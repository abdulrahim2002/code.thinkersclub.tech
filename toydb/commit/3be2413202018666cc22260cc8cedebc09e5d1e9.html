<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add MVCC TransactionState and use it for Transaction::resume(). - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3be2413202018666cc22260cc8cedebc09e5d1e9.html">3be2413202018666cc22260cc8cedebc09e5d1e9</a>
<b>parent</b> <a href="../commit/453ca47caf1fa7cc2c8f15807cca1512bed0b3fd.html">453ca47caf1fa7cc2c8f15807cca1512bed0b3fd</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Mon,  4 Sep 2023 22:39:27 +0200

Add MVCC TransactionState and use it for Transaction::resume().

This allows passing transaction state across the Raft state machine
boundary. Later, this will allow read-only transactions to be truly
read-only, omitting the on-disk state tracking of the txn ID, snapshot,
and active set.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">138</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/storage/mvcc.rs</a></td><td> | </td><td class="num">78</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">tests/client/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>4 files changed, 138 insertions(+), 94 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -28,9 +28,12 @@ impl&lt;E: storage::Engine&gt; KV&lt;E&gt; {
</a>         Self { kv: storage::mvcc::MVCC::new(engine) }
     }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// Resumes a transaction with the given ID
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    pub fn resume(&amp;self, id: u64) -&gt; Result&lt;&lt;Self as super::Engine&gt;::Transaction&gt; {
</a><a href="#h0-0-5" id="h0-0-5" class="d">-        Ok(&lt;Self as super::Engine&gt;::Transaction::new(self.kv.resume(id)?))
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    /// Resumes a transaction from the given state
</a><a href="#h0-0-7" id="h0-0-7" class="i">+    pub fn resume(
</a><a href="#h0-0-8" id="h0-0-8" class="i">+        &amp;self,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+        state: storage::mvcc::TransactionState,
</a><a href="#h0-0-10" id="h0-0-10" class="i">+    ) -&gt; Result&lt;&lt;Self as super::Engine&gt;::Transaction&gt; {
</a><a href="#h0-0-11" id="h0-0-11" class="i">+        Ok(&lt;Self as super::Engine&gt;::Transaction::new(self.kv.resume(state)?))
</a>     }
 
     /// Fetches an unversioned metadata value
<a href="#h0-1" id="h0-1" class="h">@@ -73,6 +76,11 @@ impl&lt;E: storage::Engine&gt; Transaction&lt;E&gt; {
</a>         Self { txn }
     }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    /// Returns the transaction&#39;s serialized state.
</a><a href="#h0-1-4" id="h0-1-4" class="i">+    pub(super) fn state(&amp;self) -&gt; storage::mvcc::TransactionState {
</a><a href="#h0-1-5" id="h0-1-5" class="i">+        self.txn.state()
</a><a href="#h0-1-6" id="h0-1-6" class="i">+    }
</a><a href="#h0-1-7" id="h0-1-7" class="i">+
</a>     /// Loads an index entry
     fn index_load(&amp;self, table: &amp;str, column: &amp;str, value: &amp;Value) -&gt; Result&lt;HashSet&lt;Value&gt;&gt; {
         Ok(self
<b>diff --git a/<a id="h1" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,53 +3,57 @@ use super::super::types::{Expression, Row, Value};
</a> use super::{Engine as _, IndexScan, Mode, Scan, Transaction as _};
 use crate::error::{Error, Result};
 use crate::raft;
<a href="#h1-0-3" id="h1-0-3" class="d">-use crate::storage;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+use crate::storage::{self, mvcc::TransactionState};
</a> 
 use serde::{Deserialize, Serialize};
 use std::collections::HashSet;
 
 /// A Raft state machine mutation
<a href="#h1-0-10" id="h1-0-10" class="i">+///
</a><a href="#h1-0-11" id="h1-0-11" class="i">+/// TODO: use Cows for these.
</a> #[derive(Clone, Serialize, Deserialize)]
 enum Mutation {
     /// Begins a transaction in the given mode
     Begin(Mode),
<a href="#h1-0-16" id="h1-0-16" class="d">-    /// Commits the transaction with the given ID
</a><a href="#h1-0-17" id="h1-0-17" class="d">-    Commit(u64),
</a><a href="#h1-0-18" id="h1-0-18" class="d">-    /// Rolls back the transaction with the given ID
</a><a href="#h1-0-19" id="h1-0-19" class="d">-    Rollback(u64),
</a><a href="#h1-0-20" id="h1-0-20" class="i">+    /// Commits the given transaction
</a><a href="#h1-0-21" id="h1-0-21" class="i">+    Commit(TransactionState),
</a><a href="#h1-0-22" id="h1-0-22" class="i">+    /// Rolls back the given transaction
</a><a href="#h1-0-23" id="h1-0-23" class="i">+    Rollback(TransactionState),
</a> 
     /// Creates a new row
<a href="#h1-0-26" id="h1-0-26" class="d">-    Create { txn_id: u64, table: String, row: Row },
</a><a href="#h1-0-27" id="h1-0-27" class="i">+    Create { txn: TransactionState, table: String, row: Row },
</a>     /// Deletes a row
<a href="#h1-0-29" id="h1-0-29" class="d">-    Delete { txn_id: u64, table: String, id: Value },
</a><a href="#h1-0-30" id="h1-0-30" class="i">+    Delete { txn: TransactionState, table: String, id: Value },
</a>     /// Updates a row
<a href="#h1-0-32" id="h1-0-32" class="d">-    Update { txn_id: u64, table: String, id: Value, row: Row },
</a><a href="#h1-0-33" id="h1-0-33" class="i">+    Update { txn: TransactionState, table: String, id: Value, row: Row },
</a> 
     /// Creates a table
<a href="#h1-0-36" id="h1-0-36" class="d">-    CreateTable { txn_id: u64, schema: Table },
</a><a href="#h1-0-37" id="h1-0-37" class="i">+    CreateTable { txn: TransactionState, schema: Table },
</a>     /// Deletes a table
<a href="#h1-0-39" id="h1-0-39" class="d">-    DeleteTable { txn_id: u64, table: String },
</a><a href="#h1-0-40" id="h1-0-40" class="i">+    DeleteTable { txn: TransactionState, table: String },
</a> }
 
 /// A Raft state machine query
<a href="#h1-0-44" id="h1-0-44" class="i">+///
</a><a href="#h1-0-45" id="h1-0-45" class="i">+/// TODO: use Cows for these.
</a> #[derive(Clone, Serialize, Deserialize)]
 enum Query {
     /// Fetches engine status
     Status,
 
     /// Reads a row
<a href="#h1-0-52" id="h1-0-52" class="d">-    Read { txn_id: u64, table: String, id: Value },
</a><a href="#h1-0-53" id="h1-0-53" class="i">+    Read { txn: TransactionState, table: String, id: Value },
</a>     /// Reads an index entry
<a href="#h1-0-55" id="h1-0-55" class="d">-    ReadIndex { txn_id: u64, table: String, column: String, value: Value },
</a><a href="#h1-0-56" id="h1-0-56" class="i">+    ReadIndex { txn: TransactionState, table: String, column: String, value: Value },
</a>     /// Scans a table&#39;s rows
<a href="#h1-0-58" id="h1-0-58" class="d">-    Scan { txn_id: u64, table: String, filter: Option&lt;Expression&gt; },
</a><a href="#h1-0-59" id="h1-0-59" class="i">+    Scan { txn: TransactionState, table: String, filter: Option&lt;Expression&gt; },
</a>     /// Scans an index
<a href="#h1-0-61" id="h1-0-61" class="d">-    ScanIndex { txn_id: u64, table: String, column: String },
</a><a href="#h1-0-62" id="h1-0-62" class="i">+    ScanIndex { txn: TransactionState, table: String, column: String },
</a> 
     /// Scans the tables
<a href="#h1-0-65" id="h1-0-65" class="d">-    ScanTables { txn_id: u64 },
</a><a href="#h1-0-66" id="h1-0-66" class="i">+    ScanTables { txn: TransactionState },
</a>     /// Reads a table
<a href="#h1-0-68" id="h1-0-68" class="d">-    ReadTable { txn_id: u64, table: String },
</a><a href="#h1-0-69" id="h1-0-69" class="i">+    ReadTable { txn: TransactionState, table: String },
</a> }
 
 /// Status for the Raft SQL engine.
<a href="#h1-1" id="h1-1" class="h">@@ -110,19 +114,17 @@ impl super::Engine for Raft {
</a> pub struct Transaction {
     /// The underlying Raft cluster
     client: raft::Client,
<a href="#h1-1-3" id="h1-1-3" class="d">-    /// The transaction ID
</a><a href="#h1-1-4" id="h1-1-4" class="d">-    id: u64,
</a><a href="#h1-1-5" id="h1-1-5" class="d">-    /// The transaction mode
</a><a href="#h1-1-6" id="h1-1-6" class="d">-    mode: Mode,
</a><a href="#h1-1-7" id="h1-1-7" class="i">+    // Transaction state
</a><a href="#h1-1-8" id="h1-1-8" class="i">+    state: TransactionState,
</a> }
 
 impl Transaction {
     /// Starts a transaction in the given mode
     fn begin(client: raft::Client, mode: Mode) -&gt; Result&lt;Self&gt; {
<a href="#h1-1-14" id="h1-1-14" class="d">-        let id = Raft::deserialize(&amp;futures::executor::block_on(
</a><a href="#h1-1-15" id="h1-1-15" class="i">+        let state = Raft::deserialize(&amp;futures::executor::block_on(
</a>             client.mutate(Raft::serialize(&amp;Mutation::Begin(mode))?),
         )?)?;
<a href="#h1-1-18" id="h1-1-18" class="d">-        Ok(Self { client, id, mode })
</a><a href="#h1-1-19" id="h1-1-19" class="i">+        Ok(Self { client, state })
</a>     }
 
     /// Executes a mutation
<a href="#h1-2" id="h1-2" class="h">@@ -138,24 +140,24 @@ impl Transaction {
</a> 
 impl super::Transaction for Transaction {
     fn id(&amp;self) -&gt; u64 {
<a href="#h1-2-3" id="h1-2-3" class="d">-        self.id
</a><a href="#h1-2-4" id="h1-2-4" class="i">+        self.state.id
</a>     }
 
     fn mode(&amp;self) -&gt; Mode {
<a href="#h1-2-8" id="h1-2-8" class="d">-        self.mode
</a><a href="#h1-2-9" id="h1-2-9" class="i">+        self.state.mode
</a>     }
 
     fn commit(self) -&gt; Result&lt;()&gt; {
<a href="#h1-2-13" id="h1-2-13" class="d">-        Raft::deserialize(&amp;self.mutate(Mutation::Commit(self.id))?)
</a><a href="#h1-2-14" id="h1-2-14" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Commit(self.state.clone()))?)
</a>     }
 
     fn rollback(self) -&gt; Result&lt;()&gt; {
<a href="#h1-2-18" id="h1-2-18" class="d">-        Raft::deserialize(&amp;self.mutate(Mutation::Rollback(self.id))?)
</a><a href="#h1-2-19" id="h1-2-19" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Rollback(self.state.clone()))?)
</a>     }
 
     fn create(&amp;mut self, table: &amp;str, row: Row) -&gt; Result&lt;()&gt; {
         Raft::deserialize(&amp;self.mutate(Mutation::Create {
<a href="#h1-2-24" id="h1-2-24" class="d">-            txn_id: self.id,
</a><a href="#h1-2-25" id="h1-2-25" class="i">+            txn: self.state.clone(),
</a>             table: table.to_string(),
             row,
         })?)
<a href="#h1-3" id="h1-3" class="h">@@ -163,7 +165,7 @@ impl super::Transaction for Transaction {
</a> 
     fn delete(&amp;mut self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;()&gt; {
         Raft::deserialize(&amp;self.mutate(Mutation::Delete {
<a href="#h1-3-3" id="h1-3-3" class="d">-            txn_id: self.id,
</a><a href="#h1-3-4" id="h1-3-4" class="i">+            txn: self.state.clone(),
</a>             table: table.to_string(),
             id: id.clone(),
         })?)
<a href="#h1-4" id="h1-4" class="h">@@ -171,7 +173,7 @@ impl super::Transaction for Transaction {
</a> 
     fn read(&amp;self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;Option&lt;Row&gt;&gt; {
         Raft::deserialize(&amp;self.query(Query::Read {
<a href="#h1-4-3" id="h1-4-3" class="d">-            txn_id: self.id,
</a><a href="#h1-4-4" id="h1-4-4" class="i">+            txn: self.state.clone(),
</a>             table: table.to_string(),
             id: id.clone(),
         })?)
<a href="#h1-5" id="h1-5" class="h">@@ -179,7 +181,7 @@ impl super::Transaction for Transaction {
</a> 
     fn read_index(&amp;self, table: &amp;str, column: &amp;str, value: &amp;Value) -&gt; Result&lt;HashSet&lt;Value&gt;&gt; {
         Raft::deserialize(&amp;self.query(Query::ReadIndex {
<a href="#h1-5-3" id="h1-5-3" class="d">-            txn_id: self.id,
</a><a href="#h1-5-4" id="h1-5-4" class="i">+            txn: self.state.clone(),
</a>             table: table.to_string(),
             column: column.to_string(),
             value: value.clone(),
<a href="#h1-6" id="h1-6" class="h">@@ -189,7 +191,7 @@ impl super::Transaction for Transaction {
</a>     fn scan(&amp;self, table: &amp;str, filter: Option&lt;Expression&gt;) -&gt; Result&lt;Scan&gt; {
         Ok(Box::new(
             Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::Scan {
<a href="#h1-6-3" id="h1-6-3" class="d">-                txn_id: self.id,
</a><a href="#h1-6-4" id="h1-6-4" class="i">+                txn: self.state.clone(),
</a>                 table: table.to_string(),
                 filter,
             })?)?
<a href="#h1-7" id="h1-7" class="h">@@ -201,7 +203,7 @@ impl super::Transaction for Transaction {
</a>     fn scan_index(&amp;self, table: &amp;str, column: &amp;str) -&gt; Result&lt;IndexScan&gt; {
         Ok(Box::new(
             Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanIndex {
<a href="#h1-7-3" id="h1-7-3" class="d">-                txn_id: self.id,
</a><a href="#h1-7-4" id="h1-7-4" class="i">+                txn: self.state.clone(),
</a>                 table: table.to_string(),
                 column: column.to_string(),
             })?)?
<a href="#h1-8" id="h1-8" class="h">@@ -212,7 +214,7 @@ impl super::Transaction for Transaction {
</a> 
     fn update(&amp;mut self, table: &amp;str, id: &amp;Value, row: Row) -&gt; Result&lt;()&gt; {
         Raft::deserialize(&amp;self.mutate(Mutation::Update {
<a href="#h1-8-3" id="h1-8-3" class="d">-            txn_id: self.id,
</a><a href="#h1-8-4" id="h1-8-4" class="i">+            txn: self.state.clone(),
</a>             table: table.to_string(),
             id: id.clone(),
             row,
<a href="#h1-9" id="h1-9" class="h">@@ -222,25 +224,32 @@ impl super::Transaction for Transaction {
</a> 
 impl Catalog for Transaction {
     fn create_table(&amp;mut self, table: Table) -&gt; Result&lt;()&gt; {
<a href="#h1-9-3" id="h1-9-3" class="d">-        Raft::deserialize(&amp;self.mutate(Mutation::CreateTable { txn_id: self.id, schema: table })?)
</a><a href="#h1-9-4" id="h1-9-4" class="i">+        Raft::deserialize(
</a><a href="#h1-9-5" id="h1-9-5" class="i">+            &amp;self.mutate(Mutation::CreateTable { txn: self.state.clone(), schema: table })?,
</a><a href="#h1-9-6" id="h1-9-6" class="i">+        )
</a>     }
 
     fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;()&gt; {
         Raft::deserialize(
<a href="#h1-9-11" id="h1-9-11" class="d">-            &amp;self.mutate(Mutation::DeleteTable { txn_id: self.id, table: table.to_string() })?,
</a><a href="#h1-9-12" id="h1-9-12" class="i">+            &amp;self.mutate(Mutation::DeleteTable {
</a><a href="#h1-9-13" id="h1-9-13" class="i">+                txn: self.state.clone(),
</a><a href="#h1-9-14" id="h1-9-14" class="i">+                table: table.to_string(),
</a><a href="#h1-9-15" id="h1-9-15" class="i">+            })?,
</a>         )
     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;Table&gt;&gt; {
         Raft::deserialize(
<a href="#h1-9-21" id="h1-9-21" class="d">-            &amp;self.query(Query::ReadTable { txn_id: self.id, table: table.to_string() })?,
</a><a href="#h1-9-22" id="h1-9-22" class="i">+            &amp;self.query(Query::ReadTable { txn: self.state.clone(), table: table.to_string() })?,
</a>         )
     }
 
     fn scan_tables(&amp;self) -&gt; Result&lt;Tables&gt; {
         Ok(Box::new(
<a href="#h1-9-28" id="h1-9-28" class="d">-            Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanTables { txn_id: self.id })?)?
</a><a href="#h1-9-29" id="h1-9-29" class="d">-                .into_iter(),
</a><a href="#h1-9-30" id="h1-9-30" class="i">+            Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(
</a><a href="#h1-9-31" id="h1-9-31" class="i">+                &amp;self.query(Query::ScanTables { txn: self.state.clone() })?,
</a><a href="#h1-9-32" id="h1-9-32" class="i">+            )?
</a><a href="#h1-9-33" id="h1-9-33" class="i">+            .into_iter(),
</a>         ))
     }
 }
<a href="#h1-10" id="h1-10" class="h">@@ -267,25 +276,28 @@ impl&lt;E: storage::Engine&gt; State&lt;E&gt; {
</a>     /// Applies a state machine mutation
     fn apply(&amp;mut self, mutation: Mutation) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
         match mutation {
<a href="#h1-10-3" id="h1-10-3" class="d">-            Mutation::Begin(mode) =&gt; Raft::serialize(&amp;self.engine.begin(mode)?.id()),
</a><a href="#h1-10-4" id="h1-10-4" class="d">-            Mutation::Commit(txn_id) =&gt; Raft::serialize(&amp;self.engine.resume(txn_id)?.commit()?),
</a><a href="#h1-10-5" id="h1-10-5" class="d">-            Mutation::Rollback(txn_id) =&gt; Raft::serialize(&amp;self.engine.resume(txn_id)?.rollback()?),
</a><a href="#h1-10-6" id="h1-10-6" class="i">+            Mutation::Begin(mode) =&gt; {
</a><a href="#h1-10-7" id="h1-10-7" class="i">+                let txn = self.engine.begin(mode)?;
</a><a href="#h1-10-8" id="h1-10-8" class="i">+                Raft::serialize(&amp;txn.state())
</a><a href="#h1-10-9" id="h1-10-9" class="i">+            }
</a><a href="#h1-10-10" id="h1-10-10" class="i">+            Mutation::Commit(txn) =&gt; Raft::serialize(&amp;self.engine.resume(txn)?.commit()?),
</a><a href="#h1-10-11" id="h1-10-11" class="i">+            Mutation::Rollback(txn) =&gt; Raft::serialize(&amp;self.engine.resume(txn)?.rollback()?),
</a> 
<a href="#h1-10-13" id="h1-10-13" class="d">-            Mutation::Create { txn_id, table, row } =&gt; {
</a><a href="#h1-10-14" id="h1-10-14" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a><a href="#h1-10-15" id="h1-10-15" class="i">+            Mutation::Create { txn, table, row } =&gt; {
</a><a href="#h1-10-16" id="h1-10-16" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.create(&amp;table, row)?)
</a>             }
<a href="#h1-10-18" id="h1-10-18" class="d">-            Mutation::Delete { txn_id, table, id } =&gt; {
</a><a href="#h1-10-19" id="h1-10-19" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a><a href="#h1-10-20" id="h1-10-20" class="i">+            Mutation::Delete { txn, table, id } =&gt; {
</a><a href="#h1-10-21" id="h1-10-21" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.delete(&amp;table, &amp;id)?)
</a>             }
<a href="#h1-10-23" id="h1-10-23" class="d">-            Mutation::Update { txn_id, table, id, row } =&gt; {
</a><a href="#h1-10-24" id="h1-10-24" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a><a href="#h1-10-25" id="h1-10-25" class="i">+            Mutation::Update { txn, table, id, row } =&gt; {
</a><a href="#h1-10-26" id="h1-10-26" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.update(&amp;table, &amp;id, row)?)
</a>             }
 
<a href="#h1-10-29" id="h1-10-29" class="d">-            Mutation::CreateTable { txn_id, schema } =&gt; {
</a><a href="#h1-10-30" id="h1-10-30" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.create_table(schema)?)
</a><a href="#h1-10-31" id="h1-10-31" class="i">+            Mutation::CreateTable { txn, schema } =&gt; {
</a><a href="#h1-10-32" id="h1-10-32" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.create_table(schema)?)
</a>             }
<a href="#h1-10-34" id="h1-10-34" class="d">-            Mutation::DeleteTable { txn_id, table } =&gt; {
</a><a href="#h1-10-35" id="h1-10-35" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a><a href="#h1-10-36" id="h1-10-36" class="i">+            Mutation::DeleteTable { txn, table } =&gt; {
</a><a href="#h1-10-37" id="h1-10-37" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.delete_table(&amp;table)?)
</a>             }
         }
     }
<a href="#h1-11" id="h1-11" class="h">@@ -311,30 +323,30 @@ impl&lt;E: storage::Engine&gt; raft::State for State&lt;E&gt; {
</a> 
     fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
         match Raft::deserialize(&amp;command)? {
<a href="#h1-11-3" id="h1-11-3" class="d">-            Query::Read { txn_id, table, id } =&gt; {
</a><a href="#h1-11-4" id="h1-11-4" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a><a href="#h1-11-5" id="h1-11-5" class="i">+            Query::Read { txn, table, id } =&gt; {
</a><a href="#h1-11-6" id="h1-11-6" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.read(&amp;table, &amp;id)?)
</a>             }
<a href="#h1-11-8" id="h1-11-8" class="d">-            Query::ReadIndex { txn_id, table, column, value } =&gt; {
</a><a href="#h1-11-9" id="h1-11-9" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.read_index(&amp;table, &amp;column, &amp;value)?)
</a><a href="#h1-11-10" id="h1-11-10" class="i">+            Query::ReadIndex { txn, table, column, value } =&gt; {
</a><a href="#h1-11-11" id="h1-11-11" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.read_index(&amp;table, &amp;column, &amp;value)?)
</a>             }
             // FIXME These need to stream rows somehow
<a href="#h1-11-14" id="h1-11-14" class="d">-            Query::Scan { txn_id, table, filter } =&gt; Raft::serialize(
</a><a href="#h1-11-15" id="h1-11-15" class="d">-                &amp;self.engine.resume(txn_id)?.scan(&amp;table, filter)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,
</a><a href="#h1-11-16" id="h1-11-16" class="i">+            Query::Scan { txn, table, filter } =&gt; Raft::serialize(
</a><a href="#h1-11-17" id="h1-11-17" class="i">+                &amp;self.engine.resume(txn)?.scan(&amp;table, filter)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,
</a>             ),
<a href="#h1-11-19" id="h1-11-19" class="d">-            Query::ScanIndex { txn_id, table, column } =&gt; Raft::serialize(
</a><a href="#h1-11-20" id="h1-11-20" class="i">+            Query::ScanIndex { txn, table, column } =&gt; Raft::serialize(
</a>                 &amp;self
                     .engine
<a href="#h1-11-23" id="h1-11-23" class="d">-                    .resume(txn_id)?
</a><a href="#h1-11-24" id="h1-11-24" class="i">+                    .resume(txn)?
</a>                     .scan_index(&amp;table, &amp;column)?
                     .collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,
             ),
             Query::Status =&gt; Raft::serialize(&amp;self.engine.kv.status()?),
 
<a href="#h1-11-30" id="h1-11-30" class="d">-            Query::ReadTable { txn_id, table } =&gt; {
</a><a href="#h1-11-31" id="h1-11-31" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a><a href="#h1-11-32" id="h1-11-32" class="i">+            Query::ReadTable { txn, table } =&gt; {
</a><a href="#h1-11-33" id="h1-11-33" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.read_table(&amp;table)?)
</a>             }
<a href="#h1-11-35" id="h1-11-35" class="d">-            Query::ScanTables { txn_id } =&gt; {
</a><a href="#h1-11-36" id="h1-11-36" class="d">-                Raft::serialize(&amp;self.engine.resume(txn_id)?.scan_tables()?.collect::&lt;Vec&lt;_&gt;&gt;())
</a><a href="#h1-11-37" id="h1-11-37" class="i">+            Query::ScanTables { txn } =&gt; {
</a><a href="#h1-11-38" id="h1-11-38" class="i">+                Raft::serialize(&amp;self.engine.resume(txn)?.scan_tables()?.collect::&lt;Vec&lt;_&gt;&gt;())
</a>             }
         }
     }
<b>diff --git a/<a id="h2" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -8,6 +8,12 @@ use std::iter::Peekable;
</a> use std::ops::{Bound, RangeBounds};
 use std::sync::{Arc, Mutex, MutexGuard};
 
<a href="#h2-0-3" id="h2-0-3" class="i">+// TODO: for read-only transactions, don&#39;t allocate a transaction ID. Instead,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+// keep the snapshot in the transaction object, and retain it in the SQL engine
</a><a href="#h2-0-5" id="h2-0-5" class="i">+// session to synthesize a new transaction from it (in particular, in the Raft
</a><a href="#h2-0-6" id="h2-0-6" class="i">+// engine). This removes the need to persist transaction IDs and snapshots for
</a><a href="#h2-0-7" id="h2-0-7" class="i">+// read-only transactions (including AOST transactions).
</a><a href="#h2-0-8" id="h2-0-8" class="i">+
</a> /// MVCC keys, using the KeyCode encoding which preserves the ordering and
 /// grouping of keys. Cow byte slices allow encoding borrowed values and
 /// decoding into owned values.
<a href="#h2-1" id="h2-1" class="h">@@ -90,9 +96,9 @@ impl&lt;E: Engine&gt; MVCC&lt;E&gt; {
</a>         Transaction::begin(self.engine.clone(), mode)
     }
 
<a href="#h2-1-3" id="h2-1-3" class="d">-    /// Resumes a transaction with the given ID.
</a><a href="#h2-1-4" id="h2-1-4" class="d">-    pub fn resume(&amp;self, id: u64) -&gt; Result&lt;Transaction&lt;E&gt;&gt; {
</a><a href="#h2-1-5" id="h2-1-5" class="d">-        Transaction::resume(self.engine.clone(), id)
</a><a href="#h2-1-6" id="h2-1-6" class="i">+    /// Resumes a transaction from the given state.
</a><a href="#h2-1-7" id="h2-1-7" class="i">+    pub fn resume(&amp;self, state: TransactionState) -&gt; Result&lt;Transaction&lt;E&gt;&gt; {
</a><a href="#h2-1-8" id="h2-1-8" class="i">+        Transaction::resume(self.engine.clone(), state)
</a>     }
 
     /// Fetches the value of an unversioned key.
<a href="#h2-2" id="h2-2" class="h">@@ -137,6 +143,18 @@ pub struct Transaction&lt;E: Engine&gt; {
</a>     snapshot: Snapshot,
 }
 
<a href="#h2-2-3" id="h2-2-3" class="i">+/// A serializable representation of a Transaction&#39;s state. It can be exported
</a><a href="#h2-2-4" id="h2-2-4" class="i">+/// from a Transaction and later used to instantiate a new Transaction that&#39;s
</a><a href="#h2-2-5" id="h2-2-5" class="i">+/// functionally equivalent via Transaction::resume(). In particular, this
</a><a href="#h2-2-6" id="h2-2-6" class="i">+/// allows passing the transaction between the SQL engine and storage engine
</a><a href="#h2-2-7" id="h2-2-7" class="i">+/// across the Raft state machine boundary.
</a><a href="#h2-2-8" id="h2-2-8" class="i">+#[derive(Clone, Serialize, Deserialize)]
</a><a href="#h2-2-9" id="h2-2-9" class="i">+pub struct TransactionState {
</a><a href="#h2-2-10" id="h2-2-10" class="i">+    pub id: u64,
</a><a href="#h2-2-11" id="h2-2-11" class="i">+    pub mode: Mode,
</a><a href="#h2-2-12" id="h2-2-12" class="i">+    pub snapshot: Snapshot,
</a><a href="#h2-2-13" id="h2-2-13" class="i">+}
</a><a href="#h2-2-14" id="h2-2-14" class="i">+
</a> impl&lt;E: Engine&gt; Transaction&lt;E&gt; {
     /// Begins a new transaction in the given mode.
     fn begin(engine: Arc&lt;Mutex&lt;E&gt;&gt;, mode: Mode) -&gt; Result&lt;Self&gt; {
<a href="#h2-3" id="h2-3" class="h">@@ -161,19 +179,16 @@ impl&lt;E: Engine&gt; Transaction&lt;E&gt; {
</a>         Ok(Self { engine, id, mode, snapshot })
     }
 
<a href="#h2-3-3" id="h2-3-3" class="d">-    /// Resumes an active transaction with the given ID. Errors if the transaction is not active.
</a><a href="#h2-3-4" id="h2-3-4" class="d">-    fn resume(engine: Arc&lt;Mutex&lt;E&gt;&gt;, id: u64) -&gt; Result&lt;Self&gt; {
</a><a href="#h2-3-5" id="h2-3-5" class="d">-        let mut session = engine.lock()?;
</a><a href="#h2-3-6" id="h2-3-6" class="d">-        let mode = match session.get(&amp;Key::TxnActive(id).encode()?)? {
</a><a href="#h2-3-7" id="h2-3-7" class="d">-            Some(v) =&gt; bincode::deserialize(&amp;v)?,
</a><a href="#h2-3-8" id="h2-3-8" class="d">-            None =&gt; return Err(Error::Value(format!(&quot;No active transaction {}&quot;, id))),
</a><a href="#h2-3-9" id="h2-3-9" class="d">-        };
</a><a href="#h2-3-10" id="h2-3-10" class="d">-        let snapshot = match &amp;mode {
</a><a href="#h2-3-11" id="h2-3-11" class="d">-            Mode::Snapshot { version } =&gt; Snapshot::restore(&amp;mut session, *version)?,
</a><a href="#h2-3-12" id="h2-3-12" class="d">-            _ =&gt; Snapshot::restore(&amp;mut session, id)?,
</a><a href="#h2-3-13" id="h2-3-13" class="d">-        };
</a><a href="#h2-3-14" id="h2-3-14" class="d">-        std::mem::drop(session);
</a><a href="#h2-3-15" id="h2-3-15" class="d">-        Ok(Self { engine, id, mode, snapshot })
</a><a href="#h2-3-16" id="h2-3-16" class="i">+    /// Resumes a transaction from the given state.
</a><a href="#h2-3-17" id="h2-3-17" class="i">+    fn resume(engine: Arc&lt;Mutex&lt;E&gt;&gt;, state: TransactionState) -&gt; Result&lt;Self&gt; {
</a><a href="#h2-3-18" id="h2-3-18" class="i">+        // For read-write transactions, verify that the transaction is still
</a><a href="#h2-3-19" id="h2-3-19" class="i">+        // active before making further writes.
</a><a href="#h2-3-20" id="h2-3-20" class="i">+        if state.mode == Mode::ReadWrite
</a><a href="#h2-3-21" id="h2-3-21" class="i">+            &amp;&amp; engine.lock()?.get(&amp;Key::TxnActive(state.id).encode()?)?.is_none()
</a><a href="#h2-3-22" id="h2-3-22" class="i">+        {
</a><a href="#h2-3-23" id="h2-3-23" class="i">+            return Err(Error::Internal(format!(&quot;No active transaction with ID {}&quot;, state.id)));
</a><a href="#h2-3-24" id="h2-3-24" class="i">+        }
</a><a href="#h2-3-25" id="h2-3-25" class="i">+        Ok(Self { engine, id: state.id, mode: state.mode, snapshot: state.snapshot })
</a>     }
 
     /// Returns the transaction ID.
<a href="#h2-4" id="h2-4" class="h">@@ -186,6 +201,12 @@ impl&lt;E: Engine&gt; Transaction&lt;E&gt; {
</a>         self.mode
     }
 
<a href="#h2-4-3" id="h2-4-3" class="i">+    /// Returns the transaction&#39;s state. This can be used to instantiate a
</a><a href="#h2-4-4" id="h2-4-4" class="i">+    /// functionally equivalent transaction via resume().
</a><a href="#h2-4-5" id="h2-4-5" class="i">+    pub fn state(&amp;self) -&gt; TransactionState {
</a><a href="#h2-4-6" id="h2-4-6" class="i">+        TransactionState { id: self.id, mode: self.mode, snapshot: self.snapshot.clone() }
</a><a href="#h2-4-7" id="h2-4-7" class="i">+    }
</a><a href="#h2-4-8" id="h2-4-8" class="i">+
</a>     /// Commits the transaction, by removing the txn from the active set.
     pub fn commit(self) -&gt; Result&lt;()&gt; {
         let mut session = self.engine.lock()?;
<a href="#h2-5" id="h2-5" class="h">@@ -363,13 +384,13 @@ impl Mode {
</a> }
 
 /// A versioned snapshot, containing visibility information about concurrent transactions.
<a href="#h2-5-3" id="h2-5-3" class="d">-#[derive(Clone)]
</a><a href="#h2-5-4" id="h2-5-4" class="d">-struct Snapshot {
</a><a href="#h2-5-5" id="h2-5-5" class="i">+#[derive(Clone, Deserialize, Serialize)]
</a><a href="#h2-5-6" id="h2-5-6" class="i">+pub struct Snapshot {
</a>     /// The version (i.e. transaction ID) that the snapshot belongs to.
<a href="#h2-5-8" id="h2-5-8" class="d">-    version: u64,
</a><a href="#h2-5-9" id="h2-5-9" class="i">+    pub version: u64,
</a>     /// The set of transaction IDs that were active at the start of the transactions,
     /// and thus should be invisible to the snapshot.
<a href="#h2-5-12" id="h2-5-12" class="d">-    invisible: HashSet&lt;u64&gt;,
</a><a href="#h2-5-13" id="h2-5-13" class="i">+    pub invisible: HashSet&lt;u64&gt;,
</a> }
 
 impl Snapshot {
<a href="#h2-6" id="h2-6" class="h">@@ -620,9 +641,9 @@ pub mod tests {
</a> 
         // We now resume t3, who should see it&#39;s own changes but none
         // of the others&#39;
<a href="#h2-6-3" id="h2-6-3" class="d">-        let id = t3.id();
</a><a href="#h2-6-4" id="h2-6-4" class="i">+        let state = t3.state();
</a>         std::mem::drop(t3);
<a href="#h2-6-6" id="h2-6-6" class="d">-        let tr = mvcc.resume(id)?;
</a><a href="#h2-6-7" id="h2-6-7" class="i">+        let tr = mvcc.resume(state.clone())?;
</a>         assert_eq!(3, tr.id());
         assert_eq!(Mode::ReadWrite, tr.mode());
 
<a href="#h2-7" id="h2-7" class="h">@@ -640,6 +661,12 @@ pub mod tests {
</a>         // Once tr commits, a separate transaction should see t3&#39;s changes
         tr.commit()?;
 
<a href="#h2-7-3" id="h2-7-3" class="i">+        // Resuming an inactive transaction should error.
</a><a href="#h2-7-4" id="h2-7-4" class="i">+        assert_eq!(
</a><a href="#h2-7-5" id="h2-7-5" class="i">+            mvcc.resume(state).err(),
</a><a href="#h2-7-6" id="h2-7-6" class="i">+            Some(Error::Internal(&quot;No active transaction with ID 3&quot;.into()))
</a><a href="#h2-7-7" id="h2-7-7" class="i">+        );
</a><a href="#h2-7-8" id="h2-7-8" class="i">+
</a>         let t = mvcc.begin()?;
         assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;a&quot;)?);
         assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;b&quot;)?);
<a href="#h2-8" id="h2-8" class="h">@@ -651,17 +678,14 @@ pub mod tests {
</a>         assert_eq!(7, ts.id());
         assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
 
<a href="#h2-8-3" id="h2-8-3" class="d">-        let id = ts.id();
</a><a href="#h2-8-4" id="h2-8-4" class="i">+        let state = ts.state();
</a>         std::mem::drop(ts);
<a href="#h2-8-6" id="h2-8-6" class="d">-        let ts = mvcc.resume(id)?;
</a><a href="#h2-8-7" id="h2-8-7" class="i">+        let ts = mvcc.resume(state)?;
</a>         assert_eq!(7, ts.id());
         assert_eq!(Mode::Snapshot { version: 1 }, ts.mode());
         assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
         ts.commit()?;
 
<a href="#h2-8-13" id="h2-8-13" class="d">-        // Resuming an inactive transaction should error.
</a><a href="#h2-8-14" id="h2-8-14" class="d">-        assert_eq!(mvcc.resume(7).err(), Some(Error::Value(&quot;No active transaction 7&quot;.into())));
</a><a href="#h2-8-15" id="h2-8-15" class="d">-
</a>         Ok(())
     }
 
<b>diff --git a/<a id="h3" href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a> b/<a href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -129,7 +129,7 @@ async fn status() -&gt; Result&lt;()&gt; {
</a>                 commit_index: 26,
                 apply_index: 26,
                 storage: &quot;hybrid&quot;.into(),
<a href="#h3-0-3" id="h3-0-3" class="d">-                storage_size: 3239,
</a><a href="#h3-0-4" id="h3-0-4" class="i">+                storage_size: 3739,
</a>             },
             mvcc: mvcc::Status { txns: 1, txns_active: 0, storage: &quot;memory&quot;.into() },
         }
</pre>
</div>
</body>
</html>
