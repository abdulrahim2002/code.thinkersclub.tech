<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: use shared txn borrows during execution - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a5e12fda8d138be72774305b17251223c8eb85d3.html">a5e12fda8d138be72774305b17251223c8eb85d3</a>
<b>parent</b> <a href="../commit/9e6ace8c3d97f9033b36457f92e538b0d19b48a3.html">9e6ace8c3d97f9033b36457f92e538b0d19b48a3</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 18 Jun 2024 11:10:49 +0200

sql: use shared txn borrows during execution

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/execution/execute.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/execution/schema.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/execution/source.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/execution/write.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
</table></pre><pre>4 files changed, 10 insertions(+), 10 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a> b/<a href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -10,7 +10,7 @@ use crate::sql::plan::{Node, Plan};
</a> use crate::sql::types::{Columns, Row, Rows};
 
 /// Executes a plan, returning an execution result.
<a href="#h0-0-3" id="h0-0-3" class="d">-pub fn execute_plan(plan: Plan, txn: &amp;mut impl Transaction) -&gt; Result&lt;ExecutionResult&gt; {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+pub fn execute_plan(plan: Plan, txn: &amp;impl Transaction) -&gt; Result&lt;ExecutionResult&gt; {
</a>     Ok(match plan {
         Plan::CreateTable { schema } =&gt; {
             let name = schema.name.clone();
<a href="#h0-1" id="h0-1" class="h">@@ -49,7 +49,7 @@ pub fn execute_plan(plan: Plan, txn: &amp;mut impl Transaction) -&gt; Result&lt;ExecutionR
</a> ///
 /// TODO: since iterators are lazy, make this infallible and move all catalog
 /// lookups to planning.
<a href="#h0-1-3" id="h0-1-3" class="d">-pub fn execute(node: Node, txn: &amp;mut impl Transaction) -&gt; Result&lt;QueryIterator&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+pub fn execute(node: Node, txn: &amp;impl Transaction) -&gt; Result&lt;QueryIterator&gt; {
</a>     match node {
         Node::Aggregation { source, aggregates } =&gt; {
             let source = execute(*source, txn)?;
<b>diff --git a/<a id="h1" href="../file/src/sql/execution/schema.rs.html">src/sql/execution/schema.rs</a> b/<a href="../file/src/sql/execution/schema.rs.html">src/sql/execution/schema.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,12 +3,12 @@ use crate::sql::engine::Transaction;
</a> use crate::sql::types::schema::Table;
 
 // Creates a table (i.e. CREATE TABLE).
<a href="#h1-0-3" id="h1-0-3" class="d">-pub(super) fn create_table(txn: &amp;mut impl Transaction, schema: Table) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+pub(super) fn create_table(txn: &amp;impl Transaction, schema: Table) -&gt; Result&lt;()&gt; {
</a>     txn.create_table(schema)
 }
 
 /// Deletes a table (i.e. DROP TABLE). Returns true if the table existed.
<a href="#h1-0-9" id="h1-0-9" class="d">-pub(super) fn drop_table(txn: &amp;mut impl Transaction, table: &amp;str, if_exists: bool) -&gt; Result&lt;bool&gt; {
</a><a href="#h1-0-10" id="h1-0-10" class="i">+pub(super) fn drop_table(txn: &amp;impl Transaction, table: &amp;str, if_exists: bool) -&gt; Result&lt;bool&gt; {
</a>     // TODO the planner should deal with this.
     if if_exists &amp;&amp; txn.get_table(table)?.is_none() {
         return Ok(false);
<b>diff --git a/<a id="h2" href="../file/src/sql/execution/source.rs.html">src/sql/execution/source.rs</a> b/<a href="../file/src/sql/execution/source.rs.html">src/sql/execution/source.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -5,7 +5,7 @@ use crate::sql::types::{Column, Expression, Row, Value};
</a> 
 /// A table scan source.
 pub(super) fn scan(
<a href="#h2-0-3" id="h2-0-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     filter: Option&lt;Expression&gt;,
 ) -&gt; Result&lt;QueryIterator&gt; {
<a href="#h2-1" id="h2-1" class="h">@@ -19,7 +19,7 @@ pub(super) fn scan(
</a> 
 /// A primary key lookup source.
 pub(super) fn lookup_key(
<a href="#h2-1-3" id="h2-1-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h2-1-4" id="h2-1-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     keys: Vec&lt;Value&gt;,
 ) -&gt; Result&lt;QueryIterator&gt; {
<a href="#h2-2" id="h2-2" class="h">@@ -40,7 +40,7 @@ pub(super) fn lookup_key(
</a> 
 /// An index lookup source.
 pub(super) fn lookup_index(
<a href="#h2-2-3" id="h2-2-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h2-2-4" id="h2-2-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     column: &amp;str,
     values: Vec&lt;Value&gt;,
<b>diff --git a/<a id="h3" href="../file/src/sql/execution/write.rs.html">src/sql/execution/write.rs</a> b/<a href="../file/src/sql/execution/write.rs.html">src/sql/execution/write.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -8,7 +8,7 @@ use crate::sql::types::{Expression, Row, Value};
</a> /// Deletes rows, taking primary keys from the source (i.e. DELETE).
 /// Returns the number of rows deleted.
 pub(super) fn delete(
<a href="#h3-0-3" id="h3-0-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     mut source: QueryIterator,
 ) -&gt; Result&lt;u64&gt; {
<a href="#h3-1" id="h3-1" class="h">@@ -26,7 +26,7 @@ pub(super) fn delete(
</a> ///
 /// TODO: this should take rows from a values source.
 pub(super) fn insert(
<a href="#h3-1-3" id="h3-1-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h3-1-4" id="h3-1-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     columns: Vec&lt;String&gt;,
     values: Vec&lt;Vec&lt;Expression&gt;&gt;,
<a href="#h3-2" id="h3-2" class="h">@@ -50,7 +50,7 @@ pub(super) fn insert(
</a> /// Updates rows passed in from the source (i.e. UPDATE). Returns the number of
 /// rows updated.
 pub(super) fn update(
<a href="#h3-2-3" id="h3-2-3" class="d">-    txn: &amp;mut impl Transaction,
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    txn: &amp;impl Transaction,
</a>     table: &amp;str,
     mut source: QueryIterator,
     expressions: Vec&lt;(usize, Expression)&gt;,
</pre>
</div>
</body>
</html>
