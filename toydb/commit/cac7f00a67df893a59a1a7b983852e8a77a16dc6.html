<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tests: add client txn tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/cac7f00a67df893a59a1a7b983852e8a77a16dc6.html">cac7f00a67df893a59a1a7b983852e8a77a16dc6</a>
<b>parent</b> <a href="../commit/2ab7cf92af53816cb5e4ed6362a4a77fe7c1c3e0.html">2ab7cf92af53816cb5e4ed6362a4a77fe7c1c3e0</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 11 Apr 2020 17:09:03 +0200

tests: add client txn tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">tests/client/mod.rs</a></td><td> | </td><td class="num">133</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
</table></pre><pre>1 file changed, 115 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a> b/<a href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,4 +1,6 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+use toydb::client::Client;
</a> use toydb::server::Status;
<a href="#h0-0-2" id="h0-0-2" class="i">+use toydb::sql::engine::Mode;
</a> use toydb::sql::execution::ResultSet;
 use toydb::sql::schema;
 use toydb::sql::types::{Column, DataType, Relation, Row, Value};
<a href="#h0-1" id="h0-1" class="h">@@ -9,7 +11,7 @@ use serial_test::serial;
</a> use std::collections::HashMap;
 
 #[allow(clippy::type_complexity)]
<a href="#h0-1-3" id="h0-1-3" class="d">-fn setup(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(toydb::Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+fn setup(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a>     let data_dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
     let mut srv = toydb::Server::new(&quot;test&quot;, HashMap::new(), &amp;data_dir.path().to_string_lossy())?;
     srv.listen(&quot;127.0.0.1:9605&quot;, 4)?;
<a href="#h0-2" id="h0-2" class="h">@@ -210,18 +212,14 @@ fn query() -&gt; Result&lt;(), Error&gt; {
</a>             }
         }
     );
<a href="#h0-2-3" id="h0-2-3" class="d">-    if let ResultSet::Query { relation: Relation { rows: Some(rows), .. } } = result {
</a><a href="#h0-2-4" id="h0-2-4" class="d">-        assert_eq!(
</a><a href="#h0-2-5" id="h0-2-5" class="d">-            rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?,
</a><a href="#h0-2-6" id="h0-2-6" class="d">-            vec![
</a><a href="#h0-2-7" id="h0-2-7" class="d">-                vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h0-2-8" id="h0-2-8" class="d">-                vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h0-2-9" id="h0-2-9" class="d">-                vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())]
</a><a href="#h0-2-10" id="h0-2-10" class="d">-            ]
</a><a href="#h0-2-11" id="h0-2-11" class="d">-        )
</a><a href="#h0-2-12" id="h0-2-12" class="d">-    } else {
</a><a href="#h0-2-13" id="h0-2-13" class="d">-        panic!(&quot;result returned no rows&quot;)
</a><a href="#h0-2-14" id="h0-2-14" class="d">-    }
</a><a href="#h0-2-15" id="h0-2-15" class="i">+    assert_rows(
</a><a href="#h0-2-16" id="h0-2-16" class="i">+        result,
</a><a href="#h0-2-17" id="h0-2-17" class="i">+        vec![
</a><a href="#h0-2-18" id="h0-2-18" class="i">+            vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h0-2-19" id="h0-2-19" class="i">+            vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h0-2-20" id="h0-2-20" class="i">+            vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h0-2-21" id="h0-2-21" class="i">+        ],
</a><a href="#h0-2-22" id="h0-2-22" class="i">+    );
</a> 
     let result = c.query(&quot;SELECT * FROM genres WHERE FALSE&quot;)?;
     assert_eq!(
<a href="#h0-3" id="h0-3" class="h">@@ -236,11 +234,7 @@ fn query() -&gt; Result&lt;(), Error&gt; {
</a>             }
         }
     );
<a href="#h0-3-3" id="h0-3-3" class="d">-    if let ResultSet::Query { relation: Relation { rows: Some(rows), .. } } = result {
</a><a href="#h0-3-4" id="h0-3-4" class="d">-        assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?, Vec::&lt;Row&gt;::new())
</a><a href="#h0-3-5" id="h0-3-5" class="d">-    } else {
</a><a href="#h0-3-6" id="h0-3-6" class="d">-        panic!(&quot;result returned no rows&quot;)
</a><a href="#h0-3-7" id="h0-3-7" class="d">-    }
</a><a href="#h0-3-8" id="h0-3-8" class="i">+    assert_rows(result, Vec::new());
</a> 
     assert_eq!(c.query(&quot;SELECT * FROM x&quot;), Err(Error::Value(&quot;Table x does not exist&quot;.into())));
 
<a href="#h0-4" id="h0-4" class="h">@@ -283,3 +277,106 @@ fn query() -&gt; Result&lt;(), Error&gt; {
</a> 
     Ok(())
 }
<a href="#h0-4-3" id="h0-4-3" class="i">+
</a><a href="#h0-4-4" id="h0-4-4" class="i">+#[test]
</a><a href="#h0-4-5" id="h0-4-5" class="i">+#[serial]
</a><a href="#h0-4-6" id="h0-4-6" class="i">+fn query_txn() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-4-7" id="h0-4-7" class="i">+    let (mut c, teardown) = setup_movies()?;
</a><a href="#h0-4-8" id="h0-4-8" class="i">+    defer!(teardown());
</a><a href="#h0-4-9" id="h0-4-9" class="i">+
</a><a href="#h0-4-10" id="h0-4-10" class="i">+    // Committing a change in a txn should work
</a><a href="#h0-4-11" id="h0-4-11" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-12" id="h0-4-12" class="i">+    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
</a><a href="#h0-4-13" id="h0-4-13" class="i">+    assert_eq!(c.txn(), Some((2, Mode::ReadWrite)));
</a><a href="#h0-4-14" id="h0-4-14" class="i">+
</a><a href="#h0-4-15" id="h0-4-15" class="i">+    c.query(&quot;INSERT INTO genres VALUES (4, &#39;Drama&#39;)&quot;)?;
</a><a href="#h0-4-16" id="h0-4-16" class="i">+    assert_eq!(c.txn(), Some((2, Mode::ReadWrite)));
</a><a href="#h0-4-17" id="h0-4-17" class="i">+
</a><a href="#h0-4-18" id="h0-4-18" class="i">+    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 2 });
</a><a href="#h0-4-19" id="h0-4-19" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-20" id="h0-4-20" class="i">+
</a><a href="#h0-4-21" id="h0-4-21" class="i">+    assert_rows(
</a><a href="#h0-4-22" id="h0-4-22" class="i">+        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h0-4-23" id="h0-4-23" class="i">+        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h0-4-24" id="h0-4-24" class="i">+    );
</a><a href="#h0-4-25" id="h0-4-25" class="i">+
</a><a href="#h0-4-26" id="h0-4-26" class="i">+    // Rolling back a change in a txn should also work
</a><a href="#h0-4-27" id="h0-4-27" class="i">+    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 4, mode: Mode::ReadWrite });
</a><a href="#h0-4-28" id="h0-4-28" class="i">+    c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;)?;
</a><a href="#h0-4-29" id="h0-4-29" class="i">+    assert_rows(
</a><a href="#h0-4-30" id="h0-4-30" class="i">+        c.query(&quot;SELECT * FROM genres WHERE id = 5&quot;)?,
</a><a href="#h0-4-31" id="h0-4-31" class="i">+        vec![vec![Value::Integer(5), Value::String(&quot;Musical&quot;.into())]],
</a><a href="#h0-4-32" id="h0-4-32" class="i">+    );
</a><a href="#h0-4-33" id="h0-4-33" class="i">+    assert_eq!(c.query(&quot;ROLLBACK&quot;)?, ResultSet::Rollback { id: 4 });
</a><a href="#h0-4-34" id="h0-4-34" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-35" id="h0-4-35" class="i">+    assert_rows(c.query(&quot;SELECT * FROM genres WHERE id = 5&quot;)?, Vec::new());
</a><a href="#h0-4-36" id="h0-4-36" class="i">+
</a><a href="#h0-4-37" id="h0-4-37" class="i">+    // Starting a read-only txn should block writes
</a><a href="#h0-4-38" id="h0-4-38" class="i">+    assert_eq!(c.query(&quot;BEGIN READ ONLY&quot;)?, ResultSet::Begin { id: 6, mode: Mode::ReadOnly });
</a><a href="#h0-4-39" id="h0-4-39" class="i">+    assert_eq!(c.txn(), Some((6, Mode::ReadOnly)));
</a><a href="#h0-4-40" id="h0-4-40" class="i">+    assert_rows(
</a><a href="#h0-4-41" id="h0-4-41" class="i">+        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h0-4-42" id="h0-4-42" class="i">+        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h0-4-43" id="h0-4-43" class="i">+    );
</a><a href="#h0-4-44" id="h0-4-44" class="i">+    assert_eq!(c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h0-4-45" id="h0-4-45" class="i">+    assert_eq!(c.txn(), Some((6, Mode::ReadOnly)));
</a><a href="#h0-4-46" id="h0-4-46" class="i">+    assert_rows(
</a><a href="#h0-4-47" id="h0-4-47" class="i">+        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h0-4-48" id="h0-4-48" class="i">+        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h0-4-49" id="h0-4-49" class="i">+    );
</a><a href="#h0-4-50" id="h0-4-50" class="i">+    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 6 });
</a><a href="#h0-4-51" id="h0-4-51" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-52" id="h0-4-52" class="i">+
</a><a href="#h0-4-53" id="h0-4-53" class="i">+    // Starting a time-travel txn should work, it shouldn&#39;t see recent changes, and it should
</a><a href="#h0-4-54" id="h0-4-54" class="i">+    // block writes
</a><a href="#h0-4-55" id="h0-4-55" class="i">+    assert_eq!(
</a><a href="#h0-4-56" id="h0-4-56" class="i">+        c.query(&quot;BEGIN READ ONLY AS OF SYSTEM TIME 1&quot;)?,
</a><a href="#h0-4-57" id="h0-4-57" class="i">+        ResultSet::Begin { id: 7, mode: Mode::Snapshot { version: 1 } }
</a><a href="#h0-4-58" id="h0-4-58" class="i">+    );
</a><a href="#h0-4-59" id="h0-4-59" class="i">+    assert_eq!(c.txn(), Some((7, Mode::Snapshot { version: 1 })));
</a><a href="#h0-4-60" id="h0-4-60" class="i">+    assert_rows(
</a><a href="#h0-4-61" id="h0-4-61" class="i">+        c.query(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h0-4-62" id="h0-4-62" class="i">+        vec![
</a><a href="#h0-4-63" id="h0-4-63" class="i">+            vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h0-4-64" id="h0-4-64" class="i">+            vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h0-4-65" id="h0-4-65" class="i">+            vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h0-4-66" id="h0-4-66" class="i">+        ],
</a><a href="#h0-4-67" id="h0-4-67" class="i">+    );
</a><a href="#h0-4-68" id="h0-4-68" class="i">+    assert_eq!(c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h0-4-69" id="h0-4-69" class="i">+    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 7 });
</a><a href="#h0-4-70" id="h0-4-70" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-71" id="h0-4-71" class="i">+
</a><a href="#h0-4-72" id="h0-4-72" class="i">+    // A txn should still be usable after an error occurs
</a><a href="#h0-4-73" id="h0-4-73" class="i">+    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 8, mode: Mode::ReadWrite });
</a><a href="#h0-4-74" id="h0-4-74" class="i">+    c.query(&quot;INSERT INTO genres VALUES (5, &#39;Horror&#39;)&quot;)?;
</a><a href="#h0-4-75" id="h0-4-75" class="i">+    assert_eq!(
</a><a href="#h0-4-76" id="h0-4-76" class="i">+        c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;),
</a><a href="#h0-4-77" id="h0-4-77" class="i">+        Err(Error::Value(&quot;Primary key 5 already exists for table genres&quot;.into()))
</a><a href="#h0-4-78" id="h0-4-78" class="i">+    );
</a><a href="#h0-4-79" id="h0-4-79" class="i">+    c.query(&quot;INSERT INTO genres VALUES (6, &#39;Western&#39;)&quot;)?;
</a><a href="#h0-4-80" id="h0-4-80" class="i">+    assert_eq!(c.txn(), Some((8, Mode::ReadWrite)));
</a><a href="#h0-4-81" id="h0-4-81" class="i">+    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 8 });
</a><a href="#h0-4-82" id="h0-4-82" class="i">+    assert_eq!(c.txn(), None);
</a><a href="#h0-4-83" id="h0-4-83" class="i">+    assert_rows(
</a><a href="#h0-4-84" id="h0-4-84" class="i">+        c.query(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h0-4-85" id="h0-4-85" class="i">+        vec![
</a><a href="#h0-4-86" id="h0-4-86" class="i">+            vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h0-4-87" id="h0-4-87" class="i">+            vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h0-4-88" id="h0-4-88" class="i">+            vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h0-4-89" id="h0-4-89" class="i">+            vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h0-4-90" id="h0-4-90" class="i">+            vec![Value::Integer(5), Value::String(&quot;Horror&quot;.into())],
</a><a href="#h0-4-91" id="h0-4-91" class="i">+            vec![Value::Integer(6), Value::String(&quot;Western&quot;.into())],
</a><a href="#h0-4-92" id="h0-4-92" class="i">+        ],
</a><a href="#h0-4-93" id="h0-4-93" class="i">+    );
</a><a href="#h0-4-94" id="h0-4-94" class="i">+
</a><a href="#h0-4-95" id="h0-4-95" class="i">+    Ok(())
</a><a href="#h0-4-96" id="h0-4-96" class="i">+}
</a><a href="#h0-4-97" id="h0-4-97" class="i">+
</a><a href="#h0-4-98" id="h0-4-98" class="i">+fn assert_rows(result: ResultSet, expect: Vec&lt;Row&gt;) {
</a><a href="#h0-4-99" id="h0-4-99" class="i">+    match result {
</a><a href="#h0-4-100" id="h0-4-100" class="i">+        ResultSet::Query { relation: Relation { rows: Some(rows), .. } } =&gt; {
</a><a href="#h0-4-101" id="h0-4-101" class="i">+            assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap(), expect)
</a><a href="#h0-4-102" id="h0-4-102" class="i">+        }
</a><a href="#h0-4-103" id="h0-4-103" class="i">+        r =&gt; panic!(&quot;Unexpected result {:?}&quot;, r),
</a><a href="#h0-4-104" id="h0-4-104" class="i">+    }
</a><a href="#h0-4-105" id="h0-4-105" class="i">+}
</a></pre>
</div>
</body>
</html>
