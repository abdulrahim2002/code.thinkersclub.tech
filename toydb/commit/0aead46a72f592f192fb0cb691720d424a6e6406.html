<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>kv: added naïve iter_prefix() implementation - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/0aead46a72f592f192fb0cb691720d424a6e6406.html">0aead46a72f592f192fb0cb691720d424a6e6406</a>
<b>parent</b> <a href="../commit/8c761d7aed7e899e0998490cca26218f186345e0.html">8c761d7aed7e899e0998490cca26218f186345e0</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Wed,  4 Sep 2019 22:20:52 +0200

kv: added naïve iter_prefix() implementation

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/kv/file.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/kv/memory.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/kv/mod.rs</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/kv/raft.rs</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>4 files changed, 84 insertions(+), 3 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/kv/file.rs.html">src/kv/file.rs</a> b/<a href="../file/src/kv/file.rs.html">src/kv/file.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h0-0-0" id="h0-0-0" class="d">-use super::Store;
</a><a href="#h0-0-1" id="h0-0-1" class="i">+use super::{Iter, Pair, Store};
</a> use crate::Error;
 use std::collections::BTreeMap;
 use std::io::Seek;
<a href="#h0-1" id="h0-1" class="h">@@ -42,6 +42,12 @@ impl Store for File {
</a>         Ok(self.data.get(key).cloned())
     }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    fn iter_prefix(&amp;self, prefix: &amp;str) -&gt; Box&lt;dyn Iterator&lt;Item = Result&lt;Pair, Error&gt;&gt;&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        let from = prefix.to_string();
</a><a href="#h0-1-5" id="h0-1-5" class="i">+        let to = from.clone() + &amp;std::char::MAX.to_string();
</a><a href="#h0-1-6" id="h0-1-6" class="i">+        Box::new(Iter::from(self.data.range(from..to)))
</a><a href="#h0-1-7" id="h0-1-7" class="i">+    }
</a><a href="#h0-1-8" id="h0-1-8" class="i">+
</a>     fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
         self.data.insert(key.to_string(), value);
         self.flush()?;
<b>diff --git a/<a id="h1" href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a> b/<a href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-use super::Store;
</a><a href="#h1-0-1" id="h1-0-1" class="i">+use super::{Iter, Pair, Store};
</a> use crate::Error;
 use std::collections::BTreeMap;
 use std::sync::{Arc, RwLock};
<a href="#h1-1" id="h1-1" class="h">@@ -28,6 +28,12 @@ impl Store for Memory {
</a>         Ok(self.data.clone().read()?.get(key).cloned())
     }
 
<a href="#h1-1-3" id="h1-1-3" class="i">+    fn iter_prefix(&amp;self, prefix: &amp;str) -&gt; Box&lt;dyn Iterator&lt;Item = Result&lt;Pair, Error&gt;&gt;&gt; {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        let from = prefix.to_string();
</a><a href="#h1-1-5" id="h1-1-5" class="i">+        let to = from.clone() + &amp;std::char::MAX.to_string();
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        Box::new(Iter::from(self.data.read().unwrap().range(from..to)))
</a><a href="#h1-1-7" id="h1-1-7" class="i">+    }
</a><a href="#h1-1-8" id="h1-1-8" class="i">+
</a>     fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
         self.data.clone().write()?.insert(key.to_string(), value);
         Ok(())
<b>diff --git a/<a id="h2" href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a> b/<a href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -9,6 +9,8 @@ pub use file::File;
</a> pub use memory::Memory;
 pub use raft::Raft;
 
<a href="#h2-0-3" id="h2-0-3" class="i">+type Pair = (String, Vec&lt;u8&gt;);
</a><a href="#h2-0-4" id="h2-0-4" class="i">+
</a> /// A key-value store
 pub trait Store: &#39;static + Sync + Send + std::fmt::Debug {
     /// Deletes a value in the store, regardless of whether it existed before.
<a href="#h2-1" id="h2-1" class="h">@@ -17,10 +19,42 @@ pub trait Store: &#39;static + Sync + Send + std::fmt::Debug {
</a>     /// Gets a value from the store
     fn get(&amp;self, key: &amp;str) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt;;
 
<a href="#h2-1-3" id="h2-1-3" class="i">+    /// Returns an iterator over all pairs in the store under a key prefix
</a><a href="#h2-1-4" id="h2-1-4" class="i">+    fn iter_prefix(&amp;self, prefix: &amp;str) -&gt; Box&lt;dyn Iterator&lt;Item = Result&lt;Pair, Error&gt;&gt;&gt;;
</a><a href="#h2-1-5" id="h2-1-5" class="i">+
</a>     /// Sets a value in the store
     fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt;;
 }
 
<a href="#h2-1-10" id="h2-1-10" class="i">+/// This is a terrible, temporary iterator implementation which is prepopulated
</a><a href="#h2-1-11" id="h2-1-11" class="i">+/// with all data, to avoid having to deal with trait lifetimes right now.
</a><a href="#h2-1-12" id="h2-1-12" class="i">+struct Iter {
</a><a href="#h2-1-13" id="h2-1-13" class="i">+    stack: Vec&lt;Result&lt;Pair, Error&gt;&gt;,
</a><a href="#h2-1-14" id="h2-1-14" class="i">+}
</a><a href="#h2-1-15" id="h2-1-15" class="i">+
</a><a href="#h2-1-16" id="h2-1-16" class="i">+impl Iter {
</a><a href="#h2-1-17" id="h2-1-17" class="i">+    fn from&lt;&#39;a, I&gt;(iter: I) -&gt; Self
</a><a href="#h2-1-18" id="h2-1-18" class="i">+    where
</a><a href="#h2-1-19" id="h2-1-19" class="i">+        I: DoubleEndedIterator + Iterator&lt;Item = (&amp;&#39;a String, &amp;&#39;a Vec&lt;u8&gt;)&gt;,
</a><a href="#h2-1-20" id="h2-1-20" class="i">+    {
</a><a href="#h2-1-21" id="h2-1-21" class="i">+        Self { stack: iter.map(|(k, v)| Ok((k.clone(), v.clone()))).rev().collect() }
</a><a href="#h2-1-22" id="h2-1-22" class="i">+    }
</a><a href="#h2-1-23" id="h2-1-23" class="i">+
</a><a href="#h2-1-24" id="h2-1-24" class="i">+    fn from_vec(vec: Vec&lt;(String, Vec&lt;u8&gt;)&gt;) -&gt; Self {
</a><a href="#h2-1-25" id="h2-1-25" class="i">+        Self{
</a><a href="#h2-1-26" id="h2-1-26" class="i">+            stack: vec.into_iter().map(Ok).rev().collect(),
</a><a href="#h2-1-27" id="h2-1-27" class="i">+        }
</a><a href="#h2-1-28" id="h2-1-28" class="i">+    }
</a><a href="#h2-1-29" id="h2-1-29" class="i">+}
</a><a href="#h2-1-30" id="h2-1-30" class="i">+
</a><a href="#h2-1-31" id="h2-1-31" class="i">+impl Iterator for Iter {
</a><a href="#h2-1-32" id="h2-1-32" class="i">+    type Item = Result&lt;Pair, Error&gt;;
</a><a href="#h2-1-33" id="h2-1-33" class="i">+
</a><a href="#h2-1-34" id="h2-1-34" class="i">+    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
</a><a href="#h2-1-35" id="h2-1-35" class="i">+        self.stack.pop()
</a><a href="#h2-1-36" id="h2-1-36" class="i">+    }
</a><a href="#h2-1-37" id="h2-1-37" class="i">+}
</a><a href="#h2-1-38" id="h2-1-38" class="i">+
</a> #[cfg(test)]
 pub mod tests {
     use super::*;
<a href="#h2-2" id="h2-2" class="h">@@ -44,6 +78,7 @@ pub mod tests {
</a>         pub fn test(&amp;self) {
             self.test_delete();
             self.test_get();
<a href="#h2-2-3" id="h2-2-3" class="i">+            self.test_iter_prefix();
</a>             self.test_set();
         }
 
<a href="#h2-3" id="h2-3" class="h">@@ -63,6 +98,24 @@ pub mod tests {
</a>             assert_eq!(None, s.get(&quot;b&quot;).unwrap());
         }
 
<a href="#h2-3-3" id="h2-3-3" class="i">+        pub fn test_iter_prefix(&amp;self) {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+            let mut s = self.setup();
</a><a href="#h2-3-5" id="h2-3-5" class="i">+            s.set(&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h2-3-6" id="h2-3-6" class="i">+            s.set(&quot;b&quot;, vec![0x02]).unwrap();
</a><a href="#h2-3-7" id="h2-3-7" class="i">+            s.set(&quot;ba&quot;, vec![0x02, 0x01]).unwrap();
</a><a href="#h2-3-8" id="h2-3-8" class="i">+            s.set(&quot;bb&quot;, vec![0x02, 0x02]).unwrap();
</a><a href="#h2-3-9" id="h2-3-9" class="i">+            s.set(&quot;c&quot;, vec![0x03]).unwrap();
</a><a href="#h2-3-10" id="h2-3-10" class="i">+
</a><a href="#h2-3-11" id="h2-3-11" class="i">+            assert_eq!(
</a><a href="#h2-3-12" id="h2-3-12" class="i">+                vec![
</a><a href="#h2-3-13" id="h2-3-13" class="i">+                    (&quot;b&quot;.to_string(), vec![0x02]),
</a><a href="#h2-3-14" id="h2-3-14" class="i">+                    (&quot;ba&quot;.to_string(), vec![0x02, 0x01]),
</a><a href="#h2-3-15" id="h2-3-15" class="i">+                    (&quot;bb&quot;.to_string(), vec![0x02, 0x02]),
</a><a href="#h2-3-16" id="h2-3-16" class="i">+                ],
</a><a href="#h2-3-17" id="h2-3-17" class="i">+                s.iter_prefix(&quot;b&quot;).collect::&lt;Result&lt;Vec&lt;(String, Vec&lt;u8&gt;)&gt;, Error&gt;&gt;().unwrap()
</a><a href="#h2-3-18" id="h2-3-18" class="i">+            )
</a><a href="#h2-3-19" id="h2-3-19" class="i">+        }
</a><a href="#h2-3-20" id="h2-3-20" class="i">+
</a>         pub fn test_set(&amp;self) {
             let mut s = self.setup();
             s.set(&quot;a&quot;, vec![0x01]).unwrap();
<b>diff --git a/<a id="h3" href="../file/src/kv/raft.rs.html">src/kv/raft.rs</a> b/<a href="../file/src/kv/raft.rs.html">src/kv/raft.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::Store;
</a><a href="#h3-0-1" id="h3-0-1" class="i">+use super::{Iter, Pair, Store};
</a> use crate::raft;
 use crate::utility::{deserialize, serialize};
 use crate::Error;
<a href="#h3-1" id="h3-1" class="h">@@ -38,6 +38,14 @@ impl Store for Raft {
</a>         Ok(deserialize(self.raft.read(serialize(Read::Get(key.to_string()))?)?)?)
     }
 
<a href="#h3-1-3" id="h3-1-3" class="i">+    fn iter_prefix(&amp;self, prefix: &amp;str) -&gt; Box&lt;dyn Iterator&lt;Item = Result&lt;Pair, Error&gt;&gt;&gt; {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+        let items: Vec&lt;(String, Vec&lt;u8&gt;)&gt; = deserialize(
</a><a href="#h3-1-5" id="h3-1-5" class="i">+            self.raft.read(serialize(Read::GetPrefix(prefix.to_string())).unwrap()).unwrap(),
</a><a href="#h3-1-6" id="h3-1-6" class="i">+        )
</a><a href="#h3-1-7" id="h3-1-7" class="i">+        .unwrap();
</a><a href="#h3-1-8" id="h3-1-8" class="i">+        Box::new(Iter::from_vec(items))
</a><a href="#h3-1-9" id="h3-1-9" class="i">+    }
</a><a href="#h3-1-10" id="h3-1-10" class="i">+
</a>     fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
         self.raft.mutate(serialize(Mutation::Set(key.to_string(), value))?)?;
         Ok(())
<a href="#h3-2" id="h3-2" class="h">@@ -58,6 +66,8 @@ enum Mutation {
</a> enum Read {
     /// Fetches a key
     Get(String),
<a href="#h3-2-3" id="h3-2-3" class="i">+    /// Fetches an array of pairs under a key prefix
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    GetPrefix(String),
</a> }
 
 /// The underlying state machine for the store
<a href="#h3-3" id="h3-3" class="h">@@ -101,6 +111,12 @@ impl raft::State for State {
</a>                 info!(&quot;Getting {}&quot;, key);
                 Ok(serialize(self.store.get(&amp;key)?)?)
             }
<a href="#h3-3-3" id="h3-3-3" class="i">+            Read::GetPrefix(prefix) =&gt; {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+                info!(&quot;Getting pairs under prefix {}&quot;, prefix);
</a><a href="#h3-3-5" id="h3-3-5" class="i">+                let pairs: Vec&lt;(String, Vec&lt;u8&gt;)&gt; =
</a><a href="#h3-3-6" id="h3-3-6" class="i">+                    self.store.iter_prefix(&amp;prefix).collect::&lt;Result&lt;_, Error&gt;&gt;()?;
</a><a href="#h3-3-7" id="h3-3-7" class="i">+                Ok(serialize(pairs)?)
</a><a href="#h3-3-8" id="h3-3-8" class="i">+            }
</a>         }
     }
 }
</pre>
</div>
</body>
</html>
