<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Don&#39;t use mutable borrows for MVCC txn set and delete. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/61b37b18ae36afb3477f208f6350a1d27b245dd2.html">61b37b18ae36afb3477f208f6350a1d27b245dd2</a>
<b>parent</b> <a href="../commit/42d4a20355ecb557d75b312262523bc0544d1070.html">42d4a20355ecb557d75b312262523bc0544d1070</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 10 Sep 2023 14:39:57 +0200

Don&#39;t use mutable borrows for MVCC txn set and delete.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/storage/mvcc.rs</a></td><td> | </td><td class="num">110</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
</table></pre><pre>1 file changed, 55 insertions(+), 55 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -503,12 +503,12 @@ impl&lt;E: Engine&gt; Transaction&lt;E&gt; {
</a>     }
 
     /// Deletes a key.
<a href="#h0-0-3" id="h0-0-3" class="d">-    pub fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    pub fn delete(&amp;self, key: &amp;[u8]) -&gt; Result&lt;()&gt; {
</a>         self.write_version(key, None)
     }
 
     /// Sets a value for a key.
<a href="#h0-0-9" id="h0-0-9" class="d">-    pub fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-10" id="h0-0-10" class="i">+    pub fn set(&amp;self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a>         self.write_version(key, Some(value))
     }
 
<a href="#h0-1" id="h0-1" class="h">@@ -850,21 +850,21 @@ pub mod tests {
</a>         let mvcc = setup();
 
         // Start a concurrent transaction that should be invisible.
<a href="#h0-1-3" id="h0-1-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        let t1 = mvcc.begin()?;
</a>         t1.set(b&quot;other&quot;, vec![1])?;
 
         // Write a couple of versions for a key. Commit the concurrent one in between.
<a href="#h0-1-8" id="h0-1-8" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-1-9" id="h0-1-9" class="i">+        let t2 = mvcc.begin()?;
</a>         t2.set(b&quot;key&quot;, vec![2])?;
         t2.commit()?;
 
<a href="#h0-1-13" id="h0-1-13" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-1-14" id="h0-1-14" class="i">+        let t3 = mvcc.begin()?;
</a>         t3.set(b&quot;key&quot;, vec![3])?;
         t3.commit()?;
 
         t1.commit()?;
 
<a href="#h0-1-20" id="h0-1-20" class="d">-        let mut t4 = mvcc.begin()?;
</a><a href="#h0-1-21" id="h0-1-21" class="i">+        let t4 = mvcc.begin()?;
</a>         t4.set(b&quot;key&quot;, vec![4])?;
         t4.commit()?;
 
<a href="#h0-2" id="h0-2" class="h">@@ -899,7 +899,7 @@ pub mod tests {
</a>         let mvcc = setup();
 
         // We first write a set of values that should be visible
<a href="#h0-2-3" id="h0-2-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+        let t1 = mvcc.begin()?;
</a>         t1.set(b&quot;a&quot;, b&quot;t1&quot;.to_vec())?;
         t1.set(b&quot;b&quot;, b&quot;t1&quot;.to_vec())?;
         t1.commit()?;
<a href="#h0-3" id="h0-3" class="h">@@ -907,9 +907,9 @@ pub mod tests {
</a>         // We then start three transactions, of which we will resume t3.
         // We commit t2 and t4&#39;s changes, which should not be visible,
         // and write a change for t3 which should be visible.
<a href="#h0-3-3" id="h0-3-3" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-3-4" id="h0-3-4" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-3-5" id="h0-3-5" class="d">-        let mut t4 = mvcc.begin()?;
</a><a href="#h0-3-6" id="h0-3-6" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h0-3-7" id="h0-3-7" class="i">+        let t3 = mvcc.begin()?;
</a><a href="#h0-3-8" id="h0-3-8" class="i">+        let t4 = mvcc.begin()?;
</a> 
         t2.set(b&quot;a&quot;, b&quot;t2&quot;.to_vec())?;
         t3.set(b&quot;b&quot;, b&quot;t3&quot;.to_vec())?;
<a href="#h0-4" id="h0-4" class="h">@@ -972,13 +972,13 @@ pub mod tests {
</a>     fn test_txn_delete_conflict() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-4-3" id="h0-4-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-4-4" id="h0-4-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;key&quot;, vec![0x00])?;
         txn.commit()?;
 
<a href="#h0-4-8" id="h0-4-8" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-4-9" id="h0-4-9" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-4-10" id="h0-4-10" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-4-11" id="h0-4-11" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h0-4-12" id="h0-4-12" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h0-4-13" id="h0-4-13" class="i">+        let t3 = mvcc.begin()?;
</a> 
         t2.delete(b&quot;key&quot;)?;
         assert_eq!(Err(Error::Serialization), t1.delete(b&quot;key&quot;));
<a href="#h0-5" id="h0-5" class="h">@@ -992,7 +992,7 @@ pub mod tests {
</a>     fn test_txn_delete_idempotent() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-5-3" id="h0-5-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-5-4" id="h0-5-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.delete(b&quot;key&quot;)?;
         txn.commit()?;
 
<a href="#h0-6" id="h0-6" class="h">@@ -1003,7 +1003,7 @@ pub mod tests {
</a>     fn test_txn_get() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-6-3" id="h0-6-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-6-4" id="h0-6-4" class="i">+        let txn = mvcc.begin()?;
</a>         assert_eq!(None, txn.get(b&quot;a&quot;)?);
         txn.set(b&quot;a&quot;, vec![0x01])?;
         assert_eq!(Some(vec![0x01]), txn.get(b&quot;a&quot;)?);
<a href="#h0-7" id="h0-7" class="h">@@ -1017,11 +1017,11 @@ pub mod tests {
</a>     #[test]
     fn test_txn_get_deleted() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
<a href="#h0-7-3" id="h0-7-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-7-4" id="h0-7-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;a&quot;, vec![0x01])?;
         txn.commit()?;
 
<a href="#h0-7-8" id="h0-7-8" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-7-9" id="h0-7-9" class="i">+        let txn = mvcc.begin()?;
</a>         txn.delete(b&quot;a&quot;)?;
         txn.commit()?;
 
<a href="#h0-8" id="h0-8" class="h">@@ -1036,9 +1036,9 @@ pub mod tests {
</a>     fn test_txn_get_hides_newer() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-8-3" id="h0-8-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-8-4" id="h0-8-4" class="i">+        let t1 = mvcc.begin()?;
</a>         let t2 = mvcc.begin()?;
<a href="#h0-8-6" id="h0-8-6" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-8-7" id="h0-8-7" class="i">+        let t3 = mvcc.begin()?;
</a> 
         t1.set(b&quot;a&quot;, vec![0x01])?;
         t1.commit()?;
<a href="#h0-9" id="h0-9" class="h">@@ -1055,10 +1055,10 @@ pub mod tests {
</a>     fn test_txn_get_hides_uncommitted() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-9-3" id="h0-9-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-9-4" id="h0-9-4" class="i">+        let t1 = mvcc.begin()?;
</a>         t1.set(b&quot;a&quot;, vec![0x01])?;
         let t2 = mvcc.begin()?;
<a href="#h0-9-7" id="h0-9-7" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-9-8" id="h0-9-8" class="i">+        let t3 = mvcc.begin()?;
</a>         t3.set(b&quot;c&quot;, vec![0x03])?;
 
         assert_eq!(None, t2.get(b&quot;a&quot;)?);
<a href="#h0-10" id="h0-10" class="h">@@ -1071,15 +1071,15 @@ pub mod tests {
</a>     fn test_txn_get_readonly_historical() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-10-3" id="h0-10-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-10-4" id="h0-10-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;a&quot;, vec![0x01])?;
         txn.commit()?;
 
<a href="#h0-10-8" id="h0-10-8" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-10-9" id="h0-10-9" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;b&quot;, vec![0x02])?;
         txn.commit()?;
 
<a href="#h0-10-13" id="h0-10-13" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-10-14" id="h0-10-14" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;c&quot;, vec![0x03])?;
         txn.commit()?;
 
<a href="#h0-11" id="h0-11" class="h">@@ -1095,7 +1095,7 @@ pub mod tests {
</a>     fn test_txn_get_serial() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-11-3" id="h0-11-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-11-4" id="h0-11-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;a&quot;, vec![0x01])?;
         txn.commit()?;
 
<a href="#h0-12" id="h0-12" class="h">@@ -1109,7 +1109,7 @@ pub mod tests {
</a>     fn test_txn_scan() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-12-3" id="h0-12-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-12-4" id="h0-12-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;a&quot;, vec![0x01])?;
         txn.delete(b&quot;b&quot;)?;
         txn.set(b&quot;c&quot;, vec![0x01])?;
<a href="#h0-13" id="h0-13" class="h">@@ -1117,25 +1117,25 @@ pub mod tests {
</a>         txn.set(b&quot;e&quot;, vec![0x01])?;
         txn.commit()?;
 
<a href="#h0-13-3" id="h0-13-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-13-4" id="h0-13-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;c&quot;, vec![0x02])?;
         txn.set(b&quot;d&quot;, vec![0x02])?;
         txn.set(b&quot;e&quot;, vec![0x02])?;
         txn.commit()?;
 
<a href="#h0-13-10" id="h0-13-10" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-13-11" id="h0-13-11" class="i">+        let txn = mvcc.begin()?;
</a>         txn.delete(b&quot;c&quot;)?;
         txn.set(b&quot;d&quot;, vec![0x03])?;
         txn.set(b&quot;e&quot;, vec![0x03])?;
         txn.commit()?;
 
<a href="#h0-13-17" id="h0-13-17" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-13-18" id="h0-13-18" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;c&quot;, vec![0x04])?;
         txn.set(b&quot;d&quot;, vec![0x04])?;
         txn.delete(b&quot;e&quot;)?;
         txn.commit()?;
 
<a href="#h0-13-24" id="h0-13-24" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-13-25" id="h0-13-25" class="i">+        let txn = mvcc.begin()?;
</a>         txn.delete(b&quot;d&quot;)?;
         txn.set(b&quot;e&quot;, vec![0x05])?;
         txn.commit()?;
<a href="#h0-14" id="h0-14" class="h">@@ -1186,7 +1186,7 @@ pub mod tests {
</a>         // The key encoding should be resistant to this.
         let mvcc = setup();
 
<a href="#h0-14-3" id="h0-14-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-14-4" id="h0-14-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(&amp;[0], vec![0])?; // v0
         txn.set(&amp;[0], vec![1])?; // v1
         txn.set(&amp;[0, 0, 0, 0, 0, 0, 0, 0, 2], vec![2])?; // v2
<a href="#h0-15" id="h0-15" class="h">@@ -1204,7 +1204,7 @@ pub mod tests {
</a>     #[test]
     fn test_txn_scan_prefix() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
<a href="#h0-15-3" id="h0-15-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-15-4" id="h0-15-4" class="i">+        let txn = mvcc.begin()?;
</a> 
         txn.set(b&quot;a&quot;, vec![0x01])?;
         txn.set(b&quot;az&quot;, vec![0x01, 0x1a])?;
<a href="#h0-16" id="h0-16" class="h">@@ -1256,9 +1256,9 @@ pub mod tests {
</a>     fn test_txn_set_conflict() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-16-3" id="h0-16-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-16-4" id="h0-16-4" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-16-5" id="h0-16-5" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-16-6" id="h0-16-6" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h0-16-7" id="h0-16-7" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h0-16-8" id="h0-16-8" class="i">+        let t3 = mvcc.begin()?;
</a> 
         t2.set(b&quot;key&quot;, vec![0x02])?;
         assert_eq!(Err(Error::Serialization), t1.set(b&quot;key&quot;, vec![0x01]));
<a href="#h0-17" id="h0-17" class="h">@@ -1272,9 +1272,9 @@ pub mod tests {
</a>     fn test_txn_set_conflict_committed() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-17-3" id="h0-17-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-17-4" id="h0-17-4" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-17-5" id="h0-17-5" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-17-6" id="h0-17-6" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h0-17-7" id="h0-17-7" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h0-17-8" id="h0-17-8" class="i">+        let t3 = mvcc.begin()?;
</a> 
         t2.set(b&quot;key&quot;, vec![0x02])?;
         t2.commit()?;
<a href="#h0-18" id="h0-18" class="h">@@ -1288,13 +1288,13 @@ pub mod tests {
</a>     fn test_txn_set_rollback() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-18-3" id="h0-18-3" class="d">-        let mut txn = mvcc.begin()?;
</a><a href="#h0-18-4" id="h0-18-4" class="i">+        let txn = mvcc.begin()?;
</a>         txn.set(b&quot;key&quot;, vec![0x00])?;
         txn.commit()?;
 
         let t1 = mvcc.begin()?;
<a href="#h0-18-9" id="h0-18-9" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-18-10" id="h0-18-10" class="d">-        let mut t3 = mvcc.begin()?;
</a><a href="#h0-18-11" id="h0-18-11" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h0-18-12" id="h0-18-12" class="i">+        let t3 = mvcc.begin()?;
</a> 
         t2.set(b&quot;key&quot;, vec![0x02])?;
         t2.rollback()?;
<a href="#h0-19" id="h0-19" class="h">@@ -1311,8 +1311,8 @@ pub mod tests {
</a>     fn test_txn_anomaly_dirty_write() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-19-3" id="h0-19-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-19-4" id="h0-19-4" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-19-5" id="h0-19-5" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h0-19-6" id="h0-19-6" class="i">+        let t2 = mvcc.begin()?;
</a> 
         t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
         assert_eq!(t2.set(b&quot;key&quot;, b&quot;t2&quot;.to_vec()), Err(Error::Serialization));
<a href="#h0-20" id="h0-20" class="h">@@ -1325,7 +1325,7 @@ pub mod tests {
</a>     fn test_txn_anomaly_dirty_read() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-20-3" id="h0-20-3" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-20-4" id="h0-20-4" class="i">+        let t1 = mvcc.begin()?;
</a>         let t2 = mvcc.begin()?;
 
         t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
<a href="#h0-21" id="h0-21" class="h">@@ -1339,12 +1339,12 @@ pub mod tests {
</a>     fn test_txn_anomaly_lost_update() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-21-3" id="h0-21-3" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h0-21-4" id="h0-21-4" class="i">+        let t0 = mvcc.begin()?;
</a>         t0.set(b&quot;key&quot;, b&quot;t0&quot;.to_vec())?;
         t0.commit()?;
 
<a href="#h0-21-8" id="h0-21-8" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-21-9" id="h0-21-9" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-21-10" id="h0-21-10" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h0-21-11" id="h0-21-11" class="i">+        let t2 = mvcc.begin()?;
</a> 
         t1.get(b&quot;key&quot;)?;
         t2.get(b&quot;key&quot;)?;
<a href="#h0-22" id="h0-22" class="h">@@ -1360,11 +1360,11 @@ pub mod tests {
</a>     fn test_txn_anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-22-3" id="h0-22-3" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h0-22-4" id="h0-22-4" class="i">+        let t0 = mvcc.begin()?;
</a>         t0.set(b&quot;key&quot;, b&quot;t0&quot;.to_vec())?;
         t0.commit()?;
 
<a href="#h0-22-8" id="h0-22-8" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h0-22-9" id="h0-22-9" class="i">+        let t1 = mvcc.begin()?;
</a>         let t2 = mvcc.begin()?;
 
         assert_eq!(Some(b&quot;t0&quot;.to_vec()), t2.get(b&quot;key&quot;)?);
<a href="#h0-23" id="h0-23" class="h">@@ -1380,13 +1380,13 @@ pub mod tests {
</a>     fn test_txn_anomaly_read_skew() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-23-3" id="h0-23-3" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h0-23-4" id="h0-23-4" class="i">+        let t0 = mvcc.begin()?;
</a>         t0.set(b&quot;a&quot;, b&quot;t0&quot;.to_vec())?;
         t0.set(b&quot;b&quot;, b&quot;t0&quot;.to_vec())?;
         t0.commit()?;
 
         let t1 = mvcc.begin()?;
<a href="#h0-23-10" id="h0-23-10" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-23-11" id="h0-23-11" class="i">+        let t2 = mvcc.begin()?;
</a> 
         assert_eq!(Some(b&quot;t0&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
         t2.set(b&quot;a&quot;, b&quot;t2&quot;.to_vec())?;
<a href="#h0-24" id="h0-24" class="h">@@ -1403,13 +1403,13 @@ pub mod tests {
</a>     fn test_txn_anomaly_phantom_read() -&gt; Result&lt;()&gt; {
         let mvcc = setup();
 
<a href="#h0-24-3" id="h0-24-3" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h0-24-4" id="h0-24-4" class="i">+        let t0 = mvcc.begin()?;
</a>         t0.set(b&quot;a&quot;, b&quot;true&quot;.to_vec())?;
         t0.set(b&quot;b&quot;, b&quot;false&quot;.to_vec())?;
         t0.commit()?;
 
         let t1 = mvcc.begin()?;
<a href="#h0-24-10" id="h0-24-10" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h0-24-11" id="h0-24-11" class="i">+        let t2 = mvcc.begin()?;
</a> 
         assert_eq!(Some(b&quot;true&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
         assert_eq!(Some(b&quot;false&quot;.to_vec()), t1.get(b&quot;b&quot;)?);
<a href="#h0-25" id="h0-25" class="h">@@ -1456,7 +1456,7 @@ pub mod tests {
</a>         let m = setup();
 
         // Unversioned keys should not interact with versioned keys.
<a href="#h0-25-3" id="h0-25-3" class="d">-        let mut txn = m.begin()?;
</a><a href="#h0-25-4" id="h0-25-4" class="i">+        let txn = m.begin()?;
</a>         txn.set(b&quot;foo&quot;, b&quot;bar&quot;.to_vec())?;
         txn.commit()?;
 
</pre>
</div>
</body>
</html>
