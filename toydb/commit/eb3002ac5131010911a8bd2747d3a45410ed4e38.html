<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Added support for time-travel queries - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/eb3002ac5131010911a8bd2747d3a45410ed4e38.html">eb3002ac5131010911a8bd2747d3a45410ed4e38</a>
<b>parent</b> <a href="../commit/56033813316b85233672388e25587198afc8d703.html">56033813316b85233672388e25587198afc8d703</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun,  1 Dec 2019 19:47:49 +0100

Added support for time-travel queries

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">README.md</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/kv/mvcc.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/server/toydb.rs</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/parser/ast.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/parser/lexer.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/parser/mod.rs</a></td><td> | </td><td class="num">17</td><td><span class="i">++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>6 files changed, 74 insertions(+), 9 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -34,6 +34,39 @@ toydb&gt; SELECT * FROM movies
</a> 3|Her
 ```
 
<a href="#h0-0-3" id="h0-0-3" class="i">+ACID transactions are supported via snapshot isolation:
</a><a href="#h0-0-4" id="h0-0-4" class="i">+
</a><a href="#h0-0-5" id="h0-0-5" class="i">+```
</a><a href="#h0-0-6" id="h0-0-6" class="i">+toydb&gt; BEGIN
</a><a href="#h0-0-7" id="h0-0-7" class="i">+Began transaction 2
</a><a href="#h0-0-8" id="h0-0-8" class="i">+toydb&gt; INSERT INTO movies VALUES (4, &#39;Alien vs. Predator&#39;)
</a><a href="#h0-0-9" id="h0-0-9" class="i">+toydb&gt; ROLLBACK
</a><a href="#h0-0-10" id="h0-0-10" class="i">+Rolled back transaction 2
</a><a href="#h0-0-11" id="h0-0-11" class="i">+
</a><a href="#h0-0-12" id="h0-0-12" class="i">+toydb&gt; BEGIN
</a><a href="#h0-0-13" id="h0-0-13" class="i">+Began transaction 3
</a><a href="#h0-0-14" id="h0-0-14" class="i">+toydb&gt; INSERT INTO movies VALUES (4, &#39;Predator&#39;)
</a><a href="#h0-0-15" id="h0-0-15" class="i">+toydb&gt; COMMIT
</a><a href="#h0-0-16" id="h0-0-16" class="i">+Committed transaction 3
</a><a href="#h0-0-17" id="h0-0-17" class="i">+
</a><a href="#h0-0-18" id="h0-0-18" class="i">+toydb&gt; SELECT * FROM movies
</a><a href="#h0-0-19" id="h0-0-19" class="i">+1|Sicario
</a><a href="#h0-0-20" id="h0-0-20" class="i">+2|Stalker
</a><a href="#h0-0-21" id="h0-0-21" class="i">+3|Her
</a><a href="#h0-0-22" id="h0-0-22" class="i">+4|Predator
</a><a href="#h0-0-23" id="h0-0-23" class="i">+```
</a><a href="#h0-0-24" id="h0-0-24" class="i">+
</a><a href="#h0-0-25" id="h0-0-25" class="i">+Time-travel queries are also supported:
</a><a href="#h0-0-26" id="h0-0-26" class="i">+
</a><a href="#h0-0-27" id="h0-0-27" class="i">+```
</a><a href="#h0-0-28" id="h0-0-28" class="i">+toydb&gt; BEGIN TRANSACTION READ ONLY AS OF SYSTEM TIME 2
</a><a href="#h0-0-29" id="h0-0-29" class="i">+Began read-only transaction in snapshot of version 2
</a><a href="#h0-0-30" id="h0-0-30" class="i">+toydb&gt; SELECT * FROM movies
</a><a href="#h0-0-31" id="h0-0-31" class="i">+1|Sicario
</a><a href="#h0-0-32" id="h0-0-32" class="i">+2|Stalker
</a><a href="#h0-0-33" id="h0-0-33" class="i">+3|Her
</a><a href="#h0-0-34" id="h0-0-34" class="i">+```
</a><a href="#h0-0-35" id="h0-0-35" class="i">+
</a> ## Project Outline
 
 - [x] **Networking:** gRPC for internal and external communication, no security.
<a href="#h0-1" id="h0-1" class="h">@@ -50,17 +83,17 @@ toydb&gt; SELECT * FROM movies
</a> 
 - [x] **Transactions:** Self-written ACID-compliant transaction engine with MVCC-based snapshot isolation.
 
<a href="#h0-1-3" id="h0-1-3" class="d">-- [x] **Query Engine:** Self-written iterator-based engine with simple heuristic optimizer.
</a><a href="#h0-1-4" id="h0-1-4" class="i">+- [x] **Query Engine:** Self-written iterator-based engine with simple heuristic optimizer and time-travel support.
</a> 
   - [ ] Predicate pushdown.
 
<a href="#h0-1-8" id="h0-1-8" class="d">-  - [ ] Time travel queries.
</a><a href="#h0-1-9" id="h0-1-9" class="d">-
</a> - [ ] **Language:** Self-written SQL parser with support for:
 
   - [x] `[CREATE|DROP] TABLE ...`
   - [ ] `[CREATE|DROP] INDEX ...`
<a href="#h0-1-14" id="h0-1-14" class="d">-  - [ ] `BEGIN`, `COMMIT`, and `ROLLBACK`
</a><a href="#h0-1-15" id="h0-1-15" class="i">+  - [x] `BEGIN`, `COMMIT`, and `ROLLBACK`
</a><a href="#h0-1-16" id="h0-1-16" class="i">+    - [x] `READ ONLY`
</a><a href="#h0-1-17" id="h0-1-17" class="i">+    - [x] `AS OF SYSTEM TIME &lt;txn-id&gt;`
</a>   - [x] `INSERT INTO ... (...) VALUES (...)`
   - [x] `UPDATE ... SET ... WHERE ...`
   - [x] `DELETE FROM ... WHERE ...`
<b>diff --git a/<a id="h1" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -68,6 +68,9 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>     }
 
     /// Creates a new read-only transaction at the given version
<a href="#h1-0-3" id="h1-0-3" class="i">+    // FIXME Actually, read-only transactions must be persisted as well, since we need to
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    // be able to resume them with the correct invisible transactions. This means that all
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    // of the logic in sql::engine::Snapshot must be removed.
</a>     fn new_readonly(storage: Arc&lt;RwLock&lt;S&gt;&gt;, id: Option&lt;u64&gt;) -&gt; Result&lt;Self, Error&gt; {
         let next_id = match storage.read()?.read(&amp;Key::TxnNext.encode())? {
             Some(v) =&gt; deserialize(v)?,
<b>diff --git a/<a id="h2" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -167,14 +167,19 @@ impl ToyDB {
</a>                 }
             }
             client::Mode::Statement =&gt; match statement {
<a href="#h2-0-3" id="h2-0-3" class="d">-                sql::ast::Statement::Begin { readonly: false } =&gt; {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                sql::ast::Statement::Begin { readonly: false, version } =&gt; {
</a><a href="#h2-0-5" id="h2-0-5" class="i">+                    if version.is_some() {
</a><a href="#h2-0-6" id="h2-0-6" class="i">+                        return Err(Error::Value(
</a><a href="#h2-0-7" id="h2-0-7" class="i">+                            &quot;Can&#39;t start read-write transaction in a given version&quot;.into(),
</a><a href="#h2-0-8" id="h2-0-8" class="i">+                        ));
</a><a href="#h2-0-9" id="h2-0-9" class="i">+                    }
</a>                     let txn = self.engine.begin()?;
                     let mut rs = sql::types::ResultSet::empty();
                     rs.effect = Some(client::Effect::Begin { id: txn.id(), readonly: false });
                     Ok(rs)
                 }
<a href="#h2-0-15" id="h2-0-15" class="d">-                sql::ast::Statement::Begin { readonly: true } =&gt; {
</a><a href="#h2-0-16" id="h2-0-16" class="d">-                    let txn = self.engine.snapshot(None)?;
</a><a href="#h2-0-17" id="h2-0-17" class="i">+                sql::ast::Statement::Begin { readonly: true, version } =&gt; {
</a><a href="#h2-0-18" id="h2-0-18" class="i">+                    let txn = self.engine.snapshot(version)?;
</a>                     let mut rs = sql::types::ResultSet::empty();
                     rs.effect = Some(client::Effect::Begin { id: txn.id(), readonly: true });
                     Ok(rs)
<b>diff --git a/<a id="h3" href="../file/src/sql/parser/ast.rs.html">src/sql/parser/ast.rs</a> b/<a href="../file/src/sql/parser/ast.rs.html">src/sql/parser/ast.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -6,7 +6,7 @@ use std::collections::BTreeMap;
</a> #[allow(clippy::large_enum_variant)]
 pub enum Statement {
     /// A BEGIN statement
<a href="#h3-0-3" id="h3-0-3" class="d">-    Begin { readonly: bool },
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    Begin { readonly: bool, version: Option&lt;u64&gt; },
</a>     /// A COMMIT statement
     Commit,
     /// A ROLLBACK statement
<b>diff --git a/<a id="h4" href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a> b/<a href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -90,6 +90,7 @@ pub enum Keyword {
</a>     Limit,
     Not,
     Null,
<a href="#h4-0-3" id="h4-0-3" class="i">+    Of,
</a>     Offset,
     Only,
     Or,
<a href="#h4-1" id="h4-1" class="h">@@ -99,7 +100,9 @@ pub enum Keyword {
</a>     Rollback,
     Select,
     Set,
<a href="#h4-1-3" id="h4-1-3" class="i">+    System,
</a>     Table,
<a href="#h4-1-5" id="h4-1-5" class="i">+    Time,
</a>     Transaction,
     True,
     Update,
<a href="#h4-2" id="h4-2" class="h">@@ -133,6 +136,7 @@ impl Keyword {
</a>             &quot;LIMIT&quot; =&gt; Self::Limit,
             &quot;NOT&quot; =&gt; Self::Not,
             &quot;NULL&quot; =&gt; Self::Null,
<a href="#h4-2-3" id="h4-2-3" class="i">+            &quot;OF&quot; =&gt; Self::Of,
</a>             &quot;OFFSET&quot; =&gt; Self::Offset,
             &quot;ONLY&quot; =&gt; Self::Only,
             &quot;OR&quot; =&gt; Self::Or,
<a href="#h4-3" id="h4-3" class="h">@@ -142,7 +146,9 @@ impl Keyword {
</a>             &quot;ROLLBACK&quot; =&gt; Self::Rollback,
             &quot;SELECT&quot; =&gt; Self::Select,
             &quot;SET&quot; =&gt; Self::Set,
<a href="#h4-3-3" id="h4-3-3" class="i">+            &quot;SYSTEM&quot; =&gt; Self::System,
</a>             &quot;TABLE&quot; =&gt; Self::Table,
<a href="#h4-3-5" id="h4-3-5" class="i">+            &quot;TIME&quot; =&gt; Self::Time,
</a>             &quot;TRANSACTION&quot; =&gt; Self::Transaction,
             &quot;TRUE&quot; =&gt; Self::True,
             &quot;UPDATE&quot; =&gt; Self::Update,
<a href="#h4-4" id="h4-4" class="h">@@ -177,6 +183,7 @@ impl Keyword {
</a>             Self::Limit =&gt; &quot;LIMIT&quot;,
             Self::Not =&gt; &quot;NOT&quot;,
             Self::Null =&gt; &quot;NULL&quot;,
<a href="#h4-4-3" id="h4-4-3" class="i">+            Self::Of =&gt; &quot;OF&quot;,
</a>             Self::Offset =&gt; &quot;OFFSET&quot;,
             Self::Only =&gt; &quot;ONLY&quot;,
             Self::Or =&gt; &quot;OR&quot;,
<a href="#h4-5" id="h4-5" class="h">@@ -186,7 +193,9 @@ impl Keyword {
</a>             Self::Rollback =&gt; &quot;ROLLBACK&quot;,
             Self::Select =&gt; &quot;SELECT&quot;,
             Self::Set =&gt; &quot;SET&quot;,
<a href="#h4-5-3" id="h4-5-3" class="i">+            Self::System =&gt; &quot;SYSTEM&quot;,
</a>             Self::Table =&gt; &quot;TABLE&quot;,
<a href="#h4-5-5" id="h4-5-5" class="i">+            Self::Time =&gt; &quot;TIME&quot;,
</a>             Self::Transaction =&gt; &quot;TRANSACTION&quot;,
             Self::True =&gt; &quot;TRUE&quot;,
             Self::Update =&gt; &quot;UPDATE&quot;,
<b>diff --git a/<a id="h5" href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a> b/<a href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -293,6 +293,7 @@ impl&lt;&#39;a&gt; Parser&lt;&#39;a&gt; {
</a>         match self.next()? {
             Token::Keyword(Keyword::Begin) =&gt; {
                 let mut readonly = false;
<a href="#h5-0-3" id="h5-0-3" class="i">+                let mut version = None;
</a>                 self.next_if_token(Keyword::Transaction.into());
                 if self.next_if_token(Keyword::Read.into()).is_some() {
                     match self.next()? {
<a href="#h5-1" id="h5-1" class="h">@@ -301,7 +302,21 @@ impl&lt;&#39;a&gt; Parser&lt;&#39;a&gt; {
</a>                         token =&gt; return Err(Error::Parse(format!(&quot;Unexpected token {}&quot;, token))),
                     }
                 }
<a href="#h5-1-3" id="h5-1-3" class="d">-                Ok(ast::Statement::Begin { readonly })
</a><a href="#h5-1-4" id="h5-1-4" class="i">+                if self.next_if_token(Keyword::As.into()).is_some() {
</a><a href="#h5-1-5" id="h5-1-5" class="i">+                    self.next_expect(Some(Keyword::Of.into()))?;
</a><a href="#h5-1-6" id="h5-1-6" class="i">+                    self.next_expect(Some(Keyword::System.into()))?;
</a><a href="#h5-1-7" id="h5-1-7" class="i">+                    self.next_expect(Some(Keyword::Time.into()))?;
</a><a href="#h5-1-8" id="h5-1-8" class="i">+                    match self.next()? {
</a><a href="#h5-1-9" id="h5-1-9" class="i">+                        Token::Number(n) =&gt; version = Some(n.parse::&lt;u64&gt;()?),
</a><a href="#h5-1-10" id="h5-1-10" class="i">+                        token =&gt; {
</a><a href="#h5-1-11" id="h5-1-11" class="i">+                            return Err(Error::Parse(format!(
</a><a href="#h5-1-12" id="h5-1-12" class="i">+                                &quot;Unexpected token {}, wanted number&quot;,
</a><a href="#h5-1-13" id="h5-1-13" class="i">+                                token
</a><a href="#h5-1-14" id="h5-1-14" class="i">+                            )))
</a><a href="#h5-1-15" id="h5-1-15" class="i">+                        }
</a><a href="#h5-1-16" id="h5-1-16" class="i">+                    }
</a><a href="#h5-1-17" id="h5-1-17" class="i">+                }
</a><a href="#h5-1-18" id="h5-1-18" class="i">+                Ok(ast::Statement::Begin { readonly, version })
</a>             }
             Token::Keyword(Keyword::Commit) =&gt; Ok(ast::Statement::Commit),
             Token::Keyword(Keyword::Rollback) =&gt; Ok(ast::Statement::Rollback),
</pre>
</div>
</body>
</html>
