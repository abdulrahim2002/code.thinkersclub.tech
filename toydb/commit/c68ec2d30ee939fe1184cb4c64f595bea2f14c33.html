<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: include last term in append response - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c68ec2d30ee939fe1184cb4c64f595bea2f14c33.html">c68ec2d30ee939fe1184cb4c64f595bea2f14c33</a>
<b>parent</b> <a href="../commit/1c6c813ccfe30a1bade45866a504d7c3581b1ebc.html">1c6c813ccfe30a1bade45866a504d7c3581b1ebc</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 13 Apr 2024 13:54:09 +0200

raft: include last term in append response

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node/follower.rs</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/leader.rs</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++</span><span class="d">--------------</span></td></tr>
</table></pre><pre>3 files changed, 30 insertions(+), 30 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -71,9 +71,9 @@ pub enum Message {
</a>         /// If true, the follower rejected the leader&#39;s entries.
         reject: bool,
         /// The index of the follower&#39;s last log entry.
<a href="#h0-0-3" id="h0-0-3" class="d">-        ///
</a><a href="#h0-0-4" id="h0-0-4" class="d">-        /// TODO: should this include last_term as well?
</a>         last_index: Index,
<a href="#h0-0-6" id="h0-0-6" class="i">+        /// The term of the follower&#39;s last log entry.
</a><a href="#h0-0-7" id="h0-0-7" class="i">+        last_term: Term,
</a>     },
 
     /// A client request. This can be submitted to the leader, or to a follower
<b>diff --git a/<a id="h1" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -178,14 +178,12 @@ impl RawNode&lt;Follower&gt; {
</a>                 }
 
                 // Append the entries, if possible.
<a href="#h1-0-3" id="h1-0-3" class="d">-                if base_index &gt; 0 &amp;&amp; !self.log.has(base_index, base_term)? {
</a><a href="#h1-0-4" id="h1-0-4" class="d">-                    debug!(&quot;Rejecting log entries at base {}&quot;, base_index);
</a><a href="#h1-0-5" id="h1-0-5" class="d">-                    let (last_index, _) = self.log.get_last_index();
</a><a href="#h1-0-6" id="h1-0-6" class="d">-                    self.send(msg.from, Message::AppendResponse { reject: true, last_index })?
</a><a href="#h1-0-7" id="h1-0-7" class="d">-                } else {
</a><a href="#h1-0-8" id="h1-0-8" class="d">-                    let last_index = self.log.splice(entries)?;
</a><a href="#h1-0-9" id="h1-0-9" class="d">-                    self.send(msg.from, Message::AppendResponse { reject: false, last_index })?
</a><a href="#h1-0-10" id="h1-0-10" class="i">+                let reject = base_index &gt; 0 &amp;&amp; !self.log.has(base_index, base_term)?;
</a><a href="#h1-0-11" id="h1-0-11" class="i">+                if !reject {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+                    self.log.splice(entries)?;
</a>                 }
<a href="#h1-0-14" id="h1-0-14" class="i">+                let (last_index, last_term) = self.log.get_last_index();
</a><a href="#h1-0-15" id="h1-0-15" class="i">+                self.send(msg.from, Message::AppendResponse { reject, last_index, last_term })?;
</a>             }
 
             // A candidate in this term is requesting our vote.
<a href="#h1-1" id="h1-1" class="h">@@ -651,7 +649,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-1-3" id="h1-1-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 2 },
</a><a href="#h1-1-4" id="h1-1-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 2, last_term: 1 },
</a>             }],
         );
         Ok(())
<a href="#h1-2" id="h1-2" class="h">@@ -687,7 +685,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-2-3" id="h1-2-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 5 },
</a><a href="#h1-2-4" id="h1-2-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a>             }],
         );
         Ok(())
<a href="#h1-3" id="h1-3" class="h">@@ -722,7 +720,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-3-3" id="h1-3-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4 },
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a>             }],
         );
         Ok(())
<a href="#h1-4" id="h1-4" class="h">@@ -757,7 +755,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-4-3" id="h1-4-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4 },
</a><a href="#h1-4-4" id="h1-4-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a>             }],
         );
         Ok(())
<a href="#h1-5" id="h1-5" class="h">@@ -792,7 +790,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-5-3" id="h1-5-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4 },
</a><a href="#h1-5-4" id="h1-5-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a>             }],
         );
         Ok(())
<a href="#h1-6" id="h1-6" class="h">@@ -823,7 +821,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-6-3" id="h1-6-3" class="d">-                message: Message::AppendResponse { reject: true, last_index: 3 },
</a><a href="#h1-6-4" id="h1-6-4" class="i">+                message: Message::AppendResponse { reject: true, last_index: 3, last_term: 2 },
</a>             }],
         );
         Ok(())
<a href="#h1-7" id="h1-7" class="h">@@ -854,7 +852,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-7-3" id="h1-7-3" class="d">-                message: Message::AppendResponse { reject: true, last_index: 3 },
</a><a href="#h1-7-4" id="h1-7-4" class="i">+                message: Message::AppendResponse { reject: true, last_index: 3, last_term: 2 },
</a>             }],
         );
         Ok(())
<b>diff --git a/<a id="h2" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -172,14 +172,17 @@ impl RawNode&lt;Leader&gt; {
</a> 
             // A follower appended log entries we sent it. Record its progress
             // and attempt to commit new entries.
<a href="#h2-0-3" id="h2-0-3" class="d">-            Message::AppendResponse { reject: false, last_index } =&gt; {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            Message::AppendResponse { reject: false, last_index, last_term } =&gt; {
</a>                 assert!(
                     last_index &lt;= self.log.get_last_index().0,
                     &quot;Follower accepted entries after last index&quot;
                 );
<a href="#h2-0-9" id="h2-0-9" class="i">+                assert!(
</a><a href="#h2-0-10" id="h2-0-10" class="i">+                    last_term &lt;= self.log.get_last_index().1,
</a><a href="#h2-0-11" id="h2-0-11" class="i">+                    &quot;Follower accepted entries after last term&quot;
</a><a href="#h2-0-12" id="h2-0-12" class="i">+                );
</a> 
<a href="#h2-0-14" id="h2-0-14" class="d">-                let from = msg.from;
</a><a href="#h2-0-15" id="h2-0-15" class="d">-                let progress = self.role.progress.get_mut(&amp;from).unwrap();
</a><a href="#h2-0-16" id="h2-0-16" class="i">+                let progress = self.role.progress.get_mut(&amp;msg.from).unwrap();
</a>                 if last_index &gt; progress.last {
                     progress.last = last_index;
                     progress.next = last_index + 1;
<a href="#h2-1" id="h2-1" class="h">@@ -195,14 +198,13 @@ impl RawNode&lt;Leader&gt; {
</a>             // slow with long divergent logs, but we keep it simple.
             //
             // TODO: make use of last_index and last_term here.
<a href="#h2-1-3" id="h2-1-3" class="d">-            Message::AppendResponse { reject: true, last_index: _ } =&gt; {
</a><a href="#h2-1-4" id="h2-1-4" class="d">-                let from = msg.from;
</a><a href="#h2-1-5" id="h2-1-5" class="d">-                self.role.progress.entry(from).and_modify(|p| {
</a><a href="#h2-1-6" id="h2-1-6" class="i">+            Message::AppendResponse { reject: true, last_index: _, last_term: _ } =&gt; {
</a><a href="#h2-1-7" id="h2-1-7" class="i">+                self.role.progress.entry(msg.from).and_modify(|p| {
</a>                     if p.next &gt; 1 {
                         p.next -= 1
                     }
                 });
<a href="#h2-1-12" id="h2-1-12" class="d">-                self.send_log(from)?;
</a><a href="#h2-1-13" id="h2-1-13" class="i">+                self.send_log(msg.from)?;
</a>             }
 
             // A client submitted a read command. To ensure linearizability, we
<a href="#h2-2" id="h2-2" class="h">@@ -528,7 +530,7 @@ mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-2-3" id="h2-2-3" class="d">-            message: Message::AppendResponse { reject: false, last_index: 4 },
</a><a href="#h2-2-4" id="h2-2-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a>         })?;
         assert_node(&amp;mut node).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-3" id="h2-3" class="h">@@ -537,7 +539,7 @@ mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h2-3-3" id="h2-3-3" class="d">-            message: Message::AppendResponse { reject: false, last_index: 5 },
</a><a href="#h2-3-4" id="h2-3-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a>         })?;
         assert_node(&amp;mut node).committed(4).applied(4);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-4" id="h2-4" class="h">@@ -546,7 +548,7 @@ mod tests {
</a>             from: 4,
             to: 1,
             term: 3,
<a href="#h2-4-3" id="h2-4-3" class="d">-            message: Message::AppendResponse { reject: false, last_index: 5 },
</a><a href="#h2-4-4" id="h2-4-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a>         })?;
         assert_node(&amp;mut node).committed(5).applied(5);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-5" id="h2-5" class="h">@@ -566,7 +568,7 @@ mod tests {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h2-5-3" id="h2-5-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 5 },
</a><a href="#h2-5-4" id="h2-5-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-6" id="h2-6" class="h">@@ -586,7 +588,7 @@ mod tests {
</a>                 from: peer,
                 to: 1,
                 term: 3,
<a href="#h2-6-3" id="h2-6-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 3 },
</a><a href="#h2-6-4" id="h2-6-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 3, last_term: 3 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-7" id="h2-7" class="h">@@ -604,7 +606,7 @@ mod tests {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h2-7-3" id="h2-7-3" class="d">-                message: Message::AppendResponse { reject: false, last_index: 7 },
</a><a href="#h2-7-4" id="h2-7-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 7, last_term: 3 },
</a>             })
             .unwrap();
     }
<a href="#h2-8" id="h2-8" class="h">@@ -620,7 +622,7 @@ mod tests {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h2-8-3" id="h2-8-3" class="d">-                message: Message::AppendResponse { reject: true, last_index: 0 },
</a><a href="#h2-8-4" id="h2-8-4" class="i">+                message: Message::AppendResponse { reject: true, last_index: 0, last_term: 3 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
</pre>
</div>
</body>
</html>
