<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>server: add server status - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/bafa8ad99fcadca8bbb7a1be8c2a7bab81365496.html">bafa8ad99fcadca8bbb7a1be8c2a7bab81365496</a>
<b>parent</b> <a href="../commit/b5af9e888747634465882427cd08ca4bed97aad4.html">b5af9e888747634465882427cd08ca4bed97aad4</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 13 Apr 2024 10:50:03 +0200

server: add server status

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toysql.rs</a></td><td> | </td><td class="num">7</td><td><span class="i">++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/client.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/message.rs</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/follower.rs</a></td><td> | </td><td class="num">11</td><td><span class="i">+++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/leader.rs</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/server.rs</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">tests/e2e/client.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>7 files changed, 27 insertions(+), 27 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -130,7 +130,7 @@ Node logs: {logs}
</a> MVCC:      {active_txns} active txns, {versions} versions
 Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk, {garbage_percent}% garbage ({sql_storage} engine)
 &quot;#,
<a href="#h0-0-3" id="h0-0-3" class="d">-                    server = status.raft.server,
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                    server = status.server,
</a>                     leader = status.raft.leader,
                     term = status.raft.term,
                     nodes = status.raft.last_index.len(),
<a href="#h0-1" id="h0-1" class="h">@@ -251,10 +251,7 @@ Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk,
</a>         );
 
         let status = self.client.status()?;
<a href="#h0-1-3" id="h0-1-3" class="d">-        println!(
</a><a href="#h0-1-4" id="h0-1-4" class="d">-            &quot;Connected to toyDB node \&quot;{}\&quot;. Enter !help for instructions.&quot;,
</a><a href="#h0-1-5" id="h0-1-5" class="d">-            status.raft.server
</a><a href="#h0-1-6" id="h0-1-6" class="d">-        );
</a><a href="#h0-1-7" id="h0-1-7" class="i">+        println!(&quot;Connected to toyDB node \&quot;{}\&quot;. Enter !help for instructions.&quot;, status.server);
</a> 
         while let Some(input) = self.prompt()? {
             match self.execute(&amp;input) {
<b>diff --git a/<a id="h1" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,7 +1,6 @@
</a> use crate::encoding::bincode;
 use crate::error::{Error, Result};
<a href="#h1-0-2" id="h1-0-2" class="d">-use crate::server::{Request, Response};
</a><a href="#h1-0-3" id="h1-0-3" class="d">-use crate::sql::engine::Status;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+use crate::server::{Request, Response, Status};
</a> use crate::sql::execution::ResultSet;
 use crate::sql::schema::Table;
 
<b>diff --git a/<a id="h2" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -114,10 +114,6 @@ pub enum Response {
</a> /// Raft cluster status.
 #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
 pub struct Status {
<a href="#h2-0-3" id="h2-0-3" class="d">-    /// The server handling this status request.
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    ///
</a><a href="#h2-0-5" id="h2-0-5" class="d">-    /// TODO: this should be moved to the RPC server.
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    pub server: NodeID,
</a>     /// The current Raft leader, which generated this status.
     pub leader: NodeID,
     /// The current Raft term.
<b>diff --git a/<a id="h3" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::super::{Event, Log, Message, RequestID, Response, State};
</a><a href="#h3-0-1" id="h3-0-1" class="i">+use super::super::{Event, Log, Message, RequestID, State};
</a> use super::{rand_election_timeout, Candidate, Node, NodeID, RawNode, Role, Term, Ticks};
 use crate::error::{Error, Result};
 
<a href="#h3-1" id="h3-1" class="h">@@ -227,14 +227,9 @@ impl RawNode&lt;Follower&gt; {
</a>             }
 
             // Returns client responses for forwarded requests.
<a href="#h3-1-3" id="h3-1-3" class="d">-            Event::ClientResponse { id, mut response } =&gt; {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+            Event::ClientResponse { id, response } =&gt; {
</a>                 assert!(self.is_leader(msg.from), &quot;Client response from non-leader&quot;);
 
<a href="#h3-1-7" id="h3-1-7" class="d">-                // TODO: Get rid of this field, it should be returned at the RPC
</a><a href="#h3-1-8" id="h3-1-8" class="d">-                // server level instead.
</a><a href="#h3-1-9" id="h3-1-9" class="d">-                if let Ok(Response::Status(ref mut status)) = response {
</a><a href="#h3-1-10" id="h3-1-10" class="d">-                    status.server = self.id;
</a><a href="#h3-1-11" id="h3-1-11" class="d">-                }
</a>                 if self.role.forwarded.remove(&amp;id) {
                     self.send(self.id, Event::ClientResponse { id, response })?;
                 }
<a href="#h3-2" id="h3-2" class="h">@@ -277,7 +272,7 @@ impl RawNode&lt;Follower&gt; {
</a> #[cfg(test)]
 pub mod tests {
     use super::super::super::state::tests::TestState;
<a href="#h3-2-3" id="h3-2-3" class="d">-    use super::super::super::{Entry, Log, Request};
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    use super::super::super::{Entry, Log, Request, Response};
</a>     use super::super::tests::{assert_messages, assert_node};
     use super::*;
     use crate::error::Error;
<b>diff --git a/<a id="h4" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -232,7 +232,6 @@ impl RawNode&lt;Leader&gt; {
</a> 
             Event::ClientRequest { id, request: Request::Status } =&gt; {
                 let status = Status {
<a href="#h4-0-3" id="h4-0-3" class="d">-                    server: self.id,
</a>                     leader: self.id,
                     term: self.term,
                     last_index: self
<a href="#h4-1" id="h4-1" class="h">@@ -742,7 +741,6 @@ mod tests {
</a>                 event: Event::ClientResponse {
                     id: vec![1],
                     response: Ok(Response::Status(Status {
<a href="#h4-1-3" id="h4-1-3" class="d">-                        server: 1,
</a>                         leader: 1,
                         term: 3,
                         last_index: HashMap::from([(1, 5), (2, 0), (3, 0), (4, 0), (5, 0)]),
<b>diff --git a/<a id="h5" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -6,6 +6,7 @@ use crate::sql::engine::Engine as _;
</a> use crate::sql::execution::ResultSet;
 use crate::sql::schema::{Catalog as _, Table};
 use crate::sql::types::Row;
<a href="#h5-0-3" id="h5-0-3" class="i">+use crate::storage;
</a> 
 use crossbeam::channel::{Receiver, Sender};
 use log::{debug, error, info};
<a href="#h5-1" id="h5-1" class="h">@@ -73,6 +74,7 @@ impl Server {
</a>         );
 
         std::thread::scope(move |s| {
<a href="#h5-1-3" id="h5-1-3" class="i">+            let id = self.node.id();
</a>             let (raft_request_tx, raft_request_rx) = crossbeam::channel::unbounded();
             let (raft_step_tx, raft_step_rx) = crossbeam::channel::unbounded();
 
<a href="#h5-2" id="h5-2" class="h">@@ -101,7 +103,7 @@ impl Server {
</a>             });
 
             // Serve inbound SQL connections.
<a href="#h5-2-3" id="h5-2-3" class="d">-            s.spawn(move || Self::sql_accept(sql_listener, raft_request_tx));
</a><a href="#h5-2-4" id="h5-2-4" class="i">+            s.spawn(move || Self::sql_accept(id, sql_listener, raft_request_tx));
</a>         });
 
         Ok(())
<a href="#h5-3" id="h5-3" class="h">@@ -247,6 +249,7 @@ impl Server {
</a> 
     /// Accepts new SQL client connections and spawns session threads for them.
     fn sql_accept(
<a href="#h5-3-3" id="h5-3-3" class="i">+        id: raft::NodeID,
</a>         listener: TcpListener,
         raft_request_tx: Sender&lt;(raft::Request, Sender&lt;Result&lt;raft::Response&gt;&gt;)&gt;,
     ) {
<a href="#h5-4" id="h5-4" class="h">@@ -261,7 +264,7 @@ impl Server {
</a>             let raft_request_tx = raft_request_tx.clone();
             s.spawn(move || {
                 debug!(&quot;Client {peer} connected&quot;);
<a href="#h5-4-3" id="h5-4-3" class="d">-                match Self::sql_session(socket, raft_request_tx) {
</a><a href="#h5-4-4" id="h5-4-4" class="i">+                match Self::sql_session(id, socket, raft_request_tx) {
</a>                     Ok(()) =&gt; debug!(&quot;Client {peer} disconnected&quot;),
                     Err(err) =&gt; error!(&quot;Client {peer} error: {err}&quot;),
                 }
<a href="#h5-5" id="h5-5" class="h">@@ -272,6 +275,7 @@ impl Server {
</a>     /// Processes a client SQL session, by executing SQL statements against the
     /// Raft node.
     fn sql_session(
<a href="#h5-5-3" id="h5-5-3" class="i">+        id: raft::NodeID,
</a>         socket: TcpStream,
         raft_request_tx: Sender&lt;(raft::Request, Sender&lt;Result&lt;raft::Response&gt;&gt;)&gt;,
     ) -&gt; Result&lt;()&gt; {
<a href="#h5-6" id="h5-6" class="h">@@ -284,13 +288,16 @@ impl Server {
</a>             debug!(&quot;Received request {request:?}&quot;);
             let mut response = match request {
                 Request::Execute(query) =&gt; session.execute(&amp;query).map(Response::Execute),
<a href="#h5-6-3" id="h5-6-3" class="d">-                Request::Status =&gt; session.status().map(Response::Status),
</a>                 Request::GetTable(table) =&gt; session
                     .with_txn_read_only(|txn| txn.must_read_table(&amp;table))
                     .map(Response::GetTable),
                 Request::ListTables =&gt; session
                     .with_txn_read_only(|txn| Ok(txn.scan_tables()?.map(|t| t.name).collect()))
                     .map(Response::ListTables),
<a href="#h5-6-10" id="h5-6-10" class="i">+                Request::Status =&gt; session
</a><a href="#h5-6-11" id="h5-6-11" class="i">+                    .status()
</a><a href="#h5-6-12" id="h5-6-12" class="i">+                    .map(|s| Status { server: id, raft: s.raft, mvcc: s.mvcc })
</a><a href="#h5-6-13" id="h5-6-13" class="i">+                    .map(Response::Status),
</a>             };
 
             // Process response.
<a href="#h5-7" id="h5-7" class="h">@@ -347,5 +354,13 @@ pub enum Response {
</a>     Row(Option&lt;Row&gt;),
     GetTable(Table),
     ListTables(Vec&lt;String&gt;),
<a href="#h5-7-3" id="h5-7-3" class="d">-    Status(sql::engine::Status),
</a><a href="#h5-7-4" id="h5-7-4" class="i">+    Status(Status),
</a><a href="#h5-7-5" id="h5-7-5" class="i">+}
</a><a href="#h5-7-6" id="h5-7-6" class="i">+
</a><a href="#h5-7-7" id="h5-7-7" class="i">+/// SQL server status.
</a><a href="#h5-7-8" id="h5-7-8" class="i">+#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h5-7-9" id="h5-7-9" class="i">+pub struct Status {
</a><a href="#h5-7-10" id="h5-7-10" class="i">+    pub server: raft::NodeID,
</a><a href="#h5-7-11" id="h5-7-11" class="i">+    pub raft: raft::Status,
</a><a href="#h5-7-12" id="h5-7-12" class="i">+    pub mvcc: storage::mvcc::Status,
</a> }
<b>diff --git a/<a id="h6" href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a> b/<a href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,7 +2,7 @@ use super::{assert_row, assert_rows, dataset, TestCluster};
</a> 
 use toydb::error::{Error, Result};
 use toydb::raft;
<a href="#h6-0-3" id="h6-0-3" class="d">-use toydb::sql::engine::Status;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+use toydb::server::Status;
</a> use toydb::sql::execution::ResultSet;
 use toydb::sql::schema;
 use toydb::sql::types::{Column, DataType, Value};
<a href="#h6-1" id="h6-1" class="h">@@ -119,8 +119,8 @@ fn status() -&gt; Result&lt;()&gt; {
</a>     assert_eq!(
         c.status()?,
         Status {
<a href="#h6-1-3" id="h6-1-3" class="i">+            server: 1,
</a>             raft: raft::Status {
<a href="#h6-1-5" id="h6-1-5" class="d">-                server: 1,
</a>                 leader: 1,
                 term: 1,
                 last_index: [(1, 27)].into(),
</pre>
</div>
</body>
</html>
