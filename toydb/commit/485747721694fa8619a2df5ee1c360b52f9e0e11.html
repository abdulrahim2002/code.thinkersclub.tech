<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>encoding: add format module for raw key/value formatting - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/485747721694fa8619a2df5ee1c360b52f9e0e11.html">485747721694fa8619a2df5ee1c360b52f9e0e11</a>
<b>parent</b> <a href="../commit/7cd29db0fe753e4998a5f50ace8a58689cf039d4.html">7cd29db0fe753e4998a5f50ace8a58689cf039d4</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 29 Jun 2024 15:38:17 +0200

encoding: add format module for raw key/value formatting

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toydump.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++</span><span class="d">------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">src/encoding/format.rs</a></td><td> | </td><td class="num">151</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/encoding/mod.rs</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/log.rs</a></td><td> | </td><td class="num">58</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/testscripts/log/append</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/testscripts/log/commit</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/raft/testscripts/log/get</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/raft/testscripts/log/has</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/raft/testscripts/log/init</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">src/raft/testscripts/log/scan</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/raft/testscripts/log/scan_apply</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/raft/testscripts/log/splice</a></td><td> | </td><td class="num">94</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/raft/testscripts/log/status</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/raft/testscripts/log/term</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/storage/bitcask.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">src/storage/debug.rs</a></td><td> | </td><td class="num">91</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/storage/engine.rs</a></td><td> | </td><td class="num">23</td><td><span class="i">++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/storage/mod.rs</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">src/storage/mvcc.rs</a></td><td> | </td><td class="num">48</td><td><span class="i">++++++++++++++++++</span><span class="d">------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">src/storage/testscripts/bitcask/compact</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">src/storage/testscripts/bitcask/compact_open</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/storage/testscripts/bitcask/log</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/storage/testscripts/bitcask/status</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/storage/testscripts/engine/keys</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/storage/testscripts/engine/point</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/storage/testscripts/engine/scan</a></td><td> | </td><td class="num">50</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/storage/testscripts/engine/scan_prefix</a></td><td> | </td><td class="num">100</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">src/storage/testscripts/mvcc/anomaly_dirty_read</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">src/storage/testscripts/mvcc/anomaly_lost_update</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">src/storage/testscripts/mvcc/anomaly_phantom_read</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">src/storage/testscripts/mvcc/anomaly_read_skew</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">src/storage/testscripts/mvcc/anomaly_write_skew</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">src/storage/testscripts/mvcc/begin</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">src/storage/testscripts/mvcc/begin_as_of</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/storage/testscripts/mvcc/delete</a></td><td> | </td><td class="num">64</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">src/storage/testscripts/mvcc/delete_conflict</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">src/storage/testscripts/mvcc/get</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">src/storage/testscripts/mvcc/get_isolation</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">src/storage/testscripts/mvcc/resume</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">src/storage/testscripts/mvcc/rollback</a></td><td> | </td><td class="num">84</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">src/storage/testscripts/mvcc/scan</a></td><td> | </td><td class="num">66</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">src/storage/testscripts/mvcc/scan_isolation</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">src/storage/testscripts/mvcc/scan_key_version_encoding</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">src/storage/testscripts/mvcc/scan_prefix</a></td><td> | </td><td class="num">50</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">src/storage/testscripts/mvcc/set</a></td><td> | </td><td class="num">56</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">src/storage/testscripts/mvcc/set_conflict</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">src/storage/testscripts/mvcc/unversioned</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
</table></pre><pre>49 files changed, 746 insertions(+), 723 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toydump.rs.html">src/bin/toydump.rs</a> b/<a href="../file/src/bin/toydump.rs.html">src/bin/toydump.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -2,9 +2,8 @@
</a> //! human-readable form. It only prints live BitCask data, not garbage entries.
 #![warn(clippy::all)]
 
<a href="#h0-0-3" id="h0-0-3" class="d">-use toydb::errdata;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+use toydb::encoding::format::{self, Formatter as _};
</a> use toydb::error::Result;
<a href="#h0-0-6" id="h0-0-6" class="d">-use toydb::storage::debug;
</a> use toydb::storage::{BitCask, Engine};
 
 fn main() -&gt; Result&lt;()&gt; {
<a href="#h0-1" id="h0-1" class="h">@@ -17,10 +16,8 @@ fn main() -&gt; Result&lt;()&gt; {
</a>     let mut engine = BitCask::new(file.into())?;
     let mut scan = engine.scan(..);
     while let Some((key, value)) = scan.next().transpose()? {
<a href="#h0-1-3" id="h0-1-3" class="d">-        let (fkey, Some(fvalue)) = debug::format_key_value(&amp;key, &amp;Some(value)) else {
</a><a href="#h0-1-4" id="h0-1-4" class="d">-            return errdata!(&quot;unexpected missing value at key {:?}&quot;, key);
</a><a href="#h0-1-5" id="h0-1-5" class="d">-        };
</a><a href="#h0-1-6" id="h0-1-6" class="d">-        println!(&quot;{fkey} → {fvalue}&quot;);
</a><a href="#h0-1-7" id="h0-1-7" class="i">+        // TODO: handle SQL and Raft data too.
</a><a href="#h0-1-8" id="h0-1-8" class="i">+        println!(&quot;{}&quot;, format::MVCC::&lt;format::Raw&gt;::key_value(&amp;key, &amp;value));
</a>     }
     Ok(())
 }
<b>diff --git a/<a id="h1" href="../file/src/encoding/format.rs.html">src/encoding/format.rs</a> b/<a href="../file/src/encoding/format.rs.html">src/encoding/format.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,151 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+//! Decodes and formats raw keys and values, recursively as needed. Handles both
</a><a href="#h1-0-1" id="h1-0-1" class="i">+//! both Raft, MVCC, SQL, and raw binary data.
</a><a href="#h1-0-2" id="h1-0-2" class="i">+
</a><a href="#h1-0-3" id="h1-0-3" class="i">+use super::{bincode, Key as _};
</a><a href="#h1-0-4" id="h1-0-4" class="i">+use crate::raft;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+use crate::storage::mvcc;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+
</a><a href="#h1-0-7" id="h1-0-7" class="i">+use itertools::Itertools as _;
</a><a href="#h1-0-8" id="h1-0-8" class="i">+use std::collections::BTreeSet;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+
</a><a href="#h1-0-10" id="h1-0-10" class="i">+/// Formats raw key/value pairs.
</a><a href="#h1-0-11" id="h1-0-11" class="i">+pub trait Formatter {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    /// Formats a key.
</a><a href="#h1-0-13" id="h1-0-13" class="i">+    fn key(key: &amp;[u8]) -&gt; String;
</a><a href="#h1-0-14" id="h1-0-14" class="i">+
</a><a href="#h1-0-15" id="h1-0-15" class="i">+    /// Formats a value.
</a><a href="#h1-0-16" id="h1-0-16" class="i">+    fn value(key: &amp;[u8], value: &amp;[u8]) -&gt; String;
</a><a href="#h1-0-17" id="h1-0-17" class="i">+
</a><a href="#h1-0-18" id="h1-0-18" class="i">+    /// Formats a key/value pair.
</a><a href="#h1-0-19" id="h1-0-19" class="i">+    fn key_value(key: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-20" id="h1-0-20" class="i">+        let fkey = Self::key(key);
</a><a href="#h1-0-21" id="h1-0-21" class="i">+        let fvalue = Self::value(key, value);
</a><a href="#h1-0-22" id="h1-0-22" class="i">+        format!(&quot;{fkey} → {fvalue}&quot;)
</a><a href="#h1-0-23" id="h1-0-23" class="i">+    }
</a><a href="#h1-0-24" id="h1-0-24" class="i">+
</a><a href="#h1-0-25" id="h1-0-25" class="i">+    /// Formats a key/value pair, where the value may not exist.
</a><a href="#h1-0-26" id="h1-0-26" class="i">+    fn key_maybe_value(key: &amp;[u8], value: Option&lt;&amp;[u8]&gt;) -&gt; String {
</a><a href="#h1-0-27" id="h1-0-27" class="i">+        let fkey = Self::key(key);
</a><a href="#h1-0-28" id="h1-0-28" class="i">+        let fvalue = value.map(|v| Self::value(key, v)).unwrap_or(&quot;None&quot;.to_string());
</a><a href="#h1-0-29" id="h1-0-29" class="i">+        format!(&quot;{fkey} → {fvalue}&quot;)
</a><a href="#h1-0-30" id="h1-0-30" class="i">+    }
</a><a href="#h1-0-31" id="h1-0-31" class="i">+}
</a><a href="#h1-0-32" id="h1-0-32" class="i">+
</a><a href="#h1-0-33" id="h1-0-33" class="i">+/// Formats raw byte slices.
</a><a href="#h1-0-34" id="h1-0-34" class="i">+pub struct Raw;
</a><a href="#h1-0-35" id="h1-0-35" class="i">+
</a><a href="#h1-0-36" id="h1-0-36" class="i">+impl Raw {
</a><a href="#h1-0-37" id="h1-0-37" class="i">+    pub fn bytes(bytes: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-38" id="h1-0-38" class="i">+        let escaped = bytes.iter().copied().flat_map(std::ascii::escape_default).collect_vec();
</a><a href="#h1-0-39" id="h1-0-39" class="i">+        let string = String::from_utf8_lossy(&amp;escaped);
</a><a href="#h1-0-40" id="h1-0-40" class="i">+        format!(&quot;\&quot;{string}\&quot;&quot;)
</a><a href="#h1-0-41" id="h1-0-41" class="i">+    }
</a><a href="#h1-0-42" id="h1-0-42" class="i">+}
</a><a href="#h1-0-43" id="h1-0-43" class="i">+
</a><a href="#h1-0-44" id="h1-0-44" class="i">+impl Formatter for Raw {
</a><a href="#h1-0-45" id="h1-0-45" class="i">+    fn key(key: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-46" id="h1-0-46" class="i">+        Self::bytes(key)
</a><a href="#h1-0-47" id="h1-0-47" class="i">+    }
</a><a href="#h1-0-48" id="h1-0-48" class="i">+
</a><a href="#h1-0-49" id="h1-0-49" class="i">+    fn value(_: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-50" id="h1-0-50" class="i">+        Self::bytes(value)
</a><a href="#h1-0-51" id="h1-0-51" class="i">+    }
</a><a href="#h1-0-52" id="h1-0-52" class="i">+}
</a><a href="#h1-0-53" id="h1-0-53" class="i">+
</a><a href="#h1-0-54" id="h1-0-54" class="i">+/// Formats Raft log entries.
</a><a href="#h1-0-55" id="h1-0-55" class="i">+pub struct Raft;
</a><a href="#h1-0-56" id="h1-0-56" class="i">+
</a><a href="#h1-0-57" id="h1-0-57" class="i">+impl Raft {
</a><a href="#h1-0-58" id="h1-0-58" class="i">+    pub fn entry(entry: &amp;raft::Entry) -&gt; String {
</a><a href="#h1-0-59" id="h1-0-59" class="i">+        format!(
</a><a href="#h1-0-60" id="h1-0-60" class="i">+            &quot;{}@{} {}&quot;,
</a><a href="#h1-0-61" id="h1-0-61" class="i">+            entry.index,
</a><a href="#h1-0-62" id="h1-0-62" class="i">+            entry.term,
</a><a href="#h1-0-63" id="h1-0-63" class="i">+            entry.command.as_deref().map(Raw::bytes).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h1-0-64" id="h1-0-64" class="i">+        )
</a><a href="#h1-0-65" id="h1-0-65" class="i">+    }
</a><a href="#h1-0-66" id="h1-0-66" class="i">+}
</a><a href="#h1-0-67" id="h1-0-67" class="i">+
</a><a href="#h1-0-68" id="h1-0-68" class="i">+impl Formatter for Raft {
</a><a href="#h1-0-69" id="h1-0-69" class="i">+    fn key(key: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-70" id="h1-0-70" class="i">+        let Ok(key) = raft::Key::decode(key) else {
</a><a href="#h1-0-71" id="h1-0-71" class="i">+            return Raw::key(key);
</a><a href="#h1-0-72" id="h1-0-72" class="i">+        };
</a><a href="#h1-0-73" id="h1-0-73" class="i">+        format!(&quot;raft:{key:?}&quot;)
</a><a href="#h1-0-74" id="h1-0-74" class="i">+    }
</a><a href="#h1-0-75" id="h1-0-75" class="i">+
</a><a href="#h1-0-76" id="h1-0-76" class="i">+    fn value(key: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-77" id="h1-0-77" class="i">+        let Ok(key) = raft::Key::decode(key) else {
</a><a href="#h1-0-78" id="h1-0-78" class="i">+            return Raw::value(key, value);
</a><a href="#h1-0-79" id="h1-0-79" class="i">+        };
</a><a href="#h1-0-80" id="h1-0-80" class="i">+        match key {
</a><a href="#h1-0-81" id="h1-0-81" class="i">+            raft::Key::CommitIndex =&gt; {
</a><a href="#h1-0-82" id="h1-0-82" class="i">+                match bincode::deserialize::&lt;(raft::Index, raft::Term)&gt;(value) {
</a><a href="#h1-0-83" id="h1-0-83" class="i">+                    Ok((index, term)) =&gt; format!(&quot;{index}@{term}&quot;),
</a><a href="#h1-0-84" id="h1-0-84" class="i">+                    Err(_) =&gt; Raw::bytes(value),
</a><a href="#h1-0-85" id="h1-0-85" class="i">+                }
</a><a href="#h1-0-86" id="h1-0-86" class="i">+            }
</a><a href="#h1-0-87" id="h1-0-87" class="i">+            raft::Key::TermVote =&gt; {
</a><a href="#h1-0-88" id="h1-0-88" class="i">+                match bincode::deserialize::&lt;(raft::Term, Option&lt;raft::NodeID&gt;)&gt;(value) {
</a><a href="#h1-0-89" id="h1-0-89" class="i">+                    Ok((term, vote)) =&gt; format!(
</a><a href="#h1-0-90" id="h1-0-90" class="i">+                        &quot;term={term} vote={}&quot;,
</a><a href="#h1-0-91" id="h1-0-91" class="i">+                        vote.map(|v| v.to_string()).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h1-0-92" id="h1-0-92" class="i">+                    ),
</a><a href="#h1-0-93" id="h1-0-93" class="i">+                    Err(_) =&gt; Raw::bytes(value),
</a><a href="#h1-0-94" id="h1-0-94" class="i">+                }
</a><a href="#h1-0-95" id="h1-0-95" class="i">+            }
</a><a href="#h1-0-96" id="h1-0-96" class="i">+            raft::Key::Entry(_) =&gt; match bincode::deserialize::&lt;raft::Entry&gt;(value) {
</a><a href="#h1-0-97" id="h1-0-97" class="i">+                Ok(entry) =&gt; Self::entry(&amp;entry),
</a><a href="#h1-0-98" id="h1-0-98" class="i">+                Err(_) =&gt; Raw::bytes(value),
</a><a href="#h1-0-99" id="h1-0-99" class="i">+            },
</a><a href="#h1-0-100" id="h1-0-100" class="i">+        }
</a><a href="#h1-0-101" id="h1-0-101" class="i">+    }
</a><a href="#h1-0-102" id="h1-0-102" class="i">+}
</a><a href="#h1-0-103" id="h1-0-103" class="i">+
</a><a href="#h1-0-104" id="h1-0-104" class="i">+/// Formats MVCC keys/values. Dispatches to I for inner key/value formatting.
</a><a href="#h1-0-105" id="h1-0-105" class="i">+pub struct MVCC&lt;I: Formatter&gt;(std::marker::PhantomData&lt;I&gt;);
</a><a href="#h1-0-106" id="h1-0-106" class="i">+
</a><a href="#h1-0-107" id="h1-0-107" class="i">+impl&lt;I: Formatter&gt; Formatter for MVCC&lt;I&gt; {
</a><a href="#h1-0-108" id="h1-0-108" class="i">+    fn key(key: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-109" id="h1-0-109" class="i">+        let Ok(key) = mvcc::Key::decode(key) else { return Raw::key(key) };
</a><a href="#h1-0-110" id="h1-0-110" class="i">+        match key {
</a><a href="#h1-0-111" id="h1-0-111" class="i">+            mvcc::Key::TxnWrite(version, innerkey) =&gt; {
</a><a href="#h1-0-112" id="h1-0-112" class="i">+                format!(&quot;mvcc:TxnWrite({version}, {})&quot;, I::key(&amp;innerkey))
</a><a href="#h1-0-113" id="h1-0-113" class="i">+            }
</a><a href="#h1-0-114" id="h1-0-114" class="i">+            mvcc::Key::Version(innerkey, version) =&gt; {
</a><a href="#h1-0-115" id="h1-0-115" class="i">+                format!(&quot;mvcc:Version({}, {version})&quot;, I::key(&amp;innerkey))
</a><a href="#h1-0-116" id="h1-0-116" class="i">+            }
</a><a href="#h1-0-117" id="h1-0-117" class="i">+            mvcc::Key::Unversioned(innerkey) =&gt; {
</a><a href="#h1-0-118" id="h1-0-118" class="i">+                format!(&quot;mvcc:Unversioned({})&quot;, I::key(&amp;innerkey))
</a><a href="#h1-0-119" id="h1-0-119" class="i">+            }
</a><a href="#h1-0-120" id="h1-0-120" class="i">+            mvcc::Key::NextVersion | mvcc::Key::TxnActive(_) | mvcc::Key::TxnActiveSnapshot(_) =&gt; {
</a><a href="#h1-0-121" id="h1-0-121" class="i">+                format!(&quot;mvcc:{key:?}&quot;)
</a><a href="#h1-0-122" id="h1-0-122" class="i">+            }
</a><a href="#h1-0-123" id="h1-0-123" class="i">+        }
</a><a href="#h1-0-124" id="h1-0-124" class="i">+    }
</a><a href="#h1-0-125" id="h1-0-125" class="i">+
</a><a href="#h1-0-126" id="h1-0-126" class="i">+    fn value(key: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h1-0-127" id="h1-0-127" class="i">+        let Ok(key) = mvcc::Key::decode(key) else { return Raw::bytes(value) };
</a><a href="#h1-0-128" id="h1-0-128" class="i">+        match key {
</a><a href="#h1-0-129" id="h1-0-129" class="i">+            mvcc::Key::NextVersion =&gt; {
</a><a href="#h1-0-130" id="h1-0-130" class="i">+                let Ok(version) = bincode::deserialize::&lt;mvcc::Version&gt;(value) else {
</a><a href="#h1-0-131" id="h1-0-131" class="i">+                    return Raw::bytes(value);
</a><a href="#h1-0-132" id="h1-0-132" class="i">+                };
</a><a href="#h1-0-133" id="h1-0-133" class="i">+                version.to_string()
</a><a href="#h1-0-134" id="h1-0-134" class="i">+            }
</a><a href="#h1-0-135" id="h1-0-135" class="i">+            mvcc::Key::TxnActiveSnapshot(_) =&gt; {
</a><a href="#h1-0-136" id="h1-0-136" class="i">+                let Ok(active) = bincode::deserialize::&lt;BTreeSet&lt;u64&gt;&gt;(value) else {
</a><a href="#h1-0-137" id="h1-0-137" class="i">+                    return Raw::bytes(value);
</a><a href="#h1-0-138" id="h1-0-138" class="i">+                };
</a><a href="#h1-0-139" id="h1-0-139" class="i">+                format!(&quot;{{{}}}&quot;, active.iter().map(|v| v.to_string()).join(&quot;,&quot;))
</a><a href="#h1-0-140" id="h1-0-140" class="i">+            }
</a><a href="#h1-0-141" id="h1-0-141" class="i">+            mvcc::Key::TxnActive(_) | mvcc::Key::TxnWrite(_, _) =&gt; Raw::bytes(value),
</a><a href="#h1-0-142" id="h1-0-142" class="i">+            mvcc::Key::Version(userkey, _) =&gt; match bincode::deserialize(value) {
</a><a href="#h1-0-143" id="h1-0-143" class="i">+                Ok(Some(value)) =&gt; I::value(&amp;userkey, value),
</a><a href="#h1-0-144" id="h1-0-144" class="i">+                Ok(None) =&gt; &quot;None&quot;.to_string(),
</a><a href="#h1-0-145" id="h1-0-145" class="i">+                Err(_) =&gt; Raw::bytes(value),
</a><a href="#h1-0-146" id="h1-0-146" class="i">+            },
</a><a href="#h1-0-147" id="h1-0-147" class="i">+            mvcc::Key::Unversioned(userkey) =&gt; I::value(&amp;userkey, value),
</a><a href="#h1-0-148" id="h1-0-148" class="i">+        }
</a><a href="#h1-0-149" id="h1-0-149" class="i">+    }
</a><a href="#h1-0-150" id="h1-0-150" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/src/encoding/mod.rs.html">src/encoding/mod.rs</a> b/<a href="../file/src/encoding/mod.rs.html">src/encoding/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,6 +4,7 @@
</a> //! * bincode: used for values in the key/value store and network protocols.
 
 pub mod bincode;
<a href="#h2-0-3" id="h2-0-3" class="i">+pub mod format;
</a> pub mod keycode;
 
 use crate::error::Result;
<b>diff --git a/<a id="h3" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -341,6 +341,7 @@ impl&lt;&#39;a&gt; std::iter::Iterator for Iterator&lt;&#39;a&gt; {
</a> #[cfg(test)]
 mod tests {
     use super::*;
<a href="#h3-0-3" id="h3-0-3" class="i">+    use crate::encoding::format::{self, Formatter as _};
</a>     use crossbeam::channel::Receiver;
     use regex::Regex;
     use std::fmt::Write as _;
<a href="#h3-1" id="h3-1" class="h">@@ -374,7 +375,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let index = self.log.append(command)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h3-1-3" id="h3-1-3" class="d">-                    output.push_str(&amp;format!(&quot;append → {}\n&quot;, Self::format_entry(&amp;entry)));
</a><a href="#h3-1-4" id="h3-1-4" class="i">+                    output.push_str(&amp;format!(&quot;append → {}\n&quot;, format::Raft::entry(&amp;entry)));
</a>                 }
 
                 // commit INDEX
<a href="#h3-2" id="h3-2" class="h">@@ -384,7 +385,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let index = self.log.commit(index)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h3-2-3" id="h3-2-3" class="d">-                    output.push_str(&amp;format!(&quot;commit → {}\n&quot;, Self::format_entry(&amp;entry)));
</a><a href="#h3-2-4" id="h3-2-4" class="i">+                    output.push_str(&amp;format!(&quot;commit → {}\n&quot;, format::Raft::entry(&amp;entry)));
</a>                 }
 
                 // dump
<a href="#h3-3" id="h3-3" class="h">@@ -393,8 +394,12 @@ mod tests {
</a>                     let range = (std::ops::Bound::Unbounded, std::ops::Bound::Unbounded);
                     let mut scan = self.log.engine.scan_dyn(range);
                     while let Some((key, value)) = scan.next().transpose()? {
<a href="#h3-3-3" id="h3-3-3" class="d">-                        output.push_str(&amp;Self::format_key_value(&amp;key, &amp;value));
</a><a href="#h3-3-4" id="h3-3-4" class="d">-                        output.push(&#39;\n&#39;);
</a><a href="#h3-3-5" id="h3-3-5" class="i">+                        writeln!(
</a><a href="#h3-3-6" id="h3-3-6" class="i">+                            output,
</a><a href="#h3-3-7" id="h3-3-7" class="i">+                            &quot;{} [{}]&quot;,
</a><a href="#h3-3-8" id="h3-3-8" class="i">+                            format::Raft::key_value(&amp;key, &amp;value),
</a><a href="#h3-3-9" id="h3-3-9" class="i">+                            format::Raw::key_value(&amp;key, &amp;value)
</a><a href="#h3-3-10" id="h3-3-10" class="i">+                        )?;
</a>                     }
                 }
 
<a href="#h3-4" id="h3-4" class="h">@@ -409,7 +414,7 @@ mod tests {
</a>                             .log
                             .get(index)?
                             .as_ref()
<a href="#h3-4-3" id="h3-4-3" class="d">-                            .map(Self::format_entry)
</a><a href="#h3-4-4" id="h3-4-4" class="i">+                            .map(format::Raft::entry)
</a>                             .unwrap_or(&quot;None&quot;.to_string());
                         output.push_str(&amp;format!(&quot;{entry}\n&quot;));
                     }
<a href="#h3-5" id="h3-5" class="h">@@ -459,7 +464,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let mut scan = self.log.scan(range);
                     while let Some(entry) = scan.next().transpose()? {
<a href="#h3-5-3" id="h3-5-3" class="d">-                        output.push_str(&amp;format!(&quot;{}\n&quot;, Self::format_entry(&amp;entry)));
</a><a href="#h3-5-4" id="h3-5-4" class="i">+                        output.push_str(&amp;format!(&quot;{}\n&quot;, format::Raft::entry(&amp;entry)));
</a>                     }
                 }
 
<a href="#h3-6" id="h3-6" class="h">@@ -471,7 +476,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let mut scan = self.log.scan_apply(applied_index);
                     while let Some(entry) = scan.next().transpose()? {
<a href="#h3-6-3" id="h3-6-3" class="d">-                        output.push_str(&amp;format!(&quot;{}\n&quot;, Self::format_entry(&amp;entry)));
</a><a href="#h3-6-4" id="h3-6-4" class="i">+                        output.push_str(&amp;format!(&quot;{}\n&quot;, format::Raft::entry(&amp;entry)));
</a>                     }
                 }
 
<a href="#h3-7" id="h3-7" class="h">@@ -499,7 +504,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let index = self.log.splice(entries)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h3-7-3" id="h3-7-3" class="d">-                    output.push_str(&amp;format!(&quot;splice → {}\n&quot;, Self::format_entry(&amp;entry)));
</a><a href="#h3-7-4" id="h3-7-4" class="i">+                    output.push_str(&amp;format!(&quot;splice → {}\n&quot;, format::Raft::entry(&amp;entry)));
</a>                 }
 
                 // status [engine=BOOL]
<a href="#h3-8" id="h3-8" class="h">@@ -544,13 +549,19 @@ mod tests {
</a>             while let Ok(op) = self.op_rx.try_recv() {
                 match op {
                     _ if !show_ops =&gt; {}
<a href="#h3-8-3" id="h3-8-3" class="d">-                    Operation::Delete { key } =&gt; {
</a><a href="#h3-8-4" id="h3-8-4" class="d">-                        writeln!(output, &quot;engine delete {}&quot;, Self::format_key(&amp;key))?
</a><a href="#h3-8-5" id="h3-8-5" class="d">-                    }
</a><a href="#h3-8-6" id="h3-8-6" class="i">+                    Operation::Delete { key } =&gt; writeln!(
</a><a href="#h3-8-7" id="h3-8-7" class="i">+                        output,
</a><a href="#h3-8-8" id="h3-8-8" class="i">+                        &quot;engine delete {} [{}]&quot;,
</a><a href="#h3-8-9" id="h3-8-9" class="i">+                        format::Raft::key(&amp;key),
</a><a href="#h3-8-10" id="h3-8-10" class="i">+                        format::Raw::key(&amp;key)
</a><a href="#h3-8-11" id="h3-8-11" class="i">+                    )?,
</a>                     Operation::Flush =&gt; writeln!(output, &quot;engine flush&quot;)?,
<a href="#h3-8-13" id="h3-8-13" class="d">-                    Operation::Set { key, value } =&gt; {
</a><a href="#h3-8-14" id="h3-8-14" class="d">-                        writeln!(output, &quot;engine set {}&quot;, Self::format_key_value(&amp;key, &amp;value))?
</a><a href="#h3-8-15" id="h3-8-15" class="d">-                    }
</a><a href="#h3-8-16" id="h3-8-16" class="i">+                    Operation::Set { key, value } =&gt; writeln!(
</a><a href="#h3-8-17" id="h3-8-17" class="i">+                        output,
</a><a href="#h3-8-18" id="h3-8-18" class="i">+                        &quot;engine set {} [{}]&quot;,
</a><a href="#h3-8-19" id="h3-8-19" class="i">+                        format::Raft::key_value(&amp;key, &amp;value),
</a><a href="#h3-8-20" id="h3-8-20" class="i">+                        format::Raw::key_value(&amp;key, &amp;value)
</a><a href="#h3-8-21" id="h3-8-21" class="i">+                    )?,
</a>                 }
             }
             Ok(output)
<a href="#h3-9" id="h3-9" class="h">@@ -571,25 +582,6 @@ mod tests {
</a>             Self { log, op_rx, tempdir }
         }
 
<a href="#h3-9-3" id="h3-9-3" class="d">-        /// Formats a log entry.
</a><a href="#h3-9-4" id="h3-9-4" class="d">-        fn format_entry(entry: &amp;Entry) -&gt; String {
</a><a href="#h3-9-5" id="h3-9-5" class="d">-            let command = match entry.command.as_ref() {
</a><a href="#h3-9-6" id="h3-9-6" class="d">-                Some(raw) =&gt; std::str::from_utf8(raw).expect(&quot;invalid command&quot;),
</a><a href="#h3-9-7" id="h3-9-7" class="d">-                None =&gt; &quot;None&quot;,
</a><a href="#h3-9-8" id="h3-9-8" class="d">-            };
</a><a href="#h3-9-9" id="h3-9-9" class="d">-            format!(&quot;{}@{} {command}&quot;, entry.index, entry.term)
</a><a href="#h3-9-10" id="h3-9-10" class="d">-        }
</a><a href="#h3-9-11" id="h3-9-11" class="d">-
</a><a href="#h3-9-12" id="h3-9-12" class="d">-        /// Formats a raw key.
</a><a href="#h3-9-13" id="h3-9-13" class="d">-        fn format_key(key: &amp;[u8]) -&gt; String {
</a><a href="#h3-9-14" id="h3-9-14" class="d">-            format!(&quot;{:?} 0x{}&quot;, Key::decode(key).expect(&quot;invalid key&quot;), hex::encode(key))
</a><a href="#h3-9-15" id="h3-9-15" class="d">-        }
</a><a href="#h3-9-16" id="h3-9-16" class="d">-
</a><a href="#h3-9-17" id="h3-9-17" class="d">-        /// Formats a raw key/value pair.
</a><a href="#h3-9-18" id="h3-9-18" class="d">-        fn format_key_value(key: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h3-9-19" id="h3-9-19" class="d">-            format!(&quot;{} = 0x{}&quot;, Self::format_key(key), hex::encode(value))
</a><a href="#h3-9-20" id="h3-9-20" class="d">-        }
</a><a href="#h3-9-21" id="h3-9-21" class="d">-
</a>         /// Parses an index@term pair.
         fn parse_index_term(s: &amp;str) -&gt; Result&lt;(Index, Term), Box&lt;dyn Error&gt;&gt; {
             let re = Regex::new(r&quot;^(\d+)@(\d+)$&quot;).expect(&quot;invalid regex&quot;);
<b>diff --git a/<a id="h4" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -244,7 +244,7 @@ mod message;
</a> mod node;
 mod state;
 
<a href="#h4-0-3" id="h4-0-3" class="d">-pub use log::{Entry, Index, Log};
</a><a href="#h4-0-4" id="h4-0-4" class="i">+pub use log::{Entry, Index, Key, Log};
</a> pub use message::{Envelope, Message, ReadSequence, Request, RequestID, Response, Status};
 pub use node::{Node, NodeID, Options, Term, Ticks};
 pub use state::State;
<b>diff --git a/<a id="h5" href="../file/src/raft/testscripts/log/append.html">src/raft/testscripts/log/append</a> b/<a href="../file/src/raft/testscripts/log/append.html">src/raft/testscripts/log/append</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -8,15 +8,15 @@ Panic: can&#39;t append entry in term 0
</a> set_term 2
 append foo [ops]
 ---
<a href="#h5-0-3" id="h5-0-3" class="d">-append → 1@2 foo
</a><a href="#h5-0-4" id="h5-0-4" class="d">-engine set Entry(1) 0x000000000000000001 = 0x01020103666f6f
</a><a href="#h5-0-5" id="h5-0-5" class="i">+append → 1@2 &quot;foo&quot;
</a><a href="#h5-0-6" id="h5-0-6" class="i">+engine set raft:Entry(1) → 1@2 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x02\x01\x03foo&quot;]
</a> engine flush
 
 # Appending a noop entry (no command) also works.
 append [ops]
 ---
 append → 2@2 None
<a href="#h5-0-13" id="h5-0-13" class="d">-engine set Entry(2) 0x000000000000000002 = 0x020200
</a><a href="#h5-0-14" id="h5-0-14" class="i">+engine set raft:Entry(2) → 2@2 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x02\x00&quot;]
</a> engine flush
 
 # Check that the last index/term is updated (commit index isn&#39;t), and that
<a href="#h5-1" id="h5-1" class="h">@@ -26,11 +26,11 @@ scan
</a> dump
 ---
 term=2 last=2@2 commit=0@0 vote=None
<a href="#h5-1-3" id="h5-1-3" class="d">-1@2 foo
</a><a href="#h5-1-4" id="h5-1-4" class="i">+1@2 &quot;foo&quot;
</a> 2@2 None
<a href="#h5-1-6" id="h5-1-6" class="d">-Entry(1) 0x000000000000000001 = 0x01020103666f6f
</a><a href="#h5-1-7" id="h5-1-7" class="d">-Entry(2) 0x000000000000000002 = 0x020200
</a><a href="#h5-1-8" id="h5-1-8" class="d">-TermVote 0x01 = 0x0200
</a><a href="#h5-1-9" id="h5-1-9" class="i">+raft:Entry(1) → 1@2 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x02\x01\x03foo&quot;]
</a><a href="#h5-1-10" id="h5-1-10" class="i">+raft:Entry(2) → 2@2 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x02\x00&quot;]
</a><a href="#h5-1-11" id="h5-1-11" class="i">+raft:TermVote → term=2 vote=None [&quot;\x01&quot; → &quot;\x02\x00&quot;]
</a> 
 # Skipping a term then appending is allowed.
 set_term 3
<a href="#h5-2" id="h5-2" class="h">@@ -38,7 +38,7 @@ append command
</a> set_term 5
 append
 ---
<a href="#h5-2-3" id="h5-2-3" class="d">-append → 3@3 command
</a><a href="#h5-2-4" id="h5-2-4" class="i">+append → 3@3 &quot;command&quot;
</a> append → 4@5 None
 
 # Dump the final status and data.
<a href="#h5-3" id="h5-3" class="h">@@ -47,12 +47,12 @@ scan
</a> dump
 ---
 term=5 last=4@5 commit=0@0 vote=None
<a href="#h5-3-3" id="h5-3-3" class="d">-1@2 foo
</a><a href="#h5-3-4" id="h5-3-4" class="i">+1@2 &quot;foo&quot;
</a> 2@2 None
<a href="#h5-3-6" id="h5-3-6" class="d">-3@3 command
</a><a href="#h5-3-7" id="h5-3-7" class="i">+3@3 &quot;command&quot;
</a> 4@5 None
<a href="#h5-3-9" id="h5-3-9" class="d">-Entry(1) 0x000000000000000001 = 0x01020103666f6f
</a><a href="#h5-3-10" id="h5-3-10" class="d">-Entry(2) 0x000000000000000002 = 0x020200
</a><a href="#h5-3-11" id="h5-3-11" class="d">-Entry(3) 0x000000000000000003 = 0x03030107636f6d6d616e64
</a><a href="#h5-3-12" id="h5-3-12" class="d">-Entry(4) 0x000000000000000004 = 0x040500
</a><a href="#h5-3-13" id="h5-3-13" class="d">-TermVote 0x01 = 0x0500
</a><a href="#h5-3-14" id="h5-3-14" class="i">+raft:Entry(1) → 1@2 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x02\x01\x03foo&quot;]
</a><a href="#h5-3-15" id="h5-3-15" class="i">+raft:Entry(2) → 2@2 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x02\x00&quot;]
</a><a href="#h5-3-16" id="h5-3-16" class="i">+raft:Entry(3) → 3@3 &quot;command&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x03\x03\x01\x07command&quot;]
</a><a href="#h5-3-17" id="h5-3-17" class="i">+raft:Entry(4) → 4@5 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x04\x05\x00&quot;]
</a><a href="#h5-3-18" id="h5-3-18" class="i">+raft:TermVote → term=5 vote=None [&quot;\x01&quot; → &quot;\x05\x00&quot;]
</a><b>diff --git a/<a id="h6" href="../file/src/raft/testscripts/log/commit.html">src/raft/testscripts/log/commit</a> b/<a href="../file/src/raft/testscripts/log/commit.html">src/raft/testscripts/log/commit</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -7,7 +7,7 @@ Panic: commit index 1 does not exist
</a> set_term 2
 splice 1@1= 2@1=foo 3@2=bar
 ---
<a href="#h6-0-3" id="h6-0-3" class="d">-splice → 3@2 bar
</a><a href="#h6-0-4" id="h6-0-4" class="i">+splice → 3@2 &quot;bar&quot;
</a> 
 # Committing entry 0 fails.
 !commit 0
<a href="#h6-1" id="h6-1" class="h">@@ -22,17 +22,17 @@ commit 1 [ops]
</a> status
 ---
 commit → 1@1 None
<a href="#h6-1-3" id="h6-1-3" class="d">-engine set CommitIndex 0x02 = 0x0101
</a><a href="#h6-1-4" id="h6-1-4" class="i">+engine set raft:CommitIndex → 1@1 [&quot;\x02&quot; → &quot;\x01\x01&quot;]
</a> term=2 last=3@2 commit=1@1 vote=None
 
<a href="#h6-1-7" id="h6-1-7" class="d">-# Dump the raw engine contents tdump
</a><a href="#h6-1-8" id="h6-1-8" class="i">+# Dump the raw engine contents.
</a> dump
 ---
<a href="#h6-1-11" id="h6-1-11" class="d">-Entry(1) 0x000000000000000001 = 0x010100
</a><a href="#h6-1-12" id="h6-1-12" class="d">-Entry(2) 0x000000000000000002 = 0x02010103666f6f
</a><a href="#h6-1-13" id="h6-1-13" class="d">-Entry(3) 0x000000000000000003 = 0x03020103626172
</a><a href="#h6-1-14" id="h6-1-14" class="d">-TermVote 0x01 = 0x0200
</a><a href="#h6-1-15" id="h6-1-15" class="d">-CommitIndex 0x02 = 0x0101
</a><a href="#h6-1-16" id="h6-1-16" class="i">+raft:Entry(1) → 1@1 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x01\x00&quot;]
</a><a href="#h6-1-17" id="h6-1-17" class="i">+raft:Entry(2) → 2@1 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x01\x01\x03foo&quot;]
</a><a href="#h6-1-18" id="h6-1-18" class="i">+raft:Entry(3) → 3@2 &quot;bar&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x03\x02\x01\x03bar&quot;]
</a><a href="#h6-1-19" id="h6-1-19" class="i">+raft:TermVote → term=2 vote=None [&quot;\x01&quot; → &quot;\x02\x00&quot;]
</a><a href="#h6-1-20" id="h6-1-20" class="i">+raft:CommitIndex → 1@1 [&quot;\x02&quot; → &quot;\x01\x01&quot;]
</a> 
 # Commits are idempotent, which doesn&#39;t incur an engine set.
 commit 1 [ops]
<a href="#h6-2" id="h6-2" class="h">@@ -45,7 +45,7 @@ term=2 last=3@2 commit=1@1 vote=None
</a> commit 3
 status
 ---
<a href="#h6-2-3" id="h6-2-3" class="d">-commit → 3@2 bar
</a><a href="#h6-2-4" id="h6-2-4" class="i">+commit → 3@2 &quot;bar&quot;
</a> term=2 last=3@2 commit=3@2 vote=None
 
 # Commit regressions error.
<a href="#h6-3" id="h6-3" class="h">@@ -65,8 +65,8 @@ term=2 last=3@2 commit=3@2 vote=None
</a> # Dump the raw values.
 dump
 ---
<a href="#h6-3-3" id="h6-3-3" class="d">-Entry(1) 0x000000000000000001 = 0x010100
</a><a href="#h6-3-4" id="h6-3-4" class="d">-Entry(2) 0x000000000000000002 = 0x02010103666f6f
</a><a href="#h6-3-5" id="h6-3-5" class="d">-Entry(3) 0x000000000000000003 = 0x03020103626172
</a><a href="#h6-3-6" id="h6-3-6" class="d">-TermVote 0x01 = 0x0200
</a><a href="#h6-3-7" id="h6-3-7" class="d">-CommitIndex 0x02 = 0x0302
</a><a href="#h6-3-8" id="h6-3-8" class="i">+raft:Entry(1) → 1@1 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x01\x00&quot;]
</a><a href="#h6-3-9" id="h6-3-9" class="i">+raft:Entry(2) → 2@1 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x01\x01\x03foo&quot;]
</a><a href="#h6-3-10" id="h6-3-10" class="i">+raft:Entry(3) → 3@2 &quot;bar&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x03\x02\x01\x03bar&quot;]
</a><a href="#h6-3-11" id="h6-3-11" class="i">+raft:TermVote → term=2 vote=None [&quot;\x01&quot; → &quot;\x02\x00&quot;]
</a><a href="#h6-3-12" id="h6-3-12" class="i">+raft:CommitIndex → 3@2 [&quot;\x02&quot; → &quot;\x03\x02&quot;]
</a><b>diff --git a/<a id="h7" href="../file/src/raft/testscripts/log/get.html">src/raft/testscripts/log/get</a> b/<a href="../file/src/raft/testscripts/log/get.html">src/raft/testscripts/log/get</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -11,14 +11,14 @@ set_term 2
</a> append bar
 ---
 append → 1@1 None
<a href="#h7-0-3" id="h7-0-3" class="d">-append → 2@1 foo
</a><a href="#h7-0-4" id="h7-0-4" class="d">-append → 3@2 bar
</a><a href="#h7-0-5" id="h7-0-5" class="i">+append → 2@1 &quot;foo&quot;
</a><a href="#h7-0-6" id="h7-0-6" class="i">+append → 3@2 &quot;bar&quot;
</a> 
 # get returns noop entries and regular entries.
 get 1 2
 ---
 1@1 None
<a href="#h7-0-12" id="h7-0-12" class="d">-2@1 foo
</a><a href="#h7-0-13" id="h7-0-13" class="i">+2@1 &quot;foo&quot;
</a> 
 # get returns None for missing entries, and for index 0.
 get 4 0
<b>diff --git a/<a id="h8" href="../file/src/raft/testscripts/log/has.html">src/raft/testscripts/log/has</a> b/<a href="../file/src/raft/testscripts/log/has.html">src/raft/testscripts/log/has</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -11,8 +11,8 @@ set_term 2
</a> append bar
 ---
 append → 1@1 None
<a href="#h8-0-3" id="h8-0-3" class="d">-append → 2@1 foo
</a><a href="#h8-0-4" id="h8-0-4" class="d">-append → 3@2 bar
</a><a href="#h8-0-5" id="h8-0-5" class="i">+append → 2@1 &quot;foo&quot;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+append → 3@2 &quot;bar&quot;
</a> 
 # has returns true both for noop entries and regular entries.
 has 1@1 2@1
<b>diff --git a/<a id="h9" href="../file/src/raft/testscripts/log/init.html">src/raft/testscripts/log/init</a> b/<a href="../file/src/raft/testscripts/log/init.html">src/raft/testscripts/log/init</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -9,9 +9,9 @@ set_term 2 7
</a> append bar
 commit 1
 ---
<a href="#h9-0-3" id="h9-0-3" class="d">-append → 1@1 foo
</a><a href="#h9-0-4" id="h9-0-4" class="d">-append → 2@2 bar
</a><a href="#h9-0-5" id="h9-0-5" class="d">-commit → 1@1 foo
</a><a href="#h9-0-6" id="h9-0-6" class="i">+append → 1@1 &quot;foo&quot;
</a><a href="#h9-0-7" id="h9-0-7" class="i">+append → 2@2 &quot;bar&quot;
</a><a href="#h9-0-8" id="h9-0-8" class="i">+commit → 1@1 &quot;foo&quot;
</a> 
 status
 ---
<a href="#h9-1" id="h9-1" class="h">@@ -27,5 +27,5 @@ term=2 last=2@2 commit=1@1 vote=7
</a> 
 scan
 ---
<a href="#h9-1-3" id="h9-1-3" class="d">-1@1 foo
</a><a href="#h9-1-4" id="h9-1-4" class="d">-2@2 bar
</a><a href="#h9-1-5" id="h9-1-5" class="i">+1@1 &quot;foo&quot;
</a><a href="#h9-1-6" id="h9-1-6" class="i">+2@2 &quot;bar&quot;
</a><b>diff --git a/<a id="h10" href="../file/src/raft/testscripts/log/scan.html">src/raft/testscripts/log/scan</a> b/<a href="../file/src/raft/testscripts/log/scan.html">src/raft/testscripts/log/scan</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -12,21 +12,21 @@ set_term 2
</a> append bar
 ---
 append → 1@1 None
<a href="#h10-0-3" id="h10-0-3" class="d">-append → 2@1 foo
</a><a href="#h10-0-4" id="h10-0-4" class="d">-append → 3@2 bar
</a><a href="#h10-0-5" id="h10-0-5" class="i">+append → 2@1 &quot;foo&quot;
</a><a href="#h10-0-6" id="h10-0-6" class="i">+append → 3@2 &quot;bar&quot;
</a> 
 # Full scan.
 scan
 ---
 1@1 None
<a href="#h10-0-12" id="h10-0-12" class="d">-2@1 foo
</a><a href="#h10-0-13" id="h10-0-13" class="d">-3@2 bar
</a><a href="#h10-0-14" id="h10-0-14" class="i">+2@1 &quot;foo&quot;
</a><a href="#h10-0-15" id="h10-0-15" class="i">+3@2 &quot;bar&quot;
</a> 
 # Start bound.
 scan 2..
 ---
<a href="#h10-0-20" id="h10-0-20" class="d">-2@1 foo
</a><a href="#h10-0-21" id="h10-0-21" class="d">-3@2 bar
</a><a href="#h10-0-22" id="h10-0-22" class="i">+2@1 &quot;foo&quot;
</a><a href="#h10-0-23" id="h10-0-23" class="i">+3@2 &quot;bar&quot;
</a> 
 scan 4..
 ---
<a href="#h10-1" id="h10-1" class="h">@@ -35,8 +35,8 @@ ok
</a> scan 0..
 ---
 1@1 None
<a href="#h10-1-3" id="h10-1-3" class="d">-2@1 foo
</a><a href="#h10-1-4" id="h10-1-4" class="d">-3@2 bar
</a><a href="#h10-1-5" id="h10-1-5" class="i">+2@1 &quot;foo&quot;
</a><a href="#h10-1-6" id="h10-1-6" class="i">+3@2 &quot;bar&quot;
</a> 
 # End bound.
 scan &quot;..2&quot;
<a href="#h10-2" id="h10-2" class="h">@@ -46,13 +46,13 @@ scan &quot;..2&quot;
</a> scan &quot;..=2&quot;
 ---
 1@1 None
<a href="#h10-2-3" id="h10-2-3" class="d">-2@1 foo
</a><a href="#h10-2-4" id="h10-2-4" class="i">+2@1 &quot;foo&quot;
</a> 
 scan &quot;..7&quot;
 ---
 1@1 None
<a href="#h10-2-9" id="h10-2-9" class="d">-2@1 foo
</a><a href="#h10-2-10" id="h10-2-10" class="d">-3@2 bar
</a><a href="#h10-2-11" id="h10-2-11" class="i">+2@1 &quot;foo&quot;
</a><a href="#h10-2-12" id="h10-2-12" class="i">+3@2 &quot;bar&quot;
</a> 
 scan &quot;..1&quot;
 ---
<a href="#h10-3" id="h10-3" class="h">@@ -70,13 +70,13 @@ scan 1..2
</a> scan &quot;1..=2&quot;
 ---
 1@1 None
<a href="#h10-3-3" id="h10-3-3" class="d">-2@1 foo
</a><a href="#h10-3-4" id="h10-3-4" class="i">+2@1 &quot;foo&quot;
</a> 
 scan 0..7
 ---
 1@1 None
<a href="#h10-3-9" id="h10-3-9" class="d">-2@1 foo
</a><a href="#h10-3-10" id="h10-3-10" class="d">-3@2 bar
</a><a href="#h10-3-11" id="h10-3-11" class="i">+2@1 &quot;foo&quot;
</a><a href="#h10-3-12" id="h10-3-12" class="i">+3@2 &quot;bar&quot;
</a> 
 scan 1..1
 ---
<b>diff --git a/<a id="h11" href="../file/src/raft/testscripts/log/scan_apply.html">src/raft/testscripts/log/scan_apply</a> b/<a href="../file/src/raft/testscripts/log/scan_apply.html">src/raft/testscripts/log/scan_apply</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -12,8 +12,8 @@ set_term 2
</a> append bar
 ---
 append → 1@1 None
<a href="#h11-0-3" id="h11-0-3" class="d">-append → 2@1 foo
</a><a href="#h11-0-4" id="h11-0-4" class="d">-append → 3@2 bar
</a><a href="#h11-0-5" id="h11-0-5" class="i">+append → 2@1 &quot;foo&quot;
</a><a href="#h11-0-6" id="h11-0-6" class="i">+append → 3@2 &quot;bar&quot;
</a> 
 # Nothing is committed, so scan_applied yields nothing.
 scan_apply 0
<a href="#h11-1" id="h11-1" class="h">@@ -24,9 +24,9 @@ ok
</a> commit 2
 scan_apply 0
 ---
<a href="#h11-1-3" id="h11-1-3" class="d">-commit → 2@1 foo
</a><a href="#h11-1-4" id="h11-1-4" class="i">+commit → 2@1 &quot;foo&quot;
</a> 1@1 None
<a href="#h11-1-6" id="h11-1-6" class="d">-2@1 foo
</a><a href="#h11-1-7" id="h11-1-7" class="i">+2@1 &quot;foo&quot;
</a> 
 # Passing the commit index yields nothing.
 scan_apply 2
<a href="#h11-2" id="h11-2" class="h">@@ -43,17 +43,17 @@ ok
</a> commit 3
 scan_apply 2
 ---
<a href="#h11-2-3" id="h11-2-3" class="d">-commit → 3@2 bar
</a><a href="#h11-2-4" id="h11-2-4" class="d">-3@2 bar
</a><a href="#h11-2-5" id="h11-2-5" class="i">+commit → 3@2 &quot;bar&quot;
</a><a href="#h11-2-6" id="h11-2-6" class="i">+3@2 &quot;bar&quot;
</a> 
 # Scanning from a lower commit index again works.
 scan_apply 1
 ---
<a href="#h11-2-11" id="h11-2-11" class="d">-2@1 foo
</a><a href="#h11-2-12" id="h11-2-12" class="d">-3@2 bar
</a><a href="#h11-2-13" id="h11-2-13" class="i">+2@1 &quot;foo&quot;
</a><a href="#h11-2-14" id="h11-2-14" class="i">+3@2 &quot;bar&quot;
</a> 
 scan_apply 0
 ---
 1@1 None
<a href="#h11-2-19" id="h11-2-19" class="d">-2@1 foo
</a><a href="#h11-2-20" id="h11-2-20" class="d">-3@2 bar
</a><a href="#h11-2-21" id="h11-2-21" class="i">+2@1 &quot;foo&quot;
</a><a href="#h11-2-22" id="h11-2-22" class="i">+3@2 &quot;bar&quot;
</a><b>diff --git a/<a id="h12" href="../file/src/raft/testscripts/log/splice.html">src/raft/testscripts/log/splice</a> b/<a href="../file/src/raft/testscripts/log/splice.html">src/raft/testscripts/log/splice</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -24,23 +24,23 @@ splice 1@2= 2@2=command [ops]
</a> status
 scan
 ---
<a href="#h12-0-3" id="h12-0-3" class="d">-splice → 2@2 command
</a><a href="#h12-0-4" id="h12-0-4" class="d">-engine set Entry(1) 0x000000000000000001 = 0x010200
</a><a href="#h12-0-5" id="h12-0-5" class="d">-engine set Entry(2) 0x000000000000000002 = 0x02020107636f6d6d616e64
</a><a href="#h12-0-6" id="h12-0-6" class="i">+splice → 2@2 &quot;command&quot;
</a><a href="#h12-0-7" id="h12-0-7" class="i">+engine set raft:Entry(1) → 1@2 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x02\x00&quot;]
</a><a href="#h12-0-8" id="h12-0-8" class="i">+engine set raft:Entry(2) → 2@2 &quot;command&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x02\x01\x07command&quot;]
</a> engine flush
 term=2 last=2@2 commit=0@0 vote=None
 1@2 None
<a href="#h12-0-12" id="h12-0-12" class="d">-2@2 command
</a><a href="#h12-0-13" id="h12-0-13" class="i">+2@2 &quot;command&quot;
</a> 
 # Splicing an empty list should work and be a noop.
 splice [ops]
 status
 scan
 ---
<a href="#h12-0-20" id="h12-0-20" class="d">-splice → 2@2 command
</a><a href="#h12-0-21" id="h12-0-21" class="i">+splice → 2@2 &quot;command&quot;
</a> term=2 last=2@2 commit=0@0 vote=None
 1@2 None
<a href="#h12-0-24" id="h12-0-24" class="d">-2@2 command
</a><a href="#h12-0-25" id="h12-0-25" class="i">+2@2 &quot;command&quot;
</a> 
 # Splicing multiple duplicate entries should fail.
 !splice 3@2= 3@2=
<a href="#h12-1" id="h12-1" class="h">@@ -78,25 +78,25 @@ Panic: splice term 4 beyond current 2
</a> splice 1@2= 2@2=command [ops]
 scan
 ---
<a href="#h12-1-3" id="h12-1-3" class="d">-splice → 2@2 command
</a><a href="#h12-1-4" id="h12-1-4" class="i">+splice → 2@2 &quot;command&quot;
</a> 1@2 None
<a href="#h12-1-6" id="h12-1-6" class="d">-2@2 command
</a><a href="#h12-1-7" id="h12-1-7" class="i">+2@2 &quot;command&quot;
</a> 
 # An overlapping prefix is a noop.
 splice 1@2= [ops]
 scan
 ---
<a href="#h12-1-13" id="h12-1-13" class="d">-splice → 2@2 command
</a><a href="#h12-1-14" id="h12-1-14" class="i">+splice → 2@2 &quot;command&quot;
</a> 1@2 None
<a href="#h12-1-16" id="h12-1-16" class="d">-2@2 command
</a><a href="#h12-1-17" id="h12-1-17" class="i">+2@2 &quot;command&quot;
</a> 
 # An overlapping suffix is a noop.
 splice 2@2=command [ops]
 scan
 ---
<a href="#h12-1-23" id="h12-1-23" class="d">-splice → 2@2 command
</a><a href="#h12-1-24" id="h12-1-24" class="i">+splice → 2@2 &quot;command&quot;
</a> 1@2 None
<a href="#h12-1-26" id="h12-1-26" class="d">-2@2 command
</a><a href="#h12-1-27" id="h12-1-27" class="i">+2@2 &quot;command&quot;
</a> 
 # Changing a command with the same term/index should fail.
 !splice 2@2=foo
<a href="#h12-2" id="h12-2" class="h">@@ -104,7 +104,7 @@ scan
</a> ---
 Panic: command mismatch at Entry { index: 2, term: 2, command: Some([99, 111, 109, 109, 97, 110, 100]) }
 1@2 None
<a href="#h12-2-3" id="h12-2-3" class="d">-2@2 command
</a><a href="#h12-2-4" id="h12-2-4" class="i">+2@2 &quot;command&quot;
</a> 
 # Appending a new entry in the same term should work, as should
 # appending one in a new term.
<a href="#h12-3" id="h12-3" class="h">@@ -113,27 +113,27 @@ set_term 3
</a> splice 4@3=
 scan
 ---
<a href="#h12-3-3" id="h12-3-3" class="d">-splice → 3@2 bar
</a><a href="#h12-3-4" id="h12-3-4" class="i">+splice → 3@2 &quot;bar&quot;
</a> splice → 4@3 None
 1@2 None
<a href="#h12-3-7" id="h12-3-7" class="d">-2@2 command
</a><a href="#h12-3-8" id="h12-3-8" class="d">-3@2 bar
</a><a href="#h12-3-9" id="h12-3-9" class="i">+2@2 &quot;command&quot;
</a><a href="#h12-3-10" id="h12-3-10" class="i">+3@2 &quot;bar&quot;
</a> 4@3 None
 
 # Splicing with suffix overlap should work, and only write the new entries.
 splice 3@2=bar 4@3= 5@3=foo 6@3=bar [ops]
 scan
 ---
<a href="#h12-3-17" id="h12-3-17" class="d">-splice → 6@3 bar
</a><a href="#h12-3-18" id="h12-3-18" class="d">-engine set Entry(5) 0x000000000000000005 = 0x05030103666f6f
</a><a href="#h12-3-19" id="h12-3-19" class="d">-engine set Entry(6) 0x000000000000000006 = 0x06030103626172
</a><a href="#h12-3-20" id="h12-3-20" class="i">+splice → 6@3 &quot;bar&quot;
</a><a href="#h12-3-21" id="h12-3-21" class="i">+engine set raft:Entry(5) → 5@3 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x05&quot; → &quot;\x05\x03\x01\x03foo&quot;]
</a><a href="#h12-3-22" id="h12-3-22" class="i">+engine set raft:Entry(6) → 6@3 &quot;bar&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x06&quot; → &quot;\x06\x03\x01\x03bar&quot;]
</a> engine flush
 1@2 None
<a href="#h12-3-25" id="h12-3-25" class="d">-2@2 command
</a><a href="#h12-3-26" id="h12-3-26" class="d">-3@2 bar
</a><a href="#h12-3-27" id="h12-3-27" class="i">+2@2 &quot;command&quot;
</a><a href="#h12-3-28" id="h12-3-28" class="i">+3@2 &quot;bar&quot;
</a> 4@3 None
<a href="#h12-3-30" id="h12-3-30" class="d">-5@3 foo
</a><a href="#h12-3-31" id="h12-3-31" class="d">-6@3 bar
</a><a href="#h12-3-32" id="h12-3-32" class="i">+5@3 &quot;foo&quot;
</a><a href="#h12-3-33" id="h12-3-33" class="i">+6@3 &quot;bar&quot;
</a> 
 # Splicing at an existing index with a new term should replace the tail.
 set_term 4
<a href="#h12-4" id="h12-4" class="h">@@ -142,14 +142,14 @@ status
</a> scan
 ---
 splice → 4@4 None
<a href="#h12-4-3" id="h12-4-3" class="d">-engine set Entry(4) 0x000000000000000004 = 0x040400
</a><a href="#h12-4-4" id="h12-4-4" class="d">-engine delete Entry(5) 0x000000000000000005
</a><a href="#h12-4-5" id="h12-4-5" class="d">-engine delete Entry(6) 0x000000000000000006
</a><a href="#h12-4-6" id="h12-4-6" class="i">+engine set raft:Entry(4) → 4@4 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x04\x04\x00&quot;]
</a><a href="#h12-4-7" id="h12-4-7" class="i">+engine delete raft:Entry(5) [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x05&quot;]
</a><a href="#h12-4-8" id="h12-4-8" class="i">+engine delete raft:Entry(6) [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x06&quot;]
</a> engine flush
 term=4 last=4@4 commit=0@0 vote=None
 1@2 None
<a href="#h12-4-12" id="h12-4-12" class="d">-2@2 command
</a><a href="#h12-4-13" id="h12-4-13" class="d">-3@2 bar
</a><a href="#h12-4-14" id="h12-4-14" class="i">+2@2 &quot;command&quot;
</a><a href="#h12-4-15" id="h12-4-15" class="i">+3@2 &quot;bar&quot;
</a> 4@4 None
 
 # This also holds at the start of the log.
<a href="#h12-5" id="h12-5" class="h">@@ -158,16 +158,16 @@ splice 1@5= 2@5=foo 3@5=bar [ops]
</a> status
 scan
 ---
<a href="#h12-5-3" id="h12-5-3" class="d">-splice → 3@5 bar
</a><a href="#h12-5-4" id="h12-5-4" class="d">-engine set Entry(1) 0x000000000000000001 = 0x010500
</a><a href="#h12-5-5" id="h12-5-5" class="d">-engine set Entry(2) 0x000000000000000002 = 0x02050103666f6f
</a><a href="#h12-5-6" id="h12-5-6" class="d">-engine set Entry(3) 0x000000000000000003 = 0x03050103626172
</a><a href="#h12-5-7" id="h12-5-7" class="d">-engine delete Entry(4) 0x000000000000000004
</a><a href="#h12-5-8" id="h12-5-8" class="i">+splice → 3@5 &quot;bar&quot;
</a><a href="#h12-5-9" id="h12-5-9" class="i">+engine set raft:Entry(1) → 1@5 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x05\x00&quot;]
</a><a href="#h12-5-10" id="h12-5-10" class="i">+engine set raft:Entry(2) → 2@5 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x05\x01\x03foo&quot;]
</a><a href="#h12-5-11" id="h12-5-11" class="i">+engine set raft:Entry(3) → 3@5 &quot;bar&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x03\x05\x01\x03bar&quot;]
</a><a href="#h12-5-12" id="h12-5-12" class="i">+engine delete raft:Entry(4) [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot;]
</a> engine flush
 term=5 last=3@5 commit=0@0 vote=None
 1@5 None
<a href="#h12-5-16" id="h12-5-16" class="d">-2@5 foo
</a><a href="#h12-5-17" id="h12-5-17" class="d">-3@5 bar
</a><a href="#h12-5-18" id="h12-5-18" class="i">+2@5 &quot;foo&quot;
</a><a href="#h12-5-19" id="h12-5-19" class="i">+3@5 &quot;bar&quot;
</a> 
 # Splicing across the commit index should work, as long as the entries match.
 commit 2
<a href="#h12-6" id="h12-6" class="h">@@ -175,12 +175,12 @@ splice 1@5= 2@5=foo 3@5=bar 4@5=
</a> status
 scan
 ---
<a href="#h12-6-3" id="h12-6-3" class="d">-commit → 2@5 foo
</a><a href="#h12-6-4" id="h12-6-4" class="i">+commit → 2@5 &quot;foo&quot;
</a> splice → 4@5 None
 term=5 last=4@5 commit=2@5 vote=None
 1@5 None
<a href="#h12-6-8" id="h12-6-8" class="d">-2@5 foo
</a><a href="#h12-6-9" id="h12-6-9" class="d">-3@5 bar
</a><a href="#h12-6-10" id="h12-6-10" class="i">+2@5 &quot;foo&quot;
</a><a href="#h12-6-11" id="h12-6-11" class="i">+3@5 &quot;bar&quot;
</a> 4@5 None
 
 # Splicing across the commit index can replace a tail after the commit index.
<a href="#h12-7" id="h12-7" class="h">@@ -189,12 +189,12 @@ splice 3@6= 4@6=bar
</a> status
 scan
 ---
<a href="#h12-7-3" id="h12-7-3" class="d">-splice → 4@6 bar
</a><a href="#h12-7-4" id="h12-7-4" class="i">+splice → 4@6 &quot;bar&quot;
</a> term=9 last=4@6 commit=2@5 vote=None
 1@5 None
<a href="#h12-7-7" id="h12-7-7" class="d">-2@5 foo
</a><a href="#h12-7-8" id="h12-7-8" class="i">+2@5 &quot;foo&quot;
</a> 3@6 None
<a href="#h12-7-10" id="h12-7-10" class="d">-4@6 bar
</a><a href="#h12-7-11" id="h12-7-11" class="i">+4@6 &quot;bar&quot;
</a> 
 # But replacing a tail at or before the commit index should fail.
 !splice 2@7=
<a href="#h12-8" id="h12-8" class="h">@@ -206,9 +206,9 @@ Panic: spliced entries below commit index
</a> # Dump the raw data.
 dump
 ---
<a href="#h12-8-3" id="h12-8-3" class="d">-Entry(1) 0x000000000000000001 = 0x010500
</a><a href="#h12-8-4" id="h12-8-4" class="d">-Entry(2) 0x000000000000000002 = 0x02050103666f6f
</a><a href="#h12-8-5" id="h12-8-5" class="d">-Entry(3) 0x000000000000000003 = 0x030600
</a><a href="#h12-8-6" id="h12-8-6" class="d">-Entry(4) 0x000000000000000004 = 0x04060103626172
</a><a href="#h12-8-7" id="h12-8-7" class="d">-TermVote 0x01 = 0x0900
</a><a href="#h12-8-8" id="h12-8-8" class="d">-CommitIndex 0x02 = 0x0205
</a><a href="#h12-8-9" id="h12-8-9" class="i">+raft:Entry(1) → 1@5 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x05\x00&quot;]
</a><a href="#h12-8-10" id="h12-8-10" class="i">+raft:Entry(2) → 2@5 &quot;foo&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02\x05\x01\x03foo&quot;]
</a><a href="#h12-8-11" id="h12-8-11" class="i">+raft:Entry(3) → 3@6 None [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x03\x06\x00&quot;]
</a><a href="#h12-8-12" id="h12-8-12" class="i">+raft:Entry(4) → 4@6 &quot;bar&quot; [&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x04\x06\x01\x03bar&quot;]
</a><a href="#h12-8-13" id="h12-8-13" class="i">+raft:TermVote → term=9 vote=None [&quot;\x01&quot; → &quot;\t\x00&quot;]
</a><a href="#h12-8-14" id="h12-8-14" class="i">+raft:CommitIndex → 2@5 [&quot;\x02&quot; → &quot;\x02\x05&quot;]
</a><b>diff --git a/<a id="h13" href="../file/src/raft/testscripts/log/status.html">src/raft/testscripts/log/status</a> b/<a href="../file/src/raft/testscripts/log/status.html">src/raft/testscripts/log/status</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -19,9 +19,9 @@ append bar
</a> commit 2
 ---
 append → 1@1 None
<a href="#h13-0-3" id="h13-0-3" class="d">-append → 2@1 foo
</a><a href="#h13-0-4" id="h13-0-4" class="d">-append → 3@2 bar
</a><a href="#h13-0-5" id="h13-0-5" class="d">-commit → 2@1 foo
</a><a href="#h13-0-6" id="h13-0-6" class="i">+append → 2@1 &quot;foo&quot;
</a><a href="#h13-0-7" id="h13-0-7" class="i">+append → 3@2 &quot;bar&quot;
</a><a href="#h13-0-8" id="h13-0-8" class="i">+commit → 2@1 &quot;foo&quot;
</a> 
 # Status gives correct info.
 status engine=true
<b>diff --git a/<a id="h14" href="../file/src/raft/testscripts/log/term.html">src/raft/testscripts/log/term</a> b/<a href="../file/src/raft/testscripts/log/term.html">src/raft/testscripts/log/term</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -13,7 +13,7 @@ Panic: can&#39;t set term 0
</a> set_term 3 [ops]
 get_term
 ---
<a href="#h14-0-3" id="h14-0-3" class="d">-engine set TermVote 0x01 = 0x0300
</a><a href="#h14-0-4" id="h14-0-4" class="i">+engine set raft:TermVote → term=3 vote=None [&quot;\x01&quot; → &quot;\x03\x00&quot;]
</a> engine flush
 term=3 vote=None
 
<a href="#h14-1" id="h14-1" class="h">@@ -21,7 +21,7 @@ term=3 vote=None
</a> set_term 3 7 [ops]
 get_term
 ---
<a href="#h14-1-3" id="h14-1-3" class="d">-engine set TermVote 0x01 = 0x030107
</a><a href="#h14-1-4" id="h14-1-4" class="i">+engine set raft:TermVote → term=3 vote=7 [&quot;\x01&quot; → &quot;\x03\x01\x07&quot;]
</a> engine flush
 term=3 vote=7
 
<a href="#h14-2" id="h14-2" class="h">@@ -63,4 +63,4 @@ get_term
</a> dump
 ---
 term=9 vote=1
<a href="#h14-2-3" id="h14-2-3" class="d">-TermVote 0x01 = 0x090101
</a><a href="#h14-2-4" id="h14-2-4" class="i">+raft:TermVote → term=9 vote=1 [&quot;\x01&quot; → &quot;\t\x01\x01&quot;]
</a><b>diff --git a/<a id="h15" href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a> b/<a href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -364,6 +364,7 @@ impl Log {
</a> mod tests {
     use super::super::engine::test::Runner;
     use super::*;
<a href="#h15-0-3" id="h15-0-3" class="i">+    use crate::encoding::format::{self, Formatter as _};
</a>     use std::error::Error as StdError;
     use std::fmt::Write as _;
     use std::result::Result as StdResult;
<a href="#h15-1" id="h15-1" class="h">@@ -580,15 +581,15 @@ mod tests {
</a>                 let size = 4 + 4 + key_len as u64 + value_len as u64;
                 writeln!(
                     output,
<a href="#h15-1-3" id="h15-1-3" class="d">-                    &quot;{:&lt;7} key=\&quot;{}\&quot; [{}] {}&quot;,
</a><a href="#h15-1-4" id="h15-1-4" class="i">+                    &quot;{:&lt;7} key={} [{}] {}&quot;,
</a>                     format!(&quot;{size}b&quot;),
<a href="#h15-1-6" id="h15-1-6" class="d">-                    Runner::&lt;BitCask&gt;::format_bytes(&amp;key),
</a><a href="#h15-1-7" id="h15-1-7" class="i">+                    format::Raw::key(&amp;key),
</a>                     hex::encode(key),
                     match value_len_or_tombstone {
                         -1 =&gt; &quot;tombstone&quot;.to_string(),
                         _ =&gt; format!(
<a href="#h15-1-12" id="h15-1-12" class="d">-                            &quot;value=\&quot;{}\&quot; [{}]&quot;,
</a><a href="#h15-1-13" id="h15-1-13" class="d">-                            Runner::&lt;BitCask&gt;::format_bytes(&amp;value),
</a><a href="#h15-1-14" id="h15-1-14" class="i">+                            &quot;value={} [{}]&quot;,
</a><a href="#h15-1-15" id="h15-1-15" class="i">+                            format::Raw::bytes(&amp;value),
</a>                             hex::encode(&amp;value)
                         ),
                     },
<b>diff --git a/<a id="h16" href="../file/src/storage/debug.rs.html">src/storage/debug.rs</a> b/<a href="../file/src/storage/debug.rs.html">src/storage/debug.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,91 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-//! Storage debug helpers, primarily formatting of raw engine data.
</a><a href="#h16-0-1" id="h16-0-1" class="d">-
</a><a href="#h16-0-2" id="h16-0-2" class="d">-// TODO: consider moving these elsewhere.
</a><a href="#h16-0-3" id="h16-0-3" class="d">-
</a><a href="#h16-0-4" id="h16-0-4" class="d">-use super::mvcc::{self, TransactionState};
</a><a href="#h16-0-5" id="h16-0-5" class="d">-use crate::encoding::{bincode, Key as _};
</a><a href="#h16-0-6" id="h16-0-6" class="d">-
</a><a href="#h16-0-7" id="h16-0-7" class="d">-use itertools::Itertools as _;
</a><a href="#h16-0-8" id="h16-0-8" class="d">-use std::collections::BTreeSet;
</a><a href="#h16-0-9" id="h16-0-9" class="d">-
</a><a href="#h16-0-10" id="h16-0-10" class="d">-/// Formats a raw byte string, either as a UTF-8 string (if valid and
</a><a href="#h16-0-11" id="h16-0-11" class="d">-/// printable), otherwise hex-encoded.
</a><a href="#h16-0-12" id="h16-0-12" class="d">-pub fn format_raw(v: &amp;[u8]) -&gt; String {
</a><a href="#h16-0-13" id="h16-0-13" class="d">-    if v.is_empty() {
</a><a href="#h16-0-14" id="h16-0-14" class="d">-        return String::from(&quot;[]&quot;);
</a><a href="#h16-0-15" id="h16-0-15" class="d">-    }
</a><a href="#h16-0-16" id="h16-0-16" class="d">-    if let Ok(s) = String::from_utf8(v.to_vec()) {
</a><a href="#h16-0-17" id="h16-0-17" class="d">-        if s.chars().all(|c| !c.is_control()) {
</a><a href="#h16-0-18" id="h16-0-18" class="d">-            return format!(r#&quot;&quot;{}&quot;&quot;#, s);
</a><a href="#h16-0-19" id="h16-0-19" class="d">-        }
</a><a href="#h16-0-20" id="h16-0-20" class="d">-    }
</a><a href="#h16-0-21" id="h16-0-21" class="d">-    format!(&quot;0x{}&quot;, hex::encode(v))
</a><a href="#h16-0-22" id="h16-0-22" class="d">-}
</a><a href="#h16-0-23" id="h16-0-23" class="d">-
</a><a href="#h16-0-24" id="h16-0-24" class="d">-/// Formats a transaction state.
</a><a href="#h16-0-25" id="h16-0-25" class="d">-pub fn format_txn(state: &amp;TransactionState) -&gt; String {
</a><a href="#h16-0-26" id="h16-0-26" class="d">-    format!(
</a><a href="#h16-0-27" id="h16-0-27" class="d">-        &quot;v{} {} active={}&quot;,
</a><a href="#h16-0-28" id="h16-0-28" class="d">-        state.version,
</a><a href="#h16-0-29" id="h16-0-29" class="d">-        if state.read_only { &quot;read-only&quot; } else { &quot;read-write&quot; },
</a><a href="#h16-0-30" id="h16-0-30" class="d">-        format_set(&amp;state.active)
</a><a href="#h16-0-31" id="h16-0-31" class="d">-    )
</a><a href="#h16-0-32" id="h16-0-32" class="d">-}
</a><a href="#h16-0-33" id="h16-0-33" class="d">-
</a><a href="#h16-0-34" id="h16-0-34" class="d">-/// Formats a BTreeSet.
</a><a href="#h16-0-35" id="h16-0-35" class="d">-pub fn format_set&lt;T: Copy + Ord + std::fmt::Display&gt;(set: &amp;BTreeSet&lt;T&gt;) -&gt; String {
</a><a href="#h16-0-36" id="h16-0-36" class="d">-    let elements = set.iter().map(|v| v.to_string()).join(&quot;,&quot;);
</a><a href="#h16-0-37" id="h16-0-37" class="d">-    format!(&quot;{{{elements}}}&quot;)
</a><a href="#h16-0-38" id="h16-0-38" class="d">-}
</a><a href="#h16-0-39" id="h16-0-39" class="d">-
</a><a href="#h16-0-40" id="h16-0-40" class="d">-/// Formats a raw engine key/value pair, or just the key if the value is None.
</a><a href="#h16-0-41" id="h16-0-41" class="d">-/// Attempts to decode known MVCC key formats and values.
</a><a href="#h16-0-42" id="h16-0-42" class="d">-///
</a><a href="#h16-0-43" id="h16-0-43" class="d">-/// TODO: decode Raft and SQL keys/values too.
</a><a href="#h16-0-44" id="h16-0-44" class="d">-pub fn format_key_value(key: &amp;[u8], value: &amp;Option&lt;Vec&lt;u8&gt;&gt;) -&gt; (String, Option&lt;String&gt;) {
</a><a href="#h16-0-45" id="h16-0-45" class="d">-    // Default to string/hex formatting of the raw key and value.
</a><a href="#h16-0-46" id="h16-0-46" class="d">-    let mut fkey = format_raw(key);
</a><a href="#h16-0-47" id="h16-0-47" class="d">-    let mut fvalue = value.as_ref().map(|v| format_raw(v.as_slice()));
</a><a href="#h16-0-48" id="h16-0-48" class="d">-
</a><a href="#h16-0-49" id="h16-0-49" class="d">-    // Try to decode MVCC keys and values.
</a><a href="#h16-0-50" id="h16-0-50" class="d">-    if let Ok(key) = mvcc::Key::decode(key) {
</a><a href="#h16-0-51" id="h16-0-51" class="d">-        // Use the debug formatting of the key, unless we need more.
</a><a href="#h16-0-52" id="h16-0-52" class="d">-        fkey = format!(&quot;{:?}&quot;, key);
</a><a href="#h16-0-53" id="h16-0-53" class="d">-
</a><a href="#h16-0-54" id="h16-0-54" class="d">-        match key {
</a><a href="#h16-0-55" id="h16-0-55" class="d">-            mvcc::Key::NextVersion =&gt; {
</a><a href="#h16-0-56" id="h16-0-56" class="d">-                if let Some(ref v) = value {
</a><a href="#h16-0-57" id="h16-0-57" class="d">-                    if let Ok(v) = bincode::deserialize::&lt;u64&gt;(v) {
</a><a href="#h16-0-58" id="h16-0-58" class="d">-                        fvalue = Some(format!(&quot;{}&quot;, v))
</a><a href="#h16-0-59" id="h16-0-59" class="d">-                    }
</a><a href="#h16-0-60" id="h16-0-60" class="d">-                }
</a><a href="#h16-0-61" id="h16-0-61" class="d">-            }
</a><a href="#h16-0-62" id="h16-0-62" class="d">-            mvcc::Key::TxnActive(_) =&gt; {}
</a><a href="#h16-0-63" id="h16-0-63" class="d">-            mvcc::Key::TxnActiveSnapshot(_) =&gt; {
</a><a href="#h16-0-64" id="h16-0-64" class="d">-                if let Some(ref v) = value {
</a><a href="#h16-0-65" id="h16-0-65" class="d">-                    if let Ok(active) = bincode::deserialize::&lt;BTreeSet&lt;mvcc::Version&gt;&gt;(v) {
</a><a href="#h16-0-66" id="h16-0-66" class="d">-                        fvalue = Some(format_set(&amp;active));
</a><a href="#h16-0-67" id="h16-0-67" class="d">-                    }
</a><a href="#h16-0-68" id="h16-0-68" class="d">-                }
</a><a href="#h16-0-69" id="h16-0-69" class="d">-            }
</a><a href="#h16-0-70" id="h16-0-70" class="d">-            mvcc::Key::TxnWrite(version, userkey) =&gt; {
</a><a href="#h16-0-71" id="h16-0-71" class="d">-                fkey = format!(&quot;TxnWrite({}, {})&quot;, version, format_raw(&amp;userkey))
</a><a href="#h16-0-72" id="h16-0-72" class="d">-            }
</a><a href="#h16-0-73" id="h16-0-73" class="d">-            mvcc::Key::Version(userkey, version) =&gt; {
</a><a href="#h16-0-74" id="h16-0-74" class="d">-                fkey = format!(&quot;Version({}, {})&quot;, format_raw(&amp;userkey), version);
</a><a href="#h16-0-75" id="h16-0-75" class="d">-                if let Some(ref v) = value {
</a><a href="#h16-0-76" id="h16-0-76" class="d">-                    match bincode::deserialize(v) {
</a><a href="#h16-0-77" id="h16-0-77" class="d">-                        Ok(Some(v)) =&gt; fvalue = Some(format_raw(v)),
</a><a href="#h16-0-78" id="h16-0-78" class="d">-                        Ok(None) =&gt; fvalue = Some(String::from(&quot;None&quot;)),
</a><a href="#h16-0-79" id="h16-0-79" class="d">-                        Err(_) =&gt; {}
</a><a href="#h16-0-80" id="h16-0-80" class="d">-                    }
</a><a href="#h16-0-81" id="h16-0-81" class="d">-                }
</a><a href="#h16-0-82" id="h16-0-82" class="d">-            }
</a><a href="#h16-0-83" id="h16-0-83" class="d">-            mvcc::Key::Unversioned(userkey) =&gt; {
</a><a href="#h16-0-84" id="h16-0-84" class="d">-                fkey = format!(&quot;Unversioned({})&quot;, format_raw(&amp;userkey));
</a><a href="#h16-0-85" id="h16-0-85" class="d">-            }
</a><a href="#h16-0-86" id="h16-0-86" class="d">-        }
</a><a href="#h16-0-87" id="h16-0-87" class="d">-    }
</a><a href="#h16-0-88" id="h16-0-88" class="d">-
</a><a href="#h16-0-89" id="h16-0-89" class="d">-    (fkey, fvalue)
</a><a href="#h16-0-90" id="h16-0-90" class="d">-}
</a><b>diff --git a/<a id="h17" href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a> b/<a href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -78,6 +78,7 @@ pub struct Status {
</a> #[cfg(test)]
 pub mod test {
     use super::*;
<a href="#h17-0-3" id="h17-0-3" class="i">+    use crate::encoding::format::{self, Formatter as _};
</a>     use crossbeam::channel::Sender;
     use regex::Regex;
     use std::error::Error as StdError;
<a href="#h17-1" id="h17-1" class="h">@@ -109,7 +110,7 @@ pub mod test {
</a>                     let key = Self::decode_binary(&amp;args.next_pos().ok_or(&quot;key not given&quot;)?.value);
                     args.reject_rest()?;
                     let value = self.engine.get(&amp;key)?;
<a href="#h17-1-3" id="h17-1-3" class="d">-                    output.push_str(&amp;Self::format_key_value(&amp;key, value.as_deref()))
</a><a href="#h17-1-4" id="h17-1-4" class="i">+                    writeln!(output, &quot;{}&quot;, format::Raw::key_maybe_value(&amp;key, value.as_deref()))?;
</a>                 }
 
                 // scan [reverse=BOOL] RANGE
<a href="#h17-2" id="h17-2" class="h">@@ -126,7 +127,7 @@ pub mod test {
</a>                         self.engine.scan(range).collect::&lt;Result&lt;_&gt;&gt;()?
                     };
                     for (key, value) in items {
<a href="#h17-2-3" id="h17-2-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h17-2-4" id="h17-2-4" class="i">+                        writeln!(output, &quot;{}&quot;, format::Raw::key_value(&amp;key, &amp;value))?;
</a>                     }
                 }
 
<a href="#h17-3" id="h17-3" class="h">@@ -138,7 +139,7 @@ pub mod test {
</a>                     args.reject_rest()?;
                     let mut scan = self.engine.scan_prefix(&amp;prefix);
                     while let Some((key, value)) = scan.next().transpose()? {
<a href="#h17-3-3" id="h17-3-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h17-3-4" id="h17-3-4" class="i">+                        writeln!(output, &quot;{}&quot;, format::Raw::key_value(&amp;key, &amp;value))?;
</a>                     }
                 }
 
<a href="#h17-4" id="h17-4" class="h">@@ -189,22 +190,6 @@ pub mod test {
</a>             bytes
         }
 
<a href="#h17-4-3" id="h17-4-3" class="d">-        /// Formats a raw binary byte vector, escaping special characters.
</a><a href="#h17-4-4" id="h17-4-4" class="d">-        /// TODO: find a better way to manage and share formatting functions.
</a><a href="#h17-4-5" id="h17-4-5" class="d">-        pub fn format_bytes(bytes: &amp;[u8]) -&gt; String {
</a><a href="#h17-4-6" id="h17-4-6" class="d">-            let b: Vec&lt;u8&gt; = bytes.iter().copied().flat_map(std::ascii::escape_default).collect();
</a><a href="#h17-4-7" id="h17-4-7" class="d">-            String::from_utf8_lossy(&amp;b).to_string()
</a><a href="#h17-4-8" id="h17-4-8" class="d">-        }
</a><a href="#h17-4-9" id="h17-4-9" class="d">-
</a><a href="#h17-4-10" id="h17-4-10" class="d">-        /// Formats a key/value pair, or None if the value does not exist.
</a><a href="#h17-4-11" id="h17-4-11" class="d">-        pub fn format_key_value(key: &amp;[u8], value: Option&lt;&amp;[u8]&gt;) -&gt; String {
</a><a href="#h17-4-12" id="h17-4-12" class="d">-            format!(
</a><a href="#h17-4-13" id="h17-4-13" class="d">-                &quot;{} → {}&quot;,
</a><a href="#h17-4-14" id="h17-4-14" class="d">-                Self::format_bytes(key),
</a><a href="#h17-4-15" id="h17-4-15" class="d">-                value.map(Self::format_bytes).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h17-4-16" id="h17-4-16" class="d">-            )
</a><a href="#h17-4-17" id="h17-4-17" class="d">-        }
</a><a href="#h17-4-18" id="h17-4-18" class="d">-
</a>         /// Parses an binary key range, using Rust range syntax.
         fn parse_key_range(
             s: &amp;str,
<b>diff --git a/<a id="h18" href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a> b/<a href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,5 +1,4 @@
</a> mod bitcask;
<a href="#h18-0-1" id="h18-0-1" class="d">-pub mod debug;
</a> pub mod engine;
 mod memory;
 pub mod mvcc;
<b>diff --git a/<a id="h19" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -740,9 +740,10 @@ impl&lt;&#39;a, E: Engine&gt; Iterator for VersionIterator&lt;&#39;a, E&gt; {
</a> 
 #[cfg(test)]
 pub mod tests {
<a href="#h19-0-3" id="h19-0-3" class="d">-    use super::super::engine::test::{Emit, Mirror, Operation};
</a><a href="#h19-0-4" id="h19-0-4" class="d">-    use super::super::{debug, BitCask, Memory};
</a>     use super::*;
<a href="#h19-0-6" id="h19-0-6" class="i">+    use crate::encoding::format::{self, Formatter as _};
</a><a href="#h19-0-7" id="h19-0-7" class="i">+    use crate::storage::engine::test::{Emit, Mirror, Operation};
</a><a href="#h19-0-8" id="h19-0-8" class="i">+    use crate::storage::{BitCask, Memory};
</a>     use crossbeam::channel::Receiver;
     use itertools::Itertools as _;
     use regex::Regex;
<a href="#h19-1" id="h19-1" class="h">@@ -835,11 +836,9 @@ pub mod tests {
</a>                     let mut engine = self.mvcc.engine.lock().unwrap();
                     let mut scan = engine.scan(..);
                     while let Some((key, value)) = scan.next().transpose()? {
<a href="#h19-1-3" id="h19-1-3" class="d">-                        let (fkey, Some(fvalue)) = debug::format_key_value(&amp;key, &amp;Some(value))
</a><a href="#h19-1-4" id="h19-1-4" class="d">-                        else {
</a><a href="#h19-1-5" id="h19-1-5" class="d">-                            panic!(&quot;expected option&quot;);
</a><a href="#h19-1-6" id="h19-1-6" class="d">-                        };
</a><a href="#h19-1-7" id="h19-1-7" class="d">-                        writeln!(output, &quot;{fkey} → {fvalue}&quot;)?;
</a><a href="#h19-1-8" id="h19-1-8" class="i">+                        let fmtkv = format::MVCC::&lt;format::Raw&gt;::key_value(&amp;key, &amp;value);
</a><a href="#h19-1-9" id="h19-1-9" class="i">+                        let rawkv = format::Raw::key_value(&amp;key, &amp;value);
</a><a href="#h19-1-10" id="h19-1-10" class="i">+                        writeln!(output, &quot;{fmtkv} [{rawkv}]&quot;)?;
</a>                     }
                 }
 
<a href="#h19-2" id="h19-2" class="h">@@ -850,7 +849,8 @@ pub mod tests {
</a>                     for arg in args.rest_pos() {
                         let key = Self::decode_binary(&amp;arg.value);
                         let value = txn.get(&amp;key)?;
<a href="#h19-2-3" id="h19-2-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, value.as_deref()))?;
</a><a href="#h19-2-4" id="h19-2-4" class="i">+                        let fmtkv = format::Raw::key_maybe_value(&amp;key, value.as_deref());
</a><a href="#h19-2-5" id="h19-2-5" class="i">+                        writeln!(output, &quot;{fmtkv}&quot;)?;
</a>                     }
                     args.reject_rest()?;
                 }
<a href="#h19-3" id="h19-3" class="h">@@ -862,7 +862,8 @@ pub mod tests {
</a>                     for arg in args.rest_pos() {
                         let key = Self::decode_binary(&amp;arg.value);
                         let value = self.mvcc.get_unversioned(&amp;key)?;
<a href="#h19-3-3" id="h19-3-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, value.as_deref()))?;
</a><a href="#h19-3-4" id="h19-3-4" class="i">+                        let fmtkv = format::Raw::key_maybe_value(&amp;key, value.as_deref());
</a><a href="#h19-3-5" id="h19-3-5" class="i">+                        writeln!(output, &quot;{fmtkv}&quot;)?;
</a>                     }
                     args.reject_rest()?;
                 }
<a href="#h19-4" id="h19-4" class="h">@@ -924,7 +925,7 @@ pub mod tests {
</a> 
                     let kvs: Vec&lt;_&gt; = txn.scan(range).collect::&lt;crate::error::Result&lt;_&gt;&gt;()?;
                     for (key, value) in kvs {
<a href="#h19-4-3" id="h19-4-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h19-4-4" id="h19-4-4" class="i">+                        writeln!(output, &quot;{}&quot;, format::Raw::key_value(&amp;key, &amp;value))?;
</a>                     }
                 }
 
<a href="#h19-5" id="h19-5" class="h">@@ -939,7 +940,7 @@ pub mod tests {
</a>                     let kvs: Vec&lt;_&gt; =
                         txn.scan_prefix(&amp;prefix).collect::&lt;crate::error::Result&lt;_&gt;&gt;()?;
                     for (key, value) in kvs {
<a href="#h19-5-3" id="h19-5-3" class="d">-                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h19-5-4" id="h19-5-4" class="i">+                        writeln!(output, &quot;{}&quot;, format::Raw::key_value(&amp;key, &amp;value))?;
</a>                     }
                 }
 
<a href="#h19-6" id="h19-6" class="h">@@ -1012,13 +1013,15 @@ pub mod tests {
</a>                 match op {
                     _ if !show_ops =&gt; {}
                     Operation::Delete { key } =&gt; {
<a href="#h19-6-3" id="h19-6-3" class="d">-                        let (fkey, _) = debug::format_key_value(&amp;key, &amp;None);
</a><a href="#h19-6-4" id="h19-6-4" class="d">-                        writeln!(output, &quot;engine delete {fkey}&quot;)?
</a><a href="#h19-6-5" id="h19-6-5" class="i">+                        let fmtkey = format::MVCC::&lt;format::Raw&gt;::key(&amp;key);
</a><a href="#h19-6-6" id="h19-6-6" class="i">+                        let rawkey = format::Raw::key(&amp;key);
</a><a href="#h19-6-7" id="h19-6-7" class="i">+                        writeln!(output, &quot;engine delete {fmtkey} [{rawkey}]&quot;)?
</a>                     }
                     Operation::Flush =&gt; writeln!(output, &quot;engine flush&quot;)?,
                     Operation::Set { key, value } =&gt; {
<a href="#h19-6-11" id="h19-6-11" class="d">-                        let (fkey, fvalue) = debug::format_key_value(&amp;key, &amp;Some(value));
</a><a href="#h19-6-12" id="h19-6-12" class="d">-                        writeln!(output, &quot;engine set {} → {}&quot;, fkey, fvalue.unwrap())?
</a><a href="#h19-6-13" id="h19-6-13" class="i">+                        let fmtkv = format::MVCC::&lt;format::Raw&gt;::key_value(&amp;key, &amp;value);
</a><a href="#h19-6-14" id="h19-6-14" class="i">+                        let rawkv = format::Raw::key_value(&amp;key, &amp;value);
</a><a href="#h19-6-15" id="h19-6-15" class="i">+                        writeln!(output, &quot;engine set {fmtkv} [{rawkv}]&quot;)?
</a>                     }
                 }
             }
<a href="#h19-7" id="h19-7" class="h">@@ -1061,21 +1064,6 @@ pub mod tests {
</a>             bytes
         }
 
<a href="#h19-7-3" id="h19-7-3" class="d">-        /// Formats a raw binary byte vector, escaping special characters.
</a><a href="#h19-7-4" id="h19-7-4" class="d">-        fn format_bytes(bytes: &amp;[u8]) -&gt; String {
</a><a href="#h19-7-5" id="h19-7-5" class="d">-            let b: Vec&lt;u8&gt; = bytes.iter().copied().flat_map(std::ascii::escape_default).collect();
</a><a href="#h19-7-6" id="h19-7-6" class="d">-            String::from_utf8_lossy(&amp;b).to_string()
</a><a href="#h19-7-7" id="h19-7-7" class="d">-        }
</a><a href="#h19-7-8" id="h19-7-8" class="d">-
</a><a href="#h19-7-9" id="h19-7-9" class="d">-        /// Formats a key/value pair, or None if the value does not exist.
</a><a href="#h19-7-10" id="h19-7-10" class="d">-        fn format_key_value(key: &amp;[u8], value: Option&lt;&amp;[u8]&gt;) -&gt; String {
</a><a href="#h19-7-11" id="h19-7-11" class="d">-            format!(
</a><a href="#h19-7-12" id="h19-7-12" class="d">-                &quot;{} → {}&quot;,
</a><a href="#h19-7-13" id="h19-7-13" class="d">-                Self::format_bytes(key),
</a><a href="#h19-7-14" id="h19-7-14" class="d">-                value.map(Self::format_bytes).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h19-7-15" id="h19-7-15" class="d">-            )
</a><a href="#h19-7-16" id="h19-7-16" class="d">-        }
</a><a href="#h19-7-17" id="h19-7-17" class="d">-
</a>         /// Parses an binary key range, using Rust range syntax.
         fn parse_key_range(s: &amp;str) -&gt; Result&lt;impl std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;, Box&lt;dyn Error&gt;&gt; {
             let mut bound = (Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded, Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded);
<b>diff --git a/<a id="h20" href="../file/src/storage/testscripts/bitcask/compact.html">src/storage/testscripts/bitcask/compact</a> b/<a href="../file/src/storage/testscripts/bitcask/compact.html">src/storage/testscripts/bitcask/compact</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -16,12 +16,12 @@ delete d
</a> set d=4
 scan
 ---
<a href="#h20-0-3" id="h20-0-3" class="d">- → 
</a><a href="#h20-0-4" id="h20-0-4" class="d">-a → 1
</a><a href="#h20-0-5" id="h20-0-5" class="d">-b → 2
</a><a href="#h20-0-6" id="h20-0-6" class="d">-c → 3
</a><a href="#h20-0-7" id="h20-0-7" class="d">-d → 4
</a><a href="#h20-0-8" id="h20-0-8" class="d">-foo → bar
</a><a href="#h20-0-9" id="h20-0-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h20-0-10" id="h20-0-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h20-0-11" id="h20-0-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h20-0-12" id="h20-0-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h20-0-13" id="h20-0-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h20-0-14" id="h20-0-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a> 
 # Show status.
 status
<a href="#h20-1" id="h20-1" class="h">@@ -85,12 +85,12 @@ ok
</a> # Scan should still give same results.
 scan
 ---
<a href="#h20-1-3" id="h20-1-3" class="d">- → 
</a><a href="#h20-1-4" id="h20-1-4" class="d">-a → 1
</a><a href="#h20-1-5" id="h20-1-5" class="d">-b → 2
</a><a href="#h20-1-6" id="h20-1-6" class="d">-c → 3
</a><a href="#h20-1-7" id="h20-1-7" class="d">-d → 4
</a><a href="#h20-1-8" id="h20-1-8" class="d">-foo → bar
</a><a href="#h20-1-9" id="h20-1-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h20-1-10" id="h20-1-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h20-1-11" id="h20-1-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h20-1-12" id="h20-1-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h20-1-13" id="h20-1-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h20-1-14" id="h20-1-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a> 
 # Status should show no garbage.
 status
<a href="#h20-2" id="h20-2" class="h">@@ -129,9 +129,9 @@ dump
</a> reopen
 scan
 ---
<a href="#h20-2-3" id="h20-2-3" class="d">- → 
</a><a href="#h20-2-4" id="h20-2-4" class="d">-a → 1
</a><a href="#h20-2-5" id="h20-2-5" class="d">-b → 2
</a><a href="#h20-2-6" id="h20-2-6" class="d">-c → 3
</a><a href="#h20-2-7" id="h20-2-7" class="d">-d → 4
</a><a href="#h20-2-8" id="h20-2-8" class="d">-foo → bar
</a><a href="#h20-2-9" id="h20-2-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h20-2-10" id="h20-2-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h20-2-11" id="h20-2-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h20-2-12" id="h20-2-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h20-2-13" id="h20-2-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h20-2-14" id="h20-2-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a><b>diff --git a/<a id="h21" href="../file/src/storage/testscripts/bitcask/compact_open.html">src/storage/testscripts/bitcask/compact_open</a> b/<a href="../file/src/storage/testscripts/bitcask/compact_open.html">src/storage/testscripts/bitcask/compact_open</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -17,12 +17,12 @@ delete d
</a> set d=4
 scan
 ---
<a href="#h21-0-3" id="h21-0-3" class="d">- → 
</a><a href="#h21-0-4" id="h21-0-4" class="d">-a → 1
</a><a href="#h21-0-5" id="h21-0-5" class="d">-b → 2
</a><a href="#h21-0-6" id="h21-0-6" class="d">-c → 3
</a><a href="#h21-0-7" id="h21-0-7" class="d">-d → 4
</a><a href="#h21-0-8" id="h21-0-8" class="d">-foo → bar
</a><a href="#h21-0-9" id="h21-0-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h21-0-10" id="h21-0-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h21-0-11" id="h21-0-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h21-0-12" id="h21-0-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h21-0-13" id="h21-0-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h21-0-14" id="h21-0-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a> 
 # Status shows the garbage fraction is 0.51.
 status
<b>diff --git a/<a id="h22" href="../file/src/storage/testscripts/bitcask/log.html">src/storage/testscripts/bitcask/log</a> b/<a href="../file/src/storage/testscripts/bitcask/log.html">src/storage/testscripts/bitcask/log</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -16,12 +16,12 @@ delete d
</a> set d=4
 scan
 ---
<a href="#h22-0-3" id="h22-0-3" class="d">- → 
</a><a href="#h22-0-4" id="h22-0-4" class="d">-a → 1
</a><a href="#h22-0-5" id="h22-0-5" class="d">-b → 2
</a><a href="#h22-0-6" id="h22-0-6" class="d">-c → 3
</a><a href="#h22-0-7" id="h22-0-7" class="d">-d → 4
</a><a href="#h22-0-8" id="h22-0-8" class="d">-foo → bar
</a><a href="#h22-0-9" id="h22-0-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h22-0-10" id="h22-0-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h22-0-11" id="h22-0-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h22-0-12" id="h22-0-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h22-0-13" id="h22-0-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h22-0-14" id="h22-0-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a> 
 # Dump the log.
 dump
<a href="#h22-1" id="h22-1" class="h">@@ -69,12 +69,12 @@ dump
</a> reopen
 scan
 ---
<a href="#h22-1-3" id="h22-1-3" class="d">- → 
</a><a href="#h22-1-4" id="h22-1-4" class="d">-a → 1
</a><a href="#h22-1-5" id="h22-1-5" class="d">-b → 2
</a><a href="#h22-1-6" id="h22-1-6" class="d">-c → 3
</a><a href="#h22-1-7" id="h22-1-7" class="d">-d → 4
</a><a href="#h22-1-8" id="h22-1-8" class="d">-foo → bar
</a><a href="#h22-1-9" id="h22-1-9" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h22-1-10" id="h22-1-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h22-1-11" id="h22-1-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h22-1-12" id="h22-1-12" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h22-1-13" id="h22-1-13" class="i">+&quot;d&quot; → &quot;4&quot;
</a><a href="#h22-1-14" id="h22-1-14" class="i">+&quot;foo&quot; → &quot;bar&quot;
</a> 
 dump
 ---
<b>diff --git a/<a id="h23" href="../file/src/storage/testscripts/bitcask/status.html">src/storage/testscripts/bitcask/status</a> b/<a href="../file/src/storage/testscripts/bitcask/status.html">src/storage/testscripts/bitcask/status</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -12,8 +12,8 @@ ok
</a> 
 scan
 ---
<a href="#h23-0-3" id="h23-0-3" class="d">-baz → 3
</a><a href="#h23-0-4" id="h23-0-4" class="d">-foo → 123
</a><a href="#h23-0-5" id="h23-0-5" class="i">+&quot;baz&quot; → &quot;3&quot;
</a><a href="#h23-0-6" id="h23-0-6" class="i">+&quot;foo&quot; → &quot;123&quot;
</a> 
 status
 ---
<b>diff --git a/<a id="h24" href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a> b/<a href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -5,15 +5,15 @@ set a=1
</a> get a
 get A
 ---
<a href="#h24-0-3" id="h24-0-3" class="d">-a → 1
</a><a href="#h24-0-4" id="h24-0-4" class="d">-A → None
</a><a href="#h24-0-5" id="h24-0-5" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h24-0-6" id="h24-0-6" class="i">+&quot;A&quot; → None
</a> 
 set A=2
 get a
 get A
 ---
<a href="#h24-0-12" id="h24-0-12" class="d">-a → 1
</a><a href="#h24-0-13" id="h24-0-13" class="d">-A → 2
</a><a href="#h24-0-14" id="h24-0-14" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h24-0-15" id="h24-0-15" class="i">+&quot;A&quot; → &quot;2&quot;
</a> 
 delete a
 delete A
<a href="#h24-1" id="h24-1" class="h">@@ -27,8 +27,8 @@ get &quot;&quot;
</a> scan
 delete &quot;&quot;
 ---
<a href="#h24-1-3" id="h24-1-3" class="d">- → 
</a><a href="#h24-1-4" id="h24-1-4" class="d">- → 
</a><a href="#h24-1-5" id="h24-1-5" class="i">+&quot;&quot; → &quot;&quot;
</a><a href="#h24-1-6" id="h24-1-6" class="i">+&quot;&quot; → &quot;&quot;
</a> 
 scan
 ---
<a href="#h24-2" id="h24-2" class="h">@@ -40,8 +40,8 @@ get &quot;\0&quot;
</a> scan
 delete &quot;\0&quot;
 ---
<a href="#h24-2-3" id="h24-2-3" class="d">-\x00 → \x00
</a><a href="#h24-2-4" id="h24-2-4" class="d">-\x00 → \x00
</a><a href="#h24-2-5" id="h24-2-5" class="i">+&quot;\x00&quot; → &quot;\x00&quot;
</a><a href="#h24-2-6" id="h24-2-6" class="i">+&quot;\x00&quot; → &quot;\x00&quot;
</a> 
 scan
 ---
<a href="#h24-3" id="h24-3" class="h">@@ -53,8 +53,8 @@ get &quot;👋&quot;
</a> scan
 delete &quot;👋&quot;
 ---
<a href="#h24-3-3" id="h24-3-3" class="d">-\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h24-3-4" id="h24-3-4" class="d">-\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h24-3-5" id="h24-3-5" class="i">+&quot;\xf0\x9f\x91\x8b&quot; → &quot;\xf0\x9f\x91\x8b&quot;
</a><a href="#h24-3-6" id="h24-3-6" class="i">+&quot;\xf0\x9f\x91\x8b&quot; → &quot;\xf0\x9f\x91\x8b&quot;
</a> 
 scan
 ---
<b>diff --git a/<a id="h25" href="../file/src/storage/testscripts/engine/point.html">src/storage/testscripts/engine/point</a> b/<a href="../file/src/storage/testscripts/engine/point.html">src/storage/testscripts/engine/point</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -3,7 +3,7 @@
</a> # Getting a missing key in an empty store should return None.
 get a
 ---
<a href="#h25-0-3" id="h25-0-3" class="d">-a → None
</a><a href="#h25-0-4" id="h25-0-4" class="i">+&quot;a&quot; → None
</a> 
 # Write a couple of keys.
 set a=1
<a href="#h25-1" id="h25-1" class="h">@@ -16,38 +16,38 @@ get a
</a> get b
 get c
 ---
<a href="#h25-1-3" id="h25-1-3" class="d">-a → 1
</a><a href="#h25-1-4" id="h25-1-4" class="d">-b → 2
</a><a href="#h25-1-5" id="h25-1-5" class="d">-c → None
</a><a href="#h25-1-6" id="h25-1-6" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h25-1-7" id="h25-1-7" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h25-1-8" id="h25-1-8" class="i">+&quot;c&quot; → None
</a> 
 # Replacing a key should return the new value.
 set a=foo
 get a
 ---
<a href="#h25-1-14" id="h25-1-14" class="d">-a → foo
</a><a href="#h25-1-15" id="h25-1-15" class="i">+&quot;a&quot; → &quot;foo&quot;
</a> 
 # Deleting a key should remove it, but not affect other keys.
 delete a
 get a
 get b
 ---
<a href="#h25-1-22" id="h25-1-22" class="d">-a → None
</a><a href="#h25-1-23" id="h25-1-23" class="d">-b → 2
</a><a href="#h25-1-24" id="h25-1-24" class="i">+&quot;a&quot; → None
</a><a href="#h25-1-25" id="h25-1-25" class="i">+&quot;b&quot; → &quot;2&quot;
</a> 
 # Deletes are idempotent.
 delete a
 get a
 ---
<a href="#h25-1-31" id="h25-1-31" class="d">-a → None
</a><a href="#h25-1-32" id="h25-1-32" class="i">+&quot;a&quot; → None
</a> 
 # Writing a deleted key works fine.
 set a=1
 get a
 ---
<a href="#h25-1-38" id="h25-1-38" class="d">-a → 1
</a><a href="#h25-1-39" id="h25-1-39" class="i">+&quot;a&quot; → &quot;1&quot;
</a> 
 # Scan the final state.
 scan
 ---
<a href="#h25-1-44" id="h25-1-44" class="d">-a → 1
</a><a href="#h25-1-45" id="h25-1-45" class="d">-b → 2
</a><a href="#h25-1-46" id="h25-1-46" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h25-1-47" id="h25-1-47" class="i">+&quot;b&quot; → &quot;2&quot;
</a><b>diff --git a/<a id="h26" href="../file/src/storage/testscripts/engine/scan.html">src/storage/testscripts/engine/scan</a> b/<a href="../file/src/storage/testscripts/engine/scan.html">src/storage/testscripts/engine/scan</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -13,48 +13,48 @@ ok
</a> # Forward and reverse scans.
 scan
 ---
<a href="#h26-0-3" id="h26-0-3" class="d">-C → 3
</a><a href="#h26-0-4" id="h26-0-4" class="d">-a → 1
</a><a href="#h26-0-5" id="h26-0-5" class="d">-b → 2
</a><a href="#h26-0-6" id="h26-0-6" class="d">-ba → 21
</a><a href="#h26-0-7" id="h26-0-7" class="d">-bb → 22
</a><a href="#h26-0-8" id="h26-0-8" class="d">-c → 3
</a><a href="#h26-0-9" id="h26-0-9" class="i">+&quot;C&quot; → &quot;3&quot;
</a><a href="#h26-0-10" id="h26-0-10" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h26-0-11" id="h26-0-11" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h26-0-12" id="h26-0-12" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h26-0-13" id="h26-0-13" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h26-0-14" id="h26-0-14" class="i">+&quot;c&quot; → &quot;3&quot;
</a> 
 scan reverse=true
 ---
<a href="#h26-0-18" id="h26-0-18" class="d">-c → 3
</a><a href="#h26-0-19" id="h26-0-19" class="d">-bb → 22
</a><a href="#h26-0-20" id="h26-0-20" class="d">-ba → 21
</a><a href="#h26-0-21" id="h26-0-21" class="d">-b → 2
</a><a href="#h26-0-22" id="h26-0-22" class="d">-a → 1
</a><a href="#h26-0-23" id="h26-0-23" class="d">-C → 3
</a><a href="#h26-0-24" id="h26-0-24" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h26-0-25" id="h26-0-25" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h26-0-26" id="h26-0-26" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h26-0-27" id="h26-0-27" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h26-0-28" id="h26-0-28" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h26-0-29" id="h26-0-29" class="i">+&quot;C&quot; → &quot;3&quot;
</a> 
 # Inclusive and exclusive ranges.
 scan b..bb
 ---
<a href="#h26-0-34" id="h26-0-34" class="d">-b → 2
</a><a href="#h26-0-35" id="h26-0-35" class="d">-ba → 21
</a><a href="#h26-0-36" id="h26-0-36" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h26-0-37" id="h26-0-37" class="i">+&quot;ba&quot; → &quot;21&quot;
</a> 
 scan &quot;b..=bb&quot;
 ---
<a href="#h26-0-41" id="h26-0-41" class="d">-b → 2
</a><a href="#h26-0-42" id="h26-0-42" class="d">-ba → 21
</a><a href="#h26-0-43" id="h26-0-43" class="d">-bb → 22
</a><a href="#h26-0-44" id="h26-0-44" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h26-0-45" id="h26-0-45" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h26-0-46" id="h26-0-46" class="i">+&quot;bb&quot; → &quot;22&quot;
</a> 
 scan &quot;b..=bb&quot; reverse=true
 ---
<a href="#h26-0-50" id="h26-0-50" class="d">-bb → 22
</a><a href="#h26-0-51" id="h26-0-51" class="d">-ba → 21
</a><a href="#h26-0-52" id="h26-0-52" class="d">-b → 2
</a><a href="#h26-0-53" id="h26-0-53" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h26-0-54" id="h26-0-54" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h26-0-55" id="h26-0-55" class="i">+&quot;b&quot; → &quot;2&quot;
</a> 
 # Open ranges.
 scan bb..
 ---
<a href="#h26-0-60" id="h26-0-60" class="d">-bb → 22
</a><a href="#h26-0-61" id="h26-0-61" class="d">-c → 3
</a><a href="#h26-0-62" id="h26-0-62" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h26-0-63" id="h26-0-63" class="i">+&quot;c&quot; → &quot;3&quot;
</a> 
 scan &quot;..=b&quot;
 ---
<a href="#h26-0-67" id="h26-0-67" class="d">-C → 3
</a><a href="#h26-0-68" id="h26-0-68" class="d">-a → 1
</a><a href="#h26-0-69" id="h26-0-69" class="d">-b → 2
</a><a href="#h26-0-70" id="h26-0-70" class="i">+&quot;C&quot; → &quot;3&quot;
</a><a href="#h26-0-71" id="h26-0-71" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h26-0-72" id="h26-0-72" class="i">+&quot;b&quot; → &quot;2&quot;
</a><b>diff --git a/<a id="h27" href="../file/src/storage/testscripts/engine/scan_prefix.html">src/storage/testscripts/engine/scan_prefix</a> b/<a href="../file/src/storage/testscripts/engine/scan_prefix.html">src/storage/testscripts/engine/scan_prefix</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -16,36 +16,36 @@ set &quot;\xff\xff\xff&quot;=fff
</a> set &quot;\xff\xff\xff\xff&quot;=ffff
 scan
 ---
<a href="#h27-0-3" id="h27-0-3" class="d">-a → 1
</a><a href="#h27-0-4" id="h27-0-4" class="d">-b → 2
</a><a href="#h27-0-5" id="h27-0-5" class="d">-ba → 21
</a><a href="#h27-0-6" id="h27-0-6" class="d">-bb → 22
</a><a href="#h27-0-7" id="h27-0-7" class="d">-b\xff → 2f
</a><a href="#h27-0-8" id="h27-0-8" class="d">-b\xff\x00 → 2f0
</a><a href="#h27-0-9" id="h27-0-9" class="d">-b\xffb → 2fb
</a><a href="#h27-0-10" id="h27-0-10" class="d">-b\xff\xff → 2ff
</a><a href="#h27-0-11" id="h27-0-11" class="d">-c → 3
</a><a href="#h27-0-12" id="h27-0-12" class="d">-\xff → f
</a><a href="#h27-0-13" id="h27-0-13" class="d">-\xff\xff → ff
</a><a href="#h27-0-14" id="h27-0-14" class="d">-\xff\xff\xff → fff
</a><a href="#h27-0-15" id="h27-0-15" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-0-16" id="h27-0-16" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h27-0-17" id="h27-0-17" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h27-0-18" id="h27-0-18" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h27-0-19" id="h27-0-19" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h27-0-20" id="h27-0-20" class="i">+&quot;b\xff&quot; → &quot;2f&quot;
</a><a href="#h27-0-21" id="h27-0-21" class="i">+&quot;b\xff\x00&quot; → &quot;2f0&quot;
</a><a href="#h27-0-22" id="h27-0-22" class="i">+&quot;b\xffb&quot; → &quot;2fb&quot;
</a><a href="#h27-0-23" id="h27-0-23" class="i">+&quot;b\xff\xff&quot; → &quot;2ff&quot;
</a><a href="#h27-0-24" id="h27-0-24" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h27-0-25" id="h27-0-25" class="i">+&quot;\xff&quot; → &quot;f&quot;
</a><a href="#h27-0-26" id="h27-0-26" class="i">+&quot;\xff\xff&quot; → &quot;ff&quot;
</a><a href="#h27-0-27" id="h27-0-27" class="i">+&quot;\xff\xff\xff&quot; → &quot;fff&quot;
</a><a href="#h27-0-28" id="h27-0-28" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 # An empty prefix returns everything.
 scan_prefix &quot;&quot;
 ---
<a href="#h27-0-33" id="h27-0-33" class="d">-a → 1
</a><a href="#h27-0-34" id="h27-0-34" class="d">-b → 2
</a><a href="#h27-0-35" id="h27-0-35" class="d">-ba → 21
</a><a href="#h27-0-36" id="h27-0-36" class="d">-bb → 22
</a><a href="#h27-0-37" id="h27-0-37" class="d">-b\xff → 2f
</a><a href="#h27-0-38" id="h27-0-38" class="d">-b\xff\x00 → 2f0
</a><a href="#h27-0-39" id="h27-0-39" class="d">-b\xffb → 2fb
</a><a href="#h27-0-40" id="h27-0-40" class="d">-b\xff\xff → 2ff
</a><a href="#h27-0-41" id="h27-0-41" class="d">-c → 3
</a><a href="#h27-0-42" id="h27-0-42" class="d">-\xff → f
</a><a href="#h27-0-43" id="h27-0-43" class="d">-\xff\xff → ff
</a><a href="#h27-0-44" id="h27-0-44" class="d">-\xff\xff\xff → fff
</a><a href="#h27-0-45" id="h27-0-45" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-0-46" id="h27-0-46" class="i">+&quot;a&quot; → &quot;1&quot;
</a><a href="#h27-0-47" id="h27-0-47" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h27-0-48" id="h27-0-48" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h27-0-49" id="h27-0-49" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h27-0-50" id="h27-0-50" class="i">+&quot;b\xff&quot; → &quot;2f&quot;
</a><a href="#h27-0-51" id="h27-0-51" class="i">+&quot;b\xff\x00&quot; → &quot;2f0&quot;
</a><a href="#h27-0-52" id="h27-0-52" class="i">+&quot;b\xffb&quot; → &quot;2fb&quot;
</a><a href="#h27-0-53" id="h27-0-53" class="i">+&quot;b\xff\xff&quot; → &quot;2ff&quot;
</a><a href="#h27-0-54" id="h27-0-54" class="i">+&quot;c&quot; → &quot;3&quot;
</a><a href="#h27-0-55" id="h27-0-55" class="i">+&quot;\xff&quot; → &quot;f&quot;
</a><a href="#h27-0-56" id="h27-0-56" class="i">+&quot;\xff\xff&quot; → &quot;ff&quot;
</a><a href="#h27-0-57" id="h27-0-57" class="i">+&quot;\xff\xff\xff&quot; → &quot;fff&quot;
</a><a href="#h27-0-58" id="h27-0-58" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 # A missing prefix returns nothing.
 scan_prefix bx
<a href="#h27-1" id="h27-1" class="h">@@ -56,55 +56,55 @@ ok
</a> # handles 0xff bytes properly.
 scan_prefix b
 ---
<a href="#h27-1-3" id="h27-1-3" class="d">-b → 2
</a><a href="#h27-1-4" id="h27-1-4" class="d">-ba → 21
</a><a href="#h27-1-5" id="h27-1-5" class="d">-bb → 22
</a><a href="#h27-1-6" id="h27-1-6" class="d">-b\xff → 2f
</a><a href="#h27-1-7" id="h27-1-7" class="d">-b\xff\x00 → 2f0
</a><a href="#h27-1-8" id="h27-1-8" class="d">-b\xffb → 2fb
</a><a href="#h27-1-9" id="h27-1-9" class="d">-b\xff\xff → 2ff
</a><a href="#h27-1-10" id="h27-1-10" class="i">+&quot;b&quot; → &quot;2&quot;
</a><a href="#h27-1-11" id="h27-1-11" class="i">+&quot;ba&quot; → &quot;21&quot;
</a><a href="#h27-1-12" id="h27-1-12" class="i">+&quot;bb&quot; → &quot;22&quot;
</a><a href="#h27-1-13" id="h27-1-13" class="i">+&quot;b\xff&quot; → &quot;2f&quot;
</a><a href="#h27-1-14" id="h27-1-14" class="i">+&quot;b\xff\x00&quot; → &quot;2f0&quot;
</a><a href="#h27-1-15" id="h27-1-15" class="i">+&quot;b\xffb&quot; → &quot;2fb&quot;
</a><a href="#h27-1-16" id="h27-1-16" class="i">+&quot;b\xff\xff&quot; → &quot;2ff&quot;
</a> 
 scan_prefix bb
 ---
<a href="#h27-1-20" id="h27-1-20" class="d">-bb → 22
</a><a href="#h27-1-21" id="h27-1-21" class="i">+&quot;bb&quot; → &quot;22&quot;
</a> 
 scan_prefix &quot;b\xff&quot;
 ---
<a href="#h27-1-25" id="h27-1-25" class="d">-b\xff → 2f
</a><a href="#h27-1-26" id="h27-1-26" class="d">-b\xff\x00 → 2f0
</a><a href="#h27-1-27" id="h27-1-27" class="d">-b\xffb → 2fb
</a><a href="#h27-1-28" id="h27-1-28" class="d">-b\xff\xff → 2ff
</a><a href="#h27-1-29" id="h27-1-29" class="i">+&quot;b\xff&quot; → &quot;2f&quot;
</a><a href="#h27-1-30" id="h27-1-30" class="i">+&quot;b\xff\x00&quot; → &quot;2f0&quot;
</a><a href="#h27-1-31" id="h27-1-31" class="i">+&quot;b\xffb&quot; → &quot;2fb&quot;
</a><a href="#h27-1-32" id="h27-1-32" class="i">+&quot;b\xff\xff&quot; → &quot;2ff&quot;
</a> 
 scan_prefix &quot;b\xff\x00&quot;
 ---
<a href="#h27-1-36" id="h27-1-36" class="d">-b\xff\x00 → 2f0
</a><a href="#h27-1-37" id="h27-1-37" class="i">+&quot;b\xff\x00&quot; → &quot;2f0&quot;
</a> 
 scan_prefix &quot;b\xff\xff&quot;
 ---
<a href="#h27-1-41" id="h27-1-41" class="d">-b\xff\xff → 2ff
</a><a href="#h27-1-42" id="h27-1-42" class="i">+&quot;b\xff\xff&quot; → &quot;2ff&quot;
</a> 
 # Chains of \xff prefixes.
 scan_prefix &quot;\xff&quot;
 ---
<a href="#h27-1-47" id="h27-1-47" class="d">-\xff → f
</a><a href="#h27-1-48" id="h27-1-48" class="d">-\xff\xff → ff
</a><a href="#h27-1-49" id="h27-1-49" class="d">-\xff\xff\xff → fff
</a><a href="#h27-1-50" id="h27-1-50" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-1-51" id="h27-1-51" class="i">+&quot;\xff&quot; → &quot;f&quot;
</a><a href="#h27-1-52" id="h27-1-52" class="i">+&quot;\xff\xff&quot; → &quot;ff&quot;
</a><a href="#h27-1-53" id="h27-1-53" class="i">+&quot;\xff\xff\xff&quot; → &quot;fff&quot;
</a><a href="#h27-1-54" id="h27-1-54" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 scan_prefix &quot;\xff\xff&quot;
 ---
<a href="#h27-1-58" id="h27-1-58" class="d">-\xff\xff → ff
</a><a href="#h27-1-59" id="h27-1-59" class="d">-\xff\xff\xff → fff
</a><a href="#h27-1-60" id="h27-1-60" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-1-61" id="h27-1-61" class="i">+&quot;\xff\xff&quot; → &quot;ff&quot;
</a><a href="#h27-1-62" id="h27-1-62" class="i">+&quot;\xff\xff\xff&quot; → &quot;fff&quot;
</a><a href="#h27-1-63" id="h27-1-63" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 scan_prefix &quot;\xff\xff\xff&quot;
 ---
<a href="#h27-1-67" id="h27-1-67" class="d">-\xff\xff\xff → fff
</a><a href="#h27-1-68" id="h27-1-68" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-1-69" id="h27-1-69" class="i">+&quot;\xff\xff\xff&quot; → &quot;fff&quot;
</a><a href="#h27-1-70" id="h27-1-70" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 scan_prefix &quot;\xff\xff\xff\xff&quot;
 ---
<a href="#h27-1-74" id="h27-1-74" class="d">-\xff\xff\xff\xff → ffff
</a><a href="#h27-1-75" id="h27-1-75" class="i">+&quot;\xff\xff\xff\xff&quot; → &quot;ffff&quot;
</a> 
 scan_prefix &quot;\xff\xff\xff\xff\xff&quot;
 ---
<b>diff --git a/<a id="h28" href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -9,4 +9,4 @@ ok
</a> t2: begin
 t2: get key
 ---
<a href="#h28-0-3" id="h28-0-3" class="d">-t2: key → None
</a><a href="#h28-0-4" id="h28-0-4" class="i">+t2: &quot;key&quot; → None
</a><b>diff --git a/<a id="h29" href="../file/src/storage/testscripts/mvcc/anomaly_fuzzy_read.html">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_fuzzy_read.html">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -13,7 +13,7 @@ ok
</a> 
 t2: get key
 ---
<a href="#h29-0-3" id="h29-0-3" class="d">-t2: key → 0
</a><a href="#h29-0-4" id="h29-0-4" class="i">+t2: &quot;key&quot; → &quot;0&quot;
</a> 
 t1: set key=1
 t1: commit
<a href="#h29-1" id="h29-1" class="h">@@ -22,4 +22,4 @@ ok
</a> 
 t2: get key
 ---
<a href="#h29-1-3" id="h29-1-3" class="d">-t2: key → 0
</a><a href="#h29-1-4" id="h29-1-4" class="i">+t2: &quot;key&quot; → &quot;0&quot;
</a><b>diff --git a/<a id="h30" href="../file/src/storage/testscripts/mvcc/anomaly_lost_update.html">src/storage/testscripts/mvcc/anomaly_lost_update</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_lost_update.html">src/storage/testscripts/mvcc/anomaly_lost_update</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -4,12 +4,12 @@
</a> t1: begin
 t1: get key
 ---
<a href="#h30-0-3" id="h30-0-3" class="d">-t1: key → None
</a><a href="#h30-0-4" id="h30-0-4" class="i">+t1: &quot;key&quot; → None
</a> 
 t2: begin
 t2: get key
 ---
<a href="#h30-0-9" id="h30-0-9" class="d">-t2: key → None
</a><a href="#h30-0-10" id="h30-0-10" class="i">+t2: &quot;key&quot; → None
</a> 
 t1: set key=1
 t2: !set key=2
<b>diff --git a/<a id="h31" href="../file/src/storage/testscripts/mvcc/anomaly_phantom_read.html">src/storage/testscripts/mvcc/anomaly_phantom_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_phantom_read.html">src/storage/testscripts/mvcc/anomaly_phantom_read</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -16,8 +16,8 @@ ok
</a> 
 t1: scan_prefix b
 ---
<a href="#h31-0-3" id="h31-0-3" class="d">-t1: ba → 0
</a><a href="#h31-0-4" id="h31-0-4" class="d">-t1: bb → 0
</a><a href="#h31-0-5" id="h31-0-5" class="i">+t1: &quot;ba&quot; → &quot;0&quot;
</a><a href="#h31-0-6" id="h31-0-6" class="i">+t1: &quot;bb&quot; → &quot;0&quot;
</a> 
 t2: delete ba
 t2: set bc=2
<a href="#h31-1" id="h31-1" class="h">@@ -27,5 +27,5 @@ ok
</a> 
 t1: scan_prefix b
 ---
<a href="#h31-1-3" id="h31-1-3" class="d">-t1: ba → 0
</a><a href="#h31-1-4" id="h31-1-4" class="d">-t1: bb → 0
</a><a href="#h31-1-5" id="h31-1-5" class="i">+t1: &quot;ba&quot; → &quot;0&quot;
</a><a href="#h31-1-6" id="h31-1-6" class="i">+t1: &quot;bb&quot; → &quot;0&quot;
</a><b>diff --git a/<a id="h32" href="../file/src/storage/testscripts/mvcc/anomaly_read_skew.html">src/storage/testscripts/mvcc/anomaly_read_skew</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_read_skew.html">src/storage/testscripts/mvcc/anomaly_read_skew</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -13,7 +13,7 @@ ok
</a> 
 t1: get a
 ---
<a href="#h32-0-3" id="h32-0-3" class="d">-t1: a → 0
</a><a href="#h32-0-4" id="h32-0-4" class="i">+t1: &quot;a&quot; → &quot;0&quot;
</a> 
 t2: set a=2
 t2: set b=2
<a href="#h32-1" id="h32-1" class="h">@@ -23,4 +23,4 @@ ok
</a> 
 t1: get b
 ---
<a href="#h32-1-3" id="h32-1-3" class="d">-t1: b → 0
</a><a href="#h32-1-4" id="h32-1-4" class="i">+t1: &quot;b&quot; → &quot;0&quot;
</a><b>diff --git a/<a id="h33" href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -16,8 +16,8 @@ ok
</a> t1: get a
 t2: get b
 ---
<a href="#h33-0-3" id="h33-0-3" class="d">-t1: a → 1
</a><a href="#h33-0-4" id="h33-0-4" class="d">-t2: b → 2
</a><a href="#h33-0-5" id="h33-0-5" class="i">+t1: &quot;a&quot; → &quot;1&quot;
</a><a href="#h33-0-6" id="h33-0-6" class="i">+t2: &quot;b&quot; → &quot;2&quot;
</a> 
 t1: set b=1
 t2: set a=2
<a href="#h33-1" id="h33-1" class="h">@@ -32,5 +32,5 @@ ok
</a> t3: begin readonly
 t3: scan
 ---
<a href="#h33-1-3" id="h33-1-3" class="d">-t3: a → 2
</a><a href="#h33-1-4" id="h33-1-4" class="d">-t3: b → 1
</a><a href="#h33-1-5" id="h33-1-5" class="i">+t3: &quot;a&quot; → &quot;2&quot;
</a><a href="#h33-1-6" id="h33-1-6" class="i">+t3: &quot;b&quot; → &quot;1&quot;
</a><b>diff --git a/<a id="h34" href="../file/src/storage/testscripts/mvcc/begin.html">src/storage/testscripts/mvcc/begin</a> b/<a href="../file/src/storage/testscripts/mvcc/begin.html">src/storage/testscripts/mvcc/begin</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -6,8 +6,8 @@
</a> t1: begin [ops]
 t1: state
 ---
<a href="#h34-0-3" id="h34-0-3" class="d">-t1: engine set NextVersion → 2
</a><a href="#h34-0-4" id="h34-0-4" class="d">-t1: engine set TxnActive(1) → []
</a><a href="#h34-0-5" id="h34-0-5" class="i">+t1: engine set mvcc:NextVersion → 2 [&quot;\x00&quot; → &quot;\x02&quot;]
</a><a href="#h34-0-6" id="h34-0-6" class="i">+t1: engine set mvcc:TxnActive(1) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;&quot;]
</a> t1: v1 rw active={}
 
 # t2 should have v2, and t1 in its active set. It should persist a snapshot of
<a href="#h34-1" id="h34-1" class="h">@@ -15,24 +15,24 @@ t1: v1 rw active={}
</a> t2: begin [ops]
 t2: state
 ---
<a href="#h34-1-3" id="h34-1-3" class="d">-t2: engine set NextVersion → 3
</a><a href="#h34-1-4" id="h34-1-4" class="d">-t2: engine set TxnActiveSnapshot(2) → {1}
</a><a href="#h34-1-5" id="h34-1-5" class="d">-t2: engine set TxnActive(2) → []
</a><a href="#h34-1-6" id="h34-1-6" class="i">+t2: engine set mvcc:NextVersion → 3 [&quot;\x00&quot; → &quot;\x03&quot;]
</a><a href="#h34-1-7" id="h34-1-7" class="i">+t2: engine set mvcc:TxnActiveSnapshot(2) → {1} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01&quot;]
</a><a href="#h34-1-8" id="h34-1-8" class="i">+t2: engine set mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a> t2: v2 rw active={1}
 
 # Similarly for t3.
 t3: begin [ops]
 t3: state
 ---
<a href="#h34-1-15" id="h34-1-15" class="d">-t3: engine set NextVersion → 4
</a><a href="#h34-1-16" id="h34-1-16" class="d">-t3: engine set TxnActiveSnapshot(3) → {1,2}
</a><a href="#h34-1-17" id="h34-1-17" class="d">-t3: engine set TxnActive(3) → []
</a><a href="#h34-1-18" id="h34-1-18" class="i">+t3: engine set mvcc:NextVersion → 4 [&quot;\x00&quot; → &quot;\x04&quot;]
</a><a href="#h34-1-19" id="h34-1-19" class="i">+t3: engine set mvcc:TxnActiveSnapshot(3) → {1,2} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x02\x01\x02&quot;]
</a><a href="#h34-1-20" id="h34-1-20" class="i">+t3: engine set mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a> t3: v3 rw active={1,2}
 
 # Now, commit t2, which unregisters it.
 t2: commit [ops]
 ---
<a href="#h34-1-26" id="h34-1-26" class="d">-t2: engine delete TxnActive(2)
</a><a href="#h34-1-27" id="h34-1-27" class="i">+t2: engine delete mvcc:TxnActive(2) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a> 
 # It should still be in t3&#39;s active set.
 t3: state
<a href="#h34-2" id="h34-2" class="h">@@ -43,7 +43,7 @@ t3: v3 rw active={1,2}
</a> t4: begin [ops]
 t4: state
 ---
<a href="#h34-2-3" id="h34-2-3" class="d">-t4: engine set NextVersion → 5
</a><a href="#h34-2-4" id="h34-2-4" class="d">-t4: engine set TxnActiveSnapshot(4) → {1,3}
</a><a href="#h34-2-5" id="h34-2-5" class="d">-t4: engine set TxnActive(4) → []
</a><a href="#h34-2-6" id="h34-2-6" class="i">+t4: engine set mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h34-2-7" id="h34-2-7" class="i">+t4: engine set mvcc:TxnActiveSnapshot(4) → {1,3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x02\x01\x03&quot;]
</a><a href="#h34-2-8" id="h34-2-8" class="i">+t4: engine set mvcc:TxnActive(4) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;&quot;]
</a> t4: v4 rw active={1,3}
<b>diff --git a/<a id="h35" href="../file/src/storage/testscripts/mvcc/begin_as_of.html">src/storage/testscripts/mvcc/begin_as_of</a> b/<a href="../file/src/storage/testscripts/mvcc/begin_as_of.html">src/storage/testscripts/mvcc/begin_as_of</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -21,16 +21,16 @@ ok
</a> 
 dump
 ---
<a href="#h35-0-3" id="h35-0-3" class="d">-NextVersion → 4
</a><a href="#h35-0-4" id="h35-0-4" class="d">-TxnActive(1) → []
</a><a href="#h35-0-5" id="h35-0-5" class="d">-TxnActive(3) → []
</a><a href="#h35-0-6" id="h35-0-6" class="d">-TxnActiveSnapshot(2) → {1}
</a><a href="#h35-0-7" id="h35-0-7" class="d">-TxnActiveSnapshot(3) → {1}
</a><a href="#h35-0-8" id="h35-0-8" class="d">-TxnWrite(1, &quot;other&quot;) → []
</a><a href="#h35-0-9" id="h35-0-9" class="d">-TxnWrite(3, &quot;key&quot;) → []
</a><a href="#h35-0-10" id="h35-0-10" class="d">-Version(&quot;key&quot;, 2) → &quot;2&quot;
</a><a href="#h35-0-11" id="h35-0-11" class="d">-Version(&quot;key&quot;, 3) → &quot;3&quot;
</a><a href="#h35-0-12" id="h35-0-12" class="d">-Version(&quot;other&quot;, 1) → &quot;1&quot;
</a><a href="#h35-0-13" id="h35-0-13" class="i">+mvcc:NextVersion → 4 [&quot;\x00&quot; → &quot;\x04&quot;]
</a><a href="#h35-0-14" id="h35-0-14" class="i">+mvcc:TxnActive(1) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;&quot;]
</a><a href="#h35-0-15" id="h35-0-15" class="i">+mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a><a href="#h35-0-16" id="h35-0-16" class="i">+mvcc:TxnActiveSnapshot(2) → {1} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01&quot;]
</a><a href="#h35-0-17" id="h35-0-17" class="i">+mvcc:TxnActiveSnapshot(3) → {1} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x01&quot;]
</a><a href="#h35-0-18" id="h35-0-18" class="i">+mvcc:TxnWrite(1, &quot;other&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01other\x00\x00&quot; → &quot;&quot;]
</a><a href="#h35-0-19" id="h35-0-19" class="i">+mvcc:TxnWrite(3, &quot;key&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03key\x00\x00&quot; → &quot;&quot;]
</a><a href="#h35-0-20" id="h35-0-20" class="i">+mvcc:Version(&quot;key&quot;, 2) → &quot;2&quot; [&quot;\x04key\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h35-0-21" id="h35-0-21" class="i">+mvcc:Version(&quot;key&quot;, 3) → &quot;3&quot; [&quot;\x04key\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x013&quot;]
</a><a href="#h35-0-22" id="h35-0-22" class="i">+mvcc:Version(&quot;other&quot;, 1) → &quot;1&quot; [&quot;\x04other\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a> 
 # Start a read-only transaction as-of version 3. It should only see key=2
 # because t1 and t3 haven&#39;t committed yet. It shouldn&#39;t write any state.
<a href="#h35-1" id="h35-1" class="h">@@ -41,7 +41,7 @@ t4: v3 ro active={1}
</a> 
 t4: scan
 ---
<a href="#h35-1-3" id="h35-1-3" class="d">-t4: key → 2
</a><a href="#h35-1-4" id="h35-1-4" class="i">+t4: &quot;key&quot; → &quot;2&quot;
</a> 
 # Writes should error.
 t4: !set foo=bar
<a href="#h35-2" id="h35-2" class="h">@@ -59,7 +59,7 @@ ok
</a> 
 t4: scan
 ---
<a href="#h35-2-3" id="h35-2-3" class="d">-t4: key → 2
</a><a href="#h35-2-4" id="h35-2-4" class="i">+t4: &quot;key&quot; → &quot;2&quot;
</a> 
 # A new transaction t5 running as-of v3 shouldn&#39;t see them either.
 t5: begin readonly as_of=3
<a href="#h35-3" id="h35-3" class="h">@@ -69,7 +69,7 @@ t5: v3 ro active={1}
</a> 
 t5: scan
 ---
<a href="#h35-3-3" id="h35-3-3" class="d">-t5: key → 2
</a><a href="#h35-3-4" id="h35-3-4" class="i">+t5: &quot;key&quot; → &quot;2&quot;
</a> 
 # Committing and rolling back readonly txns is a noop.
 t4: commit [ops]
<a href="#h35-4" id="h35-4" class="h">@@ -90,8 +90,8 @@ t6: v4 rw active={}
</a> t7: begin readonly as_of=4
 t7: scan
 ---
<a href="#h35-4-3" id="h35-4-3" class="d">-t7: key → 3
</a><a href="#h35-4-4" id="h35-4-4" class="d">-t7: other → 1
</a><a href="#h35-4-5" id="h35-4-5" class="i">+t7: &quot;key&quot; → &quot;3&quot;
</a><a href="#h35-4-6" id="h35-4-6" class="i">+t7: &quot;other&quot; → &quot;1&quot;
</a> 
 # Running as_of future versions should error, including the next version.
 t8: !begin readonly as_of=5
<b>diff --git a/<a id="h36" href="../file/src/storage/testscripts/mvcc/delete.html">src/storage/testscripts/mvcc/delete</a> b/<a href="../file/src/storage/testscripts/mvcc/delete.html">src/storage/testscripts/mvcc/delete</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -8,36 +8,36 @@ ok
</a> t1: begin
 t1: delete a m x [ops]
 ---
<a href="#h36-0-3" id="h36-0-3" class="d">-t1: engine set TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h36-0-4" id="h36-0-4" class="d">-t1: engine set Version(&quot;a&quot;, 2) → None
</a><a href="#h36-0-5" id="h36-0-5" class="d">-t1: engine set TxnWrite(2, &quot;m&quot;) → []
</a><a href="#h36-0-6" id="h36-0-6" class="d">-t1: engine set Version(&quot;m&quot;, 2) → None
</a><a href="#h36-0-7" id="h36-0-7" class="d">-t1: engine set TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h36-0-8" id="h36-0-8" class="d">-t1: engine set Version(&quot;x&quot;, 2) → None
</a><a href="#h36-0-9" id="h36-0-9" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-10" id="h36-0-10" class="i">+t1: engine set mvcc:Version(&quot;a&quot;, 2) → None [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-0-11" id="h36-0-11" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;m&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02m\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-12" id="h36-0-12" class="i">+t1: engine set mvcc:Version(&quot;m&quot;, 2) → None [&quot;\x04m\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-0-13" id="h36-0-13" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;x&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02x\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-14" id="h36-0-14" class="i">+t1: engine set mvcc:Version(&quot;x&quot;, 2) → None [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a> 
 t1: scan
 ---
<a href="#h36-0-18" id="h36-0-18" class="d">-t1: b → 1
</a><a href="#h36-0-19" id="h36-0-19" class="i">+t1: &quot;b&quot; → &quot;1&quot;
</a> 
 # Set and then delete a key, both an existing an missing one.
 t1: set b=2 c=2 [ops]
 ---
<a href="#h36-0-24" id="h36-0-24" class="d">-t1: engine set TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h36-0-25" id="h36-0-25" class="d">-t1: engine set Version(&quot;b&quot;, 2) → &quot;2&quot;
</a><a href="#h36-0-26" id="h36-0-26" class="d">-t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h36-0-27" id="h36-0-27" class="d">-t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h36-0-28" id="h36-0-28" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;b&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02b\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-29" id="h36-0-29" class="i">+t1: engine set mvcc:Version(&quot;b&quot;, 2) → &quot;2&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h36-0-30" id="h36-0-30" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-31" id="h36-0-31" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 2) → &quot;2&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a> 
 t1: scan
 ---
<a href="#h36-0-35" id="h36-0-35" class="d">-t1: b → 2
</a><a href="#h36-0-36" id="h36-0-36" class="d">-t1: c → 2
</a><a href="#h36-0-37" id="h36-0-37" class="i">+t1: &quot;b&quot; → &quot;2&quot;
</a><a href="#h36-0-38" id="h36-0-38" class="i">+t1: &quot;c&quot; → &quot;2&quot;
</a> 
 t1: delete b c [ops]
 ---
<a href="#h36-0-42" id="h36-0-42" class="d">-t1: engine set TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h36-0-43" id="h36-0-43" class="d">-t1: engine set Version(&quot;b&quot;, 2) → None
</a><a href="#h36-0-44" id="h36-0-44" class="d">-t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h36-0-45" id="h36-0-45" class="d">-t1: engine set Version(&quot;c&quot;, 2) → None
</a><a href="#h36-0-46" id="h36-0-46" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;b&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02b\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-47" id="h36-0-47" class="i">+t1: engine set mvcc:Version(&quot;b&quot;, 2) → None [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-0-48" id="h36-0-48" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-0-49" id="h36-0-49" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 2) → None [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a> 
 t1: scan
 ---
<a href="#h36-1" id="h36-1" class="h">@@ -45,18 +45,18 @@ ok
</a> 
 dump
 ---
<a href="#h36-1-3" id="h36-1-3" class="d">-NextVersion → 3
</a><a href="#h36-1-4" id="h36-1-4" class="d">-TxnActive(2) → []
</a><a href="#h36-1-5" id="h36-1-5" class="d">-TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h36-1-6" id="h36-1-6" class="d">-TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h36-1-7" id="h36-1-7" class="d">-TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h36-1-8" id="h36-1-8" class="d">-TxnWrite(2, &quot;m&quot;) → []
</a><a href="#h36-1-9" id="h36-1-9" class="d">-TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h36-1-10" id="h36-1-10" class="d">-Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h36-1-11" id="h36-1-11" class="d">-Version(&quot;a&quot;, 2) → None
</a><a href="#h36-1-12" id="h36-1-12" class="d">-Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h36-1-13" id="h36-1-13" class="d">-Version(&quot;b&quot;, 2) → None
</a><a href="#h36-1-14" id="h36-1-14" class="d">-Version(&quot;c&quot;, 2) → None
</a><a href="#h36-1-15" id="h36-1-15" class="d">-Version(&quot;m&quot;, 2) → None
</a><a href="#h36-1-16" id="h36-1-16" class="d">-Version(&quot;x&quot;, 1) → None
</a><a href="#h36-1-17" id="h36-1-17" class="d">-Version(&quot;x&quot;, 2) → None
</a><a href="#h36-1-18" id="h36-1-18" class="i">+mvcc:NextVersion → 3 [&quot;\x00&quot; → &quot;\x03&quot;]
</a><a href="#h36-1-19" id="h36-1-19" class="i">+mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h36-1-20" id="h36-1-20" class="i">+mvcc:TxnWrite(2, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-1-21" id="h36-1-21" class="i">+mvcc:TxnWrite(2, &quot;b&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02b\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-1-22" id="h36-1-22" class="i">+mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-1-23" id="h36-1-23" class="i">+mvcc:TxnWrite(2, &quot;m&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02m\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-1-24" id="h36-1-24" class="i">+mvcc:TxnWrite(2, &quot;x&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02x\x00\x00&quot; → &quot;&quot;]
</a><a href="#h36-1-25" id="h36-1-25" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h36-1-26" id="h36-1-26" class="i">+mvcc:Version(&quot;a&quot;, 2) → None [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-1-27" id="h36-1-27" class="i">+mvcc:Version(&quot;b&quot;, 1) → &quot;1&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h36-1-28" id="h36-1-28" class="i">+mvcc:Version(&quot;b&quot;, 2) → None [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-1-29" id="h36-1-29" class="i">+mvcc:Version(&quot;c&quot;, 2) → None [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-1-30" id="h36-1-30" class="i">+mvcc:Version(&quot;m&quot;, 2) → None [&quot;\x04m\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><a href="#h36-1-31" id="h36-1-31" class="i">+mvcc:Version(&quot;x&quot;, 1) → None [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x00&quot;]
</a><a href="#h36-1-32" id="h36-1-32" class="i">+mvcc:Version(&quot;x&quot;, 2) → None [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x00&quot;]
</a><b>diff --git a/<a id="h37" href="../file/src/storage/testscripts/mvcc/delete_conflict.html">src/storage/testscripts/mvcc/delete_conflict</a> b/<a href="../file/src/storage/testscripts/mvcc/delete_conflict.html">src/storage/testscripts/mvcc/delete_conflict</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -25,15 +25,15 @@ t2: Error: serialization failure, retry transaction
</a> 
 dump
 ---
<a href="#h37-0-3" id="h37-0-3" class="d">-NextVersion → 5
</a><a href="#h37-0-4" id="h37-0-4" class="d">-TxnActive(1) → []
</a><a href="#h37-0-5" id="h37-0-5" class="d">-TxnActive(2) → []
</a><a href="#h37-0-6" id="h37-0-6" class="d">-TxnActive(3) → []
</a><a href="#h37-0-7" id="h37-0-7" class="d">-TxnActiveSnapshot(2) → {1}
</a><a href="#h37-0-8" id="h37-0-8" class="d">-TxnActiveSnapshot(3) → {1,2}
</a><a href="#h37-0-9" id="h37-0-9" class="d">-TxnActiveSnapshot(4) → {1,2,3}
</a><a href="#h37-0-10" id="h37-0-10" class="d">-TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h37-0-11" id="h37-0-11" class="d">-TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h37-0-12" id="h37-0-12" class="d">-Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h37-0-13" id="h37-0-13" class="d">-Version(&quot;c&quot;, 3) → &quot;3&quot;
</a><a href="#h37-0-14" id="h37-0-14" class="d">-Version(&quot;d&quot;, 4) → &quot;4&quot;
</a><a href="#h37-0-15" id="h37-0-15" class="i">+mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h37-0-16" id="h37-0-16" class="i">+mvcc:TxnActive(1) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;&quot;]
</a><a href="#h37-0-17" id="h37-0-17" class="i">+mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h37-0-18" id="h37-0-18" class="i">+mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a><a href="#h37-0-19" id="h37-0-19" class="i">+mvcc:TxnActiveSnapshot(2) → {1} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01&quot;]
</a><a href="#h37-0-20" id="h37-0-20" class="i">+mvcc:TxnActiveSnapshot(3) → {1,2} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x02\x01\x02&quot;]
</a><a href="#h37-0-21" id="h37-0-21" class="i">+mvcc:TxnActiveSnapshot(4) → {1,2,3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x03\x01\x02\x03&quot;]
</a><a href="#h37-0-22" id="h37-0-22" class="i">+mvcc:TxnWrite(1, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h37-0-23" id="h37-0-23" class="i">+mvcc:TxnWrite(3, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h37-0-24" id="h37-0-24" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h37-0-25" id="h37-0-25" class="i">+mvcc:Version(&quot;c&quot;, 3) → &quot;3&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x013&quot;]
</a><a href="#h37-0-26" id="h37-0-26" class="i">+mvcc:Version(&quot;d&quot;, 4) → &quot;4&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x014&quot;]
</a><b>diff --git a/<a id="h38" href="../file/src/storage/testscripts/mvcc/get.html">src/storage/testscripts/mvcc/get</a> b/<a href="../file/src/storage/testscripts/mvcc/get.html">src/storage/testscripts/mvcc/get</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -8,14 +8,14 @@ ok
</a> t1: begin readonly
 t1: scan
 ---
<a href="#h38-0-3" id="h38-0-3" class="d">-t1: key → 1
</a><a href="#h38-0-4" id="h38-0-4" class="d">-t1: updated → 2
</a><a href="#h38-0-5" id="h38-0-5" class="i">+t1: &quot;key&quot; → &quot;1&quot;
</a><a href="#h38-0-6" id="h38-0-6" class="i">+t1: &quot;updated&quot; → &quot;2&quot;
</a> 
 # Get results should mirror scan.
 t1: get key updated deleted tombstone missing
 ---
<a href="#h38-0-11" id="h38-0-11" class="d">-t1: key → 1
</a><a href="#h38-0-12" id="h38-0-12" class="d">-t1: updated → 2
</a><a href="#h38-0-13" id="h38-0-13" class="d">-t1: deleted → None
</a><a href="#h38-0-14" id="h38-0-14" class="d">-t1: tombstone → None
</a><a href="#h38-0-15" id="h38-0-15" class="d">-t1: missing → None
</a><a href="#h38-0-16" id="h38-0-16" class="i">+t1: &quot;key&quot; → &quot;1&quot;
</a><a href="#h38-0-17" id="h38-0-17" class="i">+t1: &quot;updated&quot; → &quot;2&quot;
</a><a href="#h38-0-18" id="h38-0-18" class="i">+t1: &quot;deleted&quot; → None
</a><a href="#h38-0-19" id="h38-0-19" class="i">+t1: &quot;tombstone&quot; → None
</a><a href="#h38-0-20" id="h38-0-20" class="i">+t1: &quot;missing&quot; → None
</a><b>diff --git a/<a id="h39" href="../file/src/storage/testscripts/mvcc/get_isolation.html">src/storage/testscripts/mvcc/get_isolation</a> b/<a href="../file/src/storage/testscripts/mvcc/get_isolation.html">src/storage/testscripts/mvcc/get_isolation</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -37,10 +37,10 @@ ok
</a> # Get each key.
 t3: get a b c d e f g
 ---
<a href="#h39-0-3" id="h39-0-3" class="d">-t3: a → 1
</a><a href="#h39-0-4" id="h39-0-4" class="d">-t3: b → 1
</a><a href="#h39-0-5" id="h39-0-5" class="d">-t3: c → None
</a><a href="#h39-0-6" id="h39-0-6" class="d">-t3: d → 1
</a><a href="#h39-0-7" id="h39-0-7" class="d">-t3: e → 1
</a><a href="#h39-0-8" id="h39-0-8" class="d">-t3: f → None
</a><a href="#h39-0-9" id="h39-0-9" class="d">-t3: g → None
</a><a href="#h39-0-10" id="h39-0-10" class="i">+t3: &quot;a&quot; → &quot;1&quot;
</a><a href="#h39-0-11" id="h39-0-11" class="i">+t3: &quot;b&quot; → &quot;1&quot;
</a><a href="#h39-0-12" id="h39-0-12" class="i">+t3: &quot;c&quot; → None
</a><a href="#h39-0-13" id="h39-0-13" class="i">+t3: &quot;d&quot; → &quot;1&quot;
</a><a href="#h39-0-14" id="h39-0-14" class="i">+t3: &quot;e&quot; → &quot;1&quot;
</a><a href="#h39-0-15" id="h39-0-15" class="i">+t3: &quot;f&quot; → None
</a><a href="#h39-0-16" id="h39-0-16" class="i">+t3: &quot;g&quot; → None
</a><b>diff --git a/<a id="h40" href="../file/src/storage/testscripts/mvcc/resume.html">src/storage/testscripts/mvcc/resume</a> b/<a href="../file/src/storage/testscripts/mvcc/resume.html">src/storage/testscripts/mvcc/resume</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -37,29 +37,29 @@ t5: v3 rw active={2}
</a> # t5 can see its own changes, but not the others.
 t5: scan
 ---
<a href="#h40-0-3" id="h40-0-3" class="d">-t5: a → 1
</a><a href="#h40-0-4" id="h40-0-4" class="d">-t5: b → 3
</a><a href="#h40-0-5" id="h40-0-5" class="i">+t5: &quot;a&quot; → &quot;1&quot;
</a><a href="#h40-0-6" id="h40-0-6" class="i">+t5: &quot;b&quot; → &quot;3&quot;
</a> 
 # A new transaction should not see t3/5&#39;s uncommitted changes.
 t6: begin
 t6: scan
 ---
<a href="#h40-0-12" id="h40-0-12" class="d">-t6: a → 2
</a><a href="#h40-0-13" id="h40-0-13" class="d">-t6: b → 1
</a><a href="#h40-0-14" id="h40-0-14" class="d">-t6: c → 4
</a><a href="#h40-0-15" id="h40-0-15" class="i">+t6: &quot;a&quot; → &quot;2&quot;
</a><a href="#h40-0-16" id="h40-0-16" class="i">+t6: &quot;b&quot; → &quot;1&quot;
</a><a href="#h40-0-17" id="h40-0-17" class="i">+t6: &quot;c&quot; → &quot;4&quot;
</a> 
 # Once t5 commits, a separate transaction should see its changes.
 t5: commit [ops]
 ---
<a href="#h40-0-22" id="h40-0-22" class="d">-t5: engine delete TxnWrite(3, &quot;b&quot;)
</a><a href="#h40-0-23" id="h40-0-23" class="d">-t5: engine delete TxnActive(3)
</a><a href="#h40-0-24" id="h40-0-24" class="i">+t5: engine delete mvcc:TxnWrite(3, &quot;b&quot;) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03b\x00\x00&quot;]
</a><a href="#h40-0-25" id="h40-0-25" class="i">+t5: engine delete mvcc:TxnActive(3) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot;]
</a> 
 t7: begin
 t7: scan
 ---
<a href="#h40-0-30" id="h40-0-30" class="d">-t7: a → 2
</a><a href="#h40-0-31" id="h40-0-31" class="d">-t7: b → 3
</a><a href="#h40-0-32" id="h40-0-32" class="d">-t7: c → 4
</a><a href="#h40-0-33" id="h40-0-33" class="i">+t7: &quot;a&quot; → &quot;2&quot;
</a><a href="#h40-0-34" id="h40-0-34" class="i">+t7: &quot;b&quot; → &quot;3&quot;
</a><a href="#h40-0-35" id="h40-0-35" class="i">+t7: &quot;c&quot; → &quot;4&quot;
</a> 
 # Resuming a committed transaction should error.
 t8: !resume &#39;{&quot;version&quot;:3, &quot;read_only&quot;:false, &quot;active&quot;:[2]}&#39;
<a href="#h40-1" id="h40-1" class="h">@@ -75,8 +75,8 @@ t8: v3 ro active={2}
</a> 
 t8: scan
 ---
<a href="#h40-1-3" id="h40-1-3" class="d">-t8: a → 1
</a><a href="#h40-1-4" id="h40-1-4" class="d">-t8: b → 1
</a><a href="#h40-1-5" id="h40-1-5" class="i">+t8: &quot;a&quot; → &quot;1&quot;
</a><a href="#h40-1-6" id="h40-1-6" class="i">+t8: &quot;b&quot; → &quot;1&quot;
</a> 
 t9: resume &#39;{&quot;version&quot;:3, &quot;read_only&quot;:true, &quot;active&quot;:[2]}&#39;
 t9: state
<a href="#h40-2" id="h40-2" class="h">@@ -85,5 +85,5 @@ t9: v3 ro active={2}
</a> 
 t9: scan
 ---
<a href="#h40-2-3" id="h40-2-3" class="d">-t9: a → 1
</a><a href="#h40-2-4" id="h40-2-4" class="d">-t9: b → 1
</a><a href="#h40-2-5" id="h40-2-5" class="i">+t9: &quot;a&quot; → &quot;1&quot;
</a><a href="#h40-2-6" id="h40-2-6" class="i">+t9: &quot;b&quot; → &quot;1&quot;
</a><b>diff --git a/<a id="h41" href="../file/src/storage/testscripts/mvcc/rollback.html">src/storage/testscripts/mvcc/rollback</a> b/<a href="../file/src/storage/testscripts/mvcc/rollback.html">src/storage/testscripts/mvcc/rollback</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -21,24 +21,24 @@ ok
</a> 
 dump
 ---
<a href="#h41-0-3" id="h41-0-3" class="d">-NextVersion → 5
</a><a href="#h41-0-4" id="h41-0-4" class="d">-TxnActive(2) → []
</a><a href="#h41-0-5" id="h41-0-5" class="d">-TxnActive(3) → []
</a><a href="#h41-0-6" id="h41-0-6" class="d">-TxnActive(4) → []
</a><a href="#h41-0-7" id="h41-0-7" class="d">-TxnActiveSnapshot(3) → {2}
</a><a href="#h41-0-8" id="h41-0-8" class="d">-TxnActiveSnapshot(4) → {2,3}
</a><a href="#h41-0-9" id="h41-0-9" class="d">-TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h41-0-10" id="h41-0-10" class="d">-TxnWrite(3, &quot;b&quot;) → []
</a><a href="#h41-0-11" id="h41-0-11" class="d">-TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h41-0-12" id="h41-0-12" class="d">-TxnWrite(4, &quot;d&quot;) → []
</a><a href="#h41-0-13" id="h41-0-13" class="d">-Version(&quot;a&quot;, 1) → &quot;0&quot;
</a><a href="#h41-0-14" id="h41-0-14" class="d">-Version(&quot;a&quot;, 2) → &quot;1&quot;
</a><a href="#h41-0-15" id="h41-0-15" class="d">-Version(&quot;b&quot;, 1) → &quot;0&quot;
</a><a href="#h41-0-16" id="h41-0-16" class="d">-Version(&quot;b&quot;, 3) → &quot;2&quot;
</a><a href="#h41-0-17" id="h41-0-17" class="d">-Version(&quot;c&quot;, 1) → &quot;0&quot;
</a><a href="#h41-0-18" id="h41-0-18" class="d">-Version(&quot;c&quot;, 3) → None
</a><a href="#h41-0-19" id="h41-0-19" class="d">-Version(&quot;d&quot;, 1) → &quot;0&quot;
</a><a href="#h41-0-20" id="h41-0-20" class="d">-Version(&quot;d&quot;, 4) → &quot;3&quot;
</a><a href="#h41-0-21" id="h41-0-21" class="i">+mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h41-0-22" id="h41-0-22" class="i">+mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h41-0-23" id="h41-0-23" class="i">+mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a><a href="#h41-0-24" id="h41-0-24" class="i">+mvcc:TxnActive(4) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;&quot;]
</a><a href="#h41-0-25" id="h41-0-25" class="i">+mvcc:TxnActiveSnapshot(3) → {2} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x02&quot;]
</a><a href="#h41-0-26" id="h41-0-26" class="i">+mvcc:TxnActiveSnapshot(4) → {2,3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x02\x02\x03&quot;]
</a><a href="#h41-0-27" id="h41-0-27" class="i">+mvcc:TxnWrite(2, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h41-0-28" id="h41-0-28" class="i">+mvcc:TxnWrite(3, &quot;b&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03b\x00\x00&quot; → &quot;&quot;]
</a><a href="#h41-0-29" id="h41-0-29" class="i">+mvcc:TxnWrite(3, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h41-0-30" id="h41-0-30" class="i">+mvcc:TxnWrite(4, &quot;d&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x04d\x00\x00&quot; → &quot;&quot;]
</a><a href="#h41-0-31" id="h41-0-31" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;0&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-0-32" id="h41-0-32" class="i">+mvcc:Version(&quot;a&quot;, 2) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x011&quot;]
</a><a href="#h41-0-33" id="h41-0-33" class="i">+mvcc:Version(&quot;b&quot;, 1) → &quot;0&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-0-34" id="h41-0-34" class="i">+mvcc:Version(&quot;b&quot;, 3) → &quot;2&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x012&quot;]
</a><a href="#h41-0-35" id="h41-0-35" class="i">+mvcc:Version(&quot;c&quot;, 1) → &quot;0&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-0-36" id="h41-0-36" class="i">+mvcc:Version(&quot;c&quot;, 3) → None [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x00&quot;]
</a><a href="#h41-0-37" id="h41-0-37" class="i">+mvcc:Version(&quot;d&quot;, 1) → &quot;0&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-0-38" id="h41-0-38" class="i">+mvcc:Version(&quot;d&quot;, 4) → &quot;3&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x013&quot;]
</a> 
 # Both t1 and t3 will conflict with t2.
 t1: !set b=1
<a href="#h41-1" id="h41-1" class="h">@@ -51,19 +51,19 @@ t3: Error: serialization failure, retry transaction
</a> # perform their writes and successfully commit.
 t2: rollback [ops]
 ---
<a href="#h41-1-3" id="h41-1-3" class="d">-t2: engine delete Version(&quot;b&quot;, 3)
</a><a href="#h41-1-4" id="h41-1-4" class="d">-t2: engine delete TxnWrite(3, &quot;b&quot;)
</a><a href="#h41-1-5" id="h41-1-5" class="d">-t2: engine delete Version(&quot;c&quot;, 3)
</a><a href="#h41-1-6" id="h41-1-6" class="d">-t2: engine delete TxnWrite(3, &quot;c&quot;)
</a><a href="#h41-1-7" id="h41-1-7" class="d">-t2: engine delete TxnActive(3)
</a><a href="#h41-1-8" id="h41-1-8" class="i">+t2: engine delete mvcc:Version(&quot;b&quot;, 3) [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot;]
</a><a href="#h41-1-9" id="h41-1-9" class="i">+t2: engine delete mvcc:TxnWrite(3, &quot;b&quot;) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03b\x00\x00&quot;]
</a><a href="#h41-1-10" id="h41-1-10" class="i">+t2: engine delete mvcc:Version(&quot;c&quot;, 3) [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot;]
</a><a href="#h41-1-11" id="h41-1-11" class="i">+t2: engine delete mvcc:TxnWrite(3, &quot;c&quot;) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03c\x00\x00&quot;]
</a><a href="#h41-1-12" id="h41-1-12" class="i">+t2: engine delete mvcc:TxnActive(3) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot;]
</a> 
 t4: begin readonly
 t4: scan
 ---
<a href="#h41-1-17" id="h41-1-17" class="d">-t4: a → 0
</a><a href="#h41-1-18" id="h41-1-18" class="d">-t4: b → 0
</a><a href="#h41-1-19" id="h41-1-19" class="d">-t4: c → 0
</a><a href="#h41-1-20" id="h41-1-20" class="d">-t4: d → 0
</a><a href="#h41-1-21" id="h41-1-21" class="i">+t4: &quot;a&quot; → &quot;0&quot;
</a><a href="#h41-1-22" id="h41-1-22" class="i">+t4: &quot;b&quot; → &quot;0&quot;
</a><a href="#h41-1-23" id="h41-1-23" class="i">+t4: &quot;c&quot; → &quot;0&quot;
</a><a href="#h41-1-24" id="h41-1-24" class="i">+t4: &quot;d&quot; → &quot;0&quot;
</a> 
 t1: set b=1
 t1: commit
<a href="#h41-2" id="h41-2" class="h">@@ -75,21 +75,21 @@ ok
</a> t5: begin readonly
 t5: scan
 ---
<a href="#h41-2-3" id="h41-2-3" class="d">-t5: a → 1
</a><a href="#h41-2-4" id="h41-2-4" class="d">-t5: b → 1
</a><a href="#h41-2-5" id="h41-2-5" class="d">-t5: c → 3
</a><a href="#h41-2-6" id="h41-2-6" class="d">-t5: d → 3
</a><a href="#h41-2-7" id="h41-2-7" class="i">+t5: &quot;a&quot; → &quot;1&quot;
</a><a href="#h41-2-8" id="h41-2-8" class="i">+t5: &quot;b&quot; → &quot;1&quot;
</a><a href="#h41-2-9" id="h41-2-9" class="i">+t5: &quot;c&quot; → &quot;3&quot;
</a><a href="#h41-2-10" id="h41-2-10" class="i">+t5: &quot;d&quot; → &quot;3&quot;
</a> 
 dump
 ---
<a href="#h41-2-14" id="h41-2-14" class="d">-NextVersion → 5
</a><a href="#h41-2-15" id="h41-2-15" class="d">-TxnActiveSnapshot(3) → {2}
</a><a href="#h41-2-16" id="h41-2-16" class="d">-TxnActiveSnapshot(4) → {2,3}
</a><a href="#h41-2-17" id="h41-2-17" class="d">-Version(&quot;a&quot;, 1) → &quot;0&quot;
</a><a href="#h41-2-18" id="h41-2-18" class="d">-Version(&quot;a&quot;, 2) → &quot;1&quot;
</a><a href="#h41-2-19" id="h41-2-19" class="d">-Version(&quot;b&quot;, 1) → &quot;0&quot;
</a><a href="#h41-2-20" id="h41-2-20" class="d">-Version(&quot;b&quot;, 2) → &quot;1&quot;
</a><a href="#h41-2-21" id="h41-2-21" class="d">-Version(&quot;c&quot;, 1) → &quot;0&quot;
</a><a href="#h41-2-22" id="h41-2-22" class="d">-Version(&quot;c&quot;, 4) → &quot;3&quot;
</a><a href="#h41-2-23" id="h41-2-23" class="d">-Version(&quot;d&quot;, 1) → &quot;0&quot;
</a><a href="#h41-2-24" id="h41-2-24" class="d">-Version(&quot;d&quot;, 4) → &quot;3&quot;
</a><a href="#h41-2-25" id="h41-2-25" class="i">+mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h41-2-26" id="h41-2-26" class="i">+mvcc:TxnActiveSnapshot(3) → {2} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x02&quot;]
</a><a href="#h41-2-27" id="h41-2-27" class="i">+mvcc:TxnActiveSnapshot(4) → {2,3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x02\x02\x03&quot;]
</a><a href="#h41-2-28" id="h41-2-28" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;0&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-2-29" id="h41-2-29" class="i">+mvcc:Version(&quot;a&quot;, 2) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x011&quot;]
</a><a href="#h41-2-30" id="h41-2-30" class="i">+mvcc:Version(&quot;b&quot;, 1) → &quot;0&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-2-31" id="h41-2-31" class="i">+mvcc:Version(&quot;b&quot;, 2) → &quot;1&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x011&quot;]
</a><a href="#h41-2-32" id="h41-2-32" class="i">+mvcc:Version(&quot;c&quot;, 1) → &quot;0&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-2-33" id="h41-2-33" class="i">+mvcc:Version(&quot;c&quot;, 4) → &quot;3&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x013&quot;]
</a><a href="#h41-2-34" id="h41-2-34" class="i">+mvcc:Version(&quot;d&quot;, 1) → &quot;0&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x010&quot;]
</a><a href="#h41-2-35" id="h41-2-35" class="i">+mvcc:Version(&quot;d&quot;, 4) → &quot;3&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x013&quot;]
</a><b>diff --git a/<a id="h42" href="../file/src/storage/testscripts/mvcc/scan.html">src/storage/testscripts/mvcc/scan</a> b/<a href="../file/src/storage/testscripts/mvcc/scan.html">src/storage/testscripts/mvcc/scan</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -23,64 +23,64 @@ ok
</a> t2: begin readonly as_of=2
 t2: scan
 ---
<a href="#h42-0-3" id="h42-0-3" class="d">-t2: B → B1
</a><a href="#h42-0-4" id="h42-0-4" class="d">-t2: a → a1
</a><a href="#h42-0-5" id="h42-0-5" class="d">-t2: c → c1
</a><a href="#h42-0-6" id="h42-0-6" class="i">+t2: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h42-0-7" id="h42-0-7" class="i">+t2: &quot;a&quot; → &quot;a1&quot;
</a><a href="#h42-0-8" id="h42-0-8" class="i">+t2: &quot;c&quot; → &quot;c1&quot;
</a> 
 t3: begin readonly as_of=3
 t3: scan
 ---
<a href="#h42-0-13" id="h42-0-13" class="d">-t3: B → B1
</a><a href="#h42-0-14" id="h42-0-14" class="d">-t3: ba → ba2
</a><a href="#h42-0-15" id="h42-0-15" class="d">-t3: bb → bb2
</a><a href="#h42-0-16" id="h42-0-16" class="d">-t3: bc → bc2
</a><a href="#h42-0-17" id="h42-0-17" class="d">-t3: c → c1
</a><a href="#h42-0-18" id="h42-0-18" class="i">+t3: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h42-0-19" id="h42-0-19" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-20" id="h42-0-20" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h42-0-21" id="h42-0-21" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h42-0-22" id="h42-0-22" class="i">+t3: &quot;c&quot; → &quot;c1&quot;
</a> 
 t4: begin readonly as_of=4
 t4: scan
 ---
<a href="#h42-0-27" id="h42-0-27" class="d">-t4: a → a3
</a><a href="#h42-0-28" id="h42-0-28" class="d">-t4: b → b3
</a><a href="#h42-0-29" id="h42-0-29" class="d">-t4: ba → ba2
</a><a href="#h42-0-30" id="h42-0-30" class="d">-t4: bc → bc2
</a><a href="#h42-0-31" id="h42-0-31" class="d">-t4: c → c1
</a><a href="#h42-0-32" id="h42-0-32" class="i">+t4: &quot;a&quot; → &quot;a3&quot;
</a><a href="#h42-0-33" id="h42-0-33" class="i">+t4: &quot;b&quot; → &quot;b3&quot;
</a><a href="#h42-0-34" id="h42-0-34" class="i">+t4: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-35" id="h42-0-35" class="i">+t4: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h42-0-36" id="h42-0-36" class="i">+t4: &quot;c&quot; → &quot;c1&quot;
</a> 
 t5: begin readonly
 t5: scan
 ---
<a href="#h42-0-41" id="h42-0-41" class="d">-t5: a → a3
</a><a href="#h42-0-42" id="h42-0-42" class="d">-t5: ba → ba4
</a><a href="#h42-0-43" id="h42-0-43" class="d">-t5: bc → bc2
</a><a href="#h42-0-44" id="h42-0-44" class="d">-t5: c → c1
</a><a href="#h42-0-45" id="h42-0-45" class="i">+t5: &quot;a&quot; → &quot;a3&quot;
</a><a href="#h42-0-46" id="h42-0-46" class="i">+t5: &quot;ba&quot; → &quot;ba4&quot;
</a><a href="#h42-0-47" id="h42-0-47" class="i">+t5: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h42-0-48" id="h42-0-48" class="i">+t5: &quot;c&quot; → &quot;c1&quot;
</a> 
 # Various bounded scans around ba-bc at version 3.
 t3: scan ba..bc
 ---
<a href="#h42-0-53" id="h42-0-53" class="d">-t3: ba → ba2
</a><a href="#h42-0-54" id="h42-0-54" class="d">-t3: bb → bb2
</a><a href="#h42-0-55" id="h42-0-55" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-56" id="h42-0-56" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a> 
 t3: scan &quot;ba..=bc&quot;
 ---
<a href="#h42-0-60" id="h42-0-60" class="d">-t3: ba → ba2
</a><a href="#h42-0-61" id="h42-0-61" class="d">-t3: bb → bb2
</a><a href="#h42-0-62" id="h42-0-62" class="d">-t3: bc → bc2
</a><a href="#h42-0-63" id="h42-0-63" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-64" id="h42-0-64" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h42-0-65" id="h42-0-65" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a> 
 t3: scan ba..
 ---
<a href="#h42-0-69" id="h42-0-69" class="d">-t3: ba → ba2
</a><a href="#h42-0-70" id="h42-0-70" class="d">-t3: bb → bb2
</a><a href="#h42-0-71" id="h42-0-71" class="d">-t3: bc → bc2
</a><a href="#h42-0-72" id="h42-0-72" class="d">-t3: c → c1
</a><a href="#h42-0-73" id="h42-0-73" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-74" id="h42-0-74" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h42-0-75" id="h42-0-75" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h42-0-76" id="h42-0-76" class="i">+t3: &quot;c&quot; → &quot;c1&quot;
</a> 
 t3: scan &quot;..bc&quot;
 ---
<a href="#h42-0-80" id="h42-0-80" class="d">-t3: B → B1
</a><a href="#h42-0-81" id="h42-0-81" class="d">-t3: ba → ba2
</a><a href="#h42-0-82" id="h42-0-82" class="d">-t3: bb → bb2
</a><a href="#h42-0-83" id="h42-0-83" class="i">+t3: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h42-0-84" id="h42-0-84" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-85" id="h42-0-85" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a> 
 t3: scan &quot;..=bc&quot;
 ---
<a href="#h42-0-89" id="h42-0-89" class="d">-t3: B → B1
</a><a href="#h42-0-90" id="h42-0-90" class="d">-t3: ba → ba2
</a><a href="#h42-0-91" id="h42-0-91" class="d">-t3: bb → bb2
</a><a href="#h42-0-92" id="h42-0-92" class="d">-t3: bc → bc2
</a><a href="#h42-0-93" id="h42-0-93" class="i">+t3: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h42-0-94" id="h42-0-94" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h42-0-95" id="h42-0-95" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h42-0-96" id="h42-0-96" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a><b>diff --git a/<a id="h43" href="../file/src/storage/testscripts/mvcc/scan_isolation.html">src/storage/testscripts/mvcc/scan_isolation</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_isolation.html">src/storage/testscripts/mvcc/scan_isolation</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -37,7 +37,7 @@ ok
</a> # Scan keys.
 t3: scan
 ---
<a href="#h43-0-3" id="h43-0-3" class="d">-t3: a → 1
</a><a href="#h43-0-4" id="h43-0-4" class="d">-t3: b → 1
</a><a href="#h43-0-5" id="h43-0-5" class="d">-t3: d → 1
</a><a href="#h43-0-6" id="h43-0-6" class="d">-t3: e → 1
</a><a href="#h43-0-7" id="h43-0-7" class="i">+t3: &quot;a&quot; → &quot;1&quot;
</a><a href="#h43-0-8" id="h43-0-8" class="i">+t3: &quot;b&quot; → &quot;1&quot;
</a><a href="#h43-0-9" id="h43-0-9" class="i">+t3: &quot;d&quot; → &quot;1&quot;
</a><a href="#h43-0-10" id="h43-0-10" class="i">+t3: &quot;e&quot; → &quot;1&quot;
</a><b>diff --git a/<a id="h44" href="../file/src/storage/testscripts/mvcc/scan_key_version_encoding.html">src/storage/testscripts/mvcc/scan_key_version_encoding</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_key_version_encoding.html">src/storage/testscripts/mvcc/scan_key_version_encoding</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -10,28 +10,28 @@ t1: begin
</a> t1: set &quot;\x00&quot;=&quot;\x01&quot; [ops]
 t1: commit
 ---
<a href="#h44-0-3" id="h44-0-3" class="d">-t1: engine set TxnWrite(1, 0x00) → []
</a><a href="#h44-0-4" id="h44-0-4" class="d">-t1: engine set Version(0x00, 1) → 0x01
</a><a href="#h44-0-5" id="h44-0-5" class="i">+t1: engine set mvcc:TxnWrite(1, &quot;\x00&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01\x00\xff\x00\x00&quot; → &quot;&quot;]
</a><a href="#h44-0-6" id="h44-0-6" class="i">+t1: engine set mvcc:Version(&quot;\x00&quot;, 1) → &quot;\x01&quot; [&quot;\x04\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x01\x01&quot;]
</a> 
 t2: begin
 t2: set &quot;\x00&quot;=&quot;\x02&quot; [ops]
 t2: set &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;=&quot;\x02&quot; [ops]
 t2: commit
 ---
<a href="#h44-0-13" id="h44-0-13" class="d">-t2: engine set TxnWrite(2, 0x00) → []
</a><a href="#h44-0-14" id="h44-0-14" class="d">-t2: engine set Version(0x00, 2) → 0x02
</a><a href="#h44-0-15" id="h44-0-15" class="d">-t2: engine set TxnWrite(2, 0x000000000000000002) → []
</a><a href="#h44-0-16" id="h44-0-16" class="d">-t2: engine set Version(0x000000000000000002, 2) → 0x02
</a><a href="#h44-0-17" id="h44-0-17" class="i">+t2: engine set mvcc:TxnWrite(2, &quot;\x00&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\xff\x00\x00&quot; → &quot;&quot;]
</a><a href="#h44-0-18" id="h44-0-18" class="i">+t2: engine set mvcc:Version(&quot;\x00&quot;, 2) → &quot;\x02&quot; [&quot;\x04\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01\x02&quot;]
</a><a href="#h44-0-19" id="h44-0-19" class="i">+t2: engine set mvcc:TxnWrite(2, &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00&quot; → &quot;&quot;]
</a><a href="#h44-0-20" id="h44-0-20" class="i">+t2: engine set mvcc:Version(&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;, 2) → &quot;\x02&quot; [&quot;\x04\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01\x02&quot;]
</a> 
 t3: begin
 t3: set &quot;\x00&quot;=&quot;\x03&quot; [ops]
 t3: commit
 ---
<a href="#h44-0-26" id="h44-0-26" class="d">-t3: engine set TxnWrite(3, 0x00) → []
</a><a href="#h44-0-27" id="h44-0-27" class="d">-t3: engine set Version(0x00, 3) → 0x03
</a><a href="#h44-0-28" id="h44-0-28" class="i">+t3: engine set mvcc:TxnWrite(3, &quot;\x00&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03\x00\xff\x00\x00&quot; → &quot;&quot;]
</a><a href="#h44-0-29" id="h44-0-29" class="i">+t3: engine set mvcc:Version(&quot;\x00&quot;, 3) → &quot;\x03&quot; [&quot;\x04\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x01\x03&quot;]
</a> 
 t4: begin readonly
 t4: scan
 ---
<a href="#h44-0-34" id="h44-0-34" class="d">-t4: \x00 → \x03
</a><a href="#h44-0-35" id="h44-0-35" class="d">-t4: \x00\x00\x00\x00\x00\x00\x00\x00\x02 → \x02
</a><a href="#h44-0-36" id="h44-0-36" class="i">+t4: &quot;\x00&quot; → &quot;\x03&quot;
</a><a href="#h44-0-37" id="h44-0-37" class="i">+t4: &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x02&quot;
</a><b>diff --git a/<a id="h45" href="../file/src/storage/testscripts/mvcc/scan_prefix.html">src/storage/testscripts/mvcc/scan_prefix</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_prefix.html">src/storage/testscripts/mvcc/scan_prefix</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -23,50 +23,50 @@ ok
</a> t2: begin readonly as_of=2
 t2: scan_prefix &quot;&quot;
 ---
<a href="#h45-0-3" id="h45-0-3" class="d">-t2: B → B1
</a><a href="#h45-0-4" id="h45-0-4" class="d">-t2: a → a1
</a><a href="#h45-0-5" id="h45-0-5" class="d">-t2: c → c1
</a><a href="#h45-0-6" id="h45-0-6" class="i">+t2: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h45-0-7" id="h45-0-7" class="i">+t2: &quot;a&quot; → &quot;a1&quot;
</a><a href="#h45-0-8" id="h45-0-8" class="i">+t2: &quot;c&quot; → &quot;c1&quot;
</a> 
 t3: begin readonly as_of=3
 t3: scan_prefix &quot;&quot;
 ---
<a href="#h45-0-13" id="h45-0-13" class="d">-t3: B → B1
</a><a href="#h45-0-14" id="h45-0-14" class="d">-t3: ba → ba2
</a><a href="#h45-0-15" id="h45-0-15" class="d">-t3: bb → bb2
</a><a href="#h45-0-16" id="h45-0-16" class="d">-t3: bc → bc2
</a><a href="#h45-0-17" id="h45-0-17" class="d">-t3: c → c1
</a><a href="#h45-0-18" id="h45-0-18" class="i">+t3: &quot;B&quot; → &quot;B1&quot;
</a><a href="#h45-0-19" id="h45-0-19" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h45-0-20" id="h45-0-20" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h45-0-21" id="h45-0-21" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h45-0-22" id="h45-0-22" class="i">+t3: &quot;c&quot; → &quot;c1&quot;
</a> 
 t4: begin readonly as_of=4
 t4: scan_prefix &quot;&quot;
 ---
<a href="#h45-0-27" id="h45-0-27" class="d">-t4: a → a3
</a><a href="#h45-0-28" id="h45-0-28" class="d">-t4: b → b3
</a><a href="#h45-0-29" id="h45-0-29" class="d">-t4: ba → ba2
</a><a href="#h45-0-30" id="h45-0-30" class="d">-t4: bc → bc2
</a><a href="#h45-0-31" id="h45-0-31" class="d">-t4: c → c1
</a><a href="#h45-0-32" id="h45-0-32" class="i">+t4: &quot;a&quot; → &quot;a3&quot;
</a><a href="#h45-0-33" id="h45-0-33" class="i">+t4: &quot;b&quot; → &quot;b3&quot;
</a><a href="#h45-0-34" id="h45-0-34" class="i">+t4: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h45-0-35" id="h45-0-35" class="i">+t4: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h45-0-36" id="h45-0-36" class="i">+t4: &quot;c&quot; → &quot;c1&quot;
</a> 
 t5: begin readonly
 t5: scan_prefix &quot;&quot;
 ---
<a href="#h45-0-41" id="h45-0-41" class="d">-t5: a → a3
</a><a href="#h45-0-42" id="h45-0-42" class="d">-t5: ba → ba4
</a><a href="#h45-0-43" id="h45-0-43" class="d">-t5: bc → bc2
</a><a href="#h45-0-44" id="h45-0-44" class="d">-t5: c → c1
</a><a href="#h45-0-45" id="h45-0-45" class="i">+t5: &quot;a&quot; → &quot;a3&quot;
</a><a href="#h45-0-46" id="h45-0-46" class="i">+t5: &quot;ba&quot; → &quot;ba4&quot;
</a><a href="#h45-0-47" id="h45-0-47" class="i">+t5: &quot;bc&quot; → &quot;bc2&quot;
</a><a href="#h45-0-48" id="h45-0-48" class="i">+t5: &quot;c&quot; → &quot;c1&quot;
</a> 
 # Various prefixes at version 3.
 t3: scan_prefix B
 ---
<a href="#h45-0-53" id="h45-0-53" class="d">-t3: B → B1
</a><a href="#h45-0-54" id="h45-0-54" class="i">+t3: &quot;B&quot; → &quot;B1&quot;
</a> 
 t3: scan_prefix b
 ---
<a href="#h45-0-58" id="h45-0-58" class="d">-t3: ba → ba2
</a><a href="#h45-0-59" id="h45-0-59" class="d">-t3: bb → bb2
</a><a href="#h45-0-60" id="h45-0-60" class="d">-t3: bc → bc2
</a><a href="#h45-0-61" id="h45-0-61" class="i">+t3: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h45-0-62" id="h45-0-62" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a><a href="#h45-0-63" id="h45-0-63" class="i">+t3: &quot;bc&quot; → &quot;bc2&quot;
</a> 
 t3: scan_prefix bb
 ---
<a href="#h45-0-67" id="h45-0-67" class="d">-t3: bb → bb2
</a><a href="#h45-0-68" id="h45-0-68" class="i">+t3: &quot;bb&quot; → &quot;bb2&quot;
</a> 
 t3: scan_prefix bbb
 ---
<a href="#h45-1" id="h45-1" class="h">@@ -79,9 +79,9 @@ ok
</a> 
 t4: scan_prefix b
 ---
<a href="#h45-1-3" id="h45-1-3" class="d">-t4: b → b3
</a><a href="#h45-1-4" id="h45-1-4" class="d">-t4: ba → ba2
</a><a href="#h45-1-5" id="h45-1-5" class="d">-t4: bc → bc2
</a><a href="#h45-1-6" id="h45-1-6" class="i">+t4: &quot;b&quot; → &quot;b3&quot;
</a><a href="#h45-1-7" id="h45-1-7" class="i">+t4: &quot;ba&quot; → &quot;ba2&quot;
</a><a href="#h45-1-8" id="h45-1-8" class="i">+t4: &quot;bc&quot; → &quot;bc2&quot;
</a> 
 t4: scan_prefix bb
 ---
<b>diff --git a/<a id="h46" href="../file/src/storage/testscripts/mvcc/set.html">src/storage/testscripts/mvcc/set</a> b/<a href="../file/src/storage/testscripts/mvcc/set.html">src/storage/testscripts/mvcc/set</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -8,44 +8,44 @@ ok
</a> t1: begin
 t1: set a=2 x=2 [ops]
 ---
<a href="#h46-0-3" id="h46-0-3" class="d">-t1: engine set TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h46-0-4" id="h46-0-4" class="d">-t1: engine set Version(&quot;a&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-5" id="h46-0-5" class="d">-t1: engine set TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h46-0-6" id="h46-0-6" class="d">-t1: engine set Version(&quot;x&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-7" id="h46-0-7" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-8" id="h46-0-8" class="i">+t1: engine set mvcc:Version(&quot;a&quot;, 2) → &quot;2&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h46-0-9" id="h46-0-9" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;x&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02x\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-10" id="h46-0-10" class="i">+t1: engine set mvcc:Version(&quot;x&quot;, 2) → &quot;2&quot; [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a> 
 t1: scan
 ---
<a href="#h46-0-14" id="h46-0-14" class="d">-t1: a → 2
</a><a href="#h46-0-15" id="h46-0-15" class="d">-t1: b → 1
</a><a href="#h46-0-16" id="h46-0-16" class="d">-t1: x → 2
</a><a href="#h46-0-17" id="h46-0-17" class="i">+t1: &quot;a&quot; → &quot;2&quot;
</a><a href="#h46-0-18" id="h46-0-18" class="i">+t1: &quot;b&quot; → &quot;1&quot;
</a><a href="#h46-0-19" id="h46-0-19" class="i">+t1: &quot;x&quot; → &quot;2&quot;
</a> 
 # Can write a new key, replace it, and be idempotent.
 t1: set c=1 c=2 c=2 [ops]
 ---
<a href="#h46-0-24" id="h46-0-24" class="d">-t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h46-0-25" id="h46-0-25" class="d">-t1: engine set Version(&quot;c&quot;, 2) → &quot;1&quot;
</a><a href="#h46-0-26" id="h46-0-26" class="d">-t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h46-0-27" id="h46-0-27" class="d">-t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-28" id="h46-0-28" class="d">-t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h46-0-29" id="h46-0-29" class="d">-t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-30" id="h46-0-30" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-31" id="h46-0-31" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 2) → &quot;1&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x011&quot;]
</a><a href="#h46-0-32" id="h46-0-32" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-33" id="h46-0-33" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 2) → &quot;2&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h46-0-34" id="h46-0-34" class="i">+t1: engine set mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-35" id="h46-0-35" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 2) → &quot;2&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a> 
 t1: scan
 ---
<a href="#h46-0-39" id="h46-0-39" class="d">-t1: a → 2
</a><a href="#h46-0-40" id="h46-0-40" class="d">-t1: b → 1
</a><a href="#h46-0-41" id="h46-0-41" class="d">-t1: c → 2
</a><a href="#h46-0-42" id="h46-0-42" class="d">-t1: x → 2
</a><a href="#h46-0-43" id="h46-0-43" class="i">+t1: &quot;a&quot; → &quot;2&quot;
</a><a href="#h46-0-44" id="h46-0-44" class="i">+t1: &quot;b&quot; → &quot;1&quot;
</a><a href="#h46-0-45" id="h46-0-45" class="i">+t1: &quot;c&quot; → &quot;2&quot;
</a><a href="#h46-0-46" id="h46-0-46" class="i">+t1: &quot;x&quot; → &quot;2&quot;
</a> 
 dump
 ---
<a href="#h46-0-50" id="h46-0-50" class="d">-NextVersion → 3
</a><a href="#h46-0-51" id="h46-0-51" class="d">-TxnActive(2) → []
</a><a href="#h46-0-52" id="h46-0-52" class="d">-TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h46-0-53" id="h46-0-53" class="d">-TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h46-0-54" id="h46-0-54" class="d">-TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h46-0-55" id="h46-0-55" class="d">-Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h46-0-56" id="h46-0-56" class="d">-Version(&quot;a&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-57" id="h46-0-57" class="d">-Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h46-0-58" id="h46-0-58" class="d">-Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-59" id="h46-0-59" class="d">-Version(&quot;x&quot;, 1) → None
</a><a href="#h46-0-60" id="h46-0-60" class="d">-Version(&quot;x&quot;, 2) → &quot;2&quot;
</a><a href="#h46-0-61" id="h46-0-61" class="i">+mvcc:NextVersion → 3 [&quot;\x00&quot; → &quot;\x03&quot;]
</a><a href="#h46-0-62" id="h46-0-62" class="i">+mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h46-0-63" id="h46-0-63" class="i">+mvcc:TxnWrite(2, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-64" id="h46-0-64" class="i">+mvcc:TxnWrite(2, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-65" id="h46-0-65" class="i">+mvcc:TxnWrite(2, &quot;x&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02x\x00\x00&quot; → &quot;&quot;]
</a><a href="#h46-0-66" id="h46-0-66" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h46-0-67" id="h46-0-67" class="i">+mvcc:Version(&quot;a&quot;, 2) → &quot;2&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h46-0-68" id="h46-0-68" class="i">+mvcc:Version(&quot;b&quot;, 1) → &quot;1&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h46-0-69" id="h46-0-69" class="i">+mvcc:Version(&quot;c&quot;, 2) → &quot;2&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><a href="#h46-0-70" id="h46-0-70" class="i">+mvcc:Version(&quot;x&quot;, 1) → None [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x00&quot;]
</a><a href="#h46-0-71" id="h46-0-71" class="i">+mvcc:Version(&quot;x&quot;, 2) → &quot;2&quot; [&quot;\x04x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x012&quot;]
</a><b>diff --git a/<a id="h47" href="../file/src/storage/testscripts/mvcc/set_conflict.html">src/storage/testscripts/mvcc/set_conflict</a> b/<a href="../file/src/storage/testscripts/mvcc/set_conflict.html">src/storage/testscripts/mvcc/set_conflict</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -25,15 +25,15 @@ t2: Error: serialization failure, retry transaction
</a> 
 dump
 ---
<a href="#h47-0-3" id="h47-0-3" class="d">-NextVersion → 5
</a><a href="#h47-0-4" id="h47-0-4" class="d">-TxnActive(1) → []
</a><a href="#h47-0-5" id="h47-0-5" class="d">-TxnActive(2) → []
</a><a href="#h47-0-6" id="h47-0-6" class="d">-TxnActive(3) → []
</a><a href="#h47-0-7" id="h47-0-7" class="d">-TxnActiveSnapshot(2) → {1}
</a><a href="#h47-0-8" id="h47-0-8" class="d">-TxnActiveSnapshot(3) → {1,2}
</a><a href="#h47-0-9" id="h47-0-9" class="d">-TxnActiveSnapshot(4) → {1,2,3}
</a><a href="#h47-0-10" id="h47-0-10" class="d">-TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h47-0-11" id="h47-0-11" class="d">-TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h47-0-12" id="h47-0-12" class="d">-Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h47-0-13" id="h47-0-13" class="d">-Version(&quot;c&quot;, 3) → &quot;3&quot;
</a><a href="#h47-0-14" id="h47-0-14" class="d">-Version(&quot;d&quot;, 4) → &quot;4&quot;
</a><a href="#h47-0-15" id="h47-0-15" class="i">+mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h47-0-16" id="h47-0-16" class="i">+mvcc:TxnActive(1) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;&quot;]
</a><a href="#h47-0-17" id="h47-0-17" class="i">+mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h47-0-18" id="h47-0-18" class="i">+mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a><a href="#h47-0-19" id="h47-0-19" class="i">+mvcc:TxnActiveSnapshot(2) → {1} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x01&quot;]
</a><a href="#h47-0-20" id="h47-0-20" class="i">+mvcc:TxnActiveSnapshot(3) → {1,2} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x02\x01\x02&quot;]
</a><a href="#h47-0-21" id="h47-0-21" class="i">+mvcc:TxnActiveSnapshot(4) → {1,2,3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x03\x01\x02\x03&quot;]
</a><a href="#h47-0-22" id="h47-0-22" class="i">+mvcc:TxnWrite(1, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h47-0-23" id="h47-0-23" class="i">+mvcc:TxnWrite(3, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x03c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h47-0-24" id="h47-0-24" class="i">+mvcc:Version(&quot;a&quot;, 1) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h47-0-25" id="h47-0-25" class="i">+mvcc:Version(&quot;c&quot;, 3) → &quot;3&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;\x01\x013&quot;]
</a><a href="#h47-0-26" id="h47-0-26" class="i">+mvcc:Version(&quot;d&quot;, 4) → &quot;4&quot; [&quot;\x04d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x014&quot;]
</a><b>diff --git a/<a id="h48" href="../file/src/storage/testscripts/mvcc/unversioned.html">src/storage/testscripts/mvcc/unversioned</a> b/<a href="../file/src/storage/testscripts/mvcc/unversioned.html">src/storage/testscripts/mvcc/unversioned</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -3,14 +3,14 @@
</a> # Getting a missing unversioned key returns None.
 get_unversioned a
 ---
<a href="#h48-0-3" id="h48-0-3" class="d">-a → None
</a><a href="#h48-0-4" id="h48-0-4" class="i">+&quot;a&quot; → None
</a> 
 # Setting and getting an unversioned key should work. Dump engine operations.
 set_unversioned a=0 [ops]
 get_unversioned a
 ---
<a href="#h48-0-10" id="h48-0-10" class="d">-engine set Unversioned(&quot;a&quot;) → &quot;0&quot;
</a><a href="#h48-0-11" id="h48-0-11" class="d">-a → 0
</a><a href="#h48-0-12" id="h48-0-12" class="i">+engine set mvcc:Unversioned(&quot;a&quot;) → &quot;0&quot; [&quot;\x05a\x00\x00&quot; → &quot;0&quot;]
</a><a href="#h48-0-13" id="h48-0-13" class="i">+&quot;a&quot; → &quot;0&quot;
</a> 
 # Write some versioned keys with the same keys, interleaved between unversioned.
 # The raw engine writes show that the internal keys are different.
<a href="#h48-1" id="h48-1" class="h">@@ -18,38 +18,38 @@ t1: begin
</a> t1: set a=1 b=1 c=1 [ops]
 t1: commit
 ---
<a href="#h48-1-3" id="h48-1-3" class="d">-t1: engine set TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h48-1-4" id="h48-1-4" class="d">-t1: engine set Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h48-1-5" id="h48-1-5" class="d">-t1: engine set TxnWrite(1, &quot;b&quot;) → []
</a><a href="#h48-1-6" id="h48-1-6" class="d">-t1: engine set Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h48-1-7" id="h48-1-7" class="d">-t1: engine set TxnWrite(1, &quot;c&quot;) → []
</a><a href="#h48-1-8" id="h48-1-8" class="d">-t1: engine set Version(&quot;c&quot;, 1) → &quot;1&quot;
</a><a href="#h48-1-9" id="h48-1-9" class="i">+t1: engine set mvcc:TxnWrite(1, &quot;a&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01a\x00\x00&quot; → &quot;&quot;]
</a><a href="#h48-1-10" id="h48-1-10" class="i">+t1: engine set mvcc:Version(&quot;a&quot;, 1) → &quot;1&quot; [&quot;\x04a\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h48-1-11" id="h48-1-11" class="i">+t1: engine set mvcc:TxnWrite(1, &quot;b&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01b\x00\x00&quot; → &quot;&quot;]
</a><a href="#h48-1-12" id="h48-1-12" class="i">+t1: engine set mvcc:Version(&quot;b&quot;, 1) → &quot;1&quot; [&quot;\x04b\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a><a href="#h48-1-13" id="h48-1-13" class="i">+t1: engine set mvcc:TxnWrite(1, &quot;c&quot;) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01c\x00\x00&quot; → &quot;&quot;]
</a><a href="#h48-1-14" id="h48-1-14" class="i">+t1: engine set mvcc:Version(&quot;c&quot;, 1) → &quot;1&quot; [&quot;\x04c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x011&quot;]
</a> 
 # Set another unversioned key overlapping a versioned key.
 set_unversioned b=0 d=0 [ops]
 ---
<a href="#h48-1-19" id="h48-1-19" class="d">-engine set Unversioned(&quot;b&quot;) → &quot;0&quot;
</a><a href="#h48-1-20" id="h48-1-20" class="d">-engine set Unversioned(&quot;d&quot;) → &quot;0&quot;
</a><a href="#h48-1-21" id="h48-1-21" class="i">+engine set mvcc:Unversioned(&quot;b&quot;) → &quot;0&quot; [&quot;\x05b\x00\x00&quot; → &quot;0&quot;]
</a><a href="#h48-1-22" id="h48-1-22" class="i">+engine set mvcc:Unversioned(&quot;d&quot;) → &quot;0&quot; [&quot;\x05d\x00\x00&quot; → &quot;0&quot;]
</a> 
 # An MVCC scan shouldn&#39;t see the unversioned keys.
 t2: begin readonly
 t2: scan
 ---
<a href="#h48-1-28" id="h48-1-28" class="d">-t2: a → 1
</a><a href="#h48-1-29" id="h48-1-29" class="d">-t2: b → 1
</a><a href="#h48-1-30" id="h48-1-30" class="d">-t2: c → 1
</a><a href="#h48-1-31" id="h48-1-31" class="i">+t2: &quot;a&quot; → &quot;1&quot;
</a><a href="#h48-1-32" id="h48-1-32" class="i">+t2: &quot;b&quot; → &quot;1&quot;
</a><a href="#h48-1-33" id="h48-1-33" class="i">+t2: &quot;c&quot; → &quot;1&quot;
</a> 
 # Unversioned gets should not see versioned keys.
 get_unversioned a b c d
 ---
<a href="#h48-1-38" id="h48-1-38" class="d">-a → 0
</a><a href="#h48-1-39" id="h48-1-39" class="d">-b → 0
</a><a href="#h48-1-40" id="h48-1-40" class="d">-c → None
</a><a href="#h48-1-41" id="h48-1-41" class="d">-d → 0
</a><a href="#h48-1-42" id="h48-1-42" class="i">+&quot;a&quot; → &quot;0&quot;
</a><a href="#h48-1-43" id="h48-1-43" class="i">+&quot;b&quot; → &quot;0&quot;
</a><a href="#h48-1-44" id="h48-1-44" class="i">+&quot;c&quot; → None
</a><a href="#h48-1-45" id="h48-1-45" class="i">+&quot;d&quot; → &quot;0&quot;
</a> 
 # Replacing an unversioned key should work too.
 set_unversioned a=2 [ops]
 get_unversioned a
 ---
<a href="#h48-1-51" id="h48-1-51" class="d">-engine set Unversioned(&quot;a&quot;) → &quot;2&quot;
</a><a href="#h48-1-52" id="h48-1-52" class="d">-a → 2
</a><a href="#h48-1-53" id="h48-1-53" class="i">+engine set mvcc:Unversioned(&quot;a&quot;) → &quot;2&quot; [&quot;\x05a\x00\x00&quot; → &quot;2&quot;]
</a><a href="#h48-1-54" id="h48-1-54" class="i">+&quot;a&quot; → &quot;2&quot;
</a></pre>
</div>
</body>
</html>
