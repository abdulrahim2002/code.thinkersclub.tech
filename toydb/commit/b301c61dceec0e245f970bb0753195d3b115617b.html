<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: use goldenscript for node tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/b301c61dceec0e245f970bb0753195d3b115617b.html">b301c61dceec0e245f970bb0753195d3b115617b</a>
<b>parent</b> <a href="../commit/fbf4d68553b517ef2deee4925361f3e8827cfe82.html">fbf4d68553b517ef2deee4925361f3e8827cfe82</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Thu, 23 May 2024 14:05:47 +0200

raft: use goldenscript for node tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/message.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">210</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/follower.rs</a></td><td> | </td><td class="num">792</td><td><span class="i">+</span><span class="d">------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/node/leader.rs</a></td><td> | </td><td class="num">413</td><td><span class="i">++++</span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/node/mod.rs</a></td><td> | </td><td class="num">1243</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/raft/state.rs</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">src/raft/testscripts/append</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/raft/testscripts/append_base_missing</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/raft/testscripts/append_commit_quorum</a></td><td> | </td><td class="num">237</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">src/raft/testscripts/append_conflict_divergent</a></td><td> | </td><td class="num">238</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/raft/testscripts/append_conflict_replace_term</a></td><td> | </td><td class="num">103</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">src/raft/testscripts/append_initial</a></td><td> | </td><td class="num">78</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">src/raft/testscripts/append_overlap</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">src/raft/testscripts/append_response_beyond_last_index_panics</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">src/raft/testscripts/append_response_beyond_last_term_panics</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">src/raft/testscripts/election</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">src/raft/testscripts/election_candidate_behind_leader</a></td><td> | </td><td class="num">130</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/raft/testscripts/election_candidate_behind_quorum</a></td><td> | </td><td class="num">73</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">src/raft/testscripts/election_contested</a></td><td> | </td><td class="num">89</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">src/raft/testscripts/election_tie</a></td><td> | </td><td class="num">80</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">src/raft/testscripts/election_tie_even</a></td><td> | </td><td class="num">99</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">src/raft/testscripts/heartbeat_commits_follower</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h24">src/raft/testscripts/heartbeat_converts_candidate</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h25">src/raft/testscripts/heartbeat_converts_follower</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h26">src/raft/testscripts/heartbeat_converts_follower_leaderless</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">src/raft/testscripts/heartbeat_converts_leader</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">src/raft/testscripts/heartbeat_multiple_leaders_panic</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">src/raft/testscripts/heartbeat_old_commit_index</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">src/raft/testscripts/old_campaign_rejected</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">src/raft/testscripts/old_campaign_response_ignored</a></td><td> | </td><td class="num">100</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">src/raft/testscripts/old_heartbeat_ignored</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">src/raft/testscripts/request_candidate_abort</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">src/raft/testscripts/request_follower</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">src/raft/testscripts/request_follower_campaign_abort</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">src/raft/testscripts/request_follower_disconnect_stall</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">src/raft/testscripts/request_follower_leaderless_abort</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">src/raft/testscripts/request_leader</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">src/raft/testscripts/request_leader_campaign_abort</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">src/raft/testscripts/request_leader_change_linearizability</a></td><td> | </td><td class="num">84</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">src/raft/testscripts/request_leader_disconnect</a></td><td> | </td><td class="num">50</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">src/raft/testscripts/request_leader_read_quorum</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">src/raft/testscripts/request_leader_read_quorum_sequence</a></td><td> | </td><td class="num">80</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h44">src/raft/testscripts/request_leader_single</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">src/raft/testscripts/request_status</a></td><td> | </td><td class="num">75</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">src/raft/testscripts/request_status_single</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">src/raft/testscripts/tick_candidate</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h48">src/raft/testscripts/tick_follower</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">src/raft/testscripts/tick_follower_leaderless</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h50">src/raft/testscripts/tick_leader</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>51 files changed, 3814 insertions(+), 1687 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -133,6 +133,12 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-0-3" id="h0-0-3" class="i">+name = &quot;bytecount&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+version = &quot;0.6.8&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+checksum = &quot;5ce89b21cab1437276d2650d57e971f9d548a2d9037cc231abdc0562b97498ce&quot;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+
</a><a href="#h0-0-8" id="h0-0-8" class="i">+[[package]]
</a> name = &quot;byteorder&quot;
 version = &quot;1.5.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-1" id="h0-1" class="h">@@ -607,6 +613,17 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-1-3" id="h0-1-3" class="i">+name = &quot;goldenscript&quot;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+version = &quot;0.3.0&quot;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+checksum = &quot;0169ef881fb6dd6578ee6de31fca3bd5f6827bdb65980ab00d73288fedfecebb&quot;
</a><a href="#h0-1-7" id="h0-1-7" class="i">+dependencies = [
</a><a href="#h0-1-8" id="h0-1-8" class="i">+ &quot;goldenfile&quot;,
</a><a href="#h0-1-9" id="h0-1-9" class="i">+ &quot;nom&quot;,
</a><a href="#h0-1-10" id="h0-1-10" class="i">+ &quot;nom_locate&quot;,
</a><a href="#h0-1-11" id="h0-1-11" class="i">+]
</a><a href="#h0-1-12" id="h0-1-12" class="i">+
</a><a href="#h0-1-13" id="h0-1-13" class="i">+[[package]]
</a> name = &quot;hashbrown&quot;
 version = &quot;0.13.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-2" id="h0-2" class="h">@@ -782,6 +799,17 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-2-3" id="h0-2-3" class="i">+name = &quot;nom_locate&quot;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+version = &quot;4.2.0&quot;
</a><a href="#h0-2-5" id="h0-2-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-6" id="h0-2-6" class="i">+checksum = &quot;1e3c83c053b0713da60c5b8de47fe8e494fe3ece5267b2f23090a07a053ba8f3&quot;
</a><a href="#h0-2-7" id="h0-2-7" class="i">+dependencies = [
</a><a href="#h0-2-8" id="h0-2-8" class="i">+ &quot;bytecount&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+ &quot;memchr&quot;,
</a><a href="#h0-2-10" id="h0-2-10" class="i">+ &quot;nom&quot;,
</a><a href="#h0-2-11" id="h0-2-11" class="i">+]
</a><a href="#h0-2-12" id="h0-2-12" class="i">+
</a><a href="#h0-2-13" id="h0-2-13" class="i">+[[package]]
</a> name = &quot;num-conv&quot;
 version = &quot;0.1.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-3" id="h0-3" class="h">@@ -1223,9 +1251,9 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;serde_json&quot;
<a href="#h0-3-3" id="h0-3-3" class="d">-version = &quot;1.0.116&quot;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+version = &quot;1.0.117&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-3-6" id="h0-3-6" class="d">-checksum = &quot;3e17db7126d17feb94eb3fad46bf1a96b034e8aacbc2e775fe81505f8b0b2813&quot;
</a><a href="#h0-3-7" id="h0-3-7" class="i">+checksum = &quot;455182ea6142b14f93f4bc5320a2b31c1f266b66a4a5c858b013302a5d8cbfc3&quot;
</a> dependencies = [
  &quot;itoa&quot;,
  &quot;ryu&quot;,
<a href="#h0-4" id="h0-4" class="h">@@ -1383,6 +1411,18 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-4-3" id="h0-4-3" class="i">+name = &quot;test_each_file&quot;
</a><a href="#h0-4-4" id="h0-4-4" class="i">+version = &quot;0.3.2&quot;
</a><a href="#h0-4-5" id="h0-4-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-4-6" id="h0-4-6" class="i">+checksum = &quot;0f1a92330478de0709111391059475f7d960692519e2c54c823c662408bab365&quot;
</a><a href="#h0-4-7" id="h0-4-7" class="i">+dependencies = [
</a><a href="#h0-4-8" id="h0-4-8" class="i">+ &quot;proc-macro2&quot;,
</a><a href="#h0-4-9" id="h0-4-9" class="i">+ &quot;quote&quot;,
</a><a href="#h0-4-10" id="h0-4-10" class="i">+ &quot;syn 2.0.60&quot;,
</a><a href="#h0-4-11" id="h0-4-11" class="i">+ &quot;unicode-ident&quot;,
</a><a href="#h0-4-12" id="h0-4-12" class="i">+]
</a><a href="#h0-4-13" id="h0-4-13" class="i">+
</a><a href="#h0-4-14" id="h0-4-14" class="i">+[[package]]
</a> name = &quot;thiserror&quot;
 version = &quot;1.0.59&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-5" id="h0-5" class="h">@@ -1490,6 +1530,7 @@ dependencies = [
</a>  &quot;escargot&quot;,
  &quot;fs4&quot;,
  &quot;goldenfile&quot;,
<a href="#h0-5-3" id="h0-5-3" class="i">+ &quot;goldenscript&quot;,
</a>  &quot;hdrhistogram&quot;,
  &quot;hex&quot;,
  &quot;itertools&quot;,
<a href="#h0-6" id="h0-6" class="h">@@ -1504,10 +1545,12 @@ dependencies = [
</a>  &quot;serde&quot;,
  &quot;serde_bytes&quot;,
  &quot;serde_derive&quot;,
<a href="#h0-6-3" id="h0-6-3" class="i">+ &quot;serde_json&quot;,
</a>  &quot;serial_test&quot;,
  &quot;simplelog&quot;,
  &quot;tempdir&quot;,
  &quot;tempfile&quot;,
<a href="#h0-6-8" id="h0-6-8" class="i">+ &quot;test_each_file&quot;,
</a>  &quot;uuid&quot;,
 ]
 
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -34,8 +34,11 @@ uuid = { version = &quot;1.8.0&quot;, features = [&quot;v4&quot;] }
</a> [dev-dependencies]
 escargot = &quot;0.5.10&quot;
 goldenfile = &quot;1.7.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="i">+goldenscript = &quot;0.3.0&quot;
</a> paste = &quot;1.0.14&quot;
 pretty_assertions = &quot;1.4.0&quot;
<a href="#h1-0-6" id="h1-0-6" class="i">+serde_json = &quot;1.0.117&quot;
</a> serial_test = &quot;3.1.1&quot;
 tempdir = &quot;0.3.7&quot;
 tempfile = &quot;3.10.1&quot;
<a href="#h1-0-10" id="h1-0-10" class="i">+test_each_file = &quot;0.3.2&quot;
</a><b>diff --git a/<a id="h2" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -140,6 +140,8 @@ pub struct Status {
</a>     pub term: Term,
     /// The last log indexes of all nodes. Use a BTreeMap for deterministic
     /// debug output.
<a href="#h2-0-3" id="h2-0-3" class="i">+    ///
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    /// TODO: rename to match.
</a>     pub last_index: BTreeMap&lt;NodeID, Index&gt;,
     /// The current commit index.
     pub commit_index: Index,
<b>diff --git a/<a id="h3" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -170,213 +170,3 @@ impl RawNode&lt;Candidate&gt; {
</a>         Ok(())
     }
 }
<a href="#h3-0-3" id="h3-0-3" class="d">-
</a><a href="#h3-0-4" id="h3-0-4" class="d">-#[cfg(test)]
</a><a href="#h3-0-5" id="h3-0-5" class="d">-mod tests {
</a><a href="#h3-0-6" id="h3-0-6" class="d">-    use super::super::super::state::tests::TestState;
</a><a href="#h3-0-7" id="h3-0-7" class="d">-    use super::super::super::{Entry, Log, Request, ELECTION_TIMEOUT_RANGE};
</a><a href="#h3-0-8" id="h3-0-8" class="d">-    use super::super::tests::{assert_messages, assert_node};
</a><a href="#h3-0-9" id="h3-0-9" class="d">-    use super::*;
</a><a href="#h3-0-10" id="h3-0-10" class="d">-    use crate::raft::HEARTBEAT_INTERVAL;
</a><a href="#h3-0-11" id="h3-0-11" class="d">-    use crate::storage;
</a><a href="#h3-0-12" id="h3-0-12" class="d">-    use itertools::Itertools as _;
</a><a href="#h3-0-13" id="h3-0-13" class="d">-    use rand::Rng as _;
</a><a href="#h3-0-14" id="h3-0-14" class="d">-
</a><a href="#h3-0-15" id="h3-0-15" class="d">-    #[allow(clippy::type_complexity)]
</a><a href="#h3-0-16" id="h3-0-16" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Candidate&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a><a href="#h3-0-17" id="h3-0-17" class="d">-        let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h3-0-18" id="h3-0-18" class="d">-        let state = Box::new(TestState::new(0));
</a><a href="#h3-0-19" id="h3-0-19" class="d">-        let mut log = Log::new(storage::Memory::new(), false)?;
</a><a href="#h3-0-20" id="h3-0-20" class="d">-
</a><a href="#h3-0-21" id="h3-0-21" class="d">-        log.append(1, Some(vec![0x01]))?;
</a><a href="#h3-0-22" id="h3-0-22" class="d">-        log.append(1, Some(vec![0x02]))?;
</a><a href="#h3-0-23" id="h3-0-23" class="d">-        log.append(2, Some(vec![0x03]))?;
</a><a href="#h3-0-24" id="h3-0-24" class="d">-        log.commit(2)?;
</a><a href="#h3-0-25" id="h3-0-25" class="d">-        log.set_term(3, Some(1))?;
</a><a href="#h3-0-26" id="h3-0-26" class="d">-
</a><a href="#h3-0-27" id="h3-0-27" class="d">-        let mut node = RawNode {
</a><a href="#h3-0-28" id="h3-0-28" class="d">-            id: 1,
</a><a href="#h3-0-29" id="h3-0-29" class="d">-            peers: HashSet::from([2, 3, 4, 5]),
</a><a href="#h3-0-30" id="h3-0-30" class="d">-            term: 3,
</a><a href="#h3-0-31" id="h3-0-31" class="d">-            log,
</a><a href="#h3-0-32" id="h3-0-32" class="d">-            state,
</a><a href="#h3-0-33" id="h3-0-33" class="d">-            node_tx,
</a><a href="#h3-0-34" id="h3-0-34" class="d">-            heartbeat_interval: HEARTBEAT_INTERVAL,
</a><a href="#h3-0-35" id="h3-0-35" class="d">-            election_timeout_range: ELECTION_TIMEOUT_RANGE,
</a><a href="#h3-0-36" id="h3-0-36" class="d">-            role: Candidate::new(rand::thread_rng().gen_range(ELECTION_TIMEOUT_RANGE)),
</a><a href="#h3-0-37" id="h3-0-37" class="d">-        };
</a><a href="#h3-0-38" id="h3-0-38" class="d">-        node.role.votes.insert(1);
</a><a href="#h3-0-39" id="h3-0-39" class="d">-        Ok((node, node_rx))
</a><a href="#h3-0-40" id="h3-0-40" class="d">-    }
</a><a href="#h3-0-41" id="h3-0-41" class="d">-
</a><a href="#h3-0-42" id="h3-0-42" class="d">-    #[test]
</a><a href="#h3-0-43" id="h3-0-43" class="d">-    // Heartbeat for current term converts to follower and emits ConfirmLeader.
</a><a href="#h3-0-44" id="h3-0-44" class="d">-    fn step_heartbeat_current_term() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-45" id="h3-0-45" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h3-0-46" id="h3-0-46" class="d">-        let mut node = candidate.step(Envelope {
</a><a href="#h3-0-47" id="h3-0-47" class="d">-            from: 2,
</a><a href="#h3-0-48" id="h3-0-48" class="d">-            to: 1,
</a><a href="#h3-0-49" id="h3-0-49" class="d">-            term: 3,
</a><a href="#h3-0-50" id="h3-0-50" class="d">-            message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h3-0-51" id="h3-0-51" class="d">-        })?;
</a><a href="#h3-0-52" id="h3-0-52" class="d">-        assert_node(&amp;mut node).is_follower().term(3);
</a><a href="#h3-0-53" id="h3-0-53" class="d">-        assert_messages(
</a><a href="#h3-0-54" id="h3-0-54" class="d">-            &amp;mut node_rx,
</a><a href="#h3-0-55" id="h3-0-55" class="d">-            vec![Envelope {
</a><a href="#h3-0-56" id="h3-0-56" class="d">-                from: 1,
</a><a href="#h3-0-57" id="h3-0-57" class="d">-                to: 2,
</a><a href="#h3-0-58" id="h3-0-58" class="d">-                term: 3,
</a><a href="#h3-0-59" id="h3-0-59" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h3-0-60" id="h3-0-60" class="d">-            }],
</a><a href="#h3-0-61" id="h3-0-61" class="d">-        );
</a><a href="#h3-0-62" id="h3-0-62" class="d">-        Ok(())
</a><a href="#h3-0-63" id="h3-0-63" class="d">-    }
</a><a href="#h3-0-64" id="h3-0-64" class="d">-
</a><a href="#h3-0-65" id="h3-0-65" class="d">-    #[test]
</a><a href="#h3-0-66" id="h3-0-66" class="d">-    // Heartbeat for future term converts to follower and emits ConfirmLeader.
</a><a href="#h3-0-67" id="h3-0-67" class="d">-    fn step_heartbeat_future_term() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-68" id="h3-0-68" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h3-0-69" id="h3-0-69" class="d">-        let mut node = candidate.step(Envelope {
</a><a href="#h3-0-70" id="h3-0-70" class="d">-            from: 2,
</a><a href="#h3-0-71" id="h3-0-71" class="d">-            to: 1,
</a><a href="#h3-0-72" id="h3-0-72" class="d">-            term: 4,
</a><a href="#h3-0-73" id="h3-0-73" class="d">-            message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h3-0-74" id="h3-0-74" class="d">-        })?;
</a><a href="#h3-0-75" id="h3-0-75" class="d">-        assert_node(&amp;mut node).is_follower().term(4);
</a><a href="#h3-0-76" id="h3-0-76" class="d">-        assert_messages(
</a><a href="#h3-0-77" id="h3-0-77" class="d">-            &amp;mut node_rx,
</a><a href="#h3-0-78" id="h3-0-78" class="d">-            vec![Envelope {
</a><a href="#h3-0-79" id="h3-0-79" class="d">-                from: 1,
</a><a href="#h3-0-80" id="h3-0-80" class="d">-                to: 2,
</a><a href="#h3-0-81" id="h3-0-81" class="d">-                term: 4,
</a><a href="#h3-0-82" id="h3-0-82" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h3-0-83" id="h3-0-83" class="d">-            }],
</a><a href="#h3-0-84" id="h3-0-84" class="d">-        );
</a><a href="#h3-0-85" id="h3-0-85" class="d">-        Ok(())
</a><a href="#h3-0-86" id="h3-0-86" class="d">-    }
</a><a href="#h3-0-87" id="h3-0-87" class="d">-
</a><a href="#h3-0-88" id="h3-0-88" class="d">-    #[test]
</a><a href="#h3-0-89" id="h3-0-89" class="d">-    // Heartbeat for past term is ignored
</a><a href="#h3-0-90" id="h3-0-90" class="d">-    fn step_heartbeat_past_term() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-91" id="h3-0-91" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h3-0-92" id="h3-0-92" class="d">-        let mut node = candidate.step(Envelope {
</a><a href="#h3-0-93" id="h3-0-93" class="d">-            from: 2,
</a><a href="#h3-0-94" id="h3-0-94" class="d">-            to: 1,
</a><a href="#h3-0-95" id="h3-0-95" class="d">-            term: 2,
</a><a href="#h3-0-96" id="h3-0-96" class="d">-            message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h3-0-97" id="h3-0-97" class="d">-        })?;
</a><a href="#h3-0-98" id="h3-0-98" class="d">-        assert_node(&amp;mut node).is_candidate().term(3);
</a><a href="#h3-0-99" id="h3-0-99" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h3-0-100" id="h3-0-100" class="d">-        Ok(())
</a><a href="#h3-0-101" id="h3-0-101" class="d">-    }
</a><a href="#h3-0-102" id="h3-0-102" class="d">-
</a><a href="#h3-0-103" id="h3-0-103" class="d">-    #[test]
</a><a href="#h3-0-104" id="h3-0-104" class="d">-    fn step_grantvote() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-105" id="h3-0-105" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h3-0-106" id="h3-0-106" class="d">-        let peers = candidate.peers.clone();
</a><a href="#h3-0-107" id="h3-0-107" class="d">-        let mut node = Node::Candidate(candidate);
</a><a href="#h3-0-108" id="h3-0-108" class="d">-
</a><a href="#h3-0-109" id="h3-0-109" class="d">-        // The first vote is not sufficient for a quorum (3 votes including self)
</a><a href="#h3-0-110" id="h3-0-110" class="d">-        node = node.step(Envelope {
</a><a href="#h3-0-111" id="h3-0-111" class="d">-            from: 3,
</a><a href="#h3-0-112" id="h3-0-112" class="d">-            to: 1,
</a><a href="#h3-0-113" id="h3-0-113" class="d">-            term: 3,
</a><a href="#h3-0-114" id="h3-0-114" class="d">-            message: Message::CampaignResponse { vote: true },
</a><a href="#h3-0-115" id="h3-0-115" class="d">-        })?;
</a><a href="#h3-0-116" id="h3-0-116" class="d">-        assert_node(&amp;mut node).is_candidate().term(3);
</a><a href="#h3-0-117" id="h3-0-117" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h3-0-118" id="h3-0-118" class="d">-
</a><a href="#h3-0-119" id="h3-0-119" class="d">-        // However, the second external vote makes us leader
</a><a href="#h3-0-120" id="h3-0-120" class="d">-        node = node.step(Envelope {
</a><a href="#h3-0-121" id="h3-0-121" class="d">-            from: 5,
</a><a href="#h3-0-122" id="h3-0-122" class="d">-            to: 1,
</a><a href="#h3-0-123" id="h3-0-123" class="d">-            term: 3,
</a><a href="#h3-0-124" id="h3-0-124" class="d">-            message: Message::CampaignResponse { vote: true },
</a><a href="#h3-0-125" id="h3-0-125" class="d">-        })?;
</a><a href="#h3-0-126" id="h3-0-126" class="d">-        assert_node(&amp;mut node).is_leader().term(3);
</a><a href="#h3-0-127" id="h3-0-127" class="d">-
</a><a href="#h3-0-128" id="h3-0-128" class="d">-        for to in peers.iter().copied().sorted() {
</a><a href="#h3-0-129" id="h3-0-129" class="d">-            assert_eq!(
</a><a href="#h3-0-130" id="h3-0-130" class="d">-                node_rx.try_recv()?,
</a><a href="#h3-0-131" id="h3-0-131" class="d">-                Envelope {
</a><a href="#h3-0-132" id="h3-0-132" class="d">-                    from: 1,
</a><a href="#h3-0-133" id="h3-0-133" class="d">-                    to,
</a><a href="#h3-0-134" id="h3-0-134" class="d">-                    term: 3,
</a><a href="#h3-0-135" id="h3-0-135" class="d">-                    message: Message::Append {
</a><a href="#h3-0-136" id="h3-0-136" class="d">-                        base_index: 3,
</a><a href="#h3-0-137" id="h3-0-137" class="d">-                        base_term: 2,
</a><a href="#h3-0-138" id="h3-0-138" class="d">-                        entries: vec![Entry { index: 4, term: 3, command: None }],
</a><a href="#h3-0-139" id="h3-0-139" class="d">-                    },
</a><a href="#h3-0-140" id="h3-0-140" class="d">-                }
</a><a href="#h3-0-141" id="h3-0-141" class="d">-            )
</a><a href="#h3-0-142" id="h3-0-142" class="d">-        }
</a><a href="#h3-0-143" id="h3-0-143" class="d">-
</a><a href="#h3-0-144" id="h3-0-144" class="d">-        for to in peers.iter().copied().sorted() {
</a><a href="#h3-0-145" id="h3-0-145" class="d">-            assert_eq!(
</a><a href="#h3-0-146" id="h3-0-146" class="d">-                node_rx.try_recv()?,
</a><a href="#h3-0-147" id="h3-0-147" class="d">-                Envelope {
</a><a href="#h3-0-148" id="h3-0-148" class="d">-                    from: 1,
</a><a href="#h3-0-149" id="h3-0-149" class="d">-                    to,
</a><a href="#h3-0-150" id="h3-0-150" class="d">-                    term: 3,
</a><a href="#h3-0-151" id="h3-0-151" class="d">-                    message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h3-0-152" id="h3-0-152" class="d">-                },
</a><a href="#h3-0-153" id="h3-0-153" class="d">-            );
</a><a href="#h3-0-154" id="h3-0-154" class="d">-        }
</a><a href="#h3-0-155" id="h3-0-155" class="d">-
</a><a href="#h3-0-156" id="h3-0-156" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h3-0-157" id="h3-0-157" class="d">-        Ok(())
</a><a href="#h3-0-158" id="h3-0-158" class="d">-    }
</a><a href="#h3-0-159" id="h3-0-159" class="d">-
</a><a href="#h3-0-160" id="h3-0-160" class="d">-    #[test]
</a><a href="#h3-0-161" id="h3-0-161" class="d">-    // ClientRequest returns Error::Abort.
</a><a href="#h3-0-162" id="h3-0-162" class="d">-    fn step_clientrequest() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-163" id="h3-0-163" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h3-0-164" id="h3-0-164" class="d">-        let mut node = Node::Candidate(candidate);
</a><a href="#h3-0-165" id="h3-0-165" class="d">-
</a><a href="#h3-0-166" id="h3-0-166" class="d">-        node = node.step(Envelope {
</a><a href="#h3-0-167" id="h3-0-167" class="d">-            from: 1,
</a><a href="#h3-0-168" id="h3-0-168" class="d">-            to: 1,
</a><a href="#h3-0-169" id="h3-0-169" class="d">-            term: 3,
</a><a href="#h3-0-170" id="h3-0-170" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Write(vec![0xaf]) },
</a><a href="#h3-0-171" id="h3-0-171" class="d">-        })?;
</a><a href="#h3-0-172" id="h3-0-172" class="d">-        assert_node(&amp;mut node).is_candidate().term(3);
</a><a href="#h3-0-173" id="h3-0-173" class="d">-        assert_messages(
</a><a href="#h3-0-174" id="h3-0-174" class="d">-            &amp;mut node_rx,
</a><a href="#h3-0-175" id="h3-0-175" class="d">-            vec![Envelope {
</a><a href="#h3-0-176" id="h3-0-176" class="d">-                from: 1,
</a><a href="#h3-0-177" id="h3-0-177" class="d">-                to: 1,
</a><a href="#h3-0-178" id="h3-0-178" class="d">-                term: 3,
</a><a href="#h3-0-179" id="h3-0-179" class="d">-                message: Message::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a><a href="#h3-0-180" id="h3-0-180" class="d">-            }],
</a><a href="#h3-0-181" id="h3-0-181" class="d">-        );
</a><a href="#h3-0-182" id="h3-0-182" class="d">-        Ok(())
</a><a href="#h3-0-183" id="h3-0-183" class="d">-    }
</a><a href="#h3-0-184" id="h3-0-184" class="d">-
</a><a href="#h3-0-185" id="h3-0-185" class="d">-    #[test]
</a><a href="#h3-0-186" id="h3-0-186" class="d">-    fn tick() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-187" id="h3-0-187" class="d">-        let (candidate, node_rx) = setup()?;
</a><a href="#h3-0-188" id="h3-0-188" class="d">-        let peers = candidate.peers.clone();
</a><a href="#h3-0-189" id="h3-0-189" class="d">-        let timeout = candidate.role.election_timeout;
</a><a href="#h3-0-190" id="h3-0-190" class="d">-        let mut node = Node::Candidate(candidate);
</a><a href="#h3-0-191" id="h3-0-191" class="d">-
</a><a href="#h3-0-192" id="h3-0-192" class="d">-        assert!(timeout &gt; 0);
</a><a href="#h3-0-193" id="h3-0-193" class="d">-        for _ in 0..timeout {
</a><a href="#h3-0-194" id="h3-0-194" class="d">-            assert_node(&amp;mut node).is_candidate().term(3);
</a><a href="#h3-0-195" id="h3-0-195" class="d">-            node = node.tick()?;
</a><a href="#h3-0-196" id="h3-0-196" class="d">-        }
</a><a href="#h3-0-197" id="h3-0-197" class="d">-        assert_node(&amp;mut node).is_candidate().term(4);
</a><a href="#h3-0-198" id="h3-0-198" class="d">-
</a><a href="#h3-0-199" id="h3-0-199" class="d">-        for to in peers.iter().copied().sorted() {
</a><a href="#h3-0-200" id="h3-0-200" class="d">-            assert_eq!(
</a><a href="#h3-0-201" id="h3-0-201" class="d">-                node_rx.try_recv()?,
</a><a href="#h3-0-202" id="h3-0-202" class="d">-                Envelope {
</a><a href="#h3-0-203" id="h3-0-203" class="d">-                    from: 1,
</a><a href="#h3-0-204" id="h3-0-204" class="d">-                    to,
</a><a href="#h3-0-205" id="h3-0-205" class="d">-                    term: 4,
</a><a href="#h3-0-206" id="h3-0-206" class="d">-                    message: Message::Campaign { last_index: 3, last_term: 2 },
</a><a href="#h3-0-207" id="h3-0-207" class="d">-                },
</a><a href="#h3-0-208" id="h3-0-208" class="d">-            );
</a><a href="#h3-0-209" id="h3-0-209" class="d">-        }
</a><a href="#h3-0-210" id="h3-0-210" class="d">-        Ok(())
</a><a href="#h3-0-211" id="h3-0-211" class="d">-    }
</a><a href="#h3-0-212" id="h3-0-212" class="d">-}
</a><b>diff --git a/<a id="h4" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -158,7 +158,7 @@ impl RawNode&lt;Follower&gt; {
</a>             Message::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
                 // Check that the heartbeat is from our leader.
                 match self.role.leader {
<a href="#h4-0-3" id="h4-0-3" class="d">-                    Some(leader) =&gt; assert_eq!(msg.from, leader, &quot;Multiple leaders in term&quot;),
</a><a href="#h4-0-4" id="h4-0-4" class="i">+                    Some(leader) =&gt; assert_eq!(msg.from, leader, &quot;multiple leaders in term&quot;),
</a>                     None =&gt; self = self.into_follower(Some(msg.from), msg.term)?,
                 }
 
<a href="#h4-1" id="h4-1" class="h">@@ -184,7 +184,7 @@ impl RawNode&lt;Follower&gt; {
</a>                 // Check that the entries are from our leader.
                 let from = msg.from;
                 match self.role.leader {
<a href="#h4-1-3" id="h4-1-3" class="d">-                    Some(leader) =&gt; assert_eq!(from, leader, &quot;Multiple leaders in term&quot;),
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                    Some(leader) =&gt; assert_eq!(from, leader, &quot;multiple leaders in term&quot;),
</a>                     None =&gt; self = self.into_follower(Some(from), msg.term)?,
                 }
 
<a href="#h4-2" id="h4-2" class="h">@@ -286,791 +286,3 @@ impl RawNode&lt;Follower&gt; {
</a>         self.role.leader == Some(from)
     }
 }
<a href="#h4-2-3" id="h4-2-3" class="d">-
</a><a href="#h4-2-4" id="h4-2-4" class="d">-#[cfg(test)]
</a><a href="#h4-2-5" id="h4-2-5" class="d">-pub mod tests {
</a><a href="#h4-2-6" id="h4-2-6" class="d">-    use super::super::super::state::tests::TestState;
</a><a href="#h4-2-7" id="h4-2-7" class="d">-    use super::super::super::{Entry, Log, Request, Response, ELECTION_TIMEOUT_RANGE};
</a><a href="#h4-2-8" id="h4-2-8" class="d">-    use super::super::tests::{assert_messages, assert_node};
</a><a href="#h4-2-9" id="h4-2-9" class="d">-    use super::*;
</a><a href="#h4-2-10" id="h4-2-10" class="d">-    use crate::error::Error;
</a><a href="#h4-2-11" id="h4-2-11" class="d">-    use crate::raft::HEARTBEAT_INTERVAL;
</a><a href="#h4-2-12" id="h4-2-12" class="d">-    use crate::storage;
</a><a href="#h4-2-13" id="h4-2-13" class="d">-    use rand::Rng as _;
</a><a href="#h4-2-14" id="h4-2-14" class="d">-
</a><a href="#h4-2-15" id="h4-2-15" class="d">-    #[allow(clippy::type_complexity)]
</a><a href="#h4-2-16" id="h4-2-16" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a><a href="#h4-2-17" id="h4-2-17" class="d">-        let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h4-2-18" id="h4-2-18" class="d">-        let state = Box::new(TestState::new(0));
</a><a href="#h4-2-19" id="h4-2-19" class="d">-        let mut log = Log::new(storage::Memory::new(), false)?;
</a><a href="#h4-2-20" id="h4-2-20" class="d">-        log.append(1, Some(vec![0x01]))?;
</a><a href="#h4-2-21" id="h4-2-21" class="d">-        log.append(1, Some(vec![0x02]))?;
</a><a href="#h4-2-22" id="h4-2-22" class="d">-        log.append(2, Some(vec![0x03]))?;
</a><a href="#h4-2-23" id="h4-2-23" class="d">-        log.commit(2)?;
</a><a href="#h4-2-24" id="h4-2-24" class="d">-        log.set_term(3, None)?;
</a><a href="#h4-2-25" id="h4-2-25" class="d">-
</a><a href="#h4-2-26" id="h4-2-26" class="d">-        let node = RawNode {
</a><a href="#h4-2-27" id="h4-2-27" class="d">-            id: 1,
</a><a href="#h4-2-28" id="h4-2-28" class="d">-            peers: HashSet::from([2, 3, 4, 5]),
</a><a href="#h4-2-29" id="h4-2-29" class="d">-            term: 3,
</a><a href="#h4-2-30" id="h4-2-30" class="d">-            log,
</a><a href="#h4-2-31" id="h4-2-31" class="d">-            state,
</a><a href="#h4-2-32" id="h4-2-32" class="d">-            node_tx,
</a><a href="#h4-2-33" id="h4-2-33" class="d">-            heartbeat_interval: HEARTBEAT_INTERVAL,
</a><a href="#h4-2-34" id="h4-2-34" class="d">-            election_timeout_range: ELECTION_TIMEOUT_RANGE,
</a><a href="#h4-2-35" id="h4-2-35" class="d">-            role: Follower::new(
</a><a href="#h4-2-36" id="h4-2-36" class="d">-                Some(2),
</a><a href="#h4-2-37" id="h4-2-37" class="d">-                None,
</a><a href="#h4-2-38" id="h4-2-38" class="d">-                rand::thread_rng().gen_range(ELECTION_TIMEOUT_RANGE),
</a><a href="#h4-2-39" id="h4-2-39" class="d">-            ),
</a><a href="#h4-2-40" id="h4-2-40" class="d">-        };
</a><a href="#h4-2-41" id="h4-2-41" class="d">-        Ok((node, node_rx))
</a><a href="#h4-2-42" id="h4-2-42" class="d">-    }
</a><a href="#h4-2-43" id="h4-2-43" class="d">-
</a><a href="#h4-2-44" id="h4-2-44" class="d">-    #[test]
</a><a href="#h4-2-45" id="h4-2-45" class="d">-    // Heartbeat from current leader should commit and apply
</a><a href="#h4-2-46" id="h4-2-46" class="d">-    fn step_heartbeat() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-47" id="h4-2-47" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-48" id="h4-2-48" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-49" id="h4-2-49" class="d">-            from: 2,
</a><a href="#h4-2-50" id="h4-2-50" class="d">-            to: 1,
</a><a href="#h4-2-51" id="h4-2-51" class="d">-            term: 3,
</a><a href="#h4-2-52" id="h4-2-52" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-2-53" id="h4-2-53" class="d">-        })?;
</a><a href="#h4-2-54" id="h4-2-54" class="d">-        assert_node(&amp;mut node)
</a><a href="#h4-2-55" id="h4-2-55" class="d">-            .is_follower()
</a><a href="#h4-2-56" id="h4-2-56" class="d">-            .term(3)
</a><a href="#h4-2-57" id="h4-2-57" class="d">-            .leader(Some(2))
</a><a href="#h4-2-58" id="h4-2-58" class="d">-            .voted_for(None)
</a><a href="#h4-2-59" id="h4-2-59" class="d">-            .committed(3)
</a><a href="#h4-2-60" id="h4-2-60" class="d">-            .applied(3);
</a><a href="#h4-2-61" id="h4-2-61" class="d">-        assert_messages(
</a><a href="#h4-2-62" id="h4-2-62" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-63" id="h4-2-63" class="d">-            vec![Envelope {
</a><a href="#h4-2-64" id="h4-2-64" class="d">-                from: 1,
</a><a href="#h4-2-65" id="h4-2-65" class="d">-                to: 2,
</a><a href="#h4-2-66" id="h4-2-66" class="d">-                term: 3,
</a><a href="#h4-2-67" id="h4-2-67" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-68" id="h4-2-68" class="d">-            }],
</a><a href="#h4-2-69" id="h4-2-69" class="d">-        );
</a><a href="#h4-2-70" id="h4-2-70" class="d">-        Ok(())
</a><a href="#h4-2-71" id="h4-2-71" class="d">-    }
</a><a href="#h4-2-72" id="h4-2-72" class="d">-
</a><a href="#h4-2-73" id="h4-2-73" class="d">-    #[test]
</a><a href="#h4-2-74" id="h4-2-74" class="d">-    // Heartbeat from current leader with conflicting commit_term
</a><a href="#h4-2-75" id="h4-2-75" class="d">-    fn step_heartbeat_conflict_commit_term() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-76" id="h4-2-76" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-77" id="h4-2-77" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-78" id="h4-2-78" class="d">-            from: 2,
</a><a href="#h4-2-79" id="h4-2-79" class="d">-            to: 1,
</a><a href="#h4-2-80" id="h4-2-80" class="d">-            term: 3,
</a><a href="#h4-2-81" id="h4-2-81" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 3, read_seq: 7 },
</a><a href="#h4-2-82" id="h4-2-82" class="d">-        })?;
</a><a href="#h4-2-83" id="h4-2-83" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
</a><a href="#h4-2-84" id="h4-2-84" class="d">-        assert_messages(
</a><a href="#h4-2-85" id="h4-2-85" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-86" id="h4-2-86" class="d">-            vec![Envelope {
</a><a href="#h4-2-87" id="h4-2-87" class="d">-                from: 1,
</a><a href="#h4-2-88" id="h4-2-88" class="d">-                to: 2,
</a><a href="#h4-2-89" id="h4-2-89" class="d">-                term: 3,
</a><a href="#h4-2-90" id="h4-2-90" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-91" id="h4-2-91" class="d">-            }],
</a><a href="#h4-2-92" id="h4-2-92" class="d">-        );
</a><a href="#h4-2-93" id="h4-2-93" class="d">-        Ok(())
</a><a href="#h4-2-94" id="h4-2-94" class="d">-    }
</a><a href="#h4-2-95" id="h4-2-95" class="d">-
</a><a href="#h4-2-96" id="h4-2-96" class="d">-    #[test]
</a><a href="#h4-2-97" id="h4-2-97" class="d">-    // Heartbeat from current leader with a missing commit_index
</a><a href="#h4-2-98" id="h4-2-98" class="d">-    fn step_heartbeat_missing_commit_entry() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-99" id="h4-2-99" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-100" id="h4-2-100" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-101" id="h4-2-101" class="d">-            from: 2,
</a><a href="#h4-2-102" id="h4-2-102" class="d">-            to: 1,
</a><a href="#h4-2-103" id="h4-2-103" class="d">-            term: 3,
</a><a href="#h4-2-104" id="h4-2-104" class="d">-            message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h4-2-105" id="h4-2-105" class="d">-        })?;
</a><a href="#h4-2-106" id="h4-2-106" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
</a><a href="#h4-2-107" id="h4-2-107" class="d">-        assert_messages(
</a><a href="#h4-2-108" id="h4-2-108" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-109" id="h4-2-109" class="d">-            vec![Envelope {
</a><a href="#h4-2-110" id="h4-2-110" class="d">-                from: 1,
</a><a href="#h4-2-111" id="h4-2-111" class="d">-                to: 2,
</a><a href="#h4-2-112" id="h4-2-112" class="d">-                term: 3,
</a><a href="#h4-2-113" id="h4-2-113" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-114" id="h4-2-114" class="d">-            }],
</a><a href="#h4-2-115" id="h4-2-115" class="d">-        );
</a><a href="#h4-2-116" id="h4-2-116" class="d">-        Ok(())
</a><a href="#h4-2-117" id="h4-2-117" class="d">-    }
</a><a href="#h4-2-118" id="h4-2-118" class="d">-
</a><a href="#h4-2-119" id="h4-2-119" class="d">-    #[test]
</a><a href="#h4-2-120" id="h4-2-120" class="d">-    #[should_panic(expected = &quot;Multiple leaders in term&quot;)]
</a><a href="#h4-2-121" id="h4-2-121" class="d">-    // Heartbeat from other leader should panic.
</a><a href="#h4-2-122" id="h4-2-122" class="d">-    fn step_heartbeat_fake_leader() {
</a><a href="#h4-2-123" id="h4-2-123" class="d">-        let (follower, _) = setup().unwrap();
</a><a href="#h4-2-124" id="h4-2-124" class="d">-        follower
</a><a href="#h4-2-125" id="h4-2-125" class="d">-            .step(Envelope {
</a><a href="#h4-2-126" id="h4-2-126" class="d">-                from: 3,
</a><a href="#h4-2-127" id="h4-2-127" class="d">-                to: 1,
</a><a href="#h4-2-128" id="h4-2-128" class="d">-                term: 3,
</a><a href="#h4-2-129" id="h4-2-129" class="d">-                message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h4-2-130" id="h4-2-130" class="d">-            })
</a><a href="#h4-2-131" id="h4-2-131" class="d">-            .unwrap();
</a><a href="#h4-2-132" id="h4-2-132" class="d">-    }
</a><a href="#h4-2-133" id="h4-2-133" class="d">-
</a><a href="#h4-2-134" id="h4-2-134" class="d">-    #[test]
</a><a href="#h4-2-135" id="h4-2-135" class="d">-    // Heartbeat when no current leader makes us follow the leader
</a><a href="#h4-2-136" id="h4-2-136" class="d">-    fn step_heartbeat_no_leader() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-137" id="h4-2-137" class="d">-        let (mut follower, mut node_rx) = setup()?;
</a><a href="#h4-2-138" id="h4-2-138" class="d">-        follower.role = Follower::new(None, None, follower.role.election_timeout);
</a><a href="#h4-2-139" id="h4-2-139" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-140" id="h4-2-140" class="d">-            from: 3,
</a><a href="#h4-2-141" id="h4-2-141" class="d">-            to: 1,
</a><a href="#h4-2-142" id="h4-2-142" class="d">-            term: 3,
</a><a href="#h4-2-143" id="h4-2-143" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-2-144" id="h4-2-144" class="d">-        })?;
</a><a href="#h4-2-145" id="h4-2-145" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(3)).voted_for(None).committed(3);
</a><a href="#h4-2-146" id="h4-2-146" class="d">-        assert_messages(
</a><a href="#h4-2-147" id="h4-2-147" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-148" id="h4-2-148" class="d">-            vec![Envelope {
</a><a href="#h4-2-149" id="h4-2-149" class="d">-                from: 1,
</a><a href="#h4-2-150" id="h4-2-150" class="d">-                to: 3,
</a><a href="#h4-2-151" id="h4-2-151" class="d">-                term: 3,
</a><a href="#h4-2-152" id="h4-2-152" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-153" id="h4-2-153" class="d">-            }],
</a><a href="#h4-2-154" id="h4-2-154" class="d">-        );
</a><a href="#h4-2-155" id="h4-2-155" class="d">-        Ok(())
</a><a href="#h4-2-156" id="h4-2-156" class="d">-    }
</a><a href="#h4-2-157" id="h4-2-157" class="d">-
</a><a href="#h4-2-158" id="h4-2-158" class="d">-    #[test]
</a><a href="#h4-2-159" id="h4-2-159" class="d">-    // Heartbeat from current leader with old commit_index
</a><a href="#h4-2-160" id="h4-2-160" class="d">-    fn step_heartbeat_old_commit_index() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-161" id="h4-2-161" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-162" id="h4-2-162" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-163" id="h4-2-163" class="d">-            from: 2,
</a><a href="#h4-2-164" id="h4-2-164" class="d">-            to: 1,
</a><a href="#h4-2-165" id="h4-2-165" class="d">-            term: 3,
</a><a href="#h4-2-166" id="h4-2-166" class="d">-            message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h4-2-167" id="h4-2-167" class="d">-        })?;
</a><a href="#h4-2-168" id="h4-2-168" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
</a><a href="#h4-2-169" id="h4-2-169" class="d">-        assert_messages(
</a><a href="#h4-2-170" id="h4-2-170" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-171" id="h4-2-171" class="d">-            vec![Envelope {
</a><a href="#h4-2-172" id="h4-2-172" class="d">-                from: 1,
</a><a href="#h4-2-173" id="h4-2-173" class="d">-                to: 2,
</a><a href="#h4-2-174" id="h4-2-174" class="d">-                term: 3,
</a><a href="#h4-2-175" id="h4-2-175" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-176" id="h4-2-176" class="d">-            }],
</a><a href="#h4-2-177" id="h4-2-177" class="d">-        );
</a><a href="#h4-2-178" id="h4-2-178" class="d">-        Ok(())
</a><a href="#h4-2-179" id="h4-2-179" class="d">-    }
</a><a href="#h4-2-180" id="h4-2-180" class="d">-
</a><a href="#h4-2-181" id="h4-2-181" class="d">-    #[test]
</a><a href="#h4-2-182" id="h4-2-182" class="d">-    // Heartbeat for future term with other leader changes leader
</a><a href="#h4-2-183" id="h4-2-183" class="d">-    fn step_heartbeat_future_term() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-184" id="h4-2-184" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-185" id="h4-2-185" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-186" id="h4-2-186" class="d">-            from: 3,
</a><a href="#h4-2-187" id="h4-2-187" class="d">-            to: 1,
</a><a href="#h4-2-188" id="h4-2-188" class="d">-            term: 4,
</a><a href="#h4-2-189" id="h4-2-189" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-2-190" id="h4-2-190" class="d">-        })?;
</a><a href="#h4-2-191" id="h4-2-191" class="d">-        assert_node(&amp;mut node).is_follower().term(4).leader(Some(3)).voted_for(None);
</a><a href="#h4-2-192" id="h4-2-192" class="d">-        assert_messages(
</a><a href="#h4-2-193" id="h4-2-193" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-194" id="h4-2-194" class="d">-            vec![Envelope {
</a><a href="#h4-2-195" id="h4-2-195" class="d">-                from: 1,
</a><a href="#h4-2-196" id="h4-2-196" class="d">-                to: 3,
</a><a href="#h4-2-197" id="h4-2-197" class="d">-                term: 4,
</a><a href="#h4-2-198" id="h4-2-198" class="d">-                message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 7 },
</a><a href="#h4-2-199" id="h4-2-199" class="d">-            }],
</a><a href="#h4-2-200" id="h4-2-200" class="d">-        );
</a><a href="#h4-2-201" id="h4-2-201" class="d">-        Ok(())
</a><a href="#h4-2-202" id="h4-2-202" class="d">-    }
</a><a href="#h4-2-203" id="h4-2-203" class="d">-
</a><a href="#h4-2-204" id="h4-2-204" class="d">-    #[test]
</a><a href="#h4-2-205" id="h4-2-205" class="d">-    // Heartbeat from past term
</a><a href="#h4-2-206" id="h4-2-206" class="d">-    fn step_heartbeat_past_term() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-207" id="h4-2-207" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-208" id="h4-2-208" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-209" id="h4-2-209" class="d">-            from: 2,
</a><a href="#h4-2-210" id="h4-2-210" class="d">-            to: 1,
</a><a href="#h4-2-211" id="h4-2-211" class="d">-            term: 2,
</a><a href="#h4-2-212" id="h4-2-212" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-2-213" id="h4-2-213" class="d">-        })?;
</a><a href="#h4-2-214" id="h4-2-214" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
</a><a href="#h4-2-215" id="h4-2-215" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h4-2-216" id="h4-2-216" class="d">-        Ok(())
</a><a href="#h4-2-217" id="h4-2-217" class="d">-    }
</a><a href="#h4-2-218" id="h4-2-218" class="d">-
</a><a href="#h4-2-219" id="h4-2-219" class="d">-    #[test]
</a><a href="#h4-2-220" id="h4-2-220" class="d">-    // SolicitVote is granted for the first solicitor, otherwise ignored.
</a><a href="#h4-2-221" id="h4-2-221" class="d">-    fn step_solicitvote() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-222" id="h4-2-222" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-223" id="h4-2-223" class="d">-
</a><a href="#h4-2-224" id="h4-2-224" class="d">-        // The first vote request in this term yields a vote response.
</a><a href="#h4-2-225" id="h4-2-225" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-226" id="h4-2-226" class="d">-            from: 3,
</a><a href="#h4-2-227" id="h4-2-227" class="d">-            to: 1,
</a><a href="#h4-2-228" id="h4-2-228" class="d">-            term: 3,
</a><a href="#h4-2-229" id="h4-2-229" class="d">-            message: Message::Campaign { last_index: 3, last_term: 2 },
</a><a href="#h4-2-230" id="h4-2-230" class="d">-        })?;
</a><a href="#h4-2-231" id="h4-2-231" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
</a><a href="#h4-2-232" id="h4-2-232" class="d">-        assert_messages(
</a><a href="#h4-2-233" id="h4-2-233" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-234" id="h4-2-234" class="d">-            vec![Envelope {
</a><a href="#h4-2-235" id="h4-2-235" class="d">-                from: 1,
</a><a href="#h4-2-236" id="h4-2-236" class="d">-                to: 3,
</a><a href="#h4-2-237" id="h4-2-237" class="d">-                term: 3,
</a><a href="#h4-2-238" id="h4-2-238" class="d">-                message: Message::CampaignResponse { vote: true },
</a><a href="#h4-2-239" id="h4-2-239" class="d">-            }],
</a><a href="#h4-2-240" id="h4-2-240" class="d">-        );
</a><a href="#h4-2-241" id="h4-2-241" class="d">-
</a><a href="#h4-2-242" id="h4-2-242" class="d">-        // Another vote request from the same sender is granted.
</a><a href="#h4-2-243" id="h4-2-243" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-244" id="h4-2-244" class="d">-            from: 3,
</a><a href="#h4-2-245" id="h4-2-245" class="d">-            to: 1,
</a><a href="#h4-2-246" id="h4-2-246" class="d">-            term: 3,
</a><a href="#h4-2-247" id="h4-2-247" class="d">-            message: Message::Campaign { last_index: 3, last_term: 2 },
</a><a href="#h4-2-248" id="h4-2-248" class="d">-        })?;
</a><a href="#h4-2-249" id="h4-2-249" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
</a><a href="#h4-2-250" id="h4-2-250" class="d">-        assert_messages(
</a><a href="#h4-2-251" id="h4-2-251" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-252" id="h4-2-252" class="d">-            vec![Envelope {
</a><a href="#h4-2-253" id="h4-2-253" class="d">-                from: 1,
</a><a href="#h4-2-254" id="h4-2-254" class="d">-                to: 3,
</a><a href="#h4-2-255" id="h4-2-255" class="d">-                term: 3,
</a><a href="#h4-2-256" id="h4-2-256" class="d">-                message: Message::CampaignResponse { vote: true },
</a><a href="#h4-2-257" id="h4-2-257" class="d">-            }],
</a><a href="#h4-2-258" id="h4-2-258" class="d">-        );
</a><a href="#h4-2-259" id="h4-2-259" class="d">-
</a><a href="#h4-2-260" id="h4-2-260" class="d">-        // But a vote request from a different node is ignored.
</a><a href="#h4-2-261" id="h4-2-261" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-262" id="h4-2-262" class="d">-            from: 4,
</a><a href="#h4-2-263" id="h4-2-263" class="d">-            to: 1,
</a><a href="#h4-2-264" id="h4-2-264" class="d">-            term: 3,
</a><a href="#h4-2-265" id="h4-2-265" class="d">-            message: Message::Campaign { last_index: 3, last_term: 2 },
</a><a href="#h4-2-266" id="h4-2-266" class="d">-        })?;
</a><a href="#h4-2-267" id="h4-2-267" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
</a><a href="#h4-2-268" id="h4-2-268" class="d">-        assert_messages(
</a><a href="#h4-2-269" id="h4-2-269" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-270" id="h4-2-270" class="d">-            vec![Envelope {
</a><a href="#h4-2-271" id="h4-2-271" class="d">-                from: 1,
</a><a href="#h4-2-272" id="h4-2-272" class="d">-                to: 4,
</a><a href="#h4-2-273" id="h4-2-273" class="d">-                term: 3,
</a><a href="#h4-2-274" id="h4-2-274" class="d">-                message: Message::CampaignResponse { vote: false },
</a><a href="#h4-2-275" id="h4-2-275" class="d">-            }],
</a><a href="#h4-2-276" id="h4-2-276" class="d">-        );
</a><a href="#h4-2-277" id="h4-2-277" class="d">-        Ok(())
</a><a href="#h4-2-278" id="h4-2-278" class="d">-    }
</a><a href="#h4-2-279" id="h4-2-279" class="d">-
</a><a href="#h4-2-280" id="h4-2-280" class="d">-    #[test]
</a><a href="#h4-2-281" id="h4-2-281" class="d">-    // Vote messages are ignored.
</a><a href="#h4-2-282" id="h4-2-282" class="d">-    fn step_grantvote_noop() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-283" id="h4-2-283" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-284" id="h4-2-284" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-285" id="h4-2-285" class="d">-            from: 2,
</a><a href="#h4-2-286" id="h4-2-286" class="d">-            to: 1,
</a><a href="#h4-2-287" id="h4-2-287" class="d">-            term: 3,
</a><a href="#h4-2-288" id="h4-2-288" class="d">-            message: Message::CampaignResponse { vote: true },
</a><a href="#h4-2-289" id="h4-2-289" class="d">-        })?;
</a><a href="#h4-2-290" id="h4-2-290" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
</a><a href="#h4-2-291" id="h4-2-291" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h4-2-292" id="h4-2-292" class="d">-        Ok(())
</a><a href="#h4-2-293" id="h4-2-293" class="d">-    }
</a><a href="#h4-2-294" id="h4-2-294" class="d">-
</a><a href="#h4-2-295" id="h4-2-295" class="d">-    #[test]
</a><a href="#h4-2-296" id="h4-2-296" class="d">-    // SolicitVote is rejected if last_index is outdated.
</a><a href="#h4-2-297" id="h4-2-297" class="d">-    fn step_solicitvote_last_index_outdated() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-298" id="h4-2-298" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-299" id="h4-2-299" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-300" id="h4-2-300" class="d">-            from: 3,
</a><a href="#h4-2-301" id="h4-2-301" class="d">-            to: 1,
</a><a href="#h4-2-302" id="h4-2-302" class="d">-            term: 3,
</a><a href="#h4-2-303" id="h4-2-303" class="d">-            message: Message::Campaign { last_index: 2, last_term: 2 },
</a><a href="#h4-2-304" id="h4-2-304" class="d">-        })?;
</a><a href="#h4-2-305" id="h4-2-305" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
</a><a href="#h4-2-306" id="h4-2-306" class="d">-        assert_messages(
</a><a href="#h4-2-307" id="h4-2-307" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-308" id="h4-2-308" class="d">-            vec![Envelope {
</a><a href="#h4-2-309" id="h4-2-309" class="d">-                from: 1,
</a><a href="#h4-2-310" id="h4-2-310" class="d">-                to: 3,
</a><a href="#h4-2-311" id="h4-2-311" class="d">-                term: 3,
</a><a href="#h4-2-312" id="h4-2-312" class="d">-                message: Message::CampaignResponse { vote: false },
</a><a href="#h4-2-313" id="h4-2-313" class="d">-            }],
</a><a href="#h4-2-314" id="h4-2-314" class="d">-        );
</a><a href="#h4-2-315" id="h4-2-315" class="d">-        Ok(())
</a><a href="#h4-2-316" id="h4-2-316" class="d">-    }
</a><a href="#h4-2-317" id="h4-2-317" class="d">-
</a><a href="#h4-2-318" id="h4-2-318" class="d">-    #[test]
</a><a href="#h4-2-319" id="h4-2-319" class="d">-    // SolicitVote is rejected if last_term is outdated.
</a><a href="#h4-2-320" id="h4-2-320" class="d">-    fn step_solicitvote_last_term_outdated() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-321" id="h4-2-321" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-322" id="h4-2-322" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-323" id="h4-2-323" class="d">-            from: 3,
</a><a href="#h4-2-324" id="h4-2-324" class="d">-            to: 1,
</a><a href="#h4-2-325" id="h4-2-325" class="d">-            term: 3,
</a><a href="#h4-2-326" id="h4-2-326" class="d">-            message: Message::Campaign { last_index: 3, last_term: 1 },
</a><a href="#h4-2-327" id="h4-2-327" class="d">-        })?;
</a><a href="#h4-2-328" id="h4-2-328" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
</a><a href="#h4-2-329" id="h4-2-329" class="d">-        assert_messages(
</a><a href="#h4-2-330" id="h4-2-330" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-331" id="h4-2-331" class="d">-            vec![Envelope {
</a><a href="#h4-2-332" id="h4-2-332" class="d">-                from: 1,
</a><a href="#h4-2-333" id="h4-2-333" class="d">-                to: 3,
</a><a href="#h4-2-334" id="h4-2-334" class="d">-                term: 3,
</a><a href="#h4-2-335" id="h4-2-335" class="d">-                message: Message::CampaignResponse { vote: false },
</a><a href="#h4-2-336" id="h4-2-336" class="d">-            }],
</a><a href="#h4-2-337" id="h4-2-337" class="d">-        );
</a><a href="#h4-2-338" id="h4-2-338" class="d">-        Ok(())
</a><a href="#h4-2-339" id="h4-2-339" class="d">-    }
</a><a href="#h4-2-340" id="h4-2-340" class="d">-
</a><a href="#h4-2-341" id="h4-2-341" class="d">-    #[test]
</a><a href="#h4-2-342" id="h4-2-342" class="d">-    // AppendEntries accepts some entries at base 0 without changes
</a><a href="#h4-2-343" id="h4-2-343" class="d">-    fn step_appendentries_base0() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-344" id="h4-2-344" class="d">-        // TODO: Move this into a setup function.
</a><a href="#h4-2-345" id="h4-2-345" class="d">-        let (node_tx, mut node_rx) = crossbeam::channel::unbounded();
</a><a href="#h4-2-346" id="h4-2-346" class="d">-        let mut log = Log::new(storage::Memory::new(), false)?;
</a><a href="#h4-2-347" id="h4-2-347" class="d">-        log.append(1, Some(vec![0x01]))?;
</a><a href="#h4-2-348" id="h4-2-348" class="d">-        log.append(1, Some(vec![0x02]))?;
</a><a href="#h4-2-349" id="h4-2-349" class="d">-        log.append(2, Some(vec![0x03]))?;
</a><a href="#h4-2-350" id="h4-2-350" class="d">-        log.set_term(1, None)?;
</a><a href="#h4-2-351" id="h4-2-351" class="d">-
</a><a href="#h4-2-352" id="h4-2-352" class="d">-        let follower = RawNode {
</a><a href="#h4-2-353" id="h4-2-353" class="d">-            id: 1,
</a><a href="#h4-2-354" id="h4-2-354" class="d">-            peers: HashSet::from([2, 3, 4, 5]),
</a><a href="#h4-2-355" id="h4-2-355" class="d">-            term: 1,
</a><a href="#h4-2-356" id="h4-2-356" class="d">-            log,
</a><a href="#h4-2-357" id="h4-2-357" class="d">-            state: Box::new(TestState::new(0)),
</a><a href="#h4-2-358" id="h4-2-358" class="d">-            node_tx,
</a><a href="#h4-2-359" id="h4-2-359" class="d">-            heartbeat_interval: HEARTBEAT_INTERVAL,
</a><a href="#h4-2-360" id="h4-2-360" class="d">-            election_timeout_range: ELECTION_TIMEOUT_RANGE,
</a><a href="#h4-2-361" id="h4-2-361" class="d">-            role: Follower::new(
</a><a href="#h4-2-362" id="h4-2-362" class="d">-                Some(2),
</a><a href="#h4-2-363" id="h4-2-363" class="d">-                None,
</a><a href="#h4-2-364" id="h4-2-364" class="d">-                rand::thread_rng().gen_range(ELECTION_TIMEOUT_RANGE),
</a><a href="#h4-2-365" id="h4-2-365" class="d">-            ),
</a><a href="#h4-2-366" id="h4-2-366" class="d">-        };
</a><a href="#h4-2-367" id="h4-2-367" class="d">-
</a><a href="#h4-2-368" id="h4-2-368" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-369" id="h4-2-369" class="d">-            from: 2,
</a><a href="#h4-2-370" id="h4-2-370" class="d">-            to: 1,
</a><a href="#h4-2-371" id="h4-2-371" class="d">-            term: 3,
</a><a href="#h4-2-372" id="h4-2-372" class="d">-            message: Message::Append {
</a><a href="#h4-2-373" id="h4-2-373" class="d">-                base_index: 0,
</a><a href="#h4-2-374" id="h4-2-374" class="d">-                base_term: 0,
</a><a href="#h4-2-375" id="h4-2-375" class="d">-                entries: vec![
</a><a href="#h4-2-376" id="h4-2-376" class="d">-                    Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-377" id="h4-2-377" class="d">-                    Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-378" id="h4-2-378" class="d">-                ],
</a><a href="#h4-2-379" id="h4-2-379" class="d">-            },
</a><a href="#h4-2-380" id="h4-2-380" class="d">-        })?;
</a><a href="#h4-2-381" id="h4-2-381" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-382" id="h4-2-382" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-383" id="h4-2-383" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-384" id="h4-2-384" class="d">-        ]);
</a><a href="#h4-2-385" id="h4-2-385" class="d">-        assert_messages(
</a><a href="#h4-2-386" id="h4-2-386" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-387" id="h4-2-387" class="d">-            vec![Envelope {
</a><a href="#h4-2-388" id="h4-2-388" class="d">-                from: 1,
</a><a href="#h4-2-389" id="h4-2-389" class="d">-                to: 2,
</a><a href="#h4-2-390" id="h4-2-390" class="d">-                term: 3,
</a><a href="#h4-2-391" id="h4-2-391" class="d">-                message: Message::AppendResponse { reject: false, last_index: 2, last_term: 1 },
</a><a href="#h4-2-392" id="h4-2-392" class="d">-            }],
</a><a href="#h4-2-393" id="h4-2-393" class="d">-        );
</a><a href="#h4-2-394" id="h4-2-394" class="d">-        Ok(())
</a><a href="#h4-2-395" id="h4-2-395" class="d">-    }
</a><a href="#h4-2-396" id="h4-2-396" class="d">-
</a><a href="#h4-2-397" id="h4-2-397" class="d">-    #[test]
</a><a href="#h4-2-398" id="h4-2-398" class="d">-    // AppendEntries appends entries but does not commit them
</a><a href="#h4-2-399" id="h4-2-399" class="d">-    fn step_appendentries_append() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-400" id="h4-2-400" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-401" id="h4-2-401" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-402" id="h4-2-402" class="d">-            from: 2,
</a><a href="#h4-2-403" id="h4-2-403" class="d">-            to: 1,
</a><a href="#h4-2-404" id="h4-2-404" class="d">-            term: 3,
</a><a href="#h4-2-405" id="h4-2-405" class="d">-            message: Message::Append {
</a><a href="#h4-2-406" id="h4-2-406" class="d">-                base_index: 3,
</a><a href="#h4-2-407" id="h4-2-407" class="d">-                base_term: 2,
</a><a href="#h4-2-408" id="h4-2-408" class="d">-                entries: vec![
</a><a href="#h4-2-409" id="h4-2-409" class="d">-                    Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-410" id="h4-2-410" class="d">-                    Entry { index: 5, term: 3, command: Some(vec![0x05]) },
</a><a href="#h4-2-411" id="h4-2-411" class="d">-                ],
</a><a href="#h4-2-412" id="h4-2-412" class="d">-            },
</a><a href="#h4-2-413" id="h4-2-413" class="d">-        })?;
</a><a href="#h4-2-414" id="h4-2-414" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-415" id="h4-2-415" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-416" id="h4-2-416" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-417" id="h4-2-417" class="d">-            Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-418" id="h4-2-418" class="d">-            Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-419" id="h4-2-419" class="d">-            Entry { index: 5, term: 3, command: Some(vec![0x05]) },
</a><a href="#h4-2-420" id="h4-2-420" class="d">-        ]);
</a><a href="#h4-2-421" id="h4-2-421" class="d">-        assert_messages(
</a><a href="#h4-2-422" id="h4-2-422" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-423" id="h4-2-423" class="d">-            vec![Envelope {
</a><a href="#h4-2-424" id="h4-2-424" class="d">-                from: 1,
</a><a href="#h4-2-425" id="h4-2-425" class="d">-                to: 2,
</a><a href="#h4-2-426" id="h4-2-426" class="d">-                term: 3,
</a><a href="#h4-2-427" id="h4-2-427" class="d">-                message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a><a href="#h4-2-428" id="h4-2-428" class="d">-            }],
</a><a href="#h4-2-429" id="h4-2-429" class="d">-        );
</a><a href="#h4-2-430" id="h4-2-430" class="d">-        Ok(())
</a><a href="#h4-2-431" id="h4-2-431" class="d">-    }
</a><a href="#h4-2-432" id="h4-2-432" class="d">-
</a><a href="#h4-2-433" id="h4-2-433" class="d">-    #[test]
</a><a href="#h4-2-434" id="h4-2-434" class="d">-    // AppendEntries accepts partially overlapping entries
</a><a href="#h4-2-435" id="h4-2-435" class="d">-    fn step_appendentries_partial_overlap() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-436" id="h4-2-436" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-437" id="h4-2-437" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-438" id="h4-2-438" class="d">-            from: 2,
</a><a href="#h4-2-439" id="h4-2-439" class="d">-            to: 1,
</a><a href="#h4-2-440" id="h4-2-440" class="d">-            term: 3,
</a><a href="#h4-2-441" id="h4-2-441" class="d">-            message: Message::Append {
</a><a href="#h4-2-442" id="h4-2-442" class="d">-                base_index: 1,
</a><a href="#h4-2-443" id="h4-2-443" class="d">-                base_term: 1,
</a><a href="#h4-2-444" id="h4-2-444" class="d">-                entries: vec![
</a><a href="#h4-2-445" id="h4-2-445" class="d">-                    Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-446" id="h4-2-446" class="d">-                    Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-447" id="h4-2-447" class="d">-                ],
</a><a href="#h4-2-448" id="h4-2-448" class="d">-            },
</a><a href="#h4-2-449" id="h4-2-449" class="d">-        })?;
</a><a href="#h4-2-450" id="h4-2-450" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-451" id="h4-2-451" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-452" id="h4-2-452" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-453" id="h4-2-453" class="d">-            Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-454" id="h4-2-454" class="d">-            Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-455" id="h4-2-455" class="d">-        ]);
</a><a href="#h4-2-456" id="h4-2-456" class="d">-        assert_messages(
</a><a href="#h4-2-457" id="h4-2-457" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-458" id="h4-2-458" class="d">-            vec![Envelope {
</a><a href="#h4-2-459" id="h4-2-459" class="d">-                from: 1,
</a><a href="#h4-2-460" id="h4-2-460" class="d">-                to: 2,
</a><a href="#h4-2-461" id="h4-2-461" class="d">-                term: 3,
</a><a href="#h4-2-462" id="h4-2-462" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a><a href="#h4-2-463" id="h4-2-463" class="d">-            }],
</a><a href="#h4-2-464" id="h4-2-464" class="d">-        );
</a><a href="#h4-2-465" id="h4-2-465" class="d">-        Ok(())
</a><a href="#h4-2-466" id="h4-2-466" class="d">-    }
</a><a href="#h4-2-467" id="h4-2-467" class="d">-
</a><a href="#h4-2-468" id="h4-2-468" class="d">-    #[test]
</a><a href="#h4-2-469" id="h4-2-469" class="d">-    // AppendEntries replaces conflicting entries
</a><a href="#h4-2-470" id="h4-2-470" class="d">-    fn step_appendentries_replace() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-471" id="h4-2-471" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-472" id="h4-2-472" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-473" id="h4-2-473" class="d">-            from: 2,
</a><a href="#h4-2-474" id="h4-2-474" class="d">-            to: 1,
</a><a href="#h4-2-475" id="h4-2-475" class="d">-            term: 3,
</a><a href="#h4-2-476" id="h4-2-476" class="d">-            message: Message::Append {
</a><a href="#h4-2-477" id="h4-2-477" class="d">-                base_index: 2,
</a><a href="#h4-2-478" id="h4-2-478" class="d">-                base_term: 1,
</a><a href="#h4-2-479" id="h4-2-479" class="d">-                entries: vec![
</a><a href="#h4-2-480" id="h4-2-480" class="d">-                    Entry { index: 3, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-481" id="h4-2-481" class="d">-                    Entry { index: 4, term: 3, command: Some(vec![0x05]) },
</a><a href="#h4-2-482" id="h4-2-482" class="d">-                ],
</a><a href="#h4-2-483" id="h4-2-483" class="d">-            },
</a><a href="#h4-2-484" id="h4-2-484" class="d">-        })?;
</a><a href="#h4-2-485" id="h4-2-485" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-486" id="h4-2-486" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-487" id="h4-2-487" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-488" id="h4-2-488" class="d">-            Entry { index: 3, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-489" id="h4-2-489" class="d">-            Entry { index: 4, term: 3, command: Some(vec![0x05]) },
</a><a href="#h4-2-490" id="h4-2-490" class="d">-        ]);
</a><a href="#h4-2-491" id="h4-2-491" class="d">-        assert_messages(
</a><a href="#h4-2-492" id="h4-2-492" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-493" id="h4-2-493" class="d">-            vec![Envelope {
</a><a href="#h4-2-494" id="h4-2-494" class="d">-                from: 1,
</a><a href="#h4-2-495" id="h4-2-495" class="d">-                to: 2,
</a><a href="#h4-2-496" id="h4-2-496" class="d">-                term: 3,
</a><a href="#h4-2-497" id="h4-2-497" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a><a href="#h4-2-498" id="h4-2-498" class="d">-            }],
</a><a href="#h4-2-499" id="h4-2-499" class="d">-        );
</a><a href="#h4-2-500" id="h4-2-500" class="d">-        Ok(())
</a><a href="#h4-2-501" id="h4-2-501" class="d">-    }
</a><a href="#h4-2-502" id="h4-2-502" class="d">-
</a><a href="#h4-2-503" id="h4-2-503" class="d">-    #[test]
</a><a href="#h4-2-504" id="h4-2-504" class="d">-    // AppendEntries replaces partially conflicting entries
</a><a href="#h4-2-505" id="h4-2-505" class="d">-    fn step_appendentries_replace_partial() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-506" id="h4-2-506" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-507" id="h4-2-507" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-508" id="h4-2-508" class="d">-            from: 2,
</a><a href="#h4-2-509" id="h4-2-509" class="d">-            to: 1,
</a><a href="#h4-2-510" id="h4-2-510" class="d">-            term: 3,
</a><a href="#h4-2-511" id="h4-2-511" class="d">-            message: Message::Append {
</a><a href="#h4-2-512" id="h4-2-512" class="d">-                base_index: 2,
</a><a href="#h4-2-513" id="h4-2-513" class="d">-                base_term: 1,
</a><a href="#h4-2-514" id="h4-2-514" class="d">-                entries: vec![
</a><a href="#h4-2-515" id="h4-2-515" class="d">-                    Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-516" id="h4-2-516" class="d">-                    Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-517" id="h4-2-517" class="d">-                ],
</a><a href="#h4-2-518" id="h4-2-518" class="d">-            },
</a><a href="#h4-2-519" id="h4-2-519" class="d">-        })?;
</a><a href="#h4-2-520" id="h4-2-520" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-521" id="h4-2-521" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-522" id="h4-2-522" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-523" id="h4-2-523" class="d">-            Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-524" id="h4-2-524" class="d">-            Entry { index: 4, term: 3, command: Some(vec![0x04]) },
</a><a href="#h4-2-525" id="h4-2-525" class="d">-        ]);
</a><a href="#h4-2-526" id="h4-2-526" class="d">-        assert_messages(
</a><a href="#h4-2-527" id="h4-2-527" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-528" id="h4-2-528" class="d">-            vec![Envelope {
</a><a href="#h4-2-529" id="h4-2-529" class="d">-                from: 1,
</a><a href="#h4-2-530" id="h4-2-530" class="d">-                to: 2,
</a><a href="#h4-2-531" id="h4-2-531" class="d">-                term: 3,
</a><a href="#h4-2-532" id="h4-2-532" class="d">-                message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a><a href="#h4-2-533" id="h4-2-533" class="d">-            }],
</a><a href="#h4-2-534" id="h4-2-534" class="d">-        );
</a><a href="#h4-2-535" id="h4-2-535" class="d">-        Ok(())
</a><a href="#h4-2-536" id="h4-2-536" class="d">-    }
</a><a href="#h4-2-537" id="h4-2-537" class="d">-
</a><a href="#h4-2-538" id="h4-2-538" class="d">-    #[test]
</a><a href="#h4-2-539" id="h4-2-539" class="d">-    // AppendEntries rejects missing base index
</a><a href="#h4-2-540" id="h4-2-540" class="d">-    fn step_appendentries_reject_missing_base_index() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-541" id="h4-2-541" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-542" id="h4-2-542" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-543" id="h4-2-543" class="d">-            from: 2,
</a><a href="#h4-2-544" id="h4-2-544" class="d">-            to: 1,
</a><a href="#h4-2-545" id="h4-2-545" class="d">-            term: 3,
</a><a href="#h4-2-546" id="h4-2-546" class="d">-            message: Message::Append {
</a><a href="#h4-2-547" id="h4-2-547" class="d">-                base_index: 5,
</a><a href="#h4-2-548" id="h4-2-548" class="d">-                base_term: 2,
</a><a href="#h4-2-549" id="h4-2-549" class="d">-                entries: vec![Entry { index: 6, term: 3, command: Some(vec![0x04]) }],
</a><a href="#h4-2-550" id="h4-2-550" class="d">-            },
</a><a href="#h4-2-551" id="h4-2-551" class="d">-        })?;
</a><a href="#h4-2-552" id="h4-2-552" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-553" id="h4-2-553" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-554" id="h4-2-554" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-555" id="h4-2-555" class="d">-            Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-556" id="h4-2-556" class="d">-        ]);
</a><a href="#h4-2-557" id="h4-2-557" class="d">-        assert_messages(
</a><a href="#h4-2-558" id="h4-2-558" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-559" id="h4-2-559" class="d">-            vec![Envelope {
</a><a href="#h4-2-560" id="h4-2-560" class="d">-                from: 1,
</a><a href="#h4-2-561" id="h4-2-561" class="d">-                to: 2,
</a><a href="#h4-2-562" id="h4-2-562" class="d">-                term: 3,
</a><a href="#h4-2-563" id="h4-2-563" class="d">-                message: Message::AppendResponse { reject: true, last_index: 3, last_term: 2 },
</a><a href="#h4-2-564" id="h4-2-564" class="d">-            }],
</a><a href="#h4-2-565" id="h4-2-565" class="d">-        );
</a><a href="#h4-2-566" id="h4-2-566" class="d">-        Ok(())
</a><a href="#h4-2-567" id="h4-2-567" class="d">-    }
</a><a href="#h4-2-568" id="h4-2-568" class="d">-
</a><a href="#h4-2-569" id="h4-2-569" class="d">-    #[test]
</a><a href="#h4-2-570" id="h4-2-570" class="d">-    // AppendEntries rejects conflicting base term
</a><a href="#h4-2-571" id="h4-2-571" class="d">-    fn step_appendentries_reject_missing_base_term() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-572" id="h4-2-572" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-573" id="h4-2-573" class="d">-        let mut node = follower.step(Envelope {
</a><a href="#h4-2-574" id="h4-2-574" class="d">-            from: 2,
</a><a href="#h4-2-575" id="h4-2-575" class="d">-            to: 1,
</a><a href="#h4-2-576" id="h4-2-576" class="d">-            term: 3,
</a><a href="#h4-2-577" id="h4-2-577" class="d">-            message: Message::Append {
</a><a href="#h4-2-578" id="h4-2-578" class="d">-                base_index: 1,
</a><a href="#h4-2-579" id="h4-2-579" class="d">-                base_term: 2,
</a><a href="#h4-2-580" id="h4-2-580" class="d">-                entries: vec![Entry { index: 2, term: 3, command: Some(vec![0x04]) }],
</a><a href="#h4-2-581" id="h4-2-581" class="d">-            },
</a><a href="#h4-2-582" id="h4-2-582" class="d">-        })?;
</a><a href="#h4-2-583" id="h4-2-583" class="d">-        assert_node(&amp;mut node).is_follower().term(3).entries(vec![
</a><a href="#h4-2-584" id="h4-2-584" class="d">-            Entry { index: 1, term: 1, command: Some(vec![0x01]) },
</a><a href="#h4-2-585" id="h4-2-585" class="d">-            Entry { index: 2, term: 1, command: Some(vec![0x02]) },
</a><a href="#h4-2-586" id="h4-2-586" class="d">-            Entry { index: 3, term: 2, command: Some(vec![0x03]) },
</a><a href="#h4-2-587" id="h4-2-587" class="d">-        ]);
</a><a href="#h4-2-588" id="h4-2-588" class="d">-        assert_messages(
</a><a href="#h4-2-589" id="h4-2-589" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-590" id="h4-2-590" class="d">-            vec![Envelope {
</a><a href="#h4-2-591" id="h4-2-591" class="d">-                from: 1,
</a><a href="#h4-2-592" id="h4-2-592" class="d">-                to: 2,
</a><a href="#h4-2-593" id="h4-2-593" class="d">-                term: 3,
</a><a href="#h4-2-594" id="h4-2-594" class="d">-                message: Message::AppendResponse { reject: true, last_index: 3, last_term: 2 },
</a><a href="#h4-2-595" id="h4-2-595" class="d">-            }],
</a><a href="#h4-2-596" id="h4-2-596" class="d">-        );
</a><a href="#h4-2-597" id="h4-2-597" class="d">-        Ok(())
</a><a href="#h4-2-598" id="h4-2-598" class="d">-    }
</a><a href="#h4-2-599" id="h4-2-599" class="d">-
</a><a href="#h4-2-600" id="h4-2-600" class="d">-    #[test]
</a><a href="#h4-2-601" id="h4-2-601" class="d">-    // ClientRequest is forwarded, as is the response.
</a><a href="#h4-2-602" id="h4-2-602" class="d">-    fn step_clientrequest_clientresponse() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-603" id="h4-2-603" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-604" id="h4-2-604" class="d">-        let mut node = Node::Follower(follower);
</a><a href="#h4-2-605" id="h4-2-605" class="d">-
</a><a href="#h4-2-606" id="h4-2-606" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-607" id="h4-2-607" class="d">-            from: 1,
</a><a href="#h4-2-608" id="h4-2-608" class="d">-            to: 1,
</a><a href="#h4-2-609" id="h4-2-609" class="d">-            term: 3,
</a><a href="#h4-2-610" id="h4-2-610" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Write(vec![0xaf]) },
</a><a href="#h4-2-611" id="h4-2-611" class="d">-        })?;
</a><a href="#h4-2-612" id="h4-2-612" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![vec![0x01]]);
</a><a href="#h4-2-613" id="h4-2-613" class="d">-        assert_messages(
</a><a href="#h4-2-614" id="h4-2-614" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-615" id="h4-2-615" class="d">-            vec![Envelope {
</a><a href="#h4-2-616" id="h4-2-616" class="d">-                from: 1,
</a><a href="#h4-2-617" id="h4-2-617" class="d">-                to: 2,
</a><a href="#h4-2-618" id="h4-2-618" class="d">-                term: 3,
</a><a href="#h4-2-619" id="h4-2-619" class="d">-                message: Message::ClientRequest {
</a><a href="#h4-2-620" id="h4-2-620" class="d">-                    id: vec![0x01],
</a><a href="#h4-2-621" id="h4-2-621" class="d">-                    request: Request::Write(vec![0xaf]),
</a><a href="#h4-2-622" id="h4-2-622" class="d">-                },
</a><a href="#h4-2-623" id="h4-2-623" class="d">-            }],
</a><a href="#h4-2-624" id="h4-2-624" class="d">-        );
</a><a href="#h4-2-625" id="h4-2-625" class="d">-
</a><a href="#h4-2-626" id="h4-2-626" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-627" id="h4-2-627" class="d">-            from: 2,
</a><a href="#h4-2-628" id="h4-2-628" class="d">-            to: 1,
</a><a href="#h4-2-629" id="h4-2-629" class="d">-            term: 3,
</a><a href="#h4-2-630" id="h4-2-630" class="d">-            message: Message::ClientResponse {
</a><a href="#h4-2-631" id="h4-2-631" class="d">-                id: vec![0x01],
</a><a href="#h4-2-632" id="h4-2-632" class="d">-                response: Ok(Response::Write(vec![0xaf])),
</a><a href="#h4-2-633" id="h4-2-633" class="d">-            },
</a><a href="#h4-2-634" id="h4-2-634" class="d">-        })?;
</a><a href="#h4-2-635" id="h4-2-635" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![]);
</a><a href="#h4-2-636" id="h4-2-636" class="d">-        assert_messages(
</a><a href="#h4-2-637" id="h4-2-637" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-638" id="h4-2-638" class="d">-            vec![Envelope {
</a><a href="#h4-2-639" id="h4-2-639" class="d">-                from: 1,
</a><a href="#h4-2-640" id="h4-2-640" class="d">-                to: 1,
</a><a href="#h4-2-641" id="h4-2-641" class="d">-                term: 3,
</a><a href="#h4-2-642" id="h4-2-642" class="d">-                message: Message::ClientResponse {
</a><a href="#h4-2-643" id="h4-2-643" class="d">-                    id: vec![0x01],
</a><a href="#h4-2-644" id="h4-2-644" class="d">-                    response: Ok(Response::Write(vec![0xaf])),
</a><a href="#h4-2-645" id="h4-2-645" class="d">-                },
</a><a href="#h4-2-646" id="h4-2-646" class="d">-            }],
</a><a href="#h4-2-647" id="h4-2-647" class="d">-        );
</a><a href="#h4-2-648" id="h4-2-648" class="d">-        Ok(())
</a><a href="#h4-2-649" id="h4-2-649" class="d">-    }
</a><a href="#h4-2-650" id="h4-2-650" class="d">-
</a><a href="#h4-2-651" id="h4-2-651" class="d">-    #[test]
</a><a href="#h4-2-652" id="h4-2-652" class="d">-    // ClientRequest returns Error::Abort when there is no leader.
</a><a href="#h4-2-653" id="h4-2-653" class="d">-    fn step_clientrequest_no_leader() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-654" id="h4-2-654" class="d">-        let (mut follower, mut node_rx) = setup()?;
</a><a href="#h4-2-655" id="h4-2-655" class="d">-        follower.role = Follower::new(None, None, follower.role.election_timeout);
</a><a href="#h4-2-656" id="h4-2-656" class="d">-        let mut node = Node::Follower(follower);
</a><a href="#h4-2-657" id="h4-2-657" class="d">-
</a><a href="#h4-2-658" id="h4-2-658" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-659" id="h4-2-659" class="d">-            from: 1,
</a><a href="#h4-2-660" id="h4-2-660" class="d">-            to: 1,
</a><a href="#h4-2-661" id="h4-2-661" class="d">-            term: 3,
</a><a href="#h4-2-662" id="h4-2-662" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Write(vec![0xaf]) },
</a><a href="#h4-2-663" id="h4-2-663" class="d">-        })?;
</a><a href="#h4-2-664" id="h4-2-664" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(None).forwarded(vec![]);
</a><a href="#h4-2-665" id="h4-2-665" class="d">-        assert_messages(
</a><a href="#h4-2-666" id="h4-2-666" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-667" id="h4-2-667" class="d">-            vec![Envelope {
</a><a href="#h4-2-668" id="h4-2-668" class="d">-                from: 1,
</a><a href="#h4-2-669" id="h4-2-669" class="d">-                to: 1,
</a><a href="#h4-2-670" id="h4-2-670" class="d">-                term: 3,
</a><a href="#h4-2-671" id="h4-2-671" class="d">-                message: Message::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a><a href="#h4-2-672" id="h4-2-672" class="d">-            }],
</a><a href="#h4-2-673" id="h4-2-673" class="d">-        );
</a><a href="#h4-2-674" id="h4-2-674" class="d">-        Ok(())
</a><a href="#h4-2-675" id="h4-2-675" class="d">-    }
</a><a href="#h4-2-676" id="h4-2-676" class="d">-
</a><a href="#h4-2-677" id="h4-2-677" class="d">-    // ClientRequest is forwarded, but aborted when a new leader appears.
</a><a href="#h4-2-678" id="h4-2-678" class="d">-    #[test]
</a><a href="#h4-2-679" id="h4-2-679" class="d">-    fn step_clientrequest_aborted() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-680" id="h4-2-680" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-681" id="h4-2-681" class="d">-        let mut node = Node::Follower(follower);
</a><a href="#h4-2-682" id="h4-2-682" class="d">-
</a><a href="#h4-2-683" id="h4-2-683" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-684" id="h4-2-684" class="d">-            from: 1,
</a><a href="#h4-2-685" id="h4-2-685" class="d">-            to: 1,
</a><a href="#h4-2-686" id="h4-2-686" class="d">-            term: 3,
</a><a href="#h4-2-687" id="h4-2-687" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Write(vec![0xaf]) },
</a><a href="#h4-2-688" id="h4-2-688" class="d">-        })?;
</a><a href="#h4-2-689" id="h4-2-689" class="d">-        assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![vec![0x01]]);
</a><a href="#h4-2-690" id="h4-2-690" class="d">-        assert_messages(
</a><a href="#h4-2-691" id="h4-2-691" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-692" id="h4-2-692" class="d">-            vec![Envelope {
</a><a href="#h4-2-693" id="h4-2-693" class="d">-                from: 1,
</a><a href="#h4-2-694" id="h4-2-694" class="d">-                to: 2,
</a><a href="#h4-2-695" id="h4-2-695" class="d">-                term: 3,
</a><a href="#h4-2-696" id="h4-2-696" class="d">-                message: Message::ClientRequest {
</a><a href="#h4-2-697" id="h4-2-697" class="d">-                    id: vec![0x01],
</a><a href="#h4-2-698" id="h4-2-698" class="d">-                    request: Request::Write(vec![0xaf]),
</a><a href="#h4-2-699" id="h4-2-699" class="d">-                },
</a><a href="#h4-2-700" id="h4-2-700" class="d">-            }],
</a><a href="#h4-2-701" id="h4-2-701" class="d">-        );
</a><a href="#h4-2-702" id="h4-2-702" class="d">-
</a><a href="#h4-2-703" id="h4-2-703" class="d">-        // When a new leader appears, the proxied request is aborted.
</a><a href="#h4-2-704" id="h4-2-704" class="d">-        node = node.step(Envelope {
</a><a href="#h4-2-705" id="h4-2-705" class="d">-            from: 3,
</a><a href="#h4-2-706" id="h4-2-706" class="d">-            to: 1,
</a><a href="#h4-2-707" id="h4-2-707" class="d">-            term: 4,
</a><a href="#h4-2-708" id="h4-2-708" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-2-709" id="h4-2-709" class="d">-        })?;
</a><a href="#h4-2-710" id="h4-2-710" class="d">-        assert_node(&amp;mut node).is_follower().term(4).leader(Some(3)).forwarded(vec![]);
</a><a href="#h4-2-711" id="h4-2-711" class="d">-        assert_messages(
</a><a href="#h4-2-712" id="h4-2-712" class="d">-            &amp;mut node_rx,
</a><a href="#h4-2-713" id="h4-2-713" class="d">-            vec![
</a><a href="#h4-2-714" id="h4-2-714" class="d">-                Envelope {
</a><a href="#h4-2-715" id="h4-2-715" class="d">-                    from: 1,
</a><a href="#h4-2-716" id="h4-2-716" class="d">-                    to: 1,
</a><a href="#h4-2-717" id="h4-2-717" class="d">-                    term: 3,
</a><a href="#h4-2-718" id="h4-2-718" class="d">-                    message: Message::ClientResponse {
</a><a href="#h4-2-719" id="h4-2-719" class="d">-                        id: vec![0x01],
</a><a href="#h4-2-720" id="h4-2-720" class="d">-                        response: Err(Error::Abort),
</a><a href="#h4-2-721" id="h4-2-721" class="d">-                    },
</a><a href="#h4-2-722" id="h4-2-722" class="d">-                },
</a><a href="#h4-2-723" id="h4-2-723" class="d">-                Envelope {
</a><a href="#h4-2-724" id="h4-2-724" class="d">-                    from: 1,
</a><a href="#h4-2-725" id="h4-2-725" class="d">-                    to: 3,
</a><a href="#h4-2-726" id="h4-2-726" class="d">-                    term: 4,
</a><a href="#h4-2-727" id="h4-2-727" class="d">-                    message: Message::HeartbeatResponse {
</a><a href="#h4-2-728" id="h4-2-728" class="d">-                        last_index: 3,
</a><a href="#h4-2-729" id="h4-2-729" class="d">-                        last_term: 2,
</a><a href="#h4-2-730" id="h4-2-730" class="d">-                        read_seq: 7,
</a><a href="#h4-2-731" id="h4-2-731" class="d">-                    },
</a><a href="#h4-2-732" id="h4-2-732" class="d">-                },
</a><a href="#h4-2-733" id="h4-2-733" class="d">-            ],
</a><a href="#h4-2-734" id="h4-2-734" class="d">-        );
</a><a href="#h4-2-735" id="h4-2-735" class="d">-        Ok(())
</a><a href="#h4-2-736" id="h4-2-736" class="d">-    }
</a><a href="#h4-2-737" id="h4-2-737" class="d">-
</a><a href="#h4-2-738" id="h4-2-738" class="d">-    #[test]
</a><a href="#h4-2-739" id="h4-2-739" class="d">-    fn tick() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-740" id="h4-2-740" class="d">-        let (follower, mut node_rx) = setup()?;
</a><a href="#h4-2-741" id="h4-2-741" class="d">-        let peers = follower.peers.clone();
</a><a href="#h4-2-742" id="h4-2-742" class="d">-        let timeout = follower.role.election_timeout;
</a><a href="#h4-2-743" id="h4-2-743" class="d">-        let mut node = Node::Follower(follower);
</a><a href="#h4-2-744" id="h4-2-744" class="d">-
</a><a href="#h4-2-745" id="h4-2-745" class="d">-        // Make sure heartbeats reset election timeout
</a><a href="#h4-2-746" id="h4-2-746" class="d">-        assert!(timeout &gt; 0);
</a><a href="#h4-2-747" id="h4-2-747" class="d">-        for _ in 0..(3 * timeout) {
</a><a href="#h4-2-748" id="h4-2-748" class="d">-            assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
</a><a href="#h4-2-749" id="h4-2-749" class="d">-            node = node.tick()?;
</a><a href="#h4-2-750" id="h4-2-750" class="d">-            node = node.step(Envelope {
</a><a href="#h4-2-751" id="h4-2-751" class="d">-                from: 2,
</a><a href="#h4-2-752" id="h4-2-752" class="d">-                to: 1,
</a><a href="#h4-2-753" id="h4-2-753" class="d">-                term: 3,
</a><a href="#h4-2-754" id="h4-2-754" class="d">-                message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h4-2-755" id="h4-2-755" class="d">-            })?;
</a><a href="#h4-2-756" id="h4-2-756" class="d">-            assert_messages(
</a><a href="#h4-2-757" id="h4-2-757" class="d">-                &amp;mut node_rx,
</a><a href="#h4-2-758" id="h4-2-758" class="d">-                vec![Envelope {
</a><a href="#h4-2-759" id="h4-2-759" class="d">-                    from: 1,
</a><a href="#h4-2-760" id="h4-2-760" class="d">-                    to: 2,
</a><a href="#h4-2-761" id="h4-2-761" class="d">-                    term: 3,
</a><a href="#h4-2-762" id="h4-2-762" class="d">-                    message: Message::HeartbeatResponse {
</a><a href="#h4-2-763" id="h4-2-763" class="d">-                        last_index: 3,
</a><a href="#h4-2-764" id="h4-2-764" class="d">-                        last_term: 2,
</a><a href="#h4-2-765" id="h4-2-765" class="d">-                        read_seq: 7,
</a><a href="#h4-2-766" id="h4-2-766" class="d">-                    },
</a><a href="#h4-2-767" id="h4-2-767" class="d">-                }],
</a><a href="#h4-2-768" id="h4-2-768" class="d">-            )
</a><a href="#h4-2-769" id="h4-2-769" class="d">-        }
</a><a href="#h4-2-770" id="h4-2-770" class="d">-
</a><a href="#h4-2-771" id="h4-2-771" class="d">-        for _ in 0..timeout {
</a><a href="#h4-2-772" id="h4-2-772" class="d">-            assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
</a><a href="#h4-2-773" id="h4-2-773" class="d">-            node = node.tick()?;
</a><a href="#h4-2-774" id="h4-2-774" class="d">-        }
</a><a href="#h4-2-775" id="h4-2-775" class="d">-        assert_node(&amp;mut node).is_candidate().term(4);
</a><a href="#h4-2-776" id="h4-2-776" class="d">-
</a><a href="#h4-2-777" id="h4-2-777" class="d">-        for to in peers.iter().copied().sorted() {
</a><a href="#h4-2-778" id="h4-2-778" class="d">-            assert_eq!(
</a><a href="#h4-2-779" id="h4-2-779" class="d">-                node_rx.try_recv()?,
</a><a href="#h4-2-780" id="h4-2-780" class="d">-                Envelope {
</a><a href="#h4-2-781" id="h4-2-781" class="d">-                    from: 1,
</a><a href="#h4-2-782" id="h4-2-782" class="d">-                    to,
</a><a href="#h4-2-783" id="h4-2-783" class="d">-                    term: 4,
</a><a href="#h4-2-784" id="h4-2-784" class="d">-                    message: Message::Campaign { last_index: 3, last_term: 2 },
</a><a href="#h4-2-785" id="h4-2-785" class="d">-                },
</a><a href="#h4-2-786" id="h4-2-786" class="d">-            );
</a><a href="#h4-2-787" id="h4-2-787" class="d">-        }
</a><a href="#h4-2-788" id="h4-2-788" class="d">-        Ok(())
</a><a href="#h4-2-789" id="h4-2-789" class="d">-    }
</a><a href="#h4-2-790" id="h4-2-790" class="d">-}
</a><b>diff --git a/<a id="h5" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -8,13 +8,16 @@ use std::collections::{HashMap, HashSet, VecDeque};
</a> 
 /// Peer replication progress.
 #[derive(Clone, Debug, PartialEq)]
<a href="#h5-0-3" id="h5-0-3" class="d">-struct Progress {
</a><a href="#h5-0-4" id="h5-0-4" class="i">+pub(super) struct Progress {
</a>     /// The next index to replicate to the peer.
<a href="#h5-0-6" id="h5-0-6" class="d">-    next: Index,
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    pub(super) next: Index,
</a>     /// The last index known to be replicated to the peer.
<a href="#h5-0-9" id="h5-0-9" class="d">-    last: Index,
</a><a href="#h5-0-10" id="h5-0-10" class="i">+    ///
</a><a href="#h5-0-11" id="h5-0-11" class="i">+    /// TODO: rename to match. It needs to track the position where the
</a><a href="#h5-0-12" id="h5-0-12" class="i">+    /// follower&#39;s log matches the leader&#39;s, not its last position.
</a><a href="#h5-0-13" id="h5-0-13" class="i">+    pub(super) last: Index,
</a>     /// The last read sequence number confirmed by the peer.
<a href="#h5-0-15" id="h5-0-15" class="d">-    read_seq: ReadSequence,
</a><a href="#h5-0-16" id="h5-0-16" class="i">+    pub(super) read_seq: ReadSequence,
</a> }
 
 /// A pending client write request.
<a href="#h5-1" id="h5-1" class="h">@@ -43,7 +46,7 @@ struct Read {
</a> #[derive(Clone, Debug, PartialEq)]
 pub struct Leader {
     /// Peer replication progress.
<a href="#h5-1-3" id="h5-1-3" class="d">-    progress: HashMap&lt;NodeID, Progress&gt;,
</a><a href="#h5-1-4" id="h5-1-4" class="i">+    pub(super) progress: HashMap&lt;NodeID, Progress&gt;,
</a>     /// Keeps track of pending write requests, keyed by log index. These are
     /// added when the write is proposed and appended to the leader&#39;s log, and
     /// removed when the command is applied to the state machine, sending the
<a href="#h5-2" id="h5-2" class="h">@@ -150,12 +153,16 @@ impl RawNode&lt;Leader&gt; {
</a>         match msg.message {
             // There can&#39;t be two leaders in the same term.
             Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
<a href="#h5-2-3" id="h5-2-3" class="d">-                panic!(&quot;Saw other leader {} in term {}&quot;, msg.from, msg.term);
</a><a href="#h5-2-4" id="h5-2-4" class="i">+                panic!(&quot;saw other leader {} in term {}&quot;, msg.from, msg.term);
</a>             }
 
             // A follower received one of our heartbeats and confirms that we
             // are its leader. If its log is incomplete, append entries. If the
             // peer&#39;s read sequence number increased, process any pending reads.
<a href="#h5-2-10" id="h5-2-10" class="i">+            //
</a><a href="#h5-2-11" id="h5-2-11" class="i">+            // TODO: this needs to commit and apply entries following a leader
</a><a href="#h5-2-12" id="h5-2-12" class="i">+            // change too, otherwise we can serve stale reads if the new leader
</a><a href="#h5-2-13" id="h5-2-13" class="i">+            // hadn&#39;t fully committed and applied entries yet.
</a>             Message::HeartbeatResponse { last_index, last_term, read_seq } =&gt; {
                 assert!(read_seq &lt;= self.role.read_seq, &quot;Future read sequence number&quot;);
 
<a href="#h5-3" id="h5-3" class="h">@@ -177,11 +184,11 @@ impl RawNode&lt;Leader&gt; {
</a>             Message::AppendResponse { reject: false, last_index, last_term } =&gt; {
                 assert!(
                     last_index &lt;= self.log.get_last_index().0,
<a href="#h5-3-3" id="h5-3-3" class="d">-                    &quot;Follower accepted entries after last index&quot;
</a><a href="#h5-3-4" id="h5-3-4" class="i">+                    &quot;follower accepted entries after last index&quot;
</a>                 );
                 assert!(
                     last_term &lt;= self.log.get_last_index().1,
<a href="#h5-3-8" id="h5-3-8" class="d">-                    &quot;Follower accepted entries after last term&quot;
</a><a href="#h5-3-9" id="h5-3-9" class="i">+                    &quot;follower accepted entries after last term&quot;
</a>                 );
 
                 let progress = self.role.progress.get_mut(&amp;msg.from).unwrap();
<a href="#h5-4" id="h5-4" class="h">@@ -398,10 +405,10 @@ impl RawNode&lt;Leader&gt; {
</a>         let (base_index, base_term) = match self.role.progress.get(&amp;peer) {
             Some(Progress { next, .. }) if *next &gt; 1 =&gt; match self.log.get(next - 1)? {
                 Some(entry) =&gt; (entry.index, entry.term),
<a href="#h5-4-3" id="h5-4-3" class="d">-                None =&gt; panic!(&quot;Missing base entry {}&quot;, next - 1),
</a><a href="#h5-4-4" id="h5-4-4" class="i">+                None =&gt; panic!(&quot;missing base entry {}&quot;, next - 1),
</a>             },
             Some(_) =&gt; (0, 0),
<a href="#h5-4-7" id="h5-4-7" class="d">-            None =&gt; panic!(&quot;Unknown peer {}&quot;, peer),
</a><a href="#h5-4-8" id="h5-4-8" class="i">+            None =&gt; panic!(&quot;unknown peer {}&quot;, peer),
</a>         };
 
         let entries = self.log.scan((base_index + 1)..)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
<a href="#h5-5" id="h5-5" class="h">@@ -410,389 +417,3 @@ impl RawNode&lt;Leader&gt; {
</a>         Ok(())
     }
 }
<a href="#h5-5-3" id="h5-5-3" class="d">-
</a><a href="#h5-5-4" id="h5-5-4" class="d">-#[cfg(test)]
</a><a href="#h5-5-5" id="h5-5-5" class="d">-mod tests {
</a><a href="#h5-5-6" id="h5-5-6" class="d">-    use super::super::super::state::tests::TestState;
</a><a href="#h5-5-7" id="h5-5-7" class="d">-    use super::super::super::{Entry, Log, ELECTION_TIMEOUT_RANGE, HEARTBEAT_INTERVAL};
</a><a href="#h5-5-8" id="h5-5-8" class="d">-    use super::super::tests::{assert_messages, assert_node};
</a><a href="#h5-5-9" id="h5-5-9" class="d">-    use super::*;
</a><a href="#h5-5-10" id="h5-5-10" class="d">-    use crate::storage;
</a><a href="#h5-5-11" id="h5-5-11" class="d">-    use pretty_assertions::assert_eq;
</a><a href="#h5-5-12" id="h5-5-12" class="d">-    use std::collections::BTreeMap;
</a><a href="#h5-5-13" id="h5-5-13" class="d">-
</a><a href="#h5-5-14" id="h5-5-14" class="d">-    #[allow(clippy::type_complexity)]
</a><a href="#h5-5-15" id="h5-5-15" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Leader&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a><a href="#h5-5-16" id="h5-5-16" class="d">-        let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h5-5-17" id="h5-5-17" class="d">-        let peers = HashSet::from([2, 3, 4, 5]);
</a><a href="#h5-5-18" id="h5-5-18" class="d">-        let state = Box::new(TestState::new(0));
</a><a href="#h5-5-19" id="h5-5-19" class="d">-        let mut log = Log::new(storage::Memory::new(), false)?;
</a><a href="#h5-5-20" id="h5-5-20" class="d">-        log.append(1, Some(vec![0x01]))?;
</a><a href="#h5-5-21" id="h5-5-21" class="d">-        log.append(1, Some(vec![0x02]))?;
</a><a href="#h5-5-22" id="h5-5-22" class="d">-        log.append(2, Some(vec![0x03]))?;
</a><a href="#h5-5-23" id="h5-5-23" class="d">-        log.append(3, Some(vec![0x04]))?;
</a><a href="#h5-5-24" id="h5-5-24" class="d">-        log.append(3, Some(vec![0x05]))?;
</a><a href="#h5-5-25" id="h5-5-25" class="d">-        log.commit(2)?;
</a><a href="#h5-5-26" id="h5-5-26" class="d">-        log.set_term(3, Some(1))?;
</a><a href="#h5-5-27" id="h5-5-27" class="d">-
</a><a href="#h5-5-28" id="h5-5-28" class="d">-        let node = RawNode {
</a><a href="#h5-5-29" id="h5-5-29" class="d">-            id: 1,
</a><a href="#h5-5-30" id="h5-5-30" class="d">-            peers: peers.clone(),
</a><a href="#h5-5-31" id="h5-5-31" class="d">-            term: 3,
</a><a href="#h5-5-32" id="h5-5-32" class="d">-            role: Leader::new(peers, log.get_last_index().0),
</a><a href="#h5-5-33" id="h5-5-33" class="d">-            log,
</a><a href="#h5-5-34" id="h5-5-34" class="d">-            state,
</a><a href="#h5-5-35" id="h5-5-35" class="d">-            heartbeat_interval: HEARTBEAT_INTERVAL,
</a><a href="#h5-5-36" id="h5-5-36" class="d">-            election_timeout_range: ELECTION_TIMEOUT_RANGE,
</a><a href="#h5-5-37" id="h5-5-37" class="d">-            node_tx,
</a><a href="#h5-5-38" id="h5-5-38" class="d">-        };
</a><a href="#h5-5-39" id="h5-5-39" class="d">-        Ok((node, node_rx))
</a><a href="#h5-5-40" id="h5-5-40" class="d">-    }
</a><a href="#h5-5-41" id="h5-5-41" class="d">-
</a><a href="#h5-5-42" id="h5-5-42" class="d">-    #[test]
</a><a href="#h5-5-43" id="h5-5-43" class="d">-    // HeartbeatResponse with old log triggers replication.
</a><a href="#h5-5-44" id="h5-5-44" class="d">-    fn step_confirmleader_replicate() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-45" id="h5-5-45" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-46" id="h5-5-46" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-47" id="h5-5-47" class="d">-
</a><a href="#h5-5-48" id="h5-5-48" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-49" id="h5-5-49" class="d">-            from: 2,
</a><a href="#h5-5-50" id="h5-5-50" class="d">-            to: 1,
</a><a href="#h5-5-51" id="h5-5-51" class="d">-            term: 3,
</a><a href="#h5-5-52" id="h5-5-52" class="d">-            message: Message::HeartbeatResponse { last_index: 3, last_term: 2, read_seq: 0 },
</a><a href="#h5-5-53" id="h5-5-53" class="d">-        })?;
</a><a href="#h5-5-54" id="h5-5-54" class="d">-        assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-55" id="h5-5-55" class="d">-        assert_messages(
</a><a href="#h5-5-56" id="h5-5-56" class="d">-            &amp;mut node_rx,
</a><a href="#h5-5-57" id="h5-5-57" class="d">-            vec![Envelope {
</a><a href="#h5-5-58" id="h5-5-58" class="d">-                from: 1,
</a><a href="#h5-5-59" id="h5-5-59" class="d">-                to: 2,
</a><a href="#h5-5-60" id="h5-5-60" class="d">-                term: 3,
</a><a href="#h5-5-61" id="h5-5-61" class="d">-                message: Message::Append { base_index: 5, base_term: 3, entries: vec![] },
</a><a href="#h5-5-62" id="h5-5-62" class="d">-            }],
</a><a href="#h5-5-63" id="h5-5-63" class="d">-        );
</a><a href="#h5-5-64" id="h5-5-64" class="d">-        Ok(())
</a><a href="#h5-5-65" id="h5-5-65" class="d">-    }
</a><a href="#h5-5-66" id="h5-5-66" class="d">-
</a><a href="#h5-5-67" id="h5-5-67" class="d">-    #[test]
</a><a href="#h5-5-68" id="h5-5-68" class="d">-    #[should_panic(expected = &quot;Saw other leader 2 in term 3&quot;)]
</a><a href="#h5-5-69" id="h5-5-69" class="d">-    // Heartbeats from other leaders in current term panics.
</a><a href="#h5-5-70" id="h5-5-70" class="d">-    fn step_heartbeat_current_term() {
</a><a href="#h5-5-71" id="h5-5-71" class="d">-        let (leader, _) = setup().unwrap();
</a><a href="#h5-5-72" id="h5-5-72" class="d">-        leader
</a><a href="#h5-5-73" id="h5-5-73" class="d">-            .step(Envelope {
</a><a href="#h5-5-74" id="h5-5-74" class="d">-                from: 2,
</a><a href="#h5-5-75" id="h5-5-75" class="d">-                to: 1,
</a><a href="#h5-5-76" id="h5-5-76" class="d">-                term: 3,
</a><a href="#h5-5-77" id="h5-5-77" class="d">-                message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h5-5-78" id="h5-5-78" class="d">-            })
</a><a href="#h5-5-79" id="h5-5-79" class="d">-            .unwrap();
</a><a href="#h5-5-80" id="h5-5-80" class="d">-    }
</a><a href="#h5-5-81" id="h5-5-81" class="d">-
</a><a href="#h5-5-82" id="h5-5-82" class="d">-    #[test]
</a><a href="#h5-5-83" id="h5-5-83" class="d">-    // Heartbeats from other leaders in future term converts to follower and steps.
</a><a href="#h5-5-84" id="h5-5-84" class="d">-    fn step_heartbeat_future_term() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-85" id="h5-5-85" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-86" id="h5-5-86" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-87" id="h5-5-87" class="d">-
</a><a href="#h5-5-88" id="h5-5-88" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-89" id="h5-5-89" class="d">-            from: 2,
</a><a href="#h5-5-90" id="h5-5-90" class="d">-            to: 1,
</a><a href="#h5-5-91" id="h5-5-91" class="d">-            term: 4,
</a><a href="#h5-5-92" id="h5-5-92" class="d">-            message: Message::Heartbeat { commit_index: 7, commit_term: 4, read_seq: 7 },
</a><a href="#h5-5-93" id="h5-5-93" class="d">-        })?;
</a><a href="#h5-5-94" id="h5-5-94" class="d">-        assert_node(&amp;mut node).is_follower().term(4).leader(Some(2)).committed(2);
</a><a href="#h5-5-95" id="h5-5-95" class="d">-        assert_messages(
</a><a href="#h5-5-96" id="h5-5-96" class="d">-            &amp;mut node_rx,
</a><a href="#h5-5-97" id="h5-5-97" class="d">-            vec![Envelope {
</a><a href="#h5-5-98" id="h5-5-98" class="d">-                from: 1,
</a><a href="#h5-5-99" id="h5-5-99" class="d">-                to: 2,
</a><a href="#h5-5-100" id="h5-5-100" class="d">-                term: 4,
</a><a href="#h5-5-101" id="h5-5-101" class="d">-                message: Message::HeartbeatResponse { last_index: 5, last_term: 3, read_seq: 7 },
</a><a href="#h5-5-102" id="h5-5-102" class="d">-            }],
</a><a href="#h5-5-103" id="h5-5-103" class="d">-        );
</a><a href="#h5-5-104" id="h5-5-104" class="d">-        Ok(())
</a><a href="#h5-5-105" id="h5-5-105" class="d">-    }
</a><a href="#h5-5-106" id="h5-5-106" class="d">-
</a><a href="#h5-5-107" id="h5-5-107" class="d">-    #[test]
</a><a href="#h5-5-108" id="h5-5-108" class="d">-    // Heartbeats from other leaders in past terms are ignored.
</a><a href="#h5-5-109" id="h5-5-109" class="d">-    fn step_heartbeat_past_term() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-110" id="h5-5-110" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-111" id="h5-5-111" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-112" id="h5-5-112" class="d">-
</a><a href="#h5-5-113" id="h5-5-113" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-114" id="h5-5-114" class="d">-            from: 2,
</a><a href="#h5-5-115" id="h5-5-115" class="d">-            to: 1,
</a><a href="#h5-5-116" id="h5-5-116" class="d">-            term: 2,
</a><a href="#h5-5-117" id="h5-5-117" class="d">-            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h5-5-118" id="h5-5-118" class="d">-        })?;
</a><a href="#h5-5-119" id="h5-5-119" class="d">-        assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-120" id="h5-5-120" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-121" id="h5-5-121" class="d">-        Ok(())
</a><a href="#h5-5-122" id="h5-5-122" class="d">-    }
</a><a href="#h5-5-123" id="h5-5-123" class="d">-
</a><a href="#h5-5-124" id="h5-5-124" class="d">-    #[test]
</a><a href="#h5-5-125" id="h5-5-125" class="d">-    fn step_acceptentries() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-126" id="h5-5-126" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-127" id="h5-5-127" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-128" id="h5-5-128" class="d">-
</a><a href="#h5-5-129" id="h5-5-129" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-130" id="h5-5-130" class="d">-            from: 2,
</a><a href="#h5-5-131" id="h5-5-131" class="d">-            to: 1,
</a><a href="#h5-5-132" id="h5-5-132" class="d">-            term: 3,
</a><a href="#h5-5-133" id="h5-5-133" class="d">-            message: Message::AppendResponse { reject: false, last_index: 4, last_term: 3 },
</a><a href="#h5-5-134" id="h5-5-134" class="d">-        })?;
</a><a href="#h5-5-135" id="h5-5-135" class="d">-        assert_node(&amp;mut node).committed(2);
</a><a href="#h5-5-136" id="h5-5-136" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-137" id="h5-5-137" class="d">-
</a><a href="#h5-5-138" id="h5-5-138" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-139" id="h5-5-139" class="d">-            from: 3,
</a><a href="#h5-5-140" id="h5-5-140" class="d">-            to: 1,
</a><a href="#h5-5-141" id="h5-5-141" class="d">-            term: 3,
</a><a href="#h5-5-142" id="h5-5-142" class="d">-            message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a><a href="#h5-5-143" id="h5-5-143" class="d">-        })?;
</a><a href="#h5-5-144" id="h5-5-144" class="d">-        assert_node(&amp;mut node).committed(4).applied(4);
</a><a href="#h5-5-145" id="h5-5-145" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-146" id="h5-5-146" class="d">-
</a><a href="#h5-5-147" id="h5-5-147" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-148" id="h5-5-148" class="d">-            from: 4,
</a><a href="#h5-5-149" id="h5-5-149" class="d">-            to: 1,
</a><a href="#h5-5-150" id="h5-5-150" class="d">-            term: 3,
</a><a href="#h5-5-151" id="h5-5-151" class="d">-            message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a><a href="#h5-5-152" id="h5-5-152" class="d">-        })?;
</a><a href="#h5-5-153" id="h5-5-153" class="d">-        assert_node(&amp;mut node).committed(5).applied(5);
</a><a href="#h5-5-154" id="h5-5-154" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-155" id="h5-5-155" class="d">-
</a><a href="#h5-5-156" id="h5-5-156" class="d">-        assert_node(&amp;mut node).is_leader().term(3);
</a><a href="#h5-5-157" id="h5-5-157" class="d">-        Ok(())
</a><a href="#h5-5-158" id="h5-5-158" class="d">-    }
</a><a href="#h5-5-159" id="h5-5-159" class="d">-
</a><a href="#h5-5-160" id="h5-5-160" class="d">-    #[test]
</a><a href="#h5-5-161" id="h5-5-161" class="d">-    // Duplicate AcceptEntries from single node should not trigger commit.
</a><a href="#h5-5-162" id="h5-5-162" class="d">-    fn step_acceptentries_duplicate() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-163" id="h5-5-163" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-164" id="h5-5-164" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-165" id="h5-5-165" class="d">-
</a><a href="#h5-5-166" id="h5-5-166" class="d">-        for _ in 0..5 {
</a><a href="#h5-5-167" id="h5-5-167" class="d">-            node = node.step(Envelope {
</a><a href="#h5-5-168" id="h5-5-168" class="d">-                from: 2,
</a><a href="#h5-5-169" id="h5-5-169" class="d">-                to: 1,
</a><a href="#h5-5-170" id="h5-5-170" class="d">-                term: 3,
</a><a href="#h5-5-171" id="h5-5-171" class="d">-                message: Message::AppendResponse { reject: false, last_index: 5, last_term: 3 },
</a><a href="#h5-5-172" id="h5-5-172" class="d">-            })?;
</a><a href="#h5-5-173" id="h5-5-173" class="d">-            assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-174" id="h5-5-174" class="d">-            assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-175" id="h5-5-175" class="d">-        }
</a><a href="#h5-5-176" id="h5-5-176" class="d">-        Ok(())
</a><a href="#h5-5-177" id="h5-5-177" class="d">-    }
</a><a href="#h5-5-178" id="h5-5-178" class="d">-
</a><a href="#h5-5-179" id="h5-5-179" class="d">-    #[test]
</a><a href="#h5-5-180" id="h5-5-180" class="d">-    // AcceptEntries quorum for entry in past term should not trigger commit
</a><a href="#h5-5-181" id="h5-5-181" class="d">-    fn step_acceptentries_past_term() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-182" id="h5-5-182" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-183" id="h5-5-183" class="d">-        let peers = leader.peers.clone();
</a><a href="#h5-5-184" id="h5-5-184" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-185" id="h5-5-185" class="d">-
</a><a href="#h5-5-186" id="h5-5-186" class="d">-        for peer in peers.into_iter() {
</a><a href="#h5-5-187" id="h5-5-187" class="d">-            node = node.step(Envelope {
</a><a href="#h5-5-188" id="h5-5-188" class="d">-                from: peer,
</a><a href="#h5-5-189" id="h5-5-189" class="d">-                to: 1,
</a><a href="#h5-5-190" id="h5-5-190" class="d">-                term: 3,
</a><a href="#h5-5-191" id="h5-5-191" class="d">-                message: Message::AppendResponse { reject: false, last_index: 3, last_term: 3 },
</a><a href="#h5-5-192" id="h5-5-192" class="d">-            })?;
</a><a href="#h5-5-193" id="h5-5-193" class="d">-            assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-194" id="h5-5-194" class="d">-            assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-195" id="h5-5-195" class="d">-        }
</a><a href="#h5-5-196" id="h5-5-196" class="d">-        Ok(())
</a><a href="#h5-5-197" id="h5-5-197" class="d">-    }
</a><a href="#h5-5-198" id="h5-5-198" class="d">-
</a><a href="#h5-5-199" id="h5-5-199" class="d">-    #[test]
</a><a href="#h5-5-200" id="h5-5-200" class="d">-    #[should_panic(expected = &quot;Follower accepted entries after last index&quot;)]
</a><a href="#h5-5-201" id="h5-5-201" class="d">-    // AcceptEntries panics if last_index is beyond leader&#39;s log.
</a><a href="#h5-5-202" id="h5-5-202" class="d">-    fn step_acceptentries_future_index() {
</a><a href="#h5-5-203" id="h5-5-203" class="d">-        let (leader, _) = setup().unwrap();
</a><a href="#h5-5-204" id="h5-5-204" class="d">-        leader
</a><a href="#h5-5-205" id="h5-5-205" class="d">-            .step(Envelope {
</a><a href="#h5-5-206" id="h5-5-206" class="d">-                from: 2,
</a><a href="#h5-5-207" id="h5-5-207" class="d">-                to: 1,
</a><a href="#h5-5-208" id="h5-5-208" class="d">-                term: 3,
</a><a href="#h5-5-209" id="h5-5-209" class="d">-                message: Message::AppendResponse { reject: false, last_index: 7, last_term: 3 },
</a><a href="#h5-5-210" id="h5-5-210" class="d">-            })
</a><a href="#h5-5-211" id="h5-5-211" class="d">-            .unwrap();
</a><a href="#h5-5-212" id="h5-5-212" class="d">-    }
</a><a href="#h5-5-213" id="h5-5-213" class="d">-
</a><a href="#h5-5-214" id="h5-5-214" class="d">-    #[test]
</a><a href="#h5-5-215" id="h5-5-215" class="d">-    fn step_rejectentries() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-216" id="h5-5-216" class="d">-        let (mut leader, mut node_rx) = setup()?;
</a><a href="#h5-5-217" id="h5-5-217" class="d">-        let entries = leader.log.scan(0..)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h5-5-218" id="h5-5-218" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-219" id="h5-5-219" class="d">-
</a><a href="#h5-5-220" id="h5-5-220" class="d">-        for i in 0..(entries.len() + 3) {
</a><a href="#h5-5-221" id="h5-5-221" class="d">-            node = node.step(Envelope {
</a><a href="#h5-5-222" id="h5-5-222" class="d">-                from: 2,
</a><a href="#h5-5-223" id="h5-5-223" class="d">-                to: 1,
</a><a href="#h5-5-224" id="h5-5-224" class="d">-                term: 3,
</a><a href="#h5-5-225" id="h5-5-225" class="d">-                message: Message::AppendResponse { reject: true, last_index: 0, last_term: 3 },
</a><a href="#h5-5-226" id="h5-5-226" class="d">-            })?;
</a><a href="#h5-5-227" id="h5-5-227" class="d">-            assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-228" id="h5-5-228" class="d">-            let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
</a><a href="#h5-5-229" id="h5-5-229" class="d">-            let replicate = entries.get(index..).unwrap().to_vec();
</a><a href="#h5-5-230" id="h5-5-230" class="d">-            assert_messages(
</a><a href="#h5-5-231" id="h5-5-231" class="d">-                &amp;mut node_rx,
</a><a href="#h5-5-232" id="h5-5-232" class="d">-                vec![Envelope {
</a><a href="#h5-5-233" id="h5-5-233" class="d">-                    from: 1,
</a><a href="#h5-5-234" id="h5-5-234" class="d">-                    to: 2,
</a><a href="#h5-5-235" id="h5-5-235" class="d">-                    term: 3,
</a><a href="#h5-5-236" id="h5-5-236" class="d">-                    message: Message::Append {
</a><a href="#h5-5-237" id="h5-5-237" class="d">-                        base_index: index as Index,
</a><a href="#h5-5-238" id="h5-5-238" class="d">-                        base_term: if index &gt; 0 {
</a><a href="#h5-5-239" id="h5-5-239" class="d">-                            entries.get(index - 1).map(|e| e.term).unwrap()
</a><a href="#h5-5-240" id="h5-5-240" class="d">-                        } else {
</a><a href="#h5-5-241" id="h5-5-241" class="d">-                            0
</a><a href="#h5-5-242" id="h5-5-242" class="d">-                        },
</a><a href="#h5-5-243" id="h5-5-243" class="d">-                        entries: replicate,
</a><a href="#h5-5-244" id="h5-5-244" class="d">-                    },
</a><a href="#h5-5-245" id="h5-5-245" class="d">-                }],
</a><a href="#h5-5-246" id="h5-5-246" class="d">-            );
</a><a href="#h5-5-247" id="h5-5-247" class="d">-        }
</a><a href="#h5-5-248" id="h5-5-248" class="d">-        Ok(())
</a><a href="#h5-5-249" id="h5-5-249" class="d">-    }
</a><a href="#h5-5-250" id="h5-5-250" class="d">-
</a><a href="#h5-5-251" id="h5-5-251" class="d">-    #[test]
</a><a href="#h5-5-252" id="h5-5-252" class="d">-    // Sending a client query request will pass it to the state machine and trigger heartbeats.
</a><a href="#h5-5-253" id="h5-5-253" class="d">-    fn step_clientrequest_query() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-254" id="h5-5-254" class="d">-        let (leader, node_rx) = setup()?;
</a><a href="#h5-5-255" id="h5-5-255" class="d">-        let peers = leader.peers.clone();
</a><a href="#h5-5-256" id="h5-5-256" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-257" id="h5-5-257" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-258" id="h5-5-258" class="d">-            from: 1,
</a><a href="#h5-5-259" id="h5-5-259" class="d">-            to: 1,
</a><a href="#h5-5-260" id="h5-5-260" class="d">-            term: 3,
</a><a href="#h5-5-261" id="h5-5-261" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Read(vec![0xaf]) },
</a><a href="#h5-5-262" id="h5-5-262" class="d">-        })?;
</a><a href="#h5-5-263" id="h5-5-263" class="d">-        assert_node(&amp;mut node).is_leader().term(3).committed(2).last(5);
</a><a href="#h5-5-264" id="h5-5-264" class="d">-        for to in peers.iter().copied().sorted() {
</a><a href="#h5-5-265" id="h5-5-265" class="d">-            assert_eq!(
</a><a href="#h5-5-266" id="h5-5-266" class="d">-                node_rx.try_recv()?,
</a><a href="#h5-5-267" id="h5-5-267" class="d">-                Envelope {
</a><a href="#h5-5-268" id="h5-5-268" class="d">-                    from: 1,
</a><a href="#h5-5-269" id="h5-5-269" class="d">-                    to,
</a><a href="#h5-5-270" id="h5-5-270" class="d">-                    term: 3,
</a><a href="#h5-5-271" id="h5-5-271" class="d">-                    message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 1 },
</a><a href="#h5-5-272" id="h5-5-272" class="d">-                },
</a><a href="#h5-5-273" id="h5-5-273" class="d">-            );
</a><a href="#h5-5-274" id="h5-5-274" class="d">-        }
</a><a href="#h5-5-275" id="h5-5-275" class="d">-        Ok(())
</a><a href="#h5-5-276" id="h5-5-276" class="d">-    }
</a><a href="#h5-5-277" id="h5-5-277" class="d">-
</a><a href="#h5-5-278" id="h5-5-278" class="d">-    #[test]
</a><a href="#h5-5-279" id="h5-5-279" class="d">-    // Sending a mutate request should append it to log, replicate it to peers, and register notification.
</a><a href="#h5-5-280" id="h5-5-280" class="d">-    fn step_clientrequest_mutate() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-281" id="h5-5-281" class="d">-        let (leader, node_rx) = setup()?;
</a><a href="#h5-5-282" id="h5-5-282" class="d">-        let peers = leader.peers.clone();
</a><a href="#h5-5-283" id="h5-5-283" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-284" id="h5-5-284" class="d">-
</a><a href="#h5-5-285" id="h5-5-285" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-286" id="h5-5-286" class="d">-            from: 1,
</a><a href="#h5-5-287" id="h5-5-287" class="d">-            to: 1,
</a><a href="#h5-5-288" id="h5-5-288" class="d">-            term: 3,
</a><a href="#h5-5-289" id="h5-5-289" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Write(vec![0xaf]) },
</a><a href="#h5-5-290" id="h5-5-290" class="d">-        })?;
</a><a href="#h5-5-291" id="h5-5-291" class="d">-        assert_node(&amp;mut node).is_leader().term(3).committed(2).last(6).entry(Entry {
</a><a href="#h5-5-292" id="h5-5-292" class="d">-            index: 6,
</a><a href="#h5-5-293" id="h5-5-293" class="d">-            term: 3,
</a><a href="#h5-5-294" id="h5-5-294" class="d">-            command: Some(vec![0xaf]),
</a><a href="#h5-5-295" id="h5-5-295" class="d">-        });
</a><a href="#h5-5-296" id="h5-5-296" class="d">-
</a><a href="#h5-5-297" id="h5-5-297" class="d">-        for peer in peers.iter().copied().sorted() {
</a><a href="#h5-5-298" id="h5-5-298" class="d">-            assert_eq!(
</a><a href="#h5-5-299" id="h5-5-299" class="d">-                node_rx.try_recv()?,
</a><a href="#h5-5-300" id="h5-5-300" class="d">-                Envelope {
</a><a href="#h5-5-301" id="h5-5-301" class="d">-                    from: 1,
</a><a href="#h5-5-302" id="h5-5-302" class="d">-                    to: peer,
</a><a href="#h5-5-303" id="h5-5-303" class="d">-                    term: 3,
</a><a href="#h5-5-304" id="h5-5-304" class="d">-                    message: Message::Append {
</a><a href="#h5-5-305" id="h5-5-305" class="d">-                        base_index: 5,
</a><a href="#h5-5-306" id="h5-5-306" class="d">-                        base_term: 3,
</a><a href="#h5-5-307" id="h5-5-307" class="d">-                        entries: vec![Entry { index: 6, term: 3, command: Some(vec![0xaf]) },]
</a><a href="#h5-5-308" id="h5-5-308" class="d">-                    },
</a><a href="#h5-5-309" id="h5-5-309" class="d">-                }
</a><a href="#h5-5-310" id="h5-5-310" class="d">-            )
</a><a href="#h5-5-311" id="h5-5-311" class="d">-        }
</a><a href="#h5-5-312" id="h5-5-312" class="d">-        Ok(())
</a><a href="#h5-5-313" id="h5-5-313" class="d">-    }
</a><a href="#h5-5-314" id="h5-5-314" class="d">-
</a><a href="#h5-5-315" id="h5-5-315" class="d">-    #[test]
</a><a href="#h5-5-316" id="h5-5-316" class="d">-    // Sending a status request should pass it on to state machine, to add status.
</a><a href="#h5-5-317" id="h5-5-317" class="d">-    fn step_clientrequest_status() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-318" id="h5-5-318" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-319" id="h5-5-319" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-320" id="h5-5-320" class="d">-
</a><a href="#h5-5-321" id="h5-5-321" class="d">-        node = node.step(Envelope {
</a><a href="#h5-5-322" id="h5-5-322" class="d">-            from: 1,
</a><a href="#h5-5-323" id="h5-5-323" class="d">-            to: 1,
</a><a href="#h5-5-324" id="h5-5-324" class="d">-            term: 3,
</a><a href="#h5-5-325" id="h5-5-325" class="d">-            message: Message::ClientRequest { id: vec![0x01], request: Request::Status },
</a><a href="#h5-5-326" id="h5-5-326" class="d">-        })?;
</a><a href="#h5-5-327" id="h5-5-327" class="d">-        assert_node(&amp;mut node).is_leader().term(3).committed(2).last(5);
</a><a href="#h5-5-328" id="h5-5-328" class="d">-        assert_messages(
</a><a href="#h5-5-329" id="h5-5-329" class="d">-            &amp;mut node_rx,
</a><a href="#h5-5-330" id="h5-5-330" class="d">-            vec![Envelope {
</a><a href="#h5-5-331" id="h5-5-331" class="d">-                term: 3,
</a><a href="#h5-5-332" id="h5-5-332" class="d">-                from: 1,
</a><a href="#h5-5-333" id="h5-5-333" class="d">-                to: 1,
</a><a href="#h5-5-334" id="h5-5-334" class="d">-                message: Message::ClientResponse {
</a><a href="#h5-5-335" id="h5-5-335" class="d">-                    id: vec![1],
</a><a href="#h5-5-336" id="h5-5-336" class="d">-                    response: Ok(Response::Status(Status {
</a><a href="#h5-5-337" id="h5-5-337" class="d">-                        leader: 1,
</a><a href="#h5-5-338" id="h5-5-338" class="d">-                        term: 3,
</a><a href="#h5-5-339" id="h5-5-339" class="d">-                        last_index: BTreeMap::from([(1, 5), (2, 0), (3, 0), (4, 0), (5, 0)]),
</a><a href="#h5-5-340" id="h5-5-340" class="d">-                        commit_index: 2,
</a><a href="#h5-5-341" id="h5-5-341" class="d">-                        apply_index: 0,
</a><a href="#h5-5-342" id="h5-5-342" class="d">-                        storage: storage::engine::Status {
</a><a href="#h5-5-343" id="h5-5-343" class="d">-                            name: &quot;memory&quot;.to_string(),
</a><a href="#h5-5-344" id="h5-5-344" class="d">-                            keys: 7,
</a><a href="#h5-5-345" id="h5-5-345" class="d">-                            size: 72,
</a><a href="#h5-5-346" id="h5-5-346" class="d">-                            total_disk_size: 0,
</a><a href="#h5-5-347" id="h5-5-347" class="d">-                            live_disk_size: 0,
</a><a href="#h5-5-348" id="h5-5-348" class="d">-                            garbage_disk_size: 0,
</a><a href="#h5-5-349" id="h5-5-349" class="d">-                        },
</a><a href="#h5-5-350" id="h5-5-350" class="d">-                    })),
</a><a href="#h5-5-351" id="h5-5-351" class="d">-                },
</a><a href="#h5-5-352" id="h5-5-352" class="d">-            }],
</a><a href="#h5-5-353" id="h5-5-353" class="d">-        );
</a><a href="#h5-5-354" id="h5-5-354" class="d">-
</a><a href="#h5-5-355" id="h5-5-355" class="d">-        Ok(())
</a><a href="#h5-5-356" id="h5-5-356" class="d">-    }
</a><a href="#h5-5-357" id="h5-5-357" class="d">-
</a><a href="#h5-5-358" id="h5-5-358" class="d">-    #[test]
</a><a href="#h5-5-359" id="h5-5-359" class="d">-    fn tick() -&gt; Result&lt;()&gt; {
</a><a href="#h5-5-360" id="h5-5-360" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h5-5-361" id="h5-5-361" class="d">-        let peers = leader.peers.clone();
</a><a href="#h5-5-362" id="h5-5-362" class="d">-        let mut node: Node = leader.into();
</a><a href="#h5-5-363" id="h5-5-363" class="d">-        for _ in 0..5 {
</a><a href="#h5-5-364" id="h5-5-364" class="d">-            for _ in 0..HEARTBEAT_INTERVAL {
</a><a href="#h5-5-365" id="h5-5-365" class="d">-                assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h5-5-366" id="h5-5-366" class="d">-                node = node.tick()?;
</a><a href="#h5-5-367" id="h5-5-367" class="d">-                assert_node(&amp;mut node).is_leader().term(3).committed(2);
</a><a href="#h5-5-368" id="h5-5-368" class="d">-            }
</a><a href="#h5-5-369" id="h5-5-369" class="d">-
</a><a href="#h5-5-370" id="h5-5-370" class="d">-            for to in peers.iter().copied().sorted() {
</a><a href="#h5-5-371" id="h5-5-371" class="d">-                assert_eq!(
</a><a href="#h5-5-372" id="h5-5-372" class="d">-                    node_rx.try_recv()?,
</a><a href="#h5-5-373" id="h5-5-373" class="d">-                    Envelope {
</a><a href="#h5-5-374" id="h5-5-374" class="d">-                        from: 1,
</a><a href="#h5-5-375" id="h5-5-375" class="d">-                        to,
</a><a href="#h5-5-376" id="h5-5-376" class="d">-                        term: 3,
</a><a href="#h5-5-377" id="h5-5-377" class="d">-                        message: Message::Heartbeat {
</a><a href="#h5-5-378" id="h5-5-378" class="d">-                            commit_index: 2,
</a><a href="#h5-5-379" id="h5-5-379" class="d">-                            commit_term: 1,
</a><a href="#h5-5-380" id="h5-5-380" class="d">-                            read_seq: 0
</a><a href="#h5-5-381" id="h5-5-381" class="d">-                        },
</a><a href="#h5-5-382" id="h5-5-382" class="d">-                    }
</a><a href="#h5-5-383" id="h5-5-383" class="d">-                );
</a><a href="#h5-5-384" id="h5-5-384" class="d">-            }
</a><a href="#h5-5-385" id="h5-5-385" class="d">-        }
</a><a href="#h5-5-386" id="h5-5-386" class="d">-        Ok(())
</a><a href="#h5-5-387" id="h5-5-387" class="d">-    }
</a><a href="#h5-5-388" id="h5-5-388" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -259,295 +259,1044 @@ fn quorum_value&lt;T: Ord + Copy&gt;(mut values: Vec&lt;T&gt;) -&gt; T {
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h6-0-3" id="h6-0-3" class="d">-    pub use super::super::state::tests::TestState;
</a><a href="#h6-0-4" id="h6-0-4" class="d">-    use super::super::{Entry, RequestID, ELECTION_TIMEOUT_RANGE};
</a>     use super::*;
<a href="#h6-0-6" id="h6-0-6" class="d">-    use crate::raft::HEARTBEAT_INTERVAL;
</a><a href="#h6-0-7" id="h6-0-7" class="d">-    use crate::storage;
</a><a href="#h6-0-8" id="h6-0-8" class="i">+    use crate::encoding::bincode;
</a><a href="#h6-0-9" id="h6-0-9" class="i">+    use crate::raft::{
</a><a href="#h6-0-10" id="h6-0-10" class="i">+        Entry, Request, RequestID, Response, ELECTION_TIMEOUT_RANGE, HEARTBEAT_INTERVAL,
</a><a href="#h6-0-11" id="h6-0-11" class="i">+    };
</a><a href="#h6-0-12" id="h6-0-12" class="i">+    use crossbeam::channel::{Receiver, Sender};
</a>     use pretty_assertions::assert_eq;
<a href="#h6-0-14" id="h6-0-14" class="d">-    use std::collections::HashSet;
</a><a href="#h6-0-15" id="h6-0-15" class="i">+    use serde::{Deserialize, Serialize};
</a><a href="#h6-0-16" id="h6-0-16" class="i">+    use std::borrow::Borrow;
</a><a href="#h6-0-17" id="h6-0-17" class="i">+    use std::collections::{BTreeMap, HashMap, HashSet};
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    use std::error::Error;
</a><a href="#h6-0-19" id="h6-0-19" class="i">+    use std::result::Result;
</a><a href="#h6-0-20" id="h6-0-20" class="i">+    use test_each_file::test_each_path;
</a> 
<a href="#h6-0-22" id="h6-0-22" class="d">-    #[track_caller]
</a><a href="#h6-0-23" id="h6-0-23" class="d">-    pub fn assert_messages&lt;T: std::fmt::Debug + PartialEq&gt;(
</a><a href="#h6-0-24" id="h6-0-24" class="d">-        rx: &amp;mut crossbeam::channel::Receiver&lt;T&gt;,
</a><a href="#h6-0-25" id="h6-0-25" class="d">-        msgs: Vec&lt;T&gt;,
</a><a href="#h6-0-26" id="h6-0-26" class="d">-    ) {
</a><a href="#h6-0-27" id="h6-0-27" class="d">-        let mut actual = Vec::new();
</a><a href="#h6-0-28" id="h6-0-28" class="d">-        while let Ok(message) = rx.try_recv() {
</a><a href="#h6-0-29" id="h6-0-29" class="d">-            actual.push(message)
</a><a href="#h6-0-30" id="h6-0-30" class="i">+    #[test]
</a><a href="#h6-0-31" id="h6-0-31" class="i">+    fn quorum_size() {
</a><a href="#h6-0-32" id="h6-0-32" class="i">+        for (size, quorum) in [(1, 1), (2, 2), (3, 2), (4, 3), (5, 3), (6, 4), (7, 4), (8, 5)] {
</a><a href="#h6-0-33" id="h6-0-33" class="i">+            assert_eq!(super::quorum_size(size), quorum);
</a>         }
<a href="#h6-0-35" id="h6-0-35" class="d">-        assert_eq!(msgs, actual);
</a>     }
 
<a href="#h6-0-38" id="h6-0-38" class="d">-    pub struct NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h6-0-39" id="h6-0-39" class="d">-        node: &amp;&#39;a mut Node,
</a><a href="#h6-0-40" id="h6-0-40" class="i">+    #[test]
</a><a href="#h6-0-41" id="h6-0-41" class="i">+    fn quorum_value() {
</a><a href="#h6-0-42" id="h6-0-42" class="i">+        assert_eq!(super::quorum_value(vec![1]), 1);
</a><a href="#h6-0-43" id="h6-0-43" class="i">+        assert_eq!(super::quorum_value(vec![1, 3, 2]), 2);
</a><a href="#h6-0-44" id="h6-0-44" class="i">+        assert_eq!(super::quorum_value(vec![4, 1, 3, 2]), 2);
</a><a href="#h6-0-45" id="h6-0-45" class="i">+        assert_eq!(super::quorum_value(vec![1, 1, 1, 2, 2]), 1);
</a><a href="#h6-0-46" id="h6-0-46" class="i">+        assert_eq!(super::quorum_value(vec![1, 1, 2, 2, 2]), 2);
</a>     }
 
<a href="#h6-0-49" id="h6-0-49" class="d">-    impl&lt;&#39;a&gt; NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h6-0-50" id="h6-0-50" class="d">-        pub fn new(node: &amp;&#39;a mut Node) -&gt; Self {
</a><a href="#h6-0-51" id="h6-0-51" class="d">-            Self { node }
</a><a href="#h6-0-52" id="h6-0-52" class="i">+    // Run goldenscript tests in src/raft/testscripts/.
</a><a href="#h6-0-53" id="h6-0-53" class="i">+    test_each_path! { in &quot;src/raft/testscripts&quot; as scripts =&gt; test_goldenscript }
</a><a href="#h6-0-54" id="h6-0-54" class="i">+
</a><a href="#h6-0-55" id="h6-0-55" class="i">+    fn test_goldenscript(path: &amp;std::path::Path) {
</a><a href="#h6-0-56" id="h6-0-56" class="i">+        goldenscript::run(&amp;mut TestRunner::new(), path).expect(&quot;goldenscript failed&quot;)
</a><a href="#h6-0-57" id="h6-0-57" class="i">+    }
</a><a href="#h6-0-58" id="h6-0-58" class="i">+
</a><a href="#h6-0-59" id="h6-0-59" class="i">+    /// Runs Raft goldenscript tests. For available commands, see run().
</a><a href="#h6-0-60" id="h6-0-60" class="i">+    #[derive(Default)]
</a><a href="#h6-0-61" id="h6-0-61" class="i">+    struct TestRunner {
</a><a href="#h6-0-62" id="h6-0-62" class="i">+        /// IDs of all cluster nodes, in order.
</a><a href="#h6-0-63" id="h6-0-63" class="i">+        ids: Vec&lt;NodeID&gt;,
</a><a href="#h6-0-64" id="h6-0-64" class="i">+        /// The cluster nodes, keyed by node ID.
</a><a href="#h6-0-65" id="h6-0-65" class="i">+        nodes: HashMap&lt;NodeID, Node&gt;,
</a><a href="#h6-0-66" id="h6-0-66" class="i">+        /// Outbound send queues from each node.
</a><a href="#h6-0-67" id="h6-0-67" class="i">+        nodes_rx: HashMap&lt;NodeID, Receiver&lt;Envelope&gt;&gt;,
</a><a href="#h6-0-68" id="h6-0-68" class="i">+        /// Inbound receive queues to each node, to be stepped.
</a><a href="#h6-0-69" id="h6-0-69" class="i">+        nodes_pending: HashMap&lt;NodeID, Vec&lt;Envelope&gt;&gt;,
</a><a href="#h6-0-70" id="h6-0-70" class="i">+        /// Applied log entries for each node, after TestState application.
</a><a href="#h6-0-71" id="h6-0-71" class="i">+        applied_rx: HashMap&lt;NodeID, Receiver&lt;Entry&gt;&gt;,
</a><a href="#h6-0-72" id="h6-0-72" class="i">+        /// Network partitions, sender → receivers.
</a><a href="#h6-0-73" id="h6-0-73" class="i">+        disconnected: HashMap&lt;NodeID, HashSet&lt;NodeID&gt;&gt;,
</a><a href="#h6-0-74" id="h6-0-74" class="i">+        /// In-flight client requests.
</a><a href="#h6-0-75" id="h6-0-75" class="i">+        requests: HashMap&lt;RequestID, Request&gt;,
</a><a href="#h6-0-76" id="h6-0-76" class="i">+        /// The request ID to use for the next client request.
</a><a href="#h6-0-77" id="h6-0-77" class="i">+        next_request_id: u8,
</a><a href="#h6-0-78" id="h6-0-78" class="i">+    }
</a><a href="#h6-0-79" id="h6-0-79" class="i">+
</a><a href="#h6-0-80" id="h6-0-80" class="i">+    impl goldenscript::Runner for TestRunner {
</a><a href="#h6-0-81" id="h6-0-81" class="i">+        /// Runs a goldenscript command.
</a><a href="#h6-0-82" id="h6-0-82" class="i">+        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-83" id="h6-0-83" class="i">+            let mut output = String::new();
</a><a href="#h6-0-84" id="h6-0-84" class="i">+            match command.name.as_str() {
</a><a href="#h6-0-85" id="h6-0-85" class="i">+                // campaign [ID...]
</a><a href="#h6-0-86" id="h6-0-86" class="i">+                //
</a><a href="#h6-0-87" id="h6-0-87" class="i">+                // The given nodes transition to candidates and campaign.
</a><a href="#h6-0-88" id="h6-0-88" class="i">+                &quot;campaign&quot; =&gt; {
</a><a href="#h6-0-89" id="h6-0-89" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a><a href="#h6-0-90" id="h6-0-90" class="i">+                    self.campaign(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-91" id="h6-0-91" class="i">+                }
</a><a href="#h6-0-92" id="h6-0-92" class="i">+
</a><a href="#h6-0-93" id="h6-0-93" class="i">+                // cluster nodes=N [leader=ID] [heartbeat_interval=N] [election_timeout=N]
</a><a href="#h6-0-94" id="h6-0-94" class="i">+                //
</a><a href="#h6-0-95" id="h6-0-95" class="i">+                // Creates a new Raft cluster.
</a><a href="#h6-0-96" id="h6-0-96" class="i">+                &quot;cluster&quot; =&gt; {
</a><a href="#h6-0-97" id="h6-0-97" class="i">+                    let mut nodes = 0;
</a><a href="#h6-0-98" id="h6-0-98" class="i">+                    let mut leader = None;
</a><a href="#h6-0-99" id="h6-0-99" class="i">+                    let mut heartbeat_interval = HEARTBEAT_INTERVAL;
</a><a href="#h6-0-100" id="h6-0-100" class="i">+                    let mut election_timeout = ELECTION_TIMEOUT_RANGE.start;
</a><a href="#h6-0-101" id="h6-0-101" class="i">+                    for arg in &amp;command.args {
</a><a href="#h6-0-102" id="h6-0-102" class="i">+                        match arg.key.as_deref() {
</a><a href="#h6-0-103" id="h6-0-103" class="i">+                            Some(&quot;election_timeout&quot;) =&gt; election_timeout = arg.parse()?,
</a><a href="#h6-0-104" id="h6-0-104" class="i">+                            Some(&quot;heartbeat_interval&quot;) =&gt; heartbeat_interval = arg.parse()?,
</a><a href="#h6-0-105" id="h6-0-105" class="i">+                            Some(&quot;leader&quot;) =&gt; leader = Some(arg.parse()?),
</a><a href="#h6-0-106" id="h6-0-106" class="i">+                            Some(&quot;nodes&quot;) =&gt; nodes = arg.parse()?,
</a><a href="#h6-0-107" id="h6-0-107" class="i">+                            _ =&gt; return Err(format!(&quot;invalid argument &#39;{}&#39;&quot;, arg.name()).into()),
</a><a href="#h6-0-108" id="h6-0-108" class="i">+                        }
</a><a href="#h6-0-109" id="h6-0-109" class="i">+                    }
</a><a href="#h6-0-110" id="h6-0-110" class="i">+                    self.cluster(nodes, leader, heartbeat_interval, election_timeout, &amp;mut output)?;
</a><a href="#h6-0-111" id="h6-0-111" class="i">+                }
</a><a href="#h6-0-112" id="h6-0-112" class="i">+
</a><a href="#h6-0-113" id="h6-0-113" class="i">+                // deliver [from=ID] [ID...]
</a><a href="#h6-0-114" id="h6-0-114" class="i">+                //
</a><a href="#h6-0-115" id="h6-0-115" class="i">+                // Delivers (steps) pending messages to the given nodes. If from
</a><a href="#h6-0-116" id="h6-0-116" class="i">+                // is given, only messages from the given node is delivered, the
</a><a href="#h6-0-117" id="h6-0-117" class="i">+                // others are left pending.
</a><a href="#h6-0-118" id="h6-0-118" class="i">+                &quot;deliver&quot; =&gt; {
</a><a href="#h6-0-119" id="h6-0-119" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.pos_args())?;
</a><a href="#h6-0-120" id="h6-0-120" class="i">+                    let mut from = None;
</a><a href="#h6-0-121" id="h6-0-121" class="i">+                    for arg in command.key_args() {
</a><a href="#h6-0-122" id="h6-0-122" class="i">+                        match arg.key.as_deref().unwrap() {
</a><a href="#h6-0-123" id="h6-0-123" class="i">+                            &quot;from&quot; =&gt; from = Some(arg.parse()?),
</a><a href="#h6-0-124" id="h6-0-124" class="i">+                            key =&gt; return Err(format!(&quot;invalid argument &#39;{key}&#39;&quot;).into()),
</a><a href="#h6-0-125" id="h6-0-125" class="i">+                        }
</a><a href="#h6-0-126" id="h6-0-126" class="i">+                    }
</a><a href="#h6-0-127" id="h6-0-127" class="i">+                    self.deliver(&amp;ids, from, &amp;mut output)?;
</a><a href="#h6-0-128" id="h6-0-128" class="i">+                }
</a><a href="#h6-0-129" id="h6-0-129" class="i">+
</a><a href="#h6-0-130" id="h6-0-130" class="i">+                // get ID KEY
</a><a href="#h6-0-131" id="h6-0-131" class="i">+                //
</a><a href="#h6-0-132" id="h6-0-132" class="i">+                // Sends a client request to the given node to read the given
</a><a href="#h6-0-133" id="h6-0-133" class="i">+                // key from the state machine (key/value store).
</a><a href="#h6-0-134" id="h6-0-134" class="i">+                &quot;get&quot; =&gt; {
</a><a href="#h6-0-135" id="h6-0-135" class="i">+                    self.reject_args(&amp;command.key_args())?;
</a><a href="#h6-0-136" id="h6-0-136" class="i">+                    let mut args = command.pos_args().into_iter();
</a><a href="#h6-0-137" id="h6-0-137" class="i">+                    let id = args.next().ok_or(&quot;must specify node ID&quot;)?.parse()?;
</a><a href="#h6-0-138" id="h6-0-138" class="i">+                    let key = args.next().ok_or(&quot;must specify key&quot;)?.value.clone();
</a><a href="#h6-0-139" id="h6-0-139" class="i">+                    self.reject_args(&amp;args.collect_vec())?;
</a><a href="#h6-0-140" id="h6-0-140" class="i">+                    let request = Request::Read(TestCommand::Get { key }.encode()?);
</a><a href="#h6-0-141" id="h6-0-141" class="i">+                    self.request(id, request, &amp;mut output)?;
</a><a href="#h6-0-142" id="h6-0-142" class="i">+                }
</a><a href="#h6-0-143" id="h6-0-143" class="i">+
</a><a href="#h6-0-144" id="h6-0-144" class="i">+                // heal [ID...]
</a><a href="#h6-0-145" id="h6-0-145" class="i">+                //
</a><a href="#h6-0-146" id="h6-0-146" class="i">+                // Heals all network partitions for the given nodes.
</a><a href="#h6-0-147" id="h6-0-147" class="i">+                &quot;heal&quot; =&gt; {
</a><a href="#h6-0-148" id="h6-0-148" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a><a href="#h6-0-149" id="h6-0-149" class="i">+                    self.heal(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-150" id="h6-0-150" class="i">+                }
</a><a href="#h6-0-151" id="h6-0-151" class="i">+
</a><a href="#h6-0-152" id="h6-0-152" class="i">+                // heartbeat ID...
</a><a href="#h6-0-153" id="h6-0-153" class="i">+                //
</a><a href="#h6-0-154" id="h6-0-154" class="i">+                // Sends a heartbeat from the given leader nodes.
</a><a href="#h6-0-155" id="h6-0-155" class="i">+                &quot;heartbeat&quot; =&gt; {
</a><a href="#h6-0-156" id="h6-0-156" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a><a href="#h6-0-157" id="h6-0-157" class="i">+                    self.heartbeat(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-158" id="h6-0-158" class="i">+                }
</a><a href="#h6-0-159" id="h6-0-159" class="i">+
</a><a href="#h6-0-160" id="h6-0-160" class="i">+                // log [ID...]
</a><a href="#h6-0-161" id="h6-0-161" class="i">+                //
</a><a href="#h6-0-162" id="h6-0-162" class="i">+                // Outputs the current Raft log for the given nodes.
</a><a href="#h6-0-163" id="h6-0-163" class="i">+                &quot;log&quot; =&gt; {
</a><a href="#h6-0-164" id="h6-0-164" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a><a href="#h6-0-165" id="h6-0-165" class="i">+                    self.log(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-166" id="h6-0-166" class="i">+                }
</a><a href="#h6-0-167" id="h6-0-167" class="i">+
</a><a href="#h6-0-168" id="h6-0-168" class="i">+                // partition ID...
</a><a href="#h6-0-169" id="h6-0-169" class="i">+                //
</a><a href="#h6-0-170" id="h6-0-170" class="i">+                // Partitions the given nodes away from the rest of the cluster.
</a><a href="#h6-0-171" id="h6-0-171" class="i">+                // They can still communicate with each other, unless they were
</a><a href="#h6-0-172" id="h6-0-172" class="i">+                // previously partitioned.
</a><a href="#h6-0-173" id="h6-0-173" class="i">+                &quot;partition&quot; =&gt; {
</a><a href="#h6-0-174" id="h6-0-174" class="i">+                    let ids = self.parse_ids_or_error(&amp;command.args)?;
</a><a href="#h6-0-175" id="h6-0-175" class="i">+                    self.partition(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-176" id="h6-0-176" class="i">+                }
</a><a href="#h6-0-177" id="h6-0-177" class="i">+
</a><a href="#h6-0-178" id="h6-0-178" class="i">+                // put ID KEY=VALUE
</a><a href="#h6-0-179" id="h6-0-179" class="i">+                //
</a><a href="#h6-0-180" id="h6-0-180" class="i">+                // Sends a client request to the given node to write a key/value
</a><a href="#h6-0-181" id="h6-0-181" class="i">+                // pair to the state machine (key/value store).
</a><a href="#h6-0-182" id="h6-0-182" class="i">+                &quot;put&quot; =&gt; {
</a><a href="#h6-0-183" id="h6-0-183" class="i">+                    let mut args = command.args.iter();
</a><a href="#h6-0-184" id="h6-0-184" class="i">+                    let id = args.next().ok_or(&quot;must specify node ID&quot;)?.parse()?;
</a><a href="#h6-0-185" id="h6-0-185" class="i">+                    let kv = args.next().ok_or(&quot;must specify key/value pair&quot;)?;
</a><a href="#h6-0-186" id="h6-0-186" class="i">+                    let key = kv.key.clone().ok_or(&quot;must specify key/value pair&quot;)?;
</a><a href="#h6-0-187" id="h6-0-187" class="i">+                    let value = kv.value.clone();
</a><a href="#h6-0-188" id="h6-0-188" class="i">+                    self.reject_args(&amp;args.collect_vec())?;
</a><a href="#h6-0-189" id="h6-0-189" class="i">+                    let request = Request::Write(TestCommand::Put { key, value }.encode()?);
</a><a href="#h6-0-190" id="h6-0-190" class="i">+                    self.request(id, request, &amp;mut output)?;
</a><a href="#h6-0-191" id="h6-0-191" class="i">+                }
</a><a href="#h6-0-192" id="h6-0-192" class="i">+
</a><a href="#h6-0-193" id="h6-0-193" class="i">+                // stabilize [heartbeat=BOOL] [ID...]
</a><a href="#h6-0-194" id="h6-0-194" class="i">+                //
</a><a href="#h6-0-195" id="h6-0-195" class="i">+                // Stabilizes the given nodes by repeatedly delivering messages
</a><a href="#h6-0-196" id="h6-0-196" class="i">+                // until no more messages are pending. If heartbeat is true, also
</a><a href="#h6-0-197" id="h6-0-197" class="i">+                // emits a heartbeat from the leader and restabilizes, e.g. to
</a><a href="#h6-0-198" id="h6-0-198" class="i">+                // propagate the commit index.
</a><a href="#h6-0-199" id="h6-0-199" class="i">+                &quot;stabilize&quot; =&gt; {
</a><a href="#h6-0-200" id="h6-0-200" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.pos_args())?;
</a><a href="#h6-0-201" id="h6-0-201" class="i">+                    let mut heartbeat = false;
</a><a href="#h6-0-202" id="h6-0-202" class="i">+                    for arg in command.key_args() {
</a><a href="#h6-0-203" id="h6-0-203" class="i">+                        match arg.key.as_deref().unwrap() {
</a><a href="#h6-0-204" id="h6-0-204" class="i">+                            &quot;heartbeat&quot; =&gt; heartbeat = arg.parse()?,
</a><a href="#h6-0-205" id="h6-0-205" class="i">+                            key =&gt; return Err(format!(&quot;invalid argument &#39;{key}&#39;&quot;).into()),
</a><a href="#h6-0-206" id="h6-0-206" class="i">+                        }
</a><a href="#h6-0-207" id="h6-0-207" class="i">+                    }
</a><a href="#h6-0-208" id="h6-0-208" class="i">+                    self.stabilize(&amp;ids, heartbeat, &amp;mut output)?;
</a><a href="#h6-0-209" id="h6-0-209" class="i">+                }
</a><a href="#h6-0-210" id="h6-0-210" class="i">+
</a><a href="#h6-0-211" id="h6-0-211" class="i">+                // state [ID...]
</a><a href="#h6-0-212" id="h6-0-212" class="i">+                //
</a><a href="#h6-0-213" id="h6-0-213" class="i">+                // Prints the current state machine contents on the given nodes.
</a><a href="#h6-0-214" id="h6-0-214" class="i">+                &quot;state&quot; =&gt; {
</a><a href="#h6-0-215" id="h6-0-215" class="i">+                    let ids = self.parse_ids_or_error(&amp;command.args)?;
</a><a href="#h6-0-216" id="h6-0-216" class="i">+                    self.state(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-217" id="h6-0-217" class="i">+                }
</a><a href="#h6-0-218" id="h6-0-218" class="i">+
</a><a href="#h6-0-219" id="h6-0-219" class="i">+                // status [request=BOOL] [ID...]
</a><a href="#h6-0-220" id="h6-0-220" class="i">+                //
</a><a href="#h6-0-221" id="h6-0-221" class="i">+                // Prints the current node status of the given nodes. If request
</a><a href="#h6-0-222" id="h6-0-222" class="i">+                // is true, sends a status client request to a single node,
</a><a href="#h6-0-223" id="h6-0-223" class="i">+                // otherwise fetches status directly from each node.
</a><a href="#h6-0-224" id="h6-0-224" class="i">+                &quot;status&quot; =&gt; {
</a><a href="#h6-0-225" id="h6-0-225" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.pos_args())?;
</a><a href="#h6-0-226" id="h6-0-226" class="i">+                    let mut request = false;
</a><a href="#h6-0-227" id="h6-0-227" class="i">+                    for arg in command.key_args() {
</a><a href="#h6-0-228" id="h6-0-228" class="i">+                        match arg.key.as_deref().unwrap() {
</a><a href="#h6-0-229" id="h6-0-229" class="i">+                            &quot;request&quot; =&gt; request = arg.parse()?,
</a><a href="#h6-0-230" id="h6-0-230" class="i">+                            key =&gt; return Err(format!(&quot;invalid argument &#39;{key}&#39;&quot;).into()),
</a><a href="#h6-0-231" id="h6-0-231" class="i">+                        }
</a><a href="#h6-0-232" id="h6-0-232" class="i">+                    }
</a><a href="#h6-0-233" id="h6-0-233" class="i">+                    if request {
</a><a href="#h6-0-234" id="h6-0-234" class="i">+                        if ids.len() != 1 {
</a><a href="#h6-0-235" id="h6-0-235" class="i">+                            return Err(&quot;request=true requires 1 node ID&quot;.into());
</a><a href="#h6-0-236" id="h6-0-236" class="i">+                        }
</a><a href="#h6-0-237" id="h6-0-237" class="i">+                        self.request(ids[0], Request::Status, &amp;mut output)?;
</a><a href="#h6-0-238" id="h6-0-238" class="i">+                    } else {
</a><a href="#h6-0-239" id="h6-0-239" class="i">+                        self.status(&amp;ids, &amp;mut output)?;
</a><a href="#h6-0-240" id="h6-0-240" class="i">+                    }
</a><a href="#h6-0-241" id="h6-0-241" class="i">+                }
</a><a href="#h6-0-242" id="h6-0-242" class="i">+
</a><a href="#h6-0-243" id="h6-0-243" class="i">+                // step ID JSON
</a><a href="#h6-0-244" id="h6-0-244" class="i">+                //
</a><a href="#h6-0-245" id="h6-0-245" class="i">+                // Steps a manually generated JSON message on the given node.
</a><a href="#h6-0-246" id="h6-0-246" class="i">+                &quot;step&quot; =&gt; {
</a><a href="#h6-0-247" id="h6-0-247" class="i">+                    let mut pos_args = command.pos_args().into_iter();
</a><a href="#h6-0-248" id="h6-0-248" class="i">+                    let id = pos_args.next().ok_or(&quot;node ID not given&quot;)?.parse()?;
</a><a href="#h6-0-249" id="h6-0-249" class="i">+                    let raw = pos_args.next().ok_or(&quot;message not given&quot;)?.value.clone();
</a><a href="#h6-0-250" id="h6-0-250" class="i">+                    let msg = serde_json::from_str(&amp;raw)?;
</a><a href="#h6-0-251" id="h6-0-251" class="i">+                    self.reject_args(&amp;pos_args.collect_vec())?;
</a><a href="#h6-0-252" id="h6-0-252" class="i">+                    let mut panic = false;
</a><a href="#h6-0-253" id="h6-0-253" class="i">+                    for arg in command.key_args() {
</a><a href="#h6-0-254" id="h6-0-254" class="i">+                        match arg.key.as_deref().unwrap() {
</a><a href="#h6-0-255" id="h6-0-255" class="i">+                            &quot;panic&quot; =&gt; panic = arg.parse()?,
</a><a href="#h6-0-256" id="h6-0-256" class="i">+                            key =&gt; return Err(format!(&quot;unknown key &#39;{key}&#39;&quot;).into()),
</a><a href="#h6-0-257" id="h6-0-257" class="i">+                        }
</a><a href="#h6-0-258" id="h6-0-258" class="i">+                    }
</a><a href="#h6-0-259" id="h6-0-259" class="i">+                    self.transition_catch(id, |n| n.step(msg), panic, &amp;mut output)?;
</a><a href="#h6-0-260" id="h6-0-260" class="i">+                }
</a><a href="#h6-0-261" id="h6-0-261" class="i">+
</a><a href="#h6-0-262" id="h6-0-262" class="i">+                // tick [ID...]
</a><a href="#h6-0-263" id="h6-0-263" class="i">+                //
</a><a href="#h6-0-264" id="h6-0-264" class="i">+                // Ticks the given nodes.
</a><a href="#h6-0-265" id="h6-0-265" class="i">+                &quot;tick&quot; =&gt; {
</a><a href="#h6-0-266" id="h6-0-266" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a><a href="#h6-0-267" id="h6-0-267" class="i">+                    for id in ids {
</a><a href="#h6-0-268" id="h6-0-268" class="i">+                        self.transition(id, |n| n.tick(), &amp;mut output)?;
</a><a href="#h6-0-269" id="h6-0-269" class="i">+                    }
</a><a href="#h6-0-270" id="h6-0-270" class="i">+                }
</a><a href="#h6-0-271" id="h6-0-271" class="i">+
</a><a href="#h6-0-272" id="h6-0-272" class="i">+                name =&gt; return Err(format!(&quot;unknown command {name}&quot;).into()),
</a><a href="#h6-0-273" id="h6-0-273" class="i">+            }
</a><a href="#h6-0-274" id="h6-0-274" class="i">+            Ok(output)
</a>         }
<a href="#h6-0-276" id="h6-0-276" class="i">+    }
</a> 
<a href="#h6-0-278" id="h6-0-278" class="d">-        fn log(&amp;mut self) -&gt; &amp;&#39;_ mut Log {
</a><a href="#h6-0-279" id="h6-0-279" class="d">-            match self.node {
</a><a href="#h6-0-280" id="h6-0-280" class="d">-                Node::Candidate(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-281" id="h6-0-281" class="d">-                Node::Follower(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-282" id="h6-0-282" class="d">-                Node::Leader(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-283" id="h6-0-283" class="i">+    impl TestRunner {
</a><a href="#h6-0-284" id="h6-0-284" class="i">+        fn new() -&gt; Self {
</a><a href="#h6-0-285" id="h6-0-285" class="i">+            Self { next_request_id: 1, ..Default::default() }
</a><a href="#h6-0-286" id="h6-0-286" class="i">+        }
</a><a href="#h6-0-287" id="h6-0-287" class="i">+
</a><a href="#h6-0-288" id="h6-0-288" class="i">+        /// Makes the given nodes campaign, by transitioning to candidates.
</a><a href="#h6-0-289" id="h6-0-289" class="i">+        fn campaign(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-290" id="h6-0-290" class="i">+            let campaign = |node| match node {
</a><a href="#h6-0-291" id="h6-0-291" class="i">+                Node::Candidate(mut node) =&gt; {
</a><a href="#h6-0-292" id="h6-0-292" class="i">+                    node.campaign()?;
</a><a href="#h6-0-293" id="h6-0-293" class="i">+                    Ok(node.into())
</a><a href="#h6-0-294" id="h6-0-294" class="i">+                }
</a><a href="#h6-0-295" id="h6-0-295" class="i">+                Node::Follower(node) =&gt; Ok(node.into_candidate()?.into()),
</a><a href="#h6-0-296" id="h6-0-296" class="i">+                Node::Leader(node) =&gt; {
</a><a href="#h6-0-297" id="h6-0-297" class="i">+                    Err(crate::error::Error::Internal(format!(&quot;{} is a leader&quot;, node.id)))
</a><a href="#h6-0-298" id="h6-0-298" class="i">+                }
</a><a href="#h6-0-299" id="h6-0-299" class="i">+            };
</a><a href="#h6-0-300" id="h6-0-300" class="i">+            for id in ids.iter().copied() {
</a><a href="#h6-0-301" id="h6-0-301" class="i">+                self.transition(id, campaign, output)?;
</a><a href="#h6-0-302" id="h6-0-302" class="i">+            }
</a><a href="#h6-0-303" id="h6-0-303" class="i">+            Ok(())
</a><a href="#h6-0-304" id="h6-0-304" class="i">+        }
</a><a href="#h6-0-305" id="h6-0-305" class="i">+
</a><a href="#h6-0-306" id="h6-0-306" class="i">+        /// Creates a Raft cluster.
</a><a href="#h6-0-307" id="h6-0-307" class="i">+        fn cluster(
</a><a href="#h6-0-308" id="h6-0-308" class="i">+            &amp;mut self,
</a><a href="#h6-0-309" id="h6-0-309" class="i">+            nodes: u8,
</a><a href="#h6-0-310" id="h6-0-310" class="i">+            leader: Option&lt;NodeID&gt;,
</a><a href="#h6-0-311" id="h6-0-311" class="i">+            heartbeat_interval: Ticks,
</a><a href="#h6-0-312" id="h6-0-312" class="i">+            election_timeout: Ticks,
</a><a href="#h6-0-313" id="h6-0-313" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-314" id="h6-0-314" class="i">+        ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-315" id="h6-0-315" class="i">+            if !self.ids.is_empty() {
</a><a href="#h6-0-316" id="h6-0-316" class="i">+                return Err(&quot;cluster already exists&quot;.into());
</a><a href="#h6-0-317" id="h6-0-317" class="i">+            }
</a><a href="#h6-0-318" id="h6-0-318" class="i">+            if nodes == 0 {
</a><a href="#h6-0-319" id="h6-0-319" class="i">+                return Err(&quot;cluster can&#39;t have 0 nodes&quot;.into());
</a>             }
<a href="#h6-0-321" id="h6-0-321" class="i">+
</a><a href="#h6-0-322" id="h6-0-322" class="i">+            self.ids = (1..=nodes).collect();
</a><a href="#h6-0-323" id="h6-0-323" class="i">+
</a><a href="#h6-0-324" id="h6-0-324" class="i">+            for id in self.ids.iter().copied() {
</a><a href="#h6-0-325" id="h6-0-325" class="i">+                let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h6-0-326" id="h6-0-326" class="i">+                let (applied_tx, applied_rx) = crossbeam::channel::unbounded();
</a><a href="#h6-0-327" id="h6-0-327" class="i">+                let peers = self.ids.iter().copied().filter(|i| *i != id).collect();
</a><a href="#h6-0-328" id="h6-0-328" class="i">+                let log = Log::new(crate::storage::Memory::new(), false)?;
</a><a href="#h6-0-329" id="h6-0-329" class="i">+                let state = Box::new(TestState::new(applied_tx));
</a><a href="#h6-0-330" id="h6-0-330" class="i">+                self.nodes.insert(
</a><a href="#h6-0-331" id="h6-0-331" class="i">+                    id,
</a><a href="#h6-0-332" id="h6-0-332" class="i">+                    Node::new(
</a><a href="#h6-0-333" id="h6-0-333" class="i">+                        id,
</a><a href="#h6-0-334" id="h6-0-334" class="i">+                        peers,
</a><a href="#h6-0-335" id="h6-0-335" class="i">+                        log,
</a><a href="#h6-0-336" id="h6-0-336" class="i">+                        state,
</a><a href="#h6-0-337" id="h6-0-337" class="i">+                        node_tx,
</a><a href="#h6-0-338" id="h6-0-338" class="i">+                        heartbeat_interval,
</a><a href="#h6-0-339" id="h6-0-339" class="i">+                        election_timeout..election_timeout + 1,
</a><a href="#h6-0-340" id="h6-0-340" class="i">+                    )?,
</a><a href="#h6-0-341" id="h6-0-341" class="i">+                );
</a><a href="#h6-0-342" id="h6-0-342" class="i">+                self.nodes_rx.insert(id, node_rx);
</a><a href="#h6-0-343" id="h6-0-343" class="i">+                self.nodes_pending.insert(id, Vec::new());
</a><a href="#h6-0-344" id="h6-0-344" class="i">+                self.applied_rx.insert(id, applied_rx);
</a><a href="#h6-0-345" id="h6-0-345" class="i">+                self.disconnected.insert(id, HashSet::new());
</a><a href="#h6-0-346" id="h6-0-346" class="i">+            }
</a><a href="#h6-0-347" id="h6-0-347" class="i">+
</a><a href="#h6-0-348" id="h6-0-348" class="i">+            // Promote leader if requested. Suppress output.
</a><a href="#h6-0-349" id="h6-0-349" class="i">+            if let Some(id) = leader {
</a><a href="#h6-0-350" id="h6-0-350" class="i">+                let quiet = &amp;mut String::new();
</a><a href="#h6-0-351" id="h6-0-351" class="i">+                let Some(Node::Follower(node)) = self.nodes.remove(&amp;id) else {
</a><a href="#h6-0-352" id="h6-0-352" class="i">+                    return Err(format!(&quot;invalid leader {id}&quot;).into());
</a><a href="#h6-0-353" id="h6-0-353" class="i">+                };
</a><a href="#h6-0-354" id="h6-0-354" class="i">+                self.nodes.insert(id, node.into_candidate()?.into_leader()?.into());
</a><a href="#h6-0-355" id="h6-0-355" class="i">+                self.receive(id, quiet)?;
</a><a href="#h6-0-356" id="h6-0-356" class="i">+                self.stabilize(&amp;self.ids.clone(), true, quiet)?;
</a><a href="#h6-0-357" id="h6-0-357" class="i">+            }
</a><a href="#h6-0-358" id="h6-0-358" class="i">+
</a><a href="#h6-0-359" id="h6-0-359" class="i">+            // Output final cluster status.
</a><a href="#h6-0-360" id="h6-0-360" class="i">+            self.status(&amp;self.ids, output)
</a>         }
 
<a href="#h6-0-363" id="h6-0-363" class="d">-        #[track_caller]
</a><a href="#h6-0-364" id="h6-0-364" class="d">-        fn state(&amp;mut self) -&gt; &amp;&#39;_ mut Box&lt;dyn State&gt; {
</a><a href="#h6-0-365" id="h6-0-365" class="d">-            match self.node {
</a><a href="#h6-0-366" id="h6-0-366" class="d">-                Node::Candidate(n) =&gt; &amp;mut n.state,
</a><a href="#h6-0-367" id="h6-0-367" class="d">-                Node::Follower(n) =&gt; &amp;mut n.state,
</a><a href="#h6-0-368" id="h6-0-368" class="d">-                Node::Leader(n) =&gt; &amp;mut n.state,
</a><a href="#h6-0-369" id="h6-0-369" class="i">+        /// Delivers pending inbound messages to the given nodes. If from is
</a><a href="#h6-0-370" id="h6-0-370" class="i">+        /// given, only delivers messages from the given node ID. Returns the
</a><a href="#h6-0-371" id="h6-0-371" class="i">+        /// number of delivered messages.
</a><a href="#h6-0-372" id="h6-0-372" class="i">+        fn deliver(
</a><a href="#h6-0-373" id="h6-0-373" class="i">+            &amp;mut self,
</a><a href="#h6-0-374" id="h6-0-374" class="i">+            ids: &amp;[NodeID],
</a><a href="#h6-0-375" id="h6-0-375" class="i">+            from: Option&lt;NodeID&gt;,
</a><a href="#h6-0-376" id="h6-0-376" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-377" id="h6-0-377" class="i">+        ) -&gt; Result&lt;u32, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-378" id="h6-0-378" class="i">+            // Take a snapshot of the pending queues before delivering any
</a><a href="#h6-0-379" id="h6-0-379" class="i">+            // messages. This avoids outbound messages in response to delivery
</a><a href="#h6-0-380" id="h6-0-380" class="i">+            // being delivered to higher node IDs in the same loop, which can
</a><a href="#h6-0-381" id="h6-0-381" class="i">+            // give unintuitive results.
</a><a href="#h6-0-382" id="h6-0-382" class="i">+            let mut step = Vec::new();
</a><a href="#h6-0-383" id="h6-0-383" class="i">+            for id in ids.iter().copied() {
</a><a href="#h6-0-384" id="h6-0-384" class="i">+                let Some(node_pending) = self.nodes_pending.remove(&amp;id) else {
</a><a href="#h6-0-385" id="h6-0-385" class="i">+                    return Err(format!(&quot;unknown node {id}&quot;).into());
</a><a href="#h6-0-386" id="h6-0-386" class="i">+                };
</a><a href="#h6-0-387" id="h6-0-387" class="i">+                let (deliver, requeue) = node_pending
</a><a href="#h6-0-388" id="h6-0-388" class="i">+                    .into_iter()
</a><a href="#h6-0-389" id="h6-0-389" class="i">+                    .partition(|msg| from.is_none() || from == Some(msg.from));
</a><a href="#h6-0-390" id="h6-0-390" class="i">+                self.nodes_pending.insert(id, requeue);
</a><a href="#h6-0-391" id="h6-0-391" class="i">+                step.extend(deliver);
</a><a href="#h6-0-392" id="h6-0-392" class="i">+            }
</a><a href="#h6-0-393" id="h6-0-393" class="i">+
</a><a href="#h6-0-394" id="h6-0-394" class="i">+            let delivered = step.len() as u32;
</a><a href="#h6-0-395" id="h6-0-395" class="i">+            for msg in step {
</a><a href="#h6-0-396" id="h6-0-396" class="i">+                self.transition(msg.to, |node| node.step(msg), output)?;
</a>             }
<a href="#h6-0-398" id="h6-0-398" class="i">+            Ok(delivered)
</a>         }
 
<a href="#h6-0-401" id="h6-0-401" class="d">-        #[track_caller]
</a><a href="#h6-0-402" id="h6-0-402" class="d">-        pub fn committed(mut self, index: Index) -&gt; Self {
</a><a href="#h6-0-403" id="h6-0-403" class="d">-            assert_eq!(index, self.log().get_commit_index().0, &quot;Unexpected committed index&quot;);
</a><a href="#h6-0-404" id="h6-0-404" class="d">-            self
</a><a href="#h6-0-405" id="h6-0-405" class="i">+        /// Heals the given partitioned nodes, restoring connectivity with all
</a><a href="#h6-0-406" id="h6-0-406" class="i">+        /// other nodes.
</a><a href="#h6-0-407" id="h6-0-407" class="i">+        fn heal(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-408" id="h6-0-408" class="i">+            for id in ids.iter().copied() {
</a><a href="#h6-0-409" id="h6-0-409" class="i">+                self.disconnected.insert(id, HashSet::new());
</a><a href="#h6-0-410" id="h6-0-410" class="i">+                for peers in self.disconnected.values_mut() {
</a><a href="#h6-0-411" id="h6-0-411" class="i">+                    peers.remove(&amp;id);
</a><a href="#h6-0-412" id="h6-0-412" class="i">+                }
</a><a href="#h6-0-413" id="h6-0-413" class="i">+            }
</a><a href="#h6-0-414" id="h6-0-414" class="i">+            output.push_str(&amp;Self::format_disconnected(&amp;self.disconnected));
</a><a href="#h6-0-415" id="h6-0-415" class="i">+            Ok(())
</a>         }
 
<a href="#h6-0-418" id="h6-0-418" class="d">-        #[track_caller]
</a><a href="#h6-0-419" id="h6-0-419" class="d">-        pub fn applied(mut self, index: Index) -&gt; Self {
</a><a href="#h6-0-420" id="h6-0-420" class="d">-            assert_eq!(index, self.state().get_applied_index(), &quot;Unexpected applied index&quot;);
</a><a href="#h6-0-421" id="h6-0-421" class="d">-            self
</a><a href="#h6-0-422" id="h6-0-422" class="i">+        /// Emits a heartbeat from the given leader nodes.
</a><a href="#h6-0-423" id="h6-0-423" class="i">+        fn heartbeat(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-424" id="h6-0-424" class="i">+            for id in ids.iter().copied() {
</a><a href="#h6-0-425" id="h6-0-425" class="i">+                let node = self.nodes.get_mut(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-426" id="h6-0-426" class="i">+                let Node::Leader(leader) = node else {
</a><a href="#h6-0-427" id="h6-0-427" class="i">+                    return Err(format!(&quot;{id} is not a leader&quot;).into());
</a><a href="#h6-0-428" id="h6-0-428" class="i">+                };
</a><a href="#h6-0-429" id="h6-0-429" class="i">+                leader.heartbeat()?;
</a><a href="#h6-0-430" id="h6-0-430" class="i">+                self.receive(id, output)?;
</a><a href="#h6-0-431" id="h6-0-431" class="i">+            }
</a><a href="#h6-0-432" id="h6-0-432" class="i">+            Ok(())
</a>         }
 
<a href="#h6-0-435" id="h6-0-435" class="d">-        #[track_caller]
</a><a href="#h6-0-436" id="h6-0-436" class="d">-        pub fn last(mut self, index: Index) -&gt; Self {
</a><a href="#h6-0-437" id="h6-0-437" class="d">-            assert_eq!(index, self.log().get_last_index().0, &quot;Unexpected last index&quot;);
</a><a href="#h6-0-438" id="h6-0-438" class="d">-            self
</a><a href="#h6-0-439" id="h6-0-439" class="i">+        /// Outputs the current log contents for the given nodes.
</a><a href="#h6-0-440" id="h6-0-440" class="i">+        fn log(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-441" id="h6-0-441" class="i">+            for id in ids {
</a><a href="#h6-0-442" id="h6-0-442" class="i">+                let node = self.nodes.get_mut(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-443" id="h6-0-443" class="i">+                let nodefmt = Self::format_node(node);
</a><a href="#h6-0-444" id="h6-0-444" class="i">+                let log = Self::borrow_log_mut(node);
</a><a href="#h6-0-445" id="h6-0-445" class="i">+                let (last_index, last_term) = log.get_last_index();
</a><a href="#h6-0-446" id="h6-0-446" class="i">+                let (commit_index, commit_term) = log.get_commit_index();
</a><a href="#h6-0-447" id="h6-0-447" class="i">+                output.push_str(&amp;format!(
</a><a href="#h6-0-448" id="h6-0-448" class="i">+                    &quot;{nodefmt} last={last_index}@{last_term} commit={commit_index}@{commit_term}\n&quot;,
</a><a href="#h6-0-449" id="h6-0-449" class="i">+                ));
</a><a href="#h6-0-450" id="h6-0-450" class="i">+
</a><a href="#h6-0-451" id="h6-0-451" class="i">+                let mut scan = log.scan(..)?;
</a><a href="#h6-0-452" id="h6-0-452" class="i">+                while let Some(entry) = scan.next().transpose()? {
</a><a href="#h6-0-453" id="h6-0-453" class="i">+                    output.push_str(&amp;format!(&quot;{nodefmt} entry {}\n&quot;, &amp;Self::format_entry(&amp;entry)));
</a><a href="#h6-0-454" id="h6-0-454" class="i">+                }
</a><a href="#h6-0-455" id="h6-0-455" class="i">+            }
</a><a href="#h6-0-456" id="h6-0-456" class="i">+            Ok(())
</a>         }
 
<a href="#h6-0-459" id="h6-0-459" class="d">-        #[track_caller]
</a><a href="#h6-0-460" id="h6-0-460" class="d">-        pub fn entry(mut self, entry: Entry) -&gt; Self {
</a><a href="#h6-0-461" id="h6-0-461" class="d">-            assert!(entry.index &lt;= self.log().get_last_index().0, &quot;Index beyond last entry&quot;);
</a><a href="#h6-0-462" id="h6-0-462" class="d">-            assert_eq!(entry, self.log().get(entry.index).unwrap().unwrap());
</a><a href="#h6-0-463" id="h6-0-463" class="d">-            self
</a><a href="#h6-0-464" id="h6-0-464" class="d">-        }
</a><a href="#h6-0-465" id="h6-0-465" class="d">-
</a><a href="#h6-0-466" id="h6-0-466" class="d">-        #[track_caller]
</a><a href="#h6-0-467" id="h6-0-467" class="d">-        pub fn entries(mut self, entries: Vec&lt;Entry&gt;) -&gt; Self {
</a><a href="#h6-0-468" id="h6-0-468" class="d">-            assert_eq!(entries, self.log().scan(0..).unwrap().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;().unwrap());
</a><a href="#h6-0-469" id="h6-0-469" class="d">-            self
</a><a href="#h6-0-470" id="h6-0-470" class="i">+        /// Partitions the given nodes from all other nodes in the cluster
</a><a href="#h6-0-471" id="h6-0-471" class="i">+        /// (bidirectionally). The given nodes can communicate with each other
</a><a href="#h6-0-472" id="h6-0-472" class="i">+        /// unless they were previously partitioned.
</a><a href="#h6-0-473" id="h6-0-473" class="i">+        fn partition(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-474" id="h6-0-474" class="i">+            let ids: HashSet&lt;NodeID&gt; = HashSet::from_iter(ids.iter().copied());
</a><a href="#h6-0-475" id="h6-0-475" class="i">+            for id in ids.iter().copied() {
</a><a href="#h6-0-476" id="h6-0-476" class="i">+                for peer in self.ids.iter().copied().filter(|p| !ids.contains(p)) {
</a><a href="#h6-0-477" id="h6-0-477" class="i">+                    self.disconnected.entry(id).or_default().insert(peer);
</a><a href="#h6-0-478" id="h6-0-478" class="i">+                    self.disconnected.entry(peer).or_default().insert(id);
</a><a href="#h6-0-479" id="h6-0-479" class="i">+                }
</a><a href="#h6-0-480" id="h6-0-480" class="i">+            }
</a><a href="#h6-0-481" id="h6-0-481" class="i">+            output.push_str(&amp;Self::format_disconnected(&amp;self.disconnected));
</a><a href="#h6-0-482" id="h6-0-482" class="i">+            Ok(())
</a>         }
 
<a href="#h6-0-485" id="h6-0-485" class="d">-        #[allow(clippy::wrong_self_convention)]
</a><a href="#h6-0-486" id="h6-0-486" class="d">-        #[track_caller]
</a><a href="#h6-0-487" id="h6-0-487" class="d">-        pub fn is_candidate(self) -&gt; Self {
</a><a href="#h6-0-488" id="h6-0-488" class="d">-            match self.node {
</a><a href="#h6-0-489" id="h6-0-489" class="d">-                Node::Candidate(_) =&gt; self,
</a><a href="#h6-0-490" id="h6-0-490" class="d">-                Node::Follower(_) =&gt; panic!(&quot;Expected candidate, got follower&quot;),
</a><a href="#h6-0-491" id="h6-0-491" class="d">-                Node::Leader(_) =&gt; panic!(&quot;Expected candidate, got leader&quot;),
</a><a href="#h6-0-492" id="h6-0-492" class="i">+        /// Receives outbound messages from a node, prints them, and queues them
</a><a href="#h6-0-493" id="h6-0-493" class="i">+        /// for delivery. Returns the number of received messages.
</a><a href="#h6-0-494" id="h6-0-494" class="i">+        fn receive(&amp;mut self, id: NodeID, output: &amp;mut String) -&gt; Result&lt;u32, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-495" id="h6-0-495" class="i">+            let rx = self.nodes_rx.get_mut(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-496" id="h6-0-496" class="i">+
</a><a href="#h6-0-497" id="h6-0-497" class="i">+            let mut count = 0;
</a><a href="#h6-0-498" id="h6-0-498" class="i">+            for msg in rx.try_iter() {
</a><a href="#h6-0-499" id="h6-0-499" class="i">+                count += 1;
</a><a href="#h6-0-500" id="h6-0-500" class="i">+                let (from, term, to) = (msg.from, msg.term, msg.to); // simplify formatting
</a><a href="#h6-0-501" id="h6-0-501" class="i">+
</a><a href="#h6-0-502" id="h6-0-502" class="i">+                // If the peer is disconnected, drop the message and output it.
</a><a href="#h6-0-503" id="h6-0-503" class="i">+                if self.disconnected[&amp;msg.from].contains(&amp;msg.to) {
</a><a href="#h6-0-504" id="h6-0-504" class="i">+                    output.push_str(&amp;format!(
</a><a href="#h6-0-505" id="h6-0-505" class="i">+                        &quot;n{from}@{term} ⇥ n{to} {}\n&quot;,
</a><a href="#h6-0-506" id="h6-0-506" class="i">+                        Self::format_strikethrough(&amp;Self::format_message(&amp;msg.message)),
</a><a href="#h6-0-507" id="h6-0-507" class="i">+                    ));
</a><a href="#h6-0-508" id="h6-0-508" class="i">+                    continue;
</a><a href="#h6-0-509" id="h6-0-509" class="i">+                }
</a><a href="#h6-0-510" id="h6-0-510" class="i">+
</a><a href="#h6-0-511" id="h6-0-511" class="i">+                // Intercept and output client responses.
</a><a href="#h6-0-512" id="h6-0-512" class="i">+                if msg.from == msg.to {
</a><a href="#h6-0-513" id="h6-0-513" class="i">+                    let Message::ClientResponse { id, response } = &amp;msg.message else {
</a><a href="#h6-0-514" id="h6-0-514" class="i">+                        return Err(format!(&quot;invalid self-addressed message: {msg:?}&quot;).into());
</a><a href="#h6-0-515" id="h6-0-515" class="i">+                    };
</a><a href="#h6-0-516" id="h6-0-516" class="i">+                    output.push_str(&amp;format!(
</a><a href="#h6-0-517" id="h6-0-517" class="i">+                        &quot;n{from}@{term} → c{to} {}\n&quot;,
</a><a href="#h6-0-518" id="h6-0-518" class="i">+                        Self::format_message(&amp;msg.message),
</a><a href="#h6-0-519" id="h6-0-519" class="i">+                    ));
</a><a href="#h6-0-520" id="h6-0-520" class="i">+                    let request = &amp;self.requests.remove(id).ok_or(&quot;unknown request id&quot;)?;
</a><a href="#h6-0-521" id="h6-0-521" class="i">+                    output.push_str(&amp;format!(
</a><a href="#h6-0-522" id="h6-0-522" class="i">+                        &quot;c{to}@{term} {} ⇒ {}\n&quot;,
</a><a href="#h6-0-523" id="h6-0-523" class="i">+                        Self::format_request(request),
</a><a href="#h6-0-524" id="h6-0-524" class="i">+                        Self::format_response(response),
</a><a href="#h6-0-525" id="h6-0-525" class="i">+                    ));
</a><a href="#h6-0-526" id="h6-0-526" class="i">+                    continue;
</a><a href="#h6-0-527" id="h6-0-527" class="i">+                }
</a><a href="#h6-0-528" id="h6-0-528" class="i">+
</a><a href="#h6-0-529" id="h6-0-529" class="i">+                // Output the message and queue it for delivery.
</a><a href="#h6-0-530" id="h6-0-530" class="i">+                output.push_str(&amp;format!(
</a><a href="#h6-0-531" id="h6-0-531" class="i">+                    &quot;n{from}@{term} → n{to} {}\n&quot;,
</a><a href="#h6-0-532" id="h6-0-532" class="i">+                    Self::format_message(&amp;msg.message)
</a><a href="#h6-0-533" id="h6-0-533" class="i">+                ));
</a><a href="#h6-0-534" id="h6-0-534" class="i">+                self.nodes_pending.get_mut(&amp;msg.to).ok_or(format!(&quot;unknown node {to}&quot;))?.push(msg);
</a>             }
<a href="#h6-0-536" id="h6-0-536" class="i">+            Ok(count)
</a>         }
 
<a href="#h6-0-539" id="h6-0-539" class="d">-        #[allow(clippy::wrong_self_convention)]
</a><a href="#h6-0-540" id="h6-0-540" class="d">-        #[track_caller]
</a><a href="#h6-0-541" id="h6-0-541" class="d">-        pub fn is_follower(self) -&gt; Self {
</a><a href="#h6-0-542" id="h6-0-542" class="d">-            match self.node {
</a><a href="#h6-0-543" id="h6-0-543" class="d">-                Node::Candidate(_) =&gt; panic!(&quot;Expected follower, got candidate&quot;),
</a><a href="#h6-0-544" id="h6-0-544" class="d">-                Node::Follower(_) =&gt; self,
</a><a href="#h6-0-545" id="h6-0-545" class="d">-                Node::Leader(_) =&gt; panic!(&quot;Expected follower, got leader&quot;),
</a><a href="#h6-0-546" id="h6-0-546" class="d">-            }
</a><a href="#h6-0-547" id="h6-0-547" class="d">-        }
</a><a href="#h6-0-548" id="h6-0-548" class="d">-
</a><a href="#h6-0-549" id="h6-0-549" class="d">-        #[allow(clippy::wrong_self_convention)]
</a><a href="#h6-0-550" id="h6-0-550" class="d">-        #[track_caller]
</a><a href="#h6-0-551" id="h6-0-551" class="d">-        pub fn is_leader(self) -&gt; Self {
</a><a href="#h6-0-552" id="h6-0-552" class="d">-            match self.node {
</a><a href="#h6-0-553" id="h6-0-553" class="d">-                Node::Candidate(_) =&gt; panic!(&quot;Expected leader, got candidate&quot;),
</a><a href="#h6-0-554" id="h6-0-554" class="d">-                Node::Follower(_) =&gt; panic!(&quot;Expected leader, got follower&quot;),
</a><a href="#h6-0-555" id="h6-0-555" class="d">-                Node::Leader(_) =&gt; self,
</a><a href="#h6-0-556" id="h6-0-556" class="d">-            }
</a><a href="#h6-0-557" id="h6-0-557" class="d">-        }
</a><a href="#h6-0-558" id="h6-0-558" class="d">-
</a><a href="#h6-0-559" id="h6-0-559" class="d">-        #[track_caller]
</a><a href="#h6-0-560" id="h6-0-560" class="d">-        pub fn leader(self, leader: Option&lt;NodeID&gt;) -&gt; Self {
</a><a href="#h6-0-561" id="h6-0-561" class="d">-            assert_eq!(
</a><a href="#h6-0-562" id="h6-0-562" class="d">-                leader,
</a><a href="#h6-0-563" id="h6-0-563" class="d">-                match self.node {
</a><a href="#h6-0-564" id="h6-0-564" class="d">-                    Node::Candidate(_) =&gt; None,
</a><a href="#h6-0-565" id="h6-0-565" class="d">-                    Node::Follower(n) =&gt; n.role.leader,
</a><a href="#h6-0-566" id="h6-0-566" class="d">-                    Node::Leader(_) =&gt; None,
</a><a href="#h6-0-567" id="h6-0-567" class="d">-                },
</a><a href="#h6-0-568" id="h6-0-568" class="d">-                &quot;Unexpected leader&quot;,
</a><a href="#h6-0-569" id="h6-0-569" class="d">-            );
</a><a href="#h6-0-570" id="h6-0-570" class="d">-            self
</a><a href="#h6-0-571" id="h6-0-571" class="d">-        }
</a><a href="#h6-0-572" id="h6-0-572" class="d">-
</a><a href="#h6-0-573" id="h6-0-573" class="d">-        #[track_caller]
</a><a href="#h6-0-574" id="h6-0-574" class="d">-        pub fn forwarded(self, forwarded: Vec&lt;RequestID&gt;) -&gt; Self {
</a><a href="#h6-0-575" id="h6-0-575" class="d">-            assert_eq!(
</a><a href="#h6-0-576" id="h6-0-576" class="d">-                forwarded.into_iter().collect::&lt;HashSet&lt;RequestID&gt;&gt;(),
</a><a href="#h6-0-577" id="h6-0-577" class="d">-                match self.node {
</a><a href="#h6-0-578" id="h6-0-578" class="d">-                    Node::Candidate(_) =&gt; HashSet::new(),
</a><a href="#h6-0-579" id="h6-0-579" class="d">-                    Node::Follower(n) =&gt; n.role.forwarded.clone(),
</a><a href="#h6-0-580" id="h6-0-580" class="d">-                    Node::Leader(_) =&gt; HashSet::new(),
</a><a href="#h6-0-581" id="h6-0-581" class="d">-                }
</a><a href="#h6-0-582" id="h6-0-582" class="d">-            );
</a><a href="#h6-0-583" id="h6-0-583" class="d">-            self
</a><a href="#h6-0-584" id="h6-0-584" class="d">-        }
</a><a href="#h6-0-585" id="h6-0-585" class="d">-
</a><a href="#h6-0-586" id="h6-0-586" class="d">-        #[track_caller]
</a><a href="#h6-0-587" id="h6-0-587" class="d">-        pub fn term(mut self, term: Term) -&gt; Self {
</a><a href="#h6-0-588" id="h6-0-588" class="d">-            assert_eq!(
</a><a href="#h6-0-589" id="h6-0-589" class="d">-                term,
</a><a href="#h6-0-590" id="h6-0-590" class="d">-                match self.node {
</a><a href="#h6-0-591" id="h6-0-591" class="d">-                    Node::Candidate(n) =&gt; n.term,
</a><a href="#h6-0-592" id="h6-0-592" class="d">-                    Node::Follower(n) =&gt; n.term,
</a><a href="#h6-0-593" id="h6-0-593" class="d">-                    Node::Leader(n) =&gt; n.term,
</a><a href="#h6-0-594" id="h6-0-594" class="d">-                },
</a><a href="#h6-0-595" id="h6-0-595" class="d">-                &quot;Unexpected node term&quot;,
</a><a href="#h6-0-596" id="h6-0-596" class="d">-            );
</a><a href="#h6-0-597" id="h6-0-597" class="d">-            let (saved_term, saved_voted_for) = self.log().get_term().unwrap();
</a><a href="#h6-0-598" id="h6-0-598" class="d">-            assert_eq!(saved_term, term, &quot;Incorrect term stored in log&quot;);
</a><a href="#h6-0-599" id="h6-0-599" class="d">-            assert_eq!(
</a><a href="#h6-0-600" id="h6-0-600" class="d">-                saved_voted_for,
</a><a href="#h6-0-601" id="h6-0-601" class="d">-                match self.node {
</a><a href="#h6-0-602" id="h6-0-602" class="d">-                    Node::Candidate(n) =&gt; Some(n.id),
</a><a href="#h6-0-603" id="h6-0-603" class="d">-                    Node::Follower(n) =&gt; n.role.voted_for,
</a><a href="#h6-0-604" id="h6-0-604" class="d">-                    Node::Leader(n) =&gt; Some(n.id),
</a><a href="#h6-0-605" id="h6-0-605" class="d">-                },
</a><a href="#h6-0-606" id="h6-0-606" class="d">-                &quot;Incorrect voted_for stored in log&quot;
</a><a href="#h6-0-607" id="h6-0-607" class="d">-            );
</a><a href="#h6-0-608" id="h6-0-608" class="d">-            self
</a><a href="#h6-0-609" id="h6-0-609" class="d">-        }
</a><a href="#h6-0-610" id="h6-0-610" class="d">-
</a><a href="#h6-0-611" id="h6-0-611" class="d">-        #[track_caller]
</a><a href="#h6-0-612" id="h6-0-612" class="d">-        pub fn voted_for(mut self, voted_for: Option&lt;NodeID&gt;) -&gt; Self {
</a><a href="#h6-0-613" id="h6-0-613" class="d">-            assert_eq!(
</a><a href="#h6-0-614" id="h6-0-614" class="d">-                voted_for,
</a><a href="#h6-0-615" id="h6-0-615" class="d">-                match self.node {
</a><a href="#h6-0-616" id="h6-0-616" class="d">-                    Node::Candidate(_) =&gt; None,
</a><a href="#h6-0-617" id="h6-0-617" class="d">-                    Node::Follower(n) =&gt; n.role.voted_for,
</a><a href="#h6-0-618" id="h6-0-618" class="d">-                    Node::Leader(_) =&gt; None,
</a><a href="#h6-0-619" id="h6-0-619" class="d">-                },
</a><a href="#h6-0-620" id="h6-0-620" class="d">-                &quot;Unexpected voted_for&quot;
</a><a href="#h6-0-621" id="h6-0-621" class="d">-            );
</a><a href="#h6-0-622" id="h6-0-622" class="d">-            let (_, saved_voted_for) = self.log().get_term().unwrap();
</a><a href="#h6-0-623" id="h6-0-623" class="d">-            assert_eq!(saved_voted_for, voted_for, &quot;Unexpected voted_for saved in log&quot;);
</a><a href="#h6-0-624" id="h6-0-624" class="d">-            self
</a><a href="#h6-0-625" id="h6-0-625" class="d">-        }
</a><a href="#h6-0-626" id="h6-0-626" class="d">-    }
</a><a href="#h6-0-627" id="h6-0-627" class="d">-
</a><a href="#h6-0-628" id="h6-0-628" class="d">-    pub fn assert_node(node: &amp;mut Node) -&gt; NodeAsserter {
</a><a href="#h6-0-629" id="h6-0-629" class="d">-        NodeAsserter::new(node)
</a><a href="#h6-0-630" id="h6-0-630" class="d">-    }
</a><a href="#h6-0-631" id="h6-0-631" class="d">-
</a><a href="#h6-0-632" id="h6-0-632" class="d">-    fn setup_rolenode() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a><a href="#h6-0-633" id="h6-0-633" class="d">-        setup_rolenode_peers(vec![2, 3])
</a><a href="#h6-0-634" id="h6-0-634" class="d">-    }
</a><a href="#h6-0-635" id="h6-0-635" class="d">-
</a><a href="#h6-0-636" id="h6-0-636" class="d">-    fn setup_rolenode_peers(
</a><a href="#h6-0-637" id="h6-0-637" class="d">-        peers: Vec&lt;NodeID&gt;,
</a><a href="#h6-0-638" id="h6-0-638" class="d">-    ) -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a><a href="#h6-0-639" id="h6-0-639" class="d">-        let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h6-0-640" id="h6-0-640" class="d">-        let node = RawNode {
</a><a href="#h6-0-641" id="h6-0-641" class="d">-            role: Follower::new(None, None, rand::thread_rng().gen_range(ELECTION_TIMEOUT_RANGE)),
</a><a href="#h6-0-642" id="h6-0-642" class="d">-            id: 1,
</a><a href="#h6-0-643" id="h6-0-643" class="d">-            peers: HashSet::from_iter(peers),
</a><a href="#h6-0-644" id="h6-0-644" class="d">-            term: 1,
</a><a href="#h6-0-645" id="h6-0-645" class="d">-            log: Log::new(storage::Memory::new(), false)?,
</a><a href="#h6-0-646" id="h6-0-646" class="d">-            state: Box::new(TestState::new(0)),
</a><a href="#h6-0-647" id="h6-0-647" class="d">-            heartbeat_interval: HEARTBEAT_INTERVAL,
</a><a href="#h6-0-648" id="h6-0-648" class="d">-            election_timeout_range: ELECTION_TIMEOUT_RANGE,
</a><a href="#h6-0-649" id="h6-0-649" class="d">-            node_tx,
</a><a href="#h6-0-650" id="h6-0-650" class="d">-        };
</a><a href="#h6-0-651" id="h6-0-651" class="d">-        Ok((node, node_rx))
</a><a href="#h6-0-652" id="h6-0-652" class="d">-    }
</a><a href="#h6-0-653" id="h6-0-653" class="i">+        /// Submits a client request via the given node.
</a><a href="#h6-0-654" id="h6-0-654" class="i">+        fn request(
</a><a href="#h6-0-655" id="h6-0-655" class="i">+            &amp;mut self,
</a><a href="#h6-0-656" id="h6-0-656" class="i">+            id: NodeID,
</a><a href="#h6-0-657" id="h6-0-657" class="i">+            request: Request,
</a><a href="#h6-0-658" id="h6-0-658" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-659" id="h6-0-659" class="i">+        ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-660" id="h6-0-660" class="i">+            let node = self.nodes.get(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-661" id="h6-0-661" class="i">+            let request_id = vec![self.next_request_id];
</a><a href="#h6-0-662" id="h6-0-662" class="i">+            self.next_request_id += 1;
</a><a href="#h6-0-663" id="h6-0-663" class="i">+            self.requests.insert(request_id.clone(), request.clone());
</a> 
<a href="#h6-0-665" id="h6-0-665" class="d">-    #[test]
</a><a href="#h6-0-666" id="h6-0-666" class="d">-    fn new() -&gt; Result&lt;()&gt; {
</a><a href="#h6-0-667" id="h6-0-667" class="d">-        let (node_tx, _) = crossbeam::channel::unbounded();
</a><a href="#h6-0-668" id="h6-0-668" class="d">-        let node = Node::new(
</a><a href="#h6-0-669" id="h6-0-669" class="d">-            1,
</a><a href="#h6-0-670" id="h6-0-670" class="d">-            HashSet::from([2, 3]),
</a><a href="#h6-0-671" id="h6-0-671" class="d">-            Log::new(storage::Memory::new(), false)?,
</a><a href="#h6-0-672" id="h6-0-672" class="d">-            Box::new(TestState::new(0)),
</a><a href="#h6-0-673" id="h6-0-673" class="d">-            node_tx,
</a><a href="#h6-0-674" id="h6-0-674" class="d">-            HEARTBEAT_INTERVAL,
</a><a href="#h6-0-675" id="h6-0-675" class="d">-            ELECTION_TIMEOUT_RANGE,
</a><a href="#h6-0-676" id="h6-0-676" class="d">-        )?;
</a><a href="#h6-0-677" id="h6-0-677" class="d">-        match node {
</a><a href="#h6-0-678" id="h6-0-678" class="d">-            Node::Follower(rolenode) =&gt; {
</a><a href="#h6-0-679" id="h6-0-679" class="d">-                assert_eq!(rolenode.id, 1);
</a><a href="#h6-0-680" id="h6-0-680" class="d">-                assert_eq!(rolenode.term, 0);
</a><a href="#h6-0-681" id="h6-0-681" class="d">-                assert_eq!(rolenode.peers, HashSet::from([2, 3]));
</a><a href="#h6-0-682" id="h6-0-682" class="i">+            let msg = Envelope {
</a><a href="#h6-0-683" id="h6-0-683" class="i">+                from: node.id(),
</a><a href="#h6-0-684" id="h6-0-684" class="i">+                to: node.id(),
</a><a href="#h6-0-685" id="h6-0-685" class="i">+                term: node.term(),
</a><a href="#h6-0-686" id="h6-0-686" class="i">+                message: Message::ClientRequest { id: request_id, request },
</a><a href="#h6-0-687" id="h6-0-687" class="i">+            };
</a><a href="#h6-0-688" id="h6-0-688" class="i">+            output.push_str(&amp;format!(
</a><a href="#h6-0-689" id="h6-0-689" class="i">+                &quot;c{}@{} → n{} {}\n&quot;,
</a><a href="#h6-0-690" id="h6-0-690" class="i">+                msg.from,
</a><a href="#h6-0-691" id="h6-0-691" class="i">+                msg.term,
</a><a href="#h6-0-692" id="h6-0-692" class="i">+                msg.to,
</a><a href="#h6-0-693" id="h6-0-693" class="i">+                Self::format_message(&amp;msg.message)
</a><a href="#h6-0-694" id="h6-0-694" class="i">+            ));
</a><a href="#h6-0-695" id="h6-0-695" class="i">+            self.transition(id, |n| n.step(msg), output)
</a><a href="#h6-0-696" id="h6-0-696" class="i">+        }
</a><a href="#h6-0-697" id="h6-0-697" class="i">+
</a><a href="#h6-0-698" id="h6-0-698" class="i">+        /// Stabilizes the given nodes by repeatedly delivering pending messages
</a><a href="#h6-0-699" id="h6-0-699" class="i">+        /// until no new messages are generated. If heartbeat is true, leaders
</a><a href="#h6-0-700" id="h6-0-700" class="i">+        /// then emit a heartbeat and restabilize again, e.g. to propagate the
</a><a href="#h6-0-701" id="h6-0-701" class="i">+        /// commit index.
</a><a href="#h6-0-702" id="h6-0-702" class="i">+        fn stabilize(
</a><a href="#h6-0-703" id="h6-0-703" class="i">+            &amp;mut self,
</a><a href="#h6-0-704" id="h6-0-704" class="i">+            ids: &amp;[NodeID],
</a><a href="#h6-0-705" id="h6-0-705" class="i">+            heartbeat: bool,
</a><a href="#h6-0-706" id="h6-0-706" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-707" id="h6-0-707" class="i">+        ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-708" id="h6-0-708" class="i">+            while self.deliver(ids, None, output)? &gt; 0 {}
</a><a href="#h6-0-709" id="h6-0-709" class="i">+            if heartbeat {
</a><a href="#h6-0-710" id="h6-0-710" class="i">+                // Heartbeat the current leader (with the highest term).
</a><a href="#h6-0-711" id="h6-0-711" class="i">+                if let Some(leader) = self
</a><a href="#h6-0-712" id="h6-0-712" class="i">+                    .nodes
</a><a href="#h6-0-713" id="h6-0-713" class="i">+                    .values()
</a><a href="#h6-0-714" id="h6-0-714" class="i">+                    .sorted_by_key(|n| n.term())
</a><a href="#h6-0-715" id="h6-0-715" class="i">+                    .rev()
</a><a href="#h6-0-716" id="h6-0-716" class="i">+                    .find(|n| matches!(n, Node::Leader(_)))
</a><a href="#h6-0-717" id="h6-0-717" class="i">+                    .map(|n| n.id())
</a><a href="#h6-0-718" id="h6-0-718" class="i">+                {
</a><a href="#h6-0-719" id="h6-0-719" class="i">+                    self.heartbeat(&amp;[leader], output)?;
</a><a href="#h6-0-720" id="h6-0-720" class="i">+                    self.stabilize(ids, false, output)?;
</a><a href="#h6-0-721" id="h6-0-721" class="i">+                }
</a><a href="#h6-0-722" id="h6-0-722" class="i">+            }
</a><a href="#h6-0-723" id="h6-0-723" class="i">+            Ok(())
</a><a href="#h6-0-724" id="h6-0-724" class="i">+        }
</a><a href="#h6-0-725" id="h6-0-725" class="i">+
</a><a href="#h6-0-726" id="h6-0-726" class="i">+        /// Outputs the current state machine for the given nodes.
</a><a href="#h6-0-727" id="h6-0-727" class="i">+        fn state(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-728" id="h6-0-728" class="i">+            for id in ids {
</a><a href="#h6-0-729" id="h6-0-729" class="i">+                let node = self.nodes.get_mut(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-730" id="h6-0-730" class="i">+                let state = Self::borrow_state(node);
</a><a href="#h6-0-731" id="h6-0-731" class="i">+                let applied_index = state.get_applied_index();
</a><a href="#h6-0-732" id="h6-0-732" class="i">+                let nodefmt = Self::format_node(node);
</a><a href="#h6-0-733" id="h6-0-733" class="i">+                output.push_str(&amp;format!(&quot;{nodefmt} applied={applied_index}\n&quot;));
</a><a href="#h6-0-734" id="h6-0-734" class="i">+
</a><a href="#h6-0-735" id="h6-0-735" class="i">+                let raw = state.read(TestCommand::Scan.encode()?)?;
</a><a href="#h6-0-736" id="h6-0-736" class="i">+                let kvs: Vec&lt;(String, String)&gt; = bincode::deserialize(&amp;raw)?;
</a><a href="#h6-0-737" id="h6-0-737" class="i">+                for (key, value) in kvs {
</a><a href="#h6-0-738" id="h6-0-738" class="i">+                    output.push_str(&amp;format!(&quot;{nodefmt} state {key}={value}\n&quot;));
</a><a href="#h6-0-739" id="h6-0-739" class="i">+                }
</a><a href="#h6-0-740" id="h6-0-740" class="i">+            }
</a><a href="#h6-0-741" id="h6-0-741" class="i">+            Ok(())
</a><a href="#h6-0-742" id="h6-0-742" class="i">+        }
</a><a href="#h6-0-743" id="h6-0-743" class="i">+
</a><a href="#h6-0-744" id="h6-0-744" class="i">+        /// Outputs status for the given nodes.
</a><a href="#h6-0-745" id="h6-0-745" class="i">+        fn status(&amp;self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-746" id="h6-0-746" class="i">+            for id in ids {
</a><a href="#h6-0-747" id="h6-0-747" class="i">+                let node = self.nodes.get(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-748" id="h6-0-748" class="i">+                let (last_index, last_term) = Self::borrow_log(node).get_last_index();
</a><a href="#h6-0-749" id="h6-0-749" class="i">+                let (commit_index, commit_term) = Self::borrow_log(node).get_commit_index();
</a><a href="#h6-0-750" id="h6-0-750" class="i">+                let apply_index = Self::borrow_state(node).get_applied_index();
</a><a href="#h6-0-751" id="h6-0-751" class="i">+                output.push_str(&amp;format!(
</a><a href="#h6-0-752" id="h6-0-752" class="i">+                    &quot;{} last={last_index}@{last_term} commit={commit_index}@{commit_term} apply={apply_index}&quot;,
</a><a href="#h6-0-753" id="h6-0-753" class="i">+                    Self::format_node_role(node)
</a><a href="#h6-0-754" id="h6-0-754" class="i">+                ));
</a><a href="#h6-0-755" id="h6-0-755" class="i">+                if let Node::Leader(leader) = node {
</a><a href="#h6-0-756" id="h6-0-756" class="i">+                    output.push_str(&amp;format!(
</a><a href="#h6-0-757" id="h6-0-757" class="i">+                        &quot; progress={{{}}}&quot;,
</a><a href="#h6-0-758" id="h6-0-758" class="i">+                        leader
</a><a href="#h6-0-759" id="h6-0-759" class="i">+                            .role
</a><a href="#h6-0-760" id="h6-0-760" class="i">+                            .progress
</a><a href="#h6-0-761" id="h6-0-761" class="i">+                            .iter()
</a><a href="#h6-0-762" id="h6-0-762" class="i">+                            .sorted_by_key(|(id, _)| *id)
</a><a href="#h6-0-763" id="h6-0-763" class="i">+                            .map(|(id, pr)| format!(&quot;{id}:{}→{}&quot;, pr.last, pr.next))
</a><a href="#h6-0-764" id="h6-0-764" class="i">+                            .join(&quot; &quot;)
</a><a href="#h6-0-765" id="h6-0-765" class="i">+                    ))
</a><a href="#h6-0-766" id="h6-0-766" class="i">+                }
</a><a href="#h6-0-767" id="h6-0-767" class="i">+                output.push(&#39;\n&#39;);
</a><a href="#h6-0-768" id="h6-0-768" class="i">+            }
</a><a href="#h6-0-769" id="h6-0-769" class="i">+            Ok(())
</a><a href="#h6-0-770" id="h6-0-770" class="i">+        }
</a><a href="#h6-0-771" id="h6-0-771" class="i">+
</a><a href="#h6-0-772" id="h6-0-772" class="i">+        /// Applies a node transition (typically a step or tick).
</a><a href="#h6-0-773" id="h6-0-773" class="i">+        fn transition&lt;F: FnOnce(Node) -&gt; crate::error::Result&lt;Node&gt;&gt;(
</a><a href="#h6-0-774" id="h6-0-774" class="i">+            &amp;mut self,
</a><a href="#h6-0-775" id="h6-0-775" class="i">+            id: NodeID,
</a><a href="#h6-0-776" id="h6-0-776" class="i">+            f: F,
</a><a href="#h6-0-777" id="h6-0-777" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-778" id="h6-0-778" class="i">+        ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-779" id="h6-0-779" class="i">+            self.transition_catch(id, f, false, output)
</a><a href="#h6-0-780" id="h6-0-780" class="i">+        }
</a><a href="#h6-0-781" id="h6-0-781" class="i">+
</a><a href="#h6-0-782" id="h6-0-782" class="i">+        /// Applies a node transition, catching panics if requested.
</a><a href="#h6-0-783" id="h6-0-783" class="i">+        fn transition_catch&lt;F: FnOnce(Node) -&gt; crate::error::Result&lt;Node&gt;&gt;(
</a><a href="#h6-0-784" id="h6-0-784" class="i">+            &amp;mut self,
</a><a href="#h6-0-785" id="h6-0-785" class="i">+            id: NodeID,
</a><a href="#h6-0-786" id="h6-0-786" class="i">+            f: F,
</a><a href="#h6-0-787" id="h6-0-787" class="i">+            catch_unwind: bool,
</a><a href="#h6-0-788" id="h6-0-788" class="i">+            output: &amp;mut String,
</a><a href="#h6-0-789" id="h6-0-789" class="i">+        ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a><a href="#h6-0-790" id="h6-0-790" class="i">+            let mut node = self.nodes.remove(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h6-0-791" id="h6-0-791" class="i">+            let nodefmt = Self::format_node(&amp;node);
</a><a href="#h6-0-792" id="h6-0-792" class="i">+
</a><a href="#h6-0-793" id="h6-0-793" class="i">+            let old_noderole = Self::format_node_role(&amp;node);
</a><a href="#h6-0-794" id="h6-0-794" class="i">+            let old_commit_index = Self::borrow_log(&amp;node).get_commit_index().0;
</a><a href="#h6-0-795" id="h6-0-795" class="i">+            let old_last_index = Self::borrow_log(&amp;node).get_last_index().0;
</a><a href="#h6-0-796" id="h6-0-796" class="i">+
</a><a href="#h6-0-797" id="h6-0-797" class="i">+            // Apply the transition and handle panics. We mark it as
</a><a href="#h6-0-798" id="h6-0-798" class="i">+            // AssertUnwindSafe since we&#39;ve removed the node from the nodes map,
</a><a href="#h6-0-799" id="h6-0-799" class="i">+            // so any future node access will fail anyway if we panic.
</a><a href="#h6-0-800" id="h6-0-800" class="i">+            node = match std::panic::catch_unwind(std::panic::AssertUnwindSafe(|| f(node))) {
</a><a href="#h6-0-801" id="h6-0-801" class="i">+                Ok(result) =&gt; result?,
</a><a href="#h6-0-802" id="h6-0-802" class="i">+                Err(panic) if !catch_unwind =&gt; std::panic::resume_unwind(panic),
</a><a href="#h6-0-803" id="h6-0-803" class="i">+                Err(panic) =&gt; {
</a><a href="#h6-0-804" id="h6-0-804" class="i">+                    let message = panic
</a><a href="#h6-0-805" id="h6-0-805" class="i">+                        .downcast_ref::&lt;&amp;str&gt;()
</a><a href="#h6-0-806" id="h6-0-806" class="i">+                        .map(|s| s.to_string())
</a><a href="#h6-0-807" id="h6-0-807" class="i">+                        .or_else(|| panic.downcast_ref::&lt;String&gt;().cloned())
</a><a href="#h6-0-808" id="h6-0-808" class="i">+                        .unwrap_or_else(|| std::panic::resume_unwind(panic));
</a><a href="#h6-0-809" id="h6-0-809" class="i">+                    output.push_str(&amp;format!(&quot;{nodefmt} panic: {message}\n&quot;));
</a><a href="#h6-0-810" id="h6-0-810" class="i">+                    return Ok(());
</a><a href="#h6-0-811" id="h6-0-811" class="i">+                }
</a><a href="#h6-0-812" id="h6-0-812" class="i">+            };
</a><a href="#h6-0-813" id="h6-0-813" class="i">+
</a><a href="#h6-0-814" id="h6-0-814" class="i">+            let nodefmt = Self::format_node(&amp;node);
</a><a href="#h6-0-815" id="h6-0-815" class="i">+            let noderole = Self::format_node_role(&amp;node);
</a><a href="#h6-0-816" id="h6-0-816" class="i">+
</a><a href="#h6-0-817" id="h6-0-817" class="i">+            let log = Self::borrow_log_mut(&amp;mut node);
</a><a href="#h6-0-818" id="h6-0-818" class="i">+            let (commit_index, commit_term) = log.get_commit_index();
</a><a href="#h6-0-819" id="h6-0-819" class="i">+            let appended: Vec&lt;_&gt; =
</a><a href="#h6-0-820" id="h6-0-820" class="i">+                log.scan(old_last_index + 1..)?.collect::&lt;crate::error::Result&lt;_&gt;&gt;()?;
</a><a href="#h6-0-821" id="h6-0-821" class="i">+
</a><a href="#h6-0-822" id="h6-0-822" class="i">+            self.nodes.insert(id, node);
</a><a href="#h6-0-823" id="h6-0-823" class="i">+
</a><a href="#h6-0-824" id="h6-0-824" class="i">+            // Print term/role changes.
</a><a href="#h6-0-825" id="h6-0-825" class="i">+            if old_noderole != noderole {
</a><a href="#h6-0-826" id="h6-0-826" class="i">+                output.push_str(&amp;format!(&quot;{old_noderole} ⇨ {noderole}\n&quot;))
</a><a href="#h6-0-827" id="h6-0-827" class="i">+            }
</a><a href="#h6-0-828" id="h6-0-828" class="i">+
</a><a href="#h6-0-829" id="h6-0-829" class="i">+            // Print appended entries.
</a><a href="#h6-0-830" id="h6-0-830" class="i">+            for entry in appended {
</a><a href="#h6-0-831" id="h6-0-831" class="i">+                output.push_str(&amp;format!(&quot;{nodefmt} append {}\n&quot;, Self::format_entry(&amp;entry)))
</a><a href="#h6-0-832" id="h6-0-832" class="i">+            }
</a><a href="#h6-0-833" id="h6-0-833" class="i">+
</a><a href="#h6-0-834" id="h6-0-834" class="i">+            // Print commit index changes.
</a><a href="#h6-0-835" id="h6-0-835" class="i">+            if old_commit_index != commit_index {
</a><a href="#h6-0-836" id="h6-0-836" class="i">+                output.push_str(&amp;format!(&quot;{nodefmt} commit {commit_index}@{commit_term}\n&quot;))
</a><a href="#h6-0-837" id="h6-0-837" class="i">+            }
</a><a href="#h6-0-838" id="h6-0-838" class="i">+
</a><a href="#h6-0-839" id="h6-0-839" class="i">+            // Print applied entries.
</a><a href="#h6-0-840" id="h6-0-840" class="i">+            for entry in self.applied_rx[&amp;id].try_iter() {
</a><a href="#h6-0-841" id="h6-0-841" class="i">+                output.push_str(&amp;format!(&quot;{nodefmt} apply {}\n&quot;, Self::format_entry(&amp;entry)))
</a><a href="#h6-0-842" id="h6-0-842" class="i">+            }
</a><a href="#h6-0-843" id="h6-0-843" class="i">+
</a><a href="#h6-0-844" id="h6-0-844" class="i">+            // Receive outbound messages resulting from the transition.
</a><a href="#h6-0-845" id="h6-0-845" class="i">+            self.receive(id, output)?;
</a><a href="#h6-0-846" id="h6-0-846" class="i">+
</a><a href="#h6-0-847" id="h6-0-847" class="i">+            Ok(())
</a><a href="#h6-0-848" id="h6-0-848" class="i">+        }
</a><a href="#h6-0-849" id="h6-0-849" class="i">+
</a><a href="#h6-0-850" id="h6-0-850" class="i">+        /// Parses node IDs from the given argument values. Errors on key/value
</a><a href="#h6-0-851" id="h6-0-851" class="i">+        /// arguments. Can take both [Argument] and [&amp;Argument].
</a><a href="#h6-0-852" id="h6-0-852" class="i">+        fn parse_ids&lt;A&gt;(&amp;self, args: &amp;[A]) -&gt; Result&lt;Vec&lt;NodeID&gt;, Box&lt;dyn Error&gt;&gt;
</a><a href="#h6-0-853" id="h6-0-853" class="i">+        where
</a><a href="#h6-0-854" id="h6-0-854" class="i">+            A: Borrow&lt;goldenscript::Argument&gt;,
</a><a href="#h6-0-855" id="h6-0-855" class="i">+        {
</a><a href="#h6-0-856" id="h6-0-856" class="i">+            let mut ids = Vec::new();
</a><a href="#h6-0-857" id="h6-0-857" class="i">+            for arg in args.iter().map(|a| a.borrow()) {
</a><a href="#h6-0-858" id="h6-0-858" class="i">+                if let Some(key) = &amp;arg.key {
</a><a href="#h6-0-859" id="h6-0-859" class="i">+                    return Err(format!(&quot;unknown argument &#39;{key}&#39;&quot;).into());
</a><a href="#h6-0-860" id="h6-0-860" class="i">+                }
</a><a href="#h6-0-861" id="h6-0-861" class="i">+                let id = arg.parse()?;
</a><a href="#h6-0-862" id="h6-0-862" class="i">+                if !self.nodes.contains_key(&amp;id) {
</a><a href="#h6-0-863" id="h6-0-863" class="i">+                    return Err(format!(&quot;unknown node {id}&quot;).into());
</a><a href="#h6-0-864" id="h6-0-864" class="i">+                }
</a><a href="#h6-0-865" id="h6-0-865" class="i">+                ids.push(id)
</a><a href="#h6-0-866" id="h6-0-866" class="i">+            }
</a><a href="#h6-0-867" id="h6-0-867" class="i">+            Ok(ids)
</a><a href="#h6-0-868" id="h6-0-868" class="i">+        }
</a><a href="#h6-0-869" id="h6-0-869" class="i">+
</a><a href="#h6-0-870" id="h6-0-870" class="i">+        // Parses node IDs from the given argument values, or returns all node
</a><a href="#h6-0-871" id="h6-0-871" class="i">+        // IDs if none were given.
</a><a href="#h6-0-872" id="h6-0-872" class="i">+        fn parse_ids_or_all&lt;A&gt;(&amp;self, args: &amp;[A]) -&gt; Result&lt;Vec&lt;NodeID&gt;, Box&lt;dyn Error&gt;&gt;
</a><a href="#h6-0-873" id="h6-0-873" class="i">+        where
</a><a href="#h6-0-874" id="h6-0-874" class="i">+            A: Borrow&lt;goldenscript::Argument&gt;,
</a><a href="#h6-0-875" id="h6-0-875" class="i">+        {
</a><a href="#h6-0-876" id="h6-0-876" class="i">+            let mut ids = self.parse_ids(args)?;
</a><a href="#h6-0-877" id="h6-0-877" class="i">+            if ids.is_empty() {
</a><a href="#h6-0-878" id="h6-0-878" class="i">+                ids = self.ids.clone();
</a><a href="#h6-0-879" id="h6-0-879" class="i">+            }
</a><a href="#h6-0-880" id="h6-0-880" class="i">+            Ok(ids)
</a><a href="#h6-0-881" id="h6-0-881" class="i">+        }
</a><a href="#h6-0-882" id="h6-0-882" class="i">+
</a><a href="#h6-0-883" id="h6-0-883" class="i">+        // Parses node IDs from the given argument values. Errors if no IDs were
</a><a href="#h6-0-884" id="h6-0-884" class="i">+        // given.
</a><a href="#h6-0-885" id="h6-0-885" class="i">+        fn parse_ids_or_error&lt;A&gt;(&amp;self, args: &amp;[A]) -&gt; Result&lt;Vec&lt;NodeID&gt;, Box&lt;dyn Error&gt;&gt;
</a><a href="#h6-0-886" id="h6-0-886" class="i">+        where
</a><a href="#h6-0-887" id="h6-0-887" class="i">+            A: Borrow&lt;goldenscript::Argument&gt;,
</a><a href="#h6-0-888" id="h6-0-888" class="i">+        {
</a><a href="#h6-0-889" id="h6-0-889" class="i">+            let ids = self.parse_ids(args)?;
</a><a href="#h6-0-890" id="h6-0-890" class="i">+            if ids.is_empty() {
</a><a href="#h6-0-891" id="h6-0-891" class="i">+                return Err(&quot;node ID not given&quot;.into());
</a><a href="#h6-0-892" id="h6-0-892" class="i">+            }
</a><a href="#h6-0-893" id="h6-0-893" class="i">+            Ok(ids)
</a><a href="#h6-0-894" id="h6-0-894" class="i">+        }
</a><a href="#h6-0-895" id="h6-0-895" class="i">+
</a><a href="#h6-0-896" id="h6-0-896" class="i">+        // Errors if any arguments are passed.
</a><a href="#h6-0-897" id="h6-0-897" class="i">+        fn reject_args&lt;A&gt;(&amp;self, args: &amp;[A]) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt;
</a><a href="#h6-0-898" id="h6-0-898" class="i">+        where
</a><a href="#h6-0-899" id="h6-0-899" class="i">+            A: Borrow&lt;goldenscript::Argument&gt;,
</a><a href="#h6-0-900" id="h6-0-900" class="i">+        {
</a><a href="#h6-0-901" id="h6-0-901" class="i">+            if let Some(arg) = args.first().map(|a| a.borrow()) {
</a><a href="#h6-0-902" id="h6-0-902" class="i">+                return Err(format!(&quot;unexpected argument &#39;{}&#39;&quot;, arg.name()).into());
</a><a href="#h6-0-903" id="h6-0-903" class="i">+            }
</a><a href="#h6-0-904" id="h6-0-904" class="i">+            Ok(())
</a><a href="#h6-0-905" id="h6-0-905" class="i">+        }
</a><a href="#h6-0-906" id="h6-0-906" class="i">+
</a><a href="#h6-0-907" id="h6-0-907" class="i">+        /// Formats network partitions.
</a><a href="#h6-0-908" id="h6-0-908" class="i">+        fn format_disconnected(disconnected: &amp;HashMap&lt;NodeID, HashSet&lt;NodeID&gt;&gt;) -&gt; String {
</a><a href="#h6-0-909" id="h6-0-909" class="i">+            // Return early if the cluster is fully connected.
</a><a href="#h6-0-910" id="h6-0-910" class="i">+            if disconnected.iter().all(|(_, peers)| peers.is_empty()) {
</a><a href="#h6-0-911" id="h6-0-911" class="i">+                return format!(
</a><a href="#h6-0-912" id="h6-0-912" class="i">+                    &quot;{} fully connected&quot;,
</a><a href="#h6-0-913" id="h6-0-913" class="i">+                    disconnected.keys().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;)
</a><a href="#h6-0-914" id="h6-0-914" class="i">+                );
</a><a href="#h6-0-915" id="h6-0-915" class="i">+            }
</a><a href="#h6-0-916" id="h6-0-916" class="i">+
</a><a href="#h6-0-917" id="h6-0-917" class="i">+            let mut output = String::new();
</a><a href="#h6-0-918" id="h6-0-918" class="i">+
</a><a href="#h6-0-919" id="h6-0-919" class="i">+            // Separate symmetric and asymmetric partitions.
</a><a href="#h6-0-920" id="h6-0-920" class="i">+            let mut symmetric: HashMap&lt;NodeID, HashSet&lt;NodeID&gt;&gt; = HashMap::new();
</a><a href="#h6-0-921" id="h6-0-921" class="i">+            let mut asymmetric: HashMap&lt;NodeID, HashSet&lt;NodeID&gt;&gt; = HashMap::new();
</a><a href="#h6-0-922" id="h6-0-922" class="i">+            for (id, peers) in disconnected {
</a><a href="#h6-0-923" id="h6-0-923" class="i">+                for peer in peers {
</a><a href="#h6-0-924" id="h6-0-924" class="i">+                    if disconnected[peer].contains(id) {
</a><a href="#h6-0-925" id="h6-0-925" class="i">+                        symmetric.entry(*id).or_default().insert(*peer);
</a><a href="#h6-0-926" id="h6-0-926" class="i">+                    } else {
</a><a href="#h6-0-927" id="h6-0-927" class="i">+                        asymmetric.entry(*id).or_default().insert(*peer);
</a><a href="#h6-0-928" id="h6-0-928" class="i">+                    }
</a><a href="#h6-0-929" id="h6-0-929" class="i">+                }
</a><a href="#h6-0-930" id="h6-0-930" class="i">+            }
</a><a href="#h6-0-931" id="h6-0-931" class="i">+
</a><a href="#h6-0-932" id="h6-0-932" class="i">+            // Anchor the symmetric partitions at the node with the largest number
</a><a href="#h6-0-933" id="h6-0-933" class="i">+            // of disconnects, otherwise the smallest (first) ID.
</a><a href="#h6-0-934" id="h6-0-934" class="i">+            for (id, peers) in &amp;symmetric.clone() {
</a><a href="#h6-0-935" id="h6-0-935" class="i">+                for peer in peers {
</a><a href="#h6-0-936" id="h6-0-936" class="i">+                    // Recompute the peer set sizes for each iteration, since we
</a><a href="#h6-0-937" id="h6-0-937" class="i">+                    // modify the peer set below.
</a><a href="#h6-0-938" id="h6-0-938" class="i">+                    let len = symmetric.get(id).map(|p| p.len()).unwrap_or_default();
</a><a href="#h6-0-939" id="h6-0-939" class="i">+                    let peer_len = symmetric.get(peer).map(|p| p.len()).unwrap_or_default();
</a><a href="#h6-0-940" id="h6-0-940" class="i">+                    if len &lt; peer_len || len == peer_len &amp;&amp; id &lt; peer {
</a><a href="#h6-0-941" id="h6-0-941" class="i">+                        let Some(peers) = symmetric.get_mut(id) else {
</a><a href="#h6-0-942" id="h6-0-942" class="i">+                            continue;
</a><a href="#h6-0-943" id="h6-0-943" class="i">+                        };
</a><a href="#h6-0-944" id="h6-0-944" class="i">+                        peers.remove(peer);
</a><a href="#h6-0-945" id="h6-0-945" class="i">+                        if peers.is_empty() {
</a><a href="#h6-0-946" id="h6-0-946" class="i">+                            symmetric.remove(id);
</a><a href="#h6-0-947" id="h6-0-947" class="i">+                        }
</a><a href="#h6-0-948" id="h6-0-948" class="i">+                    }
</a><a href="#h6-0-949" id="h6-0-949" class="i">+                }
</a><a href="#h6-0-950" id="h6-0-950" class="i">+            }
</a><a href="#h6-0-951" id="h6-0-951" class="i">+
</a><a href="#h6-0-952" id="h6-0-952" class="i">+            // The values (HashSets) correspond to the RHS of a partition. Let&#39;s
</a><a href="#h6-0-953" id="h6-0-953" class="i">+            // group the LHS of the partition as well, from smallest to largest,
</a><a href="#h6-0-954" id="h6-0-954" class="i">+            // separately for symmetric and asymmetric partitions. The vector
</a><a href="#h6-0-955" id="h6-0-955" class="i">+            // contains (LHS, RHS, symmetric) groupings for each partition.
</a><a href="#h6-0-956" id="h6-0-956" class="i">+            let mut grouped: Vec&lt;(HashSet&lt;NodeID&gt;, HashSet&lt;NodeID&gt;, bool)&gt; = Vec::new();
</a><a href="#h6-0-957" id="h6-0-957" class="i">+            &#39;outer: for (id, peers, symm) in symmetric
</a><a href="#h6-0-958" id="h6-0-958" class="i">+                .into_iter()
</a><a href="#h6-0-959" id="h6-0-959" class="i">+                .map(|(i, p)| (i, p, true))
</a><a href="#h6-0-960" id="h6-0-960" class="i">+                .chain(asymmetric.into_iter().map(|(i, p)| (i, p, false)))
</a><a href="#h6-0-961" id="h6-0-961" class="i">+                .sorted_by_key(|(id, _, symm)| (*id, !symm))
</a><a href="#h6-0-962" id="h6-0-962" class="i">+            {
</a><a href="#h6-0-963" id="h6-0-963" class="i">+                // Look for an existing LHS group with the same RHS.
</a><a href="#h6-0-964" id="h6-0-964" class="i">+                for (lhs, rhs, s) in grouped.iter_mut() {
</a><a href="#h6-0-965" id="h6-0-965" class="i">+                    if peers == *rhs &amp;&amp; symm == *s {
</a><a href="#h6-0-966" id="h6-0-966" class="i">+                        lhs.insert(id);
</a><a href="#h6-0-967" id="h6-0-967" class="i">+                        continue &#39;outer;
</a><a href="#h6-0-968" id="h6-0-968" class="i">+                    }
</a><a href="#h6-0-969" id="h6-0-969" class="i">+                }
</a><a href="#h6-0-970" id="h6-0-970" class="i">+                // If we didn&#39;t find a match above, append a new LHS group.
</a><a href="#h6-0-971" id="h6-0-971" class="i">+                grouped.push((HashSet::from([id]), peers, symm))
</a><a href="#h6-0-972" id="h6-0-972" class="i">+            }
</a><a href="#h6-0-973" id="h6-0-973" class="i">+
</a><a href="#h6-0-974" id="h6-0-974" class="i">+            // Display the groups.
</a><a href="#h6-0-975" id="h6-0-975" class="i">+            for (lhs, rhs, symm) in grouped {
</a><a href="#h6-0-976" id="h6-0-976" class="i">+                output.push_str(&amp;format!(
</a><a href="#h6-0-977" id="h6-0-977" class="i">+                    &quot;{} {} {}\n&quot;,
</a><a href="#h6-0-978" id="h6-0-978" class="i">+                    lhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;),
</a><a href="#h6-0-979" id="h6-0-979" class="i">+                    if symm { &#39;⇹&#39; } else { &#39;⇥&#39; },
</a><a href="#h6-0-980" id="h6-0-980" class="i">+                    rhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;),
</a><a href="#h6-0-981" id="h6-0-981" class="i">+                ))
</a><a href="#h6-0-982" id="h6-0-982" class="i">+            }
</a><a href="#h6-0-983" id="h6-0-983" class="i">+
</a><a href="#h6-0-984" id="h6-0-984" class="i">+            output
</a><a href="#h6-0-985" id="h6-0-985" class="i">+        }
</a><a href="#h6-0-986" id="h6-0-986" class="i">+
</a><a href="#h6-0-987" id="h6-0-987" class="i">+        /// Formats an entry.
</a><a href="#h6-0-988" id="h6-0-988" class="i">+        fn format_entry(entry: &amp;Entry) -&gt; String {
</a><a href="#h6-0-989" id="h6-0-989" class="i">+            let command = match entry.command.as_ref() {
</a><a href="#h6-0-990" id="h6-0-990" class="i">+                Some(raw) =&gt; TestCommand::decode(raw).expect(&quot;invalid command&quot;).to_string(),
</a><a href="#h6-0-991" id="h6-0-991" class="i">+                None =&gt; &quot;None&quot;.to_string(),
</a><a href="#h6-0-992" id="h6-0-992" class="i">+            };
</a><a href="#h6-0-993" id="h6-0-993" class="i">+            format!(&quot;{}@{} {command}&quot;, entry.index, entry.term)
</a><a href="#h6-0-994" id="h6-0-994" class="i">+        }
</a><a href="#h6-0-995" id="h6-0-995" class="i">+
</a><a href="#h6-0-996" id="h6-0-996" class="i">+        /// Formats a message.
</a><a href="#h6-0-997" id="h6-0-997" class="i">+        fn format_message(msg: &amp;Message) -&gt; String {
</a><a href="#h6-0-998" id="h6-0-998" class="i">+            match msg {
</a><a href="#h6-0-999" id="h6-0-999" class="i">+                Message::Campaign { last_index, last_term } =&gt; {
</a><a href="#h6-0-1000" id="h6-0-1000" class="i">+                    format!(&quot;Campaign last={last_index}@{last_term}&quot;)
</a><a href="#h6-0-1001" id="h6-0-1001" class="i">+                }
</a><a href="#h6-0-1002" id="h6-0-1002" class="i">+                Message::CampaignResponse { vote } =&gt; {
</a><a href="#h6-0-1003" id="h6-0-1003" class="i">+                    format!(&quot;CampaignResponse vote={vote}&quot;)
</a><a href="#h6-0-1004" id="h6-0-1004" class="i">+                }
</a><a href="#h6-0-1005" id="h6-0-1005" class="i">+                Message::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
</a><a href="#h6-0-1006" id="h6-0-1006" class="i">+                    format!(&quot;Heartbeat commit={commit_index}@{commit_term} read_seq={read_seq}&quot;)
</a><a href="#h6-0-1007" id="h6-0-1007" class="i">+                }
</a><a href="#h6-0-1008" id="h6-0-1008" class="i">+                Message::HeartbeatResponse { last_index, last_term, read_seq } =&gt; {
</a><a href="#h6-0-1009" id="h6-0-1009" class="i">+                    format!(&quot;HeartbeatResponse last={last_index}@{last_term} read_seq={read_seq}&quot;)
</a><a href="#h6-0-1010" id="h6-0-1010" class="i">+                }
</a><a href="#h6-0-1011" id="h6-0-1011" class="i">+                Message::Append { base_index, base_term, entries } =&gt; {
</a><a href="#h6-0-1012" id="h6-0-1012" class="i">+                    format!(
</a><a href="#h6-0-1013" id="h6-0-1013" class="i">+                        &quot;Append base={base_index}@{base_term} [{}]&quot;,
</a><a href="#h6-0-1014" id="h6-0-1014" class="i">+                        entries.iter().map(|e| format!(&quot;{}@{}&quot;, e.index, e.term)).join(&quot; &quot;)
</a><a href="#h6-0-1015" id="h6-0-1015" class="i">+                    )
</a><a href="#h6-0-1016" id="h6-0-1016" class="i">+                }
</a><a href="#h6-0-1017" id="h6-0-1017" class="i">+                Message::AppendResponse { reject, last_index, last_term } =&gt; {
</a><a href="#h6-0-1018" id="h6-0-1018" class="i">+                    format!(&quot;AppendResponse last={last_index}@{last_term} reject={reject}&quot;)
</a><a href="#h6-0-1019" id="h6-0-1019" class="i">+                }
</a><a href="#h6-0-1020" id="h6-0-1020" class="i">+                Message::ClientRequest { id, request } =&gt; {
</a><a href="#h6-0-1021" id="h6-0-1021" class="i">+                    format!(
</a><a href="#h6-0-1022" id="h6-0-1022" class="i">+                        &quot;ClientRequest id=0x{} {}&quot;,
</a><a href="#h6-0-1023" id="h6-0-1023" class="i">+                        hex::encode(id),
</a><a href="#h6-0-1024" id="h6-0-1024" class="i">+                        match request {
</a><a href="#h6-0-1025" id="h6-0-1025" class="i">+                            Request::Read(v) =&gt; format!(&quot;read 0x{}&quot;, hex::encode(v)),
</a><a href="#h6-0-1026" id="h6-0-1026" class="i">+                            Request::Write(v) =&gt; format!(&quot;write 0x{}&quot;, hex::encode(v)),
</a><a href="#h6-0-1027" id="h6-0-1027" class="i">+                            Request::Status =&gt; &quot;status&quot;.to_string(),
</a><a href="#h6-0-1028" id="h6-0-1028" class="i">+                        }
</a><a href="#h6-0-1029" id="h6-0-1029" class="i">+                    )
</a><a href="#h6-0-1030" id="h6-0-1030" class="i">+                }
</a><a href="#h6-0-1031" id="h6-0-1031" class="i">+                Message::ClientResponse { id, response } =&gt; {
</a><a href="#h6-0-1032" id="h6-0-1032" class="i">+                    format!(
</a><a href="#h6-0-1033" id="h6-0-1033" class="i">+                        &quot;ClientResponse id=0x{} {}&quot;,
</a><a href="#h6-0-1034" id="h6-0-1034" class="i">+                        hex::encode(id),
</a><a href="#h6-0-1035" id="h6-0-1035" class="i">+                        match response {
</a><a href="#h6-0-1036" id="h6-0-1036" class="i">+                            Ok(Response::Read(v)) =&gt; format!(&quot;read 0x{}&quot;, hex::encode(v)),
</a><a href="#h6-0-1037" id="h6-0-1037" class="i">+                            Ok(Response::Write(v)) =&gt; format!(&quot;write 0x{}&quot;, hex::encode(v)),
</a><a href="#h6-0-1038" id="h6-0-1038" class="i">+                            Ok(Response::Status(v)) =&gt; format!(&quot;status {v:?}&quot;),
</a><a href="#h6-0-1039" id="h6-0-1039" class="i">+                            Err(e) =&gt; format!(&quot;Error::{e:#?}&quot;),
</a><a href="#h6-0-1040" id="h6-0-1040" class="i">+                        }
</a><a href="#h6-0-1041" id="h6-0-1041" class="i">+                    )
</a><a href="#h6-0-1042" id="h6-0-1042" class="i">+                }
</a><a href="#h6-0-1043" id="h6-0-1043" class="i">+            }
</a><a href="#h6-0-1044" id="h6-0-1044" class="i">+        }
</a><a href="#h6-0-1045" id="h6-0-1045" class="i">+
</a><a href="#h6-0-1046" id="h6-0-1046" class="i">+        /// Formats a node identifier.
</a><a href="#h6-0-1047" id="h6-0-1047" class="i">+        fn format_node(node: &amp;Node) -&gt; String {
</a><a href="#h6-0-1048" id="h6-0-1048" class="i">+            format!(&quot;n{}@{}&quot;, node.id(), node.term())
</a><a href="#h6-0-1049" id="h6-0-1049" class="i">+        }
</a><a href="#h6-0-1050" id="h6-0-1050" class="i">+
</a><a href="#h6-0-1051" id="h6-0-1051" class="i">+        /// Formats a node identifier with role.
</a><a href="#h6-0-1052" id="h6-0-1052" class="i">+        fn format_node_role(node: &amp;Node) -&gt; String {
</a><a href="#h6-0-1053" id="h6-0-1053" class="i">+            let role = match node {
</a><a href="#h6-0-1054" id="h6-0-1054" class="i">+                Node::Candidate(_) =&gt; &quot;candidate&quot;.to_string(),
</a><a href="#h6-0-1055" id="h6-0-1055" class="i">+                Node::Follower(node) =&gt; {
</a><a href="#h6-0-1056" id="h6-0-1056" class="i">+                    format!(
</a><a href="#h6-0-1057" id="h6-0-1057" class="i">+                        &quot;follower({})&quot;,
</a><a href="#h6-0-1058" id="h6-0-1058" class="i">+                        node.role.leader.map(|id| format!(&quot;n{id}&quot;)).unwrap_or_default()
</a><a href="#h6-0-1059" id="h6-0-1059" class="i">+                    )
</a><a href="#h6-0-1060" id="h6-0-1060" class="i">+                }
</a><a href="#h6-0-1061" id="h6-0-1061" class="i">+                Node::Leader(_) =&gt; &quot;leader&quot;.to_string(),
</a><a href="#h6-0-1062" id="h6-0-1062" class="i">+            };
</a><a href="#h6-0-1063" id="h6-0-1063" class="i">+            format!(&quot;{} {role}&quot;, Self::format_node(node))
</a><a href="#h6-0-1064" id="h6-0-1064" class="i">+        }
</a><a href="#h6-0-1065" id="h6-0-1065" class="i">+
</a><a href="#h6-0-1066" id="h6-0-1066" class="i">+        /// Formats a request.
</a><a href="#h6-0-1067" id="h6-0-1067" class="i">+        fn format_request(request: &amp;Request) -&gt; String {
</a><a href="#h6-0-1068" id="h6-0-1068" class="i">+            match request {
</a><a href="#h6-0-1069" id="h6-0-1069" class="i">+                Request::Read(c) | Request::Write(c) =&gt; TestCommand::decode(c).unwrap().to_string(),
</a><a href="#h6-0-1070" id="h6-0-1070" class="i">+                Request::Status =&gt; &quot;status&quot;.to_string(),
</a><a href="#h6-0-1071" id="h6-0-1071" class="i">+            }
</a><a href="#h6-0-1072" id="h6-0-1072" class="i">+        }
</a><a href="#h6-0-1073" id="h6-0-1073" class="i">+
</a><a href="#h6-0-1074" id="h6-0-1074" class="i">+        /// Formats a response.
</a><a href="#h6-0-1075" id="h6-0-1075" class="i">+        fn format_response(response: &amp;crate::error::Result&lt;Response&gt;) -&gt; String {
</a><a href="#h6-0-1076" id="h6-0-1076" class="i">+            match response {
</a><a href="#h6-0-1077" id="h6-0-1077" class="i">+                Ok(Response::Read(r) | Response::Write(r)) =&gt; {
</a><a href="#h6-0-1078" id="h6-0-1078" class="i">+                    TestResponse::decode(r).unwrap().to_string()
</a><a href="#h6-0-1079" id="h6-0-1079" class="i">+                }
</a><a href="#h6-0-1080" id="h6-0-1080" class="i">+                Ok(Response::Status(status)) =&gt; format!(&quot;{status:#?}&quot;),
</a><a href="#h6-0-1081" id="h6-0-1081" class="i">+                Err(e) =&gt; format!(&quot;Error::{e:?} ({e})&quot;),
</a><a href="#h6-0-1082" id="h6-0-1082" class="i">+            }
</a><a href="#h6-0-1083" id="h6-0-1083" class="i">+        }
</a><a href="#h6-0-1084" id="h6-0-1084" class="i">+
</a><a href="#h6-0-1085" id="h6-0-1085" class="i">+        /// Strike-through formats the given string using a Unicode combining stroke.
</a><a href="#h6-0-1086" id="h6-0-1086" class="i">+        fn format_strikethrough(s: &amp;str) -&gt; String {
</a><a href="#h6-0-1087" id="h6-0-1087" class="i">+            s.chars().flat_map(|c| [c, &#39;\u{0336}&#39;]).collect()
</a><a href="#h6-0-1088" id="h6-0-1088" class="i">+        }
</a><a href="#h6-0-1089" id="h6-0-1089" class="i">+
</a><a href="#h6-0-1090" id="h6-0-1090" class="i">+        /// Returns a borrow for a node&#39;s log.
</a><a href="#h6-0-1091" id="h6-0-1091" class="i">+        fn borrow_log(node: &amp;Node) -&gt; &amp;&#39;_ Log {
</a><a href="#h6-0-1092" id="h6-0-1092" class="i">+            match node {
</a><a href="#h6-0-1093" id="h6-0-1093" class="i">+                Node::Candidate(n) =&gt; &amp;n.log,
</a><a href="#h6-0-1094" id="h6-0-1094" class="i">+                Node::Follower(n) =&gt; &amp;n.log,
</a><a href="#h6-0-1095" id="h6-0-1095" class="i">+                Node::Leader(n) =&gt; &amp;n.log,
</a><a href="#h6-0-1096" id="h6-0-1096" class="i">+            }
</a><a href="#h6-0-1097" id="h6-0-1097" class="i">+        }
</a><a href="#h6-0-1098" id="h6-0-1098" class="i">+
</a><a href="#h6-0-1099" id="h6-0-1099" class="i">+        /// Returns a mutable borrow for a node&#39;s log.
</a><a href="#h6-0-1100" id="h6-0-1100" class="i">+        fn borrow_log_mut(node: &amp;mut Node) -&gt; &amp;&#39;_ mut Log {
</a><a href="#h6-0-1101" id="h6-0-1101" class="i">+            match node {
</a><a href="#h6-0-1102" id="h6-0-1102" class="i">+                Node::Candidate(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-1103" id="h6-0-1103" class="i">+                Node::Follower(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-1104" id="h6-0-1104" class="i">+                Node::Leader(n) =&gt; &amp;mut n.log,
</a><a href="#h6-0-1105" id="h6-0-1105" class="i">+            }
</a><a href="#h6-0-1106" id="h6-0-1106" class="i">+        }
</a><a href="#h6-0-1107" id="h6-0-1107" class="i">+
</a><a href="#h6-0-1108" id="h6-0-1108" class="i">+        /// Returns a borrow for a node&#39;s state machine.
</a><a href="#h6-0-1109" id="h6-0-1109" class="i">+        fn borrow_state(node: &amp;Node) -&gt; &amp;&#39;_ dyn State {
</a><a href="#h6-0-1110" id="h6-0-1110" class="i">+            match node {
</a><a href="#h6-0-1111" id="h6-0-1111" class="i">+                Node::Candidate(n) =&gt; n.state.as_ref(),
</a><a href="#h6-0-1112" id="h6-0-1112" class="i">+                Node::Follower(n) =&gt; n.state.as_ref(),
</a><a href="#h6-0-1113" id="h6-0-1113" class="i">+                Node::Leader(n) =&gt; n.state.as_ref(),
</a>             }
<a href="#h6-0-1115" id="h6-0-1115" class="d">-            _ =&gt; panic!(&quot;Expected node to start as follower&quot;),
</a>         }
<a href="#h6-0-1117" id="h6-0-1117" class="d">-        Ok(())
</a>     }
 
<a href="#h6-0-1120" id="h6-0-1120" class="d">-    #[test]
</a><a href="#h6-0-1121" id="h6-0-1121" class="d">-    fn new_single() -&gt; Result&lt;()&gt; {
</a><a href="#h6-0-1122" id="h6-0-1122" class="d">-        let (node_tx, _node_rx) = crossbeam::channel::unbounded();
</a><a href="#h6-0-1123" id="h6-0-1123" class="d">-        let node = Node::new(
</a><a href="#h6-0-1124" id="h6-0-1124" class="d">-            1,
</a><a href="#h6-0-1125" id="h6-0-1125" class="d">-            HashSet::new(),
</a><a href="#h6-0-1126" id="h6-0-1126" class="d">-            Log::new(storage::Memory::new(), false)?,
</a><a href="#h6-0-1127" id="h6-0-1127" class="d">-            Box::new(TestState::new(0)),
</a><a href="#h6-0-1128" id="h6-0-1128" class="d">-            node_tx,
</a><a href="#h6-0-1129" id="h6-0-1129" class="d">-            HEARTBEAT_INTERVAL,
</a><a href="#h6-0-1130" id="h6-0-1130" class="d">-            ELECTION_TIMEOUT_RANGE,
</a><a href="#h6-0-1131" id="h6-0-1131" class="d">-        )?;
</a><a href="#h6-0-1132" id="h6-0-1132" class="d">-        match node {
</a><a href="#h6-0-1133" id="h6-0-1133" class="d">-            Node::Leader(rolenode) =&gt; {
</a><a href="#h6-0-1134" id="h6-0-1134" class="d">-                assert_eq!(rolenode.id, 1);
</a><a href="#h6-0-1135" id="h6-0-1135" class="d">-                assert_eq!(rolenode.term, 1);
</a><a href="#h6-0-1136" id="h6-0-1136" class="d">-                assert!(rolenode.peers.is_empty());
</a><a href="#h6-0-1137" id="h6-0-1137" class="i">+    /// A test state machine which stores key/value pairs. See TestCommand.
</a><a href="#h6-0-1138" id="h6-0-1138" class="i">+    struct TestState {
</a><a href="#h6-0-1139" id="h6-0-1139" class="i">+        /// The current applied index.
</a><a href="#h6-0-1140" id="h6-0-1140" class="i">+        applied_index: Index,
</a><a href="#h6-0-1141" id="h6-0-1141" class="i">+        /// The stored data.
</a><a href="#h6-0-1142" id="h6-0-1142" class="i">+        data: BTreeMap&lt;String, String&gt;,
</a><a href="#h6-0-1143" id="h6-0-1143" class="i">+        /// Sends applied entries, for output.
</a><a href="#h6-0-1144" id="h6-0-1144" class="i">+        applied_tx: Sender&lt;Entry&gt;,
</a><a href="#h6-0-1145" id="h6-0-1145" class="i">+    }
</a><a href="#h6-0-1146" id="h6-0-1146" class="i">+
</a><a href="#h6-0-1147" id="h6-0-1147" class="i">+    impl TestState {
</a><a href="#h6-0-1148" id="h6-0-1148" class="i">+        fn new(applied_tx: Sender&lt;Entry&gt;) -&gt; Self {
</a><a href="#h6-0-1149" id="h6-0-1149" class="i">+            Self { applied_index: 0, data: BTreeMap::new(), applied_tx }
</a><a href="#h6-0-1150" id="h6-0-1150" class="i">+        }
</a><a href="#h6-0-1151" id="h6-0-1151" class="i">+    }
</a><a href="#h6-0-1152" id="h6-0-1152" class="i">+
</a><a href="#h6-0-1153" id="h6-0-1153" class="i">+    impl State for TestState {
</a><a href="#h6-0-1154" id="h6-0-1154" class="i">+        fn get_applied_index(&amp;self) -&gt; Index {
</a><a href="#h6-0-1155" id="h6-0-1155" class="i">+            self.applied_index
</a><a href="#h6-0-1156" id="h6-0-1156" class="i">+        }
</a><a href="#h6-0-1157" id="h6-0-1157" class="i">+
</a><a href="#h6-0-1158" id="h6-0-1158" class="i">+        fn apply(&amp;mut self, entry: Entry) -&gt; crate::error::Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h6-0-1159" id="h6-0-1159" class="i">+            let response = entry
</a><a href="#h6-0-1160" id="h6-0-1160" class="i">+                .command
</a><a href="#h6-0-1161" id="h6-0-1161" class="i">+                .as_deref()
</a><a href="#h6-0-1162" id="h6-0-1162" class="i">+                .map(TestCommand::decode)
</a><a href="#h6-0-1163" id="h6-0-1163" class="i">+                .transpose()?
</a><a href="#h6-0-1164" id="h6-0-1164" class="i">+                .map(|c| match c {
</a><a href="#h6-0-1165" id="h6-0-1165" class="i">+                    TestCommand::Put { key, value } =&gt; {
</a><a href="#h6-0-1166" id="h6-0-1166" class="i">+                        self.data.insert(key, value);
</a><a href="#h6-0-1167" id="h6-0-1167" class="i">+                        TestResponse::Put(entry.index)
</a><a href="#h6-0-1168" id="h6-0-1168" class="i">+                    }
</a><a href="#h6-0-1169" id="h6-0-1169" class="i">+                    TestCommand::Get { .. } =&gt; panic!(&quot;get submitted as write command&quot;),
</a><a href="#h6-0-1170" id="h6-0-1170" class="i">+                    TestCommand::Scan =&gt; panic!(&quot;scan submitted as write command&quot;),
</a><a href="#h6-0-1171" id="h6-0-1171" class="i">+                })
</a><a href="#h6-0-1172" id="h6-0-1172" class="i">+                .map_or(Ok(Vec::new()), |r| r.encode())?;
</a><a href="#h6-0-1173" id="h6-0-1173" class="i">+            self.applied_index = entry.index;
</a><a href="#h6-0-1174" id="h6-0-1174" class="i">+            self.applied_tx.send(entry)?;
</a><a href="#h6-0-1175" id="h6-0-1175" class="i">+            Ok(response)
</a><a href="#h6-0-1176" id="h6-0-1176" class="i">+        }
</a><a href="#h6-0-1177" id="h6-0-1177" class="i">+
</a><a href="#h6-0-1178" id="h6-0-1178" class="i">+        fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; crate::error::Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h6-0-1179" id="h6-0-1179" class="i">+            let response = match TestCommand::decode(&amp;command)? {
</a><a href="#h6-0-1180" id="h6-0-1180" class="i">+                TestCommand::Get { key } =&gt; TestResponse::Get(self.data.get(&amp;key).cloned()),
</a><a href="#h6-0-1181" id="h6-0-1181" class="i">+                TestCommand::Scan =&gt; TestResponse::Scan(self.data.clone()),
</a><a href="#h6-0-1182" id="h6-0-1182" class="i">+                TestCommand::Put { .. } =&gt; panic!(&quot;put submitted as read command&quot;),
</a><a href="#h6-0-1183" id="h6-0-1183" class="i">+            };
</a><a href="#h6-0-1184" id="h6-0-1184" class="i">+            response.encode()
</a><a href="#h6-0-1185" id="h6-0-1185" class="i">+        }
</a><a href="#h6-0-1186" id="h6-0-1186" class="i">+    }
</a><a href="#h6-0-1187" id="h6-0-1187" class="i">+
</a><a href="#h6-0-1188" id="h6-0-1188" class="i">+    /// A TestState command. Each command returns a corresponding TestResponse.
</a><a href="#h6-0-1189" id="h6-0-1189" class="i">+    #[derive(Serialize, Deserialize)]
</a><a href="#h6-0-1190" id="h6-0-1190" class="i">+    enum TestCommand {
</a><a href="#h6-0-1191" id="h6-0-1191" class="i">+        /// Fetches the value of the given key.
</a><a href="#h6-0-1192" id="h6-0-1192" class="i">+        Get { key: String },
</a><a href="#h6-0-1193" id="h6-0-1193" class="i">+        /// Stores the given key/value pair, returning the applied index.
</a><a href="#h6-0-1194" id="h6-0-1194" class="i">+        Put { key: String, value: String },
</a><a href="#h6-0-1195" id="h6-0-1195" class="i">+        /// Returns all key/value pairs.
</a><a href="#h6-0-1196" id="h6-0-1196" class="i">+        Scan,
</a><a href="#h6-0-1197" id="h6-0-1197" class="i">+    }
</a><a href="#h6-0-1198" id="h6-0-1198" class="i">+
</a><a href="#h6-0-1199" id="h6-0-1199" class="i">+    impl std::fmt::Display for TestCommand {
</a><a href="#h6-0-1200" id="h6-0-1200" class="i">+        fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h6-0-1201" id="h6-0-1201" class="i">+            match self {
</a><a href="#h6-0-1202" id="h6-0-1202" class="i">+                Self::Get { key } =&gt; write!(f, &quot;get {key}&quot;),
</a><a href="#h6-0-1203" id="h6-0-1203" class="i">+                Self::Put { key, value } =&gt; write!(f, &quot;put {key}={value}&quot;),
</a><a href="#h6-0-1204" id="h6-0-1204" class="i">+                Self::Scan =&gt; write!(f, &quot;scan&quot;),
</a>             }
<a href="#h6-0-1206" id="h6-0-1206" class="d">-            _ =&gt; panic!(&quot;Expected leader&quot;),
</a>         }
<a href="#h6-0-1208" id="h6-0-1208" class="d">-        Ok(())
</a>     }
 
<a href="#h6-0-1211" id="h6-0-1211" class="d">-    #[test]
</a><a href="#h6-0-1212" id="h6-0-1212" class="d">-    fn into_role() -&gt; Result&lt;()&gt; {
</a><a href="#h6-0-1213" id="h6-0-1213" class="d">-        let (node, _) = setup_rolenode()?;
</a><a href="#h6-0-1214" id="h6-0-1214" class="d">-        let role = Candidate::new(node.gen_election_timeout());
</a><a href="#h6-0-1215" id="h6-0-1215" class="d">-        let new = node.into_role(role.clone());
</a><a href="#h6-0-1216" id="h6-0-1216" class="d">-        assert_eq!(new.id, 1);
</a><a href="#h6-0-1217" id="h6-0-1217" class="d">-        assert_eq!(new.term, 1);
</a><a href="#h6-0-1218" id="h6-0-1218" class="d">-        assert_eq!(new.peers, HashSet::from([2, 3]));
</a><a href="#h6-0-1219" id="h6-0-1219" class="d">-        assert_eq!(new.role, role);
</a><a href="#h6-0-1220" id="h6-0-1220" class="d">-        Ok(())
</a><a href="#h6-0-1221" id="h6-0-1221" class="i">+    impl TestCommand {
</a><a href="#h6-0-1222" id="h6-0-1222" class="i">+        fn decode(raw: &amp;[u8]) -&gt; crate::error::Result&lt;Self&gt; {
</a><a href="#h6-0-1223" id="h6-0-1223" class="i">+            bincode::deserialize(raw)
</a><a href="#h6-0-1224" id="h6-0-1224" class="i">+        }
</a><a href="#h6-0-1225" id="h6-0-1225" class="i">+
</a><a href="#h6-0-1226" id="h6-0-1226" class="i">+        fn encode(&amp;self) -&gt; crate::error::Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h6-0-1227" id="h6-0-1227" class="i">+            bincode::serialize(self)
</a><a href="#h6-0-1228" id="h6-0-1228" class="i">+        }
</a>     }
 
<a href="#h6-0-1231" id="h6-0-1231" class="d">-    #[test]
</a><a href="#h6-0-1232" id="h6-0-1232" class="d">-    fn send() -&gt; Result&lt;()&gt; {
</a><a href="#h6-0-1233" id="h6-0-1233" class="d">-        let (node, mut rx) = setup_rolenode()?;
</a><a href="#h6-0-1234" id="h6-0-1234" class="d">-        node.send(2, Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 })?;
</a><a href="#h6-0-1235" id="h6-0-1235" class="d">-        assert_messages(
</a><a href="#h6-0-1236" id="h6-0-1236" class="d">-            &amp;mut rx,
</a><a href="#h6-0-1237" id="h6-0-1237" class="d">-            vec![Envelope {
</a><a href="#h6-0-1238" id="h6-0-1238" class="d">-                from: 1,
</a><a href="#h6-0-1239" id="h6-0-1239" class="d">-                to: 2,
</a><a href="#h6-0-1240" id="h6-0-1240" class="d">-                term: 1,
</a><a href="#h6-0-1241" id="h6-0-1241" class="d">-                message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h6-0-1242" id="h6-0-1242" class="d">-            }],
</a><a href="#h6-0-1243" id="h6-0-1243" class="d">-        );
</a><a href="#h6-0-1244" id="h6-0-1244" class="d">-        Ok(())
</a><a href="#h6-0-1245" id="h6-0-1245" class="i">+    /// A TestCommand response.
</a><a href="#h6-0-1246" id="h6-0-1246" class="i">+    #[derive(Serialize, Deserialize)]
</a><a href="#h6-0-1247" id="h6-0-1247" class="i">+    enum TestResponse {
</a><a href="#h6-0-1248" id="h6-0-1248" class="i">+        /// The value for the TestCommand::Get key, or None if it does not exist.
</a><a href="#h6-0-1249" id="h6-0-1249" class="i">+        Get(Option&lt;String&gt;),
</a><a href="#h6-0-1250" id="h6-0-1250" class="i">+        /// The applied index of a TestCommand::Put command.
</a><a href="#h6-0-1251" id="h6-0-1251" class="i">+        Put(Index),
</a><a href="#h6-0-1252" id="h6-0-1252" class="i">+        /// The scanned key/value pairs.
</a><a href="#h6-0-1253" id="h6-0-1253" class="i">+        Scan(BTreeMap&lt;String, String&gt;),
</a>     }
 
<a href="#h6-0-1256" id="h6-0-1256" class="d">-    #[test]
</a><a href="#h6-0-1257" id="h6-0-1257" class="d">-    fn quorum_size() {
</a><a href="#h6-0-1258" id="h6-0-1258" class="d">-        for (size, quorum) in [(1, 1), (2, 2), (3, 2), (4, 3), (5, 3), (6, 4), (7, 4), (8, 5)] {
</a><a href="#h6-0-1259" id="h6-0-1259" class="d">-            assert_eq!(super::quorum_size(size), quorum);
</a><a href="#h6-0-1260" id="h6-0-1260" class="i">+    impl std::fmt::Display for TestResponse {
</a><a href="#h6-0-1261" id="h6-0-1261" class="i">+        fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h6-0-1262" id="h6-0-1262" class="i">+            match self {
</a><a href="#h6-0-1263" id="h6-0-1263" class="i">+                Self::Get(Some(value)) =&gt; write!(f, &quot;{value}&quot;)?,
</a><a href="#h6-0-1264" id="h6-0-1264" class="i">+                Self::Get(None) =&gt; write!(f, &quot;None&quot;)?,
</a><a href="#h6-0-1265" id="h6-0-1265" class="i">+                Self::Put(applied_index) =&gt; write!(f, &quot;{applied_index}&quot;)?,
</a><a href="#h6-0-1266" id="h6-0-1266" class="i">+                Self::Scan(scan) =&gt; {
</a><a href="#h6-0-1267" id="h6-0-1267" class="i">+                    write!(f, &quot;{}&quot;, scan.iter().map(|(k, v)| format!(&quot;{k}={v}&quot;)).join(&quot;,&quot;))?
</a><a href="#h6-0-1268" id="h6-0-1268" class="i">+                }
</a><a href="#h6-0-1269" id="h6-0-1269" class="i">+            };
</a><a href="#h6-0-1270" id="h6-0-1270" class="i">+            Ok(())
</a>         }
     }
 
<a href="#h6-0-1274" id="h6-0-1274" class="d">-    #[test]
</a><a href="#h6-0-1275" id="h6-0-1275" class="d">-    fn quorum_value() {
</a><a href="#h6-0-1276" id="h6-0-1276" class="d">-        assert_eq!(super::quorum_value(vec![1]), 1);
</a><a href="#h6-0-1277" id="h6-0-1277" class="d">-        assert_eq!(super::quorum_value(vec![1, 3, 2]), 2);
</a><a href="#h6-0-1278" id="h6-0-1278" class="d">-        assert_eq!(super::quorum_value(vec![4, 1, 3, 2]), 2);
</a><a href="#h6-0-1279" id="h6-0-1279" class="d">-        assert_eq!(super::quorum_value(vec![1, 1, 1, 2, 2]), 1);
</a><a href="#h6-0-1280" id="h6-0-1280" class="d">-        assert_eq!(super::quorum_value(vec![1, 1, 2, 2, 2]), 2);
</a><a href="#h6-0-1281" id="h6-0-1281" class="i">+    impl TestResponse {
</a><a href="#h6-0-1282" id="h6-0-1282" class="i">+        fn decode(raw: &amp;[u8]) -&gt; crate::error::Result&lt;Self&gt; {
</a><a href="#h6-0-1283" id="h6-0-1283" class="i">+            bincode::deserialize(raw)
</a><a href="#h6-0-1284" id="h6-0-1284" class="i">+        }
</a><a href="#h6-0-1285" id="h6-0-1285" class="i">+
</a><a href="#h6-0-1286" id="h6-0-1286" class="i">+        fn encode(&amp;self) -&gt; crate::error::Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h6-0-1287" id="h6-0-1287" class="i">+            bincode::serialize(self)
</a><a href="#h6-0-1288" id="h6-0-1288" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h7" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -20,45 +20,3 @@ pub trait State: Send {
</a>     /// Reads from the state machine. All errors are propagated to the caller.
     fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;&gt;;
 }
<a href="#h7-0-3" id="h7-0-3" class="d">-
</a><a href="#h7-0-4" id="h7-0-4" class="d">-#[cfg(test)]
</a><a href="#h7-0-5" id="h7-0-5" class="d">-pub mod tests {
</a><a href="#h7-0-6" id="h7-0-6" class="d">-    use super::*;
</a><a href="#h7-0-7" id="h7-0-7" class="d">-    use std::sync::{Arc, Mutex};
</a><a href="#h7-0-8" id="h7-0-8" class="d">-
</a><a href="#h7-0-9" id="h7-0-9" class="d">-    #[derive(Clone, Debug)]
</a><a href="#h7-0-10" id="h7-0-10" class="d">-    pub struct TestState {
</a><a href="#h7-0-11" id="h7-0-11" class="d">-        commands: Arc&lt;Mutex&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h7-0-12" id="h7-0-12" class="d">-        applied_index: Arc&lt;Mutex&lt;Index&gt;&gt;,
</a><a href="#h7-0-13" id="h7-0-13" class="d">-    }
</a><a href="#h7-0-14" id="h7-0-14" class="d">-
</a><a href="#h7-0-15" id="h7-0-15" class="d">-    impl TestState {
</a><a href="#h7-0-16" id="h7-0-16" class="d">-        pub fn new(applied_index: Index) -&gt; Self {
</a><a href="#h7-0-17" id="h7-0-17" class="d">-            Self {
</a><a href="#h7-0-18" id="h7-0-18" class="d">-                commands: Arc::new(Mutex::new(Vec::new())),
</a><a href="#h7-0-19" id="h7-0-19" class="d">-                applied_index: Arc::new(Mutex::new(applied_index)),
</a><a href="#h7-0-20" id="h7-0-20" class="d">-            }
</a><a href="#h7-0-21" id="h7-0-21" class="d">-        }
</a><a href="#h7-0-22" id="h7-0-22" class="d">-    }
</a><a href="#h7-0-23" id="h7-0-23" class="d">-
</a><a href="#h7-0-24" id="h7-0-24" class="d">-    impl State for TestState {
</a><a href="#h7-0-25" id="h7-0-25" class="d">-        fn get_applied_index(&amp;self) -&gt; Index {
</a><a href="#h7-0-26" id="h7-0-26" class="d">-            *self.applied_index.lock().unwrap()
</a><a href="#h7-0-27" id="h7-0-27" class="d">-        }
</a><a href="#h7-0-28" id="h7-0-28" class="d">-
</a><a href="#h7-0-29" id="h7-0-29" class="d">-        // Appends the entry to the internal command list.
</a><a href="#h7-0-30" id="h7-0-30" class="d">-        fn apply(&amp;mut self, entry: Entry) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h7-0-31" id="h7-0-31" class="d">-            if let Some(command) = &amp;entry.command {
</a><a href="#h7-0-32" id="h7-0-32" class="d">-                self.commands.lock()?.push(command.clone());
</a><a href="#h7-0-33" id="h7-0-33" class="d">-            }
</a><a href="#h7-0-34" id="h7-0-34" class="d">-            *self.applied_index.lock()? = entry.index;
</a><a href="#h7-0-35" id="h7-0-35" class="d">-            Ok(entry.command.unwrap_or_default())
</a><a href="#h7-0-36" id="h7-0-36" class="d">-        }
</a><a href="#h7-0-37" id="h7-0-37" class="d">-
</a><a href="#h7-0-38" id="h7-0-38" class="d">-        // Appends the command to the internal commands list.
</a><a href="#h7-0-39" id="h7-0-39" class="d">-        fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h7-0-40" id="h7-0-40" class="d">-            self.commands.lock()?.push(command.clone());
</a><a href="#h7-0-41" id="h7-0-41" class="d">-            Ok(command)
</a><a href="#h7-0-42" id="h7-0-42" class="d">-        }
</a><a href="#h7-0-43" id="h7-0-43" class="d">-    }
</a><a href="#h7-0-44" id="h7-0-44" class="d">-}
</a><b>diff --git a/<a id="h8" href="../file/src/raft/testscripts/append.html">src/raft/testscripts/append</a> b/<a href="../file/src/raft/testscripts/append.html">src/raft/testscripts/append</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+# Can append both a single and multiple entries.
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h8-0-3" id="h8-0-3" class="i">+---
</a><a href="#h8-0-4" id="h8-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h8-0-5" id="h8-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-6" id="h8-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-7" id="h8-0-7" class="i">+
</a><a href="#h8-0-8" id="h8-0-8" class="i">+# Partition n3 so that it does not receive writes.
</a><a href="#h8-0-9" id="h8-0-9" class="i">+partition 3
</a><a href="#h8-0-10" id="h8-0-10" class="i">+---
</a><a href="#h8-0-11" id="h8-0-11" class="i">+n3 ⇹ n1 n2
</a><a href="#h8-0-12" id="h8-0-12" class="i">+
</a><a href="#h8-0-13" id="h8-0-13" class="i">+# Propose a single write, and append it to n2.
</a><a href="#h8-0-14" id="h8-0-14" class="i">+put 1 foo=bar
</a><a href="#h8-0-15" id="h8-0-15" class="i">+---
</a><a href="#h8-0-16" id="h8-0-16" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h8-0-17" id="h8-0-17" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h8-0-18" id="h8-0-18" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h8-0-19" id="h8-0-19" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h8-0-20" id="h8-0-20" class="i">+
</a><a href="#h8-0-21" id="h8-0-21" class="i">+stabilize
</a><a href="#h8-0-22" id="h8-0-22" class="i">+---
</a><a href="#h8-0-23" id="h8-0-23" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h8-0-24" id="h8-0-24" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h8-0-25" id="h8-0-25" class="i">+n1@1 commit 2@1
</a><a href="#h8-0-26" id="h8-0-26" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h8-0-27" id="h8-0-27" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h8-0-28" id="h8-0-28" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h8-0-29" id="h8-0-29" class="i">+
</a><a href="#h8-0-30" id="h8-0-30" class="i">+# Propose another write.
</a><a href="#h8-0-31" id="h8-0-31" class="i">+put 1 a=1
</a><a href="#h8-0-32" id="h8-0-32" class="i">+---
</a><a href="#h8-0-33" id="h8-0-33" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0101610131
</a><a href="#h8-0-34" id="h8-0-34" class="i">+n1@1 append 3@1 put a=1
</a><a href="#h8-0-35" id="h8-0-35" class="i">+n1@1 → n2 Append base=2@1 [3@1]
</a><a href="#h8-0-36" id="h8-0-36" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h8-0-37" id="h8-0-37" class="i">+
</a><a href="#h8-0-38" id="h8-0-38" class="i">+stabilize
</a><a href="#h8-0-39" id="h8-0-39" class="i">+---
</a><a href="#h8-0-40" id="h8-0-40" class="i">+n2@1 append 3@1 put a=1
</a><a href="#h8-0-41" id="h8-0-41" class="i">+n2@1 → n1 AppendResponse last=3@1 reject=false
</a><a href="#h8-0-42" id="h8-0-42" class="i">+n1@1 commit 3@1
</a><a href="#h8-0-43" id="h8-0-43" class="i">+n1@1 apply 3@1 put a=1
</a><a href="#h8-0-44" id="h8-0-44" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h8-0-45" id="h8-0-45" class="i">+c1@1 put a=1 ⇒ 3
</a><a href="#h8-0-46" id="h8-0-46" class="i">+
</a><a href="#h8-0-47" id="h8-0-47" class="i">+# Heal the partition and propose another write. All writes are sent to
</a><a href="#h8-0-48" id="h8-0-48" class="i">+# n3 as a single message.
</a><a href="#h8-0-49" id="h8-0-49" class="i">+heal
</a><a href="#h8-0-50" id="h8-0-50" class="i">+---
</a><a href="#h8-0-51" id="h8-0-51" class="i">+n1 n2 n3 fully connected
</a><a href="#h8-0-52" id="h8-0-52" class="i">+
</a><a href="#h8-0-53" id="h8-0-53" class="i">+put 1 b=2
</a><a href="#h8-0-54" id="h8-0-54" class="i">+---
</a><a href="#h8-0-55" id="h8-0-55" class="i">+c1@1 → n1 ClientRequest id=0x03 write 0x0101620132
</a><a href="#h8-0-56" id="h8-0-56" class="i">+n1@1 append 4@1 put b=2
</a><a href="#h8-0-57" id="h8-0-57" class="i">+n1@1 → n2 Append base=3@1 [4@1]
</a><a href="#h8-0-58" id="h8-0-58" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h8-0-59" id="h8-0-59" class="i">+
</a><a href="#h8-0-60" id="h8-0-60" class="i">+stabilize
</a><a href="#h8-0-61" id="h8-0-61" class="i">+---
</a><a href="#h8-0-62" id="h8-0-62" class="i">+n2@1 append 4@1 put b=2
</a><a href="#h8-0-63" id="h8-0-63" class="i">+n2@1 → n1 AppendResponse last=4@1 reject=false
</a><a href="#h8-0-64" id="h8-0-64" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h8-0-65" id="h8-0-65" class="i">+n3@1 append 3@1 put a=1
</a><a href="#h8-0-66" id="h8-0-66" class="i">+n3@1 append 4@1 put b=2
</a><a href="#h8-0-67" id="h8-0-67" class="i">+n3@1 → n1 AppendResponse last=4@1 reject=false
</a><a href="#h8-0-68" id="h8-0-68" class="i">+n1@1 commit 4@1
</a><a href="#h8-0-69" id="h8-0-69" class="i">+n1@1 apply 4@1 put b=2
</a><a href="#h8-0-70" id="h8-0-70" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h8-0-71" id="h8-0-71" class="i">+c1@1 put b=2 ⇒ 4
</a><b>diff --git a/<a id="h9" href="../file/src/raft/testscripts/append_base_missing.html">src/raft/testscripts/append_base_missing</a> b/<a href="../file/src/raft/testscripts/append_base_missing.html">src/raft/testscripts/append_base_missing</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,91 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+# Appends with a base beyond the node&#39;s last log entry work.
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h9-0-3" id="h9-0-3" class="i">+---
</a><a href="#h9-0-4" id="h9-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h9-0-5" id="h9-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-6" id="h9-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-7" id="h9-0-7" class="i">+
</a><a href="#h9-0-8" id="h9-0-8" class="i">+# Partition n3 so that it does not receive writes.
</a><a href="#h9-0-9" id="h9-0-9" class="i">+partition 3
</a><a href="#h9-0-10" id="h9-0-10" class="i">+---
</a><a href="#h9-0-11" id="h9-0-11" class="i">+n3 ⇹ n1 n2
</a><a href="#h9-0-12" id="h9-0-12" class="i">+
</a><a href="#h9-0-13" id="h9-0-13" class="i">+# Replicate a couple of writes.
</a><a href="#h9-0-14" id="h9-0-14" class="i">+(put 1 a=1)
</a><a href="#h9-0-15" id="h9-0-15" class="i">+(put 1 b=2)
</a><a href="#h9-0-16" id="h9-0-16" class="i">+(stabilize heartbeat=true)
</a><a href="#h9-0-17" id="h9-0-17" class="i">+status
</a><a href="#h9-0-18" id="h9-0-18" class="i">+---
</a><a href="#h9-0-19" id="h9-0-19" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:1→2}
</a><a href="#h9-0-20" id="h9-0-20" class="i">+n2@1 follower(n1) last=3@1 commit=3@1 apply=3
</a><a href="#h9-0-21" id="h9-0-21" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-22" id="h9-0-22" class="i">+
</a><a href="#h9-0-23" id="h9-0-23" class="i">+# Elect n2 as a new leader.
</a><a href="#h9-0-24" id="h9-0-24" class="i">+(campaign 2)
</a><a href="#h9-0-25" id="h9-0-25" class="i">+(stabilize heartbeat=true)
</a><a href="#h9-0-26" id="h9-0-26" class="i">+status
</a><a href="#h9-0-27" id="h9-0-27" class="i">+---
</a><a href="#h9-0-28" id="h9-0-28" class="i">+n1@2 follower(n2) last=4@2 commit=4@2 apply=4
</a><a href="#h9-0-29" id="h9-0-29" class="i">+n2@2 leader last=4@2 commit=4@2 apply=4 progress={1:4→5 3:0→4}
</a><a href="#h9-0-30" id="h9-0-30" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-31" id="h9-0-31" class="i">+
</a><a href="#h9-0-32" id="h9-0-32" class="i">+# Heal the partition, and propose another write.
</a><a href="#h9-0-33" id="h9-0-33" class="i">+heal
</a><a href="#h9-0-34" id="h9-0-34" class="i">+put 2 c=3
</a><a href="#h9-0-35" id="h9-0-35" class="i">+---
</a><a href="#h9-0-36" id="h9-0-36" class="i">+n1 n2 n3 fully connected
</a><a href="#h9-0-37" id="h9-0-37" class="i">+c2@2 → n2 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h9-0-38" id="h9-0-38" class="i">+n2@2 append 5@2 put c=3
</a><a href="#h9-0-39" id="h9-0-39" class="i">+n2@2 → n1 Append base=4@2 [5@2]
</a><a href="#h9-0-40" id="h9-0-40" class="i">+n2@2 → n3 Append base=3@1 [4@2 5@2]
</a><a href="#h9-0-41" id="h9-0-41" class="i">+
</a><a href="#h9-0-42" id="h9-0-42" class="i">+# The 3@1 base is beyond n3&#39;s last index 1@1, so the append is rejected.
</a><a href="#h9-0-43" id="h9-0-43" class="i">+deliver 3
</a><a href="#h9-0-44" id="h9-0-44" class="i">+---
</a><a href="#h9-0-45" id="h9-0-45" class="i">+n3@1 follower(n1) ⇨ n3@2 follower(n2)
</a><a href="#h9-0-46" id="h9-0-46" class="i">+n3@2 → n2 AppendResponse last=1@1 reject=true
</a><a href="#h9-0-47" id="h9-0-47" class="i">+
</a><a href="#h9-0-48" id="h9-0-48" class="i">+# n2 reduces the base by 1 and tries again, but this is also rejected.
</a><a href="#h9-0-49" id="h9-0-49" class="i">+#
</a><a href="#h9-0-50" id="h9-0-50" class="i">+# TODO: this should retry at 1@1 immediately, since the leader knows the
</a><a href="#h9-0-51" id="h9-0-51" class="i">+# follower&#39;s last index. The progress also isn&#39;t updated.
</a><a href="#h9-0-52" id="h9-0-52" class="i">+deliver 2
</a><a href="#h9-0-53" id="h9-0-53" class="i">+status 2
</a><a href="#h9-0-54" id="h9-0-54" class="i">+---
</a><a href="#h9-0-55" id="h9-0-55" class="i">+n2@2 → n3 Append base=2@1 [3@1 4@2 5@2]
</a><a href="#h9-0-56" id="h9-0-56" class="i">+n2@2 leader last=5@2 commit=4@2 apply=4 progress={1:4→5 3:0→3}
</a><a href="#h9-0-57" id="h9-0-57" class="i">+
</a><a href="#h9-0-58" id="h9-0-58" class="i">+deliver 3
</a><a href="#h9-0-59" id="h9-0-59" class="i">+---
</a><a href="#h9-0-60" id="h9-0-60" class="i">+n3@2 → n2 AppendResponse last=1@1 reject=true
</a><a href="#h9-0-61" id="h9-0-61" class="i">+
</a><a href="#h9-0-62" id="h9-0-62" class="i">+# Finally, n2 sends base 1 which succeeds.
</a><a href="#h9-0-63" id="h9-0-63" class="i">+deliver 2
</a><a href="#h9-0-64" id="h9-0-64" class="i">+status 2
</a><a href="#h9-0-65" id="h9-0-65" class="i">+---
</a><a href="#h9-0-66" id="h9-0-66" class="i">+n2@2 → n3 Append base=1@1 [2@1 3@1 4@2 5@2]
</a><a href="#h9-0-67" id="h9-0-67" class="i">+n2@2 leader last=5@2 commit=4@2 apply=4 progress={1:4→5 3:0→2}
</a><a href="#h9-0-68" id="h9-0-68" class="i">+
</a><a href="#h9-0-69" id="h9-0-69" class="i">+deliver 3
</a><a href="#h9-0-70" id="h9-0-70" class="i">+---
</a><a href="#h9-0-71" id="h9-0-71" class="i">+n3@2 append 2@1 put a=1
</a><a href="#h9-0-72" id="h9-0-72" class="i">+n3@2 append 3@1 put b=2
</a><a href="#h9-0-73" id="h9-0-73" class="i">+n3@2 append 4@2 None
</a><a href="#h9-0-74" id="h9-0-74" class="i">+n3@2 append 5@2 put c=3
</a><a href="#h9-0-75" id="h9-0-75" class="i">+n3@2 → n2 AppendResponse last=5@2 reject=false
</a><a href="#h9-0-76" id="h9-0-76" class="i">+
</a><a href="#h9-0-77" id="h9-0-77" class="i">+# When n2 receives the ack, it commits and applies the write.
</a><a href="#h9-0-78" id="h9-0-78" class="i">+deliver 2
</a><a href="#h9-0-79" id="h9-0-79" class="i">+---
</a><a href="#h9-0-80" id="h9-0-80" class="i">+n2@2 commit 5@2
</a><a href="#h9-0-81" id="h9-0-81" class="i">+n2@2 apply 5@2 put c=3
</a><a href="#h9-0-82" id="h9-0-82" class="i">+n2@2 → c2 ClientResponse id=0x03 write 0x0105
</a><a href="#h9-0-83" id="h9-0-83" class="i">+c2@2 put c=3 ⇒ 5
</a><a href="#h9-0-84" id="h9-0-84" class="i">+
</a><a href="#h9-0-85" id="h9-0-85" class="i">+# The progress is also updated (finally).
</a><a href="#h9-0-86" id="h9-0-86" class="i">+status
</a><a href="#h9-0-87" id="h9-0-87" class="i">+---
</a><a href="#h9-0-88" id="h9-0-88" class="i">+n1@2 follower(n2) last=4@2 commit=4@2 apply=4
</a><a href="#h9-0-89" id="h9-0-89" class="i">+n2@2 leader last=5@2 commit=5@2 apply=5 progress={1:4→5 3:5→6}
</a><a href="#h9-0-90" id="h9-0-90" class="i">+n3@2 follower(n2) last=5@2 commit=1@1 apply=1
</a><b>diff --git a/<a id="h10" href="../file/src/raft/testscripts/append_commit_quorum.html">src/raft/testscripts/append_commit_quorum</a> b/<a href="../file/src/raft/testscripts/append_commit_quorum.html">src/raft/testscripts/append_commit_quorum</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,237 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+# Append results in a leader-side commit once a quorum is reached for the
</a><a href="#h10-0-1" id="h10-0-1" class="i">+# relevant entries.
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+cluster nodes=6 leader=1
</a><a href="#h10-0-4" id="h10-0-4" class="i">+---
</a><a href="#h10-0-5" id="h10-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2 6:1→2}
</a><a href="#h10-0-6" id="h10-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-7" id="h10-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-8" id="h10-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-9" id="h10-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-10" id="h10-0-10" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-11" id="h10-0-11" class="i">+
</a><a href="#h10-0-12" id="h10-0-12" class="i">+# Incrementally disconnect all nodes except one and then propose a write, to
</a><a href="#h10-0-13" id="h10-0-13" class="i">+# generate an increasing quorum index.
</a><a href="#h10-0-14" id="h10-0-14" class="i">+
</a><a href="#h10-0-15" id="h10-0-15" class="i">+# Replicating 2 to n2 does not commit.
</a><a href="#h10-0-16" id="h10-0-16" class="i">+partition 3 4 5 6
</a><a href="#h10-0-17" id="h10-0-17" class="i">+---
</a><a href="#h10-0-18" id="h10-0-18" class="i">+n1 n2 ⇹ n3 n4 n5 n6
</a><a href="#h10-0-19" id="h10-0-19" class="i">+
</a><a href="#h10-0-20" id="h10-0-20" class="i">+put 1 a=1
</a><a href="#h10-0-21" id="h10-0-21" class="i">+stabilize
</a><a href="#h10-0-22" id="h10-0-22" class="i">+---
</a><a href="#h10-0-23" id="h10-0-23" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h10-0-24" id="h10-0-24" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h10-0-25" id="h10-0-25" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h10-0-26" id="h10-0-26" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h10-0-27" id="h10-0-27" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h10-0-28" id="h10-0-28" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h10-0-29" id="h10-0-29" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h10-0-30" id="h10-0-30" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h10-0-31" id="h10-0-31" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h10-0-32" id="h10-0-32" class="i">+
</a><a href="#h10-0-33" id="h10-0-33" class="i">+status
</a><a href="#h10-0-34" id="h10-0-34" class="i">+---
</a><a href="#h10-0-35" id="h10-0-35" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2 6:1→2}
</a><a href="#h10-0-36" id="h10-0-36" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h10-0-37" id="h10-0-37" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-38" id="h10-0-38" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-39" id="h10-0-39" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-40" id="h10-0-40" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-41" id="h10-0-41" class="i">+
</a><a href="#h10-0-42" id="h10-0-42" class="i">+# Replicating 2-3 to n3 does not commit.
</a><a href="#h10-0-43" id="h10-0-43" class="i">+heal
</a><a href="#h10-0-44" id="h10-0-44" class="i">+partition 2 4 5 6
</a><a href="#h10-0-45" id="h10-0-45" class="i">+---
</a><a href="#h10-0-46" id="h10-0-46" class="i">+n1 n2 n3 n4 n5 n6 fully connected
</a><a href="#h10-0-47" id="h10-0-47" class="i">+n1 n3 ⇹ n2 n4 n5 n6
</a><a href="#h10-0-48" id="h10-0-48" class="i">+
</a><a href="#h10-0-49" id="h10-0-49" class="i">+put 1 b=2
</a><a href="#h10-0-50" id="h10-0-50" class="i">+stabilize
</a><a href="#h10-0-51" id="h10-0-51" class="i">+---
</a><a href="#h10-0-52" id="h10-0-52" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h10-0-53" id="h10-0-53" class="i">+n1@1 append 3@1 put b=2
</a><a href="#h10-0-54" id="h10-0-54" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h10-0-55" id="h10-0-55" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1]
</a><a href="#h10-0-56" id="h10-0-56" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h10-0-57" id="h10-0-57" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h10-0-58" id="h10-0-58" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h10-0-59" id="h10-0-59" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h10-0-60" id="h10-0-60" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h10-0-61" id="h10-0-61" class="i">+n3@1 → n1 AppendResponse last=3@1 reject=false
</a><a href="#h10-0-62" id="h10-0-62" class="i">+
</a><a href="#h10-0-63" id="h10-0-63" class="i">+status
</a><a href="#h10-0-64" id="h10-0-64" class="i">+---
</a><a href="#h10-0-65" id="h10-0-65" class="i">+n1@1 leader last=3@1 commit=1@1 apply=1 progress={2:2→3 3:3→4 4:1→2 5:1→2 6:1→2}
</a><a href="#h10-0-66" id="h10-0-66" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h10-0-67" id="h10-0-67" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h10-0-68" id="h10-0-68" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-69" id="h10-0-69" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-70" id="h10-0-70" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-71" id="h10-0-71" class="i">+
</a><a href="#h10-0-72" id="h10-0-72" class="i">+# Replicating 2-4 to n4 commits 2.
</a><a href="#h10-0-73" id="h10-0-73" class="i">+heal
</a><a href="#h10-0-74" id="h10-0-74" class="i">+partition 2 3 5 6
</a><a href="#h10-0-75" id="h10-0-75" class="i">+---
</a><a href="#h10-0-76" id="h10-0-76" class="i">+n1 n2 n3 n4 n5 n6 fully connected
</a><a href="#h10-0-77" id="h10-0-77" class="i">+n1 n4 ⇹ n2 n3 n5 n6
</a><a href="#h10-0-78" id="h10-0-78" class="i">+
</a><a href="#h10-0-79" id="h10-0-79" class="i">+put 1 c=3
</a><a href="#h10-0-80" id="h10-0-80" class="i">+stabilize
</a><a href="#h10-0-81" id="h10-0-81" class="i">+---
</a><a href="#h10-0-82" id="h10-0-82" class="i">+c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h10-0-83" id="h10-0-83" class="i">+n1@1 append 4@1 put c=3
</a><a href="#h10-0-84" id="h10-0-84" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a><a href="#h10-0-85" id="h10-0-85" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a><a href="#h10-0-86" id="h10-0-86" class="i">+n1@1 → n4 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h10-0-87" id="h10-0-87" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a><a href="#h10-0-88" id="h10-0-88" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a><a href="#h10-0-89" id="h10-0-89" class="i">+n4@1 append 2@1 put a=1
</a><a href="#h10-0-90" id="h10-0-90" class="i">+n4@1 append 3@1 put b=2
</a><a href="#h10-0-91" id="h10-0-91" class="i">+n4@1 append 4@1 put c=3
</a><a href="#h10-0-92" id="h10-0-92" class="i">+n4@1 → n1 AppendResponse last=4@1 reject=false
</a><a href="#h10-0-93" id="h10-0-93" class="i">+n1@1 commit 2@1
</a><a href="#h10-0-94" id="h10-0-94" class="i">+n1@1 apply 2@1 put a=1
</a><a href="#h10-0-95" id="h10-0-95" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h10-0-96" id="h10-0-96" class="i">+c1@1 put a=1 ⇒ 2
</a><a href="#h10-0-97" id="h10-0-97" class="i">+
</a><a href="#h10-0-98" id="h10-0-98" class="i">+status
</a><a href="#h10-0-99" id="h10-0-99" class="i">+---
</a><a href="#h10-0-100" id="h10-0-100" class="i">+n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→3 3:3→4 4:4→5 5:1→2 6:1→2}
</a><a href="#h10-0-101" id="h10-0-101" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h10-0-102" id="h10-0-102" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h10-0-103" id="h10-0-103" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h10-0-104" id="h10-0-104" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-105" id="h10-0-105" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-106" id="h10-0-106" class="i">+
</a><a href="#h10-0-107" id="h10-0-107" class="i">+# Replicating 2-5 to n5 commits 3.
</a><a href="#h10-0-108" id="h10-0-108" class="i">+heal
</a><a href="#h10-0-109" id="h10-0-109" class="i">+partition 2 3 4 6
</a><a href="#h10-0-110" id="h10-0-110" class="i">+---
</a><a href="#h10-0-111" id="h10-0-111" class="i">+n1 n2 n3 n4 n5 n6 fully connected
</a><a href="#h10-0-112" id="h10-0-112" class="i">+n1 n5 ⇹ n2 n3 n4 n6
</a><a href="#h10-0-113" id="h10-0-113" class="i">+
</a><a href="#h10-0-114" id="h10-0-114" class="i">+put 1 d=4
</a><a href="#h10-0-115" id="h10-0-115" class="i">+stabilize
</a><a href="#h10-0-116" id="h10-0-116" class="i">+---
</a><a href="#h10-0-117" id="h10-0-117" class="i">+c1@1 → n1 ClientRequest id=0x04 write 0x0101640134
</a><a href="#h10-0-118" id="h10-0-118" class="i">+n1@1 append 5@1 put d=4
</a><a href="#h10-0-119" id="h10-0-119" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a><a href="#h10-0-120" id="h10-0-120" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a><a href="#h10-0-121" id="h10-0-121" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶]̶
</a><a href="#h10-0-122" id="h10-0-122" class="i">+n1@1 → n5 Append base=1@1 [2@1 3@1 4@1 5@1]
</a><a href="#h10-0-123" id="h10-0-123" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a><a href="#h10-0-124" id="h10-0-124" class="i">+n5@1 append 2@1 put a=1
</a><a href="#h10-0-125" id="h10-0-125" class="i">+n5@1 append 3@1 put b=2
</a><a href="#h10-0-126" id="h10-0-126" class="i">+n5@1 append 4@1 put c=3
</a><a href="#h10-0-127" id="h10-0-127" class="i">+n5@1 append 5@1 put d=4
</a><a href="#h10-0-128" id="h10-0-128" class="i">+n5@1 → n1 AppendResponse last=5@1 reject=false
</a><a href="#h10-0-129" id="h10-0-129" class="i">+n1@1 commit 3@1
</a><a href="#h10-0-130" id="h10-0-130" class="i">+n1@1 apply 3@1 put b=2
</a><a href="#h10-0-131" id="h10-0-131" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h10-0-132" id="h10-0-132" class="i">+c1@1 put b=2 ⇒ 3
</a><a href="#h10-0-133" id="h10-0-133" class="i">+
</a><a href="#h10-0-134" id="h10-0-134" class="i">+status
</a><a href="#h10-0-135" id="h10-0-135" class="i">+---
</a><a href="#h10-0-136" id="h10-0-136" class="i">+n1@1 leader last=5@1 commit=3@1 apply=3 progress={2:2→3 3:3→4 4:4→5 5:5→6 6:1→2}
</a><a href="#h10-0-137" id="h10-0-137" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h10-0-138" id="h10-0-138" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h10-0-139" id="h10-0-139" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h10-0-140" id="h10-0-140" class="i">+n5@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><a href="#h10-0-141" id="h10-0-141" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-142" id="h10-0-142" class="i">+
</a><a href="#h10-0-143" id="h10-0-143" class="i">+# Replicating 2-6 to n6 commits 4.
</a><a href="#h10-0-144" id="h10-0-144" class="i">+heal
</a><a href="#h10-0-145" id="h10-0-145" class="i">+partition 2 3 4 5
</a><a href="#h10-0-146" id="h10-0-146" class="i">+---
</a><a href="#h10-0-147" id="h10-0-147" class="i">+n1 n2 n3 n4 n5 n6 fully connected
</a><a href="#h10-0-148" id="h10-0-148" class="i">+n1 n6 ⇹ n2 n3 n4 n5
</a><a href="#h10-0-149" id="h10-0-149" class="i">+
</a><a href="#h10-0-150" id="h10-0-150" class="i">+put 1 e=5
</a><a href="#h10-0-151" id="h10-0-151" class="i">+stabilize
</a><a href="#h10-0-152" id="h10-0-152" class="i">+---
</a><a href="#h10-0-153" id="h10-0-153" class="i">+c1@1 → n1 ClientRequest id=0x05 write 0x0101650135
</a><a href="#h10-0-154" id="h10-0-154" class="i">+n1@1 append 6@1 put e=5
</a><a href="#h10-0-155" id="h10-0-155" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h10-0-156" id="h10-0-156" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶ ̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h10-0-157" id="h10-0-157" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h10-0-158" id="h10-0-158" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶5̶@̶1̶ ̶[̶6̶@̶1̶]̶
</a><a href="#h10-0-159" id="h10-0-159" class="i">+n1@1 → n6 Append base=1@1 [2@1 3@1 4@1 5@1 6@1]
</a><a href="#h10-0-160" id="h10-0-160" class="i">+n6@1 append 2@1 put a=1
</a><a href="#h10-0-161" id="h10-0-161" class="i">+n6@1 append 3@1 put b=2
</a><a href="#h10-0-162" id="h10-0-162" class="i">+n6@1 append 4@1 put c=3
</a><a href="#h10-0-163" id="h10-0-163" class="i">+n6@1 append 5@1 put d=4
</a><a href="#h10-0-164" id="h10-0-164" class="i">+n6@1 append 6@1 put e=5
</a><a href="#h10-0-165" id="h10-0-165" class="i">+n6@1 → n1 AppendResponse last=6@1 reject=false
</a><a href="#h10-0-166" id="h10-0-166" class="i">+n1@1 commit 4@1
</a><a href="#h10-0-167" id="h10-0-167" class="i">+n1@1 apply 4@1 put c=3
</a><a href="#h10-0-168" id="h10-0-168" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h10-0-169" id="h10-0-169" class="i">+c1@1 put c=3 ⇒ 4
</a><a href="#h10-0-170" id="h10-0-170" class="i">+
</a><a href="#h10-0-171" id="h10-0-171" class="i">+status
</a><a href="#h10-0-172" id="h10-0-172" class="i">+---
</a><a href="#h10-0-173" id="h10-0-173" class="i">+n1@1 leader last=6@1 commit=4@1 apply=4 progress={2:2→3 3:3→4 4:4→5 5:5→6 6:6→7}
</a><a href="#h10-0-174" id="h10-0-174" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h10-0-175" id="h10-0-175" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h10-0-176" id="h10-0-176" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h10-0-177" id="h10-0-177" class="i">+n5@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><a href="#h10-0-178" id="h10-0-178" class="i">+n6@1 follower(n1) last=6@1 commit=1@1 apply=1
</a><a href="#h10-0-179" id="h10-0-179" class="i">+
</a><a href="#h10-0-180" id="h10-0-180" class="i">+# Healing the partition and proposing another write replicates and commits all
</a><a href="#h10-0-181" id="h10-0-181" class="i">+# entries.
</a><a href="#h10-0-182" id="h10-0-182" class="i">+heal
</a><a href="#h10-0-183" id="h10-0-183" class="i">+---
</a><a href="#h10-0-184" id="h10-0-184" class="i">+n1 n2 n3 n4 n5 n6 fully connected
</a><a href="#h10-0-185" id="h10-0-185" class="i">+
</a><a href="#h10-0-186" id="h10-0-186" class="i">+put 1 f=6
</a><a href="#h10-0-187" id="h10-0-187" class="i">+stabilize
</a><a href="#h10-0-188" id="h10-0-188" class="i">+---
</a><a href="#h10-0-189" id="h10-0-189" class="i">+c1@1 → n1 ClientRequest id=0x06 write 0x0101660136
</a><a href="#h10-0-190" id="h10-0-190" class="i">+n1@1 append 7@1 put f=6
</a><a href="#h10-0-191" id="h10-0-191" class="i">+n1@1 → n2 Append base=2@1 [3@1 4@1 5@1 6@1 7@1]
</a><a href="#h10-0-192" id="h10-0-192" class="i">+n1@1 → n3 Append base=3@1 [4@1 5@1 6@1 7@1]
</a><a href="#h10-0-193" id="h10-0-193" class="i">+n1@1 → n4 Append base=4@1 [5@1 6@1 7@1]
</a><a href="#h10-0-194" id="h10-0-194" class="i">+n1@1 → n5 Append base=5@1 [6@1 7@1]
</a><a href="#h10-0-195" id="h10-0-195" class="i">+n1@1 → n6 Append base=6@1 [7@1]
</a><a href="#h10-0-196" id="h10-0-196" class="i">+n2@1 append 3@1 put b=2
</a><a href="#h10-0-197" id="h10-0-197" class="i">+n2@1 append 4@1 put c=3
</a><a href="#h10-0-198" id="h10-0-198" class="i">+n2@1 append 5@1 put d=4
</a><a href="#h10-0-199" id="h10-0-199" class="i">+n2@1 append 6@1 put e=5
</a><a href="#h10-0-200" id="h10-0-200" class="i">+n2@1 append 7@1 put f=6
</a><a href="#h10-0-201" id="h10-0-201" class="i">+n2@1 → n1 AppendResponse last=7@1 reject=false
</a><a href="#h10-0-202" id="h10-0-202" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h10-0-203" id="h10-0-203" class="i">+n3@1 append 5@1 put d=4
</a><a href="#h10-0-204" id="h10-0-204" class="i">+n3@1 append 6@1 put e=5
</a><a href="#h10-0-205" id="h10-0-205" class="i">+n3@1 append 7@1 put f=6
</a><a href="#h10-0-206" id="h10-0-206" class="i">+n3@1 → n1 AppendResponse last=7@1 reject=false
</a><a href="#h10-0-207" id="h10-0-207" class="i">+n4@1 append 5@1 put d=4
</a><a href="#h10-0-208" id="h10-0-208" class="i">+n4@1 append 6@1 put e=5
</a><a href="#h10-0-209" id="h10-0-209" class="i">+n4@1 append 7@1 put f=6
</a><a href="#h10-0-210" id="h10-0-210" class="i">+n4@1 → n1 AppendResponse last=7@1 reject=false
</a><a href="#h10-0-211" id="h10-0-211" class="i">+n5@1 append 6@1 put e=5
</a><a href="#h10-0-212" id="h10-0-212" class="i">+n5@1 append 7@1 put f=6
</a><a href="#h10-0-213" id="h10-0-213" class="i">+n5@1 → n1 AppendResponse last=7@1 reject=false
</a><a href="#h10-0-214" id="h10-0-214" class="i">+n6@1 append 7@1 put f=6
</a><a href="#h10-0-215" id="h10-0-215" class="i">+n6@1 → n1 AppendResponse last=7@1 reject=false
</a><a href="#h10-0-216" id="h10-0-216" class="i">+n1@1 commit 5@1
</a><a href="#h10-0-217" id="h10-0-217" class="i">+n1@1 apply 5@1 put d=4
</a><a href="#h10-0-218" id="h10-0-218" class="i">+n1@1 → c1 ClientResponse id=0x04 write 0x0105
</a><a href="#h10-0-219" id="h10-0-219" class="i">+c1@1 put d=4 ⇒ 5
</a><a href="#h10-0-220" id="h10-0-220" class="i">+n1@1 commit 6@1
</a><a href="#h10-0-221" id="h10-0-221" class="i">+n1@1 apply 6@1 put e=5
</a><a href="#h10-0-222" id="h10-0-222" class="i">+n1@1 → c1 ClientResponse id=0x05 write 0x0106
</a><a href="#h10-0-223" id="h10-0-223" class="i">+c1@1 put e=5 ⇒ 6
</a><a href="#h10-0-224" id="h10-0-224" class="i">+n1@1 commit 7@1
</a><a href="#h10-0-225" id="h10-0-225" class="i">+n1@1 apply 7@1 put f=6
</a><a href="#h10-0-226" id="h10-0-226" class="i">+n1@1 → c1 ClientResponse id=0x06 write 0x0107
</a><a href="#h10-0-227" id="h10-0-227" class="i">+c1@1 put f=6 ⇒ 7
</a><a href="#h10-0-228" id="h10-0-228" class="i">+
</a><a href="#h10-0-229" id="h10-0-229" class="i">+status
</a><a href="#h10-0-230" id="h10-0-230" class="i">+---
</a><a href="#h10-0-231" id="h10-0-231" class="i">+n1@1 leader last=7@1 commit=7@1 apply=7 progress={2:7→8 3:7→8 4:7→8 5:7→8 6:7→8}
</a><a href="#h10-0-232" id="h10-0-232" class="i">+n2@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h10-0-233" id="h10-0-233" class="i">+n3@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h10-0-234" id="h10-0-234" class="i">+n4@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h10-0-235" id="h10-0-235" class="i">+n5@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h10-0-236" id="h10-0-236" class="i">+n6@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h11" href="../file/src/raft/testscripts/append_conflict_divergent.html">src/raft/testscripts/append_conflict_divergent</a> b/<a href="../file/src/raft/testscripts/append_conflict_divergent.html">src/raft/testscripts/append_conflict_divergent</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,238 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+# Appends with a divergent follower retries until it finds a commit base.
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+cluster nodes=5 leader=1
</a><a href="#h11-0-3" id="h11-0-3" class="i">+---
</a><a href="#h11-0-4" id="h11-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h11-0-5" id="h11-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-6" id="h11-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-7" id="h11-0-7" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-8" id="h11-0-8" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-9" id="h11-0-9" class="i">+
</a><a href="#h11-0-10" id="h11-0-10" class="i">+# Partition n1-n2
</a><a href="#h11-0-11" id="h11-0-11" class="i">+partition 1 2
</a><a href="#h11-0-12" id="h11-0-12" class="i">+---
</a><a href="#h11-0-13" id="h11-0-13" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h11-0-14" id="h11-0-14" class="i">+
</a><a href="#h11-0-15" id="h11-0-15" class="i">+# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h11-0-16" id="h11-0-16" class="i">+(campaign 3)
</a><a href="#h11-0-17" id="h11-0-17" class="i">+(stabilize)
</a><a href="#h11-0-18" id="h11-0-18" class="i">+(put 3 a=1)
</a><a href="#h11-0-19" id="h11-0-19" class="i">+(stabilize heartbeat=true)
</a><a href="#h11-0-20" id="h11-0-20" class="i">+status
</a><a href="#h11-0-21" id="h11-0-21" class="i">+---
</a><a href="#h11-0-22" id="h11-0-22" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h11-0-23" id="h11-0-23" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-24" id="h11-0-24" class="i">+n3@2 leader last=3@2 commit=3@2 apply=3 progress={1:0→2 2:0→2 4:3→4 5:3→4}
</a><a href="#h11-0-25" id="h11-0-25" class="i">+n4@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h11-0-26" id="h11-0-26" class="i">+n5@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h11-0-27" id="h11-0-27" class="i">+
</a><a href="#h11-0-28" id="h11-0-28" class="i">+(campaign 4)
</a><a href="#h11-0-29" id="h11-0-29" class="i">+(stabilize)
</a><a href="#h11-0-30" id="h11-0-30" class="i">+(put 4 b=2)
</a><a href="#h11-0-31" id="h11-0-31" class="i">+(stabilize heartbeat=true)
</a><a href="#h11-0-32" id="h11-0-32" class="i">+status
</a><a href="#h11-0-33" id="h11-0-33" class="i">+---
</a><a href="#h11-0-34" id="h11-0-34" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h11-0-35" id="h11-0-35" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-36" id="h11-0-36" class="i">+n3@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h11-0-37" id="h11-0-37" class="i">+n4@3 leader last=5@3 commit=5@3 apply=5 progress={1:0→4 2:0→4 3:5→6 5:5→6}
</a><a href="#h11-0-38" id="h11-0-38" class="i">+n5@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h11-0-39" id="h11-0-39" class="i">+
</a><a href="#h11-0-40" id="h11-0-40" class="i">+(campaign 5)
</a><a href="#h11-0-41" id="h11-0-41" class="i">+(stabilize)
</a><a href="#h11-0-42" id="h11-0-42" class="i">+(put 5 c=3)
</a><a href="#h11-0-43" id="h11-0-43" class="i">+(stabilize heartbeat=true)
</a><a href="#h11-0-44" id="h11-0-44" class="i">+status
</a><a href="#h11-0-45" id="h11-0-45" class="i">+---
</a><a href="#h11-0-46" id="h11-0-46" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h11-0-47" id="h11-0-47" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-48" id="h11-0-48" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-49" id="h11-0-49" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-50" id="h11-0-50" class="i">+n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→6 2:0→6 3:7→8 4:7→8}
</a><a href="#h11-0-51" id="h11-0-51" class="i">+
</a><a href="#h11-0-52" id="h11-0-52" class="i">+# Propose writes in the minority partition as well, to build up a log
</a><a href="#h11-0-53" id="h11-0-53" class="i">+# beyond the length of the majory log.
</a><a href="#h11-0-54" id="h11-0-54" class="i">+(put 1 a=1)
</a><a href="#h11-0-55" id="h11-0-55" class="i">+(put 1 a=2)
</a><a href="#h11-0-56" id="h11-0-56" class="i">+(put 1 a=3)
</a><a href="#h11-0-57" id="h11-0-57" class="i">+(put 1 a=4)
</a><a href="#h11-0-58" id="h11-0-58" class="i">+(put 1 a=5)
</a><a href="#h11-0-59" id="h11-0-59" class="i">+(put 1 a=6)
</a><a href="#h11-0-60" id="h11-0-60" class="i">+(put 1 a=7)
</a><a href="#h11-0-61" id="h11-0-61" class="i">+(put 1 a=8)
</a><a href="#h11-0-62" id="h11-0-62" class="i">+(put 1 a=9)
</a><a href="#h11-0-63" id="h11-0-63" class="i">+(stabilize)
</a><a href="#h11-0-64" id="h11-0-64" class="i">+status
</a><a href="#h11-0-65" id="h11-0-65" class="i">+---
</a><a href="#h11-0-66" id="h11-0-66" class="i">+n1@1 leader last=10@1 commit=1@1 apply=1 progress={2:10→11 3:1→2 4:1→2 5:1→2}
</a><a href="#h11-0-67" id="h11-0-67" class="i">+n2@1 follower(n1) last=10@1 commit=1@1 apply=1
</a><a href="#h11-0-68" id="h11-0-68" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-69" id="h11-0-69" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-70" id="h11-0-70" class="i">+n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→6 2:0→6 3:7→8 4:7→8}
</a><a href="#h11-0-71" id="h11-0-71" class="i">+
</a><a href="#h11-0-72" id="h11-0-72" class="i">+log 1 5
</a><a href="#h11-0-73" id="h11-0-73" class="i">+---
</a><a href="#h11-0-74" id="h11-0-74" class="i">+n1@1 last=10@1 commit=1@1
</a><a href="#h11-0-75" id="h11-0-75" class="i">+n1@1 entry 1@1 None
</a><a href="#h11-0-76" id="h11-0-76" class="i">+n1@1 entry 2@1 put a=1
</a><a href="#h11-0-77" id="h11-0-77" class="i">+n1@1 entry 3@1 put a=2
</a><a href="#h11-0-78" id="h11-0-78" class="i">+n1@1 entry 4@1 put a=3
</a><a href="#h11-0-79" id="h11-0-79" class="i">+n1@1 entry 5@1 put a=4
</a><a href="#h11-0-80" id="h11-0-80" class="i">+n1@1 entry 6@1 put a=5
</a><a href="#h11-0-81" id="h11-0-81" class="i">+n1@1 entry 7@1 put a=6
</a><a href="#h11-0-82" id="h11-0-82" class="i">+n1@1 entry 8@1 put a=7
</a><a href="#h11-0-83" id="h11-0-83" class="i">+n1@1 entry 9@1 put a=8
</a><a href="#h11-0-84" id="h11-0-84" class="i">+n1@1 entry 10@1 put a=9
</a><a href="#h11-0-85" id="h11-0-85" class="i">+n5@4 last=7@4 commit=7@4
</a><a href="#h11-0-86" id="h11-0-86" class="i">+n5@4 entry 1@1 None
</a><a href="#h11-0-87" id="h11-0-87" class="i">+n5@4 entry 2@2 None
</a><a href="#h11-0-88" id="h11-0-88" class="i">+n5@4 entry 3@2 put a=1
</a><a href="#h11-0-89" id="h11-0-89" class="i">+n5@4 entry 4@3 None
</a><a href="#h11-0-90" id="h11-0-90" class="i">+n5@4 entry 5@3 put b=2
</a><a href="#h11-0-91" id="h11-0-91" class="i">+n5@4 entry 6@4 None
</a><a href="#h11-0-92" id="h11-0-92" class="i">+n5@4 entry 7@4 put c=3
</a><a href="#h11-0-93" id="h11-0-93" class="i">+
</a><a href="#h11-0-94" id="h11-0-94" class="i">+# Heal the partition.
</a><a href="#h11-0-95" id="h11-0-95" class="i">+heal
</a><a href="#h11-0-96" id="h11-0-96" class="i">+---
</a><a href="#h11-0-97" id="h11-0-97" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h11-0-98" id="h11-0-98" class="i">+
</a><a href="#h11-0-99" id="h11-0-99" class="i">+# Propose another write on the majority leader.
</a><a href="#h11-0-100" id="h11-0-100" class="i">+put 5 d=4
</a><a href="#h11-0-101" id="h11-0-101" class="i">+---
</a><a href="#h11-0-102" id="h11-0-102" class="i">+c5@4 → n5 ClientRequest id=0x0d write 0x0101640134
</a><a href="#h11-0-103" id="h11-0-103" class="i">+n5@4 append 8@4 put d=4
</a><a href="#h11-0-104" id="h11-0-104" class="i">+n5@4 → n1 Append base=5@3 [6@4 7@4 8@4]
</a><a href="#h11-0-105" id="h11-0-105" class="i">+n5@4 → n2 Append base=5@3 [6@4 7@4 8@4]
</a><a href="#h11-0-106" id="h11-0-106" class="i">+n5@4 → n3 Append base=7@4 [8@4]
</a><a href="#h11-0-107" id="h11-0-107" class="i">+n5@4 → n4 Append base=7@4 [8@4]
</a><a href="#h11-0-108" id="h11-0-108" class="i">+
</a><a href="#h11-0-109" id="h11-0-109" class="i">+# Delivering the appends to n1 and n2 should reject the appends. It also 
</a><a href="#h11-0-110" id="h11-0-110" class="i">+# cancels the write requests on n1.
</a><a href="#h11-0-111" id="h11-0-111" class="i">+deliver 1 2
</a><a href="#h11-0-112" id="h11-0-112" class="i">+---
</a><a href="#h11-0-113" id="h11-0-113" class="i">+n1@1 leader ⇨ n1@4 follower(n5)
</a><a href="#h11-0-114" id="h11-0-114" class="i">+n1@1 → c1 ClientResponse id=0x04 Error::Abort
</a><a href="#h11-0-115" id="h11-0-115" class="i">+c1@1 put a=1 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-116" id="h11-0-116" class="i">+n1@1 → c1 ClientResponse id=0x05 Error::Abort
</a><a href="#h11-0-117" id="h11-0-117" class="i">+c1@1 put a=2 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-118" id="h11-0-118" class="i">+n1@1 → c1 ClientResponse id=0x06 Error::Abort
</a><a href="#h11-0-119" id="h11-0-119" class="i">+c1@1 put a=3 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-120" id="h11-0-120" class="i">+n1@1 → c1 ClientResponse id=0x07 Error::Abort
</a><a href="#h11-0-121" id="h11-0-121" class="i">+c1@1 put a=4 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-122" id="h11-0-122" class="i">+n1@1 → c1 ClientResponse id=0x08 Error::Abort
</a><a href="#h11-0-123" id="h11-0-123" class="i">+c1@1 put a=5 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-124" id="h11-0-124" class="i">+n1@1 → c1 ClientResponse id=0x09 Error::Abort
</a><a href="#h11-0-125" id="h11-0-125" class="i">+c1@1 put a=6 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-126" id="h11-0-126" class="i">+n1@1 → c1 ClientResponse id=0x0a Error::Abort
</a><a href="#h11-0-127" id="h11-0-127" class="i">+c1@1 put a=7 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-128" id="h11-0-128" class="i">+n1@1 → c1 ClientResponse id=0x0b Error::Abort
</a><a href="#h11-0-129" id="h11-0-129" class="i">+c1@1 put a=8 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-130" id="h11-0-130" class="i">+n1@1 → c1 ClientResponse id=0x0c Error::Abort
</a><a href="#h11-0-131" id="h11-0-131" class="i">+c1@1 put a=9 ⇒ Error::Abort (Operation aborted)
</a><a href="#h11-0-132" id="h11-0-132" class="i">+n1@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-133" id="h11-0-133" class="i">+n2@1 follower(n1) ⇨ n2@4 follower(n5)
</a><a href="#h11-0-134" id="h11-0-134" class="i">+n2@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-135" id="h11-0-135" class="i">+
</a><a href="#h11-0-136" id="h11-0-136" class="i">+# n5 will send the previous entry, which is again rejected.
</a><a href="#h11-0-137" id="h11-0-137" class="i">+deliver 5
</a><a href="#h11-0-138" id="h11-0-138" class="i">+deliver 1 2
</a><a href="#h11-0-139" id="h11-0-139" class="i">+status 5
</a><a href="#h11-0-140" id="h11-0-140" class="i">+---
</a><a href="#h11-0-141" id="h11-0-141" class="i">+n5@4 → n1 Append base=4@3 [5@3 6@4 7@4 8@4]
</a><a href="#h11-0-142" id="h11-0-142" class="i">+n5@4 → n2 Append base=4@3 [5@3 6@4 7@4 8@4]
</a><a href="#h11-0-143" id="h11-0-143" class="i">+n1@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-144" id="h11-0-144" class="i">+n2@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-145" id="h11-0-145" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→5 2:0→5 3:7→8 4:7→8}
</a><a href="#h11-0-146" id="h11-0-146" class="i">+
</a><a href="#h11-0-147" id="h11-0-147" class="i">+# This repeats until they find a common base at 1@1.
</a><a href="#h11-0-148" id="h11-0-148" class="i">+deliver 5
</a><a href="#h11-0-149" id="h11-0-149" class="i">+deliver 1 2
</a><a href="#h11-0-150" id="h11-0-150" class="i">+status 5
</a><a href="#h11-0-151" id="h11-0-151" class="i">+---
</a><a href="#h11-0-152" id="h11-0-152" class="i">+n5@4 → n1 Append base=3@2 [4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-153" id="h11-0-153" class="i">+n5@4 → n2 Append base=3@2 [4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-154" id="h11-0-154" class="i">+n1@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-155" id="h11-0-155" class="i">+n2@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-156" id="h11-0-156" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→4 2:0→4 3:7→8 4:7→8}
</a><a href="#h11-0-157" id="h11-0-157" class="i">+
</a><a href="#h11-0-158" id="h11-0-158" class="i">+deliver 5
</a><a href="#h11-0-159" id="h11-0-159" class="i">+deliver 1 2
</a><a href="#h11-0-160" id="h11-0-160" class="i">+status 5
</a><a href="#h11-0-161" id="h11-0-161" class="i">+---
</a><a href="#h11-0-162" id="h11-0-162" class="i">+n5@4 → n1 Append base=2@2 [3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-163" id="h11-0-163" class="i">+n5@4 → n2 Append base=2@2 [3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-164" id="h11-0-164" class="i">+n1@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-165" id="h11-0-165" class="i">+n2@4 → n5 AppendResponse last=10@1 reject=true
</a><a href="#h11-0-166" id="h11-0-166" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→3 2:0→3 3:7→8 4:7→8}
</a><a href="#h11-0-167" id="h11-0-167" class="i">+
</a><a href="#h11-0-168" id="h11-0-168" class="i">+deliver 5
</a><a href="#h11-0-169" id="h11-0-169" class="i">+deliver 5
</a><a href="#h11-0-170" id="h11-0-170" class="i">+deliver 1 2
</a><a href="#h11-0-171" id="h11-0-171" class="i">+status 5
</a><a href="#h11-0-172" id="h11-0-172" class="i">+---
</a><a href="#h11-0-173" id="h11-0-173" class="i">+n5@4 → n1 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-174" id="h11-0-174" class="i">+n5@4 → n2 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h11-0-175" id="h11-0-175" class="i">+n1@4 → n5 AppendResponse last=8@4 reject=false
</a><a href="#h11-0-176" id="h11-0-176" class="i">+n2@4 → n5 AppendResponse last=8@4 reject=false
</a><a href="#h11-0-177" id="h11-0-177" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→2 2:0→2 3:7→8 4:7→8}
</a><a href="#h11-0-178" id="h11-0-178" class="i">+
</a><a href="#h11-0-179" id="h11-0-179" class="i">+# The new write can now commit and apply.
</a><a href="#h11-0-180" id="h11-0-180" class="i">+deliver 5
</a><a href="#h11-0-181" id="h11-0-181" class="i">+---
</a><a href="#h11-0-182" id="h11-0-182" class="i">+n5@4 commit 8@4
</a><a href="#h11-0-183" id="h11-0-183" class="i">+n5@4 apply 8@4 put d=4
</a><a href="#h11-0-184" id="h11-0-184" class="i">+n5@4 → c5 ClientResponse id=0x0d write 0x0108
</a><a href="#h11-0-185" id="h11-0-185" class="i">+c5@4 put d=4 ⇒ 8
</a><a href="#h11-0-186" id="h11-0-186" class="i">+
</a><a href="#h11-0-187" id="h11-0-187" class="i">+status
</a><a href="#h11-0-188" id="h11-0-188" class="i">+---
</a><a href="#h11-0-189" id="h11-0-189" class="i">+n1@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h11-0-190" id="h11-0-190" class="i">+n2@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h11-0-191" id="h11-0-191" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-192" id="h11-0-192" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h11-0-193" id="h11-0-193" class="i">+n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:7→8 4:7→8}
</a><a href="#h11-0-194" id="h11-0-194" class="i">+
</a><a href="#h11-0-195" id="h11-0-195" class="i">+# A heartbeat brings the cluster into agreement.
</a><a href="#h11-0-196" id="h11-0-196" class="i">+stabilize heartbeat=true
</a><a href="#h11-0-197" id="h11-0-197" class="i">+---
</a><a href="#h11-0-198" id="h11-0-198" class="i">+n3@4 append 8@4 put d=4
</a><a href="#h11-0-199" id="h11-0-199" class="i">+n3@4 → n5 AppendResponse last=8@4 reject=false
</a><a href="#h11-0-200" id="h11-0-200" class="i">+n4@4 append 8@4 put d=4
</a><a href="#h11-0-201" id="h11-0-201" class="i">+n4@4 → n5 AppendResponse last=8@4 reject=false
</a><a href="#h11-0-202" id="h11-0-202" class="i">+n5@4 → n1 Heartbeat commit=8@4 read_seq=0
</a><a href="#h11-0-203" id="h11-0-203" class="i">+n5@4 → n2 Heartbeat commit=8@4 read_seq=0
</a><a href="#h11-0-204" id="h11-0-204" class="i">+n5@4 → n3 Heartbeat commit=8@4 read_seq=0
</a><a href="#h11-0-205" id="h11-0-205" class="i">+n5@4 → n4 Heartbeat commit=8@4 read_seq=0
</a><a href="#h11-0-206" id="h11-0-206" class="i">+n1@4 commit 8@4
</a><a href="#h11-0-207" id="h11-0-207" class="i">+n1@4 apply 2@2 None
</a><a href="#h11-0-208" id="h11-0-208" class="i">+n1@4 apply 3@2 put a=1
</a><a href="#h11-0-209" id="h11-0-209" class="i">+n1@4 apply 4@3 None
</a><a href="#h11-0-210" id="h11-0-210" class="i">+n1@4 apply 5@3 put b=2
</a><a href="#h11-0-211" id="h11-0-211" class="i">+n1@4 apply 6@4 None
</a><a href="#h11-0-212" id="h11-0-212" class="i">+n1@4 apply 7@4 put c=3
</a><a href="#h11-0-213" id="h11-0-213" class="i">+n1@4 apply 8@4 put d=4
</a><a href="#h11-0-214" id="h11-0-214" class="i">+n1@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h11-0-215" id="h11-0-215" class="i">+n2@4 commit 8@4
</a><a href="#h11-0-216" id="h11-0-216" class="i">+n2@4 apply 2@2 None
</a><a href="#h11-0-217" id="h11-0-217" class="i">+n2@4 apply 3@2 put a=1
</a><a href="#h11-0-218" id="h11-0-218" class="i">+n2@4 apply 4@3 None
</a><a href="#h11-0-219" id="h11-0-219" class="i">+n2@4 apply 5@3 put b=2
</a><a href="#h11-0-220" id="h11-0-220" class="i">+n2@4 apply 6@4 None
</a><a href="#h11-0-221" id="h11-0-221" class="i">+n2@4 apply 7@4 put c=3
</a><a href="#h11-0-222" id="h11-0-222" class="i">+n2@4 apply 8@4 put d=4
</a><a href="#h11-0-223" id="h11-0-223" class="i">+n2@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h11-0-224" id="h11-0-224" class="i">+n3@4 commit 8@4
</a><a href="#h11-0-225" id="h11-0-225" class="i">+n3@4 apply 8@4 put d=4
</a><a href="#h11-0-226" id="h11-0-226" class="i">+n3@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h11-0-227" id="h11-0-227" class="i">+n4@4 commit 8@4
</a><a href="#h11-0-228" id="h11-0-228" class="i">+n4@4 apply 8@4 put d=4
</a><a href="#h11-0-229" id="h11-0-229" class="i">+n4@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h11-0-230" id="h11-0-230" class="i">+
</a><a href="#h11-0-231" id="h11-0-231" class="i">+status
</a><a href="#h11-0-232" id="h11-0-232" class="i">+---
</a><a href="#h11-0-233" id="h11-0-233" class="i">+n1@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h11-0-234" id="h11-0-234" class="i">+n2@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h11-0-235" id="h11-0-235" class="i">+n3@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h11-0-236" id="h11-0-236" class="i">+n4@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h11-0-237" id="h11-0-237" class="i">+n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:8→9 4:8→9}
</a><b>diff --git a/<a id="h12" href="../file/src/raft/testscripts/append_conflict_replace_term.html">src/raft/testscripts/append_conflict_replace_term</a> b/<a href="../file/src/raft/testscripts/append_conflict_replace_term.html">src/raft/testscripts/append_conflict_replace_term</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,103 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+# An append replaces a conflict at the tail for a single term.
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+cluster nodes=5 leader=1
</a><a href="#h12-0-3" id="h12-0-3" class="i">+---
</a><a href="#h12-0-4" id="h12-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h12-0-5" id="h12-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-6" id="h12-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-7" id="h12-0-7" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-8" id="h12-0-8" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-9" id="h12-0-9" class="i">+
</a><a href="#h12-0-10" id="h12-0-10" class="i">+# Partition n3-n5.
</a><a href="#h12-0-11" id="h12-0-11" class="i">+partition 3 4 5
</a><a href="#h12-0-12" id="h12-0-12" class="i">+---
</a><a href="#h12-0-13" id="h12-0-13" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h12-0-14" id="h12-0-14" class="i">+
</a><a href="#h12-0-15" id="h12-0-15" class="i">+# Propose and replicate a write to n2.
</a><a href="#h12-0-16" id="h12-0-16" class="i">+put 1 a=1
</a><a href="#h12-0-17" id="h12-0-17" class="i">+stabilize
</a><a href="#h12-0-18" id="h12-0-18" class="i">+---
</a><a href="#h12-0-19" id="h12-0-19" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h12-0-20" id="h12-0-20" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h12-0-21" id="h12-0-21" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h12-0-22" id="h12-0-22" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h12-0-23" id="h12-0-23" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h12-0-24" id="h12-0-24" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h12-0-25" id="h12-0-25" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h12-0-26" id="h12-0-26" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h12-0-27" id="h12-0-27" class="i">+
</a><a href="#h12-0-28" id="h12-0-28" class="i">+log 1 2
</a><a href="#h12-0-29" id="h12-0-29" class="i">+---
</a><a href="#h12-0-30" id="h12-0-30" class="i">+n1@1 last=2@1 commit=1@1
</a><a href="#h12-0-31" id="h12-0-31" class="i">+n1@1 entry 1@1 None
</a><a href="#h12-0-32" id="h12-0-32" class="i">+n1@1 entry 2@1 put a=1
</a><a href="#h12-0-33" id="h12-0-33" class="i">+n2@1 last=2@1 commit=1@1
</a><a href="#h12-0-34" id="h12-0-34" class="i">+n2@1 entry 1@1 None
</a><a href="#h12-0-35" id="h12-0-35" class="i">+n2@1 entry 2@1 put a=1
</a><a href="#h12-0-36" id="h12-0-36" class="i">+
</a><a href="#h12-0-37" id="h12-0-37" class="i">+# Elect n5 as a new leader while partitioned.
</a><a href="#h12-0-38" id="h12-0-38" class="i">+(campaign 5)
</a><a href="#h12-0-39" id="h12-0-39" class="i">+(stabilize)
</a><a href="#h12-0-40" id="h12-0-40" class="i">+status
</a><a href="#h12-0-41" id="h12-0-41" class="i">+---
</a><a href="#h12-0-42" id="h12-0-42" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h12-0-43" id="h12-0-43" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h12-0-44" id="h12-0-44" class="i">+n3@2 follower(n5) last=2@2 commit=1@1 apply=1
</a><a href="#h12-0-45" id="h12-0-45" class="i">+n4@2 follower(n5) last=2@2 commit=1@1 apply=1
</a><a href="#h12-0-46" id="h12-0-46" class="i">+n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:0→2 2:0→2 3:2→3 4:2→3}
</a><a href="#h12-0-47" id="h12-0-47" class="i">+
</a><a href="#h12-0-48" id="h12-0-48" class="i">+# Replicate a write via n5.
</a><a href="#h12-0-49" id="h12-0-49" class="i">+(put 5 b=2)
</a><a href="#h12-0-50" id="h12-0-50" class="i">+(stabilize)
</a><a href="#h12-0-51" id="h12-0-51" class="i">+status
</a><a href="#h12-0-52" id="h12-0-52" class="i">+---
</a><a href="#h12-0-53" id="h12-0-53" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h12-0-54" id="h12-0-54" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h12-0-55" id="h12-0-55" class="i">+n3@2 follower(n5) last=3@2 commit=1@1 apply=1
</a><a href="#h12-0-56" id="h12-0-56" class="i">+n4@2 follower(n5) last=3@2 commit=1@1 apply=1
</a><a href="#h12-0-57" id="h12-0-57" class="i">+n5@2 leader last=3@2 commit=3@2 apply=3 progress={1:0→2 2:0→2 3:3→4 4:3→4}
</a><a href="#h12-0-58" id="h12-0-58" class="i">+
</a><a href="#h12-0-59" id="h12-0-59" class="i">+# Heal the partition, and submit another write on n5. This will attempt to
</a><a href="#h12-0-60" id="h12-0-60" class="i">+# replicate the tail 2-4 to n1,n2.
</a><a href="#h12-0-61" id="h12-0-61" class="i">+#
</a><a href="#h12-0-62" id="h12-0-62" class="i">+# TODO: to avoid quadratic behavior, this should only attempt to replicate the
</a><a href="#h12-0-63" id="h12-0-63" class="i">+# single appended entry (if it matches the follower&#39;s next index) instead of all
</a><a href="#h12-0-64" id="h12-0-64" class="i">+# entries from next up to it.
</a><a href="#h12-0-65" id="h12-0-65" class="i">+heal
</a><a href="#h12-0-66" id="h12-0-66" class="i">+put 5 c=3
</a><a href="#h12-0-67" id="h12-0-67" class="i">+---
</a><a href="#h12-0-68" id="h12-0-68" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h12-0-69" id="h12-0-69" class="i">+c5@2 → n5 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h12-0-70" id="h12-0-70" class="i">+n5@2 append 4@2 put c=3
</a><a href="#h12-0-71" id="h12-0-71" class="i">+n5@2 → n1 Append base=1@1 [2@2 3@2 4@2]
</a><a href="#h12-0-72" id="h12-0-72" class="i">+n5@2 → n2 Append base=1@1 [2@2 3@2 4@2]
</a><a href="#h12-0-73" id="h12-0-73" class="i">+n5@2 → n3 Append base=3@2 [4@2]
</a><a href="#h12-0-74" id="h12-0-74" class="i">+n5@2 → n4 Append base=3@2 [4@2]
</a><a href="#h12-0-75" id="h12-0-75" class="i">+
</a><a href="#h12-0-76" id="h12-0-76" class="i">+# Delivering the append messages to n1,n2 will make them follow n5 and
</a><a href="#h12-0-77" id="h12-0-77" class="i">+# replace the tail of the logs with n5&#39;s log.
</a><a href="#h12-0-78" id="h12-0-78" class="i">+deliver 1 2
</a><a href="#h12-0-79" id="h12-0-79" class="i">+---
</a><a href="#h12-0-80" id="h12-0-80" class="i">+n1@1 leader ⇨ n1@2 follower(n5)
</a><a href="#h12-0-81" id="h12-0-81" class="i">+n1@2 append 3@2 put b=2
</a><a href="#h12-0-82" id="h12-0-82" class="i">+n1@2 append 4@2 put c=3
</a><a href="#h12-0-83" id="h12-0-83" class="i">+n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h12-0-84" id="h12-0-84" class="i">+c1@1 put a=1 ⇒ Error::Abort (Operation aborted)
</a><a href="#h12-0-85" id="h12-0-85" class="i">+n1@2 → n5 AppendResponse last=4@2 reject=false
</a><a href="#h12-0-86" id="h12-0-86" class="i">+n2@1 follower(n1) ⇨ n2@2 follower(n5)
</a><a href="#h12-0-87" id="h12-0-87" class="i">+n2@2 append 3@2 put b=2
</a><a href="#h12-0-88" id="h12-0-88" class="i">+n2@2 append 4@2 put c=3
</a><a href="#h12-0-89" id="h12-0-89" class="i">+n2@2 → n5 AppendResponse last=4@2 reject=false
</a><a href="#h12-0-90" id="h12-0-90" class="i">+
</a><a href="#h12-0-91" id="h12-0-91" class="i">+log 1 2
</a><a href="#h12-0-92" id="h12-0-92" class="i">+---
</a><a href="#h12-0-93" id="h12-0-93" class="i">+n1@2 last=4@2 commit=1@1
</a><a href="#h12-0-94" id="h12-0-94" class="i">+n1@2 entry 1@1 None
</a><a href="#h12-0-95" id="h12-0-95" class="i">+n1@2 entry 2@2 None
</a><a href="#h12-0-96" id="h12-0-96" class="i">+n1@2 entry 3@2 put b=2
</a><a href="#h12-0-97" id="h12-0-97" class="i">+n1@2 entry 4@2 put c=3
</a><a href="#h12-0-98" id="h12-0-98" class="i">+n2@2 last=4@2 commit=1@1
</a><a href="#h12-0-99" id="h12-0-99" class="i">+n2@2 entry 1@1 None
</a><a href="#h12-0-100" id="h12-0-100" class="i">+n2@2 entry 2@2 None
</a><a href="#h12-0-101" id="h12-0-101" class="i">+n2@2 entry 3@2 put b=2
</a><a href="#h12-0-102" id="h12-0-102" class="i">+n2@2 entry 4@2 put c=3
</a><b>diff --git a/<a id="h13" href="../file/src/raft/testscripts/append_initial.html">src/raft/testscripts/append_initial</a> b/<a href="../file/src/raft/testscripts/append_initial.html">src/raft/testscripts/append_initial</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,78 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+# An initial append at base 0 can have a single or multiple entries.
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+cluster nodes=3
</a><a href="#h13-0-3" id="h13-0-3" class="i">+---
</a><a href="#h13-0-4" id="h13-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h13-0-5" id="h13-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h13-0-6" id="h13-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h13-0-7" id="h13-0-7" class="i">+
</a><a href="#h13-0-8" id="h13-0-8" class="i">+# Partition n3 so that is has an empty log.
</a><a href="#h13-0-9" id="h13-0-9" class="i">+partition 3
</a><a href="#h13-0-10" id="h13-0-10" class="i">+---
</a><a href="#h13-0-11" id="h13-0-11" class="i">+n3 ⇹ n1 n2
</a><a href="#h13-0-12" id="h13-0-12" class="i">+
</a><a href="#h13-0-13" id="h13-0-13" class="i">+# n1 campaigns.
</a><a href="#h13-0-14" id="h13-0-14" class="i">+campaign 1
</a><a href="#h13-0-15" id="h13-0-15" class="i">+deliver
</a><a href="#h13-0-16" id="h13-0-16" class="i">+---
</a><a href="#h13-0-17" id="h13-0-17" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h13-0-18" id="h13-0-18" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h13-0-19" id="h13-0-19" class="i">+n1@1 ⇥ n3 C̶a̶m̶p̶a̶i̶g̶n̶ ̶l̶a̶s̶t̶=̶0̶@̶0̶
</a><a href="#h13-0-20" id="h13-0-20" class="i">+n2@0 follower() ⇨ n2@1 follower()
</a><a href="#h13-0-21" id="h13-0-21" class="i">+n2@1 → n1 CampaignResponse vote=true
</a><a href="#h13-0-22" id="h13-0-22" class="i">+
</a><a href="#h13-0-23" id="h13-0-23" class="i">+# When n1 wins, it successfully appends an entry at base 0 to n2.
</a><a href="#h13-0-24" id="h13-0-24" class="i">+stabilize
</a><a href="#h13-0-25" id="h13-0-25" class="i">+---
</a><a href="#h13-0-26" id="h13-0-26" class="i">+n1@1 candidate ⇨ n1@1 leader
</a><a href="#h13-0-27" id="h13-0-27" class="i">+n1@1 append 1@1 None
</a><a href="#h13-0-28" id="h13-0-28" class="i">+n1@1 → n2 Append base=0@0 [1@1]
</a><a href="#h13-0-29" id="h13-0-29" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶0̶@̶0̶ ̶[̶1̶@̶1̶]̶
</a><a href="#h13-0-30" id="h13-0-30" class="i">+n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h13-0-31" id="h13-0-31" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶0̶@̶0̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h13-0-32" id="h13-0-32" class="i">+n2@1 follower() ⇨ n2@1 follower(n1)
</a><a href="#h13-0-33" id="h13-0-33" class="i">+n2@1 append 1@1 None
</a><a href="#h13-0-34" id="h13-0-34" class="i">+n2@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h13-0-35" id="h13-0-35" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h13-0-36" id="h13-0-36" class="i">+n1@1 commit 1@1
</a><a href="#h13-0-37" id="h13-0-37" class="i">+n1@1 apply 1@1 None
</a><a href="#h13-0-38" id="h13-0-38" class="i">+
</a><a href="#h13-0-39" id="h13-0-39" class="i">+status
</a><a href="#h13-0-40" id="h13-0-40" class="i">+---
</a><a href="#h13-0-41" id="h13-0-41" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h13-0-42" id="h13-0-42" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h13-0-43" id="h13-0-43" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h13-0-44" id="h13-0-44" class="i">+
</a><a href="#h13-0-45" id="h13-0-45" class="i">+# Heal the partition.
</a><a href="#h13-0-46" id="h13-0-46" class="i">+heal
</a><a href="#h13-0-47" id="h13-0-47" class="i">+---
</a><a href="#h13-0-48" id="h13-0-48" class="i">+n1 n2 n3 fully connected
</a><a href="#h13-0-49" id="h13-0-49" class="i">+
</a><a href="#h13-0-50" id="h13-0-50" class="i">+# Propose a write. This appends entry 2 to n2 at base 1, and entries 1-2 to n3 at base 0.
</a><a href="#h13-0-51" id="h13-0-51" class="i">+put 1 foo=bar
</a><a href="#h13-0-52" id="h13-0-52" class="i">+---
</a><a href="#h13-0-53" id="h13-0-53" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h13-0-54" id="h13-0-54" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h13-0-55" id="h13-0-55" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h13-0-56" id="h13-0-56" class="i">+n1@1 → n3 Append base=0@0 [1@1 2@1]
</a><a href="#h13-0-57" id="h13-0-57" class="i">+
</a><a href="#h13-0-58" id="h13-0-58" class="i">+deliver
</a><a href="#h13-0-59" id="h13-0-59" class="i">+---
</a><a href="#h13-0-60" id="h13-0-60" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h13-0-61" id="h13-0-61" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h13-0-62" id="h13-0-62" class="i">+n3@0 follower() ⇨ n3@1 follower(n1)
</a><a href="#h13-0-63" id="h13-0-63" class="i">+n3@1 append 1@1 None
</a><a href="#h13-0-64" id="h13-0-64" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h13-0-65" id="h13-0-65" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h13-0-66" id="h13-0-66" class="i">+
</a><a href="#h13-0-67" id="h13-0-67" class="i">+log
</a><a href="#h13-0-68" id="h13-0-68" class="i">+---
</a><a href="#h13-0-69" id="h13-0-69" class="i">+n1@1 last=2@1 commit=1@1
</a><a href="#h13-0-70" id="h13-0-70" class="i">+n1@1 entry 1@1 None
</a><a href="#h13-0-71" id="h13-0-71" class="i">+n1@1 entry 2@1 put foo=bar
</a><a href="#h13-0-72" id="h13-0-72" class="i">+n2@1 last=2@1 commit=0@0
</a><a href="#h13-0-73" id="h13-0-73" class="i">+n2@1 entry 1@1 None
</a><a href="#h13-0-74" id="h13-0-74" class="i">+n2@1 entry 2@1 put foo=bar
</a><a href="#h13-0-75" id="h13-0-75" class="i">+n3@1 last=2@1 commit=0@0
</a><a href="#h13-0-76" id="h13-0-76" class="i">+n3@1 entry 1@1 None
</a><a href="#h13-0-77" id="h13-0-77" class="i">+n3@1 entry 2@1 put foo=bar
</a><b>diff --git a/<a id="h14" href="../file/src/raft/testscripts/append_overlap.html">src/raft/testscripts/append_overlap</a> b/<a href="../file/src/raft/testscripts/append_overlap.html">src/raft/testscripts/append_overlap</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,60 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+# Overlapping entries are appended just fine.
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h14-0-3" id="h14-0-3" class="i">+---
</a><a href="#h14-0-4" id="h14-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h14-0-5" id="h14-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-6" id="h14-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-7" id="h14-0-7" class="i">+
</a><a href="#h14-0-8" id="h14-0-8" class="i">+# Propose three writes before the acks are received. This emits duplicate,
</a><a href="#h14-0-9" id="h14-0-9" class="i">+# overlapping entries in successive messages, which should all be accepted.
</a><a href="#h14-0-10" id="h14-0-10" class="i">+put 1 a=1
</a><a href="#h14-0-11" id="h14-0-11" class="i">+deliver 2 3
</a><a href="#h14-0-12" id="h14-0-12" class="i">+---
</a><a href="#h14-0-13" id="h14-0-13" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h14-0-14" id="h14-0-14" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h14-0-15" id="h14-0-15" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h14-0-16" id="h14-0-16" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h14-0-17" id="h14-0-17" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h14-0-18" id="h14-0-18" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h14-0-19" id="h14-0-19" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h14-0-20" id="h14-0-20" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h14-0-21" id="h14-0-21" class="i">+
</a><a href="#h14-0-22" id="h14-0-22" class="i">+put 1 b=2
</a><a href="#h14-0-23" id="h14-0-23" class="i">+deliver 2 3
</a><a href="#h14-0-24" id="h14-0-24" class="i">+---
</a><a href="#h14-0-25" id="h14-0-25" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h14-0-26" id="h14-0-26" class="i">+n1@1 append 3@1 put b=2
</a><a href="#h14-0-27" id="h14-0-27" class="i">+n1@1 → n2 Append base=1@1 [2@1 3@1]
</a><a href="#h14-0-28" id="h14-0-28" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1]
</a><a href="#h14-0-29" id="h14-0-29" class="i">+n2@1 append 3@1 put b=2
</a><a href="#h14-0-30" id="h14-0-30" class="i">+n2@1 → n1 AppendResponse last=3@1 reject=false
</a><a href="#h14-0-31" id="h14-0-31" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h14-0-32" id="h14-0-32" class="i">+n3@1 → n1 AppendResponse last=3@1 reject=false
</a><a href="#h14-0-33" id="h14-0-33" class="i">+
</a><a href="#h14-0-34" id="h14-0-34" class="i">+put 1 c=3
</a><a href="#h14-0-35" id="h14-0-35" class="i">+deliver 2 3
</a><a href="#h14-0-36" id="h14-0-36" class="i">+---
</a><a href="#h14-0-37" id="h14-0-37" class="i">+c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h14-0-38" id="h14-0-38" class="i">+n1@1 append 4@1 put c=3
</a><a href="#h14-0-39" id="h14-0-39" class="i">+n1@1 → n2 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h14-0-40" id="h14-0-40" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h14-0-41" id="h14-0-41" class="i">+n2@1 append 4@1 put c=3
</a><a href="#h14-0-42" id="h14-0-42" class="i">+n2@1 → n1 AppendResponse last=4@1 reject=false
</a><a href="#h14-0-43" id="h14-0-43" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h14-0-44" id="h14-0-44" class="i">+n3@1 → n1 AppendResponse last=4@1 reject=false
</a><a href="#h14-0-45" id="h14-0-45" class="i">+
</a><a href="#h14-0-46" id="h14-0-46" class="i">+stabilize
</a><a href="#h14-0-47" id="h14-0-47" class="i">+---
</a><a href="#h14-0-48" id="h14-0-48" class="i">+n1@1 commit 2@1
</a><a href="#h14-0-49" id="h14-0-49" class="i">+n1@1 apply 2@1 put a=1
</a><a href="#h14-0-50" id="h14-0-50" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h14-0-51" id="h14-0-51" class="i">+c1@1 put a=1 ⇒ 2
</a><a href="#h14-0-52" id="h14-0-52" class="i">+n1@1 commit 3@1
</a><a href="#h14-0-53" id="h14-0-53" class="i">+n1@1 apply 3@1 put b=2
</a><a href="#h14-0-54" id="h14-0-54" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h14-0-55" id="h14-0-55" class="i">+c1@1 put b=2 ⇒ 3
</a><a href="#h14-0-56" id="h14-0-56" class="i">+n1@1 commit 4@1
</a><a href="#h14-0-57" id="h14-0-57" class="i">+n1@1 apply 4@1 put c=3
</a><a href="#h14-0-58" id="h14-0-58" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h14-0-59" id="h14-0-59" class="i">+c1@1 put c=3 ⇒ 4
</a><b>diff --git a/<a id="h15" href="../file/src/raft/testscripts/append_response_beyond_last_index_panics.html">src/raft/testscripts/append_response_beyond_last_index_panics</a> b/<a href="../file/src/raft/testscripts/append_response_beyond_last_index_panics.html">src/raft/testscripts/append_response_beyond_last_index_panics</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+# A successful AppendResponse with last index beyond leader&#39;s last log
</a><a href="#h15-0-1" id="h15-0-1" class="i">+# should panic.
</a><a href="#h15-0-2" id="h15-0-2" class="i">+
</a><a href="#h15-0-3" id="h15-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h15-0-4" id="h15-0-4" class="i">+---
</a><a href="#h15-0-5" id="h15-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h15-0-6" id="h15-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-7" id="h15-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-8" id="h15-0-8" class="i">+
</a><a href="#h15-0-9" id="h15-0-9" class="i">+# Propose a write.
</a><a href="#h15-0-10" id="h15-0-10" class="i">+put 1 foo=bar
</a><a href="#h15-0-11" id="h15-0-11" class="i">+---
</a><a href="#h15-0-12" id="h15-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h15-0-13" id="h15-0-13" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h15-0-14" id="h15-0-14" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h15-0-15" id="h15-0-15" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h15-0-16" id="h15-0-16" class="i">+
</a><a href="#h15-0-17" id="h15-0-17" class="i">+# An AppendResponse beyond leader&#39;s last log should panic.
</a><a href="#h15-0-18" id="h15-0-18" class="i">+step 1 panic=true &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;last_index&quot;:3,&quot;last_term&quot;:1,&quot;reject&quot;:false}}}&#39;
</a><a href="#h15-0-19" id="h15-0-19" class="i">+---
</a><a href="#h15-0-20" id="h15-0-20" class="i">+n1@1 panic: follower accepted entries after last index
</a><b>diff --git a/<a id="h16" href="../file/src/raft/testscripts/append_response_beyond_last_term_panics.html">src/raft/testscripts/append_response_beyond_last_term_panics</a> b/<a href="../file/src/raft/testscripts/append_response_beyond_last_term_panics.html">src/raft/testscripts/append_response_beyond_last_term_panics</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+# A successful AppendResponse with last term beyond leader&#39;s last term
</a><a href="#h16-0-1" id="h16-0-1" class="i">+# should panic.
</a><a href="#h16-0-2" id="h16-0-2" class="i">+
</a><a href="#h16-0-3" id="h16-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h16-0-4" id="h16-0-4" class="i">+---
</a><a href="#h16-0-5" id="h16-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h16-0-6" id="h16-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-7" id="h16-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-8" id="h16-0-8" class="i">+
</a><a href="#h16-0-9" id="h16-0-9" class="i">+# Propose a write.
</a><a href="#h16-0-10" id="h16-0-10" class="i">+put 1 foo=bar
</a><a href="#h16-0-11" id="h16-0-11" class="i">+---
</a><a href="#h16-0-12" id="h16-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h16-0-13" id="h16-0-13" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h16-0-14" id="h16-0-14" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h16-0-15" id="h16-0-15" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h16-0-16" id="h16-0-16" class="i">+
</a><a href="#h16-0-17" id="h16-0-17" class="i">+# An AppendResponse beyond leader&#39;s last term should panic.
</a><a href="#h16-0-18" id="h16-0-18" class="i">+step 1 panic=true &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;last_index&quot;:2,&quot;last_term&quot;:2,&quot;reject&quot;:false}}}&#39;
</a><a href="#h16-0-19" id="h16-0-19" class="i">+---
</a><a href="#h16-0-20" id="h16-0-20" class="i">+n1@1 panic: follower accepted entries after last term
</a><b>diff --git a/<a id="h17" href="../file/src/raft/testscripts/election.html">src/raft/testscripts/election</a> b/<a href="../file/src/raft/testscripts/election.html">src/raft/testscripts/election</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+# A node campaigns and wins leadership once the election timeout passes. Uses
</a><a href="#h17-0-1" id="h17-0-1" class="i">+# ticks directly to also test tick handling.
</a><a href="#h17-0-2" id="h17-0-2" class="i">+
</a><a href="#h17-0-3" id="h17-0-3" class="i">+cluster nodes=3 heartbeat_interval=1 election_timeout=2
</a><a href="#h17-0-4" id="h17-0-4" class="i">+---
</a><a href="#h17-0-5" id="h17-0-5" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h17-0-6" id="h17-0-6" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h17-0-7" id="h17-0-7" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h17-0-8" id="h17-0-8" class="i">+
</a><a href="#h17-0-9" id="h17-0-9" class="i">+# Tick all nodes. Then tick n1 again to make it campaign.
</a><a href="#h17-0-10" id="h17-0-10" class="i">+tick
</a><a href="#h17-0-11" id="h17-0-11" class="i">+---
</a><a href="#h17-0-12" id="h17-0-12" class="i">+ok
</a><a href="#h17-0-13" id="h17-0-13" class="i">+
</a><a href="#h17-0-14" id="h17-0-14" class="i">+tick 1
</a><a href="#h17-0-15" id="h17-0-15" class="i">+---
</a><a href="#h17-0-16" id="h17-0-16" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h17-0-17" id="h17-0-17" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h17-0-18" id="h17-0-18" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h17-0-19" id="h17-0-19" class="i">+
</a><a href="#h17-0-20" id="h17-0-20" class="i">+# n2,n3 grant n1 their votes.
</a><a href="#h17-0-21" id="h17-0-21" class="i">+deliver
</a><a href="#h17-0-22" id="h17-0-22" class="i">+---
</a><a href="#h17-0-23" id="h17-0-23" class="i">+n2@0 follower() ⇨ n2@1 follower()
</a><a href="#h17-0-24" id="h17-0-24" class="i">+n2@1 → n1 CampaignResponse vote=true
</a><a href="#h17-0-25" id="h17-0-25" class="i">+n3@0 follower() ⇨ n3@1 follower()
</a><a href="#h17-0-26" id="h17-0-26" class="i">+n3@1 → n1 CampaignResponse vote=true
</a><a href="#h17-0-27" id="h17-0-27" class="i">+
</a><a href="#h17-0-28" id="h17-0-28" class="i">+# n1 wins the election and becomes leader.
</a><a href="#h17-0-29" id="h17-0-29" class="i">+deliver
</a><a href="#h17-0-30" id="h17-0-30" class="i">+---
</a><a href="#h17-0-31" id="h17-0-31" class="i">+n1@1 candidate ⇨ n1@1 leader
</a><a href="#h17-0-32" id="h17-0-32" class="i">+n1@1 append 1@1 None
</a><a href="#h17-0-33" id="h17-0-33" class="i">+n1@1 → n2 Append base=0@0 [1@1]
</a><a href="#h17-0-34" id="h17-0-34" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h17-0-35" id="h17-0-35" class="i">+n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h17-0-36" id="h17-0-36" class="i">+n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h17-0-37" id="h17-0-37" class="i">+
</a><a href="#h17-0-38" id="h17-0-38" class="i">+# All nodes become n1 followers.
</a><a href="#h17-0-39" id="h17-0-39" class="i">+stabilize
</a><a href="#h17-0-40" id="h17-0-40" class="i">+---
</a><a href="#h17-0-41" id="h17-0-41" class="i">+n2@1 follower() ⇨ n2@1 follower(n1)
</a><a href="#h17-0-42" id="h17-0-42" class="i">+n2@1 append 1@1 None
</a><a href="#h17-0-43" id="h17-0-43" class="i">+n2@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h17-0-44" id="h17-0-44" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h17-0-45" id="h17-0-45" class="i">+n3@1 follower() ⇨ n3@1 follower(n1)
</a><a href="#h17-0-46" id="h17-0-46" class="i">+n3@1 append 1@1 None
</a><a href="#h17-0-47" id="h17-0-47" class="i">+n3@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h17-0-48" id="h17-0-48" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h17-0-49" id="h17-0-49" class="i">+n1@1 commit 1@1
</a><a href="#h17-0-50" id="h17-0-50" class="i">+n1@1 apply 1@1 None
</a><a href="#h17-0-51" id="h17-0-51" class="i">+
</a><a href="#h17-0-52" id="h17-0-52" class="i">+# n1&#39;s heartbeats are accepted by followers, who commit and apply the entry.
</a><a href="#h17-0-53" id="h17-0-53" class="i">+tick 1
</a><a href="#h17-0-54" id="h17-0-54" class="i">+---
</a><a href="#h17-0-55" id="h17-0-55" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h17-0-56" id="h17-0-56" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h17-0-57" id="h17-0-57" class="i">+
</a><a href="#h17-0-58" id="h17-0-58" class="i">+stabilize
</a><a href="#h17-0-59" id="h17-0-59" class="i">+---
</a><a href="#h17-0-60" id="h17-0-60" class="i">+n2@1 commit 1@1
</a><a href="#h17-0-61" id="h17-0-61" class="i">+n2@1 apply 1@1 None
</a><a href="#h17-0-62" id="h17-0-62" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h17-0-63" id="h17-0-63" class="i">+n3@1 commit 1@1
</a><a href="#h17-0-64" id="h17-0-64" class="i">+n3@1 apply 1@1 None
</a><a href="#h17-0-65" id="h17-0-65" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h17-0-66" id="h17-0-66" class="i">+
</a><a href="#h17-0-67" id="h17-0-67" class="i">+status
</a><a href="#h17-0-68" id="h17-0-68" class="i">+---
</a><a href="#h17-0-69" id="h17-0-69" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h17-0-70" id="h17-0-70" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h17-0-71" id="h17-0-71" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h18" href="../file/src/raft/testscripts/election_candidate_behind_leader.html">src/raft/testscripts/election_candidate_behind_leader</a> b/<a href="../file/src/raft/testscripts/election_candidate_behind_leader.html">src/raft/testscripts/election_candidate_behind_leader</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,130 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+# A candidate that lags behind the leader can still win the election
</a><a href="#h18-0-1" id="h18-0-1" class="i">+# as long as it isn&#39;t behind the quorum.
</a><a href="#h18-0-2" id="h18-0-2" class="i">+
</a><a href="#h18-0-3" id="h18-0-3" class="i">+cluster nodes=5 leader=1
</a><a href="#h18-0-4" id="h18-0-4" class="i">+---
</a><a href="#h18-0-5" id="h18-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h18-0-6" id="h18-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-7" id="h18-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-8" id="h18-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-9" id="h18-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-10" id="h18-0-10" class="i">+
</a><a href="#h18-0-11" id="h18-0-11" class="i">+# Partition n1+n2 away from the cluster.
</a><a href="#h18-0-12" id="h18-0-12" class="i">+partition 1 2
</a><a href="#h18-0-13" id="h18-0-13" class="i">+---
</a><a href="#h18-0-14" id="h18-0-14" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h18-0-15" id="h18-0-15" class="i">+
</a><a href="#h18-0-16" id="h18-0-16" class="i">+# Replica a write on n1+n2. The write can&#39;t be committed, because n1 doesn&#39;t
</a><a href="#h18-0-17" id="h18-0-17" class="i">+# have quorum.
</a><a href="#h18-0-18" id="h18-0-18" class="i">+(put 1 foo=bar)
</a><a href="#h18-0-19" id="h18-0-19" class="i">+(stabilize)
</a><a href="#h18-0-20" id="h18-0-20" class="i">+status
</a><a href="#h18-0-21" id="h18-0-21" class="i">+---
</a><a href="#h18-0-22" id="h18-0-22" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h18-0-23" id="h18-0-23" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h18-0-24" id="h18-0-24" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-25" id="h18-0-25" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-26" id="h18-0-26" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-27" id="h18-0-27" class="i">+
</a><a href="#h18-0-28" id="h18-0-28" class="i">+# List the logs on n1 n2 n3 to show the replicated but uncommitted entry.
</a><a href="#h18-0-29" id="h18-0-29" class="i">+log 1 2 3
</a><a href="#h18-0-30" id="h18-0-30" class="i">+---
</a><a href="#h18-0-31" id="h18-0-31" class="i">+n1@1 last=2@1 commit=1@1
</a><a href="#h18-0-32" id="h18-0-32" class="i">+n1@1 entry 1@1 None
</a><a href="#h18-0-33" id="h18-0-33" class="i">+n1@1 entry 2@1 put foo=bar
</a><a href="#h18-0-34" id="h18-0-34" class="i">+n2@1 last=2@1 commit=1@1
</a><a href="#h18-0-35" id="h18-0-35" class="i">+n2@1 entry 1@1 None
</a><a href="#h18-0-36" id="h18-0-36" class="i">+n2@1 entry 2@1 put foo=bar
</a><a href="#h18-0-37" id="h18-0-37" class="i">+n3@1 last=1@1 commit=1@1
</a><a href="#h18-0-38" id="h18-0-38" class="i">+n3@1 entry 1@1 None
</a><a href="#h18-0-39" id="h18-0-39" class="i">+
</a><a href="#h18-0-40" id="h18-0-40" class="i">+# Heal the partition.
</a><a href="#h18-0-41" id="h18-0-41" class="i">+heal
</a><a href="#h18-0-42" id="h18-0-42" class="i">+---
</a><a href="#h18-0-43" id="h18-0-43" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h18-0-44" id="h18-0-44" class="i">+
</a><a href="#h18-0-45" id="h18-0-45" class="i">+# Make n5 campaign. n3+n4 grant their votes, n1+n2 reject it. n1 aborts the
</a><a href="#h18-0-46" id="h18-0-46" class="i">+# in-flight write request because the term changes.
</a><a href="#h18-0-47" id="h18-0-47" class="i">+campaign 5
</a><a href="#h18-0-48" id="h18-0-48" class="i">+deliver
</a><a href="#h18-0-49" id="h18-0-49" class="i">+---
</a><a href="#h18-0-50" id="h18-0-50" class="i">+n5@1 follower(n1) ⇨ n5@2 candidate
</a><a href="#h18-0-51" id="h18-0-51" class="i">+n5@2 → n1 Campaign last=1@1
</a><a href="#h18-0-52" id="h18-0-52" class="i">+n5@2 → n2 Campaign last=1@1
</a><a href="#h18-0-53" id="h18-0-53" class="i">+n5@2 → n3 Campaign last=1@1
</a><a href="#h18-0-54" id="h18-0-54" class="i">+n5@2 → n4 Campaign last=1@1
</a><a href="#h18-0-55" id="h18-0-55" class="i">+n1@1 leader ⇨ n1@2 follower()
</a><a href="#h18-0-56" id="h18-0-56" class="i">+n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h18-0-57" id="h18-0-57" class="i">+c1@1 put foo=bar ⇒ Error::Abort (Operation aborted)
</a><a href="#h18-0-58" id="h18-0-58" class="i">+n1@2 → n5 CampaignResponse vote=false
</a><a href="#h18-0-59" id="h18-0-59" class="i">+n2@1 follower(n1) ⇨ n2@2 follower()
</a><a href="#h18-0-60" id="h18-0-60" class="i">+n2@2 → n5 CampaignResponse vote=false
</a><a href="#h18-0-61" id="h18-0-61" class="i">+n3@1 follower(n1) ⇨ n3@2 follower()
</a><a href="#h18-0-62" id="h18-0-62" class="i">+n3@2 → n5 CampaignResponse vote=true
</a><a href="#h18-0-63" id="h18-0-63" class="i">+n4@1 follower(n1) ⇨ n4@2 follower()
</a><a href="#h18-0-64" id="h18-0-64" class="i">+n4@2 → n5 CampaignResponse vote=true
</a><a href="#h18-0-65" id="h18-0-65" class="i">+
</a><a href="#h18-0-66" id="h18-0-66" class="i">+# n5 wins the election and becomes leader.
</a><a href="#h18-0-67" id="h18-0-67" class="i">+stabilize heartbeat=true
</a><a href="#h18-0-68" id="h18-0-68" class="i">+---
</a><a href="#h18-0-69" id="h18-0-69" class="i">+n5@2 candidate ⇨ n5@2 leader
</a><a href="#h18-0-70" id="h18-0-70" class="i">+n5@2 append 2@2 None
</a><a href="#h18-0-71" id="h18-0-71" class="i">+n5@2 → n1 Append base=1@1 [2@2]
</a><a href="#h18-0-72" id="h18-0-72" class="i">+n5@2 → n2 Append base=1@1 [2@2]
</a><a href="#h18-0-73" id="h18-0-73" class="i">+n5@2 → n3 Append base=1@1 [2@2]
</a><a href="#h18-0-74" id="h18-0-74" class="i">+n5@2 → n4 Append base=1@1 [2@2]
</a><a href="#h18-0-75" id="h18-0-75" class="i">+n5@2 → n1 Heartbeat commit=1@1 read_seq=0
</a><a href="#h18-0-76" id="h18-0-76" class="i">+n5@2 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h18-0-77" id="h18-0-77" class="i">+n5@2 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h18-0-78" id="h18-0-78" class="i">+n5@2 → n4 Heartbeat commit=1@1 read_seq=0
</a><a href="#h18-0-79" id="h18-0-79" class="i">+n1@2 follower() ⇨ n1@2 follower(n5)
</a><a href="#h18-0-80" id="h18-0-80" class="i">+n1@2 → n5 AppendResponse last=2@2 reject=false
</a><a href="#h18-0-81" id="h18-0-81" class="i">+n1@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-82" id="h18-0-82" class="i">+n2@2 follower() ⇨ n2@2 follower(n5)
</a><a href="#h18-0-83" id="h18-0-83" class="i">+n2@2 → n5 AppendResponse last=2@2 reject=false
</a><a href="#h18-0-84" id="h18-0-84" class="i">+n2@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-85" id="h18-0-85" class="i">+n3@2 follower() ⇨ n3@2 follower(n5)
</a><a href="#h18-0-86" id="h18-0-86" class="i">+n3@2 append 2@2 None
</a><a href="#h18-0-87" id="h18-0-87" class="i">+n3@2 → n5 AppendResponse last=2@2 reject=false
</a><a href="#h18-0-88" id="h18-0-88" class="i">+n3@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-89" id="h18-0-89" class="i">+n4@2 follower() ⇨ n4@2 follower(n5)
</a><a href="#h18-0-90" id="h18-0-90" class="i">+n4@2 append 2@2 None
</a><a href="#h18-0-91" id="h18-0-91" class="i">+n4@2 → n5 AppendResponse last=2@2 reject=false
</a><a href="#h18-0-92" id="h18-0-92" class="i">+n4@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-93" id="h18-0-93" class="i">+n5@2 commit 2@2
</a><a href="#h18-0-94" id="h18-0-94" class="i">+n5@2 apply 2@2 None
</a><a href="#h18-0-95" id="h18-0-95" class="i">+n5@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h18-0-96" id="h18-0-96" class="i">+n5@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h18-0-97" id="h18-0-97" class="i">+n5@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h18-0-98" id="h18-0-98" class="i">+n5@2 → n4 Heartbeat commit=2@2 read_seq=0
</a><a href="#h18-0-99" id="h18-0-99" class="i">+n1@2 commit 2@2
</a><a href="#h18-0-100" id="h18-0-100" class="i">+n1@2 apply 2@2 None
</a><a href="#h18-0-101" id="h18-0-101" class="i">+n1@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-102" id="h18-0-102" class="i">+n2@2 commit 2@2
</a><a href="#h18-0-103" id="h18-0-103" class="i">+n2@2 apply 2@2 None
</a><a href="#h18-0-104" id="h18-0-104" class="i">+n2@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-105" id="h18-0-105" class="i">+n3@2 commit 2@2
</a><a href="#h18-0-106" id="h18-0-106" class="i">+n3@2 apply 2@2 None
</a><a href="#h18-0-107" id="h18-0-107" class="i">+n3@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-108" id="h18-0-108" class="i">+n4@2 commit 2@2
</a><a href="#h18-0-109" id="h18-0-109" class="i">+n4@2 apply 2@2 None
</a><a href="#h18-0-110" id="h18-0-110" class="i">+n4@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h18-0-111" id="h18-0-111" class="i">+
</a><a href="#h18-0-112" id="h18-0-112" class="i">+# n1+n2&#39;s in-flight write at log position 2 has been replaced by the
</a><a href="#h18-0-113" id="h18-0-113" class="i">+# empty log entry appended by n5 when it became leader.
</a><a href="#h18-0-114" id="h18-0-114" class="i">+log 1 2
</a><a href="#h18-0-115" id="h18-0-115" class="i">+---
</a><a href="#h18-0-116" id="h18-0-116" class="i">+n1@2 last=2@2 commit=2@2
</a><a href="#h18-0-117" id="h18-0-117" class="i">+n1@2 entry 1@1 None
</a><a href="#h18-0-118" id="h18-0-118" class="i">+n1@2 entry 2@2 None
</a><a href="#h18-0-119" id="h18-0-119" class="i">+n2@2 last=2@2 commit=2@2
</a><a href="#h18-0-120" id="h18-0-120" class="i">+n2@2 entry 1@1 None
</a><a href="#h18-0-121" id="h18-0-121" class="i">+n2@2 entry 2@2 None
</a><a href="#h18-0-122" id="h18-0-122" class="i">+
</a><a href="#h18-0-123" id="h18-0-123" class="i">+status
</a><a href="#h18-0-124" id="h18-0-124" class="i">+---
</a><a href="#h18-0-125" id="h18-0-125" class="i">+n1@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h18-0-126" id="h18-0-126" class="i">+n2@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h18-0-127" id="h18-0-127" class="i">+n3@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h18-0-128" id="h18-0-128" class="i">+n4@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h18-0-129" id="h18-0-129" class="i">+n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:2→3 2:2→3 3:2→3 4:2→3}
</a><b>diff --git a/<a id="h19" href="../file/src/raft/testscripts/election_candidate_behind_quorum.html">src/raft/testscripts/election_candidate_behind_quorum</a> b/<a href="../file/src/raft/testscripts/election_candidate_behind_quorum.html">src/raft/testscripts/election_candidate_behind_quorum</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,73 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+# A candidate that lags behind the quorum can&#39;t win an election.
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+cluster nodes=5 leader=1
</a><a href="#h19-0-3" id="h19-0-3" class="i">+---
</a><a href="#h19-0-4" id="h19-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h19-0-5" id="h19-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-6" id="h19-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-7" id="h19-0-7" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-8" id="h19-0-8" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-9" id="h19-0-9" class="i">+
</a><a href="#h19-0-10" id="h19-0-10" class="i">+# Partition n4+n5 away from the cluster.
</a><a href="#h19-0-11" id="h19-0-11" class="i">+partition 4 5
</a><a href="#h19-0-12" id="h19-0-12" class="i">+---
</a><a href="#h19-0-13" id="h19-0-13" class="i">+n4 n5 ⇹ n1 n2 n3
</a><a href="#h19-0-14" id="h19-0-14" class="i">+
</a><a href="#h19-0-15" id="h19-0-15" class="i">+# Replicate a write on n1. n4+n5 now lag behind the quorum. Don&#39;t yet propagate
</a><a href="#h19-0-16" id="h19-0-16" class="i">+# the commit index to n2+n3, to make sure it won&#39;t grant the vote just because
</a><a href="#h19-0-17" id="h19-0-17" class="i">+# n5 is caught up to their local view of the commit index.
</a><a href="#h19-0-18" id="h19-0-18" class="i">+(put 1 foo=bar)
</a><a href="#h19-0-19" id="h19-0-19" class="i">+(stabilize)
</a><a href="#h19-0-20" id="h19-0-20" class="i">+status
</a><a href="#h19-0-21" id="h19-0-21" class="i">+---
</a><a href="#h19-0-22" id="h19-0-22" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3 4:1→2 5:1→2}
</a><a href="#h19-0-23" id="h19-0-23" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h19-0-24" id="h19-0-24" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h19-0-25" id="h19-0-25" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-26" id="h19-0-26" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-27" id="h19-0-27" class="i">+
</a><a href="#h19-0-28" id="h19-0-28" class="i">+# Heal the partition.
</a><a href="#h19-0-29" id="h19-0-29" class="i">+heal
</a><a href="#h19-0-30" id="h19-0-30" class="i">+---
</a><a href="#h19-0-31" id="h19-0-31" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h19-0-32" id="h19-0-32" class="i">+
</a><a href="#h19-0-33" id="h19-0-33" class="i">+# Make n5 campaign. n4 grants its vote, but the others reject it because it is
</a><a href="#h19-0-34" id="h19-0-34" class="i">+# behind the quorum. However, the term bump will convert the other nodes to
</a><a href="#h19-0-35" id="h19-0-35" class="i">+# leaderless followers.
</a><a href="#h19-0-36" id="h19-0-36" class="i">+heal
</a><a href="#h19-0-37" id="h19-0-37" class="i">+campaign 5
</a><a href="#h19-0-38" id="h19-0-38" class="i">+stabilize
</a><a href="#h19-0-39" id="h19-0-39" class="i">+---
</a><a href="#h19-0-40" id="h19-0-40" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h19-0-41" id="h19-0-41" class="i">+n5@1 follower(n1) ⇨ n5@2 candidate
</a><a href="#h19-0-42" id="h19-0-42" class="i">+n5@2 → n1 Campaign last=1@1
</a><a href="#h19-0-43" id="h19-0-43" class="i">+n5@2 → n2 Campaign last=1@1
</a><a href="#h19-0-44" id="h19-0-44" class="i">+n5@2 → n3 Campaign last=1@1
</a><a href="#h19-0-45" id="h19-0-45" class="i">+n5@2 → n4 Campaign last=1@1
</a><a href="#h19-0-46" id="h19-0-46" class="i">+n1@1 leader ⇨ n1@2 follower()
</a><a href="#h19-0-47" id="h19-0-47" class="i">+n1@2 → n5 CampaignResponse vote=false
</a><a href="#h19-0-48" id="h19-0-48" class="i">+n2@1 follower(n1) ⇨ n2@2 follower()
</a><a href="#h19-0-49" id="h19-0-49" class="i">+n2@2 → n5 CampaignResponse vote=false
</a><a href="#h19-0-50" id="h19-0-50" class="i">+n3@1 follower(n1) ⇨ n3@2 follower()
</a><a href="#h19-0-51" id="h19-0-51" class="i">+n3@2 → n5 CampaignResponse vote=false
</a><a href="#h19-0-52" id="h19-0-52" class="i">+n4@1 follower(n1) ⇨ n4@2 follower()
</a><a href="#h19-0-53" id="h19-0-53" class="i">+n4@2 → n5 CampaignResponse vote=true
</a><a href="#h19-0-54" id="h19-0-54" class="i">+
</a><a href="#h19-0-55" id="h19-0-55" class="i">+status
</a><a href="#h19-0-56" id="h19-0-56" class="i">+---
</a><a href="#h19-0-57" id="h19-0-57" class="i">+n1@2 follower() last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-58" id="h19-0-58" class="i">+n2@2 follower() last=2@1 commit=1@1 apply=1
</a><a href="#h19-0-59" id="h19-0-59" class="i">+n3@2 follower() last=2@1 commit=1@1 apply=1
</a><a href="#h19-0-60" id="h19-0-60" class="i">+n4@2 follower() last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-61" id="h19-0-61" class="i">+n5@2 candidate last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-62" id="h19-0-62" class="i">+
</a><a href="#h19-0-63" id="h19-0-63" class="i">+# n2 can campaign and win the election.
</a><a href="#h19-0-64" id="h19-0-64" class="i">+(campaign 2)
</a><a href="#h19-0-65" id="h19-0-65" class="i">+(stabilize heartbeat=true)
</a><a href="#h19-0-66" id="h19-0-66" class="i">+status
</a><a href="#h19-0-67" id="h19-0-67" class="i">+---
</a><a href="#h19-0-68" id="h19-0-68" class="i">+n1@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h19-0-69" id="h19-0-69" class="i">+n2@3 leader last=3@3 commit=3@3 apply=3 progress={1:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h19-0-70" id="h19-0-70" class="i">+n3@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h19-0-71" id="h19-0-71" class="i">+n4@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h19-0-72" id="h19-0-72" class="i">+n5@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><b>diff --git a/<a id="h20" href="../file/src/raft/testscripts/election_contested.html">src/raft/testscripts/election_contested</a> b/<a href="../file/src/raft/testscripts/election_contested.html">src/raft/testscripts/election_contested</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,89 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+# A leader can be elected even when there are multiple candidates.
</a><a href="#h20-0-1" id="h20-0-1" class="i">+
</a><a href="#h20-0-2" id="h20-0-2" class="i">+cluster nodes=5 election_timeout=2
</a><a href="#h20-0-3" id="h20-0-3" class="i">+---
</a><a href="#h20-0-4" id="h20-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h20-0-5" id="h20-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h20-0-6" id="h20-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h20-0-7" id="h20-0-7" class="i">+n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h20-0-8" id="h20-0-8" class="i">+n5@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h20-0-9" id="h20-0-9" class="i">+
</a><a href="#h20-0-10" id="h20-0-10" class="i">+# n1 and n5 campaign.
</a><a href="#h20-0-11" id="h20-0-11" class="i">+tick
</a><a href="#h20-0-12" id="h20-0-12" class="i">+tick 1 5
</a><a href="#h20-0-13" id="h20-0-13" class="i">+---
</a><a href="#h20-0-14" id="h20-0-14" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h20-0-15" id="h20-0-15" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h20-0-16" id="h20-0-16" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h20-0-17" id="h20-0-17" class="i">+n1@1 → n4 Campaign last=0@0
</a><a href="#h20-0-18" id="h20-0-18" class="i">+n1@1 → n5 Campaign last=0@0
</a><a href="#h20-0-19" id="h20-0-19" class="i">+n5@0 follower() ⇨ n5@1 candidate
</a><a href="#h20-0-20" id="h20-0-20" class="i">+n5@1 → n1 Campaign last=0@0
</a><a href="#h20-0-21" id="h20-0-21" class="i">+n5@1 → n2 Campaign last=0@0
</a><a href="#h20-0-22" id="h20-0-22" class="i">+n5@1 → n3 Campaign last=0@0
</a><a href="#h20-0-23" id="h20-0-23" class="i">+n5@1 → n4 Campaign last=0@0
</a><a href="#h20-0-24" id="h20-0-24" class="i">+
</a><a href="#h20-0-25" id="h20-0-25" class="i">+# n1 and n5 ignore each other, since they&#39;re both campaigning.
</a><a href="#h20-0-26" id="h20-0-26" class="i">+deliver 1 5
</a><a href="#h20-0-27" id="h20-0-27" class="i">+---
</a><a href="#h20-0-28" id="h20-0-28" class="i">+n1@1 → n5 CampaignResponse vote=false
</a><a href="#h20-0-29" id="h20-0-29" class="i">+n5@1 → n1 CampaignResponse vote=false
</a><a href="#h20-0-30" id="h20-0-30" class="i">+
</a><a href="#h20-0-31" id="h20-0-31" class="i">+# n1 reaches n2,n3 first, but n5 reaches n4 first.
</a><a href="#h20-0-32" id="h20-0-32" class="i">+deliver 2 3
</a><a href="#h20-0-33" id="h20-0-33" class="i">+deliver 4 from=5
</a><a href="#h20-0-34" id="h20-0-34" class="i">+deliver 4
</a><a href="#h20-0-35" id="h20-0-35" class="i">+---
</a><a href="#h20-0-36" id="h20-0-36" class="i">+n2@0 follower() ⇨ n2@1 follower()
</a><a href="#h20-0-37" id="h20-0-37" class="i">+n2@1 → n1 CampaignResponse vote=true
</a><a href="#h20-0-38" id="h20-0-38" class="i">+n2@1 → n5 CampaignResponse vote=false
</a><a href="#h20-0-39" id="h20-0-39" class="i">+n3@0 follower() ⇨ n3@1 follower()
</a><a href="#h20-0-40" id="h20-0-40" class="i">+n3@1 → n1 CampaignResponse vote=true
</a><a href="#h20-0-41" id="h20-0-41" class="i">+n3@1 → n5 CampaignResponse vote=false
</a><a href="#h20-0-42" id="h20-0-42" class="i">+n4@0 follower() ⇨ n4@1 follower()
</a><a href="#h20-0-43" id="h20-0-43" class="i">+n4@1 → n5 CampaignResponse vote=true
</a><a href="#h20-0-44" id="h20-0-44" class="i">+n4@1 → n1 CampaignResponse vote=false
</a><a href="#h20-0-45" id="h20-0-45" class="i">+
</a><a href="#h20-0-46" id="h20-0-46" class="i">+# n1 and n5 receive their votes. n1 has quorum and becomes leader.
</a><a href="#h20-0-47" id="h20-0-47" class="i">+deliver
</a><a href="#h20-0-48" id="h20-0-48" class="i">+---
</a><a href="#h20-0-49" id="h20-0-49" class="i">+n1@1 candidate ⇨ n1@1 leader
</a><a href="#h20-0-50" id="h20-0-50" class="i">+n1@1 append 1@1 None
</a><a href="#h20-0-51" id="h20-0-51" class="i">+n1@1 → n2 Append base=0@0 [1@1]
</a><a href="#h20-0-52" id="h20-0-52" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h20-0-53" id="h20-0-53" class="i">+n1@1 → n4 Append base=0@0 [1@1]
</a><a href="#h20-0-54" id="h20-0-54" class="i">+n1@1 → n5 Append base=0@0 [1@1]
</a><a href="#h20-0-55" id="h20-0-55" class="i">+n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-56" id="h20-0-56" class="i">+n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-57" id="h20-0-57" class="i">+n1@1 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-58" id="h20-0-58" class="i">+n1@1 → n5 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-59" id="h20-0-59" class="i">+
</a><a href="#h20-0-60" id="h20-0-60" class="i">+# All nodes accept n1 as leader in term 1 and become followers.
</a><a href="#h20-0-61" id="h20-0-61" class="i">+stabilize
</a><a href="#h20-0-62" id="h20-0-62" class="i">+---
</a><a href="#h20-0-63" id="h20-0-63" class="i">+n2@1 follower() ⇨ n2@1 follower(n1)
</a><a href="#h20-0-64" id="h20-0-64" class="i">+n2@1 append 1@1 None
</a><a href="#h20-0-65" id="h20-0-65" class="i">+n2@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h20-0-66" id="h20-0-66" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-67" id="h20-0-67" class="i">+n3@1 follower() ⇨ n3@1 follower(n1)
</a><a href="#h20-0-68" id="h20-0-68" class="i">+n3@1 append 1@1 None
</a><a href="#h20-0-69" id="h20-0-69" class="i">+n3@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h20-0-70" id="h20-0-70" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-71" id="h20-0-71" class="i">+n4@1 follower() ⇨ n4@1 follower(n1)
</a><a href="#h20-0-72" id="h20-0-72" class="i">+n4@1 append 1@1 None
</a><a href="#h20-0-73" id="h20-0-73" class="i">+n4@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h20-0-74" id="h20-0-74" class="i">+n4@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-75" id="h20-0-75" class="i">+n5@1 candidate ⇨ n5@1 follower(n1)
</a><a href="#h20-0-76" id="h20-0-76" class="i">+n5@1 append 1@1 None
</a><a href="#h20-0-77" id="h20-0-77" class="i">+n5@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h20-0-78" id="h20-0-78" class="i">+n5@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-79" id="h20-0-79" class="i">+n1@1 commit 1@1
</a><a href="#h20-0-80" id="h20-0-80" class="i">+n1@1 apply 1@1 None
</a><a href="#h20-0-81" id="h20-0-81" class="i">+
</a><a href="#h20-0-82" id="h20-0-82" class="i">+status
</a><a href="#h20-0-83" id="h20-0-83" class="i">+---
</a><a href="#h20-0-84" id="h20-0-84" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h20-0-85" id="h20-0-85" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h20-0-86" id="h20-0-86" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h20-0-87" id="h20-0-87" class="i">+n4@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h20-0-88" id="h20-0-88" class="i">+n5@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><b>diff --git a/<a id="h21" href="../file/src/raft/testscripts/election_tie.html">src/raft/testscripts/election_tie</a> b/<a href="../file/src/raft/testscripts/election_tie.html">src/raft/testscripts/election_tie</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+# No leader can be elected with an election tie.
</a><a href="#h21-0-1" id="h21-0-1" class="i">+
</a><a href="#h21-0-2" id="h21-0-2" class="i">+cluster nodes=3 election_timeout=2
</a><a href="#h21-0-3" id="h21-0-3" class="i">+---
</a><a href="#h21-0-4" id="h21-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-5" id="h21-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-6" id="h21-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-7" id="h21-0-7" class="i">+
</a><a href="#h21-0-8" id="h21-0-8" class="i">+# Tick all nodes twice to make them all campaign.
</a><a href="#h21-0-9" id="h21-0-9" class="i">+tick
</a><a href="#h21-0-10" id="h21-0-10" class="i">+tick
</a><a href="#h21-0-11" id="h21-0-11" class="i">+---
</a><a href="#h21-0-12" id="h21-0-12" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h21-0-13" id="h21-0-13" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h21-0-14" id="h21-0-14" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h21-0-15" id="h21-0-15" class="i">+n2@0 follower() ⇨ n2@1 candidate
</a><a href="#h21-0-16" id="h21-0-16" class="i">+n2@1 → n1 Campaign last=0@0
</a><a href="#h21-0-17" id="h21-0-17" class="i">+n2@1 → n3 Campaign last=0@0
</a><a href="#h21-0-18" id="h21-0-18" class="i">+n3@0 follower() ⇨ n3@1 candidate
</a><a href="#h21-0-19" id="h21-0-19" class="i">+n3@1 → n1 Campaign last=0@0
</a><a href="#h21-0-20" id="h21-0-20" class="i">+n3@1 → n2 Campaign last=0@0
</a><a href="#h21-0-21" id="h21-0-21" class="i">+
</a><a href="#h21-0-22" id="h21-0-22" class="i">+# Stabilizing the cluster will not result in a leader.
</a><a href="#h21-0-23" id="h21-0-23" class="i">+stabilize
</a><a href="#h21-0-24" id="h21-0-24" class="i">+---
</a><a href="#h21-0-25" id="h21-0-25" class="i">+n1@1 → n2 CampaignResponse vote=false
</a><a href="#h21-0-26" id="h21-0-26" class="i">+n1@1 → n3 CampaignResponse vote=false
</a><a href="#h21-0-27" id="h21-0-27" class="i">+n2@1 → n1 CampaignResponse vote=false
</a><a href="#h21-0-28" id="h21-0-28" class="i">+n2@1 → n3 CampaignResponse vote=false
</a><a href="#h21-0-29" id="h21-0-29" class="i">+n3@1 → n1 CampaignResponse vote=false
</a><a href="#h21-0-30" id="h21-0-30" class="i">+n3@1 → n2 CampaignResponse vote=false
</a><a href="#h21-0-31" id="h21-0-31" class="i">+
</a><a href="#h21-0-32" id="h21-0-32" class="i">+status
</a><a href="#h21-0-33" id="h21-0-33" class="i">+---
</a><a href="#h21-0-34" id="h21-0-34" class="i">+n1@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-35" id="h21-0-35" class="i">+n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-36" id="h21-0-36" class="i">+n3@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h21-0-37" id="h21-0-37" class="i">+
</a><a href="#h21-0-38" id="h21-0-38" class="i">+# A node can call another election in a new term and win.
</a><a href="#h21-0-39" id="h21-0-39" class="i">+tick 2
</a><a href="#h21-0-40" id="h21-0-40" class="i">+tick 2
</a><a href="#h21-0-41" id="h21-0-41" class="i">+---
</a><a href="#h21-0-42" id="h21-0-42" class="i">+n2@1 candidate ⇨ n2@2 candidate
</a><a href="#h21-0-43" id="h21-0-43" class="i">+n2@2 → n1 Campaign last=0@0
</a><a href="#h21-0-44" id="h21-0-44" class="i">+n2@2 → n3 Campaign last=0@0
</a><a href="#h21-0-45" id="h21-0-45" class="i">+
</a><a href="#h21-0-46" id="h21-0-46" class="i">+deliver
</a><a href="#h21-0-47" id="h21-0-47" class="i">+---
</a><a href="#h21-0-48" id="h21-0-48" class="i">+n1@1 candidate ⇨ n1@2 follower()
</a><a href="#h21-0-49" id="h21-0-49" class="i">+n1@2 → n2 CampaignResponse vote=true
</a><a href="#h21-0-50" id="h21-0-50" class="i">+n3@1 candidate ⇨ n3@2 follower()
</a><a href="#h21-0-51" id="h21-0-51" class="i">+n3@2 → n2 CampaignResponse vote=true
</a><a href="#h21-0-52" id="h21-0-52" class="i">+
</a><a href="#h21-0-53" id="h21-0-53" class="i">+deliver
</a><a href="#h21-0-54" id="h21-0-54" class="i">+---
</a><a href="#h21-0-55" id="h21-0-55" class="i">+n2@2 candidate ⇨ n2@2 leader
</a><a href="#h21-0-56" id="h21-0-56" class="i">+n2@2 append 1@2 None
</a><a href="#h21-0-57" id="h21-0-57" class="i">+n2@2 → n1 Append base=0@0 [1@2]
</a><a href="#h21-0-58" id="h21-0-58" class="i">+n2@2 → n3 Append base=0@0 [1@2]
</a><a href="#h21-0-59" id="h21-0-59" class="i">+n2@2 → n1 Heartbeat commit=0@0 read_seq=0
</a><a href="#h21-0-60" id="h21-0-60" class="i">+n2@2 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h21-0-61" id="h21-0-61" class="i">+
</a><a href="#h21-0-62" id="h21-0-62" class="i">+stabilize
</a><a href="#h21-0-63" id="h21-0-63" class="i">+---
</a><a href="#h21-0-64" id="h21-0-64" class="i">+n1@2 follower() ⇨ n1@2 follower(n2)
</a><a href="#h21-0-65" id="h21-0-65" class="i">+n1@2 append 1@2 None
</a><a href="#h21-0-66" id="h21-0-66" class="i">+n1@2 → n2 AppendResponse last=1@2 reject=false
</a><a href="#h21-0-67" id="h21-0-67" class="i">+n1@2 → n2 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h21-0-68" id="h21-0-68" class="i">+n3@2 follower() ⇨ n3@2 follower(n2)
</a><a href="#h21-0-69" id="h21-0-69" class="i">+n3@2 append 1@2 None
</a><a href="#h21-0-70" id="h21-0-70" class="i">+n3@2 → n2 AppendResponse last=1@2 reject=false
</a><a href="#h21-0-71" id="h21-0-71" class="i">+n3@2 → n2 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h21-0-72" id="h21-0-72" class="i">+n2@2 commit 1@2
</a><a href="#h21-0-73" id="h21-0-73" class="i">+n2@2 apply 1@2 None
</a><a href="#h21-0-74" id="h21-0-74" class="i">+
</a><a href="#h21-0-75" id="h21-0-75" class="i">+status
</a><a href="#h21-0-76" id="h21-0-76" class="i">+---
</a><a href="#h21-0-77" id="h21-0-77" class="i">+n1@2 follower(n2) last=1@2 commit=0@0 apply=0
</a><a href="#h21-0-78" id="h21-0-78" class="i">+n2@2 leader last=1@2 commit=1@2 apply=1 progress={1:1→2 3:1→2}
</a><a href="#h21-0-79" id="h21-0-79" class="i">+n3@2 follower(n2) last=1@2 commit=0@0 apply=0
</a><b>diff --git a/<a id="h22" href="../file/src/raft/testscripts/election_tie_even.html">src/raft/testscripts/election_tie_even</a> b/<a href="../file/src/raft/testscripts/election_tie_even.html">src/raft/testscripts/election_tie_even</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,99 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+# No leader can be elected with an election tie between an even number of nodes.
</a><a href="#h22-0-1" id="h22-0-1" class="i">+
</a><a href="#h22-0-2" id="h22-0-2" class="i">+cluster nodes=4 election_timeout=2
</a><a href="#h22-0-3" id="h22-0-3" class="i">+---
</a><a href="#h22-0-4" id="h22-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-5" id="h22-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-6" id="h22-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-7" id="h22-0-7" class="i">+n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-8" id="h22-0-8" class="i">+
</a><a href="#h22-0-9" id="h22-0-9" class="i">+# n1 and n4 campaign.
</a><a href="#h22-0-10" id="h22-0-10" class="i">+tick
</a><a href="#h22-0-11" id="h22-0-11" class="i">+tick 1 4
</a><a href="#h22-0-12" id="h22-0-12" class="i">+---
</a><a href="#h22-0-13" id="h22-0-13" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h22-0-14" id="h22-0-14" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h22-0-15" id="h22-0-15" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h22-0-16" id="h22-0-16" class="i">+n1@1 → n4 Campaign last=0@0
</a><a href="#h22-0-17" id="h22-0-17" class="i">+n4@0 follower() ⇨ n4@1 candidate
</a><a href="#h22-0-18" id="h22-0-18" class="i">+n4@1 → n1 Campaign last=0@0
</a><a href="#h22-0-19" id="h22-0-19" class="i">+n4@1 → n2 Campaign last=0@0
</a><a href="#h22-0-20" id="h22-0-20" class="i">+n4@1 → n3 Campaign last=0@0
</a><a href="#h22-0-21" id="h22-0-21" class="i">+
</a><a href="#h22-0-22" id="h22-0-22" class="i">+# n2 votes for n1, n3 votes for n4.
</a><a href="#h22-0-23" id="h22-0-23" class="i">+deliver 2
</a><a href="#h22-0-24" id="h22-0-24" class="i">+deliver 3 from=4
</a><a href="#h22-0-25" id="h22-0-25" class="i">+deliver 3
</a><a href="#h22-0-26" id="h22-0-26" class="i">+---
</a><a href="#h22-0-27" id="h22-0-27" class="i">+n2@0 follower() ⇨ n2@1 follower()
</a><a href="#h22-0-28" id="h22-0-28" class="i">+n2@1 → n1 CampaignResponse vote=true
</a><a href="#h22-0-29" id="h22-0-29" class="i">+n2@1 → n4 CampaignResponse vote=false
</a><a href="#h22-0-30" id="h22-0-30" class="i">+n3@0 follower() ⇨ n3@1 follower()
</a><a href="#h22-0-31" id="h22-0-31" class="i">+n3@1 → n4 CampaignResponse vote=true
</a><a href="#h22-0-32" id="h22-0-32" class="i">+n3@1 → n1 CampaignResponse vote=false
</a><a href="#h22-0-33" id="h22-0-33" class="i">+
</a><a href="#h22-0-34" id="h22-0-34" class="i">+# Stabilizing the cluster will not result in a leader.
</a><a href="#h22-0-35" id="h22-0-35" class="i">+stabilize
</a><a href="#h22-0-36" id="h22-0-36" class="i">+---
</a><a href="#h22-0-37" id="h22-0-37" class="i">+n1@1 → n4 CampaignResponse vote=false
</a><a href="#h22-0-38" id="h22-0-38" class="i">+n4@1 → n1 CampaignResponse vote=false
</a><a href="#h22-0-39" id="h22-0-39" class="i">+
</a><a href="#h22-0-40" id="h22-0-40" class="i">+status
</a><a href="#h22-0-41" id="h22-0-41" class="i">+---
</a><a href="#h22-0-42" id="h22-0-42" class="i">+n1@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-43" id="h22-0-43" class="i">+n2@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-44" id="h22-0-44" class="i">+n3@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-45" id="h22-0-45" class="i">+n4@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-46" id="h22-0-46" class="i">+
</a><a href="#h22-0-47" id="h22-0-47" class="i">+# A node can call another election in a new term and win.
</a><a href="#h22-0-48" id="h22-0-48" class="i">+tick 3
</a><a href="#h22-0-49" id="h22-0-49" class="i">+tick 3
</a><a href="#h22-0-50" id="h22-0-50" class="i">+---
</a><a href="#h22-0-51" id="h22-0-51" class="i">+n3@1 follower() ⇨ n3@2 candidate
</a><a href="#h22-0-52" id="h22-0-52" class="i">+n3@2 → n1 Campaign last=0@0
</a><a href="#h22-0-53" id="h22-0-53" class="i">+n3@2 → n2 Campaign last=0@0
</a><a href="#h22-0-54" id="h22-0-54" class="i">+n3@2 → n4 Campaign last=0@0
</a><a href="#h22-0-55" id="h22-0-55" class="i">+
</a><a href="#h22-0-56" id="h22-0-56" class="i">+deliver
</a><a href="#h22-0-57" id="h22-0-57" class="i">+---
</a><a href="#h22-0-58" id="h22-0-58" class="i">+n1@1 candidate ⇨ n1@2 follower()
</a><a href="#h22-0-59" id="h22-0-59" class="i">+n1@2 → n3 CampaignResponse vote=true
</a><a href="#h22-0-60" id="h22-0-60" class="i">+n2@1 follower() ⇨ n2@2 follower()
</a><a href="#h22-0-61" id="h22-0-61" class="i">+n2@2 → n3 CampaignResponse vote=true
</a><a href="#h22-0-62" id="h22-0-62" class="i">+n4@1 candidate ⇨ n4@2 follower()
</a><a href="#h22-0-63" id="h22-0-63" class="i">+n4@2 → n3 CampaignResponse vote=true
</a><a href="#h22-0-64" id="h22-0-64" class="i">+
</a><a href="#h22-0-65" id="h22-0-65" class="i">+deliver
</a><a href="#h22-0-66" id="h22-0-66" class="i">+---
</a><a href="#h22-0-67" id="h22-0-67" class="i">+n3@2 candidate ⇨ n3@2 leader
</a><a href="#h22-0-68" id="h22-0-68" class="i">+n3@2 append 1@2 None
</a><a href="#h22-0-69" id="h22-0-69" class="i">+n3@2 → n1 Append base=0@0 [1@2]
</a><a href="#h22-0-70" id="h22-0-70" class="i">+n3@2 → n2 Append base=0@0 [1@2]
</a><a href="#h22-0-71" id="h22-0-71" class="i">+n3@2 → n4 Append base=0@0 [1@2]
</a><a href="#h22-0-72" id="h22-0-72" class="i">+n3@2 → n1 Heartbeat commit=0@0 read_seq=0
</a><a href="#h22-0-73" id="h22-0-73" class="i">+n3@2 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h22-0-74" id="h22-0-74" class="i">+n3@2 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h22-0-75" id="h22-0-75" class="i">+
</a><a href="#h22-0-76" id="h22-0-76" class="i">+stabilize
</a><a href="#h22-0-77" id="h22-0-77" class="i">+---
</a><a href="#h22-0-78" id="h22-0-78" class="i">+n1@2 follower() ⇨ n1@2 follower(n3)
</a><a href="#h22-0-79" id="h22-0-79" class="i">+n1@2 append 1@2 None
</a><a href="#h22-0-80" id="h22-0-80" class="i">+n1@2 → n3 AppendResponse last=1@2 reject=false
</a><a href="#h22-0-81" id="h22-0-81" class="i">+n1@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h22-0-82" id="h22-0-82" class="i">+n2@2 follower() ⇨ n2@2 follower(n3)
</a><a href="#h22-0-83" id="h22-0-83" class="i">+n2@2 append 1@2 None
</a><a href="#h22-0-84" id="h22-0-84" class="i">+n2@2 → n3 AppendResponse last=1@2 reject=false
</a><a href="#h22-0-85" id="h22-0-85" class="i">+n2@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h22-0-86" id="h22-0-86" class="i">+n4@2 follower() ⇨ n4@2 follower(n3)
</a><a href="#h22-0-87" id="h22-0-87" class="i">+n4@2 append 1@2 None
</a><a href="#h22-0-88" id="h22-0-88" class="i">+n4@2 → n3 AppendResponse last=1@2 reject=false
</a><a href="#h22-0-89" id="h22-0-89" class="i">+n4@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h22-0-90" id="h22-0-90" class="i">+n3@2 commit 1@2
</a><a href="#h22-0-91" id="h22-0-91" class="i">+n3@2 apply 1@2 None
</a><a href="#h22-0-92" id="h22-0-92" class="i">+
</a><a href="#h22-0-93" id="h22-0-93" class="i">+status
</a><a href="#h22-0-94" id="h22-0-94" class="i">+---
</a><a href="#h22-0-95" id="h22-0-95" class="i">+n1@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><a href="#h22-0-96" id="h22-0-96" class="i">+n2@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><a href="#h22-0-97" id="h22-0-97" class="i">+n3@2 leader last=1@2 commit=1@2 apply=1 progress={1:1→2 2:1→2 4:1→2}
</a><a href="#h22-0-98" id="h22-0-98" class="i">+n4@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><b>diff --git a/<a id="h23" href="../file/src/raft/testscripts/heartbeat_commits_follower.html">src/raft/testscripts/heartbeat_commits_follower</a> b/<a href="../file/src/raft/testscripts/heartbeat_commits_follower.html">src/raft/testscripts/heartbeat_commits_follower</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+# A heartbeat will commit and apply an entry on a follower.
</a><a href="#h23-0-1" id="h23-0-1" class="i">+
</a><a href="#h23-0-2" id="h23-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h23-0-3" id="h23-0-3" class="i">+---
</a><a href="#h23-0-4" id="h23-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h23-0-5" id="h23-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h23-0-6" id="h23-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h23-0-7" id="h23-0-7" class="i">+
</a><a href="#h23-0-8" id="h23-0-8" class="i">+# Write on the leader, which replicates then commits and applies locally.
</a><a href="#h23-0-9" id="h23-0-9" class="i">+put 1 foo=bar
</a><a href="#h23-0-10" id="h23-0-10" class="i">+stabilize
</a><a href="#h23-0-11" id="h23-0-11" class="i">+---
</a><a href="#h23-0-12" id="h23-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h23-0-13" id="h23-0-13" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h23-0-14" id="h23-0-14" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h23-0-15" id="h23-0-15" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h23-0-16" id="h23-0-16" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h23-0-17" id="h23-0-17" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h23-0-18" id="h23-0-18" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h23-0-19" id="h23-0-19" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h23-0-20" id="h23-0-20" class="i">+n1@1 commit 2@1
</a><a href="#h23-0-21" id="h23-0-21" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h23-0-22" id="h23-0-22" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h23-0-23" id="h23-0-23" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h23-0-24" id="h23-0-24" class="i">+
</a><a href="#h23-0-25" id="h23-0-25" class="i">+# The write has been replicated, but not yet committed and applied on followers.
</a><a href="#h23-0-26" id="h23-0-26" class="i">+status
</a><a href="#h23-0-27" id="h23-0-27" class="i">+---
</a><a href="#h23-0-28" id="h23-0-28" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h23-0-29" id="h23-0-29" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h23-0-30" id="h23-0-30" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h23-0-31" id="h23-0-31" class="i">+
</a><a href="#h23-0-32" id="h23-0-32" class="i">+# A heartbeat commits and applies on followers.
</a><a href="#h23-0-33" id="h23-0-33" class="i">+heartbeat 1
</a><a href="#h23-0-34" id="h23-0-34" class="i">+stabilize
</a><a href="#h23-0-35" id="h23-0-35" class="i">+---
</a><a href="#h23-0-36" id="h23-0-36" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=0
</a><a href="#h23-0-37" id="h23-0-37" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=0
</a><a href="#h23-0-38" id="h23-0-38" class="i">+n2@1 commit 2@1
</a><a href="#h23-0-39" id="h23-0-39" class="i">+n2@1 apply 2@1 put foo=bar
</a><a href="#h23-0-40" id="h23-0-40" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><a href="#h23-0-41" id="h23-0-41" class="i">+n3@1 commit 2@1
</a><a href="#h23-0-42" id="h23-0-42" class="i">+n3@1 apply 2@1 put foo=bar
</a><a href="#h23-0-43" id="h23-0-43" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><a href="#h23-0-44" id="h23-0-44" class="i">+
</a><a href="#h23-0-45" id="h23-0-45" class="i">+status
</a><a href="#h23-0-46" id="h23-0-46" class="i">+---
</a><a href="#h23-0-47" id="h23-0-47" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h23-0-48" id="h23-0-48" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h23-0-49" id="h23-0-49" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><b>diff --git a/<a id="h24" href="../file/src/raft/testscripts/heartbeat_converts_candidate.html">src/raft/testscripts/heartbeat_converts_candidate</a> b/<a href="../file/src/raft/testscripts/heartbeat_converts_candidate.html">src/raft/testscripts/heartbeat_converts_candidate</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+# A heartbeat from a leader should convert a candidate in the same term to a
</a><a href="#h24-0-1" id="h24-0-1" class="i">+# follower.
</a><a href="#h24-0-2" id="h24-0-2" class="i">+
</a><a href="#h24-0-3" id="h24-0-3" class="i">+cluster nodes=3
</a><a href="#h24-0-4" id="h24-0-4" class="i">+---
</a><a href="#h24-0-5" id="h24-0-5" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-6" id="h24-0-6" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-7" id="h24-0-7" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-8" id="h24-0-8" class="i">+
</a><a href="#h24-0-9" id="h24-0-9" class="i">+# Partition n3 away from the cluster.
</a><a href="#h24-0-10" id="h24-0-10" class="i">+partition 3
</a><a href="#h24-0-11" id="h24-0-11" class="i">+---
</a><a href="#h24-0-12" id="h24-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h24-0-13" id="h24-0-13" class="i">+
</a><a href="#h24-0-14" id="h24-0-14" class="i">+# Both n1 and n3 campaign. n2 votes for n1.
</a><a href="#h24-0-15" id="h24-0-15" class="i">+campaign 1 3
</a><a href="#h24-0-16" id="h24-0-16" class="i">+deliver
</a><a href="#h24-0-17" id="h24-0-17" class="i">+---
</a><a href="#h24-0-18" id="h24-0-18" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h24-0-19" id="h24-0-19" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h24-0-20" id="h24-0-20" class="i">+n1@1 ⇥ n3 C̶a̶m̶p̶a̶i̶g̶n̶ ̶l̶a̶s̶t̶=̶0̶@̶0̶
</a><a href="#h24-0-21" id="h24-0-21" class="i">+n3@0 follower() ⇨ n3@1 candidate
</a><a href="#h24-0-22" id="h24-0-22" class="i">+n3@1 ⇥ n1 C̶a̶m̶p̶a̶i̶g̶n̶ ̶l̶a̶s̶t̶=̶0̶@̶0̶
</a><a href="#h24-0-23" id="h24-0-23" class="i">+n3@1 ⇥ n2 C̶a̶m̶p̶a̶i̶g̶n̶ ̶l̶a̶s̶t̶=̶0̶@̶0̶
</a><a href="#h24-0-24" id="h24-0-24" class="i">+n2@0 follower() ⇨ n2@1 follower()
</a><a href="#h24-0-25" id="h24-0-25" class="i">+n2@1 → n1 CampaignResponse vote=true
</a><a href="#h24-0-26" id="h24-0-26" class="i">+
</a><a href="#h24-0-27" id="h24-0-27" class="i">+# n1 assumes leadership and heartbeats, committing entry 1.
</a><a href="#h24-0-28" id="h24-0-28" class="i">+(stabilize heartbeat=true)
</a><a href="#h24-0-29" id="h24-0-29" class="i">+status
</a><a href="#h24-0-30" id="h24-0-30" class="i">+---
</a><a href="#h24-0-31" id="h24-0-31" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h24-0-32" id="h24-0-32" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h24-0-33" id="h24-0-33" class="i">+n3@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-34" id="h24-0-34" class="i">+
</a><a href="#h24-0-35" id="h24-0-35" class="i">+# Heal the partition.
</a><a href="#h24-0-36" id="h24-0-36" class="i">+heal
</a><a href="#h24-0-37" id="h24-0-37" class="i">+---
</a><a href="#h24-0-38" id="h24-0-38" class="i">+n1 n2 n3 fully connected
</a><a href="#h24-0-39" id="h24-0-39" class="i">+
</a><a href="#h24-0-40" id="h24-0-40" class="i">+# The next heartbeat from n1 converts n3 to a follower in term 1.
</a><a href="#h24-0-41" id="h24-0-41" class="i">+heartbeat 1
</a><a href="#h24-0-42" id="h24-0-42" class="i">+stabilize
</a><a href="#h24-0-43" id="h24-0-43" class="i">+---
</a><a href="#h24-0-44" id="h24-0-44" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h24-0-45" id="h24-0-45" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h24-0-46" id="h24-0-46" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h24-0-47" id="h24-0-47" class="i">+n3@1 candidate ⇨ n3@1 follower(n1)
</a><a href="#h24-0-48" id="h24-0-48" class="i">+n3@1 → n1 HeartbeatResponse last=0@0 read_seq=0
</a><a href="#h24-0-49" id="h24-0-49" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h24-0-50" id="h24-0-50" class="i">+n3@1 append 1@1 None
</a><a href="#h24-0-51" id="h24-0-51" class="i">+n3@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h24-0-52" id="h24-0-52" class="i">+
</a><a href="#h24-0-53" id="h24-0-53" class="i">+status
</a><a href="#h24-0-54" id="h24-0-54" class="i">+---
</a><a href="#h24-0-55" id="h24-0-55" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h24-0-56" id="h24-0-56" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h24-0-57" id="h24-0-57" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><b>diff --git a/<a id="h25" href="../file/src/raft/testscripts/heartbeat_converts_follower.html">src/raft/testscripts/heartbeat_converts_follower</a> b/<a href="../file/src/raft/testscripts/heartbeat_converts_follower.html">src/raft/testscripts/heartbeat_converts_follower</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -0,0 +1,52 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+# A heartbeat from a leader should convert a follower of a different leader in a
</a><a href="#h25-0-1" id="h25-0-1" class="i">+# past term to a follower.
</a><a href="#h25-0-2" id="h25-0-2" class="i">+
</a><a href="#h25-0-3" id="h25-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h25-0-4" id="h25-0-4" class="i">+---
</a><a href="#h25-0-5" id="h25-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h25-0-6" id="h25-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h25-0-7" id="h25-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h25-0-8" id="h25-0-8" class="i">+
</a><a href="#h25-0-9" id="h25-0-9" class="i">+# Partition n2 away from the cluster.
</a><a href="#h25-0-10" id="h25-0-10" class="i">+partition 2
</a><a href="#h25-0-11" id="h25-0-11" class="i">+---
</a><a href="#h25-0-12" id="h25-0-12" class="i">+n2 ⇹ n1 n3
</a><a href="#h25-0-13" id="h25-0-13" class="i">+
</a><a href="#h25-0-14" id="h25-0-14" class="i">+# Elect n3 as a new leader.
</a><a href="#h25-0-15" id="h25-0-15" class="i">+(campaign 3)
</a><a href="#h25-0-16" id="h25-0-16" class="i">+(stabilize heartbeat=true)
</a><a href="#h25-0-17" id="h25-0-17" class="i">+status
</a><a href="#h25-0-18" id="h25-0-18" class="i">+---
</a><a href="#h25-0-19" id="h25-0-19" class="i">+n1@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h25-0-20" id="h25-0-20" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h25-0-21" id="h25-0-21" class="i">+n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:2→3 2:0→2}
</a><a href="#h25-0-22" id="h25-0-22" class="i">+
</a><a href="#h25-0-23" id="h25-0-23" class="i">+# Heal the partition.
</a><a href="#h25-0-24" id="h25-0-24" class="i">+heal
</a><a href="#h25-0-25" id="h25-0-25" class="i">+---
</a><a href="#h25-0-26" id="h25-0-26" class="i">+n1 n2 n3 fully connected
</a><a href="#h25-0-27" id="h25-0-27" class="i">+
</a><a href="#h25-0-28" id="h25-0-28" class="i">+# The next heartbeat from n3 converts n2 to a follower in term 2.
</a><a href="#h25-0-29" id="h25-0-29" class="i">+heartbeat 3
</a><a href="#h25-0-30" id="h25-0-30" class="i">+stabilize heartbeat=true
</a><a href="#h25-0-31" id="h25-0-31" class="i">+---
</a><a href="#h25-0-32" id="h25-0-32" class="i">+n3@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h25-0-33" id="h25-0-33" class="i">+n3@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h25-0-34" id="h25-0-34" class="i">+n1@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h25-0-35" id="h25-0-35" class="i">+n2@1 follower(n1) ⇨ n2@2 follower(n3)
</a><a href="#h25-0-36" id="h25-0-36" class="i">+n2@2 → n3 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h25-0-37" id="h25-0-37" class="i">+n3@2 → n2 Append base=1@1 [2@2]
</a><a href="#h25-0-38" id="h25-0-38" class="i">+n2@2 append 2@2 None
</a><a href="#h25-0-39" id="h25-0-39" class="i">+n2@2 → n3 AppendResponse last=2@2 reject=false
</a><a href="#h25-0-40" id="h25-0-40" class="i">+n3@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h25-0-41" id="h25-0-41" class="i">+n3@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h25-0-42" id="h25-0-42" class="i">+n1@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h25-0-43" id="h25-0-43" class="i">+n2@2 commit 2@2
</a><a href="#h25-0-44" id="h25-0-44" class="i">+n2@2 apply 2@2 None
</a><a href="#h25-0-45" id="h25-0-45" class="i">+n2@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h25-0-46" id="h25-0-46" class="i">+
</a><a href="#h25-0-47" id="h25-0-47" class="i">+status
</a><a href="#h25-0-48" id="h25-0-48" class="i">+---
</a><a href="#h25-0-49" id="h25-0-49" class="i">+n1@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h25-0-50" id="h25-0-50" class="i">+n2@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h25-0-51" id="h25-0-51" class="i">+n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:2→3 2:2→3}
</a><b>diff --git a/<a id="h26" href="../file/src/raft/testscripts/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/heartbeat_converts_follower_leaderless</a> b/<a href="../file/src/raft/testscripts/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/heartbeat_converts_follower_leaderless</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+# A heartbeat from a leader should convert a leaderless follower.
</a><a href="#h26-0-1" id="h26-0-1" class="i">+
</a><a href="#h26-0-2" id="h26-0-2" class="i">+cluster nodes=3
</a><a href="#h26-0-3" id="h26-0-3" class="i">+---
</a><a href="#h26-0-4" id="h26-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-5" id="h26-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-6" id="h26-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-7" id="h26-0-7" class="i">+
</a><a href="#h26-0-8" id="h26-0-8" class="i">+# Partition n3 away from the cluster.
</a><a href="#h26-0-9" id="h26-0-9" class="i">+partition 3
</a><a href="#h26-0-10" id="h26-0-10" class="i">+---
</a><a href="#h26-0-11" id="h26-0-11" class="i">+n3 ⇹ n1 n2
</a><a href="#h26-0-12" id="h26-0-12" class="i">+
</a><a href="#h26-0-13" id="h26-0-13" class="i">+# Elect n1 as a new leader.
</a><a href="#h26-0-14" id="h26-0-14" class="i">+(campaign 1)
</a><a href="#h26-0-15" id="h26-0-15" class="i">+(stabilize heartbeat=true)
</a><a href="#h26-0-16" id="h26-0-16" class="i">+status
</a><a href="#h26-0-17" id="h26-0-17" class="i">+---
</a><a href="#h26-0-18" id="h26-0-18" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h26-0-19" id="h26-0-19" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h26-0-20" id="h26-0-20" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-21" id="h26-0-21" class="i">+
</a><a href="#h26-0-22" id="h26-0-22" class="i">+# Heal the partition.
</a><a href="#h26-0-23" id="h26-0-23" class="i">+heal
</a><a href="#h26-0-24" id="h26-0-24" class="i">+---
</a><a href="#h26-0-25" id="h26-0-25" class="i">+n1 n2 n3 fully connected
</a><a href="#h26-0-26" id="h26-0-26" class="i">+
</a><a href="#h26-0-27" id="h26-0-27" class="i">+# The next heartbeat from n1 converts n3 to a follower in term 1.
</a><a href="#h26-0-28" id="h26-0-28" class="i">+heartbeat 1
</a><a href="#h26-0-29" id="h26-0-29" class="i">+stabilize
</a><a href="#h26-0-30" id="h26-0-30" class="i">+---
</a><a href="#h26-0-31" id="h26-0-31" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h26-0-32" id="h26-0-32" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h26-0-33" id="h26-0-33" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h26-0-34" id="h26-0-34" class="i">+n3@0 follower() ⇨ n3@1 follower(n1)
</a><a href="#h26-0-35" id="h26-0-35" class="i">+n3@1 → n1 HeartbeatResponse last=0@0 read_seq=0
</a><a href="#h26-0-36" id="h26-0-36" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h26-0-37" id="h26-0-37" class="i">+n3@1 append 1@1 None
</a><a href="#h26-0-38" id="h26-0-38" class="i">+n3@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h26-0-39" id="h26-0-39" class="i">+
</a><a href="#h26-0-40" id="h26-0-40" class="i">+status
</a><a href="#h26-0-41" id="h26-0-41" class="i">+---
</a><a href="#h26-0-42" id="h26-0-42" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h26-0-43" id="h26-0-43" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h26-0-44" id="h26-0-44" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><b>diff --git a/<a id="h27" href="../file/src/raft/testscripts/heartbeat_converts_leader.html">src/raft/testscripts/heartbeat_converts_leader</a> b/<a href="../file/src/raft/testscripts/heartbeat_converts_leader.html">src/raft/testscripts/heartbeat_converts_leader</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,52 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+# A heartbeat from a leader should convert a leader in a past term to a
</a><a href="#h27-0-1" id="h27-0-1" class="i">+# follower.
</a><a href="#h27-0-2" id="h27-0-2" class="i">+
</a><a href="#h27-0-3" id="h27-0-3" class="i">+cluster nodes=3 leader=3
</a><a href="#h27-0-4" id="h27-0-4" class="i">+---
</a><a href="#h27-0-5" id="h27-0-5" class="i">+n1@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h27-0-6" id="h27-0-6" class="i">+n2@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h27-0-7" id="h27-0-7" class="i">+n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
</a><a href="#h27-0-8" id="h27-0-8" class="i">+
</a><a href="#h27-0-9" id="h27-0-9" class="i">+# Partition n3 away from the cluster.
</a><a href="#h27-0-10" id="h27-0-10" class="i">+partition 3
</a><a href="#h27-0-11" id="h27-0-11" class="i">+---
</a><a href="#h27-0-12" id="h27-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h27-0-13" id="h27-0-13" class="i">+
</a><a href="#h27-0-14" id="h27-0-14" class="i">+# Elect n1 as a new leader.
</a><a href="#h27-0-15" id="h27-0-15" class="i">+(campaign 1)
</a><a href="#h27-0-16" id="h27-0-16" class="i">+(stabilize heartbeat=true)
</a><a href="#h27-0-17" id="h27-0-17" class="i">+status
</a><a href="#h27-0-18" id="h27-0-18" class="i">+---
</a><a href="#h27-0-19" id="h27-0-19" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h27-0-20" id="h27-0-20" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h27-0-21" id="h27-0-21" class="i">+n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
</a><a href="#h27-0-22" id="h27-0-22" class="i">+
</a><a href="#h27-0-23" id="h27-0-23" class="i">+# Heal the partition.
</a><a href="#h27-0-24" id="h27-0-24" class="i">+heal
</a><a href="#h27-0-25" id="h27-0-25" class="i">+---
</a><a href="#h27-0-26" id="h27-0-26" class="i">+n1 n2 n3 fully connected
</a><a href="#h27-0-27" id="h27-0-27" class="i">+
</a><a href="#h27-0-28" id="h27-0-28" class="i">+# The next heartbeat from n1 converts n3 to a follower in term 2.
</a><a href="#h27-0-29" id="h27-0-29" class="i">+heartbeat 1
</a><a href="#h27-0-30" id="h27-0-30" class="i">+stabilize heartbeat=true
</a><a href="#h27-0-31" id="h27-0-31" class="i">+---
</a><a href="#h27-0-32" id="h27-0-32" class="i">+n1@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h27-0-33" id="h27-0-33" class="i">+n1@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h27-0-34" id="h27-0-34" class="i">+n2@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h27-0-35" id="h27-0-35" class="i">+n3@1 leader ⇨ n3@2 follower(n1)
</a><a href="#h27-0-36" id="h27-0-36" class="i">+n3@2 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h27-0-37" id="h27-0-37" class="i">+n1@2 → n3 Append base=1@1 [2@2]
</a><a href="#h27-0-38" id="h27-0-38" class="i">+n3@2 append 2@2 None
</a><a href="#h27-0-39" id="h27-0-39" class="i">+n3@2 → n1 AppendResponse last=2@2 reject=false
</a><a href="#h27-0-40" id="h27-0-40" class="i">+n1@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h27-0-41" id="h27-0-41" class="i">+n1@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h27-0-42" id="h27-0-42" class="i">+n2@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h27-0-43" id="h27-0-43" class="i">+n3@2 commit 2@2
</a><a href="#h27-0-44" id="h27-0-44" class="i">+n3@2 apply 2@2 None
</a><a href="#h27-0-45" id="h27-0-45" class="i">+n3@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h27-0-46" id="h27-0-46" class="i">+
</a><a href="#h27-0-47" id="h27-0-47" class="i">+status
</a><a href="#h27-0-48" id="h27-0-48" class="i">+---
</a><a href="#h27-0-49" id="h27-0-49" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h27-0-50" id="h27-0-50" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h27-0-51" id="h27-0-51" class="i">+n3@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><b>diff --git a/<a id="h28" href="../file/src/raft/testscripts/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/heartbeat_multiple_leaders_panic</a> b/<a href="../file/src/raft/testscripts/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/heartbeat_multiple_leaders_panic</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+# A heartbeat will panic if there are multiple leaders in a term.
</a><a href="#h28-0-1" id="h28-0-1" class="i">+
</a><a href="#h28-0-2" id="h28-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h28-0-3" id="h28-0-3" class="i">+---
</a><a href="#h28-0-4" id="h28-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h28-0-5" id="h28-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h28-0-6" id="h28-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h28-0-7" id="h28-0-7" class="i">+
</a><a href="#h28-0-8" id="h28-0-8" class="i">+# Leader panics if it sees another leader in the same term.
</a><a href="#h28-0-9" id="h28-0-9" class="i">+step 1 panic=true &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a><a href="#h28-0-10" id="h28-0-10" class="i">+---
</a><a href="#h28-0-11" id="h28-0-11" class="i">+n1@1 panic: saw other leader 2 in term 1
</a><a href="#h28-0-12" id="h28-0-12" class="i">+
</a><a href="#h28-0-13" id="h28-0-13" class="i">+# Follower panics too.
</a><a href="#h28-0-14" id="h28-0-14" class="i">+step 2 panic=true &#39;{&quot;from&quot;:3, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a><a href="#h28-0-15" id="h28-0-15" class="i">+---
</a><a href="#h28-0-16" id="h28-0-16" class="i">+n2@1 panic: assertion `left == right` failed: multiple leaders in term
</a><a href="#h28-0-17" id="h28-0-17" class="i">+  left: 3
</a><a href="#h28-0-18" id="h28-0-18" class="i">+ right: 1
</a><b>diff --git a/<a id="h29" href="../file/src/raft/testscripts/heartbeat_old_commit_index.html">src/raft/testscripts/heartbeat_old_commit_index</a> b/<a href="../file/src/raft/testscripts/heartbeat_old_commit_index.html">src/raft/testscripts/heartbeat_old_commit_index</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+# A heartbeat with an old commit index is ignored by a follower.
</a><a href="#h29-0-1" id="h29-0-1" class="i">+
</a><a href="#h29-0-2" id="h29-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h29-0-3" id="h29-0-3" class="i">+---
</a><a href="#h29-0-4" id="h29-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h29-0-5" id="h29-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h29-0-6" id="h29-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h29-0-7" id="h29-0-7" class="i">+
</a><a href="#h29-0-8" id="h29-0-8" class="i">+# Replicate a write.
</a><a href="#h29-0-9" id="h29-0-9" class="i">+(put 1 foo=bar)
</a><a href="#h29-0-10" id="h29-0-10" class="i">+(stabilize heartbeat=true)
</a><a href="#h29-0-11" id="h29-0-11" class="i">+status
</a><a href="#h29-0-12" id="h29-0-12" class="i">+---
</a><a href="#h29-0-13" id="h29-0-13" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h29-0-14" id="h29-0-14" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h29-0-15" id="h29-0-15" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h29-0-16" id="h29-0-16" class="i">+
</a><a href="#h29-0-17" id="h29-0-17" class="i">+# Step a heartbeat with an outdated commit index.
</a><a href="#h29-0-18" id="h29-0-18" class="i">+step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
</a><a href="#h29-0-19" id="h29-0-19" class="i">+stabilize
</a><a href="#h29-0-20" id="h29-0-20" class="i">+---
</a><a href="#h29-0-21" id="h29-0-21" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><b>diff --git a/<a id="h30" href="../file/src/raft/testscripts/old_campaign_rejected.html">src/raft/testscripts/old_campaign_rejected</a> b/<a href="../file/src/raft/testscripts/old_campaign_rejected.html">src/raft/testscripts/old_campaign_rejected</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+# Old campaign messages (in the same term) are ignored by leaders and followers
</a><a href="#h30-0-1" id="h30-0-1" class="i">+# once a leader is elected.
</a><a href="#h30-0-2" id="h30-0-2" class="i">+
</a><a href="#h30-0-3" id="h30-0-3" class="i">+cluster nodes=3
</a><a href="#h30-0-4" id="h30-0-4" class="i">+---
</a><a href="#h30-0-5" id="h30-0-5" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h30-0-6" id="h30-0-6" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h30-0-7" id="h30-0-7" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h30-0-8" id="h30-0-8" class="i">+
</a><a href="#h30-0-9" id="h30-0-9" class="i">+# n1 and n2 campaign.
</a><a href="#h30-0-10" id="h30-0-10" class="i">+campaign 1 2
</a><a href="#h30-0-11" id="h30-0-11" class="i">+---
</a><a href="#h30-0-12" id="h30-0-12" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h30-0-13" id="h30-0-13" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h30-0-14" id="h30-0-14" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h30-0-15" id="h30-0-15" class="i">+n2@0 follower() ⇨ n2@1 candidate
</a><a href="#h30-0-16" id="h30-0-16" class="i">+n2@1 → n1 Campaign last=0@0
</a><a href="#h30-0-17" id="h30-0-17" class="i">+n2@1 → n3 Campaign last=0@0
</a><a href="#h30-0-18" id="h30-0-18" class="i">+
</a><a href="#h30-0-19" id="h30-0-19" class="i">+# n3 receives n1&#39;s Campaign message and grants its vote.
</a><a href="#h30-0-20" id="h30-0-20" class="i">+deliver 3 from=1
</a><a href="#h30-0-21" id="h30-0-21" class="i">+---
</a><a href="#h30-0-22" id="h30-0-22" class="i">+n3@0 follower() ⇨ n3@1 follower()
</a><a href="#h30-0-23" id="h30-0-23" class="i">+n3@1 → n1 CampaignResponse vote=true
</a><a href="#h30-0-24" id="h30-0-24" class="i">+
</a><a href="#h30-0-25" id="h30-0-25" class="i">+# n1 becomes leader.
</a><a href="#h30-0-26" id="h30-0-26" class="i">+deliver 1 from=3
</a><a href="#h30-0-27" id="h30-0-27" class="i">+---
</a><a href="#h30-0-28" id="h30-0-28" class="i">+n1@1 candidate ⇨ n1@1 leader
</a><a href="#h30-0-29" id="h30-0-29" class="i">+n1@1 append 1@1 None
</a><a href="#h30-0-30" id="h30-0-30" class="i">+n1@1 → n2 Append base=0@0 [1@1]
</a><a href="#h30-0-31" id="h30-0-31" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h30-0-32" id="h30-0-32" class="i">+n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h30-0-33" id="h30-0-33" class="i">+n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h30-0-34" id="h30-0-34" class="i">+
</a><a href="#h30-0-35" id="h30-0-35" class="i">+# n3 receives n1&#39;s heartbeat and becomes follower.
</a><a href="#h30-0-36" id="h30-0-36" class="i">+deliver 3 from=1
</a><a href="#h30-0-37" id="h30-0-37" class="i">+---
</a><a href="#h30-0-38" id="h30-0-38" class="i">+n3@1 follower() ⇨ n3@1 follower(n1)
</a><a href="#h30-0-39" id="h30-0-39" class="i">+n3@1 append 1@1 None
</a><a href="#h30-0-40" id="h30-0-40" class="i">+n3@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h30-0-41" id="h30-0-41" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h30-0-42" id="h30-0-42" class="i">+
</a><a href="#h30-0-43" id="h30-0-43" class="i">+status
</a><a href="#h30-0-44" id="h30-0-44" class="i">+---
</a><a href="#h30-0-45" id="h30-0-45" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→1 3:0→1}
</a><a href="#h30-0-46" id="h30-0-46" class="i">+n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h30-0-47" id="h30-0-47" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h30-0-48" id="h30-0-48" class="i">+
</a><a href="#h30-0-49" id="h30-0-49" class="i">+# n1 and n3 receive n2&#39;s Campaign message and reject it.
</a><a href="#h30-0-50" id="h30-0-50" class="i">+deliver 1 3 from=2
</a><a href="#h30-0-51" id="h30-0-51" class="i">+---
</a><a href="#h30-0-52" id="h30-0-52" class="i">+n1@1 → n2 CampaignResponse vote=false
</a><a href="#h30-0-53" id="h30-0-53" class="i">+n3@1 → n2 CampaignResponse vote=false
</a><a href="#h30-0-54" id="h30-0-54" class="i">+
</a><a href="#h30-0-55" id="h30-0-55" class="i">+# Stabilizing the cluster results in everyone following n1.
</a><a href="#h30-0-56" id="h30-0-56" class="i">+(stabilize heartbeat=true)
</a><a href="#h30-0-57" id="h30-0-57" class="i">+status
</a><a href="#h30-0-58" id="h30-0-58" class="i">+---
</a><a href="#h30-0-59" id="h30-0-59" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h30-0-60" id="h30-0-60" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h30-0-61" id="h30-0-61" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h31" href="../file/src/raft/testscripts/old_campaign_response_ignored.html">src/raft/testscripts/old_campaign_response_ignored</a> b/<a href="../file/src/raft/testscripts/old_campaign_response_ignored.html">src/raft/testscripts/old_campaign_response_ignored</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,100 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+# Old campaign responses (in the same term) are ignored by leaders and followers
</a><a href="#h31-0-1" id="h31-0-1" class="i">+# once a leader is elected.
</a><a href="#h31-0-2" id="h31-0-2" class="i">+
</a><a href="#h31-0-3" id="h31-0-3" class="i">+cluster nodes=7
</a><a href="#h31-0-4" id="h31-0-4" class="i">+---
</a><a href="#h31-0-5" id="h31-0-5" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-6" id="h31-0-6" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-7" id="h31-0-7" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-8" id="h31-0-8" class="i">+n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-9" id="h31-0-9" class="i">+n5@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-10" id="h31-0-10" class="i">+n6@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-11" id="h31-0-11" class="i">+n7@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-12" id="h31-0-12" class="i">+
</a><a href="#h31-0-13" id="h31-0-13" class="i">+# n1 and n2 campaign.
</a><a href="#h31-0-14" id="h31-0-14" class="i">+campaign 1 2
</a><a href="#h31-0-15" id="h31-0-15" class="i">+---
</a><a href="#h31-0-16" id="h31-0-16" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h31-0-17" id="h31-0-17" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h31-0-18" id="h31-0-18" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h31-0-19" id="h31-0-19" class="i">+n1@1 → n4 Campaign last=0@0
</a><a href="#h31-0-20" id="h31-0-20" class="i">+n1@1 → n5 Campaign last=0@0
</a><a href="#h31-0-21" id="h31-0-21" class="i">+n1@1 → n6 Campaign last=0@0
</a><a href="#h31-0-22" id="h31-0-22" class="i">+n1@1 → n7 Campaign last=0@0
</a><a href="#h31-0-23" id="h31-0-23" class="i">+n2@0 follower() ⇨ n2@1 candidate
</a><a href="#h31-0-24" id="h31-0-24" class="i">+n2@1 → n1 Campaign last=0@0
</a><a href="#h31-0-25" id="h31-0-25" class="i">+n2@1 → n3 Campaign last=0@0
</a><a href="#h31-0-26" id="h31-0-26" class="i">+n2@1 → n4 Campaign last=0@0
</a><a href="#h31-0-27" id="h31-0-27" class="i">+n2@1 → n5 Campaign last=0@0
</a><a href="#h31-0-28" id="h31-0-28" class="i">+n2@1 → n6 Campaign last=0@0
</a><a href="#h31-0-29" id="h31-0-29" class="i">+n2@1 → n7 Campaign last=0@0
</a><a href="#h31-0-30" id="h31-0-30" class="i">+
</a><a href="#h31-0-31" id="h31-0-31" class="i">+# n3-n6 vote for n1, n7 votes for n2.
</a><a href="#h31-0-32" id="h31-0-32" class="i">+deliver 3 4 5 6 from=1
</a><a href="#h31-0-33" id="h31-0-33" class="i">+deliver 7 from=2
</a><a href="#h31-0-34" id="h31-0-34" class="i">+---
</a><a href="#h31-0-35" id="h31-0-35" class="i">+n3@0 follower() ⇨ n3@1 follower()
</a><a href="#h31-0-36" id="h31-0-36" class="i">+n3@1 → n1 CampaignResponse vote=true
</a><a href="#h31-0-37" id="h31-0-37" class="i">+n4@0 follower() ⇨ n4@1 follower()
</a><a href="#h31-0-38" id="h31-0-38" class="i">+n4@1 → n1 CampaignResponse vote=true
</a><a href="#h31-0-39" id="h31-0-39" class="i">+n5@0 follower() ⇨ n5@1 follower()
</a><a href="#h31-0-40" id="h31-0-40" class="i">+n5@1 → n1 CampaignResponse vote=true
</a><a href="#h31-0-41" id="h31-0-41" class="i">+n6@0 follower() ⇨ n6@1 follower()
</a><a href="#h31-0-42" id="h31-0-42" class="i">+n6@1 → n1 CampaignResponse vote=true
</a><a href="#h31-0-43" id="h31-0-43" class="i">+n7@0 follower() ⇨ n7@1 follower()
</a><a href="#h31-0-44" id="h31-0-44" class="i">+n7@1 → n2 CampaignResponse vote=true
</a><a href="#h31-0-45" id="h31-0-45" class="i">+
</a><a href="#h31-0-46" id="h31-0-46" class="i">+# n1 receives votes from n3-n5 and assumes leadership.
</a><a href="#h31-0-47" id="h31-0-47" class="i">+deliver 1 from=3
</a><a href="#h31-0-48" id="h31-0-48" class="i">+deliver 1 from=4
</a><a href="#h31-0-49" id="h31-0-49" class="i">+deliver 1 from=5
</a><a href="#h31-0-50" id="h31-0-50" class="i">+---
</a><a href="#h31-0-51" id="h31-0-51" class="i">+n1@1 candidate ⇨ n1@1 leader
</a><a href="#h31-0-52" id="h31-0-52" class="i">+n1@1 append 1@1 None
</a><a href="#h31-0-53" id="h31-0-53" class="i">+n1@1 → n2 Append base=0@0 [1@1]
</a><a href="#h31-0-54" id="h31-0-54" class="i">+n1@1 → n3 Append base=0@0 [1@1]
</a><a href="#h31-0-55" id="h31-0-55" class="i">+n1@1 → n4 Append base=0@0 [1@1]
</a><a href="#h31-0-56" id="h31-0-56" class="i">+n1@1 → n5 Append base=0@0 [1@1]
</a><a href="#h31-0-57" id="h31-0-57" class="i">+n1@1 → n6 Append base=0@0 [1@1]
</a><a href="#h31-0-58" id="h31-0-58" class="i">+n1@1 → n7 Append base=0@0 [1@1]
</a><a href="#h31-0-59" id="h31-0-59" class="i">+n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-60" id="h31-0-60" class="i">+n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-61" id="h31-0-61" class="i">+n1@1 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-62" id="h31-0-62" class="i">+n1@1 → n5 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-63" id="h31-0-63" class="i">+n1@1 → n6 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-64" id="h31-0-64" class="i">+n1@1 → n7 Heartbeat commit=0@0 read_seq=0
</a><a href="#h31-0-65" id="h31-0-65" class="i">+
</a><a href="#h31-0-66" id="h31-0-66" class="i">+# n2 receives n1&#39;s heartbeats and becomes follower.
</a><a href="#h31-0-67" id="h31-0-67" class="i">+deliver 2 from=1
</a><a href="#h31-0-68" id="h31-0-68" class="i">+---
</a><a href="#h31-0-69" id="h31-0-69" class="i">+n2@1 → n1 CampaignResponse vote=false
</a><a href="#h31-0-70" id="h31-0-70" class="i">+n2@1 candidate ⇨ n2@1 follower(n1)
</a><a href="#h31-0-71" id="h31-0-71" class="i">+n2@1 append 1@1 None
</a><a href="#h31-0-72" id="h31-0-72" class="i">+n2@1 → n1 AppendResponse last=1@1 reject=false
</a><a href="#h31-0-73" id="h31-0-73" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h31-0-74" id="h31-0-74" class="i">+
</a><a href="#h31-0-75" id="h31-0-75" class="i">+# n1 (leader) receives n6&#39;s vote and ignores it. n2 (follower) receives n7&#39;s
</a><a href="#h31-0-76" id="h31-0-76" class="i">+# vote and ignores it. They remain leader and follower.
</a><a href="#h31-0-77" id="h31-0-77" class="i">+deliver 1 from=6
</a><a href="#h31-0-78" id="h31-0-78" class="i">+deliver 2 from=7
</a><a href="#h31-0-79" id="h31-0-79" class="i">+status
</a><a href="#h31-0-80" id="h31-0-80" class="i">+---
</a><a href="#h31-0-81" id="h31-0-81" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→1 3:0→1 4:0→1 5:0→1 6:0→1 7:0→1}
</a><a href="#h31-0-82" id="h31-0-82" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h31-0-83" id="h31-0-83" class="i">+n3@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-84" id="h31-0-84" class="i">+n4@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-85" id="h31-0-85" class="i">+n5@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-86" id="h31-0-86" class="i">+n6@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-87" id="h31-0-87" class="i">+n7@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h31-0-88" id="h31-0-88" class="i">+
</a><a href="#h31-0-89" id="h31-0-89" class="i">+# Stabilizing the cluster results in everyone following n1.
</a><a href="#h31-0-90" id="h31-0-90" class="i">+(stabilize heartbeat=true)
</a><a href="#h31-0-91" id="h31-0-91" class="i">+status
</a><a href="#h31-0-92" id="h31-0-92" class="i">+---
</a><a href="#h31-0-93" id="h31-0-93" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2 6:1→2 7:1→2}
</a><a href="#h31-0-94" id="h31-0-94" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-95" id="h31-0-95" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-96" id="h31-0-96" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-97" id="h31-0-97" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-98" id="h31-0-98" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-99" id="h31-0-99" class="i">+n7@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h32" href="../file/src/raft/testscripts/old_heartbeat_ignored.html">src/raft/testscripts/old_heartbeat_ignored</a> b/<a href="../file/src/raft/testscripts/old_heartbeat_ignored.html">src/raft/testscripts/old_heartbeat_ignored</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+# A heartbeat from an old leader should be ignored.
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+# Make n3 leader.
</a><a href="#h32-0-3" id="h32-0-3" class="i">+cluster nodes=3 leader=3
</a><a href="#h32-0-4" id="h32-0-4" class="i">+---
</a><a href="#h32-0-5" id="h32-0-5" class="i">+n1@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-6" id="h32-0-6" class="i">+n2@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-7" id="h32-0-7" class="i">+n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
</a><a href="#h32-0-8" id="h32-0-8" class="i">+
</a><a href="#h32-0-9" id="h32-0-9" class="i">+# Partition n3 away from the cluster.
</a><a href="#h32-0-10" id="h32-0-10" class="i">+partition 3
</a><a href="#h32-0-11" id="h32-0-11" class="i">+---
</a><a href="#h32-0-12" id="h32-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h32-0-13" id="h32-0-13" class="i">+
</a><a href="#h32-0-14" id="h32-0-14" class="i">+# Elect n1 as a new leader.
</a><a href="#h32-0-15" id="h32-0-15" class="i">+(campaign 1)
</a><a href="#h32-0-16" id="h32-0-16" class="i">+(stabilize heartbeat=true)
</a><a href="#h32-0-17" id="h32-0-17" class="i">+status
</a><a href="#h32-0-18" id="h32-0-18" class="i">+---
</a><a href="#h32-0-19" id="h32-0-19" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h32-0-20" id="h32-0-20" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h32-0-21" id="h32-0-21" class="i">+n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
</a><a href="#h32-0-22" id="h32-0-22" class="i">+
</a><a href="#h32-0-23" id="h32-0-23" class="i">+# Heal the partition.
</a><a href="#h32-0-24" id="h32-0-24" class="i">+heal
</a><a href="#h32-0-25" id="h32-0-25" class="i">+---
</a><a href="#h32-0-26" id="h32-0-26" class="i">+n1 n2 n3 fully connected
</a><a href="#h32-0-27" id="h32-0-27" class="i">+
</a><a href="#h32-0-28" id="h32-0-28" class="i">+# The next heartbeat from n3 is ignored.
</a><a href="#h32-0-29" id="h32-0-29" class="i">+heartbeat 3
</a><a href="#h32-0-30" id="h32-0-30" class="i">+stabilize
</a><a href="#h32-0-31" id="h32-0-31" class="i">+---
</a><a href="#h32-0-32" id="h32-0-32" class="i">+n3@1 → n1 Heartbeat commit=1@1 read_seq=0
</a><a href="#h32-0-33" id="h32-0-33" class="i">+n3@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h32-0-34" id="h32-0-34" class="i">+
</a><a href="#h32-0-35" id="h32-0-35" class="i">+status
</a><a href="#h32-0-36" id="h32-0-36" class="i">+---
</a><a href="#h32-0-37" id="h32-0-37" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h32-0-38" id="h32-0-38" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h32-0-39" id="h32-0-39" class="i">+n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
</a><b>diff --git a/<a id="h33" href="../file/src/raft/testscripts/request_candidate_abort.html">src/raft/testscripts/request_candidate_abort</a> b/<a href="../file/src/raft/testscripts/request_candidate_abort.html">src/raft/testscripts/request_candidate_abort</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,28 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+# Client read/write requests fail on candidates.
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+cluster nodes=3
</a><a href="#h33-0-3" id="h33-0-3" class="i">+---
</a><a href="#h33-0-4" id="h33-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h33-0-5" id="h33-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h33-0-6" id="h33-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h33-0-7" id="h33-0-7" class="i">+
</a><a href="#h33-0-8" id="h33-0-8" class="i">+# n1 campaigns.
</a><a href="#h33-0-9" id="h33-0-9" class="i">+campaign 1
</a><a href="#h33-0-10" id="h33-0-10" class="i">+---
</a><a href="#h33-0-11" id="h33-0-11" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h33-0-12" id="h33-0-12" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h33-0-13" id="h33-0-13" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h33-0-14" id="h33-0-14" class="i">+
</a><a href="#h33-0-15" id="h33-0-15" class="i">+# A read request on n1 should be rejected.
</a><a href="#h33-0-16" id="h33-0-16" class="i">+get 1 foo
</a><a href="#h33-0-17" id="h33-0-17" class="i">+---
</a><a href="#h33-0-18" id="h33-0-18" class="i">+c1@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h33-0-19" id="h33-0-19" class="i">+n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h33-0-20" id="h33-0-20" class="i">+c1@1 get foo ⇒ Error::Abort (Operation aborted)
</a><a href="#h33-0-21" id="h33-0-21" class="i">+
</a><a href="#h33-0-22" id="h33-0-22" class="i">+# A write request on n1 should be rejected.
</a><a href="#h33-0-23" id="h33-0-23" class="i">+put 1 foo=bar
</a><a href="#h33-0-24" id="h33-0-24" class="i">+---
</a><a href="#h33-0-25" id="h33-0-25" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h33-0-26" id="h33-0-26" class="i">+n1@1 → c1 ClientResponse id=0x02 Error::Abort
</a><a href="#h33-0-27" id="h33-0-27" class="i">+c1@1 put foo=bar ⇒ Error::Abort (Operation aborted)
</a><b>diff --git a/<a id="h34" href="../file/src/raft/testscripts/request_follower.html">src/raft/testscripts/request_follower</a> b/<a href="../file/src/raft/testscripts/request_follower.html">src/raft/testscripts/request_follower</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,55 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+# Client read/write requests are proxied by followers.
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h34-0-3" id="h34-0-3" class="i">+---
</a><a href="#h34-0-4" id="h34-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h34-0-5" id="h34-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-6" id="h34-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-7" id="h34-0-7" class="i">+
</a><a href="#h34-0-8" id="h34-0-8" class="i">+# An initial get on a follower yields None.
</a><a href="#h34-0-9" id="h34-0-9" class="i">+get 2 foo
</a><a href="#h34-0-10" id="h34-0-10" class="i">+stabilize
</a><a href="#h34-0-11" id="h34-0-11" class="i">+---
</a><a href="#h34-0-12" id="h34-0-12" class="i">+c2@1 → n2 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h34-0-13" id="h34-0-13" class="i">+n2@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h34-0-14" id="h34-0-14" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h34-0-15" id="h34-0-15" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h34-0-16" id="h34-0-16" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h34-0-17" id="h34-0-17" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h34-0-18" id="h34-0-18" class="i">+n1@1 → n2 ClientResponse id=0x01 read 0x0000
</a><a href="#h34-0-19" id="h34-0-19" class="i">+n2@1 → c2 ClientResponse id=0x01 read 0x0000
</a><a href="#h34-0-20" id="h34-0-20" class="i">+c2@1 get foo ⇒ None
</a><a href="#h34-0-21" id="h34-0-21" class="i">+
</a><a href="#h34-0-22" id="h34-0-22" class="i">+# Write a value on the follower.
</a><a href="#h34-0-23" id="h34-0-23" class="i">+put 2 foo=bar
</a><a href="#h34-0-24" id="h34-0-24" class="i">+stabilize
</a><a href="#h34-0-25" id="h34-0-25" class="i">+(stabilize heartbeat=true)
</a><a href="#h34-0-26" id="h34-0-26" class="i">+---
</a><a href="#h34-0-27" id="h34-0-27" class="i">+c2@1 → n2 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h34-0-28" id="h34-0-28" class="i">+n2@1 → n1 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h34-0-29" id="h34-0-29" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h34-0-30" id="h34-0-30" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h34-0-31" id="h34-0-31" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h34-0-32" id="h34-0-32" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h34-0-33" id="h34-0-33" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h34-0-34" id="h34-0-34" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h34-0-35" id="h34-0-35" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h34-0-36" id="h34-0-36" class="i">+n1@1 commit 2@1
</a><a href="#h34-0-37" id="h34-0-37" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h34-0-38" id="h34-0-38" class="i">+n1@1 → n2 ClientResponse id=0x02 write 0x0102
</a><a href="#h34-0-39" id="h34-0-39" class="i">+n2@1 → c2 ClientResponse id=0x02 write 0x0102
</a><a href="#h34-0-40" id="h34-0-40" class="i">+c2@1 put foo=bar ⇒ 2
</a><a href="#h34-0-41" id="h34-0-41" class="i">+
</a><a href="#h34-0-42" id="h34-0-42" class="i">+# Read the value back on the follower.
</a><a href="#h34-0-43" id="h34-0-43" class="i">+get 2 foo
</a><a href="#h34-0-44" id="h34-0-44" class="i">+stabilize
</a><a href="#h34-0-45" id="h34-0-45" class="i">+---
</a><a href="#h34-0-46" id="h34-0-46" class="i">+c2@1 → n2 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h34-0-47" id="h34-0-47" class="i">+n2@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h34-0-48" id="h34-0-48" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h34-0-49" id="h34-0-49" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h34-0-50" id="h34-0-50" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h34-0-51" id="h34-0-51" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h34-0-52" id="h34-0-52" class="i">+n1@1 → n2 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h34-0-53" id="h34-0-53" class="i">+n2@1 → c2 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h34-0-54" id="h34-0-54" class="i">+c2@1 get foo ⇒ bar
</a><b>diff --git a/<a id="h35" href="../file/src/raft/testscripts/request_follower_campaign_abort.html">src/raft/testscripts/request_follower_campaign_abort</a> b/<a href="../file/src/raft/testscripts/request_follower_campaign_abort.html">src/raft/testscripts/request_follower_campaign_abort</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+# A follower aborts in-flight requests when it steps down.
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h35-0-3" id="h35-0-3" class="i">+---
</a><a href="#h35-0-4" id="h35-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h35-0-5" id="h35-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h35-0-6" id="h35-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h35-0-7" id="h35-0-7" class="i">+
</a><a href="#h35-0-8" id="h35-0-8" class="i">+# Submit a read and write on n2.
</a><a href="#h35-0-9" id="h35-0-9" class="i">+put 2 foo=bar
</a><a href="#h35-0-10" id="h35-0-10" class="i">+get 2 foo
</a><a href="#h35-0-11" id="h35-0-11" class="i">+---
</a><a href="#h35-0-12" id="h35-0-12" class="i">+c2@1 → n2 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h35-0-13" id="h35-0-13" class="i">+n2@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h35-0-14" id="h35-0-14" class="i">+c2@1 → n2 ClientRequest id=0x02 read 0x0003666f6f
</a><a href="#h35-0-15" id="h35-0-15" class="i">+n2@1 → n1 ClientRequest id=0x02 read 0x0003666f6f
</a><a href="#h35-0-16" id="h35-0-16" class="i">+
</a><a href="#h35-0-17" id="h35-0-17" class="i">+# n3 campaigns before n2&#39;s requests achieve quorum.
</a><a href="#h35-0-18" id="h35-0-18" class="i">+campaign 3
</a><a href="#h35-0-19" id="h35-0-19" class="i">+---
</a><a href="#h35-0-20" id="h35-0-20" class="i">+n3@1 follower(n1) ⇨ n3@2 candidate
</a><a href="#h35-0-21" id="h35-0-21" class="i">+n3@2 → n1 Campaign last=1@1
</a><a href="#h35-0-22" id="h35-0-22" class="i">+n3@2 → n2 Campaign last=1@1
</a><a href="#h35-0-23" id="h35-0-23" class="i">+
</a><a href="#h35-0-24" id="h35-0-24" class="i">+# When n2 receives the campaign message, the requests are aborted.
</a><a href="#h35-0-25" id="h35-0-25" class="i">+deliver 2 from=3
</a><a href="#h35-0-26" id="h35-0-26" class="i">+---
</a><a href="#h35-0-27" id="h35-0-27" class="i">+n2@1 follower(n1) ⇨ n2@2 follower()
</a><a href="#h35-0-28" id="h35-0-28" class="i">+n2@1 → c2 ClientResponse id=0x01 Error::Abort
</a><a href="#h35-0-29" id="h35-0-29" class="i">+c2@1 put foo=bar ⇒ Error::Abort (Operation aborted)
</a><a href="#h35-0-30" id="h35-0-30" class="i">+n2@1 → c2 ClientResponse id=0x02 Error::Abort
</a><a href="#h35-0-31" id="h35-0-31" class="i">+c2@1 get foo ⇒ Error::Abort (Operation aborted)
</a><a href="#h35-0-32" id="h35-0-32" class="i">+n2@2 → n3 CampaignResponse vote=true
</a><b>diff --git a/<a id="h36" href="../file/src/raft/testscripts/request_follower_disconnect_stall.html">src/raft/testscripts/request_follower_disconnect_stall</a> b/<a href="../file/src/raft/testscripts/request_follower_disconnect_stall.html">src/raft/testscripts/request_follower_disconnect_stall</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,35 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+# Client read/write requests stall if the follower is disconnected from the
</a><a href="#h36-0-1" id="h36-0-1" class="i">+# leader when the request is submitted. They are not retried, nor aborted.
</a><a href="#h36-0-2" id="h36-0-2" class="i">+
</a><a href="#h36-0-3" id="h36-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h36-0-4" id="h36-0-4" class="i">+---
</a><a href="#h36-0-5" id="h36-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h36-0-6" id="h36-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h36-0-7" id="h36-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h36-0-8" id="h36-0-8" class="i">+
</a><a href="#h36-0-9" id="h36-0-9" class="i">+# Partition n3 away from the cluster.
</a><a href="#h36-0-10" id="h36-0-10" class="i">+partition 3
</a><a href="#h36-0-11" id="h36-0-11" class="i">+---
</a><a href="#h36-0-12" id="h36-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h36-0-13" id="h36-0-13" class="i">+
</a><a href="#h36-0-14" id="h36-0-14" class="i">+# Submit write and read requests to n3. They don&#39;t return a result.
</a><a href="#h36-0-15" id="h36-0-15" class="i">+put 3 foo=bar
</a><a href="#h36-0-16" id="h36-0-16" class="i">+get 3 foo
</a><a href="#h36-0-17" id="h36-0-17" class="i">+stabilize
</a><a href="#h36-0-18" id="h36-0-18" class="i">+---
</a><a href="#h36-0-19" id="h36-0-19" class="i">+c3@1 → n3 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h36-0-20" id="h36-0-20" class="i">+n3@1 ⇥ n1 C̶l̶i̶e̶n̶t̶R̶e̶q̶u̶e̶s̶t̶ ̶i̶d̶=̶0̶x̶0̶1̶ ̶w̶r̶i̶t̶e̶ ̶0̶x̶0̶1̶0̶3̶6̶6̶6̶f̶6̶f̶0̶3̶6̶2̶6̶1̶7̶2̶
</a><a href="#h36-0-21" id="h36-0-21" class="i">+c3@1 → n3 ClientRequest id=0x02 read 0x0003666f6f
</a><a href="#h36-0-22" id="h36-0-22" class="i">+n3@1 ⇥ n1 C̶l̶i̶e̶n̶t̶R̶e̶q̶u̶e̶s̶t̶ ̶i̶d̶=̶0̶x̶0̶2̶ ̶r̶e̶a̶d̶ ̶0̶x̶0̶0̶0̶3̶6̶6̶6̶f̶6̶f̶
</a><a href="#h36-0-23" id="h36-0-23" class="i">+
</a><a href="#h36-0-24" id="h36-0-24" class="i">+# Heal the partition and heartbeat. The requests still don&#39;t return a result.
</a><a href="#h36-0-25" id="h36-0-25" class="i">+heal
</a><a href="#h36-0-26" id="h36-0-26" class="i">+---
</a><a href="#h36-0-27" id="h36-0-27" class="i">+n1 n2 n3 fully connected
</a><a href="#h36-0-28" id="h36-0-28" class="i">+
</a><a href="#h36-0-29" id="h36-0-29" class="i">+stabilize heartbeat=true
</a><a href="#h36-0-30" id="h36-0-30" class="i">+---
</a><a href="#h36-0-31" id="h36-0-31" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h36-0-32" id="h36-0-32" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h36-0-33" id="h36-0-33" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h36-0-34" id="h36-0-34" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><b>diff --git a/<a id="h37" href="../file/src/raft/testscripts/request_follower_leaderless_abort.html">src/raft/testscripts/request_follower_leaderless_abort</a> b/<a href="../file/src/raft/testscripts/request_follower_leaderless_abort.html">src/raft/testscripts/request_follower_leaderless_abort</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+# Client read/write requests fail on leaderless followers.
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+cluster nodes=3
</a><a href="#h37-0-3" id="h37-0-3" class="i">+---
</a><a href="#h37-0-4" id="h37-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h37-0-5" id="h37-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h37-0-6" id="h37-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h37-0-7" id="h37-0-7" class="i">+
</a><a href="#h37-0-8" id="h37-0-8" class="i">+# A read request on n1 should be rejected.
</a><a href="#h37-0-9" id="h37-0-9" class="i">+get 1 foo
</a><a href="#h37-0-10" id="h37-0-10" class="i">+---
</a><a href="#h37-0-11" id="h37-0-11" class="i">+c1@0 → n1 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h37-0-12" id="h37-0-12" class="i">+n1@0 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h37-0-13" id="h37-0-13" class="i">+c1@0 get foo ⇒ Error::Abort (Operation aborted)
</a><a href="#h37-0-14" id="h37-0-14" class="i">+
</a><a href="#h37-0-15" id="h37-0-15" class="i">+# A write request on n1 should be rejected.
</a><a href="#h37-0-16" id="h37-0-16" class="i">+put 1 foo=bar
</a><a href="#h37-0-17" id="h37-0-17" class="i">+---
</a><a href="#h37-0-18" id="h37-0-18" class="i">+c1@0 → n1 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h37-0-19" id="h37-0-19" class="i">+n1@0 → c1 ClientResponse id=0x02 Error::Abort
</a><a href="#h37-0-20" id="h37-0-20" class="i">+c1@0 put foo=bar ⇒ Error::Abort (Operation aborted)
</a><b>diff --git a/<a id="h38" href="../file/src/raft/testscripts/request_leader.html">src/raft/testscripts/request_leader</a> b/<a href="../file/src/raft/testscripts/request_leader.html">src/raft/testscripts/request_leader</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,49 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+# Client read/write requests succeed on leaders.
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h38-0-3" id="h38-0-3" class="i">+---
</a><a href="#h38-0-4" id="h38-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h38-0-5" id="h38-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-0-6" id="h38-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-0-7" id="h38-0-7" class="i">+
</a><a href="#h38-0-8" id="h38-0-8" class="i">+# An initial get on the leader yields None.
</a><a href="#h38-0-9" id="h38-0-9" class="i">+get 1 foo
</a><a href="#h38-0-10" id="h38-0-10" class="i">+stabilize
</a><a href="#h38-0-11" id="h38-0-11" class="i">+---
</a><a href="#h38-0-12" id="h38-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h38-0-13" id="h38-0-13" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h38-0-14" id="h38-0-14" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h38-0-15" id="h38-0-15" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h38-0-16" id="h38-0-16" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h38-0-17" id="h38-0-17" class="i">+n1@1 → c1 ClientResponse id=0x01 read 0x0000
</a><a href="#h38-0-18" id="h38-0-18" class="i">+c1@1 get foo ⇒ None
</a><a href="#h38-0-19" id="h38-0-19" class="i">+
</a><a href="#h38-0-20" id="h38-0-20" class="i">+# Write a value on the leader.
</a><a href="#h38-0-21" id="h38-0-21" class="i">+put 1 foo=bar
</a><a href="#h38-0-22" id="h38-0-22" class="i">+stabilize
</a><a href="#h38-0-23" id="h38-0-23" class="i">+(stabilize heartbeat=true)
</a><a href="#h38-0-24" id="h38-0-24" class="i">+---
</a><a href="#h38-0-25" id="h38-0-25" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h38-0-26" id="h38-0-26" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h38-0-27" id="h38-0-27" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h38-0-28" id="h38-0-28" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h38-0-29" id="h38-0-29" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h38-0-30" id="h38-0-30" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h38-0-31" id="h38-0-31" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h38-0-32" id="h38-0-32" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h38-0-33" id="h38-0-33" class="i">+n1@1 commit 2@1
</a><a href="#h38-0-34" id="h38-0-34" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h38-0-35" id="h38-0-35" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0102
</a><a href="#h38-0-36" id="h38-0-36" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h38-0-37" id="h38-0-37" class="i">+
</a><a href="#h38-0-38" id="h38-0-38" class="i">+# Read the value back on the leader.
</a><a href="#h38-0-39" id="h38-0-39" class="i">+get 1 foo
</a><a href="#h38-0-40" id="h38-0-40" class="i">+stabilize
</a><a href="#h38-0-41" id="h38-0-41" class="i">+---
</a><a href="#h38-0-42" id="h38-0-42" class="i">+c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h38-0-43" id="h38-0-43" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h38-0-44" id="h38-0-44" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h38-0-45" id="h38-0-45" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h38-0-46" id="h38-0-46" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h38-0-47" id="h38-0-47" class="i">+n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h38-0-48" id="h38-0-48" class="i">+c1@1 get foo ⇒ bar
</a><b>diff --git a/<a id="h39" href="../file/src/raft/testscripts/request_leader_campaign_abort.html">src/raft/testscripts/request_leader_campaign_abort</a> b/<a href="../file/src/raft/testscripts/request_leader_campaign_abort.html">src/raft/testscripts/request_leader_campaign_abort</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,36 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+# A leader aborts in-flight requests when it steps down.
</a><a href="#h39-0-1" id="h39-0-1" class="i">+
</a><a href="#h39-0-2" id="h39-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h39-0-3" id="h39-0-3" class="i">+---
</a><a href="#h39-0-4" id="h39-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h39-0-5" id="h39-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-0-6" id="h39-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-0-7" id="h39-0-7" class="i">+
</a><a href="#h39-0-8" id="h39-0-8" class="i">+# Submit a read and write on n1.
</a><a href="#h39-0-9" id="h39-0-9" class="i">+put 1 foo=bar
</a><a href="#h39-0-10" id="h39-0-10" class="i">+get 1 foo
</a><a href="#h39-0-11" id="h39-0-11" class="i">+---
</a><a href="#h39-0-12" id="h39-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h39-0-13" id="h39-0-13" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h39-0-14" id="h39-0-14" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h39-0-15" id="h39-0-15" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h39-0-16" id="h39-0-16" class="i">+c1@1 → n1 ClientRequest id=0x02 read 0x0003666f6f
</a><a href="#h39-0-17" id="h39-0-17" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h39-0-18" id="h39-0-18" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h39-0-19" id="h39-0-19" class="i">+
</a><a href="#h39-0-20" id="h39-0-20" class="i">+# n2 campaigns before n1&#39;s requests achieve quorum.
</a><a href="#h39-0-21" id="h39-0-21" class="i">+campaign 2
</a><a href="#h39-0-22" id="h39-0-22" class="i">+---
</a><a href="#h39-0-23" id="h39-0-23" class="i">+n2@1 follower(n1) ⇨ n2@2 candidate
</a><a href="#h39-0-24" id="h39-0-24" class="i">+n2@2 → n1 Campaign last=1@1
</a><a href="#h39-0-25" id="h39-0-25" class="i">+n2@2 → n3 Campaign last=1@1
</a><a href="#h39-0-26" id="h39-0-26" class="i">+
</a><a href="#h39-0-27" id="h39-0-27" class="i">+# When n1 receives the campaign message, the requests are aborted.
</a><a href="#h39-0-28" id="h39-0-28" class="i">+deliver 1 from=2
</a><a href="#h39-0-29" id="h39-0-29" class="i">+---
</a><a href="#h39-0-30" id="h39-0-30" class="i">+n1@1 leader ⇨ n1@2 follower()
</a><a href="#h39-0-31" id="h39-0-31" class="i">+n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h39-0-32" id="h39-0-32" class="i">+c1@1 put foo=bar ⇒ Error::Abort (Operation aborted)
</a><a href="#h39-0-33" id="h39-0-33" class="i">+n1@1 → c1 ClientResponse id=0x02 Error::Abort
</a><a href="#h39-0-34" id="h39-0-34" class="i">+c1@1 get foo ⇒ Error::Abort (Operation aborted)
</a><a href="#h39-0-35" id="h39-0-35" class="i">+n1@2 → n2 CampaignResponse vote=false
</a><b>diff --git a/<a id="h40" href="../file/src/raft/testscripts/request_leader_change_linearizability.html">src/raft/testscripts/request_leader_change_linearizability</a> b/<a href="../file/src/raft/testscripts/request_leader_change_linearizability.html">src/raft/testscripts/request_leader_change_linearizability</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,84 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+# A new leader that&#39;s behind on commit/apply shouldn&#39;t serve stale reads.
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h40-0-3" id="h40-0-3" class="i">+---
</a><a href="#h40-0-4" id="h40-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h40-0-5" id="h40-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h40-0-6" id="h40-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h40-0-7" id="h40-0-7" class="i">+
</a><a href="#h40-0-8" id="h40-0-8" class="i">+# Write an initial value, and propagate the commit index.
</a><a href="#h40-0-9" id="h40-0-9" class="i">+(put 1 a=1)
</a><a href="#h40-0-10" id="h40-0-10" class="i">+(stabilize heartbeat=true)
</a><a href="#h40-0-11" id="h40-0-11" class="i">+status
</a><a href="#h40-0-12" id="h40-0-12" class="i">+---
</a><a href="#h40-0-13" id="h40-0-13" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h40-0-14" id="h40-0-14" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h40-0-15" id="h40-0-15" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h40-0-16" id="h40-0-16" class="i">+
</a><a href="#h40-0-17" id="h40-0-17" class="i">+# Write another value, but don&#39;t propagate the commit index.
</a><a href="#h40-0-18" id="h40-0-18" class="i">+(put 1 b=2)
</a><a href="#h40-0-19" id="h40-0-19" class="i">+(stabilize)
</a><a href="#h40-0-20" id="h40-0-20" class="i">+status
</a><a href="#h40-0-21" id="h40-0-21" class="i">+---
</a><a href="#h40-0-22" id="h40-0-22" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4}
</a><a href="#h40-0-23" id="h40-0-23" class="i">+n2@1 follower(n1) last=3@1 commit=2@1 apply=2
</a><a href="#h40-0-24" id="h40-0-24" class="i">+n3@1 follower(n1) last=3@1 commit=2@1 apply=2
</a><a href="#h40-0-25" id="h40-0-25" class="i">+
</a><a href="#h40-0-26" id="h40-0-26" class="i">+# n2 campaigns and wins.
</a><a href="#h40-0-27" id="h40-0-27" class="i">+campaign 2
</a><a href="#h40-0-28" id="h40-0-28" class="i">+deliver
</a><a href="#h40-0-29" id="h40-0-29" class="i">+---
</a><a href="#h40-0-30" id="h40-0-30" class="i">+n2@1 follower(n1) ⇨ n2@2 candidate
</a><a href="#h40-0-31" id="h40-0-31" class="i">+n2@2 → n1 Campaign last=3@1
</a><a href="#h40-0-32" id="h40-0-32" class="i">+n2@2 → n3 Campaign last=3@1
</a><a href="#h40-0-33" id="h40-0-33" class="i">+n1@1 leader ⇨ n1@2 follower()
</a><a href="#h40-0-34" id="h40-0-34" class="i">+n1@2 → n2 CampaignResponse vote=true
</a><a href="#h40-0-35" id="h40-0-35" class="i">+n3@1 follower(n1) ⇨ n3@2 follower()
</a><a href="#h40-0-36" id="h40-0-36" class="i">+n3@2 → n2 CampaignResponse vote=true
</a><a href="#h40-0-37" id="h40-0-37" class="i">+
</a><a href="#h40-0-38" id="h40-0-38" class="i">+# However, the initial append/heartbeat messages don&#39;t make it to the followers,
</a><a href="#h40-0-39" id="h40-0-39" class="i">+# so its commit index trails the previous leader.
</a><a href="#h40-0-40" id="h40-0-40" class="i">+partition 2
</a><a href="#h40-0-41" id="h40-0-41" class="i">+deliver 2
</a><a href="#h40-0-42" id="h40-0-42" class="i">+---
</a><a href="#h40-0-43" id="h40-0-43" class="i">+n2 ⇹ n1 n3
</a><a href="#h40-0-44" id="h40-0-44" class="i">+n2@2 candidate ⇨ n2@2 leader
</a><a href="#h40-0-45" id="h40-0-45" class="i">+n2@2 append 4@2 None
</a><a href="#h40-0-46" id="h40-0-46" class="i">+n2@2 ⇥ n1 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶2̶]̶
</a><a href="#h40-0-47" id="h40-0-47" class="i">+n2@2 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶2̶]̶
</a><a href="#h40-0-48" id="h40-0-48" class="i">+n2@2 ⇥ n1 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h40-0-49" id="h40-0-49" class="i">+n2@2 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h40-0-50" id="h40-0-50" class="i">+
</a><a href="#h40-0-51" id="h40-0-51" class="i">+heal
</a><a href="#h40-0-52" id="h40-0-52" class="i">+status
</a><a href="#h40-0-53" id="h40-0-53" class="i">+---
</a><a href="#h40-0-54" id="h40-0-54" class="i">+n1 n2 n3 fully connected
</a><a href="#h40-0-55" id="h40-0-55" class="i">+n1@2 follower() last=3@1 commit=3@1 apply=3
</a><a href="#h40-0-56" id="h40-0-56" class="i">+n2@2 leader last=4@2 commit=2@1 apply=2 progress={1:0→4 3:0→4}
</a><a href="#h40-0-57" id="h40-0-57" class="i">+n3@2 follower() last=3@1 commit=2@1 apply=2
</a><a href="#h40-0-58" id="h40-0-58" class="i">+
</a><a href="#h40-0-59" id="h40-0-59" class="i">+# Reading from n2 should not result in a stale read.
</a><a href="#h40-0-60" id="h40-0-60" class="i">+#
</a><a href="#h40-0-61" id="h40-0-61" class="i">+# TODO: this currently results in a stale read, since n2 does not commit and
</a><a href="#h40-0-62" id="h40-0-62" class="i">+# apply in response to heartbeat messages.
</a><a href="#h40-0-63" id="h40-0-63" class="i">+get 2 b
</a><a href="#h40-0-64" id="h40-0-64" class="i">+stabilize
</a><a href="#h40-0-65" id="h40-0-65" class="i">+---
</a><a href="#h40-0-66" id="h40-0-66" class="i">+c2@2 → n2 ClientRequest id=0x03 read 0x000162
</a><a href="#h40-0-67" id="h40-0-67" class="i">+n2@2 → n1 Heartbeat commit=2@1 read_seq=1
</a><a href="#h40-0-68" id="h40-0-68" class="i">+n2@2 → n3 Heartbeat commit=2@1 read_seq=1
</a><a href="#h40-0-69" id="h40-0-69" class="i">+n1@2 follower() ⇨ n1@2 follower(n2)
</a><a href="#h40-0-70" id="h40-0-70" class="i">+n1@2 → n2 HeartbeatResponse last=3@1 read_seq=1
</a><a href="#h40-0-71" id="h40-0-71" class="i">+n3@2 follower() ⇨ n3@2 follower(n2)
</a><a href="#h40-0-72" id="h40-0-72" class="i">+n3@2 → n2 HeartbeatResponse last=3@1 read_seq=1
</a><a href="#h40-0-73" id="h40-0-73" class="i">+n2@2 → c2 ClientResponse id=0x03 read 0x0000
</a><a href="#h40-0-74" id="h40-0-74" class="i">+c2@2 get b ⇒ None
</a><a href="#h40-0-75" id="h40-0-75" class="i">+n2@2 → n1 Append base=3@1 [4@2]
</a><a href="#h40-0-76" id="h40-0-76" class="i">+n2@2 → n3 Append base=3@1 [4@2]
</a><a href="#h40-0-77" id="h40-0-77" class="i">+n1@2 append 4@2 None
</a><a href="#h40-0-78" id="h40-0-78" class="i">+n1@2 → n2 AppendResponse last=4@2 reject=false
</a><a href="#h40-0-79" id="h40-0-79" class="i">+n3@2 append 4@2 None
</a><a href="#h40-0-80" id="h40-0-80" class="i">+n3@2 → n2 AppendResponse last=4@2 reject=false
</a><a href="#h40-0-81" id="h40-0-81" class="i">+n2@2 commit 4@2
</a><a href="#h40-0-82" id="h40-0-82" class="i">+n2@2 apply 3@1 put b=2
</a><a href="#h40-0-83" id="h40-0-83" class="i">+n2@2 apply 4@2 None
</a><b>diff --git a/<a id="h41" href="../file/src/raft/testscripts/request_leader_disconnect.html">src/raft/testscripts/request_leader_disconnect</a> b/<a href="../file/src/raft/testscripts/request_leader_disconnect.html">src/raft/testscripts/request_leader_disconnect</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,50 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+# Client read/write requests succeed if the leader is disconnected from the
</a><a href="#h41-0-1" id="h41-0-1" class="i">+# quorum when the request is submitted but it later reconnects.
</a><a href="#h41-0-2" id="h41-0-2" class="i">+
</a><a href="#h41-0-3" id="h41-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h41-0-4" id="h41-0-4" class="i">+---
</a><a href="#h41-0-5" id="h41-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h41-0-6" id="h41-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h41-0-7" id="h41-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h41-0-8" id="h41-0-8" class="i">+
</a><a href="#h41-0-9" id="h41-0-9" class="i">+# Partition n1 away from the cluster.
</a><a href="#h41-0-10" id="h41-0-10" class="i">+partition 1
</a><a href="#h41-0-11" id="h41-0-11" class="i">+---
</a><a href="#h41-0-12" id="h41-0-12" class="i">+n1 ⇹ n2 n3
</a><a href="#h41-0-13" id="h41-0-13" class="i">+
</a><a href="#h41-0-14" id="h41-0-14" class="i">+# Submit write and read requests to n1. They don&#39;t return a result.
</a><a href="#h41-0-15" id="h41-0-15" class="i">+put 1 foo=bar
</a><a href="#h41-0-16" id="h41-0-16" class="i">+get 1 foo
</a><a href="#h41-0-17" id="h41-0-17" class="i">+stabilize
</a><a href="#h41-0-18" id="h41-0-18" class="i">+---
</a><a href="#h41-0-19" id="h41-0-19" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h41-0-20" id="h41-0-20" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h41-0-21" id="h41-0-21" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h41-0-22" id="h41-0-22" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h41-0-23" id="h41-0-23" class="i">+c1@1 → n1 ClientRequest id=0x02 read 0x0003666f6f
</a><a href="#h41-0-24" id="h41-0-24" class="i">+n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a><a href="#h41-0-25" id="h41-0-25" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a><a href="#h41-0-26" id="h41-0-26" class="i">+
</a><a href="#h41-0-27" id="h41-0-27" class="i">+# Heal the partition and heartbeat. The requests return a result.
</a><a href="#h41-0-28" id="h41-0-28" class="i">+heal
</a><a href="#h41-0-29" id="h41-0-29" class="i">+---
</a><a href="#h41-0-30" id="h41-0-30" class="i">+n1 n2 n3 fully connected
</a><a href="#h41-0-31" id="h41-0-31" class="i">+
</a><a href="#h41-0-32" id="h41-0-32" class="i">+stabilize heartbeat=true
</a><a href="#h41-0-33" id="h41-0-33" class="i">+---
</a><a href="#h41-0-34" id="h41-0-34" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h41-0-35" id="h41-0-35" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h41-0-36" id="h41-0-36" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h41-0-37" id="h41-0-37" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h41-0-38" id="h41-0-38" class="i">+n1@1 → c1 ClientResponse id=0x02 read 0x0000
</a><a href="#h41-0-39" id="h41-0-39" class="i">+c1@1 get foo ⇒ None
</a><a href="#h41-0-40" id="h41-0-40" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h41-0-41" id="h41-0-41" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h41-0-42" id="h41-0-42" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h41-0-43" id="h41-0-43" class="i">+n2@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h41-0-44" id="h41-0-44" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h41-0-45" id="h41-0-45" class="i">+n3@1 → n1 AppendResponse last=2@1 reject=false
</a><a href="#h41-0-46" id="h41-0-46" class="i">+n1@1 commit 2@1
</a><a href="#h41-0-47" id="h41-0-47" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h41-0-48" id="h41-0-48" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h41-0-49" id="h41-0-49" class="i">+c1@1 put foo=bar ⇒ 2
</a><b>diff --git a/<a id="h42" href="../file/src/raft/testscripts/request_leader_read_quorum.html">src/raft/testscripts/request_leader_read_quorum</a> b/<a href="../file/src/raft/testscripts/request_leader_read_quorum.html">src/raft/testscripts/request_leader_read_quorum</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,47 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+# Client read requests are only processed once a quorum confirms the read sequence.
</a><a href="#h42-0-1" id="h42-0-1" class="i">+
</a><a href="#h42-0-2" id="h42-0-2" class="i">+cluster nodes=5 leader=1
</a><a href="#h42-0-3" id="h42-0-3" class="i">+---
</a><a href="#h42-0-4" id="h42-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h42-0-5" id="h42-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-6" id="h42-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-7" id="h42-0-7" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-8" id="h42-0-8" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-9" id="h42-0-9" class="i">+
</a><a href="#h42-0-10" id="h42-0-10" class="i">+# Write foo=bar.
</a><a href="#h42-0-11" id="h42-0-11" class="i">+(put 1 foo=bar)
</a><a href="#h42-0-12" id="h42-0-12" class="i">+(stabilize heartbeat=true)
</a><a href="#h42-0-13" id="h42-0-13" class="i">+---
</a><a href="#h42-0-14" id="h42-0-14" class="i">+ok
</a><a href="#h42-0-15" id="h42-0-15" class="i">+
</a><a href="#h42-0-16" id="h42-0-16" class="i">+# Read it once.
</a><a href="#h42-0-17" id="h42-0-17" class="i">+(get 1 foo)
</a><a href="#h42-0-18" id="h42-0-18" class="i">+(stabilize)
</a><a href="#h42-0-19" id="h42-0-19" class="i">+---
</a><a href="#h42-0-20" id="h42-0-20" class="i">+ok
</a><a href="#h42-0-21" id="h42-0-21" class="i">+
</a><a href="#h42-0-22" id="h42-0-22" class="i">+# Attempt to read it again. The read only returns once a quorum have
</a><a href="#h42-0-23" id="h42-0-23" class="i">+# confirmed the read sequence.
</a><a href="#h42-0-24" id="h42-0-24" class="i">+get 1 foo
</a><a href="#h42-0-25" id="h42-0-25" class="i">+---
</a><a href="#h42-0-26" id="h42-0-26" class="i">+c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h42-0-27" id="h42-0-27" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-0-28" id="h42-0-28" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-0-29" id="h42-0-29" class="i">+n1@1 → n4 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-0-30" id="h42-0-30" class="i">+n1@1 → n5 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-0-31" id="h42-0-31" class="i">+
</a><a href="#h42-0-32" id="h42-0-32" class="i">+deliver 2
</a><a href="#h42-0-33" id="h42-0-33" class="i">+deliver 1
</a><a href="#h42-0-34" id="h42-0-34" class="i">+---
</a><a href="#h42-0-35" id="h42-0-35" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h42-0-36" id="h42-0-36" class="i">+
</a><a href="#h42-0-37" id="h42-0-37" class="i">+deliver 3
</a><a href="#h42-0-38" id="h42-0-38" class="i">+deliver 1
</a><a href="#h42-0-39" id="h42-0-39" class="i">+---
</a><a href="#h42-0-40" id="h42-0-40" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h42-0-41" id="h42-0-41" class="i">+n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h42-0-42" id="h42-0-42" class="i">+c1@1 get foo ⇒ bar
</a><a href="#h42-0-43" id="h42-0-43" class="i">+
</a><a href="#h42-0-44" id="h42-0-44" class="i">+(stabilize)
</a><a href="#h42-0-45" id="h42-0-45" class="i">+---
</a><a href="#h42-0-46" id="h42-0-46" class="i">+ok
</a><b>diff --git a/<a id="h43" href="../file/src/raft/testscripts/request_leader_read_quorum_sequence.html">src/raft/testscripts/request_leader_read_quorum_sequence</a> b/<a href="../file/src/raft/testscripts/request_leader_read_quorum_sequence.html">src/raft/testscripts/request_leader_read_quorum_sequence</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+# Client read requests are only served once a quorum confirm the read sequence
</a><a href="#h43-0-1" id="h43-0-1" class="i">+# number, including higher sequence numbers.
</a><a href="#h43-0-2" id="h43-0-2" class="i">+
</a><a href="#h43-0-3" id="h43-0-3" class="i">+cluster nodes=5 leader=1
</a><a href="#h43-0-4" id="h43-0-4" class="i">+---
</a><a href="#h43-0-5" id="h43-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h43-0-6" id="h43-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-7" id="h43-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-8" id="h43-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-9" id="h43-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-10" id="h43-0-10" class="i">+
</a><a href="#h43-0-11" id="h43-0-11" class="i">+# Write foo=bar and read it back.
</a><a href="#h43-0-12" id="h43-0-12" class="i">+(put 1 foo=bar)
</a><a href="#h43-0-13" id="h43-0-13" class="i">+(stabilize heartbeat=true)
</a><a href="#h43-0-14" id="h43-0-14" class="i">+(get 1 foo)
</a><a href="#h43-0-15" id="h43-0-15" class="i">+(stabilize)
</a><a href="#h43-0-16" id="h43-0-16" class="i">+---
</a><a href="#h43-0-17" id="h43-0-17" class="i">+ok
</a><a href="#h43-0-18" id="h43-0-18" class="i">+
</a><a href="#h43-0-19" id="h43-0-19" class="i">+# Send a heartbeat with sequence number 1, and deliver it to all followers.
</a><a href="#h43-0-20" id="h43-0-20" class="i">+heartbeat 1
</a><a href="#h43-0-21" id="h43-0-21" class="i">+deliver
</a><a href="#h43-0-22" id="h43-0-22" class="i">+---
</a><a href="#h43-0-23" id="h43-0-23" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=1
</a><a href="#h43-0-24" id="h43-0-24" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=1
</a><a href="#h43-0-25" id="h43-0-25" class="i">+n1@1 → n4 Heartbeat commit=2@1 read_seq=1
</a><a href="#h43-0-26" id="h43-0-26" class="i">+n1@1 → n5 Heartbeat commit=2@1 read_seq=1
</a><a href="#h43-0-27" id="h43-0-27" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h43-0-28" id="h43-0-28" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h43-0-29" id="h43-0-29" class="i">+n4@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h43-0-30" id="h43-0-30" class="i">+n5@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h43-0-31" id="h43-0-31" class="i">+
</a><a href="#h43-0-32" id="h43-0-32" class="i">+# Partition n1 away.
</a><a href="#h43-0-33" id="h43-0-33" class="i">+partition 1
</a><a href="#h43-0-34" id="h43-0-34" class="i">+---
</a><a href="#h43-0-35" id="h43-0-35" class="i">+n1 ⇹ n2 n3 n4 n5
</a><a href="#h43-0-36" id="h43-0-36" class="i">+
</a><a href="#h43-0-37" id="h43-0-37" class="i">+# Perform a read at sequence number 2. The heartbeats are lost.
</a><a href="#h43-0-38" id="h43-0-38" class="i">+get 1 foo
</a><a href="#h43-0-39" id="h43-0-39" class="i">+---
</a><a href="#h43-0-40" id="h43-0-40" class="i">+c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h43-0-41" id="h43-0-41" class="i">+n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h43-0-42" id="h43-0-42" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h43-0-43" id="h43-0-43" class="i">+n1@1 ⇥ n4 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h43-0-44" id="h43-0-44" class="i">+n1@1 ⇥ n5 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h43-0-45" id="h43-0-45" class="i">+
</a><a href="#h43-0-46" id="h43-0-46" class="i">+# Deliver the heartbeat responses at sequence number 1. These should not satisfy
</a><a href="#h43-0-47" id="h43-0-47" class="i">+# the read at sequence number 2.
</a><a href="#h43-0-48" id="h43-0-48" class="i">+deliver 1
</a><a href="#h43-0-49" id="h43-0-49" class="i">+---
</a><a href="#h43-0-50" id="h43-0-50" class="i">+ok
</a><a href="#h43-0-51" id="h43-0-51" class="i">+
</a><a href="#h43-0-52" id="h43-0-52" class="i">+# Heal the partition and perform another read at sequence number 3. Followers
</a><a href="#h43-0-53" id="h43-0-53" class="i">+# respond to the heartbeats at sequence number 3.
</a><a href="#h43-0-54" id="h43-0-54" class="i">+heal
</a><a href="#h43-0-55" id="h43-0-55" class="i">+get 1 foo
</a><a href="#h43-0-56" id="h43-0-56" class="i">+---
</a><a href="#h43-0-57" id="h43-0-57" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h43-0-58" id="h43-0-58" class="i">+c1@1 → n1 ClientRequest id=0x04 read 0x0003666f6f
</a><a href="#h43-0-59" id="h43-0-59" class="i">+n1@1 → n2 Heartbeat commit=2@1 read_seq=3
</a><a href="#h43-0-60" id="h43-0-60" class="i">+n1@1 → n3 Heartbeat commit=2@1 read_seq=3
</a><a href="#h43-0-61" id="h43-0-61" class="i">+n1@1 → n4 Heartbeat commit=2@1 read_seq=3
</a><a href="#h43-0-62" id="h43-0-62" class="i">+n1@1 → n5 Heartbeat commit=2@1 read_seq=3
</a><a href="#h43-0-63" id="h43-0-63" class="i">+
</a><a href="#h43-0-64" id="h43-0-64" class="i">+deliver
</a><a href="#h43-0-65" id="h43-0-65" class="i">+---
</a><a href="#h43-0-66" id="h43-0-66" class="i">+n2@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h43-0-67" id="h43-0-67" class="i">+n3@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h43-0-68" id="h43-0-68" class="i">+n4@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h43-0-69" id="h43-0-69" class="i">+n5@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h43-0-70" id="h43-0-70" class="i">+
</a><a href="#h43-0-71" id="h43-0-71" class="i">+# Once n1 receives two heartbeat responses it has a read quorum and
</a><a href="#h43-0-72" id="h43-0-72" class="i">+# serves both the read at seqnums 2 (id=0x03) and 3 (id=0x04).
</a><a href="#h43-0-73" id="h43-0-73" class="i">+deliver 1 from=3
</a><a href="#h43-0-74" id="h43-0-74" class="i">+deliver 1 from=5
</a><a href="#h43-0-75" id="h43-0-75" class="i">+---
</a><a href="#h43-0-76" id="h43-0-76" class="i">+n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h43-0-77" id="h43-0-77" class="i">+c1@1 get foo ⇒ bar
</a><a href="#h43-0-78" id="h43-0-78" class="i">+n1@1 → c1 ClientResponse id=0x04 read 0x000103626172
</a><a href="#h43-0-79" id="h43-0-79" class="i">+c1@1 get foo ⇒ bar
</a><b>diff --git a/<a id="h44" href="../file/src/raft/testscripts/request_leader_single.html">src/raft/testscripts/request_leader_single</a> b/<a href="../file/src/raft/testscripts/request_leader_single.html">src/raft/testscripts/request_leader_single</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h44-0-0" id="h44-0-0" class="i">+# Client read/write requests succeed on a lone leader.
</a><a href="#h44-0-1" id="h44-0-1" class="i">+
</a><a href="#h44-0-2" id="h44-0-2" class="i">+cluster nodes=1
</a><a href="#h44-0-3" id="h44-0-3" class="i">+---
</a><a href="#h44-0-4" id="h44-0-4" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={}
</a><a href="#h44-0-5" id="h44-0-5" class="i">+
</a><a href="#h44-0-6" id="h44-0-6" class="i">+# An initial get on the leader yields None.
</a><a href="#h44-0-7" id="h44-0-7" class="i">+get 1 foo
</a><a href="#h44-0-8" id="h44-0-8" class="i">+stabilize
</a><a href="#h44-0-9" id="h44-0-9" class="i">+---
</a><a href="#h44-0-10" id="h44-0-10" class="i">+c1@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
</a><a href="#h44-0-11" id="h44-0-11" class="i">+n1@1 → c1 ClientResponse id=0x01 read 0x0000
</a><a href="#h44-0-12" id="h44-0-12" class="i">+c1@1 get foo ⇒ None
</a><a href="#h44-0-13" id="h44-0-13" class="i">+
</a><a href="#h44-0-14" id="h44-0-14" class="i">+# Write a value on the leader.
</a><a href="#h44-0-15" id="h44-0-15" class="i">+put 1 foo=bar
</a><a href="#h44-0-16" id="h44-0-16" class="i">+stabilize heartbeat=true
</a><a href="#h44-0-17" id="h44-0-17" class="i">+---
</a><a href="#h44-0-18" id="h44-0-18" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0103666f6f03626172
</a><a href="#h44-0-19" id="h44-0-19" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h44-0-20" id="h44-0-20" class="i">+n1@1 commit 2@1
</a><a href="#h44-0-21" id="h44-0-21" class="i">+n1@1 apply 1@1 None
</a><a href="#h44-0-22" id="h44-0-22" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h44-0-23" id="h44-0-23" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0102
</a><a href="#h44-0-24" id="h44-0-24" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h44-0-25" id="h44-0-25" class="i">+
</a><a href="#h44-0-26" id="h44-0-26" class="i">+# Read the value back on the leader.
</a><a href="#h44-0-27" id="h44-0-27" class="i">+get 1 foo
</a><a href="#h44-0-28" id="h44-0-28" class="i">+stabilize
</a><a href="#h44-0-29" id="h44-0-29" class="i">+---
</a><a href="#h44-0-30" id="h44-0-30" class="i">+c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
</a><a href="#h44-0-31" id="h44-0-31" class="i">+n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
</a><a href="#h44-0-32" id="h44-0-32" class="i">+c1@1 get foo ⇒ bar
</a><b>diff --git a/<a id="h45" href="../file/src/raft/testscripts/request_status.html">src/raft/testscripts/request_status</a> b/<a href="../file/src/raft/testscripts/request_status.html">src/raft/testscripts/request_status</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,75 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+# Status requests return the cluster status.
</a><a href="#h45-0-1" id="h45-0-1" class="i">+
</a><a href="#h45-0-2" id="h45-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h45-0-3" id="h45-0-3" class="i">+---
</a><a href="#h45-0-4" id="h45-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h45-0-5" id="h45-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h45-0-6" id="h45-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h45-0-7" id="h45-0-7" class="i">+
</a><a href="#h45-0-8" id="h45-0-8" class="i">+# Partition away n3, so not all nodes have the same log position.
</a><a href="#h45-0-9" id="h45-0-9" class="i">+partition 3
</a><a href="#h45-0-10" id="h45-0-10" class="i">+---
</a><a href="#h45-0-11" id="h45-0-11" class="i">+n3 ⇹ n1 n2
</a><a href="#h45-0-12" id="h45-0-12" class="i">+
</a><a href="#h45-0-13" id="h45-0-13" class="i">+# Replicate a write, but not the commit index.
</a><a href="#h45-0-14" id="h45-0-14" class="i">+(put 1 foo=bar)
</a><a href="#h45-0-15" id="h45-0-15" class="i">+(stabilize)
</a><a href="#h45-0-16" id="h45-0-16" class="i">+status
</a><a href="#h45-0-17" id="h45-0-17" class="i">+---
</a><a href="#h45-0-18" id="h45-0-18" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:1→2}
</a><a href="#h45-0-19" id="h45-0-19" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h45-0-20" id="h45-0-20" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h45-0-21" id="h45-0-21" class="i">+
</a><a href="#h45-0-22" id="h45-0-22" class="i">+# Run a status request on the leader.
</a><a href="#h45-0-23" id="h45-0-23" class="i">+status request=true 1
</a><a href="#h45-0-24" id="h45-0-24" class="i">+stabilize
</a><a href="#h45-0-25" id="h45-0-25" class="i">+---
</a><a href="#h45-0-26" id="h45-0-26" class="i">+c1@1 → n1 ClientRequest id=0x02 status
</a><a href="#h45-0-27" id="h45-0-27" class="i">+n1@1 → c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, last_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 39, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h45-0-28" id="h45-0-28" class="i">+c1@1 status ⇒ Status {
</a><a href="#h45-0-29" id="h45-0-29" class="i">+    leader: 1,
</a><a href="#h45-0-30" id="h45-0-30" class="i">+    term: 1,
</a><a href="#h45-0-31" id="h45-0-31" class="i">+    last_index: {
</a><a href="#h45-0-32" id="h45-0-32" class="i">+        1: 2,
</a><a href="#h45-0-33" id="h45-0-33" class="i">+        2: 2,
</a><a href="#h45-0-34" id="h45-0-34" class="i">+        3: 1,
</a><a href="#h45-0-35" id="h45-0-35" class="i">+    },
</a><a href="#h45-0-36" id="h45-0-36" class="i">+    commit_index: 2,
</a><a href="#h45-0-37" id="h45-0-37" class="i">+    apply_index: 2,
</a><a href="#h45-0-38" id="h45-0-38" class="i">+    storage: Status {
</a><a href="#h45-0-39" id="h45-0-39" class="i">+        name: &quot;memory&quot;,
</a><a href="#h45-0-40" id="h45-0-40" class="i">+        keys: 4,
</a><a href="#h45-0-41" id="h45-0-41" class="i">+        size: 39,
</a><a href="#h45-0-42" id="h45-0-42" class="i">+        total_disk_size: 0,
</a><a href="#h45-0-43" id="h45-0-43" class="i">+        live_disk_size: 0,
</a><a href="#h45-0-44" id="h45-0-44" class="i">+        garbage_disk_size: 0,
</a><a href="#h45-0-45" id="h45-0-45" class="i">+    },
</a><a href="#h45-0-46" id="h45-0-46" class="i">+}
</a><a href="#h45-0-47" id="h45-0-47" class="i">+
</a><a href="#h45-0-48" id="h45-0-48" class="i">+# Run a status request on a follower.
</a><a href="#h45-0-49" id="h45-0-49" class="i">+status request=true 2
</a><a href="#h45-0-50" id="h45-0-50" class="i">+stabilize
</a><a href="#h45-0-51" id="h45-0-51" class="i">+---
</a><a href="#h45-0-52" id="h45-0-52" class="i">+c2@1 → n2 ClientRequest id=0x03 status
</a><a href="#h45-0-53" id="h45-0-53" class="i">+n2@1 → n1 ClientRequest id=0x03 status
</a><a href="#h45-0-54" id="h45-0-54" class="i">+n1@1 → n2 ClientResponse id=0x03 status Status { leader: 1, term: 1, last_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 39, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h45-0-55" id="h45-0-55" class="i">+n2@1 → c2 ClientResponse id=0x03 status Status { leader: 1, term: 1, last_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 39, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h45-0-56" id="h45-0-56" class="i">+c2@1 status ⇒ Status {
</a><a href="#h45-0-57" id="h45-0-57" class="i">+    leader: 1,
</a><a href="#h45-0-58" id="h45-0-58" class="i">+    term: 1,
</a><a href="#h45-0-59" id="h45-0-59" class="i">+    last_index: {
</a><a href="#h45-0-60" id="h45-0-60" class="i">+        1: 2,
</a><a href="#h45-0-61" id="h45-0-61" class="i">+        2: 2,
</a><a href="#h45-0-62" id="h45-0-62" class="i">+        3: 1,
</a><a href="#h45-0-63" id="h45-0-63" class="i">+    },
</a><a href="#h45-0-64" id="h45-0-64" class="i">+    commit_index: 2,
</a><a href="#h45-0-65" id="h45-0-65" class="i">+    apply_index: 2,
</a><a href="#h45-0-66" id="h45-0-66" class="i">+    storage: Status {
</a><a href="#h45-0-67" id="h45-0-67" class="i">+        name: &quot;memory&quot;,
</a><a href="#h45-0-68" id="h45-0-68" class="i">+        keys: 4,
</a><a href="#h45-0-69" id="h45-0-69" class="i">+        size: 39,
</a><a href="#h45-0-70" id="h45-0-70" class="i">+        total_disk_size: 0,
</a><a href="#h45-0-71" id="h45-0-71" class="i">+        live_disk_size: 0,
</a><a href="#h45-0-72" id="h45-0-72" class="i">+        garbage_disk_size: 0,
</a><a href="#h45-0-73" id="h45-0-73" class="i">+    },
</a><a href="#h45-0-74" id="h45-0-74" class="i">+}
</a><b>diff --git a/<a id="h46" href="../file/src/raft/testscripts/request_status_single.html">src/raft/testscripts/request_status_single</a> b/<a href="../file/src/raft/testscripts/request_status_single.html">src/raft/testscripts/request_status_single</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,36 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+# Status requests return the cluster status on a single node.
</a><a href="#h46-0-1" id="h46-0-1" class="i">+
</a><a href="#h46-0-2" id="h46-0-2" class="i">+cluster nodes=1
</a><a href="#h46-0-3" id="h46-0-3" class="i">+---
</a><a href="#h46-0-4" id="h46-0-4" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={}
</a><a href="#h46-0-5" id="h46-0-5" class="i">+
</a><a href="#h46-0-6" id="h46-0-6" class="i">+# Perform a write.
</a><a href="#h46-0-7" id="h46-0-7" class="i">+(put 1 foo=bar)
</a><a href="#h46-0-8" id="h46-0-8" class="i">+(stabilize)
</a><a href="#h46-0-9" id="h46-0-9" class="i">+status
</a><a href="#h46-0-10" id="h46-0-10" class="i">+---
</a><a href="#h46-0-11" id="h46-0-11" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={}
</a><a href="#h46-0-12" id="h46-0-12" class="i">+
</a><a href="#h46-0-13" id="h46-0-13" class="i">+# Run a status request on the leader.
</a><a href="#h46-0-14" id="h46-0-14" class="i">+status request=true 1
</a><a href="#h46-0-15" id="h46-0-15" class="i">+stabilize
</a><a href="#h46-0-16" id="h46-0-16" class="i">+---
</a><a href="#h46-0-17" id="h46-0-17" class="i">+c1@1 → n1 ClientRequest id=0x02 status
</a><a href="#h46-0-18" id="h46-0-18" class="i">+n1@1 → c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, last_index: {1: 2}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 39, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h46-0-19" id="h46-0-19" class="i">+c1@1 status ⇒ Status {
</a><a href="#h46-0-20" id="h46-0-20" class="i">+    leader: 1,
</a><a href="#h46-0-21" id="h46-0-21" class="i">+    term: 1,
</a><a href="#h46-0-22" id="h46-0-22" class="i">+    last_index: {
</a><a href="#h46-0-23" id="h46-0-23" class="i">+        1: 2,
</a><a href="#h46-0-24" id="h46-0-24" class="i">+    },
</a><a href="#h46-0-25" id="h46-0-25" class="i">+    commit_index: 2,
</a><a href="#h46-0-26" id="h46-0-26" class="i">+    apply_index: 2,
</a><a href="#h46-0-27" id="h46-0-27" class="i">+    storage: Status {
</a><a href="#h46-0-28" id="h46-0-28" class="i">+        name: &quot;memory&quot;,
</a><a href="#h46-0-29" id="h46-0-29" class="i">+        keys: 4,
</a><a href="#h46-0-30" id="h46-0-30" class="i">+        size: 39,
</a><a href="#h46-0-31" id="h46-0-31" class="i">+        total_disk_size: 0,
</a><a href="#h46-0-32" id="h46-0-32" class="i">+        live_disk_size: 0,
</a><a href="#h46-0-33" id="h46-0-33" class="i">+        garbage_disk_size: 0,
</a><a href="#h46-0-34" id="h46-0-34" class="i">+    },
</a><a href="#h46-0-35" id="h46-0-35" class="i">+}
</a><b>diff --git a/<a id="h47" href="../file/src/raft/testscripts/tick_candidate.html">src/raft/testscripts/tick_candidate</a> b/<a href="../file/src/raft/testscripts/tick_candidate.html">src/raft/testscripts/tick_candidate</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,32 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+# Ticking a candidate will eventually hold a new election in a later term.
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+cluster nodes=3 heartbeat_interval=1 election_timeout=2
</a><a href="#h47-0-3" id="h47-0-3" class="i">+---
</a><a href="#h47-0-4" id="h47-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h47-0-5" id="h47-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h47-0-6" id="h47-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h47-0-7" id="h47-0-7" class="i">+
</a><a href="#h47-0-8" id="h47-0-8" class="i">+# n1 campaigns.
</a><a href="#h47-0-9" id="h47-0-9" class="i">+campaign 1
</a><a href="#h47-0-10" id="h47-0-10" class="i">+---
</a><a href="#h47-0-11" id="h47-0-11" class="i">+n1@0 follower() ⇨ n1@1 candidate
</a><a href="#h47-0-12" id="h47-0-12" class="i">+n1@1 → n2 Campaign last=0@0
</a><a href="#h47-0-13" id="h47-0-13" class="i">+n1@1 → n3 Campaign last=0@0
</a><a href="#h47-0-14" id="h47-0-14" class="i">+
</a><a href="#h47-0-15" id="h47-0-15" class="i">+# A single tick does nothing.
</a><a href="#h47-0-16" id="h47-0-16" class="i">+tick 1
</a><a href="#h47-0-17" id="h47-0-17" class="i">+---
</a><a href="#h47-0-18" id="h47-0-18" class="i">+ok
</a><a href="#h47-0-19" id="h47-0-19" class="i">+
</a><a href="#h47-0-20" id="h47-0-20" class="i">+# Another tick campaigns in a later term.
</a><a href="#h47-0-21" id="h47-0-21" class="i">+tick 1
</a><a href="#h47-0-22" id="h47-0-22" class="i">+---
</a><a href="#h47-0-23" id="h47-0-23" class="i">+n1@1 candidate ⇨ n1@2 candidate
</a><a href="#h47-0-24" id="h47-0-24" class="i">+n1@2 → n2 Campaign last=0@0
</a><a href="#h47-0-25" id="h47-0-25" class="i">+n1@2 → n3 Campaign last=0@0
</a><a href="#h47-0-26" id="h47-0-26" class="i">+
</a><a href="#h47-0-27" id="h47-0-27" class="i">+status
</a><a href="#h47-0-28" id="h47-0-28" class="i">+---
</a><a href="#h47-0-29" id="h47-0-29" class="i">+n1@2 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h47-0-30" id="h47-0-30" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h47-0-31" id="h47-0-31" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><b>diff --git a/<a id="h48" href="../file/src/raft/testscripts/tick_follower.html">src/raft/testscripts/tick_follower</a> b/<a href="../file/src/raft/testscripts/tick_follower.html">src/raft/testscripts/tick_follower</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h48-0-0" id="h48-0-0" class="i">+# Ticking a follower will transition it to candidate if it hasn&#39;t
</a><a href="#h48-0-1" id="h48-0-1" class="i">+# heard from the leader in a while.
</a><a href="#h48-0-2" id="h48-0-2" class="i">+
</a><a href="#h48-0-3" id="h48-0-3" class="i">+cluster nodes=3 leader=1 heartbeat_interval=1 election_timeout=2
</a><a href="#h48-0-4" id="h48-0-4" class="i">+---
</a><a href="#h48-0-5" id="h48-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h48-0-6" id="h48-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h48-0-7" id="h48-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h48-0-8" id="h48-0-8" class="i">+
</a><a href="#h48-0-9" id="h48-0-9" class="i">+# A single follower tick does nothing.
</a><a href="#h48-0-10" id="h48-0-10" class="i">+tick 2
</a><a href="#h48-0-11" id="h48-0-11" class="i">+---
</a><a href="#h48-0-12" id="h48-0-12" class="i">+ok
</a><a href="#h48-0-13" id="h48-0-13" class="i">+
</a><a href="#h48-0-14" id="h48-0-14" class="i">+# If n1 heartbeats, the election counter is reset, and another n2 tick does nothing.
</a><a href="#h48-0-15" id="h48-0-15" class="i">+heartbeat 1
</a><a href="#h48-0-16" id="h48-0-16" class="i">+stabilize
</a><a href="#h48-0-17" id="h48-0-17" class="i">+---
</a><a href="#h48-0-18" id="h48-0-18" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h48-0-19" id="h48-0-19" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h48-0-20" id="h48-0-20" class="i">+n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h48-0-21" id="h48-0-21" class="i">+n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h48-0-22" id="h48-0-22" class="i">+
</a><a href="#h48-0-23" id="h48-0-23" class="i">+tick 2
</a><a href="#h48-0-24" id="h48-0-24" class="i">+---
</a><a href="#h48-0-25" id="h48-0-25" class="i">+ok
</a><a href="#h48-0-26" id="h48-0-26" class="i">+
</a><a href="#h48-0-27" id="h48-0-27" class="i">+# Ticking n2 again exceeds the election timeout, making it campaign.
</a><a href="#h48-0-28" id="h48-0-28" class="i">+tick 2
</a><a href="#h48-0-29" id="h48-0-29" class="i">+---
</a><a href="#h48-0-30" id="h48-0-30" class="i">+n2@1 follower(n1) ⇨ n2@2 candidate
</a><a href="#h48-0-31" id="h48-0-31" class="i">+n2@2 → n1 Campaign last=1@1
</a><a href="#h48-0-32" id="h48-0-32" class="i">+n2@2 → n3 Campaign last=1@1
</a><a href="#h48-0-33" id="h48-0-33" class="i">+
</a><a href="#h48-0-34" id="h48-0-34" class="i">+status
</a><a href="#h48-0-35" id="h48-0-35" class="i">+---
</a><a href="#h48-0-36" id="h48-0-36" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h48-0-37" id="h48-0-37" class="i">+n2@2 candidate last=1@1 commit=1@1 apply=1
</a><a href="#h48-0-38" id="h48-0-38" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h49" href="../file/src/raft/testscripts/tick_follower_leaderless.html">src/raft/testscripts/tick_follower_leaderless</a> b/<a href="../file/src/raft/testscripts/tick_follower_leaderless.html">src/raft/testscripts/tick_follower_leaderless</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+# Ticking a leaderless follower will eventually transition it to candidate.
</a><a href="#h49-0-1" id="h49-0-1" class="i">+
</a><a href="#h49-0-2" id="h49-0-2" class="i">+cluster nodes=3 heartbeat_interval=1 election_timeout=2
</a><a href="#h49-0-3" id="h49-0-3" class="i">+---
</a><a href="#h49-0-4" id="h49-0-4" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h49-0-5" id="h49-0-5" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h49-0-6" id="h49-0-6" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h49-0-7" id="h49-0-7" class="i">+
</a><a href="#h49-0-8" id="h49-0-8" class="i">+# A single follower tick does nothing.
</a><a href="#h49-0-9" id="h49-0-9" class="i">+tick 2
</a><a href="#h49-0-10" id="h49-0-10" class="i">+---
</a><a href="#h49-0-11" id="h49-0-11" class="i">+ok
</a><a href="#h49-0-12" id="h49-0-12" class="i">+
</a><a href="#h49-0-13" id="h49-0-13" class="i">+# Another tick makes it campaign.
</a><a href="#h49-0-14" id="h49-0-14" class="i">+tick 2
</a><a href="#h49-0-15" id="h49-0-15" class="i">+---
</a><a href="#h49-0-16" id="h49-0-16" class="i">+n2@0 follower() ⇨ n2@1 candidate
</a><a href="#h49-0-17" id="h49-0-17" class="i">+n2@1 → n1 Campaign last=0@0
</a><a href="#h49-0-18" id="h49-0-18" class="i">+n2@1 → n3 Campaign last=0@0
</a><a href="#h49-0-19" id="h49-0-19" class="i">+
</a><a href="#h49-0-20" id="h49-0-20" class="i">+status
</a><a href="#h49-0-21" id="h49-0-21" class="i">+---
</a><a href="#h49-0-22" id="h49-0-22" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h49-0-23" id="h49-0-23" class="i">+n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h49-0-24" id="h49-0-24" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><b>diff --git a/<a id="h50" href="../file/src/raft/testscripts/tick_leader.html">src/raft/testscripts/tick_leader</a> b/<a href="../file/src/raft/testscripts/tick_leader.html">src/raft/testscripts/tick_leader</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h50-0-0" id="h50-0-0" class="i">+# Ticking a leader should cause it to emit heartbeats, even when it doesn&#39;t
</a><a href="#h50-0-1" id="h50-0-1" class="i">+# hear back from any followers.
</a><a href="#h50-0-2" id="h50-0-2" class="i">+
</a><a href="#h50-0-3" id="h50-0-3" class="i">+cluster nodes=3 leader=1 heartbeat_interval=1 election_timeout=2
</a><a href="#h50-0-4" id="h50-0-4" class="i">+---
</a><a href="#h50-0-5" id="h50-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h50-0-6" id="h50-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-7" id="h50-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-8" id="h50-0-8" class="i">+
</a><a href="#h50-0-9" id="h50-0-9" class="i">+# Ticking n1 will emit a heartbeat.
</a><a href="#h50-0-10" id="h50-0-10" class="i">+tick 1
</a><a href="#h50-0-11" id="h50-0-11" class="i">+---
</a><a href="#h50-0-12" id="h50-0-12" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-13" id="h50-0-13" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-14" id="h50-0-14" class="i">+
</a><a href="#h50-0-15" id="h50-0-15" class="i">+# Ticking n1 again will emit further heartbeats, even when it hasn&#39;t heard from
</a><a href="#h50-0-16" id="h50-0-16" class="i">+# any followers.
</a><a href="#h50-0-17" id="h50-0-17" class="i">+tick 1
</a><a href="#h50-0-18" id="h50-0-18" class="i">+tick 1
</a><a href="#h50-0-19" id="h50-0-19" class="i">+tick 1
</a><a href="#h50-0-20" id="h50-0-20" class="i">+---
</a><a href="#h50-0-21" id="h50-0-21" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-22" id="h50-0-22" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-23" id="h50-0-23" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-24" id="h50-0-24" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-25" id="h50-0-25" class="i">+n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h50-0-26" id="h50-0-26" class="i">+n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a></pre>
</div>
</body>
</html>
