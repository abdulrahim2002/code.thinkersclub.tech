<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Added transaction support. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/37a1d245bbe4ba59d59e1c7c9bcd04402541d618.html">37a1d245bbe4ba59d59e1c7c9bcd04402541d618</a>
<b>parent</b> <a href="../commit/d93ee30e93f1975b80e68b00f204cf03c8ca9b75.html">d93ee30e93f1975b80e68b00f204cf03c8ca9b75</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun,  1 Dec 2019 17:55:21 +0100

Added transaction support.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">README.md</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">protobuf/toydb.proto</a></td><td> | </td><td class="num">5</td><td><span class="i">++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/bin/toysql.rs</a></td><td> | </td><td class="num">24</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/client.rs</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/kv/mvcc.rs</a></td><td> | </td><td class="num">140</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/server/toydb.rs</a></td><td> | </td><td class="num">68</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/sql/engine/mod.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">226</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/sql/types.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">+++++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>10 files changed, 409 insertions(+), 111 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -48,9 +48,7 @@ toydb&gt; SELECT * FROM movies
</a> 
 - [ ] **Schemas:** Compulsory singluar primary keys, unique and foreign key constraints, indexes.
 
<a href="#h0-0-3" id="h0-0-3" class="d">-- [ ] **Transactions:** Self-written ACID-compliant transaction engine with MVCC-based snapshot isolation.
</a><a href="#h0-0-4" id="h0-0-4" class="d">-
</a><a href="#h0-0-5" id="h0-0-5" class="d">-  - [ ] Serializable snapshot isolation.
</a><a href="#h0-0-6" id="h0-0-6" class="i">+- [x] **Transactions:** Self-written ACID-compliant transaction engine with MVCC-based snapshot isolation.
</a> 
 - [x] **Query Engine:** Self-written iterator-based engine with simple heuristic optimizer.
 
<a href="#h0-1" id="h0-1" class="h">@@ -103,6 +101,8 @@ Below is an incomplete list of known issues preventing this from being a &quot;real&quot; 
</a> 
 * **Abortion:** client disconnects or system crashes do not abort transactions, which may cause serialization failures for other transactions due to uncommitted writes.
 
<a href="#h0-1-3" id="h0-1-3" class="i">+* **Serializability:** transactions use MVCC without serializable snapshot isolation, thus are vulnerable to write skew and other anomalies.
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a> ### Schema
 
 * **Single database:** only a single, unnamed database is supported per ToyDB cluster.
<b>diff --git a/<a id="h1" href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a> b/<a href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -27,7 +27,10 @@ message StatusResponse {
</a>   string version = 3;
 };
 
<a href="#h1-0-3" id="h1-0-3" class="d">-message QueryRequest { string query = 1; };
</a><a href="#h1-0-4" id="h1-0-4" class="i">+message QueryRequest {
</a><a href="#h1-0-5" id="h1-0-5" class="i">+  string query = 1;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+  uint64 txn_id = 2;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+};
</a> 
 message Row {
   Error error = 1;
<b>diff --git a/<a id="h2" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -55,6 +55,7 @@ struct ToySQL {
</a>     editor: rustyline::Editor&lt;()&gt;,
     history_path: Option&lt;std::path::PathBuf&gt;,
     show_headers: bool,
<a href="#h2-0-3" id="h2-0-3" class="i">+    txn_id: Option&lt;u64&gt;,
</a> }
 
 impl ToySQL {
<a href="#h2-1" id="h2-1" class="h">@@ -66,6 +67,7 @@ impl ToySQL {
</a>             history_path: std::env::var_os(&quot;HOME&quot;)
                 .map(|home| std::path::Path::new(&amp;home).join(&quot;.toysql.history&quot;)),
             show_headers: false,
<a href="#h2-1-3" id="h2-1-3" class="i">+            txn_id: None,
</a>         })
     }
 
<a href="#h2-2" id="h2-2" class="h">@@ -145,7 +147,27 @@ Semicolons are not supported. The following !-commands are also available:
</a> 
     /// Runs a query and displays the results
     fn execute_query(&amp;mut self, query: &amp;str) -&gt; Result&lt;(), toydb::Error&gt; {
<a href="#h2-2-3" id="h2-2-3" class="d">-        let resultset = self.client.query(query)?;
</a><a href="#h2-2-4" id="h2-2-4" class="i">+        let resultset = self.client.query(self.txn_id.clone(), query)?;
</a><a href="#h2-2-5" id="h2-2-5" class="i">+
</a><a href="#h2-2-6" id="h2-2-6" class="i">+        match (resultset.txn_id(), self.txn_id) {
</a><a href="#h2-2-7" id="h2-2-7" class="i">+            (None, None) =&gt; {}
</a><a href="#h2-2-8" id="h2-2-8" class="i">+            (Some(new_id), Some(current_id)) if new_id == current_id =&gt; {}
</a><a href="#h2-2-9" id="h2-2-9" class="i">+            (Some(new_id), Some(current_id)) =&gt; {
</a><a href="#h2-2-10" id="h2-2-10" class="i">+                return Err(toydb::Error::Internal(format!(
</a><a href="#h2-2-11" id="h2-2-11" class="i">+                    &quot;Unexpected transaction ID {}, current {}&quot;,
</a><a href="#h2-2-12" id="h2-2-12" class="i">+                    new_id, current_id
</a><a href="#h2-2-13" id="h2-2-13" class="i">+                )))
</a><a href="#h2-2-14" id="h2-2-14" class="i">+            }
</a><a href="#h2-2-15" id="h2-2-15" class="i">+            (Some(new_id), None) =&gt; {
</a><a href="#h2-2-16" id="h2-2-16" class="i">+                println!(&quot;Began transaction {}&quot;, new_id);
</a><a href="#h2-2-17" id="h2-2-17" class="i">+                self.txn_id = Some(new_id)
</a><a href="#h2-2-18" id="h2-2-18" class="i">+            }
</a><a href="#h2-2-19" id="h2-2-19" class="i">+            (None, Some(current_id)) =&gt; {
</a><a href="#h2-2-20" id="h2-2-20" class="i">+                println!(&quot;Ended transaction {}&quot;, current_id);
</a><a href="#h2-2-21" id="h2-2-21" class="i">+                self.txn_id = None
</a><a href="#h2-2-22" id="h2-2-22" class="i">+            }
</a><a href="#h2-2-23" id="h2-2-23" class="i">+        }
</a><a href="#h2-2-24" id="h2-2-24" class="i">+
</a>         if self.show_headers {
             println!(&quot;{}&quot;, resultset.columns().join(&quot;|&quot;));
         }
<b>diff --git a/<a id="h3" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -38,12 +38,16 @@ impl Client {
</a>     }
 
     /// Runs a query
<a href="#h3-0-3" id="h3-0-3" class="d">-    pub fn query(&amp;self, query: &amp;str) -&gt; Result&lt;ResultSet, Error&gt; {
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    pub fn query(&amp;self, txn_id: Option&lt;u64&gt;, query: &amp;str) -&gt; Result&lt;ResultSet, Error&gt; {
</a>         let (metadata, iter) = self
             .client
             .query(
                 grpc::RequestOptions::new(),
<a href="#h3-0-9" id="h3-0-9" class="d">-                service::QueryRequest { query: query.to_owned(), ..Default::default() },
</a><a href="#h3-0-10" id="h3-0-10" class="i">+                service::QueryRequest {
</a><a href="#h3-0-11" id="h3-0-11" class="i">+                    query: query.to_owned(),
</a><a href="#h3-0-12" id="h3-0-12" class="i">+                    txn_id: txn_id.unwrap_or(0),
</a><a href="#h3-0-13" id="h3-0-13" class="i">+                    ..Default::default()
</a><a href="#h3-0-14" id="h3-0-14" class="i">+                },
</a>             )
             .wait()?;
         ResultSet::from_grpc(metadata, iter)
<a href="#h3-1" id="h3-1" class="h">@@ -61,6 +65,7 @@ impl Client {
</a> 
 /// A query result set
 pub struct ResultSet {
<a href="#h3-1-3" id="h3-1-3" class="i">+    txn_id: Option&lt;u64&gt;,
</a>     columns: Vec&lt;String&gt;,
     rows: Box&lt;dyn Iterator&lt;Item = Result&lt;service::Row, grpc::Error&gt;&gt;&gt;,
 }
<a href="#h3-2" id="h3-2" class="h">@@ -89,12 +94,20 @@ impl ResultSet {
</a>         let columns =
             deserialize(metadata.get(&quot;columns&quot;).map(|c| c.to_vec()).unwrap_or_else(Vec::new))
                 .unwrap_or_else(|_| Vec::new());
<a href="#h3-2-3" id="h3-2-3" class="d">-        Ok(Self { columns, rows })
</a><a href="#h3-2-4" id="h3-2-4" class="i">+        let txn_id = match metadata.get(&quot;txn_id&quot;) {
</a><a href="#h3-2-5" id="h3-2-5" class="i">+            Some(v) =&gt; deserialize(v.to_vec()).ok(),
</a><a href="#h3-2-6" id="h3-2-6" class="i">+            None =&gt; None,
</a><a href="#h3-2-7" id="h3-2-7" class="i">+        };
</a><a href="#h3-2-8" id="h3-2-8" class="i">+        Ok(Self { columns, rows, txn_id })
</a>     }
 
     pub fn columns(&amp;self) -&gt; Vec&lt;String&gt; {
         self.columns.clone()
     }
<a href="#h3-2-14" id="h3-2-14" class="i">+
</a><a href="#h3-2-15" id="h3-2-15" class="i">+    pub fn txn_id(&amp;self) -&gt; Option&lt;u64&gt; {
</a><a href="#h3-2-16" id="h3-2-16" class="i">+        self.txn_id
</a><a href="#h3-2-17" id="h3-2-17" class="i">+    }
</a> }
 
 /// Server status
<b>diff --git a/<a id="h4" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -27,6 +27,12 @@ impl&lt;S: Storage&gt; MVCC&lt;S&gt; {
</a>     pub fn begin_readonly(&amp;self, version: Option&lt;u64&gt;) -&gt; Result&lt;Transaction&lt;S&gt;, Error&gt; {
         Transaction::new_readonly(self.storage.clone(), version)
     }
<a href="#h4-0-3" id="h4-0-3" class="i">+
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    /// Resumes a transaction
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    #[allow(dead_code)]
</a><a href="#h4-0-6" id="h4-0-6" class="i">+    pub fn resume(&amp;self, id: u64) -&gt; Result&lt;Transaction&lt;S&gt;, Error&gt; {
</a><a href="#h4-0-7" id="h4-0-7" class="i">+        Transaction::new_resume(self.storage.clone(), id)
</a><a href="#h4-0-8" id="h4-0-8" class="i">+    }
</a> }
 
 /// An MVCC transaction
<a href="#h4-1" id="h4-1" class="h">@@ -35,19 +41,12 @@ pub struct Transaction&lt;S: Storage&gt; {
</a>     id: u64,
     readonly: bool,
     invisible: HashSet&lt;u64&gt;,
<a href="#h4-1-3" id="h4-1-3" class="d">-    updated: HashSet&lt;Vec&lt;u8&gt;&gt;,
</a> }
 
 impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
     /// Creates a new transaction
     fn new(storage: Arc&lt;RwLock&lt;S&gt;&gt;) -&gt; Result&lt;Self, Error&gt; {
<a href="#h4-1-9" id="h4-1-9" class="d">-        let mut txn = Self {
</a><a href="#h4-1-10" id="h4-1-10" class="d">-            storage,
</a><a href="#h4-1-11" id="h4-1-11" class="d">-            id: 0,
</a><a href="#h4-1-12" id="h4-1-12" class="d">-            readonly: false,
</a><a href="#h4-1-13" id="h4-1-13" class="d">-            invisible: HashSet::new(),
</a><a href="#h4-1-14" id="h4-1-14" class="d">-            updated: HashSet::new(),
</a><a href="#h4-1-15" id="h4-1-15" class="d">-        };
</a><a href="#h4-1-16" id="h4-1-16" class="i">+        let mut txn = Self { storage, id: 0, readonly: false, invisible: HashSet::new() };
</a>         {
             let mut storage = txn.storage.write()?;
             txn.id = match storage.read(&amp;Key::TxnNext.encode())? {
<a href="#h4-2" id="h4-2" class="h">@@ -55,7 +54,6 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>                 None =&gt; 0,
             };
             storage.write(&amp;Key::TxnNext.encode(), serialize(txn.id + 1)?)?;
<a href="#h4-2-3" id="h4-2-3" class="d">-            storage.write(&amp;Key::TxnActive(txn.id).encode(), serialize(true)?)?;
</a> 
             for r in storage.scan(&amp;Key::TxnActive(0).encode()..&amp;Key::TxnActive(txn.id).encode()) {
                 let (k, _) = r?;
<a href="#h4-3" id="h4-3" class="h">@@ -64,6 +62,7 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>                     _ =&gt; return Err(Error::Value(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
                 };
             }
<a href="#h4-3-3" id="h4-3-3" class="i">+            storage.write(&amp;Key::TxnActive(txn.id).encode(), serialize(txn.invisible.clone())?)?;
</a>         }
         Ok(txn)
     }
<a href="#h4-4" id="h4-4" class="h">@@ -78,13 +77,7 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>         if id &gt;= next_id {
             return Err(Error::Value(&quot;Can&#39;t start read-only transaction in the future&quot;.into()));
         }
<a href="#h4-4-3" id="h4-4-3" class="d">-        let mut txn = Self {
</a><a href="#h4-4-4" id="h4-4-4" class="d">-            storage,
</a><a href="#h4-4-5" id="h4-4-5" class="d">-            id,
</a><a href="#h4-4-6" id="h4-4-6" class="d">-            readonly: true,
</a><a href="#h4-4-7" id="h4-4-7" class="d">-            invisible: HashSet::new(),
</a><a href="#h4-4-8" id="h4-4-8" class="d">-            updated: HashSet::new(),
</a><a href="#h4-4-9" id="h4-4-9" class="d">-        };
</a><a href="#h4-4-10" id="h4-4-10" class="i">+        let mut txn = Self { storage, id, readonly: true, invisible: HashSet::new() };
</a>         for r in
             txn.storage.read()?.scan(&amp;Key::TxnActive(0).encode()..=&amp;Key::TxnActive(txn.id).encode())
         {
<a href="#h4-5" id="h4-5" class="h">@@ -97,6 +90,18 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>         Ok(txn)
     }
 
<a href="#h4-5-3" id="h4-5-3" class="i">+    /// Resumes a transaction
</a><a href="#h4-5-4" id="h4-5-4" class="i">+    fn new_resume(storage: Arc&lt;RwLock&lt;S&gt;&gt;, id: u64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h4-5-5" id="h4-5-5" class="i">+        let key = Key::TxnActive(id).encode();
</a><a href="#h4-5-6" id="h4-5-6" class="i">+        let mut txn = Self { storage, id, readonly: false, invisible: HashSet::new() };
</a><a href="#h4-5-7" id="h4-5-7" class="i">+        if let Some(v) = txn.storage.read()?.read(&amp;key)? {
</a><a href="#h4-5-8" id="h4-5-8" class="i">+            txn.invisible = deserialize(v)?;
</a><a href="#h4-5-9" id="h4-5-9" class="i">+        } else {
</a><a href="#h4-5-10" id="h4-5-10" class="i">+            return Err(Error::Value(format!(&quot;Unable to resume non-existant transaction {}&quot;, id)));
</a><a href="#h4-5-11" id="h4-5-11" class="i">+        };
</a><a href="#h4-5-12" id="h4-5-12" class="i">+        Ok(txn)
</a><a href="#h4-5-13" id="h4-5-13" class="i">+    }
</a><a href="#h4-5-14" id="h4-5-14" class="i">+
</a>     /// Returns the transaction ID
     pub fn id(&amp;self) -&gt; u64 {
         self.id
<a href="#h4-6" id="h4-6" class="h">@@ -114,8 +119,16 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>     pub fn rollback(self) -&gt; Result&lt;(), Error&gt; {
         if !self.readonly {
             let mut storage = self.storage.write()?;
<a href="#h4-6-3" id="h4-6-3" class="d">-            for key in self.updated.iter() {
</a><a href="#h4-6-4" id="h4-6-4" class="d">-                storage.remove(key)?;
</a><a href="#h4-6-5" id="h4-6-5" class="i">+            let start = Key::TxnUpdatedStart(self.id).encode();
</a><a href="#h4-6-6" id="h4-6-6" class="i">+            let end = Key::TxnUpdatedEnd(self.id).encode();
</a><a href="#h4-6-7" id="h4-6-7" class="i">+            for r in storage.scan(start..end).rev() {
</a><a href="#h4-6-8" id="h4-6-8" class="i">+                let (k, _) = r?;
</a><a href="#h4-6-9" id="h4-6-9" class="i">+                if let Key::TxnUpdated(_, key) = Key::decode(k.clone())? {
</a><a href="#h4-6-10" id="h4-6-10" class="i">+                    storage.remove(&amp;key)?;
</a><a href="#h4-6-11" id="h4-6-11" class="i">+                    storage.remove(&amp;k)?;
</a><a href="#h4-6-12" id="h4-6-12" class="i">+                } else {
</a><a href="#h4-6-13" id="h4-6-13" class="i">+                    return Err(Error::Internal(&quot;Unexpected key&quot;.into()));
</a><a href="#h4-6-14" id="h4-6-14" class="i">+                }
</a>             }
             storage.remove(&amp;Key::TxnActive(self.id).encode())?;
         }
<a href="#h4-7" id="h4-7" class="h">@@ -129,9 +142,11 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>         if self.is_dirty(&amp;mut storage, key)? {
             return Err(Error::Serialization);
         }
<a href="#h4-7-3" id="h4-7-3" class="i">+
</a>         let key = Key::Record(key.to_vec(), self.id).encode();
<a href="#h4-7-5" id="h4-7-5" class="i">+        let update_key = Key::TxnUpdated(self.id, key.clone()).encode();
</a><a href="#h4-7-6" id="h4-7-6" class="i">+        storage.write(&amp;update_key, Vec::new())?;
</a>         storage.write(&amp;key, Value::Delete.encode())?;
<a href="#h4-7-8" id="h4-7-8" class="d">-        self.updated.insert(key);
</a>         Ok(())
     }
 
<a href="#h4-8" id="h4-8" class="h">@@ -183,8 +198,9 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>             return Err(Error::Serialization);
         }
         let key = Key::Record(key.to_vec(), self.id).encode();
<a href="#h4-8-3" id="h4-8-3" class="i">+        let update_key = Key::TxnUpdated(self.id, key.clone()).encode();
</a><a href="#h4-8-4" id="h4-8-4" class="i">+        storage.write(&amp;update_key, Vec::new())?;
</a>         storage.write(&amp;key, Value::Set(value).encode())?;
<a href="#h4-8-6" id="h4-8-6" class="d">-        self.updated.insert(key);
</a>         Ok(())
     }
 
<a href="#h4-9" id="h4-9" class="h">@@ -319,6 +335,9 @@ impl DoubleEndedIterator for Scan {
</a> enum Key {
     TxnNext,
     TxnActive(u64),
<a href="#h4-9-3" id="h4-9-3" class="i">+    TxnUpdatedStart(u64),
</a><a href="#h4-9-4" id="h4-9-4" class="i">+    TxnUpdated(u64, Vec&lt;u8&gt;),
</a><a href="#h4-9-5" id="h4-9-5" class="i">+    TxnUpdatedEnd(u64),
</a>     Record(Vec&lt;u8&gt;, u64),
     RecordStart,
     RecordEnd,
<a href="#h4-10" id="h4-10" class="h">@@ -338,6 +357,25 @@ impl Key {
</a>                 id.copy_from_slice(&amp;bytes[..]);
                 Ok(Key::TxnActive(u64::from_be_bytes(id)))
             }
<a href="#h4-10-3" id="h4-10-3" class="i">+            Some(0x03) =&gt; {
</a><a href="#h4-10-4" id="h4-10-4" class="i">+                let bytes: Vec&lt;u8&gt; = iter.collect();
</a><a href="#h4-10-5" id="h4-10-5" class="i">+                if bytes.len() &lt; 10 {
</a><a href="#h4-10-6" id="h4-10-6" class="i">+                    return Err(Error::Value(&quot;Unable to parse MVCC update key&quot;.into()));
</a><a href="#h4-10-7" id="h4-10-7" class="i">+                }
</a><a href="#h4-10-8" id="h4-10-8" class="i">+                let mut id = [0; 8];
</a><a href="#h4-10-9" id="h4-10-9" class="i">+                id.copy_from_slice(&amp;bytes[0..8]);
</a><a href="#h4-10-10" id="h4-10-10" class="i">+                let id = u64::from_be_bytes(id);
</a><a href="#h4-10-11" id="h4-10-11" class="i">+                if bytes.len() == 10 {
</a><a href="#h4-10-12" id="h4-10-12" class="i">+                    return match bytes[9] {
</a><a href="#h4-10-13" id="h4-10-13" class="i">+                        0x00 =&gt; Ok(Key::TxnUpdatedStart(id)),
</a><a href="#h4-10-14" id="h4-10-14" class="i">+                        0xff =&gt; Ok(Key::TxnUpdatedEnd(id)),
</a><a href="#h4-10-15" id="h4-10-15" class="i">+                        _ =&gt; return Err(Error::Value(&quot;Invalid MVCC update key&quot;.into())),
</a><a href="#h4-10-16" id="h4-10-16" class="i">+                    };
</a><a href="#h4-10-17" id="h4-10-17" class="i">+                }
</a><a href="#h4-10-18" id="h4-10-18" class="i">+
</a><a href="#h4-10-19" id="h4-10-19" class="i">+                let key = bytes[9..].to_vec();
</a><a href="#h4-10-20" id="h4-10-20" class="i">+                Ok(Key::TxnUpdated(id, key))
</a><a href="#h4-10-21" id="h4-10-21" class="i">+            }
</a> 
             Some(0xf1) =&gt; {
                 let mut key: Vec&lt;u8&gt; = iter.collect();
<a href="#h4-11" id="h4-11" class="h">@@ -359,6 +397,13 @@ impl Key {
</a>         match self {
             Self::TxnNext =&gt; vec![0x01],
             Self::TxnActive(id) =&gt; [vec![0x02], id.to_be_bytes().to_vec()].concat(),
<a href="#h4-11-3" id="h4-11-3" class="i">+            Self::TxnUpdatedStart(id) =&gt; {
</a><a href="#h4-11-4" id="h4-11-4" class="i">+                [vec![0x03], id.to_be_bytes().to_vec(), vec![0x00]].concat()
</a><a href="#h4-11-5" id="h4-11-5" class="i">+            }
</a><a href="#h4-11-6" id="h4-11-6" class="i">+            Self::TxnUpdated(id, key) =&gt; {
</a><a href="#h4-11-7" id="h4-11-7" class="i">+                [vec![0x03], id.to_be_bytes().to_vec(), vec![0x00], key].concat()
</a><a href="#h4-11-8" id="h4-11-8" class="i">+            }
</a><a href="#h4-11-9" id="h4-11-9" class="i">+            Self::TxnUpdatedEnd(id) =&gt; [vec![0x03], id.to_be_bytes().to_vec(), vec![0xff]].concat(),
</a>             Self::RecordStart =&gt; vec![0xf0],
             Self::Record(key, version) =&gt; {
                 // We have to use 0x00 as a key/version separator, and use 0x00 0xff as an
<a href="#h4-12" id="h4-12" class="h">@@ -450,7 +495,7 @@ pub mod tests {
</a>     }
 
     #[test]
<a href="#h4-12-3" id="h4-12-3" class="d">-    fn test_begin_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-12-4" id="h4-12-4" class="i">+    fn test_begin_readonly() -&gt; Result&lt;(), Error&gt; {
</a>         let mvcc = setup();
 
         let txn = mvcc.begin_readonly(None)?;
<a href="#h4-13" id="h4-13" class="h">@@ -476,6 +521,59 @@ pub mod tests {
</a>     }
 
     #[test]
<a href="#h4-13-3" id="h4-13-3" class="i">+    fn test_resume() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-13-4" id="h4-13-4" class="i">+        let mvcc = setup();
</a><a href="#h4-13-5" id="h4-13-5" class="i">+
</a><a href="#h4-13-6" id="h4-13-6" class="i">+        // We first write a set of values that should be visible
</a><a href="#h4-13-7" id="h4-13-7" class="i">+        let mut t0 = mvcc.begin()?;
</a><a href="#h4-13-8" id="h4-13-8" class="i">+        t0.set(b&quot;a&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h4-13-9" id="h4-13-9" class="i">+        t0.set(b&quot;b&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h4-13-10" id="h4-13-10" class="i">+        t0.commit()?;
</a><a href="#h4-13-11" id="h4-13-11" class="i">+
</a><a href="#h4-13-12" id="h4-13-12" class="i">+        // We then start three transactions, of which we will resume t2.
</a><a href="#h4-13-13" id="h4-13-13" class="i">+        // We commit t1 and t3&#39;s changes, which should not be visible,
</a><a href="#h4-13-14" id="h4-13-14" class="i">+        // and write a change for t2 which should be visible.
</a><a href="#h4-13-15" id="h4-13-15" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h4-13-16" id="h4-13-16" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h4-13-17" id="h4-13-17" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h4-13-18" id="h4-13-18" class="i">+
</a><a href="#h4-13-19" id="h4-13-19" class="i">+        t1.set(b&quot;a&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h4-13-20" id="h4-13-20" class="i">+        t2.set(b&quot;b&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h4-13-21" id="h4-13-21" class="i">+        t3.set(b&quot;c&quot;, b&quot;t3&quot;.to_vec())?;
</a><a href="#h4-13-22" id="h4-13-22" class="i">+
</a><a href="#h4-13-23" id="h4-13-23" class="i">+        t1.commit()?;
</a><a href="#h4-13-24" id="h4-13-24" class="i">+        t3.commit()?;
</a><a href="#h4-13-25" id="h4-13-25" class="i">+
</a><a href="#h4-13-26" id="h4-13-26" class="i">+        // We now resume t2, who should see it&#39;s own changes but none
</a><a href="#h4-13-27" id="h4-13-27" class="i">+        // of the others&#39;
</a><a href="#h4-13-28" id="h4-13-28" class="i">+        let id = t2.id();
</a><a href="#h4-13-29" id="h4-13-29" class="i">+        std::mem::drop(t2);
</a><a href="#h4-13-30" id="h4-13-30" class="i">+        let tr = mvcc.resume(id)?;
</a><a href="#h4-13-31" id="h4-13-31" class="i">+
</a><a href="#h4-13-32" id="h4-13-32" class="i">+        assert_eq!(Some(b&quot;t0&quot;.to_vec()), tr.get(b&quot;a&quot;)?);
</a><a href="#h4-13-33" id="h4-13-33" class="i">+        assert_eq!(Some(b&quot;t2&quot;.to_vec()), tr.get(b&quot;b&quot;)?);
</a><a href="#h4-13-34" id="h4-13-34" class="i">+        assert_eq!(None, tr.get(b&quot;c&quot;)?);
</a><a href="#h4-13-35" id="h4-13-35" class="i">+
</a><a href="#h4-13-36" id="h4-13-36" class="i">+        // A separate transaction should not see t2&#39;s changes, but should see the others
</a><a href="#h4-13-37" id="h4-13-37" class="i">+        let t = mvcc.begin_readonly(None)?;
</a><a href="#h4-13-38" id="h4-13-38" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h4-13-39" id="h4-13-39" class="i">+        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h4-13-40" id="h4-13-40" class="i">+        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h4-13-41" id="h4-13-41" class="i">+        t.rollback()?;
</a><a href="#h4-13-42" id="h4-13-42" class="i">+
</a><a href="#h4-13-43" id="h4-13-43" class="i">+        // Once tr commits, a separate transaction should see t2&#39;s changes
</a><a href="#h4-13-44" id="h4-13-44" class="i">+        tr.commit()?;
</a><a href="#h4-13-45" id="h4-13-45" class="i">+
</a><a href="#h4-13-46" id="h4-13-46" class="i">+        let t = mvcc.begin_readonly(None)?;
</a><a href="#h4-13-47" id="h4-13-47" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h4-13-48" id="h4-13-48" class="i">+        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h4-13-49" id="h4-13-49" class="i">+        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h4-13-50" id="h4-13-50" class="i">+        t.rollback()?;
</a><a href="#h4-13-51" id="h4-13-51" class="i">+
</a><a href="#h4-13-52" id="h4-13-52" class="i">+        Ok(())
</a><a href="#h4-13-53" id="h4-13-53" class="i">+    }
</a><a href="#h4-13-54" id="h4-13-54" class="i">+
</a><a href="#h4-13-55" id="h4-13-55" class="i">+    #[test]
</a>     fn test_txn_delete_conflict() -&gt; Result&lt;(), Error&gt; {
         let mvcc = setup();
 
<b>diff --git a/<a id="h5" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -58,7 +58,8 @@ impl service::ToyDB for ToyDB {
</a>         _: grpc::RequestOptions,
         req: service::QueryRequest,
     ) -&gt; grpc::StreamingResponse&lt;service::Row&gt; {
<a href="#h5-0-3" id="h5-0-3" class="d">-        let result = match self.execute(&amp;req.query) {
</a><a href="#h5-0-4" id="h5-0-4" class="i">+        let txn_id = if req.txn_id &gt; 0 { Some(req.txn_id) } else { None };
</a><a href="#h5-0-5" id="h5-0-5" class="i">+        let result = match self.execute(txn_id, &amp;req.query) {
</a>             Ok(result) =&gt; result,
             Err(err) =&gt; {
                 return grpc::StreamingResponse::completed(vec![service::Row {
<a href="#h5-1" id="h5-1" class="h">@@ -70,6 +71,9 @@ impl service::ToyDB for ToyDB {
</a>         let mut metadata = grpc::Metadata::new();
         metadata
             .add(grpc::MetadataKey::from(&quot;columns&quot;), serialize(result.columns()).unwrap().into());
<a href="#h5-1-3" id="h5-1-3" class="i">+        if let Some(txn_id) = result.txn_id() {
</a><a href="#h5-1-4" id="h5-1-4" class="i">+            metadata.add(grpc::MetadataKey::from(&quot;txn_id&quot;), serialize(txn_id).unwrap().into());
</a><a href="#h5-1-5" id="h5-1-5" class="i">+        }
</a>         grpc::StreamingResponse::iter_with_metadata(
             metadata,
             result.map(|r| match r {
<a href="#h5-2" id="h5-2" class="h">@@ -96,13 +100,61 @@ impl service::ToyDB for ToyDB {
</a> 
 impl ToyDB {
     /// Executes an SQL statement
<a href="#h5-2-3" id="h5-2-3" class="d">-    fn execute(&amp;self, query: &amp;str) -&gt; Result&lt;sql::types::ResultSet, Error&gt; {
</a><a href="#h5-2-4" id="h5-2-4" class="d">-        let mut txn = self.engine.begin()?;
</a><a href="#h5-2-5" id="h5-2-5" class="d">-        let rs = sql::Plan::build(sql::Parser::new(query).parse()?)?
</a><a href="#h5-2-6" id="h5-2-6" class="d">-            .optimize()?
</a><a href="#h5-2-7" id="h5-2-7" class="d">-            .execute(sql::Context { txn: &amp;mut txn })?;
</a><a href="#h5-2-8" id="h5-2-8" class="d">-        txn.commit()?;
</a><a href="#h5-2-9" id="h5-2-9" class="d">-        Ok(rs)
</a><a href="#h5-2-10" id="h5-2-10" class="i">+    fn execute(&amp;self, txn_id: Option&lt;u64&gt;, query: &amp;str) -&gt; Result&lt;sql::types::ResultSet, Error&gt; {
</a><a href="#h5-2-11" id="h5-2-11" class="i">+        let statement = sql::Parser::new(query).parse()?;
</a><a href="#h5-2-12" id="h5-2-12" class="i">+
</a><a href="#h5-2-13" id="h5-2-13" class="i">+        // Handle statements in an ongoing transaction
</a><a href="#h5-2-14" id="h5-2-14" class="i">+        if let Some(txn_id) = txn_id {
</a><a href="#h5-2-15" id="h5-2-15" class="i">+            let mut txn = self.engine.resume(txn_id)?;
</a><a href="#h5-2-16" id="h5-2-16" class="i">+            return match statement {
</a><a href="#h5-2-17" id="h5-2-17" class="i">+                sql::ast::Statement::Begin =&gt; {
</a><a href="#h5-2-18" id="h5-2-18" class="i">+                    Err(Error::Value(format!(&quot;Already in a transaction (id {})&quot;, txn_id)))
</a><a href="#h5-2-19" id="h5-2-19" class="i">+                }
</a><a href="#h5-2-20" id="h5-2-20" class="i">+                sql::ast::Statement::Commit =&gt; {
</a><a href="#h5-2-21" id="h5-2-21" class="i">+                    txn.commit()?;
</a><a href="#h5-2-22" id="h5-2-22" class="i">+                    Ok(sql::types::ResultSet::empty())
</a><a href="#h5-2-23" id="h5-2-23" class="i">+                }
</a><a href="#h5-2-24" id="h5-2-24" class="i">+                sql::ast::Statement::Rollback =&gt; {
</a><a href="#h5-2-25" id="h5-2-25" class="i">+                    txn.rollback()?;
</a><a href="#h5-2-26" id="h5-2-26" class="i">+                    Ok(sql::types::ResultSet::empty())
</a><a href="#h5-2-27" id="h5-2-27" class="i">+                }
</a><a href="#h5-2-28" id="h5-2-28" class="i">+                _ =&gt; {
</a><a href="#h5-2-29" id="h5-2-29" class="i">+                    let mut rs = sql::Plan::build(statement)?
</a><a href="#h5-2-30" id="h5-2-30" class="i">+                        .optimize()?
</a><a href="#h5-2-31" id="h5-2-31" class="i">+                        .execute(sql::Context { txn: &amp;mut txn })?;
</a><a href="#h5-2-32" id="h5-2-32" class="i">+                    // FIXME Shouldn&#39;t be necessary
</a><a href="#h5-2-33" id="h5-2-33" class="i">+                    rs.txn_id = Some(txn_id);
</a><a href="#h5-2-34" id="h5-2-34" class="i">+                    Ok(rs)
</a><a href="#h5-2-35" id="h5-2-35" class="i">+                }
</a><a href="#h5-2-36" id="h5-2-36" class="i">+            };
</a><a href="#h5-2-37" id="h5-2-37" class="i">+        }
</a><a href="#h5-2-38" id="h5-2-38" class="i">+
</a><a href="#h5-2-39" id="h5-2-39" class="i">+        // Handle standalone statements
</a><a href="#h5-2-40" id="h5-2-40" class="i">+        match statement {
</a><a href="#h5-2-41" id="h5-2-41" class="i">+            sql::ast::Statement::Begin =&gt; {
</a><a href="#h5-2-42" id="h5-2-42" class="i">+                let txn = self.engine.begin()?;
</a><a href="#h5-2-43" id="h5-2-43" class="i">+                Ok(sql::types::ResultSet::from_begin(txn.id()))
</a><a href="#h5-2-44" id="h5-2-44" class="i">+            }
</a><a href="#h5-2-45" id="h5-2-45" class="i">+            sql::ast::Statement::Commit | sql::ast::Statement::Rollback =&gt; {
</a><a href="#h5-2-46" id="h5-2-46" class="i">+                Err(Error::Value(&quot;Not in a transaction&quot;.into()))
</a><a href="#h5-2-47" id="h5-2-47" class="i">+            }
</a><a href="#h5-2-48" id="h5-2-48" class="i">+            sql::ast::Statement::Select { .. } =&gt; {
</a><a href="#h5-2-49" id="h5-2-49" class="i">+                let mut txn = self.engine.snapshot(None)?;
</a><a href="#h5-2-50" id="h5-2-50" class="i">+                let result = sql::Plan::build(statement)?
</a><a href="#h5-2-51" id="h5-2-51" class="i">+                    .optimize()?
</a><a href="#h5-2-52" id="h5-2-52" class="i">+                    .execute(sql::Context { txn: &amp;mut txn });
</a><a href="#h5-2-53" id="h5-2-53" class="i">+                txn.commit()?;
</a><a href="#h5-2-54" id="h5-2-54" class="i">+                result
</a><a href="#h5-2-55" id="h5-2-55" class="i">+            }
</a><a href="#h5-2-56" id="h5-2-56" class="i">+            _ =&gt; {
</a><a href="#h5-2-57" id="h5-2-57" class="i">+                let mut txn = self.engine.begin()?;
</a><a href="#h5-2-58" id="h5-2-58" class="i">+                let result = sql::Plan::build(statement)?
</a><a href="#h5-2-59" id="h5-2-59" class="i">+                    .optimize()?
</a><a href="#h5-2-60" id="h5-2-60" class="i">+                    .execute(sql::Context { txn: &amp;mut txn });
</a><a href="#h5-2-61" id="h5-2-61" class="i">+                txn.commit()?;
</a><a href="#h5-2-62" id="h5-2-62" class="i">+                result
</a><a href="#h5-2-63" id="h5-2-63" class="i">+            }
</a><a href="#h5-2-64" id="h5-2-64" class="i">+        }
</a>     }
 
     /// Converts an error into a protobuf object
<b>diff --git a/<a id="h6" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -16,10 +16,19 @@ impl&lt;S: kv::storage::Storage&gt; KV&lt;S&gt; {
</a> 
 impl&lt;S: kv::storage::Storage&gt; super::Engine for KV&lt;S&gt; {
     type Transaction = Transaction&lt;S&gt;;
<a href="#h6-0-3" id="h6-0-3" class="i">+    type Snapshot = Transaction&lt;S&gt;;
</a> 
     fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt; {
         Ok(Self::Transaction::new(self.kv.begin()?))
     }
<a href="#h6-0-8" id="h6-0-8" class="i">+
</a><a href="#h6-0-9" id="h6-0-9" class="i">+    fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h6-0-10" id="h6-0-10" class="i">+        Ok(Self::Transaction::new(self.kv.resume(id)?))
</a><a href="#h6-0-11" id="h6-0-11" class="i">+    }
</a><a href="#h6-0-12" id="h6-0-12" class="i">+
</a><a href="#h6-0-13" id="h6-0-13" class="i">+    fn snapshot(&amp;self, version: Option&lt;u64&gt;) -&gt; Result&lt;Self::Snapshot, Error&gt; {
</a><a href="#h6-0-14" id="h6-0-14" class="i">+        Ok(Self::Transaction::new(self.kv.begin_readonly(version)?))
</a><a href="#h6-0-15" id="h6-0-15" class="i">+    }
</a> }
 
 pub struct Transaction&lt;S: kv::storage::Storage&gt; {
<b>diff --git a/<a id="h7" href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a> b/<a href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -10,8 +10,11 @@ use crate::Error;
</a> 
 pub trait Engine {
     type Transaction: Transaction;
<a href="#h7-0-3" id="h7-0-3" class="i">+    type Snapshot: Transaction;
</a> 
     fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt;;
<a href="#h7-0-6" id="h7-0-6" class="i">+    fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt;;
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    fn snapshot(&amp;self, version: Option&lt;u64&gt;) -&gt; Result&lt;Self::Snapshot, Error&gt;;
</a> }
 
 pub trait Transaction {
<b>diff --git a/<a id="h8" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -6,7 +6,6 @@ use crate::kv;
</a> use crate::raft;
 use crate::utility::{deserialize, serialize};
 use crate::Error;
<a href="#h8-0-3" id="h8-0-3" class="d">-use std::collections::HashMap;
</a> 
 /// A state machine mutation
 #[derive(Clone, Debug, Serialize, Deserialize)]
<a href="#h8-1" id="h8-1" class="h">@@ -26,11 +25,21 @@ enum Mutation {
</a> /// A state machine query
 #[derive(Clone, Debug, Serialize, Deserialize)]
 enum Query {
<a href="#h8-1-3" id="h8-1-3" class="i">+    BeginReadOnly(Option&lt;u64&gt;),
</a><a href="#h8-1-4" id="h8-1-4" class="i">+    Resume(u64),
</a><a href="#h8-1-5" id="h8-1-5" class="i">+
</a>     Read { txn_id: u64, table: String, id: types::Value },
     Scan { txn_id: u64, table: String },
 
     ListTables { txn_id: u64 },
     ReadTable { txn_id: u64, table: String },
<a href="#h8-1-11" id="h8-1-11" class="i">+
</a><a href="#h8-1-12" id="h8-1-12" class="i">+    // FIXME Snapshot queries shouldn&#39;t be separate variants
</a><a href="#h8-1-13" id="h8-1-13" class="i">+    ReadSnapshot { version: u64, table: String, id: types::Value },
</a><a href="#h8-1-14" id="h8-1-14" class="i">+    ScanSnapshot { version: u64, table: String },
</a><a href="#h8-1-15" id="h8-1-15" class="i">+
</a><a href="#h8-1-16" id="h8-1-16" class="i">+    ListTablesSnapshot { version: u64 },
</a><a href="#h8-1-17" id="h8-1-17" class="i">+    ReadTableSnapshot { version: u64, table: String },
</a> }
 
 pub struct Raft {
<a href="#h8-2" id="h8-2" class="h">@@ -51,16 +60,25 @@ impl Raft {
</a> 
 impl super::Engine for Raft {
     type Transaction = Transaction;
<a href="#h8-2-3" id="h8-2-3" class="i">+    type Snapshot = Snapshot;
</a> 
     fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt; {
         Transaction::new(self.raft.clone())
     }
<a href="#h8-2-8" id="h8-2-8" class="i">+
</a><a href="#h8-2-9" id="h8-2-9" class="i">+    fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h8-2-10" id="h8-2-10" class="i">+        Transaction::resume(self.raft.clone(), id)
</a><a href="#h8-2-11" id="h8-2-11" class="i">+    }
</a><a href="#h8-2-12" id="h8-2-12" class="i">+
</a><a href="#h8-2-13" id="h8-2-13" class="i">+    fn snapshot(&amp;self, version: Option&lt;u64&gt;) -&gt; Result&lt;Self::Snapshot, Error&gt; {
</a><a href="#h8-2-14" id="h8-2-14" class="i">+        Snapshot::new(self.raft.clone(), version)
</a><a href="#h8-2-15" id="h8-2-15" class="i">+    }
</a> }
 
 #[derive(Clone)]
 pub struct Transaction {
<a href="#h8-2-20" id="h8-2-20" class="d">-    id: u64,
</a>     raft: raft::Raft,
<a href="#h8-2-22" id="h8-2-22" class="i">+    id: u64,
</a> }
 
 impl Transaction {
<a href="#h8-3" id="h8-3" class="h">@@ -68,6 +86,11 @@ impl Transaction {
</a>         let id = deserialize(raft.mutate(serialize(Mutation::Begin)?)?)?;
         Ok(Self { raft, id })
     }
<a href="#h8-3-3" id="h8-3-3" class="i">+
</a><a href="#h8-3-4" id="h8-3-4" class="i">+    fn resume(raft: raft::Raft, id: u64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h8-3-5" id="h8-3-5" class="i">+        let id = deserialize(raft.query(serialize(Query::Resume(id))?)?)?;
</a><a href="#h8-3-6" id="h8-3-6" class="i">+        Ok(Self { raft, id })
</a><a href="#h8-3-7" id="h8-3-7" class="i">+    }
</a> }
 
 impl super::Transaction for Transaction {
<a href="#h8-4" id="h8-4" class="h">@@ -157,10 +180,88 @@ impl super::Transaction for Transaction {
</a>     }
 }
 
<a href="#h8-4-3" id="h8-4-3" class="i">+#[derive(Clone)]
</a><a href="#h8-4-4" id="h8-4-4" class="i">+pub struct Snapshot {
</a><a href="#h8-4-5" id="h8-4-5" class="i">+    raft: raft::Raft,
</a><a href="#h8-4-6" id="h8-4-6" class="i">+    version: u64,
</a><a href="#h8-4-7" id="h8-4-7" class="i">+}
</a><a href="#h8-4-8" id="h8-4-8" class="i">+
</a><a href="#h8-4-9" id="h8-4-9" class="i">+impl Snapshot {
</a><a href="#h8-4-10" id="h8-4-10" class="i">+    fn new(raft: raft::Raft, version: Option&lt;u64&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h8-4-11" id="h8-4-11" class="i">+        let version = deserialize(raft.query(serialize(Query::BeginReadOnly(version))?)?)?;
</a><a href="#h8-4-12" id="h8-4-12" class="i">+        Ok(Self { raft, version })
</a><a href="#h8-4-13" id="h8-4-13" class="i">+    }
</a><a href="#h8-4-14" id="h8-4-14" class="i">+}
</a><a href="#h8-4-15" id="h8-4-15" class="i">+
</a><a href="#h8-4-16" id="h8-4-16" class="i">+impl super::Transaction for Snapshot {
</a><a href="#h8-4-17" id="h8-4-17" class="i">+    fn id(&amp;self) -&gt; u64 {
</a><a href="#h8-4-18" id="h8-4-18" class="i">+        self.version
</a><a href="#h8-4-19" id="h8-4-19" class="i">+    }
</a><a href="#h8-4-20" id="h8-4-20" class="i">+
</a><a href="#h8-4-21" id="h8-4-21" class="i">+    fn commit(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-22" id="h8-4-22" class="i">+        Ok(())
</a><a href="#h8-4-23" id="h8-4-23" class="i">+    }
</a><a href="#h8-4-24" id="h8-4-24" class="i">+
</a><a href="#h8-4-25" id="h8-4-25" class="i">+    fn rollback(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-26" id="h8-4-26" class="i">+        Ok(())
</a><a href="#h8-4-27" id="h8-4-27" class="i">+    }
</a><a href="#h8-4-28" id="h8-4-28" class="i">+
</a><a href="#h8-4-29" id="h8-4-29" class="i">+    fn create(&amp;mut self, _table: &amp;str, _row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-30" id="h8-4-30" class="i">+        Err(Error::ReadOnly)
</a><a href="#h8-4-31" id="h8-4-31" class="i">+    }
</a><a href="#h8-4-32" id="h8-4-32" class="i">+
</a><a href="#h8-4-33" id="h8-4-33" class="i">+    fn delete(&amp;mut self, _table: &amp;str, _id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-34" id="h8-4-34" class="i">+        Err(Error::ReadOnly)
</a><a href="#h8-4-35" id="h8-4-35" class="i">+    }
</a><a href="#h8-4-36" id="h8-4-36" class="i">+
</a><a href="#h8-4-37" id="h8-4-37" class="i">+    fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
</a><a href="#h8-4-38" id="h8-4-38" class="i">+        deserialize(self.raft.query(serialize(Query::ReadSnapshot {
</a><a href="#h8-4-39" id="h8-4-39" class="i">+            version: self.version,
</a><a href="#h8-4-40" id="h8-4-40" class="i">+            table: table.into(),
</a><a href="#h8-4-41" id="h8-4-41" class="i">+            id: id.clone(),
</a><a href="#h8-4-42" id="h8-4-42" class="i">+        })?)?)
</a><a href="#h8-4-43" id="h8-4-43" class="i">+    }
</a><a href="#h8-4-44" id="h8-4-44" class="i">+
</a><a href="#h8-4-45" id="h8-4-45" class="i">+    fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
</a><a href="#h8-4-46" id="h8-4-46" class="i">+        Ok(Box::new(
</a><a href="#h8-4-47" id="h8-4-47" class="i">+            deserialize::&lt;Vec&lt;types::Row&gt;&gt;(self.raft.query(serialize(Query::ScanSnapshot {
</a><a href="#h8-4-48" id="h8-4-48" class="i">+                version: self.version,
</a><a href="#h8-4-49" id="h8-4-49" class="i">+                table: table.into(),
</a><a href="#h8-4-50" id="h8-4-50" class="i">+            })?)?)?
</a><a href="#h8-4-51" id="h8-4-51" class="i">+            .into_iter()
</a><a href="#h8-4-52" id="h8-4-52" class="i">+            .map(Ok),
</a><a href="#h8-4-53" id="h8-4-53" class="i">+        ))
</a><a href="#h8-4-54" id="h8-4-54" class="i">+    }
</a><a href="#h8-4-55" id="h8-4-55" class="i">+
</a><a href="#h8-4-56" id="h8-4-56" class="i">+    fn update(&amp;mut self, _table: &amp;str, _id: &amp;types::Value, _row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-57" id="h8-4-57" class="i">+        Err(Error::ReadOnly)
</a><a href="#h8-4-58" id="h8-4-58" class="i">+    }
</a><a href="#h8-4-59" id="h8-4-59" class="i">+
</a><a href="#h8-4-60" id="h8-4-60" class="i">+    fn create_table(&amp;mut self, _table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-61" id="h8-4-61" class="i">+        Err(Error::ReadOnly)
</a><a href="#h8-4-62" id="h8-4-62" class="i">+    }
</a><a href="#h8-4-63" id="h8-4-63" class="i">+
</a><a href="#h8-4-64" id="h8-4-64" class="i">+    fn delete_table(&amp;mut self, _table: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-4-65" id="h8-4-65" class="i">+        Err(Error::ReadOnly)
</a><a href="#h8-4-66" id="h8-4-66" class="i">+    }
</a><a href="#h8-4-67" id="h8-4-67" class="i">+
</a><a href="#h8-4-68" id="h8-4-68" class="i">+    fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h8-4-69" id="h8-4-69" class="i">+        deserialize(
</a><a href="#h8-4-70" id="h8-4-70" class="i">+            self.raft.query(serialize(Query::ListTablesSnapshot { version: self.version })?)?,
</a><a href="#h8-4-71" id="h8-4-71" class="i">+        )
</a><a href="#h8-4-72" id="h8-4-72" class="i">+    }
</a><a href="#h8-4-73" id="h8-4-73" class="i">+
</a><a href="#h8-4-74" id="h8-4-74" class="i">+    fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h8-4-75" id="h8-4-75" class="i">+        deserialize(self.raft.query(serialize(Query::ReadTableSnapshot {
</a><a href="#h8-4-76" id="h8-4-76" class="i">+            version: self.version,
</a><a href="#h8-4-77" id="h8-4-77" class="i">+            table: table.into(),
</a><a href="#h8-4-78" id="h8-4-78" class="i">+        })?)?)
</a><a href="#h8-4-79" id="h8-4-79" class="i">+    }
</a><a href="#h8-4-80" id="h8-4-80" class="i">+}
</a><a href="#h8-4-81" id="h8-4-81" class="i">+
</a> /// The underlying state machine for the Raft-based engine
 pub struct State&lt;S: kv::storage::Storage&gt; {
     engine: super::KV&lt;S&gt;,
<a href="#h8-4-85" id="h8-4-85" class="d">-    txns: HashMap&lt;u64, &lt;super::KV&lt;S&gt; as super::Engine&gt;::Transaction&gt;,
</a> }
 
 impl&lt;S: kv::storage::Storage&gt; std::fmt::Debug for State&lt;S&gt; {
<a href="#h8-5" id="h8-5" class="h">@@ -171,95 +272,74 @@ impl&lt;S: kv::storage::Storage&gt; std::fmt::Debug for State&lt;S&gt; {
</a> 
 impl&lt;S: kv::storage::Storage&gt; State&lt;S&gt; {
     pub fn new(store: kv::MVCC&lt;S&gt;) -&gt; Self {
<a href="#h8-5-3" id="h8-5-3" class="d">-        State { engine: super::KV::new(store), txns: HashMap::new() }
</a><a href="#h8-5-4" id="h8-5-4" class="i">+        State { engine: super::KV::new(store) }
</a>     }
 }
 
 impl&lt;S: kv::storage::Storage&gt; raft::State for State&lt;S&gt; {
     fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
         match deserialize(command)? {
<a href="#h8-5-11" id="h8-5-11" class="d">-            Mutation::Begin =&gt; {
</a><a href="#h8-5-12" id="h8-5-12" class="d">-                let txn = self.engine.begin()?;
</a><a href="#h8-5-13" id="h8-5-13" class="d">-                let txn_id = txn.id();
</a><a href="#h8-5-14" id="h8-5-14" class="d">-                self.txns.insert(txn_id, txn);
</a><a href="#h8-5-15" id="h8-5-15" class="d">-                serialize(txn_id)
</a><a href="#h8-5-16" id="h8-5-16" class="d">-            }
</a><a href="#h8-5-17" id="h8-5-17" class="d">-            Mutation::Commit(txn_id) =&gt; serialize(
</a><a href="#h8-5-18" id="h8-5-18" class="d">-                self.txns
</a><a href="#h8-5-19" id="h8-5-19" class="d">-                    .remove(&amp;txn_id)
</a><a href="#h8-5-20" id="h8-5-20" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-21" id="h8-5-21" class="d">-                    .commit()?,
</a><a href="#h8-5-22" id="h8-5-22" class="d">-            ),
</a><a href="#h8-5-23" id="h8-5-23" class="d">-            Mutation::Rollback(txn_id) =&gt; serialize(
</a><a href="#h8-5-24" id="h8-5-24" class="d">-                self.txns
</a><a href="#h8-5-25" id="h8-5-25" class="d">-                    .remove(&amp;txn_id)
</a><a href="#h8-5-26" id="h8-5-26" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-27" id="h8-5-27" class="d">-                    .rollback()?,
</a><a href="#h8-5-28" id="h8-5-28" class="d">-            ),
</a><a href="#h8-5-29" id="h8-5-29" class="i">+            Mutation::Begin =&gt; serialize(self.engine.begin()?.id()),
</a><a href="#h8-5-30" id="h8-5-30" class="i">+            Mutation::Commit(txn_id) =&gt; serialize(self.engine.resume(txn_id)?.commit()?),
</a><a href="#h8-5-31" id="h8-5-31" class="i">+            Mutation::Rollback(txn_id) =&gt; serialize(self.engine.resume(txn_id)?.rollback()?),
</a> 
<a href="#h8-5-33" id="h8-5-33" class="d">-            Mutation::Create { txn_id, table, row } =&gt; serialize(
</a><a href="#h8-5-34" id="h8-5-34" class="d">-                self.txns
</a><a href="#h8-5-35" id="h8-5-35" class="d">-                    .get_mut(&amp;txn_id)
</a><a href="#h8-5-36" id="h8-5-36" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-37" id="h8-5-37" class="d">-                    .create(&amp;table, row)?,
</a><a href="#h8-5-38" id="h8-5-38" class="d">-            ),
</a><a href="#h8-5-39" id="h8-5-39" class="d">-            Mutation::Delete { txn_id, table, id } =&gt; serialize(
</a><a href="#h8-5-40" id="h8-5-40" class="d">-                self.txns
</a><a href="#h8-5-41" id="h8-5-41" class="d">-                    .get_mut(&amp;txn_id)
</a><a href="#h8-5-42" id="h8-5-42" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-43" id="h8-5-43" class="d">-                    .delete(&amp;table, &amp;id)?,
</a><a href="#h8-5-44" id="h8-5-44" class="d">-            ),
</a><a href="#h8-5-45" id="h8-5-45" class="d">-            Mutation::Update { txn_id, table, id, row } =&gt; serialize(
</a><a href="#h8-5-46" id="h8-5-46" class="d">-                self.txns
</a><a href="#h8-5-47" id="h8-5-47" class="d">-                    .get_mut(&amp;txn_id)
</a><a href="#h8-5-48" id="h8-5-48" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-49" id="h8-5-49" class="d">-                    .update(&amp;table, &amp;id, row)?,
</a><a href="#h8-5-50" id="h8-5-50" class="d">-            ),
</a><a href="#h8-5-51" id="h8-5-51" class="i">+            Mutation::Create { txn_id, table, row } =&gt; {
</a><a href="#h8-5-52" id="h8-5-52" class="i">+                serialize(self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a><a href="#h8-5-53" id="h8-5-53" class="i">+            }
</a><a href="#h8-5-54" id="h8-5-54" class="i">+            Mutation::Delete { txn_id, table, id } =&gt; {
</a><a href="#h8-5-55" id="h8-5-55" class="i">+                serialize(self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a><a href="#h8-5-56" id="h8-5-56" class="i">+            }
</a><a href="#h8-5-57" id="h8-5-57" class="i">+            Mutation::Update { txn_id, table, id, row } =&gt; {
</a><a href="#h8-5-58" id="h8-5-58" class="i">+                serialize(self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a><a href="#h8-5-59" id="h8-5-59" class="i">+            }
</a> 
<a href="#h8-5-61" id="h8-5-61" class="d">-            Mutation::CreateTable { txn_id, schema } =&gt; serialize(
</a><a href="#h8-5-62" id="h8-5-62" class="d">-                self.txns
</a><a href="#h8-5-63" id="h8-5-63" class="d">-                    .get_mut(&amp;txn_id)
</a><a href="#h8-5-64" id="h8-5-64" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-65" id="h8-5-65" class="d">-                    .create_table(&amp;schema)?,
</a><a href="#h8-5-66" id="h8-5-66" class="d">-            ),
</a><a href="#h8-5-67" id="h8-5-67" class="d">-            Mutation::DeleteTable { txn_id, table } =&gt; serialize(
</a><a href="#h8-5-68" id="h8-5-68" class="d">-                self.txns
</a><a href="#h8-5-69" id="h8-5-69" class="d">-                    .get_mut(&amp;txn_id)
</a><a href="#h8-5-70" id="h8-5-70" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-71" id="h8-5-71" class="d">-                    .delete_table(&amp;table)?,
</a><a href="#h8-5-72" id="h8-5-72" class="d">-            ),
</a><a href="#h8-5-73" id="h8-5-73" class="i">+            Mutation::CreateTable { txn_id, schema } =&gt; {
</a><a href="#h8-5-74" id="h8-5-74" class="i">+                serialize(self.engine.resume(txn_id)?.create_table(&amp;schema)?)
</a><a href="#h8-5-75" id="h8-5-75" class="i">+            }
</a><a href="#h8-5-76" id="h8-5-76" class="i">+            Mutation::DeleteTable { txn_id, table } =&gt; {
</a><a href="#h8-5-77" id="h8-5-77" class="i">+                serialize(self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a><a href="#h8-5-78" id="h8-5-78" class="i">+            }
</a>         }
     }
 
     fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
         match deserialize(command)? {
<a href="#h8-5-84" id="h8-5-84" class="d">-            Query::Read { txn_id, table, id } =&gt; serialize(
</a><a href="#h8-5-85" id="h8-5-85" class="d">-                self.txns
</a><a href="#h8-5-86" id="h8-5-86" class="d">-                    .get(&amp;txn_id)
</a><a href="#h8-5-87" id="h8-5-87" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-88" id="h8-5-88" class="d">-                    .read(&amp;table, &amp;id)?,
</a><a href="#h8-5-89" id="h8-5-89" class="d">-            ),
</a><a href="#h8-5-90" id="h8-5-90" class="i">+            Query::BeginReadOnly(version) =&gt; serialize(self.engine.snapshot(version)?.id()),
</a><a href="#h8-5-91" id="h8-5-91" class="i">+            Query::Resume(id) =&gt; serialize(self.engine.resume(id)?.id()),
</a><a href="#h8-5-92" id="h8-5-92" class="i">+
</a><a href="#h8-5-93" id="h8-5-93" class="i">+            Query::Read { txn_id, table, id } =&gt; {
</a><a href="#h8-5-94" id="h8-5-94" class="i">+                serialize(self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a><a href="#h8-5-95" id="h8-5-95" class="i">+            }
</a><a href="#h8-5-96" id="h8-5-96" class="i">+            // FIXME This needs to stream rows
</a>             Query::Scan { txn_id, table } =&gt; serialize(
<a href="#h8-5-98" id="h8-5-98" class="d">-                // FIXME This needs to stream rows
</a><a href="#h8-5-99" id="h8-5-99" class="d">-                self.txns
</a><a href="#h8-5-100" id="h8-5-100" class="d">-                    .get(&amp;txn_id)
</a><a href="#h8-5-101" id="h8-5-101" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-102" id="h8-5-102" class="i">+                self.engine
</a><a href="#h8-5-103" id="h8-5-103" class="i">+                    .resume(txn_id)?
</a>                     .scan(&amp;table)?
                     .collect::&lt;Result&lt;Vec&lt;types::Row&gt;, Error&gt;&gt;()?,
             ),
 
<a href="#h8-5-108" id="h8-5-108" class="d">-            Query::ListTables { txn_id } =&gt; serialize(
</a><a href="#h8-5-109" id="h8-5-109" class="d">-                self.txns
</a><a href="#h8-5-110" id="h8-5-110" class="d">-                    .get(&amp;txn_id)
</a><a href="#h8-5-111" id="h8-5-111" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-112" id="h8-5-112" class="d">-                    .list_tables()?,
</a><a href="#h8-5-113" id="h8-5-113" class="d">-            ),
</a><a href="#h8-5-114" id="h8-5-114" class="d">-            Query::ReadTable { txn_id, table } =&gt; serialize(
</a><a href="#h8-5-115" id="h8-5-115" class="d">-                self.txns
</a><a href="#h8-5-116" id="h8-5-116" class="d">-                    .get(&amp;txn_id)
</a><a href="#h8-5-117" id="h8-5-117" class="d">-                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h8-5-118" id="h8-5-118" class="d">-                    .read_table(&amp;table)?,
</a><a href="#h8-5-119" id="h8-5-119" class="i">+            Query::ListTables { txn_id } =&gt; serialize(self.engine.resume(txn_id)?.list_tables()?),
</a><a href="#h8-5-120" id="h8-5-120" class="i">+            Query::ReadTable { txn_id, table } =&gt; {
</a><a href="#h8-5-121" id="h8-5-121" class="i">+                serialize(self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a><a href="#h8-5-122" id="h8-5-122" class="i">+            }
</a><a href="#h8-5-123" id="h8-5-123" class="i">+
</a><a href="#h8-5-124" id="h8-5-124" class="i">+            Query::ReadSnapshot { version, table, id } =&gt; {
</a><a href="#h8-5-125" id="h8-5-125" class="i">+                serialize(self.engine.snapshot(Some(version))?.read(&amp;table, &amp;id)?)
</a><a href="#h8-5-126" id="h8-5-126" class="i">+            }
</a><a href="#h8-5-127" id="h8-5-127" class="i">+            // FIXME This needs to stream rows
</a><a href="#h8-5-128" id="h8-5-128" class="i">+            Query::ScanSnapshot { version, table } =&gt; serialize(
</a><a href="#h8-5-129" id="h8-5-129" class="i">+                self.engine
</a><a href="#h8-5-130" id="h8-5-130" class="i">+                    .snapshot(Some(version))?
</a><a href="#h8-5-131" id="h8-5-131" class="i">+                    .scan(&amp;table)?
</a><a href="#h8-5-132" id="h8-5-132" class="i">+                    .collect::&lt;Result&lt;Vec&lt;types::Row&gt;, Error&gt;&gt;()?,
</a>             ),
<a href="#h8-5-134" id="h8-5-134" class="i">+
</a><a href="#h8-5-135" id="h8-5-135" class="i">+            Query::ListTablesSnapshot { version } =&gt; {
</a><a href="#h8-5-136" id="h8-5-136" class="i">+                serialize(self.engine.snapshot(Some(version))?.list_tables()?)
</a><a href="#h8-5-137" id="h8-5-137" class="i">+            }
</a><a href="#h8-5-138" id="h8-5-138" class="i">+            Query::ReadTableSnapshot { version, table } =&gt; {
</a><a href="#h8-5-139" id="h8-5-139" class="i">+                serialize(self.engine.snapshot(Some(version))?.read_table(&amp;table)?)
</a><a href="#h8-5-140" id="h8-5-140" class="i">+            }
</a>         }
     }
 }
<b>diff --git a/<a id="h9" href="../file/src/sql/types.rs.html">src/sql/types.rs</a> b/<a href="../file/src/sql/types.rs.html">src/sql/types.rs</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -117,20 +117,38 @@ pub type Row = Vec&lt;Value&gt;;
</a> 
 /// A result set
 pub struct ResultSet {
<a href="#h9-0-3" id="h9-0-3" class="i">+    // FIXME Shouldn&#39;t be public
</a><a href="#h9-0-4" id="h9-0-4" class="i">+    pub txn_id: Option&lt;u64&gt;,
</a>     columns: Vec&lt;String&gt;,
     executor: Option&lt;Box&lt;dyn Executor&gt;&gt;,
 }
 
 impl ResultSet {
<a href="#h9-0-10" id="h9-0-10" class="i">+    /// Creates an empty result set, mostly used for transaction commit and rollback
</a><a href="#h9-0-11" id="h9-0-11" class="i">+    pub fn empty() -&gt; Self {
</a><a href="#h9-0-12" id="h9-0-12" class="i">+        Self { txn_id: None, columns: Vec::new(), executor: None }
</a><a href="#h9-0-13" id="h9-0-13" class="i">+    }
</a><a href="#h9-0-14" id="h9-0-14" class="i">+
</a><a href="#h9-0-15" id="h9-0-15" class="i">+    /// Creates a result set for a transaction begin
</a><a href="#h9-0-16" id="h9-0-16" class="i">+    pub fn from_begin(txn_id: u64) -&gt; Self {
</a><a href="#h9-0-17" id="h9-0-17" class="i">+        Self { txn_id: Some(txn_id), columns: Vec::new(), executor: None }
</a><a href="#h9-0-18" id="h9-0-18" class="i">+    }
</a><a href="#h9-0-19" id="h9-0-19" class="i">+
</a>     /// Creates a result set from an executor
     pub fn from_executor(executor: Box&lt;dyn Executor&gt;) -&gt; Self {
<a href="#h9-0-22" id="h9-0-22" class="d">-        Self { columns: executor.columns(), executor: Some(executor) }
</a><a href="#h9-0-23" id="h9-0-23" class="i">+        Self { txn_id: None, columns: executor.columns(), executor: Some(executor) }
</a>     }
 
     /// Fetches the columns of the result set
     pub fn columns(&amp;self) -&gt; Vec&lt;String&gt; {
         self.columns.clone()
     }
<a href="#h9-0-30" id="h9-0-30" class="i">+
</a><a href="#h9-0-31" id="h9-0-31" class="i">+    /// Fetches the active transaction ID after the statement was executed
</a><a href="#h9-0-32" id="h9-0-32" class="i">+    /// (i.e. Some after BEGIN but None after COMMIT/ROLLBACK)
</a><a href="#h9-0-33" id="h9-0-33" class="i">+    pub fn txn_id(&amp;self) -&gt; Option&lt;u64&gt; {
</a><a href="#h9-0-34" id="h9-0-34" class="i">+        self.txn_id
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    }
</a> }
 
 impl Iterator for ResultSet {
</pre>
</div>
</body>
</html>
