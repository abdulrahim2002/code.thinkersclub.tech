<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>kv: minor mvcc cleanups - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/ac4c1918ef47986e1efa791a005e41cc73fe3cfe.html">ac4c1918ef47986e1efa791a005e41cc73fe3cfe</a>
<b>parent</b> <a href="../commit/410c862dc460e0dab901626c408d607f386dae38.html">410c862dc460e0dab901626c408d607f386dae38</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 17 Dec 2019 21:53:31 +0100

kv: minor mvcc cleanups

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/kv/mvcc.rs</a></td><td> | </td><td class="num">53</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
</table></pre><pre>1 file changed, 26 insertions(+), 27 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -100,7 +100,6 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>         // for any future snapshot transactions looking at this one.
         let mut snapshot = Snapshot::take(&amp;mut session, id)?;
         std::mem::drop(session);
<a href="#h0-0-3" id="h0-0-3" class="d">-
</a>         if let Mode::Snapshot { version } = &amp;mode {
             snapshot = Snapshot::restore(&amp;storage.read()?, *version)?
         }
<a href="#h0-1" id="h0-1" class="h">@@ -133,34 +132,31 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>         self.mode.clone()
     }
 
<a href="#h0-1-3" id="h0-1-3" class="d">-    /// Commits the transaction
</a><a href="#h0-1-4" id="h0-1-4" class="i">+    /// Commits the transaction.
</a>     pub fn commit(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h0-1-6" id="h0-1-6" class="d">-        self.storage.write()?.remove(&amp;Key::TxnActive(self.id).encode())?;
</a><a href="#h0-1-7" id="h0-1-7" class="d">-        Ok(())
</a><a href="#h0-1-8" id="h0-1-8" class="i">+        self.storage.write()?.remove(&amp;Key::TxnActive(self.id).encode())
</a>     }
 
     /// Rolls back the transaction
     pub fn rollback(self) -&gt; Result&lt;(), Error&gt; {
         let mut session = self.storage.write()?;
         if self.mode.is_mutable() {
<a href="#h0-1-15" id="h0-1-15" class="d">-            let start = Key::TxnUpdatedStart(self.id).encode();
</a><a href="#h0-1-16" id="h0-1-16" class="d">-            let end = Key::TxnUpdatedEnd(self.id).encode();
</a><a href="#h0-1-17" id="h0-1-17" class="d">-            let mut keys: Vec&lt;Vec&lt;u8&gt;&gt; = vec![];
</a><a href="#h0-1-18" id="h0-1-18" class="d">-            for r in session.scan(start..end).rev() {
</a><a href="#h0-1-19" id="h0-1-19" class="d">-                let (k, _) = r?;
</a><a href="#h0-1-20" id="h0-1-20" class="d">-                if let Key::TxnUpdated(_, key) = Key::decode(k.clone())? {
</a><a href="#h0-1-21" id="h0-1-21" class="d">-                    keys.push(key.clone());
</a><a href="#h0-1-22" id="h0-1-22" class="d">-                    keys.push(k.clone());
</a><a href="#h0-1-23" id="h0-1-23" class="d">-                } else {
</a><a href="#h0-1-24" id="h0-1-24" class="d">-                    return Err(Error::Internal(&quot;Unexpected key&quot;.into()));
</a><a href="#h0-1-25" id="h0-1-25" class="i">+            let mut keys: Vec&lt;Vec&lt;u8&gt;&gt; = Vec::new();
</a><a href="#h0-1-26" id="h0-1-26" class="i">+            let mut scan = session
</a><a href="#h0-1-27" id="h0-1-27" class="i">+                .scan(&amp;Key::TxnUpdateStart(self.id).encode()..&amp;Key::TxnUpdateEnd(self.id).encode());
</a><a href="#h0-1-28" id="h0-1-28" class="i">+            while let Some((key, _)) = scan.next().transpose()? {
</a><a href="#h0-1-29" id="h0-1-29" class="i">+                keys.push(key.clone());
</a><a href="#h0-1-30" id="h0-1-30" class="i">+                match Key::decode(key)? {
</a><a href="#h0-1-31" id="h0-1-31" class="i">+                    Key::TxnUpdate(_, k) =&gt; keys.push(k),
</a><a href="#h0-1-32" id="h0-1-32" class="i">+                    _ =&gt; return Err(Error::Internal(&quot;Unexpected key, wanted TxnUpdated&quot;.into())),
</a>                 }
             }
<a href="#h0-1-35" id="h0-1-35" class="i">+            std::mem::drop(scan);
</a>             for key in keys.into_iter() {
                 session.remove(&amp;key)?;
             }
         }
<a href="#h0-1-40" id="h0-1-40" class="d">-        session.remove(&amp;Key::TxnActive(self.id).encode())?;
</a><a href="#h0-1-41" id="h0-1-41" class="d">-        Ok(())
</a><a href="#h0-1-42" id="h0-1-42" class="i">+        session.remove(&amp;Key::TxnActive(self.id).encode())
</a>     }
 
     /// Deletes a key
<a href="#h0-2" id="h0-2" class="h">@@ -172,7 +168,7 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>         }
 
         let key = Key::Record(key.to_vec(), self.id).encode();
<a href="#h0-2-3" id="h0-2-3" class="d">-        let update_key = Key::TxnUpdated(self.id, key.clone()).encode();
</a><a href="#h0-2-4" id="h0-2-4" class="i">+        let update_key = Key::TxnUpdate(self.id, key.clone()).encode();
</a>         storage.write(&amp;update_key, Vec::new())?;
         storage.write(&amp;key, Value::Delete.encode())?;
         Ok(())
<a href="#h0-3" id="h0-3" class="h">@@ -209,7 +205,7 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>             return Err(Error::Serialization);
         }
         let key = Key::Record(key.to_vec(), self.id).encode();
<a href="#h0-3-3" id="h0-3-3" class="d">-        let update_key = Key::TxnUpdated(self.id, key.clone()).encode();
</a><a href="#h0-3-4" id="h0-3-4" class="i">+        let update_key = Key::TxnUpdate(self.id, key.clone()).encode();
</a>         storage.write(&amp;update_key, Vec::new())?;
         storage.write(&amp;key, Value::Set(value).encode())?;
         Ok(())
<a href="#h0-4" id="h0-4" class="h">@@ -412,9 +408,12 @@ enum Key {
</a>     TxnActive(u64),
     /// Transaction snapshot, containing concurrent transactions at start.
     TxnSnapshot(u64),
<a href="#h0-4-3" id="h0-4-3" class="d">-    TxnUpdatedStart(u64),
</a><a href="#h0-4-4" id="h0-4-4" class="d">-    TxnUpdated(u64, Vec&lt;u8&gt;),
</a><a href="#h0-4-5" id="h0-4-5" class="d">-    TxnUpdatedEnd(u64),
</a><a href="#h0-4-6" id="h0-4-6" class="i">+    /// Start of transaction update range for a given transaction ID.
</a><a href="#h0-4-7" id="h0-4-7" class="i">+    TxnUpdateStart(u64),
</a><a href="#h0-4-8" id="h0-4-8" class="i">+    /// Update entry for a transaction ID and key.
</a><a href="#h0-4-9" id="h0-4-9" class="i">+    TxnUpdate(u64, Vec&lt;u8&gt;),
</a><a href="#h0-4-10" id="h0-4-10" class="i">+    /// End of transaction update range for a given transaction ID.
</a><a href="#h0-4-11" id="h0-4-11" class="i">+    TxnUpdateEnd(u64),
</a>     Record(Vec&lt;u8&gt;, u64),
     RecordStart,
     RecordEnd,
<a href="#h0-5" id="h0-5" class="h">@@ -453,14 +452,14 @@ impl Key {
</a>                 let id = u64::from_be_bytes(id);
                 if bytes.len() == 10 {
                     return match bytes[9] {
<a href="#h0-5-3" id="h0-5-3" class="d">-                        0x00 =&gt; Ok(Key::TxnUpdatedStart(id)),
</a><a href="#h0-5-4" id="h0-5-4" class="d">-                        0xff =&gt; Ok(Key::TxnUpdatedEnd(id)),
</a><a href="#h0-5-5" id="h0-5-5" class="i">+                        0x00 =&gt; Ok(Key::TxnUpdateStart(id)),
</a><a href="#h0-5-6" id="h0-5-6" class="i">+                        0xff =&gt; Ok(Key::TxnUpdateEnd(id)),
</a>                         _ =&gt; return Err(Error::Value(&quot;Invalid MVCC update key&quot;.into())),
                     };
                 }
 
                 let key = bytes[9..].to_vec();
<a href="#h0-5-12" id="h0-5-12" class="d">-                Ok(Key::TxnUpdated(id, key))
</a><a href="#h0-5-13" id="h0-5-13" class="i">+                Ok(Key::TxnUpdate(id, key))
</a>             }
             Some(0xf1) =&gt; {
                 let mut key: Vec&lt;u8&gt; = iter.collect();
<a href="#h0-6" id="h0-6" class="h">@@ -483,13 +482,13 @@ impl Key {
</a>             Self::TxnNext =&gt; vec![0x01],
             Self::TxnActive(id) =&gt; [vec![0x02], id.to_be_bytes().to_vec()].concat(),
             Self::TxnSnapshot(version) =&gt; [vec![0x03], version.to_be_bytes().to_vec()].concat(),
<a href="#h0-6-3" id="h0-6-3" class="d">-            Self::TxnUpdatedStart(id) =&gt; {
</a><a href="#h0-6-4" id="h0-6-4" class="i">+            Self::TxnUpdateStart(id) =&gt; {
</a>                 [vec![0x04], id.to_be_bytes().to_vec(), vec![0x00]].concat()
             }
<a href="#h0-6-7" id="h0-6-7" class="d">-            Self::TxnUpdated(id, key) =&gt; {
</a><a href="#h0-6-8" id="h0-6-8" class="i">+            Self::TxnUpdate(id, key) =&gt; {
</a>                 [vec![0x04], id.to_be_bytes().to_vec(), vec![0x00], key].concat()
             }
<a href="#h0-6-11" id="h0-6-11" class="d">-            Self::TxnUpdatedEnd(id) =&gt; [vec![0x04], id.to_be_bytes().to_vec(), vec![0xff]].concat(),
</a><a href="#h0-6-12" id="h0-6-12" class="i">+            Self::TxnUpdateEnd(id) =&gt; [vec![0x04], id.to_be_bytes().to_vec(), vec![0xff]].concat(),
</a>             Self::RecordStart =&gt; vec![0xf0],
             Self::Record(key, version) =&gt; {
                 // We have to use 0x00 as a key/version separator, and use 0x00 0xff as an
</pre>
</div>
</body>
</html>
