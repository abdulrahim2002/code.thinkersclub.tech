<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>toysql: support multi-line query editing (fixes #36) - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7b38683e91d2f1c9f0fc70e26d59b49e033025b7.html">7b38683e91d2f1c9f0fc70e26d59b49e033025b7</a>
<b>parent</b> <a href="../commit/39d68cf6f50dc4f689ed670eea8007459d5c2ae6.html">39d68cf6f50dc4f689ed670eea8007459d5c2ae6</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Thu, 11 Jun 2020 23:48:18 +0200

toysql: support multi-line query editing (fixes #36)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">README.md</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/bin/toysql.rs</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/parser/lexer.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/parser/mod.rs</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
</table></pre><pre>6 files changed, 96 insertions(+), 21 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -194,6 +194,15 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-0-3" id="h0-0-3" class="i">+name = &quot;dirs-next&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+version = &quot;1.0.1&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+dependencies = [
</a><a href="#h0-0-7" id="h0-0-7" class="i">+ &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-8" id="h0-0-8" class="i">+ &quot;dirs-sys-next 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+]
</a><a href="#h0-0-10" id="h0-0-10" class="i">+
</a><a href="#h0-0-11" id="h0-0-11" class="i">+[[package]]
</a> name = &quot;dirs-sys&quot;
 version = &quot;0.3.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-1" id="h0-1" class="h">@@ -205,6 +214,16 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-1-3" id="h0-1-3" class="i">+name = &quot;dirs-sys-next&quot;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+version = &quot;0.1.0&quot;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+dependencies = [
</a><a href="#h0-1-7" id="h0-1-7" class="i">+ &quot;libc 0.2.69 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-1-8" id="h0-1-8" class="i">+ &quot;redox_users 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-1-9" id="h0-1-9" class="i">+ &quot;winapi 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-1-10" id="h0-1-10" class="i">+]
</a><a href="#h0-1-11" id="h0-1-11" class="i">+
</a><a href="#h0-1-12" id="h0-1-12" class="i">+[[package]]
</a> name = &quot;fnv&quot;
 version = &quot;1.0.6&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-2" id="h0-2" class="h">@@ -778,11 +797,11 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;rustyline&quot;
<a href="#h0-2-3" id="h0-2-3" class="d">-version = &quot;6.1.2&quot;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+version = &quot;6.2.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-2-8" id="h0-2-8" class="d">- &quot;dirs 2.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+ &quot;dirs-next 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;libc 0.2.69 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;memchr 2.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-3" id="h0-3" class="h">@@ -795,6 +814,15 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-3-3" id="h0-3-3" class="i">+name = &quot;rustyline-derive&quot;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+version = &quot;0.3.1&quot;
</a><a href="#h0-3-5" id="h0-3-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-6" id="h0-3-6" class="i">+dependencies = [
</a><a href="#h0-3-7" id="h0-3-7" class="i">+ &quot;quote 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-8" id="h0-3-8" class="i">+ &quot;syn 1.0.18 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-9" id="h0-3-9" class="i">+]
</a><a href="#h0-3-10" id="h0-3-10" class="i">+
</a><a href="#h0-3-11" id="h0-3-11" class="i">+[[package]]
</a> name = &quot;ryu&quot;
 version = &quot;1.0.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-4" id="h0-4" class="h">@@ -1064,7 +1092,8 @@ dependencies = [
</a>  &quot;pretty_assertions 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rand 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;regex 1.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-4-3" id="h0-4-3" class="d">- &quot;rustyline 6.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-4-4" id="h0-4-4" class="i">+ &quot;rustyline 6.2.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-4-5" id="h0-4-5" class="i">+ &quot;rustyline-derive 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;serde 1.0.106 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde_derive 1.0.106 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serial_test 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-5" id="h0-5" class="h">@@ -1197,7 +1226,9 @@ dependencies = [
</a> &quot;checksum derivative 2.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;cb582b60359da160a9477ee80f15c8d784c477e69c217ef2cdd4169c24ea380f&quot;
 &quot;checksum difference 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;524cbf6897b527295dff137cec09ecf3a05f4fddffd7dfcd1585403449e74198&quot;
 &quot;checksum dirs 2.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;13aea89a5c93364a98e9b37b2fa237effbb694d5cfe01c5b70941f7eb087d5e3&quot;
<a href="#h0-5-3" id="h0-5-3" class="i">+&quot;checksum dirs-next 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1cbcf9241d9e8d106295bd496bbe2e9cffd5fa098f2a8c9e2bbcbf09773c11a8&quot;
</a> &quot;checksum dirs-sys 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;afa0b23de8fd801745c471deffa6e12d248f962c9fd4b4c33787b055599bde7b&quot;
<a href="#h0-5-5" id="h0-5-5" class="i">+&quot;checksum dirs-sys-next 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9c60f7b8a8953926148223260454befb50c751d3c50e1c178c4fd1ace4083c9a&quot;
</a> &quot;checksum fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2fad85553e09a6f881f739c29f0b00b0f01357c743266d478b68951ce23285f3&quot;
 &quot;checksum fuchsia-cprng 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a06f77d526c1a601b7c4cdd98f54b5eaabffc14d5f2f0296febdc7f357c6d3ba&quot;
 &quot;checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82&quot;
<a href="#h0-6" id="h0-6" class="h">@@ -1267,7 +1298,8 @@ dependencies = [
</a> &quot;checksum rust-argon2 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2bc8af4bda8e1ff4932523b94d3dd20ee30a87232323eda55903ffd71d2fb017&quot;
 &quot;checksum rust-ini 0.13.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3e52c148ef37f8c375d49d5a73aa70713125b7f19095948a923f80afdeb22ec2&quot;
 &quot;checksum rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;138e3e0acb6c9fb258b19b67cb8abd63c00679d2851805ea151465464fe9030a&quot;
<a href="#h0-6-3" id="h0-6-3" class="d">-&quot;checksum rustyline 6.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1cd20b28d972040c627e209eb29f19c24a71a19d661cc5a220089176e20ee202&quot;
</a><a href="#h0-6-4" id="h0-6-4" class="i">+&quot;checksum rustyline 6.2.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3358c21cbbc1a751892528db4e1de4b7a2b6a73f001e215aaba97d712cfa9777&quot;
</a><a href="#h0-6-5" id="h0-6-5" class="i">+&quot;checksum rustyline-derive 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;54a50e29610a5be68d4a586a5cce3bfb572ed2c2a74227e4168444b7bf4e5235&quot;
</a> &quot;checksum ryu 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ed3d612bc64430efeb3f7ee6ef26d590dce0c43249217bddc62112540c7941e1&quot;
 &quot;checksum scopeguard 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d29ab0c6d3fc0ee92fe66e2d99f700eab17a8d57d1c1d3b748380fb20baa78cd&quot;
 &quot;checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403&quot;
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -18,7 +18,8 @@ log = &quot;~0.4.6&quot;
</a> names = &quot;~0.11.0&quot;
 rand = &quot;~0.7.2&quot;
 regex = &quot;~1.3.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-rustyline = &quot;~6.1.2&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+rustyline = &quot;~6.2.0&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="i">+rustyline-derive = &quot;0.3.1&quot;
</a> serde = &quot;~1.0.91&quot;
 serde_derive = &quot;~1.0.91&quot;
 simplelog = &quot;~0.7.4&quot;
<b>diff --git a/<a id="h2" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -40,9 +40,9 @@ toydb&gt;
</a> A basic subset of SQL has been partially implemented, e.g.:
 
 ```
<a href="#h2-0-3" id="h2-0-3" class="d">-toydb&gt; CREATE TABLE movies (id INTEGER PRIMARY KEY, title VARCHAR NOT NULL)
</a><a href="#h2-0-4" id="h2-0-4" class="d">-toydb&gt; INSERT INTO movies VALUES (1, &#39;Sicario&#39;), (2, &#39;Stalker&#39;), (3, &#39;Her&#39;)
</a><a href="#h2-0-5" id="h2-0-5" class="d">-toydb&gt; SELECT * FROM movies
</a><a href="#h2-0-6" id="h2-0-6" class="i">+toydb&gt; CREATE TABLE movies (id INTEGER PRIMARY KEY, title VARCHAR NOT NULL);
</a><a href="#h2-0-7" id="h2-0-7" class="i">+toydb&gt; INSERT INTO movies VALUES (1, &#39;Sicario&#39;), (2, &#39;Stalker&#39;), (3, &#39;Her&#39;);
</a><a href="#h2-0-8" id="h2-0-8" class="i">+toydb&gt; SELECT * FROM movies;
</a> 1|Sicario
 2|Stalker
 3|Her
<a href="#h2-1" id="h2-1" class="h">@@ -51,19 +51,19 @@ toydb&gt; SELECT * FROM movies
</a> ACID transactions are supported via snapshot isolation:
 
 ```
<a href="#h2-1-3" id="h2-1-3" class="d">-toydb&gt; BEGIN
</a><a href="#h2-1-4" id="h2-1-4" class="i">+toydb&gt; BEGIN;
</a> Began transaction 3
<a href="#h2-1-6" id="h2-1-6" class="d">-toydb:3&gt; INSERT INTO movies VALUES (4, &#39;Alien vs. Predator&#39;)
</a><a href="#h2-1-7" id="h2-1-7" class="d">-toydb:3&gt; ROLLBACK
</a><a href="#h2-1-8" id="h2-1-8" class="i">+toydb:3&gt; INSERT INTO movies VALUES (4, &#39;Alien vs. Predator&#39;);
</a><a href="#h2-1-9" id="h2-1-9" class="i">+toydb:3&gt; ROLLBACK;
</a> Rolled back transaction 3
 
<a href="#h2-1-12" id="h2-1-12" class="d">-toydb&gt; BEGIN
</a><a href="#h2-1-13" id="h2-1-13" class="i">+toydb&gt; BEGIN;
</a> Began transaction 4
<a href="#h2-1-15" id="h2-1-15" class="d">-toydb:4&gt; INSERT INTO movies VALUES (4, &#39;Alien&#39;), (5, &#39;Predator&#39;)
</a><a href="#h2-1-16" id="h2-1-16" class="d">-toydb:4&gt; COMMIT
</a><a href="#h2-1-17" id="h2-1-17" class="i">+toydb:4&gt; INSERT INTO movies VALUES (4, &#39;Alien&#39;), (5, &#39;Predator&#39;);
</a><a href="#h2-1-18" id="h2-1-18" class="i">+toydb:4&gt; COMMIT;
</a> Committed transaction 4
 
<a href="#h2-1-21" id="h2-1-21" class="d">-toydb&gt; SELECT * FROM movies
</a><a href="#h2-1-22" id="h2-1-22" class="i">+toydb&gt; SELECT * FROM movies;
</a> 1|Sicario
 2|Stalker
 3|Her
<a href="#h2-2" id="h2-2" class="h">@@ -74,9 +74,9 @@ toydb&gt; SELECT * FROM movies
</a> Time-travel queries are also supported:
 
 ```
<a href="#h2-2-3" id="h2-2-3" class="d">-toydb&gt; BEGIN TRANSACTION READ ONLY AS OF SYSTEM TIME 2
</a><a href="#h2-2-4" id="h2-2-4" class="i">+toydb&gt; BEGIN TRANSACTION READ ONLY AS OF SYSTEM TIME 2;
</a> Began read-only transaction in snapshot of version 2
<a href="#h2-2-6" id="h2-2-6" class="d">-toydb@1&gt; SELECT * FROM movies
</a><a href="#h2-2-7" id="h2-2-7" class="i">+toydb@1&gt; SELECT * FROM movies;
</a> 1|Sicario
 2|Stalker
 3|Her
<b>diff --git a/<a id="h3" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -6,10 +6,13 @@
</a> #![warn(clippy::all)]
 
 use clap::{app_from_crate, crate_authors, crate_description, crate_name, crate_version};
<a href="#h3-0-3" id="h3-0-3" class="i">+use rustyline::validate::{ValidationContext, ValidationResult, Validator};
</a> use rustyline::{error::ReadlineError, Editor};
<a href="#h3-0-5" id="h3-0-5" class="i">+use rustyline_derive::{Completer, Helper, Highlighter, Hinter};
</a> use toydb::error::{Error, Result};
 use toydb::sql::engine::Mode;
 use toydb::sql::execution::ResultSet;
<a href="#h3-0-9" id="h3-0-9" class="i">+use toydb::sql::parser::{Lexer, Token};
</a> use toydb::Client;
 
 #[tokio::main]
<a href="#h3-1" id="h3-1" class="h">@@ -54,7 +57,7 @@ async fn main() -&gt; Result&lt;()&gt; {
</a> /// The ToySQL REPL
 struct ToySQL {
     client: Client,
<a href="#h3-1-3" id="h3-1-3" class="d">-    editor: Editor&lt;()&gt;,
</a><a href="#h3-1-4" id="h3-1-4" class="i">+    editor: Editor&lt;InputValidator&gt;,
</a>     history_path: Option&lt;std::path::PathBuf&gt;,
     show_headers: bool,
 }
<a href="#h3-2" id="h3-2" class="h">@@ -64,7 +67,7 @@ impl ToySQL {
</a>     async fn new(host: &amp;str, port: u16) -&gt; Result&lt;Self&gt; {
         Ok(Self {
             client: Client::new((host, port)).await?,
<a href="#h3-2-3" id="h3-2-3" class="d">-            editor: Editor::&lt;()&gt;::new(),
</a><a href="#h3-2-4" id="h3-2-4" class="i">+            editor: Editor::new(),
</a>             history_path: std::env::var_os(&quot;HOME&quot;)
                 .map(|home| std::path::Path::new(&amp;home).join(&quot;.toysql.history&quot;)),
             show_headers: false,
<a href="#h3-3" id="h3-3" class="h">@@ -110,8 +113,8 @@ impl ToySQL {
</a>             },
             &quot;!help&quot; =&gt; println!(
                 r#&quot;
<a href="#h3-3-3" id="h3-3-3" class="d">-Enter a SQL statement on a single line to execute it and display the result.
</a><a href="#h3-3-4" id="h3-3-4" class="d">-Semicolons are not supported. The following commands are also available:
</a><a href="#h3-3-5" id="h3-3-5" class="i">+Enter a SQL statement terminated by a semicolon (;) to execute it and display the result.
</a><a href="#h3-3-6" id="h3-3-6" class="i">+The following commands are also available:
</a> 
     !headers &lt;on|off&gt;  Enable or disable column headers
     !help              This help message
<a href="#h3-4" id="h3-4" class="h">@@ -233,6 +236,9 @@ SQL txns:  {txns_active} active, {txns} total ({sql_storage} storage)
</a>                 Err(err) =&gt; return Err(err.into()),
             };
         }
<a href="#h3-4-3" id="h3-4-3" class="i">+        self.editor.set_helper(Some(InputValidator));
</a><a href="#h3-4-4" id="h3-4-4" class="i">+        // Make sure multiline pastes are interpreted as normal inputs.
</a><a href="#h3-4-5" id="h3-4-5" class="i">+        self.editor.bind_sequence(rustyline::KeyPress::BracketedPasteStart, rustyline::Cmd::Noop);
</a> 
         let status = self.client.status().await?;
         println!(
<a href="#h3-5" id="h3-5" class="h">@@ -254,3 +260,35 @@ SQL txns:  {txns_active} active, {txns} total ({sql_storage} storage)
</a>         Ok(())
     }
 }
<a href="#h3-5-3" id="h3-5-3" class="i">+
</a><a href="#h3-5-4" id="h3-5-4" class="i">+/// A Rustyline helper for multiline editing. It parses input lines and determines if they make up a
</a><a href="#h3-5-5" id="h3-5-5" class="i">+/// complete command or not.
</a><a href="#h3-5-6" id="h3-5-6" class="i">+#[derive(Completer, Helper, Highlighter, Hinter)]
</a><a href="#h3-5-7" id="h3-5-7" class="i">+struct InputValidator;
</a><a href="#h3-5-8" id="h3-5-8" class="i">+
</a><a href="#h3-5-9" id="h3-5-9" class="i">+impl Validator for InputValidator {
</a><a href="#h3-5-10" id="h3-5-10" class="i">+    fn validate(&amp;self, ctx: &amp;mut ValidationContext) -&gt; rustyline::Result&lt;ValidationResult&gt; {
</a><a href="#h3-5-11" id="h3-5-11" class="i">+        let input = ctx.input();
</a><a href="#h3-5-12" id="h3-5-12" class="i">+
</a><a href="#h3-5-13" id="h3-5-13" class="i">+        // Empty lines and ! commands are fine.
</a><a href="#h3-5-14" id="h3-5-14" class="i">+        if input.is_empty() || input.starts_with(&#39;!&#39;) || input == &quot;;&quot; {
</a><a href="#h3-5-15" id="h3-5-15" class="i">+            return Ok(ValidationResult::Valid(None));
</a><a href="#h3-5-16" id="h3-5-16" class="i">+        }
</a><a href="#h3-5-17" id="h3-5-17" class="i">+
</a><a href="#h3-5-18" id="h3-5-18" class="i">+        // For SQL statements, just look for any semicolon or lexer error and if found accept the
</a><a href="#h3-5-19" id="h3-5-19" class="i">+        // input and rely on the server to do further validation and error handling. Otherwise,
</a><a href="#h3-5-20" id="h3-5-20" class="i">+        // wait for more input.
</a><a href="#h3-5-21" id="h3-5-21" class="i">+        for result in Lexer::new(ctx.input()) {
</a><a href="#h3-5-22" id="h3-5-22" class="i">+            match result {
</a><a href="#h3-5-23" id="h3-5-23" class="i">+                Ok(Token::Semicolon) =&gt; return Ok(ValidationResult::Valid(None)),
</a><a href="#h3-5-24" id="h3-5-24" class="i">+                Err(_) =&gt; return Ok(ValidationResult::Valid(None)),
</a><a href="#h3-5-25" id="h3-5-25" class="i">+                _ =&gt; {}
</a><a href="#h3-5-26" id="h3-5-26" class="i">+            }
</a><a href="#h3-5-27" id="h3-5-27" class="i">+        }
</a><a href="#h3-5-28" id="h3-5-28" class="i">+        Ok(ValidationResult::Incomplete)
</a><a href="#h3-5-29" id="h3-5-29" class="i">+    }
</a><a href="#h3-5-30" id="h3-5-30" class="i">+
</a><a href="#h3-5-31" id="h3-5-31" class="i">+    fn validate_while_typing(&amp;self) -&gt; bool {
</a><a href="#h3-5-32" id="h3-5-32" class="i">+        false
</a><a href="#h3-5-33" id="h3-5-33" class="i">+    }
</a><a href="#h3-5-34" id="h3-5-34" class="i">+}
</a><b>diff --git a/<a id="h4" href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a> b/<a href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -29,6 +29,7 @@ pub enum Token {
</a>     OpenParen,
     CloseParen,
     Comma,
<a href="#h4-0-3" id="h4-0-3" class="i">+    Semicolon,
</a> }
 
 impl std::fmt::Display for Token {
<a href="#h4-1" id="h4-1" class="h">@@ -57,6 +58,7 @@ impl std::fmt::Display for Token {
</a>             Token::OpenParen =&gt; &quot;(&quot;,
             Token::CloseParen =&gt; &quot;)&quot;,
             Token::Comma =&gt; &quot;,&quot;,
<a href="#h4-1-3" id="h4-1-3" class="i">+            Token::Semicolon =&gt; &quot;;&quot;,
</a>         })
     }
 }
<a href="#h4-2" id="h4-2" class="h">@@ -439,6 +441,7 @@ impl&lt;&#39;a&gt; Lexer&lt;&#39;a&gt; {
</a>             &#39;(&#39; =&gt; Some(Token::OpenParen),
             &#39;)&#39; =&gt; Some(Token::CloseParen),
             &#39;,&#39; =&gt; Some(Token::Comma),
<a href="#h4-2-3" id="h4-2-3" class="i">+            &#39;;&#39; =&gt; Some(Token::Semicolon),
</a>             _ =&gt; None,
         })
         .map(|token| match token {
<b>diff --git a/<a id="h5" href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a> b/<a href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -23,6 +23,7 @@ impl&lt;&#39;a&gt; Parser&lt;&#39;a&gt; {
</a>     /// Parses the input string into an AST statement
     pub fn parse(&amp;mut self) -&gt; Result&lt;ast::Statement&gt; {
         let statement = self.parse_statement()?;
<a href="#h5-0-3" id="h5-0-3" class="i">+        self.next_if_token(Token::Semicolon);
</a>         self.next_expect(None)?;
         Ok(statement)
     }
</pre>
</div>
</body>
</html>
