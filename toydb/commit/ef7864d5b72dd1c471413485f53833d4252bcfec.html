<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>utility: borrow inputs for (de)serialize() - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/ef7864d5b72dd1c471413485f53833d4252bcfec.html">ef7864d5b72dd1c471413485f53833d4252bcfec</a>
<b>parent</b> <a href="../commit/871f62892875f8720b894d0b84a4b77977fada8d.html">871f62892875f8720b894d0b84a4b77977fada8d</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 14 Dec 2019 21:41:09 +0100

utility: borrow inputs for (de)serialize()

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/client.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/kv/mvcc.rs</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/log.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/server/toydb.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">71</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/utility/deref.rs</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/utility/serialize.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
</table></pre><pre>8 files changed, 67 insertions(+), 71 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -118,13 +118,8 @@ impl ResultSet {
</a>         metadata: grpc::Metadata,
         rows: Box&lt;dyn std::iter::Iterator&lt;Item = Result&lt;service::Row, grpc::Error&gt;&gt;&gt;,
     ) -&gt; Result&lt;Self, Error&gt; {
<a href="#h0-0-3" id="h0-0-3" class="d">-        let columns =
</a><a href="#h0-0-4" id="h0-0-4" class="d">-            deserialize(metadata.get(&quot;columns&quot;).map(|c| c.to_vec()).unwrap_or_else(Vec::new))
</a><a href="#h0-0-5" id="h0-0-5" class="d">-                .unwrap_or_else(|_| Vec::new());
</a><a href="#h0-0-6" id="h0-0-6" class="d">-        let effect = match metadata.get(&quot;effect&quot;) {
</a><a href="#h0-0-7" id="h0-0-7" class="d">-            Some(v) =&gt; deserialize(v.to_vec()).ok(),
</a><a href="#h0-0-8" id="h0-0-8" class="d">-            None =&gt; None,
</a><a href="#h0-0-9" id="h0-0-9" class="d">-        };
</a><a href="#h0-0-10" id="h0-0-10" class="i">+        let columns = deserialize(metadata.get(&quot;columns&quot;).unwrap_or_else(|| &amp;[]))?;
</a><a href="#h0-0-11" id="h0-0-11" class="i">+        let effect = metadata.get(&quot;effect&quot;).map(deserialize).transpose()?;
</a>         Ok(Self { effect, columns, rows })
     }
 
<b>diff --git a/<a id="h1" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -74,11 +74,11 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>         let id = {
             let mut storage = storage.write()?;
             let id = match storage.read(&amp;Key::TxnNext.encode())? {
<a href="#h1-0-3" id="h1-0-3" class="d">-                Some(v) =&gt; deserialize(v)?,
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                Some(v) =&gt; deserialize(&amp;v)?,
</a>                 None =&gt; 1,
             };
<a href="#h1-0-7" id="h1-0-7" class="d">-            storage.write(&amp;Key::TxnNext.encode(), serialize(id + 1)?)?;
</a><a href="#h1-0-8" id="h1-0-8" class="d">-            storage.write(&amp;Key::TxnActive(id).encode(), serialize(mode.clone())?)?;
</a><a href="#h1-0-9" id="h1-0-9" class="i">+            storage.write(&amp;Key::TxnNext.encode(), serialize(&amp;(id + 1))?)?;
</a><a href="#h1-0-10" id="h1-0-10" class="i">+            storage.write(&amp;Key::TxnActive(id).encode(), serialize(&amp;mode)?)?;
</a>             id
         };
         let snapshot = match &amp;mode {
<a href="#h1-1" id="h1-1" class="h">@@ -92,7 +92,7 @@ impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a>     fn resume(storage: Arc&lt;RwLock&lt;S&gt;&gt;, id: u64) -&gt; Result&lt;Self, Error&gt; {
         let key = Key::TxnActive(id).encode();
         let mode = if let Some(v) = storage.read()?.read(&amp;key)? {
<a href="#h1-1-3" id="h1-1-3" class="d">-            deserialize(v)?
</a><a href="#h1-1-4" id="h1-1-4" class="i">+            deserialize(&amp;v)?
</a>         } else {
             return Err(Error::Value(format!(&quot;Unable to resume non-existant transaction {}&quot;, id)));
         };
<a href="#h1-2" id="h1-2" class="h">@@ -247,15 +247,14 @@ impl Snapshot {
</a>                 _ =&gt; return Err(Error::Value(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
             };
         }
<a href="#h1-2-3" id="h1-2-3" class="d">-        storage
</a><a href="#h1-2-4" id="h1-2-4" class="d">-            .write(&amp;Key::TxnSnapshot(version).encode(), serialize(snapshot.invisible.clone())?)?;
</a><a href="#h1-2-5" id="h1-2-5" class="i">+        storage.write(&amp;Key::TxnSnapshot(version).encode(), serialize(&amp;snapshot.invisible)?)?;
</a>         Ok(snapshot)
     }
 
     /// Restores an existing snapshot
     fn restore(storage: &amp;RwLockReadGuard&lt;impl Storage&gt;, version: u64) -&gt; Result&lt;Self, Error&gt; {
         if let Some(v) = storage.read(&amp;Key::TxnSnapshot(version).encode())? {
<a href="#h1-2-12" id="h1-2-12" class="d">-            Ok(Self { version, invisible: deserialize(v)? })
</a><a href="#h1-2-13" id="h1-2-13" class="i">+            Ok(Self { version, invisible: deserialize(&amp;v)? })
</a>         } else {
             Err(Error::Value(format!(&quot;Unable to find snapshot for version {}&quot;, version)))
         }
<b>diff --git a/<a id="h2" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -37,11 +37,11 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>     /// Creates a new log, using a kv::Store for storage.
     pub fn new(store: kv::Simple&lt;S&gt;) -&gt; Result&lt;Self, Error&gt; {
         let apply_index = match store.get(b&quot;apply_index&quot;)? {
<a href="#h2-0-3" id="h2-0-3" class="d">-            Some(v) =&gt; deserialize(v)?,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            Some(v) =&gt; deserialize(&amp;v)?,
</a>             None =&gt; 0,
         };
         let (commit_index, commit_term) = match store.get(&amp;apply_index.to_string().as_bytes())? {
<a href="#h2-0-8" id="h2-0-8" class="d">-            Some(raw_entry) =&gt; (apply_index, deserialize::&lt;Entry&gt;(raw_entry)?.term),
</a><a href="#h2-0-9" id="h2-0-9" class="i">+            Some(raw_entry) =&gt; (apply_index, deserialize::&lt;Entry&gt;(&amp;raw_entry)?.term),
</a>             None if apply_index == 0 =&gt; (0, 0),
             None =&gt; {
                 return Err(Error::Internal(format!(&quot;Applied entry {} not found&quot;, apply_index)))
<a href="#h2-1" id="h2-1" class="h">@@ -52,7 +52,7 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>         let (mut last_index, mut last_term) = (0, 0);
         for i in 1..std::u64::MAX {
             if let Some(e) = store.get(&amp;i.to_string().as_bytes())? {
<a href="#h2-1-3" id="h2-1-3" class="d">-                let entry: Entry = deserialize(e)?;
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                let entry: Entry = deserialize(&amp;e)?;
</a>                 last_index = i;
                 last_term = entry.term;
             } else {
<a href="#h2-2" id="h2-2" class="h">@@ -76,7 +76,7 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>         let index = self.last_index + 1;
         self.last_index = index;
         self.last_term = entry.term;
<a href="#h2-2-3" id="h2-2-3" class="d">-        self.kv.set(&amp;index.to_string().as_bytes(), serialize(entry)?)?;
</a><a href="#h2-2-4" id="h2-2-4" class="i">+        self.kv.set(&amp;index.to_string().as_bytes(), serialize(&amp;entry)?)?;
</a>         Ok(index)
     }
 
<a href="#h2-3" id="h2-3" class="h">@@ -97,7 +97,7 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>             self.apply_index += 1;
             self.apply_term = entry.term;
         }
<a href="#h2-3-3" id="h2-3-3" class="d">-        self.kv.set(b&quot;apply_index&quot;, serialize(self.apply_index)?)?;
</a><a href="#h2-3-4" id="h2-3-4" class="i">+        self.kv.set(b&quot;apply_index&quot;, serialize(&amp;self.apply_index)?)?;
</a>         Ok(Some((self.apply_index, output)))
     }
 
<a href="#h2-4" id="h2-4" class="h">@@ -123,7 +123,7 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>     /// Fetches an entry at an index
     pub fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Entry&gt;, Error&gt; {
         if let Some(value) = self.kv.get(&amp;index.to_string().as_bytes())? {
<a href="#h2-4-3" id="h2-4-3" class="d">-            Ok(Some(deserialize(value)?))
</a><a href="#h2-4-4" id="h2-4-4" class="i">+            Ok(Some(deserialize(&amp;value)?))
</a>         } else {
             Ok(None)
         }
<a href="#h2-5" id="h2-5" class="h">@@ -217,9 +217,9 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>     /// containing the term number (0 if none) and candidate voted for
     /// in current term (if any).
     pub fn load_term(&amp;self) -&gt; Result&lt;(u64, Option&lt;String&gt;), Error&gt; {
<a href="#h2-5-3" id="h2-5-3" class="d">-        let term = if let Some(value) = self.kv.get(b&quot;term&quot;)? { deserialize(value)? } else { 0 };
</a><a href="#h2-5-4" id="h2-5-4" class="i">+        let term = if let Some(value) = self.kv.get(b&quot;term&quot;)? { deserialize(&amp;value)? } else { 0 };
</a>         let voted_for = if let Some(value) = self.kv.get(b&quot;voted_for&quot;)? {
<a href="#h2-5-6" id="h2-5-6" class="d">-            Some(deserialize(value)?)
</a><a href="#h2-5-7" id="h2-5-7" class="i">+            Some(deserialize(&amp;value)?)
</a>         } else {
             None
         };
<a href="#h2-6" id="h2-6" class="h">@@ -231,12 +231,12 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>     // FIXME Should be transactional.
     pub fn save_term(&amp;mut self, term: u64, voted_for: Option&lt;&amp;str&gt;) -&gt; Result&lt;(), Error&gt; {
         if term &gt; 0 {
<a href="#h2-6-3" id="h2-6-3" class="d">-            self.kv.set(b&quot;term&quot;, serialize(term)?)?
</a><a href="#h2-6-4" id="h2-6-4" class="i">+            self.kv.set(b&quot;term&quot;, serialize(&amp;term)?)?
</a>         } else {
             self.kv.delete(b&quot;term&quot;)?
         }
         if let Some(v) = voted_for {
<a href="#h2-6-9" id="h2-6-9" class="d">-            self.kv.set(b&quot;voted_for&quot;, serialize(v)?)?
</a><a href="#h2-6-10" id="h2-6-10" class="i">+            self.kv.set(b&quot;voted_for&quot;, serialize(&amp;v)?)?
</a>         } else {
             self.kv.delete(b&quot;voted_for&quot;)?
         }
<b>diff --git a/<a id="h3" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -69,8 +69,8 @@ impl service::ToyDB for ToyDB {
</a>         };
         let mut metadata = grpc::Metadata::new();
         metadata
<a href="#h3-0-3" id="h3-0-3" class="d">-            .add(grpc::MetadataKey::from(&quot;columns&quot;), serialize(result.columns()).unwrap().into());
</a><a href="#h3-0-4" id="h3-0-4" class="d">-        if let Some(effect) = result.effect.clone() {
</a><a href="#h3-0-5" id="h3-0-5" class="i">+            .add(grpc::MetadataKey::from(&quot;columns&quot;), serialize(&amp;result.columns()).unwrap().into());
</a><a href="#h3-0-6" id="h3-0-6" class="i">+        if let Some(effect) = &amp;result.effect {
</a>             metadata.add(grpc::MetadataKey::from(&quot;effect&quot;), serialize(effect).unwrap().into());
         }
         grpc::StreamingResponse::iter_with_metadata(
<b>diff --git a/<a id="h4" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -66,7 +66,7 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>                 pk, table.name
             )));
         }
<a href="#h4-0-3" id="h4-0-3" class="d">-        self.txn.set(&amp;Key::Row(&amp;table.name, &amp;pk).encode(), serialize(row)?)?;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+        self.txn.set(&amp;Key::Row(&amp;table.name, &amp;pk).encode(), serialize(&amp;row)?)?;
</a>         Ok(())
     }
 
<a href="#h4-1" id="h4-1" class="h">@@ -75,14 +75,14 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
<a href="#h4-1-3" id="h4-1-3" class="d">-        self.txn.get(&amp;Key::Row(table, id).encode())?.map(deserialize).transpose()
</a><a href="#h4-1-4" id="h4-1-4" class="i">+        self.txn.get(&amp;Key::Row(table, id).encode())?.map(|v| deserialize(&amp;v)).transpose()
</a>     }
 
     fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
         let from = Key::RowStart(table).encode();
         let to = Key::RowEnd(table).encode();
         Ok(Box::new(self.txn.scan(&amp;from..&amp;to)?.map(|res| match res {
<a href="#h4-1-11" id="h4-1-11" class="d">-            Ok((_, v)) =&gt; deserialize(v),
</a><a href="#h4-1-12" id="h4-1-12" class="i">+            Ok((_, v)) =&gt; deserialize(&amp;v),
</a>             Err(err) =&gt; Err(err),
         })))
     }
<a href="#h4-2" id="h4-2" class="h">@@ -113,12 +113,12 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>             .scan(&amp;Key::TableStart.encode()..&amp;Key::TableEnd.encode())?
             .collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?
             .into_iter()
<a href="#h4-2-3" id="h4-2-3" class="d">-            .map(|(_, v)| deserialize(v))
</a><a href="#h4-2-4" id="h4-2-4" class="i">+            .map(|(_, v)| deserialize(&amp;v))
</a>             .collect()
     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
<a href="#h4-2-9" id="h4-2-9" class="d">-        self.txn.get(&amp;Key::Table(table).encode())?.map(deserialize).transpose()
</a><a href="#h4-2-10" id="h4-2-10" class="i">+        self.txn.get(&amp;Key::Table(table).encode())?.map(|v| deserialize(&amp;v)).transpose()
</a>     }
 }
 
<b>diff --git a/<a id="h5" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -72,12 +72,12 @@ pub struct Transaction {
</a> 
 impl Transaction {
     fn begin_with_mode(raft: raft::Raft, mode: Mode) -&gt; Result&lt;Self, Error&gt; {
<a href="#h5-0-3" id="h5-0-3" class="d">-        let id = deserialize(raft.mutate(serialize(Mutation::Begin(mode.clone()))?)?)?;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+        let id = deserialize(&amp;raft.mutate(serialize(&amp;Mutation::Begin(mode.clone()))?)?)?;
</a>         Ok(Self { raft, id, mode })
     }
 
     fn resume(raft: raft::Raft, id: u64) -&gt; Result&lt;Self, Error&gt; {
<a href="#h5-0-9" id="h5-0-9" class="d">-        let (id, mode) = deserialize(raft.query(serialize(Query::Resume(id))?)?)?;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+        let (id, mode) = deserialize(&amp;raft.query(serialize(&amp;Query::Resume(id))?)?)?;
</a>         Ok(Self { raft, id, mode })
     }
 }
<a href="#h5-1" id="h5-1" class="h">@@ -92,15 +92,15 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn commit(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-1-3" id="h5-1-3" class="d">-        deserialize(self.raft.mutate(serialize(Mutation::Commit(self.id))?)?)
</a><a href="#h5-1-4" id="h5-1-4" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Commit(self.id))?)?)
</a>     }
 
     fn rollback(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-1-8" id="h5-1-8" class="d">-        deserialize(self.raft.mutate(serialize(Mutation::Rollback(self.id))?)?)
</a><a href="#h5-1-9" id="h5-1-9" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Rollback(self.id))?)?)
</a>     }
 
     fn create(&amp;mut self, table: &amp;str, row: types::Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-1-13" id="h5-1-13" class="d">-        deserialize(self.raft.mutate(serialize(Mutation::Create {
</a><a href="#h5-1-14" id="h5-1-14" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Create {
</a>             txn_id: self.id,
             table: table.into(),
             row,
<a href="#h5-2" id="h5-2" class="h">@@ -108,7 +108,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn delete(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-2-3" id="h5-2-3" class="d">-        deserialize(self.raft.mutate(serialize(Mutation::Delete {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Delete {
</a>             txn_id: self.id,
             table: table.into(),
             id: id.clone(),
<a href="#h5-3" id="h5-3" class="h">@@ -116,7 +116,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
<a href="#h5-3-3" id="h5-3-3" class="d">-        deserialize(self.raft.query(serialize(Query::Read {
</a><a href="#h5-3-4" id="h5-3-4" class="i">+        deserialize(&amp;self.raft.query(serialize(&amp;Query::Read {
</a>             txn_id: self.id,
             table: table.into(),
             id: id.clone(),
<a href="#h5-4" id="h5-4" class="h">@@ -126,8 +126,9 @@ impl super::Transaction for Transaction {
</a>     fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
         Ok(Box::new(
             deserialize::&lt;Vec&lt;types::Row&gt;&gt;(
<a href="#h5-4-3" id="h5-4-3" class="d">-                self.raft
</a><a href="#h5-4-4" id="h5-4-4" class="d">-                    .query(serialize(Query::Scan { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h5-4-5" id="h5-4-5" class="i">+                &amp;self
</a><a href="#h5-4-6" id="h5-4-6" class="i">+                    .raft
</a><a href="#h5-4-7" id="h5-4-7" class="i">+                    .query(serialize(&amp;Query::Scan { txn_id: self.id, table: table.into() })?)?,
</a>             )?
             .into_iter()
             .map(Ok),
<a href="#h5-5" id="h5-5" class="h">@@ -135,7 +136,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn update(&amp;mut self, table: &amp;str, id: &amp;types::Value, row: types::Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-5-3" id="h5-5-3" class="d">-        deserialize(self.raft.mutate(serialize(Mutation::Update {
</a><a href="#h5-5-4" id="h5-5-4" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Update {
</a>             txn_id: self.id,
             table: table.into(),
             id: id.clone(),
<a href="#h5-6" id="h5-6" class="h">@@ -144,17 +145,15 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-6-3" id="h5-6-3" class="d">-        deserialize(
</a><a href="#h5-6-4" id="h5-6-4" class="d">-            self.raft.mutate(serialize(Mutation::CreateTable {
</a><a href="#h5-6-5" id="h5-6-5" class="d">-                txn_id: self.id,
</a><a href="#h5-6-6" id="h5-6-6" class="d">-                schema: table.clone(),
</a><a href="#h5-6-7" id="h5-6-7" class="d">-            })?)?,
</a><a href="#h5-6-8" id="h5-6-8" class="d">-        )
</a><a href="#h5-6-9" id="h5-6-9" class="i">+        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::CreateTable {
</a><a href="#h5-6-10" id="h5-6-10" class="i">+            txn_id: self.id,
</a><a href="#h5-6-11" id="h5-6-11" class="i">+            schema: table.clone(),
</a><a href="#h5-6-12" id="h5-6-12" class="i">+        })?)?)
</a>     }
 
     fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
         deserialize(
<a href="#h5-6-17" id="h5-6-17" class="d">-            self.raft.mutate(serialize(Mutation::DeleteTable {
</a><a href="#h5-6-18" id="h5-6-18" class="i">+            &amp;self.raft.mutate(serialize(&amp;Mutation::DeleteTable {
</a>                 txn_id: self.id,
                 table: table.into(),
             })?)?,
<a href="#h5-7" id="h5-7" class="h">@@ -162,13 +161,14 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt; {
<a href="#h5-7-3" id="h5-7-3" class="d">-        deserialize(self.raft.query(serialize(Query::ListTables { txn_id: self.id })?)?)
</a><a href="#h5-7-4" id="h5-7-4" class="i">+        deserialize(&amp;self.raft.query(serialize(&amp;Query::ListTables { txn_id: self.id })?)?)
</a>     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
         deserialize(
<a href="#h5-7-9" id="h5-7-9" class="d">-            self.raft
</a><a href="#h5-7-10" id="h5-7-10" class="d">-                .query(serialize(Query::ReadTable { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h5-7-11" id="h5-7-11" class="i">+            &amp;self
</a><a href="#h5-7-12" id="h5-7-12" class="i">+                .raft
</a><a href="#h5-7-13" id="h5-7-13" class="i">+                .query(serialize(&amp;Query::ReadTable { txn_id: self.id, table: table.into() })?)?,
</a>         )
     }
 }
<a href="#h5-8" id="h5-8" class="h">@@ -192,51 +192,52 @@ impl&lt;S: kv::storage::Storage&gt; State&lt;S&gt; {
</a> 
 impl&lt;S: kv::storage::Storage&gt; raft::State for State&lt;S&gt; {
     fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
<a href="#h5-8-3" id="h5-8-3" class="d">-        match deserialize(command)? {
</a><a href="#h5-8-4" id="h5-8-4" class="d">-            Mutation::Begin(mode) =&gt; serialize(self.engine.begin_with_mode(mode)?.id()),
</a><a href="#h5-8-5" id="h5-8-5" class="d">-            Mutation::Commit(txn_id) =&gt; serialize(self.engine.resume(txn_id)?.commit()?),
</a><a href="#h5-8-6" id="h5-8-6" class="d">-            Mutation::Rollback(txn_id) =&gt; serialize(self.engine.resume(txn_id)?.rollback()?),
</a><a href="#h5-8-7" id="h5-8-7" class="i">+        match deserialize(&amp;command)? {
</a><a href="#h5-8-8" id="h5-8-8" class="i">+            Mutation::Begin(mode) =&gt; serialize(&amp;self.engine.begin_with_mode(mode)?.id()),
</a><a href="#h5-8-9" id="h5-8-9" class="i">+            Mutation::Commit(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.commit()?),
</a><a href="#h5-8-10" id="h5-8-10" class="i">+            Mutation::Rollback(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.rollback()?),
</a> 
             Mutation::Create { txn_id, table, row } =&gt; {
<a href="#h5-8-13" id="h5-8-13" class="d">-                serialize(self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a><a href="#h5-8-14" id="h5-8-14" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a>             }
             Mutation::Delete { txn_id, table, id } =&gt; {
<a href="#h5-8-17" id="h5-8-17" class="d">-                serialize(self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a><a href="#h5-8-18" id="h5-8-18" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a>             }
             Mutation::Update { txn_id, table, id, row } =&gt; {
<a href="#h5-8-21" id="h5-8-21" class="d">-                serialize(self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a><a href="#h5-8-22" id="h5-8-22" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a>             }
 
             Mutation::CreateTable { txn_id, schema } =&gt; {
<a href="#h5-8-26" id="h5-8-26" class="d">-                serialize(self.engine.resume(txn_id)?.create_table(&amp;schema)?)
</a><a href="#h5-8-27" id="h5-8-27" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.create_table(&amp;schema)?)
</a>             }
             Mutation::DeleteTable { txn_id, table } =&gt; {
<a href="#h5-8-30" id="h5-8-30" class="d">-                serialize(self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a><a href="#h5-8-31" id="h5-8-31" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a>             }
         }
     }
 
     fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
<a href="#h5-8-37" id="h5-8-37" class="d">-        match deserialize(command)? {
</a><a href="#h5-8-38" id="h5-8-38" class="i">+        match deserialize(&amp;command)? {
</a>             Query::Resume(id) =&gt; {
                 let txn = self.engine.resume(id)?;
<a href="#h5-8-41" id="h5-8-41" class="d">-                serialize((txn.id(), txn.mode()))
</a><a href="#h5-8-42" id="h5-8-42" class="i">+                serialize(&amp;(txn.id(), txn.mode()))
</a>             }
 
             Query::Read { txn_id, table, id } =&gt; {
<a href="#h5-8-46" id="h5-8-46" class="d">-                serialize(self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a><a href="#h5-8-47" id="h5-8-47" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a>             }
             // FIXME This needs to stream rows
             Query::Scan { txn_id, table } =&gt; serialize(
<a href="#h5-8-51" id="h5-8-51" class="d">-                self.engine
</a><a href="#h5-8-52" id="h5-8-52" class="i">+                &amp;self
</a><a href="#h5-8-53" id="h5-8-53" class="i">+                    .engine
</a>                     .resume(txn_id)?
                     .scan(&amp;table)?
                     .collect::&lt;Result&lt;Vec&lt;types::Row&gt;, Error&gt;&gt;()?,
             ),
 
<a href="#h5-8-59" id="h5-8-59" class="d">-            Query::ListTables { txn_id } =&gt; serialize(self.engine.resume(txn_id)?.list_tables()?),
</a><a href="#h5-8-60" id="h5-8-60" class="i">+            Query::ListTables { txn_id } =&gt; serialize(&amp;self.engine.resume(txn_id)?.list_tables()?),
</a>             Query::ReadTable { txn_id, table } =&gt; {
<a href="#h5-8-62" id="h5-8-62" class="d">-                serialize(self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a><a href="#h5-8-63" id="h5-8-63" class="i">+                serialize(&amp;self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a>             }
         }
     }
<b>diff --git a/<a id="h6" href="../file/src/utility/deref.rs.html">src/utility/deref.rs</a> b/<a href="../file/src/utility/deref.rs.html">src/utility/deref.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -3,6 +3,7 @@ use std::ops::Deref;
</a> /// This implements as_deref() for Option, to e.g. convert
 /// Option&lt;String&gt; to Option&lt;&amp;str&gt;. There is a similar method in nightly:
 /// https://doc.rust-lang.org/std/option/enum.Option.html#method.deref
<a href="#h6-0-3" id="h6-0-3" class="i">+// FIXME This will stabilize in Rust 1.40.
</a> pub trait OptionDeref&lt;T: Deref&gt; {
     fn as_deref(&amp;self) -&gt; Option&lt;&amp;T::Target&gt;;
 }
<b>diff --git a/<a id="h7" href="../file/src/utility/serialize.rs.html">src/utility/serialize.rs</a> b/<a href="../file/src/utility/serialize.rs.html">src/utility/serialize.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,12 +1,12 @@
</a> use crate::Error;
 
<a href="#h7-0-2" id="h7-0-2" class="d">-/// Deserializes a value from a byte buffer
</a><a href="#h7-0-3" id="h7-0-3" class="d">-pub fn deserialize&lt;&#39;de, V: serde::Deserialize&lt;&#39;de&gt;&gt;(bytes: Vec&lt;u8&gt;) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h7-0-4" id="h7-0-4" class="d">-    Ok(serde::Deserialize::deserialize(&amp;mut rmps::Deserializer::new(&amp;bytes[..]))?)
</a><a href="#h7-0-5" id="h7-0-5" class="i">+/// Deserializes a value from a byte buffer, using MessagePack.
</a><a href="#h7-0-6" id="h7-0-6" class="i">+pub fn deserialize&lt;&#39;de, V: serde::Deserialize&lt;&#39;de&gt;&gt;(bytes: &amp;[u8]) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    Ok(serde::Deserialize::deserialize(&amp;mut rmps::Deserializer::new(bytes))?)
</a> }
 
<a href="#h7-0-10" id="h7-0-10" class="d">-/// Serializes a value into a byte buffer
</a><a href="#h7-0-11" id="h7-0-11" class="d">-pub fn serialize&lt;V: serde::Serialize&gt;(value: V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h7-0-12" id="h7-0-12" class="i">+/// Serializes a value into a byte buffer, using MessagePack.
</a><a href="#h7-0-13" id="h7-0-13" class="i">+pub fn serialize&lt;V: serde::Serialize&gt;(value: &amp;V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a>     let mut bytes = Vec::new();
     value.serialize(&amp;mut rmps::Serializer::new(&amp;mut bytes))?;
     Ok(bytes)
</pre>
</div>
</body>
</html>
