<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rewrite and improve MVCC tests. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/8642453e21bb1a0b923897d31e26c019299fee90.html">8642453e21bb1a0b923897d31e26c019299fee90</a>
<b>parent</b> <a href="../commit/61b37b18ae36afb3477f208f6350a1d27b245dd2.html">61b37b18ae36afb3477f208f6350a1d27b245dd2</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 10 Sep 2023 12:17:34 +0200

Rewrite and improve MVCC tests.

<b>Diffstat:</b>
<table><tr><td class="A">A</td><td><a href="#h0">src/storage/debug.rs</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">src/storage/engine/debug.rs</a></td><td> | </td><td class="num">69</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/storage/engine/mod.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">src/storage/golden/mvcc/anomaly_dirty_read</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">src/storage/golden/mvcc/anomaly_dirty_write</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/storage/golden/mvcc/anomaly_fuzzy_read</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">src/storage/golden/mvcc/anomaly_lost_update</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">src/storage/golden/mvcc/anomaly_phantom_read</a></td><td> | </td><td class="num">45</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">src/storage/golden/mvcc/anomaly_read_skew</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/storage/golden/mvcc/anomaly_write_skew</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/storage/golden/mvcc/begin</a></td><td> | </td><td class="num">30</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">src/storage/golden/mvcc/begin_as_of</a></td><td> | </td><td class="num">89</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/storage/golden/mvcc/begin_read_only</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">src/storage/golden/mvcc/delete</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">src/storage/golden/mvcc/delete_conflict</a></td><td> | </td><td class="num">54</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">src/storage/golden/mvcc/get</a></td><td> | </td><td class="num">27</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">src/storage/golden/mvcc/get_isolation</a></td><td> | </td><td class="num">97</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">src/storage/golden/mvcc/resume</a></td><td> | </td><td class="num">110</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">src/storage/golden/mvcc/rollback</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/storage/golden/mvcc/scan</a></td><td> | </td><td class="num">109</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">src/storage/golden/mvcc/scan_isolation</a></td><td> | </td><td class="num">91</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">src/storage/golden/mvcc/scan_key_version_encoding</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">src/storage/golden/mvcc/scan_prefix</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">src/storage/golden/mvcc/set</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h24">src/storage/golden/mvcc/set_conflict</a></td><td> | </td><td class="num">54</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h25">src/storage/golden/mvcc/unversioned</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/storage/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/storage/mvcc.rs</a></td><td> | </td><td class="num">1309</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
</table></pre><pre>28 files changed, 2352 insertions(+), 435 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/storage/debug.rs.html">src/storage/debug.rs</a> b/<a href="../file/src/storage/debug.rs.html">src/storage/debug.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -0,0 +1,87 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+//! Storage debug helpers, primarily formatting of raw engine data.
</a><a href="#h0-0-1" id="h0-0-1" class="i">+
</a><a href="#h0-0-2" id="h0-0-2" class="i">+use std::collections::HashSet;
</a><a href="#h0-0-3" id="h0-0-3" class="i">+
</a><a href="#h0-0-4" id="h0-0-4" class="i">+use super::mvcc::{self, TransactionState};
</a><a href="#h0-0-5" id="h0-0-5" class="i">+
</a><a href="#h0-0-6" id="h0-0-6" class="i">+/// Formats a raw byte string, either as a UTF-8 string (if valid and
</a><a href="#h0-0-7" id="h0-0-7" class="i">+/// printable), otherwise hex-encoded.
</a><a href="#h0-0-8" id="h0-0-8" class="i">+pub fn format_raw(v: &amp;[u8]) -&gt; String {
</a><a href="#h0-0-9" id="h0-0-9" class="i">+    if v.is_empty() {
</a><a href="#h0-0-10" id="h0-0-10" class="i">+        return String::from(&quot;[]&quot;);
</a><a href="#h0-0-11" id="h0-0-11" class="i">+    }
</a><a href="#h0-0-12" id="h0-0-12" class="i">+    if let Ok(s) = String::from_utf8(v.to_vec()) {
</a><a href="#h0-0-13" id="h0-0-13" class="i">+        if s.chars().all(|c| !c.is_control()) {
</a><a href="#h0-0-14" id="h0-0-14" class="i">+            return format!(r#&quot;&quot;{}&quot;&quot;#, s);
</a><a href="#h0-0-15" id="h0-0-15" class="i">+        }
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    }
</a><a href="#h0-0-17" id="h0-0-17" class="i">+    format!(&quot;0x{}&quot;, hex::encode(v))
</a><a href="#h0-0-18" id="h0-0-18" class="i">+}
</a><a href="#h0-0-19" id="h0-0-19" class="i">+
</a><a href="#h0-0-20" id="h0-0-20" class="i">+/// Formats a transaction state.
</a><a href="#h0-0-21" id="h0-0-21" class="i">+pub fn format_txn(state: &amp;TransactionState) -&gt; String {
</a><a href="#h0-0-22" id="h0-0-22" class="i">+    format!(
</a><a href="#h0-0-23" id="h0-0-23" class="i">+        &quot;v{} {} active={}&quot;,
</a><a href="#h0-0-24" id="h0-0-24" class="i">+        state.version,
</a><a href="#h0-0-25" id="h0-0-25" class="i">+        if state.read_only { &quot;read-only&quot; } else { &quot;read-write&quot; },
</a><a href="#h0-0-26" id="h0-0-26" class="i">+        format_hashset(&amp;state.active)
</a><a href="#h0-0-27" id="h0-0-27" class="i">+    )
</a><a href="#h0-0-28" id="h0-0-28" class="i">+}
</a><a href="#h0-0-29" id="h0-0-29" class="i">+
</a><a href="#h0-0-30" id="h0-0-30" class="i">+/// Formats a HashSet with sorted elements.
</a><a href="#h0-0-31" id="h0-0-31" class="i">+pub fn format_hashset&lt;T: Copy + Ord + std::fmt::Display&gt;(set: &amp;HashSet&lt;T&gt;) -&gt; String {
</a><a href="#h0-0-32" id="h0-0-32" class="i">+    let mut elements: Vec&lt;T&gt; = set.iter().copied().collect();
</a><a href="#h0-0-33" id="h0-0-33" class="i">+    elements.sort();
</a><a href="#h0-0-34" id="h0-0-34" class="i">+    let elements: Vec&lt;String&gt; = elements.into_iter().map(|v| v.to_string()).collect();
</a><a href="#h0-0-35" id="h0-0-35" class="i">+    format!(&quot;{{{}}}&quot;, elements.join(&quot;,&quot;))
</a><a href="#h0-0-36" id="h0-0-36" class="i">+}
</a><a href="#h0-0-37" id="h0-0-37" class="i">+
</a><a href="#h0-0-38" id="h0-0-38" class="i">+/// Formats a raw engine key/value pair, or just the key if the value is None.
</a><a href="#h0-0-39" id="h0-0-39" class="i">+/// Attempts to decode known MVCC key formats and values.
</a><a href="#h0-0-40" id="h0-0-40" class="i">+pub fn format_key_value(key: &amp;[u8], value: &amp;Option&lt;Vec&lt;u8&gt;&gt;) -&gt; (String, Option&lt;String&gt;) {
</a><a href="#h0-0-41" id="h0-0-41" class="i">+    // Default to string/hex formatting of the raw key and value.
</a><a href="#h0-0-42" id="h0-0-42" class="i">+    let mut fkey = format_raw(key);
</a><a href="#h0-0-43" id="h0-0-43" class="i">+    let mut fvalue = value.as_ref().map(|v| format_raw(v.as_slice()));
</a><a href="#h0-0-44" id="h0-0-44" class="i">+
</a><a href="#h0-0-45" id="h0-0-45" class="i">+    // Try to decode MVCC keys and values.
</a><a href="#h0-0-46" id="h0-0-46" class="i">+    if let Ok(key) = mvcc::Key::decode(key) {
</a><a href="#h0-0-47" id="h0-0-47" class="i">+        // Use the debug formatting of the key, unless we need more.
</a><a href="#h0-0-48" id="h0-0-48" class="i">+        fkey = format!(&quot;{:?}&quot;, key);
</a><a href="#h0-0-49" id="h0-0-49" class="i">+
</a><a href="#h0-0-50" id="h0-0-50" class="i">+        match key {
</a><a href="#h0-0-51" id="h0-0-51" class="i">+            mvcc::Key::NextVersion =&gt; {
</a><a href="#h0-0-52" id="h0-0-52" class="i">+                if let Some(ref v) = value {
</a><a href="#h0-0-53" id="h0-0-53" class="i">+                    if let Ok(v) = bincode::deserialize::&lt;u64&gt;(v) {
</a><a href="#h0-0-54" id="h0-0-54" class="i">+                        fvalue = Some(format!(&quot;{}&quot;, v))
</a><a href="#h0-0-55" id="h0-0-55" class="i">+                    }
</a><a href="#h0-0-56" id="h0-0-56" class="i">+                }
</a><a href="#h0-0-57" id="h0-0-57" class="i">+            }
</a><a href="#h0-0-58" id="h0-0-58" class="i">+            mvcc::Key::TxnActive(_) =&gt; {}
</a><a href="#h0-0-59" id="h0-0-59" class="i">+            mvcc::Key::TxnActiveSnapshot(_) =&gt; {
</a><a href="#h0-0-60" id="h0-0-60" class="i">+                if let Some(ref v) = value {
</a><a href="#h0-0-61" id="h0-0-61" class="i">+                    if let Ok(active) = bincode::deserialize::&lt;HashSet&lt;u64&gt;&gt;(v) {
</a><a href="#h0-0-62" id="h0-0-62" class="i">+                        fvalue = Some(format_hashset(&amp;active));
</a><a href="#h0-0-63" id="h0-0-63" class="i">+                    }
</a><a href="#h0-0-64" id="h0-0-64" class="i">+                }
</a><a href="#h0-0-65" id="h0-0-65" class="i">+            }
</a><a href="#h0-0-66" id="h0-0-66" class="i">+            mvcc::Key::TxnWrite(version, userkey) =&gt; {
</a><a href="#h0-0-67" id="h0-0-67" class="i">+                fkey = format!(&quot;TxnWrite({}, {})&quot;, version, format_raw(&amp;userkey))
</a><a href="#h0-0-68" id="h0-0-68" class="i">+            }
</a><a href="#h0-0-69" id="h0-0-69" class="i">+            mvcc::Key::Version(userkey, version) =&gt; {
</a><a href="#h0-0-70" id="h0-0-70" class="i">+                fkey = format!(&quot;Version({}, {})&quot;, format_raw(&amp;userkey), version);
</a><a href="#h0-0-71" id="h0-0-71" class="i">+                if let Some(ref v) = value {
</a><a href="#h0-0-72" id="h0-0-72" class="i">+                    match bincode::deserialize(v) {
</a><a href="#h0-0-73" id="h0-0-73" class="i">+                        Ok(Some(v)) =&gt; fvalue = Some(format_raw(v)),
</a><a href="#h0-0-74" id="h0-0-74" class="i">+                        Ok(None) =&gt; fvalue = Some(String::from(&quot;None&quot;)),
</a><a href="#h0-0-75" id="h0-0-75" class="i">+                        Err(_) =&gt; {}
</a><a href="#h0-0-76" id="h0-0-76" class="i">+                    }
</a><a href="#h0-0-77" id="h0-0-77" class="i">+                }
</a><a href="#h0-0-78" id="h0-0-78" class="i">+            }
</a><a href="#h0-0-79" id="h0-0-79" class="i">+            mvcc::Key::Unversioned(userkey) =&gt; {
</a><a href="#h0-0-80" id="h0-0-80" class="i">+                fkey = format!(&quot;Unversioned({})&quot;, format_raw(&amp;userkey));
</a><a href="#h0-0-81" id="h0-0-81" class="i">+            }
</a><a href="#h0-0-82" id="h0-0-82" class="i">+        }
</a><a href="#h0-0-83" id="h0-0-83" class="i">+    }
</a><a href="#h0-0-84" id="h0-0-84" class="i">+
</a><a href="#h0-0-85" id="h0-0-85" class="i">+    (fkey, fvalue)
</a><a href="#h0-0-86" id="h0-0-86" class="i">+}
</a><b>diff --git a/<a id="h1" href="../file/src/storage/engine/debug.rs.html">src/storage/engine/debug.rs</a> b/<a href="../file/src/storage/engine/debug.rs.html">src/storage/engine/debug.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,69 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+use super::{Engine, Status};
</a><a href="#h1-0-1" id="h1-0-1" class="i">+use crate::error::Result;
</a><a href="#h1-0-2" id="h1-0-2" class="i">+
</a><a href="#h1-0-3" id="h1-0-3" class="i">+/// A debug engine, which wraps another engine and logs mutations.
</a><a href="#h1-0-4" id="h1-0-4" class="i">+pub struct Debug&lt;E: Engine&gt; {
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    /// The wrapped engine.
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    inner: E,
</a><a href="#h1-0-7" id="h1-0-7" class="i">+    /// Write log as key/value tuples. Value is None for deletes.
</a><a href="#h1-0-8" id="h1-0-8" class="i">+    write_log: Vec&lt;(Vec&lt;u8&gt;, Option&lt;Vec&lt;u8&gt;&gt;)&gt;,
</a><a href="#h1-0-9" id="h1-0-9" class="i">+}
</a><a href="#h1-0-10" id="h1-0-10" class="i">+
</a><a href="#h1-0-11" id="h1-0-11" class="i">+impl&lt;E: Engine&gt; std::fmt::Display for Debug&lt;E&gt; {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h1-0-13" id="h1-0-13" class="i">+        write!(f, &quot;debug:{}&quot;, self.inner)
</a><a href="#h1-0-14" id="h1-0-14" class="i">+    }
</a><a href="#h1-0-15" id="h1-0-15" class="i">+}
</a><a href="#h1-0-16" id="h1-0-16" class="i">+
</a><a href="#h1-0-17" id="h1-0-17" class="i">+impl&lt;E: Engine&gt; Debug&lt;E&gt; {
</a><a href="#h1-0-18" id="h1-0-18" class="i">+    pub fn new(inner: E) -&gt; Self {
</a><a href="#h1-0-19" id="h1-0-19" class="i">+        Self { inner, write_log: Vec::new() }
</a><a href="#h1-0-20" id="h1-0-20" class="i">+    }
</a><a href="#h1-0-21" id="h1-0-21" class="i">+
</a><a href="#h1-0-22" id="h1-0-22" class="i">+    /// Returns and resets the write log. The next call only returns new writes.
</a><a href="#h1-0-23" id="h1-0-23" class="i">+    pub fn take_write_log(&amp;mut self) -&gt; Vec&lt;(Vec&lt;u8&gt;, Option&lt;Vec&lt;u8&gt;&gt;)&gt; {
</a><a href="#h1-0-24" id="h1-0-24" class="i">+        let mut write_log = Vec::new();
</a><a href="#h1-0-25" id="h1-0-25" class="i">+        std::mem::swap(&amp;mut write_log, &amp;mut self.write_log);
</a><a href="#h1-0-26" id="h1-0-26" class="i">+        write_log
</a><a href="#h1-0-27" id="h1-0-27" class="i">+    }
</a><a href="#h1-0-28" id="h1-0-28" class="i">+}
</a><a href="#h1-0-29" id="h1-0-29" class="i">+
</a><a href="#h1-0-30" id="h1-0-30" class="i">+impl&lt;E: Engine&gt; Engine for Debug&lt;E&gt; {
</a><a href="#h1-0-31" id="h1-0-31" class="i">+    type ScanIterator&lt;&#39;a&gt; = E::ScanIterator&lt;&#39;a&gt; where E: &#39;a;
</a><a href="#h1-0-32" id="h1-0-32" class="i">+
</a><a href="#h1-0-33" id="h1-0-33" class="i">+    fn flush(&amp;mut self) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-34" id="h1-0-34" class="i">+        self.inner.flush()
</a><a href="#h1-0-35" id="h1-0-35" class="i">+    }
</a><a href="#h1-0-36" id="h1-0-36" class="i">+
</a><a href="#h1-0-37" id="h1-0-37" class="i">+    fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-38" id="h1-0-38" class="i">+        self.inner.delete(key)?;
</a><a href="#h1-0-39" id="h1-0-39" class="i">+        self.write_log.push((key.to_vec(), None));
</a><a href="#h1-0-40" id="h1-0-40" class="i">+        Ok(())
</a><a href="#h1-0-41" id="h1-0-41" class="i">+    }
</a><a href="#h1-0-42" id="h1-0-42" class="i">+
</a><a href="#h1-0-43" id="h1-0-43" class="i">+    fn get(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h1-0-44" id="h1-0-44" class="i">+        self.inner.get(key)
</a><a href="#h1-0-45" id="h1-0-45" class="i">+    }
</a><a href="#h1-0-46" id="h1-0-46" class="i">+
</a><a href="#h1-0-47" id="h1-0-47" class="i">+    fn scan&lt;R: std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;&gt;(&amp;mut self, range: R) -&gt; Self::ScanIterator&lt;&#39;_&gt; {
</a><a href="#h1-0-48" id="h1-0-48" class="i">+        self.inner.scan(range)
</a><a href="#h1-0-49" id="h1-0-49" class="i">+    }
</a><a href="#h1-0-50" id="h1-0-50" class="i">+
</a><a href="#h1-0-51" id="h1-0-51" class="i">+    fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-52" id="h1-0-52" class="i">+        self.inner.set(key, value.clone())?;
</a><a href="#h1-0-53" id="h1-0-53" class="i">+        self.write_log.push((key.to_vec(), Some(value)));
</a><a href="#h1-0-54" id="h1-0-54" class="i">+        Ok(())
</a><a href="#h1-0-55" id="h1-0-55" class="i">+    }
</a><a href="#h1-0-56" id="h1-0-56" class="i">+
</a><a href="#h1-0-57" id="h1-0-57" class="i">+    fn status(&amp;mut self) -&gt; Result&lt;Status&gt; {
</a><a href="#h1-0-58" id="h1-0-58" class="i">+        self.inner.status()
</a><a href="#h1-0-59" id="h1-0-59" class="i">+    }
</a><a href="#h1-0-60" id="h1-0-60" class="i">+}
</a><a href="#h1-0-61" id="h1-0-61" class="i">+
</a><a href="#h1-0-62" id="h1-0-62" class="i">+#[cfg(test)]
</a><a href="#h1-0-63" id="h1-0-63" class="i">+mod tests {
</a><a href="#h1-0-64" id="h1-0-64" class="i">+    use super::super::Memory;
</a><a href="#h1-0-65" id="h1-0-65" class="i">+    use super::*;
</a><a href="#h1-0-66" id="h1-0-66" class="i">+
</a><a href="#h1-0-67" id="h1-0-67" class="i">+    super::super::tests::test_engine!(Debug::new(Memory::new()));
</a><a href="#h1-0-68" id="h1-0-68" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/src/storage/engine/mod.rs.html">src/storage/engine/mod.rs</a> b/<a href="../file/src/storage/engine/mod.rs.html">src/storage/engine/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,7 +1,11 @@
</a> mod bitcask;
<a href="#h2-0-1" id="h2-0-1" class="i">+#[cfg(test)]
</a><a href="#h2-0-2" id="h2-0-2" class="i">+mod debug;
</a> mod memory;
 
 pub use bitcask::BitCask;
<a href="#h2-0-6" id="h2-0-6" class="i">+#[cfg(test)]
</a><a href="#h2-0-7" id="h2-0-7" class="i">+pub use debug::Debug;
</a> pub use memory::Memory;
 
 use crate::error::Result;
<b>diff --git a/<a id="h3" href="../file/src/storage/golden/mvcc/anomaly_dirty_read.html">src/storage/golden/mvcc/anomaly_dirty_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_dirty_read.html">src/storage/golden/mvcc/anomaly_dirty_read</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h3-0-1" id="h3-0-1" class="i">+    set NextVersion = 2
</a><a href="#h3-0-2" id="h3-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h3-0-3" id="h3-0-3" class="i">+
</a><a href="#h3-0-4" id="h3-0-4" class="i">+T1: set &quot;key&quot; = 0x01
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    set TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h3-0-6" id="h3-0-6" class="i">+    set Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    set NextVersion = 3
</a><a href="#h3-0-10" id="h3-0-10" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h3-0-11" id="h3-0-11" class="i">+    set TxnActive(2) = []
</a><a href="#h3-0-12" id="h3-0-12" class="i">+
</a><a href="#h3-0-13" id="h3-0-13" class="i">+T2: get &quot;key&quot; → None
</a><a href="#h3-0-14" id="h3-0-14" class="i">+
</a><a href="#h3-0-15" id="h3-0-15" class="i">+Engine state:
</a><a href="#h3-0-16" id="h3-0-16" class="i">+NextVersion = 3
</a><a href="#h3-0-17" id="h3-0-17" class="i">+TxnActive(1) = []
</a><a href="#h3-0-18" id="h3-0-18" class="i">+TxnActive(2) = []
</a><a href="#h3-0-19" id="h3-0-19" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h3-0-20" id="h3-0-20" class="i">+TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h3-0-21" id="h3-0-21" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h4" href="../file/src/storage/golden/mvcc/anomaly_dirty_write.html">src/storage/golden/mvcc/anomaly_dirty_write</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_dirty_write.html">src/storage/golden/mvcc/anomaly_dirty_write</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h4-0-1" id="h4-0-1" class="i">+    set NextVersion = 2
</a><a href="#h4-0-2" id="h4-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h4-0-3" id="h4-0-3" class="i">+
</a><a href="#h4-0-4" id="h4-0-4" class="i">+T1: set &quot;key&quot; = 0x01
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    set TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h4-0-6" id="h4-0-6" class="i">+    set Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h4-0-7" id="h4-0-7" class="i">+
</a><a href="#h4-0-8" id="h4-0-8" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h4-0-9" id="h4-0-9" class="i">+    set NextVersion = 3
</a><a href="#h4-0-10" id="h4-0-10" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    set TxnActive(2) = []
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+T2: set &quot;key&quot; = 0x02 → Error::Serialization
</a><a href="#h4-0-14" id="h4-0-14" class="i">+
</a><a href="#h4-0-15" id="h4-0-15" class="i">+Engine state:
</a><a href="#h4-0-16" id="h4-0-16" class="i">+NextVersion = 3
</a><a href="#h4-0-17" id="h4-0-17" class="i">+TxnActive(1) = []
</a><a href="#h4-0-18" id="h4-0-18" class="i">+TxnActive(2) = []
</a><a href="#h4-0-19" id="h4-0-19" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h4-0-20" id="h4-0-20" class="i">+TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h4-0-21" id="h4-0-21" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h5" href="../file/src/storage/golden/mvcc/anomaly_fuzzy_read.html">src/storage/golden/mvcc/anomaly_fuzzy_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_fuzzy_read.html">src/storage/golden/mvcc/anomaly_fuzzy_read</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+Engine state:
</a><a href="#h5-0-1" id="h5-0-1" class="i">+NextVersion = 2
</a><a href="#h5-0-2" id="h5-0-2" class="i">+Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h5-0-3" id="h5-0-3" class="i">+
</a><a href="#h5-0-4" id="h5-0-4" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h5-0-5" id="h5-0-5" class="i">+    set NextVersion = 3
</a><a href="#h5-0-6" id="h5-0-6" class="i">+    set TxnActive(2) = []
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h5-0-9" id="h5-0-9" class="i">+    set NextVersion = 4
</a><a href="#h5-0-10" id="h5-0-10" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h5-0-11" id="h5-0-11" class="i">+    set TxnActive(3) = []
</a><a href="#h5-0-12" id="h5-0-12" class="i">+
</a><a href="#h5-0-13" id="h5-0-13" class="i">+T2: get &quot;key&quot; → 0x00
</a><a href="#h5-0-14" id="h5-0-14" class="i">+
</a><a href="#h5-0-15" id="h5-0-15" class="i">+T1: set &quot;key&quot; = &quot;t1&quot;
</a><a href="#h5-0-16" id="h5-0-16" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h5-0-17" id="h5-0-17" class="i">+    set Version(&quot;key&quot;, 2) = &quot;t1&quot;
</a><a href="#h5-0-18" id="h5-0-18" class="i">+
</a><a href="#h5-0-19" id="h5-0-19" class="i">+T1: commit
</a><a href="#h5-0-20" id="h5-0-20" class="i">+    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h5-0-21" id="h5-0-21" class="i">+    del TxnActive(2)
</a><a href="#h5-0-22" id="h5-0-22" class="i">+
</a><a href="#h5-0-23" id="h5-0-23" class="i">+T2: get &quot;key&quot; → 0x00
</a><a href="#h5-0-24" id="h5-0-24" class="i">+
</a><a href="#h5-0-25" id="h5-0-25" class="i">+Engine state:
</a><a href="#h5-0-26" id="h5-0-26" class="i">+NextVersion = 4
</a><a href="#h5-0-27" id="h5-0-27" class="i">+TxnActive(3) = []
</a><a href="#h5-0-28" id="h5-0-28" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h5-0-29" id="h5-0-29" class="i">+Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h5-0-30" id="h5-0-30" class="i">+Version(&quot;key&quot;, 2) = &quot;t1&quot;
</a><b>diff --git a/<a id="h6" href="../file/src/storage/golden/mvcc/anomaly_lost_update.html">src/storage/golden/mvcc/anomaly_lost_update</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_lost_update.html">src/storage/golden/mvcc/anomaly_lost_update</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,33 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+Engine state:
</a><a href="#h6-0-1" id="h6-0-1" class="i">+NextVersion = 2
</a><a href="#h6-0-2" id="h6-0-2" class="i">+Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h6-0-3" id="h6-0-3" class="i">+
</a><a href="#h6-0-4" id="h6-0-4" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    set NextVersion = 3
</a><a href="#h6-0-6" id="h6-0-6" class="i">+    set TxnActive(2) = []
</a><a href="#h6-0-7" id="h6-0-7" class="i">+
</a><a href="#h6-0-8" id="h6-0-8" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h6-0-9" id="h6-0-9" class="i">+    set NextVersion = 4
</a><a href="#h6-0-10" id="h6-0-10" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h6-0-11" id="h6-0-11" class="i">+    set TxnActive(3) = []
</a><a href="#h6-0-12" id="h6-0-12" class="i">+
</a><a href="#h6-0-13" id="h6-0-13" class="i">+T1: get &quot;key&quot; → 0x00
</a><a href="#h6-0-14" id="h6-0-14" class="i">+
</a><a href="#h6-0-15" id="h6-0-15" class="i">+T2: get &quot;key&quot; → 0x00
</a><a href="#h6-0-16" id="h6-0-16" class="i">+
</a><a href="#h6-0-17" id="h6-0-17" class="i">+T1: set &quot;key&quot; = 0x01
</a><a href="#h6-0-18" id="h6-0-18" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h6-0-19" id="h6-0-19" class="i">+    set Version(&quot;key&quot;, 2) = 0x01
</a><a href="#h6-0-20" id="h6-0-20" class="i">+
</a><a href="#h6-0-21" id="h6-0-21" class="i">+T2: set &quot;key&quot; = 0x02 → Error::Serialization
</a><a href="#h6-0-22" id="h6-0-22" class="i">+
</a><a href="#h6-0-23" id="h6-0-23" class="i">+T1: commit
</a><a href="#h6-0-24" id="h6-0-24" class="i">+    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h6-0-25" id="h6-0-25" class="i">+    del TxnActive(2)
</a><a href="#h6-0-26" id="h6-0-26" class="i">+
</a><a href="#h6-0-27" id="h6-0-27" class="i">+Engine state:
</a><a href="#h6-0-28" id="h6-0-28" class="i">+NextVersion = 4
</a><a href="#h6-0-29" id="h6-0-29" class="i">+TxnActive(3) = []
</a><a href="#h6-0-30" id="h6-0-30" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h6-0-31" id="h6-0-31" class="i">+Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h6-0-32" id="h6-0-32" class="i">+Version(&quot;key&quot;, 2) = 0x01
</a><b>diff --git a/<a id="h7" href="../file/src/storage/golden/mvcc/anomaly_phantom_read.html">src/storage/golden/mvcc/anomaly_phantom_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_phantom_read.html">src/storage/golden/mvcc/anomaly_phantom_read</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,45 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+Engine state:
</a><a href="#h7-0-1" id="h7-0-1" class="i">+NextVersion = 2
</a><a href="#h7-0-2" id="h7-0-2" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h7-0-3" id="h7-0-3" class="i">+Version(&quot;ba&quot;, 1) = 0x00
</a><a href="#h7-0-4" id="h7-0-4" class="i">+Version(&quot;bb&quot;, 1) = 0x00
</a><a href="#h7-0-5" id="h7-0-5" class="i">+
</a><a href="#h7-0-6" id="h7-0-6" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h7-0-7" id="h7-0-7" class="i">+    set NextVersion = 3
</a><a href="#h7-0-8" id="h7-0-8" class="i">+    set TxnActive(2) = []
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h7-0-11" id="h7-0-11" class="i">+    set NextVersion = 4
</a><a href="#h7-0-12" id="h7-0-12" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h7-0-13" id="h7-0-13" class="i">+    set TxnActive(3) = []
</a><a href="#h7-0-14" id="h7-0-14" class="i">+
</a><a href="#h7-0-15" id="h7-0-15" class="i">+T1: scan prefix &quot;b&quot;
</a><a href="#h7-0-16" id="h7-0-16" class="i">+    &quot;ba&quot; = 0x00
</a><a href="#h7-0-17" id="h7-0-17" class="i">+    &quot;bb&quot; = 0x00
</a><a href="#h7-0-18" id="h7-0-18" class="i">+
</a><a href="#h7-0-19" id="h7-0-19" class="i">+T2: del &quot;ba&quot;
</a><a href="#h7-0-20" id="h7-0-20" class="i">+    set TxnWrite(3, &quot;ba&quot;) = []
</a><a href="#h7-0-21" id="h7-0-21" class="i">+    set Version(&quot;ba&quot;, 3) = None
</a><a href="#h7-0-22" id="h7-0-22" class="i">+
</a><a href="#h7-0-23" id="h7-0-23" class="i">+T2: set &quot;bc&quot; = 0x02
</a><a href="#h7-0-24" id="h7-0-24" class="i">+    set TxnWrite(3, &quot;bc&quot;) = []
</a><a href="#h7-0-25" id="h7-0-25" class="i">+    set Version(&quot;bc&quot;, 3) = 0x02
</a><a href="#h7-0-26" id="h7-0-26" class="i">+
</a><a href="#h7-0-27" id="h7-0-27" class="i">+T2: commit
</a><a href="#h7-0-28" id="h7-0-28" class="i">+    del TxnWrite(3, &quot;ba&quot;)
</a><a href="#h7-0-29" id="h7-0-29" class="i">+    del TxnWrite(3, &quot;bc&quot;)
</a><a href="#h7-0-30" id="h7-0-30" class="i">+    del TxnActive(3)
</a><a href="#h7-0-31" id="h7-0-31" class="i">+
</a><a href="#h7-0-32" id="h7-0-32" class="i">+T1: scan prefix &quot;b&quot;
</a><a href="#h7-0-33" id="h7-0-33" class="i">+    &quot;ba&quot; = 0x00
</a><a href="#h7-0-34" id="h7-0-34" class="i">+    &quot;bb&quot; = 0x00
</a><a href="#h7-0-35" id="h7-0-35" class="i">+
</a><a href="#h7-0-36" id="h7-0-36" class="i">+Engine state:
</a><a href="#h7-0-37" id="h7-0-37" class="i">+NextVersion = 4
</a><a href="#h7-0-38" id="h7-0-38" class="i">+TxnActive(2) = []
</a><a href="#h7-0-39" id="h7-0-39" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h7-0-40" id="h7-0-40" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h7-0-41" id="h7-0-41" class="i">+Version(&quot;ba&quot;, 1) = 0x00
</a><a href="#h7-0-42" id="h7-0-42" class="i">+Version(&quot;ba&quot;, 3) = None
</a><a href="#h7-0-43" id="h7-0-43" class="i">+Version(&quot;bb&quot;, 1) = 0x00
</a><a href="#h7-0-44" id="h7-0-44" class="i">+Version(&quot;bc&quot;, 3) = 0x02
</a><b>diff --git a/<a id="h8" href="../file/src/storage/golden/mvcc/anomaly_read_skew.html">src/storage/golden/mvcc/anomaly_read_skew</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_read_skew.html">src/storage/golden/mvcc/anomaly_read_skew</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+Engine state:
</a><a href="#h8-0-1" id="h8-0-1" class="i">+NextVersion = 2
</a><a href="#h8-0-2" id="h8-0-2" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h8-0-3" id="h8-0-3" class="i">+Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h8-0-4" id="h8-0-4" class="i">+
</a><a href="#h8-0-5" id="h8-0-5" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h8-0-6" id="h8-0-6" class="i">+    set NextVersion = 3
</a><a href="#h8-0-7" id="h8-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h8-0-8" id="h8-0-8" class="i">+
</a><a href="#h8-0-9" id="h8-0-9" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h8-0-10" id="h8-0-10" class="i">+    set NextVersion = 4
</a><a href="#h8-0-11" id="h8-0-11" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h8-0-12" id="h8-0-12" class="i">+    set TxnActive(3) = []
</a><a href="#h8-0-13" id="h8-0-13" class="i">+
</a><a href="#h8-0-14" id="h8-0-14" class="i">+T1: get &quot;a&quot; → 0x00
</a><a href="#h8-0-15" id="h8-0-15" class="i">+
</a><a href="#h8-0-16" id="h8-0-16" class="i">+T2: set &quot;a&quot; = 0x02
</a><a href="#h8-0-17" id="h8-0-17" class="i">+    set TxnWrite(3, &quot;a&quot;) = []
</a><a href="#h8-0-18" id="h8-0-18" class="i">+    set Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h8-0-19" id="h8-0-19" class="i">+
</a><a href="#h8-0-20" id="h8-0-20" class="i">+T2: set &quot;b&quot; = 0x02
</a><a href="#h8-0-21" id="h8-0-21" class="i">+    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h8-0-22" id="h8-0-22" class="i">+    set Version(&quot;b&quot;, 3) = 0x02
</a><a href="#h8-0-23" id="h8-0-23" class="i">+
</a><a href="#h8-0-24" id="h8-0-24" class="i">+T2: commit
</a><a href="#h8-0-25" id="h8-0-25" class="i">+    del TxnWrite(3, &quot;a&quot;)
</a><a href="#h8-0-26" id="h8-0-26" class="i">+    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h8-0-27" id="h8-0-27" class="i">+    del TxnActive(3)
</a><a href="#h8-0-28" id="h8-0-28" class="i">+
</a><a href="#h8-0-29" id="h8-0-29" class="i">+T1: get &quot;a&quot; → 0x00
</a><a href="#h8-0-30" id="h8-0-30" class="i">+
</a><a href="#h8-0-31" id="h8-0-31" class="i">+Engine state:
</a><a href="#h8-0-32" id="h8-0-32" class="i">+NextVersion = 4
</a><a href="#h8-0-33" id="h8-0-33" class="i">+TxnActive(2) = []
</a><a href="#h8-0-34" id="h8-0-34" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h8-0-35" id="h8-0-35" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h8-0-36" id="h8-0-36" class="i">+Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h8-0-37" id="h8-0-37" class="i">+Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h8-0-38" id="h8-0-38" class="i">+Version(&quot;b&quot;, 3) = 0x02
</a><b>diff --git a/<a id="h9" href="../file/src/storage/golden/mvcc/anomaly_write_skew.html">src/storage/golden/mvcc/anomaly_write_skew</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_write_skew.html">src/storage/golden/mvcc/anomaly_write_skew</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+Engine state:
</a><a href="#h9-0-1" id="h9-0-1" class="i">+NextVersion = 2
</a><a href="#h9-0-2" id="h9-0-2" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h9-0-3" id="h9-0-3" class="i">+Version(&quot;b&quot;, 1) = 0x02
</a><a href="#h9-0-4" id="h9-0-4" class="i">+
</a><a href="#h9-0-5" id="h9-0-5" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h9-0-6" id="h9-0-6" class="i">+    set NextVersion = 3
</a><a href="#h9-0-7" id="h9-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h9-0-8" id="h9-0-8" class="i">+
</a><a href="#h9-0-9" id="h9-0-9" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h9-0-10" id="h9-0-10" class="i">+    set NextVersion = 4
</a><a href="#h9-0-11" id="h9-0-11" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h9-0-12" id="h9-0-12" class="i">+    set TxnActive(3) = []
</a><a href="#h9-0-13" id="h9-0-13" class="i">+
</a><a href="#h9-0-14" id="h9-0-14" class="i">+T1: get &quot;a&quot; → 0x01
</a><a href="#h9-0-15" id="h9-0-15" class="i">+
</a><a href="#h9-0-16" id="h9-0-16" class="i">+T2: get &quot;b&quot; → 0x02
</a><a href="#h9-0-17" id="h9-0-17" class="i">+
</a><a href="#h9-0-18" id="h9-0-18" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h9-0-19" id="h9-0-19" class="i">+    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h9-0-20" id="h9-0-20" class="i">+    set Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h9-0-21" id="h9-0-21" class="i">+
</a><a href="#h9-0-22" id="h9-0-22" class="i">+T2: set &quot;a&quot; = 0x02
</a><a href="#h9-0-23" id="h9-0-23" class="i">+    set TxnWrite(3, &quot;a&quot;) = []
</a><a href="#h9-0-24" id="h9-0-24" class="i">+    set Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h9-0-25" id="h9-0-25" class="i">+
</a><a href="#h9-0-26" id="h9-0-26" class="i">+T1: commit
</a><a href="#h9-0-27" id="h9-0-27" class="i">+    del TxnWrite(2, &quot;b&quot;)
</a><a href="#h9-0-28" id="h9-0-28" class="i">+    del TxnActive(2)
</a><a href="#h9-0-29" id="h9-0-29" class="i">+
</a><a href="#h9-0-30" id="h9-0-30" class="i">+T2: commit
</a><a href="#h9-0-31" id="h9-0-31" class="i">+    del TxnWrite(3, &quot;a&quot;)
</a><a href="#h9-0-32" id="h9-0-32" class="i">+    del TxnActive(3)
</a><a href="#h9-0-33" id="h9-0-33" class="i">+
</a><a href="#h9-0-34" id="h9-0-34" class="i">+Engine state:
</a><a href="#h9-0-35" id="h9-0-35" class="i">+NextVersion = 4
</a><a href="#h9-0-36" id="h9-0-36" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h9-0-37" id="h9-0-37" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h9-0-38" id="h9-0-38" class="i">+Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h9-0-39" id="h9-0-39" class="i">+Version(&quot;b&quot;, 1) = 0x02
</a><a href="#h9-0-40" id="h9-0-40" class="i">+Version(&quot;b&quot;, 2) = 0x01
</a><b>diff --git a/<a id="h10" href="../file/src/storage/golden/mvcc/begin.html">src/storage/golden/mvcc/begin</a> b/<a href="../file/src/storage/golden/mvcc/begin.html">src/storage/golden/mvcc/begin</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,30 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h10-0-1" id="h10-0-1" class="i">+    set NextVersion = 2
</a><a href="#h10-0-2" id="h10-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h10-0-3" id="h10-0-3" class="i">+
</a><a href="#h10-0-4" id="h10-0-4" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h10-0-5" id="h10-0-5" class="i">+    set NextVersion = 3
</a><a href="#h10-0-6" id="h10-0-6" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h10-0-7" id="h10-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h10-0-8" id="h10-0-8" class="i">+
</a><a href="#h10-0-9" id="h10-0-9" class="i">+T3: begin → v3 read-write active={1,2}
</a><a href="#h10-0-10" id="h10-0-10" class="i">+    set NextVersion = 4
</a><a href="#h10-0-11" id="h10-0-11" class="i">+    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h10-0-12" id="h10-0-12" class="i">+    set TxnActive(3) = []
</a><a href="#h10-0-13" id="h10-0-13" class="i">+
</a><a href="#h10-0-14" id="h10-0-14" class="i">+T2: commit
</a><a href="#h10-0-15" id="h10-0-15" class="i">+    del TxnActive(2)
</a><a href="#h10-0-16" id="h10-0-16" class="i">+
</a><a href="#h10-0-17" id="h10-0-17" class="i">+T4: begin → v4 read-write active={1,3}
</a><a href="#h10-0-18" id="h10-0-18" class="i">+    set NextVersion = 5
</a><a href="#h10-0-19" id="h10-0-19" class="i">+    set TxnActiveSnapshot(4) = {1,3}
</a><a href="#h10-0-20" id="h10-0-20" class="i">+    set TxnActive(4) = []
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+Engine state:
</a><a href="#h10-0-23" id="h10-0-23" class="i">+NextVersion = 5
</a><a href="#h10-0-24" id="h10-0-24" class="i">+TxnActive(1) = []
</a><a href="#h10-0-25" id="h10-0-25" class="i">+TxnActive(3) = []
</a><a href="#h10-0-26" id="h10-0-26" class="i">+TxnActive(4) = []
</a><a href="#h10-0-27" id="h10-0-27" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h10-0-28" id="h10-0-28" class="i">+TxnActiveSnapshot(3) = {1,2}
</a><a href="#h10-0-29" id="h10-0-29" class="i">+TxnActiveSnapshot(4) = {1,3}
</a><b>diff --git a/<a id="h11" href="../file/src/storage/golden/mvcc/begin_as_of.html">src/storage/golden/mvcc/begin_as_of</a> b/<a href="../file/src/storage/golden/mvcc/begin_as_of.html">src/storage/golden/mvcc/begin_as_of</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,89 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h11-0-1" id="h11-0-1" class="i">+    set NextVersion = 2
</a><a href="#h11-0-2" id="h11-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h11-0-3" id="h11-0-3" class="i">+
</a><a href="#h11-0-4" id="h11-0-4" class="i">+T1: set &quot;other&quot; = 0x01
</a><a href="#h11-0-5" id="h11-0-5" class="i">+    set TxnWrite(1, &quot;other&quot;) = []
</a><a href="#h11-0-6" id="h11-0-6" class="i">+    set Version(&quot;other&quot;, 1) = 0x01
</a><a href="#h11-0-7" id="h11-0-7" class="i">+
</a><a href="#h11-0-8" id="h11-0-8" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h11-0-9" id="h11-0-9" class="i">+    set NextVersion = 3
</a><a href="#h11-0-10" id="h11-0-10" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h11-0-11" id="h11-0-11" class="i">+    set TxnActive(2) = []
</a><a href="#h11-0-12" id="h11-0-12" class="i">+
</a><a href="#h11-0-13" id="h11-0-13" class="i">+T2: set &quot;key&quot; = 0x02
</a><a href="#h11-0-14" id="h11-0-14" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h11-0-15" id="h11-0-15" class="i">+    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h11-0-16" id="h11-0-16" class="i">+
</a><a href="#h11-0-17" id="h11-0-17" class="i">+T2: commit
</a><a href="#h11-0-18" id="h11-0-18" class="i">+    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h11-0-19" id="h11-0-19" class="i">+    del TxnActive(2)
</a><a href="#h11-0-20" id="h11-0-20" class="i">+
</a><a href="#h11-0-21" id="h11-0-21" class="i">+T3: begin → v3 read-write active={1}
</a><a href="#h11-0-22" id="h11-0-22" class="i">+    set NextVersion = 4
</a><a href="#h11-0-23" id="h11-0-23" class="i">+    set TxnActiveSnapshot(3) = {1}
</a><a href="#h11-0-24" id="h11-0-24" class="i">+    set TxnActive(3) = []
</a><a href="#h11-0-25" id="h11-0-25" class="i">+
</a><a href="#h11-0-26" id="h11-0-26" class="i">+T3: set &quot;key&quot; = 0x03
</a><a href="#h11-0-27" id="h11-0-27" class="i">+    set TxnWrite(3, &quot;key&quot;) = []
</a><a href="#h11-0-28" id="h11-0-28" class="i">+    set Version(&quot;key&quot;, 3) = 0x03
</a><a href="#h11-0-29" id="h11-0-29" class="i">+
</a><a href="#h11-0-30" id="h11-0-30" class="i">+T4: begin as of 3 → v3 read-only active={1}
</a><a href="#h11-0-31" id="h11-0-31" class="i">+
</a><a href="#h11-0-32" id="h11-0-32" class="i">+T4: scan ..
</a><a href="#h11-0-33" id="h11-0-33" class="i">+    &quot;key&quot; = 0x02
</a><a href="#h11-0-34" id="h11-0-34" class="i">+
</a><a href="#h11-0-35" id="h11-0-35" class="i">+T4: set &quot;foo&quot; = 0x01 → Error::ReadOnly
</a><a href="#h11-0-36" id="h11-0-36" class="i">+
</a><a href="#h11-0-37" id="h11-0-37" class="i">+T4: del &quot;foo&quot; → Error::ReadOnly
</a><a href="#h11-0-38" id="h11-0-38" class="i">+
</a><a href="#h11-0-39" id="h11-0-39" class="i">+T1: commit
</a><a href="#h11-0-40" id="h11-0-40" class="i">+    del TxnWrite(1, &quot;other&quot;)
</a><a href="#h11-0-41" id="h11-0-41" class="i">+    del TxnActive(1)
</a><a href="#h11-0-42" id="h11-0-42" class="i">+
</a><a href="#h11-0-43" id="h11-0-43" class="i">+T3: commit
</a><a href="#h11-0-44" id="h11-0-44" class="i">+    del TxnWrite(3, &quot;key&quot;)
</a><a href="#h11-0-45" id="h11-0-45" class="i">+    del TxnActive(3)
</a><a href="#h11-0-46" id="h11-0-46" class="i">+
</a><a href="#h11-0-47" id="h11-0-47" class="i">+T4: scan ..
</a><a href="#h11-0-48" id="h11-0-48" class="i">+    &quot;key&quot; = 0x02
</a><a href="#h11-0-49" id="h11-0-49" class="i">+
</a><a href="#h11-0-50" id="h11-0-50" class="i">+T5: begin as of 3 → v3 read-only active={1}
</a><a href="#h11-0-51" id="h11-0-51" class="i">+
</a><a href="#h11-0-52" id="h11-0-52" class="i">+T5: scan ..
</a><a href="#h11-0-53" id="h11-0-53" class="i">+    &quot;key&quot; = 0x02
</a><a href="#h11-0-54" id="h11-0-54" class="i">+
</a><a href="#h11-0-55" id="h11-0-55" class="i">+T4: rollback
</a><a href="#h11-0-56" id="h11-0-56" class="i">+
</a><a href="#h11-0-57" id="h11-0-57" class="i">+T5: commit
</a><a href="#h11-0-58" id="h11-0-58" class="i">+
</a><a href="#h11-0-59" id="h11-0-59" class="i">+T6: begin → v4 read-write active={}
</a><a href="#h11-0-60" id="h11-0-60" class="i">+    set NextVersion = 5
</a><a href="#h11-0-61" id="h11-0-61" class="i">+    set TxnActive(4) = []
</a><a href="#h11-0-62" id="h11-0-62" class="i">+
</a><a href="#h11-0-63" id="h11-0-63" class="i">+T6: set &quot;key&quot; = 0x04
</a><a href="#h11-0-64" id="h11-0-64" class="i">+    set TxnWrite(4, &quot;key&quot;) = []
</a><a href="#h11-0-65" id="h11-0-65" class="i">+    set Version(&quot;key&quot;, 4) = 0x04
</a><a href="#h11-0-66" id="h11-0-66" class="i">+
</a><a href="#h11-0-67" id="h11-0-67" class="i">+T6: commit
</a><a href="#h11-0-68" id="h11-0-68" class="i">+    del TxnWrite(4, &quot;key&quot;)
</a><a href="#h11-0-69" id="h11-0-69" class="i">+    del TxnActive(4)
</a><a href="#h11-0-70" id="h11-0-70" class="i">+
</a><a href="#h11-0-71" id="h11-0-71" class="i">+T7: begin as of 4 → v4 read-only active={}
</a><a href="#h11-0-72" id="h11-0-72" class="i">+
</a><a href="#h11-0-73" id="h11-0-73" class="i">+T7: scan ..
</a><a href="#h11-0-74" id="h11-0-74" class="i">+    &quot;key&quot; = 0x03
</a><a href="#h11-0-75" id="h11-0-75" class="i">+    &quot;other&quot; = 0x01
</a><a href="#h11-0-76" id="h11-0-76" class="i">+
</a><a href="#h11-0-77" id="h11-0-77" class="i">+T8: begin as of 5 → Error::Value(&quot;Version 5 does not exist&quot;)
</a><a href="#h11-0-78" id="h11-0-78" class="i">+
</a><a href="#h11-0-79" id="h11-0-79" class="i">+T9: begin as of 9 → Error::Value(&quot;Version 9 does not exist&quot;)
</a><a href="#h11-0-80" id="h11-0-80" class="i">+
</a><a href="#h11-0-81" id="h11-0-81" class="i">+Engine state:
</a><a href="#h11-0-82" id="h11-0-82" class="i">+NextVersion = 5
</a><a href="#h11-0-83" id="h11-0-83" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h11-0-84" id="h11-0-84" class="i">+TxnActiveSnapshot(3) = {1}
</a><a href="#h11-0-85" id="h11-0-85" class="i">+Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h11-0-86" id="h11-0-86" class="i">+Version(&quot;key&quot;, 3) = 0x03
</a><a href="#h11-0-87" id="h11-0-87" class="i">+Version(&quot;key&quot;, 4) = 0x04
</a><a href="#h11-0-88" id="h11-0-88" class="i">+Version(&quot;other&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h12" href="../file/src/storage/golden/mvcc/begin_read_only.html">src/storage/golden/mvcc/begin_read_only</a> b/<a href="../file/src/storage/golden/mvcc/begin_read_only.html">src/storage/golden/mvcc/begin_read_only</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+T1: begin read-only → v1 read-only active={}
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+T1: set &quot;foo&quot; = 0x01 → Error::ReadOnly
</a><a href="#h12-0-3" id="h12-0-3" class="i">+
</a><a href="#h12-0-4" id="h12-0-4" class="i">+T1: del &quot;foo&quot; → Error::ReadOnly
</a><a href="#h12-0-5" id="h12-0-5" class="i">+
</a><a href="#h12-0-6" id="h12-0-6" class="i">+T2: begin → v1 read-write active={}
</a><a href="#h12-0-7" id="h12-0-7" class="i">+    set NextVersion = 2
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    set TxnActive(1) = []
</a><a href="#h12-0-9" id="h12-0-9" class="i">+
</a><a href="#h12-0-10" id="h12-0-10" class="i">+T3: begin read-only → v2 read-only active={1}
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+Engine state:
</a><a href="#h12-0-13" id="h12-0-13" class="i">+NextVersion = 2
</a><a href="#h12-0-14" id="h12-0-14" class="i">+TxnActive(1) = []
</a><b>diff --git a/<a id="h13" href="../file/src/storage/golden/mvcc/delete.html">src/storage/golden/mvcc/delete</a> b/<a href="../file/src/storage/golden/mvcc/delete.html">src/storage/golden/mvcc/delete</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,42 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+Engine state:
</a><a href="#h13-0-1" id="h13-0-1" class="i">+NextVersion = 2
</a><a href="#h13-0-2" id="h13-0-2" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h13-0-3" id="h13-0-3" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h13-0-4" id="h13-0-4" class="i">+
</a><a href="#h13-0-5" id="h13-0-5" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h13-0-6" id="h13-0-6" class="i">+    set NextVersion = 3
</a><a href="#h13-0-7" id="h13-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h13-0-8" id="h13-0-8" class="i">+
</a><a href="#h13-0-9" id="h13-0-9" class="i">+T1: set &quot;key&quot; = 0x02
</a><a href="#h13-0-10" id="h13-0-10" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h13-0-11" id="h13-0-11" class="i">+    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h13-0-12" id="h13-0-12" class="i">+
</a><a href="#h13-0-13" id="h13-0-13" class="i">+T1: del &quot;key&quot;
</a><a href="#h13-0-14" id="h13-0-14" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h13-0-15" id="h13-0-15" class="i">+    set Version(&quot;key&quot;, 2) = None
</a><a href="#h13-0-16" id="h13-0-16" class="i">+
</a><a href="#h13-0-17" id="h13-0-17" class="i">+T1: del &quot;key&quot;
</a><a href="#h13-0-18" id="h13-0-18" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h13-0-19" id="h13-0-19" class="i">+    set Version(&quot;key&quot;, 2) = None
</a><a href="#h13-0-20" id="h13-0-20" class="i">+
</a><a href="#h13-0-21" id="h13-0-21" class="i">+T1: del &quot;tombstone&quot;
</a><a href="#h13-0-22" id="h13-0-22" class="i">+    set TxnWrite(2, &quot;tombstone&quot;) = []
</a><a href="#h13-0-23" id="h13-0-23" class="i">+    set Version(&quot;tombstone&quot;, 2) = None
</a><a href="#h13-0-24" id="h13-0-24" class="i">+
</a><a href="#h13-0-25" id="h13-0-25" class="i">+T1: del &quot;missing&quot;
</a><a href="#h13-0-26" id="h13-0-26" class="i">+    set TxnWrite(2, &quot;missing&quot;) = []
</a><a href="#h13-0-27" id="h13-0-27" class="i">+    set Version(&quot;missing&quot;, 2) = None
</a><a href="#h13-0-28" id="h13-0-28" class="i">+
</a><a href="#h13-0-29" id="h13-0-29" class="i">+T1: commit
</a><a href="#h13-0-30" id="h13-0-30" class="i">+    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h13-0-31" id="h13-0-31" class="i">+    del TxnWrite(2, &quot;missing&quot;)
</a><a href="#h13-0-32" id="h13-0-32" class="i">+    del TxnWrite(2, &quot;tombstone&quot;)
</a><a href="#h13-0-33" id="h13-0-33" class="i">+    del TxnActive(2)
</a><a href="#h13-0-34" id="h13-0-34" class="i">+
</a><a href="#h13-0-35" id="h13-0-35" class="i">+Engine state:
</a><a href="#h13-0-36" id="h13-0-36" class="i">+NextVersion = 3
</a><a href="#h13-0-37" id="h13-0-37" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h13-0-38" id="h13-0-38" class="i">+Version(&quot;key&quot;, 2) = None
</a><a href="#h13-0-39" id="h13-0-39" class="i">+Version(&quot;missing&quot;, 2) = None
</a><a href="#h13-0-40" id="h13-0-40" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h13-0-41" id="h13-0-41" class="i">+Version(&quot;tombstone&quot;, 2) = None
</a><b>diff --git a/<a id="h14" href="../file/src/storage/golden/mvcc/delete_conflict.html">src/storage/golden/mvcc/delete_conflict</a> b/<a href="../file/src/storage/golden/mvcc/delete_conflict.html">src/storage/golden/mvcc/delete_conflict</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,54 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h14-0-1" id="h14-0-1" class="i">+    set NextVersion = 2
</a><a href="#h14-0-2" id="h14-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h14-0-3" id="h14-0-3" class="i">+
</a><a href="#h14-0-4" id="h14-0-4" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h14-0-5" id="h14-0-5" class="i">+    set NextVersion = 3
</a><a href="#h14-0-6" id="h14-0-6" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h14-0-8" id="h14-0-8" class="i">+
</a><a href="#h14-0-9" id="h14-0-9" class="i">+T3: begin → v3 read-write active={1,2}
</a><a href="#h14-0-10" id="h14-0-10" class="i">+    set NextVersion = 4
</a><a href="#h14-0-11" id="h14-0-11" class="i">+    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h14-0-12" id="h14-0-12" class="i">+    set TxnActive(3) = []
</a><a href="#h14-0-13" id="h14-0-13" class="i">+
</a><a href="#h14-0-14" id="h14-0-14" class="i">+T4: begin → v4 read-write active={1,2,3}
</a><a href="#h14-0-15" id="h14-0-15" class="i">+    set NextVersion = 5
</a><a href="#h14-0-16" id="h14-0-16" class="i">+    set TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h14-0-17" id="h14-0-17" class="i">+    set TxnActive(4) = []
</a><a href="#h14-0-18" id="h14-0-18" class="i">+
</a><a href="#h14-0-19" id="h14-0-19" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h14-0-20" id="h14-0-20" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h14-0-21" id="h14-0-21" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h14-0-22" id="h14-0-22" class="i">+
</a><a href="#h14-0-23" id="h14-0-23" class="i">+T3: set &quot;c&quot; = 0x03
</a><a href="#h14-0-24" id="h14-0-24" class="i">+    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h14-0-25" id="h14-0-25" class="i">+    set Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h14-0-26" id="h14-0-26" class="i">+
</a><a href="#h14-0-27" id="h14-0-27" class="i">+T4: set &quot;d&quot; = 0x04
</a><a href="#h14-0-28" id="h14-0-28" class="i">+    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h14-0-29" id="h14-0-29" class="i">+    set Version(&quot;d&quot;, 4) = 0x04
</a><a href="#h14-0-30" id="h14-0-30" class="i">+
</a><a href="#h14-0-31" id="h14-0-31" class="i">+T4: commit
</a><a href="#h14-0-32" id="h14-0-32" class="i">+    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h14-0-33" id="h14-0-33" class="i">+    del TxnActive(4)
</a><a href="#h14-0-34" id="h14-0-34" class="i">+
</a><a href="#h14-0-35" id="h14-0-35" class="i">+T2: del &quot;a&quot; → Error::Serialization
</a><a href="#h14-0-36" id="h14-0-36" class="i">+
</a><a href="#h14-0-37" id="h14-0-37" class="i">+T2: del &quot;c&quot; → Error::Serialization
</a><a href="#h14-0-38" id="h14-0-38" class="i">+
</a><a href="#h14-0-39" id="h14-0-39" class="i">+T2: del &quot;d&quot; → Error::Serialization
</a><a href="#h14-0-40" id="h14-0-40" class="i">+
</a><a href="#h14-0-41" id="h14-0-41" class="i">+Engine state:
</a><a href="#h14-0-42" id="h14-0-42" class="i">+NextVersion = 5
</a><a href="#h14-0-43" id="h14-0-43" class="i">+TxnActive(1) = []
</a><a href="#h14-0-44" id="h14-0-44" class="i">+TxnActive(2) = []
</a><a href="#h14-0-45" id="h14-0-45" class="i">+TxnActive(3) = []
</a><a href="#h14-0-46" id="h14-0-46" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h14-0-47" id="h14-0-47" class="i">+TxnActiveSnapshot(3) = {1,2}
</a><a href="#h14-0-48" id="h14-0-48" class="i">+TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h14-0-49" id="h14-0-49" class="i">+TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h14-0-50" id="h14-0-50" class="i">+TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h14-0-51" id="h14-0-51" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h14-0-52" id="h14-0-52" class="i">+Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h14-0-53" id="h14-0-53" class="i">+Version(&quot;d&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h15" href="../file/src/storage/golden/mvcc/get.html">src/storage/golden/mvcc/get</a> b/<a href="../file/src/storage/golden/mvcc/get.html">src/storage/golden/mvcc/get</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,27 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+Engine state:
</a><a href="#h15-0-1" id="h15-0-1" class="i">+NextVersion = 3
</a><a href="#h15-0-2" id="h15-0-2" class="i">+Version(&quot;deleted&quot;, 1) = 0x01
</a><a href="#h15-0-3" id="h15-0-3" class="i">+Version(&quot;deleted&quot;, 2) = None
</a><a href="#h15-0-4" id="h15-0-4" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h15-0-5" id="h15-0-5" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h15-0-6" id="h15-0-6" class="i">+Version(&quot;updated&quot;, 1) = 0x01
</a><a href="#h15-0-7" id="h15-0-7" class="i">+Version(&quot;updated&quot;, 2) = 0x02
</a><a href="#h15-0-8" id="h15-0-8" class="i">+
</a><a href="#h15-0-9" id="h15-0-9" class="i">+T1: begin read-only → v3 read-only active={}
</a><a href="#h15-0-10" id="h15-0-10" class="i">+
</a><a href="#h15-0-11" id="h15-0-11" class="i">+T1: get &quot;key&quot; → 0x01
</a><a href="#h15-0-12" id="h15-0-12" class="i">+
</a><a href="#h15-0-13" id="h15-0-13" class="i">+T1: get &quot;updated&quot; → 0x02
</a><a href="#h15-0-14" id="h15-0-14" class="i">+
</a><a href="#h15-0-15" id="h15-0-15" class="i">+T1: get &quot;deleted&quot; → None
</a><a href="#h15-0-16" id="h15-0-16" class="i">+
</a><a href="#h15-0-17" id="h15-0-17" class="i">+T1: get &quot;tombstone&quot; → None
</a><a href="#h15-0-18" id="h15-0-18" class="i">+
</a><a href="#h15-0-19" id="h15-0-19" class="i">+Engine state:
</a><a href="#h15-0-20" id="h15-0-20" class="i">+NextVersion = 3
</a><a href="#h15-0-21" id="h15-0-21" class="i">+Version(&quot;deleted&quot;, 1) = 0x01
</a><a href="#h15-0-22" id="h15-0-22" class="i">+Version(&quot;deleted&quot;, 2) = None
</a><a href="#h15-0-23" id="h15-0-23" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h15-0-24" id="h15-0-24" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h15-0-25" id="h15-0-25" class="i">+Version(&quot;updated&quot;, 1) = 0x01
</a><a href="#h15-0-26" id="h15-0-26" class="i">+Version(&quot;updated&quot;, 2) = 0x02
</a><b>diff --git a/<a id="h16" href="../file/src/storage/golden/mvcc/get_isolation.html">src/storage/golden/mvcc/get_isolation</a> b/<a href="../file/src/storage/golden/mvcc/get_isolation.html">src/storage/golden/mvcc/get_isolation</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,97 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h16-0-1" id="h16-0-1" class="i">+    set NextVersion = 2
</a><a href="#h16-0-2" id="h16-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h16-0-3" id="h16-0-3" class="i">+
</a><a href="#h16-0-4" id="h16-0-4" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h16-0-5" id="h16-0-5" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h16-0-6" id="h16-0-6" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h16-0-7" id="h16-0-7" class="i">+
</a><a href="#h16-0-8" id="h16-0-8" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h16-0-9" id="h16-0-9" class="i">+    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h16-0-10" id="h16-0-10" class="i">+    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h16-0-11" id="h16-0-11" class="i">+
</a><a href="#h16-0-12" id="h16-0-12" class="i">+T1: set &quot;d&quot; = 0x01
</a><a href="#h16-0-13" id="h16-0-13" class="i">+    set TxnWrite(1, &quot;d&quot;) = []
</a><a href="#h16-0-14" id="h16-0-14" class="i">+    set Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h16-0-15" id="h16-0-15" class="i">+
</a><a href="#h16-0-16" id="h16-0-16" class="i">+T1: set &quot;e&quot; = 0x01
</a><a href="#h16-0-17" id="h16-0-17" class="i">+    set TxnWrite(1, &quot;e&quot;) = []
</a><a href="#h16-0-18" id="h16-0-18" class="i">+    set Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h16-0-19" id="h16-0-19" class="i">+
</a><a href="#h16-0-20" id="h16-0-20" class="i">+T1: commit
</a><a href="#h16-0-21" id="h16-0-21" class="i">+    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h16-0-22" id="h16-0-22" class="i">+    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h16-0-23" id="h16-0-23" class="i">+    del TxnWrite(1, &quot;d&quot;)
</a><a href="#h16-0-24" id="h16-0-24" class="i">+    del TxnWrite(1, &quot;e&quot;)
</a><a href="#h16-0-25" id="h16-0-25" class="i">+    del TxnActive(1)
</a><a href="#h16-0-26" id="h16-0-26" class="i">+
</a><a href="#h16-0-27" id="h16-0-27" class="i">+T2: begin → v2 read-write active={}
</a><a href="#h16-0-28" id="h16-0-28" class="i">+    set NextVersion = 3
</a><a href="#h16-0-29" id="h16-0-29" class="i">+    set TxnActive(2) = []
</a><a href="#h16-0-30" id="h16-0-30" class="i">+
</a><a href="#h16-0-31" id="h16-0-31" class="i">+T2: set &quot;a&quot; = 0x02
</a><a href="#h16-0-32" id="h16-0-32" class="i">+    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h16-0-33" id="h16-0-33" class="i">+    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h16-0-34" id="h16-0-34" class="i">+
</a><a href="#h16-0-35" id="h16-0-35" class="i">+T2: del &quot;b&quot;
</a><a href="#h16-0-36" id="h16-0-36" class="i">+    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h16-0-37" id="h16-0-37" class="i">+    set Version(&quot;b&quot;, 2) = None
</a><a href="#h16-0-38" id="h16-0-38" class="i">+
</a><a href="#h16-0-39" id="h16-0-39" class="i">+T2: set &quot;c&quot; = 0x02
</a><a href="#h16-0-40" id="h16-0-40" class="i">+    set TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h16-0-41" id="h16-0-41" class="i">+    set Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h16-0-42" id="h16-0-42" class="i">+
</a><a href="#h16-0-43" id="h16-0-43" class="i">+T3: begin read-only → v3 read-only active={2}
</a><a href="#h16-0-44" id="h16-0-44" class="i">+
</a><a href="#h16-0-45" id="h16-0-45" class="i">+T4: begin → v3 read-write active={2}
</a><a href="#h16-0-46" id="h16-0-46" class="i">+    set NextVersion = 4
</a><a href="#h16-0-47" id="h16-0-47" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h16-0-48" id="h16-0-48" class="i">+    set TxnActive(3) = []
</a><a href="#h16-0-49" id="h16-0-49" class="i">+
</a><a href="#h16-0-50" id="h16-0-50" class="i">+T4: set &quot;d&quot; = 0x03
</a><a href="#h16-0-51" id="h16-0-51" class="i">+    set TxnWrite(3, &quot;d&quot;) = []
</a><a href="#h16-0-52" id="h16-0-52" class="i">+    set Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h16-0-53" id="h16-0-53" class="i">+
</a><a href="#h16-0-54" id="h16-0-54" class="i">+T4: del &quot;e&quot;
</a><a href="#h16-0-55" id="h16-0-55" class="i">+    set TxnWrite(3, &quot;e&quot;) = []
</a><a href="#h16-0-56" id="h16-0-56" class="i">+    set Version(&quot;e&quot;, 3) = None
</a><a href="#h16-0-57" id="h16-0-57" class="i">+
</a><a href="#h16-0-58" id="h16-0-58" class="i">+T4: set &quot;f&quot; = 0x03
</a><a href="#h16-0-59" id="h16-0-59" class="i">+    set TxnWrite(3, &quot;f&quot;) = []
</a><a href="#h16-0-60" id="h16-0-60" class="i">+    set Version(&quot;f&quot;, 3) = 0x03
</a><a href="#h16-0-61" id="h16-0-61" class="i">+
</a><a href="#h16-0-62" id="h16-0-62" class="i">+T4: commit
</a><a href="#h16-0-63" id="h16-0-63" class="i">+    del TxnWrite(3, &quot;d&quot;)
</a><a href="#h16-0-64" id="h16-0-64" class="i">+    del TxnWrite(3, &quot;e&quot;)
</a><a href="#h16-0-65" id="h16-0-65" class="i">+    del TxnWrite(3, &quot;f&quot;)
</a><a href="#h16-0-66" id="h16-0-66" class="i">+    del TxnActive(3)
</a><a href="#h16-0-67" id="h16-0-67" class="i">+
</a><a href="#h16-0-68" id="h16-0-68" class="i">+T3: get &quot;a&quot; → 0x01
</a><a href="#h16-0-69" id="h16-0-69" class="i">+
</a><a href="#h16-0-70" id="h16-0-70" class="i">+T3: get &quot;b&quot; → 0x01
</a><a href="#h16-0-71" id="h16-0-71" class="i">+
</a><a href="#h16-0-72" id="h16-0-72" class="i">+T3: get &quot;c&quot; → None
</a><a href="#h16-0-73" id="h16-0-73" class="i">+
</a><a href="#h16-0-74" id="h16-0-74" class="i">+T3: get &quot;d&quot; → 0x01
</a><a href="#h16-0-75" id="h16-0-75" class="i">+
</a><a href="#h16-0-76" id="h16-0-76" class="i">+T3: get &quot;e&quot; → 0x01
</a><a href="#h16-0-77" id="h16-0-77" class="i">+
</a><a href="#h16-0-78" id="h16-0-78" class="i">+T3: get &quot;f&quot; → None
</a><a href="#h16-0-79" id="h16-0-79" class="i">+
</a><a href="#h16-0-80" id="h16-0-80" class="i">+Engine state:
</a><a href="#h16-0-81" id="h16-0-81" class="i">+NextVersion = 4
</a><a href="#h16-0-82" id="h16-0-82" class="i">+TxnActive(2) = []
</a><a href="#h16-0-83" id="h16-0-83" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h16-0-84" id="h16-0-84" class="i">+TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h16-0-85" id="h16-0-85" class="i">+TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h16-0-86" id="h16-0-86" class="i">+TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h16-0-87" id="h16-0-87" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h16-0-88" id="h16-0-88" class="i">+Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h16-0-89" id="h16-0-89" class="i">+Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h16-0-90" id="h16-0-90" class="i">+Version(&quot;b&quot;, 2) = None
</a><a href="#h16-0-91" id="h16-0-91" class="i">+Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h16-0-92" id="h16-0-92" class="i">+Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h16-0-93" id="h16-0-93" class="i">+Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h16-0-94" id="h16-0-94" class="i">+Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h16-0-95" id="h16-0-95" class="i">+Version(&quot;e&quot;, 3) = None
</a><a href="#h16-0-96" id="h16-0-96" class="i">+Version(&quot;f&quot;, 3) = 0x03
</a><b>diff --git a/<a id="h17" href="../file/src/storage/golden/mvcc/resume.html">src/storage/golden/mvcc/resume</a> b/<a href="../file/src/storage/golden/mvcc/resume.html">src/storage/golden/mvcc/resume</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,110 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h17-0-1" id="h17-0-1" class="i">+    set NextVersion = 2
</a><a href="#h17-0-2" id="h17-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h17-0-3" id="h17-0-3" class="i">+
</a><a href="#h17-0-4" id="h17-0-4" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h17-0-5" id="h17-0-5" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h17-0-6" id="h17-0-6" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h17-0-7" id="h17-0-7" class="i">+
</a><a href="#h17-0-8" id="h17-0-8" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h17-0-9" id="h17-0-9" class="i">+    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h17-0-10" id="h17-0-10" class="i">+    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h17-0-11" id="h17-0-11" class="i">+
</a><a href="#h17-0-12" id="h17-0-12" class="i">+T1: commit
</a><a href="#h17-0-13" id="h17-0-13" class="i">+    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h17-0-14" id="h17-0-14" class="i">+    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h17-0-15" id="h17-0-15" class="i">+    del TxnActive(1)
</a><a href="#h17-0-16" id="h17-0-16" class="i">+
</a><a href="#h17-0-17" id="h17-0-17" class="i">+T2: begin → v2 read-write active={}
</a><a href="#h17-0-18" id="h17-0-18" class="i">+    set NextVersion = 3
</a><a href="#h17-0-19" id="h17-0-19" class="i">+    set TxnActive(2) = []
</a><a href="#h17-0-20" id="h17-0-20" class="i">+
</a><a href="#h17-0-21" id="h17-0-21" class="i">+T3: begin → v3 read-write active={2}
</a><a href="#h17-0-22" id="h17-0-22" class="i">+    set NextVersion = 4
</a><a href="#h17-0-23" id="h17-0-23" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h17-0-24" id="h17-0-24" class="i">+    set TxnActive(3) = []
</a><a href="#h17-0-25" id="h17-0-25" class="i">+
</a><a href="#h17-0-26" id="h17-0-26" class="i">+T4: begin → v4 read-write active={2,3}
</a><a href="#h17-0-27" id="h17-0-27" class="i">+    set NextVersion = 5
</a><a href="#h17-0-28" id="h17-0-28" class="i">+    set TxnActiveSnapshot(4) = {2,3}
</a><a href="#h17-0-29" id="h17-0-29" class="i">+    set TxnActive(4) = []
</a><a href="#h17-0-30" id="h17-0-30" class="i">+
</a><a href="#h17-0-31" id="h17-0-31" class="i">+T2: set &quot;a&quot; = 0x02
</a><a href="#h17-0-32" id="h17-0-32" class="i">+    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h17-0-33" id="h17-0-33" class="i">+    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h17-0-34" id="h17-0-34" class="i">+
</a><a href="#h17-0-35" id="h17-0-35" class="i">+T3: set &quot;b&quot; = 0x03
</a><a href="#h17-0-36" id="h17-0-36" class="i">+    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h17-0-37" id="h17-0-37" class="i">+    set Version(&quot;b&quot;, 3) = 0x03
</a><a href="#h17-0-38" id="h17-0-38" class="i">+
</a><a href="#h17-0-39" id="h17-0-39" class="i">+T4: set &quot;c&quot; = 0x04
</a><a href="#h17-0-40" id="h17-0-40" class="i">+    set TxnWrite(4, &quot;c&quot;) = []
</a><a href="#h17-0-41" id="h17-0-41" class="i">+    set Version(&quot;c&quot;, 4) = 0x04
</a><a href="#h17-0-42" id="h17-0-42" class="i">+
</a><a href="#h17-0-43" id="h17-0-43" class="i">+T2: commit
</a><a href="#h17-0-44" id="h17-0-44" class="i">+    del TxnWrite(2, &quot;a&quot;)
</a><a href="#h17-0-45" id="h17-0-45" class="i">+    del TxnActive(2)
</a><a href="#h17-0-46" id="h17-0-46" class="i">+
</a><a href="#h17-0-47" id="h17-0-47" class="i">+T4: commit
</a><a href="#h17-0-48" id="h17-0-48" class="i">+    del TxnWrite(4, &quot;c&quot;)
</a><a href="#h17-0-49" id="h17-0-49" class="i">+    del TxnActive(4)
</a><a href="#h17-0-50" id="h17-0-50" class="i">+
</a><a href="#h17-0-51" id="h17-0-51" class="i">+T5: resume → v3 read-write active={2}
</a><a href="#h17-0-52" id="h17-0-52" class="i">+
</a><a href="#h17-0-53" id="h17-0-53" class="i">+T5: scan ..
</a><a href="#h17-0-54" id="h17-0-54" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h17-0-55" id="h17-0-55" class="i">+    &quot;b&quot; = 0x03
</a><a href="#h17-0-56" id="h17-0-56" class="i">+
</a><a href="#h17-0-57" id="h17-0-57" class="i">+T6: begin → v5 read-write active={3}
</a><a href="#h17-0-58" id="h17-0-58" class="i">+    set NextVersion = 6
</a><a href="#h17-0-59" id="h17-0-59" class="i">+    set TxnActiveSnapshot(5) = {3}
</a><a href="#h17-0-60" id="h17-0-60" class="i">+    set TxnActive(5) = []
</a><a href="#h17-0-61" id="h17-0-61" class="i">+
</a><a href="#h17-0-62" id="h17-0-62" class="i">+T6: scan ..
</a><a href="#h17-0-63" id="h17-0-63" class="i">+    &quot;a&quot; = 0x02
</a><a href="#h17-0-64" id="h17-0-64" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h17-0-65" id="h17-0-65" class="i">+    &quot;c&quot; = 0x04
</a><a href="#h17-0-66" id="h17-0-66" class="i">+
</a><a href="#h17-0-67" id="h17-0-67" class="i">+T6: rollback
</a><a href="#h17-0-68" id="h17-0-68" class="i">+    del TxnActive(5)
</a><a href="#h17-0-69" id="h17-0-69" class="i">+
</a><a href="#h17-0-70" id="h17-0-70" class="i">+T5: commit
</a><a href="#h17-0-71" id="h17-0-71" class="i">+    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h17-0-72" id="h17-0-72" class="i">+    del TxnActive(3)
</a><a href="#h17-0-73" id="h17-0-73" class="i">+
</a><a href="#h17-0-74" id="h17-0-74" class="i">+T7: begin → v6 read-write active={}
</a><a href="#h17-0-75" id="h17-0-75" class="i">+    set NextVersion = 7
</a><a href="#h17-0-76" id="h17-0-76" class="i">+    set TxnActive(6) = []
</a><a href="#h17-0-77" id="h17-0-77" class="i">+
</a><a href="#h17-0-78" id="h17-0-78" class="i">+T7: scan ..
</a><a href="#h17-0-79" id="h17-0-79" class="i">+    &quot;a&quot; = 0x02
</a><a href="#h17-0-80" id="h17-0-80" class="i">+    &quot;b&quot; = 0x03
</a><a href="#h17-0-81" id="h17-0-81" class="i">+    &quot;c&quot; = 0x04
</a><a href="#h17-0-82" id="h17-0-82" class="i">+
</a><a href="#h17-0-83" id="h17-0-83" class="i">+T7: rollback
</a><a href="#h17-0-84" id="h17-0-84" class="i">+    del TxnActive(6)
</a><a href="#h17-0-85" id="h17-0-85" class="i">+
</a><a href="#h17-0-86" id="h17-0-86" class="i">+T8: resume → Error::Internal(&quot;No active transaction at version 3&quot;)
</a><a href="#h17-0-87" id="h17-0-87" class="i">+
</a><a href="#h17-0-88" id="h17-0-88" class="i">+T9: begin as of 3 → v3 read-only active={2}
</a><a href="#h17-0-89" id="h17-0-89" class="i">+
</a><a href="#h17-0-90" id="h17-0-90" class="i">+T9: scan ..
</a><a href="#h17-0-91" id="h17-0-91" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h17-0-92" id="h17-0-92" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h17-0-93" id="h17-0-93" class="i">+
</a><a href="#h17-0-94" id="h17-0-94" class="i">+T10: resume → v3 read-only active={2}
</a><a href="#h17-0-95" id="h17-0-95" class="i">+
</a><a href="#h17-0-96" id="h17-0-96" class="i">+T10: scan ..
</a><a href="#h17-0-97" id="h17-0-97" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h17-0-98" id="h17-0-98" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h17-0-99" id="h17-0-99" class="i">+
</a><a href="#h17-0-100" id="h17-0-100" class="i">+Engine state:
</a><a href="#h17-0-101" id="h17-0-101" class="i">+NextVersion = 7
</a><a href="#h17-0-102" id="h17-0-102" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h17-0-103" id="h17-0-103" class="i">+TxnActiveSnapshot(4) = {2,3}
</a><a href="#h17-0-104" id="h17-0-104" class="i">+TxnActiveSnapshot(5) = {3}
</a><a href="#h17-0-105" id="h17-0-105" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h17-0-106" id="h17-0-106" class="i">+Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h17-0-107" id="h17-0-107" class="i">+Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h17-0-108" id="h17-0-108" class="i">+Version(&quot;b&quot;, 3) = 0x03
</a><a href="#h17-0-109" id="h17-0-109" class="i">+Version(&quot;c&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h18" href="../file/src/storage/golden/mvcc/rollback.html">src/storage/golden/mvcc/rollback</a> b/<a href="../file/src/storage/golden/mvcc/rollback.html">src/storage/golden/mvcc/rollback</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+Engine state:
</a><a href="#h18-0-1" id="h18-0-1" class="i">+NextVersion = 2
</a><a href="#h18-0-2" id="h18-0-2" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h18-0-3" id="h18-0-3" class="i">+Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h18-0-4" id="h18-0-4" class="i">+Version(&quot;c&quot;, 1) = 0x00
</a><a href="#h18-0-5" id="h18-0-5" class="i">+Version(&quot;d&quot;, 1) = 0x00
</a><a href="#h18-0-6" id="h18-0-6" class="i">+
</a><a href="#h18-0-7" id="h18-0-7" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h18-0-8" id="h18-0-8" class="i">+    set NextVersion = 3
</a><a href="#h18-0-9" id="h18-0-9" class="i">+    set TxnActive(2) = []
</a><a href="#h18-0-10" id="h18-0-10" class="i">+
</a><a href="#h18-0-11" id="h18-0-11" class="i">+T2: begin → v3 read-write active={2}
</a><a href="#h18-0-12" id="h18-0-12" class="i">+    set NextVersion = 4
</a><a href="#h18-0-13" id="h18-0-13" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h18-0-14" id="h18-0-14" class="i">+    set TxnActive(3) = []
</a><a href="#h18-0-15" id="h18-0-15" class="i">+
</a><a href="#h18-0-16" id="h18-0-16" class="i">+T3: begin → v4 read-write active={2,3}
</a><a href="#h18-0-17" id="h18-0-17" class="i">+    set NextVersion = 5
</a><a href="#h18-0-18" id="h18-0-18" class="i">+    set TxnActiveSnapshot(4) = {2,3}
</a><a href="#h18-0-19" id="h18-0-19" class="i">+    set TxnActive(4) = []
</a><a href="#h18-0-20" id="h18-0-20" class="i">+
</a><a href="#h18-0-21" id="h18-0-21" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h18-0-22" id="h18-0-22" class="i">+    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h18-0-23" id="h18-0-23" class="i">+    set Version(&quot;a&quot;, 2) = 0x01
</a><a href="#h18-0-24" id="h18-0-24" class="i">+
</a><a href="#h18-0-25" id="h18-0-25" class="i">+T2: set &quot;b&quot; = 0x02
</a><a href="#h18-0-26" id="h18-0-26" class="i">+    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h18-0-27" id="h18-0-27" class="i">+    set Version(&quot;b&quot;, 3) = 0x02
</a><a href="#h18-0-28" id="h18-0-28" class="i">+
</a><a href="#h18-0-29" id="h18-0-29" class="i">+T2: del &quot;c&quot;
</a><a href="#h18-0-30" id="h18-0-30" class="i">+    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h18-0-31" id="h18-0-31" class="i">+    set Version(&quot;c&quot;, 3) = None
</a><a href="#h18-0-32" id="h18-0-32" class="i">+
</a><a href="#h18-0-33" id="h18-0-33" class="i">+T3: set &quot;d&quot; = 0x03
</a><a href="#h18-0-34" id="h18-0-34" class="i">+    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h18-0-35" id="h18-0-35" class="i">+    set Version(&quot;d&quot;, 4) = 0x03
</a><a href="#h18-0-36" id="h18-0-36" class="i">+
</a><a href="#h18-0-37" id="h18-0-37" class="i">+T1: set &quot;b&quot; = 0x01 → Error::Serialization
</a><a href="#h18-0-38" id="h18-0-38" class="i">+
</a><a href="#h18-0-39" id="h18-0-39" class="i">+T3: set &quot;c&quot; = 0x03 → Error::Serialization
</a><a href="#h18-0-40" id="h18-0-40" class="i">+
</a><a href="#h18-0-41" id="h18-0-41" class="i">+T2: rollback
</a><a href="#h18-0-42" id="h18-0-42" class="i">+    del Version(&quot;b&quot;, 3)
</a><a href="#h18-0-43" id="h18-0-43" class="i">+    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h18-0-44" id="h18-0-44" class="i">+    del Version(&quot;c&quot;, 3)
</a><a href="#h18-0-45" id="h18-0-45" class="i">+    del TxnWrite(3, &quot;c&quot;)
</a><a href="#h18-0-46" id="h18-0-46" class="i">+    del TxnActive(3)
</a><a href="#h18-0-47" id="h18-0-47" class="i">+
</a><a href="#h18-0-48" id="h18-0-48" class="i">+T4: begin read-only → v5 read-only active={2,4}
</a><a href="#h18-0-49" id="h18-0-49" class="i">+
</a><a href="#h18-0-50" id="h18-0-50" class="i">+T4: scan ..
</a><a href="#h18-0-51" id="h18-0-51" class="i">+    &quot;a&quot; = 0x00
</a><a href="#h18-0-52" id="h18-0-52" class="i">+    &quot;b&quot; = 0x00
</a><a href="#h18-0-53" id="h18-0-53" class="i">+    &quot;c&quot; = 0x00
</a><a href="#h18-0-54" id="h18-0-54" class="i">+    &quot;d&quot; = 0x00
</a><a href="#h18-0-55" id="h18-0-55" class="i">+
</a><a href="#h18-0-56" id="h18-0-56" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h18-0-57" id="h18-0-57" class="i">+    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h18-0-58" id="h18-0-58" class="i">+    set Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h18-0-59" id="h18-0-59" class="i">+
</a><a href="#h18-0-60" id="h18-0-60" class="i">+T3: set &quot;c&quot; = 0x03
</a><a href="#h18-0-61" id="h18-0-61" class="i">+    set TxnWrite(4, &quot;c&quot;) = []
</a><a href="#h18-0-62" id="h18-0-62" class="i">+    set Version(&quot;c&quot;, 4) = 0x03
</a><a href="#h18-0-63" id="h18-0-63" class="i">+
</a><a href="#h18-0-64" id="h18-0-64" class="i">+T1: commit
</a><a href="#h18-0-65" id="h18-0-65" class="i">+    del TxnWrite(2, &quot;a&quot;)
</a><a href="#h18-0-66" id="h18-0-66" class="i">+    del TxnWrite(2, &quot;b&quot;)
</a><a href="#h18-0-67" id="h18-0-67" class="i">+    del TxnActive(2)
</a><a href="#h18-0-68" id="h18-0-68" class="i">+
</a><a href="#h18-0-69" id="h18-0-69" class="i">+T3: commit
</a><a href="#h18-0-70" id="h18-0-70" class="i">+    del TxnWrite(4, &quot;c&quot;)
</a><a href="#h18-0-71" id="h18-0-71" class="i">+    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h18-0-72" id="h18-0-72" class="i">+    del TxnActive(4)
</a><a href="#h18-0-73" id="h18-0-73" class="i">+
</a><a href="#h18-0-74" id="h18-0-74" class="i">+T5: begin read-only → v5 read-only active={}
</a><a href="#h18-0-75" id="h18-0-75" class="i">+
</a><a href="#h18-0-76" id="h18-0-76" class="i">+T5: scan ..
</a><a href="#h18-0-77" id="h18-0-77" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h18-0-78" id="h18-0-78" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h18-0-79" id="h18-0-79" class="i">+    &quot;c&quot; = 0x03
</a><a href="#h18-0-80" id="h18-0-80" class="i">+    &quot;d&quot; = 0x03
</a><a href="#h18-0-81" id="h18-0-81" class="i">+
</a><a href="#h18-0-82" id="h18-0-82" class="i">+Engine state:
</a><a href="#h18-0-83" id="h18-0-83" class="i">+NextVersion = 5
</a><a href="#h18-0-84" id="h18-0-84" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h18-0-85" id="h18-0-85" class="i">+TxnActiveSnapshot(4) = {2,3}
</a><a href="#h18-0-86" id="h18-0-86" class="i">+Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h18-0-87" id="h18-0-87" class="i">+Version(&quot;a&quot;, 2) = 0x01
</a><a href="#h18-0-88" id="h18-0-88" class="i">+Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h18-0-89" id="h18-0-89" class="i">+Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h18-0-90" id="h18-0-90" class="i">+Version(&quot;c&quot;, 1) = 0x00
</a><a href="#h18-0-91" id="h18-0-91" class="i">+Version(&quot;c&quot;, 4) = 0x03
</a><a href="#h18-0-92" id="h18-0-92" class="i">+Version(&quot;d&quot;, 1) = 0x00
</a><a href="#h18-0-93" id="h18-0-93" class="i">+Version(&quot;d&quot;, 4) = 0x03
</a><b>diff --git a/<a id="h19" href="../file/src/storage/golden/mvcc/scan.html">src/storage/golden/mvcc/scan</a> b/<a href="../file/src/storage/golden/mvcc/scan.html">src/storage/golden/mvcc/scan</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,109 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+Engine state:
</a><a href="#h19-0-1" id="h19-0-1" class="i">+NextVersion = 5
</a><a href="#h19-0-2" id="h19-0-2" class="i">+Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h19-0-3" id="h19-0-3" class="i">+Version(&quot;B&quot;, 3) = None
</a><a href="#h19-0-4" id="h19-0-4" class="i">+Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h19-0-5" id="h19-0-5" class="i">+Version(&quot;a&quot;, 2) = None
</a><a href="#h19-0-6" id="h19-0-6" class="i">+Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h19-0-7" id="h19-0-7" class="i">+Version(&quot;b&quot;, 1) = None
</a><a href="#h19-0-8" id="h19-0-8" class="i">+Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h19-0-9" id="h19-0-9" class="i">+Version(&quot;b&quot;, 4) = None
</a><a href="#h19-0-10" id="h19-0-10" class="i">+Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h19-0-11" id="h19-0-11" class="i">+Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h19-0-12" id="h19-0-12" class="i">+Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h19-0-13" id="h19-0-13" class="i">+Version(&quot;bb&quot;, 3) = None
</a><a href="#h19-0-14" id="h19-0-14" class="i">+Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h19-0-15" id="h19-0-15" class="i">+Version(&quot;c&quot;, 1) = 0x0c01
</a><a href="#h19-0-16" id="h19-0-16" class="i">+
</a><a href="#h19-0-17" id="h19-0-17" class="i">+T1: begin as of 1 → v1 read-only active={}
</a><a href="#h19-0-18" id="h19-0-18" class="i">+
</a><a href="#h19-0-19" id="h19-0-19" class="i">+T1: scan ..
</a><a href="#h19-0-20" id="h19-0-20" class="i">+
</a><a href="#h19-0-21" id="h19-0-21" class="i">+T2: begin as of 2 → v2 read-only active={}
</a><a href="#h19-0-22" id="h19-0-22" class="i">+
</a><a href="#h19-0-23" id="h19-0-23" class="i">+T2: scan ..
</a><a href="#h19-0-24" id="h19-0-24" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h19-0-25" id="h19-0-25" class="i">+    &quot;a&quot; = 0x0a01
</a><a href="#h19-0-26" id="h19-0-26" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-27" id="h19-0-27" class="i">+
</a><a href="#h19-0-28" id="h19-0-28" class="i">+T3: begin as of 3 → v3 read-only active={}
</a><a href="#h19-0-29" id="h19-0-29" class="i">+
</a><a href="#h19-0-30" id="h19-0-30" class="i">+T3: scan ..
</a><a href="#h19-0-31" id="h19-0-31" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h19-0-32" id="h19-0-32" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-33" id="h19-0-33" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-34" id="h19-0-34" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-35" id="h19-0-35" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-36" id="h19-0-36" class="i">+
</a><a href="#h19-0-37" id="h19-0-37" class="i">+T4: begin as of 4 → v4 read-only active={}
</a><a href="#h19-0-38" id="h19-0-38" class="i">+
</a><a href="#h19-0-39" id="h19-0-39" class="i">+T4: scan ..
</a><a href="#h19-0-40" id="h19-0-40" class="i">+    &quot;a&quot; = 0x0a03
</a><a href="#h19-0-41" id="h19-0-41" class="i">+    &quot;b&quot; = 0x0b03
</a><a href="#h19-0-42" id="h19-0-42" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-43" id="h19-0-43" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-44" id="h19-0-44" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-45" id="h19-0-45" class="i">+
</a><a href="#h19-0-46" id="h19-0-46" class="i">+T5: begin as of 3 → v3 read-only active={}
</a><a href="#h19-0-47" id="h19-0-47" class="i">+
</a><a href="#h19-0-48" id="h19-0-48" class="i">+T5: scan ..
</a><a href="#h19-0-49" id="h19-0-49" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h19-0-50" id="h19-0-50" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-51" id="h19-0-51" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-52" id="h19-0-52" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-53" id="h19-0-53" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-54" id="h19-0-54" class="i">+
</a><a href="#h19-0-55" id="h19-0-55" class="i">+T5: scan ..&quot;bc&quot;]
</a><a href="#h19-0-56" id="h19-0-56" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h19-0-57" id="h19-0-57" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-58" id="h19-0-58" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-59" id="h19-0-59" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-60" id="h19-0-60" class="i">+
</a><a href="#h19-0-61" id="h19-0-61" class="i">+T5: scan ..&quot;bc&quot;)
</a><a href="#h19-0-62" id="h19-0-62" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h19-0-63" id="h19-0-63" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-64" id="h19-0-64" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-65" id="h19-0-65" class="i">+
</a><a href="#h19-0-66" id="h19-0-66" class="i">+T5: scan [&quot;ba&quot;..
</a><a href="#h19-0-67" id="h19-0-67" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-68" id="h19-0-68" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-69" id="h19-0-69" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-70" id="h19-0-70" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-71" id="h19-0-71" class="i">+
</a><a href="#h19-0-72" id="h19-0-72" class="i">+T5: scan [&quot;ba&quot;..&quot;bc&quot;]
</a><a href="#h19-0-73" id="h19-0-73" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-74" id="h19-0-74" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-75" id="h19-0-75" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-76" id="h19-0-76" class="i">+
</a><a href="#h19-0-77" id="h19-0-77" class="i">+T5: scan [&quot;ba&quot;..&quot;bc&quot;)
</a><a href="#h19-0-78" id="h19-0-78" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h19-0-79" id="h19-0-79" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-80" id="h19-0-80" class="i">+
</a><a href="#h19-0-81" id="h19-0-81" class="i">+T5: scan (&quot;ba&quot;..
</a><a href="#h19-0-82" id="h19-0-82" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-83" id="h19-0-83" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-84" id="h19-0-84" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h19-0-85" id="h19-0-85" class="i">+
</a><a href="#h19-0-86" id="h19-0-86" class="i">+T5: scan (&quot;ba&quot;..&quot;bc&quot;]
</a><a href="#h19-0-87" id="h19-0-87" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-88" id="h19-0-88" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h19-0-89" id="h19-0-89" class="i">+
</a><a href="#h19-0-90" id="h19-0-90" class="i">+T5: scan (&quot;ba&quot;..&quot;bc&quot;)
</a><a href="#h19-0-91" id="h19-0-91" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h19-0-92" id="h19-0-92" class="i">+
</a><a href="#h19-0-93" id="h19-0-93" class="i">+Engine state:
</a><a href="#h19-0-94" id="h19-0-94" class="i">+NextVersion = 5
</a><a href="#h19-0-95" id="h19-0-95" class="i">+Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h19-0-96" id="h19-0-96" class="i">+Version(&quot;B&quot;, 3) = None
</a><a href="#h19-0-97" id="h19-0-97" class="i">+Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h19-0-98" id="h19-0-98" class="i">+Version(&quot;a&quot;, 2) = None
</a><a href="#h19-0-99" id="h19-0-99" class="i">+Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h19-0-100" id="h19-0-100" class="i">+Version(&quot;b&quot;, 1) = None
</a><a href="#h19-0-101" id="h19-0-101" class="i">+Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h19-0-102" id="h19-0-102" class="i">+Version(&quot;b&quot;, 4) = None
</a><a href="#h19-0-103" id="h19-0-103" class="i">+Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h19-0-104" id="h19-0-104" class="i">+Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h19-0-105" id="h19-0-105" class="i">+Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h19-0-106" id="h19-0-106" class="i">+Version(&quot;bb&quot;, 3) = None
</a><a href="#h19-0-107" id="h19-0-107" class="i">+Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h19-0-108" id="h19-0-108" class="i">+Version(&quot;c&quot;, 1) = 0x0c01
</a><b>diff --git a/<a id="h20" href="../file/src/storage/golden/mvcc/scan_isolation.html">src/storage/golden/mvcc/scan_isolation</a> b/<a href="../file/src/storage/golden/mvcc/scan_isolation.html">src/storage/golden/mvcc/scan_isolation</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,91 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h20-0-1" id="h20-0-1" class="i">+    set NextVersion = 2
</a><a href="#h20-0-2" id="h20-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h20-0-3" id="h20-0-3" class="i">+
</a><a href="#h20-0-4" id="h20-0-4" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h20-0-5" id="h20-0-5" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h20-0-6" id="h20-0-6" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h20-0-7" id="h20-0-7" class="i">+
</a><a href="#h20-0-8" id="h20-0-8" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h20-0-9" id="h20-0-9" class="i">+    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h20-0-10" id="h20-0-10" class="i">+    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h20-0-11" id="h20-0-11" class="i">+
</a><a href="#h20-0-12" id="h20-0-12" class="i">+T1: set &quot;d&quot; = 0x01
</a><a href="#h20-0-13" id="h20-0-13" class="i">+    set TxnWrite(1, &quot;d&quot;) = []
</a><a href="#h20-0-14" id="h20-0-14" class="i">+    set Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h20-0-15" id="h20-0-15" class="i">+
</a><a href="#h20-0-16" id="h20-0-16" class="i">+T1: set &quot;e&quot; = 0x01
</a><a href="#h20-0-17" id="h20-0-17" class="i">+    set TxnWrite(1, &quot;e&quot;) = []
</a><a href="#h20-0-18" id="h20-0-18" class="i">+    set Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h20-0-19" id="h20-0-19" class="i">+
</a><a href="#h20-0-20" id="h20-0-20" class="i">+T1: commit
</a><a href="#h20-0-21" id="h20-0-21" class="i">+    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h20-0-22" id="h20-0-22" class="i">+    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h20-0-23" id="h20-0-23" class="i">+    del TxnWrite(1, &quot;d&quot;)
</a><a href="#h20-0-24" id="h20-0-24" class="i">+    del TxnWrite(1, &quot;e&quot;)
</a><a href="#h20-0-25" id="h20-0-25" class="i">+    del TxnActive(1)
</a><a href="#h20-0-26" id="h20-0-26" class="i">+
</a><a href="#h20-0-27" id="h20-0-27" class="i">+T2: begin → v2 read-write active={}
</a><a href="#h20-0-28" id="h20-0-28" class="i">+    set NextVersion = 3
</a><a href="#h20-0-29" id="h20-0-29" class="i">+    set TxnActive(2) = []
</a><a href="#h20-0-30" id="h20-0-30" class="i">+
</a><a href="#h20-0-31" id="h20-0-31" class="i">+T2: set &quot;a&quot; = 0x02
</a><a href="#h20-0-32" id="h20-0-32" class="i">+    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h20-0-33" id="h20-0-33" class="i">+    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h20-0-34" id="h20-0-34" class="i">+
</a><a href="#h20-0-35" id="h20-0-35" class="i">+T2: del &quot;b&quot;
</a><a href="#h20-0-36" id="h20-0-36" class="i">+    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h20-0-37" id="h20-0-37" class="i">+    set Version(&quot;b&quot;, 2) = None
</a><a href="#h20-0-38" id="h20-0-38" class="i">+
</a><a href="#h20-0-39" id="h20-0-39" class="i">+T2: set &quot;c&quot; = 0x02
</a><a href="#h20-0-40" id="h20-0-40" class="i">+    set TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h20-0-41" id="h20-0-41" class="i">+    set Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h20-0-42" id="h20-0-42" class="i">+
</a><a href="#h20-0-43" id="h20-0-43" class="i">+T3: begin read-only → v3 read-only active={2}
</a><a href="#h20-0-44" id="h20-0-44" class="i">+
</a><a href="#h20-0-45" id="h20-0-45" class="i">+T4: begin → v3 read-write active={2}
</a><a href="#h20-0-46" id="h20-0-46" class="i">+    set NextVersion = 4
</a><a href="#h20-0-47" id="h20-0-47" class="i">+    set TxnActiveSnapshot(3) = {2}
</a><a href="#h20-0-48" id="h20-0-48" class="i">+    set TxnActive(3) = []
</a><a href="#h20-0-49" id="h20-0-49" class="i">+
</a><a href="#h20-0-50" id="h20-0-50" class="i">+T4: set &quot;d&quot; = 0x03
</a><a href="#h20-0-51" id="h20-0-51" class="i">+    set TxnWrite(3, &quot;d&quot;) = []
</a><a href="#h20-0-52" id="h20-0-52" class="i">+    set Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h20-0-53" id="h20-0-53" class="i">+
</a><a href="#h20-0-54" id="h20-0-54" class="i">+T4: del &quot;e&quot;
</a><a href="#h20-0-55" id="h20-0-55" class="i">+    set TxnWrite(3, &quot;e&quot;) = []
</a><a href="#h20-0-56" id="h20-0-56" class="i">+    set Version(&quot;e&quot;, 3) = None
</a><a href="#h20-0-57" id="h20-0-57" class="i">+
</a><a href="#h20-0-58" id="h20-0-58" class="i">+T4: set &quot;f&quot; = 0x03
</a><a href="#h20-0-59" id="h20-0-59" class="i">+    set TxnWrite(3, &quot;f&quot;) = []
</a><a href="#h20-0-60" id="h20-0-60" class="i">+    set Version(&quot;f&quot;, 3) = 0x03
</a><a href="#h20-0-61" id="h20-0-61" class="i">+
</a><a href="#h20-0-62" id="h20-0-62" class="i">+T4: commit
</a><a href="#h20-0-63" id="h20-0-63" class="i">+    del TxnWrite(3, &quot;d&quot;)
</a><a href="#h20-0-64" id="h20-0-64" class="i">+    del TxnWrite(3, &quot;e&quot;)
</a><a href="#h20-0-65" id="h20-0-65" class="i">+    del TxnWrite(3, &quot;f&quot;)
</a><a href="#h20-0-66" id="h20-0-66" class="i">+    del TxnActive(3)
</a><a href="#h20-0-67" id="h20-0-67" class="i">+
</a><a href="#h20-0-68" id="h20-0-68" class="i">+T3: scan ..
</a><a href="#h20-0-69" id="h20-0-69" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h20-0-70" id="h20-0-70" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h20-0-71" id="h20-0-71" class="i">+    &quot;d&quot; = 0x01
</a><a href="#h20-0-72" id="h20-0-72" class="i">+    &quot;e&quot; = 0x01
</a><a href="#h20-0-73" id="h20-0-73" class="i">+
</a><a href="#h20-0-74" id="h20-0-74" class="i">+Engine state:
</a><a href="#h20-0-75" id="h20-0-75" class="i">+NextVersion = 4
</a><a href="#h20-0-76" id="h20-0-76" class="i">+TxnActive(2) = []
</a><a href="#h20-0-77" id="h20-0-77" class="i">+TxnActiveSnapshot(3) = {2}
</a><a href="#h20-0-78" id="h20-0-78" class="i">+TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h20-0-79" id="h20-0-79" class="i">+TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h20-0-80" id="h20-0-80" class="i">+TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h20-0-81" id="h20-0-81" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h20-0-82" id="h20-0-82" class="i">+Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h20-0-83" id="h20-0-83" class="i">+Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h20-0-84" id="h20-0-84" class="i">+Version(&quot;b&quot;, 2) = None
</a><a href="#h20-0-85" id="h20-0-85" class="i">+Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h20-0-86" id="h20-0-86" class="i">+Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h20-0-87" id="h20-0-87" class="i">+Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h20-0-88" id="h20-0-88" class="i">+Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h20-0-89" id="h20-0-89" class="i">+Version(&quot;e&quot;, 3) = None
</a><a href="#h20-0-90" id="h20-0-90" class="i">+Version(&quot;f&quot;, 3) = 0x03
</a><b>diff --git a/<a id="h21" href="../file/src/storage/golden/mvcc/scan_key_version_encoding.html">src/storage/golden/mvcc/scan_key_version_encoding</a> b/<a href="../file/src/storage/golden/mvcc/scan_key_version_encoding.html">src/storage/golden/mvcc/scan_key_version_encoding</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h21-0-1" id="h21-0-1" class="i">+    set NextVersion = 2
</a><a href="#h21-0-2" id="h21-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h21-0-3" id="h21-0-3" class="i">+
</a><a href="#h21-0-4" id="h21-0-4" class="i">+T1: set 0x00 = 0x01
</a><a href="#h21-0-5" id="h21-0-5" class="i">+    set TxnWrite(1, 0x00) = []
</a><a href="#h21-0-6" id="h21-0-6" class="i">+    set Version(0x00, 1) = 0x01
</a><a href="#h21-0-7" id="h21-0-7" class="i">+
</a><a href="#h21-0-8" id="h21-0-8" class="i">+T1: commit
</a><a href="#h21-0-9" id="h21-0-9" class="i">+    del TxnWrite(1, 0x00)
</a><a href="#h21-0-10" id="h21-0-10" class="i">+    del TxnActive(1)
</a><a href="#h21-0-11" id="h21-0-11" class="i">+
</a><a href="#h21-0-12" id="h21-0-12" class="i">+T2: begin → v2 read-write active={}
</a><a href="#h21-0-13" id="h21-0-13" class="i">+    set NextVersion = 3
</a><a href="#h21-0-14" id="h21-0-14" class="i">+    set TxnActive(2) = []
</a><a href="#h21-0-15" id="h21-0-15" class="i">+
</a><a href="#h21-0-16" id="h21-0-16" class="i">+T2: set 0x00 = 0x02
</a><a href="#h21-0-17" id="h21-0-17" class="i">+    set TxnWrite(2, 0x00) = []
</a><a href="#h21-0-18" id="h21-0-18" class="i">+    set Version(0x00, 2) = 0x02
</a><a href="#h21-0-19" id="h21-0-19" class="i">+
</a><a href="#h21-0-20" id="h21-0-20" class="i">+T2: set 0x000000000000000002 = 0x02
</a><a href="#h21-0-21" id="h21-0-21" class="i">+    set TxnWrite(2, 0x000000000000000002) = []
</a><a href="#h21-0-22" id="h21-0-22" class="i">+    set Version(0x000000000000000002, 2) = 0x02
</a><a href="#h21-0-23" id="h21-0-23" class="i">+
</a><a href="#h21-0-24" id="h21-0-24" class="i">+T2: commit
</a><a href="#h21-0-25" id="h21-0-25" class="i">+    del TxnWrite(2, 0x00)
</a><a href="#h21-0-26" id="h21-0-26" class="i">+    del TxnWrite(2, 0x000000000000000002)
</a><a href="#h21-0-27" id="h21-0-27" class="i">+    del TxnActive(2)
</a><a href="#h21-0-28" id="h21-0-28" class="i">+
</a><a href="#h21-0-29" id="h21-0-29" class="i">+T3: begin → v3 read-write active={}
</a><a href="#h21-0-30" id="h21-0-30" class="i">+    set NextVersion = 4
</a><a href="#h21-0-31" id="h21-0-31" class="i">+    set TxnActive(3) = []
</a><a href="#h21-0-32" id="h21-0-32" class="i">+
</a><a href="#h21-0-33" id="h21-0-33" class="i">+T3: set 0x00 = 0x03
</a><a href="#h21-0-34" id="h21-0-34" class="i">+    set TxnWrite(3, 0x00) = []
</a><a href="#h21-0-35" id="h21-0-35" class="i">+    set Version(0x00, 3) = 0x03
</a><a href="#h21-0-36" id="h21-0-36" class="i">+
</a><a href="#h21-0-37" id="h21-0-37" class="i">+T3: commit
</a><a href="#h21-0-38" id="h21-0-38" class="i">+    del TxnWrite(3, 0x00)
</a><a href="#h21-0-39" id="h21-0-39" class="i">+    del TxnActive(3)
</a><a href="#h21-0-40" id="h21-0-40" class="i">+
</a><a href="#h21-0-41" id="h21-0-41" class="i">+T4: begin read-only → v4 read-only active={}
</a><a href="#h21-0-42" id="h21-0-42" class="i">+
</a><a href="#h21-0-43" id="h21-0-43" class="i">+T4: scan ..
</a><a href="#h21-0-44" id="h21-0-44" class="i">+    0x00 = 0x03
</a><a href="#h21-0-45" id="h21-0-45" class="i">+    0x000000000000000002 = 0x02
</a><a href="#h21-0-46" id="h21-0-46" class="i">+
</a><a href="#h21-0-47" id="h21-0-47" class="i">+Engine state:
</a><a href="#h21-0-48" id="h21-0-48" class="i">+NextVersion = 4
</a><a href="#h21-0-49" id="h21-0-49" class="i">+Version(0x00, 1) = 0x01
</a><a href="#h21-0-50" id="h21-0-50" class="i">+Version(0x00, 2) = 0x02
</a><a href="#h21-0-51" id="h21-0-51" class="i">+Version(0x00, 3) = 0x03
</a><a href="#h21-0-52" id="h21-0-52" class="i">+Version(0x000000000000000002, 2) = 0x02
</a><b>diff --git a/<a id="h22" href="../file/src/storage/golden/mvcc/scan_prefix.html">src/storage/golden/mvcc/scan_prefix</a> b/<a href="../file/src/storage/golden/mvcc/scan_prefix.html">src/storage/golden/mvcc/scan_prefix</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,117 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+Engine state:
</a><a href="#h22-0-1" id="h22-0-1" class="i">+NextVersion = 5
</a><a href="#h22-0-2" id="h22-0-2" class="i">+Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h22-0-3" id="h22-0-3" class="i">+Version(&quot;B&quot;, 3) = None
</a><a href="#h22-0-4" id="h22-0-4" class="i">+Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h22-0-5" id="h22-0-5" class="i">+Version(&quot;a&quot;, 2) = None
</a><a href="#h22-0-6" id="h22-0-6" class="i">+Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h22-0-7" id="h22-0-7" class="i">+Version(&quot;b&quot;, 1) = None
</a><a href="#h22-0-8" id="h22-0-8" class="i">+Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h22-0-9" id="h22-0-9" class="i">+Version(&quot;b&quot;, 4) = None
</a><a href="#h22-0-10" id="h22-0-10" class="i">+Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h22-0-11" id="h22-0-11" class="i">+Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h22-0-12" id="h22-0-12" class="i">+Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h22-0-13" id="h22-0-13" class="i">+Version(&quot;bb&quot;, 3) = None
</a><a href="#h22-0-14" id="h22-0-14" class="i">+Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h22-0-15" id="h22-0-15" class="i">+Version(&quot;c&quot;, 1) = 0x0c01
</a><a href="#h22-0-16" id="h22-0-16" class="i">+
</a><a href="#h22-0-17" id="h22-0-17" class="i">+T1: begin as of 1 → v1 read-only active={}
</a><a href="#h22-0-18" id="h22-0-18" class="i">+
</a><a href="#h22-0-19" id="h22-0-19" class="i">+T1: scan prefix []
</a><a href="#h22-0-20" id="h22-0-20" class="i">+
</a><a href="#h22-0-21" id="h22-0-21" class="i">+T2: begin as of 2 → v2 read-only active={}
</a><a href="#h22-0-22" id="h22-0-22" class="i">+
</a><a href="#h22-0-23" id="h22-0-23" class="i">+T2: scan prefix []
</a><a href="#h22-0-24" id="h22-0-24" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h22-0-25" id="h22-0-25" class="i">+    &quot;a&quot; = 0x0a01
</a><a href="#h22-0-26" id="h22-0-26" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h22-0-27" id="h22-0-27" class="i">+
</a><a href="#h22-0-28" id="h22-0-28" class="i">+T3: begin as of 3 → v3 read-only active={}
</a><a href="#h22-0-29" id="h22-0-29" class="i">+
</a><a href="#h22-0-30" id="h22-0-30" class="i">+T3: scan prefix []
</a><a href="#h22-0-31" id="h22-0-31" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h22-0-32" id="h22-0-32" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-33" id="h22-0-33" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h22-0-34" id="h22-0-34" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-35" id="h22-0-35" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h22-0-36" id="h22-0-36" class="i">+
</a><a href="#h22-0-37" id="h22-0-37" class="i">+T4: begin as of 4 → v4 read-only active={}
</a><a href="#h22-0-38" id="h22-0-38" class="i">+
</a><a href="#h22-0-39" id="h22-0-39" class="i">+T4: scan prefix []
</a><a href="#h22-0-40" id="h22-0-40" class="i">+    &quot;a&quot; = 0x0a03
</a><a href="#h22-0-41" id="h22-0-41" class="i">+    &quot;b&quot; = 0x0b03
</a><a href="#h22-0-42" id="h22-0-42" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-43" id="h22-0-43" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-44" id="h22-0-44" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h22-0-45" id="h22-0-45" class="i">+
</a><a href="#h22-0-46" id="h22-0-46" class="i">+T5: begin as of 3 → v3 read-only active={}
</a><a href="#h22-0-47" id="h22-0-47" class="i">+
</a><a href="#h22-0-48" id="h22-0-48" class="i">+T5: scan prefix &quot;B&quot;
</a><a href="#h22-0-49" id="h22-0-49" class="i">+    &quot;B&quot; = 0x0001
</a><a href="#h22-0-50" id="h22-0-50" class="i">+
</a><a href="#h22-0-51" id="h22-0-51" class="i">+T5: scan prefix &quot;a&quot;
</a><a href="#h22-0-52" id="h22-0-52" class="i">+
</a><a href="#h22-0-53" id="h22-0-53" class="i">+T5: scan prefix &quot;b&quot;
</a><a href="#h22-0-54" id="h22-0-54" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-55" id="h22-0-55" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h22-0-56" id="h22-0-56" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-57" id="h22-0-57" class="i">+
</a><a href="#h22-0-58" id="h22-0-58" class="i">+T5: scan prefix &quot;ba&quot;
</a><a href="#h22-0-59" id="h22-0-59" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-60" id="h22-0-60" class="i">+
</a><a href="#h22-0-61" id="h22-0-61" class="i">+T5: scan prefix &quot;bb&quot;
</a><a href="#h22-0-62" id="h22-0-62" class="i">+    &quot;bb&quot; = 0xbb02
</a><a href="#h22-0-63" id="h22-0-63" class="i">+
</a><a href="#h22-0-64" id="h22-0-64" class="i">+T5: scan prefix &quot;bbb&quot;
</a><a href="#h22-0-65" id="h22-0-65" class="i">+
</a><a href="#h22-0-66" id="h22-0-66" class="i">+T5: scan prefix &quot;bc&quot;
</a><a href="#h22-0-67" id="h22-0-67" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-68" id="h22-0-68" class="i">+
</a><a href="#h22-0-69" id="h22-0-69" class="i">+T5: scan prefix &quot;c&quot;
</a><a href="#h22-0-70" id="h22-0-70" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h22-0-71" id="h22-0-71" class="i">+
</a><a href="#h22-0-72" id="h22-0-72" class="i">+T5: scan prefix &quot;d&quot;
</a><a href="#h22-0-73" id="h22-0-73" class="i">+
</a><a href="#h22-0-74" id="h22-0-74" class="i">+T6: begin as of 4 → v4 read-only active={}
</a><a href="#h22-0-75" id="h22-0-75" class="i">+
</a><a href="#h22-0-76" id="h22-0-76" class="i">+T6: scan prefix &quot;B&quot;
</a><a href="#h22-0-77" id="h22-0-77" class="i">+
</a><a href="#h22-0-78" id="h22-0-78" class="i">+T6: scan prefix &quot;a&quot;
</a><a href="#h22-0-79" id="h22-0-79" class="i">+    &quot;a&quot; = 0x0a03
</a><a href="#h22-0-80" id="h22-0-80" class="i">+
</a><a href="#h22-0-81" id="h22-0-81" class="i">+T6: scan prefix &quot;b&quot;
</a><a href="#h22-0-82" id="h22-0-82" class="i">+    &quot;b&quot; = 0x0b03
</a><a href="#h22-0-83" id="h22-0-83" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-84" id="h22-0-84" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-85" id="h22-0-85" class="i">+
</a><a href="#h22-0-86" id="h22-0-86" class="i">+T6: scan prefix &quot;ba&quot;
</a><a href="#h22-0-87" id="h22-0-87" class="i">+    &quot;ba&quot; = 0xba02
</a><a href="#h22-0-88" id="h22-0-88" class="i">+
</a><a href="#h22-0-89" id="h22-0-89" class="i">+T6: scan prefix &quot;bb&quot;
</a><a href="#h22-0-90" id="h22-0-90" class="i">+
</a><a href="#h22-0-91" id="h22-0-91" class="i">+T6: scan prefix &quot;bbb&quot;
</a><a href="#h22-0-92" id="h22-0-92" class="i">+
</a><a href="#h22-0-93" id="h22-0-93" class="i">+T6: scan prefix &quot;bc&quot;
</a><a href="#h22-0-94" id="h22-0-94" class="i">+    &quot;bc&quot; = 0xbc02
</a><a href="#h22-0-95" id="h22-0-95" class="i">+
</a><a href="#h22-0-96" id="h22-0-96" class="i">+T6: scan prefix &quot;c&quot;
</a><a href="#h22-0-97" id="h22-0-97" class="i">+    &quot;c&quot; = 0x0c01
</a><a href="#h22-0-98" id="h22-0-98" class="i">+
</a><a href="#h22-0-99" id="h22-0-99" class="i">+T6: scan prefix &quot;d&quot;
</a><a href="#h22-0-100" id="h22-0-100" class="i">+
</a><a href="#h22-0-101" id="h22-0-101" class="i">+Engine state:
</a><a href="#h22-0-102" id="h22-0-102" class="i">+NextVersion = 5
</a><a href="#h22-0-103" id="h22-0-103" class="i">+Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h22-0-104" id="h22-0-104" class="i">+Version(&quot;B&quot;, 3) = None
</a><a href="#h22-0-105" id="h22-0-105" class="i">+Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h22-0-106" id="h22-0-106" class="i">+Version(&quot;a&quot;, 2) = None
</a><a href="#h22-0-107" id="h22-0-107" class="i">+Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h22-0-108" id="h22-0-108" class="i">+Version(&quot;b&quot;, 1) = None
</a><a href="#h22-0-109" id="h22-0-109" class="i">+Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h22-0-110" id="h22-0-110" class="i">+Version(&quot;b&quot;, 4) = None
</a><a href="#h22-0-111" id="h22-0-111" class="i">+Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h22-0-112" id="h22-0-112" class="i">+Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h22-0-113" id="h22-0-113" class="i">+Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h22-0-114" id="h22-0-114" class="i">+Version(&quot;bb&quot;, 3) = None
</a><a href="#h22-0-115" id="h22-0-115" class="i">+Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h22-0-116" id="h22-0-116" class="i">+Version(&quot;c&quot;, 1) = 0x0c01
</a><b>diff --git a/<a id="h23" href="../file/src/storage/golden/mvcc/set.html">src/storage/golden/mvcc/set</a> b/<a href="../file/src/storage/golden/mvcc/set.html">src/storage/golden/mvcc/set</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,42 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+Engine state:
</a><a href="#h23-0-1" id="h23-0-1" class="i">+NextVersion = 2
</a><a href="#h23-0-2" id="h23-0-2" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h23-0-3" id="h23-0-3" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h23-0-4" id="h23-0-4" class="i">+
</a><a href="#h23-0-5" id="h23-0-5" class="i">+T1: begin → v2 read-write active={}
</a><a href="#h23-0-6" id="h23-0-6" class="i">+    set NextVersion = 3
</a><a href="#h23-0-7" id="h23-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h23-0-8" id="h23-0-8" class="i">+
</a><a href="#h23-0-9" id="h23-0-9" class="i">+T1: set &quot;key&quot; = 0x02
</a><a href="#h23-0-10" id="h23-0-10" class="i">+    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h23-0-11" id="h23-0-11" class="i">+    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h23-0-12" id="h23-0-12" class="i">+
</a><a href="#h23-0-13" id="h23-0-13" class="i">+T1: set &quot;tombstone&quot; = 0x02
</a><a href="#h23-0-14" id="h23-0-14" class="i">+    set TxnWrite(2, &quot;tombstone&quot;) = []
</a><a href="#h23-0-15" id="h23-0-15" class="i">+    set Version(&quot;tombstone&quot;, 2) = 0x02
</a><a href="#h23-0-16" id="h23-0-16" class="i">+
</a><a href="#h23-0-17" id="h23-0-17" class="i">+T1: set &quot;new&quot; = 0x01
</a><a href="#h23-0-18" id="h23-0-18" class="i">+    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h23-0-19" id="h23-0-19" class="i">+    set Version(&quot;new&quot;, 2) = 0x01
</a><a href="#h23-0-20" id="h23-0-20" class="i">+
</a><a href="#h23-0-21" id="h23-0-21" class="i">+T1: set &quot;new&quot; = 0x01
</a><a href="#h23-0-22" id="h23-0-22" class="i">+    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h23-0-23" id="h23-0-23" class="i">+    set Version(&quot;new&quot;, 2) = 0x01
</a><a href="#h23-0-24" id="h23-0-24" class="i">+
</a><a href="#h23-0-25" id="h23-0-25" class="i">+T1: set &quot;new&quot; = 0x02
</a><a href="#h23-0-26" id="h23-0-26" class="i">+    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h23-0-27" id="h23-0-27" class="i">+    set Version(&quot;new&quot;, 2) = 0x02
</a><a href="#h23-0-28" id="h23-0-28" class="i">+
</a><a href="#h23-0-29" id="h23-0-29" class="i">+T1: commit
</a><a href="#h23-0-30" id="h23-0-30" class="i">+    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h23-0-31" id="h23-0-31" class="i">+    del TxnWrite(2, &quot;new&quot;)
</a><a href="#h23-0-32" id="h23-0-32" class="i">+    del TxnWrite(2, &quot;tombstone&quot;)
</a><a href="#h23-0-33" id="h23-0-33" class="i">+    del TxnActive(2)
</a><a href="#h23-0-34" id="h23-0-34" class="i">+
</a><a href="#h23-0-35" id="h23-0-35" class="i">+Engine state:
</a><a href="#h23-0-36" id="h23-0-36" class="i">+NextVersion = 3
</a><a href="#h23-0-37" id="h23-0-37" class="i">+Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h23-0-38" id="h23-0-38" class="i">+Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h23-0-39" id="h23-0-39" class="i">+Version(&quot;new&quot;, 2) = 0x02
</a><a href="#h23-0-40" id="h23-0-40" class="i">+Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h23-0-41" id="h23-0-41" class="i">+Version(&quot;tombstone&quot;, 2) = 0x02
</a><b>diff --git a/<a id="h24" href="../file/src/storage/golden/mvcc/set_conflict.html">src/storage/golden/mvcc/set_conflict</a> b/<a href="../file/src/storage/golden/mvcc/set_conflict.html">src/storage/golden/mvcc/set_conflict</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -0,0 +1,54 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h24-0-1" id="h24-0-1" class="i">+    set NextVersion = 2
</a><a href="#h24-0-2" id="h24-0-2" class="i">+    set TxnActive(1) = []
</a><a href="#h24-0-3" id="h24-0-3" class="i">+
</a><a href="#h24-0-4" id="h24-0-4" class="i">+T2: begin → v2 read-write active={1}
</a><a href="#h24-0-5" id="h24-0-5" class="i">+    set NextVersion = 3
</a><a href="#h24-0-6" id="h24-0-6" class="i">+    set TxnActiveSnapshot(2) = {1}
</a><a href="#h24-0-7" id="h24-0-7" class="i">+    set TxnActive(2) = []
</a><a href="#h24-0-8" id="h24-0-8" class="i">+
</a><a href="#h24-0-9" id="h24-0-9" class="i">+T3: begin → v3 read-write active={1,2}
</a><a href="#h24-0-10" id="h24-0-10" class="i">+    set NextVersion = 4
</a><a href="#h24-0-11" id="h24-0-11" class="i">+    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h24-0-12" id="h24-0-12" class="i">+    set TxnActive(3) = []
</a><a href="#h24-0-13" id="h24-0-13" class="i">+
</a><a href="#h24-0-14" id="h24-0-14" class="i">+T4: begin → v4 read-write active={1,2,3}
</a><a href="#h24-0-15" id="h24-0-15" class="i">+    set NextVersion = 5
</a><a href="#h24-0-16" id="h24-0-16" class="i">+    set TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h24-0-17" id="h24-0-17" class="i">+    set TxnActive(4) = []
</a><a href="#h24-0-18" id="h24-0-18" class="i">+
</a><a href="#h24-0-19" id="h24-0-19" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h24-0-20" id="h24-0-20" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h24-0-21" id="h24-0-21" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h24-0-22" id="h24-0-22" class="i">+
</a><a href="#h24-0-23" id="h24-0-23" class="i">+T3: set &quot;c&quot; = 0x03
</a><a href="#h24-0-24" id="h24-0-24" class="i">+    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h24-0-25" id="h24-0-25" class="i">+    set Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h24-0-26" id="h24-0-26" class="i">+
</a><a href="#h24-0-27" id="h24-0-27" class="i">+T4: set &quot;d&quot; = 0x04
</a><a href="#h24-0-28" id="h24-0-28" class="i">+    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h24-0-29" id="h24-0-29" class="i">+    set Version(&quot;d&quot;, 4) = 0x04
</a><a href="#h24-0-30" id="h24-0-30" class="i">+
</a><a href="#h24-0-31" id="h24-0-31" class="i">+T4: commit
</a><a href="#h24-0-32" id="h24-0-32" class="i">+    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h24-0-33" id="h24-0-33" class="i">+    del TxnActive(4)
</a><a href="#h24-0-34" id="h24-0-34" class="i">+
</a><a href="#h24-0-35" id="h24-0-35" class="i">+T2: set &quot;a&quot; = 0x02 → Error::Serialization
</a><a href="#h24-0-36" id="h24-0-36" class="i">+
</a><a href="#h24-0-37" id="h24-0-37" class="i">+T2: set &quot;c&quot; = 0x02 → Error::Serialization
</a><a href="#h24-0-38" id="h24-0-38" class="i">+
</a><a href="#h24-0-39" id="h24-0-39" class="i">+T2: set &quot;d&quot; = 0x02 → Error::Serialization
</a><a href="#h24-0-40" id="h24-0-40" class="i">+
</a><a href="#h24-0-41" id="h24-0-41" class="i">+Engine state:
</a><a href="#h24-0-42" id="h24-0-42" class="i">+NextVersion = 5
</a><a href="#h24-0-43" id="h24-0-43" class="i">+TxnActive(1) = []
</a><a href="#h24-0-44" id="h24-0-44" class="i">+TxnActive(2) = []
</a><a href="#h24-0-45" id="h24-0-45" class="i">+TxnActive(3) = []
</a><a href="#h24-0-46" id="h24-0-46" class="i">+TxnActiveSnapshot(2) = {1}
</a><a href="#h24-0-47" id="h24-0-47" class="i">+TxnActiveSnapshot(3) = {1,2}
</a><a href="#h24-0-48" id="h24-0-48" class="i">+TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h24-0-49" id="h24-0-49" class="i">+TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h24-0-50" id="h24-0-50" class="i">+TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h24-0-51" id="h24-0-51" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h24-0-52" id="h24-0-52" class="i">+Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h24-0-53" id="h24-0-53" class="i">+Version(&quot;d&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h25" href="../file/src/storage/golden/mvcc/unversioned.html">src/storage/golden/mvcc/unversioned</a> b/<a href="../file/src/storage/golden/mvcc/unversioned.html">src/storage/golden/mvcc/unversioned</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -0,0 +1,59 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+T_: set unversioned &quot;a&quot; = 0x00
</a><a href="#h25-0-1" id="h25-0-1" class="i">+    set Unversioned(&quot;a&quot;) = 0x00
</a><a href="#h25-0-2" id="h25-0-2" class="i">+
</a><a href="#h25-0-3" id="h25-0-3" class="i">+T1: begin → v1 read-write active={}
</a><a href="#h25-0-4" id="h25-0-4" class="i">+    set NextVersion = 2
</a><a href="#h25-0-5" id="h25-0-5" class="i">+    set TxnActive(1) = []
</a><a href="#h25-0-6" id="h25-0-6" class="i">+
</a><a href="#h25-0-7" id="h25-0-7" class="i">+T1: set &quot;a&quot; = 0x01
</a><a href="#h25-0-8" id="h25-0-8" class="i">+    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h25-0-9" id="h25-0-9" class="i">+    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h25-0-10" id="h25-0-10" class="i">+
</a><a href="#h25-0-11" id="h25-0-11" class="i">+T1: set &quot;b&quot; = 0x01
</a><a href="#h25-0-12" id="h25-0-12" class="i">+    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h25-0-13" id="h25-0-13" class="i">+    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h25-0-14" id="h25-0-14" class="i">+
</a><a href="#h25-0-15" id="h25-0-15" class="i">+T1: set &quot;c&quot; = 0x01
</a><a href="#h25-0-16" id="h25-0-16" class="i">+    set TxnWrite(1, &quot;c&quot;) = []
</a><a href="#h25-0-17" id="h25-0-17" class="i">+    set Version(&quot;c&quot;, 1) = 0x01
</a><a href="#h25-0-18" id="h25-0-18" class="i">+
</a><a href="#h25-0-19" id="h25-0-19" class="i">+T1: commit
</a><a href="#h25-0-20" id="h25-0-20" class="i">+    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h25-0-21" id="h25-0-21" class="i">+    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h25-0-22" id="h25-0-22" class="i">+    del TxnWrite(1, &quot;c&quot;)
</a><a href="#h25-0-23" id="h25-0-23" class="i">+    del TxnActive(1)
</a><a href="#h25-0-24" id="h25-0-24" class="i">+
</a><a href="#h25-0-25" id="h25-0-25" class="i">+T_: set unversioned &quot;b&quot; = 0x00
</a><a href="#h25-0-26" id="h25-0-26" class="i">+    set Unversioned(&quot;b&quot;) = 0x00
</a><a href="#h25-0-27" id="h25-0-27" class="i">+
</a><a href="#h25-0-28" id="h25-0-28" class="i">+T_: set unversioned &quot;d&quot; = 0x00
</a><a href="#h25-0-29" id="h25-0-29" class="i">+    set Unversioned(&quot;d&quot;) = 0x00
</a><a href="#h25-0-30" id="h25-0-30" class="i">+
</a><a href="#h25-0-31" id="h25-0-31" class="i">+T2: begin read-only → v2 read-only active={}
</a><a href="#h25-0-32" id="h25-0-32" class="i">+
</a><a href="#h25-0-33" id="h25-0-33" class="i">+T2: scan ..
</a><a href="#h25-0-34" id="h25-0-34" class="i">+    &quot;a&quot; = 0x01
</a><a href="#h25-0-35" id="h25-0-35" class="i">+    &quot;b&quot; = 0x01
</a><a href="#h25-0-36" id="h25-0-36" class="i">+    &quot;c&quot; = 0x01
</a><a href="#h25-0-37" id="h25-0-37" class="i">+
</a><a href="#h25-0-38" id="h25-0-38" class="i">+T_: get unversioned &quot;a&quot; → 0x00
</a><a href="#h25-0-39" id="h25-0-39" class="i">+
</a><a href="#h25-0-40" id="h25-0-40" class="i">+T_: get unversioned &quot;b&quot; → 0x00
</a><a href="#h25-0-41" id="h25-0-41" class="i">+
</a><a href="#h25-0-42" id="h25-0-42" class="i">+T_: get unversioned &quot;c&quot; → None
</a><a href="#h25-0-43" id="h25-0-43" class="i">+
</a><a href="#h25-0-44" id="h25-0-44" class="i">+T_: get unversioned &quot;d&quot; → 0x00
</a><a href="#h25-0-45" id="h25-0-45" class="i">+
</a><a href="#h25-0-46" id="h25-0-46" class="i">+T_: set unversioned &quot;a&quot; = 0x01
</a><a href="#h25-0-47" id="h25-0-47" class="i">+    set Unversioned(&quot;a&quot;) = 0x01
</a><a href="#h25-0-48" id="h25-0-48" class="i">+
</a><a href="#h25-0-49" id="h25-0-49" class="i">+T_: get unversioned &quot;a&quot; → 0x01
</a><a href="#h25-0-50" id="h25-0-50" class="i">+
</a><a href="#h25-0-51" id="h25-0-51" class="i">+Engine state:
</a><a href="#h25-0-52" id="h25-0-52" class="i">+NextVersion = 2
</a><a href="#h25-0-53" id="h25-0-53" class="i">+Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h25-0-54" id="h25-0-54" class="i">+Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h25-0-55" id="h25-0-55" class="i">+Version(&quot;c&quot;, 1) = 0x01
</a><a href="#h25-0-56" id="h25-0-56" class="i">+Unversioned(&quot;a&quot;) = 0x01
</a><a href="#h25-0-57" id="h25-0-57" class="i">+Unversioned(&quot;b&quot;) = 0x00
</a><a href="#h25-0-58" id="h25-0-58" class="i">+Unversioned(&quot;d&quot;) = 0x00
</a><b>diff --git a/<a id="h26" href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a> b/<a href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,3 +1,5 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+#[cfg(test)]
</a><a href="#h26-0-1" id="h26-0-1" class="i">+mod debug;
</a> pub mod engine;
 pub mod keycode;
 pub mod log;
<b>diff --git a/<a id="h27" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -156,7 +156,7 @@ type Version = u64;
</a> /// grouping of keys. Cow byte slices allow encoding borrowed values and
 /// decoding into owned values.
 #[derive(Debug, Deserialize, Serialize)]
<a href="#h27-0-3" id="h27-0-3" class="d">-enum Key&lt;&#39;a&gt; {
</a><a href="#h27-0-4" id="h27-0-4" class="i">+pub enum Key&lt;&#39;a&gt; {
</a>     /// The next available version.
     NextVersion,
     /// Active (uncommitted) transactions by version.
<a href="#h27-1" id="h27-1" class="h">@@ -191,11 +191,11 @@ enum Key&lt;&#39;a&gt; {
</a> }
 
 impl&lt;&#39;a&gt; Key&lt;&#39;a&gt; {
<a href="#h27-1-3" id="h27-1-3" class="d">-    fn decode(bytes: &amp;&#39;a [u8]) -&gt; Result&lt;Self&gt; {
</a><a href="#h27-1-4" id="h27-1-4" class="i">+    pub fn decode(bytes: &amp;&#39;a [u8]) -&gt; Result&lt;Self&gt; {
</a>         keycode::deserialize(bytes)
     }
 
<a href="#h27-1-8" id="h27-1-8" class="d">-    fn encode(&amp;self) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h27-1-9" id="h27-1-9" class="i">+    pub fn encode(&amp;self) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
</a>         keycode::serialize(&amp;self)
     }
 }
<a href="#h27-2" id="h27-2" class="h">@@ -320,7 +320,7 @@ pub struct Transaction&lt;E: Engine&gt; {
</a> ///
 /// - It can be borrowed independently of Engine, allowing references to it
 ///   in VisibleIterator, which would otherwise result in self-references.
<a href="#h27-2-3" id="h27-2-3" class="d">-#[derive(Clone, Serialize, Deserialize)]
</a><a href="#h27-2-4" id="h27-2-4" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a> pub struct TransactionState {
     /// The version this transaction is running at. Only one read-write
     /// transaction can run at a given version, since this identifies its
<a href="#h27-3" id="h27-3" class="h">@@ -785,16 +785,340 @@ impl&lt;&#39;a, E: Engine&gt; DoubleEndedIterator for VersionIterator&lt;&#39;a, E&gt; {
</a> 
 #[cfg(test)]
 pub mod tests {
<a href="#h27-3-3" id="h27-3-3" class="d">-    use super::super::engine::Memory;
</a><a href="#h27-3-4" id="h27-3-4" class="i">+    use super::super::debug;
</a><a href="#h27-3-5" id="h27-3-5" class="i">+    use super::super::engine::{Debug, Memory};
</a>     use super::*;
<a href="#h27-3-7" id="h27-3-7" class="i">+    use std::collections::HashMap;
</a><a href="#h27-3-8" id="h27-3-8" class="i">+    use std::io::Write as _;
</a><a href="#h27-3-9" id="h27-3-9" class="i">+
</a><a href="#h27-3-10" id="h27-3-10" class="i">+    const GOLDEN_DIR: &amp;str = &quot;src/storage/golden/mvcc&quot;;
</a><a href="#h27-3-11" id="h27-3-11" class="i">+
</a><a href="#h27-3-12" id="h27-3-12" class="i">+    /// An MVCC wrapper that records transaction schedules to golden masters.
</a><a href="#h27-3-13" id="h27-3-13" class="i">+    struct Schedule {
</a><a href="#h27-3-14" id="h27-3-14" class="i">+        mvcc: MVCC&lt;Debug&lt;Memory&gt;&gt;,
</a><a href="#h27-3-15" id="h27-3-15" class="i">+        mint: goldenfile::Mint,
</a><a href="#h27-3-16" id="h27-3-16" class="i">+        file: Arc&lt;Mutex&lt;std::fs::File&gt;&gt;,
</a><a href="#h27-3-17" id="h27-3-17" class="i">+        next_id: u8,
</a><a href="#h27-3-18" id="h27-3-18" class="i">+    }
</a><a href="#h27-3-19" id="h27-3-19" class="i">+
</a><a href="#h27-3-20" id="h27-3-20" class="i">+    impl Schedule {
</a><a href="#h27-3-21" id="h27-3-21" class="i">+        /// Creates a new schedule using the given golden master filename.
</a><a href="#h27-3-22" id="h27-3-22" class="i">+        fn new(name: &amp;str) -&gt; Result&lt;Self&gt; {
</a><a href="#h27-3-23" id="h27-3-23" class="i">+            let mvcc = MVCC::new(Debug::new(Memory::new()));
</a><a href="#h27-3-24" id="h27-3-24" class="i">+            let mut mint = goldenfile::Mint::new(GOLDEN_DIR);
</a><a href="#h27-3-25" id="h27-3-25" class="i">+            let file = Arc::new(Mutex::new(mint.new_goldenfile(name)?));
</a><a href="#h27-3-26" id="h27-3-26" class="i">+            Ok(Self { mvcc, mint, file, next_id: 1 })
</a><a href="#h27-3-27" id="h27-3-27" class="i">+        }
</a><a href="#h27-3-28" id="h27-3-28" class="i">+
</a><a href="#h27-3-29" id="h27-3-29" class="i">+        /// Sets up an initial, versioned dataset from the given data as a
</a><a href="#h27-3-30" id="h27-3-30" class="i">+        /// vector of key,version,value tuples. These transactions are not
</a><a href="#h27-3-31" id="h27-3-31" class="i">+        /// assigned transaction IDs, nor are the writes logged, except for the
</a><a href="#h27-3-32" id="h27-3-32" class="i">+        /// initial engine state.
</a><a href="#h27-3-33" id="h27-3-33" class="i">+        #[allow(clippy::type_complexity)]
</a><a href="#h27-3-34" id="h27-3-34" class="i">+        fn setup(&amp;mut self, data: Vec&lt;(&amp;[u8], Version, Option&lt;&amp;[u8]&gt;)&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-35" id="h27-3-35" class="i">+            // Segment the writes by version.
</a><a href="#h27-3-36" id="h27-3-36" class="i">+            let mut writes = HashMap::new();
</a><a href="#h27-3-37" id="h27-3-37" class="i">+            for (key, version, value) in data {
</a><a href="#h27-3-38" id="h27-3-38" class="i">+                writes
</a><a href="#h27-3-39" id="h27-3-39" class="i">+                    .entry(version)
</a><a href="#h27-3-40" id="h27-3-40" class="i">+                    .or_insert(Vec::new())
</a><a href="#h27-3-41" id="h27-3-41" class="i">+                    .push((key.to_vec(), value.map(|v| v.to_vec())));
</a><a href="#h27-3-42" id="h27-3-42" class="i">+            }
</a><a href="#h27-3-43" id="h27-3-43" class="i">+            // Insert the writes with individual transactions.
</a><a href="#h27-3-44" id="h27-3-44" class="i">+            for i in 1..=writes.keys().max().copied().unwrap_or(0) {
</a><a href="#h27-3-45" id="h27-3-45" class="i">+                let txn = self.mvcc.begin()?;
</a><a href="#h27-3-46" id="h27-3-46" class="i">+                for (key, value) in writes.get(&amp;i).unwrap_or(&amp;Vec::new()) {
</a><a href="#h27-3-47" id="h27-3-47" class="i">+                    if let Some(value) = value {
</a><a href="#h27-3-48" id="h27-3-48" class="i">+                        txn.set(key, value.clone())?;
</a><a href="#h27-3-49" id="h27-3-49" class="i">+                    } else {
</a><a href="#h27-3-50" id="h27-3-50" class="i">+                        txn.delete(key)?;
</a><a href="#h27-3-51" id="h27-3-51" class="i">+                    }
</a><a href="#h27-3-52" id="h27-3-52" class="i">+                }
</a><a href="#h27-3-53" id="h27-3-53" class="i">+                txn.commit()?;
</a><a href="#h27-3-54" id="h27-3-54" class="i">+            }
</a><a href="#h27-3-55" id="h27-3-55" class="i">+            // Flush the write log, but dump the engine contents.
</a><a href="#h27-3-56" id="h27-3-56" class="i">+            self.mvcc.engine.lock()?.take_write_log();
</a><a href="#h27-3-57" id="h27-3-57" class="i">+            self.print_engine()?;
</a><a href="#h27-3-58" id="h27-3-58" class="i">+            writeln!(&amp;mut self.file.lock()?)?;
</a><a href="#h27-3-59" id="h27-3-59" class="i">+            Ok(())
</a><a href="#h27-3-60" id="h27-3-60" class="i">+        }
</a><a href="#h27-3-61" id="h27-3-61" class="i">+
</a><a href="#h27-3-62" id="h27-3-62" class="i">+        fn begin(&amp;mut self) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h27-3-63" id="h27-3-63" class="i">+            self.new_txn(&quot;begin&quot;, self.mvcc.begin())
</a><a href="#h27-3-64" id="h27-3-64" class="i">+        }
</a><a href="#h27-3-65" id="h27-3-65" class="i">+
</a><a href="#h27-3-66" id="h27-3-66" class="i">+        fn begin_read_only(&amp;mut self) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h27-3-67" id="h27-3-67" class="i">+            self.new_txn(&quot;begin read-only&quot;, self.mvcc.begin_read_only())
</a><a href="#h27-3-68" id="h27-3-68" class="i">+        }
</a><a href="#h27-3-69" id="h27-3-69" class="i">+
</a><a href="#h27-3-70" id="h27-3-70" class="i">+        fn begin_as_of(&amp;mut self, version: Version) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h27-3-71" id="h27-3-71" class="i">+            self.new_txn(&amp;format!(&quot;begin as of {}&quot;, version), self.mvcc.begin_as_of(version))
</a><a href="#h27-3-72" id="h27-3-72" class="i">+        }
</a><a href="#h27-3-73" id="h27-3-73" class="i">+
</a><a href="#h27-3-74" id="h27-3-74" class="i">+        fn resume(&amp;mut self, state: TransactionState) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h27-3-75" id="h27-3-75" class="i">+            self.new_txn(&quot;resume&quot;, self.mvcc.resume(state))
</a><a href="#h27-3-76" id="h27-3-76" class="i">+        }
</a><a href="#h27-3-77" id="h27-3-77" class="i">+
</a><a href="#h27-3-78" id="h27-3-78" class="i">+        /// Processes a begin/resume result.
</a><a href="#h27-3-79" id="h27-3-79" class="i">+        fn new_txn(
</a><a href="#h27-3-80" id="h27-3-80" class="i">+            &amp;mut self,
</a><a href="#h27-3-81" id="h27-3-81" class="i">+            name: &amp;str,
</a><a href="#h27-3-82" id="h27-3-82" class="i">+            result: Result&lt;Transaction&lt;Debug&lt;Memory&gt;&gt;&gt;,
</a><a href="#h27-3-83" id="h27-3-83" class="i">+        ) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h27-3-84" id="h27-3-84" class="i">+            let id = self.next_id;
</a><a href="#h27-3-85" id="h27-3-85" class="i">+            self.next_id += 1;
</a><a href="#h27-3-86" id="h27-3-86" class="i">+            self.print_begin(id, name, &amp;result)?;
</a><a href="#h27-3-87" id="h27-3-87" class="i">+            result.map(|txn| ScheduleTransaction { id, txn, file: self.file.clone() })
</a><a href="#h27-3-88" id="h27-3-88" class="i">+        }
</a><a href="#h27-3-89" id="h27-3-89" class="i">+
</a><a href="#h27-3-90" id="h27-3-90" class="i">+        /// Prints a transaction begin to the golden file.
</a><a href="#h27-3-91" id="h27-3-91" class="i">+        fn print_begin(
</a><a href="#h27-3-92" id="h27-3-92" class="i">+            &amp;mut self,
</a><a href="#h27-3-93" id="h27-3-93" class="i">+            id: u8,
</a><a href="#h27-3-94" id="h27-3-94" class="i">+            name: &amp;str,
</a><a href="#h27-3-95" id="h27-3-95" class="i">+            result: &amp;Result&lt;Transaction&lt;Debug&lt;Memory&gt;&gt;&gt;,
</a><a href="#h27-3-96" id="h27-3-96" class="i">+        ) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-97" id="h27-3-97" class="i">+            let mut f = self.file.lock()?;
</a><a href="#h27-3-98" id="h27-3-98" class="i">+            write!(f, &quot;T{}: {} → &quot;, id, name)?;
</a><a href="#h27-3-99" id="h27-3-99" class="i">+            match result {
</a><a href="#h27-3-100" id="h27-3-100" class="i">+                Ok(txn) =&gt; writeln!(f, &quot;{}&quot;, debug::format_txn(txn.state()))?,
</a><a href="#h27-3-101" id="h27-3-101" class="i">+                Err(err) =&gt; writeln!(f, &quot;Error::{:?}&quot;, err)?,
</a><a href="#h27-3-102" id="h27-3-102" class="i">+            };
</a><a href="#h27-3-103" id="h27-3-103" class="i">+            Self::print_log(&amp;mut f, &amp;mut self.mvcc.engine.lock()?)?;
</a><a href="#h27-3-104" id="h27-3-104" class="i">+            writeln!(f)?;
</a><a href="#h27-3-105" id="h27-3-105" class="i">+            Ok(())
</a><a href="#h27-3-106" id="h27-3-106" class="i">+        }
</a><a href="#h27-3-107" id="h27-3-107" class="i">+
</a><a href="#h27-3-108" id="h27-3-108" class="i">+        /// Prints the engine write log since the last call to the golden file.
</a><a href="#h27-3-109" id="h27-3-109" class="i">+        fn print_log(
</a><a href="#h27-3-110" id="h27-3-110" class="i">+            f: &amp;mut MutexGuard&lt;&#39;_, std::fs::File&gt;,
</a><a href="#h27-3-111" id="h27-3-111" class="i">+            engine: &amp;mut MutexGuard&lt;&#39;_, Debug&lt;Memory&gt;&gt;,
</a><a href="#h27-3-112" id="h27-3-112" class="i">+        ) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-113" id="h27-3-113" class="i">+            let writes = engine.take_write_log();
</a><a href="#h27-3-114" id="h27-3-114" class="i">+            for (key, value) in &amp;writes {
</a><a href="#h27-3-115" id="h27-3-115" class="i">+                let (fkey, fvalue) = debug::format_key_value(key, value);
</a><a href="#h27-3-116" id="h27-3-116" class="i">+                match fvalue {
</a><a href="#h27-3-117" id="h27-3-117" class="i">+                    Some(fvalue) =&gt; writeln!(f, &quot;    set {} = {}&quot;, fkey, fvalue)?,
</a><a href="#h27-3-118" id="h27-3-118" class="i">+                    None =&gt; writeln!(f, &quot;    del {}&quot;, fkey)?,
</a><a href="#h27-3-119" id="h27-3-119" class="i">+                }
</a><a href="#h27-3-120" id="h27-3-120" class="i">+            }
</a><a href="#h27-3-121" id="h27-3-121" class="i">+            Ok(())
</a><a href="#h27-3-122" id="h27-3-122" class="i">+        }
</a><a href="#h27-3-123" id="h27-3-123" class="i">+
</a><a href="#h27-3-124" id="h27-3-124" class="i">+        /// Prints the engine contents to the golden file.
</a><a href="#h27-3-125" id="h27-3-125" class="i">+        fn print_engine(&amp;self) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-126" id="h27-3-126" class="i">+            let mut f = self.file.lock()?;
</a><a href="#h27-3-127" id="h27-3-127" class="i">+            let mut engine = self.mvcc.engine.lock()?;
</a><a href="#h27-3-128" id="h27-3-128" class="i">+            let mut scan = engine.scan(..);
</a><a href="#h27-3-129" id="h27-3-129" class="i">+            writeln!(f, &quot;Engine state:&quot;)?;
</a><a href="#h27-3-130" id="h27-3-130" class="i">+            while let Some((key, value)) = scan.next().transpose()? {
</a><a href="#h27-3-131" id="h27-3-131" class="i">+                if let (fkey, Some(fvalue)) = debug::format_key_value(&amp;key, &amp;Some(value)) {
</a><a href="#h27-3-132" id="h27-3-132" class="i">+                    writeln!(f, &quot;{} = {}&quot;, fkey, fvalue)?;
</a><a href="#h27-3-133" id="h27-3-133" class="i">+                }
</a><a href="#h27-3-134" id="h27-3-134" class="i">+            }
</a><a href="#h27-3-135" id="h27-3-135" class="i">+            Ok(())
</a><a href="#h27-3-136" id="h27-3-136" class="i">+        }
</a><a href="#h27-3-137" id="h27-3-137" class="i">+
</a><a href="#h27-3-138" id="h27-3-138" class="i">+        fn get_unversioned(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h27-3-139" id="h27-3-139" class="i">+            let value = self.mvcc.get_unversioned(key)?;
</a><a href="#h27-3-140" id="h27-3-140" class="i">+            write!(
</a><a href="#h27-3-141" id="h27-3-141" class="i">+                self.file.lock()?,
</a><a href="#h27-3-142" id="h27-3-142" class="i">+                &quot;T_: get unversioned {} → {}\n\n&quot;,
</a><a href="#h27-3-143" id="h27-3-143" class="i">+                debug::format_raw(key),
</a><a href="#h27-3-144" id="h27-3-144" class="i">+                if let Some(ref value) = value {
</a><a href="#h27-3-145" id="h27-3-145" class="i">+                    debug::format_raw(value)
</a><a href="#h27-3-146" id="h27-3-146" class="i">+                } else {
</a><a href="#h27-3-147" id="h27-3-147" class="i">+                    String::from(&quot;None&quot;)
</a><a href="#h27-3-148" id="h27-3-148" class="i">+                }
</a><a href="#h27-3-149" id="h27-3-149" class="i">+            )?;
</a><a href="#h27-3-150" id="h27-3-150" class="i">+            Ok(value)
</a><a href="#h27-3-151" id="h27-3-151" class="i">+        }
</a><a href="#h27-3-152" id="h27-3-152" class="i">+
</a><a href="#h27-3-153" id="h27-3-153" class="i">+        fn set_unversioned(&amp;self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-154" id="h27-3-154" class="i">+            let mut f = self.file.lock()?;
</a><a href="#h27-3-155" id="h27-3-155" class="i">+            write!(
</a><a href="#h27-3-156" id="h27-3-156" class="i">+                f,
</a><a href="#h27-3-157" id="h27-3-157" class="i">+                &quot;T_: set unversioned {} = {}&quot;,
</a><a href="#h27-3-158" id="h27-3-158" class="i">+                debug::format_raw(key),
</a><a href="#h27-3-159" id="h27-3-159" class="i">+                debug::format_raw(&amp;value)
</a><a href="#h27-3-160" id="h27-3-160" class="i">+            )?;
</a><a href="#h27-3-161" id="h27-3-161" class="i">+            let result = self.mvcc.set_unversioned(key, value);
</a><a href="#h27-3-162" id="h27-3-162" class="i">+            match &amp;result {
</a><a href="#h27-3-163" id="h27-3-163" class="i">+                Ok(_) =&gt; writeln!(f)?,
</a><a href="#h27-3-164" id="h27-3-164" class="i">+                Err(err) =&gt; writeln!(f, &quot; → Error::{:?}&quot;, err)?,
</a><a href="#h27-3-165" id="h27-3-165" class="i">+            }
</a><a href="#h27-3-166" id="h27-3-166" class="i">+            Schedule::print_log(&amp;mut f, &amp;mut self.mvcc.engine.lock()?)?;
</a><a href="#h27-3-167" id="h27-3-167" class="i">+            writeln!(f)?;
</a><a href="#h27-3-168" id="h27-3-168" class="i">+            result
</a><a href="#h27-3-169" id="h27-3-169" class="i">+        }
</a><a href="#h27-3-170" id="h27-3-170" class="i">+    }
</a><a href="#h27-3-171" id="h27-3-171" class="i">+
</a><a href="#h27-3-172" id="h27-3-172" class="i">+    impl Drop for Schedule {
</a><a href="#h27-3-173" id="h27-3-173" class="i">+        /// Print engine contents when the schedule is dropped.
</a><a href="#h27-3-174" id="h27-3-174" class="i">+        fn drop(&amp;mut self) {
</a><a href="#h27-3-175" id="h27-3-175" class="i">+            _ = self.print_engine();
</a><a href="#h27-3-176" id="h27-3-176" class="i">+            _ = self.mint; // goldenfile assertions run when mint is dropped
</a><a href="#h27-3-177" id="h27-3-177" class="i">+        }
</a><a href="#h27-3-178" id="h27-3-178" class="i">+    }
</a><a href="#h27-3-179" id="h27-3-179" class="i">+
</a><a href="#h27-3-180" id="h27-3-180" class="i">+    struct ScheduleTransaction {
</a><a href="#h27-3-181" id="h27-3-181" class="i">+        id: u8,
</a><a href="#h27-3-182" id="h27-3-182" class="i">+        txn: Transaction&lt;Debug&lt;Memory&gt;&gt;,
</a><a href="#h27-3-183" id="h27-3-183" class="i">+        file: Arc&lt;Mutex&lt;std::fs::File&gt;&gt;,
</a><a href="#h27-3-184" id="h27-3-184" class="i">+    }
</a><a href="#h27-3-185" id="h27-3-185" class="i">+
</a><a href="#h27-3-186" id="h27-3-186" class="i">+    impl Clone for ScheduleTransaction {
</a><a href="#h27-3-187" id="h27-3-187" class="i">+        /// Allow cloning a schedule transaction, to simplify handling when
</a><a href="#h27-3-188" id="h27-3-188" class="i">+        /// commit/rollback consumes it. We don&#39;t want to allow this in general,
</a><a href="#h27-3-189" id="h27-3-189" class="i">+        /// since a commit/rollback will invalidate the cloned transactions.
</a><a href="#h27-3-190" id="h27-3-190" class="i">+        fn clone(&amp;self) -&gt; Self {
</a><a href="#h27-3-191" id="h27-3-191" class="i">+            let txn = Transaction { engine: self.txn.engine.clone(), st: self.txn.st.clone() };
</a><a href="#h27-3-192" id="h27-3-192" class="i">+            Self { id: self.id, txn, file: self.file.clone() }
</a><a href="#h27-3-193" id="h27-3-193" class="i">+        }
</a><a href="#h27-3-194" id="h27-3-194" class="i">+    }
</a><a href="#h27-3-195" id="h27-3-195" class="i">+
</a><a href="#h27-3-196" id="h27-3-196" class="i">+    impl ScheduleTransaction {
</a><a href="#h27-3-197" id="h27-3-197" class="i">+        fn state(&amp;self) -&gt; TransactionState {
</a><a href="#h27-3-198" id="h27-3-198" class="i">+            self.txn.state().clone()
</a><a href="#h27-3-199" id="h27-3-199" class="i">+        }
</a><a href="#h27-3-200" id="h27-3-200" class="i">+
</a><a href="#h27-3-201" id="h27-3-201" class="i">+        fn commit(self) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-202" id="h27-3-202" class="i">+            let result = self.clone().txn.commit(); // clone to retain self.txn for printing
</a><a href="#h27-3-203" id="h27-3-203" class="i">+            self.print_mutation(&quot;commit&quot;, &amp;result)?;
</a><a href="#h27-3-204" id="h27-3-204" class="i">+            result
</a><a href="#h27-3-205" id="h27-3-205" class="i">+        }
</a><a href="#h27-3-206" id="h27-3-206" class="i">+
</a><a href="#h27-3-207" id="h27-3-207" class="i">+        fn rollback(self) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-208" id="h27-3-208" class="i">+            let result = self.clone().txn.rollback(); // clone to retain self.txn for printing
</a><a href="#h27-3-209" id="h27-3-209" class="i">+            self.print_mutation(&quot;rollback&quot;, &amp;result)?;
</a><a href="#h27-3-210" id="h27-3-210" class="i">+            result
</a><a href="#h27-3-211" id="h27-3-211" class="i">+        }
</a><a href="#h27-3-212" id="h27-3-212" class="i">+
</a><a href="#h27-3-213" id="h27-3-213" class="i">+        fn delete(&amp;self, key: &amp;[u8]) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-214" id="h27-3-214" class="i">+            let result = self.txn.delete(key);
</a><a href="#h27-3-215" id="h27-3-215" class="i">+            self.print_mutation(&amp;format!(&quot;del {}&quot;, debug::format_raw(key)), &amp;result)?;
</a><a href="#h27-3-216" id="h27-3-216" class="i">+            result
</a><a href="#h27-3-217" id="h27-3-217" class="i">+        }
</a><a href="#h27-3-218" id="h27-3-218" class="i">+
</a><a href="#h27-3-219" id="h27-3-219" class="i">+        fn set(&amp;self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-220" id="h27-3-220" class="i">+            let result = self.txn.set(key, value.clone());
</a><a href="#h27-3-221" id="h27-3-221" class="i">+            self.print_mutation(
</a><a href="#h27-3-222" id="h27-3-222" class="i">+                &amp;format!(&quot;set {} = {}&quot;, debug::format_raw(key), debug::format_raw(&amp;value)),
</a><a href="#h27-3-223" id="h27-3-223" class="i">+                &amp;result,
</a><a href="#h27-3-224" id="h27-3-224" class="i">+            )?;
</a><a href="#h27-3-225" id="h27-3-225" class="i">+            result
</a><a href="#h27-3-226" id="h27-3-226" class="i">+        }
</a><a href="#h27-3-227" id="h27-3-227" class="i">+
</a><a href="#h27-3-228" id="h27-3-228" class="i">+        fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h27-3-229" id="h27-3-229" class="i">+            let value = self.txn.get(key)?;
</a><a href="#h27-3-230" id="h27-3-230" class="i">+            write!(
</a><a href="#h27-3-231" id="h27-3-231" class="i">+                self.file.lock()?,
</a><a href="#h27-3-232" id="h27-3-232" class="i">+                &quot;T{}: get {} → {}\n\n&quot;,
</a><a href="#h27-3-233" id="h27-3-233" class="i">+                self.id,
</a><a href="#h27-3-234" id="h27-3-234" class="i">+                debug::format_raw(key),
</a><a href="#h27-3-235" id="h27-3-235" class="i">+                if let Some(ref value) = value {
</a><a href="#h27-3-236" id="h27-3-236" class="i">+                    debug::format_raw(value)
</a><a href="#h27-3-237" id="h27-3-237" class="i">+                } else {
</a><a href="#h27-3-238" id="h27-3-238" class="i">+                    String::from(&quot;None&quot;)
</a><a href="#h27-3-239" id="h27-3-239" class="i">+                }
</a><a href="#h27-3-240" id="h27-3-240" class="i">+            )?;
</a><a href="#h27-3-241" id="h27-3-241" class="i">+            Ok(value)
</a><a href="#h27-3-242" id="h27-3-242" class="i">+        }
</a><a href="#h27-3-243" id="h27-3-243" class="i">+
</a><a href="#h27-3-244" id="h27-3-244" class="i">+        fn scan&lt;R: RangeBounds&lt;Vec&lt;u8&gt;&gt;&gt;(&amp;self, range: R) -&gt; Result&lt;Scan&lt;Debug&lt;Memory&gt;&gt;&gt; {
</a><a href="#h27-3-245" id="h27-3-245" class="i">+            let name = format!(
</a><a href="#h27-3-246" id="h27-3-246" class="i">+                &quot;scan {}..{}&quot;,
</a><a href="#h27-3-247" id="h27-3-247" class="i">+                match range.start_bound() {
</a><a href="#h27-3-248" id="h27-3-248" class="i">+                    Bound::Excluded(k) =&gt; format!(&quot;({}&quot;, debug::format_raw(k)),
</a><a href="#h27-3-249" id="h27-3-249" class="i">+                    Bound::Included(k) =&gt; format!(&quot;[{}&quot;, debug::format_raw(k)),
</a><a href="#h27-3-250" id="h27-3-250" class="i">+                    Bound::Unbounded =&gt; &quot;&quot;.to_string(),
</a><a href="#h27-3-251" id="h27-3-251" class="i">+                },
</a><a href="#h27-3-252" id="h27-3-252" class="i">+                match range.end_bound() {
</a><a href="#h27-3-253" id="h27-3-253" class="i">+                    Bound::Excluded(k) =&gt; format!(&quot;{})&quot;, debug::format_raw(k)),
</a><a href="#h27-3-254" id="h27-3-254" class="i">+                    Bound::Included(k) =&gt; format!(&quot;{}]&quot;, debug::format_raw(k)),
</a><a href="#h27-3-255" id="h27-3-255" class="i">+                    Bound::Unbounded =&gt; &quot;&quot;.to_string(),
</a><a href="#h27-3-256" id="h27-3-256" class="i">+                },
</a><a href="#h27-3-257" id="h27-3-257" class="i">+            );
</a><a href="#h27-3-258" id="h27-3-258" class="i">+            let mut scan = self.txn.scan(range)?;
</a><a href="#h27-3-259" id="h27-3-259" class="i">+            self.print_scan(&amp;name, scan.to_vec()?)?;
</a><a href="#h27-3-260" id="h27-3-260" class="i">+            Ok(scan)
</a><a href="#h27-3-261" id="h27-3-261" class="i">+        }
</a><a href="#h27-3-262" id="h27-3-262" class="i">+
</a><a href="#h27-3-263" id="h27-3-263" class="i">+        fn scan_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Result&lt;Scan&lt;Debug&lt;Memory&gt;&gt;&gt; {
</a><a href="#h27-3-264" id="h27-3-264" class="i">+            let mut scan = self.txn.scan_prefix(prefix)?;
</a><a href="#h27-3-265" id="h27-3-265" class="i">+            self.print_scan(&amp;format!(&quot;scan prefix {}&quot;, debug::format_raw(prefix)), scan.to_vec()?)?;
</a><a href="#h27-3-266" id="h27-3-266" class="i">+            Ok(scan)
</a><a href="#h27-3-267" id="h27-3-267" class="i">+        }
</a><a href="#h27-3-268" id="h27-3-268" class="i">+
</a><a href="#h27-3-269" id="h27-3-269" class="i">+        /// Prints the result of a mutation to the golden file.
</a><a href="#h27-3-270" id="h27-3-270" class="i">+        fn print_mutation(&amp;self, name: &amp;str, result: &amp;Result&lt;()&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-271" id="h27-3-271" class="i">+            let mut f = self.file.lock()?;
</a><a href="#h27-3-272" id="h27-3-272" class="i">+            write!(f, &quot;T{}: {}&quot;, self.id, name)?;
</a><a href="#h27-3-273" id="h27-3-273" class="i">+            match result {
</a><a href="#h27-3-274" id="h27-3-274" class="i">+                Ok(_) =&gt; writeln!(f)?,
</a><a href="#h27-3-275" id="h27-3-275" class="i">+                Err(err) =&gt; writeln!(f, &quot; → Error::{:?}&quot;, err)?,
</a><a href="#h27-3-276" id="h27-3-276" class="i">+            }
</a><a href="#h27-3-277" id="h27-3-277" class="i">+            Schedule::print_log(&amp;mut f, &amp;mut self.txn.engine.lock()?)?;
</a><a href="#h27-3-278" id="h27-3-278" class="i">+            writeln!(f)?;
</a><a href="#h27-3-279" id="h27-3-279" class="i">+            Ok(())
</a><a href="#h27-3-280" id="h27-3-280" class="i">+        }
</a><a href="#h27-3-281" id="h27-3-281" class="i">+
</a><a href="#h27-3-282" id="h27-3-282" class="i">+        /// Prints the results of a scan to the golden file.
</a><a href="#h27-3-283" id="h27-3-283" class="i">+        fn print_scan(&amp;self, name: &amp;str, scan: Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-284" id="h27-3-284" class="i">+            let mut f = self.file.lock()?;
</a><a href="#h27-3-285" id="h27-3-285" class="i">+            writeln!(f, &quot;T{}: {}&quot;, self.id, name)?;
</a><a href="#h27-3-286" id="h27-3-286" class="i">+            for (key, value) in scan {
</a><a href="#h27-3-287" id="h27-3-287" class="i">+                writeln!(f, &quot;    {} = {}&quot;, debug::format_raw(&amp;key), debug::format_raw(&amp;value))?
</a><a href="#h27-3-288" id="h27-3-288" class="i">+            }
</a><a href="#h27-3-289" id="h27-3-289" class="i">+            writeln!(f)?;
</a><a href="#h27-3-290" id="h27-3-290" class="i">+            Ok(())
</a><a href="#h27-3-291" id="h27-3-291" class="i">+        }
</a><a href="#h27-3-292" id="h27-3-292" class="i">+    }
</a> 
<a href="#h27-3-294" id="h27-3-294" class="d">-    fn setup() -&gt; MVCC&lt;Memory&gt; {
</a><a href="#h27-3-295" id="h27-3-295" class="d">-        MVCC::new(Memory::new())
</a><a href="#h27-3-296" id="h27-3-296" class="i">+    /// Asserts that a scan yields the expected result.
</a><a href="#h27-3-297" id="h27-3-297" class="i">+    macro_rules! assert_scan {
</a><a href="#h27-3-298" id="h27-3-298" class="i">+        ( $scan:expr =&gt; { $( $key:expr =&gt; $value:expr),* $(,)? } ) =&gt; {
</a><a href="#h27-3-299" id="h27-3-299" class="i">+            let result = $scan.to_vec()?;
</a><a href="#h27-3-300" id="h27-3-300" class="i">+            let expect = vec![
</a><a href="#h27-3-301" id="h27-3-301" class="i">+                $( ($key.to_vec(), $value.to_vec()), )*
</a><a href="#h27-3-302" id="h27-3-302" class="i">+            ];
</a><a href="#h27-3-303" id="h27-3-303" class="i">+            assert_eq!(result, expect);
</a><a href="#h27-3-304" id="h27-3-304" class="i">+        };
</a><a href="#h27-3-305" id="h27-3-305" class="i">+    }
</a><a href="#h27-3-306" id="h27-3-306" class="i">+
</a><a href="#h27-3-307" id="h27-3-307" class="i">+    // Asserts scan invariants.
</a><a href="#h27-3-308" id="h27-3-308" class="i">+    #[track_caller]
</a><a href="#h27-3-309" id="h27-3-309" class="i">+    fn assert_scan_invariants(scan: &amp;mut Scan&lt;Debug&lt;Memory&gt;&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-310" id="h27-3-310" class="i">+        // Iterator and vec should yield same results.
</a><a href="#h27-3-311" id="h27-3-311" class="i">+        let result = scan.to_vec()?;
</a><a href="#h27-3-312" id="h27-3-312" class="i">+        assert_eq!(scan.iter().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?, result);
</a><a href="#h27-3-313" id="h27-3-313" class="i">+
</a><a href="#h27-3-314" id="h27-3-314" class="i">+        // Forward and reverse scans should give the same results.
</a><a href="#h27-3-315" id="h27-3-315" class="i">+        let mut forward = result.clone();
</a><a href="#h27-3-316" id="h27-3-316" class="i">+        forward.reverse();
</a><a href="#h27-3-317" id="h27-3-317" class="i">+        let reverse = scan.iter().rev().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h27-3-318" id="h27-3-318" class="i">+        assert_eq!(reverse, forward);
</a><a href="#h27-3-319" id="h27-3-319" class="i">+
</a><a href="#h27-3-320" id="h27-3-320" class="i">+        // Alternating next/next_back calls should give the same results.
</a><a href="#h27-3-321" id="h27-3-321" class="i">+        let mut forward = Vec::new();
</a><a href="#h27-3-322" id="h27-3-322" class="i">+        let mut reverse = Vec::new();
</a><a href="#h27-3-323" id="h27-3-323" class="i">+        let mut iter = scan.iter();
</a><a href="#h27-3-324" id="h27-3-324" class="i">+        while let Some(b) = iter.next().transpose()? {
</a><a href="#h27-3-325" id="h27-3-325" class="i">+            forward.push(b);
</a><a href="#h27-3-326" id="h27-3-326" class="i">+            if let Some(b) = iter.next_back().transpose()? {
</a><a href="#h27-3-327" id="h27-3-327" class="i">+                reverse.push(b);
</a><a href="#h27-3-328" id="h27-3-328" class="i">+            }
</a><a href="#h27-3-329" id="h27-3-329" class="i">+        }
</a><a href="#h27-3-330" id="h27-3-330" class="i">+        reverse.reverse();
</a><a href="#h27-3-331" id="h27-3-331" class="i">+        forward.extend_from_slice(&amp;reverse);
</a><a href="#h27-3-332" id="h27-3-332" class="i">+        assert_eq!(forward, result);
</a><a href="#h27-3-333" id="h27-3-333" class="i">+
</a><a href="#h27-3-334" id="h27-3-334" class="i">+        Ok(())
</a>     }
 
     #[test]
     /// Tests that key prefixes are actually prefixes of keys.
<a href="#h27-3-339" id="h27-3-339" class="d">-    fn test_key_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h27-3-340" id="h27-3-340" class="i">+    fn key_prefix() -&gt; Result&lt;()&gt; {
</a>         let cases = vec![
             (KeyPrefix::NextVersion, Key::NextVersion),
             (KeyPrefix::TxnActive, Key::TxnActive(1)),
<a href="#h27-4" id="h27-4" class="h">@@ -816,76 +1140,135 @@ pub mod tests {
</a>     }
 
     #[test]
<a href="#h27-4-3" id="h27-4-3" class="d">-    fn test_begin() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-4" id="h27-4-4" class="d">-        let mvcc = setup();
</a><a href="#h27-4-5" id="h27-4-5" class="i">+    /// Begin should create txns with new versions and current active sets.
</a><a href="#h27-4-6" id="h27-4-6" class="i">+    fn begin() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-7" id="h27-4-7" class="i">+        let mut mvcc = Schedule::new(&quot;begin&quot;)?;
</a> 
<a href="#h27-4-9" id="h27-4-9" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-4-10" id="h27-4-10" class="d">-        assert_eq!(1, txn.version());
</a><a href="#h27-4-11" id="h27-4-11" class="d">-        assert!(!txn.read_only());
</a><a href="#h27-4-12" id="h27-4-12" class="d">-        txn.commit()?;
</a><a href="#h27-4-13" id="h27-4-13" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-4-14" id="h27-4-14" class="i">+        assert_eq!(
</a><a href="#h27-4-15" id="h27-4-15" class="i">+            t1.state(),
</a><a href="#h27-4-16" id="h27-4-16" class="i">+            TransactionState { version: 1, read_only: false, active: HashSet::new() }
</a><a href="#h27-4-17" id="h27-4-17" class="i">+        );
</a> 
<a href="#h27-4-19" id="h27-4-19" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-4-20" id="h27-4-20" class="d">-        assert_eq!(2, txn.version());
</a><a href="#h27-4-21" id="h27-4-21" class="d">-        txn.rollback()?;
</a><a href="#h27-4-22" id="h27-4-22" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-4-23" id="h27-4-23" class="i">+        assert_eq!(
</a><a href="#h27-4-24" id="h27-4-24" class="i">+            t2.state(),
</a><a href="#h27-4-25" id="h27-4-25" class="i">+            TransactionState { version: 2, read_only: false, active: HashSet::from([1]) }
</a><a href="#h27-4-26" id="h27-4-26" class="i">+        );
</a> 
<a href="#h27-4-28" id="h27-4-28" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-4-29" id="h27-4-29" class="d">-        assert_eq!(3, txn.version());
</a><a href="#h27-4-30" id="h27-4-30" class="d">-        txn.commit()?;
</a><a href="#h27-4-31" id="h27-4-31" class="i">+        let t3 = mvcc.begin()?;
</a><a href="#h27-4-32" id="h27-4-32" class="i">+        assert_eq!(
</a><a href="#h27-4-33" id="h27-4-33" class="i">+            t3.state(),
</a><a href="#h27-4-34" id="h27-4-34" class="i">+            TransactionState { version: 3, read_only: false, active: HashSet::from([1, 2]) }
</a><a href="#h27-4-35" id="h27-4-35" class="i">+        );
</a><a href="#h27-4-36" id="h27-4-36" class="i">+
</a><a href="#h27-4-37" id="h27-4-37" class="i">+        t2.commit()?; // commit to remove from active set
</a><a href="#h27-4-38" id="h27-4-38" class="i">+
</a><a href="#h27-4-39" id="h27-4-39" class="i">+        let t4 = mvcc.begin()?;
</a><a href="#h27-4-40" id="h27-4-40" class="i">+        assert_eq!(
</a><a href="#h27-4-41" id="h27-4-41" class="i">+            t4.state(),
</a><a href="#h27-4-42" id="h27-4-42" class="i">+            TransactionState { version: 4, read_only: false, active: HashSet::from([1, 3]) }
</a><a href="#h27-4-43" id="h27-4-43" class="i">+        );
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-4-49" id="h27-4-49" class="d">-    fn test_begin_read_only() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-50" id="h27-4-50" class="d">-        let mvcc = setup();
</a><a href="#h27-4-51" id="h27-4-51" class="d">-        let txn = mvcc.begin_read_only()?;
</a><a href="#h27-4-52" id="h27-4-52" class="d">-        assert_eq!(txn.version(), 1);
</a><a href="#h27-4-53" id="h27-4-53" class="d">-        assert!(txn.read_only());
</a><a href="#h27-4-54" id="h27-4-54" class="d">-        txn.commit()?;
</a><a href="#h27-4-55" id="h27-4-55" class="i">+    /// Begin read-only should not create a new version, instead using the
</a><a href="#h27-4-56" id="h27-4-56" class="i">+    /// next one, but it should use the current active set.
</a><a href="#h27-4-57" id="h27-4-57" class="i">+    fn begin_read_only() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-58" id="h27-4-58" class="i">+        let mut mvcc = Schedule::new(&quot;begin_read_only&quot;)?;
</a><a href="#h27-4-59" id="h27-4-59" class="i">+
</a><a href="#h27-4-60" id="h27-4-60" class="i">+        // Start an initial read-only transaction, and make sure it&#39;s actually
</a><a href="#h27-4-61" id="h27-4-61" class="i">+        // read-only.
</a><a href="#h27-4-62" id="h27-4-62" class="i">+        let t1 = mvcc.begin_read_only()?;
</a><a href="#h27-4-63" id="h27-4-63" class="i">+        assert_eq!(
</a><a href="#h27-4-64" id="h27-4-64" class="i">+            t1.state(),
</a><a href="#h27-4-65" id="h27-4-65" class="i">+            TransactionState { version: 1, read_only: true, active: HashSet::new() }
</a><a href="#h27-4-66" id="h27-4-66" class="i">+        );
</a><a href="#h27-4-67" id="h27-4-67" class="i">+        assert_eq!(t1.set(b&quot;foo&quot;, vec![1]), Err(Error::ReadOnly));
</a><a href="#h27-4-68" id="h27-4-68" class="i">+        assert_eq!(t1.delete(b&quot;foo&quot;), Err(Error::ReadOnly));
</a><a href="#h27-4-69" id="h27-4-69" class="i">+
</a><a href="#h27-4-70" id="h27-4-70" class="i">+        // Start a new read-write transaction, then another read-only
</a><a href="#h27-4-71" id="h27-4-71" class="i">+        // transaction which should have it in its active set. t1 should not be
</a><a href="#h27-4-72" id="h27-4-72" class="i">+        // in the active set, because it&#39;s read-only.
</a><a href="#h27-4-73" id="h27-4-73" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-4-74" id="h27-4-74" class="i">+        assert_eq!(
</a><a href="#h27-4-75" id="h27-4-75" class="i">+            t2.state(),
</a><a href="#h27-4-76" id="h27-4-76" class="i">+            TransactionState { version: 1, read_only: false, active: HashSet::new() }
</a><a href="#h27-4-77" id="h27-4-77" class="i">+        );
</a><a href="#h27-4-78" id="h27-4-78" class="i">+
</a><a href="#h27-4-79" id="h27-4-79" class="i">+        let t3 = mvcc.begin_read_only()?;
</a><a href="#h27-4-80" id="h27-4-80" class="i">+        assert_eq!(
</a><a href="#h27-4-81" id="h27-4-81" class="i">+            t3.state(),
</a><a href="#h27-4-82" id="h27-4-82" class="i">+            TransactionState { version: 2, read_only: true, active: HashSet::from([1]) }
</a><a href="#h27-4-83" id="h27-4-83" class="i">+        );
</a><a href="#h27-4-84" id="h27-4-84" class="i">+
</a>         Ok(())
     }
 
     #[test]
<a href="#h27-4-89" id="h27-4-89" class="d">-    fn test_begin_as_of() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-90" id="h27-4-90" class="d">-        let mvcc = setup();
</a><a href="#h27-4-91" id="h27-4-91" class="i">+    /// Begin as of should provide a read-only view of a historical version.
</a><a href="#h27-4-92" id="h27-4-92" class="i">+    fn begin_as_of() -&gt; Result&lt;()&gt; {
</a><a href="#h27-4-93" id="h27-4-93" class="i">+        let mut mvcc = Schedule::new(&quot;begin_as_of&quot;)?;
</a> 
         // Start a concurrent transaction that should be invisible.
         let t1 = mvcc.begin()?;
         t1.set(b&quot;other&quot;, vec![1])?;
 
<a href="#h27-4-99" id="h27-4-99" class="d">-        // Write a couple of versions for a key. Commit the concurrent one in between.
</a><a href="#h27-4-100" id="h27-4-100" class="i">+        // Write a couple of versions for a key.
</a>         let t2 = mvcc.begin()?;
         t2.set(b&quot;key&quot;, vec![2])?;
         t2.commit()?;
 
         let t3 = mvcc.begin()?;
         t3.set(b&quot;key&quot;, vec![3])?;
<a href="#h27-4-107" id="h27-4-107" class="d">-        t3.commit()?;
</a> 
<a href="#h27-4-109" id="h27-4-109" class="i">+        // Reading as of version 3 should only see key=2, because t1 and
</a><a href="#h27-4-110" id="h27-4-110" class="i">+        // t3 haven&#39;t committed yet.
</a><a href="#h27-4-111" id="h27-4-111" class="i">+        let t4 = mvcc.begin_as_of(3)?;
</a><a href="#h27-4-112" id="h27-4-112" class="i">+        assert_eq!(
</a><a href="#h27-4-113" id="h27-4-113" class="i">+            t4.state(),
</a><a href="#h27-4-114" id="h27-4-114" class="i">+            TransactionState { version: 3, read_only: true, active: HashSet::from([1]) }
</a><a href="#h27-4-115" id="h27-4-115" class="i">+        );
</a><a href="#h27-4-116" id="h27-4-116" class="i">+        assert_scan!(t4.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a><a href="#h27-4-117" id="h27-4-117" class="i">+
</a><a href="#h27-4-118" id="h27-4-118" class="i">+        // Writes should error.
</a><a href="#h27-4-119" id="h27-4-119" class="i">+        assert_eq!(t4.set(b&quot;foo&quot;, vec![1]), Err(Error::ReadOnly));
</a><a href="#h27-4-120" id="h27-4-120" class="i">+        assert_eq!(t4.delete(b&quot;foo&quot;), Err(Error::ReadOnly));
</a><a href="#h27-4-121" id="h27-4-121" class="i">+
</a><a href="#h27-4-122" id="h27-4-122" class="i">+        // Once we commit t1 and t3, neither the existing as of transaction nor
</a><a href="#h27-4-123" id="h27-4-123" class="i">+        // a new one should see their writes, since versions must be stable.
</a>         t1.commit()?;
<a href="#h27-4-125" id="h27-4-125" class="i">+        t3.commit()?;
</a> 
<a href="#h27-4-127" id="h27-4-127" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h27-4-128" id="h27-4-128" class="d">-        t4.set(b&quot;key&quot;, vec![4])?;
</a><a href="#h27-4-129" id="h27-4-129" class="d">-        t4.commit()?;
</a><a href="#h27-4-130" id="h27-4-130" class="i">+        assert_scan!(t4.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a> 
<a href="#h27-4-132" id="h27-4-132" class="d">-        // Check that we can start a snapshot as of version 3. It should see
</a><a href="#h27-4-133" id="h27-4-133" class="d">-        // key=2 and other=None (because it hadn&#39;t committed yet).
</a><a href="#h27-4-134" id="h27-4-134" class="d">-        let txn = mvcc.begin_as_of(3)?;
</a><a href="#h27-4-135" id="h27-4-135" class="d">-        assert_eq!(txn.version(), 3);
</a><a href="#h27-4-136" id="h27-4-136" class="d">-        assert!(txn.read_only());
</a><a href="#h27-4-137" id="h27-4-137" class="d">-        assert_eq!(txn.get(b&quot;key&quot;)?, Some(vec![2]));
</a><a href="#h27-4-138" id="h27-4-138" class="d">-        assert_eq!(txn.get(b&quot;other&quot;)?, None);
</a><a href="#h27-4-139" id="h27-4-139" class="d">-        txn.commit()?;
</a><a href="#h27-4-140" id="h27-4-140" class="d">-
</a><a href="#h27-4-141" id="h27-4-141" class="d">-        // A snapshot as of version 4 should see key=3 and Other=2.
</a><a href="#h27-4-142" id="h27-4-142" class="d">-        let txn = mvcc.begin_as_of(4)?;
</a><a href="#h27-4-143" id="h27-4-143" class="d">-        assert_eq!(txn.version(), 4);
</a><a href="#h27-4-144" id="h27-4-144" class="d">-        assert!(txn.read_only());
</a><a href="#h27-4-145" id="h27-4-145" class="d">-        assert_eq!(txn.get(b&quot;key&quot;)?, Some(vec![3]));
</a><a href="#h27-4-146" id="h27-4-146" class="d">-        assert_eq!(txn.get(b&quot;other&quot;)?, Some(vec![1]));
</a><a href="#h27-4-147" id="h27-4-147" class="d">-        txn.commit()?;
</a><a href="#h27-4-148" id="h27-4-148" class="d">-
</a><a href="#h27-4-149" id="h27-4-149" class="d">-        // Check that any future versions are invalid.
</a><a href="#h27-4-150" id="h27-4-150" class="i">+        let t5 = mvcc.begin_as_of(3)?;
</a><a href="#h27-4-151" id="h27-4-151" class="i">+        assert_scan!(t5.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a><a href="#h27-4-152" id="h27-4-152" class="i">+
</a><a href="#h27-4-153" id="h27-4-153" class="i">+        // Rolling back and committing read-only transactions is noops.
</a><a href="#h27-4-154" id="h27-4-154" class="i">+        t4.rollback()?;
</a><a href="#h27-4-155" id="h27-4-155" class="i">+        t5.commit()?;
</a><a href="#h27-4-156" id="h27-4-156" class="i">+
</a><a href="#h27-4-157" id="h27-4-157" class="i">+        // Commit a new value.
</a><a href="#h27-4-158" id="h27-4-158" class="i">+        let t6 = mvcc.begin()?;
</a><a href="#h27-4-159" id="h27-4-159" class="i">+        t6.set(b&quot;key&quot;, vec![4])?;
</a><a href="#h27-4-160" id="h27-4-160" class="i">+        t6.commit()?;
</a><a href="#h27-4-161" id="h27-4-161" class="i">+
</a><a href="#h27-4-162" id="h27-4-162" class="i">+        // A snapshot as of version 4 should see key=3 and other=1.
</a><a href="#h27-4-163" id="h27-4-163" class="i">+        let t7 = mvcc.begin_as_of(4)?;
</a><a href="#h27-4-164" id="h27-4-164" class="i">+        assert_eq!(
</a><a href="#h27-4-165" id="h27-4-165" class="i">+            t7.state(),
</a><a href="#h27-4-166" id="h27-4-166" class="i">+            TransactionState { version: 4, read_only: true, active: HashSet::new() }
</a><a href="#h27-4-167" id="h27-4-167" class="i">+        );
</a><a href="#h27-4-168" id="h27-4-168" class="i">+        assert_scan!(t7.scan(..)? =&gt; {b&quot;key&quot; =&gt; [3], b&quot;other&quot; =&gt; [1]});
</a><a href="#h27-4-169" id="h27-4-169" class="i">+
</a><a href="#h27-4-170" id="h27-4-170" class="i">+        // Check that future versions are invalid, including the next.
</a><a href="#h27-4-171" id="h27-4-171" class="i">+        assert_eq!(
</a><a href="#h27-4-172" id="h27-4-172" class="i">+            mvcc.begin_as_of(5).err(),
</a><a href="#h27-4-173" id="h27-4-173" class="i">+            Some(Error::Value(&quot;Version 5 does not exist&quot;.into()))
</a><a href="#h27-4-174" id="h27-4-174" class="i">+        );
</a>         assert_eq!(
             mvcc.begin_as_of(9).err(),
             Some(Error::Value(&quot;Version 9 does not exist&quot;.into()))
<a href="#h27-5" id="h27-5" class="h">@@ -895,13 +1278,14 @@ pub mod tests {
</a>     }
 
     #[test]
<a href="#h27-5-3" id="h27-5-3" class="d">-    fn test_resume() -&gt; Result&lt;()&gt; {
</a><a href="#h27-5-4" id="h27-5-4" class="d">-        let mvcc = setup();
</a><a href="#h27-5-5" id="h27-5-5" class="i">+    /// Resume should resume a transaction with the same state.
</a><a href="#h27-5-6" id="h27-5-6" class="i">+    fn resume() -&gt; Result&lt;()&gt; {
</a><a href="#h27-5-7" id="h27-5-7" class="i">+        let mut mvcc = Schedule::new(&quot;resume&quot;)?;
</a> 
<a href="#h27-5-9" id="h27-5-9" class="d">-        // We first write a set of values that should be visible
</a><a href="#h27-5-10" id="h27-5-10" class="i">+        // We first write a set of values that should be visible.
</a>         let t1 = mvcc.begin()?;
<a href="#h27-5-12" id="h27-5-12" class="d">-        t1.set(b&quot;a&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h27-5-13" id="h27-5-13" class="d">-        t1.set(b&quot;b&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h27-5-14" id="h27-5-14" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-5-15" id="h27-5-15" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a>         t1.commit()?;
 
         // We then start three transactions, of which we will resume t3.
<a href="#h27-6" id="h27-6" class="h">@@ -911,34 +1295,48 @@ pub mod tests {
</a>         let t3 = mvcc.begin()?;
         let t4 = mvcc.begin()?;
 
<a href="#h27-6-3" id="h27-6-3" class="d">-        t2.set(b&quot;a&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h27-6-4" id="h27-6-4" class="d">-        t3.set(b&quot;b&quot;, b&quot;t3&quot;.to_vec())?;
</a><a href="#h27-6-5" id="h27-6-5" class="d">-        t4.set(b&quot;c&quot;, b&quot;t4&quot;.to_vec())?;
</a><a href="#h27-6-6" id="h27-6-6" class="i">+        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h27-6-7" id="h27-6-7" class="i">+        t3.set(b&quot;b&quot;, vec![3])?;
</a><a href="#h27-6-8" id="h27-6-8" class="i">+        t4.set(b&quot;c&quot;, vec![4])?;
</a> 
         t2.commit()?;
         t4.commit()?;
 
<a href="#h27-6-13" id="h27-6-13" class="d">-        // We now resume t3, who should see it&#39;s own changes but none
</a><a href="#h27-6-14" id="h27-6-14" class="d">-        // of the others&#39;
</a><a href="#h27-6-15" id="h27-6-15" class="i">+        // We now resume t3, who should only see its own changes.
</a>         let state = t3.state().clone();
<a href="#h27-6-17" id="h27-6-17" class="d">-        std::mem::drop(t3);
</a><a href="#h27-6-18" id="h27-6-18" class="d">-        let tr = mvcc.resume(state.clone())?;
</a><a href="#h27-6-19" id="h27-6-19" class="d">-        assert_eq!(3, tr.version());
</a><a href="#h27-6-20" id="h27-6-20" class="d">-        assert!(!tr.read_only());
</a><a href="#h27-6-21" id="h27-6-21" class="d">-
</a><a href="#h27-6-22" id="h27-6-22" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), tr.get(b&quot;a&quot;)?);
</a><a href="#h27-6-23" id="h27-6-23" class="d">-        assert_eq!(Some(b&quot;t3&quot;.to_vec()), tr.get(b&quot;b&quot;)?);
</a><a href="#h27-6-24" id="h27-6-24" class="d">-        assert_eq!(None, tr.get(b&quot;c&quot;)?);
</a><a href="#h27-6-25" id="h27-6-25" class="d">-
</a><a href="#h27-6-26" id="h27-6-26" class="d">-        // A separate transaction should not see t3&#39;s changes, but should see the others
</a><a href="#h27-6-27" id="h27-6-27" class="d">-        let t = mvcc.begin()?;
</a><a href="#h27-6-28" id="h27-6-28" class="d">-        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h27-6-29" id="h27-6-29" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h27-6-30" id="h27-6-30" class="d">-        assert_eq!(Some(b&quot;t4&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h27-6-31" id="h27-6-31" class="d">-        t.rollback()?;
</a><a href="#h27-6-32" id="h27-6-32" class="d">-
</a><a href="#h27-6-33" id="h27-6-33" class="d">-        // Once tr commits, a separate transaction should see t3&#39;s changes
</a><a href="#h27-6-34" id="h27-6-34" class="d">-        tr.commit()?;
</a><a href="#h27-6-35" id="h27-6-35" class="i">+        assert_eq!(
</a><a href="#h27-6-36" id="h27-6-36" class="i">+            state,
</a><a href="#h27-6-37" id="h27-6-37" class="i">+            TransactionState { version: 3, read_only: false, active: HashSet::from([2]) }
</a><a href="#h27-6-38" id="h27-6-38" class="i">+        );
</a><a href="#h27-6-39" id="h27-6-39" class="i">+        drop(t3);
</a><a href="#h27-6-40" id="h27-6-40" class="i">+
</a><a href="#h27-6-41" id="h27-6-41" class="i">+        let t5 = mvcc.resume(state.clone())?;
</a><a href="#h27-6-42" id="h27-6-42" class="i">+        assert_eq!(t5.state(), state);
</a><a href="#h27-6-43" id="h27-6-43" class="i">+
</a><a href="#h27-6-44" id="h27-6-44" class="i">+        assert_scan!(t5.scan(..)? =&gt; {
</a><a href="#h27-6-45" id="h27-6-45" class="i">+            b&quot;a&quot; =&gt; [1],
</a><a href="#h27-6-46" id="h27-6-46" class="i">+            b&quot;b&quot; =&gt; [3],
</a><a href="#h27-6-47" id="h27-6-47" class="i">+        });
</a><a href="#h27-6-48" id="h27-6-48" class="i">+
</a><a href="#h27-6-49" id="h27-6-49" class="i">+        // A separate transaction should not see t3&#39;s changes.
</a><a href="#h27-6-50" id="h27-6-50" class="i">+        let t6 = mvcc.begin()?;
</a><a href="#h27-6-51" id="h27-6-51" class="i">+        assert_scan!(t6.scan(..)? =&gt; {
</a><a href="#h27-6-52" id="h27-6-52" class="i">+            b&quot;a&quot; =&gt; [2],
</a><a href="#h27-6-53" id="h27-6-53" class="i">+            b&quot;b&quot; =&gt; [1], // not 3
</a><a href="#h27-6-54" id="h27-6-54" class="i">+            b&quot;c&quot; =&gt; [4],
</a><a href="#h27-6-55" id="h27-6-55" class="i">+        });
</a><a href="#h27-6-56" id="h27-6-56" class="i">+        t6.rollback()?;
</a><a href="#h27-6-57" id="h27-6-57" class="i">+
</a><a href="#h27-6-58" id="h27-6-58" class="i">+        // Once t5 commits, a separate transaction should see its changes.
</a><a href="#h27-6-59" id="h27-6-59" class="i">+        t5.commit()?;
</a><a href="#h27-6-60" id="h27-6-60" class="i">+
</a><a href="#h27-6-61" id="h27-6-61" class="i">+        let t7 = mvcc.begin()?;
</a><a href="#h27-6-62" id="h27-6-62" class="i">+        assert_scan!(t7.scan(..)? =&gt; {
</a><a href="#h27-6-63" id="h27-6-63" class="i">+            b&quot;a&quot; =&gt; [2],
</a><a href="#h27-6-64" id="h27-6-64" class="i">+            b&quot;b&quot; =&gt; [3], // now 3
</a><a href="#h27-6-65" id="h27-6-65" class="i">+            b&quot;c&quot; =&gt; [4],
</a><a href="#h27-6-66" id="h27-6-66" class="i">+        });
</a><a href="#h27-6-67" id="h27-6-67" class="i">+        t7.rollback()?;
</a> 
         // Resuming an inactive transaction should error.
         assert_eq!(
<a href="#h27-7" id="h27-7" class="h">@@ -946,402 +1344,436 @@ pub mod tests {
</a>             Some(Error::Internal(&quot;No active transaction at version 3&quot;.into()))
         );
 
<a href="#h27-7-3" id="h27-7-3" class="d">-        let t = mvcc.begin()?;
</a><a href="#h27-7-4" id="h27-7-4" class="d">-        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h27-7-5" id="h27-7-5" class="d">-        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h27-7-6" id="h27-7-6" class="d">-        assert_eq!(Some(b&quot;t4&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h27-7-7" id="h27-7-7" class="d">-        t.rollback()?;
</a><a href="#h27-7-8" id="h27-7-8" class="d">-
</a><a href="#h27-7-9" id="h27-7-9" class="d">-        // It should also be possible to start a snapshot transaction and resume it.
</a><a href="#h27-7-10" id="h27-7-10" class="d">-        let ts = mvcc.begin_as_of(2)?;
</a><a href="#h27-7-11" id="h27-7-11" class="d">-        assert_eq!(2, ts.version());
</a><a href="#h27-7-12" id="h27-7-12" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
</a><a href="#h27-7-13" id="h27-7-13" class="d">-
</a><a href="#h27-7-14" id="h27-7-14" class="d">-        let state = ts.state().clone();
</a><a href="#h27-7-15" id="h27-7-15" class="d">-        std::mem::drop(ts);
</a><a href="#h27-7-16" id="h27-7-16" class="d">-        let ts = mvcc.resume(state)?;
</a><a href="#h27-7-17" id="h27-7-17" class="d">-        assert_eq!(2, ts.version());
</a><a href="#h27-7-18" id="h27-7-18" class="d">-        assert!(ts.read_only());
</a><a href="#h27-7-19" id="h27-7-19" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
</a><a href="#h27-7-20" id="h27-7-20" class="d">-        ts.commit()?;
</a><a href="#h27-7-21" id="h27-7-21" class="d">-
</a><a href="#h27-7-22" id="h27-7-22" class="d">-        Ok(())
</a><a href="#h27-7-23" id="h27-7-23" class="d">-    }
</a><a href="#h27-7-24" id="h27-7-24" class="d">-
</a><a href="#h27-7-25" id="h27-7-25" class="d">-    #[test]
</a><a href="#h27-7-26" id="h27-7-26" class="d">-    fn test_txn_delete_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-27" id="h27-7-27" class="d">-        let mvcc = setup();
</a><a href="#h27-7-28" id="h27-7-28" class="i">+        // It should also be possible to start a snapshot transaction in t3
</a><a href="#h27-7-29" id="h27-7-29" class="i">+        // and resume it. It should not see t3&#39;s writes, nor t2&#39;s.
</a><a href="#h27-7-30" id="h27-7-30" class="i">+        let t8 = mvcc.begin_as_of(3)?;
</a><a href="#h27-7-31" id="h27-7-31" class="i">+        assert_eq!(
</a><a href="#h27-7-32" id="h27-7-32" class="i">+            t8.state(),
</a><a href="#h27-7-33" id="h27-7-33" class="i">+            TransactionState { version: 3, read_only: true, active: HashSet::from([2]) }
</a><a href="#h27-7-34" id="h27-7-34" class="i">+        );
</a> 
<a href="#h27-7-36" id="h27-7-36" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-37" id="h27-7-37" class="d">-        txn.set(b&quot;key&quot;, vec![0x00])?;
</a><a href="#h27-7-38" id="h27-7-38" class="d">-        txn.commit()?;
</a><a href="#h27-7-39" id="h27-7-39" class="i">+        assert_scan!(t8.scan(..)? =&gt; {
</a><a href="#h27-7-40" id="h27-7-40" class="i">+            b&quot;a&quot; =&gt; [1],
</a><a href="#h27-7-41" id="h27-7-41" class="i">+            b&quot;b&quot; =&gt; [1],
</a><a href="#h27-7-42" id="h27-7-42" class="i">+        });
</a> 
<a href="#h27-7-44" id="h27-7-44" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h27-7-45" id="h27-7-45" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-46" id="h27-7-46" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h27-7-47" id="h27-7-47" class="i">+        let state = t8.state().clone();
</a><a href="#h27-7-48" id="h27-7-48" class="i">+        drop(t8);
</a> 
<a href="#h27-7-50" id="h27-7-50" class="d">-        t2.delete(b&quot;key&quot;)?;
</a><a href="#h27-7-51" id="h27-7-51" class="d">-        assert_eq!(Err(Error::Serialization), t1.delete(b&quot;key&quot;));
</a><a href="#h27-7-52" id="h27-7-52" class="d">-        assert_eq!(Err(Error::Serialization), t3.delete(b&quot;key&quot;));
</a><a href="#h27-7-53" id="h27-7-53" class="d">-        t2.commit()?;
</a><a href="#h27-7-54" id="h27-7-54" class="i">+        let t9 = mvcc.resume(state.clone())?;
</a><a href="#h27-7-55" id="h27-7-55" class="i">+        assert_eq!(t9.state(), state);
</a><a href="#h27-7-56" id="h27-7-56" class="i">+        assert_scan!(t9.scan(..)? =&gt; {
</a><a href="#h27-7-57" id="h27-7-57" class="i">+            b&quot;a&quot; =&gt; [1],
</a><a href="#h27-7-58" id="h27-7-58" class="i">+            b&quot;b&quot; =&gt; [1],
</a><a href="#h27-7-59" id="h27-7-59" class="i">+        });
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-65" id="h27-7-65" class="d">-    fn test_txn_delete_idempotent() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-66" id="h27-7-66" class="d">-        let mvcc = setup();
</a><a href="#h27-7-67" id="h27-7-67" class="i">+    /// Deletes should work on both existing, missing, and deleted keys, be
</a><a href="#h27-7-68" id="h27-7-68" class="i">+    /// idempotent.
</a><a href="#h27-7-69" id="h27-7-69" class="i">+    fn delete() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-70" id="h27-7-70" class="i">+        let mut mvcc = Schedule::new(&quot;delete&quot;)?;
</a><a href="#h27-7-71" id="h27-7-71" class="i">+        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[1])), (b&quot;tombstone&quot;, 1, None)])?;
</a> 
<a href="#h27-7-73" id="h27-7-73" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-74" id="h27-7-74" class="d">-        txn.delete(b&quot;key&quot;)?;
</a><a href="#h27-7-75" id="h27-7-75" class="d">-        txn.commit()?;
</a><a href="#h27-7-76" id="h27-7-76" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-7-77" id="h27-7-77" class="i">+        t1.set(b&quot;key&quot;, vec![2])?;
</a><a href="#h27-7-78" id="h27-7-78" class="i">+        t1.delete(b&quot;key&quot;)?; // delete uncommitted version
</a><a href="#h27-7-79" id="h27-7-79" class="i">+        t1.delete(b&quot;key&quot;)?; // idempotent
</a><a href="#h27-7-80" id="h27-7-80" class="i">+        t1.delete(b&quot;tombstone&quot;)?;
</a><a href="#h27-7-81" id="h27-7-81" class="i">+        t1.delete(b&quot;missing&quot;)?;
</a><a href="#h27-7-82" id="h27-7-82" class="i">+        t1.commit()?;
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-88" id="h27-7-88" class="d">-    fn test_txn_get() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-89" id="h27-7-89" class="d">-        let mvcc = setup();
</a><a href="#h27-7-90" id="h27-7-90" class="i">+    /// Delete should return serialization errors both for uncommitted versions
</a><a href="#h27-7-91" id="h27-7-91" class="i">+    /// (past and future), and future committed versions.
</a><a href="#h27-7-92" id="h27-7-92" class="i">+    fn delete_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-93" id="h27-7-93" class="i">+        let mut mvcc = Schedule::new(&quot;delete_conflict&quot;)?;
</a> 
<a href="#h27-7-95" id="h27-7-95" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-96" id="h27-7-96" class="d">-        assert_eq!(None, txn.get(b&quot;a&quot;)?);
</a><a href="#h27-7-97" id="h27-7-97" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-98" id="h27-7-98" class="d">-        assert_eq!(Some(vec![0x01]), txn.get(b&quot;a&quot;)?);
</a><a href="#h27-7-99" id="h27-7-99" class="d">-        txn.set(b&quot;a&quot;, vec![0x02])?;
</a><a href="#h27-7-100" id="h27-7-100" class="d">-        assert_eq!(Some(vec![0x02]), txn.get(b&quot;a&quot;)?);
</a><a href="#h27-7-101" id="h27-7-101" class="d">-        txn.commit()?;
</a><a href="#h27-7-102" id="h27-7-102" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-7-103" id="h27-7-103" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-104" id="h27-7-104" class="i">+        let t3 = mvcc.begin()?;
</a><a href="#h27-7-105" id="h27-7-105" class="i">+        let t4 = mvcc.begin()?;
</a><a href="#h27-7-106" id="h27-7-106" class="i">+
</a><a href="#h27-7-107" id="h27-7-107" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-7-108" id="h27-7-108" class="i">+        t3.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h27-7-109" id="h27-7-109" class="i">+        t4.set(b&quot;d&quot;, vec![4])?;
</a><a href="#h27-7-110" id="h27-7-110" class="i">+        t4.commit()?;
</a><a href="#h27-7-111" id="h27-7-111" class="i">+
</a><a href="#h27-7-112" id="h27-7-112" class="i">+        assert_eq!(t2.delete(b&quot;a&quot;), Err(Error::Serialization)); // past uncommitted
</a><a href="#h27-7-113" id="h27-7-113" class="i">+        assert_eq!(t2.delete(b&quot;c&quot;), Err(Error::Serialization)); // future uncommitted
</a><a href="#h27-7-114" id="h27-7-114" class="i">+        assert_eq!(t2.delete(b&quot;d&quot;), Err(Error::Serialization)); // future committed
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-120" id="h27-7-120" class="d">-    fn test_txn_get_deleted() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-121" id="h27-7-121" class="d">-        let mvcc = setup();
</a><a href="#h27-7-122" id="h27-7-122" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-123" id="h27-7-123" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-124" id="h27-7-124" class="d">-        txn.commit()?;
</a><a href="#h27-7-125" id="h27-7-125" class="d">-
</a><a href="#h27-7-126" id="h27-7-126" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-127" id="h27-7-127" class="d">-        txn.delete(b&quot;a&quot;)?;
</a><a href="#h27-7-128" id="h27-7-128" class="d">-        txn.commit()?;
</a><a href="#h27-7-129" id="h27-7-129" class="d">-
</a><a href="#h27-7-130" id="h27-7-130" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-131" id="h27-7-131" class="d">-        assert_eq!(None, txn.get(b&quot;a&quot;)?);
</a><a href="#h27-7-132" id="h27-7-132" class="d">-        txn.commit()?;
</a><a href="#h27-7-133" id="h27-7-133" class="i">+    /// Get should return the correct latest value.
</a><a href="#h27-7-134" id="h27-7-134" class="i">+    fn get() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-135" id="h27-7-135" class="i">+        let mut mvcc = Schedule::new(&quot;get&quot;)?;
</a><a href="#h27-7-136" id="h27-7-136" class="i">+        mvcc.setup(vec![
</a><a href="#h27-7-137" id="h27-7-137" class="i">+            (b&quot;key&quot;, 1, Some(&amp;[1])),
</a><a href="#h27-7-138" id="h27-7-138" class="i">+            (b&quot;updated&quot;, 1, Some(&amp;[1])),
</a><a href="#h27-7-139" id="h27-7-139" class="i">+            (b&quot;updated&quot;, 2, Some(&amp;[2])),
</a><a href="#h27-7-140" id="h27-7-140" class="i">+            (b&quot;deleted&quot;, 1, Some(&amp;[1])),
</a><a href="#h27-7-141" id="h27-7-141" class="i">+            (b&quot;deleted&quot;, 2, None),
</a><a href="#h27-7-142" id="h27-7-142" class="i">+            (b&quot;tombstone&quot;, 1, None),
</a><a href="#h27-7-143" id="h27-7-143" class="i">+        ])?;
</a><a href="#h27-7-144" id="h27-7-144" class="i">+
</a><a href="#h27-7-145" id="h27-7-145" class="i">+        let t1 = mvcc.begin_read_only()?;
</a><a href="#h27-7-146" id="h27-7-146" class="i">+        assert_eq!(t1.get(b&quot;key&quot;)?, Some(vec![1]));
</a><a href="#h27-7-147" id="h27-7-147" class="i">+        assert_eq!(t1.get(b&quot;updated&quot;)?, Some(vec![2]));
</a><a href="#h27-7-148" id="h27-7-148" class="i">+        assert_eq!(t1.get(b&quot;deleted&quot;)?, None);
</a><a href="#h27-7-149" id="h27-7-149" class="i">+        assert_eq!(t1.get(b&quot;tombstone&quot;)?, None);
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-155" id="h27-7-155" class="d">-    fn test_txn_get_hides_newer() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-156" id="h27-7-156" class="d">-        let mvcc = setup();
</a><a href="#h27-7-157" id="h27-7-157" class="i">+    /// Get should be isolated from future and uncommitted transactions.
</a><a href="#h27-7-158" id="h27-7-158" class="i">+    fn get_isolation() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-159" id="h27-7-159" class="i">+        let mut mvcc = Schedule::new(&quot;get_isolation&quot;)?;
</a> 
         let t1 = mvcc.begin()?;
<a href="#h27-7-162" id="h27-7-162" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-163" id="h27-7-163" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h27-7-164" id="h27-7-164" class="d">-
</a><a href="#h27-7-165" id="h27-7-165" class="d">-        t1.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-166" id="h27-7-166" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-7-167" id="h27-7-167" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h27-7-168" id="h27-7-168" class="i">+        t1.set(b&quot;d&quot;, vec![1])?;
</a><a href="#h27-7-169" id="h27-7-169" class="i">+        t1.set(b&quot;e&quot;, vec![1])?;
</a>         t1.commit()?;
<a href="#h27-7-171" id="h27-7-171" class="d">-        t3.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h27-7-172" id="h27-7-172" class="d">-        t3.commit()?;
</a><a href="#h27-7-173" id="h27-7-173" class="d">-
</a><a href="#h27-7-174" id="h27-7-174" class="d">-        assert_eq!(None, t2.get(b&quot;a&quot;)?);
</a><a href="#h27-7-175" id="h27-7-175" class="d">-        assert_eq!(None, t2.get(b&quot;c&quot;)?);
</a> 
<a href="#h27-7-177" id="h27-7-177" class="d">-        Ok(())
</a><a href="#h27-7-178" id="h27-7-178" class="d">-    }
</a><a href="#h27-7-179" id="h27-7-179" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-180" id="h27-7-180" class="i">+        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h27-7-181" id="h27-7-181" class="i">+        t2.delete(b&quot;b&quot;)?;
</a><a href="#h27-7-182" id="h27-7-182" class="i">+        t2.set(b&quot;c&quot;, vec![2])?;
</a> 
<a href="#h27-7-184" id="h27-7-184" class="d">-    #[test]
</a><a href="#h27-7-185" id="h27-7-185" class="d">-    fn test_txn_get_hides_uncommitted() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-186" id="h27-7-186" class="d">-        let mvcc = setup();
</a><a href="#h27-7-187" id="h27-7-187" class="i">+        let t3 = mvcc.begin_read_only()?;
</a> 
<a href="#h27-7-189" id="h27-7-189" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h27-7-190" id="h27-7-190" class="d">-        t1.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-191" id="h27-7-191" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-192" id="h27-7-192" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h27-7-193" id="h27-7-193" class="d">-        t3.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h27-7-194" id="h27-7-194" class="i">+        let t4 = mvcc.begin()?;
</a><a href="#h27-7-195" id="h27-7-195" class="i">+        t4.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h27-7-196" id="h27-7-196" class="i">+        t4.delete(b&quot;e&quot;)?;
</a><a href="#h27-7-197" id="h27-7-197" class="i">+        t4.set(b&quot;f&quot;, vec![3])?;
</a><a href="#h27-7-198" id="h27-7-198" class="i">+        t4.commit()?;
</a> 
<a href="#h27-7-200" id="h27-7-200" class="d">-        assert_eq!(None, t2.get(b&quot;a&quot;)?);
</a><a href="#h27-7-201" id="h27-7-201" class="d">-        assert_eq!(None, t2.get(b&quot;c&quot;)?);
</a><a href="#h27-7-202" id="h27-7-202" class="i">+        assert_eq!(t3.get(b&quot;a&quot;)?, Some(vec![1])); // uncommitted update
</a><a href="#h27-7-203" id="h27-7-203" class="i">+        assert_eq!(t3.get(b&quot;b&quot;)?, Some(vec![1])); // uncommitted delete
</a><a href="#h27-7-204" id="h27-7-204" class="i">+        assert_eq!(t3.get(b&quot;c&quot;)?, None); // uncommitted write
</a><a href="#h27-7-205" id="h27-7-205" class="i">+        assert_eq!(t3.get(b&quot;d&quot;)?, Some(vec![1])); // future update
</a><a href="#h27-7-206" id="h27-7-206" class="i">+        assert_eq!(t3.get(b&quot;e&quot;)?, Some(vec![1])); // future delete
</a><a href="#h27-7-207" id="h27-7-207" class="i">+        assert_eq!(t3.get(b&quot;f&quot;)?, None); // future write
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-213" id="h27-7-213" class="d">-    fn test_txn_get_readonly_historical() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-214" id="h27-7-214" class="d">-        let mvcc = setup();
</a><a href="#h27-7-215" id="h27-7-215" class="d">-
</a><a href="#h27-7-216" id="h27-7-216" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-217" id="h27-7-217" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-218" id="h27-7-218" class="d">-        txn.commit()?;
</a><a href="#h27-7-219" id="h27-7-219" class="d">-
</a><a href="#h27-7-220" id="h27-7-220" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-221" id="h27-7-221" class="d">-        txn.set(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h27-7-222" id="h27-7-222" class="d">-        txn.commit()?;
</a><a href="#h27-7-223" id="h27-7-223" class="d">-
</a><a href="#h27-7-224" id="h27-7-224" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-225" id="h27-7-225" class="d">-        txn.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h27-7-226" id="h27-7-226" class="d">-        txn.commit()?;
</a><a href="#h27-7-227" id="h27-7-227" class="i">+    /// Scans should use correct key and time bounds. Sets up an initial data
</a><a href="#h27-7-228" id="h27-7-228" class="i">+    /// set as follows, and asserts results via the golden file.
</a><a href="#h27-7-229" id="h27-7-229" class="i">+    ///
</a><a href="#h27-7-230" id="h27-7-230" class="i">+    /// T
</a><a href="#h27-7-231" id="h27-7-231" class="i">+    /// 4             x   ba,4
</a><a href="#h27-7-232" id="h27-7-232" class="i">+    /// 3   x   a,3  b,3        x
</a><a href="#h27-7-233" id="h27-7-233" class="i">+    /// 2        x        ba,2 bb,2 bc,2
</a><a href="#h27-7-234" id="h27-7-234" class="i">+    /// 1  0,1  a,1   x                  c,1
</a><a href="#h27-7-235" id="h27-7-235" class="i">+    ///     B    a    b    ba   bb   bc   c
</a><a href="#h27-7-236" id="h27-7-236" class="i">+    fn scan() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-237" id="h27-7-237" class="i">+        let mut mvcc = Schedule::new(&quot;scan&quot;)?;
</a><a href="#h27-7-238" id="h27-7-238" class="i">+        mvcc.setup(vec![
</a><a href="#h27-7-239" id="h27-7-239" class="i">+            (b&quot;B&quot;, 1, Some(&amp;[0, 1])),
</a><a href="#h27-7-240" id="h27-7-240" class="i">+            (b&quot;B&quot;, 3, None),
</a><a href="#h27-7-241" id="h27-7-241" class="i">+            (b&quot;a&quot;, 1, Some(&amp;[0x0a, 1])),
</a><a href="#h27-7-242" id="h27-7-242" class="i">+            (b&quot;a&quot;, 2, None),
</a><a href="#h27-7-243" id="h27-7-243" class="i">+            (b&quot;a&quot;, 3, Some(&amp;[0x0a, 3])),
</a><a href="#h27-7-244" id="h27-7-244" class="i">+            (b&quot;b&quot;, 1, None),
</a><a href="#h27-7-245" id="h27-7-245" class="i">+            (b&quot;b&quot;, 3, Some(&amp;[0x0b, 3])),
</a><a href="#h27-7-246" id="h27-7-246" class="i">+            (b&quot;b&quot;, 4, None),
</a><a href="#h27-7-247" id="h27-7-247" class="i">+            (b&quot;ba&quot;, 2, Some(&amp;[0xba, 2])),
</a><a href="#h27-7-248" id="h27-7-248" class="i">+            (b&quot;ba&quot;, 4, Some(&amp;[0xba, 4])),
</a><a href="#h27-7-249" id="h27-7-249" class="i">+            (b&quot;bb&quot;, 2, Some(&amp;[0xbb, 2])),
</a><a href="#h27-7-250" id="h27-7-250" class="i">+            (b&quot;bb&quot;, 3, None),
</a><a href="#h27-7-251" id="h27-7-251" class="i">+            (b&quot;bc&quot;, 2, Some(&amp;[0xbc, 2])),
</a><a href="#h27-7-252" id="h27-7-252" class="i">+            (b&quot;c&quot;, 1, Some(&amp;[0x0c, 1])),
</a><a href="#h27-7-253" id="h27-7-253" class="i">+        ])?;
</a><a href="#h27-7-254" id="h27-7-254" class="i">+
</a><a href="#h27-7-255" id="h27-7-255" class="i">+        // Full scans at all timestamps.
</a><a href="#h27-7-256" id="h27-7-256" class="i">+        for version in 1..5 {
</a><a href="#h27-7-257" id="h27-7-257" class="i">+            let txn = match version {
</a><a href="#h27-7-258" id="h27-7-258" class="i">+                v if v == 5 =&gt; mvcc.begin_read_only()?,
</a><a href="#h27-7-259" id="h27-7-259" class="i">+                v =&gt; mvcc.begin_as_of(v)?,
</a><a href="#h27-7-260" id="h27-7-260" class="i">+            };
</a><a href="#h27-7-261" id="h27-7-261" class="i">+            let mut scan = txn.scan(..)?; // see golden master
</a><a href="#h27-7-262" id="h27-7-262" class="i">+            assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h27-7-263" id="h27-7-263" class="i">+        }
</a> 
<a href="#h27-7-265" id="h27-7-265" class="d">-        let tr = mvcc.begin_as_of(3)?;
</a><a href="#h27-7-266" id="h27-7-266" class="d">-        assert_eq!(Some(vec![0x01]), tr.get(b&quot;a&quot;)?);
</a><a href="#h27-7-267" id="h27-7-267" class="d">-        assert_eq!(Some(vec![0x02]), tr.get(b&quot;b&quot;)?);
</a><a href="#h27-7-268" id="h27-7-268" class="d">-        assert_eq!(None, tr.get(b&quot;c&quot;)?);
</a><a href="#h27-7-269" id="h27-7-269" class="i">+        // All bounded scans around ba-bc at version 3.
</a><a href="#h27-7-270" id="h27-7-270" class="i">+        let txn = mvcc.begin_as_of(3)?;
</a><a href="#h27-7-271" id="h27-7-271" class="i">+        let starts =
</a><a href="#h27-7-272" id="h27-7-272" class="i">+            [Bound::Unbounded, Bound::Included(b&quot;ba&quot;.to_vec()), Bound::Excluded(b&quot;ba&quot;.to_vec())];
</a><a href="#h27-7-273" id="h27-7-273" class="i">+        let ends =
</a><a href="#h27-7-274" id="h27-7-274" class="i">+            [Bound::Unbounded, Bound::Included(b&quot;bc&quot;.to_vec()), Bound::Excluded(b&quot;bc&quot;.to_vec())];
</a><a href="#h27-7-275" id="h27-7-275" class="i">+        for start in &amp;starts {
</a><a href="#h27-7-276" id="h27-7-276" class="i">+            for end in &amp;ends {
</a><a href="#h27-7-277" id="h27-7-277" class="i">+                let mut scan = txn.scan((start.to_owned(), end.to_owned()))?; // see golden master
</a><a href="#h27-7-278" id="h27-7-278" class="i">+                assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h27-7-279" id="h27-7-279" class="i">+            }
</a><a href="#h27-7-280" id="h27-7-280" class="i">+        }
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-286" id="h27-7-286" class="d">-    fn test_txn_get_serial() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-287" id="h27-7-287" class="d">-        let mvcc = setup();
</a><a href="#h27-7-288" id="h27-7-288" class="d">-
</a><a href="#h27-7-289" id="h27-7-289" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-290" id="h27-7-290" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-291" id="h27-7-291" class="d">-        txn.commit()?;
</a><a href="#h27-7-292" id="h27-7-292" class="i">+    /// Prefix scans should use correct key and time bounds. Sets up an initial
</a><a href="#h27-7-293" id="h27-7-293" class="i">+    /// data set as follows, and asserts results via the golden file.
</a><a href="#h27-7-294" id="h27-7-294" class="i">+    ///
</a><a href="#h27-7-295" id="h27-7-295" class="i">+    /// T
</a><a href="#h27-7-296" id="h27-7-296" class="i">+    /// 4             x   ba,4
</a><a href="#h27-7-297" id="h27-7-297" class="i">+    /// 3   x   a,3  b,3        x
</a><a href="#h27-7-298" id="h27-7-298" class="i">+    /// 2        x        ba,2 bb,2 bc,2
</a><a href="#h27-7-299" id="h27-7-299" class="i">+    /// 1  0,1  a,1   x                  c,1
</a><a href="#h27-7-300" id="h27-7-300" class="i">+    ///     B    a    b    ba   bb   bc   c
</a><a href="#h27-7-301" id="h27-7-301" class="i">+    fn scan_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-302" id="h27-7-302" class="i">+        let mut mvcc = Schedule::new(&quot;scan_prefix&quot;)?;
</a><a href="#h27-7-303" id="h27-7-303" class="i">+        mvcc.setup(vec![
</a><a href="#h27-7-304" id="h27-7-304" class="i">+            (b&quot;B&quot;, 1, Some(&amp;[0, 1])),
</a><a href="#h27-7-305" id="h27-7-305" class="i">+            (b&quot;B&quot;, 3, None),
</a><a href="#h27-7-306" id="h27-7-306" class="i">+            (b&quot;a&quot;, 1, Some(&amp;[0x0a, 1])),
</a><a href="#h27-7-307" id="h27-7-307" class="i">+            (b&quot;a&quot;, 2, None),
</a><a href="#h27-7-308" id="h27-7-308" class="i">+            (b&quot;a&quot;, 3, Some(&amp;[0x0a, 3])),
</a><a href="#h27-7-309" id="h27-7-309" class="i">+            (b&quot;b&quot;, 1, None),
</a><a href="#h27-7-310" id="h27-7-310" class="i">+            (b&quot;b&quot;, 3, Some(&amp;[0x0b, 3])),
</a><a href="#h27-7-311" id="h27-7-311" class="i">+            (b&quot;b&quot;, 4, None),
</a><a href="#h27-7-312" id="h27-7-312" class="i">+            (b&quot;ba&quot;, 2, Some(&amp;[0xba, 2])),
</a><a href="#h27-7-313" id="h27-7-313" class="i">+            (b&quot;ba&quot;, 4, Some(&amp;[0xba, 4])),
</a><a href="#h27-7-314" id="h27-7-314" class="i">+            (b&quot;bb&quot;, 2, Some(&amp;[0xbb, 2])),
</a><a href="#h27-7-315" id="h27-7-315" class="i">+            (b&quot;bb&quot;, 3, None),
</a><a href="#h27-7-316" id="h27-7-316" class="i">+            (b&quot;bc&quot;, 2, Some(&amp;[0xbc, 2])),
</a><a href="#h27-7-317" id="h27-7-317" class="i">+            (b&quot;c&quot;, 1, Some(&amp;[0x0c, 1])),
</a><a href="#h27-7-318" id="h27-7-318" class="i">+        ])?;
</a><a href="#h27-7-319" id="h27-7-319" class="i">+
</a><a href="#h27-7-320" id="h27-7-320" class="i">+        // Full scans at all timestamps.
</a><a href="#h27-7-321" id="h27-7-321" class="i">+        for version in 1..5 {
</a><a href="#h27-7-322" id="h27-7-322" class="i">+            let txn = match version {
</a><a href="#h27-7-323" id="h27-7-323" class="i">+                v if v == 5 =&gt; mvcc.begin_read_only()?,
</a><a href="#h27-7-324" id="h27-7-324" class="i">+                v =&gt; mvcc.begin_as_of(v)?,
</a><a href="#h27-7-325" id="h27-7-325" class="i">+            };
</a><a href="#h27-7-326" id="h27-7-326" class="i">+            let mut scan = txn.scan_prefix(&amp;[])?; // see golden master
</a><a href="#h27-7-327" id="h27-7-327" class="i">+            assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h27-7-328" id="h27-7-328" class="i">+        }
</a> 
<a href="#h27-7-330" id="h27-7-330" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-331" id="h27-7-331" class="d">-        assert_eq!(Some(vec![0x01]), txn.get(b&quot;a&quot;)?);
</a><a href="#h27-7-332" id="h27-7-332" class="i">+        // All prefixes at version 3 and version 4.
</a><a href="#h27-7-333" id="h27-7-333" class="i">+        for version in 3..=4 {
</a><a href="#h27-7-334" id="h27-7-334" class="i">+            let txn = mvcc.begin_as_of(version)?;
</a><a href="#h27-7-335" id="h27-7-335" class="i">+            for prefix in [b&quot;B&quot; as &amp;[u8], b&quot;a&quot;, b&quot;b&quot;, b&quot;ba&quot;, b&quot;bb&quot;, b&quot;bbb&quot;, b&quot;bc&quot;, b&quot;c&quot;, b&quot;d&quot;] {
</a><a href="#h27-7-336" id="h27-7-336" class="i">+                let mut scan = txn.scan_prefix(prefix)?; // see golden master
</a><a href="#h27-7-337" id="h27-7-337" class="i">+                assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h27-7-338" id="h27-7-338" class="i">+            }
</a><a href="#h27-7-339" id="h27-7-339" class="i">+        }
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-345" id="h27-7-345" class="d">-    fn test_txn_scan() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-346" id="h27-7-346" class="d">-        let mvcc = setup();
</a><a href="#h27-7-347" id="h27-7-347" class="d">-
</a><a href="#h27-7-348" id="h27-7-348" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-349" id="h27-7-349" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-350" id="h27-7-350" class="d">-        txn.delete(b&quot;b&quot;)?;
</a><a href="#h27-7-351" id="h27-7-351" class="d">-        txn.set(b&quot;c&quot;, vec![0x01])?;
</a><a href="#h27-7-352" id="h27-7-352" class="d">-        txn.set(b&quot;d&quot;, vec![0x01])?;
</a><a href="#h27-7-353" id="h27-7-353" class="d">-        txn.set(b&quot;e&quot;, vec![0x01])?;
</a><a href="#h27-7-354" id="h27-7-354" class="d">-        txn.commit()?;
</a><a href="#h27-7-355" id="h27-7-355" class="d">-
</a><a href="#h27-7-356" id="h27-7-356" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-357" id="h27-7-357" class="d">-        txn.set(b&quot;c&quot;, vec![0x02])?;
</a><a href="#h27-7-358" id="h27-7-358" class="d">-        txn.set(b&quot;d&quot;, vec![0x02])?;
</a><a href="#h27-7-359" id="h27-7-359" class="d">-        txn.set(b&quot;e&quot;, vec![0x02])?;
</a><a href="#h27-7-360" id="h27-7-360" class="d">-        txn.commit()?;
</a><a href="#h27-7-361" id="h27-7-361" class="d">-
</a><a href="#h27-7-362" id="h27-7-362" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-363" id="h27-7-363" class="d">-        txn.delete(b&quot;c&quot;)?;
</a><a href="#h27-7-364" id="h27-7-364" class="d">-        txn.set(b&quot;d&quot;, vec![0x03])?;
</a><a href="#h27-7-365" id="h27-7-365" class="d">-        txn.set(b&quot;e&quot;, vec![0x03])?;
</a><a href="#h27-7-366" id="h27-7-366" class="d">-        txn.commit()?;
</a><a href="#h27-7-367" id="h27-7-367" class="d">-
</a><a href="#h27-7-368" id="h27-7-368" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-369" id="h27-7-369" class="d">-        txn.set(b&quot;c&quot;, vec![0x04])?;
</a><a href="#h27-7-370" id="h27-7-370" class="d">-        txn.set(b&quot;d&quot;, vec![0x04])?;
</a><a href="#h27-7-371" id="h27-7-371" class="d">-        txn.delete(b&quot;e&quot;)?;
</a><a href="#h27-7-372" id="h27-7-372" class="d">-        txn.commit()?;
</a><a href="#h27-7-373" id="h27-7-373" class="d">-
</a><a href="#h27-7-374" id="h27-7-374" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-375" id="h27-7-375" class="d">-        txn.delete(b&quot;d&quot;)?;
</a><a href="#h27-7-376" id="h27-7-376" class="d">-        txn.set(b&quot;e&quot;, vec![0x05])?;
</a><a href="#h27-7-377" id="h27-7-377" class="d">-        txn.commit()?;
</a><a href="#h27-7-378" id="h27-7-378" class="d">-
</a><a href="#h27-7-379" id="h27-7-379" class="d">-        // Forward scan
</a><a href="#h27-7-380" id="h27-7-380" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-381" id="h27-7-381" class="d">-        assert_eq!(
</a><a href="#h27-7-382" id="h27-7-382" class="d">-            vec![
</a><a href="#h27-7-383" id="h27-7-383" class="d">-                (b&quot;a&quot;.to_vec(), vec![0x01]),
</a><a href="#h27-7-384" id="h27-7-384" class="d">-                (b&quot;c&quot;.to_vec(), vec![0x04]),
</a><a href="#h27-7-385" id="h27-7-385" class="d">-                (b&quot;e&quot;.to_vec(), vec![0x05]),
</a><a href="#h27-7-386" id="h27-7-386" class="d">-            ],
</a><a href="#h27-7-387" id="h27-7-387" class="d">-            txn.scan(..)?.to_vec()?
</a><a href="#h27-7-388" id="h27-7-388" class="d">-        );
</a><a href="#h27-7-389" id="h27-7-389" class="i">+    /// Scan should be isolated from future and uncommitted transactions.
</a><a href="#h27-7-390" id="h27-7-390" class="i">+    fn scan_isolation() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-391" id="h27-7-391" class="i">+        let mut mvcc = Schedule::new(&quot;scan_isolation&quot;)?;
</a> 
<a href="#h27-7-393" id="h27-7-393" class="d">-        // Reverse scan
</a><a href="#h27-7-394" id="h27-7-394" class="d">-        assert_eq!(
</a><a href="#h27-7-395" id="h27-7-395" class="d">-            vec![
</a><a href="#h27-7-396" id="h27-7-396" class="d">-                (b&quot;e&quot;.to_vec(), vec![0x05]),
</a><a href="#h27-7-397" id="h27-7-397" class="d">-                (b&quot;c&quot;.to_vec(), vec![0x04]),
</a><a href="#h27-7-398" id="h27-7-398" class="d">-                (b&quot;a&quot;.to_vec(), vec![0x01]),
</a><a href="#h27-7-399" id="h27-7-399" class="d">-            ],
</a><a href="#h27-7-400" id="h27-7-400" class="d">-            txn.scan(..)?.iter().rev().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h27-7-401" id="h27-7-401" class="d">-        );
</a><a href="#h27-7-402" id="h27-7-402" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-7-403" id="h27-7-403" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-7-404" id="h27-7-404" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h27-7-405" id="h27-7-405" class="i">+        t1.set(b&quot;d&quot;, vec![1])?;
</a><a href="#h27-7-406" id="h27-7-406" class="i">+        t1.set(b&quot;e&quot;, vec![1])?;
</a><a href="#h27-7-407" id="h27-7-407" class="i">+        t1.commit()?;
</a> 
<a href="#h27-7-409" id="h27-7-409" class="d">-        // Alternate forward/backward scan
</a><a href="#h27-7-410" id="h27-7-410" class="d">-        let mut scan = txn.scan(..)?;
</a><a href="#h27-7-411" id="h27-7-411" class="d">-        let mut iter = scan.iter();
</a><a href="#h27-7-412" id="h27-7-412" class="d">-        assert_eq!(Some((b&quot;a&quot;.to_vec(), vec![0x01])), iter.next().transpose()?);
</a><a href="#h27-7-413" id="h27-7-413" class="d">-        assert_eq!(Some((b&quot;e&quot;.to_vec(), vec![0x05])), iter.next_back().transpose()?);
</a><a href="#h27-7-414" id="h27-7-414" class="d">-        assert_eq!(Some((b&quot;c&quot;.to_vec(), vec![0x04])), iter.next_back().transpose()?);
</a><a href="#h27-7-415" id="h27-7-415" class="d">-        assert_eq!(None, iter.next().transpose()?);
</a><a href="#h27-7-416" id="h27-7-416" class="d">-        drop(scan);
</a><a href="#h27-7-417" id="h27-7-417" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-418" id="h27-7-418" class="i">+        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h27-7-419" id="h27-7-419" class="i">+        t2.delete(b&quot;b&quot;)?;
</a><a href="#h27-7-420" id="h27-7-420" class="i">+        t2.set(b&quot;c&quot;, vec![2])?;
</a> 
<a href="#h27-7-422" id="h27-7-422" class="d">-        txn.commit()?;
</a><a href="#h27-7-423" id="h27-7-423" class="d">-        Ok(())
</a><a href="#h27-7-424" id="h27-7-424" class="d">-    }
</a><a href="#h27-7-425" id="h27-7-425" class="i">+        let t3 = mvcc.begin_read_only()?;
</a> 
<a href="#h27-7-427" id="h27-7-427" class="d">-    #[test]
</a><a href="#h27-7-428" id="h27-7-428" class="d">-    fn test_txn_scan_key_version_overlap() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-429" id="h27-7-429" class="d">-        // The idea here is that with a naive key/version concatenation
</a><a href="#h27-7-430" id="h27-7-430" class="d">-        // we get overlapping entries that mess up scans. For example:
</a><a href="#h27-7-431" id="h27-7-431" class="d">-        //
</a><a href="#h27-7-432" id="h27-7-432" class="d">-        // 00|00 00 00 00 00 00 00 01
</a><a href="#h27-7-433" id="h27-7-433" class="d">-        // 00 00 00 00 00 00 00 00 02|00 00 00 00 00 00 00 02
</a><a href="#h27-7-434" id="h27-7-434" class="d">-        // 00|00 00 00 00 00 00 00 03
</a><a href="#h27-7-435" id="h27-7-435" class="d">-        //
</a><a href="#h27-7-436" id="h27-7-436" class="d">-        // The key encoding should be resistant to this.
</a><a href="#h27-7-437" id="h27-7-437" class="d">-        let mvcc = setup();
</a><a href="#h27-7-438" id="h27-7-438" class="i">+        let t4 = mvcc.begin()?;
</a><a href="#h27-7-439" id="h27-7-439" class="i">+        t4.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h27-7-440" id="h27-7-440" class="i">+        t4.delete(b&quot;e&quot;)?;
</a><a href="#h27-7-441" id="h27-7-441" class="i">+        t4.set(b&quot;f&quot;, vec![3])?;
</a><a href="#h27-7-442" id="h27-7-442" class="i">+        t4.commit()?;
</a> 
<a href="#h27-7-444" id="h27-7-444" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-445" id="h27-7-445" class="d">-        txn.set(&amp;[0], vec![0])?; // v0
</a><a href="#h27-7-446" id="h27-7-446" class="d">-        txn.set(&amp;[0], vec![1])?; // v1
</a><a href="#h27-7-447" id="h27-7-447" class="d">-        txn.set(&amp;[0, 0, 0, 0, 0, 0, 0, 0, 2], vec![2])?; // v2
</a><a href="#h27-7-448" id="h27-7-448" class="d">-        txn.set(&amp;[0], vec![3])?; // v3
</a><a href="#h27-7-449" id="h27-7-449" class="d">-        txn.commit()?;
</a><a href="#h27-7-450" id="h27-7-450" class="i">+        assert_scan!(t3.scan(..)? =&gt; {
</a><a href="#h27-7-451" id="h27-7-451" class="i">+            b&quot;a&quot; =&gt; [1], // uncommitted update
</a><a href="#h27-7-452" id="h27-7-452" class="i">+            b&quot;b&quot; =&gt; [1], // uncommitted delete
</a><a href="#h27-7-453" id="h27-7-453" class="i">+            // b&quot;c&quot; is uncommitted write
</a><a href="#h27-7-454" id="h27-7-454" class="i">+            b&quot;d&quot; =&gt; [1], // future update
</a><a href="#h27-7-455" id="h27-7-455" class="i">+            b&quot;e&quot; =&gt; [1], // future delete
</a><a href="#h27-7-456" id="h27-7-456" class="i">+            // b&quot;f&quot; is future write
</a><a href="#h27-7-457" id="h27-7-457" class="i">+        });
</a> 
<a href="#h27-7-459" id="h27-7-459" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-460" id="h27-7-460" class="d">-        assert_eq!(
</a><a href="#h27-7-461" id="h27-7-461" class="d">-            vec![(vec![0].to_vec(), vec![3]), (vec![0, 0, 0, 0, 0, 0, 0, 0, 2].to_vec(), vec![2]),],
</a><a href="#h27-7-462" id="h27-7-462" class="d">-            txn.scan(..)?.to_vec()?,
</a><a href="#h27-7-463" id="h27-7-463" class="d">-        );
</a>         Ok(())
     }
 
     #[test]
<a href="#h27-7-468" id="h27-7-468" class="d">-    fn test_txn_scan_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-469" id="h27-7-469" class="d">-        let mvcc = setup();
</a><a href="#h27-7-470" id="h27-7-470" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-471" id="h27-7-471" class="d">-
</a><a href="#h27-7-472" id="h27-7-472" class="d">-        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h27-7-473" id="h27-7-473" class="d">-        txn.set(b&quot;az&quot;, vec![0x01, 0x1a])?;
</a><a href="#h27-7-474" id="h27-7-474" class="d">-        txn.set(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h27-7-475" id="h27-7-475" class="d">-        txn.set(b&quot;ba&quot;, vec![0x02, 0x01])?;
</a><a href="#h27-7-476" id="h27-7-476" class="d">-        txn.set(b&quot;bb&quot;, vec![0x02, 0x02])?;
</a><a href="#h27-7-477" id="h27-7-477" class="d">-        txn.set(b&quot;bc&quot;, vec![0x02, 0x03])?;
</a><a href="#h27-7-478" id="h27-7-478" class="d">-        txn.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h27-7-479" id="h27-7-479" class="d">-        txn.commit()?;
</a><a href="#h27-7-480" id="h27-7-480" class="d">-
</a><a href="#h27-7-481" id="h27-7-481" class="d">-        // Forward scan
</a><a href="#h27-7-482" id="h27-7-482" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-483" id="h27-7-483" class="d">-        assert_eq!(
</a><a href="#h27-7-484" id="h27-7-484" class="d">-            vec![
</a><a href="#h27-7-485" id="h27-7-485" class="d">-                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h27-7-486" id="h27-7-486" class="d">-                (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h27-7-487" id="h27-7-487" class="d">-                (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h27-7-488" id="h27-7-488" class="d">-                (b&quot;bc&quot;.to_vec(), vec![0x02, 0x03]),
</a><a href="#h27-7-489" id="h27-7-489" class="d">-            ],
</a><a href="#h27-7-490" id="h27-7-490" class="d">-            txn.scan_prefix(b&quot;b&quot;)?.to_vec()?,
</a><a href="#h27-7-491" id="h27-7-491" class="d">-        );
</a><a href="#h27-7-492" id="h27-7-492" class="i">+    /// Tests that the key encoding is resistant to key/version overlap.
</a><a href="#h27-7-493" id="h27-7-493" class="i">+    /// For example, a naïve concatenation of keys and versions would
</a><a href="#h27-7-494" id="h27-7-494" class="i">+    /// produce incorrect ordering in this case:
</a><a href="#h27-7-495" id="h27-7-495" class="i">+    ///
</a><a href="#h27-7-496" id="h27-7-496" class="i">+    // 00|00 00 00 00 00 00 00 01
</a><a href="#h27-7-497" id="h27-7-497" class="i">+    // 00 00 00 00 00 00 00 00 02|00 00 00 00 00 00 00 02
</a><a href="#h27-7-498" id="h27-7-498" class="i">+    // 00|00 00 00 00 00 00 00 03
</a><a href="#h27-7-499" id="h27-7-499" class="i">+    fn scan_key_version_encoding() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-500" id="h27-7-500" class="i">+        let mut mvcc = Schedule::new(&quot;scan_key_version_encoding&quot;)?;
</a> 
<a href="#h27-7-502" id="h27-7-502" class="d">-        // Reverse scan
</a><a href="#h27-7-503" id="h27-7-503" class="d">-        assert_eq!(
</a><a href="#h27-7-504" id="h27-7-504" class="d">-            vec![
</a><a href="#h27-7-505" id="h27-7-505" class="d">-                (b&quot;bc&quot;.to_vec(), vec![0x02, 0x03]),
</a><a href="#h27-7-506" id="h27-7-506" class="d">-                (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h27-7-507" id="h27-7-507" class="d">-                (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h27-7-508" id="h27-7-508" class="d">-                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h27-7-509" id="h27-7-509" class="d">-            ],
</a><a href="#h27-7-510" id="h27-7-510" class="d">-            txn.scan_prefix(b&quot;b&quot;)?.iter().rev().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h27-7-511" id="h27-7-511" class="d">-        );
</a><a href="#h27-7-512" id="h27-7-512" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-7-513" id="h27-7-513" class="i">+        t1.set(&amp;[0], vec![1])?;
</a><a href="#h27-7-514" id="h27-7-514" class="i">+        t1.commit()?;
</a> 
<a href="#h27-7-516" id="h27-7-516" class="d">-        // Alternate forward/backward scan
</a><a href="#h27-7-517" id="h27-7-517" class="d">-        let mut scan = txn.scan_prefix(b&quot;b&quot;)?;
</a><a href="#h27-7-518" id="h27-7-518" class="d">-        let mut iter = scan.iter();
</a><a href="#h27-7-519" id="h27-7-519" class="d">-        assert_eq!(Some((b&quot;b&quot;.to_vec(), vec![0x02])), iter.next().transpose()?);
</a><a href="#h27-7-520" id="h27-7-520" class="d">-        assert_eq!(Some((b&quot;bc&quot;.to_vec(), vec![0x02, 0x03])), iter.next_back().transpose()?);
</a><a href="#h27-7-521" id="h27-7-521" class="d">-        assert_eq!(Some((b&quot;bb&quot;.to_vec(), vec![0x02, 0x02])), iter.next_back().transpose()?);
</a><a href="#h27-7-522" id="h27-7-522" class="d">-        assert_eq!(Some((b&quot;ba&quot;.to_vec(), vec![0x02, 0x01])), iter.next().transpose()?);
</a><a href="#h27-7-523" id="h27-7-523" class="d">-        assert_eq!(None, iter.next().transpose()?);
</a><a href="#h27-7-524" id="h27-7-524" class="d">-        drop(scan);
</a><a href="#h27-7-525" id="h27-7-525" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-526" id="h27-7-526" class="i">+        t2.set(&amp;[0], vec![2])?;
</a><a href="#h27-7-527" id="h27-7-527" class="i">+        t2.set(&amp;[0, 0, 0, 0, 0, 0, 0, 0, 2], vec![2])?;
</a><a href="#h27-7-528" id="h27-7-528" class="i">+        t2.commit()?;
</a> 
<a href="#h27-7-530" id="h27-7-530" class="d">-        txn.commit()?;
</a><a href="#h27-7-531" id="h27-7-531" class="i">+        let t3 = mvcc.begin()?;
</a><a href="#h27-7-532" id="h27-7-532" class="i">+        t3.set(&amp;[0], vec![3])?;
</a><a href="#h27-7-533" id="h27-7-533" class="i">+        t3.commit()?;
</a><a href="#h27-7-534" id="h27-7-534" class="i">+
</a><a href="#h27-7-535" id="h27-7-535" class="i">+        let t4 = mvcc.begin_read_only()?;
</a><a href="#h27-7-536" id="h27-7-536" class="i">+        assert_scan!(t4.scan(..)? =&gt; {
</a><a href="#h27-7-537" id="h27-7-537" class="i">+            b&quot;\x00&quot; =&gt; [3],
</a><a href="#h27-7-538" id="h27-7-538" class="i">+            b&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; =&gt; [2],
</a><a href="#h27-7-539" id="h27-7-539" class="i">+        });
</a>         Ok(())
     }
 
     #[test]
<a href="#h27-7-544" id="h27-7-544" class="d">-    fn test_txn_set_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-545" id="h27-7-545" class="d">-        let mvcc = setup();
</a><a href="#h27-7-546" id="h27-7-546" class="i">+    /// Sets should work on both existing, missing, and deleted keys, and be
</a><a href="#h27-7-547" id="h27-7-547" class="i">+    /// idempotent.
</a><a href="#h27-7-548" id="h27-7-548" class="i">+    fn set() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-549" id="h27-7-549" class="i">+        let mut mvcc = Schedule::new(&quot;set&quot;)?;
</a><a href="#h27-7-550" id="h27-7-550" class="i">+        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[1])), (b&quot;tombstone&quot;, 1, None)])?;
</a> 
         let t1 = mvcc.begin()?;
<a href="#h27-7-553" id="h27-7-553" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-554" id="h27-7-554" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h27-7-555" id="h27-7-555" class="d">-
</a><a href="#h27-7-556" id="h27-7-556" class="d">-        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h27-7-557" id="h27-7-557" class="d">-        assert_eq!(Err(Error::Serialization), t1.set(b&quot;key&quot;, vec![0x01]));
</a><a href="#h27-7-558" id="h27-7-558" class="d">-        assert_eq!(Err(Error::Serialization), t3.set(b&quot;key&quot;, vec![0x03]));
</a><a href="#h27-7-559" id="h27-7-559" class="d">-        t2.commit()?;
</a><a href="#h27-7-560" id="h27-7-560" class="i">+        t1.set(b&quot;key&quot;, vec![2])?; // update
</a><a href="#h27-7-561" id="h27-7-561" class="i">+        t1.set(b&quot;tombstone&quot;, vec![2])?; // update tombstone
</a><a href="#h27-7-562" id="h27-7-562" class="i">+        t1.set(b&quot;new&quot;, vec![1])?; // new write
</a><a href="#h27-7-563" id="h27-7-563" class="i">+        t1.set(b&quot;new&quot;, vec![1])?; // idempotent
</a><a href="#h27-7-564" id="h27-7-564" class="i">+        t1.set(b&quot;new&quot;, vec![2])?; // update own
</a><a href="#h27-7-565" id="h27-7-565" class="i">+        t1.commit()?;
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-571" id="h27-7-571" class="d">-    fn test_txn_set_conflict_committed() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-572" id="h27-7-572" class="d">-        let mvcc = setup();
</a><a href="#h27-7-573" id="h27-7-573" class="i">+    /// Set should return serialization errors both for uncommitted versions
</a><a href="#h27-7-574" id="h27-7-574" class="i">+    /// (past and future), and future committed versions.
</a><a href="#h27-7-575" id="h27-7-575" class="i">+    fn set_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-576" id="h27-7-576" class="i">+        let mut mvcc = Schedule::new(&quot;set_conflict&quot;)?;
</a> 
         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
         let t3 = mvcc.begin()?;
<a href="#h27-7-581" id="h27-7-581" class="i">+        let t4 = mvcc.begin()?;
</a> 
<a href="#h27-7-583" id="h27-7-583" class="d">-        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h27-7-584" id="h27-7-584" class="d">-        t2.commit()?;
</a><a href="#h27-7-585" id="h27-7-585" class="d">-        assert_eq!(Err(Error::Serialization), t1.set(b&quot;key&quot;, vec![0x01]));
</a><a href="#h27-7-586" id="h27-7-586" class="d">-        assert_eq!(Err(Error::Serialization), t3.set(b&quot;key&quot;, vec![0x03]));
</a><a href="#h27-7-587" id="h27-7-587" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-7-588" id="h27-7-588" class="i">+        t3.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h27-7-589" id="h27-7-589" class="i">+        t4.set(b&quot;d&quot;, vec![4])?;
</a><a href="#h27-7-590" id="h27-7-590" class="i">+        t4.commit()?;
</a><a href="#h27-7-591" id="h27-7-591" class="i">+
</a><a href="#h27-7-592" id="h27-7-592" class="i">+        assert_eq!(t2.set(b&quot;a&quot;, vec![2]), Err(Error::Serialization)); // past uncommitted
</a><a href="#h27-7-593" id="h27-7-593" class="i">+        assert_eq!(t2.set(b&quot;c&quot;, vec![2]), Err(Error::Serialization)); // future uncommitted
</a><a href="#h27-7-594" id="h27-7-594" class="i">+        assert_eq!(t2.set(b&quot;d&quot;, vec![2]), Err(Error::Serialization)); // future committed
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-600" id="h27-7-600" class="d">-    fn test_txn_set_rollback() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-601" id="h27-7-601" class="d">-        let mvcc = setup();
</a><a href="#h27-7-602" id="h27-7-602" class="d">-
</a><a href="#h27-7-603" id="h27-7-603" class="d">-        let txn = mvcc.begin()?;
</a><a href="#h27-7-604" id="h27-7-604" class="d">-        txn.set(b&quot;key&quot;, vec![0x00])?;
</a><a href="#h27-7-605" id="h27-7-605" class="d">-        txn.commit()?;
</a><a href="#h27-7-606" id="h27-7-606" class="d">-
</a><a href="#h27-7-607" id="h27-7-607" class="i">+    /// Tests that transaction rollback properly rolls back uncommitted writes,
</a><a href="#h27-7-608" id="h27-7-608" class="i">+    /// allowing other concurrent transactions to write the keys.
</a><a href="#h27-7-609" id="h27-7-609" class="i">+    fn rollback() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-610" id="h27-7-610" class="i">+        let mut mvcc = Schedule::new(&quot;rollback&quot;)?;
</a><a href="#h27-7-611" id="h27-7-611" class="i">+        mvcc.setup(vec![
</a><a href="#h27-7-612" id="h27-7-612" class="i">+            (b&quot;a&quot;, 1, Some(&amp;[0])),
</a><a href="#h27-7-613" id="h27-7-613" class="i">+            (b&quot;b&quot;, 1, Some(&amp;[0])),
</a><a href="#h27-7-614" id="h27-7-614" class="i">+            (b&quot;c&quot;, 1, Some(&amp;[0])),
</a><a href="#h27-7-615" id="h27-7-615" class="i">+            (b&quot;d&quot;, 1, Some(&amp;[0])),
</a><a href="#h27-7-616" id="h27-7-616" class="i">+        ])?;
</a><a href="#h27-7-617" id="h27-7-617" class="i">+
</a><a href="#h27-7-618" id="h27-7-618" class="i">+        // t2 will be rolled back. t1 and t3 are concurrent transactions.
</a>         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
         let t3 = mvcc.begin()?;
 
<a href="#h27-7-623" id="h27-7-623" class="d">-        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h27-7-624" id="h27-7-624" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-7-625" id="h27-7-625" class="i">+        t2.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h27-7-626" id="h27-7-626" class="i">+        t2.delete(b&quot;c&quot;)?;
</a><a href="#h27-7-627" id="h27-7-627" class="i">+        t3.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h27-7-628" id="h27-7-628" class="i">+
</a><a href="#h27-7-629" id="h27-7-629" class="i">+        // Both t1 and t3 will get serialization errors with t2.
</a><a href="#h27-7-630" id="h27-7-630" class="i">+        assert_eq!(t1.set(b&quot;b&quot;, vec![1]), Err(Error::Serialization));
</a><a href="#h27-7-631" id="h27-7-631" class="i">+        assert_eq!(t3.set(b&quot;c&quot;, vec![3]), Err(Error::Serialization));
</a><a href="#h27-7-632" id="h27-7-632" class="i">+
</a><a href="#h27-7-633" id="h27-7-633" class="i">+        // When t2 is rolled back, none of its writes will be visible, and t1
</a><a href="#h27-7-634" id="h27-7-634" class="i">+        // and t3 can perform their writes and successfully commit.
</a>         t2.rollback()?;
<a href="#h27-7-636" id="h27-7-636" class="d">-        assert_eq!(Some(vec![0x00]), t1.get(b&quot;key&quot;)?);
</a><a href="#h27-7-637" id="h27-7-637" class="i">+
</a><a href="#h27-7-638" id="h27-7-638" class="i">+        let t4 = mvcc.begin_read_only()?;
</a><a href="#h27-7-639" id="h27-7-639" class="i">+        assert_scan!(t4.scan(..)? =&gt; {
</a><a href="#h27-7-640" id="h27-7-640" class="i">+            b&quot;a&quot; =&gt; [0],
</a><a href="#h27-7-641" id="h27-7-641" class="i">+            b&quot;b&quot; =&gt; [0],
</a><a href="#h27-7-642" id="h27-7-642" class="i">+            b&quot;c&quot; =&gt; [0],
</a><a href="#h27-7-643" id="h27-7-643" class="i">+            b&quot;d&quot; =&gt; [0],
</a><a href="#h27-7-644" id="h27-7-644" class="i">+        });
</a><a href="#h27-7-645" id="h27-7-645" class="i">+
</a><a href="#h27-7-646" id="h27-7-646" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h27-7-647" id="h27-7-647" class="i">+        t3.set(b&quot;c&quot;, vec![3])?;
</a>         t1.commit()?;
<a href="#h27-7-649" id="h27-7-649" class="d">-        t3.set(b&quot;key&quot;, vec![0x03])?;
</a>         t3.commit()?;
 
<a href="#h27-7-652" id="h27-7-652" class="i">+        let t5 = mvcc.begin_read_only()?;
</a><a href="#h27-7-653" id="h27-7-653" class="i">+        assert_scan!(t5.scan(..)? =&gt; {
</a><a href="#h27-7-654" id="h27-7-654" class="i">+            b&quot;a&quot; =&gt; [1],
</a><a href="#h27-7-655" id="h27-7-655" class="i">+            b&quot;b&quot; =&gt; [1],
</a><a href="#h27-7-656" id="h27-7-656" class="i">+            b&quot;c&quot; =&gt; [3],
</a><a href="#h27-7-657" id="h27-7-657" class="i">+            b&quot;d&quot; =&gt; [3],
</a><a href="#h27-7-658" id="h27-7-658" class="i">+        });
</a><a href="#h27-7-659" id="h27-7-659" class="i">+
</a>         Ok(())
     }
 
     #[test]
     // A dirty write is when t2 overwrites an uncommitted value written by t1.
<a href="#h27-7-665" id="h27-7-665" class="d">-    fn test_txn_anomaly_dirty_write() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-666" id="h27-7-666" class="d">-        let mvcc = setup();
</a><a href="#h27-7-667" id="h27-7-667" class="i">+    // Snapshot isolation prevents this.
</a><a href="#h27-7-668" id="h27-7-668" class="i">+    fn anomaly_dirty_write() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-669" id="h27-7-669" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_dirty_write&quot;)?;
</a> 
         let t1 = mvcc.begin()?;
<a href="#h27-7-672" id="h27-7-672" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-673" id="h27-7-673" class="i">+        t1.set(b&quot;key&quot;, vec![1])?;
</a> 
<a href="#h27-7-675" id="h27-7-675" class="d">-        t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h27-7-676" id="h27-7-676" class="d">-        assert_eq!(t2.set(b&quot;key&quot;, b&quot;t2&quot;.to_vec()), Err(Error::Serialization));
</a><a href="#h27-7-677" id="h27-7-677" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-678" id="h27-7-678" class="i">+        assert_eq!(t2.set(b&quot;key&quot;, vec![2]), Err(Error::Serialization));
</a> 
         Ok(())
     }
 
     #[test]
     // A dirty read is when t2 can read an uncommitted value set by t1.
<a href="#h27-7-685" id="h27-7-685" class="d">-    fn test_txn_anomaly_dirty_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-686" id="h27-7-686" class="d">-        let mvcc = setup();
</a><a href="#h27-7-687" id="h27-7-687" class="i">+    // Snapshot isolation prevents this.
</a><a href="#h27-7-688" id="h27-7-688" class="i">+    fn anomaly_dirty_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-689" id="h27-7-689" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_dirty_read&quot;)?;
</a> 
         let t1 = mvcc.begin()?;
<a href="#h27-7-692" id="h27-7-692" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h27-7-693" id="h27-7-693" class="i">+        t1.set(b&quot;key&quot;, vec![1])?;
</a> 
<a href="#h27-7-695" id="h27-7-695" class="d">-        t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h27-7-696" id="h27-7-696" class="d">-        assert_eq!(None, t2.get(b&quot;key&quot;)?);
</a><a href="#h27-7-697" id="h27-7-697" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h27-7-698" id="h27-7-698" class="i">+        assert_eq!(t2.get(b&quot;key&quot;)?, None);
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-7-704" id="h27-7-704" class="d">-    // A lost update is when t1 and t2 both read a value and update it, where t2&#39;s update replaces t1.
</a><a href="#h27-7-705" id="h27-7-705" class="d">-    fn test_txn_anomaly_lost_update() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-706" id="h27-7-706" class="d">-        let mvcc = setup();
</a><a href="#h27-7-707" id="h27-7-707" class="d">-
</a><a href="#h27-7-708" id="h27-7-708" class="d">-        let t0 = mvcc.begin()?;
</a><a href="#h27-7-709" id="h27-7-709" class="d">-        t0.set(b&quot;key&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h27-7-710" id="h27-7-710" class="d">-        t0.commit()?;
</a><a href="#h27-7-711" id="h27-7-711" class="i">+    // A lost update is when t1 and t2 both read a value and update it, where
</a><a href="#h27-7-712" id="h27-7-712" class="i">+    // t2&#39;s update replaces t1. Snapshot isolation prevents this.
</a><a href="#h27-7-713" id="h27-7-713" class="i">+    fn anomaly_lost_update() -&gt; Result&lt;()&gt; {
</a><a href="#h27-7-714" id="h27-7-714" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_lost_update&quot;)?;
</a><a href="#h27-7-715" id="h27-7-715" class="i">+        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[0]))])?;
</a> 
         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
<a href="#h27-8" id="h27-8" class="h">@@ -1349,131 +1781,138 @@ pub mod tests {
</a>         t1.get(b&quot;key&quot;)?;
         t2.get(b&quot;key&quot;)?;
 
<a href="#h27-8-3" id="h27-8-3" class="d">-        t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h27-8-4" id="h27-8-4" class="d">-        assert_eq!(t2.set(b&quot;key&quot;, b&quot;t2&quot;.to_vec()), Err(Error::Serialization));
</a><a href="#h27-8-5" id="h27-8-5" class="i">+        t1.set(b&quot;key&quot;, vec![1])?;
</a><a href="#h27-8-6" id="h27-8-6" class="i">+        assert_eq!(t2.set(b&quot;key&quot;, vec![2]), Err(Error::Serialization));
</a><a href="#h27-8-7" id="h27-8-7" class="i">+        t1.commit()?;
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-8-13" id="h27-8-13" class="d">-    // A fuzzy (or unrepeatable) read is when t2 sees a value change after t1 updates it.
</a><a href="#h27-8-14" id="h27-8-14" class="d">-    fn test_txn_anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-15" id="h27-8-15" class="d">-        let mvcc = setup();
</a><a href="#h27-8-16" id="h27-8-16" class="d">-
</a><a href="#h27-8-17" id="h27-8-17" class="d">-        let t0 = mvcc.begin()?;
</a><a href="#h27-8-18" id="h27-8-18" class="d">-        t0.set(b&quot;key&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h27-8-19" id="h27-8-19" class="d">-        t0.commit()?;
</a><a href="#h27-8-20" id="h27-8-20" class="i">+    // A fuzzy (or unrepeatable) read is when t2 sees a value change after t1
</a><a href="#h27-8-21" id="h27-8-21" class="i">+    // updates it. Snapshot isolation prevents this.
</a><a href="#h27-8-22" id="h27-8-22" class="i">+    fn anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-23" id="h27-8-23" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_fuzzy_read&quot;)?;
</a><a href="#h27-8-24" id="h27-8-24" class="i">+        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[0]))])?;
</a> 
         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
 
<a href="#h27-8-29" id="h27-8-29" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t2.get(b&quot;key&quot;)?);
</a><a href="#h27-8-30" id="h27-8-30" class="i">+        assert_eq!(t2.get(b&quot;key&quot;)?, Some(vec![0]));
</a>         t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
         t1.commit()?;
<a href="#h27-8-33" id="h27-8-33" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t2.get(b&quot;key&quot;)?);
</a><a href="#h27-8-34" id="h27-8-34" class="i">+        assert_eq!(t2.get(b&quot;key&quot;)?, Some(vec![0]));
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-8-40" id="h27-8-40" class="d">-    // Read skew is when t1 reads a and b, but t2 modifies b in between the reads.
</a><a href="#h27-8-41" id="h27-8-41" class="d">-    fn test_txn_anomaly_read_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-42" id="h27-8-42" class="d">-        let mvcc = setup();
</a><a href="#h27-8-43" id="h27-8-43" class="d">-
</a><a href="#h27-8-44" id="h27-8-44" class="d">-        let t0 = mvcc.begin()?;
</a><a href="#h27-8-45" id="h27-8-45" class="d">-        t0.set(b&quot;a&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h27-8-46" id="h27-8-46" class="d">-        t0.set(b&quot;b&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h27-8-47" id="h27-8-47" class="d">-        t0.commit()?;
</a><a href="#h27-8-48" id="h27-8-48" class="i">+    // Read skew is when t1 reads a and b, but t2 modifies b in between the
</a><a href="#h27-8-49" id="h27-8-49" class="i">+    // reads. Snapshot isolation prevents this.
</a><a href="#h27-8-50" id="h27-8-50" class="i">+    fn anomaly_read_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-51" id="h27-8-51" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_read_skew&quot;)?;
</a><a href="#h27-8-52" id="h27-8-52" class="i">+        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[0])), (b&quot;b&quot;, 1, Some(&amp;[0]))])?;
</a> 
         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
 
<a href="#h27-8-57" id="h27-8-57" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
</a><a href="#h27-8-58" id="h27-8-58" class="d">-        t2.set(b&quot;a&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h27-8-59" id="h27-8-59" class="d">-        t2.set(b&quot;b&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h27-8-60" id="h27-8-60" class="i">+        assert_eq!(t1.get(b&quot;a&quot;)?, Some(vec![0]));
</a><a href="#h27-8-61" id="h27-8-61" class="i">+        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h27-8-62" id="h27-8-62" class="i">+        t2.set(b&quot;b&quot;, vec![2])?;
</a>         t2.commit()?;
<a href="#h27-8-64" id="h27-8-64" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t1.get(b&quot;b&quot;)?);
</a><a href="#h27-8-65" id="h27-8-65" class="i">+        assert_eq!(t1.get(b&quot;a&quot;)?, Some(vec![0]));
</a> 
         Ok(())
     }
 
     #[test]
<a href="#h27-8-71" id="h27-8-71" class="d">-    // A phantom read is when t1 reads entries matching some predicate, but a modification by
</a><a href="#h27-8-72" id="h27-8-72" class="d">-    // t2 changes the entries that match the predicate such that a later read by t1 returns them.
</a><a href="#h27-8-73" id="h27-8-73" class="d">-    fn test_txn_anomaly_phantom_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-74" id="h27-8-74" class="d">-        let mvcc = setup();
</a><a href="#h27-8-75" id="h27-8-75" class="d">-
</a><a href="#h27-8-76" id="h27-8-76" class="d">-        let t0 = mvcc.begin()?;
</a><a href="#h27-8-77" id="h27-8-77" class="d">-        t0.set(b&quot;a&quot;, b&quot;true&quot;.to_vec())?;
</a><a href="#h27-8-78" id="h27-8-78" class="d">-        t0.set(b&quot;b&quot;, b&quot;false&quot;.to_vec())?;
</a><a href="#h27-8-79" id="h27-8-79" class="d">-        t0.commit()?;
</a><a href="#h27-8-80" id="h27-8-80" class="i">+    // A phantom read is when t1 reads entries matching some predicate, but a
</a><a href="#h27-8-81" id="h27-8-81" class="i">+    // modification by t2 changes which entries that match the predicate such
</a><a href="#h27-8-82" id="h27-8-82" class="i">+    // that a later read by t1 returns them. Snapshot isolation prevents this.
</a><a href="#h27-8-83" id="h27-8-83" class="i">+    //
</a><a href="#h27-8-84" id="h27-8-84" class="i">+    // We use a prefix scan as our predicate.
</a><a href="#h27-8-85" id="h27-8-85" class="i">+    fn anomaly_phantom_read() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-86" id="h27-8-86" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_phantom_read&quot;)?;
</a><a href="#h27-8-87" id="h27-8-87" class="i">+        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[0])), (b&quot;ba&quot;, 1, Some(&amp;[0])), (b&quot;bb&quot;, 1, Some(&amp;[0]))])?;
</a> 
         let t1 = mvcc.begin()?;
         let t2 = mvcc.begin()?;
 
<a href="#h27-8-92" id="h27-8-92" class="d">-        assert_eq!(Some(b&quot;true&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
</a><a href="#h27-8-93" id="h27-8-93" class="d">-        assert_eq!(Some(b&quot;false&quot;.to_vec()), t1.get(b&quot;b&quot;)?);
</a><a href="#h27-8-94" id="h27-8-94" class="i">+        assert_scan!(t1.scan_prefix(b&quot;b&quot;)? =&gt; {
</a><a href="#h27-8-95" id="h27-8-95" class="i">+            b&quot;ba&quot; =&gt; [0],
</a><a href="#h27-8-96" id="h27-8-96" class="i">+            b&quot;bb&quot; =&gt; [0],
</a><a href="#h27-8-97" id="h27-8-97" class="i">+        });
</a> 
<a href="#h27-8-99" id="h27-8-99" class="d">-        t2.set(b&quot;b&quot;, b&quot;true&quot;.to_vec())?;
</a><a href="#h27-8-100" id="h27-8-100" class="i">+        t2.delete(b&quot;ba&quot;)?;
</a><a href="#h27-8-101" id="h27-8-101" class="i">+        t2.set(b&quot;bc&quot;, vec![2])?;
</a>         t2.commit()?;
 
<a href="#h27-8-104" id="h27-8-104" class="d">-        assert_eq!(Some(b&quot;true&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
</a><a href="#h27-8-105" id="h27-8-105" class="d">-        assert_eq!(Some(b&quot;false&quot;.to_vec()), t1.get(b&quot;b&quot;)?);
</a><a href="#h27-8-106" id="h27-8-106" class="i">+        assert_scan!(t1.scan_prefix(b&quot;b&quot;)? =&gt; {
</a><a href="#h27-8-107" id="h27-8-107" class="i">+            b&quot;ba&quot; =&gt; [0],
</a><a href="#h27-8-108" id="h27-8-108" class="i">+            b&quot;bb&quot; =&gt; [0],
</a><a href="#h27-8-109" id="h27-8-109" class="i">+        });
</a> 
         Ok(())
     }
 
<a href="#h27-8-114" id="h27-8-114" class="d">-    /* FIXME To avoid write skew we need to implement serializable snapshot isolation.
</a>     #[test]
<a href="#h27-8-116" id="h27-8-116" class="d">-    // Write skew is when t1 reads b and writes it to a while t2 reads a and writes it to b.¨
</a><a href="#h27-8-117" id="h27-8-117" class="d">-    fn test_txn_anomaly_write_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-118" id="h27-8-118" class="d">-        let mvcc = setup();
</a><a href="#h27-8-119" id="h27-8-119" class="d">-
</a><a href="#h27-8-120" id="h27-8-120" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h27-8-121" id="h27-8-121" class="d">-        t0.set(b&quot;a&quot;, b&quot;1&quot;.to_vec())?;
</a><a href="#h27-8-122" id="h27-8-122" class="d">-        t0.set(b&quot;b&quot;, b&quot;2&quot;.to_vec())?;
</a><a href="#h27-8-123" id="h27-8-123" class="d">-        t0.commit()?;
</a><a href="#h27-8-124" id="h27-8-124" class="i">+    // Write skew is when t1 reads a and writes it to b while t2 reads b and
</a><a href="#h27-8-125" id="h27-8-125" class="i">+    // writes it to a. Snapshot isolation DOES NOT prevent this, which is
</a><a href="#h27-8-126" id="h27-8-126" class="i">+    // expected, so we assert the current behavior. Fixing this requires
</a><a href="#h27-8-127" id="h27-8-127" class="i">+    // implementing serializable snapshot isolation.
</a><a href="#h27-8-128" id="h27-8-128" class="i">+    fn anomaly_write_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-129" id="h27-8-129" class="i">+        let mut mvcc = Schedule::new(&quot;anomaly_write_skew&quot;)?;
</a><a href="#h27-8-130" id="h27-8-130" class="i">+        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[1])), (b&quot;b&quot;, 1, Some(&amp;[2]))])?;
</a> 
<a href="#h27-8-132" id="h27-8-132" class="d">-        let mut t1 = mvcc.begin()?;
</a><a href="#h27-8-133" id="h27-8-133" class="d">-        let mut t2 = mvcc.begin()?;
</a><a href="#h27-8-134" id="h27-8-134" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-8-135" id="h27-8-135" class="i">+        let t2 = mvcc.begin()?;
</a> 
<a href="#h27-8-137" id="h27-8-137" class="d">-        assert_eq!(Some(b&quot;1&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
</a><a href="#h27-8-138" id="h27-8-138" class="d">-        assert_eq!(Some(b&quot;2&quot;.to_vec()), t2.get(b&quot;b&quot;)?);
</a><a href="#h27-8-139" id="h27-8-139" class="i">+        assert_eq!(t1.get(b&quot;a&quot;)?, Some(vec![1]));
</a><a href="#h27-8-140" id="h27-8-140" class="i">+        assert_eq!(t2.get(b&quot;b&quot;)?, Some(vec![2]));
</a> 
<a href="#h27-8-142" id="h27-8-142" class="d">-        // Some of the following operations should error
</a><a href="#h27-8-143" id="h27-8-143" class="d">-        t1.set(b&quot;a&quot;, b&quot;2&quot;.to_vec())?;
</a><a href="#h27-8-144" id="h27-8-144" class="d">-        t2.set(b&quot;b&quot;, b&quot;1&quot;.to_vec())?;
</a><a href="#h27-8-145" id="h27-8-145" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h27-8-146" id="h27-8-146" class="i">+        t2.set(b&quot;a&quot;, vec![2])?;
</a> 
         t1.commit()?;
         t2.commit()?;
 
         Ok(())
<a href="#h27-8-152" id="h27-8-152" class="d">-    }*/
</a><a href="#h27-8-153" id="h27-8-153" class="i">+    }
</a> 
     #[test]
     /// Tests unversioned key/value pairs, via set/get_unversioned().
<a href="#h27-8-157" id="h27-8-157" class="d">-    fn test_unversioned() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-158" id="h27-8-158" class="d">-        let m = setup();
</a><a href="#h27-8-159" id="h27-8-159" class="d">-
</a><a href="#h27-8-160" id="h27-8-160" class="d">-        // Unversioned keys should not interact with versioned keys.
</a><a href="#h27-8-161" id="h27-8-161" class="d">-        let txn = m.begin()?;
</a><a href="#h27-8-162" id="h27-8-162" class="d">-        txn.set(b&quot;foo&quot;, b&quot;bar&quot;.to_vec())?;
</a><a href="#h27-8-163" id="h27-8-163" class="d">-        txn.commit()?;
</a><a href="#h27-8-164" id="h27-8-164" class="i">+    fn unversioned() -&gt; Result&lt;()&gt; {
</a><a href="#h27-8-165" id="h27-8-165" class="i">+        let mut mvcc = Schedule::new(&quot;unversioned&quot;)?;
</a> 
<a href="#h27-8-167" id="h27-8-167" class="d">-        // The unversioned key should return None.
</a><a href="#h27-8-168" id="h27-8-168" class="d">-        assert_eq!(m.get_unversioned(b&quot;foo&quot;)?, None);
</a><a href="#h27-8-169" id="h27-8-169" class="i">+        // Interleave versioned and unversioned writes.
</a><a href="#h27-8-170" id="h27-8-170" class="i">+        mvcc.set_unversioned(b&quot;a&quot;, vec![0])?;
</a> 
<a href="#h27-8-172" id="h27-8-172" class="d">-        // Setting and then fetching the unversioned key should return its value.
</a><a href="#h27-8-173" id="h27-8-173" class="d">-        m.set_unversioned(b&quot;foo&quot;, b&quot;bar&quot;.to_vec())?;
</a><a href="#h27-8-174" id="h27-8-174" class="d">-        assert_eq!(m.get_unversioned(b&quot;foo&quot;)?, Some(b&quot;bar&quot;.to_vec()));
</a><a href="#h27-8-175" id="h27-8-175" class="d">-
</a><a href="#h27-8-176" id="h27-8-176" class="d">-        // Replacing it should return the new value.
</a><a href="#h27-8-177" id="h27-8-177" class="d">-        m.set_unversioned(b&quot;foo&quot;, b&quot;baz&quot;.to_vec())?;
</a><a href="#h27-8-178" id="h27-8-178" class="d">-        assert_eq!(m.get_unversioned(b&quot;foo&quot;)?, Some(b&quot;baz&quot;.to_vec()));
</a><a href="#h27-8-179" id="h27-8-179" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h27-8-180" id="h27-8-180" class="i">+        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-8-181" id="h27-8-181" class="i">+        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h27-8-182" id="h27-8-182" class="i">+        t1.set(b&quot;c&quot;, vec![1])?;
</a><a href="#h27-8-183" id="h27-8-183" class="i">+        t1.commit()?;
</a> 
<a href="#h27-8-185" id="h27-8-185" class="d">-        // The versioned key should remain unaffected.
</a><a href="#h27-8-186" id="h27-8-186" class="d">-        let txn = m.begin_read_only()?;
</a><a href="#h27-8-187" id="h27-8-187" class="d">-        assert_eq!(txn.get(b&quot;foo&quot;)?, Some(b&quot;bar&quot;.to_vec()));
</a><a href="#h27-8-188" id="h27-8-188" class="i">+        mvcc.set_unversioned(b&quot;b&quot;, vec![0])?;
</a><a href="#h27-8-189" id="h27-8-189" class="i">+        mvcc.set_unversioned(b&quot;d&quot;, vec![0])?;
</a><a href="#h27-8-190" id="h27-8-190" class="i">+
</a><a href="#h27-8-191" id="h27-8-191" class="i">+        // Scans should not see the unversioned writes.
</a><a href="#h27-8-192" id="h27-8-192" class="i">+        let t2 = mvcc.begin_read_only()?;
</a><a href="#h27-8-193" id="h27-8-193" class="i">+        assert_scan!(t2.scan(..)? =&gt; {
</a><a href="#h27-8-194" id="h27-8-194" class="i">+            b&quot;a&quot; =&gt; [1],
</a><a href="#h27-8-195" id="h27-8-195" class="i">+            b&quot;b&quot; =&gt; [1],
</a><a href="#h27-8-196" id="h27-8-196" class="i">+            b&quot;c&quot; =&gt; [1],
</a><a href="#h27-8-197" id="h27-8-197" class="i">+        });
</a><a href="#h27-8-198" id="h27-8-198" class="i">+
</a><a href="#h27-8-199" id="h27-8-199" class="i">+        // Unversioned gets should not see MVCC writes.
</a><a href="#h27-8-200" id="h27-8-200" class="i">+        assert_eq!(mvcc.get_unversioned(b&quot;a&quot;)?, Some(vec![0]));
</a><a href="#h27-8-201" id="h27-8-201" class="i">+        assert_eq!(mvcc.get_unversioned(b&quot;b&quot;)?, Some(vec![0]));
</a><a href="#h27-8-202" id="h27-8-202" class="i">+        assert_eq!(mvcc.get_unversioned(b&quot;c&quot;)?, None);
</a><a href="#h27-8-203" id="h27-8-203" class="i">+        assert_eq!(mvcc.get_unversioned(b&quot;d&quot;)?, Some(vec![0]));
</a><a href="#h27-8-204" id="h27-8-204" class="i">+
</a><a href="#h27-8-205" id="h27-8-205" class="i">+        // Replacing an unversioned key should be fine.
</a><a href="#h27-8-206" id="h27-8-206" class="i">+        mvcc.set_unversioned(b&quot;a&quot;, vec![1])?;
</a><a href="#h27-8-207" id="h27-8-207" class="i">+        assert_eq!(mvcc.get_unversioned(b&quot;a&quot;)?, Some(vec![1]));
</a> 
         Ok(())
     }
</pre>
</div>
</body>
</html>
