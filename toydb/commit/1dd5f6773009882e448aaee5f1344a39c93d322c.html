<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>bank: support multiple hosts - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/1dd5f6773009882e448aaee5f1344a39c93d322c.html">1dd5f6773009882e448aaee5f1344a39c93d322c</a>
<b>parent</b> <a href="../commit/e09b7b0f39e50dc0e5e8d80b3d39e1c4f574850b.html">e09b7b0f39e50dc0e5e8d80b3d39e1c4f574850b</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 12 Apr 2020 12:15:49 +0200

bank: support multiple hosts

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/bank.rs</a></td><td> | </td><td class="num">104</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
</table></pre><pre>1 file changed, 67 insertions(+), 37 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/bank.rs.html">src/bin/bank.rs</a> b/<a href="../file/src/bin/bank.rs.html">src/bin/bank.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -14,6 +14,7 @@ extern crate toydb;
</a> 
 use rand::distributions::Distribution;
 use rand::prelude::*;
<a href="#h0-0-3" id="h0-0-3" class="i">+use toydb::client::Client;
</a> use toydb::sql::execution::ResultSet;
 use toydb::sql::types::Value;
 use toydb::Error;
<a href="#h0-1" id="h0-1" class="h">@@ -26,19 +27,12 @@ fn main() -&gt; Result&lt;(), Error&gt; {
</a>             clap::Arg::with_name(&quot;host&quot;)
                 .short(&quot;h&quot;)
                 .long(&quot;host&quot;)
<a href="#h0-1-3" id="h0-1-3" class="d">-                .help(&quot;Host to connect to&quot;)
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                .help(&quot;Host to connect to, optionally with port number&quot;)
</a>                 .takes_value(true)
<a href="#h0-1-6" id="h0-1-6" class="i">+                .number_of_values(1)
</a><a href="#h0-1-7" id="h0-1-7" class="i">+                .multiple(true)
</a>                 .required(true)
<a href="#h0-1-9" id="h0-1-9" class="d">-                .default_value(&quot;127.0.0.1&quot;),
</a><a href="#h0-1-10" id="h0-1-10" class="d">-        )
</a><a href="#h0-1-11" id="h0-1-11" class="d">-        .arg(
</a><a href="#h0-1-12" id="h0-1-12" class="d">-            clap::Arg::with_name(&quot;port&quot;)
</a><a href="#h0-1-13" id="h0-1-13" class="d">-                .short(&quot;p&quot;)
</a><a href="#h0-1-14" id="h0-1-14" class="d">-                .long(&quot;port&quot;)
</a><a href="#h0-1-15" id="h0-1-15" class="d">-                .help(&quot;Port number to connect to&quot;)
</a><a href="#h0-1-16" id="h0-1-16" class="d">-                .takes_value(true)
</a><a href="#h0-1-17" id="h0-1-17" class="d">-                .required(true)
</a><a href="#h0-1-18" id="h0-1-18" class="d">-                .default_value(&quot;9605&quot;),
</a><a href="#h0-1-19" id="h0-1-19" class="i">+                .default_value(&quot;127.0.0.1:9605&quot;),
</a>         )
         .arg(
             clap::Arg::with_name(&quot;concurrency&quot;)
<a href="#h0-2" id="h0-2" class="h">@@ -50,6 +44,24 @@ fn main() -&gt; Result&lt;(), Error&gt; {
</a>                 .default_value(&quot;4&quot;),
         )
         .arg(
<a href="#h0-2-3" id="h0-2-3" class="i">+            clap::Arg::with_name(&quot;customers&quot;)
</a><a href="#h0-2-4" id="h0-2-4" class="i">+                .short(&quot;C&quot;)
</a><a href="#h0-2-5" id="h0-2-5" class="i">+                .long(&quot;customers&quot;)
</a><a href="#h0-2-6" id="h0-2-6" class="i">+                .help(&quot;Number of customers to create&quot;)
</a><a href="#h0-2-7" id="h0-2-7" class="i">+                .takes_value(true)
</a><a href="#h0-2-8" id="h0-2-8" class="i">+                .required(true)
</a><a href="#h0-2-9" id="h0-2-9" class="i">+                .default_value(&quot;10&quot;),
</a><a href="#h0-2-10" id="h0-2-10" class="i">+        )
</a><a href="#h0-2-11" id="h0-2-11" class="i">+        .arg(
</a><a href="#h0-2-12" id="h0-2-12" class="i">+            clap::Arg::with_name(&quot;accounts&quot;)
</a><a href="#h0-2-13" id="h0-2-13" class="i">+                .short(&quot;a&quot;)
</a><a href="#h0-2-14" id="h0-2-14" class="i">+                .long(&quot;accounts&quot;)
</a><a href="#h0-2-15" id="h0-2-15" class="i">+                .help(&quot;Number of accounts to create per customer&quot;)
</a><a href="#h0-2-16" id="h0-2-16" class="i">+                .takes_value(true)
</a><a href="#h0-2-17" id="h0-2-17" class="i">+                .required(true)
</a><a href="#h0-2-18" id="h0-2-18" class="i">+                .default_value(&quot;10&quot;),
</a><a href="#h0-2-19" id="h0-2-19" class="i">+        )
</a><a href="#h0-2-20" id="h0-2-20" class="i">+        .arg(
</a>             clap::Arg::with_name(&quot;transactions&quot;)
                 .short(&quot;t&quot;)
                 .long(&quot;transactions&quot;)
<a href="#h0-3" id="h0-3" class="h">@@ -60,15 +72,19 @@ fn main() -&gt; Result&lt;(), Error&gt; {
</a>         )
         .get_matches();
 
<a href="#h0-3-3" id="h0-3-3" class="d">-    Bank::new(opts.value_of(&quot;host&quot;).unwrap(), opts.value_of(&quot;port&quot;).unwrap().parse()?)?.run(
</a><a href="#h0-3-4" id="h0-3-4" class="i">+    Bank::new(
</a><a href="#h0-3-5" id="h0-3-5" class="i">+        opts.values_of(&quot;host&quot;).unwrap().map(String::from).collect(),
</a><a href="#h0-3-6" id="h0-3-6" class="i">+        opts.value_of(&quot;customers&quot;).unwrap().parse()?,
</a><a href="#h0-3-7" id="h0-3-7" class="i">+        opts.value_of(&quot;accounts&quot;).unwrap().parse()?,
</a><a href="#h0-3-8" id="h0-3-8" class="i">+    )?
</a><a href="#h0-3-9" id="h0-3-9" class="i">+    .run(
</a>         opts.value_of(&quot;concurrency&quot;).unwrap().parse()?,
         opts.value_of(&quot;transactions&quot;).unwrap().parse()?,
     )
 }
 
 struct Bank {
<a href="#h0-3-16" id="h0-3-16" class="d">-    host: String,
</a><a href="#h0-3-17" id="h0-3-17" class="d">-    port: u16,
</a><a href="#h0-3-18" id="h0-3-18" class="i">+    hosts: Vec&lt;(String, u16)&gt;,
</a>     customers: i64,
     customer_accounts: i64,
     initial_balance: i64,
<a href="#h0-4" id="h0-4" class="h">@@ -76,25 +92,35 @@ struct Bank {
</a> 
 impl Bank {
     // Creates a new bank simulation
<a href="#h0-4-3" id="h0-4-3" class="d">-    fn new(host: &amp;str, port: u16) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h0-4-4" id="h0-4-4" class="d">-        Ok(Self {
</a><a href="#h0-4-5" id="h0-4-5" class="d">-            host: host.to_string(),
</a><a href="#h0-4-6" id="h0-4-6" class="d">-            port,
</a><a href="#h0-4-7" id="h0-4-7" class="d">-            customers: 10,
</a><a href="#h0-4-8" id="h0-4-8" class="d">-            customer_accounts: 10,
</a><a href="#h0-4-9" id="h0-4-9" class="d">-            initial_balance: 100,
</a><a href="#h0-4-10" id="h0-4-10" class="d">-        })
</a><a href="#h0-4-11" id="h0-4-11" class="d">-    }
</a><a href="#h0-4-12" id="h0-4-12" class="d">-
</a><a href="#h0-4-13" id="h0-4-13" class="d">-    // Creates a new client
</a><a href="#h0-4-14" id="h0-4-14" class="d">-    fn client(&amp;self) -&gt; Result&lt;toydb::Client, Error&gt; {
</a><a href="#h0-4-15" id="h0-4-15" class="d">-        toydb::Client::new(&amp;self.host, self.port)
</a><a href="#h0-4-16" id="h0-4-16" class="i">+    fn new(hosts: Vec&lt;String&gt;, customers: i64, accounts: i64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h0-4-17" id="h0-4-17" class="i">+        let mut h = Vec::new();
</a><a href="#h0-4-18" id="h0-4-18" class="i">+        for host in hosts {
</a><a href="#h0-4-19" id="h0-4-19" class="i">+            let parts: Vec&lt;&amp;str&gt; = host.split(&quot;:&quot;).collect();
</a><a href="#h0-4-20" id="h0-4-20" class="i">+            h.push((parts[0].to_string(), if parts.len() &gt;= 2 { parts[1].parse()? } else { 9605 }));
</a><a href="#h0-4-21" id="h0-4-21" class="i">+        }
</a><a href="#h0-4-22" id="h0-4-22" class="i">+        Ok(Self { hosts: h, customers, customer_accounts: accounts, initial_balance: 100 })
</a>     }
 
     // Runs the bank simulation
     fn run(&amp;self, concurrency: i64, transactions: i64) -&gt; Result&lt;(), Error&gt; {
<a href="#h0-4-27" id="h0-4-27" class="d">-        self.setup()?;
</a><a href="#h0-4-28" id="h0-4-28" class="d">-        self.check()?;
</a><a href="#h0-4-29" id="h0-4-29" class="i">+        println!(
</a><a href="#h0-4-30" id="h0-4-30" class="i">+            &quot;Using {} threads with {}&quot;,
</a><a href="#h0-4-31" id="h0-4-31" class="i">+            concurrency,
</a><a href="#h0-4-32" id="h0-4-32" class="i">+            self.hosts
</a><a href="#h0-4-33" id="h0-4-33" class="i">+                .iter()
</a><a href="#h0-4-34" id="h0-4-34" class="i">+                .map(|(h, p)| format!(&quot;{}:{}&quot;, h, p))
</a><a href="#h0-4-35" id="h0-4-35" class="i">+                .collect::&lt;Vec&lt;String&gt;&gt;()
</a><a href="#h0-4-36" id="h0-4-36" class="i">+                .join(&quot;,&quot;),
</a><a href="#h0-4-37" id="h0-4-37" class="i">+        );
</a><a href="#h0-4-38" id="h0-4-38" class="i">+
</a><a href="#h0-4-39" id="h0-4-39" class="i">+        let mut hosts = self.hosts.iter().cycle();
</a><a href="#h0-4-40" id="h0-4-40" class="i">+        let client = &amp;mut {
</a><a href="#h0-4-41" id="h0-4-41" class="i">+            let (host, port) = hosts.next().unwrap();
</a><a href="#h0-4-42" id="h0-4-42" class="i">+            Client::new(host, *port)?
</a><a href="#h0-4-43" id="h0-4-43" class="i">+        };
</a><a href="#h0-4-44" id="h0-4-44" class="i">+
</a><a href="#h0-4-45" id="h0-4-45" class="i">+        self.setup(client)?;
</a><a href="#h0-4-46" id="h0-4-46" class="i">+        self.check(client)?;
</a> 
         let start = std::time::Instant::now();
 
<a href="#h0-5" id="h0-5" class="h">@@ -117,7 +143,9 @@ impl Bank {
</a>             println!();
             for i in 0..concurrency {
                 let r = rx.clone();
<a href="#h0-5-3" id="h0-5-3" class="d">-                scope.spawn(move |_| self.process(i, r).unwrap());
</a><a href="#h0-5-4" id="h0-5-4" class="i">+                let (host, port) = hosts.next().unwrap();
</a><a href="#h0-5-5" id="h0-5-5" class="i">+                let mut client = Client::new(host, *port).unwrap();
</a><a href="#h0-5-6" id="h0-5-6" class="i">+                scope.spawn(move |_| self.process(&amp;mut client, i, r).unwrap());
</a>             }
         })
         .unwrap();
<a href="#h0-6" id="h0-6" class="h">@@ -131,14 +159,18 @@ impl Bank {
</a>             transactions as f64 / elapsed
         );
 
<a href="#h0-6-3" id="h0-6-3" class="d">-        self.check()?;
</a><a href="#h0-6-4" id="h0-6-4" class="i">+        self.check(client)?;
</a>         Ok(())
     }
 
     // Processes transactions for a customer
<a href="#h0-6-9" id="h0-6-9" class="d">-    fn process(&amp;self, tid: i64, rx: crossbeam::channel::Receiver&lt;(i64, i64)&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-6-10" id="h0-6-10" class="i">+    fn process(
</a><a href="#h0-6-11" id="h0-6-11" class="i">+        &amp;self,
</a><a href="#h0-6-12" id="h0-6-12" class="i">+        client: &amp;mut Client,
</a><a href="#h0-6-13" id="h0-6-13" class="i">+        tid: i64,
</a><a href="#h0-6-14" id="h0-6-14" class="i">+        rx: crossbeam::channel::Receiver&lt;(i64, i64)&gt;,
</a><a href="#h0-6-15" id="h0-6-15" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a>         let mut rng = rand::thread_rng();
<a href="#h0-6-17" id="h0-6-17" class="d">-        let mut client = self.client()?;
</a>         for (from, to) in rx {
             let mut amount = 0;
             let mut from_account = 0;
<a href="#h0-7" id="h0-7" class="h">@@ -206,10 +238,9 @@ impl Bank {
</a>     }
 
     // Sets up the database
<a href="#h0-7-3" id="h0-7-3" class="d">-    fn setup(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-7-4" id="h0-7-4" class="i">+    fn setup(&amp;self, client: &amp;mut Client) -&gt; Result&lt;(), Error&gt; {
</a>         let mut namegen = names::Generator::default(names::Name::Plain);
         let now = std::time::Instant::now();
<a href="#h0-7-7" id="h0-7-7" class="d">-        let mut client = self.client()?;
</a> 
         client.query(&quot;BEGIN&quot;)?;
         client.query(
<a href="#h0-8" id="h0-8" class="h">@@ -253,8 +284,7 @@ impl Bank {
</a>     }
 
     /// Checks that all invariants hold
<a href="#h0-8-3" id="h0-8-3" class="d">-    fn check(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-8-4" id="h0-8-4" class="d">-        let mut client = self.client()?;
</a><a href="#h0-8-5" id="h0-8-5" class="i">+    fn check(&amp;self, client: &amp;mut Client) -&gt; Result&lt;(), Error&gt; {
</a>         let expect_balance = self.customers * self.customer_accounts * self.initial_balance;
         let balance = get_integers(client.query(&quot;SELECT SUM(balance) FROM account&quot;)?)?[0];
         if balance != expect_balance {
</pre>
</div>
</body>
</html>
