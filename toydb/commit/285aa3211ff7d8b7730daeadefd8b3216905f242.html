<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: rename Raft message/envelope - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/285aa3211ff7d8b7730daeadefd8b3216905f242.html">285aa3211ff7d8b7730daeadefd8b3216905f242</a>
<b>parent</b> <a href="../commit/bafa8ad99fcadca8bbb7a1be8c2a7bab81365496.html">bafa8ad99fcadca8bbb7a1be8c2a7bab81365496</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 13 Apr 2024 10:54:16 +0200

raft: rename Raft message/envelope

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">78</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/follower.rs</a></td><td> | </td><td class="num">249</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/leader.rs</a></td><td> | </td><td class="num">137</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/node/mod.rs</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/server.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
</table></pre><pre>7 files changed, 280 insertions(+), 254 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -5,22 +5,22 @@ use crate::storage;
</a> use serde_derive::{Deserialize, Serialize};
 use std::collections::HashMap;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-/// A message passed between Raft nodes.
</a><a href="#h0-0-4" id="h0-0-4" class="i">+/// A message envelope sent between Raft nodes.
</a> #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
<a href="#h0-0-6" id="h0-0-6" class="d">-pub struct Message {
</a><a href="#h0-0-7" id="h0-0-7" class="d">-    /// The sender&#39;s current term.
</a><a href="#h0-0-8" id="h0-0-8" class="d">-    pub term: Term,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+pub struct Envelope {
</a>     /// The sender.
     pub from: NodeID,
     /// The recipient.
     pub to: NodeID,
<a href="#h0-0-14" id="h0-0-14" class="d">-    /// The message payload.
</a><a href="#h0-0-15" id="h0-0-15" class="d">-    pub event: Event,
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    /// The sender&#39;s current term.
</a><a href="#h0-0-17" id="h0-0-17" class="i">+    pub term: Term,
</a><a href="#h0-0-18" id="h0-0-18" class="i">+    /// The message.
</a><a href="#h0-0-19" id="h0-0-19" class="i">+    pub message: Message,
</a> }
 
<a href="#h0-0-22" id="h0-0-22" class="d">-/// An event contained within messages.
</a><a href="#h0-0-23" id="h0-0-23" class="i">+/// A message sent between Raft nodes.
</a> #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
<a href="#h0-0-25" id="h0-0-25" class="d">-pub enum Event {
</a><a href="#h0-0-26" id="h0-0-26" class="i">+pub enum Message {
</a>     /// Leaders send periodic heartbeats to its followers.
     Heartbeat {
         /// The index of the leader&#39;s last committed log entry.
<b>diff --git a/<a id="h1" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -4,7 +4,7 @@ mod node;
</a> mod state;
 
 pub use log::{Entry, Index, Log};
<a href="#h1-0-3" id="h1-0-3" class="d">-pub use message::{Event, Message, ReadSequence, Request, RequestID, Response, Status};
</a><a href="#h1-0-4" id="h1-0-4" class="i">+pub use message::{Envelope, Message, ReadSequence, Request, RequestID, Response, Status};
</a> pub use node::{Node, NodeID, Term, Ticks};
 pub use state::State;
 
<b>diff --git a/<a id="h2" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-use super::super::{Event, Message};
</a><a href="#h2-0-1" id="h2-0-1" class="i">+use super::super::{Envelope, Message};
</a> use super::{rand_election_timeout, Follower, Leader, Node, NodeID, RawNode, Role, Term, Ticks};
 use crate::error::{Error, Result};
 
<a href="#h2-1" id="h2-1" class="h">@@ -88,7 +88,7 @@ impl RawNode&lt;Candidate&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h2-1-3" id="h2-1-3" class="d">-    pub fn step(mut self, msg: Message) -&gt; Result&lt;Node&gt; {
</a><a href="#h2-1-4" id="h2-1-4" class="i">+    pub fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
</a>         self.assert()?;
         self.assert_step(&amp;msg);
 
<a href="#h2-2" id="h2-2" class="h">@@ -105,13 +105,13 @@ impl RawNode&lt;Candidate&gt; {
</a>             return self.into_follower(msg.term, None)?.step(msg);
         }
 
<a href="#h2-2-3" id="h2-2-3" class="d">-        match msg.event {
</a><a href="#h2-2-4" id="h2-2-4" class="i">+        match msg.message {
</a>             // Ignore other candidates when we&#39;re also campaigning.
<a href="#h2-2-6" id="h2-2-6" class="d">-            Event::SolicitVote { .. } =&gt; {}
</a><a href="#h2-2-7" id="h2-2-7" class="i">+            Message::SolicitVote { .. } =&gt; {}
</a> 
             // We received a vote. Record it, and if we have quorum, assume
             // leadership.
<a href="#h2-2-11" id="h2-2-11" class="d">-            Event::GrantVote =&gt; {
</a><a href="#h2-2-12" id="h2-2-12" class="i">+            Message::GrantVote =&gt; {
</a>                 self.role.votes.insert(msg.from);
                 if self.role.votes.len() as u8 &gt;= self.quorum_size() {
                     return Ok(self.into_leader()?.into());
<a href="#h2-3" id="h2-3" class="h">@@ -120,21 +120,21 @@ impl RawNode&lt;Candidate&gt; {
</a> 
             // If we receive a heartbeat or entries in this term, we lost the
             // election and have a new leader. Follow it and step the message.
<a href="#h2-3-3" id="h2-3-3" class="d">-            Event::Heartbeat { .. } | Event::AppendEntries { .. } =&gt; {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+            Message::Heartbeat { .. } | Message::AppendEntries { .. } =&gt; {
</a>                 return self.into_follower(msg.term, Some(msg.from))?.step(msg);
             }
 
             // Abort any inbound client requests while candidate.
<a href="#h2-3-9" id="h2-3-9" class="d">-            Event::ClientRequest { id, .. } =&gt; {
</a><a href="#h2-3-10" id="h2-3-10" class="d">-                self.send(msg.from, Event::ClientResponse { id, response: Err(Error::Abort) })?;
</a><a href="#h2-3-11" id="h2-3-11" class="i">+            Message::ClientRequest { id, .. } =&gt; {
</a><a href="#h2-3-12" id="h2-3-12" class="i">+                self.send(msg.from, Message::ClientResponse { id, response: Err(Error::Abort) })?;
</a>             }
 
             // We&#39;re not a leader in this term, nor are we forwarding requests,
             // so we shouldn&#39;t see these.
<a href="#h2-3-17" id="h2-3-17" class="d">-            Event::ConfirmLeader { .. }
</a><a href="#h2-3-18" id="h2-3-18" class="d">-            | Event::AcceptEntries { .. }
</a><a href="#h2-3-19" id="h2-3-19" class="d">-            | Event::RejectEntries { .. }
</a><a href="#h2-3-20" id="h2-3-20" class="d">-            | Event::ClientResponse { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a><a href="#h2-3-21" id="h2-3-21" class="i">+            Message::ConfirmLeader { .. }
</a><a href="#h2-3-22" id="h2-3-22" class="i">+            | Message::AcceptEntries { .. }
</a><a href="#h2-3-23" id="h2-3-23" class="i">+            | Message::RejectEntries { .. }
</a><a href="#h2-3-24" id="h2-3-24" class="i">+            | Message::ClientResponse { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a>         }
         Ok(self.into())
     }
<a href="#h2-4" id="h2-4" class="h">@@ -161,7 +161,7 @@ impl RawNode&lt;Candidate&gt; {
</a>         self.log.set_term(term, Some(self.id))?;
 
         let (last_index, last_term) = self.log.get_last_index();
<a href="#h2-4-3" id="h2-4-3" class="d">-        self.broadcast(Event::SolicitVote { last_index, last_term })?;
</a><a href="#h2-4-4" id="h2-4-4" class="i">+        self.broadcast(Message::SolicitVote { last_index, last_term })?;
</a>         Ok(())
     }
 }
<a href="#h2-5" id="h2-5" class="h">@@ -176,7 +176,7 @@ mod tests {
</a>     use itertools::Itertools as _;
 
     #[allow(clippy::type_complexity)]
<a href="#h2-5-3" id="h2-5-3" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Candidate&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
</a><a href="#h2-5-4" id="h2-5-4" class="i">+    fn setup() -&gt; Result&lt;(RawNode&lt;Candidate&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a>         let (node_tx, node_rx) = crossbeam::channel::unbounded();
         let state = Box::new(TestState::new(0));
         let mut log = Log::new(storage::Memory::new(), false)?;
<a href="#h2-6" id="h2-6" class="h">@@ -204,44 +204,43 @@ mod tests {
</a>     // Heartbeat for current term converts to follower and emits ConfirmLeader.
     fn step_heartbeat_current_term() -&gt; Result&lt;()&gt; {
         let (candidate, mut node_rx) = setup()?;
<a href="#h2-6-3" id="h2-6-3" class="d">-        let mut node = candidate.step(Message {
</a><a href="#h2-6-4" id="h2-6-4" class="i">+        let mut node = candidate.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-6-8" id="h2-6-8" class="d">-            event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h2-6-9" id="h2-6-9" class="i">+            message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3);
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-6-14" id="h2-6-14" class="d">-            vec![Message {
</a><a href="#h2-6-15" id="h2-6-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-6-19" id="h2-6-19" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-6-20" id="h2-6-20" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
     }
 
     #[test]
<a href="#h2-6-27" id="h2-6-27" class="d">-    // Heartbeat for future term converts to follower and emits ConfirmLeader
</a><a href="#h2-6-28" id="h2-6-28" class="d">-    // event.
</a><a href="#h2-6-29" id="h2-6-29" class="i">+    // Heartbeat for future term converts to follower and emits ConfirmLeader.
</a>     fn step_heartbeat_future_term() -&gt; Result&lt;()&gt; {
         let (candidate, mut node_rx) = setup()?;
<a href="#h2-6-32" id="h2-6-32" class="d">-        let mut node = candidate.step(Message {
</a><a href="#h2-6-33" id="h2-6-33" class="i">+        let mut node = candidate.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 4,
<a href="#h2-6-37" id="h2-6-37" class="d">-            event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h2-6-38" id="h2-6-38" class="i">+            message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(4);
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-6-43" id="h2-6-43" class="d">-            vec![Message {
</a><a href="#h2-6-44" id="h2-6-44" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 4,
<a href="#h2-6-48" id="h2-6-48" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-6-49" id="h2-6-49" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-7" id="h2-7" class="h">@@ -251,11 +250,11 @@ mod tests {
</a>     // Heartbeat for past term is ignored
     fn step_heartbeat_past_term() -&gt; Result&lt;()&gt; {
         let (candidate, mut node_rx) = setup()?;
<a href="#h2-7-3" id="h2-7-3" class="d">-        let mut node = candidate.step(Message {
</a><a href="#h2-7-4" id="h2-7-4" class="i">+        let mut node = candidate.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 2,
<a href="#h2-7-8" id="h2-7-8" class="d">-            event: Event::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h2-7-9" id="h2-7-9" class="i">+            message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_candidate().term(3);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h2-8" id="h2-8" class="h">@@ -269,22 +268,22 @@ mod tests {
</a>         let mut node = Node::Candidate(candidate);
 
         // The first vote is not sufficient for a quorum (3 votes including self)
<a href="#h2-8-3" id="h2-8-3" class="d">-        node = node.step(Message { from: 3, to: 1, term: 3, event: Event::GrantVote })?;
</a><a href="#h2-8-4" id="h2-8-4" class="i">+        node = node.step(Envelope { from: 3, to: 1, term: 3, message: Message::GrantVote })?;
</a>         assert_node(&amp;mut node).is_candidate().term(3);
         assert_messages(&amp;mut node_rx, vec![]);
 
         // However, the second external vote makes us leader
<a href="#h2-8-9" id="h2-8-9" class="d">-        node = node.step(Message { from: 5, to: 1, term: 3, event: Event::GrantVote })?;
</a><a href="#h2-8-10" id="h2-8-10" class="i">+        node = node.step(Envelope { from: 5, to: 1, term: 3, message: Message::GrantVote })?;
</a>         assert_node(&amp;mut node).is_leader().term(3);
 
         for to in peers.iter().copied().sorted() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h2-8-16" id="h2-8-16" class="d">-                Message {
</a><a href="#h2-8-17" id="h2-8-17" class="i">+                Envelope {
</a>                     from: 1,
                     to,
                     term: 3,
<a href="#h2-8-21" id="h2-8-21" class="d">-                    event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h2-8-22" id="h2-8-22" class="i">+                    message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a>                 },
             );
         }
<a href="#h2-9" id="h2-9" class="h">@@ -292,11 +291,11 @@ mod tests {
</a>         for to in peers.iter().copied() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h2-9-3" id="h2-9-3" class="d">-                Message {
</a><a href="#h2-9-4" id="h2-9-4" class="i">+                Envelope {
</a>                     from: 1,
                     to,
                     term: 3,
<a href="#h2-9-8" id="h2-9-8" class="d">-                    event: Event::AppendEntries {
</a><a href="#h2-9-9" id="h2-9-9" class="i">+                    message: Message::AppendEntries {
</a>                         base_index: 3,
                         base_term: 2,
                         entries: vec![Entry { index: 4, term: 3, command: None }],
<a href="#h2-10" id="h2-10" class="h">@@ -315,20 +314,23 @@ mod tests {
</a>         let (candidate, mut node_rx) = setup()?;
         let mut node = Node::Candidate(candidate);
 
<a href="#h2-10-3" id="h2-10-3" class="d">-        node = node.step(Message {
</a><a href="#h2-10-4" id="h2-10-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h2-10-8" id="h2-10-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
</a><a href="#h2-10-9" id="h2-10-9" class="i">+            message: Message::ClientRequest {
</a><a href="#h2-10-10" id="h2-10-10" class="i">+                id: vec![0x01],
</a><a href="#h2-10-11" id="h2-10-11" class="i">+                request: Request::Mutate(vec![0xaf]),
</a><a href="#h2-10-12" id="h2-10-12" class="i">+            },
</a>         })?;
         assert_node(&amp;mut node).is_candidate().term(3);
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-10-17" id="h2-10-17" class="d">-            vec![Message {
</a><a href="#h2-10-18" id="h2-10-18" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 1,
                 term: 3,
<a href="#h2-10-22" id="h2-10-22" class="d">-                event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a><a href="#h2-10-23" id="h2-10-23" class="i">+                message: Message::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a>             }],
         );
         Ok(())
<a href="#h2-11" id="h2-11" class="h">@@ -351,11 +353,11 @@ mod tests {
</a>         for to in peers.iter().copied().sorted() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h2-11-3" id="h2-11-3" class="d">-                Message {
</a><a href="#h2-11-4" id="h2-11-4" class="i">+                Envelope {
</a>                     from: 1,
                     to,
                     term: 4,
<a href="#h2-11-8" id="h2-11-8" class="d">-                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-11-9" id="h2-11-9" class="i">+                    message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a>                 },
             );
         }
<b>diff --git a/<a id="h3" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::super::{Event, Log, Message, RequestID, State};
</a><a href="#h3-0-1" id="h3-0-1" class="i">+use super::super::{Envelope, Log, Message, RequestID, State};
</a> use super::{rand_election_timeout, Candidate, Node, NodeID, RawNode, Role, Term, Ticks};
 use crate::error::{Error, Result};
 
<a href="#h3-1" id="h3-1" class="h">@@ -43,7 +43,7 @@ impl RawNode&lt;Follower&gt; {
</a>         peers: HashSet&lt;NodeID&gt;,
         mut log: Log,
         state: Box&lt;dyn State&gt;,
<a href="#h3-1-3" id="h3-1-3" class="d">-        node_tx: crossbeam::channel::Sender&lt;Message&gt;,
</a><a href="#h3-1-4" id="h3-1-4" class="i">+        node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a>     ) -&gt; Result&lt;Self&gt; {
         let (term, voted_for) = log.get_term()?;
         let role = Follower::new(None, voted_for);
<a href="#h3-2" id="h3-2" class="h">@@ -118,7 +118,7 @@ impl RawNode&lt;Follower&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h3-2-3" id="h3-2-3" class="d">-    pub fn step(mut self, msg: Message) -&gt; Result&lt;Node&gt; {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    pub fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
</a>         self.assert()?;
         self.assert_step(&amp;msg);
 
<a href="#h3-3" id="h3-3" class="h">@@ -140,11 +140,11 @@ impl RawNode&lt;Follower&gt; {
</a>             self.role.leader_seen = 0
         }
 
<a href="#h3-3-3" id="h3-3-3" class="d">-        match msg.event {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+        match msg.message {
</a>             // The leader will send periodic heartbeats. If we don&#39;t have a
             // leader in this term yet, follow it. If the commit_index advances,
             // apply state transitions.
<a href="#h3-3-8" id="h3-3-8" class="d">-            Event::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
</a><a href="#h3-3-9" id="h3-3-9" class="i">+            Message::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
</a>                 // Check that the heartbeat is from our leader.
                 let from = msg.from;
                 match self.role.leader {
<a href="#h3-4" id="h3-4" class="h">@@ -156,7 +156,7 @@ impl RawNode&lt;Follower&gt; {
</a>                 //
                 // TODO: this should return the last index and term.
                 let has_committed = self.log.has(commit_index, commit_term)?;
<a href="#h3-4-3" id="h3-4-3" class="d">-                self.send(msg.from, Event::ConfirmLeader { has_committed, read_seq })?;
</a><a href="#h3-4-4" id="h3-4-4" class="i">+                self.send(msg.from, Message::ConfirmLeader { has_committed, read_seq })?;
</a> 
                 // Advance commit index and apply entries.
                 if has_committed &amp;&amp; commit_index &gt; self.log.get_commit_index().0 {
<a href="#h3-5" id="h3-5" class="h">@@ -167,7 +167,7 @@ impl RawNode&lt;Follower&gt; {
</a> 
             // Replicate entries from the leader. If we don&#39;t have a leader in
             // this term yet, follow it.
<a href="#h3-5-3" id="h3-5-3" class="d">-            Event::AppendEntries { base_index, base_term, entries } =&gt; {
</a><a href="#h3-5-4" id="h3-5-4" class="i">+            Message::AppendEntries { base_index, base_term, entries } =&gt; {
</a>                 // Check that the entries are from our leader.
                 let from = msg.from;
                 match self.role.leader {
<a href="#h3-6" id="h3-6" class="h">@@ -178,15 +178,15 @@ impl RawNode&lt;Follower&gt; {
</a>                 // Append the entries, if possible.
                 if base_index &gt; 0 &amp;&amp; !self.log.has(base_index, base_term)? {
                     debug!(&quot;Rejecting log entries at base {}&quot;, base_index);
<a href="#h3-6-3" id="h3-6-3" class="d">-                    self.send(msg.from, Event::RejectEntries)?
</a><a href="#h3-6-4" id="h3-6-4" class="i">+                    self.send(msg.from, Message::RejectEntries)?
</a>                 } else {
                     let last_index = self.log.splice(entries)?;
<a href="#h3-6-7" id="h3-6-7" class="d">-                    self.send(msg.from, Event::AcceptEntries { last_index })?
</a><a href="#h3-6-8" id="h3-6-8" class="i">+                    self.send(msg.from, Message::AcceptEntries { last_index })?
</a>                 }
             }
 
             // A candidate in this term is requesting our vote.
<a href="#h3-6-13" id="h3-6-13" class="d">-            Event::SolicitVote { last_index, last_term } =&gt; {
</a><a href="#h3-6-14" id="h3-6-14" class="i">+            Message::SolicitVote { last_index, last_term } =&gt; {
</a>                 let from = msg.from;
 
                 // If we already voted for someone else in this term, ignore it.
<a href="#h3-7" id="h3-7" class="h">@@ -201,7 +201,7 @@ impl RawNode&lt;Follower&gt; {
</a>                 let (log_index, log_term) = self.log.get_last_index();
                 if last_term &gt; log_term || last_term == log_term &amp;&amp; last_index &gt;= log_index {
                     info!(&quot;Voting for {} in term {} election&quot;, from, self.term);
<a href="#h3-7-3" id="h3-7-3" class="d">-                    self.send(from, Event::GrantVote)?;
</a><a href="#h3-7-4" id="h3-7-4" class="i">+                    self.send(from, Message::GrantVote)?;
</a>                     self.log.set_term(self.term, Some(from))?;
                     self.role.voted_for = Some(from);
                 }
<a href="#h3-8" id="h3-8" class="h">@@ -209,36 +209,39 @@ impl RawNode&lt;Follower&gt; {
</a> 
             // We may receive a vote after we lost an election and followed a
             // different leader. Ignore it.
<a href="#h3-8-3" id="h3-8-3" class="d">-            Event::GrantVote =&gt; {}
</a><a href="#h3-8-4" id="h3-8-4" class="i">+            Message::GrantVote =&gt; {}
</a> 
             // Forward client requests to the leader, or abort them if there is
             // none (the client must retry).
<a href="#h3-8-8" id="h3-8-8" class="d">-            Event::ClientRequest { ref id, .. } =&gt; {
</a><a href="#h3-8-9" id="h3-8-9" class="i">+            Message::ClientRequest { ref id, .. } =&gt; {
</a>                 assert_eq!(msg.from, self.id, &quot;Client request from other node&quot;);
 
                 let id = id.clone();
                 if let Some(leader) = self.role.leader {
                     debug!(&quot;Forwarding request to leader {}: {:?}&quot;, leader, msg);
                     self.role.forwarded.insert(id);
<a href="#h3-8-16" id="h3-8-16" class="d">-                    self.send(leader, msg.event)?
</a><a href="#h3-8-17" id="h3-8-17" class="i">+                    self.send(leader, msg.message)?
</a>                 } else {
<a href="#h3-8-19" id="h3-8-19" class="d">-                    self.send(msg.from, Event::ClientResponse { id, response: Err(Error::Abort) })?
</a><a href="#h3-8-20" id="h3-8-20" class="i">+                    self.send(
</a><a href="#h3-8-21" id="h3-8-21" class="i">+                        msg.from,
</a><a href="#h3-8-22" id="h3-8-22" class="i">+                        Message::ClientResponse { id, response: Err(Error::Abort) },
</a><a href="#h3-8-23" id="h3-8-23" class="i">+                    )?
</a>                 }
             }
 
             // Returns client responses for forwarded requests.
<a href="#h3-8-28" id="h3-8-28" class="d">-            Event::ClientResponse { id, response } =&gt; {
</a><a href="#h3-8-29" id="h3-8-29" class="i">+            Message::ClientResponse { id, response } =&gt; {
</a>                 assert!(self.is_leader(msg.from), &quot;Client response from non-leader&quot;);
 
                 if self.role.forwarded.remove(&amp;id) {
<a href="#h3-8-33" id="h3-8-33" class="d">-                    self.send(self.id, Event::ClientResponse { id, response })?;
</a><a href="#h3-8-34" id="h3-8-34" class="i">+                    self.send(self.id, Message::ClientResponse { id, response })?;
</a>                 }
             }
 
             // We&#39;re not a leader nor candidate in this term, so we shoudn&#39;t see these.
<a href="#h3-8-39" id="h3-8-39" class="d">-            Event::ConfirmLeader { .. }
</a><a href="#h3-8-40" id="h3-8-40" class="d">-            | Event::AcceptEntries { .. }
</a><a href="#h3-8-41" id="h3-8-41" class="d">-            | Event::RejectEntries { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a><a href="#h3-8-42" id="h3-8-42" class="i">+            Message::ConfirmLeader { .. }
</a><a href="#h3-8-43" id="h3-8-43" class="i">+            | Message::AcceptEntries { .. }
</a><a href="#h3-8-44" id="h3-8-44" class="i">+            | Message::RejectEntries { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a>         };
         Ok(self.into())
     }
<a href="#h3-9" id="h3-9" class="h">@@ -258,7 +261,7 @@ impl RawNode&lt;Follower&gt; {
</a>     fn abort_forwarded(&amp;mut self) -&gt; Result&lt;()&gt; {
         for id in std::mem::take(&amp;mut self.role.forwarded) {
             debug!(&quot;Aborting forwarded request {:x?}&quot;, id);
<a href="#h3-9-3" id="h3-9-3" class="d">-            self.send(self.id, Event::ClientResponse { id, response: Err(Error::Abort) })?;
</a><a href="#h3-9-4" id="h3-9-4" class="i">+            self.send(self.id, Message::ClientResponse { id, response: Err(Error::Abort) })?;
</a>         }
         Ok(())
     }
<a href="#h3-10" id="h3-10" class="h">@@ -280,7 +283,7 @@ pub mod tests {
</a>     use itertools::Itertools as _;
 
     #[allow(clippy::type_complexity)]
<a href="#h3-10-3" id="h3-10-3" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
</a><a href="#h3-10-4" id="h3-10-4" class="i">+    fn setup() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a>         let (node_tx, node_rx) = crossbeam::channel::unbounded();
         let state = Box::new(TestState::new(0));
         let mut log = Log::new(storage::Memory::new(), false)?;
<a href="#h3-11" id="h3-11" class="h">@@ -306,11 +309,11 @@ pub mod tests {
</a>     // Heartbeat from current leader should commit and apply
     fn step_heartbeat() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-11-3" id="h3-11-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-11-4" id="h3-11-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-11-8" id="h3-11-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h3-11-9" id="h3-11-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node)
             .is_follower()
<a href="#h3-12" id="h3-12" class="h">@@ -321,11 +324,11 @@ pub mod tests {
</a>             .applied(3);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-12-3" id="h3-12-3" class="d">-            vec![Message {
</a><a href="#h3-12-4" id="h3-12-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-12-8" id="h3-12-8" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-12-9" id="h3-12-9" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-13" id="h3-13" class="h">@@ -335,20 +338,20 @@ pub mod tests {
</a>     // Heartbeat from current leader with conflicting commit_term
     fn step_heartbeat_conflict_commit_term() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-13-3" id="h3-13-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-13-4" id="h3-13-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-13-8" id="h3-13-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 3, read_seq: 7 },
</a><a href="#h3-13-9" id="h3-13-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 3, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-13-14" id="h3-13-14" class="d">-            vec![Message {
</a><a href="#h3-13-15" id="h3-13-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-13-19" id="h3-13-19" class="d">-                event: Event::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h3-13-20" id="h3-13-20" class="i">+                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-14" id="h3-14" class="h">@@ -358,20 +361,20 @@ pub mod tests {
</a>     // Heartbeat from current leader with a missing commit_index
     fn step_heartbeat_missing_commit_entry() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-14-3" id="h3-14-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-14-4" id="h3-14-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-14-8" id="h3-14-8" class="d">-            event: Event::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h3-14-9" id="h3-14-9" class="i">+            message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-14-14" id="h3-14-14" class="d">-            vec![Message {
</a><a href="#h3-14-15" id="h3-14-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-14-19" id="h3-14-19" class="d">-                event: Event::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h3-14-20" id="h3-14-20" class="i">+                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-15" id="h3-15" class="h">@@ -383,11 +386,11 @@ pub mod tests {
</a>     fn step_heartbeat_fake_leader() {
         let (follower, _) = setup().unwrap();
         follower
<a href="#h3-15-3" id="h3-15-3" class="d">-            .step(Message {
</a><a href="#h3-15-4" id="h3-15-4" class="i">+            .step(Envelope {
</a>                 from: 3,
                 to: 1,
                 term: 3,
<a href="#h3-15-8" id="h3-15-8" class="d">-                event: Event::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h3-15-9" id="h3-15-9" class="i">+                message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a>             })
             .unwrap();
     }
<a href="#h3-16" id="h3-16" class="h">@@ -397,20 +400,20 @@ pub mod tests {
</a>     fn step_heartbeat_no_leader() -&gt; Result&lt;()&gt; {
         let (mut follower, mut node_rx) = setup()?;
         follower.role = Follower::new(None, None);
<a href="#h3-16-3" id="h3-16-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-16-4" id="h3-16-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-16-8" id="h3-16-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h3-16-9" id="h3-16-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(3)).voted_for(None).committed(3);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-16-14" id="h3-16-14" class="d">-            vec![Message {
</a><a href="#h3-16-15" id="h3-16-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 3,
                 term: 3,
<a href="#h3-16-19" id="h3-16-19" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-16-20" id="h3-16-20" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-17" id="h3-17" class="h">@@ -420,20 +423,20 @@ pub mod tests {
</a>     // Heartbeat from current leader with old commit_index
     fn step_heartbeat_old_commit_index() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-17-3" id="h3-17-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-17-4" id="h3-17-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-17-8" id="h3-17-8" class="d">-            event: Event::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h3-17-9" id="h3-17-9" class="i">+            message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-17-14" id="h3-17-14" class="d">-            vec![Message {
</a><a href="#h3-17-15" id="h3-17-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-17-19" id="h3-17-19" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-17-20" id="h3-17-20" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-18" id="h3-18" class="h">@@ -443,20 +446,20 @@ pub mod tests {
</a>     // Heartbeat for future term with other leader changes leader
     fn step_heartbeat_future_term() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-18-3" id="h3-18-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-18-4" id="h3-18-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 4,
<a href="#h3-18-8" id="h3-18-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h3-18-9" id="h3-18-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(4).leader(Some(3)).voted_for(None);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-18-14" id="h3-18-14" class="d">-            vec![Message {
</a><a href="#h3-18-15" id="h3-18-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 3,
                 term: 4,
<a href="#h3-18-19" id="h3-18-19" class="d">-                event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-18-20" id="h3-18-20" class="i">+                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-19" id="h3-19" class="h">@@ -466,11 +469,11 @@ pub mod tests {
</a>     // Heartbeat from past term
     fn step_heartbeat_past_term() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-19-3" id="h3-19-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-19-4" id="h3-19-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 2,
<a href="#h3-19-8" id="h3-19-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h3-19-9" id="h3-19-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-20" id="h3-20" class="h">@@ -483,37 +486,37 @@ pub mod tests {
</a>         let (follower, mut node_rx) = setup()?;
 
         // The first vote request in this term yields a vote response.
<a href="#h3-20-3" id="h3-20-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-20-4" id="h3-20-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-20-8" id="h3-20-8" class="d">-            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h3-20-9" id="h3-20-9" class="i">+            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-20-14" id="h3-20-14" class="d">-            vec![Message { from: 1, to: 3, term: 3, event: Event::GrantVote }],
</a><a href="#h3-20-15" id="h3-20-15" class="i">+            vec![Envelope { from: 1, to: 3, term: 3, message: Message::GrantVote }],
</a>         );
 
         // Another vote request from the same sender is granted.
<a href="#h3-20-19" id="h3-20-19" class="d">-        node = node.step(Message {
</a><a href="#h3-20-20" id="h3-20-20" class="i">+        node = node.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-20-24" id="h3-20-24" class="d">-            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h3-20-25" id="h3-20-25" class="i">+            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-20-30" id="h3-20-30" class="d">-            vec![Message { from: 1, to: 3, term: 3, event: Event::GrantVote }],
</a><a href="#h3-20-31" id="h3-20-31" class="i">+            vec![Envelope { from: 1, to: 3, term: 3, message: Message::GrantVote }],
</a>         );
 
         // But a vote request from a different node is ignored.
<a href="#h3-20-35" id="h3-20-35" class="d">-        node = node.step(Message {
</a><a href="#h3-20-36" id="h3-20-36" class="i">+        node = node.step(Envelope {
</a>             from: 4,
             to: 1,
             term: 3,
<a href="#h3-20-40" id="h3-20-40" class="d">-            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h3-20-41" id="h3-20-41" class="i">+            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-21" id="h3-21" class="h">@@ -525,7 +528,7 @@ pub mod tests {
</a>     fn step_grantvote_noop() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
         let mut node =
<a href="#h3-21-3" id="h3-21-3" class="d">-            follower.step(Message { from: 2, to: 1, term: 3, event: Event::GrantVote })?;
</a><a href="#h3-21-4" id="h3-21-4" class="i">+            follower.step(Envelope { from: 2, to: 1, term: 3, message: Message::GrantVote })?;
</a>         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
         assert_messages(&amp;mut node_rx, vec![]);
         Ok(())
<a href="#h3-22" id="h3-22" class="h">@@ -535,11 +538,11 @@ pub mod tests {
</a>     // SolicitVote is rejected if last_term is outdated.
     fn step_solicitvote_last_index_outdated() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-22-3" id="h3-22-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-22-4" id="h3-22-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-22-8" id="h3-22-8" class="d">-            event: Event::SolicitVote { last_index: 2, last_term: 2 },
</a><a href="#h3-22-9" id="h3-22-9" class="i">+            message: Message::SolicitVote { last_index: 2, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-23" id="h3-23" class="h">@@ -550,11 +553,11 @@ pub mod tests {
</a>     // SolicitVote is rejected if last_term is outdated.
     fn step_solicitvote_last_term_outdated() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-23-3" id="h3-23-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-23-4" id="h3-23-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-23-8" id="h3-23-8" class="d">-            event: Event::SolicitVote { last_index: 3, last_term: 1 },
</a><a href="#h3-23-9" id="h3-23-9" class="i">+            message: Message::SolicitVote { last_index: 3, last_term: 1 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-24" id="h3-24" class="h">@@ -582,11 +585,11 @@ pub mod tests {
</a>             role: Follower::new(Some(2), None),
         };
 
<a href="#h3-24-3" id="h3-24-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-24-4" id="h3-24-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-24-8" id="h3-24-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-24-9" id="h3-24-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 0,
                 base_term: 0,
                 entries: vec![
<a href="#h3-25" id="h3-25" class="h">@@ -601,11 +604,11 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-25-3" id="h3-25-3" class="d">-            vec![Message {
</a><a href="#h3-25-4" id="h3-25-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-25-8" id="h3-25-8" class="d">-                event: Event::AcceptEntries { last_index: 2 },
</a><a href="#h3-25-9" id="h3-25-9" class="i">+                message: Message::AcceptEntries { last_index: 2 },
</a>             }],
         );
         Ok(())
<a href="#h3-26" id="h3-26" class="h">@@ -615,11 +618,11 @@ pub mod tests {
</a>     // AppendEntries appends entries but does not commit them
     fn step_appendentries_append() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-26-3" id="h3-26-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-26-4" id="h3-26-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-26-8" id="h3-26-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-26-9" id="h3-26-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 3,
                 base_term: 2,
                 entries: vec![
<a href="#h3-27" id="h3-27" class="h">@@ -637,11 +640,11 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-27-3" id="h3-27-3" class="d">-            vec![Message {
</a><a href="#h3-27-4" id="h3-27-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-27-8" id="h3-27-8" class="d">-                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-27-9" id="h3-27-9" class="i">+                message: Message::AcceptEntries { last_index: 5 },
</a>             }],
         );
         Ok(())
<a href="#h3-28" id="h3-28" class="h">@@ -651,11 +654,11 @@ pub mod tests {
</a>     // AppendEntries accepts partially overlapping entries
     fn step_appendentries_partial_overlap() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-28-3" id="h3-28-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-28-4" id="h3-28-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-28-8" id="h3-28-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-28-9" id="h3-28-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 1,
                 base_term: 1,
                 entries: vec![
<a href="#h3-29" id="h3-29" class="h">@@ -672,11 +675,11 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-29-3" id="h3-29-3" class="d">-            vec![Message {
</a><a href="#h3-29-4" id="h3-29-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-29-8" id="h3-29-8" class="d">-                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h3-29-9" id="h3-29-9" class="i">+                message: Message::AcceptEntries { last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h3-30" id="h3-30" class="h">@@ -686,11 +689,11 @@ pub mod tests {
</a>     // AppendEntries replaces conflicting entries
     fn step_appendentries_replace() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-30-3" id="h3-30-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-30-4" id="h3-30-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-30-8" id="h3-30-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-30-9" id="h3-30-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 2,
                 base_term: 1,
                 entries: vec![
<a href="#h3-31" id="h3-31" class="h">@@ -707,11 +710,11 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-31-3" id="h3-31-3" class="d">-            vec![Message {
</a><a href="#h3-31-4" id="h3-31-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-31-8" id="h3-31-8" class="d">-                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h3-31-9" id="h3-31-9" class="i">+                message: Message::AcceptEntries { last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h3-32" id="h3-32" class="h">@@ -721,11 +724,11 @@ pub mod tests {
</a>     // AppendEntries replaces partially conflicting entries
     fn step_appendentries_replace_partial() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-32-3" id="h3-32-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-32-4" id="h3-32-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-32-8" id="h3-32-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-32-9" id="h3-32-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 2,
                 base_term: 1,
                 entries: vec![
<a href="#h3-33" id="h3-33" class="h">@@ -742,11 +745,11 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-33-3" id="h3-33-3" class="d">-            vec![Message {
</a><a href="#h3-33-4" id="h3-33-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-33-8" id="h3-33-8" class="d">-                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h3-33-9" id="h3-33-9" class="i">+                message: Message::AcceptEntries { last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h3-34" id="h3-34" class="h">@@ -756,11 +759,11 @@ pub mod tests {
</a>     // AppendEntries rejects missing base index
     fn step_appendentries_reject_missing_base_index() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-34-3" id="h3-34-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-34-4" id="h3-34-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-34-8" id="h3-34-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-34-9" id="h3-34-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 5,
                 base_term: 2,
                 entries: vec![Entry { index: 6, term: 3, command: Some(vec![0x04]) }],
<a href="#h3-35" id="h3-35" class="h">@@ -773,7 +776,7 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-35-3" id="h3-35-3" class="d">-            vec![Message { from: 1, to: 2, term: 3, event: Event::RejectEntries }],
</a><a href="#h3-35-4" id="h3-35-4" class="i">+            vec![Envelope { from: 1, to: 2, term: 3, message: Message::RejectEntries }],
</a>         );
         Ok(())
     }
<a href="#h3-36" id="h3-36" class="h">@@ -782,11 +785,11 @@ pub mod tests {
</a>     // AppendEntries rejects conflicting base term
     fn step_appendentries_reject_missing_base_term() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h3-36-3" id="h3-36-3" class="d">-        let mut node = follower.step(Message {
</a><a href="#h3-36-4" id="h3-36-4" class="i">+        let mut node = follower.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-36-8" id="h3-36-8" class="d">-            event: Event::AppendEntries {
</a><a href="#h3-36-9" id="h3-36-9" class="i">+            message: Message::AppendEntries {
</a>                 base_index: 1,
                 base_term: 2,
                 entries: vec![Entry { index: 2, term: 3, command: Some(vec![0x04]) }],
<a href="#h3-37" id="h3-37" class="h">@@ -799,7 +802,7 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-37-3" id="h3-37-3" class="d">-            vec![Message { from: 1, to: 2, term: 3, event: Event::RejectEntries }],
</a><a href="#h3-37-4" id="h3-37-4" class="i">+            vec![Envelope { from: 1, to: 2, term: 3, message: Message::RejectEntries }],
</a>         );
         Ok(())
     }
<a href="#h3-38" id="h3-38" class="h">@@ -810,31 +813,34 @@ pub mod tests {
</a>         let (follower, mut node_rx) = setup()?;
         let mut node = Node::Follower(follower);
 
<a href="#h3-38-3" id="h3-38-3" class="d">-        node = node.step(Message {
</a><a href="#h3-38-4" id="h3-38-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h3-38-8" id="h3-38-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
</a><a href="#h3-38-9" id="h3-38-9" class="i">+            message: Message::ClientRequest {
</a><a href="#h3-38-10" id="h3-38-10" class="i">+                id: vec![0x01],
</a><a href="#h3-38-11" id="h3-38-11" class="i">+                request: Request::Mutate(vec![0xaf]),
</a><a href="#h3-38-12" id="h3-38-12" class="i">+            },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![vec![0x01]]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-38-17" id="h3-38-17" class="d">-            vec![Message {
</a><a href="#h3-38-18" id="h3-38-18" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-38-22" id="h3-38-22" class="d">-                event: Event::ClientRequest {
</a><a href="#h3-38-23" id="h3-38-23" class="i">+                message: Message::ClientRequest {
</a>                     id: vec![0x01],
                     request: Request::Mutate(vec![0xaf]),
                 },
             }],
         );
 
<a href="#h3-38-30" id="h3-38-30" class="d">-        node = node.step(Message {
</a><a href="#h3-38-31" id="h3-38-31" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-38-35" id="h3-38-35" class="d">-            event: Event::ClientResponse {
</a><a href="#h3-38-36" id="h3-38-36" class="i">+            message: Message::ClientResponse {
</a>                 id: vec![0x01],
                 response: Ok(Response::Mutate(vec![0xaf])),
             },
<a href="#h3-39" id="h3-39" class="h">@@ -842,11 +848,11 @@ pub mod tests {
</a>         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-39-3" id="h3-39-3" class="d">-            vec![Message {
</a><a href="#h3-39-4" id="h3-39-4" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 1,
                 term: 3,
<a href="#h3-39-8" id="h3-39-8" class="d">-                event: Event::ClientResponse {
</a><a href="#h3-39-9" id="h3-39-9" class="i">+                message: Message::ClientResponse {
</a>                     id: vec![0x01],
                     response: Ok(Response::Mutate(vec![0xaf])),
                 },
<a href="#h3-40" id="h3-40" class="h">@@ -862,20 +868,23 @@ pub mod tests {
</a>         follower.role = Follower::new(None, None);
         let mut node = Node::Follower(follower);
 
<a href="#h3-40-3" id="h3-40-3" class="d">-        node = node.step(Message {
</a><a href="#h3-40-4" id="h3-40-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h3-40-8" id="h3-40-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
</a><a href="#h3-40-9" id="h3-40-9" class="i">+            message: Message::ClientRequest {
</a><a href="#h3-40-10" id="h3-40-10" class="i">+                id: vec![0x01],
</a><a href="#h3-40-11" id="h3-40-11" class="i">+                request: Request::Mutate(vec![0xaf]),
</a><a href="#h3-40-12" id="h3-40-12" class="i">+            },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(None).forwarded(vec![]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-40-17" id="h3-40-17" class="d">-            vec![Message {
</a><a href="#h3-40-18" id="h3-40-18" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 1,
                 term: 3,
<a href="#h3-40-22" id="h3-40-22" class="d">-                event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a><a href="#h3-40-23" id="h3-40-23" class="i">+                message: Message::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a>             }],
         );
         Ok(())
<a href="#h3-41" id="h3-41" class="h">@@ -887,20 +896,23 @@ pub mod tests {
</a>         let (follower, mut node_rx) = setup()?;
         let mut node = Node::Follower(follower);
 
<a href="#h3-41-3" id="h3-41-3" class="d">-        node = node.step(Message {
</a><a href="#h3-41-4" id="h3-41-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h3-41-8" id="h3-41-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
</a><a href="#h3-41-9" id="h3-41-9" class="i">+            message: Message::ClientRequest {
</a><a href="#h3-41-10" id="h3-41-10" class="i">+                id: vec![0x01],
</a><a href="#h3-41-11" id="h3-41-11" class="i">+                request: Request::Mutate(vec![0xaf]),
</a><a href="#h3-41-12" id="h3-41-12" class="i">+            },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).forwarded(vec![vec![0x01]]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h3-41-17" id="h3-41-17" class="d">-            vec![Message {
</a><a href="#h3-41-18" id="h3-41-18" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-41-22" id="h3-41-22" class="d">-                event: Event::ClientRequest {
</a><a href="#h3-41-23" id="h3-41-23" class="i">+                message: Message::ClientRequest {
</a>                     id: vec![0x01],
                     request: Request::Mutate(vec![0xaf]),
                 },
<a href="#h3-42" id="h3-42" class="h">@@ -908,27 +920,30 @@ pub mod tests {
</a>         );
 
         // When a new leader appears, the proxied request is aborted.
<a href="#h3-42-3" id="h3-42-3" class="d">-        node = node.step(Message {
</a><a href="#h3-42-4" id="h3-42-4" class="i">+        node = node.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 4,
<a href="#h3-42-8" id="h3-42-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h3-42-9" id="h3-42-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(4).leader(Some(3)).forwarded(vec![]);
         assert_messages(
             &amp;mut node_rx,
             vec![
<a href="#h3-42-15" id="h3-42-15" class="d">-                Message {
</a><a href="#h3-42-16" id="h3-42-16" class="i">+                Envelope {
</a>                     from: 1,
                     to: 1,
                     term: 3,
<a href="#h3-42-20" id="h3-42-20" class="d">-                    event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
</a><a href="#h3-42-21" id="h3-42-21" class="i">+                    message: Message::ClientResponse {
</a><a href="#h3-42-22" id="h3-42-22" class="i">+                        id: vec![0x01],
</a><a href="#h3-42-23" id="h3-42-23" class="i">+                        response: Err(Error::Abort),
</a><a href="#h3-42-24" id="h3-42-24" class="i">+                    },
</a>                 },
<a href="#h3-42-26" id="h3-42-26" class="d">-                Message {
</a><a href="#h3-42-27" id="h3-42-27" class="i">+                Envelope {
</a>                     from: 1,
                     to: 3,
                     term: 4,
<a href="#h3-42-31" id="h3-42-31" class="d">-                    event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-42-32" id="h3-42-32" class="i">+                    message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>                 },
             ],
         );
<a href="#h3-43" id="h3-43" class="h">@@ -947,19 +962,19 @@ pub mod tests {
</a>         for _ in 0..(3 * timeout) {
             assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
             node = node.tick()?;
<a href="#h3-43-3" id="h3-43-3" class="d">-            node = node.step(Message {
</a><a href="#h3-43-4" id="h3-43-4" class="i">+            node = node.step(Envelope {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h3-43-8" id="h3-43-8" class="d">-                event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a><a href="#h3-43-9" id="h3-43-9" class="i">+                message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 7 },
</a>             })?;
             assert_messages(
                 &amp;mut node_rx,
<a href="#h3-43-13" id="h3-43-13" class="d">-                vec![Message {
</a><a href="#h3-43-14" id="h3-43-14" class="i">+                vec![Envelope {
</a>                     from: 1,
                     to: 2,
                     term: 3,
<a href="#h3-43-18" id="h3-43-18" class="d">-                    event: Event::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h3-43-19" id="h3-43-19" class="i">+                    message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a>                 }],
             )
         }
<a href="#h3-44" id="h3-44" class="h">@@ -973,11 +988,11 @@ pub mod tests {
</a>         for to in peers.iter().copied().sorted() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h3-44-3" id="h3-44-3" class="d">-                Message {
</a><a href="#h3-44-4" id="h3-44-4" class="i">+                Envelope {
</a>                     from: 1,
                     to,
                     term: 4,
<a href="#h3-44-8" id="h3-44-8" class="d">-                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h3-44-9" id="h3-44-9" class="i">+                    message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a>                 },
             );
         }
<b>diff --git a/<a id="h4" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,5 +1,6 @@
</a> use super::super::{
<a href="#h4-0-1" id="h4-0-1" class="d">-    Event, Index, Message, ReadSequence, Request, RequestID, Response, Status, HEARTBEAT_INTERVAL,
</a><a href="#h4-0-2" id="h4-0-2" class="i">+    Envelope, Index, Message, ReadSequence, Request, RequestID, Response, Status,
</a><a href="#h4-0-3" id="h4-0-3" class="i">+    HEARTBEAT_INTERVAL,
</a> };
 use super::{Follower, Node, NodeID, RawNode, Role, Term, Ticks};
 use crate::error::{Error, Result};
<a href="#h4-1" id="h4-1" class="h">@@ -111,13 +112,13 @@ impl RawNode&lt;Leader&gt; {
</a>         for write in std::mem::take(&amp;mut self.role.writes).into_values() {
             self.send(
                 write.from,
<a href="#h4-1-3" id="h4-1-3" class="d">-                Event::ClientResponse { id: write.id, response: Err(Error::Abort) },
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                Message::ClientResponse { id: write.id, response: Err(Error::Abort) },
</a>             )?;
         }
         for read in std::mem::take(&amp;mut self.role.reads).into_iter() {
             self.send(
                 read.from,
<a href="#h4-1-10" id="h4-1-10" class="d">-                Event::ClientResponse { id: read.id, response: Err(Error::Abort) },
</a><a href="#h4-1-11" id="h4-1-11" class="i">+                Message::ClientResponse { id: read.id, response: Err(Error::Abort) },
</a>             )?;
         }
 
<a href="#h4-2" id="h4-2" class="h">@@ -127,7 +128,7 @@ impl RawNode&lt;Leader&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h4-2-3" id="h4-2-3" class="d">-    pub fn step(mut self, msg: Message) -&gt; Result&lt;Node&gt; {
</a><a href="#h4-2-4" id="h4-2-4" class="i">+    pub fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
</a>         self.assert()?;
         self.assert_step(&amp;msg);
 
<a href="#h4-3" id="h4-3" class="h">@@ -144,9 +145,9 @@ impl RawNode&lt;Leader&gt; {
</a>             return self.into_follower(msg.term)?.step(msg);
         }
 
<a href="#h4-3-3" id="h4-3-3" class="d">-        match msg.event {
</a><a href="#h4-3-4" id="h4-3-4" class="i">+        match msg.message {
</a>             // There can&#39;t be two leaders in the same term.
<a href="#h4-3-6" id="h4-3-6" class="d">-            Event::Heartbeat { .. } | Event::AppendEntries { .. } =&gt; {
</a><a href="#h4-3-7" id="h4-3-7" class="i">+            Message::Heartbeat { .. } | Message::AppendEntries { .. } =&gt; {
</a>                 panic!(&quot;Saw other leader {} in term {}&quot;, msg.from, msg.term);
             }
 
<a href="#h4-4" id="h4-4" class="h">@@ -154,7 +155,7 @@ impl RawNode&lt;Leader&gt; {
</a>             // are its leader. If it doesn&#39;t have the commit index in its local
             // log, replicate the log to it. If the peer&#39;s read sequence number
             // increased, process any pending reads.
<a href="#h4-4-3" id="h4-4-3" class="d">-            Event::ConfirmLeader { has_committed, read_seq } =&gt; {
</a><a href="#h4-4-4" id="h4-4-4" class="i">+            Message::ConfirmLeader { has_committed, read_seq } =&gt; {
</a>                 assert!(read_seq &lt;= self.role.read_seq, &quot;Future read sequence number&quot;);
 
                 let from = msg.from;
<a href="#h4-5" id="h4-5" class="h">@@ -171,7 +172,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
             // A follower appended log entries we sent it. Record its progress
             // and attempt to commit new entries.
<a href="#h4-5-3" id="h4-5-3" class="d">-            Event::AcceptEntries { last_index } =&gt; {
</a><a href="#h4-5-4" id="h4-5-4" class="i">+            Message::AcceptEntries { last_index } =&gt; {
</a>                 assert!(
                     last_index &lt;= self.log.get_last_index().0,
                     &quot;Follower accepted entries after last index&quot;
<a href="#h4-6" id="h4-6" class="h">@@ -192,7 +193,7 @@ impl RawNode&lt;Leader&gt; {
</a>             //
             // This linear probing, as described in the Raft paper, can be very
             // slow with long divergent logs, but we keep it simple.
<a href="#h4-6-3" id="h4-6-3" class="d">-            Event::RejectEntries =&gt; {
</a><a href="#h4-6-4" id="h4-6-4" class="i">+            Message::RejectEntries =&gt; {
</a>                 let from = msg.from;
                 self.role.progress.entry(from).and_modify(|p| {
                     if p.next &gt; 1 {
<a href="#h4-7" id="h4-7" class="h">@@ -206,7 +207,7 @@ impl RawNode&lt;Leader&gt; {
</a>             // must confirm that we are still the leader by sending a heartbeat
             // with the read&#39;s sequence number and wait for confirmation from a
             // quorum before executing the read.
<a href="#h4-7-3" id="h4-7-3" class="d">-            Event::ClientRequest { id, request: Request::Query(command) } =&gt; {
</a><a href="#h4-7-4" id="h4-7-4" class="i">+            Message::ClientRequest { id, request: Request::Query(command) } =&gt; {
</a>                 self.role.read_seq += 1;
                 self.role.reads.push_back(Read {
                     seq: self.role.read_seq,
<a href="#h4-8" id="h4-8" class="h">@@ -222,7 +223,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
             // A client submitted a write command. Propose it, and track it
             // until it&#39;s applied and the response is returned to the client.
<a href="#h4-8-3" id="h4-8-3" class="d">-            Event::ClientRequest { id, request: Request::Mutate(command) } =&gt; {
</a><a href="#h4-8-4" id="h4-8-4" class="i">+            Message::ClientRequest { id, request: Request::Mutate(command) } =&gt; {
</a>                 let index = self.propose(Some(command))?;
                 self.role.writes.insert(index, Write { from: msg.from, id: id.clone() });
                 if self.peers.is_empty() {
<a href="#h4-9" id="h4-9" class="h">@@ -230,7 +231,7 @@ impl RawNode&lt;Leader&gt; {
</a>                 }
             }
 
<a href="#h4-9-3" id="h4-9-3" class="d">-            Event::ClientRequest { id, request: Request::Status } =&gt; {
</a><a href="#h4-9-4" id="h4-9-4" class="i">+            Message::ClientRequest { id, request: Request::Status } =&gt; {
</a>                 let status = Status {
                     leader: self.id,
                     term: self.term,
<a href="#h4-10" id="h4-10" class="h">@@ -247,16 +248,16 @@ impl RawNode&lt;Leader&gt; {
</a>                 };
                 self.send(
                     msg.from,
<a href="#h4-10-3" id="h4-10-3" class="d">-                    Event::ClientResponse { id, response: Ok(Response::Status(status)) },
</a><a href="#h4-10-4" id="h4-10-4" class="i">+                    Message::ClientResponse { id, response: Ok(Response::Status(status)) },
</a>                 )?;
             }
 
             // Votes can come in after we won the election, ignore them.
<a href="#h4-10-9" id="h4-10-9" class="d">-            Event::SolicitVote { .. } | Event::GrantVote =&gt; {}
</a><a href="#h4-10-10" id="h4-10-10" class="i">+            Message::SolicitVote { .. } | Message::GrantVote =&gt; {}
</a> 
             // Leaders never proxy client requests, so we don&#39;t expect to see
             // responses from other nodes.
<a href="#h4-10-14" id="h4-10-14" class="d">-            Event::ClientResponse { .. } =&gt; panic!(&quot;Unexpected message {:?}&quot;, msg),
</a><a href="#h4-10-15" id="h4-10-15" class="i">+            Message::ClientResponse { .. } =&gt; panic!(&quot;Unexpected message {:?}&quot;, msg),
</a>         }
 
         Ok(self.into())
<a href="#h4-11" id="h4-11" class="h">@@ -278,7 +279,7 @@ impl RawNode&lt;Leader&gt; {
</a>     pub(super) fn heartbeat(&amp;mut self) -&gt; Result&lt;()&gt; {
         let (commit_index, commit_term) = self.log.get_commit_index();
         let read_seq = self.role.read_seq;
<a href="#h4-11-3" id="h4-11-3" class="d">-        self.broadcast(Event::Heartbeat { commit_index, commit_term, read_seq })?;
</a><a href="#h4-11-4" id="h4-11-4" class="i">+        self.broadcast(Message::Heartbeat { commit_index, commit_term, read_seq })?;
</a>         // NB: We don&#39;t reset self.since_heartbeat here, because we want to send
         // periodic heartbeats regardless of any on-demand heartbeats.
         Ok(())
<a href="#h4-12" id="h4-12" class="h">@@ -331,11 +332,11 @@ impl RawNode&lt;Leader&gt; {
</a>         Self::maybe_apply_with(&amp;mut self.log, &amp;mut self.state, |index, result| -&gt; Result&lt;()&gt; {
             if let Some(write) = self.role.writes.remove(&amp;index) {
                 // TODO: use self.send() or something.
<a href="#h4-12-3" id="h4-12-3" class="d">-                self.node_tx.send(Message {
</a><a href="#h4-12-4" id="h4-12-4" class="i">+                self.node_tx.send(Envelope {
</a>                     from: self.id,
                     to: write.from,
                     term: self.term,
<a href="#h4-12-8" id="h4-12-8" class="d">-                    event: Event::ClientResponse {
</a><a href="#h4-12-9" id="h4-12-9" class="i">+                    message: Message::ClientResponse {
</a>                         id: write.id,
                         response: result.map(Response::Mutate),
                     },
<a href="#h4-13" id="h4-13" class="h">@@ -373,7 +374,7 @@ impl RawNode&lt;Leader&gt; {
</a>             let result = self.state.query(read.command);
             self.send(
                 read.from,
<a href="#h4-13-3" id="h4-13-3" class="d">-                Event::ClientResponse { id: read.id, response: result.map(Response::Query) },
</a><a href="#h4-13-4" id="h4-13-4" class="i">+                Message::ClientResponse { id: read.id, response: result.map(Response::Query) },
</a>             )?;
         }
 
<a href="#h4-14" id="h4-14" class="h">@@ -393,7 +394,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
         let entries = self.log.scan((base_index + 1)..)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
         debug!(&quot;Replicating {} entries at base {} to {}&quot;, entries.len(), base_index, peer);
<a href="#h4-14-3" id="h4-14-3" class="d">-        self.send(peer, Event::AppendEntries { base_index, base_term, entries })?;
</a><a href="#h4-14-4" id="h4-14-4" class="i">+        self.send(peer, Message::AppendEntries { base_index, base_term, entries })?;
</a>         Ok(())
     }
 }
<a href="#h4-15" id="h4-15" class="h">@@ -409,7 +410,7 @@ mod tests {
</a>     use pretty_assertions::assert_eq;
 
     #[allow(clippy::type_complexity)]
<a href="#h4-15-3" id="h4-15-3" class="d">-    fn setup() -&gt; Result&lt;(RawNode&lt;Leader&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
</a><a href="#h4-15-4" id="h4-15-4" class="i">+    fn setup() -&gt; Result&lt;(RawNode&lt;Leader&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a>         let (node_tx, node_rx) = crossbeam::channel::unbounded();
         let peers = HashSet::from([2, 3, 4, 5]);
         let state = Box::new(TestState::new(0));
<a href="#h4-16" id="h4-16" class="h">@@ -440,11 +441,11 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-16-3" id="h4-16-3" class="d">-        node = node.step(Message {
</a><a href="#h4-16-4" id="h4-16-4" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h4-16-8" id="h4-16-8" class="d">-            event: Event::ConfirmLeader { has_committed: true, read_seq: 0 },
</a><a href="#h4-16-9" id="h4-16-9" class="i">+            message: Message::ConfirmLeader { has_committed: true, read_seq: 0 },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h4-17" id="h4-17" class="h">@@ -457,20 +458,20 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-17-3" id="h4-17-3" class="d">-        node = node.step(Message {
</a><a href="#h4-17-4" id="h4-17-4" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h4-17-8" id="h4-17-8" class="d">-            event: Event::ConfirmLeader { has_committed: false, read_seq: 0 },
</a><a href="#h4-17-9" id="h4-17-9" class="i">+            message: Message::ConfirmLeader { has_committed: false, read_seq: 0 },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2);
         assert_messages(
             &amp;mut node_rx,
<a href="#h4-17-14" id="h4-17-14" class="d">-            vec![Message {
</a><a href="#h4-17-15" id="h4-17-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h4-17-19" id="h4-17-19" class="d">-                event: Event::AppendEntries { base_index: 5, base_term: 3, entries: vec![] },
</a><a href="#h4-17-20" id="h4-17-20" class="i">+                message: Message::AppendEntries { base_index: 5, base_term: 3, entries: vec![] },
</a>             }],
         );
         Ok(())
<a href="#h4-18" id="h4-18" class="h">@@ -482,11 +483,11 @@ mod tests {
</a>     fn step_heartbeat_current_term() {
         let (leader, _) = setup().unwrap();
         leader
<a href="#h4-18-3" id="h4-18-3" class="d">-            .step(Message {
</a><a href="#h4-18-4" id="h4-18-4" class="i">+            .step(Envelope {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h4-18-8" id="h4-18-8" class="d">-                event: Event::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a><a href="#h4-18-9" id="h4-18-9" class="i">+                message: Message::Heartbeat { commit_index: 5, commit_term: 3, read_seq: 7 },
</a>             })
             .unwrap();
     }
<a href="#h4-19" id="h4-19" class="h">@@ -497,20 +498,20 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-19-3" id="h4-19-3" class="d">-        node = node.step(Message {
</a><a href="#h4-19-4" id="h4-19-4" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 4,
<a href="#h4-19-8" id="h4-19-8" class="d">-            event: Event::Heartbeat { commit_index: 7, commit_term: 4, read_seq: 7 },
</a><a href="#h4-19-9" id="h4-19-9" class="i">+            message: Message::Heartbeat { commit_index: 7, commit_term: 4, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(4).leader(Some(2)).committed(2);
         assert_messages(
             &amp;mut node_rx,
<a href="#h4-19-14" id="h4-19-14" class="d">-            vec![Message {
</a><a href="#h4-19-15" id="h4-19-15" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 4,
<a href="#h4-19-19" id="h4-19-19" class="d">-                event: Event::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h4-19-20" id="h4-19-20" class="i">+                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h4-20" id="h4-20" class="h">@@ -522,11 +523,11 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-20-3" id="h4-20-3" class="d">-        node = node.step(Message {
</a><a href="#h4-20-4" id="h4-20-4" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 2,
<a href="#h4-20-8" id="h4-20-8" class="d">-            event: Event::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a><a href="#h4-20-9" id="h4-20-9" class="i">+            message: Message::Heartbeat { commit_index: 3, commit_term: 2, read_seq: 7 },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h4-21" id="h4-21" class="h">@@ -538,29 +539,29 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-21-3" id="h4-21-3" class="d">-        node = node.step(Message {
</a><a href="#h4-21-4" id="h4-21-4" class="i">+        node = node.step(Envelope {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h4-21-8" id="h4-21-8" class="d">-            event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h4-21-9" id="h4-21-9" class="i">+            message: Message::AcceptEntries { last_index: 4 },
</a>         })?;
         assert_node(&amp;mut node).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
 
<a href="#h4-21-14" id="h4-21-14" class="d">-        node = node.step(Message {
</a><a href="#h4-21-15" id="h4-21-15" class="i">+        node = node.step(Envelope {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h4-21-19" id="h4-21-19" class="d">-            event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h4-21-20" id="h4-21-20" class="i">+            message: Message::AcceptEntries { last_index: 5 },
</a>         })?;
         assert_node(&amp;mut node).committed(4).applied(4);
         assert_messages(&amp;mut node_rx, vec![]);
 
<a href="#h4-21-25" id="h4-21-25" class="d">-        node = node.step(Message {
</a><a href="#h4-21-26" id="h4-21-26" class="i">+        node = node.step(Envelope {
</a>             from: 4,
             to: 1,
             term: 3,
<a href="#h4-21-30" id="h4-21-30" class="d">-            event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h4-21-31" id="h4-21-31" class="i">+            message: Message::AcceptEntries { last_index: 5 },
</a>         })?;
         assert_node(&amp;mut node).committed(5).applied(5);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h4-22" id="h4-22" class="h">@@ -576,11 +577,11 @@ mod tests {
</a>         let mut node: Node = leader.into();
 
         for _ in 0..5 {
<a href="#h4-22-3" id="h4-22-3" class="d">-            node = node.step(Message {
</a><a href="#h4-22-4" id="h4-22-4" class="i">+            node = node.step(Envelope {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h4-22-8" id="h4-22-8" class="d">-                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h4-22-9" id="h4-22-9" class="i">+                message: Message::AcceptEntries { last_index: 5 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h4-23" id="h4-23" class="h">@@ -596,11 +597,11 @@ mod tests {
</a>         let mut node: Node = leader.into();
 
         for peer in peers.into_iter() {
<a href="#h4-23-3" id="h4-23-3" class="d">-            node = node.step(Message {
</a><a href="#h4-23-4" id="h4-23-4" class="i">+            node = node.step(Envelope {
</a>                 from: peer,
                 to: 1,
                 term: 3,
<a href="#h4-23-8" id="h4-23-8" class="d">-                event: Event::AcceptEntries { last_index: 3 },
</a><a href="#h4-23-9" id="h4-23-9" class="i">+                message: Message::AcceptEntries { last_index: 3 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h4-24" id="h4-24" class="h">@@ -614,11 +615,11 @@ mod tests {
</a>     fn step_acceptentries_future_index() {
         let (leader, _) = setup().unwrap();
         leader
<a href="#h4-24-3" id="h4-24-3" class="d">-            .step(Message {
</a><a href="#h4-24-4" id="h4-24-4" class="i">+            .step(Envelope {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h4-24-8" id="h4-24-8" class="d">-                event: Event::AcceptEntries { last_index: 7 },
</a><a href="#h4-24-9" id="h4-24-9" class="i">+                message: Message::AcceptEntries { last_index: 7 },
</a>             })
             .unwrap();
     }
<a href="#h4-25" id="h4-25" class="h">@@ -630,17 +631,18 @@ mod tests {
</a>         let mut node: Node = leader.into();
 
         for i in 0..(entries.len() + 3) {
<a href="#h4-25-3" id="h4-25-3" class="d">-            node = node.step(Message { from: 2, to: 1, term: 3, event: Event::RejectEntries })?;
</a><a href="#h4-25-4" id="h4-25-4" class="i">+            node =
</a><a href="#h4-25-5" id="h4-25-5" class="i">+                node.step(Envelope { from: 2, to: 1, term: 3, message: Message::RejectEntries })?;
</a>             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
             let replicate = entries.get(index..).unwrap().to_vec();
             assert_messages(
                 &amp;mut node_rx,
<a href="#h4-25-11" id="h4-25-11" class="d">-                vec![Message {
</a><a href="#h4-25-12" id="h4-25-12" class="i">+                vec![Envelope {
</a>                     from: 1,
                     to: 2,
                     term: 3,
<a href="#h4-25-16" id="h4-25-16" class="d">-                    event: Event::AppendEntries {
</a><a href="#h4-25-17" id="h4-25-17" class="i">+                    message: Message::AppendEntries {
</a>                         base_index: index as Index,
                         base_term: if index &gt; 0 {
                             entries.get(index - 1).map(|e| e.term).unwrap()
<a href="#h4-26" id="h4-26" class="h">@@ -661,21 +663,21 @@ mod tests {
</a>         let (leader, node_rx) = setup()?;
         let peers = leader.peers.clone();
         let mut node: Node = leader.into();
<a href="#h4-26-3" id="h4-26-3" class="d">-        node = node.step(Message {
</a><a href="#h4-26-4" id="h4-26-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h4-26-8" id="h4-26-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Query(vec![0xaf]) },
</a><a href="#h4-26-9" id="h4-26-9" class="i">+            message: Message::ClientRequest { id: vec![0x01], request: Request::Query(vec![0xaf]) },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2).last(5);
         for to in peers.iter().copied().sorted() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h4-26-15" id="h4-26-15" class="d">-                Message {
</a><a href="#h4-26-16" id="h4-26-16" class="i">+                Envelope {
</a>                     from: 1,
                     to,
                     term: 3,
<a href="#h4-26-20" id="h4-26-20" class="d">-                    event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 1 },
</a><a href="#h4-26-21" id="h4-26-21" class="i">+                    message: Message::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 1 },
</a>                 },
             );
         }
<a href="#h4-27" id="h4-27" class="h">@@ -689,11 +691,14 @@ mod tests {
</a>         let peers = leader.peers.clone();
         let mut node: Node = leader.into();
 
<a href="#h4-27-3" id="h4-27-3" class="d">-        node = node.step(Message {
</a><a href="#h4-27-4" id="h4-27-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h4-27-8" id="h4-27-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
</a><a href="#h4-27-9" id="h4-27-9" class="i">+            message: Message::ClientRequest {
</a><a href="#h4-27-10" id="h4-27-10" class="i">+                id: vec![0x01],
</a><a href="#h4-27-11" id="h4-27-11" class="i">+                request: Request::Mutate(vec![0xaf]),
</a><a href="#h4-27-12" id="h4-27-12" class="i">+            },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2).last(6).entry(Entry {
             index: 6,
<a href="#h4-28" id="h4-28" class="h">@@ -704,11 +709,11 @@ mod tests {
</a>         for peer in peers.iter().cloned() {
             assert_eq!(
                 node_rx.try_recv()?,
<a href="#h4-28-3" id="h4-28-3" class="d">-                Message {
</a><a href="#h4-28-4" id="h4-28-4" class="i">+                Envelope {
</a>                     from: 1,
                     to: peer,
                     term: 3,
<a href="#h4-28-8" id="h4-28-8" class="d">-                    event: Event::AppendEntries {
</a><a href="#h4-28-9" id="h4-28-9" class="i">+                    message: Message::AppendEntries {
</a>                         base_index: 5,
                         base_term: 3,
                         entries: vec![Entry { index: 6, term: 3, command: Some(vec![0xaf]) },]
<a href="#h4-29" id="h4-29" class="h">@@ -725,20 +730,20 @@ mod tests {
</a>         let (leader, mut node_rx) = setup()?;
         let mut node: Node = leader.into();
 
<a href="#h4-29-3" id="h4-29-3" class="d">-        node = node.step(Message {
</a><a href="#h4-29-4" id="h4-29-4" class="i">+        node = node.step(Envelope {
</a>             from: 1,
             to: 1,
             term: 3,
<a href="#h4-29-8" id="h4-29-8" class="d">-            event: Event::ClientRequest { id: vec![0x01], request: Request::Status },
</a><a href="#h4-29-9" id="h4-29-9" class="i">+            message: Message::ClientRequest { id: vec![0x01], request: Request::Status },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2).last(5);
         assert_messages(
             &amp;mut node_rx,
<a href="#h4-29-14" id="h4-29-14" class="d">-            vec![Message {
</a><a href="#h4-29-15" id="h4-29-15" class="i">+            vec![Envelope {
</a>                 term: 3,
                 from: 1,
                 to: 1,
<a href="#h4-29-19" id="h4-29-19" class="d">-                event: Event::ClientResponse {
</a><a href="#h4-29-20" id="h4-29-20" class="i">+                message: Message::ClientResponse {
</a>                     id: vec![1],
                     response: Ok(Response::Status(Status {
                         leader: 1,
<a href="#h4-30" id="h4-30" class="h">@@ -777,11 +782,15 @@ mod tests {
</a>             for to in peers.iter().copied().sorted() {
                 assert_eq!(
                     node_rx.try_recv()?,
<a href="#h4-30-3" id="h4-30-3" class="d">-                    Message {
</a><a href="#h4-30-4" id="h4-30-4" class="i">+                    Envelope {
</a>                         from: 1,
                         to,
                         term: 3,
<a href="#h4-30-8" id="h4-30-8" class="d">-                        event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h4-30-9" id="h4-30-9" class="i">+                        message: Message::Heartbeat {
</a><a href="#h4-30-10" id="h4-30-10" class="i">+                            commit_index: 2,
</a><a href="#h4-30-11" id="h4-30-11" class="i">+                            commit_term: 1,
</a><a href="#h4-30-12" id="h4-30-12" class="i">+                            read_seq: 0
</a><a href="#h4-30-13" id="h4-30-13" class="i">+                        },
</a>                     }
                 );
             }
<b>diff --git a/<a id="h5" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -2,7 +2,7 @@ mod candidate;
</a> mod follower;
 mod leader;
 
<a href="#h5-0-3" id="h5-0-3" class="d">-use super::{Event, Index, Log, Message, State, ELECTION_TIMEOUT_RANGE};
</a><a href="#h5-0-4" id="h5-0-4" class="i">+use super::{Envelope, Index, Log, Message, State, ELECTION_TIMEOUT_RANGE};
</a> use crate::error::{Error, Result};
 use candidate::Candidate;
 use follower::Follower;
<a href="#h5-1" id="h5-1" class="h">@@ -49,7 +49,7 @@ impl Node {
</a>         peers: HashSet&lt;NodeID&gt;,
         log: Log,
         state: Box&lt;dyn State&gt;,
<a href="#h5-1-3" id="h5-1-3" class="d">-        node_tx: crossbeam::channel::Sender&lt;Message&gt;,
</a><a href="#h5-1-4" id="h5-1-4" class="i">+        node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a>     ) -&gt; Result&lt;Self&gt; {
         let node = RawNode::new(id, peers, log, state, node_tx)?;
         if node.peers.is_empty() {
<a href="#h5-2" id="h5-2" class="h">@@ -78,7 +78,7 @@ impl Node {
</a>     }
 
     /// Processes a message from a peer.
<a href="#h5-2-3" id="h5-2-3" class="d">-    pub fn step(self, msg: Message) -&gt; Result&lt;Self&gt; {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+    pub fn step(self, msg: Envelope) -&gt; Result&lt;Self&gt; {
</a>         debug!(&quot;Stepping {:?}&quot;, msg);
         match self {
             Node::Candidate(n) =&gt; n.step(msg),
<a href="#h5-3" id="h5-3" class="h">@@ -128,7 +128,7 @@ pub struct RawNode&lt;R: Role = Follower&gt; {
</a>     term: Term,
     log: Log,
     state: Box&lt;dyn State&gt;,
<a href="#h5-3-3" id="h5-3-3" class="d">-    node_tx: crossbeam::channel::Sender&lt;Message&gt;,
</a><a href="#h5-3-4" id="h5-3-4" class="i">+    node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a>     role: R,
 }
 
<a href="#h5-4" id="h5-4" class="h">@@ -194,18 +194,18 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>         quorum_value(values)
     }
 
<a href="#h5-4-3" id="h5-4-3" class="d">-    /// Sends an event
</a><a href="#h5-4-4" id="h5-4-4" class="d">-    fn send(&amp;self, to: NodeID, event: Event) -&gt; Result&lt;()&gt; {
</a><a href="#h5-4-5" id="h5-4-5" class="d">-        let msg = Message { term: self.term, from: self.id, to, event };
</a><a href="#h5-4-6" id="h5-4-6" class="i">+    /// Sends a message.
</a><a href="#h5-4-7" id="h5-4-7" class="i">+    fn send(&amp;self, to: NodeID, message: Message) -&gt; Result&lt;()&gt; {
</a><a href="#h5-4-8" id="h5-4-8" class="i">+        let msg = Envelope { from: self.id, to, term: self.term, message };
</a>         debug!(&quot;Sending {msg:?}&quot;);
         Ok(self.node_tx.send(msg)?)
     }
 
<a href="#h5-4-13" id="h5-4-13" class="d">-    /// Broadcasts an event to all peers.
</a><a href="#h5-4-14" id="h5-4-14" class="d">-    fn broadcast(&amp;self, event: Event) -&gt; Result&lt;()&gt; {
</a><a href="#h5-4-15" id="h5-4-15" class="i">+    /// Broadcasts a message to all peers.
</a><a href="#h5-4-16" id="h5-4-16" class="i">+    fn broadcast(&amp;self, message: Message) -&gt; Result&lt;()&gt; {
</a>         // Sort for test determinism.
         for id in self.peers.iter().copied().sorted() {
<a href="#h5-4-19" id="h5-4-19" class="d">-            self.send(id, event.clone())?;
</a><a href="#h5-4-20" id="h5-4-20" class="i">+            self.send(id, message.clone())?;
</a>         }
         Ok(())
     }
<a href="#h5-5" id="h5-5" class="h">@@ -217,7 +217,7 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>     }
 
     /// Asserts message invariants when stepping.
<a href="#h5-5-3" id="h5-5-3" class="d">-    fn assert_step(&amp;self, msg: &amp;Message) {
</a><a href="#h5-5-4" id="h5-5-4" class="i">+    fn assert_step(&amp;self, msg: &amp;Envelope) {
</a>         // Messages must be addressed to the local node.
         assert_eq!(msg.to, self.id, &quot;Message to other node&quot;);
 
<a href="#h5-6" id="h5-6" class="h">@@ -424,13 +424,13 @@ mod tests {
</a>         NodeAsserter::new(node)
     }
 
<a href="#h5-6-3" id="h5-6-3" class="d">-    fn setup_rolenode() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
</a><a href="#h5-6-4" id="h5-6-4" class="i">+    fn setup_rolenode() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a>         setup_rolenode_peers(vec![2, 3])
     }
 
     fn setup_rolenode_peers(
         peers: Vec&lt;NodeID&gt;,
<a href="#h5-6-10" id="h5-6-10" class="d">-    ) -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
</a><a href="#h5-6-11" id="h5-6-11" class="i">+    ) -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Envelope&gt;)&gt; {
</a>         let (node_tx, node_rx) = crossbeam::channel::unbounded();
         let node = RawNode {
             role: Follower::new(None, None),
<a href="#h5-7" id="h5-7" class="h">@@ -501,14 +501,14 @@ mod tests {
</a>     #[test]
     fn send() -&gt; Result&lt;()&gt; {
         let (node, mut rx) = setup_rolenode()?;
<a href="#h5-7-3" id="h5-7-3" class="d">-        node.send(2, Event::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 })?;
</a><a href="#h5-7-4" id="h5-7-4" class="i">+        node.send(2, Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 })?;
</a>         assert_messages(
             &amp;mut rx,
<a href="#h5-7-7" id="h5-7-7" class="d">-            vec![Message {
</a><a href="#h5-7-8" id="h5-7-8" class="i">+            vec![Envelope {
</a>                 from: 1,
                 to: 2,
                 term: 1,
<a href="#h5-7-12" id="h5-7-12" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a><a href="#h5-7-13" id="h5-7-13" class="i">+                message: Message::Heartbeat { commit_index: 1, commit_term: 1, read_seq: 7 },
</a>             }],
         );
         Ok(())
<b>diff --git a/<a id="h6" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -36,7 +36,7 @@ pub struct Server {
</a>     /// The inner Raft node.
     node: raft::Node,
     /// Outbound messages from the Raft node.
<a href="#h6-0-3" id="h6-0-3" class="d">-    node_rx: Receiver&lt;raft::Message&gt;,
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    node_rx: Receiver&lt;raft::Envelope&gt;,
</a>     /// Raft peer IDs and addresses.
     peers: HashMap&lt;raft::NodeID, String&gt;,
 }
<a href="#h6-1" id="h6-1" class="h">@@ -111,7 +111,7 @@ impl Server {
</a> 
     /// Accepts new inbound Raft connections from peers and spawns threads
     /// routing inbound messages to the local Raft node.
<a href="#h6-1-3" id="h6-1-3" class="d">-    fn raft_accept(listener: TcpListener, raft_step_tx: Sender&lt;raft::Message&gt;) {
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    fn raft_accept(listener: TcpListener, raft_step_tx: Sender&lt;raft::Envelope&gt;) {
</a>         std::thread::scope(|s| loop {
             let (socket, peer) = match listener.accept() {
                 Ok(sp) =&gt; sp,
<a href="#h6-2" id="h6-2" class="h">@@ -133,7 +133,7 @@ impl Server {
</a> 
     /// Receives inbound messages from a peer via TCP, and queues them for
     /// stepping into the Raft node.
<a href="#h6-2-3" id="h6-2-3" class="d">-    fn raft_receive_peer(socket: TcpStream, raft_step_tx: Sender&lt;raft::Message&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h6-2-4" id="h6-2-4" class="i">+    fn raft_receive_peer(socket: TcpStream, raft_step_tx: Sender&lt;raft::Envelope&gt;) -&gt; Result&lt;()&gt; {
</a>         let mut socket = std::io::BufReader::new(socket);
         while let Some(message) = bincode::maybe_deserialize_from(&amp;mut socket)? {
             raft_step_tx.send(message)?;
<a href="#h6-3" id="h6-3" class="h">@@ -143,7 +143,7 @@ impl Server {
</a> 
     /// Sends outbound messages to a peer via TCP. Retries indefinitely if the
     /// connection fails.
<a href="#h6-3-3" id="h6-3-3" class="d">-    fn raft_send_peer(addr: String, raft_node_rx: Receiver&lt;raft::Message&gt;) {
</a><a href="#h6-3-4" id="h6-3-4" class="i">+    fn raft_send_peer(addr: String, raft_node_rx: Receiver&lt;raft::Envelope&gt;) {
</a>         loop {
             let mut socket = match TcpStream::connect(&amp;addr) {
                 Ok(socket) =&gt; std::io::BufWriter::new(socket),
<a href="#h6-4" id="h6-4" class="h">@@ -184,9 +184,9 @@ impl Server {
</a>     /// state transitions.
     fn raft_route(
         mut node: raft::Node,
<a href="#h6-4-3" id="h6-4-3" class="d">-        node_rx: Receiver&lt;raft::Message&gt;,
</a><a href="#h6-4-4" id="h6-4-4" class="d">-        peers_rx: Receiver&lt;raft::Message&gt;,
</a><a href="#h6-4-5" id="h6-4-5" class="d">-        mut peers_tx: HashMap&lt;raft::NodeID, Sender&lt;raft::Message&gt;&gt;,
</a><a href="#h6-4-6" id="h6-4-6" class="i">+        node_rx: Receiver&lt;raft::Envelope&gt;,
</a><a href="#h6-4-7" id="h6-4-7" class="i">+        peers_rx: Receiver&lt;raft::Envelope&gt;,
</a><a href="#h6-4-8" id="h6-4-8" class="i">+        mut peers_tx: HashMap&lt;raft::NodeID, Sender&lt;raft::Envelope&gt;&gt;,
</a>         request_rx: Receiver&lt;(raft::Request, Sender&lt;Result&lt;raft::Response&gt;&gt;)&gt;,
     ) {
         // Track response channels by request ID. The Raft node will emit
<a href="#h6-5" id="h6-5" class="h">@@ -211,7 +211,7 @@ impl Server {
</a>                 recv(node_rx) -&gt; result =&gt; {
                     let msg = result.expect(&quot;node_rx disconnected&quot;);
                     if msg.to == node.id() {
<a href="#h6-5-3" id="h6-5-3" class="d">-                        if let raft::Event::ClientResponse{ id, response } = msg.event {
</a><a href="#h6-5-4" id="h6-5-4" class="i">+                        if let raft::Message::ClientResponse{ id, response } = msg.message {
</a>                             if let Some(response_tx) = response_txs.remove(&amp;id) {
                                 response_tx.send(response).expect(&quot;response_tx disconnected&quot;);
                             }
<a href="#h6-6" id="h6-6" class="h">@@ -234,11 +234,11 @@ impl Server {
</a>                 recv(request_rx) -&gt; result =&gt; {
                     let (request, response_tx) = result.expect(&quot;request_rx disconnected&quot;);
                     let id = uuid::Uuid::new_v4().into_bytes().to_vec();
<a href="#h6-6-3" id="h6-6-3" class="d">-                    let msg = raft::Message{
</a><a href="#h6-6-4" id="h6-6-4" class="i">+                    let msg = raft::Envelope{
</a>                         from: node.id(),
                         to: node.id(),
                         term: node.term(),
<a href="#h6-6-8" id="h6-6-8" class="d">-                        event: raft::Event::ClientRequest{id: id.clone(), request},
</a><a href="#h6-6-9" id="h6-6-9" class="i">+                        message: raft::Message::ClientRequest{id: id.clone(), request},
</a>                     };
                     node = node.step(msg).expect(&quot;step failed&quot;);
                     response_txs.insert(id, response_tx);
</pre>
</div>
</body>
</html>
