<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>server: buffer network IO - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/76315bdccac873b0b2dfea736deff0dee76c9d20.html">76315bdccac873b0b2dfea736deff0dee76c9d20</a>
<b>parent</b> <a href="../commit/431e91e826e129ae3f2c705cb9a2901d15508639.html">431e91e826e129ae3f2c705cb9a2901d15508639</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Fri, 12 Apr 2024 16:19:58 +0200

server: buffer network IO

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/client.rs</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/server.rs</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++</span><span class="d">--------</span></td></tr>
</table></pre><pre>2 files changed, 27 insertions(+), 13 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -6,23 +6,29 @@ use crate::sql::execution::ResultSet;
</a> use crate::sql::schema::Table;
 
 use rand::Rng;
<a href="#h0-0-3" id="h0-0-3" class="i">+use std::io::Write as _;
</a> 
 /// A toyDB client
 pub struct Client {
<a href="#h0-0-7" id="h0-0-7" class="d">-    conn: std::net::TcpStream,
</a><a href="#h0-0-8" id="h0-0-8" class="i">+    reader: std::io::BufReader&lt;std::net::TcpStream&gt;,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+    writer: std::io::BufWriter&lt;std::net::TcpStream&gt;,
</a>     txn: Option&lt;(u64, bool)&gt;,
 }
 
 impl Client {
     /// Creates a new client
     pub fn new(addr: impl std::net::ToSocketAddrs) -&gt; Result&lt;Self&gt; {
<a href="#h0-0-16" id="h0-0-16" class="d">-        Ok(Self { conn: std::net::TcpStream::connect(addr)?, txn: None })
</a><a href="#h0-0-17" id="h0-0-17" class="i">+        let socket = std::net::TcpStream::connect(addr)?;
</a><a href="#h0-0-18" id="h0-0-18" class="i">+        let reader = std::io::BufReader::new(socket.try_clone()?);
</a><a href="#h0-0-19" id="h0-0-19" class="i">+        let writer = std::io::BufWriter::new(socket);
</a><a href="#h0-0-20" id="h0-0-20" class="i">+        Ok(Self { reader, writer, txn: None })
</a>     }
 
     /// Call a server method
     fn call(&amp;mut self, request: Request) -&gt; Result&lt;Response&gt; {
<a href="#h0-0-25" id="h0-0-25" class="d">-        bincode::serialize_into(&amp;mut self.conn, &amp;request)?;
</a><a href="#h0-0-26" id="h0-0-26" class="d">-        bincode::deserialize_from(&amp;mut self.conn)?
</a><a href="#h0-0-27" id="h0-0-27" class="i">+        bincode::serialize_into(&amp;mut self.writer, &amp;request)?;
</a><a href="#h0-0-28" id="h0-0-28" class="i">+        self.writer.flush()?;
</a><a href="#h0-0-29" id="h0-0-29" class="i">+        bincode::deserialize_from(&amp;mut self.reader)?
</a>     }
 
     /// Executes a query
<a href="#h0-1" id="h0-1" class="h">@@ -35,7 +41,7 @@ impl Client {
</a>             // FIXME We buffer rows for now to avoid lifetime hassles
             let mut rows = Vec::new();
             loop {
<a href="#h0-1-3" id="h0-1-3" class="d">-                match bincode::deserialize_from::&lt;_, Result&lt;_&gt;&gt;(&amp;mut self.conn)?? {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                match bincode::deserialize_from::&lt;_, Result&lt;_&gt;&gt;(&amp;mut self.reader)?? {
</a>                     Response::Row(Some(row)) =&gt; rows.push(row),
                     Response::Row(None) =&gt; break,
                     response =&gt; {
<b>diff --git a/<a id="h1" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,5 +1,5 @@
</a> use crate::encoding::bincode;
<a href="#h1-0-1" id="h1-0-1" class="d">-use crate::error::Result;
</a><a href="#h1-0-2" id="h1-0-2" class="i">+use crate::error::{Error, Result};
</a> use crate::raft;
 use crate::sql;
 use crate::sql::engine::Engine as _;
<a href="#h1-1" id="h1-1" class="h">@@ -11,6 +11,7 @@ use crossbeam::channel::{Receiver, Sender};
</a> use log::{debug, error, info};
 use serde_derive::{Deserialize, Serialize};
 use std::collections::HashMap;
<a href="#h1-1-3" id="h1-1-3" class="i">+use std::io::Write as _;
</a> use std::net::{TcpListener, TcpStream, ToSocketAddrs};
 
 /// The outbound Raft peer channel capacity. This buffers messages when a Raft
<a href="#h1-2" id="h1-2" class="h">@@ -130,7 +131,8 @@ impl Server {
</a> 
     /// Receives inbound messages from a peer via TCP, and queues them for
     /// stepping into the Raft node.
<a href="#h1-2-3" id="h1-2-3" class="d">-    fn raft_receive_peer(mut socket: TcpStream, raft_step_tx: Sender&lt;raft::Message&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    fn raft_receive_peer(socket: TcpStream, raft_step_tx: Sender&lt;raft::Message&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h1-2-5" id="h1-2-5" class="i">+        let mut socket = std::io::BufReader::new(socket);
</a>         while let Some(message) = bincode::maybe_deserialize_from(&amp;mut socket)? {
             raft_step_tx.send(message)?;
         }
<a href="#h1-3" id="h1-3" class="h">@@ -142,7 +144,7 @@ impl Server {
</a>     fn raft_send_peer(addr: String, raft_node_rx: Receiver&lt;raft::Message&gt;) {
         loop {
             let mut socket = match TcpStream::connect(&amp;addr) {
<a href="#h1-3-3" id="h1-3-3" class="d">-                Ok(s) =&gt; s,
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                Ok(socket) =&gt; std::io::BufWriter::new(socket),
</a>                 Err(err) =&gt; {
                     error!(&quot;Failed connecting to Raft peer {addr}: {err}&quot;);
                     std::thread::sleep(RAFT_PEER_RETRY_INTERVAL);
<a href="#h1-4" id="h1-4" class="h">@@ -150,7 +152,9 @@ impl Server {
</a>                 }
             };
             while let Ok(message) = raft_node_rx.recv() {
<a href="#h1-4-3" id="h1-4-3" class="d">-                if let Err(err) = bincode::serialize_into(&amp;mut socket, &amp;message) {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+                if let Err(err) = bincode::serialize_into(&amp;mut socket, &amp;message)
</a><a href="#h1-4-5" id="h1-4-5" class="i">+                    .and_then(|()| socket.flush().map_err(Error::from))
</a><a href="#h1-4-6" id="h1-4-6" class="i">+                {
</a>                     error!(&quot;Failed sending to Raft peer {addr}: {err}&quot;);
                     break;
                 }
<a href="#h1-5" id="h1-5" class="h">@@ -260,11 +264,14 @@ impl Server {
</a>     /// Processes a client SQL session, by executing SQL statements against the
     /// Raft node.
     fn sql_session(
<a href="#h1-5-3" id="h1-5-3" class="d">-        mut socket: TcpStream,
</a><a href="#h1-5-4" id="h1-5-4" class="i">+        socket: TcpStream,
</a>         raft_request_tx: Sender&lt;(raft::Request, Sender&lt;Result&lt;raft::Response&gt;&gt;)&gt;,
     ) -&gt; Result&lt;()&gt; {
         let mut session = sql::engine::Raft::new(raft_request_tx).session();
<a href="#h1-5-8" id="h1-5-8" class="d">-        while let Some(request) = bincode::maybe_deserialize_from(&amp;mut socket)? {
</a><a href="#h1-5-9" id="h1-5-9" class="i">+        let mut reader = std::io::BufReader::new(socket.try_clone()?);
</a><a href="#h1-5-10" id="h1-5-10" class="i">+        let mut writer = std::io::BufWriter::new(socket);
</a><a href="#h1-5-11" id="h1-5-11" class="i">+
</a><a href="#h1-5-12" id="h1-5-12" class="i">+        while let Some(request) = bincode::maybe_deserialize_from(&amp;mut reader)? {
</a>             // Execute request.
             debug!(&quot;Received request {request:?}&quot;);
             let mut response = match request {
<a href="#h1-6" id="h1-6" class="h">@@ -302,10 +309,11 @@ impl Server {
</a>                 );
             }
 
<a href="#h1-6-3" id="h1-6-3" class="d">-            bincode::serialize_into(&amp;mut socket, &amp;response)?;
</a><a href="#h1-6-4" id="h1-6-4" class="i">+            bincode::serialize_into(&amp;mut writer, &amp;response)?;
</a>             for row in rows {
<a href="#h1-6-6" id="h1-6-6" class="d">-                bincode::serialize_into(&amp;mut socket, &amp;row)?;
</a><a href="#h1-6-7" id="h1-6-7" class="i">+                bincode::serialize_into(&amp;mut writer, &amp;row)?;
</a>             }
<a href="#h1-6-9" id="h1-6-9" class="i">+            writer.flush()?;
</a>         }
         Ok(())
     }
</pre>
</div>
</body>
</html>
