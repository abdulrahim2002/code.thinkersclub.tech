<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>fix a bunch of FIXMEs - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/600baa97360fc001c41850440d18306606e7e628.html">600baa97360fc001c41850440d18306606e7e628</a>
<b>parent</b> <a href="../commit/a082d65732cff3f394b03d866ecc92a3bffa19ab.html">a082d65732cff3f394b03d866ecc92a3bffa19ab</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue,  9 Jun 2020 21:26:50 +0200

fix a bunch of FIXMEs

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/execution/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/execution/mutation.rs</a></td><td> | </td><td class="num">16</td><td><span class="i">++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/plan/mod.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/plan/planner.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/types/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/storage/kv/mvcc.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">tests/sql/mutation/update_missing_column_set</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>8 files changed, 27 insertions(+), 29 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -83,8 +83,6 @@ impl Transaction {
</a>     }
 
     /// Saves an index entry.
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// FIXME We save the index key as part of the value, to avoid having to implement key decoders
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    /// right now.
</a>     fn index_save(
         &amp;mut self,
         table: &amp;str,
<b>diff --git a/<a id="h1" href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a> b/<a href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -62,9 +62,11 @@ impl&lt;T: Transaction + &#39;static&gt; dyn Executor&lt;T&gt; {
</a>                 Projection::new(Self::build(*source), expressions)
             }
             Node::Scan { table, filter, alias: _ } =&gt; Scan::new(table, filter),
<a href="#h1-0-3" id="h1-0-3" class="d">-            Node::Update { table, source, expressions } =&gt; {
</a><a href="#h1-0-4" id="h1-0-4" class="d">-                Update::new(table, Self::build(*source), expressions)
</a><a href="#h1-0-5" id="h1-0-5" class="d">-            }
</a><a href="#h1-0-6" id="h1-0-6" class="i">+            Node::Update { table, source, expressions } =&gt; Update::new(
</a><a href="#h1-0-7" id="h1-0-7" class="i">+                table,
</a><a href="#h1-0-8" id="h1-0-8" class="i">+                Self::build(*source),
</a><a href="#h1-0-9" id="h1-0-9" class="i">+                expressions.into_iter().map(|(i, _, e)| (i, e)).collect(),
</a><a href="#h1-0-10" id="h1-0-10" class="i">+            ),
</a>         }
     }
 }
<b>diff --git a/<a id="h2" href="../file/src/sql/execution/mutation.rs.html">src/sql/execution/mutation.rs</a> b/<a href="../file/src/sql/execution/mutation.rs.html">src/sql/execution/mutation.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -4,7 +4,7 @@ use super::super::types::{Expression, Row, Value};
</a> use super::{Executor, ResultSet};
 use crate::error::{Error, Result};
 
<a href="#h2-0-3" id="h2-0-3" class="d">-use std::collections::{BTreeMap, HashMap, HashSet};
</a><a href="#h2-0-4" id="h2-0-4" class="i">+use std::collections::{HashMap, HashSet};
</a> 
 /// An INSERT executor
 pub struct Insert {
<a href="#h2-1" id="h2-1" class="h">@@ -79,25 +79,17 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Insert {
</a> pub struct Update&lt;T: Transaction&gt; {
     table: String,
     source: Box&lt;dyn Executor&lt;T&gt;&gt;,
<a href="#h2-1-3" id="h2-1-3" class="d">-    /// FIXME Uses BTreeMap instead of HashMap for test stability
</a><a href="#h2-1-4" id="h2-1-4" class="d">-    expressions: BTreeMap&lt;String, Expression&gt;,
</a><a href="#h2-1-5" id="h2-1-5" class="i">+    expressions: Vec&lt;(usize, Expression)&gt;,
</a> }
 
 impl&lt;T: Transaction&gt; Update&lt;T&gt; {
     pub fn new(
         table: String,
         source: Box&lt;dyn Executor&lt;T&gt;&gt;,
<a href="#h2-1-12" id="h2-1-12" class="d">-        expressions: BTreeMap&lt;String, Expression&gt;,
</a><a href="#h2-1-13" id="h2-1-13" class="i">+        expressions: Vec&lt;(usize, Expression)&gt;,
</a>     ) -&gt; Box&lt;Self&gt; {
         Box::new(Self { table, source, expressions })
     }
<a href="#h2-1-17" id="h2-1-17" class="d">-
</a><a href="#h2-1-18" id="h2-1-18" class="d">-    /// Sets a named row field to a value
</a><a href="#h2-1-19" id="h2-1-19" class="d">-    pub fn set_row_field(table: &amp;Table, row: &amp;mut Row, field: &amp;str, value: Value) -&gt; Result&lt;()&gt; {
</a><a href="#h2-1-20" id="h2-1-20" class="d">-        *row.get_mut(table.get_column_index(field)?)
</a><a href="#h2-1-21" id="h2-1-21" class="d">-            .ok_or_else(|| Error::Value(format!(&quot;Field {} not found in row&quot;, field)))? = value;
</a><a href="#h2-1-22" id="h2-1-22" class="d">-        Ok(())
</a><a href="#h2-1-23" id="h2-1-23" class="d">-    }
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
<a href="#h2-2" id="h2-2" class="h">@@ -121,7 +113,7 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
</a>                     }
                     let mut new = row.clone();
                     for (field, expr) in &amp;self.expressions {
<a href="#h2-2-3" id="h2-2-3" class="d">-                        Self::set_row_field(&amp;table, &amp;mut new, field, expr.evaluate(Some(&amp;row))?)?;
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                        new[*field] = expr.evaluate(Some(&amp;row))?;
</a>                     }
                     txn.update(&amp;table.name, &amp;id, new)?;
                     updated.insert(id);
<b>diff --git a/<a id="h3" href="../file/src/sql/plan/mod.rs.html">src/sql/plan/mod.rs</a> b/<a href="../file/src/sql/plan/mod.rs.html">src/sql/plan/mod.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -11,7 +11,6 @@ use super::types::{Expression, Value};
</a> use crate::error::Result;
 
 use serde_derive::{Deserialize, Serialize};
<a href="#h3-0-3" id="h3-0-3" class="d">-use std::collections::BTreeMap;
</a> use std::fmt::{self, Display};
 
 /// A query plan
<a href="#h3-1" id="h3-1" class="h">@@ -120,11 +119,10 @@ pub enum Node {
</a>         alias: Option&lt;String&gt;,
         filter: Option&lt;Expression&gt;,
     },
<a href="#h3-1-3" id="h3-1-3" class="d">-    // Uses BTreeMap for test stability
</a>     Update {
         table: String,
         source: Box&lt;Node&gt;,
<a href="#h3-1-7" id="h3-1-7" class="d">-        expressions: BTreeMap&lt;String, Expression&gt;,
</a><a href="#h3-1-8" id="h3-1-8" class="i">+        expressions: Vec&lt;(usize, Option&lt;String&gt;, Expression)&gt;,
</a>     },
 }
 
<a href="#h3-2" id="h3-2" class="h">@@ -251,7 +249,7 @@ impl Node {
</a>                 source,
                 expressions: expressions
                     .into_iter()
<a href="#h3-2-3" id="h3-2-3" class="d">-                    .map(|(k, e)| e.transform(before, after).map(|e| (k, e)))
</a><a href="#h3-2-4" id="h3-2-4" class="i">+                    .map(|(i, l, e)| e.transform(before, after).map(|e| (i, l, e)))
</a>                     .collect::&lt;Result&lt;_&gt;&gt;()?,
             },
         })
<a href="#h3-3" id="h3-3" class="h">@@ -399,7 +397,11 @@ impl Node {
</a>                     table,
                     expressions
                         .iter()
<a href="#h3-3-3" id="h3-3-3" class="d">-                        .map(|(l, e)| format!(&quot;{}={}&quot;, l, e))
</a><a href="#h3-3-4" id="h3-3-4" class="i">+                        .map(|(i, l, e)| format!(
</a><a href="#h3-3-5" id="h3-3-5" class="i">+                            &quot;{}={}&quot;,
</a><a href="#h3-3-6" id="h3-3-6" class="i">+                            l.clone().unwrap_or_else(|| format!(&quot;#{}&quot;, i)),
</a><a href="#h3-3-7" id="h3-3-7" class="i">+                            e
</a><a href="#h3-3-8" id="h3-3-8" class="i">+                        ))
</a>                         .collect::&lt;Vec&lt;_&gt;&gt;()
                         .join(&quot;,&quot;)
                 );
<b>diff --git a/<a id="h4" href="../file/src/sql/plan/planner.rs.html">src/sql/plan/planner.rs</a> b/<a href="../file/src/sql/plan/planner.rs.html">src/sql/plan/planner.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -106,7 +106,13 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>                     }),
                     expressions: set
                         .into_iter()
<a href="#h4-0-3" id="h4-0-3" class="d">-                        .map(|(c, e)| self.build_expression(scope, e).map(|e| (c, e)))
</a><a href="#h4-0-4" id="h4-0-4" class="i">+                        .map(|(c, e)| {
</a><a href="#h4-0-5" id="h4-0-5" class="i">+                            Ok((
</a><a href="#h4-0-6" id="h4-0-6" class="i">+                                scope.resolve(None, &amp;c)?,
</a><a href="#h4-0-7" id="h4-0-7" class="i">+                                Some(c),
</a><a href="#h4-0-8" id="h4-0-8" class="i">+                                self.build_expression(scope, e)?,
</a><a href="#h4-0-9" id="h4-0-9" class="i">+                            ))
</a><a href="#h4-0-10" id="h4-0-10" class="i">+                        })
</a>                         .collect::&lt;Result&lt;_&gt;&gt;()?,
                 }
             }
<b>diff --git a/<a id="h5" href="../file/src/sql/types/mod.rs.html">src/sql/types/mod.rs</a> b/<a href="../file/src/sql/types/mod.rs.html">src/sql/types/mod.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -48,7 +48,7 @@ impl Hash for Value {
</a>             Value::Null =&gt; self.hash(state),
             Value::Boolean(v) =&gt; v.hash(state),
             Value::Integer(v) =&gt; v.hash(state),
<a href="#h5-0-3" id="h5-0-3" class="d">-            Value::Float(v) =&gt; v.to_be_bytes().hash(state), // FIXME Is this sane?
</a><a href="#h5-0-4" id="h5-0-4" class="i">+            Value::Float(v) =&gt; v.to_be_bytes().hash(state),
</a>             Value::String(v) =&gt; v.hash(state),
         }
     }
<b>diff --git a/<a id="h6" href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a> b/<a href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -19,12 +19,10 @@ pub struct Status {
</a> 
 /// An MVCC-based transactional key-value store.
 pub struct MVCC {
<a href="#h6-0-3" id="h6-0-3" class="d">-    /// The underlying KV store. It is protected by a mutex so it can be shared between multiple
</a><a href="#h6-0-4" id="h6-0-4" class="d">-    /// transactions.
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    /// The underlying KV store. It is protected by a mutex so it can be shared between txns.
</a>     store: Arc&lt;RwLock&lt;Box&lt;dyn Store&gt;&gt;&gt;,
 }
 
<a href="#h6-0-9" id="h6-0-9" class="d">-// FIXME Implement Clone manually due to https://github.com/rust-lang/rust/issues/26925
</a> impl Clone for MVCC {
     fn clone(&amp;self) -&gt; Self {
         MVCC { store: self.store.clone() }
<a href="#h6-1" id="h6-1" class="h">@@ -1151,7 +1149,7 @@ pub mod tests {
</a>         assert_eq!(Some(b&quot;1&quot;.to_vec()), t1.get(b&quot;a&quot;)?);
         assert_eq!(Some(b&quot;2&quot;.to_vec()), t2.get(b&quot;b&quot;)?);
 
<a href="#h6-1-3" id="h6-1-3" class="d">-        // FIXME Some of the following operations should error
</a><a href="#h6-1-4" id="h6-1-4" class="i">+        // Some of the following operations should error
</a>         t1.set(b&quot;a&quot;, b&quot;2&quot;.to_vec())?;
         t2.set(b&quot;b&quot;, b&quot;1&quot;.to_vec())?;
 
<b>diff --git a/<a id="h7" href="../file/tests/sql/mutation/update_missing_column_set.html">tests/sql/mutation/update_missing_column_set</a> b/<a href="../file/tests/sql/mutation/update_missing_column_set.html">tests/sql/mutation/update_missing_column_set</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,5 +1,5 @@
</a> Query: UPDATE test SET missing = 0
<a href="#h7-0-1" id="h7-0-1" class="d">-Error: Value(&quot;Column missing not found in table test&quot;)
</a><a href="#h7-0-2" id="h7-0-2" class="i">+Error: Value(&quot;Unknown field missing&quot;)
</a> 
 Storage:
 CREATE TABLE other (
</pre>
</div>
</body>
</html>
