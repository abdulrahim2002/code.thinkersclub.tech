<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: improve formatting of `Remap` nodes - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7b83b2634654bad012a18ebcd1c5a7ad61cab8db.html">7b83b2634654bad012a18ebcd1c5a7ad61cab8db</a>
<b>parent</b> <a href="../commit/53fb0e9075c00ae404cc4f5607b8773a58e89584.html">53fb0e9075c00ae404cc4f5607b8773a58e89584</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 16 Jul 2024 22:57:05 +0200

sql: improve formatting of `Remap` nodes

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/testscripts/queries/having</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/testscripts/queries/join_inner</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/testscripts/queries/join_outer</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/testscripts/queries/order</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
</table></pre><pre>5 files changed, 32 insertions(+), 21 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -510,13 +510,24 @@ impl Node {
</a>             Self::Remap { source, targets } =&gt; {
                 let remap = remap_sources(targets)
                     .into_iter()
<a href="#h0-0-3" id="h0-0-3" class="d">-                    .map(|from| from.map(|from| format!(&quot;#{from}&quot;)).unwrap_or(&quot;Null&quot;.to_string()))
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                    .map(|from| {
</a><a href="#h0-0-5" id="h0-0-5" class="i">+                        from.map(|from| match source.column_label(from) {
</a><a href="#h0-0-6" id="h0-0-6" class="i">+                            Label::None =&gt; format!(&quot;#{from}&quot;),
</a><a href="#h0-0-7" id="h0-0-7" class="i">+                            label =&gt; format!(&quot;{label}&quot;),
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                        })
</a><a href="#h0-0-9" id="h0-0-9" class="i">+                        .unwrap_or(&quot;Null&quot;.to_string())
</a><a href="#h0-0-10" id="h0-0-10" class="i">+                    })
</a>                     .join(&quot;, &quot;);
                 write!(f, &quot;Remap: {remap}&quot;)?;
                 let dropped = targets
                     .iter()
                     .enumerate()
<a href="#h0-0-16" id="h0-0-16" class="d">-                    .filter_map(|(i, v)| v.is_none().then_some(format!(&quot;#{i}&quot;)))
</a><a href="#h0-0-17" id="h0-0-17" class="i">+                    .filter_map(|(i, v)| {
</a><a href="#h0-0-18" id="h0-0-18" class="i">+                        v.is_none().then_some(match source.column_label(i) {
</a><a href="#h0-0-19" id="h0-0-19" class="i">+                            Label::None =&gt; format!(&quot;#{i}&quot;),
</a><a href="#h0-0-20" id="h0-0-20" class="i">+                            label =&gt; format!(&quot;{label}&quot;),
</a><a href="#h0-0-21" id="h0-0-21" class="i">+                        })
</a><a href="#h0-0-22" id="h0-0-22" class="i">+                    })
</a>                     .join(&quot;, &quot;);
                 if !dropped.is_empty() {
                     write!(f, &quot; (dropped: {dropped})&quot;)?;
<b>diff --git a/<a id="h1" href="../file/src/sql/testscripts/queries/having.html">src/sql/testscripts/queries/having</a> b/<a href="../file/src/sql/testscripts/queries/having.html">src/sql/testscripts/queries/having</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -46,7 +46,7 @@ b, 42
</a> 
 [plan]&gt; SELECT &quot;group&quot; FROM test GROUP BY &quot;group&quot; HAVING MAX(&quot;int&quot;) &gt; 10
 ---
<a href="#h1-0-3" id="h1-0-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h1-0-4" id="h1-0-4" class="i">+Remap: test.group (dropped: #1)
</a> └─ Filter: #1 &gt; 10
    └─ Aggregate: test.group, max(test.int)
       └─ Scan: test
<a href="#h1-1" id="h1-1" class="h">@@ -54,7 +54,7 @@ b
</a> 
 [plan]&gt; SELECT &quot;group&quot;, MAX(&quot;int&quot;) FROM test GROUP BY &quot;group&quot; HAVING MAX(&quot;int&quot;) - MIN(&quot;int&quot;) &gt; 10
 ---
<a href="#h1-1-3" id="h1-1-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h1-1-4" id="h1-1-4" class="i">+Remap: test.group, #1 (dropped: #2)
</a> └─ Filter: #1 - #2 &gt; 10
    └─ Aggregate: test.group, max(test.int), min(test.int)
       └─ Scan: test
<a href="#h1-2" id="h1-2" class="h">@@ -72,7 +72,7 @@ b, 42
</a> # Having works with an aggregate function not in the SELECT clause.
 [plan]&gt; SELECT &quot;group&quot;, COUNT(*) FROM test GROUP BY &quot;group&quot; HAVING MAX(&quot;int&quot;) &gt; 10
 ---
<a href="#h1-2-3" id="h1-2-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h1-2-4" id="h1-2-4" class="i">+Remap: test.group, #1 (dropped: #2)
</a> └─ Filter: #2 &gt; 10
    └─ Aggregate: test.group, count(TRUE), max(test.int)
       └─ Scan: test
<a href="#h1-3" id="h1-3" class="h">@@ -81,7 +81,7 @@ b, 3
</a> # Having works with compound expressions.
 [plan]&gt; SELECT &quot;group&quot;, COUNT(*) FROM test GROUP BY &quot;group&quot; HAVING MAX(&quot;int&quot;) / COUNT(*) &gt; 3
 ---
<a href="#h1-3-3" id="h1-3-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h1-3-4" id="h1-3-4" class="i">+Remap: test.group, #1 (dropped: #2)
</a> └─ Filter: #2 / #1 &gt; 3
    └─ Aggregate: test.group, count(TRUE), max(test.int)
       └─ Scan: test
<a href="#h1-4" id="h1-4" class="h">@@ -102,7 +102,7 @@ Remap: #0 (dropped: #1)
</a> # Having can use (un)qualified expressions for an (un)qualified GROUP BY.
 [plan]&gt; SELECT COUNT(*) FROM test GROUP BY &quot;group&quot; HAVING test.&quot;group&quot; = &#39;a&#39;
 ---
<a href="#h1-4-3" id="h1-4-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h1-4-4" id="h1-4-4" class="i">+Remap: #0 (dropped: test.group)
</a> └─ Filter: test.group = a
    └─ Projection: #1, test.group
       └─ Aggregate: test.group, count(TRUE)
<a href="#h1-5" id="h1-5" class="h">@@ -111,7 +111,7 @@ Remap: #0 (dropped: #1)
</a> 
 [plan]&gt; SELECT COUNT(*) FROM test GROUP BY test.&quot;group&quot; HAVING &quot;group&quot; = &#39;a&#39;
 ---
<a href="#h1-5-3" id="h1-5-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h1-5-4" id="h1-5-4" class="i">+Remap: #0 (dropped: test.group)
</a> └─ Filter: test.group = a
    └─ Projection: #1, test.group
       └─ Aggregate: test.group, count(TRUE)
<b>diff --git a/<a id="h2" href="../file/src/sql/testscripts/queries/join_inner.html">src/sql/testscripts/queries/join_inner</a> b/<a href="../file/src/sql/testscripts/queries/join_inner.html">src/sql/testscripts/queries/join_inner</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -221,7 +221,7 @@ Error: invalid input: unknown field movies.unknown_id
</a>   WHERE m.studio_id = s.id \
   ORDER BY m.rating DESC, m.released ASC, m.id ASC
 ---
<a href="#h2-0-3" id="h2-0-3" class="d">-Remap: #0, #1, #2, #3, #4 (dropped: #5)
</a><a href="#h2-0-4" id="h2-0-4" class="i">+Remap: m.id, m.title, genre, studio, m.rating (dropped: m.released)
</a> └─ Order: m.rating desc, m.released asc, m.id asc
    └─ Projection: m.id, m.title, g.name as genre, s.name as studio, m.rating, m.released
       └─ HashJoin: inner on m.studio_id = s.id
<b>diff --git a/<a id="h3" href="../file/src/sql/testscripts/queries/join_outer.html">src/sql/testscripts/queries/join_outer</a> b/<a href="../file/src/sql/testscripts/queries/join_outer.html">src/sql/testscripts/queries/join_outer</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -70,7 +70,7 @@ HashJoin: outer on movies.id = genres.id
</a> # Right join.
 [plan]&gt; SELECT * FROM genres RIGHT JOIN movies ON movies.id = genres.id
 ---
<a href="#h3-0-3" id="h3-0-3" class="d">-Remap: #7, #8, #0, #1, #2, #3, #4, #5, #6
</a><a href="#h3-0-4" id="h3-0-4" class="i">+Remap: genres.id, genres.name, movies.id, movies.title, movies.studio_id, movies.genre_id, movies.released, movies.rating, movies.ultrahd
</a> └─ HashJoin: outer on movies.id = genres.id
    ├─ Scan: movies
    └─ Scan: genres
<a href="#h3-1" id="h3-1" class="h">@@ -104,7 +104,7 @@ HashJoin: outer on movies.id = genres.id
</a> 
 [plan]&gt; SELECT * FROM genres RIGHT OUTER JOIN movies ON movies.id = genres.id
 ---
<a href="#h3-1-3" id="h3-1-3" class="d">-Remap: #7, #8, #0, #1, #2, #3, #4, #5, #6
</a><a href="#h3-1-4" id="h3-1-4" class="i">+Remap: genres.id, genres.name, movies.id, movies.title, movies.studio_id, movies.genre_id, movies.released, movies.rating, movies.ultrahd
</a> └─ HashJoin: outer on movies.id = genres.id
    ├─ Scan: movies
    └─ Scan: genres
<a href="#h3-2" id="h3-2" class="h">@@ -131,7 +131,7 @@ HashJoin: outer on genres.id = movies.id
</a> 
 [plan]&gt; SELECT * FROM movies RIGHT JOIN genres ON movies.id = genres.id
 ---
<a href="#h3-2-3" id="h3-2-3" class="d">-Remap: #2, #3, #4, #5, #6, #7, #8, #0, #1
</a><a href="#h3-2-4" id="h3-2-4" class="i">+Remap: movies.id, movies.title, movies.studio_id, movies.genre_id, movies.released, movies.rating, movies.ultrahd, genres.id, genres.name
</a> └─ HashJoin: outer on genres.id = movies.id
    ├─ Scan: genres
    └─ Scan: movies
<a href="#h3-3" id="h3-3" class="h">@@ -164,7 +164,7 @@ NestedLoopJoin: outer on genres.id &gt; movies.id OR genres.id = movies.id
</a>     LEFT JOIN genres ON studios.id = genres.id \
     RIGHT JOIN movies ON movies.id = studios.id
 ---
<a href="#h3-3-3" id="h3-3-3" class="d">-Remap: #7, #8, #9, #10, #11, #0, #1, #2, #3, #4, #5, #6
</a><a href="#h3-3-4" id="h3-3-4" class="i">+Remap: studios.id, studios.name, studios.country_id, genres.id, genres.name, movies.id, movies.title, movies.studio_id, movies.genre_id, movies.released, movies.rating, movies.ultrahd
</a> └─ HashJoin: outer on movies.id = studios.id
    ├─ Scan: movies
    └─ HashJoin: outer on studios.id = genres.id
<b>diff --git a/<a id="h4" href="../file/src/sql/testscripts/queries/order.html">src/sql/testscripts/queries/order</a> b/<a href="../file/src/sql/testscripts/queries/order.html">src/sql/testscripts/queries/order</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -258,7 +258,7 @@ Order: test.float ^ 2 asc
</a> # only result in one hidden column.
 [plan]&gt; SELECT id, &quot;int&quot; FROM test ORDER BY &quot;bool&quot; DESC
 ---
<a href="#h4-0-3" id="h4-0-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h4-0-4" id="h4-0-4" class="i">+Remap: test.id, test.int (dropped: test.bool)
</a> └─ Order: test.bool desc
    └─ Projection: test.id, test.int, test.bool
       └─ Scan: test
<a href="#h4-1" id="h4-1" class="h">@@ -275,7 +275,7 @@ Remap: #0, #1 (dropped: #2)
</a> 
 [plan]&gt; SELECT id, &quot;int&quot; FROM test ORDER BY &quot;bool&quot; DESC, &quot;bool&quot; ASC
 ---
<a href="#h4-1-3" id="h4-1-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h4-1-4" id="h4-1-4" class="i">+Remap: test.id, test.int (dropped: test.bool)
</a> └─ Order: test.bool desc, test.bool asc
    └─ Projection: test.id, test.int, test.bool
       └─ Scan: test
<a href="#h4-2" id="h4-2" class="h">@@ -293,7 +293,7 @@ Remap: #0, #1 (dropped: #2)
</a> # Can order on expressions on columns not in the result.
 [plan]&gt; SELECT id FROM test ORDER BY &quot;float&quot; ^ 2 - &quot;int&quot; ^ 2 DESC
 ---
<a href="#h4-2-3" id="h4-2-3" class="d">-Remap: #0 (dropped: #1, #2)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+Remap: test.id (dropped: test.float, test.int)
</a> └─ Order: test.float ^ 2 - test.int ^ 2 desc
    └─ Projection: test.id, test.float, test.int
       └─ Scan: test
<a href="#h4-3" id="h4-3" class="h">@@ -373,7 +373,7 @@ Order: int desc
</a> 
 [plan]&gt; SELECT id AS &quot;int&quot; FROM test ORDER BY test.&quot;int&quot; DESC
 ---
<a href="#h4-3-3" id="h4-3-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h4-3-4" id="h4-3-4" class="i">+Remap: int (dropped: test.int)
</a> └─ Order: test.int desc
    └─ Projection: test.id as int, test.int
       └─ Scan: test
<a href="#h4-4" id="h4-4" class="h">@@ -481,7 +481,7 @@ FALSE, -1
</a> 
 [plan]&gt; SELECT &quot;bool&quot; FROM test GROUP BY &quot;bool&quot; ORDER BY MAX(&quot;int&quot;) DESC
 ---
<a href="#h4-4-3" id="h4-4-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h4-4-4" id="h4-4-4" class="i">+Remap: test.bool (dropped: #1)
</a> └─ Order: #1 desc
    └─ Aggregate: test.bool, max(test.int)
       └─ Scan: test
<a href="#h4-5" id="h4-5" class="h">@@ -491,7 +491,7 @@ FALSE
</a> 
 [plan]&gt; SELECT &quot;bool&quot;, MAX(&quot;int&quot;) FROM test GROUP BY &quot;bool&quot; ORDER BY MAX(&quot;int&quot;) - MIN(&quot;int&quot;) DESC
 ---
<a href="#h4-5-3" id="h4-5-3" class="d">-Remap: #0, #1 (dropped: #2)
</a><a href="#h4-5-4" id="h4-5-4" class="i">+Remap: test.bool, #1 (dropped: #2)
</a> └─ Order: #1 - #2 desc
    └─ Aggregate: test.bool, max(test.int), min(test.int)
       └─ Scan: test
<a href="#h4-6" id="h4-6" class="h">@@ -514,7 +514,7 @@ Remap: #0 (dropped: #1)
</a> # ORDER BY can use (un)qualified expressions for an (un)qualified GROUP BY.
 [plan]&gt; SELECT COUNT(*) FROM test GROUP BY &quot;bool&quot; ORDER BY test.&quot;bool&quot;
 ---
<a href="#h4-6-3" id="h4-6-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h4-6-4" id="h4-6-4" class="i">+Remap: #0 (dropped: test.bool)
</a> └─ Order: test.bool asc
    └─ Projection: #1, test.bool
       └─ Aggregate: test.bool, count(TRUE)
<a href="#h4-7" id="h4-7" class="h">@@ -525,7 +525,7 @@ Remap: #0 (dropped: #1)
</a> 
 [plan]&gt; SELECT COUNT(*) FROM test GROUP BY test.&quot;bool&quot; ORDER BY &quot;bool&quot;
 ---
<a href="#h4-7-3" id="h4-7-3" class="d">-Remap: #0 (dropped: #1)
</a><a href="#h4-7-4" id="h4-7-4" class="i">+Remap: #0 (dropped: test.bool)
</a> └─ Order: test.bool asc
    └─ Projection: #1, test.bool
       └─ Aggregate: test.bool, count(TRUE)
</pre>
</div>
</body>
</html>
