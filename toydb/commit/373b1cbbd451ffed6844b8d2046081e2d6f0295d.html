<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add lifetime for storage::kv::Scan borrows - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/373b1cbbd451ffed6844b8d2046081e2d6f0295d.html">373b1cbbd451ffed6844b8d2046081e2d6f0295d</a>
<b>parent</b> <a href="../commit/5e0984478013e6b22dea9d7226c2722121a82196.html">5e0984478013e6b22dea9d7226c2722121a82196</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Wed, 23 Aug 2023 22:25:48 +0200

Add lifetime for storage::kv::Scan borrows

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/storage/kv/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/storage/kv/mvcc.rs</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/storage/kv/std_memory.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+</span><span class="d">-------</span></td></tr>
</table></pre><pre>4 files changed, 19 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -208,7 +208,9 @@ impl super::Transaction for Transaction {
</a>                         None =&gt; Some(Ok(row)),
                     },
                     err =&gt; Some(err),
<a href="#h0-0-3" id="h0-0-3" class="d">-                }),
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                })
</a><a href="#h0-0-5" id="h0-0-5" class="i">+                .collect::&lt;Vec&lt;_&gt;&gt;()
</a><a href="#h0-0-6" id="h0-0-6" class="i">+                .into_iter(),
</a>         ))
     }
 
<a href="#h0-1" id="h0-1" class="h">@@ -230,7 +232,9 @@ impl super::Transaction for Transaction {
</a>                         _ =&gt; return Err(Error::Internal(&quot;Invalid index key&quot;.into())),
                     };
                     Ok((value, deserialize(&amp;v)?))
<a href="#h0-1-3" id="h0-1-3" class="d">-                }),
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                })
</a><a href="#h0-1-5" id="h0-1-5" class="i">+                .collect::&lt;Vec&lt;_&gt;&gt;()
</a><a href="#h0-1-6" id="h0-1-6" class="i">+                .into_iter(),
</a>         ))
     }
 
<b>diff --git a/<a id="h1" href="../file/src/storage/kv/mod.rs.html">src/storage/kv/mod.rs</a> b/<a href="../file/src/storage/kv/mod.rs.html">src/storage/kv/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -91,7 +91,7 @@ impl RangeBounds&lt;Vec&lt;u8&gt;&gt; for Range {
</a> }
 
 /// Iterator over a key/value range.
<a href="#h1-0-3" id="h1-0-3" class="d">-pub type Scan = Box&lt;dyn DoubleEndedIterator&lt;Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;&gt; + Send&gt;;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+pub type Scan&lt;&#39;a&gt; = Box&lt;dyn DoubleEndedIterator&lt;Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;&gt; + Send + &#39;a&gt;;
</a> 
 #[cfg(test)]
 trait TestSuite&lt;S: Store&gt; {
<b>diff --git a/<a id="h2" href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a> b/<a href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -70,6 +70,7 @@ impl MVCC {
</a>     pub fn status(&amp;self) -&gt; Result&lt;Status&gt; {
         let mut store = self.store.lock()?;
         return Ok(Status {
<a href="#h2-0-3" id="h2-0-3" class="i">+            storage: store.to_string(),
</a>             txns: match store.get(&amp;Key::TxnNext.encode())? {
                 Some(ref v) =&gt; deserialize(v)?,
                 None =&gt; 1,
<a href="#h2-1" id="h2-1" class="h">@@ -79,7 +80,6 @@ impl MVCC {
</a>                     Key::TxnActive(0).encode()..Key::TxnActive(std::u64::MAX).encode(),
                 ))
                 .try_fold(0, |count, r| r.map(|_| count + 1))?,
<a href="#h2-1-3" id="h2-1-3" class="d">-            storage: store.to_string(),
</a>         });
     }
 }
<a href="#h2-2" id="h2-2" class="h">@@ -224,7 +224,10 @@ impl Transaction {
</a>             Bound::Included(k) =&gt; Bound::Included(Key::Record(k.into(), std::u64::MAX).encode()),
             Bound::Unbounded =&gt; Bound::Unbounded,
         };
<a href="#h2-2-3" id="h2-2-3" class="d">-        let scan = self.store.lock()?.scan(Range::from((start, end)));
</a><a href="#h2-2-4" id="h2-2-4" class="i">+        // TODO: For now, collect results from the store to not have to deal with lifetimes.
</a><a href="#h2-2-5" id="h2-2-5" class="i">+        let scan = Box::new(
</a><a href="#h2-2-6" id="h2-2-6" class="i">+            self.store.lock()?.scan(Range::from((start, end))).collect::&lt;Vec&lt;_&gt;&gt;().into_iter(),
</a><a href="#h2-2-7" id="h2-2-7" class="i">+        );
</a>         Ok(Box::new(Scan::new(scan, self.snapshot.clone())))
     }
 
<a href="#h2-3" id="h2-3" class="h">@@ -427,17 +430,17 @@ impl&lt;&#39;a&gt; Key&lt;&#39;a&gt; {
</a> }
 
 /// A key range scan.
<a href="#h2-3-3" id="h2-3-3" class="d">-pub struct Scan {
</a><a href="#h2-3-4" id="h2-3-4" class="i">+pub struct Scan&lt;&#39;a&gt; {
</a>     /// The augmented KV store iterator, with key (decoded) and value. Note that we don&#39;t retain
     /// the decoded version, so there will be multiple keys (for each version). We want the last.
<a href="#h2-3-7" id="h2-3-7" class="d">-    scan: Peekable&lt;super::Scan&gt;,
</a><a href="#h2-3-8" id="h2-3-8" class="i">+    scan: Peekable&lt;super::Scan&lt;&#39;a&gt;&gt;,
</a>     /// Keeps track of next_back() seen key, whose previous versions should be ignored.
     next_back_seen: Option&lt;Vec&lt;u8&gt;&gt;,
 }
 
<a href="#h2-3-13" id="h2-3-13" class="d">-impl Scan {
</a><a href="#h2-3-14" id="h2-3-14" class="i">+impl&lt;&#39;a&gt; Scan&lt;&#39;a&gt; {
</a>     /// Creates a new scan.
<a href="#h2-3-16" id="h2-3-16" class="d">-    fn new(mut scan: super::Scan, snapshot: Snapshot) -&gt; Self {
</a><a href="#h2-3-17" id="h2-3-17" class="i">+    fn new(mut scan: super::Scan&lt;&#39;a&gt;, snapshot: Snapshot) -&gt; Self {
</a>         // Augment the underlying scan to decode the key and filter invisible versions. We don&#39;t
         // return the version, since we don&#39;t need it, but beware that all versions of the key
         // will still be returned - we usually only need the last, which is what the next() and
<a href="#h2-4" id="h2-4" class="h">@@ -493,14 +496,14 @@ impl Scan {
</a>     }
 }
 
<a href="#h2-4-3" id="h2-4-3" class="d">-impl Iterator for Scan {
</a><a href="#h2-4-4" id="h2-4-4" class="i">+impl&lt;&#39;a&gt; Iterator for Scan&lt;&#39;a&gt; {
</a>     type Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;;
     fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
         self.try_next().transpose()
     }
 }
 
<a href="#h2-4-11" id="h2-4-11" class="d">-impl DoubleEndedIterator for Scan {
</a><a href="#h2-4-12" id="h2-4-12" class="i">+impl&lt;&#39;a&gt; DoubleEndedIterator for Scan&lt;&#39;a&gt; {
</a>     fn next_back(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
         self.try_next_back().transpose()
     }
<b>diff --git a/<a id="h3" href="../file/src/storage/kv/std_memory.rs.html">src/storage/kv/std_memory.rs</a> b/<a href="../file/src/storage/kv/std_memory.rs.html">src/storage/kv/std_memory.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -37,13 +37,7 @@ impl Store for StdMemory {
</a>     }
 
     fn scan(&amp;mut self, range: Range) -&gt; Scan {
<a href="#h3-0-3" id="h3-0-3" class="d">-        Box::new(
</a><a href="#h3-0-4" id="h3-0-4" class="d">-            self.data
</a><a href="#h3-0-5" id="h3-0-5" class="d">-                .range(range)
</a><a href="#h3-0-6" id="h3-0-6" class="d">-                .map(|(k, v)| Ok((k.clone(), v.clone())))
</a><a href="#h3-0-7" id="h3-0-7" class="d">-                .collect::&lt;Vec&lt;_&gt;&gt;()
</a><a href="#h3-0-8" id="h3-0-8" class="d">-                .into_iter(),
</a><a href="#h3-0-9" id="h3-0-9" class="d">-        )
</a><a href="#h3-0-10" id="h3-0-10" class="i">+        Box::new(self.data.range(range).map(|(k, v)| Ok((k.clone(), v.clone()))))
</a>     }
 
     fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</pre>
</div>
</body>
</html>
