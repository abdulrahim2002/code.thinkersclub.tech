<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>test: always return results (fixes #15) - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/89ca9bb362f3fd6b0c23294b986acf82e86165eb.html">89ca9bb362f3fd6b0c23294b986acf82e86165eb</a>
<b>parent</b> <a href="../commit/782c6c9905425599bab3e7e16cddbcae5bbaa75d.html">782c6c9905425599bab3e7e16cddbcae5bbaa75d</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Mon, 20 Apr 2020 23:23:04 +0200

test: always return results (fixes #15)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/log.rs</a></td><td> | </td><td class="num">427</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">123</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/follower.rs</a></td><td> | </td><td class="num">545</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/leader.rs</a></td><td> | </td><td class="num">385</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/mod.rs</a></td><td> | </td><td class="num">71</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
</table></pre><pre>5 files changed, 765 insertions(+), 786 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -258,109 +258,115 @@ mod tests {
</a>     use super::super::tests::TestState;
     use super::*;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-    fn setup() -&gt; (Log&lt;kv::storage::Test&gt;, kv::Simple&lt;kv::storage::Test&gt;) {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    fn setup() -&gt; Result&lt;(Log&lt;kv::storage::Test&gt;, kv::Simple&lt;kv::storage::Test&gt;), Error&gt; {
</a>         let backend = kv::storage::Test::new();
<a href="#h0-0-6" id="h0-0-6" class="d">-        let log = Log::new(kv::Simple::new(backend.clone())).unwrap();
</a><a href="#h0-0-7" id="h0-0-7" class="i">+        let log = Log::new(kv::Simple::new(backend.clone()))?;
</a>         let store = kv::Simple::new(backend);
<a href="#h0-0-9" id="h0-0-9" class="d">-        (log, store)
</a><a href="#h0-0-10" id="h0-0-10" class="i">+        Ok((log, store))
</a>     }
 
     #[test]
<a href="#h0-0-14" id="h0-0-14" class="d">-    fn new() {
</a><a href="#h0-0-15" id="h0-0-15" class="d">-        let (l, _) = setup();
</a><a href="#h0-0-16" id="h0-0-16" class="i">+    fn new() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-17" id="h0-0-17" class="i">+        let (l, _) = setup()?;
</a>         assert_eq!((0, 0), l.get_last());
         assert_eq!((0, 0), l.get_committed());
         assert_eq!((0, 0), l.get_applied());
<a href="#h0-0-21" id="h0-0-21" class="d">-        assert_eq!(None, l.get(1).unwrap());
</a><a href="#h0-0-22" id="h0-0-22" class="i">+        assert_eq!(None, l.get(1)?);
</a><a href="#h0-0-23" id="h0-0-23" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-0-27" id="h0-0-27" class="d">-    fn append() {
</a><a href="#h0-0-28" id="h0-0-28" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-0-29" id="h0-0-29" class="i">+    fn append() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-30" id="h0-0-30" class="i">+        let (mut l, _) = setup()?;
</a>         assert_eq!(Ok(None), l.get(1));
 
<a href="#h0-0-33" id="h0-0-33" class="d">-        assert_eq!(Ok(1), l.append(Entry { term: 3, command: Some(vec![0x01]) }));
</a><a href="#h0-0-34" id="h0-0-34" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-0-35" id="h0-0-35" class="d">-        assert_eq!(Ok(None), l.get(2));
</a><a href="#h0-0-36" id="h0-0-36" class="i">+        assert_eq!(1, l.append(Entry { term: 3, command: Some(vec![0x01]) })?);
</a><a href="#h0-0-37" id="h0-0-37" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-0-38" id="h0-0-38" class="i">+        assert_eq!(None, l.get(2)?);
</a> 
         assert_eq!((1, 3), l.get_last());
         assert_eq!((0, 0), l.get_committed());
         assert_eq!((0, 0), l.get_applied());
<a href="#h0-0-43" id="h0-0-43" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-0-47" id="h0-0-47" class="d">-    fn append_none_command() {
</a><a href="#h0-0-48" id="h0-0-48" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-0-49" id="h0-0-49" class="d">-        assert_eq!(Ok(1), l.append(Entry { term: 3, command: None }));
</a><a href="#h0-0-50" id="h0-0-50" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: None })), l.get(1));
</a><a href="#h0-0-51" id="h0-0-51" class="i">+    fn append_none_command() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-52" id="h0-0-52" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-0-53" id="h0-0-53" class="i">+        assert_eq!(1, l.append(Entry { term: 3, command: None })?);
</a><a href="#h0-0-54" id="h0-0-54" class="i">+        assert_eq!(Some(Entry { term: 3, command: None }), l.get(1)?);
</a><a href="#h0-0-55" id="h0-0-55" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-0-59" id="h0-0-59" class="d">-    fn append_persistence() {
</a><a href="#h0-0-60" id="h0-0-60" class="d">-        let (mut l, store) = setup();
</a><a href="#h0-0-61" id="h0-0-61" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-0-62" id="h0-0-62" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-0-63" id="h0-0-63" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-0-64" id="h0-0-64" class="i">+    fn append_persistence() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-65" id="h0-0-65" class="i">+        let (mut l, store) = setup()?;
</a><a href="#h0-0-66" id="h0-0-66" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-0-67" id="h0-0-67" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-0-68" id="h0-0-68" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a> 
<a href="#h0-0-70" id="h0-0-70" class="d">-        let l = Log::new(store).unwrap();
</a><a href="#h0-0-71" id="h0-0-71" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-0-72" id="h0-0-72" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: None })), l.get(2));
</a><a href="#h0-0-73" id="h0-0-73" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h0-0-74" id="h0-0-74" class="i">+        let l = Log::new(store)?;
</a><a href="#h0-0-75" id="h0-0-75" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-0-76" id="h0-0-76" class="i">+        assert_eq!(Some(Entry { term: 2, command: None }), l.get(2)?);
</a><a href="#h0-0-77" id="h0-0-77" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x03]) }), l.get(3)?);
</a><a href="#h0-0-78" id="h0-0-78" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-0-82" id="h0-0-82" class="d">-    fn apply() {
</a><a href="#h0-0-83" id="h0-0-83" class="d">-        let (mut l, store) = setup();
</a><a href="#h0-0-84" id="h0-0-84" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-0-85" id="h0-0-85" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-0-86" id="h0-0-86" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-0-87" id="h0-0-87" class="i">+    fn apply() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-88" id="h0-0-88" class="i">+        let (mut l, store) = setup()?;
</a><a href="#h0-0-89" id="h0-0-89" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-0-90" id="h0-0-90" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-0-91" id="h0-0-91" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a>         l.commit(3).unwrap();
 
         let mut state = TestState::new();
<a href="#h0-0-95" id="h0-0-95" class="d">-        assert_eq!(Ok(Some((1, Ok(vec![0xff, 0x01])))), l.apply(&amp;mut state));
</a><a href="#h0-0-96" id="h0-0-96" class="i">+        assert_eq!(Some((1, Ok(vec![0xff, 0x01]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h0-0-100" id="h0-0-100" class="d">-        assert_eq!(Ok(Some((2, Ok(vec![])))), l.apply(&amp;mut state));
</a><a href="#h0-0-101" id="h0-0-101" class="i">+        assert_eq!(Some((2, Ok(vec![]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((2, 2), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h0-0-105" id="h0-0-105" class="d">-        assert_eq!(Ok(Some((3, Ok(vec![0xff, 0x03])))), l.apply(&amp;mut state));
</a><a href="#h0-0-106" id="h0-0-106" class="i">+        assert_eq!(Some((3, Ok(vec![0xff, 0x03]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((3, 2), l.get_applied());
         assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
 
<a href="#h0-0-110" id="h0-0-110" class="d">-        assert_eq!(Ok(None), l.apply(&amp;mut state));
</a><a href="#h0-0-111" id="h0-0-111" class="i">+        assert_eq!(None, l.apply(&amp;mut state)?);
</a>         assert_eq!((3, 2), l.get_applied());
         assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
 
         // The last applied entry should be persisted, and also used for last committed
<a href="#h0-0-116" id="h0-0-116" class="d">-        let l = Log::new(store).unwrap();
</a><a href="#h0-0-117" id="h0-0-117" class="i">+        let l = Log::new(store)?;
</a>         assert_eq!((3, 2), l.get_last());
         assert_eq!((3, 2), l.get_committed());
         assert_eq!((3, 2), l.get_applied());
<a href="#h0-0-121" id="h0-0-121" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-0-125" id="h0-0-125" class="d">-    fn apply_committed_only() {
</a><a href="#h0-0-126" id="h0-0-126" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-0-127" id="h0-0-127" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-0-128" id="h0-0-128" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-0-129" id="h0-0-129" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-0-130" id="h0-0-130" class="i">+    fn apply_committed_only() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-0-131" id="h0-0-131" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-0-132" id="h0-0-132" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-0-133" id="h0-0-133" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-0-134" id="h0-0-134" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a>         l.commit(1).unwrap();
 
         let mut state = TestState::new();
<a href="#h0-0-138" id="h0-0-138" class="d">-        assert_eq!(Ok(Some((1, Ok(vec![0xff, 0x01])))), l.apply(&amp;mut state));
</a><a href="#h0-0-139" id="h0-0-139" class="i">+        assert_eq!(Some((1, Ok(vec![0xff, 0x01]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h0-0-143" id="h0-0-143" class="d">-        assert_eq!(Ok(None), l.apply(&amp;mut state));
</a><a href="#h0-0-144" id="h0-0-144" class="i">+        assert_eq!(None, l.apply(&amp;mut state)?);
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
<a href="#h0-0-147" id="h0-0-147" class="i">+        Ok(())
</a>     }
 
     #[test]
     fn apply_errors() -&gt; Result&lt;(), Error&gt; {
<a href="#h0-0-152" id="h0-0-152" class="d">-        let (mut l, store) = setup();
</a><a href="#h0-0-153" id="h0-0-153" class="i">+        let (mut l, store) = setup()?;
</a>         l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
         l.append(Entry { term: 1, command: Some(vec![0xff]) })?; // Error::Value
         l.append(Entry { term: 1, command: Some(vec![0x03]) })?;
<a href="#h0-1" id="h0-1" class="h">@@ -370,18 +376,18 @@ mod tests {
</a>         assert_eq!((5, 1), l.get_committed(), &quot;committed entry&quot;);
 
         let mut state = TestState::new();
<a href="#h0-1-3" id="h0-1-3" class="d">-        assert_eq!(Ok(Some((1, Ok(vec![0xff, 0x01])))), l.apply(&amp;mut state));
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        assert_eq!(Some((1, Ok(vec![0xff, 0x01]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
         assert_eq!(
<a href="#h0-1-9" id="h0-1-9" class="d">-            Ok(Some((2, Err(Error::Value(&quot;Command cannot be 0xff&quot;.into()))))),
</a><a href="#h0-1-10" id="h0-1-10" class="d">-            l.apply(&amp;mut state)
</a><a href="#h0-1-11" id="h0-1-11" class="i">+            Some((2, Err(Error::Value(&quot;Command cannot be 0xff&quot;.into())))),
</a><a href="#h0-1-12" id="h0-1-12" class="i">+            l.apply(&amp;mut state)?
</a>         );
         assert_eq!((2, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h0-1-17" id="h0-1-17" class="d">-        assert_eq!(Ok(Some((3, Ok(vec![0xff, 0x03])))), l.apply(&amp;mut state));
</a><a href="#h0-1-18" id="h0-1-18" class="i">+        assert_eq!(Some((3, Ok(vec![0xff, 0x03]))), l.apply(&amp;mut state)?);
</a>         assert_eq!((3, 1), l.get_applied());
         assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
 
<a href="#h0-2" id="h0-2" class="h">@@ -395,7 +401,7 @@ mod tests {
</a> 
         // The last applied entry should be persisted, and also used for last committed,
         // and the erroring log entry should still be there.
<a href="#h0-2-3" id="h0-2-3" class="d">-        let mut l = Log::new(store).unwrap();
</a><a href="#h0-2-4" id="h0-2-4" class="i">+        let mut l = Log::new(store)?;
</a>         assert_eq!((5, 1), l.get_last(), &quot;last entry&quot;);
         assert_eq!((3, 1), l.get_committed(), &quot;committed entry&quot;);
         assert_eq!((3, 1), l.get_applied(), &quot;applied entry&quot;);
<a href="#h0-3" id="h0-3" class="h">@@ -405,280 +411,297 @@ mod tests {
</a>     }
 
     #[test]
<a href="#h0-3-3" id="h0-3-3" class="d">-    fn commit() {
</a><a href="#h0-3-4" id="h0-3-4" class="d">-        let (mut l, store) = setup();
</a><a href="#h0-3-5" id="h0-3-5" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-6" id="h0-3-6" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-3-7" id="h0-3-7" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-8" id="h0-3-8" class="d">-        assert_eq!(Ok(3), l.commit(3));
</a><a href="#h0-3-9" id="h0-3-9" class="i">+    fn commit() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-10" id="h0-3-10" class="i">+        let (mut l, store) = setup()?;
</a><a href="#h0-3-11" id="h0-3-11" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-12" id="h0-3-12" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-3-13" id="h0-3-13" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-14" id="h0-3-14" class="i">+        assert_eq!(3, l.commit(3)?);
</a>         assert_eq!((3, 2), l.get_committed());
 
         // The last committed entry should not be persisted
<a href="#h0-3-18" id="h0-3-18" class="d">-        let l = Log::new(store).unwrap();
</a><a href="#h0-3-19" id="h0-3-19" class="i">+        let l = Log::new(store)?;
</a>         assert_eq!((0, 0), l.get_committed());
<a href="#h0-3-21" id="h0-3-21" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-25" id="h0-3-25" class="d">-    fn commit_beyond() {
</a><a href="#h0-3-26" id="h0-3-26" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-27" id="h0-3-27" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-28" id="h0-3-28" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-3-29" id="h0-3-29" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-30" id="h0-3-30" class="d">-        assert_eq!(Ok(3), l.commit(4));
</a><a href="#h0-3-31" id="h0-3-31" class="i">+    fn commit_beyond() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-32" id="h0-3-32" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-33" id="h0-3-33" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-34" id="h0-3-34" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-3-35" id="h0-3-35" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-36" id="h0-3-36" class="i">+        assert_eq!(3, l.commit(4)?);
</a>         assert_eq!((3, 2), l.get_committed());
<a href="#h0-3-38" id="h0-3-38" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-42" id="h0-3-42" class="d">-    fn commit_partial() {
</a><a href="#h0-3-43" id="h0-3-43" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-44" id="h0-3-44" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-45" id="h0-3-45" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-3-46" id="h0-3-46" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-47" id="h0-3-47" class="d">-        assert_eq!(Ok(2), l.commit(2));
</a><a href="#h0-3-48" id="h0-3-48" class="i">+    fn commit_partial() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-49" id="h0-3-49" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-50" id="h0-3-50" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-51" id="h0-3-51" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-3-52" id="h0-3-52" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-53" id="h0-3-53" class="i">+        assert_eq!(2, l.commit(2)?);
</a>         assert_eq!((2, 2), l.get_committed());
<a href="#h0-3-55" id="h0-3-55" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-59" id="h0-3-59" class="d">-    fn commit_reduce() {
</a><a href="#h0-3-60" id="h0-3-60" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-61" id="h0-3-61" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-62" id="h0-3-62" class="d">-        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h0-3-63" id="h0-3-63" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-64" id="h0-3-64" class="d">-        assert_eq!(Ok(2), l.commit(2));
</a><a href="#h0-3-65" id="h0-3-65" class="i">+    fn commit_reduce() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-66" id="h0-3-66" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-67" id="h0-3-67" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-68" id="h0-3-68" class="i">+        l.append(Entry { term: 2, command: None })?;
</a><a href="#h0-3-69" id="h0-3-69" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-70" id="h0-3-70" class="i">+        assert_eq!(2, l.commit(2)?);
</a>         assert_eq!((2, 2), l.get_committed());
 
<a href="#h0-3-73" id="h0-3-73" class="d">-        assert_eq!(Ok(2), l.commit(1));
</a><a href="#h0-3-74" id="h0-3-74" class="i">+        assert_eq!(2, l.commit(1)?);
</a>         assert_eq!((2, 2), l.get_committed());
<a href="#h0-3-76" id="h0-3-76" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-80" id="h0-3-80" class="d">-    fn get() {
</a><a href="#h0-3-81" id="h0-3-81" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-82" id="h0-3-82" class="d">-        assert_eq!(Ok(None), l.get(1));
</a><a href="#h0-3-83" id="h0-3-83" class="i">+    fn get() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-84" id="h0-3-84" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-85" id="h0-3-85" class="i">+        assert_eq!(None, l.get(1)?);
</a> 
<a href="#h0-3-87" id="h0-3-87" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-88" id="h0-3-88" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-89" id="h0-3-89" class="d">-        assert_eq!(Ok(None), l.get(2));
</a><a href="#h0-3-90" id="h0-3-90" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-91" id="h0-3-91" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-92" id="h0-3-92" class="i">+        assert_eq!(None, l.get(2)?);
</a><a href="#h0-3-93" id="h0-3-93" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-97" id="h0-3-97" class="d">-    fn has() {
</a><a href="#h0-3-98" id="h0-3-98" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-99" id="h0-3-99" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-100" id="h0-3-100" class="d">-
</a><a href="#h0-3-101" id="h0-3-101" class="d">-        assert_eq!(true, l.has(1, 2).unwrap());
</a><a href="#h0-3-102" id="h0-3-102" class="d">-        assert_eq!(true, l.has(0, 0).unwrap());
</a><a href="#h0-3-103" id="h0-3-103" class="d">-        assert_eq!(false, l.has(0, 1).unwrap());
</a><a href="#h0-3-104" id="h0-3-104" class="d">-        assert_eq!(false, l.has(1, 0).unwrap());
</a><a href="#h0-3-105" id="h0-3-105" class="d">-        assert_eq!(false, l.has(1, 3).unwrap());
</a><a href="#h0-3-106" id="h0-3-106" class="d">-        assert_eq!(false, l.has(2, 0).unwrap());
</a><a href="#h0-3-107" id="h0-3-107" class="d">-        assert_eq!(false, l.has(2, 1).unwrap());
</a><a href="#h0-3-108" id="h0-3-108" class="i">+    fn has() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-109" id="h0-3-109" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-110" id="h0-3-110" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-111" id="h0-3-111" class="i">+
</a><a href="#h0-3-112" id="h0-3-112" class="i">+        assert_eq!(true, l.has(1, 2)?);
</a><a href="#h0-3-113" id="h0-3-113" class="i">+        assert_eq!(true, l.has(0, 0)?);
</a><a href="#h0-3-114" id="h0-3-114" class="i">+        assert_eq!(false, l.has(0, 1)?);
</a><a href="#h0-3-115" id="h0-3-115" class="i">+        assert_eq!(false, l.has(1, 0)?);
</a><a href="#h0-3-116" id="h0-3-116" class="i">+        assert_eq!(false, l.has(1, 3)?);
</a><a href="#h0-3-117" id="h0-3-117" class="i">+        assert_eq!(false, l.has(2, 0)?);
</a><a href="#h0-3-118" id="h0-3-118" class="i">+        assert_eq!(false, l.has(2, 1)?);
</a><a href="#h0-3-119" id="h0-3-119" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-123" id="h0-3-123" class="d">-    fn range() {
</a><a href="#h0-3-124" id="h0-3-124" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-125" id="h0-3-125" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-126" id="h0-3-126" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-127" id="h0-3-127" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-128" id="h0-3-128" class="i">+    fn range() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-129" id="h0-3-129" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-130" id="h0-3-130" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-131" id="h0-3-131" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-132" id="h0-3-132" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x03]) })?;
</a> 
         assert_eq!(
<a href="#h0-3-135" id="h0-3-135" class="d">-            Ok(vec![
</a><a href="#h0-3-136" id="h0-3-136" class="i">+            vec![
</a>                 Entry { term: 1, command: Some(vec![0x01]) },
                 Entry { term: 1, command: Some(vec![0x02]) },
                 Entry { term: 1, command: Some(vec![0x03]) },
<a href="#h0-3-140" id="h0-3-140" class="d">-            ]),
</a><a href="#h0-3-141" id="h0-3-141" class="d">-            l.range(0..)
</a><a href="#h0-3-142" id="h0-3-142" class="i">+            ],
</a><a href="#h0-3-143" id="h0-3-143" class="i">+            l.range(0..)?
</a>         );
         assert_eq!(
<a href="#h0-3-146" id="h0-3-146" class="d">-            Ok(vec![
</a><a href="#h0-3-147" id="h0-3-147" class="i">+            vec![
</a>                 Entry { term: 1, command: Some(vec![0x02]) },
                 Entry { term: 1, command: Some(vec![0x03]) },
<a href="#h0-3-150" id="h0-3-150" class="d">-            ]),
</a><a href="#h0-3-151" id="h0-3-151" class="d">-            l.range(2..)
</a><a href="#h0-3-152" id="h0-3-152" class="i">+            ],
</a><a href="#h0-3-153" id="h0-3-153" class="i">+            l.range(2..)?
</a>         );
<a href="#h0-3-155" id="h0-3-155" class="d">-        assert_eq!(Ok(vec![]), l.range(4..));
</a><a href="#h0-3-156" id="h0-3-156" class="i">+        assert_eq!(Vec::&lt;Entry&gt;::new(), l.range(4..)?);
</a><a href="#h0-3-157" id="h0-3-157" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-161" id="h0-3-161" class="d">-    fn load_save_term() {
</a><a href="#h0-3-162" id="h0-3-162" class="i">+    fn load_save_term() -&gt; Result&lt;(), Error&gt; {
</a>         // Test loading empty term
<a href="#h0-3-164" id="h0-3-164" class="d">-        let (l, _) = setup();
</a><a href="#h0-3-165" id="h0-3-165" class="d">-        assert_eq!(Ok((0, None)), l.load_term());
</a><a href="#h0-3-166" id="h0-3-166" class="i">+        let (l, _) = setup()?;
</a><a href="#h0-3-167" id="h0-3-167" class="i">+        assert_eq!((0, None), l.load_term()?);
</a> 
         // Test loading saved term
<a href="#h0-3-170" id="h0-3-170" class="d">-        let (mut l, store) = setup();
</a><a href="#h0-3-171" id="h0-3-171" class="d">-        assert_eq!(Ok(()), l.save_term(1, Some(&quot;a&quot;)));
</a><a href="#h0-3-172" id="h0-3-172" class="d">-        let l = Log::new(store).unwrap();
</a><a href="#h0-3-173" id="h0-3-173" class="d">-        assert_eq!(Ok((1, Some(&quot;a&quot;.into()))), l.load_term());
</a><a href="#h0-3-174" id="h0-3-174" class="i">+        let (mut l, store) = setup()?;
</a><a href="#h0-3-175" id="h0-3-175" class="i">+        assert_eq!((), l.save_term(1, Some(&quot;a&quot;))?);
</a><a href="#h0-3-176" id="h0-3-176" class="i">+        let l = Log::new(store)?;
</a><a href="#h0-3-177" id="h0-3-177" class="i">+        assert_eq!((1, Some(&quot;a&quot;.into())), l.load_term()?);
</a> 
         // Test replacing saved term with none
<a href="#h0-3-180" id="h0-3-180" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-181" id="h0-3-181" class="d">-        assert_eq!(Ok(()), l.save_term(1, Some(&quot;a&quot;)));
</a><a href="#h0-3-182" id="h0-3-182" class="d">-        assert_eq!(Ok((1, Some(&quot;a&quot;.into()))), l.load_term());
</a><a href="#h0-3-183" id="h0-3-183" class="d">-        assert_eq!(Ok(()), l.save_term(0, None));
</a><a href="#h0-3-184" id="h0-3-184" class="d">-        assert_eq!(Ok((0, None)), l.load_term());
</a><a href="#h0-3-185" id="h0-3-185" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-186" id="h0-3-186" class="i">+        assert_eq!((), l.save_term(1, Some(&quot;a&quot;))?);
</a><a href="#h0-3-187" id="h0-3-187" class="i">+        assert_eq!((1, Some(&quot;a&quot;.into())), l.load_term()?);
</a><a href="#h0-3-188" id="h0-3-188" class="i">+        assert_eq!((), l.save_term(0, None)?);
</a><a href="#h0-3-189" id="h0-3-189" class="i">+        assert_eq!((0, None), l.load_term()?);
</a><a href="#h0-3-190" id="h0-3-190" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-194" id="h0-3-194" class="d">-    fn splice() {
</a><a href="#h0-3-195" id="h0-3-195" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-196" id="h0-3-196" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-197" id="h0-3-197" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-198" id="h0-3-198" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-199" id="h0-3-199" class="i">+    fn splice() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-200" id="h0-3-200" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-201" id="h0-3-201" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-202" id="h0-3-202" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-203" id="h0-3-203" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a> 
         assert_eq!(
<a href="#h0-3-206" id="h0-3-206" class="d">-            Ok(4),
</a><a href="#h0-3-207" id="h0-3-207" class="i">+            4,
</a>             l.splice(
                 2,
                 vec![
                     Entry { term: 3, command: Some(vec![0x03]) },
                     Entry { term: 4, command: Some(vec![0x04]) },
                 ]
<a href="#h0-3-214" id="h0-3-214" class="d">-            )
</a><a href="#h0-3-215" id="h0-3-215" class="i">+            )?
</a>         );
<a href="#h0-3-217" id="h0-3-217" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-218" id="h0-3-218" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h0-3-219" id="h0-3-219" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h0-3-220" id="h0-3-220" class="d">-        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x04]) })), l.get(4));
</a><a href="#h0-3-221" id="h0-3-221" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-222" id="h0-3-222" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x02]) }), l.get(2)?);
</a><a href="#h0-3-223" id="h0-3-223" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x03]) }), l.get(3)?);
</a><a href="#h0-3-224" id="h0-3-224" class="i">+        assert_eq!(Some(Entry { term: 4, command: Some(vec![0x04]) }), l.get(4)?);
</a>         assert_eq!((4, 4), l.get_last());
<a href="#h0-3-226" id="h0-3-226" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-230" id="h0-3-230" class="d">-    fn splice_all() {
</a><a href="#h0-3-231" id="h0-3-231" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-232" id="h0-3-232" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-233" id="h0-3-233" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-234" id="h0-3-234" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-235" id="h0-3-235" class="i">+    fn splice_all() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-236" id="h0-3-236" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-237" id="h0-3-237" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-238" id="h0-3-238" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-239" id="h0-3-239" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a> 
         assert_eq!(
<a href="#h0-3-242" id="h0-3-242" class="d">-            Ok(2),
</a><a href="#h0-3-243" id="h0-3-243" class="i">+            2,
</a>             l.splice(
                 0,
                 vec![
                     Entry { term: 4, command: Some(vec![0x0a]) },
                     Entry { term: 4, command: Some(vec![0x0b]) },
                 ]
<a href="#h0-3-250" id="h0-3-250" class="d">-            )
</a><a href="#h0-3-251" id="h0-3-251" class="i">+            )?
</a>         );
<a href="#h0-3-253" id="h0-3-253" class="d">-        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x0a]) })), l.get(1));
</a><a href="#h0-3-254" id="h0-3-254" class="d">-        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x0b]) })), l.get(2));
</a><a href="#h0-3-255" id="h0-3-255" class="i">+        assert_eq!(Some(Entry { term: 4, command: Some(vec![0x0a]) }), l.get(1)?);
</a><a href="#h0-3-256" id="h0-3-256" class="i">+        assert_eq!(Some(Entry { term: 4, command: Some(vec![0x0b]) }), l.get(2)?);
</a>         assert_eq!((2, 4), l.get_last());
<a href="#h0-3-258" id="h0-3-258" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-262" id="h0-3-262" class="d">-    fn splice_append() {
</a><a href="#h0-3-263" id="h0-3-263" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-264" id="h0-3-264" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-265" id="h0-3-265" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-266" id="h0-3-266" class="i">+    fn splice_append() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-267" id="h0-3-267" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-268" id="h0-3-268" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-269" id="h0-3-269" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a> 
         assert_eq!(
<a href="#h0-3-272" id="h0-3-272" class="d">-            Ok(4),
</a><a href="#h0-3-273" id="h0-3-273" class="i">+            4,
</a>             l.splice(
                 2,
                 vec![
                     Entry { term: 3, command: Some(vec![0x03]) },
                     Entry { term: 4, command: Some(vec![0x04]) },
                 ]
<a href="#h0-3-280" id="h0-3-280" class="d">-            )
</a><a href="#h0-3-281" id="h0-3-281" class="i">+            )?
</a>         );
<a href="#h0-3-283" id="h0-3-283" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-284" id="h0-3-284" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h0-3-285" id="h0-3-285" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h0-3-286" id="h0-3-286" class="d">-        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x04]) })), l.get(4));
</a><a href="#h0-3-287" id="h0-3-287" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-288" id="h0-3-288" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x02]) }), l.get(2)?);
</a><a href="#h0-3-289" id="h0-3-289" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x03]) }), l.get(3)?);
</a><a href="#h0-3-290" id="h0-3-290" class="i">+        assert_eq!(Some(Entry { term: 4, command: Some(vec![0x04]) }), l.get(4)?);
</a>         assert_eq!((4, 4), l.get_last());
<a href="#h0-3-292" id="h0-3-292" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-296" id="h0-3-296" class="d">-    fn splice_conflict_term() {
</a><a href="#h0-3-297" id="h0-3-297" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-298" id="h0-3-298" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-299" id="h0-3-299" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-300" id="h0-3-300" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-301" id="h0-3-301" class="d">-        l.append(Entry { term: 4, command: Some(vec![0x04]) }).unwrap();
</a><a href="#h0-3-302" id="h0-3-302" class="i">+    fn splice_conflict_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-303" id="h0-3-303" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-304" id="h0-3-304" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-305" id="h0-3-305" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-306" id="h0-3-306" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-307" id="h0-3-307" class="i">+        l.append(Entry { term: 4, command: Some(vec![0x04]) })?;
</a> 
         assert_eq!(
<a href="#h0-3-310" id="h0-3-310" class="d">-            Ok(3),
</a><a href="#h0-3-311" id="h0-3-311" class="i">+            3,
</a>             l.splice(
                 1,
                 vec![
                     Entry { term: 3, command: Some(vec![0x0b]) },
                     Entry { term: 3, command: Some(vec![0x0c]) }
                 ]
<a href="#h0-3-318" id="h0-3-318" class="d">-            )
</a><a href="#h0-3-319" id="h0-3-319" class="i">+            )?
</a>         );
<a href="#h0-3-321" id="h0-3-321" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-322" id="h0-3-322" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x0b]) })), l.get(2));
</a><a href="#h0-3-323" id="h0-3-323" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x0c]) })), l.get(3));
</a><a href="#h0-3-324" id="h0-3-324" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-325" id="h0-3-325" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x0b]) }), l.get(2)?);
</a><a href="#h0-3-326" id="h0-3-326" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x0c]) }), l.get(3)?);
</a>         assert_eq!((3, 3), l.get_last());
<a href="#h0-3-328" id="h0-3-328" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-332" id="h0-3-332" class="d">-    fn splice_overlap_inside() {
</a><a href="#h0-3-333" id="h0-3-333" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-334" id="h0-3-334" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-335" id="h0-3-335" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-336" id="h0-3-336" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-337" id="h0-3-337" class="d">-
</a><a href="#h0-3-338" id="h0-3-338" class="d">-        assert_eq!(Ok(3), l.splice(1, vec![Entry { term: 2, command: Some(vec![0x02]) },]));
</a><a href="#h0-3-339" id="h0-3-339" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-340" id="h0-3-340" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h0-3-341" id="h0-3-341" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h0-3-342" id="h0-3-342" class="i">+    fn splice_overlap_inside() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-343" id="h0-3-343" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-344" id="h0-3-344" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-345" id="h0-3-345" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-346" id="h0-3-346" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-347" id="h0-3-347" class="i">+
</a><a href="#h0-3-348" id="h0-3-348" class="i">+        assert_eq!(3, l.splice(1, vec![Entry { term: 2, command: Some(vec![0x02]) },])?);
</a><a href="#h0-3-349" id="h0-3-349" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-350" id="h0-3-350" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x02]) }), l.get(2)?);
</a><a href="#h0-3-351" id="h0-3-351" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x03]) }), l.get(3)?);
</a>         assert_eq!((3, 3), l.get_last());
<a href="#h0-3-353" id="h0-3-353" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-357" id="h0-3-357" class="d">-    fn truncate() {
</a><a href="#h0-3-358" id="h0-3-358" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-359" id="h0-3-359" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-360" id="h0-3-360" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-361" id="h0-3-361" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-362" id="h0-3-362" class="d">-
</a><a href="#h0-3-363" id="h0-3-363" class="d">-        assert_eq!(Ok(2), l.truncate(2));
</a><a href="#h0-3-364" id="h0-3-364" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-365" id="h0-3-365" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h0-3-366" id="h0-3-366" class="d">-        assert_eq!(Ok(None), l.get(3));
</a><a href="#h0-3-367" id="h0-3-367" class="i">+    fn truncate() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-368" id="h0-3-368" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-369" id="h0-3-369" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-370" id="h0-3-370" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-371" id="h0-3-371" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-372" id="h0-3-372" class="i">+
</a><a href="#h0-3-373" id="h0-3-373" class="i">+        assert_eq!(2, l.truncate(2)?);
</a><a href="#h0-3-374" id="h0-3-374" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-375" id="h0-3-375" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x02]) }), l.get(2)?);
</a><a href="#h0-3-376" id="h0-3-376" class="i">+        assert_eq!(None, l.get(3)?);
</a>         assert_eq!((2, 2), l.get_last());
<a href="#h0-3-378" id="h0-3-378" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-382" id="h0-3-382" class="d">-    fn truncate_beyond() {
</a><a href="#h0-3-383" id="h0-3-383" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-384" id="h0-3-384" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-385" id="h0-3-385" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-386" id="h0-3-386" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-387" id="h0-3-387" class="d">-
</a><a href="#h0-3-388" id="h0-3-388" class="d">-        assert_eq!(Ok(3), l.truncate(4));
</a><a href="#h0-3-389" id="h0-3-389" class="d">-        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h0-3-390" id="h0-3-390" class="d">-        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h0-3-391" id="h0-3-391" class="d">-        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h0-3-392" id="h0-3-392" class="d">-        assert_eq!(Ok(None), l.get(4));
</a><a href="#h0-3-393" id="h0-3-393" class="i">+    fn truncate_beyond() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-394" id="h0-3-394" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-395" id="h0-3-395" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-396" id="h0-3-396" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-397" id="h0-3-397" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-398" id="h0-3-398" class="i">+
</a><a href="#h0-3-399" id="h0-3-399" class="i">+        assert_eq!(3, l.truncate(4)?);
</a><a href="#h0-3-400" id="h0-3-400" class="i">+        assert_eq!(Some(Entry { term: 1, command: Some(vec![0x01]) }), l.get(1)?);
</a><a href="#h0-3-401" id="h0-3-401" class="i">+        assert_eq!(Some(Entry { term: 2, command: Some(vec![0x02]) }), l.get(2)?);
</a><a href="#h0-3-402" id="h0-3-402" class="i">+        assert_eq!(Some(Entry { term: 3, command: Some(vec![0x03]) }), l.get(3)?);
</a><a href="#h0-3-403" id="h0-3-403" class="i">+        assert_eq!(None, l.get(4)?);
</a>         assert_eq!((3, 3), l.get_last());
<a href="#h0-3-405" id="h0-3-405" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-409" id="h0-3-409" class="d">-    fn truncate_committed() {
</a><a href="#h0-3-410" id="h0-3-410" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-411" id="h0-3-411" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-412" id="h0-3-412" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-413" id="h0-3-413" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-414" id="h0-3-414" class="d">-        l.commit(2).unwrap();
</a><a href="#h0-3-415" id="h0-3-415" class="i">+    fn truncate_committed() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-416" id="h0-3-416" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-417" id="h0-3-417" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-418" id="h0-3-418" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-419" id="h0-3-419" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a><a href="#h0-3-420" id="h0-3-420" class="i">+        l.commit(2)?;
</a> 
         assert_matches!(l.truncate(1), Err(Error::Value(_)));
<a href="#h0-3-423" id="h0-3-423" class="d">-        assert_eq!(l.truncate(2), Ok(2));
</a><a href="#h0-3-424" id="h0-3-424" class="i">+        assert_eq!(l.truncate(2)?, 2);
</a><a href="#h0-3-425" id="h0-3-425" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h0-3-429" id="h0-3-429" class="d">-    fn truncate_zero() {
</a><a href="#h0-3-430" id="h0-3-430" class="d">-        let (mut l, _) = setup();
</a><a href="#h0-3-431" id="h0-3-431" class="d">-        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h0-3-432" id="h0-3-432" class="d">-        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h0-3-433" id="h0-3-433" class="d">-        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h0-3-434" id="h0-3-434" class="i">+    fn truncate_zero() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-3-435" id="h0-3-435" class="i">+        let (mut l, _) = setup()?;
</a><a href="#h0-3-436" id="h0-3-436" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h0-3-437" id="h0-3-437" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) })?;
</a><a href="#h0-3-438" id="h0-3-438" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) })?;
</a> 
<a href="#h0-3-440" id="h0-3-440" class="d">-        assert_eq!(Ok(0), l.truncate(0));
</a><a href="#h0-3-441" id="h0-3-441" class="d">-        assert_eq!(Ok(None), l.get(1));
</a><a href="#h0-3-442" id="h0-3-442" class="d">-        assert_eq!(Ok(None), l.get(2));
</a><a href="#h0-3-443" id="h0-3-443" class="d">-        assert_eq!(Ok(None), l.get(3));
</a><a href="#h0-3-444" id="h0-3-444" class="i">+        assert_eq!(0, l.truncate(0)?);
</a><a href="#h0-3-445" id="h0-3-445" class="i">+        assert_eq!(None, l.get(1)?);
</a><a href="#h0-3-446" id="h0-3-446" class="i">+        assert_eq!(None, l.get(2)?);
</a><a href="#h0-3-447" id="h0-3-447" class="i">+        assert_eq!(None, l.get(3)?);
</a>         assert_eq!((0, 0), l.get_last());
<a href="#h0-3-449" id="h0-3-449" class="i">+        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h1" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -109,15 +109,17 @@ mod tests {
</a>     use super::*;
     use crossbeam::channel::Receiver;
 
<a href="#h1-0-3" id="h1-0-3" class="d">-    fn setup() -&gt; (RoleNode&lt;Candidate, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    fn setup(
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;Candidate, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    {
</a>         let (sender, receiver) = crossbeam::channel::unbounded();
         let mut state = TestState::new();
<a href="#h1-0-9" id="h1-0-9" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a><a href="#h1-0-10" id="h1-0-10" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h1-0-11" id="h1-0-11" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h1-0-12" id="h1-0-12" class="d">-        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h1-0-13" id="h1-0-13" class="d">-        log.commit(2).unwrap();
</a><a href="#h1-0-14" id="h1-0-14" class="d">-        log.apply(&amp;mut state).unwrap();
</a><a href="#h1-0-15" id="h1-0-15" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h1-0-16" id="h1-0-16" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h1-0-17" id="h1-0-17" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
</a><a href="#h1-0-18" id="h1-0-18" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h1-0-19" id="h1-0-19" class="i">+        log.commit(2)?;
</a><a href="#h1-0-20" id="h1-0-20" class="i">+        log.apply(&amp;mut state)?;
</a> 
         let mut node = RoleNode {
             id: &quot;a&quot;.into(),
<a href="#h1-1" id="h1-1" class="h">@@ -128,22 +130,20 @@ mod tests {
</a>             sender,
             role: Candidate::new(),
         };
<a href="#h1-1-3" id="h1-1-3" class="d">-        node.save_term(3, None).unwrap();
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        (node, receiver)
</a><a href="#h1-1-5" id="h1-1-5" class="i">+        node.save_term(3, None)?;
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        Ok((node, receiver))
</a>     }
 
     #[test]
     // Heartbeat for current term converts to follower and emits ConfirmLeader event
<a href="#h1-1-11" id="h1-1-11" class="d">-    fn step_heartbeat_current_term() {
</a><a href="#h1-1-12" id="h1-1-12" class="d">-        let (candidate, rx) = setup();
</a><a href="#h1-1-13" id="h1-1-13" class="d">-        let node = candidate
</a><a href="#h1-1-14" id="h1-1-14" class="d">-            .step(Message {
</a><a href="#h1-1-15" id="h1-1-15" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h1-1-16" id="h1-1-16" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h1-1-17" id="h1-1-17" class="d">-                term: 3,
</a><a href="#h1-1-18" id="h1-1-18" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-1-19" id="h1-1-19" class="d">-            })
</a><a href="#h1-1-20" id="h1-1-20" class="d">-            .unwrap();
</a><a href="#h1-1-21" id="h1-1-21" class="i">+    fn step_heartbeat_current_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-1-22" id="h1-1-22" class="i">+        let (candidate, rx) = setup()?;
</a><a href="#h1-1-23" id="h1-1-23" class="i">+        let node = candidate.step(Message {
</a><a href="#h1-1-24" id="h1-1-24" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h1-1-25" id="h1-1-25" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h1-1-26" id="h1-1-26" class="i">+            term: 3,
</a><a href="#h1-1-27" id="h1-1-27" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-1-28" id="h1-1-28" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3);
         assert_messages(
             &amp;rx,
<a href="#h1-2" id="h1-2" class="h">@@ -154,20 +154,19 @@ mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
             }],
         );
<a href="#h1-2-3" id="h1-2-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat for future term converts to follower and emits ConfirmLeader event
<a href="#h1-2-8" id="h1-2-8" class="d">-    fn step_heartbeat_future_term() {
</a><a href="#h1-2-9" id="h1-2-9" class="d">-        let (candidate, rx) = setup();
</a><a href="#h1-2-10" id="h1-2-10" class="d">-        let node = candidate
</a><a href="#h1-2-11" id="h1-2-11" class="d">-            .step(Message {
</a><a href="#h1-2-12" id="h1-2-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h1-2-13" id="h1-2-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h1-2-14" id="h1-2-14" class="d">-                term: 4,
</a><a href="#h1-2-15" id="h1-2-15" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-2-16" id="h1-2-16" class="d">-            })
</a><a href="#h1-2-17" id="h1-2-17" class="d">-            .unwrap();
</a><a href="#h1-2-18" id="h1-2-18" class="i">+    fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-2-19" id="h1-2-19" class="i">+        let (candidate, rx) = setup()?;
</a><a href="#h1-2-20" id="h1-2-20" class="i">+        let node = candidate.step(Message {
</a><a href="#h1-2-21" id="h1-2-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h1-2-22" id="h1-2-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h1-2-23" id="h1-2-23" class="i">+            term: 4,
</a><a href="#h1-2-24" id="h1-2-24" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-2-25" id="h1-2-25" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(4);
         assert_messages(
             &amp;rx,
<a href="#h1-3" id="h1-3" class="h">@@ -178,57 +177,53 @@ mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
             }],
         );
<a href="#h1-3-3" id="h1-3-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat for past term is ignored
<a href="#h1-3-8" id="h1-3-8" class="d">-    fn step_heartbeat_past_term() {
</a><a href="#h1-3-9" id="h1-3-9" class="d">-        let (candidate, rx) = setup();
</a><a href="#h1-3-10" id="h1-3-10" class="d">-        let node = candidate
</a><a href="#h1-3-11" id="h1-3-11" class="d">-            .step(Message {
</a><a href="#h1-3-12" id="h1-3-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h1-3-13" id="h1-3-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-14" id="h1-3-14" class="d">-                term: 2,
</a><a href="#h1-3-15" id="h1-3-15" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-3-16" id="h1-3-16" class="d">-            })
</a><a href="#h1-3-17" id="h1-3-17" class="d">-            .unwrap();
</a><a href="#h1-3-18" id="h1-3-18" class="i">+    fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-3-19" id="h1-3-19" class="i">+        let (candidate, rx) = setup()?;
</a><a href="#h1-3-20" id="h1-3-20" class="i">+        let node = candidate.step(Message {
</a><a href="#h1-3-21" id="h1-3-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h1-3-22" id="h1-3-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-23" id="h1-3-23" class="i">+            term: 2,
</a><a href="#h1-3-24" id="h1-3-24" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h1-3-25" id="h1-3-25" class="i">+        })?;
</a>         assert_node(&amp;node).is_candidate().term(3);
         assert_messages(&amp;rx, vec![]);
<a href="#h1-3-28" id="h1-3-28" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h1-3-32" id="h1-3-32" class="d">-    fn step_grantvote() {
</a><a href="#h1-3-33" id="h1-3-33" class="d">-        let (candidate, rx) = setup();
</a><a href="#h1-3-34" id="h1-3-34" class="i">+    fn step_grantvote() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-3-35" id="h1-3-35" class="i">+        let (candidate, rx) = setup()?;
</a>         let peers = candidate.peers.clone();
         let mut node = Node::Candidate(candidate);
 
         // The first vote is not sufficient for a quorum (3 votes including self)
<a href="#h1-3-40" id="h1-3-40" class="d">-        node = node
</a><a href="#h1-3-41" id="h1-3-41" class="d">-            .step(Message {
</a><a href="#h1-3-42" id="h1-3-42" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h1-3-43" id="h1-3-43" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-44" id="h1-3-44" class="d">-                term: 3,
</a><a href="#h1-3-45" id="h1-3-45" class="d">-                event: Event::GrantVote,
</a><a href="#h1-3-46" id="h1-3-46" class="d">-            })
</a><a href="#h1-3-47" id="h1-3-47" class="d">-            .unwrap();
</a><a href="#h1-3-48" id="h1-3-48" class="i">+        node = node.step(Message {
</a><a href="#h1-3-49" id="h1-3-49" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h1-3-50" id="h1-3-50" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-51" id="h1-3-51" class="i">+            term: 3,
</a><a href="#h1-3-52" id="h1-3-52" class="i">+            event: Event::GrantVote,
</a><a href="#h1-3-53" id="h1-3-53" class="i">+        })?;
</a>         assert_node(&amp;node).is_candidate().term(3);
         assert_messages(&amp;rx, vec![]);
 
         // However, the second external vote makes us leader
<a href="#h1-3-58" id="h1-3-58" class="d">-        node = node
</a><a href="#h1-3-59" id="h1-3-59" class="d">-            .step(Message {
</a><a href="#h1-3-60" id="h1-3-60" class="d">-                from: Some(&quot;e&quot;.into()),
</a><a href="#h1-3-61" id="h1-3-61" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-62" id="h1-3-62" class="d">-                term: 3,
</a><a href="#h1-3-63" id="h1-3-63" class="d">-                event: Event::GrantVote,
</a><a href="#h1-3-64" id="h1-3-64" class="d">-            })
</a><a href="#h1-3-65" id="h1-3-65" class="d">-            .unwrap();
</a><a href="#h1-3-66" id="h1-3-66" class="i">+        node = node.step(Message {
</a><a href="#h1-3-67" id="h1-3-67" class="i">+            from: Some(&quot;e&quot;.into()),
</a><a href="#h1-3-68" id="h1-3-68" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h1-3-69" id="h1-3-69" class="i">+            term: 3,
</a><a href="#h1-3-70" id="h1-3-70" class="i">+            event: Event::GrantVote,
</a><a href="#h1-3-71" id="h1-3-71" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3);
 
         for to in peers.iter().cloned() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h1-3-77" id="h1-3-77" class="d">-                rx.recv().unwrap(),
</a><a href="#h1-3-78" id="h1-3-78" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h1-4" id="h1-4" class="h">@@ -241,7 +236,7 @@ mod tests {
</a>         for to in peers.iter().cloned() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h1-4-3" id="h1-4-3" class="d">-                rx.recv().unwrap(),
</a><a href="#h1-4-4" id="h1-4-4" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h1-5" id="h1-5" class="h">@@ -256,11 +251,12 @@ mod tests {
</a>         }
 
         assert_messages(&amp;rx, vec![]);
<a href="#h1-5-3" id="h1-5-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h1-5-7" id="h1-5-7" class="d">-    fn tick() {
</a><a href="#h1-5-8" id="h1-5-8" class="d">-        let (candidate, rx) = setup();
</a><a href="#h1-5-9" id="h1-5-9" class="i">+    fn tick() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-5-10" id="h1-5-10" class="i">+        let (candidate, rx) = setup()?;
</a>         let timeout = candidate.role.election_timeout;
         let peers = candidate.peers.clone();
         let mut node = Node::Candidate(candidate);
<a href="#h1-6" id="h1-6" class="h">@@ -268,14 +264,14 @@ mod tests {
</a>         assert!(timeout &gt; 0);
         for i in 0..timeout {
             assert_node(&amp;node).is_candidate().term(3).applied(if i &gt; 0 { 2 } else { 1 });
<a href="#h1-6-3" id="h1-6-3" class="d">-            node = node.tick().unwrap();
</a><a href="#h1-6-4" id="h1-6-4" class="i">+            node = node.tick()?;
</a>         }
         assert_node(&amp;node).is_candidate().term(4);
 
         for to in peers.into_iter() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h1-6-11" id="h1-6-11" class="d">-                rx.recv().unwrap(),
</a><a href="#h1-6-12" id="h1-6-12" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h1-7" id="h1-7" class="h">@@ -284,5 +280,6 @@ mod tests {
</a>                 }
             )
         }
<a href="#h1-7-3" id="h1-7-3" class="i">+        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h2" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -165,15 +165,17 @@ pub mod tests {
</a>         node.role.voted_for.clone()
     }
 
<a href="#h2-0-3" id="h2-0-3" class="d">-    fn setup() -&gt; (RoleNode&lt;Follower, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    fn setup(
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;Follower, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    {
</a>         let (sender, receiver) = crossbeam::channel::unbounded();
         let mut state = TestState::new();
<a href="#h2-0-9" id="h2-0-9" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a><a href="#h2-0-10" id="h2-0-10" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h2-0-11" id="h2-0-11" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h2-0-12" id="h2-0-12" class="d">-        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h2-0-13" id="h2-0-13" class="d">-        log.commit(2).unwrap();
</a><a href="#h2-0-14" id="h2-0-14" class="d">-        log.apply(&amp;mut state).unwrap();
</a><a href="#h2-0-15" id="h2-0-15" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h2-0-16" id="h2-0-16" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h2-0-17" id="h2-0-17" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
</a><a href="#h2-0-18" id="h2-0-18" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h2-0-19" id="h2-0-19" class="i">+        log.commit(2)?;
</a><a href="#h2-0-20" id="h2-0-20" class="i">+        log.apply(&amp;mut state)?;
</a> 
         let mut node = RoleNode {
             id: &quot;a&quot;.into(),
<a href="#h2-1" id="h2-1" class="h">@@ -184,22 +186,20 @@ pub mod tests {
</a>             sender,
             role: Follower::new(Some(&quot;b&quot;), None),
         };
<a href="#h2-1-3" id="h2-1-3" class="d">-        node.save_term(3, None).unwrap();
</a><a href="#h2-1-4" id="h2-1-4" class="d">-        (node, receiver)
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        node.save_term(3, None)?;
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        Ok((node, receiver))
</a>     }
 
     #[test]
     // Heartbeat from current leader
<a href="#h2-1-11" id="h2-1-11" class="d">-    fn step_heartbeat() {
</a><a href="#h2-1-12" id="h2-1-12" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-1-13" id="h2-1-13" class="d">-        let node = follower
</a><a href="#h2-1-14" id="h2-1-14" class="d">-            .step(Message {
</a><a href="#h2-1-15" id="h2-1-15" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-1-16" id="h2-1-16" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-1-17" id="h2-1-17" class="d">-                term: 3,
</a><a href="#h2-1-18" id="h2-1-18" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-1-19" id="h2-1-19" class="d">-            })
</a><a href="#h2-1-20" id="h2-1-20" class="d">-            .unwrap();
</a><a href="#h2-1-21" id="h2-1-21" class="i">+    fn step_heartbeat() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-1-22" id="h2-1-22" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-1-23" id="h2-1-23" class="i">+        let node = follower.step(Message {
</a><a href="#h2-1-24" id="h2-1-24" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-1-25" id="h2-1-25" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-1-26" id="h2-1-26" class="i">+            term: 3,
</a><a href="#h2-1-27" id="h2-1-27" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-1-28" id="h2-1-28" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-2" id="h2-2" class="h">@@ -216,20 +216,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
             }],
         );
<a href="#h2-2-3" id="h2-2-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat from current leader with conflicting commit_term
<a href="#h2-2-8" id="h2-2-8" class="d">-    fn step_heartbeat_conflict_commit_term() {
</a><a href="#h2-2-9" id="h2-2-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-2-10" id="h2-2-10" class="d">-        let node = follower
</a><a href="#h2-2-11" id="h2-2-11" class="d">-            .step(Message {
</a><a href="#h2-2-12" id="h2-2-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-2-13" id="h2-2-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-2-14" id="h2-2-14" class="d">-                term: 3,
</a><a href="#h2-2-15" id="h2-2-15" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 3 },
</a><a href="#h2-2-16" id="h2-2-16" class="d">-            })
</a><a href="#h2-2-17" id="h2-2-17" class="d">-            .unwrap();
</a><a href="#h2-2-18" id="h2-2-18" class="i">+    fn step_heartbeat_conflict_commit_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-2-19" id="h2-2-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-2-20" id="h2-2-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-2-21" id="h2-2-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-2-22" id="h2-2-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-2-23" id="h2-2-23" class="i">+            term: 3,
</a><a href="#h2-2-24" id="h2-2-24" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 3 },
</a><a href="#h2-2-25" id="h2-2-25" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-3" id="h2-3" class="h">@@ -246,20 +245,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 3, has_committed: false },
             }],
         );
<a href="#h2-3-3" id="h2-3-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat from current leader with a missing commit_index
<a href="#h2-3-8" id="h2-3-8" class="d">-    fn step_heartbeat_missing_commit_entry() {
</a><a href="#h2-3-9" id="h2-3-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-3-10" id="h2-3-10" class="d">-        let node = follower
</a><a href="#h2-3-11" id="h2-3-11" class="d">-            .step(Message {
</a><a href="#h2-3-12" id="h2-3-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-3-13" id="h2-3-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-3-14" id="h2-3-14" class="d">-                term: 3,
</a><a href="#h2-3-15" id="h2-3-15" class="d">-                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h2-3-16" id="h2-3-16" class="d">-            })
</a><a href="#h2-3-17" id="h2-3-17" class="d">-            .unwrap();
</a><a href="#h2-3-18" id="h2-3-18" class="i">+    fn step_heartbeat_missing_commit_entry() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-3-19" id="h2-3-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-3-20" id="h2-3-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-3-21" id="h2-3-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-3-22" id="h2-3-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-3-23" id="h2-3-23" class="i">+            term: 3,
</a><a href="#h2-3-24" id="h2-3-24" class="i">+            event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h2-3-25" id="h2-3-25" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-4" id="h2-4" class="h">@@ -276,20 +274,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 5, has_committed: false },
             }],
         );
<a href="#h2-4-3" id="h2-4-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat from fake leader
<a href="#h2-4-8" id="h2-4-8" class="d">-    fn step_heartbeat_fake_leader() {
</a><a href="#h2-4-9" id="h2-4-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-4-10" id="h2-4-10" class="d">-        let node = follower
</a><a href="#h2-4-11" id="h2-4-11" class="d">-            .step(Message {
</a><a href="#h2-4-12" id="h2-4-12" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-4-13" id="h2-4-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-4-14" id="h2-4-14" class="d">-                term: 3,
</a><a href="#h2-4-15" id="h2-4-15" class="d">-                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h2-4-16" id="h2-4-16" class="d">-            })
</a><a href="#h2-4-17" id="h2-4-17" class="d">-            .unwrap();
</a><a href="#h2-4-18" id="h2-4-18" class="i">+    fn step_heartbeat_fake_leader() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-4-19" id="h2-4-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-4-20" id="h2-4-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-4-21" id="h2-4-21" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-4-22" id="h2-4-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-4-23" id="h2-4-23" class="i">+            term: 3,
</a><a href="#h2-4-24" id="h2-4-24" class="i">+            event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h2-4-25" id="h2-4-25" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-5" id="h2-5" class="h">@@ -298,21 +295,20 @@ pub mod tests {
</a>             .committed(2)
             .applied(1);
         assert_messages(&amp;rx, vec![]);
<a href="#h2-5-3" id="h2-5-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat when no current leader
<a href="#h2-5-8" id="h2-5-8" class="d">-    fn step_heartbeat_no_leader() {
</a><a href="#h2-5-9" id="h2-5-9" class="d">-        let (mut follower, rx) = setup();
</a><a href="#h2-5-10" id="h2-5-10" class="i">+    fn step_heartbeat_no_leader() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-5-11" id="h2-5-11" class="i">+        let (mut follower, rx) = setup()?;
</a>         follower.role = Follower::new(None, None);
<a href="#h2-5-13" id="h2-5-13" class="d">-        let node = follower
</a><a href="#h2-5-14" id="h2-5-14" class="d">-            .step(Message {
</a><a href="#h2-5-15" id="h2-5-15" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-5-16" id="h2-5-16" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-5-17" id="h2-5-17" class="d">-                term: 3,
</a><a href="#h2-5-18" id="h2-5-18" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-5-19" id="h2-5-19" class="d">-            })
</a><a href="#h2-5-20" id="h2-5-20" class="d">-            .unwrap();
</a><a href="#h2-5-21" id="h2-5-21" class="i">+        let node = follower.step(Message {
</a><a href="#h2-5-22" id="h2-5-22" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-5-23" id="h2-5-23" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-5-24" id="h2-5-24" class="i">+            term: 3,
</a><a href="#h2-5-25" id="h2-5-25" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-5-26" id="h2-5-26" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-6" id="h2-6" class="h">@@ -329,20 +325,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
             }],
         );
<a href="#h2-6-3" id="h2-6-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat from current leader with old commit_index
<a href="#h2-6-8" id="h2-6-8" class="d">-    fn step_heartbeat_old_commit_index() {
</a><a href="#h2-6-9" id="h2-6-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-6-10" id="h2-6-10" class="d">-        let node = follower
</a><a href="#h2-6-11" id="h2-6-11" class="d">-            .step(Message {
</a><a href="#h2-6-12" id="h2-6-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-6-13" id="h2-6-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-6-14" id="h2-6-14" class="d">-                term: 3,
</a><a href="#h2-6-15" id="h2-6-15" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h2-6-16" id="h2-6-16" class="d">-            })
</a><a href="#h2-6-17" id="h2-6-17" class="d">-            .unwrap();
</a><a href="#h2-6-18" id="h2-6-18" class="i">+    fn step_heartbeat_old_commit_index() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-6-19" id="h2-6-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-6-20" id="h2-6-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-6-21" id="h2-6-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-6-22" id="h2-6-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-6-23" id="h2-6-23" class="i">+            term: 3,
</a><a href="#h2-6-24" id="h2-6-24" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h2-6-25" id="h2-6-25" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-7" id="h2-7" class="h">@@ -359,20 +354,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
             }],
         );
<a href="#h2-7-3" id="h2-7-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat for future term with other leader changes leader
<a href="#h2-7-8" id="h2-7-8" class="d">-    fn step_heartbeat_future_term() {
</a><a href="#h2-7-9" id="h2-7-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-7-10" id="h2-7-10" class="d">-        let node = follower
</a><a href="#h2-7-11" id="h2-7-11" class="d">-            .step(Message {
</a><a href="#h2-7-12" id="h2-7-12" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-7-13" id="h2-7-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-7-14" id="h2-7-14" class="d">-                term: 4,
</a><a href="#h2-7-15" id="h2-7-15" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-7-16" id="h2-7-16" class="d">-            })
</a><a href="#h2-7-17" id="h2-7-17" class="d">-            .unwrap();
</a><a href="#h2-7-18" id="h2-7-18" class="i">+    fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-7-19" id="h2-7-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-7-20" id="h2-7-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-7-21" id="h2-7-21" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-7-22" id="h2-7-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-7-23" id="h2-7-23" class="i">+            term: 4,
</a><a href="#h2-7-24" id="h2-7-24" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-7-25" id="h2-7-25" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;c&quot;)).voted_for(None);
         assert_messages(
             &amp;rx,
<a href="#h2-8" id="h2-8" class="h">@@ -383,20 +377,19 @@ pub mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
             }],
         );
<a href="#h2-8-3" id="h2-8-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeat from past term
<a href="#h2-8-8" id="h2-8-8" class="d">-    fn step_heartbeat_past_term() {
</a><a href="#h2-8-9" id="h2-8-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-8-10" id="h2-8-10" class="d">-        let node = follower
</a><a href="#h2-8-11" id="h2-8-11" class="d">-            .step(Message {
</a><a href="#h2-8-12" id="h2-8-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-8-13" id="h2-8-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-8-14" id="h2-8-14" class="d">-                term: 2,
</a><a href="#h2-8-15" id="h2-8-15" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-8-16" id="h2-8-16" class="d">-            })
</a><a href="#h2-8-17" id="h2-8-17" class="d">-            .unwrap();
</a><a href="#h2-8-18" id="h2-8-18" class="i">+    fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-8-19" id="h2-8-19" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-8-20" id="h2-8-20" class="i">+        let node = follower.step(Message {
</a><a href="#h2-8-21" id="h2-8-21" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-8-22" id="h2-8-22" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-8-23" id="h2-8-23" class="i">+            term: 2,
</a><a href="#h2-8-24" id="h2-8-24" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h2-8-25" id="h2-8-25" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_follower()
             .term(3)
<a href="#h2-9" id="h2-9" class="h">@@ -405,22 +398,21 @@ pub mod tests {
</a>             .committed(2)
             .applied(1);
         assert_messages(&amp;rx, vec![]);
<a href="#h2-9-3" id="h2-9-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // SolicitVote is granted for the first solicitor, otherwise ignored.
<a href="#h2-9-8" id="h2-9-8" class="d">-    fn step_solicitvote() {
</a><a href="#h2-9-9" id="h2-9-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-9-10" id="h2-9-10" class="i">+    fn step_solicitvote() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-9-11" id="h2-9-11" class="i">+        let (follower, rx) = setup()?;
</a> 
         // The first vote request in this term yields a vote response.
<a href="#h2-9-14" id="h2-9-14" class="d">-        let mut node = follower
</a><a href="#h2-9-15" id="h2-9-15" class="d">-            .step(Message {
</a><a href="#h2-9-16" id="h2-9-16" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-9-17" id="h2-9-17" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-9-18" id="h2-9-18" class="d">-                term: 3,
</a><a href="#h2-9-19" id="h2-9-19" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-9-20" id="h2-9-20" class="d">-            })
</a><a href="#h2-9-21" id="h2-9-21" class="d">-            .unwrap();
</a><a href="#h2-9-22" id="h2-9-22" class="i">+        let mut node = follower.step(Message {
</a><a href="#h2-9-23" id="h2-9-23" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-9-24" id="h2-9-24" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-9-25" id="h2-9-25" class="i">+            term: 3,
</a><a href="#h2-9-26" id="h2-9-26" class="i">+            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-9-27" id="h2-9-27" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
         assert_messages(
             &amp;rx,
<a href="#h2-10" id="h2-10" class="h">@@ -433,14 +425,12 @@ pub mod tests {
</a>         );
 
         // Another vote request from the same sender is granted.
<a href="#h2-10-3" id="h2-10-3" class="d">-        node = node
</a><a href="#h2-10-4" id="h2-10-4" class="d">-            .step(Message {
</a><a href="#h2-10-5" id="h2-10-5" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-10-6" id="h2-10-6" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-10-7" id="h2-10-7" class="d">-                term: 3,
</a><a href="#h2-10-8" id="h2-10-8" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-10-9" id="h2-10-9" class="d">-            })
</a><a href="#h2-10-10" id="h2-10-10" class="d">-            .unwrap();
</a><a href="#h2-10-11" id="h2-10-11" class="i">+        node = node.step(Message {
</a><a href="#h2-10-12" id="h2-10-12" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-10-13" id="h2-10-13" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-10-14" id="h2-10-14" class="i">+            term: 3,
</a><a href="#h2-10-15" id="h2-10-15" class="i">+            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-10-16" id="h2-10-16" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
         assert_messages(
             &amp;rx,
<a href="#h2-11" id="h2-11" class="h">@@ -453,85 +443,79 @@ pub mod tests {
</a>         );
 
         // But a vote request from a different node is ignored.
<a href="#h2-11-3" id="h2-11-3" class="d">-        node = node
</a><a href="#h2-11-4" id="h2-11-4" class="d">-            .step(Message {
</a><a href="#h2-11-5" id="h2-11-5" class="d">-                from: Some(&quot;d&quot;.into()),
</a><a href="#h2-11-6" id="h2-11-6" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-7" id="h2-11-7" class="d">-                term: 3,
</a><a href="#h2-11-8" id="h2-11-8" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-11-9" id="h2-11-9" class="d">-            })
</a><a href="#h2-11-10" id="h2-11-10" class="d">-            .unwrap();
</a><a href="#h2-11-11" id="h2-11-11" class="i">+        node = node.step(Message {
</a><a href="#h2-11-12" id="h2-11-12" class="i">+            from: Some(&quot;d&quot;.into()),
</a><a href="#h2-11-13" id="h2-11-13" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-14" id="h2-11-14" class="i">+            term: 3,
</a><a href="#h2-11-15" id="h2-11-15" class="i">+            event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-11-16" id="h2-11-16" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
         assert_messages(&amp;rx, vec![]);
<a href="#h2-11-19" id="h2-11-19" class="i">+        Ok(())
</a>     }
 
     #[test]
     // GrantVote messages are ignored
<a href="#h2-11-24" id="h2-11-24" class="d">-    fn step_grantvote_noop() {
</a><a href="#h2-11-25" id="h2-11-25" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-11-26" id="h2-11-26" class="d">-        let node = follower
</a><a href="#h2-11-27" id="h2-11-27" class="d">-            .step(Message {
</a><a href="#h2-11-28" id="h2-11-28" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-11-29" id="h2-11-29" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-30" id="h2-11-30" class="d">-                term: 3,
</a><a href="#h2-11-31" id="h2-11-31" class="d">-                event: Event::GrantVote,
</a><a href="#h2-11-32" id="h2-11-32" class="d">-            })
</a><a href="#h2-11-33" id="h2-11-33" class="d">-            .unwrap();
</a><a href="#h2-11-34" id="h2-11-34" class="i">+    fn step_grantvote_noop() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-11-35" id="h2-11-35" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-11-36" id="h2-11-36" class="i">+        let node = follower.step(Message {
</a><a href="#h2-11-37" id="h2-11-37" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-11-38" id="h2-11-38" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-39" id="h2-11-39" class="i">+            term: 3,
</a><a href="#h2-11-40" id="h2-11-40" class="i">+            event: Event::GrantVote,
</a><a href="#h2-11-41" id="h2-11-41" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
         assert_messages(&amp;rx, vec![]);
<a href="#h2-11-44" id="h2-11-44" class="i">+        Ok(())
</a>     }
 
     #[test]
     // SolicitVote is rejected if last_term is outdated.
<a href="#h2-11-49" id="h2-11-49" class="d">-    fn step_solicitvote_last_index_outdated() {
</a><a href="#h2-11-50" id="h2-11-50" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-11-51" id="h2-11-51" class="d">-        let node = follower
</a><a href="#h2-11-52" id="h2-11-52" class="d">-            .step(Message {
</a><a href="#h2-11-53" id="h2-11-53" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-11-54" id="h2-11-54" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-55" id="h2-11-55" class="d">-                term: 3,
</a><a href="#h2-11-56" id="h2-11-56" class="d">-                event: Event::SolicitVote { last_index: 2, last_term: 2 },
</a><a href="#h2-11-57" id="h2-11-57" class="d">-            })
</a><a href="#h2-11-58" id="h2-11-58" class="d">-            .unwrap();
</a><a href="#h2-11-59" id="h2-11-59" class="i">+    fn step_solicitvote_last_index_outdated() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-11-60" id="h2-11-60" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-11-61" id="h2-11-61" class="i">+        let node = follower.step(Message {
</a><a href="#h2-11-62" id="h2-11-62" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-11-63" id="h2-11-63" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-64" id="h2-11-64" class="i">+            term: 3,
</a><a href="#h2-11-65" id="h2-11-65" class="i">+            event: Event::SolicitVote { last_index: 2, last_term: 2 },
</a><a href="#h2-11-66" id="h2-11-66" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
         assert_messages(&amp;rx, vec![]);
<a href="#h2-11-69" id="h2-11-69" class="i">+        Ok(())
</a>     }
 
     #[test]
     // SolicitVote is rejected if last_term is outdated.
<a href="#h2-11-74" id="h2-11-74" class="d">-    fn step_solicitvote_last_term_outdated() {
</a><a href="#h2-11-75" id="h2-11-75" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-11-76" id="h2-11-76" class="d">-        let node = follower
</a><a href="#h2-11-77" id="h2-11-77" class="d">-            .step(Message {
</a><a href="#h2-11-78" id="h2-11-78" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h2-11-79" id="h2-11-79" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-80" id="h2-11-80" class="d">-                term: 3,
</a><a href="#h2-11-81" id="h2-11-81" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 1 },
</a><a href="#h2-11-82" id="h2-11-82" class="d">-            })
</a><a href="#h2-11-83" id="h2-11-83" class="d">-            .unwrap();
</a><a href="#h2-11-84" id="h2-11-84" class="i">+    fn step_solicitvote_last_term_outdated() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-11-85" id="h2-11-85" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-11-86" id="h2-11-86" class="i">+        let node = follower.step(Message {
</a><a href="#h2-11-87" id="h2-11-87" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h2-11-88" id="h2-11-88" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-89" id="h2-11-89" class="i">+            term: 3,
</a><a href="#h2-11-90" id="h2-11-90" class="i">+            event: Event::SolicitVote { last_index: 3, last_term: 1 },
</a><a href="#h2-11-91" id="h2-11-91" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
         assert_messages(&amp;rx, vec![]);
<a href="#h2-11-94" id="h2-11-94" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries accepts some entries at base 0 without changes
<a href="#h2-11-99" id="h2-11-99" class="d">-    fn step_replicateentries_base0() {
</a><a href="#h2-11-100" id="h2-11-100" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-11-101" id="h2-11-101" class="d">-        let node = follower
</a><a href="#h2-11-102" id="h2-11-102" class="d">-            .step(Message {
</a><a href="#h2-11-103" id="h2-11-103" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-11-104" id="h2-11-104" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-105" id="h2-11-105" class="d">-                term: 3,
</a><a href="#h2-11-106" id="h2-11-106" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-11-107" id="h2-11-107" class="d">-                    base_index: 0,
</a><a href="#h2-11-108" id="h2-11-108" class="d">-                    base_term: 0,
</a><a href="#h2-11-109" id="h2-11-109" class="d">-                    entries: vec![
</a><a href="#h2-11-110" id="h2-11-110" class="d">-                        Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h2-11-111" id="h2-11-111" class="d">-                        Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h2-11-112" id="h2-11-112" class="d">-                    ],
</a><a href="#h2-11-113" id="h2-11-113" class="d">-                },
</a><a href="#h2-11-114" id="h2-11-114" class="d">-            })
</a><a href="#h2-11-115" id="h2-11-115" class="d">-            .unwrap();
</a><a href="#h2-11-116" id="h2-11-116" class="i">+    fn step_replicateentries_base0() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-11-117" id="h2-11-117" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-11-118" id="h2-11-118" class="i">+        let node = follower.step(Message {
</a><a href="#h2-11-119" id="h2-11-119" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-11-120" id="h2-11-120" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-11-121" id="h2-11-121" class="i">+            term: 3,
</a><a href="#h2-11-122" id="h2-11-122" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-11-123" id="h2-11-123" class="i">+                base_index: 0,
</a><a href="#h2-11-124" id="h2-11-124" class="i">+                base_term: 0,
</a><a href="#h2-11-125" id="h2-11-125" class="i">+                entries: vec![
</a><a href="#h2-11-126" id="h2-11-126" class="i">+                    Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h2-11-127" id="h2-11-127" class="i">+                    Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h2-11-128" id="h2-11-128" class="i">+                ],
</a><a href="#h2-11-129" id="h2-11-129" class="i">+            },
</a><a href="#h2-11-130" id="h2-11-130" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-12" id="h2-12" class="h">@@ -546,27 +530,26 @@ pub mod tests {
</a>                 event: Event::AcceptEntries { last_index: 3 },
             }],
         );
<a href="#h2-12-3" id="h2-12-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries appends entries
<a href="#h2-12-8" id="h2-12-8" class="d">-    fn step_replicateentries_append() {
</a><a href="#h2-12-9" id="h2-12-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-12-10" id="h2-12-10" class="d">-        let node = follower
</a><a href="#h2-12-11" id="h2-12-11" class="d">-            .step(Message {
</a><a href="#h2-12-12" id="h2-12-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-12-13" id="h2-12-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-12-14" id="h2-12-14" class="d">-                term: 3,
</a><a href="#h2-12-15" id="h2-12-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-12-16" id="h2-12-16" class="d">-                    base_index: 3,
</a><a href="#h2-12-17" id="h2-12-17" class="d">-                    base_term: 2,
</a><a href="#h2-12-18" id="h2-12-18" class="d">-                    entries: vec![
</a><a href="#h2-12-19" id="h2-12-19" class="d">-                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-12-20" id="h2-12-20" class="d">-                        Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h2-12-21" id="h2-12-21" class="d">-                    ],
</a><a href="#h2-12-22" id="h2-12-22" class="d">-                },
</a><a href="#h2-12-23" id="h2-12-23" class="d">-            })
</a><a href="#h2-12-24" id="h2-12-24" class="d">-            .unwrap();
</a><a href="#h2-12-25" id="h2-12-25" class="i">+    fn step_replicateentries_append() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-12-26" id="h2-12-26" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-12-27" id="h2-12-27" class="i">+        let node = follower.step(Message {
</a><a href="#h2-12-28" id="h2-12-28" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-12-29" id="h2-12-29" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-12-30" id="h2-12-30" class="i">+            term: 3,
</a><a href="#h2-12-31" id="h2-12-31" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-12-32" id="h2-12-32" class="i">+                base_index: 3,
</a><a href="#h2-12-33" id="h2-12-33" class="i">+                base_term: 2,
</a><a href="#h2-12-34" id="h2-12-34" class="i">+                entries: vec![
</a><a href="#h2-12-35" id="h2-12-35" class="i">+                    Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-12-36" id="h2-12-36" class="i">+                    Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h2-12-37" id="h2-12-37" class="i">+                ],
</a><a href="#h2-12-38" id="h2-12-38" class="i">+            },
</a><a href="#h2-12-39" id="h2-12-39" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-13" id="h2-13" class="h">@@ -583,28 +566,27 @@ pub mod tests {
</a>                 event: Event::AcceptEntries { last_index: 5 },
             }],
         );
<a href="#h2-13-3" id="h2-13-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries accepts partially overlapping entries
<a href="#h2-13-8" id="h2-13-8" class="d">-    fn step_replicateentries_partial_overlap() {
</a><a href="#h2-13-9" id="h2-13-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-13-10" id="h2-13-10" class="d">-        let node = follower
</a><a href="#h2-13-11" id="h2-13-11" class="d">-            .step(Message {
</a><a href="#h2-13-12" id="h2-13-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-13-13" id="h2-13-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-13-14" id="h2-13-14" class="d">-                term: 3,
</a><a href="#h2-13-15" id="h2-13-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-13-16" id="h2-13-16" class="d">-                    base_index: 1,
</a><a href="#h2-13-17" id="h2-13-17" class="d">-                    base_term: 1,
</a><a href="#h2-13-18" id="h2-13-18" class="d">-                    entries: vec![
</a><a href="#h2-13-19" id="h2-13-19" class="d">-                        Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h2-13-20" id="h2-13-20" class="d">-                        Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h2-13-21" id="h2-13-21" class="d">-                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-13-22" id="h2-13-22" class="d">-                    ],
</a><a href="#h2-13-23" id="h2-13-23" class="d">-                },
</a><a href="#h2-13-24" id="h2-13-24" class="d">-            })
</a><a href="#h2-13-25" id="h2-13-25" class="d">-            .unwrap();
</a><a href="#h2-13-26" id="h2-13-26" class="i">+    fn step_replicateentries_partial_overlap() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-13-27" id="h2-13-27" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-13-28" id="h2-13-28" class="i">+        let node = follower.step(Message {
</a><a href="#h2-13-29" id="h2-13-29" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-13-30" id="h2-13-30" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-13-31" id="h2-13-31" class="i">+            term: 3,
</a><a href="#h2-13-32" id="h2-13-32" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-13-33" id="h2-13-33" class="i">+                base_index: 1,
</a><a href="#h2-13-34" id="h2-13-34" class="i">+                base_term: 1,
</a><a href="#h2-13-35" id="h2-13-35" class="i">+                entries: vec![
</a><a href="#h2-13-36" id="h2-13-36" class="i">+                    Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h2-13-37" id="h2-13-37" class="i">+                    Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h2-13-38" id="h2-13-38" class="i">+                    Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-13-39" id="h2-13-39" class="i">+                ],
</a><a href="#h2-13-40" id="h2-13-40" class="i">+            },
</a><a href="#h2-13-41" id="h2-13-41" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-14" id="h2-14" class="h">@@ -620,27 +602,26 @@ pub mod tests {
</a>                 event: Event::AcceptEntries { last_index: 4 },
             }],
         );
<a href="#h2-14-3" id="h2-14-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries replaces conflicting entries
<a href="#h2-14-8" id="h2-14-8" class="d">-    fn step_replicateentries_replace() {
</a><a href="#h2-14-9" id="h2-14-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-14-10" id="h2-14-10" class="d">-        let node = follower
</a><a href="#h2-14-11" id="h2-14-11" class="d">-            .step(Message {
</a><a href="#h2-14-12" id="h2-14-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-14-13" id="h2-14-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-14-14" id="h2-14-14" class="d">-                term: 3,
</a><a href="#h2-14-15" id="h2-14-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-14-16" id="h2-14-16" class="d">-                    base_index: 2,
</a><a href="#h2-14-17" id="h2-14-17" class="d">-                    base_term: 1,
</a><a href="#h2-14-18" id="h2-14-18" class="d">-                    entries: vec![
</a><a href="#h2-14-19" id="h2-14-19" class="d">-                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-14-20" id="h2-14-20" class="d">-                        Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h2-14-21" id="h2-14-21" class="d">-                    ],
</a><a href="#h2-14-22" id="h2-14-22" class="d">-                },
</a><a href="#h2-14-23" id="h2-14-23" class="d">-            })
</a><a href="#h2-14-24" id="h2-14-24" class="d">-            .unwrap();
</a><a href="#h2-14-25" id="h2-14-25" class="i">+    fn step_replicateentries_replace() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-14-26" id="h2-14-26" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-14-27" id="h2-14-27" class="i">+        let node = follower.step(Message {
</a><a href="#h2-14-28" id="h2-14-28" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-14-29" id="h2-14-29" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-14-30" id="h2-14-30" class="i">+            term: 3,
</a><a href="#h2-14-31" id="h2-14-31" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-14-32" id="h2-14-32" class="i">+                base_index: 2,
</a><a href="#h2-14-33" id="h2-14-33" class="i">+                base_term: 1,
</a><a href="#h2-14-34" id="h2-14-34" class="i">+                entries: vec![
</a><a href="#h2-14-35" id="h2-14-35" class="i">+                    Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-14-36" id="h2-14-36" class="i">+                    Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h2-14-37" id="h2-14-37" class="i">+                ],
</a><a href="#h2-14-38" id="h2-14-38" class="i">+            },
</a><a href="#h2-14-39" id="h2-14-39" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-15" id="h2-15" class="h">@@ -656,27 +637,26 @@ pub mod tests {
</a>                 event: Event::AcceptEntries { last_index: 4 },
             }],
         );
<a href="#h2-15-3" id="h2-15-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries replaces partially conflicting entries
<a href="#h2-15-8" id="h2-15-8" class="d">-    fn step_replicateentries_replace_partial() {
</a><a href="#h2-15-9" id="h2-15-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-15-10" id="h2-15-10" class="d">-        let node = follower
</a><a href="#h2-15-11" id="h2-15-11" class="d">-            .step(Message {
</a><a href="#h2-15-12" id="h2-15-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-15-13" id="h2-15-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-15-14" id="h2-15-14" class="d">-                term: 3,
</a><a href="#h2-15-15" id="h2-15-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-15-16" id="h2-15-16" class="d">-                    base_index: 2,
</a><a href="#h2-15-17" id="h2-15-17" class="d">-                    base_term: 1,
</a><a href="#h2-15-18" id="h2-15-18" class="d">-                    entries: vec![
</a><a href="#h2-15-19" id="h2-15-19" class="d">-                        Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h2-15-20" id="h2-15-20" class="d">-                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-15-21" id="h2-15-21" class="d">-                    ],
</a><a href="#h2-15-22" id="h2-15-22" class="d">-                },
</a><a href="#h2-15-23" id="h2-15-23" class="d">-            })
</a><a href="#h2-15-24" id="h2-15-24" class="d">-            .unwrap();
</a><a href="#h2-15-25" id="h2-15-25" class="i">+    fn step_replicateentries_replace_partial() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-15-26" id="h2-15-26" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-15-27" id="h2-15-27" class="i">+        let node = follower.step(Message {
</a><a href="#h2-15-28" id="h2-15-28" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-15-29" id="h2-15-29" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-15-30" id="h2-15-30" class="i">+            term: 3,
</a><a href="#h2-15-31" id="h2-15-31" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-15-32" id="h2-15-32" class="i">+                base_index: 2,
</a><a href="#h2-15-33" id="h2-15-33" class="i">+                base_term: 1,
</a><a href="#h2-15-34" id="h2-15-34" class="i">+                entries: vec![
</a><a href="#h2-15-35" id="h2-15-35" class="i">+                    Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h2-15-36" id="h2-15-36" class="i">+                    Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h2-15-37" id="h2-15-37" class="i">+                ],
</a><a href="#h2-15-38" id="h2-15-38" class="i">+            },
</a><a href="#h2-15-39" id="h2-15-39" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-16" id="h2-16" class="h">@@ -692,24 +672,23 @@ pub mod tests {
</a>                 event: Event::AcceptEntries { last_index: 4 },
             }],
         );
<a href="#h2-16-3" id="h2-16-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries rejects missing base index
<a href="#h2-16-8" id="h2-16-8" class="d">-    fn step_replicateentries_reject_missing_base_index() {
</a><a href="#h2-16-9" id="h2-16-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-16-10" id="h2-16-10" class="d">-        let node = follower
</a><a href="#h2-16-11" id="h2-16-11" class="d">-            .step(Message {
</a><a href="#h2-16-12" id="h2-16-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-16-13" id="h2-16-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-16-14" id="h2-16-14" class="d">-                term: 3,
</a><a href="#h2-16-15" id="h2-16-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-16-16" id="h2-16-16" class="d">-                    base_index: 5,
</a><a href="#h2-16-17" id="h2-16-17" class="d">-                    base_term: 2,
</a><a href="#h2-16-18" id="h2-16-18" class="d">-                    entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h2-16-19" id="h2-16-19" class="d">-                },
</a><a href="#h2-16-20" id="h2-16-20" class="d">-            })
</a><a href="#h2-16-21" id="h2-16-21" class="d">-            .unwrap();
</a><a href="#h2-16-22" id="h2-16-22" class="i">+    fn step_replicateentries_reject_missing_base_index() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-16-23" id="h2-16-23" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-16-24" id="h2-16-24" class="i">+        let node = follower.step(Message {
</a><a href="#h2-16-25" id="h2-16-25" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-16-26" id="h2-16-26" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-16-27" id="h2-16-27" class="i">+            term: 3,
</a><a href="#h2-16-28" id="h2-16-28" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-16-29" id="h2-16-29" class="i">+                base_index: 5,
</a><a href="#h2-16-30" id="h2-16-30" class="i">+                base_term: 2,
</a><a href="#h2-16-31" id="h2-16-31" class="i">+                entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h2-16-32" id="h2-16-32" class="i">+            },
</a><a href="#h2-16-33" id="h2-16-33" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-17" id="h2-17" class="h">@@ -724,24 +703,23 @@ pub mod tests {
</a>                 event: Event::RejectEntries,
             }],
         );
<a href="#h2-17-3" id="h2-17-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReplicateEntries rejects conflicting base term
<a href="#h2-17-8" id="h2-17-8" class="d">-    fn step_replicateentries_reject_missing_base_term() {
</a><a href="#h2-17-9" id="h2-17-9" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-17-10" id="h2-17-10" class="d">-        let node = follower
</a><a href="#h2-17-11" id="h2-17-11" class="d">-            .step(Message {
</a><a href="#h2-17-12" id="h2-17-12" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-17-13" id="h2-17-13" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-17-14" id="h2-17-14" class="d">-                term: 3,
</a><a href="#h2-17-15" id="h2-17-15" class="d">-                event: Event::ReplicateEntries {
</a><a href="#h2-17-16" id="h2-17-16" class="d">-                    base_index: 1,
</a><a href="#h2-17-17" id="h2-17-17" class="d">-                    base_term: 2,
</a><a href="#h2-17-18" id="h2-17-18" class="d">-                    entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h2-17-19" id="h2-17-19" class="d">-                },
</a><a href="#h2-17-20" id="h2-17-20" class="d">-            })
</a><a href="#h2-17-21" id="h2-17-21" class="d">-            .unwrap();
</a><a href="#h2-17-22" id="h2-17-22" class="i">+    fn step_replicateentries_reject_missing_base_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-17-23" id="h2-17-23" class="i">+        let (follower, rx) = setup()?;
</a><a href="#h2-17-24" id="h2-17-24" class="i">+        let node = follower.step(Message {
</a><a href="#h2-17-25" id="h2-17-25" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-17-26" id="h2-17-26" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-17-27" id="h2-17-27" class="i">+            term: 3,
</a><a href="#h2-17-28" id="h2-17-28" class="i">+            event: Event::ReplicateEntries {
</a><a href="#h2-17-29" id="h2-17-29" class="i">+                base_index: 1,
</a><a href="#h2-17-30" id="h2-17-30" class="i">+                base_term: 2,
</a><a href="#h2-17-31" id="h2-17-31" class="i">+                entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h2-17-32" id="h2-17-32" class="i">+            },
</a><a href="#h2-17-33" id="h2-17-33" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(3).entries(vec![
             Entry { term: 1, command: Some(vec![0x01]) },
             Entry { term: 1, command: Some(vec![0x02]) },
<a href="#h2-18" id="h2-18" class="h">@@ -756,11 +734,12 @@ pub mod tests {
</a>                 event: Event::RejectEntries,
             }],
         );
<a href="#h2-18-3" id="h2-18-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ReadState and MutateState are proxied, as are the responses
<a href="#h2-18-8" id="h2-18-8" class="d">-    fn step_readstate_mutatestate_respond() {
</a><a href="#h2-18-9" id="h2-18-9" class="i">+    fn step_readstate_mutatestate_respond() -&gt; Result&lt;(), Error&gt; {
</a>         let calls = vec![
             Event::MutateState { call_id: vec![0x02], command: vec![0x02] },
             Event::QueryState { call_id: vec![0x01], command: vec![0x01] },
<a href="#h2-19" id="h2-19" class="h">@@ -769,13 +748,11 @@ pub mod tests {
</a>             Event::RespondError { call_id: vec![], error: Error::Internal(&quot;b00m&quot;.into()) },
             Event::RespondState { call_id: vec![], response: vec![0xaf] },
         ];
<a href="#h2-19-3" id="h2-19-3" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-19-4" id="h2-19-4" class="i">+        let (follower, rx) = setup()?;
</a>         let mut node = Node::Follower(follower);
         for call in calls.into_iter() {
             for mut response in responses.clone().into_iter() {
<a href="#h2-19-8" id="h2-19-8" class="d">-                node = node
</a><a href="#h2-19-9" id="h2-19-9" class="d">-                    .step(Message { from: None, to: None, term: 0, event: call.clone() })
</a><a href="#h2-19-10" id="h2-19-10" class="d">-                    .unwrap();
</a><a href="#h2-19-11" id="h2-19-11" class="i">+                node = node.step(Message { from: None, to: None, term: 0, event: call.clone() })?;
</a>                 assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
                 assert_messages(
                     &amp;rx,
<a href="#h2-20" id="h2-20" class="h">@@ -795,14 +772,12 @@ pub mod tests {
</a>                 }
                 // Multiple responses should only be proxied once.
                 for _ in 0..3 {
<a href="#h2-20-3" id="h2-20-3" class="d">-                    node = node
</a><a href="#h2-20-4" id="h2-20-4" class="d">-                        .step(Message {
</a><a href="#h2-20-5" id="h2-20-5" class="d">-                            from: Some(&quot;b&quot;.into()),
</a><a href="#h2-20-6" id="h2-20-6" class="d">-                            to: Some(&quot;a&quot;.into()),
</a><a href="#h2-20-7" id="h2-20-7" class="d">-                            term: 3,
</a><a href="#h2-20-8" id="h2-20-8" class="d">-                            event: response.clone(),
</a><a href="#h2-20-9" id="h2-20-9" class="d">-                        })
</a><a href="#h2-20-10" id="h2-20-10" class="d">-                        .unwrap();
</a><a href="#h2-20-11" id="h2-20-11" class="i">+                    node = node.step(Message {
</a><a href="#h2-20-12" id="h2-20-12" class="i">+                        from: Some(&quot;b&quot;.into()),
</a><a href="#h2-20-13" id="h2-20-13" class="i">+                        to: Some(&quot;a&quot;.into()),
</a><a href="#h2-20-14" id="h2-20-14" class="i">+                        term: 3,
</a><a href="#h2-20-15" id="h2-20-15" class="i">+                        event: response.clone(),
</a><a href="#h2-20-16" id="h2-20-16" class="i">+                    })?;
</a>                 }
                 assert_messages(
                     &amp;rx,
<a href="#h2-21" id="h2-21" class="h">@@ -810,11 +785,12 @@ pub mod tests {
</a>                 );
             }
         }
<a href="#h2-21-3" id="h2-21-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h2-21-7" id="h2-21-7" class="d">-    fn tick() {
</a><a href="#h2-21-8" id="h2-21-8" class="d">-        let (follower, rx) = setup();
</a><a href="#h2-21-9" id="h2-21-9" class="i">+    fn tick() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-21-10" id="h2-21-10" class="i">+        let (follower, rx) = setup()?;
</a>         let timeout = follower.role.leader_seen_timeout;
         let peers = follower.peers.clone();
         let mut node = Node::Follower(follower);
<a href="#h2-22" id="h2-22" class="h">@@ -824,15 +800,13 @@ pub mod tests {
</a>         for i in 0..(3 * timeout) {
             let applied = if i &gt; 0 { 2 } else { 1 };
             assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).applied(applied);
<a href="#h2-22-3" id="h2-22-3" class="d">-            node = node.tick().unwrap();
</a><a href="#h2-22-4" id="h2-22-4" class="d">-            node = node
</a><a href="#h2-22-5" id="h2-22-5" class="d">-                .step(Message {
</a><a href="#h2-22-6" id="h2-22-6" class="d">-                    from: Some(&quot;b&quot;.into()),
</a><a href="#h2-22-7" id="h2-22-7" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h2-22-8" id="h2-22-8" class="d">-                    term: 3,
</a><a href="#h2-22-9" id="h2-22-9" class="d">-                    event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
</a><a href="#h2-22-10" id="h2-22-10" class="d">-                })
</a><a href="#h2-22-11" id="h2-22-11" class="d">-                .unwrap();
</a><a href="#h2-22-12" id="h2-22-12" class="i">+            node = node.tick()?;
</a><a href="#h2-22-13" id="h2-22-13" class="i">+            node = node.step(Message {
</a><a href="#h2-22-14" id="h2-22-14" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h2-22-15" id="h2-22-15" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h2-22-16" id="h2-22-16" class="i">+                term: 3,
</a><a href="#h2-22-17" id="h2-22-17" class="i">+                event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
</a><a href="#h2-22-18" id="h2-22-18" class="i">+            })?;
</a>             assert_messages(
                 &amp;rx,
                 vec![Message {
<a href="#h2-23" id="h2-23" class="h">@@ -846,14 +820,14 @@ pub mod tests {
</a> 
         for _ in 0..timeout {
             assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
<a href="#h2-23-3" id="h2-23-3" class="d">-            node = node.tick().unwrap();
</a><a href="#h2-23-4" id="h2-23-4" class="i">+            node = node.tick()?;
</a>         }
         assert_node(&amp;node).is_candidate().term(4);
 
         for to in peers.into_iter() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h2-23-11" id="h2-23-11" class="d">-                rx.recv().unwrap(),
</a><a href="#h2-23-12" id="h2-23-12" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h2-24" id="h2-24" class="h">@@ -862,5 +836,6 @@ pub mod tests {
</a>                 }
             )
         }
<a href="#h2-24-3" id="h2-24-3" class="i">+        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h3" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -291,17 +291,18 @@ mod tests {
</a>     use super::*;
     use crossbeam::channel::Receiver;
 
<a href="#h3-0-3" id="h3-0-3" class="d">-    fn setup() -&gt; (RoleNode&lt;Leader, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    fn setup(
</a><a href="#h3-0-5" id="h3-0-5" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;Leader, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a>         let (sender, receiver) = crossbeam::channel::unbounded();
         let mut state = TestState::new();
<a href="#h3-0-8" id="h3-0-8" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a><a href="#h3-0-9" id="h3-0-9" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h3-0-10" id="h3-0-10" class="d">-        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h3-0-11" id="h3-0-11" class="d">-        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h3-0-12" id="h3-0-12" class="d">-        log.append(Entry { term: 3, command: Some(vec![0x04]) }).unwrap();
</a><a href="#h3-0-13" id="h3-0-13" class="d">-        log.append(Entry { term: 3, command: Some(vec![0x05]) }).unwrap();
</a><a href="#h3-0-14" id="h3-0-14" class="d">-        log.commit(2).unwrap();
</a><a href="#h3-0-15" id="h3-0-15" class="d">-        log.apply(&amp;mut state).unwrap();
</a><a href="#h3-0-16" id="h3-0-16" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h3-0-17" id="h3-0-17" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
</a><a href="#h3-0-18" id="h3-0-18" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
</a><a href="#h3-0-19" id="h3-0-19" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
</a><a href="#h3-0-20" id="h3-0-20" class="i">+        log.append(Entry { term: 3, command: Some(vec![0x04]) })?;
</a><a href="#h3-0-21" id="h3-0-21" class="i">+        log.append(Entry { term: 3, command: Some(vec![0x05]) })?;
</a><a href="#h3-0-22" id="h3-0-22" class="i">+        log.commit(2)?;
</a><a href="#h3-0-23" id="h3-0-23" class="i">+        log.apply(&amp;mut state)?;
</a> 
         let peers = vec![&quot;b&quot;.into(), &quot;c&quot;.into(), &quot;d&quot;.into(), &quot;e&quot;.into()];
         let (last_index, _) = log.get_last();
<a href="#h3-1" id="h3-1" class="h">@@ -315,42 +316,39 @@ mod tests {
</a>             sender,
             role: Leader::new(peers, last_index),
         };
<a href="#h3-1-3" id="h3-1-3" class="d">-        node.save_term(3, None).unwrap();
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        (node, receiver)
</a><a href="#h3-1-5" id="h3-1-5" class="i">+        node.save_term(3, None)?;
</a><a href="#h3-1-6" id="h3-1-6" class="i">+        Ok((node, receiver))
</a>     }
 
     #[test]
     // ConfirmLeader with has_committed has no effect without any calls
<a href="#h3-1-11" id="h3-1-11" class="d">-    fn step_confirmleader() {
</a><a href="#h3-1-12" id="h3-1-12" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-1-13" id="h3-1-13" class="i">+    fn step_confirmleader() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-1-14" id="h3-1-14" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-1-17" id="h3-1-17" class="d">-        node = node
</a><a href="#h3-1-18" id="h3-1-18" class="d">-            .step(Message {
</a><a href="#h3-1-19" id="h3-1-19" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-1-20" id="h3-1-20" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-1-21" id="h3-1-21" class="d">-                term: 3,
</a><a href="#h3-1-22" id="h3-1-22" class="d">-                event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
</a><a href="#h3-1-23" id="h3-1-23" class="d">-            })
</a><a href="#h3-1-24" id="h3-1-24" class="d">-            .unwrap();
</a><a href="#h3-1-25" id="h3-1-25" class="i">+        node = node.step(Message {
</a><a href="#h3-1-26" id="h3-1-26" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-1-27" id="h3-1-27" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-1-28" id="h3-1-28" class="i">+            term: 3,
</a><a href="#h3-1-29" id="h3-1-29" class="i">+            event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
</a><a href="#h3-1-30" id="h3-1-30" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
         assert_messages(&amp;rx, vec![]);
<a href="#h3-1-33" id="h3-1-33" class="i">+        Ok(())
</a>     }
 
     #[test]
     // ConfirmLeader without has_committed triggers replication
<a href="#h3-1-38" id="h3-1-38" class="d">-    fn step_confirmleader_without_has_committed() {
</a><a href="#h3-1-39" id="h3-1-39" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-1-40" id="h3-1-40" class="i">+    fn step_confirmleader_without_has_committed() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-1-41" id="h3-1-41" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-1-44" id="h3-1-44" class="d">-        node = node
</a><a href="#h3-1-45" id="h3-1-45" class="d">-            .step(Message {
</a><a href="#h3-1-46" id="h3-1-46" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-1-47" id="h3-1-47" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-1-48" id="h3-1-48" class="d">-                term: 3,
</a><a href="#h3-1-49" id="h3-1-49" class="d">-                event: Event::ConfirmLeader { commit_index: 2, has_committed: false },
</a><a href="#h3-1-50" id="h3-1-50" class="d">-            })
</a><a href="#h3-1-51" id="h3-1-51" class="d">-            .unwrap();
</a><a href="#h3-1-52" id="h3-1-52" class="i">+        node = node.step(Message {
</a><a href="#h3-1-53" id="h3-1-53" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-1-54" id="h3-1-54" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-1-55" id="h3-1-55" class="i">+            term: 3,
</a><a href="#h3-1-56" id="h3-1-56" class="i">+            event: Event::ConfirmLeader { commit_index: 2, has_committed: false },
</a><a href="#h3-1-57" id="h3-1-57" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
         assert_messages(
             &amp;rx,
<a href="#h3-2" id="h3-2" class="h">@@ -361,40 +359,38 @@ mod tests {
</a>                 event: Event::ReplicateEntries { base_index: 5, base_term: 3, entries: vec![] },
             }],
         );
<a href="#h3-2-3" id="h3-2-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeats from other leaders in current term are ignored.
<a href="#h3-2-8" id="h3-2-8" class="d">-    fn step_heartbeat_current_term() {
</a><a href="#h3-2-9" id="h3-2-9" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-2-10" id="h3-2-10" class="i">+    fn step_heartbeat_current_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-2-11" id="h3-2-11" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-2-14" id="h3-2-14" class="d">-        node = node
</a><a href="#h3-2-15" id="h3-2-15" class="d">-            .step(Message {
</a><a href="#h3-2-16" id="h3-2-16" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-2-17" id="h3-2-17" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-2-18" id="h3-2-18" class="d">-                term: 3,
</a><a href="#h3-2-19" id="h3-2-19" class="d">-                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h3-2-20" id="h3-2-20" class="d">-            })
</a><a href="#h3-2-21" id="h3-2-21" class="d">-            .unwrap();
</a><a href="#h3-2-22" id="h3-2-22" class="i">+        node = node.step(Message {
</a><a href="#h3-2-23" id="h3-2-23" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-2-24" id="h3-2-24" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-2-25" id="h3-2-25" class="i">+            term: 3,
</a><a href="#h3-2-26" id="h3-2-26" class="i">+            event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h3-2-27" id="h3-2-27" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
         assert_messages(&amp;rx, vec![]);
<a href="#h3-2-30" id="h3-2-30" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeats from other leaders in future term converts to follower and steps.
<a href="#h3-2-35" id="h3-2-35" class="d">-    fn step_heartbeat_future_term() {
</a><a href="#h3-2-36" id="h3-2-36" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-2-37" id="h3-2-37" class="i">+    fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-2-38" id="h3-2-38" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-2-41" id="h3-2-41" class="d">-        node = node
</a><a href="#h3-2-42" id="h3-2-42" class="d">-            .step(Message {
</a><a href="#h3-2-43" id="h3-2-43" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-2-44" id="h3-2-44" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-2-45" id="h3-2-45" class="d">-                term: 4,
</a><a href="#h3-2-46" id="h3-2-46" class="d">-                event: Event::Heartbeat { commit_index: 7, commit_term: 4 },
</a><a href="#h3-2-47" id="h3-2-47" class="d">-            })
</a><a href="#h3-2-48" id="h3-2-48" class="d">-            .unwrap();
</a><a href="#h3-2-49" id="h3-2-49" class="i">+        node = node.step(Message {
</a><a href="#h3-2-50" id="h3-2-50" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-2-51" id="h3-2-51" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-2-52" id="h3-2-52" class="i">+            term: 4,
</a><a href="#h3-2-53" id="h3-2-53" class="i">+            event: Event::Heartbeat { commit_index: 7, commit_term: 4 },
</a><a href="#h3-2-54" id="h3-2-54" class="i">+        })?;
</a>         assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;b&quot;)).committed(2).applied(1);
         assert_messages(
             &amp;rx,
<a href="#h3-3" id="h3-3" class="h">@@ -405,124 +401,115 @@ mod tests {
</a>                 event: Event::ConfirmLeader { commit_index: 7, has_committed: false },
             }],
         );
<a href="#h3-3-3" id="h3-3-3" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Heartbeats from other leaders in past terms are ignored.
<a href="#h3-3-8" id="h3-3-8" class="d">-    fn step_heartbeat_past_term() {
</a><a href="#h3-3-9" id="h3-3-9" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-3-10" id="h3-3-10" class="i">+    fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-3-11" id="h3-3-11" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-3-14" id="h3-3-14" class="d">-        node = node
</a><a href="#h3-3-15" id="h3-3-15" class="d">-            .step(Message {
</a><a href="#h3-3-16" id="h3-3-16" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-17" id="h3-3-17" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-18" id="h3-3-18" class="d">-                term: 2,
</a><a href="#h3-3-19" id="h3-3-19" class="d">-                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h3-3-20" id="h3-3-20" class="d">-            })
</a><a href="#h3-3-21" id="h3-3-21" class="d">-            .unwrap();
</a><a href="#h3-3-22" id="h3-3-22" class="i">+        node = node.step(Message {
</a><a href="#h3-3-23" id="h3-3-23" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-24" id="h3-3-24" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-25" id="h3-3-25" class="i">+            term: 2,
</a><a href="#h3-3-26" id="h3-3-26" class="i">+            event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h3-3-27" id="h3-3-27" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
         assert_messages(&amp;rx, vec![]);
<a href="#h3-3-30" id="h3-3-30" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-3-34" id="h3-3-34" class="d">-    fn step_acceptentries() {
</a><a href="#h3-3-35" id="h3-3-35" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-3-36" id="h3-3-36" class="i">+    fn step_acceptentries() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-3-37" id="h3-3-37" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h3-3-40" id="h3-3-40" class="d">-        node = node
</a><a href="#h3-3-41" id="h3-3-41" class="d">-            .step(Message {
</a><a href="#h3-3-42" id="h3-3-42" class="d">-                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-43" id="h3-3-43" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-44" id="h3-3-44" class="d">-                term: 3,
</a><a href="#h3-3-45" id="h3-3-45" class="d">-                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h3-3-46" id="h3-3-46" class="d">-            })
</a><a href="#h3-3-47" id="h3-3-47" class="d">-            .unwrap();
</a><a href="#h3-3-48" id="h3-3-48" class="i">+        node = node.step(Message {
</a><a href="#h3-3-49" id="h3-3-49" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-50" id="h3-3-50" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-51" id="h3-3-51" class="i">+            term: 3,
</a><a href="#h3-3-52" id="h3-3-52" class="i">+            event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h3-3-53" id="h3-3-53" class="i">+        })?;
</a>         assert_node(&amp;node).committed(2).applied(2);
         assert_messages(&amp;rx, vec![]);
 
<a href="#h3-3-57" id="h3-3-57" class="d">-        node = node
</a><a href="#h3-3-58" id="h3-3-58" class="d">-            .step(Message {
</a><a href="#h3-3-59" id="h3-3-59" class="d">-                from: Some(&quot;c&quot;.into()),
</a><a href="#h3-3-60" id="h3-3-60" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-61" id="h3-3-61" class="d">-                term: 3,
</a><a href="#h3-3-62" id="h3-3-62" class="d">-                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-63" id="h3-3-63" class="d">-            })
</a><a href="#h3-3-64" id="h3-3-64" class="d">-            .unwrap();
</a><a href="#h3-3-65" id="h3-3-65" class="i">+        node = node.step(Message {
</a><a href="#h3-3-66" id="h3-3-66" class="i">+            from: Some(&quot;c&quot;.into()),
</a><a href="#h3-3-67" id="h3-3-67" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-68" id="h3-3-68" class="i">+            term: 3,
</a><a href="#h3-3-69" id="h3-3-69" class="i">+            event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-70" id="h3-3-70" class="i">+        })?;
</a>         assert_node(&amp;node).committed(4).applied(4);
         assert_messages(&amp;rx, vec![]);
 
<a href="#h3-3-74" id="h3-3-74" class="d">-        node = node
</a><a href="#h3-3-75" id="h3-3-75" class="d">-            .step(Message {
</a><a href="#h3-3-76" id="h3-3-76" class="d">-                from: Some(&quot;d&quot;.into()),
</a><a href="#h3-3-77" id="h3-3-77" class="d">-                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-78" id="h3-3-78" class="d">-                term: 3,
</a><a href="#h3-3-79" id="h3-3-79" class="d">-                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-80" id="h3-3-80" class="d">-            })
</a><a href="#h3-3-81" id="h3-3-81" class="d">-            .unwrap();
</a><a href="#h3-3-82" id="h3-3-82" class="i">+        node = node.step(Message {
</a><a href="#h3-3-83" id="h3-3-83" class="i">+            from: Some(&quot;d&quot;.into()),
</a><a href="#h3-3-84" id="h3-3-84" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-85" id="h3-3-85" class="i">+            term: 3,
</a><a href="#h3-3-86" id="h3-3-86" class="i">+            event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-87" id="h3-3-87" class="i">+        })?;
</a>         assert_node(&amp;node).committed(5).applied(5);
         assert_messages(&amp;rx, vec![]);
 
         assert_node(&amp;node).is_leader().term(3);
<a href="#h3-3-92" id="h3-3-92" class="i">+        Ok(())
</a>     }
 
     #[test]
     // Duplicate AcceptEntries from single node should not trigger commit.
<a href="#h3-3-97" id="h3-3-97" class="d">-    fn step_acceptentries_duplicate() {
</a><a href="#h3-3-98" id="h3-3-98" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-3-99" id="h3-3-99" class="i">+    fn step_acceptentries_duplicate() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-3-100" id="h3-3-100" class="i">+        let (leader, rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         for _ in 0..5 {
<a href="#h3-3-104" id="h3-3-104" class="d">-            node = node
</a><a href="#h3-3-105" id="h3-3-105" class="d">-                .step(Message {
</a><a href="#h3-3-106" id="h3-3-106" class="d">-                    from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-107" id="h3-3-107" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-108" id="h3-3-108" class="d">-                    term: 3,
</a><a href="#h3-3-109" id="h3-3-109" class="d">-                    event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-110" id="h3-3-110" class="d">-                })
</a><a href="#h3-3-111" id="h3-3-111" class="d">-                .unwrap();
</a><a href="#h3-3-112" id="h3-3-112" class="i">+            node = node.step(Message {
</a><a href="#h3-3-113" id="h3-3-113" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-3-114" id="h3-3-114" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-115" id="h3-3-115" class="i">+                term: 3,
</a><a href="#h3-3-116" id="h3-3-116" class="i">+                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h3-3-117" id="h3-3-117" class="i">+            })?;
</a>             assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
             assert_messages(&amp;rx, vec![]);
         }
<a href="#h3-3-121" id="h3-3-121" class="i">+        Ok(())
</a>     }
 
     #[test]
     // AcceptEntries quorum for entry in past term should not trigger commit
<a href="#h3-3-126" id="h3-3-126" class="d">-    fn step_acceptentries_past_term() {
</a><a href="#h3-3-127" id="h3-3-127" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-3-128" id="h3-3-128" class="i">+    fn step_acceptentries_past_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-3-129" id="h3-3-129" class="i">+        let (leader, rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
 
         for peer in peers.into_iter() {
<a href="#h3-3-134" id="h3-3-134" class="d">-            node = node
</a><a href="#h3-3-135" id="h3-3-135" class="d">-                .step(Message {
</a><a href="#h3-3-136" id="h3-3-136" class="d">-                    from: Some(peer),
</a><a href="#h3-3-137" id="h3-3-137" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-138" id="h3-3-138" class="d">-                    term: 3,
</a><a href="#h3-3-139" id="h3-3-139" class="d">-                    event: Event::AcceptEntries { last_index: 3 },
</a><a href="#h3-3-140" id="h3-3-140" class="d">-                })
</a><a href="#h3-3-141" id="h3-3-141" class="d">-                .unwrap();
</a><a href="#h3-3-142" id="h3-3-142" class="i">+            node = node.step(Message {
</a><a href="#h3-3-143" id="h3-3-143" class="i">+                from: Some(peer),
</a><a href="#h3-3-144" id="h3-3-144" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-145" id="h3-3-145" class="i">+                term: 3,
</a><a href="#h3-3-146" id="h3-3-146" class="i">+                event: Event::AcceptEntries { last_index: 3 },
</a><a href="#h3-3-147" id="h3-3-147" class="i">+            })?;
</a>             assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
             assert_messages(&amp;rx, vec![]);
         }
<a href="#h3-3-151" id="h3-3-151" class="i">+        Ok(())
</a>     }
 
     #[test]
     // AcceptEntries quorum for missing future entry
<a href="#h3-3-156" id="h3-3-156" class="d">-    fn step_acceptentries_future_index() {
</a><a href="#h3-3-157" id="h3-3-157" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-3-158" id="h3-3-158" class="i">+    fn step_acceptentries_future_index() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-3-159" id="h3-3-159" class="i">+        let (leader, rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
 
         for (i, peer) in peers.into_iter().enumerate() {
<a href="#h3-3-164" id="h3-3-164" class="d">-            node = node
</a><a href="#h3-3-165" id="h3-3-165" class="d">-                .step(Message {
</a><a href="#h3-3-166" id="h3-3-166" class="d">-                    from: Some(peer),
</a><a href="#h3-3-167" id="h3-3-167" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-168" id="h3-3-168" class="d">-                    term: 3,
</a><a href="#h3-3-169" id="h3-3-169" class="d">-                    event: Event::AcceptEntries { last_index: 7 },
</a><a href="#h3-3-170" id="h3-3-170" class="d">-                })
</a><a href="#h3-3-171" id="h3-3-171" class="d">-                .unwrap();
</a><a href="#h3-3-172" id="h3-3-172" class="i">+            node = node.step(Message {
</a><a href="#h3-3-173" id="h3-3-173" class="i">+                from: Some(peer),
</a><a href="#h3-3-174" id="h3-3-174" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-3-175" id="h3-3-175" class="i">+                term: 3,
</a><a href="#h3-3-176" id="h3-3-176" class="i">+                event: Event::AcceptEntries { last_index: 7 },
</a><a href="#h3-3-177" id="h3-3-177" class="i">+            })?;
</a>             // The local leader will cast a vote to commit 5, thus
             // when we have votes 2x7, 1x5, 2x0 we will commit index 5.
             // However, we will correctly ignore the following votes for 7.
<a href="#h3-4" id="h3-4" class="h">@@ -530,23 +517,22 @@ mod tests {
</a>             assert_node(&amp;node).is_leader().term(3).committed(c).applied(c).last(5);
             assert_messages(&amp;rx, vec![]);
         }
<a href="#h3-4-3" id="h3-4-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-4-7" id="h3-4-7" class="d">-    fn step_rejectentries() {
</a><a href="#h3-4-8" id="h3-4-8" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-4-9" id="h3-4-9" class="d">-        let entries = leader.log.range(0..).unwrap();
</a><a href="#h3-4-10" id="h3-4-10" class="i">+    fn step_rejectentries() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-4-11" id="h3-4-11" class="i">+        let (leader, rx) = setup()?;
</a><a href="#h3-4-12" id="h3-4-12" class="i">+        let entries = leader.log.range(0..)?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         for i in 0..(entries.len() + 3) {
<a href="#h3-4-16" id="h3-4-16" class="d">-            node = node
</a><a href="#h3-4-17" id="h3-4-17" class="d">-                .step(Message {
</a><a href="#h3-4-18" id="h3-4-18" class="d">-                    from: Some(&quot;b&quot;.into()),
</a><a href="#h3-4-19" id="h3-4-19" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-4-20" id="h3-4-20" class="d">-                    term: 3,
</a><a href="#h3-4-21" id="h3-4-21" class="d">-                    event: Event::RejectEntries,
</a><a href="#h3-4-22" id="h3-4-22" class="d">-                })
</a><a href="#h3-4-23" id="h3-4-23" class="d">-                .unwrap();
</a><a href="#h3-4-24" id="h3-4-24" class="i">+            node = node.step(Message {
</a><a href="#h3-4-25" id="h3-4-25" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h3-4-26" id="h3-4-26" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-4-27" id="h3-4-27" class="i">+                term: 3,
</a><a href="#h3-4-28" id="h3-4-28" class="i">+                event: Event::RejectEntries,
</a><a href="#h3-4-29" id="h3-4-29" class="i">+            })?;
</a>             assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
             let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
             let replicate = entries.get(index..).unwrap().to_vec();
<a href="#h3-5" id="h3-5" class="h">@@ -568,11 +554,12 @@ mod tests {
</a>                 }],
             );
         }
<a href="#h3-5-3" id="h3-5-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-5-7" id="h3-5-7" class="d">-    fn step_mutatestate_readstate() {
</a><a href="#h3-5-8" id="h3-5-8" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-5-9" id="h3-5-9" class="i">+    fn step_mutatestate_readstate() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-5-10" id="h3-5-10" class="i">+        let (leader, rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let quorum = leader.quorum();
         let mut node: Node&lt;_, _&gt; = leader.into();
<a href="#h3-6" id="h3-6" class="h">@@ -583,14 +570,12 @@ mod tests {
</a>         // a 0xff prefix, and a subsequent read command can read back the
         // command at the index given by the command with the result prefixed
         // with 0xbb.
<a href="#h3-6-3" id="h3-6-3" class="d">-        node = node
</a><a href="#h3-6-4" id="h3-6-4" class="d">-            .step(Message {
</a><a href="#h3-6-5" id="h3-6-5" class="d">-                from: None,
</a><a href="#h3-6-6" id="h3-6-6" class="d">-                to: None,
</a><a href="#h3-6-7" id="h3-6-7" class="d">-                term: 0,
</a><a href="#h3-6-8" id="h3-6-8" class="d">-                event: Event::MutateState { call_id: vec![0x01], command: vec![0xaf] },
</a><a href="#h3-6-9" id="h3-6-9" class="d">-            })
</a><a href="#h3-6-10" id="h3-6-10" class="d">-            .unwrap();
</a><a href="#h3-6-11" id="h3-6-11" class="i">+        node = node.step(Message {
</a><a href="#h3-6-12" id="h3-6-12" class="i">+            from: None,
</a><a href="#h3-6-13" id="h3-6-13" class="i">+            to: None,
</a><a href="#h3-6-14" id="h3-6-14" class="i">+            term: 0,
</a><a href="#h3-6-15" id="h3-6-15" class="i">+            event: Event::MutateState { call_id: vec![0x01], command: vec![0xaf] },
</a><a href="#h3-6-16" id="h3-6-16" class="i">+        })?;
</a>         assert_node(&amp;node)
             .is_leader()
             .term(3)
<a href="#h3-7" id="h3-7" class="h">@@ -601,7 +586,7 @@ mod tests {
</a>         for peer in peers.iter().cloned() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h3-7-3" id="h3-7-3" class="d">-                rx.recv().unwrap(),
</a><a href="#h3-7-4" id="h3-7-4" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(peer),
<a href="#h3-8" id="h3-8" class="h">@@ -618,14 +603,12 @@ mod tests {
</a>         // Receive some ConfirmLeader messages from peers, to make sure
         // they do not affect mutation calls at all.
         for peer in peers.iter().cloned() {
<a href="#h3-8-3" id="h3-8-3" class="d">-            node = node
</a><a href="#h3-8-4" id="h3-8-4" class="d">-                .step(Message {
</a><a href="#h3-8-5" id="h3-8-5" class="d">-                    from: Some(peer),
</a><a href="#h3-8-6" id="h3-8-6" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-8-7" id="h3-8-7" class="d">-                    term: 3,
</a><a href="#h3-8-8" id="h3-8-8" class="d">-                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-8-9" id="h3-8-9" class="d">-                })
</a><a href="#h3-8-10" id="h3-8-10" class="d">-                .unwrap();
</a><a href="#h3-8-11" id="h3-8-11" class="i">+            node = node.step(Message {
</a><a href="#h3-8-12" id="h3-8-12" class="i">+                from: Some(peer),
</a><a href="#h3-8-13" id="h3-8-13" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-8-14" id="h3-8-14" class="i">+                term: 3,
</a><a href="#h3-8-15" id="h3-8-15" class="i">+                event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-8-16" id="h3-8-16" class="i">+            })?;
</a>             assert_node(&amp;node).committed(2).applied(1).last(6);
         }
         assert_messages(&amp;rx, vec![]);
<a href="#h3-9" id="h3-9" class="h">@@ -633,14 +616,12 @@ mod tests {
</a>         // Receive AcceptEntries calls from peers, which after a quorum
         // will commit and apply the entries and return a call response.
         for (i, peer) in peers.iter().cloned().enumerate() {
<a href="#h3-9-3" id="h3-9-3" class="d">-            node = node
</a><a href="#h3-9-4" id="h3-9-4" class="d">-                .step(Message {
</a><a href="#h3-9-5" id="h3-9-5" class="d">-                    from: Some(peer),
</a><a href="#h3-9-6" id="h3-9-6" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-9-7" id="h3-9-7" class="d">-                    term: 3,
</a><a href="#h3-9-8" id="h3-9-8" class="d">-                    event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h3-9-9" id="h3-9-9" class="d">-                })
</a><a href="#h3-9-10" id="h3-9-10" class="d">-                .unwrap();
</a><a href="#h3-9-11" id="h3-9-11" class="i">+            node = node.step(Message {
</a><a href="#h3-9-12" id="h3-9-12" class="i">+                from: Some(peer),
</a><a href="#h3-9-13" id="h3-9-13" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-9-14" id="h3-9-14" class="i">+                term: 3,
</a><a href="#h3-9-15" id="h3-9-15" class="i">+                event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h3-9-16" id="h3-9-16" class="i">+            })?;
</a>             if (i as u64 + 2) &lt; quorum {
                 assert_node(&amp;node).committed(2).applied(2).last(6);
                 assert_messages(&amp;rx, vec![]);
<a href="#h3-10" id="h3-10" class="h">@@ -661,19 +642,17 @@ mod tests {
</a> 
         // Submit a read call to read back our entry, which will immediately
         // send heartbeats to all peers to confirm that we&#39;re still the leader.
<a href="#h3-10-3" id="h3-10-3" class="d">-        node = node
</a><a href="#h3-10-4" id="h3-10-4" class="d">-            .step(Message {
</a><a href="#h3-10-5" id="h3-10-5" class="d">-                from: None,
</a><a href="#h3-10-6" id="h3-10-6" class="d">-                to: None,
</a><a href="#h3-10-7" id="h3-10-7" class="d">-                term: 0,
</a><a href="#h3-10-8" id="h3-10-8" class="d">-                event: Event::QueryState { call_id: vec![0x02], command: vec![0x06] },
</a><a href="#h3-10-9" id="h3-10-9" class="d">-            })
</a><a href="#h3-10-10" id="h3-10-10" class="d">-            .unwrap();
</a><a href="#h3-10-11" id="h3-10-11" class="i">+        node = node.step(Message {
</a><a href="#h3-10-12" id="h3-10-12" class="i">+            from: None,
</a><a href="#h3-10-13" id="h3-10-13" class="i">+            to: None,
</a><a href="#h3-10-14" id="h3-10-14" class="i">+            term: 0,
</a><a href="#h3-10-15" id="h3-10-15" class="i">+            event: Event::QueryState { call_id: vec![0x02], command: vec![0x06] },
</a><a href="#h3-10-16" id="h3-10-16" class="i">+        })?;
</a>         assert_node(&amp;node).is_leader().term(3);
         for peer in peers.iter().cloned() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h3-10-21" id="h3-10-21" class="d">-                rx.recv().unwrap(),
</a><a href="#h3-10-22" id="h3-10-22" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(peer),
<a href="#h3-11" id="h3-11" class="h">@@ -688,36 +667,30 @@ mod tests {
</a>         // AcceptEntries calls for the current last_index do not trigger a
         // read response.
         for peer in peers.iter().cloned() {
<a href="#h3-11-3" id="h3-11-3" class="d">-            node = node
</a><a href="#h3-11-4" id="h3-11-4" class="d">-                .step(Message {
</a><a href="#h3-11-5" id="h3-11-5" class="d">-                    from: Some(peer.clone()),
</a><a href="#h3-11-6" id="h3-11-6" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-7" id="h3-11-7" class="d">-                    term: 3,
</a><a href="#h3-11-8" id="h3-11-8" class="d">-                    event: Event::ConfirmLeader { commit_index: 5, has_committed: true },
</a><a href="#h3-11-9" id="h3-11-9" class="d">-                })
</a><a href="#h3-11-10" id="h3-11-10" class="d">-                .unwrap();
</a><a href="#h3-11-11" id="h3-11-11" class="d">-            node = node
</a><a href="#h3-11-12" id="h3-11-12" class="d">-                .step(Message {
</a><a href="#h3-11-13" id="h3-11-13" class="d">-                    from: Some(peer),
</a><a href="#h3-11-14" id="h3-11-14" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-15" id="h3-11-15" class="d">-                    term: 3,
</a><a href="#h3-11-16" id="h3-11-16" class="d">-                    event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h3-11-17" id="h3-11-17" class="d">-                })
</a><a href="#h3-11-18" id="h3-11-18" class="d">-                .unwrap();
</a><a href="#h3-11-19" id="h3-11-19" class="i">+            node = node.step(Message {
</a><a href="#h3-11-20" id="h3-11-20" class="i">+                from: Some(peer.clone()),
</a><a href="#h3-11-21" id="h3-11-21" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-22" id="h3-11-22" class="i">+                term: 3,
</a><a href="#h3-11-23" id="h3-11-23" class="i">+                event: Event::ConfirmLeader { commit_index: 5, has_committed: true },
</a><a href="#h3-11-24" id="h3-11-24" class="i">+            })?;
</a><a href="#h3-11-25" id="h3-11-25" class="i">+            node = node.step(Message {
</a><a href="#h3-11-26" id="h3-11-26" class="i">+                from: Some(peer),
</a><a href="#h3-11-27" id="h3-11-27" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-28" id="h3-11-28" class="i">+                term: 3,
</a><a href="#h3-11-29" id="h3-11-29" class="i">+                event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h3-11-30" id="h3-11-30" class="i">+            })?;
</a>             assert_messages(&amp;rx, vec![]);
         }
 
         // After we receive leadership confirmation from a quorum of
         // votes, the read response is returned.
         for (i, peer) in peers.iter().cloned().enumerate() {
<a href="#h3-11-37" id="h3-11-37" class="d">-            node = node
</a><a href="#h3-11-38" id="h3-11-38" class="d">-                .step(Message {
</a><a href="#h3-11-39" id="h3-11-39" class="d">-                    from: Some(peer.clone()),
</a><a href="#h3-11-40" id="h3-11-40" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-41" id="h3-11-41" class="d">-                    term: 3,
</a><a href="#h3-11-42" id="h3-11-42" class="d">-                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-11-43" id="h3-11-43" class="d">-                })
</a><a href="#h3-11-44" id="h3-11-44" class="d">-                .unwrap();
</a><a href="#h3-11-45" id="h3-11-45" class="i">+            node = node.step(Message {
</a><a href="#h3-11-46" id="h3-11-46" class="i">+                from: Some(peer.clone()),
</a><a href="#h3-11-47" id="h3-11-47" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-11-48" id="h3-11-48" class="i">+                term: 3,
</a><a href="#h3-11-49" id="h3-11-49" class="i">+                event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-11-50" id="h3-11-50" class="i">+            })?;
</a>             assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
             if (i as u64 + 2) &lt; quorum {
                 assert_messages(&amp;rx, vec![]);
<a href="#h3-12" id="h3-12" class="h">@@ -737,34 +710,33 @@ mod tests {
</a> 
         // Further leadership confirmation messages should not trigger messages.
         for peer in peers.iter().cloned() {
<a href="#h3-12-3" id="h3-12-3" class="d">-            node = node
</a><a href="#h3-12-4" id="h3-12-4" class="d">-                .step(Message {
</a><a href="#h3-12-5" id="h3-12-5" class="d">-                    from: Some(peer.clone()),
</a><a href="#h3-12-6" id="h3-12-6" class="d">-                    to: Some(&quot;a&quot;.into()),
</a><a href="#h3-12-7" id="h3-12-7" class="d">-                    term: 3,
</a><a href="#h3-12-8" id="h3-12-8" class="d">-                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-12-9" id="h3-12-9" class="d">-                })
</a><a href="#h3-12-10" id="h3-12-10" class="d">-                .unwrap();
</a><a href="#h3-12-11" id="h3-12-11" class="i">+            node = node.step(Message {
</a><a href="#h3-12-12" id="h3-12-12" class="i">+                from: Some(peer.clone()),
</a><a href="#h3-12-13" id="h3-12-13" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h3-12-14" id="h3-12-14" class="i">+                term: 3,
</a><a href="#h3-12-15" id="h3-12-15" class="i">+                event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h3-12-16" id="h3-12-16" class="i">+            })?;
</a>             assert_messages(&amp;rx, vec![]);
         }
         assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
<a href="#h3-12-20" id="h3-12-20" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-12-24" id="h3-12-24" class="d">-    fn tick() {
</a><a href="#h3-12-25" id="h3-12-25" class="d">-        let (leader, rx) = setup();
</a><a href="#h3-12-26" id="h3-12-26" class="i">+    fn tick() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-12-27" id="h3-12-27" class="i">+        let (leader, rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
         for _ in 0..5 {
             for _ in 0..HEARTBEAT_INTERVAL {
                 assert_messages(&amp;rx, vec![]);
<a href="#h3-12-33" id="h3-12-33" class="d">-                node = node.tick().unwrap();
</a><a href="#h3-12-34" id="h3-12-34" class="i">+                node = node.tick()?;
</a>                 assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
             }
             for peer in peers.iter() {
                 assert!(!rx.is_empty());
                 assert_eq!(
<a href="#h3-12-40" id="h3-12-40" class="d">-                    rx.recv().unwrap(),
</a><a href="#h3-12-41" id="h3-12-41" class="i">+                    rx.recv()?,
</a>                     Message {
                         from: Some(&quot;a&quot;.into()),
                         to: Some(peer.into()),
<a href="#h3-13" id="h3-13" class="h">@@ -774,6 +746,7 @@ mod tests {
</a>                 );
             }
         }
<a href="#h3-13-3" id="h3-13-3" class="i">+        Ok(())
</a>     }
 
     fn setup_calls() -&gt; Calls {
<a href="#h3-14" id="h3-14" class="h">@@ -828,15 +801,16 @@ mod tests {
</a>     }
 
     #[test]
<a href="#h3-14-3" id="h3-14-3" class="d">-    fn calls_log_applied() {
</a><a href="#h3-14-4" id="h3-14-4" class="i">+    fn calls_log_applied() -&gt; Result&lt;(), Error&gt; {
</a>         let mut calls = setup_calls();
         assert_eq!(calls.log_applied(2).unwrap().id, vec![0xa2]);
         assert_eq!(calls.log_applied(2), None);
         assert_eq!(calls.log_applied(9), None);
<a href="#h3-14-9" id="h3-14-9" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-14-13" id="h3-14-13" class="d">-    fn calls_quorum_vote() {
</a><a href="#h3-14-14" id="h3-14-14" class="i">+    fn calls_quorum_vote() -&gt; Result&lt;(), Error&gt; {
</a>         let mut calls = setup_calls();
         // 0xb0=1 0xb1=1 0xb2=1
         assert_eq!(calls.quorum_vote(&quot;a&quot;, 3), vec![]);
<a href="#h3-15" id="h3-15" class="h">@@ -857,10 +831,11 @@ mod tests {
</a>             calls.quorum_vote(&quot;e&quot;, 3).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
             vec![vec![0xb2_u8]]
         );
<a href="#h3-15-3" id="h3-15-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-15-7" id="h3-15-7" class="d">-    fn calls_quorum_vote_multiple() {
</a><a href="#h3-15-8" id="h3-15-8" class="i">+    fn calls_quorum_vote_multiple() -&gt; Result&lt;(), Error&gt; {
</a>         let mut calls = setup_calls();
         assert_eq!(calls.quorum_vote(&quot;a&quot;, 3), vec![]);
         assert_eq!(calls.quorum_vote(&quot;b&quot;, 3), vec![]);
<a href="#h3-16" id="h3-16" class="h">@@ -868,10 +843,11 @@ mod tests {
</a>             calls.quorum_vote(&quot;c&quot;, 3).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
             vec![vec![0xb0_u8], vec![0xb1_u8], vec![0xb2_u8]]
         );
<a href="#h3-16-3" id="h3-16-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h3-16-7" id="h3-16-7" class="d">-    fn calls_quorum_vote_same_voter_ignored() {
</a><a href="#h3-16-8" id="h3-16-8" class="i">+    fn calls_quorum_vote_same_voter_ignored() -&gt; Result&lt;(), Error&gt; {
</a>         let mut calls = setup_calls();
         assert_eq!(calls.quorum_vote(&quot;a&quot;, 1), vec![]);
         assert_eq!(calls.quorum_vote(&quot;a&quot;, 1), vec![]);
<a href="#h3-17" id="h3-17" class="h">@@ -883,5 +859,6 @@ mod tests {
</a>             calls.quorum_vote(&quot;c&quot;, 1).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
             vec![vec![0xb0_u8]]
         );
<a href="#h3-17-3" id="h3-17-3" class="i">+        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h4" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -304,28 +304,29 @@ mod tests {
</a>         NodeAsserter::new(node)
     }
 
<a href="#h4-0-3" id="h4-0-3" class="d">-    fn setup_rolenode() -&gt; (RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    fn setup_rolenode(
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a>         setup_rolenode_peers(vec![&quot;b&quot;.into(), &quot;c&quot;.into()])
     }
 
     fn setup_rolenode_peers(
         peers: Vec&lt;String&gt;,
<a href="#h4-0-11" id="h4-0-11" class="d">-    ) -&gt; (RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h4-0-12" id="h4-0-12" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a>         let (sender, receiver) = crossbeam::channel::unbounded();
         let node = RoleNode {
             role: (),
             id: &quot;a&quot;.into(),
             peers,
             term: 1,
<a href="#h4-0-19" id="h4-0-19" class="d">-            log: Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap(),
</a><a href="#h4-0-20" id="h4-0-20" class="i">+            log: Log::new(kv::Simple::new(kv::storage::Memory::new()))?,
</a>             state: TestState::new(),
             sender,
         };
<a href="#h4-0-24" id="h4-0-24" class="d">-        (node, receiver)
</a><a href="#h4-0-25" id="h4-0-25" class="i">+        Ok((node, receiver))
</a>     }
 
     #[test]
<a href="#h4-0-29" id="h4-0-29" class="d">-    fn new() {
</a><a href="#h4-0-30" id="h4-0-30" class="i">+    fn new() -&gt; Result&lt;(), Error&gt; {
</a>         let (sender, _) = crossbeam::channel::unbounded();
         let node = Node::new(
             &quot;a&quot;,
<a href="#h4-1" id="h4-1" class="h">@@ -333,8 +334,7 @@ mod tests {
</a>             kv::Simple::new(kv::storage::Memory::new()),
             TestState::new(),
             sender,
<a href="#h4-1-3" id="h4-1-3" class="d">-        )
</a><a href="#h4-1-4" id="h4-1-4" class="d">-        .unwrap();
</a><a href="#h4-1-5" id="h4-1-5" class="i">+        )?;
</a>         match node {
             Node::Follower(rolenode) =&gt; {
                 assert_eq!(rolenode.id, &quot;a&quot;.to_owned());
<a href="#h4-2" id="h4-2" class="h">@@ -343,29 +343,30 @@ mod tests {
</a>             }
             _ =&gt; panic!(&quot;Expected node to start as follower&quot;),
         }
<a href="#h4-2-3" id="h4-2-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-2-7" id="h4-2-7" class="d">-    fn new_loads_term() {
</a><a href="#h4-2-8" id="h4-2-8" class="i">+    fn new_loads_term() -&gt; Result&lt;(), Error&gt; {
</a>         let (sender, _) = crossbeam::channel::unbounded();
         let storage = kv::storage::Test::new();
<a href="#h4-2-11" id="h4-2-11" class="d">-        Log::new(kv::Simple::new(storage.clone())).unwrap().save_term(3, Some(&quot;c&quot;)).unwrap();
</a><a href="#h4-2-12" id="h4-2-12" class="i">+        Log::new(kv::Simple::new(storage.clone()))?.save_term(3, Some(&quot;c&quot;))?;
</a>         let node = Node::new(
             &quot;a&quot;,
             vec![&quot;b&quot;.into(), &quot;c&quot;.into()],
             kv::Simple::new(storage),
             TestState::new(),
             sender,
<a href="#h4-2-19" id="h4-2-19" class="d">-        )
</a><a href="#h4-2-20" id="h4-2-20" class="d">-        .unwrap();
</a><a href="#h4-2-21" id="h4-2-21" class="i">+        )?;
</a>         match node {
             Node::Follower(rolenode) =&gt; assert_eq!(rolenode.term, 3),
             _ =&gt; panic!(&quot;Expected node to start as follower&quot;),
         }
<a href="#h4-2-26" id="h4-2-26" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-2-30" id="h4-2-30" class="d">-    fn new_single() {
</a><a href="#h4-2-31" id="h4-2-31" class="i">+    fn new_single() -&gt; Result&lt;(), Error&gt; {
</a>         let (sender, _) = crossbeam::channel::unbounded();
         let node = Node::new(
             &quot;a&quot;,
<a href="#h4-3" id="h4-3" class="h">@@ -373,8 +374,7 @@ mod tests {
</a>             kv::Simple::new(kv::storage::Memory::new()),
             TestState::new(),
             sender,
<a href="#h4-3-3" id="h4-3-3" class="d">-        )
</a><a href="#h4-3-4" id="h4-3-4" class="d">-        .unwrap();
</a><a href="#h4-3-5" id="h4-3-5" class="i">+        )?;
</a>         match node {
             Node::Leader(rolenode) =&gt; {
                 assert_eq!(rolenode.id, &quot;a&quot;.to_owned());
<a href="#h4-4" id="h4-4" class="h">@@ -383,27 +383,29 @@ mod tests {
</a>             }
             _ =&gt; panic!(&quot;Expected leader&quot;),
         }
<a href="#h4-4-3" id="h4-4-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-4-7" id="h4-4-7" class="d">-    fn become_role() {
</a><a href="#h4-4-8" id="h4-4-8" class="d">-        let (node, _) = setup_rolenode();
</a><a href="#h4-4-9" id="h4-4-9" class="d">-        let new = node.become_role(&quot;role&quot;).unwrap();
</a><a href="#h4-4-10" id="h4-4-10" class="i">+    fn become_role() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-4-11" id="h4-4-11" class="i">+        let (node, _) = setup_rolenode()?;
</a><a href="#h4-4-12" id="h4-4-12" class="i">+        let new = node.become_role(&quot;role&quot;)?;
</a>         assert_eq!(new.id, &quot;a&quot;.to_owned());
         assert_eq!(new.term, 1);
         assert_eq!(new.peers, vec![&quot;b&quot;.to_owned(), &quot;c&quot;.to_owned()]);
         assert_eq!(new.role, &quot;role&quot;);
<a href="#h4-4-17" id="h4-4-17" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-4-21" id="h4-4-21" class="d">-    fn broadcast() {
</a><a href="#h4-4-22" id="h4-4-22" class="d">-        let (node, rx) = setup_rolenode();
</a><a href="#h4-4-23" id="h4-4-23" class="d">-        node.broadcast(Event::Heartbeat { commit_index: 1, commit_term: 1 }).unwrap();
</a><a href="#h4-4-24" id="h4-4-24" class="i">+    fn broadcast() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-4-25" id="h4-4-25" class="i">+        let (node, rx) = setup_rolenode()?;
</a><a href="#h4-4-26" id="h4-4-26" class="i">+        node.broadcast(Event::Heartbeat { commit_index: 1, commit_term: 1 })?;
</a> 
         for to in [&quot;b&quot;, &quot;c&quot;].iter().cloned() {
             assert!(!rx.is_empty());
             assert_eq!(
<a href="#h4-4-31" id="h4-4-31" class="d">-                rx.recv().unwrap(),
</a><a href="#h4-4-32" id="h4-4-32" class="i">+                rx.recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to.into()),
<a href="#h4-5" id="h4-5" class="h">@@ -413,11 +415,12 @@ mod tests {
</a>             )
         }
         assert!(rx.is_empty());
<a href="#h4-5-3" id="h4-5-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-5-7" id="h4-5-7" class="d">-    fn normalize_message() {
</a><a href="#h4-5-8" id="h4-5-8" class="d">-        let (node, _) = setup_rolenode();
</a><a href="#h4-5-9" id="h4-5-9" class="i">+    fn normalize_message() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-5-10" id="h4-5-10" class="i">+        let (node, _) = setup_rolenode()?;
</a>         let mut msg = Message {
             from: None,
             to: None,
<a href="#h4-6" id="h4-6" class="h">@@ -437,24 +440,26 @@ mod tests {
</a> 
         msg.to = Some(&quot;c&quot;.into());
         assert!(!node.normalize_message(&amp;mut msg));
<a href="#h4-6-3" id="h4-6-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-6-7" id="h4-6-7" class="d">-    fn quorum() {
</a><a href="#h4-6-8" id="h4-6-8" class="i">+    fn quorum() -&gt; Result&lt;(), Error&gt; {
</a>         let quorums = vec![(1, 1), (2, 2), (3, 2), (4, 3), (5, 3), (6, 4), (7, 4), (8, 5)];
         for (size, quorum) in quorums.into_iter() {
             let peers: Vec&lt;String&gt; =
                 (0..(size as u8 - 1)).map(|i| (i as char).to_string()).collect();
             assert_eq!(peers.len(), size as usize - 1);
<a href="#h4-6-14" id="h4-6-14" class="d">-            let (node, _) = setup_rolenode_peers(peers);
</a><a href="#h4-6-15" id="h4-6-15" class="i">+            let (node, _) = setup_rolenode_peers(peers)?;
</a>             assert_eq!(node.quorum(), quorum);
         }
<a href="#h4-6-18" id="h4-6-18" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-6-22" id="h4-6-22" class="d">-    fn send() {
</a><a href="#h4-6-23" id="h4-6-23" class="d">-        let (node, rx) = setup_rolenode();
</a><a href="#h4-6-24" id="h4-6-24" class="d">-        node.send(Some(&quot;b&quot;), Event::Heartbeat { commit_index: 1, commit_term: 1 }).unwrap();
</a><a href="#h4-6-25" id="h4-6-25" class="i">+    fn send() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-6-26" id="h4-6-26" class="i">+        let (node, rx) = setup_rolenode()?;
</a><a href="#h4-6-27" id="h4-6-27" class="i">+        node.send(Some(&quot;b&quot;), Event::Heartbeat { commit_index: 1, commit_term: 1 })?;
</a>         assert_messages(
             &amp;rx,
             vec![Message {
<a href="#h4-7" id="h4-7" class="h">@@ -464,12 +469,14 @@ mod tests {
</a>                 event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
             }],
         );
<a href="#h4-7-3" id="h4-7-3" class="i">+        Ok(())
</a>     }
 
     #[test]
<a href="#h4-7-7" id="h4-7-7" class="d">-    fn save_term() {
</a><a href="#h4-7-8" id="h4-7-8" class="d">-        let (mut node, _) = setup_rolenode();
</a><a href="#h4-7-9" id="h4-7-9" class="d">-        node.save_term(4, Some(&quot;b&quot;)).unwrap();
</a><a href="#h4-7-10" id="h4-7-10" class="d">-        assert_eq!(node.log.load_term().unwrap(), (4, Some(&quot;b&quot;.into())));
</a><a href="#h4-7-11" id="h4-7-11" class="i">+    fn save_term() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h4-7-12" id="h4-7-12" class="i">+        let (mut node, _) = setup_rolenode()?;
</a><a href="#h4-7-13" id="h4-7-13" class="i">+        node.save_term(4, Some(&quot;b&quot;))?;
</a><a href="#h4-7-14" id="h4-7-14" class="i">+        assert_eq!(node.log.load_term()?, (4, Some(&quot;b&quot;.into())));
</a><a href="#h4-7-15" id="h4-7-15" class="i">+        Ok(())
</a>     }
 }
</pre>
</div>
</body>
</html>
