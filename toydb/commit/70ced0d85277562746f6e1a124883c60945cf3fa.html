<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>kv: cleaned up MVCC::begin() and resume() - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/70ced0d85277562746f6e1a124883c60945cf3fa.html">70ced0d85277562746f6e1a124883c60945cf3fa</a>
<b>parent</b> <a href="../commit/8be59b9489f1bae70ed34f626a4a527ea96c34bb.html">8be59b9489f1bae70ed34f626a4a527ea96c34bb</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 15 Dec 2019 21:17:22 +0100

kv: cleaned up MVCC::begin() and resume()

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/kv/mvcc.rs</a></td><td> | </td><td class="num">270</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------</span></td></tr>
</table></pre><pre>1 file changed, 194 insertions(+), 76 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -37,7 +37,7 @@ impl&lt;S: Storage&gt; MVCC&lt;S&gt; {
</a> }
 
 /// An MVCC transaction mode.
<a href="#h0-0-3" id="h0-0-3" class="d">-#[derive(Clone, Serialize, Deserialize)]
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a> pub enum Mode {
     /// A read-write transaction.
     ReadWrite,
<a href="#h0-1" id="h0-1" class="h">@@ -86,36 +86,40 @@ pub struct Transaction&lt;S: Storage&gt; {
</a> impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
     /// Begins a new transaction in the given mode.
     fn begin(storage: Arc&lt;RwLock&lt;S&gt;&gt;, mode: Mode) -&gt; Result&lt;Self, Error&gt; {
<a href="#h0-1-3" id="h0-1-3" class="d">-        let id = {
</a><a href="#h0-1-4" id="h0-1-4" class="d">-            let mut storage = storage.write()?;
</a><a href="#h0-1-5" id="h0-1-5" class="d">-            let id = match storage.read(&amp;Key::TxnNext.encode())? {
</a><a href="#h0-1-6" id="h0-1-6" class="d">-                Some(v) =&gt; deserialize(&amp;v)?,
</a><a href="#h0-1-7" id="h0-1-7" class="d">-                None =&gt; 1,
</a><a href="#h0-1-8" id="h0-1-8" class="d">-            };
</a><a href="#h0-1-9" id="h0-1-9" class="d">-            storage.write(&amp;Key::TxnNext.encode(), serialize(&amp;(id + 1))?)?;
</a><a href="#h0-1-10" id="h0-1-10" class="d">-            storage.write(&amp;Key::TxnActive(id).encode(), serialize(&amp;mode)?)?;
</a><a href="#h0-1-11" id="h0-1-11" class="d">-            id
</a><a href="#h0-1-12" id="h0-1-12" class="d">-        };
</a><a href="#h0-1-13" id="h0-1-13" class="d">-        let snapshot = match &amp;mode {
</a><a href="#h0-1-14" id="h0-1-14" class="d">-            Mode::Snapshot { version } =&gt; Snapshot::restore(&amp;storage.read()?, *version)?,
</a><a href="#h0-1-15" id="h0-1-15" class="d">-            _ =&gt; Snapshot::take(&amp;mut storage.write()?, id)?,
</a><a href="#h0-1-16" id="h0-1-16" class="i">+        let mut session = storage.write()?;
</a><a href="#h0-1-17" id="h0-1-17" class="i">+
</a><a href="#h0-1-18" id="h0-1-18" class="i">+        let id = match session.read(&amp;Key::TxnNext.encode())? {
</a><a href="#h0-1-19" id="h0-1-19" class="i">+            Some(ref v) =&gt; deserialize(v)?,
</a><a href="#h0-1-20" id="h0-1-20" class="i">+            None =&gt; 1,
</a>         };
<a href="#h0-1-22" id="h0-1-22" class="d">-        Ok(Self { storage, id, mode, snapshot })
</a><a href="#h0-1-23" id="h0-1-23" class="i">+        session.write(&amp;Key::TxnNext.encode(), serialize(&amp;(id + 1))?)?;
</a><a href="#h0-1-24" id="h0-1-24" class="i">+        session.write(&amp;Key::TxnActive(id).encode(), serialize(&amp;mode)?)?;
</a><a href="#h0-1-25" id="h0-1-25" class="i">+
</a><a href="#h0-1-26" id="h0-1-26" class="i">+        // We always take a new snapshot, even for snapshot transactions, because all transactions
</a><a href="#h0-1-27" id="h0-1-27" class="i">+        // increment the transaction ID and we need to properly record currently active transactions
</a><a href="#h0-1-28" id="h0-1-28" class="i">+        // for any future snapshot transactions looking at this one.
</a><a href="#h0-1-29" id="h0-1-29" class="i">+        let mut snapshot = Snapshot::take(&amp;mut session, id)?;
</a><a href="#h0-1-30" id="h0-1-30" class="i">+        std::mem::drop(session);
</a><a href="#h0-1-31" id="h0-1-31" class="i">+
</a><a href="#h0-1-32" id="h0-1-32" class="i">+        if let Mode::Snapshot { version } = &amp;mode {
</a><a href="#h0-1-33" id="h0-1-33" class="i">+            snapshot = Snapshot::restore(&amp;storage.read()?, *version)?
</a><a href="#h0-1-34" id="h0-1-34" class="i">+        }
</a><a href="#h0-1-35" id="h0-1-35" class="i">+
</a><a href="#h0-1-36" id="h0-1-36" class="i">+        Ok(Self { storage, snapshot, mode, id })
</a>     }
 
<a href="#h0-1-39" id="h0-1-39" class="d">-    /// Resumes an active transaction with the given ID. If no such active transaction exists,
</a><a href="#h0-1-40" id="h0-1-40" class="d">-    /// an error is returned.
</a><a href="#h0-1-41" id="h0-1-41" class="i">+    /// Resumes an active transaction with the given ID. Errors if the transaction is not active.
</a>     fn resume(storage: Arc&lt;RwLock&lt;S&gt;&gt;, id: u64) -&gt; Result&lt;Self, Error&gt; {
<a href="#h0-1-43" id="h0-1-43" class="d">-        let key = Key::TxnActive(id).encode();
</a><a href="#h0-1-44" id="h0-1-44" class="d">-        let mode = if let Some(v) = storage.read()?.read(&amp;key)? {
</a><a href="#h0-1-45" id="h0-1-45" class="d">-            deserialize(&amp;v)?
</a><a href="#h0-1-46" id="h0-1-46" class="d">-        } else {
</a><a href="#h0-1-47" id="h0-1-47" class="d">-            return Err(Error::Value(format!(&quot;Unable to resume non-existant transaction {}&quot;, id)));
</a><a href="#h0-1-48" id="h0-1-48" class="d">-        };
</a><a href="#h0-1-49" id="h0-1-49" class="d">-        let snapshot = match &amp;mode {
</a><a href="#h0-1-50" id="h0-1-50" class="d">-            Mode::Snapshot { version } =&gt; Snapshot::restore(&amp;storage.read()?, *version)?,
</a><a href="#h0-1-51" id="h0-1-51" class="d">-            _ =&gt; Snapshot::restore(&amp;storage.read()?, id)?,
</a><a href="#h0-1-52" id="h0-1-52" class="i">+        let session = storage.read()?;
</a><a href="#h0-1-53" id="h0-1-53" class="i">+        let mode = match session.read(&amp;Key::TxnActive(id).encode())? {
</a><a href="#h0-1-54" id="h0-1-54" class="i">+            Some(ref v) =&gt; deserialize(v)?,
</a><a href="#h0-1-55" id="h0-1-55" class="i">+            None =&gt; return Err(Error::Value(format!(&quot;No active transaction {}&quot;, id))),
</a>         };
<a href="#h0-1-57" id="h0-1-57" class="i">+        let snapshot = Snapshot::restore(
</a><a href="#h0-1-58" id="h0-1-58" class="i">+            &amp;session,
</a><a href="#h0-1-59" id="h0-1-59" class="i">+            if let Mode::Snapshot { version } = &amp;mode { *version } else { id },
</a><a href="#h0-1-60" id="h0-1-60" class="i">+        )?;
</a><a href="#h0-1-61" id="h0-1-61" class="i">+        std::mem::drop(session);
</a>         Ok(Self { storage, id, mode, snapshot })
     }
 
<a href="#h0-2" id="h0-2" class="h">@@ -131,20 +135,18 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a> 
     /// Commits the transaction
     pub fn commit(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h0-2-3" id="h0-2-3" class="d">-        if self.mode.is_mutable() {
</a><a href="#h0-2-4" id="h0-2-4" class="d">-            self.storage.write()?.remove(&amp;Key::TxnActive(self.id).encode())?;
</a><a href="#h0-2-5" id="h0-2-5" class="d">-        }
</a><a href="#h0-2-6" id="h0-2-6" class="i">+        self.storage.write()?.remove(&amp;Key::TxnActive(self.id).encode())?;
</a>         Ok(())
     }
 
     /// Rolls back the transaction
     pub fn rollback(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h0-2-12" id="h0-2-12" class="i">+        let mut session = self.storage.write()?;
</a>         if self.mode.is_mutable() {
<a href="#h0-2-14" id="h0-2-14" class="d">-            let mut storage = self.storage.write()?;
</a>             let start = Key::TxnUpdatedStart(self.id).encode();
             let end = Key::TxnUpdatedEnd(self.id).encode();
             let mut keys: Vec&lt;Vec&lt;u8&gt;&gt; = vec![];
<a href="#h0-2-18" id="h0-2-18" class="d">-            for r in storage.scan(start..end).rev() {
</a><a href="#h0-2-19" id="h0-2-19" class="i">+            for r in session.scan(start..end).rev() {
</a>                 let (k, _) = r?;
                 if let Key::TxnUpdated(_, key) = Key::decode(k.clone())? {
                     keys.push(key.clone());
<a href="#h0-3" id="h0-3" class="h">@@ -154,10 +156,10 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>                 }
             }
             for key in keys.into_iter() {
<a href="#h0-3-3" id="h0-3-3" class="d">-                storage.remove(&amp;key)?;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+                session.remove(&amp;key)?;
</a>             }
<a href="#h0-3-6" id="h0-3-6" class="d">-            storage.remove(&amp;Key::TxnActive(self.id).encode())?;
</a>         }
<a href="#h0-3-8" id="h0-3-8" class="i">+        session.remove(&amp;Key::TxnActive(self.id).encode())?;
</a>         Ok(())
     }
 
<a href="#h0-4" id="h0-4" class="h">@@ -233,38 +235,41 @@ impl&lt;&#39;a, S: Storage&gt; Transaction&lt;S&gt; {
</a>     }
 }
 
<a href="#h0-4-3" id="h0-4-3" class="d">-/// A versioned snapshot
</a><a href="#h0-4-4" id="h0-4-4" class="i">+/// A versioned snapshot, containing visibility information about concurrent transactions.
</a> #[derive(Clone)]
<a href="#h0-4-6" id="h0-4-6" class="d">-pub struct Snapshot {
</a><a href="#h0-4-7" id="h0-4-7" class="i">+struct Snapshot {
</a><a href="#h0-4-8" id="h0-4-8" class="i">+    /// The version (i.e. transaction ID) that the snapshot belongs to.
</a>     version: u64,
<a href="#h0-4-10" id="h0-4-10" class="i">+    /// The set of transaction IDs that were active at the start of the transactions,
</a><a href="#h0-4-11" id="h0-4-11" class="i">+    /// and thus should be invisible to the snapshot.
</a>     invisible: HashSet&lt;u64&gt;,
 }
 
 impl Snapshot {
<a href="#h0-4-16" id="h0-4-16" class="d">-    /// Takes a new snapshot
</a><a href="#h0-4-17" id="h0-4-17" class="i">+    /// Takes a new snapshot, persisting it as `Key::TxnSnapshot(version)`.
</a>     fn take(storage: &amp;mut RwLockWriteGuard&lt;impl Storage&gt;, version: u64) -&gt; Result&lt;Self, Error&gt; {
         let mut snapshot = Self { version, invisible: HashSet::new() };
<a href="#h0-4-20" id="h0-4-20" class="d">-        for r in storage.scan(&amp;Key::TxnActive(0).encode()..&amp;Key::TxnActive(version).encode()) {
</a><a href="#h0-4-21" id="h0-4-21" class="d">-            let (k, _) = r?;
</a><a href="#h0-4-22" id="h0-4-22" class="d">-            match Key::decode(k)? {
</a><a href="#h0-4-23" id="h0-4-23" class="i">+        let mut scan = storage.scan(&amp;Key::TxnActive(0).encode()..&amp;Key::TxnActive(version).encode());
</a><a href="#h0-4-24" id="h0-4-24" class="i">+        while let Some((key, _)) = scan.next().transpose()? {
</a><a href="#h0-4-25" id="h0-4-25" class="i">+            match Key::decode(key)? {
</a>                 Key::TxnActive(id) =&gt; snapshot.invisible.insert(id),
<a href="#h0-4-27" id="h0-4-27" class="d">-                _ =&gt; return Err(Error::Value(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
</a><a href="#h0-4-28" id="h0-4-28" class="i">+                _ =&gt; return Err(Error::Internal(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
</a>             };
         }
<a href="#h0-4-31" id="h0-4-31" class="i">+        std::mem::drop(scan);
</a>         storage.write(&amp;Key::TxnSnapshot(version).encode(), serialize(&amp;snapshot.invisible)?)?;
         Ok(snapshot)
     }
 
<a href="#h0-4-36" id="h0-4-36" class="d">-    /// Restores an existing snapshot
</a><a href="#h0-4-37" id="h0-4-37" class="i">+    /// Restores an existing snapshot from `Key::TxnSnapshot(version)`, or errors if not found.
</a>     fn restore(storage: &amp;RwLockReadGuard&lt;impl Storage&gt;, version: u64) -&gt; Result&lt;Self, Error&gt; {
<a href="#h0-4-39" id="h0-4-39" class="d">-        if let Some(v) = storage.read(&amp;Key::TxnSnapshot(version).encode())? {
</a><a href="#h0-4-40" id="h0-4-40" class="d">-            Ok(Self { version, invisible: deserialize(&amp;v)? })
</a><a href="#h0-4-41" id="h0-4-41" class="d">-        } else {
</a><a href="#h0-4-42" id="h0-4-42" class="d">-            Err(Error::Value(format!(&quot;Unable to find snapshot for version {}&quot;, version)))
</a><a href="#h0-4-43" id="h0-4-43" class="i">+        match storage.read(&amp;Key::TxnSnapshot(version).encode())? {
</a><a href="#h0-4-44" id="h0-4-44" class="i">+            Some(ref v) =&gt; Ok(Self { version, invisible: deserialize(v)? }),
</a><a href="#h0-4-45" id="h0-4-45" class="i">+            None =&gt; Err(Error::Value(format!(&quot;Snapshot not found for version {}&quot;, version))),
</a>         }
     }
 
<a href="#h0-4-49" id="h0-4-49" class="d">-    /// Checks whether the given version is visible to us
</a><a href="#h0-4-50" id="h0-4-50" class="i">+    /// Checks whether the given version is visible in this snapshot.
</a>     fn is_visible(&amp;self, version: u64) -&gt; bool {
         version &lt;= self.version &amp;&amp; self.invisible.get(&amp;version).is_none()
     }
<a href="#h0-5" id="h0-5" class="h">@@ -398,10 +403,14 @@ impl&lt;&#39;a, S: Storage&gt; DoubleEndedIterator for Scan&lt;&#39;a, S&gt; {
</a>     }
 }
 
<a href="#h0-5-3" id="h0-5-3" class="i">+/// Key encoding and decoding
</a> #[derive(Debug)]
 enum Key {
<a href="#h0-5-6" id="h0-5-6" class="i">+    /// The next available transaction ID.
</a>     TxnNext,
<a href="#h0-5-8" id="h0-5-8" class="i">+    /// Marker for active transactions, containing the transaction mode.
</a>     TxnActive(u64),
<a href="#h0-5-10" id="h0-5-10" class="i">+    /// Transaction snapshot, containing concurrent transactions at start.
</a>     TxnSnapshot(u64),
     TxnUpdatedStart(u64),
     TxnUpdated(u64, Vec&lt;u8&gt;),
<a href="#h0-6" id="h0-6" class="h">@@ -524,6 +533,12 @@ impl Key {
</a>     }
 }
 
<a href="#h0-6-3" id="h0-6-3" class="i">+impl Into&lt;Vec&lt;u8&gt;&gt; for Key {
</a><a href="#h0-6-4" id="h0-6-4" class="i">+    fn into(self) -&gt; Vec&lt;u8&gt; {
</a><a href="#h0-6-5" id="h0-6-5" class="i">+        self.encode()
</a><a href="#h0-6-6" id="h0-6-6" class="i">+    }
</a><a href="#h0-6-7" id="h0-6-7" class="i">+}
</a><a href="#h0-6-8" id="h0-6-8" class="i">+
</a> enum Value {
     Delete,
     Set(Vec&lt;u8&gt;),
<a href="#h0-7" id="h0-7" class="h">@@ -550,10 +565,11 @@ impl Value {
</a> 
 #[cfg(test)]
 pub mod tests {
<a href="#h0-7-3" id="h0-7-3" class="i">+    use super::super::storage::Test;
</a>     use super::*;
 
<a href="#h0-7-6" id="h0-7-6" class="d">-    fn setup() -&gt; MVCC&lt;super::super::storage::Memory&gt; {
</a><a href="#h0-7-7" id="h0-7-7" class="d">-        MVCC::new(super::super::storage::Memory::new())
</a><a href="#h0-7-8" id="h0-7-8" class="i">+    fn setup() -&gt; MVCC&lt;Test&gt; {
</a><a href="#h0-7-9" id="h0-7-9" class="i">+        MVCC::new(Test::new())
</a>     }
 
     #[test]
<a href="#h0-8" id="h0-8" class="h">@@ -561,11 +577,95 @@ pub mod tests {
</a>         let mvcc = setup();
 
         let txn = mvcc.begin()?;
<a href="#h0-8-3" id="h0-8-3" class="d">-        assert_eq!(txn.id(), 1);
</a><a href="#h0-8-4" id="h0-8-4" class="i">+        assert_eq!(1, txn.id());
</a><a href="#h0-8-5" id="h0-8-5" class="i">+        assert_eq!(Mode::ReadWrite, txn.mode());
</a>         txn.commit()?;
 
         let txn = mvcc.begin()?;
<a href="#h0-8-9" id="h0-8-9" class="d">-        assert_eq!(txn.id(), 2);
</a><a href="#h0-8-10" id="h0-8-10" class="i">+        assert_eq!(2, txn.id());
</a><a href="#h0-8-11" id="h0-8-11" class="i">+        txn.rollback()?;
</a><a href="#h0-8-12" id="h0-8-12" class="i">+
</a><a href="#h0-8-13" id="h0-8-13" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h0-8-14" id="h0-8-14" class="i">+        assert_eq!(3, txn.id());
</a><a href="#h0-8-15" id="h0-8-15" class="i">+        txn.commit()?;
</a><a href="#h0-8-16" id="h0-8-16" class="i">+
</a><a href="#h0-8-17" id="h0-8-17" class="i">+        Ok(())
</a><a href="#h0-8-18" id="h0-8-18" class="i">+    }
</a><a href="#h0-8-19" id="h0-8-19" class="i">+
</a><a href="#h0-8-20" id="h0-8-20" class="i">+    #[test]
</a><a href="#h0-8-21" id="h0-8-21" class="i">+    fn test_begin_with_mode_readonly() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-8-22" id="h0-8-22" class="i">+        let mvcc = setup();
</a><a href="#h0-8-23" id="h0-8-23" class="i">+        let txn = mvcc.begin_with_mode(Mode::ReadOnly)?;
</a><a href="#h0-8-24" id="h0-8-24" class="i">+        assert_eq!(1, txn.id());
</a><a href="#h0-8-25" id="h0-8-25" class="i">+        assert_eq!(Mode::ReadOnly, txn.mode());
</a><a href="#h0-8-26" id="h0-8-26" class="i">+        txn.commit()?;
</a><a href="#h0-8-27" id="h0-8-27" class="i">+        Ok(())
</a><a href="#h0-8-28" id="h0-8-28" class="i">+    }
</a><a href="#h0-8-29" id="h0-8-29" class="i">+
</a><a href="#h0-8-30" id="h0-8-30" class="i">+    #[test]
</a><a href="#h0-8-31" id="h0-8-31" class="i">+    fn test_begin_with_mode_readwrite() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-8-32" id="h0-8-32" class="i">+        let mvcc = setup();
</a><a href="#h0-8-33" id="h0-8-33" class="i">+        let txn = mvcc.begin_with_mode(Mode::ReadWrite)?;
</a><a href="#h0-8-34" id="h0-8-34" class="i">+        assert_eq!(1, txn.id());
</a><a href="#h0-8-35" id="h0-8-35" class="i">+        assert_eq!(Mode::ReadWrite, txn.mode());
</a><a href="#h0-8-36" id="h0-8-36" class="i">+        txn.commit()?;
</a><a href="#h0-8-37" id="h0-8-37" class="i">+        Ok(())
</a><a href="#h0-8-38" id="h0-8-38" class="i">+    }
</a><a href="#h0-8-39" id="h0-8-39" class="i">+
</a><a href="#h0-8-40" id="h0-8-40" class="i">+    #[test]
</a><a href="#h0-8-41" id="h0-8-41" class="i">+    fn test_begin_with_mode_snapshot() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h0-8-42" id="h0-8-42" class="i">+        let mvcc = setup();
</a><a href="#h0-8-43" id="h0-8-43" class="i">+
</a><a href="#h0-8-44" id="h0-8-44" class="i">+        // Write a couple of versions for a key
</a><a href="#h0-8-45" id="h0-8-45" class="i">+        let mut txn = mvcc.begin_with_mode(Mode::ReadWrite)?;
</a><a href="#h0-8-46" id="h0-8-46" class="i">+        txn.set(b&quot;key&quot;, vec![0x01])?;
</a><a href="#h0-8-47" id="h0-8-47" class="i">+        txn.commit()?;
</a><a href="#h0-8-48" id="h0-8-48" class="i">+        let mut txn = mvcc.begin_with_mode(Mode::ReadWrite)?;
</a><a href="#h0-8-49" id="h0-8-49" class="i">+        txn.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h0-8-50" id="h0-8-50" class="i">+        txn.commit()?;
</a><a href="#h0-8-51" id="h0-8-51" class="i">+
</a><a href="#h0-8-52" id="h0-8-52" class="i">+        // Check that we can start a snapshot in version 1
</a><a href="#h0-8-53" id="h0-8-53" class="i">+        let txn = mvcc.begin_with_mode(Mode::Snapshot { version: 1 })?;
</a><a href="#h0-8-54" id="h0-8-54" class="i">+        assert_eq!(3, txn.id());
</a><a href="#h0-8-55" id="h0-8-55" class="i">+        assert_eq!(Mode::Snapshot { version: 1 }, txn.mode());
</a><a href="#h0-8-56" id="h0-8-56" class="i">+        assert_eq!(Some(vec![0x01]), txn.get(b&quot;key&quot;)?);
</a><a href="#h0-8-57" id="h0-8-57" class="i">+        txn.commit()?;
</a><a href="#h0-8-58" id="h0-8-58" class="i">+
</a><a href="#h0-8-59" id="h0-8-59" class="i">+        // Check that we can start a snapshot in a past snapshot transaction
</a><a href="#h0-8-60" id="h0-8-60" class="i">+        let txn = mvcc.begin_with_mode(Mode::Snapshot { version: 3 })?;
</a><a href="#h0-8-61" id="h0-8-61" class="i">+        assert_eq!(4, txn.id());
</a><a href="#h0-8-62" id="h0-8-62" class="i">+        assert_eq!(Mode::Snapshot { version: 3 }, txn.mode());
</a><a href="#h0-8-63" id="h0-8-63" class="i">+        assert_eq!(Some(vec![0x02]), txn.get(b&quot;key&quot;)?);
</a><a href="#h0-8-64" id="h0-8-64" class="i">+        txn.commit()?;
</a><a href="#h0-8-65" id="h0-8-65" class="i">+
</a><a href="#h0-8-66" id="h0-8-66" class="i">+        // Check that the current transaction ID is valid as a snapshot version
</a><a href="#h0-8-67" id="h0-8-67" class="i">+        let txn = mvcc.begin_with_mode(Mode::Snapshot { version: 5 })?;
</a><a href="#h0-8-68" id="h0-8-68" class="i">+        assert_eq!(5, txn.id());
</a><a href="#h0-8-69" id="h0-8-69" class="i">+        assert_eq!(Mode::Snapshot { version: 5 }, txn.mode());
</a><a href="#h0-8-70" id="h0-8-70" class="i">+        txn.commit()?;
</a><a href="#h0-8-71" id="h0-8-71" class="i">+
</a><a href="#h0-8-72" id="h0-8-72" class="i">+        // Check that any future transaction IDs are invalid
</a><a href="#h0-8-73" id="h0-8-73" class="i">+        assert_matches!(
</a><a href="#h0-8-74" id="h0-8-74" class="i">+            mvcc.begin_with_mode(Mode::Snapshot { version: 9 }).err(),
</a><a href="#h0-8-75" id="h0-8-75" class="i">+            Some(Error::Value(_))
</a><a href="#h0-8-76" id="h0-8-76" class="i">+        );
</a><a href="#h0-8-77" id="h0-8-77" class="i">+
</a><a href="#h0-8-78" id="h0-8-78" class="i">+        // Check that concurrent transactions are hidden from snapshots of snapshot transactions.
</a><a href="#h0-8-79" id="h0-8-79" class="i">+        // This is because any transaction, including a snapshot transaction, allocates a new
</a><a href="#h0-8-80" id="h0-8-80" class="i">+        // transaction ID, and we need to make sure concurrent transaction at the time the
</a><a href="#h0-8-81" id="h0-8-81" class="i">+        // transaction began are hidden from future snapshot transactions.
</a><a href="#h0-8-82" id="h0-8-82" class="i">+        let mut txn_active = mvcc.begin()?;
</a><a href="#h0-8-83" id="h0-8-83" class="i">+        let txn_snapshot = mvcc.begin_with_mode(Mode::Snapshot { version: 1 })?;
</a><a href="#h0-8-84" id="h0-8-84" class="i">+        assert_eq!(7, txn_active.id());
</a><a href="#h0-8-85" id="h0-8-85" class="i">+        assert_eq!(8, txn_snapshot.id());
</a><a href="#h0-8-86" id="h0-8-86" class="i">+        txn_active.set(b&quot;key&quot;, vec![0x07])?;
</a><a href="#h0-8-87" id="h0-8-87" class="i">+        assert_eq!(Some(vec![0x01]), txn_snapshot.get(b&quot;key&quot;)?);
</a><a href="#h0-8-88" id="h0-8-88" class="i">+        txn_active.commit()?;
</a><a href="#h0-8-89" id="h0-8-89" class="i">+        txn_snapshot.commit()?;
</a><a href="#h0-8-90" id="h0-8-90" class="i">+
</a><a href="#h0-8-91" id="h0-8-91" class="i">+        let txn = mvcc.begin_with_mode(Mode::Snapshot { version: 8 })?;
</a><a href="#h0-8-92" id="h0-8-92" class="i">+        assert_eq!(9, txn.id());
</a><a href="#h0-8-93" id="h0-8-93" class="i">+        assert_eq!(Some(vec![0x02]), txn.get(b&quot;key&quot;)?);
</a>         txn.commit()?;
 
         Ok(())
<a href="#h0-9" id="h0-9" class="h">@@ -576,51 +676,69 @@ pub mod tests {
</a>         let mvcc = setup();
 
         // We first write a set of values that should be visible
<a href="#h0-9-3" id="h0-9-3" class="d">-        let mut t0 = mvcc.begin()?;
</a><a href="#h0-9-4" id="h0-9-4" class="d">-        t0.set(b&quot;a&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h0-9-5" id="h0-9-5" class="d">-        t0.set(b&quot;b&quot;, b&quot;t0&quot;.to_vec())?;
</a><a href="#h0-9-6" id="h0-9-6" class="d">-        t0.commit()?;
</a><a href="#h0-9-7" id="h0-9-7" class="d">-
</a><a href="#h0-9-8" id="h0-9-8" class="d">-        // We then start three transactions, of which we will resume t2.
</a><a href="#h0-9-9" id="h0-9-9" class="d">-        // We commit t1 and t3&#39;s changes, which should not be visible,
</a><a href="#h0-9-10" id="h0-9-10" class="d">-        // and write a change for t2 which should be visible.
</a>         let mut t1 = mvcc.begin()?;
<a href="#h0-9-12" id="h0-9-12" class="i">+        t1.set(b&quot;a&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h0-9-13" id="h0-9-13" class="i">+        t1.set(b&quot;b&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h0-9-14" id="h0-9-14" class="i">+        t1.commit()?;
</a><a href="#h0-9-15" id="h0-9-15" class="i">+
</a><a href="#h0-9-16" id="h0-9-16" class="i">+        // We then start three transactions, of which we will resume t3.
</a><a href="#h0-9-17" id="h0-9-17" class="i">+        // We commit t2 and t4&#39;s changes, which should not be visible,
</a><a href="#h0-9-18" id="h0-9-18" class="i">+        // and write a change for t3 which should be visible.
</a>         let mut t2 = mvcc.begin()?;
         let mut t3 = mvcc.begin()?;
<a href="#h0-9-21" id="h0-9-21" class="i">+        let mut t4 = mvcc.begin()?;
</a> 
<a href="#h0-9-23" id="h0-9-23" class="d">-        t1.set(b&quot;a&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h0-9-24" id="h0-9-24" class="d">-        t2.set(b&quot;b&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h0-9-25" id="h0-9-25" class="d">-        t3.set(b&quot;c&quot;, b&quot;t3&quot;.to_vec())?;
</a><a href="#h0-9-26" id="h0-9-26" class="i">+        t2.set(b&quot;a&quot;, b&quot;t2&quot;.to_vec())?;
</a><a href="#h0-9-27" id="h0-9-27" class="i">+        t3.set(b&quot;b&quot;, b&quot;t3&quot;.to_vec())?;
</a><a href="#h0-9-28" id="h0-9-28" class="i">+        t4.set(b&quot;c&quot;, b&quot;t4&quot;.to_vec())?;
</a> 
<a href="#h0-9-30" id="h0-9-30" class="d">-        t1.commit()?;
</a><a href="#h0-9-31" id="h0-9-31" class="d">-        t3.commit()?;
</a><a href="#h0-9-32" id="h0-9-32" class="i">+        t2.commit()?;
</a><a href="#h0-9-33" id="h0-9-33" class="i">+        t4.commit()?;
</a> 
<a href="#h0-9-35" id="h0-9-35" class="d">-        // We now resume t2, who should see it&#39;s own changes but none
</a><a href="#h0-9-36" id="h0-9-36" class="i">+        // We now resume t3, who should see it&#39;s own changes but none
</a>         // of the others&#39;
<a href="#h0-9-38" id="h0-9-38" class="d">-        let id = t2.id();
</a><a href="#h0-9-39" id="h0-9-39" class="d">-        std::mem::drop(t2);
</a><a href="#h0-9-40" id="h0-9-40" class="i">+        let id = t3.id();
</a><a href="#h0-9-41" id="h0-9-41" class="i">+        std::mem::drop(t3);
</a>         let tr = mvcc.resume(id)?;
<a href="#h0-9-43" id="h0-9-43" class="i">+        assert_eq!(3, tr.id());
</a><a href="#h0-9-44" id="h0-9-44" class="i">+        assert_eq!(Mode::ReadWrite, tr.mode());
</a> 
<a href="#h0-9-46" id="h0-9-46" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), tr.get(b&quot;a&quot;)?);
</a><a href="#h0-9-47" id="h0-9-47" class="d">-        assert_eq!(Some(b&quot;t2&quot;.to_vec()), tr.get(b&quot;b&quot;)?);
</a><a href="#h0-9-48" id="h0-9-48" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), tr.get(b&quot;a&quot;)?);
</a><a href="#h0-9-49" id="h0-9-49" class="i">+        assert_eq!(Some(b&quot;t3&quot;.to_vec()), tr.get(b&quot;b&quot;)?);
</a>         assert_eq!(None, tr.get(b&quot;c&quot;)?);
 
<a href="#h0-9-52" id="h0-9-52" class="d">-        // A separate transaction should not see t2&#39;s changes, but should see the others
</a><a href="#h0-9-53" id="h0-9-53" class="i">+        // A separate transaction should not see t3&#39;s changes, but should see the others
</a>         let t = mvcc.begin()?;
<a href="#h0-9-55" id="h0-9-55" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h0-9-56" id="h0-9-56" class="d">-        assert_eq!(Some(b&quot;t0&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h0-9-57" id="h0-9-57" class="d">-        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h0-9-58" id="h0-9-58" class="i">+        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h0-9-59" id="h0-9-59" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h0-9-60" id="h0-9-60" class="i">+        assert_eq!(Some(b&quot;t4&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a>         t.rollback()?;
 
<a href="#h0-9-63" id="h0-9-63" class="d">-        // Once tr commits, a separate transaction should see t2&#39;s changes
</a><a href="#h0-9-64" id="h0-9-64" class="i">+        // Once tr commits, a separate transaction should see t3&#39;s changes
</a>         tr.commit()?;
 
         let t = mvcc.begin()?;
<a href="#h0-9-68" id="h0-9-68" class="d">-        assert_eq!(Some(b&quot;t1&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h0-9-69" id="h0-9-69" class="d">-        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h0-9-70" id="h0-9-70" class="d">-        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a><a href="#h0-9-71" id="h0-9-71" class="i">+        assert_eq!(Some(b&quot;t2&quot;.to_vec()), t.get(b&quot;a&quot;)?);
</a><a href="#h0-9-72" id="h0-9-72" class="i">+        assert_eq!(Some(b&quot;t3&quot;.to_vec()), t.get(b&quot;b&quot;)?);
</a><a href="#h0-9-73" id="h0-9-73" class="i">+        assert_eq!(Some(b&quot;t4&quot;.to_vec()), t.get(b&quot;c&quot;)?);
</a>         t.rollback()?;
 
<a href="#h0-9-76" id="h0-9-76" class="i">+        // It should also be possible to start a snapshot transaction and resume it.
</a><a href="#h0-9-77" id="h0-9-77" class="i">+        let ts = mvcc.begin_with_mode(Mode::Snapshot { version: 1 })?;
</a><a href="#h0-9-78" id="h0-9-78" class="i">+        assert_eq!(7, ts.id());
</a><a href="#h0-9-79" id="h0-9-79" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
</a><a href="#h0-9-80" id="h0-9-80" class="i">+
</a><a href="#h0-9-81" id="h0-9-81" class="i">+        let id = ts.id();
</a><a href="#h0-9-82" id="h0-9-82" class="i">+        std::mem::drop(ts);
</a><a href="#h0-9-83" id="h0-9-83" class="i">+        let ts = mvcc.resume(id)?;
</a><a href="#h0-9-84" id="h0-9-84" class="i">+        assert_eq!(7, ts.id());
</a><a href="#h0-9-85" id="h0-9-85" class="i">+        assert_eq!(Mode::Snapshot { version: 1 }, ts.mode());
</a><a href="#h0-9-86" id="h0-9-86" class="i">+        assert_eq!(Some(b&quot;t1&quot;.to_vec()), ts.get(b&quot;a&quot;)?);
</a><a href="#h0-9-87" id="h0-9-87" class="i">+        ts.commit()?;
</a><a href="#h0-9-88" id="h0-9-88" class="i">+
</a><a href="#h0-9-89" id="h0-9-89" class="i">+        // Resuming an inactive transaction should error.
</a><a href="#h0-9-90" id="h0-9-90" class="i">+        assert_matches!(mvcc.resume(7).err(), Some(Error::Value(_)));
</a><a href="#h0-9-91" id="h0-9-91" class="i">+
</a>         Ok(())
     }
 
</pre>
</div>
</body>
</html>
