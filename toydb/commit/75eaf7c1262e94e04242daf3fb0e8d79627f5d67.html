<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>storage: use goldenscripts for MVCC tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/75eaf7c1262e94e04242daf3fb0e8d79627f5d67.html">75eaf7c1262e94e04242daf3fb0e8d79627f5d67</a>
<b>parent</b> <a href="../commit/638a17546be31bf35fba5a2764f5e5e442f2f24f.html">638a17546be31bf35fba5a2764f5e5e442f2f24f</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Wed, 12 Jun 2024 23:24:05 +0200

storage: use goldenscripts for MVCC tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/log.rs</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/storage/engine.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h2">src/storage/golden/mvcc/anomaly_dirty_read</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">src/storage/golden/mvcc/anomaly_dirty_write</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">src/storage/golden/mvcc/anomaly_fuzzy_read</a></td><td> | </td><td class="num">31</td><td><span class="i"></span><span class="d">-------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">src/storage/golden/mvcc/anomaly_lost_update</a></td><td> | </td><td class="num">33</td><td><span class="i"></span><span class="d">---------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">src/storage/golden/mvcc/anomaly_phantom_read</a></td><td> | </td><td class="num">45</td><td><span class="i"></span><span class="d">---------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">src/storage/golden/mvcc/anomaly_read_skew</a></td><td> | </td><td class="num">39</td><td><span class="i"></span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">src/storage/golden/mvcc/anomaly_write_skew</a></td><td> | </td><td class="num">41</td><td><span class="i"></span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">src/storage/golden/mvcc/begin</a></td><td> | </td><td class="num">30</td><td><span class="i"></span><span class="d">------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">src/storage/golden/mvcc/begin_as_of</a></td><td> | </td><td class="num">89</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h11">src/storage/golden/mvcc/begin_read_only</a></td><td> | </td><td class="num">15</td><td><span class="i"></span><span class="d">---------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h12">src/storage/golden/mvcc/delete</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">src/storage/golden/mvcc/delete_conflict</a></td><td> | </td><td class="num">54</td><td><span class="i"></span><span class="d">------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h14">src/storage/golden/mvcc/get</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h15">src/storage/golden/mvcc/get_isolation</a></td><td> | </td><td class="num">97</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">src/storage/golden/mvcc/resume</a></td><td> | </td><td class="num">110</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h17">src/storage/golden/mvcc/rollback</a></td><td> | </td><td class="num">94</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">src/storage/golden/mvcc/scan</a></td><td> | </td><td class="num">109</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h19">src/storage/golden/mvcc/scan_isolation</a></td><td> | </td><td class="num">91</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">src/storage/golden/mvcc/scan_key_version_encoding</a></td><td> | </td><td class="num">53</td><td><span class="i"></span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h21">src/storage/golden/mvcc/scan_prefix</a></td><td> | </td><td class="num">117</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">src/storage/golden/mvcc/set</a></td><td> | </td><td class="num">42</td><td><span class="i"></span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">src/storage/golden/mvcc/set_conflict</a></td><td> | </td><td class="num">54</td><td><span class="i"></span><span class="d">------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">src/storage/golden/mvcc/unversioned</a></td><td> | </td><td class="num">59</td><td><span class="i"></span><span class="d">-----------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/storage/mvcc.rs</a></td><td> | </td><td class="num">1434</td><td><span class="i">+++++++++++++++++++</span><span class="d">------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/storage/testscripts/engine/keys</a></td><td> | </td><td class="num">61</td><td><span class="i"></span><span class="d">-------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">src/storage/testscripts/mvcc/anomaly_dirty_read</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">src/storage/testscripts/mvcc/anomaly_dirty_write</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">src/storage/testscripts/mvcc/anomaly_lost_update</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">src/storage/testscripts/mvcc/anomaly_phantom_read</a></td><td> | </td><td class="num">31</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">src/storage/testscripts/mvcc/anomaly_read_skew</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">src/storage/testscripts/mvcc/anomaly_write_skew</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">src/storage/testscripts/mvcc/begin</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">src/storage/testscripts/mvcc/begin_as_of</a></td><td> | </td><td class="num">108</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">src/storage/testscripts/mvcc/begin_readonly</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">src/storage/testscripts/mvcc/delete</a></td><td> | </td><td class="num">62</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">src/storage/testscripts/mvcc/delete_conflict</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">src/storage/testscripts/mvcc/get</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h40">src/storage/testscripts/mvcc/get_isolation</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">src/storage/testscripts/mvcc/resume</a></td><td> | </td><td class="num">89</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">src/storage/testscripts/mvcc/rollback</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">src/storage/testscripts/mvcc/scan</a></td><td> | </td><td class="num">101</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h44">src/storage/testscripts/mvcc/scan_isolation</a></td><td> | </td><td class="num">43</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">src/storage/testscripts/mvcc/scan_key_version_encoding</a></td><td> | </td><td class="num">37</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">src/storage/testscripts/mvcc/scan_prefix</a></td><td> | </td><td class="num">104</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">src/storage/testscripts/mvcc/set</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h48">src/storage/testscripts/mvcc/set_conflict</a></td><td> | </td><td class="num">39</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h49">src/storage/testscripts/mvcc/unversioned</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>50 files changed, 1481 insertions(+), 2473 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -365,6 +365,7 @@ mod tests {
</a>     impl goldenscript::Runner for TestRunner {
         fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
             let mut output = String::new();
<a href="#h0-0-3" id="h0-0-3" class="i">+            // TODO: use [ops] tag instead of oplog= parameters. See MVCC runner.
</a>             match command.name.as_str() {
                 // append [COMMAND] [oplog=BOOL]
                 &quot;append&quot; =&gt; {
<b>diff --git a/<a id="h1" href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a> b/<a href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -207,7 +207,7 @@ pub mod test {
</a>             format!(
                 &quot;{} → {}&quot;,
                 Self::format_bytes(key),
<a href="#h1-0-3" id="h1-0-3" class="d">-                value.map(|v| Self::format_bytes(v)).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                value.map(Self::format_bytes).unwrap_or(&quot;None&quot;.to_string())
</a>             )
         }
 
<a href="#h1-1" id="h1-1" class="h">@@ -300,7 +300,7 @@ pub mod test {
</a>     /// panicking if they produce different results. Engine implementations
     /// should not have any observable differences in behavior.
     ///
<a href="#h1-1-3" id="h1-1-3" class="d">-    /// TODO: use this in more tests, e.g. MVCC tests.
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    /// TODO: use this in more tests, e.g. SQL tests.
</a>     pub struct Mirror&lt;A: Engine, B: Engine&gt; {
         pub a: A,
         pub b: B,
<b>diff --git a/<a id="h2" href="../file/src/storage/golden/mvcc/anomaly_dirty_read.html">src/storage/golden/mvcc/anomaly_dirty_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_dirty_read.html">src/storage/golden/mvcc/anomaly_dirty_read</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h2-0-1" id="h2-0-1" class="d">-    set NextVersion = 2
</a><a href="#h2-0-2" id="h2-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h2-0-3" id="h2-0-3" class="d">-
</a><a href="#h2-0-4" id="h2-0-4" class="d">-T1: set &quot;key&quot; = 0x01
</a><a href="#h2-0-5" id="h2-0-5" class="d">-    set TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    set Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h2-0-7" id="h2-0-7" class="d">-
</a><a href="#h2-0-8" id="h2-0-8" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h2-0-9" id="h2-0-9" class="d">-    set NextVersion = 3
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h2-0-11" id="h2-0-11" class="d">-    set TxnActive(2) = []
</a><a href="#h2-0-12" id="h2-0-12" class="d">-
</a><a href="#h2-0-13" id="h2-0-13" class="d">-T2: get &quot;key&quot; → None
</a><a href="#h2-0-14" id="h2-0-14" class="d">-
</a><a href="#h2-0-15" id="h2-0-15" class="d">-Engine state:
</a><a href="#h2-0-16" id="h2-0-16" class="d">-NextVersion = 3
</a><a href="#h2-0-17" id="h2-0-17" class="d">-TxnActive(1) = []
</a><a href="#h2-0-18" id="h2-0-18" class="d">-TxnActive(2) = []
</a><a href="#h2-0-19" id="h2-0-19" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h2-0-20" id="h2-0-20" class="d">-TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h2-0-21" id="h2-0-21" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h3" href="../file/src/storage/golden/mvcc/anomaly_dirty_write.html">src/storage/golden/mvcc/anomaly_dirty_write</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_dirty_write.html">src/storage/golden/mvcc/anomaly_dirty_write</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h3-0-1" id="h3-0-1" class="d">-    set NextVersion = 2
</a><a href="#h3-0-2" id="h3-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h3-0-3" id="h3-0-3" class="d">-
</a><a href="#h3-0-4" id="h3-0-4" class="d">-T1: set &quot;key&quot; = 0x01
</a><a href="#h3-0-5" id="h3-0-5" class="d">-    set TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h3-0-6" id="h3-0-6" class="d">-    set Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h3-0-7" id="h3-0-7" class="d">-
</a><a href="#h3-0-8" id="h3-0-8" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h3-0-9" id="h3-0-9" class="d">-    set NextVersion = 3
</a><a href="#h3-0-10" id="h3-0-10" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h3-0-11" id="h3-0-11" class="d">-    set TxnActive(2) = []
</a><a href="#h3-0-12" id="h3-0-12" class="d">-
</a><a href="#h3-0-13" id="h3-0-13" class="d">-T2: set &quot;key&quot; = 0x02 → Error::Serialization
</a><a href="#h3-0-14" id="h3-0-14" class="d">-
</a><a href="#h3-0-15" id="h3-0-15" class="d">-Engine state:
</a><a href="#h3-0-16" id="h3-0-16" class="d">-NextVersion = 3
</a><a href="#h3-0-17" id="h3-0-17" class="d">-TxnActive(1) = []
</a><a href="#h3-0-18" id="h3-0-18" class="d">-TxnActive(2) = []
</a><a href="#h3-0-19" id="h3-0-19" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h3-0-20" id="h3-0-20" class="d">-TxnWrite(1, &quot;key&quot;) = []
</a><a href="#h3-0-21" id="h3-0-21" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h4" href="../file/src/storage/golden/mvcc/anomaly_fuzzy_read.html">src/storage/golden/mvcc/anomaly_fuzzy_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_fuzzy_read.html">src/storage/golden/mvcc/anomaly_fuzzy_read</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,31 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-Engine state:
</a><a href="#h4-0-1" id="h4-0-1" class="d">-NextVersion = 2
</a><a href="#h4-0-2" id="h4-0-2" class="d">-Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h4-0-3" id="h4-0-3" class="d">-
</a><a href="#h4-0-4" id="h4-0-4" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h4-0-5" id="h4-0-5" class="d">-    set NextVersion = 3
</a><a href="#h4-0-6" id="h4-0-6" class="d">-    set TxnActive(2) = []
</a><a href="#h4-0-7" id="h4-0-7" class="d">-
</a><a href="#h4-0-8" id="h4-0-8" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h4-0-9" id="h4-0-9" class="d">-    set NextVersion = 4
</a><a href="#h4-0-10" id="h4-0-10" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h4-0-11" id="h4-0-11" class="d">-    set TxnActive(3) = []
</a><a href="#h4-0-12" id="h4-0-12" class="d">-
</a><a href="#h4-0-13" id="h4-0-13" class="d">-T2: get &quot;key&quot; → 0x00
</a><a href="#h4-0-14" id="h4-0-14" class="d">-
</a><a href="#h4-0-15" id="h4-0-15" class="d">-T1: set &quot;key&quot; = &quot;t1&quot;
</a><a href="#h4-0-16" id="h4-0-16" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h4-0-17" id="h4-0-17" class="d">-    set Version(&quot;key&quot;, 2) = &quot;t1&quot;
</a><a href="#h4-0-18" id="h4-0-18" class="d">-
</a><a href="#h4-0-19" id="h4-0-19" class="d">-T1: commit
</a><a href="#h4-0-20" id="h4-0-20" class="d">-    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h4-0-21" id="h4-0-21" class="d">-    del TxnActive(2)
</a><a href="#h4-0-22" id="h4-0-22" class="d">-
</a><a href="#h4-0-23" id="h4-0-23" class="d">-T2: get &quot;key&quot; → 0x00
</a><a href="#h4-0-24" id="h4-0-24" class="d">-
</a><a href="#h4-0-25" id="h4-0-25" class="d">-Engine state:
</a><a href="#h4-0-26" id="h4-0-26" class="d">-NextVersion = 4
</a><a href="#h4-0-27" id="h4-0-27" class="d">-TxnActive(3) = []
</a><a href="#h4-0-28" id="h4-0-28" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h4-0-29" id="h4-0-29" class="d">-Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h4-0-30" id="h4-0-30" class="d">-Version(&quot;key&quot;, 2) = &quot;t1&quot;
</a><b>diff --git a/<a id="h5" href="../file/src/storage/golden/mvcc/anomaly_lost_update.html">src/storage/golden/mvcc/anomaly_lost_update</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_lost_update.html">src/storage/golden/mvcc/anomaly_lost_update</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,33 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-Engine state:
</a><a href="#h5-0-1" id="h5-0-1" class="d">-NextVersion = 2
</a><a href="#h5-0-2" id="h5-0-2" class="d">-Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h5-0-3" id="h5-0-3" class="d">-
</a><a href="#h5-0-4" id="h5-0-4" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h5-0-5" id="h5-0-5" class="d">-    set NextVersion = 3
</a><a href="#h5-0-6" id="h5-0-6" class="d">-    set TxnActive(2) = []
</a><a href="#h5-0-7" id="h5-0-7" class="d">-
</a><a href="#h5-0-8" id="h5-0-8" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h5-0-9" id="h5-0-9" class="d">-    set NextVersion = 4
</a><a href="#h5-0-10" id="h5-0-10" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h5-0-11" id="h5-0-11" class="d">-    set TxnActive(3) = []
</a><a href="#h5-0-12" id="h5-0-12" class="d">-
</a><a href="#h5-0-13" id="h5-0-13" class="d">-T1: get &quot;key&quot; → 0x00
</a><a href="#h5-0-14" id="h5-0-14" class="d">-
</a><a href="#h5-0-15" id="h5-0-15" class="d">-T2: get &quot;key&quot; → 0x00
</a><a href="#h5-0-16" id="h5-0-16" class="d">-
</a><a href="#h5-0-17" id="h5-0-17" class="d">-T1: set &quot;key&quot; = 0x01
</a><a href="#h5-0-18" id="h5-0-18" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h5-0-19" id="h5-0-19" class="d">-    set Version(&quot;key&quot;, 2) = 0x01
</a><a href="#h5-0-20" id="h5-0-20" class="d">-
</a><a href="#h5-0-21" id="h5-0-21" class="d">-T2: set &quot;key&quot; = 0x02 → Error::Serialization
</a><a href="#h5-0-22" id="h5-0-22" class="d">-
</a><a href="#h5-0-23" id="h5-0-23" class="d">-T1: commit
</a><a href="#h5-0-24" id="h5-0-24" class="d">-    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h5-0-25" id="h5-0-25" class="d">-    del TxnActive(2)
</a><a href="#h5-0-26" id="h5-0-26" class="d">-
</a><a href="#h5-0-27" id="h5-0-27" class="d">-Engine state:
</a><a href="#h5-0-28" id="h5-0-28" class="d">-NextVersion = 4
</a><a href="#h5-0-29" id="h5-0-29" class="d">-TxnActive(3) = []
</a><a href="#h5-0-30" id="h5-0-30" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h5-0-31" id="h5-0-31" class="d">-Version(&quot;key&quot;, 1) = 0x00
</a><a href="#h5-0-32" id="h5-0-32" class="d">-Version(&quot;key&quot;, 2) = 0x01
</a><b>diff --git a/<a id="h6" href="../file/src/storage/golden/mvcc/anomaly_phantom_read.html">src/storage/golden/mvcc/anomaly_phantom_read</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_phantom_read.html">src/storage/golden/mvcc/anomaly_phantom_read</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,45 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-Engine state:
</a><a href="#h6-0-1" id="h6-0-1" class="d">-NextVersion = 2
</a><a href="#h6-0-2" id="h6-0-2" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h6-0-3" id="h6-0-3" class="d">-Version(&quot;ba&quot;, 1) = 0x00
</a><a href="#h6-0-4" id="h6-0-4" class="d">-Version(&quot;bb&quot;, 1) = 0x00
</a><a href="#h6-0-5" id="h6-0-5" class="d">-
</a><a href="#h6-0-6" id="h6-0-6" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h6-0-7" id="h6-0-7" class="d">-    set NextVersion = 3
</a><a href="#h6-0-8" id="h6-0-8" class="d">-    set TxnActive(2) = []
</a><a href="#h6-0-9" id="h6-0-9" class="d">-
</a><a href="#h6-0-10" id="h6-0-10" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h6-0-11" id="h6-0-11" class="d">-    set NextVersion = 4
</a><a href="#h6-0-12" id="h6-0-12" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h6-0-13" id="h6-0-13" class="d">-    set TxnActive(3) = []
</a><a href="#h6-0-14" id="h6-0-14" class="d">-
</a><a href="#h6-0-15" id="h6-0-15" class="d">-T1: scan prefix &quot;b&quot;
</a><a href="#h6-0-16" id="h6-0-16" class="d">-    &quot;ba&quot; = 0x00
</a><a href="#h6-0-17" id="h6-0-17" class="d">-    &quot;bb&quot; = 0x00
</a><a href="#h6-0-18" id="h6-0-18" class="d">-
</a><a href="#h6-0-19" id="h6-0-19" class="d">-T2: del &quot;ba&quot;
</a><a href="#h6-0-20" id="h6-0-20" class="d">-    set TxnWrite(3, &quot;ba&quot;) = []
</a><a href="#h6-0-21" id="h6-0-21" class="d">-    set Version(&quot;ba&quot;, 3) = None
</a><a href="#h6-0-22" id="h6-0-22" class="d">-
</a><a href="#h6-0-23" id="h6-0-23" class="d">-T2: set &quot;bc&quot; = 0x02
</a><a href="#h6-0-24" id="h6-0-24" class="d">-    set TxnWrite(3, &quot;bc&quot;) = []
</a><a href="#h6-0-25" id="h6-0-25" class="d">-    set Version(&quot;bc&quot;, 3) = 0x02
</a><a href="#h6-0-26" id="h6-0-26" class="d">-
</a><a href="#h6-0-27" id="h6-0-27" class="d">-T2: commit
</a><a href="#h6-0-28" id="h6-0-28" class="d">-    del TxnWrite(3, &quot;ba&quot;)
</a><a href="#h6-0-29" id="h6-0-29" class="d">-    del TxnWrite(3, &quot;bc&quot;)
</a><a href="#h6-0-30" id="h6-0-30" class="d">-    del TxnActive(3)
</a><a href="#h6-0-31" id="h6-0-31" class="d">-
</a><a href="#h6-0-32" id="h6-0-32" class="d">-T1: scan prefix &quot;b&quot;
</a><a href="#h6-0-33" id="h6-0-33" class="d">-    &quot;ba&quot; = 0x00
</a><a href="#h6-0-34" id="h6-0-34" class="d">-    &quot;bb&quot; = 0x00
</a><a href="#h6-0-35" id="h6-0-35" class="d">-
</a><a href="#h6-0-36" id="h6-0-36" class="d">-Engine state:
</a><a href="#h6-0-37" id="h6-0-37" class="d">-NextVersion = 4
</a><a href="#h6-0-38" id="h6-0-38" class="d">-TxnActive(2) = []
</a><a href="#h6-0-39" id="h6-0-39" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h6-0-40" id="h6-0-40" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h6-0-41" id="h6-0-41" class="d">-Version(&quot;ba&quot;, 1) = 0x00
</a><a href="#h6-0-42" id="h6-0-42" class="d">-Version(&quot;ba&quot;, 3) = None
</a><a href="#h6-0-43" id="h6-0-43" class="d">-Version(&quot;bb&quot;, 1) = 0x00
</a><a href="#h6-0-44" id="h6-0-44" class="d">-Version(&quot;bc&quot;, 3) = 0x02
</a><b>diff --git a/<a id="h7" href="../file/src/storage/golden/mvcc/anomaly_read_skew.html">src/storage/golden/mvcc/anomaly_read_skew</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_read_skew.html">src/storage/golden/mvcc/anomaly_read_skew</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,39 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-Engine state:
</a><a href="#h7-0-1" id="h7-0-1" class="d">-NextVersion = 2
</a><a href="#h7-0-2" id="h7-0-2" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h7-0-3" id="h7-0-3" class="d">-Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h7-0-4" id="h7-0-4" class="d">-
</a><a href="#h7-0-5" id="h7-0-5" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h7-0-6" id="h7-0-6" class="d">-    set NextVersion = 3
</a><a href="#h7-0-7" id="h7-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h7-0-8" id="h7-0-8" class="d">-
</a><a href="#h7-0-9" id="h7-0-9" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h7-0-10" id="h7-0-10" class="d">-    set NextVersion = 4
</a><a href="#h7-0-11" id="h7-0-11" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    set TxnActive(3) = []
</a><a href="#h7-0-13" id="h7-0-13" class="d">-
</a><a href="#h7-0-14" id="h7-0-14" class="d">-T1: get &quot;a&quot; → 0x00
</a><a href="#h7-0-15" id="h7-0-15" class="d">-
</a><a href="#h7-0-16" id="h7-0-16" class="d">-T2: set &quot;a&quot; = 0x02
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    set TxnWrite(3, &quot;a&quot;) = []
</a><a href="#h7-0-18" id="h7-0-18" class="d">-    set Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h7-0-19" id="h7-0-19" class="d">-
</a><a href="#h7-0-20" id="h7-0-20" class="d">-T2: set &quot;b&quot; = 0x02
</a><a href="#h7-0-21" id="h7-0-21" class="d">-    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h7-0-22" id="h7-0-22" class="d">-    set Version(&quot;b&quot;, 3) = 0x02
</a><a href="#h7-0-23" id="h7-0-23" class="d">-
</a><a href="#h7-0-24" id="h7-0-24" class="d">-T2: commit
</a><a href="#h7-0-25" id="h7-0-25" class="d">-    del TxnWrite(3, &quot;a&quot;)
</a><a href="#h7-0-26" id="h7-0-26" class="d">-    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h7-0-27" id="h7-0-27" class="d">-    del TxnActive(3)
</a><a href="#h7-0-28" id="h7-0-28" class="d">-
</a><a href="#h7-0-29" id="h7-0-29" class="d">-T1: get &quot;b&quot; → 0x00
</a><a href="#h7-0-30" id="h7-0-30" class="d">-
</a><a href="#h7-0-31" id="h7-0-31" class="d">-Engine state:
</a><a href="#h7-0-32" id="h7-0-32" class="d">-NextVersion = 4
</a><a href="#h7-0-33" id="h7-0-33" class="d">-TxnActive(2) = []
</a><a href="#h7-0-34" id="h7-0-34" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h7-0-35" id="h7-0-35" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h7-0-36" id="h7-0-36" class="d">-Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h7-0-37" id="h7-0-37" class="d">-Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h7-0-38" id="h7-0-38" class="d">-Version(&quot;b&quot;, 3) = 0x02
</a><b>diff --git a/<a id="h8" href="../file/src/storage/golden/mvcc/anomaly_write_skew.html">src/storage/golden/mvcc/anomaly_write_skew</a> b/<a href="../file/src/storage/golden/mvcc/anomaly_write_skew.html">src/storage/golden/mvcc/anomaly_write_skew</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,41 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-Engine state:
</a><a href="#h8-0-1" id="h8-0-1" class="d">-NextVersion = 2
</a><a href="#h8-0-2" id="h8-0-2" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h8-0-3" id="h8-0-3" class="d">-Version(&quot;b&quot;, 1) = 0x02
</a><a href="#h8-0-4" id="h8-0-4" class="d">-
</a><a href="#h8-0-5" id="h8-0-5" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h8-0-6" id="h8-0-6" class="d">-    set NextVersion = 3
</a><a href="#h8-0-7" id="h8-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h8-0-8" id="h8-0-8" class="d">-
</a><a href="#h8-0-9" id="h8-0-9" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h8-0-10" id="h8-0-10" class="d">-    set NextVersion = 4
</a><a href="#h8-0-11" id="h8-0-11" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h8-0-12" id="h8-0-12" class="d">-    set TxnActive(3) = []
</a><a href="#h8-0-13" id="h8-0-13" class="d">-
</a><a href="#h8-0-14" id="h8-0-14" class="d">-T1: get &quot;a&quot; → 0x01
</a><a href="#h8-0-15" id="h8-0-15" class="d">-
</a><a href="#h8-0-16" id="h8-0-16" class="d">-T2: get &quot;b&quot; → 0x02
</a><a href="#h8-0-17" id="h8-0-17" class="d">-
</a><a href="#h8-0-18" id="h8-0-18" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h8-0-19" id="h8-0-19" class="d">-    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h8-0-20" id="h8-0-20" class="d">-    set Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h8-0-21" id="h8-0-21" class="d">-
</a><a href="#h8-0-22" id="h8-0-22" class="d">-T2: set &quot;a&quot; = 0x02
</a><a href="#h8-0-23" id="h8-0-23" class="d">-    set TxnWrite(3, &quot;a&quot;) = []
</a><a href="#h8-0-24" id="h8-0-24" class="d">-    set Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h8-0-25" id="h8-0-25" class="d">-
</a><a href="#h8-0-26" id="h8-0-26" class="d">-T1: commit
</a><a href="#h8-0-27" id="h8-0-27" class="d">-    del TxnWrite(2, &quot;b&quot;)
</a><a href="#h8-0-28" id="h8-0-28" class="d">-    del TxnActive(2)
</a><a href="#h8-0-29" id="h8-0-29" class="d">-
</a><a href="#h8-0-30" id="h8-0-30" class="d">-T2: commit
</a><a href="#h8-0-31" id="h8-0-31" class="d">-    del TxnWrite(3, &quot;a&quot;)
</a><a href="#h8-0-32" id="h8-0-32" class="d">-    del TxnActive(3)
</a><a href="#h8-0-33" id="h8-0-33" class="d">-
</a><a href="#h8-0-34" id="h8-0-34" class="d">-Engine state:
</a><a href="#h8-0-35" id="h8-0-35" class="d">-NextVersion = 4
</a><a href="#h8-0-36" id="h8-0-36" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h8-0-37" id="h8-0-37" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h8-0-38" id="h8-0-38" class="d">-Version(&quot;a&quot;, 3) = 0x02
</a><a href="#h8-0-39" id="h8-0-39" class="d">-Version(&quot;b&quot;, 1) = 0x02
</a><a href="#h8-0-40" id="h8-0-40" class="d">-Version(&quot;b&quot;, 2) = 0x01
</a><b>diff --git a/<a id="h9" href="../file/src/storage/golden/mvcc/begin.html">src/storage/golden/mvcc/begin</a> b/<a href="../file/src/storage/golden/mvcc/begin.html">src/storage/golden/mvcc/begin</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h9-0-1" id="h9-0-1" class="d">-    set NextVersion = 2
</a><a href="#h9-0-2" id="h9-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h9-0-3" id="h9-0-3" class="d">-
</a><a href="#h9-0-4" id="h9-0-4" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h9-0-5" id="h9-0-5" class="d">-    set NextVersion = 3
</a><a href="#h9-0-6" id="h9-0-6" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h9-0-7" id="h9-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h9-0-8" id="h9-0-8" class="d">-
</a><a href="#h9-0-9" id="h9-0-9" class="d">-T3: begin → v3 read-write active={1,2}
</a><a href="#h9-0-10" id="h9-0-10" class="d">-    set NextVersion = 4
</a><a href="#h9-0-11" id="h9-0-11" class="d">-    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h9-0-12" id="h9-0-12" class="d">-    set TxnActive(3) = []
</a><a href="#h9-0-13" id="h9-0-13" class="d">-
</a><a href="#h9-0-14" id="h9-0-14" class="d">-T2: commit
</a><a href="#h9-0-15" id="h9-0-15" class="d">-    del TxnActive(2)
</a><a href="#h9-0-16" id="h9-0-16" class="d">-
</a><a href="#h9-0-17" id="h9-0-17" class="d">-T4: begin → v4 read-write active={1,3}
</a><a href="#h9-0-18" id="h9-0-18" class="d">-    set NextVersion = 5
</a><a href="#h9-0-19" id="h9-0-19" class="d">-    set TxnActiveSnapshot(4) = {1,3}
</a><a href="#h9-0-20" id="h9-0-20" class="d">-    set TxnActive(4) = []
</a><a href="#h9-0-21" id="h9-0-21" class="d">-
</a><a href="#h9-0-22" id="h9-0-22" class="d">-Engine state:
</a><a href="#h9-0-23" id="h9-0-23" class="d">-NextVersion = 5
</a><a href="#h9-0-24" id="h9-0-24" class="d">-TxnActive(1) = []
</a><a href="#h9-0-25" id="h9-0-25" class="d">-TxnActive(3) = []
</a><a href="#h9-0-26" id="h9-0-26" class="d">-TxnActive(4) = []
</a><a href="#h9-0-27" id="h9-0-27" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h9-0-28" id="h9-0-28" class="d">-TxnActiveSnapshot(3) = {1,2}
</a><a href="#h9-0-29" id="h9-0-29" class="d">-TxnActiveSnapshot(4) = {1,3}
</a><b>diff --git a/<a id="h10" href="../file/src/storage/golden/mvcc/begin_as_of.html">src/storage/golden/mvcc/begin_as_of</a> b/<a href="../file/src/storage/golden/mvcc/begin_as_of.html">src/storage/golden/mvcc/begin_as_of</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,89 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h10-0-1" id="h10-0-1" class="d">-    set NextVersion = 2
</a><a href="#h10-0-2" id="h10-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h10-0-3" id="h10-0-3" class="d">-
</a><a href="#h10-0-4" id="h10-0-4" class="d">-T1: set &quot;other&quot; = 0x01
</a><a href="#h10-0-5" id="h10-0-5" class="d">-    set TxnWrite(1, &quot;other&quot;) = []
</a><a href="#h10-0-6" id="h10-0-6" class="d">-    set Version(&quot;other&quot;, 1) = 0x01
</a><a href="#h10-0-7" id="h10-0-7" class="d">-
</a><a href="#h10-0-8" id="h10-0-8" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h10-0-9" id="h10-0-9" class="d">-    set NextVersion = 3
</a><a href="#h10-0-10" id="h10-0-10" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h10-0-11" id="h10-0-11" class="d">-    set TxnActive(2) = []
</a><a href="#h10-0-12" id="h10-0-12" class="d">-
</a><a href="#h10-0-13" id="h10-0-13" class="d">-T2: set &quot;key&quot; = 0x02
</a><a href="#h10-0-14" id="h10-0-14" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h10-0-15" id="h10-0-15" class="d">-    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h10-0-16" id="h10-0-16" class="d">-
</a><a href="#h10-0-17" id="h10-0-17" class="d">-T2: commit
</a><a href="#h10-0-18" id="h10-0-18" class="d">-    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h10-0-19" id="h10-0-19" class="d">-    del TxnActive(2)
</a><a href="#h10-0-20" id="h10-0-20" class="d">-
</a><a href="#h10-0-21" id="h10-0-21" class="d">-T3: begin → v3 read-write active={1}
</a><a href="#h10-0-22" id="h10-0-22" class="d">-    set NextVersion = 4
</a><a href="#h10-0-23" id="h10-0-23" class="d">-    set TxnActiveSnapshot(3) = {1}
</a><a href="#h10-0-24" id="h10-0-24" class="d">-    set TxnActive(3) = []
</a><a href="#h10-0-25" id="h10-0-25" class="d">-
</a><a href="#h10-0-26" id="h10-0-26" class="d">-T3: set &quot;key&quot; = 0x03
</a><a href="#h10-0-27" id="h10-0-27" class="d">-    set TxnWrite(3, &quot;key&quot;) = []
</a><a href="#h10-0-28" id="h10-0-28" class="d">-    set Version(&quot;key&quot;, 3) = 0x03
</a><a href="#h10-0-29" id="h10-0-29" class="d">-
</a><a href="#h10-0-30" id="h10-0-30" class="d">-T4: begin as of 3 → v3 read-only active={1}
</a><a href="#h10-0-31" id="h10-0-31" class="d">-
</a><a href="#h10-0-32" id="h10-0-32" class="d">-T4: scan ..
</a><a href="#h10-0-33" id="h10-0-33" class="d">-    &quot;key&quot; = 0x02
</a><a href="#h10-0-34" id="h10-0-34" class="d">-
</a><a href="#h10-0-35" id="h10-0-35" class="d">-T4: set &quot;foo&quot; = 0x01 → Error::ReadOnly
</a><a href="#h10-0-36" id="h10-0-36" class="d">-
</a><a href="#h10-0-37" id="h10-0-37" class="d">-T4: del &quot;foo&quot; → Error::ReadOnly
</a><a href="#h10-0-38" id="h10-0-38" class="d">-
</a><a href="#h10-0-39" id="h10-0-39" class="d">-T1: commit
</a><a href="#h10-0-40" id="h10-0-40" class="d">-    del TxnWrite(1, &quot;other&quot;)
</a><a href="#h10-0-41" id="h10-0-41" class="d">-    del TxnActive(1)
</a><a href="#h10-0-42" id="h10-0-42" class="d">-
</a><a href="#h10-0-43" id="h10-0-43" class="d">-T3: commit
</a><a href="#h10-0-44" id="h10-0-44" class="d">-    del TxnWrite(3, &quot;key&quot;)
</a><a href="#h10-0-45" id="h10-0-45" class="d">-    del TxnActive(3)
</a><a href="#h10-0-46" id="h10-0-46" class="d">-
</a><a href="#h10-0-47" id="h10-0-47" class="d">-T4: scan ..
</a><a href="#h10-0-48" id="h10-0-48" class="d">-    &quot;key&quot; = 0x02
</a><a href="#h10-0-49" id="h10-0-49" class="d">-
</a><a href="#h10-0-50" id="h10-0-50" class="d">-T5: begin as of 3 → v3 read-only active={1}
</a><a href="#h10-0-51" id="h10-0-51" class="d">-
</a><a href="#h10-0-52" id="h10-0-52" class="d">-T5: scan ..
</a><a href="#h10-0-53" id="h10-0-53" class="d">-    &quot;key&quot; = 0x02
</a><a href="#h10-0-54" id="h10-0-54" class="d">-
</a><a href="#h10-0-55" id="h10-0-55" class="d">-T4: rollback
</a><a href="#h10-0-56" id="h10-0-56" class="d">-
</a><a href="#h10-0-57" id="h10-0-57" class="d">-T5: commit
</a><a href="#h10-0-58" id="h10-0-58" class="d">-
</a><a href="#h10-0-59" id="h10-0-59" class="d">-T6: begin → v4 read-write active={}
</a><a href="#h10-0-60" id="h10-0-60" class="d">-    set NextVersion = 5
</a><a href="#h10-0-61" id="h10-0-61" class="d">-    set TxnActive(4) = []
</a><a href="#h10-0-62" id="h10-0-62" class="d">-
</a><a href="#h10-0-63" id="h10-0-63" class="d">-T6: set &quot;key&quot; = 0x04
</a><a href="#h10-0-64" id="h10-0-64" class="d">-    set TxnWrite(4, &quot;key&quot;) = []
</a><a href="#h10-0-65" id="h10-0-65" class="d">-    set Version(&quot;key&quot;, 4) = 0x04
</a><a href="#h10-0-66" id="h10-0-66" class="d">-
</a><a href="#h10-0-67" id="h10-0-67" class="d">-T6: commit
</a><a href="#h10-0-68" id="h10-0-68" class="d">-    del TxnWrite(4, &quot;key&quot;)
</a><a href="#h10-0-69" id="h10-0-69" class="d">-    del TxnActive(4)
</a><a href="#h10-0-70" id="h10-0-70" class="d">-
</a><a href="#h10-0-71" id="h10-0-71" class="d">-T7: begin as of 4 → v4 read-only active={}
</a><a href="#h10-0-72" id="h10-0-72" class="d">-
</a><a href="#h10-0-73" id="h10-0-73" class="d">-T7: scan ..
</a><a href="#h10-0-74" id="h10-0-74" class="d">-    &quot;key&quot; = 0x03
</a><a href="#h10-0-75" id="h10-0-75" class="d">-    &quot;other&quot; = 0x01
</a><a href="#h10-0-76" id="h10-0-76" class="d">-
</a><a href="#h10-0-77" id="h10-0-77" class="d">-T8: begin as of 5 → Error::InvalidInput(&quot;version 5 does not exist&quot;)
</a><a href="#h10-0-78" id="h10-0-78" class="d">-
</a><a href="#h10-0-79" id="h10-0-79" class="d">-T9: begin as of 9 → Error::InvalidInput(&quot;version 9 does not exist&quot;)
</a><a href="#h10-0-80" id="h10-0-80" class="d">-
</a><a href="#h10-0-81" id="h10-0-81" class="d">-Engine state:
</a><a href="#h10-0-82" id="h10-0-82" class="d">-NextVersion = 5
</a><a href="#h10-0-83" id="h10-0-83" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h10-0-84" id="h10-0-84" class="d">-TxnActiveSnapshot(3) = {1}
</a><a href="#h10-0-85" id="h10-0-85" class="d">-Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h10-0-86" id="h10-0-86" class="d">-Version(&quot;key&quot;, 3) = 0x03
</a><a href="#h10-0-87" id="h10-0-87" class="d">-Version(&quot;key&quot;, 4) = 0x04
</a><a href="#h10-0-88" id="h10-0-88" class="d">-Version(&quot;other&quot;, 1) = 0x01
</a><b>diff --git a/<a id="h11" href="../file/src/storage/golden/mvcc/begin_read_only.html">src/storage/golden/mvcc/begin_read_only</a> b/<a href="../file/src/storage/golden/mvcc/begin_read_only.html">src/storage/golden/mvcc/begin_read_only</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,15 +0,0 @@
</a><a href="#h11-0-0" id="h11-0-0" class="d">-T1: begin read-only → v1 read-only active={}
</a><a href="#h11-0-1" id="h11-0-1" class="d">-
</a><a href="#h11-0-2" id="h11-0-2" class="d">-T1: set &quot;foo&quot; = 0x01 → Error::ReadOnly
</a><a href="#h11-0-3" id="h11-0-3" class="d">-
</a><a href="#h11-0-4" id="h11-0-4" class="d">-T1: del &quot;foo&quot; → Error::ReadOnly
</a><a href="#h11-0-5" id="h11-0-5" class="d">-
</a><a href="#h11-0-6" id="h11-0-6" class="d">-T2: begin → v1 read-write active={}
</a><a href="#h11-0-7" id="h11-0-7" class="d">-    set NextVersion = 2
</a><a href="#h11-0-8" id="h11-0-8" class="d">-    set TxnActive(1) = []
</a><a href="#h11-0-9" id="h11-0-9" class="d">-
</a><a href="#h11-0-10" id="h11-0-10" class="d">-T3: begin read-only → v2 read-only active={1}
</a><a href="#h11-0-11" id="h11-0-11" class="d">-
</a><a href="#h11-0-12" id="h11-0-12" class="d">-Engine state:
</a><a href="#h11-0-13" id="h11-0-13" class="d">-NextVersion = 2
</a><a href="#h11-0-14" id="h11-0-14" class="d">-TxnActive(1) = []
</a><b>diff --git a/<a id="h12" href="../file/src/storage/golden/mvcc/delete.html">src/storage/golden/mvcc/delete</a> b/<a href="../file/src/storage/golden/mvcc/delete.html">src/storage/golden/mvcc/delete</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,42 +0,0 @@
</a><a href="#h12-0-0" id="h12-0-0" class="d">-Engine state:
</a><a href="#h12-0-1" id="h12-0-1" class="d">-NextVersion = 2
</a><a href="#h12-0-2" id="h12-0-2" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h12-0-3" id="h12-0-3" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h12-0-4" id="h12-0-4" class="d">-
</a><a href="#h12-0-5" id="h12-0-5" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h12-0-6" id="h12-0-6" class="d">-    set NextVersion = 3
</a><a href="#h12-0-7" id="h12-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h12-0-8" id="h12-0-8" class="d">-
</a><a href="#h12-0-9" id="h12-0-9" class="d">-T1: set &quot;key&quot; = 0x02
</a><a href="#h12-0-10" id="h12-0-10" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h12-0-11" id="h12-0-11" class="d">-    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h12-0-12" id="h12-0-12" class="d">-
</a><a href="#h12-0-13" id="h12-0-13" class="d">-T1: del &quot;key&quot;
</a><a href="#h12-0-14" id="h12-0-14" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h12-0-15" id="h12-0-15" class="d">-    set Version(&quot;key&quot;, 2) = None
</a><a href="#h12-0-16" id="h12-0-16" class="d">-
</a><a href="#h12-0-17" id="h12-0-17" class="d">-T1: del &quot;key&quot;
</a><a href="#h12-0-18" id="h12-0-18" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h12-0-19" id="h12-0-19" class="d">-    set Version(&quot;key&quot;, 2) = None
</a><a href="#h12-0-20" id="h12-0-20" class="d">-
</a><a href="#h12-0-21" id="h12-0-21" class="d">-T1: del &quot;tombstone&quot;
</a><a href="#h12-0-22" id="h12-0-22" class="d">-    set TxnWrite(2, &quot;tombstone&quot;) = []
</a><a href="#h12-0-23" id="h12-0-23" class="d">-    set Version(&quot;tombstone&quot;, 2) = None
</a><a href="#h12-0-24" id="h12-0-24" class="d">-
</a><a href="#h12-0-25" id="h12-0-25" class="d">-T1: del &quot;missing&quot;
</a><a href="#h12-0-26" id="h12-0-26" class="d">-    set TxnWrite(2, &quot;missing&quot;) = []
</a><a href="#h12-0-27" id="h12-0-27" class="d">-    set Version(&quot;missing&quot;, 2) = None
</a><a href="#h12-0-28" id="h12-0-28" class="d">-
</a><a href="#h12-0-29" id="h12-0-29" class="d">-T1: commit
</a><a href="#h12-0-30" id="h12-0-30" class="d">-    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h12-0-31" id="h12-0-31" class="d">-    del TxnWrite(2, &quot;missing&quot;)
</a><a href="#h12-0-32" id="h12-0-32" class="d">-    del TxnWrite(2, &quot;tombstone&quot;)
</a><a href="#h12-0-33" id="h12-0-33" class="d">-    del TxnActive(2)
</a><a href="#h12-0-34" id="h12-0-34" class="d">-
</a><a href="#h12-0-35" id="h12-0-35" class="d">-Engine state:
</a><a href="#h12-0-36" id="h12-0-36" class="d">-NextVersion = 3
</a><a href="#h12-0-37" id="h12-0-37" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h12-0-38" id="h12-0-38" class="d">-Version(&quot;key&quot;, 2) = None
</a><a href="#h12-0-39" id="h12-0-39" class="d">-Version(&quot;missing&quot;, 2) = None
</a><a href="#h12-0-40" id="h12-0-40" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h12-0-41" id="h12-0-41" class="d">-Version(&quot;tombstone&quot;, 2) = None
</a><b>diff --git a/<a id="h13" href="../file/src/storage/golden/mvcc/delete_conflict.html">src/storage/golden/mvcc/delete_conflict</a> b/<a href="../file/src/storage/golden/mvcc/delete_conflict.html">src/storage/golden/mvcc/delete_conflict</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,54 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h13-0-1" id="h13-0-1" class="d">-    set NextVersion = 2
</a><a href="#h13-0-2" id="h13-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h13-0-3" id="h13-0-3" class="d">-
</a><a href="#h13-0-4" id="h13-0-4" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h13-0-5" id="h13-0-5" class="d">-    set NextVersion = 3
</a><a href="#h13-0-6" id="h13-0-6" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h13-0-7" id="h13-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h13-0-8" id="h13-0-8" class="d">-
</a><a href="#h13-0-9" id="h13-0-9" class="d">-T3: begin → v3 read-write active={1,2}
</a><a href="#h13-0-10" id="h13-0-10" class="d">-    set NextVersion = 4
</a><a href="#h13-0-11" id="h13-0-11" class="d">-    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h13-0-12" id="h13-0-12" class="d">-    set TxnActive(3) = []
</a><a href="#h13-0-13" id="h13-0-13" class="d">-
</a><a href="#h13-0-14" id="h13-0-14" class="d">-T4: begin → v4 read-write active={1,2,3}
</a><a href="#h13-0-15" id="h13-0-15" class="d">-    set NextVersion = 5
</a><a href="#h13-0-16" id="h13-0-16" class="d">-    set TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h13-0-17" id="h13-0-17" class="d">-    set TxnActive(4) = []
</a><a href="#h13-0-18" id="h13-0-18" class="d">-
</a><a href="#h13-0-19" id="h13-0-19" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h13-0-20" id="h13-0-20" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h13-0-21" id="h13-0-21" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h13-0-22" id="h13-0-22" class="d">-
</a><a href="#h13-0-23" id="h13-0-23" class="d">-T3: set &quot;c&quot; = 0x03
</a><a href="#h13-0-24" id="h13-0-24" class="d">-    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h13-0-25" id="h13-0-25" class="d">-    set Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h13-0-26" id="h13-0-26" class="d">-
</a><a href="#h13-0-27" id="h13-0-27" class="d">-T4: set &quot;d&quot; = 0x04
</a><a href="#h13-0-28" id="h13-0-28" class="d">-    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h13-0-29" id="h13-0-29" class="d">-    set Version(&quot;d&quot;, 4) = 0x04
</a><a href="#h13-0-30" id="h13-0-30" class="d">-
</a><a href="#h13-0-31" id="h13-0-31" class="d">-T4: commit
</a><a href="#h13-0-32" id="h13-0-32" class="d">-    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h13-0-33" id="h13-0-33" class="d">-    del TxnActive(4)
</a><a href="#h13-0-34" id="h13-0-34" class="d">-
</a><a href="#h13-0-35" id="h13-0-35" class="d">-T2: del &quot;a&quot; → Error::Serialization
</a><a href="#h13-0-36" id="h13-0-36" class="d">-
</a><a href="#h13-0-37" id="h13-0-37" class="d">-T2: del &quot;c&quot; → Error::Serialization
</a><a href="#h13-0-38" id="h13-0-38" class="d">-
</a><a href="#h13-0-39" id="h13-0-39" class="d">-T2: del &quot;d&quot; → Error::Serialization
</a><a href="#h13-0-40" id="h13-0-40" class="d">-
</a><a href="#h13-0-41" id="h13-0-41" class="d">-Engine state:
</a><a href="#h13-0-42" id="h13-0-42" class="d">-NextVersion = 5
</a><a href="#h13-0-43" id="h13-0-43" class="d">-TxnActive(1) = []
</a><a href="#h13-0-44" id="h13-0-44" class="d">-TxnActive(2) = []
</a><a href="#h13-0-45" id="h13-0-45" class="d">-TxnActive(3) = []
</a><a href="#h13-0-46" id="h13-0-46" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h13-0-47" id="h13-0-47" class="d">-TxnActiveSnapshot(3) = {1,2}
</a><a href="#h13-0-48" id="h13-0-48" class="d">-TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h13-0-49" id="h13-0-49" class="d">-TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h13-0-50" id="h13-0-50" class="d">-TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h13-0-51" id="h13-0-51" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h13-0-52" id="h13-0-52" class="d">-Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h13-0-53" id="h13-0-53" class="d">-Version(&quot;d&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h14" href="../file/src/storage/golden/mvcc/get.html">src/storage/golden/mvcc/get</a> b/<a href="../file/src/storage/golden/mvcc/get.html">src/storage/golden/mvcc/get</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-Engine state:
</a><a href="#h14-0-1" id="h14-0-1" class="d">-NextVersion = 3
</a><a href="#h14-0-2" id="h14-0-2" class="d">-Version(&quot;deleted&quot;, 1) = 0x01
</a><a href="#h14-0-3" id="h14-0-3" class="d">-Version(&quot;deleted&quot;, 2) = None
</a><a href="#h14-0-4" id="h14-0-4" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h14-0-5" id="h14-0-5" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h14-0-6" id="h14-0-6" class="d">-Version(&quot;updated&quot;, 1) = 0x01
</a><a href="#h14-0-7" id="h14-0-7" class="d">-Version(&quot;updated&quot;, 2) = 0x02
</a><a href="#h14-0-8" id="h14-0-8" class="d">-
</a><a href="#h14-0-9" id="h14-0-9" class="d">-T1: begin read-only → v3 read-only active={}
</a><a href="#h14-0-10" id="h14-0-10" class="d">-
</a><a href="#h14-0-11" id="h14-0-11" class="d">-T1: get &quot;key&quot; → 0x01
</a><a href="#h14-0-12" id="h14-0-12" class="d">-
</a><a href="#h14-0-13" id="h14-0-13" class="d">-T1: get &quot;updated&quot; → 0x02
</a><a href="#h14-0-14" id="h14-0-14" class="d">-
</a><a href="#h14-0-15" id="h14-0-15" class="d">-T1: get &quot;deleted&quot; → None
</a><a href="#h14-0-16" id="h14-0-16" class="d">-
</a><a href="#h14-0-17" id="h14-0-17" class="d">-T1: get &quot;tombstone&quot; → None
</a><a href="#h14-0-18" id="h14-0-18" class="d">-
</a><a href="#h14-0-19" id="h14-0-19" class="d">-Engine state:
</a><a href="#h14-0-20" id="h14-0-20" class="d">-NextVersion = 3
</a><a href="#h14-0-21" id="h14-0-21" class="d">-Version(&quot;deleted&quot;, 1) = 0x01
</a><a href="#h14-0-22" id="h14-0-22" class="d">-Version(&quot;deleted&quot;, 2) = None
</a><a href="#h14-0-23" id="h14-0-23" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h14-0-24" id="h14-0-24" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h14-0-25" id="h14-0-25" class="d">-Version(&quot;updated&quot;, 1) = 0x01
</a><a href="#h14-0-26" id="h14-0-26" class="d">-Version(&quot;updated&quot;, 2) = 0x02
</a><b>diff --git a/<a id="h15" href="../file/src/storage/golden/mvcc/get_isolation.html">src/storage/golden/mvcc/get_isolation</a> b/<a href="../file/src/storage/golden/mvcc/get_isolation.html">src/storage/golden/mvcc/get_isolation</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,97 +0,0 @@
</a><a href="#h15-0-0" id="h15-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h15-0-1" id="h15-0-1" class="d">-    set NextVersion = 2
</a><a href="#h15-0-2" id="h15-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h15-0-3" id="h15-0-3" class="d">-
</a><a href="#h15-0-4" id="h15-0-4" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h15-0-5" id="h15-0-5" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h15-0-6" id="h15-0-6" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h15-0-7" id="h15-0-7" class="d">-
</a><a href="#h15-0-8" id="h15-0-8" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h15-0-9" id="h15-0-9" class="d">-    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h15-0-10" id="h15-0-10" class="d">-    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h15-0-11" id="h15-0-11" class="d">-
</a><a href="#h15-0-12" id="h15-0-12" class="d">-T1: set &quot;d&quot; = 0x01
</a><a href="#h15-0-13" id="h15-0-13" class="d">-    set TxnWrite(1, &quot;d&quot;) = []
</a><a href="#h15-0-14" id="h15-0-14" class="d">-    set Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h15-0-15" id="h15-0-15" class="d">-
</a><a href="#h15-0-16" id="h15-0-16" class="d">-T1: set &quot;e&quot; = 0x01
</a><a href="#h15-0-17" id="h15-0-17" class="d">-    set TxnWrite(1, &quot;e&quot;) = []
</a><a href="#h15-0-18" id="h15-0-18" class="d">-    set Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h15-0-19" id="h15-0-19" class="d">-
</a><a href="#h15-0-20" id="h15-0-20" class="d">-T1: commit
</a><a href="#h15-0-21" id="h15-0-21" class="d">-    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h15-0-22" id="h15-0-22" class="d">-    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h15-0-23" id="h15-0-23" class="d">-    del TxnWrite(1, &quot;d&quot;)
</a><a href="#h15-0-24" id="h15-0-24" class="d">-    del TxnWrite(1, &quot;e&quot;)
</a><a href="#h15-0-25" id="h15-0-25" class="d">-    del TxnActive(1)
</a><a href="#h15-0-26" id="h15-0-26" class="d">-
</a><a href="#h15-0-27" id="h15-0-27" class="d">-T2: begin → v2 read-write active={}
</a><a href="#h15-0-28" id="h15-0-28" class="d">-    set NextVersion = 3
</a><a href="#h15-0-29" id="h15-0-29" class="d">-    set TxnActive(2) = []
</a><a href="#h15-0-30" id="h15-0-30" class="d">-
</a><a href="#h15-0-31" id="h15-0-31" class="d">-T2: set &quot;a&quot; = 0x02
</a><a href="#h15-0-32" id="h15-0-32" class="d">-    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h15-0-33" id="h15-0-33" class="d">-    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h15-0-34" id="h15-0-34" class="d">-
</a><a href="#h15-0-35" id="h15-0-35" class="d">-T2: del &quot;b&quot;
</a><a href="#h15-0-36" id="h15-0-36" class="d">-    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h15-0-37" id="h15-0-37" class="d">-    set Version(&quot;b&quot;, 2) = None
</a><a href="#h15-0-38" id="h15-0-38" class="d">-
</a><a href="#h15-0-39" id="h15-0-39" class="d">-T2: set &quot;c&quot; = 0x02
</a><a href="#h15-0-40" id="h15-0-40" class="d">-    set TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h15-0-41" id="h15-0-41" class="d">-    set Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h15-0-42" id="h15-0-42" class="d">-
</a><a href="#h15-0-43" id="h15-0-43" class="d">-T3: begin read-only → v3 read-only active={2}
</a><a href="#h15-0-44" id="h15-0-44" class="d">-
</a><a href="#h15-0-45" id="h15-0-45" class="d">-T4: begin → v3 read-write active={2}
</a><a href="#h15-0-46" id="h15-0-46" class="d">-    set NextVersion = 4
</a><a href="#h15-0-47" id="h15-0-47" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h15-0-48" id="h15-0-48" class="d">-    set TxnActive(3) = []
</a><a href="#h15-0-49" id="h15-0-49" class="d">-
</a><a href="#h15-0-50" id="h15-0-50" class="d">-T4: set &quot;d&quot; = 0x03
</a><a href="#h15-0-51" id="h15-0-51" class="d">-    set TxnWrite(3, &quot;d&quot;) = []
</a><a href="#h15-0-52" id="h15-0-52" class="d">-    set Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h15-0-53" id="h15-0-53" class="d">-
</a><a href="#h15-0-54" id="h15-0-54" class="d">-T4: del &quot;e&quot;
</a><a href="#h15-0-55" id="h15-0-55" class="d">-    set TxnWrite(3, &quot;e&quot;) = []
</a><a href="#h15-0-56" id="h15-0-56" class="d">-    set Version(&quot;e&quot;, 3) = None
</a><a href="#h15-0-57" id="h15-0-57" class="d">-
</a><a href="#h15-0-58" id="h15-0-58" class="d">-T4: set &quot;f&quot; = 0x03
</a><a href="#h15-0-59" id="h15-0-59" class="d">-    set TxnWrite(3, &quot;f&quot;) = []
</a><a href="#h15-0-60" id="h15-0-60" class="d">-    set Version(&quot;f&quot;, 3) = 0x03
</a><a href="#h15-0-61" id="h15-0-61" class="d">-
</a><a href="#h15-0-62" id="h15-0-62" class="d">-T4: commit
</a><a href="#h15-0-63" id="h15-0-63" class="d">-    del TxnWrite(3, &quot;d&quot;)
</a><a href="#h15-0-64" id="h15-0-64" class="d">-    del TxnWrite(3, &quot;e&quot;)
</a><a href="#h15-0-65" id="h15-0-65" class="d">-    del TxnWrite(3, &quot;f&quot;)
</a><a href="#h15-0-66" id="h15-0-66" class="d">-    del TxnActive(3)
</a><a href="#h15-0-67" id="h15-0-67" class="d">-
</a><a href="#h15-0-68" id="h15-0-68" class="d">-T3: get &quot;a&quot; → 0x01
</a><a href="#h15-0-69" id="h15-0-69" class="d">-
</a><a href="#h15-0-70" id="h15-0-70" class="d">-T3: get &quot;b&quot; → 0x01
</a><a href="#h15-0-71" id="h15-0-71" class="d">-
</a><a href="#h15-0-72" id="h15-0-72" class="d">-T3: get &quot;c&quot; → None
</a><a href="#h15-0-73" id="h15-0-73" class="d">-
</a><a href="#h15-0-74" id="h15-0-74" class="d">-T3: get &quot;d&quot; → 0x01
</a><a href="#h15-0-75" id="h15-0-75" class="d">-
</a><a href="#h15-0-76" id="h15-0-76" class="d">-T3: get &quot;e&quot; → 0x01
</a><a href="#h15-0-77" id="h15-0-77" class="d">-
</a><a href="#h15-0-78" id="h15-0-78" class="d">-T3: get &quot;f&quot; → None
</a><a href="#h15-0-79" id="h15-0-79" class="d">-
</a><a href="#h15-0-80" id="h15-0-80" class="d">-Engine state:
</a><a href="#h15-0-81" id="h15-0-81" class="d">-NextVersion = 4
</a><a href="#h15-0-82" id="h15-0-82" class="d">-TxnActive(2) = []
</a><a href="#h15-0-83" id="h15-0-83" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h15-0-84" id="h15-0-84" class="d">-TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h15-0-85" id="h15-0-85" class="d">-TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h15-0-86" id="h15-0-86" class="d">-TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h15-0-87" id="h15-0-87" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h15-0-88" id="h15-0-88" class="d">-Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h15-0-89" id="h15-0-89" class="d">-Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h15-0-90" id="h15-0-90" class="d">-Version(&quot;b&quot;, 2) = None
</a><a href="#h15-0-91" id="h15-0-91" class="d">-Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h15-0-92" id="h15-0-92" class="d">-Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h15-0-93" id="h15-0-93" class="d">-Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h15-0-94" id="h15-0-94" class="d">-Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h15-0-95" id="h15-0-95" class="d">-Version(&quot;e&quot;, 3) = None
</a><a href="#h15-0-96" id="h15-0-96" class="d">-Version(&quot;f&quot;, 3) = 0x03
</a><b>diff --git a/<a id="h16" href="../file/src/storage/golden/mvcc/resume.html">src/storage/golden/mvcc/resume</a> b/<a href="../file/src/storage/golden/mvcc/resume.html">src/storage/golden/mvcc/resume</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,110 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h16-0-1" id="h16-0-1" class="d">-    set NextVersion = 2
</a><a href="#h16-0-2" id="h16-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h16-0-3" id="h16-0-3" class="d">-
</a><a href="#h16-0-4" id="h16-0-4" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h16-0-5" id="h16-0-5" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h16-0-6" id="h16-0-6" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h16-0-7" id="h16-0-7" class="d">-
</a><a href="#h16-0-8" id="h16-0-8" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h16-0-9" id="h16-0-9" class="d">-    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h16-0-10" id="h16-0-10" class="d">-    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h16-0-11" id="h16-0-11" class="d">-
</a><a href="#h16-0-12" id="h16-0-12" class="d">-T1: commit
</a><a href="#h16-0-13" id="h16-0-13" class="d">-    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h16-0-14" id="h16-0-14" class="d">-    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h16-0-15" id="h16-0-15" class="d">-    del TxnActive(1)
</a><a href="#h16-0-16" id="h16-0-16" class="d">-
</a><a href="#h16-0-17" id="h16-0-17" class="d">-T2: begin → v2 read-write active={}
</a><a href="#h16-0-18" id="h16-0-18" class="d">-    set NextVersion = 3
</a><a href="#h16-0-19" id="h16-0-19" class="d">-    set TxnActive(2) = []
</a><a href="#h16-0-20" id="h16-0-20" class="d">-
</a><a href="#h16-0-21" id="h16-0-21" class="d">-T3: begin → v3 read-write active={2}
</a><a href="#h16-0-22" id="h16-0-22" class="d">-    set NextVersion = 4
</a><a href="#h16-0-23" id="h16-0-23" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h16-0-24" id="h16-0-24" class="d">-    set TxnActive(3) = []
</a><a href="#h16-0-25" id="h16-0-25" class="d">-
</a><a href="#h16-0-26" id="h16-0-26" class="d">-T4: begin → v4 read-write active={2,3}
</a><a href="#h16-0-27" id="h16-0-27" class="d">-    set NextVersion = 5
</a><a href="#h16-0-28" id="h16-0-28" class="d">-    set TxnActiveSnapshot(4) = {2,3}
</a><a href="#h16-0-29" id="h16-0-29" class="d">-    set TxnActive(4) = []
</a><a href="#h16-0-30" id="h16-0-30" class="d">-
</a><a href="#h16-0-31" id="h16-0-31" class="d">-T2: set &quot;a&quot; = 0x02
</a><a href="#h16-0-32" id="h16-0-32" class="d">-    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h16-0-33" id="h16-0-33" class="d">-    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h16-0-34" id="h16-0-34" class="d">-
</a><a href="#h16-0-35" id="h16-0-35" class="d">-T3: set &quot;b&quot; = 0x03
</a><a href="#h16-0-36" id="h16-0-36" class="d">-    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h16-0-37" id="h16-0-37" class="d">-    set Version(&quot;b&quot;, 3) = 0x03
</a><a href="#h16-0-38" id="h16-0-38" class="d">-
</a><a href="#h16-0-39" id="h16-0-39" class="d">-T4: set &quot;c&quot; = 0x04
</a><a href="#h16-0-40" id="h16-0-40" class="d">-    set TxnWrite(4, &quot;c&quot;) = []
</a><a href="#h16-0-41" id="h16-0-41" class="d">-    set Version(&quot;c&quot;, 4) = 0x04
</a><a href="#h16-0-42" id="h16-0-42" class="d">-
</a><a href="#h16-0-43" id="h16-0-43" class="d">-T2: commit
</a><a href="#h16-0-44" id="h16-0-44" class="d">-    del TxnWrite(2, &quot;a&quot;)
</a><a href="#h16-0-45" id="h16-0-45" class="d">-    del TxnActive(2)
</a><a href="#h16-0-46" id="h16-0-46" class="d">-
</a><a href="#h16-0-47" id="h16-0-47" class="d">-T4: commit
</a><a href="#h16-0-48" id="h16-0-48" class="d">-    del TxnWrite(4, &quot;c&quot;)
</a><a href="#h16-0-49" id="h16-0-49" class="d">-    del TxnActive(4)
</a><a href="#h16-0-50" id="h16-0-50" class="d">-
</a><a href="#h16-0-51" id="h16-0-51" class="d">-T5: resume → v3 read-write active={2}
</a><a href="#h16-0-52" id="h16-0-52" class="d">-
</a><a href="#h16-0-53" id="h16-0-53" class="d">-T5: scan ..
</a><a href="#h16-0-54" id="h16-0-54" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h16-0-55" id="h16-0-55" class="d">-    &quot;b&quot; = 0x03
</a><a href="#h16-0-56" id="h16-0-56" class="d">-
</a><a href="#h16-0-57" id="h16-0-57" class="d">-T6: begin → v5 read-write active={3}
</a><a href="#h16-0-58" id="h16-0-58" class="d">-    set NextVersion = 6
</a><a href="#h16-0-59" id="h16-0-59" class="d">-    set TxnActiveSnapshot(5) = {3}
</a><a href="#h16-0-60" id="h16-0-60" class="d">-    set TxnActive(5) = []
</a><a href="#h16-0-61" id="h16-0-61" class="d">-
</a><a href="#h16-0-62" id="h16-0-62" class="d">-T6: scan ..
</a><a href="#h16-0-63" id="h16-0-63" class="d">-    &quot;a&quot; = 0x02
</a><a href="#h16-0-64" id="h16-0-64" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h16-0-65" id="h16-0-65" class="d">-    &quot;c&quot; = 0x04
</a><a href="#h16-0-66" id="h16-0-66" class="d">-
</a><a href="#h16-0-67" id="h16-0-67" class="d">-T6: rollback
</a><a href="#h16-0-68" id="h16-0-68" class="d">-    del TxnActive(5)
</a><a href="#h16-0-69" id="h16-0-69" class="d">-
</a><a href="#h16-0-70" id="h16-0-70" class="d">-T5: commit
</a><a href="#h16-0-71" id="h16-0-71" class="d">-    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h16-0-72" id="h16-0-72" class="d">-    del TxnActive(3)
</a><a href="#h16-0-73" id="h16-0-73" class="d">-
</a><a href="#h16-0-74" id="h16-0-74" class="d">-T7: begin → v6 read-write active={}
</a><a href="#h16-0-75" id="h16-0-75" class="d">-    set NextVersion = 7
</a><a href="#h16-0-76" id="h16-0-76" class="d">-    set TxnActive(6) = []
</a><a href="#h16-0-77" id="h16-0-77" class="d">-
</a><a href="#h16-0-78" id="h16-0-78" class="d">-T7: scan ..
</a><a href="#h16-0-79" id="h16-0-79" class="d">-    &quot;a&quot; = 0x02
</a><a href="#h16-0-80" id="h16-0-80" class="d">-    &quot;b&quot; = 0x03
</a><a href="#h16-0-81" id="h16-0-81" class="d">-    &quot;c&quot; = 0x04
</a><a href="#h16-0-82" id="h16-0-82" class="d">-
</a><a href="#h16-0-83" id="h16-0-83" class="d">-T7: rollback
</a><a href="#h16-0-84" id="h16-0-84" class="d">-    del TxnActive(6)
</a><a href="#h16-0-85" id="h16-0-85" class="d">-
</a><a href="#h16-0-86" id="h16-0-86" class="d">-T8: resume → Error::InvalidInput(&quot;no active transaction at version 3&quot;)
</a><a href="#h16-0-87" id="h16-0-87" class="d">-
</a><a href="#h16-0-88" id="h16-0-88" class="d">-T9: begin as of 3 → v3 read-only active={2}
</a><a href="#h16-0-89" id="h16-0-89" class="d">-
</a><a href="#h16-0-90" id="h16-0-90" class="d">-T9: scan ..
</a><a href="#h16-0-91" id="h16-0-91" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h16-0-92" id="h16-0-92" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h16-0-93" id="h16-0-93" class="d">-
</a><a href="#h16-0-94" id="h16-0-94" class="d">-T10: resume → v3 read-only active={2}
</a><a href="#h16-0-95" id="h16-0-95" class="d">-
</a><a href="#h16-0-96" id="h16-0-96" class="d">-T10: scan ..
</a><a href="#h16-0-97" id="h16-0-97" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h16-0-98" id="h16-0-98" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h16-0-99" id="h16-0-99" class="d">-
</a><a href="#h16-0-100" id="h16-0-100" class="d">-Engine state:
</a><a href="#h16-0-101" id="h16-0-101" class="d">-NextVersion = 7
</a><a href="#h16-0-102" id="h16-0-102" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h16-0-103" id="h16-0-103" class="d">-TxnActiveSnapshot(4) = {2,3}
</a><a href="#h16-0-104" id="h16-0-104" class="d">-TxnActiveSnapshot(5) = {3}
</a><a href="#h16-0-105" id="h16-0-105" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h16-0-106" id="h16-0-106" class="d">-Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h16-0-107" id="h16-0-107" class="d">-Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h16-0-108" id="h16-0-108" class="d">-Version(&quot;b&quot;, 3) = 0x03
</a><a href="#h16-0-109" id="h16-0-109" class="d">-Version(&quot;c&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h17" href="../file/src/storage/golden/mvcc/rollback.html">src/storage/golden/mvcc/rollback</a> b/<a href="../file/src/storage/golden/mvcc/rollback.html">src/storage/golden/mvcc/rollback</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,94 +0,0 @@
</a><a href="#h17-0-0" id="h17-0-0" class="d">-Engine state:
</a><a href="#h17-0-1" id="h17-0-1" class="d">-NextVersion = 2
</a><a href="#h17-0-2" id="h17-0-2" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h17-0-3" id="h17-0-3" class="d">-Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h17-0-4" id="h17-0-4" class="d">-Version(&quot;c&quot;, 1) = 0x00
</a><a href="#h17-0-5" id="h17-0-5" class="d">-Version(&quot;d&quot;, 1) = 0x00
</a><a href="#h17-0-6" id="h17-0-6" class="d">-
</a><a href="#h17-0-7" id="h17-0-7" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h17-0-8" id="h17-0-8" class="d">-    set NextVersion = 3
</a><a href="#h17-0-9" id="h17-0-9" class="d">-    set TxnActive(2) = []
</a><a href="#h17-0-10" id="h17-0-10" class="d">-
</a><a href="#h17-0-11" id="h17-0-11" class="d">-T2: begin → v3 read-write active={2}
</a><a href="#h17-0-12" id="h17-0-12" class="d">-    set NextVersion = 4
</a><a href="#h17-0-13" id="h17-0-13" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h17-0-14" id="h17-0-14" class="d">-    set TxnActive(3) = []
</a><a href="#h17-0-15" id="h17-0-15" class="d">-
</a><a href="#h17-0-16" id="h17-0-16" class="d">-T3: begin → v4 read-write active={2,3}
</a><a href="#h17-0-17" id="h17-0-17" class="d">-    set NextVersion = 5
</a><a href="#h17-0-18" id="h17-0-18" class="d">-    set TxnActiveSnapshot(4) = {2,3}
</a><a href="#h17-0-19" id="h17-0-19" class="d">-    set TxnActive(4) = []
</a><a href="#h17-0-20" id="h17-0-20" class="d">-
</a><a href="#h17-0-21" id="h17-0-21" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h17-0-22" id="h17-0-22" class="d">-    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h17-0-23" id="h17-0-23" class="d">-    set Version(&quot;a&quot;, 2) = 0x01
</a><a href="#h17-0-24" id="h17-0-24" class="d">-
</a><a href="#h17-0-25" id="h17-0-25" class="d">-T2: set &quot;b&quot; = 0x02
</a><a href="#h17-0-26" id="h17-0-26" class="d">-    set TxnWrite(3, &quot;b&quot;) = []
</a><a href="#h17-0-27" id="h17-0-27" class="d">-    set Version(&quot;b&quot;, 3) = 0x02
</a><a href="#h17-0-28" id="h17-0-28" class="d">-
</a><a href="#h17-0-29" id="h17-0-29" class="d">-T2: del &quot;c&quot;
</a><a href="#h17-0-30" id="h17-0-30" class="d">-    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h17-0-31" id="h17-0-31" class="d">-    set Version(&quot;c&quot;, 3) = None
</a><a href="#h17-0-32" id="h17-0-32" class="d">-
</a><a href="#h17-0-33" id="h17-0-33" class="d">-T3: set &quot;d&quot; = 0x03
</a><a href="#h17-0-34" id="h17-0-34" class="d">-    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h17-0-35" id="h17-0-35" class="d">-    set Version(&quot;d&quot;, 4) = 0x03
</a><a href="#h17-0-36" id="h17-0-36" class="d">-
</a><a href="#h17-0-37" id="h17-0-37" class="d">-T1: set &quot;b&quot; = 0x01 → Error::Serialization
</a><a href="#h17-0-38" id="h17-0-38" class="d">-
</a><a href="#h17-0-39" id="h17-0-39" class="d">-T3: set &quot;c&quot; = 0x03 → Error::Serialization
</a><a href="#h17-0-40" id="h17-0-40" class="d">-
</a><a href="#h17-0-41" id="h17-0-41" class="d">-T2: rollback
</a><a href="#h17-0-42" id="h17-0-42" class="d">-    del Version(&quot;b&quot;, 3)
</a><a href="#h17-0-43" id="h17-0-43" class="d">-    del TxnWrite(3, &quot;b&quot;)
</a><a href="#h17-0-44" id="h17-0-44" class="d">-    del Version(&quot;c&quot;, 3)
</a><a href="#h17-0-45" id="h17-0-45" class="d">-    del TxnWrite(3, &quot;c&quot;)
</a><a href="#h17-0-46" id="h17-0-46" class="d">-    del TxnActive(3)
</a><a href="#h17-0-47" id="h17-0-47" class="d">-
</a><a href="#h17-0-48" id="h17-0-48" class="d">-T4: begin read-only → v5 read-only active={2,4}
</a><a href="#h17-0-49" id="h17-0-49" class="d">-
</a><a href="#h17-0-50" id="h17-0-50" class="d">-T4: scan ..
</a><a href="#h17-0-51" id="h17-0-51" class="d">-    &quot;a&quot; = 0x00
</a><a href="#h17-0-52" id="h17-0-52" class="d">-    &quot;b&quot; = 0x00
</a><a href="#h17-0-53" id="h17-0-53" class="d">-    &quot;c&quot; = 0x00
</a><a href="#h17-0-54" id="h17-0-54" class="d">-    &quot;d&quot; = 0x00
</a><a href="#h17-0-55" id="h17-0-55" class="d">-
</a><a href="#h17-0-56" id="h17-0-56" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h17-0-57" id="h17-0-57" class="d">-    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h17-0-58" id="h17-0-58" class="d">-    set Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h17-0-59" id="h17-0-59" class="d">-
</a><a href="#h17-0-60" id="h17-0-60" class="d">-T3: set &quot;c&quot; = 0x03
</a><a href="#h17-0-61" id="h17-0-61" class="d">-    set TxnWrite(4, &quot;c&quot;) = []
</a><a href="#h17-0-62" id="h17-0-62" class="d">-    set Version(&quot;c&quot;, 4) = 0x03
</a><a href="#h17-0-63" id="h17-0-63" class="d">-
</a><a href="#h17-0-64" id="h17-0-64" class="d">-T1: commit
</a><a href="#h17-0-65" id="h17-0-65" class="d">-    del TxnWrite(2, &quot;a&quot;)
</a><a href="#h17-0-66" id="h17-0-66" class="d">-    del TxnWrite(2, &quot;b&quot;)
</a><a href="#h17-0-67" id="h17-0-67" class="d">-    del TxnActive(2)
</a><a href="#h17-0-68" id="h17-0-68" class="d">-
</a><a href="#h17-0-69" id="h17-0-69" class="d">-T3: commit
</a><a href="#h17-0-70" id="h17-0-70" class="d">-    del TxnWrite(4, &quot;c&quot;)
</a><a href="#h17-0-71" id="h17-0-71" class="d">-    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h17-0-72" id="h17-0-72" class="d">-    del TxnActive(4)
</a><a href="#h17-0-73" id="h17-0-73" class="d">-
</a><a href="#h17-0-74" id="h17-0-74" class="d">-T5: begin read-only → v5 read-only active={}
</a><a href="#h17-0-75" id="h17-0-75" class="d">-
</a><a href="#h17-0-76" id="h17-0-76" class="d">-T5: scan ..
</a><a href="#h17-0-77" id="h17-0-77" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h17-0-78" id="h17-0-78" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h17-0-79" id="h17-0-79" class="d">-    &quot;c&quot; = 0x03
</a><a href="#h17-0-80" id="h17-0-80" class="d">-    &quot;d&quot; = 0x03
</a><a href="#h17-0-81" id="h17-0-81" class="d">-
</a><a href="#h17-0-82" id="h17-0-82" class="d">-Engine state:
</a><a href="#h17-0-83" id="h17-0-83" class="d">-NextVersion = 5
</a><a href="#h17-0-84" id="h17-0-84" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h17-0-85" id="h17-0-85" class="d">-TxnActiveSnapshot(4) = {2,3}
</a><a href="#h17-0-86" id="h17-0-86" class="d">-Version(&quot;a&quot;, 1) = 0x00
</a><a href="#h17-0-87" id="h17-0-87" class="d">-Version(&quot;a&quot;, 2) = 0x01
</a><a href="#h17-0-88" id="h17-0-88" class="d">-Version(&quot;b&quot;, 1) = 0x00
</a><a href="#h17-0-89" id="h17-0-89" class="d">-Version(&quot;b&quot;, 2) = 0x01
</a><a href="#h17-0-90" id="h17-0-90" class="d">-Version(&quot;c&quot;, 1) = 0x00
</a><a href="#h17-0-91" id="h17-0-91" class="d">-Version(&quot;c&quot;, 4) = 0x03
</a><a href="#h17-0-92" id="h17-0-92" class="d">-Version(&quot;d&quot;, 1) = 0x00
</a><a href="#h17-0-93" id="h17-0-93" class="d">-Version(&quot;d&quot;, 4) = 0x03
</a><b>diff --git a/<a id="h18" href="../file/src/storage/golden/mvcc/scan.html">src/storage/golden/mvcc/scan</a> b/<a href="../file/src/storage/golden/mvcc/scan.html">src/storage/golden/mvcc/scan</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,109 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-Engine state:
</a><a href="#h18-0-1" id="h18-0-1" class="d">-NextVersion = 5
</a><a href="#h18-0-2" id="h18-0-2" class="d">-Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h18-0-3" id="h18-0-3" class="d">-Version(&quot;B&quot;, 3) = None
</a><a href="#h18-0-4" id="h18-0-4" class="d">-Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h18-0-5" id="h18-0-5" class="d">-Version(&quot;a&quot;, 2) = None
</a><a href="#h18-0-6" id="h18-0-6" class="d">-Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h18-0-7" id="h18-0-7" class="d">-Version(&quot;b&quot;, 1) = None
</a><a href="#h18-0-8" id="h18-0-8" class="d">-Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h18-0-9" id="h18-0-9" class="d">-Version(&quot;b&quot;, 4) = None
</a><a href="#h18-0-10" id="h18-0-10" class="d">-Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h18-0-11" id="h18-0-11" class="d">-Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h18-0-12" id="h18-0-12" class="d">-Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h18-0-13" id="h18-0-13" class="d">-Version(&quot;bb&quot;, 3) = None
</a><a href="#h18-0-14" id="h18-0-14" class="d">-Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h18-0-15" id="h18-0-15" class="d">-Version(&quot;c&quot;, 1) = 0x0c01
</a><a href="#h18-0-16" id="h18-0-16" class="d">-
</a><a href="#h18-0-17" id="h18-0-17" class="d">-T1: begin as of 1 → v1 read-only active={}
</a><a href="#h18-0-18" id="h18-0-18" class="d">-
</a><a href="#h18-0-19" id="h18-0-19" class="d">-T1: scan ..
</a><a href="#h18-0-20" id="h18-0-20" class="d">-
</a><a href="#h18-0-21" id="h18-0-21" class="d">-T2: begin as of 2 → v2 read-only active={}
</a><a href="#h18-0-22" id="h18-0-22" class="d">-
</a><a href="#h18-0-23" id="h18-0-23" class="d">-T2: scan ..
</a><a href="#h18-0-24" id="h18-0-24" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h18-0-25" id="h18-0-25" class="d">-    &quot;a&quot; = 0x0a01
</a><a href="#h18-0-26" id="h18-0-26" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-27" id="h18-0-27" class="d">-
</a><a href="#h18-0-28" id="h18-0-28" class="d">-T3: begin as of 3 → v3 read-only active={}
</a><a href="#h18-0-29" id="h18-0-29" class="d">-
</a><a href="#h18-0-30" id="h18-0-30" class="d">-T3: scan ..
</a><a href="#h18-0-31" id="h18-0-31" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h18-0-32" id="h18-0-32" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-33" id="h18-0-33" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-34" id="h18-0-34" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-35" id="h18-0-35" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-36" id="h18-0-36" class="d">-
</a><a href="#h18-0-37" id="h18-0-37" class="d">-T4: begin as of 4 → v4 read-only active={}
</a><a href="#h18-0-38" id="h18-0-38" class="d">-
</a><a href="#h18-0-39" id="h18-0-39" class="d">-T4: scan ..
</a><a href="#h18-0-40" id="h18-0-40" class="d">-    &quot;a&quot; = 0x0a03
</a><a href="#h18-0-41" id="h18-0-41" class="d">-    &quot;b&quot; = 0x0b03
</a><a href="#h18-0-42" id="h18-0-42" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-43" id="h18-0-43" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-44" id="h18-0-44" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-45" id="h18-0-45" class="d">-
</a><a href="#h18-0-46" id="h18-0-46" class="d">-T5: begin as of 3 → v3 read-only active={}
</a><a href="#h18-0-47" id="h18-0-47" class="d">-
</a><a href="#h18-0-48" id="h18-0-48" class="d">-T5: scan ..
</a><a href="#h18-0-49" id="h18-0-49" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h18-0-50" id="h18-0-50" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-51" id="h18-0-51" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-52" id="h18-0-52" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-53" id="h18-0-53" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-54" id="h18-0-54" class="d">-
</a><a href="#h18-0-55" id="h18-0-55" class="d">-T5: scan ..&quot;bc&quot;]
</a><a href="#h18-0-56" id="h18-0-56" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h18-0-57" id="h18-0-57" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-58" id="h18-0-58" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-59" id="h18-0-59" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-60" id="h18-0-60" class="d">-
</a><a href="#h18-0-61" id="h18-0-61" class="d">-T5: scan ..&quot;bc&quot;)
</a><a href="#h18-0-62" id="h18-0-62" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h18-0-63" id="h18-0-63" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-64" id="h18-0-64" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-65" id="h18-0-65" class="d">-
</a><a href="#h18-0-66" id="h18-0-66" class="d">-T5: scan [&quot;ba&quot;..
</a><a href="#h18-0-67" id="h18-0-67" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-68" id="h18-0-68" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-69" id="h18-0-69" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-70" id="h18-0-70" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-71" id="h18-0-71" class="d">-
</a><a href="#h18-0-72" id="h18-0-72" class="d">-T5: scan [&quot;ba&quot;..&quot;bc&quot;]
</a><a href="#h18-0-73" id="h18-0-73" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-74" id="h18-0-74" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-75" id="h18-0-75" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-76" id="h18-0-76" class="d">-
</a><a href="#h18-0-77" id="h18-0-77" class="d">-T5: scan [&quot;ba&quot;..&quot;bc&quot;)
</a><a href="#h18-0-78" id="h18-0-78" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h18-0-79" id="h18-0-79" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-80" id="h18-0-80" class="d">-
</a><a href="#h18-0-81" id="h18-0-81" class="d">-T5: scan (&quot;ba&quot;..
</a><a href="#h18-0-82" id="h18-0-82" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-83" id="h18-0-83" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-84" id="h18-0-84" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h18-0-85" id="h18-0-85" class="d">-
</a><a href="#h18-0-86" id="h18-0-86" class="d">-T5: scan (&quot;ba&quot;..&quot;bc&quot;]
</a><a href="#h18-0-87" id="h18-0-87" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-88" id="h18-0-88" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h18-0-89" id="h18-0-89" class="d">-
</a><a href="#h18-0-90" id="h18-0-90" class="d">-T5: scan (&quot;ba&quot;..&quot;bc&quot;)
</a><a href="#h18-0-91" id="h18-0-91" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h18-0-92" id="h18-0-92" class="d">-
</a><a href="#h18-0-93" id="h18-0-93" class="d">-Engine state:
</a><a href="#h18-0-94" id="h18-0-94" class="d">-NextVersion = 5
</a><a href="#h18-0-95" id="h18-0-95" class="d">-Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h18-0-96" id="h18-0-96" class="d">-Version(&quot;B&quot;, 3) = None
</a><a href="#h18-0-97" id="h18-0-97" class="d">-Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h18-0-98" id="h18-0-98" class="d">-Version(&quot;a&quot;, 2) = None
</a><a href="#h18-0-99" id="h18-0-99" class="d">-Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h18-0-100" id="h18-0-100" class="d">-Version(&quot;b&quot;, 1) = None
</a><a href="#h18-0-101" id="h18-0-101" class="d">-Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h18-0-102" id="h18-0-102" class="d">-Version(&quot;b&quot;, 4) = None
</a><a href="#h18-0-103" id="h18-0-103" class="d">-Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h18-0-104" id="h18-0-104" class="d">-Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h18-0-105" id="h18-0-105" class="d">-Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h18-0-106" id="h18-0-106" class="d">-Version(&quot;bb&quot;, 3) = None
</a><a href="#h18-0-107" id="h18-0-107" class="d">-Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h18-0-108" id="h18-0-108" class="d">-Version(&quot;c&quot;, 1) = 0x0c01
</a><b>diff --git a/<a id="h19" href="../file/src/storage/golden/mvcc/scan_isolation.html">src/storage/golden/mvcc/scan_isolation</a> b/<a href="../file/src/storage/golden/mvcc/scan_isolation.html">src/storage/golden/mvcc/scan_isolation</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,91 +0,0 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h19-0-1" id="h19-0-1" class="d">-    set NextVersion = 2
</a><a href="#h19-0-2" id="h19-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h19-0-3" id="h19-0-3" class="d">-
</a><a href="#h19-0-4" id="h19-0-4" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h19-0-5" id="h19-0-5" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h19-0-6" id="h19-0-6" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h19-0-7" id="h19-0-7" class="d">-
</a><a href="#h19-0-8" id="h19-0-8" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h19-0-9" id="h19-0-9" class="d">-    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h19-0-10" id="h19-0-10" class="d">-    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h19-0-11" id="h19-0-11" class="d">-
</a><a href="#h19-0-12" id="h19-0-12" class="d">-T1: set &quot;d&quot; = 0x01
</a><a href="#h19-0-13" id="h19-0-13" class="d">-    set TxnWrite(1, &quot;d&quot;) = []
</a><a href="#h19-0-14" id="h19-0-14" class="d">-    set Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h19-0-15" id="h19-0-15" class="d">-
</a><a href="#h19-0-16" id="h19-0-16" class="d">-T1: set &quot;e&quot; = 0x01
</a><a href="#h19-0-17" id="h19-0-17" class="d">-    set TxnWrite(1, &quot;e&quot;) = []
</a><a href="#h19-0-18" id="h19-0-18" class="d">-    set Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h19-0-19" id="h19-0-19" class="d">-
</a><a href="#h19-0-20" id="h19-0-20" class="d">-T1: commit
</a><a href="#h19-0-21" id="h19-0-21" class="d">-    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h19-0-22" id="h19-0-22" class="d">-    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h19-0-23" id="h19-0-23" class="d">-    del TxnWrite(1, &quot;d&quot;)
</a><a href="#h19-0-24" id="h19-0-24" class="d">-    del TxnWrite(1, &quot;e&quot;)
</a><a href="#h19-0-25" id="h19-0-25" class="d">-    del TxnActive(1)
</a><a href="#h19-0-26" id="h19-0-26" class="d">-
</a><a href="#h19-0-27" id="h19-0-27" class="d">-T2: begin → v2 read-write active={}
</a><a href="#h19-0-28" id="h19-0-28" class="d">-    set NextVersion = 3
</a><a href="#h19-0-29" id="h19-0-29" class="d">-    set TxnActive(2) = []
</a><a href="#h19-0-30" id="h19-0-30" class="d">-
</a><a href="#h19-0-31" id="h19-0-31" class="d">-T2: set &quot;a&quot; = 0x02
</a><a href="#h19-0-32" id="h19-0-32" class="d">-    set TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h19-0-33" id="h19-0-33" class="d">-    set Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h19-0-34" id="h19-0-34" class="d">-
</a><a href="#h19-0-35" id="h19-0-35" class="d">-T2: del &quot;b&quot;
</a><a href="#h19-0-36" id="h19-0-36" class="d">-    set TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h19-0-37" id="h19-0-37" class="d">-    set Version(&quot;b&quot;, 2) = None
</a><a href="#h19-0-38" id="h19-0-38" class="d">-
</a><a href="#h19-0-39" id="h19-0-39" class="d">-T2: set &quot;c&quot; = 0x02
</a><a href="#h19-0-40" id="h19-0-40" class="d">-    set TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h19-0-41" id="h19-0-41" class="d">-    set Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h19-0-42" id="h19-0-42" class="d">-
</a><a href="#h19-0-43" id="h19-0-43" class="d">-T3: begin read-only → v3 read-only active={2}
</a><a href="#h19-0-44" id="h19-0-44" class="d">-
</a><a href="#h19-0-45" id="h19-0-45" class="d">-T4: begin → v3 read-write active={2}
</a><a href="#h19-0-46" id="h19-0-46" class="d">-    set NextVersion = 4
</a><a href="#h19-0-47" id="h19-0-47" class="d">-    set TxnActiveSnapshot(3) = {2}
</a><a href="#h19-0-48" id="h19-0-48" class="d">-    set TxnActive(3) = []
</a><a href="#h19-0-49" id="h19-0-49" class="d">-
</a><a href="#h19-0-50" id="h19-0-50" class="d">-T4: set &quot;d&quot; = 0x03
</a><a href="#h19-0-51" id="h19-0-51" class="d">-    set TxnWrite(3, &quot;d&quot;) = []
</a><a href="#h19-0-52" id="h19-0-52" class="d">-    set Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h19-0-53" id="h19-0-53" class="d">-
</a><a href="#h19-0-54" id="h19-0-54" class="d">-T4: del &quot;e&quot;
</a><a href="#h19-0-55" id="h19-0-55" class="d">-    set TxnWrite(3, &quot;e&quot;) = []
</a><a href="#h19-0-56" id="h19-0-56" class="d">-    set Version(&quot;e&quot;, 3) = None
</a><a href="#h19-0-57" id="h19-0-57" class="d">-
</a><a href="#h19-0-58" id="h19-0-58" class="d">-T4: set &quot;f&quot; = 0x03
</a><a href="#h19-0-59" id="h19-0-59" class="d">-    set TxnWrite(3, &quot;f&quot;) = []
</a><a href="#h19-0-60" id="h19-0-60" class="d">-    set Version(&quot;f&quot;, 3) = 0x03
</a><a href="#h19-0-61" id="h19-0-61" class="d">-
</a><a href="#h19-0-62" id="h19-0-62" class="d">-T4: commit
</a><a href="#h19-0-63" id="h19-0-63" class="d">-    del TxnWrite(3, &quot;d&quot;)
</a><a href="#h19-0-64" id="h19-0-64" class="d">-    del TxnWrite(3, &quot;e&quot;)
</a><a href="#h19-0-65" id="h19-0-65" class="d">-    del TxnWrite(3, &quot;f&quot;)
</a><a href="#h19-0-66" id="h19-0-66" class="d">-    del TxnActive(3)
</a><a href="#h19-0-67" id="h19-0-67" class="d">-
</a><a href="#h19-0-68" id="h19-0-68" class="d">-T3: scan ..
</a><a href="#h19-0-69" id="h19-0-69" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h19-0-70" id="h19-0-70" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h19-0-71" id="h19-0-71" class="d">-    &quot;d&quot; = 0x01
</a><a href="#h19-0-72" id="h19-0-72" class="d">-    &quot;e&quot; = 0x01
</a><a href="#h19-0-73" id="h19-0-73" class="d">-
</a><a href="#h19-0-74" id="h19-0-74" class="d">-Engine state:
</a><a href="#h19-0-75" id="h19-0-75" class="d">-NextVersion = 4
</a><a href="#h19-0-76" id="h19-0-76" class="d">-TxnActive(2) = []
</a><a href="#h19-0-77" id="h19-0-77" class="d">-TxnActiveSnapshot(3) = {2}
</a><a href="#h19-0-78" id="h19-0-78" class="d">-TxnWrite(2, &quot;a&quot;) = []
</a><a href="#h19-0-79" id="h19-0-79" class="d">-TxnWrite(2, &quot;b&quot;) = []
</a><a href="#h19-0-80" id="h19-0-80" class="d">-TxnWrite(2, &quot;c&quot;) = []
</a><a href="#h19-0-81" id="h19-0-81" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h19-0-82" id="h19-0-82" class="d">-Version(&quot;a&quot;, 2) = 0x02
</a><a href="#h19-0-83" id="h19-0-83" class="d">-Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h19-0-84" id="h19-0-84" class="d">-Version(&quot;b&quot;, 2) = None
</a><a href="#h19-0-85" id="h19-0-85" class="d">-Version(&quot;c&quot;, 2) = 0x02
</a><a href="#h19-0-86" id="h19-0-86" class="d">-Version(&quot;d&quot;, 1) = 0x01
</a><a href="#h19-0-87" id="h19-0-87" class="d">-Version(&quot;d&quot;, 3) = 0x03
</a><a href="#h19-0-88" id="h19-0-88" class="d">-Version(&quot;e&quot;, 1) = 0x01
</a><a href="#h19-0-89" id="h19-0-89" class="d">-Version(&quot;e&quot;, 3) = None
</a><a href="#h19-0-90" id="h19-0-90" class="d">-Version(&quot;f&quot;, 3) = 0x03
</a><b>diff --git a/<a id="h20" href="../file/src/storage/golden/mvcc/scan_key_version_encoding.html">src/storage/golden/mvcc/scan_key_version_encoding</a> b/<a href="../file/src/storage/golden/mvcc/scan_key_version_encoding.html">src/storage/golden/mvcc/scan_key_version_encoding</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,53 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h20-0-1" id="h20-0-1" class="d">-    set NextVersion = 2
</a><a href="#h20-0-2" id="h20-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h20-0-3" id="h20-0-3" class="d">-
</a><a href="#h20-0-4" id="h20-0-4" class="d">-T1: set 0x00 = 0x01
</a><a href="#h20-0-5" id="h20-0-5" class="d">-    set TxnWrite(1, 0x00) = []
</a><a href="#h20-0-6" id="h20-0-6" class="d">-    set Version(0x00, 1) = 0x01
</a><a href="#h20-0-7" id="h20-0-7" class="d">-
</a><a href="#h20-0-8" id="h20-0-8" class="d">-T1: commit
</a><a href="#h20-0-9" id="h20-0-9" class="d">-    del TxnWrite(1, 0x00)
</a><a href="#h20-0-10" id="h20-0-10" class="d">-    del TxnActive(1)
</a><a href="#h20-0-11" id="h20-0-11" class="d">-
</a><a href="#h20-0-12" id="h20-0-12" class="d">-T2: begin → v2 read-write active={}
</a><a href="#h20-0-13" id="h20-0-13" class="d">-    set NextVersion = 3
</a><a href="#h20-0-14" id="h20-0-14" class="d">-    set TxnActive(2) = []
</a><a href="#h20-0-15" id="h20-0-15" class="d">-
</a><a href="#h20-0-16" id="h20-0-16" class="d">-T2: set 0x00 = 0x02
</a><a href="#h20-0-17" id="h20-0-17" class="d">-    set TxnWrite(2, 0x00) = []
</a><a href="#h20-0-18" id="h20-0-18" class="d">-    set Version(0x00, 2) = 0x02
</a><a href="#h20-0-19" id="h20-0-19" class="d">-
</a><a href="#h20-0-20" id="h20-0-20" class="d">-T2: set 0x000000000000000002 = 0x02
</a><a href="#h20-0-21" id="h20-0-21" class="d">-    set TxnWrite(2, 0x000000000000000002) = []
</a><a href="#h20-0-22" id="h20-0-22" class="d">-    set Version(0x000000000000000002, 2) = 0x02
</a><a href="#h20-0-23" id="h20-0-23" class="d">-
</a><a href="#h20-0-24" id="h20-0-24" class="d">-T2: commit
</a><a href="#h20-0-25" id="h20-0-25" class="d">-    del TxnWrite(2, 0x00)
</a><a href="#h20-0-26" id="h20-0-26" class="d">-    del TxnWrite(2, 0x000000000000000002)
</a><a href="#h20-0-27" id="h20-0-27" class="d">-    del TxnActive(2)
</a><a href="#h20-0-28" id="h20-0-28" class="d">-
</a><a href="#h20-0-29" id="h20-0-29" class="d">-T3: begin → v3 read-write active={}
</a><a href="#h20-0-30" id="h20-0-30" class="d">-    set NextVersion = 4
</a><a href="#h20-0-31" id="h20-0-31" class="d">-    set TxnActive(3) = []
</a><a href="#h20-0-32" id="h20-0-32" class="d">-
</a><a href="#h20-0-33" id="h20-0-33" class="d">-T3: set 0x00 = 0x03
</a><a href="#h20-0-34" id="h20-0-34" class="d">-    set TxnWrite(3, 0x00) = []
</a><a href="#h20-0-35" id="h20-0-35" class="d">-    set Version(0x00, 3) = 0x03
</a><a href="#h20-0-36" id="h20-0-36" class="d">-
</a><a href="#h20-0-37" id="h20-0-37" class="d">-T3: commit
</a><a href="#h20-0-38" id="h20-0-38" class="d">-    del TxnWrite(3, 0x00)
</a><a href="#h20-0-39" id="h20-0-39" class="d">-    del TxnActive(3)
</a><a href="#h20-0-40" id="h20-0-40" class="d">-
</a><a href="#h20-0-41" id="h20-0-41" class="d">-T4: begin read-only → v4 read-only active={}
</a><a href="#h20-0-42" id="h20-0-42" class="d">-
</a><a href="#h20-0-43" id="h20-0-43" class="d">-T4: scan ..
</a><a href="#h20-0-44" id="h20-0-44" class="d">-    0x00 = 0x03
</a><a href="#h20-0-45" id="h20-0-45" class="d">-    0x000000000000000002 = 0x02
</a><a href="#h20-0-46" id="h20-0-46" class="d">-
</a><a href="#h20-0-47" id="h20-0-47" class="d">-Engine state:
</a><a href="#h20-0-48" id="h20-0-48" class="d">-NextVersion = 4
</a><a href="#h20-0-49" id="h20-0-49" class="d">-Version(0x00, 1) = 0x01
</a><a href="#h20-0-50" id="h20-0-50" class="d">-Version(0x00, 2) = 0x02
</a><a href="#h20-0-51" id="h20-0-51" class="d">-Version(0x00, 3) = 0x03
</a><a href="#h20-0-52" id="h20-0-52" class="d">-Version(0x000000000000000002, 2) = 0x02
</a><b>diff --git a/<a id="h21" href="../file/src/storage/golden/mvcc/scan_prefix.html">src/storage/golden/mvcc/scan_prefix</a> b/<a href="../file/src/storage/golden/mvcc/scan_prefix.html">src/storage/golden/mvcc/scan_prefix</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -1,117 +0,0 @@
</a><a href="#h21-0-0" id="h21-0-0" class="d">-Engine state:
</a><a href="#h21-0-1" id="h21-0-1" class="d">-NextVersion = 5
</a><a href="#h21-0-2" id="h21-0-2" class="d">-Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h21-0-3" id="h21-0-3" class="d">-Version(&quot;B&quot;, 3) = None
</a><a href="#h21-0-4" id="h21-0-4" class="d">-Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h21-0-5" id="h21-0-5" class="d">-Version(&quot;a&quot;, 2) = None
</a><a href="#h21-0-6" id="h21-0-6" class="d">-Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h21-0-7" id="h21-0-7" class="d">-Version(&quot;b&quot;, 1) = None
</a><a href="#h21-0-8" id="h21-0-8" class="d">-Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h21-0-9" id="h21-0-9" class="d">-Version(&quot;b&quot;, 4) = None
</a><a href="#h21-0-10" id="h21-0-10" class="d">-Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h21-0-11" id="h21-0-11" class="d">-Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h21-0-12" id="h21-0-12" class="d">-Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h21-0-13" id="h21-0-13" class="d">-Version(&quot;bb&quot;, 3) = None
</a><a href="#h21-0-14" id="h21-0-14" class="d">-Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h21-0-15" id="h21-0-15" class="d">-Version(&quot;c&quot;, 1) = 0x0c01
</a><a href="#h21-0-16" id="h21-0-16" class="d">-
</a><a href="#h21-0-17" id="h21-0-17" class="d">-T1: begin as of 1 → v1 read-only active={}
</a><a href="#h21-0-18" id="h21-0-18" class="d">-
</a><a href="#h21-0-19" id="h21-0-19" class="d">-T1: scan prefix []
</a><a href="#h21-0-20" id="h21-0-20" class="d">-
</a><a href="#h21-0-21" id="h21-0-21" class="d">-T2: begin as of 2 → v2 read-only active={}
</a><a href="#h21-0-22" id="h21-0-22" class="d">-
</a><a href="#h21-0-23" id="h21-0-23" class="d">-T2: scan prefix []
</a><a href="#h21-0-24" id="h21-0-24" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h21-0-25" id="h21-0-25" class="d">-    &quot;a&quot; = 0x0a01
</a><a href="#h21-0-26" id="h21-0-26" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h21-0-27" id="h21-0-27" class="d">-
</a><a href="#h21-0-28" id="h21-0-28" class="d">-T3: begin as of 3 → v3 read-only active={}
</a><a href="#h21-0-29" id="h21-0-29" class="d">-
</a><a href="#h21-0-30" id="h21-0-30" class="d">-T3: scan prefix []
</a><a href="#h21-0-31" id="h21-0-31" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h21-0-32" id="h21-0-32" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-33" id="h21-0-33" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h21-0-34" id="h21-0-34" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-35" id="h21-0-35" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h21-0-36" id="h21-0-36" class="d">-
</a><a href="#h21-0-37" id="h21-0-37" class="d">-T4: begin as of 4 → v4 read-only active={}
</a><a href="#h21-0-38" id="h21-0-38" class="d">-
</a><a href="#h21-0-39" id="h21-0-39" class="d">-T4: scan prefix []
</a><a href="#h21-0-40" id="h21-0-40" class="d">-    &quot;a&quot; = 0x0a03
</a><a href="#h21-0-41" id="h21-0-41" class="d">-    &quot;b&quot; = 0x0b03
</a><a href="#h21-0-42" id="h21-0-42" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-43" id="h21-0-43" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-44" id="h21-0-44" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h21-0-45" id="h21-0-45" class="d">-
</a><a href="#h21-0-46" id="h21-0-46" class="d">-T5: begin as of 3 → v3 read-only active={}
</a><a href="#h21-0-47" id="h21-0-47" class="d">-
</a><a href="#h21-0-48" id="h21-0-48" class="d">-T5: scan prefix &quot;B&quot;
</a><a href="#h21-0-49" id="h21-0-49" class="d">-    &quot;B&quot; = 0x0001
</a><a href="#h21-0-50" id="h21-0-50" class="d">-
</a><a href="#h21-0-51" id="h21-0-51" class="d">-T5: scan prefix &quot;a&quot;
</a><a href="#h21-0-52" id="h21-0-52" class="d">-
</a><a href="#h21-0-53" id="h21-0-53" class="d">-T5: scan prefix &quot;b&quot;
</a><a href="#h21-0-54" id="h21-0-54" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-55" id="h21-0-55" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h21-0-56" id="h21-0-56" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-57" id="h21-0-57" class="d">-
</a><a href="#h21-0-58" id="h21-0-58" class="d">-T5: scan prefix &quot;ba&quot;
</a><a href="#h21-0-59" id="h21-0-59" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-60" id="h21-0-60" class="d">-
</a><a href="#h21-0-61" id="h21-0-61" class="d">-T5: scan prefix &quot;bb&quot;
</a><a href="#h21-0-62" id="h21-0-62" class="d">-    &quot;bb&quot; = 0xbb02
</a><a href="#h21-0-63" id="h21-0-63" class="d">-
</a><a href="#h21-0-64" id="h21-0-64" class="d">-T5: scan prefix &quot;bbb&quot;
</a><a href="#h21-0-65" id="h21-0-65" class="d">-
</a><a href="#h21-0-66" id="h21-0-66" class="d">-T5: scan prefix &quot;bc&quot;
</a><a href="#h21-0-67" id="h21-0-67" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-68" id="h21-0-68" class="d">-
</a><a href="#h21-0-69" id="h21-0-69" class="d">-T5: scan prefix &quot;c&quot;
</a><a href="#h21-0-70" id="h21-0-70" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h21-0-71" id="h21-0-71" class="d">-
</a><a href="#h21-0-72" id="h21-0-72" class="d">-T5: scan prefix &quot;d&quot;
</a><a href="#h21-0-73" id="h21-0-73" class="d">-
</a><a href="#h21-0-74" id="h21-0-74" class="d">-T6: begin as of 4 → v4 read-only active={}
</a><a href="#h21-0-75" id="h21-0-75" class="d">-
</a><a href="#h21-0-76" id="h21-0-76" class="d">-T6: scan prefix &quot;B&quot;
</a><a href="#h21-0-77" id="h21-0-77" class="d">-
</a><a href="#h21-0-78" id="h21-0-78" class="d">-T6: scan prefix &quot;a&quot;
</a><a href="#h21-0-79" id="h21-0-79" class="d">-    &quot;a&quot; = 0x0a03
</a><a href="#h21-0-80" id="h21-0-80" class="d">-
</a><a href="#h21-0-81" id="h21-0-81" class="d">-T6: scan prefix &quot;b&quot;
</a><a href="#h21-0-82" id="h21-0-82" class="d">-    &quot;b&quot; = 0x0b03
</a><a href="#h21-0-83" id="h21-0-83" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-84" id="h21-0-84" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-85" id="h21-0-85" class="d">-
</a><a href="#h21-0-86" id="h21-0-86" class="d">-T6: scan prefix &quot;ba&quot;
</a><a href="#h21-0-87" id="h21-0-87" class="d">-    &quot;ba&quot; = 0xba02
</a><a href="#h21-0-88" id="h21-0-88" class="d">-
</a><a href="#h21-0-89" id="h21-0-89" class="d">-T6: scan prefix &quot;bb&quot;
</a><a href="#h21-0-90" id="h21-0-90" class="d">-
</a><a href="#h21-0-91" id="h21-0-91" class="d">-T6: scan prefix &quot;bbb&quot;
</a><a href="#h21-0-92" id="h21-0-92" class="d">-
</a><a href="#h21-0-93" id="h21-0-93" class="d">-T6: scan prefix &quot;bc&quot;
</a><a href="#h21-0-94" id="h21-0-94" class="d">-    &quot;bc&quot; = 0xbc02
</a><a href="#h21-0-95" id="h21-0-95" class="d">-
</a><a href="#h21-0-96" id="h21-0-96" class="d">-T6: scan prefix &quot;c&quot;
</a><a href="#h21-0-97" id="h21-0-97" class="d">-    &quot;c&quot; = 0x0c01
</a><a href="#h21-0-98" id="h21-0-98" class="d">-
</a><a href="#h21-0-99" id="h21-0-99" class="d">-T6: scan prefix &quot;d&quot;
</a><a href="#h21-0-100" id="h21-0-100" class="d">-
</a><a href="#h21-0-101" id="h21-0-101" class="d">-Engine state:
</a><a href="#h21-0-102" id="h21-0-102" class="d">-NextVersion = 5
</a><a href="#h21-0-103" id="h21-0-103" class="d">-Version(&quot;B&quot;, 1) = 0x0001
</a><a href="#h21-0-104" id="h21-0-104" class="d">-Version(&quot;B&quot;, 3) = None
</a><a href="#h21-0-105" id="h21-0-105" class="d">-Version(&quot;a&quot;, 1) = 0x0a01
</a><a href="#h21-0-106" id="h21-0-106" class="d">-Version(&quot;a&quot;, 2) = None
</a><a href="#h21-0-107" id="h21-0-107" class="d">-Version(&quot;a&quot;, 3) = 0x0a03
</a><a href="#h21-0-108" id="h21-0-108" class="d">-Version(&quot;b&quot;, 1) = None
</a><a href="#h21-0-109" id="h21-0-109" class="d">-Version(&quot;b&quot;, 3) = 0x0b03
</a><a href="#h21-0-110" id="h21-0-110" class="d">-Version(&quot;b&quot;, 4) = None
</a><a href="#h21-0-111" id="h21-0-111" class="d">-Version(&quot;ba&quot;, 2) = 0xba02
</a><a href="#h21-0-112" id="h21-0-112" class="d">-Version(&quot;ba&quot;, 4) = 0xba04
</a><a href="#h21-0-113" id="h21-0-113" class="d">-Version(&quot;bb&quot;, 2) = 0xbb02
</a><a href="#h21-0-114" id="h21-0-114" class="d">-Version(&quot;bb&quot;, 3) = None
</a><a href="#h21-0-115" id="h21-0-115" class="d">-Version(&quot;bc&quot;, 2) = 0xbc02
</a><a href="#h21-0-116" id="h21-0-116" class="d">-Version(&quot;c&quot;, 1) = 0x0c01
</a><b>diff --git a/<a id="h22" href="../file/src/storage/golden/mvcc/set.html">src/storage/golden/mvcc/set</a> b/<a href="../file/src/storage/golden/mvcc/set.html">src/storage/golden/mvcc/set</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,42 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-Engine state:
</a><a href="#h22-0-1" id="h22-0-1" class="d">-NextVersion = 2
</a><a href="#h22-0-2" id="h22-0-2" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h22-0-3" id="h22-0-3" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h22-0-4" id="h22-0-4" class="d">-
</a><a href="#h22-0-5" id="h22-0-5" class="d">-T1: begin → v2 read-write active={}
</a><a href="#h22-0-6" id="h22-0-6" class="d">-    set NextVersion = 3
</a><a href="#h22-0-7" id="h22-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h22-0-8" id="h22-0-8" class="d">-
</a><a href="#h22-0-9" id="h22-0-9" class="d">-T1: set &quot;key&quot; = 0x02
</a><a href="#h22-0-10" id="h22-0-10" class="d">-    set TxnWrite(2, &quot;key&quot;) = []
</a><a href="#h22-0-11" id="h22-0-11" class="d">-    set Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h22-0-12" id="h22-0-12" class="d">-
</a><a href="#h22-0-13" id="h22-0-13" class="d">-T1: set &quot;tombstone&quot; = 0x02
</a><a href="#h22-0-14" id="h22-0-14" class="d">-    set TxnWrite(2, &quot;tombstone&quot;) = []
</a><a href="#h22-0-15" id="h22-0-15" class="d">-    set Version(&quot;tombstone&quot;, 2) = 0x02
</a><a href="#h22-0-16" id="h22-0-16" class="d">-
</a><a href="#h22-0-17" id="h22-0-17" class="d">-T1: set &quot;new&quot; = 0x01
</a><a href="#h22-0-18" id="h22-0-18" class="d">-    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h22-0-19" id="h22-0-19" class="d">-    set Version(&quot;new&quot;, 2) = 0x01
</a><a href="#h22-0-20" id="h22-0-20" class="d">-
</a><a href="#h22-0-21" id="h22-0-21" class="d">-T1: set &quot;new&quot; = 0x01
</a><a href="#h22-0-22" id="h22-0-22" class="d">-    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h22-0-23" id="h22-0-23" class="d">-    set Version(&quot;new&quot;, 2) = 0x01
</a><a href="#h22-0-24" id="h22-0-24" class="d">-
</a><a href="#h22-0-25" id="h22-0-25" class="d">-T1: set &quot;new&quot; = 0x02
</a><a href="#h22-0-26" id="h22-0-26" class="d">-    set TxnWrite(2, &quot;new&quot;) = []
</a><a href="#h22-0-27" id="h22-0-27" class="d">-    set Version(&quot;new&quot;, 2) = 0x02
</a><a href="#h22-0-28" id="h22-0-28" class="d">-
</a><a href="#h22-0-29" id="h22-0-29" class="d">-T1: commit
</a><a href="#h22-0-30" id="h22-0-30" class="d">-    del TxnWrite(2, &quot;key&quot;)
</a><a href="#h22-0-31" id="h22-0-31" class="d">-    del TxnWrite(2, &quot;new&quot;)
</a><a href="#h22-0-32" id="h22-0-32" class="d">-    del TxnWrite(2, &quot;tombstone&quot;)
</a><a href="#h22-0-33" id="h22-0-33" class="d">-    del TxnActive(2)
</a><a href="#h22-0-34" id="h22-0-34" class="d">-
</a><a href="#h22-0-35" id="h22-0-35" class="d">-Engine state:
</a><a href="#h22-0-36" id="h22-0-36" class="d">-NextVersion = 3
</a><a href="#h22-0-37" id="h22-0-37" class="d">-Version(&quot;key&quot;, 1) = 0x01
</a><a href="#h22-0-38" id="h22-0-38" class="d">-Version(&quot;key&quot;, 2) = 0x02
</a><a href="#h22-0-39" id="h22-0-39" class="d">-Version(&quot;new&quot;, 2) = 0x02
</a><a href="#h22-0-40" id="h22-0-40" class="d">-Version(&quot;tombstone&quot;, 1) = None
</a><a href="#h22-0-41" id="h22-0-41" class="d">-Version(&quot;tombstone&quot;, 2) = 0x02
</a><b>diff --git a/<a id="h23" href="../file/src/storage/golden/mvcc/set_conflict.html">src/storage/golden/mvcc/set_conflict</a> b/<a href="../file/src/storage/golden/mvcc/set_conflict.html">src/storage/golden/mvcc/set_conflict</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,54 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h23-0-1" id="h23-0-1" class="d">-    set NextVersion = 2
</a><a href="#h23-0-2" id="h23-0-2" class="d">-    set TxnActive(1) = []
</a><a href="#h23-0-3" id="h23-0-3" class="d">-
</a><a href="#h23-0-4" id="h23-0-4" class="d">-T2: begin → v2 read-write active={1}
</a><a href="#h23-0-5" id="h23-0-5" class="d">-    set NextVersion = 3
</a><a href="#h23-0-6" id="h23-0-6" class="d">-    set TxnActiveSnapshot(2) = {1}
</a><a href="#h23-0-7" id="h23-0-7" class="d">-    set TxnActive(2) = []
</a><a href="#h23-0-8" id="h23-0-8" class="d">-
</a><a href="#h23-0-9" id="h23-0-9" class="d">-T3: begin → v3 read-write active={1,2}
</a><a href="#h23-0-10" id="h23-0-10" class="d">-    set NextVersion = 4
</a><a href="#h23-0-11" id="h23-0-11" class="d">-    set TxnActiveSnapshot(3) = {1,2}
</a><a href="#h23-0-12" id="h23-0-12" class="d">-    set TxnActive(3) = []
</a><a href="#h23-0-13" id="h23-0-13" class="d">-
</a><a href="#h23-0-14" id="h23-0-14" class="d">-T4: begin → v4 read-write active={1,2,3}
</a><a href="#h23-0-15" id="h23-0-15" class="d">-    set NextVersion = 5
</a><a href="#h23-0-16" id="h23-0-16" class="d">-    set TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h23-0-17" id="h23-0-17" class="d">-    set TxnActive(4) = []
</a><a href="#h23-0-18" id="h23-0-18" class="d">-
</a><a href="#h23-0-19" id="h23-0-19" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h23-0-20" id="h23-0-20" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h23-0-21" id="h23-0-21" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h23-0-22" id="h23-0-22" class="d">-
</a><a href="#h23-0-23" id="h23-0-23" class="d">-T3: set &quot;c&quot; = 0x03
</a><a href="#h23-0-24" id="h23-0-24" class="d">-    set TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h23-0-25" id="h23-0-25" class="d">-    set Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h23-0-26" id="h23-0-26" class="d">-
</a><a href="#h23-0-27" id="h23-0-27" class="d">-T4: set &quot;d&quot; = 0x04
</a><a href="#h23-0-28" id="h23-0-28" class="d">-    set TxnWrite(4, &quot;d&quot;) = []
</a><a href="#h23-0-29" id="h23-0-29" class="d">-    set Version(&quot;d&quot;, 4) = 0x04
</a><a href="#h23-0-30" id="h23-0-30" class="d">-
</a><a href="#h23-0-31" id="h23-0-31" class="d">-T4: commit
</a><a href="#h23-0-32" id="h23-0-32" class="d">-    del TxnWrite(4, &quot;d&quot;)
</a><a href="#h23-0-33" id="h23-0-33" class="d">-    del TxnActive(4)
</a><a href="#h23-0-34" id="h23-0-34" class="d">-
</a><a href="#h23-0-35" id="h23-0-35" class="d">-T2: set &quot;a&quot; = 0x02 → Error::Serialization
</a><a href="#h23-0-36" id="h23-0-36" class="d">-
</a><a href="#h23-0-37" id="h23-0-37" class="d">-T2: set &quot;c&quot; = 0x02 → Error::Serialization
</a><a href="#h23-0-38" id="h23-0-38" class="d">-
</a><a href="#h23-0-39" id="h23-0-39" class="d">-T2: set &quot;d&quot; = 0x02 → Error::Serialization
</a><a href="#h23-0-40" id="h23-0-40" class="d">-
</a><a href="#h23-0-41" id="h23-0-41" class="d">-Engine state:
</a><a href="#h23-0-42" id="h23-0-42" class="d">-NextVersion = 5
</a><a href="#h23-0-43" id="h23-0-43" class="d">-TxnActive(1) = []
</a><a href="#h23-0-44" id="h23-0-44" class="d">-TxnActive(2) = []
</a><a href="#h23-0-45" id="h23-0-45" class="d">-TxnActive(3) = []
</a><a href="#h23-0-46" id="h23-0-46" class="d">-TxnActiveSnapshot(2) = {1}
</a><a href="#h23-0-47" id="h23-0-47" class="d">-TxnActiveSnapshot(3) = {1,2}
</a><a href="#h23-0-48" id="h23-0-48" class="d">-TxnActiveSnapshot(4) = {1,2,3}
</a><a href="#h23-0-49" id="h23-0-49" class="d">-TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h23-0-50" id="h23-0-50" class="d">-TxnWrite(3, &quot;c&quot;) = []
</a><a href="#h23-0-51" id="h23-0-51" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h23-0-52" id="h23-0-52" class="d">-Version(&quot;c&quot;, 3) = 0x03
</a><a href="#h23-0-53" id="h23-0-53" class="d">-Version(&quot;d&quot;, 4) = 0x04
</a><b>diff --git a/<a id="h24" href="../file/src/storage/golden/mvcc/unversioned.html">src/storage/golden/mvcc/unversioned</a> b/<a href="../file/src/storage/golden/mvcc/unversioned.html">src/storage/golden/mvcc/unversioned</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,59 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-T_: set unversioned &quot;a&quot; = 0x00
</a><a href="#h24-0-1" id="h24-0-1" class="d">-    set Unversioned(&quot;a&quot;) = 0x00
</a><a href="#h24-0-2" id="h24-0-2" class="d">-
</a><a href="#h24-0-3" id="h24-0-3" class="d">-T1: begin → v1 read-write active={}
</a><a href="#h24-0-4" id="h24-0-4" class="d">-    set NextVersion = 2
</a><a href="#h24-0-5" id="h24-0-5" class="d">-    set TxnActive(1) = []
</a><a href="#h24-0-6" id="h24-0-6" class="d">-
</a><a href="#h24-0-7" id="h24-0-7" class="d">-T1: set &quot;a&quot; = 0x01
</a><a href="#h24-0-8" id="h24-0-8" class="d">-    set TxnWrite(1, &quot;a&quot;) = []
</a><a href="#h24-0-9" id="h24-0-9" class="d">-    set Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h24-0-10" id="h24-0-10" class="d">-
</a><a href="#h24-0-11" id="h24-0-11" class="d">-T1: set &quot;b&quot; = 0x01
</a><a href="#h24-0-12" id="h24-0-12" class="d">-    set TxnWrite(1, &quot;b&quot;) = []
</a><a href="#h24-0-13" id="h24-0-13" class="d">-    set Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h24-0-14" id="h24-0-14" class="d">-
</a><a href="#h24-0-15" id="h24-0-15" class="d">-T1: set &quot;c&quot; = 0x01
</a><a href="#h24-0-16" id="h24-0-16" class="d">-    set TxnWrite(1, &quot;c&quot;) = []
</a><a href="#h24-0-17" id="h24-0-17" class="d">-    set Version(&quot;c&quot;, 1) = 0x01
</a><a href="#h24-0-18" id="h24-0-18" class="d">-
</a><a href="#h24-0-19" id="h24-0-19" class="d">-T1: commit
</a><a href="#h24-0-20" id="h24-0-20" class="d">-    del TxnWrite(1, &quot;a&quot;)
</a><a href="#h24-0-21" id="h24-0-21" class="d">-    del TxnWrite(1, &quot;b&quot;)
</a><a href="#h24-0-22" id="h24-0-22" class="d">-    del TxnWrite(1, &quot;c&quot;)
</a><a href="#h24-0-23" id="h24-0-23" class="d">-    del TxnActive(1)
</a><a href="#h24-0-24" id="h24-0-24" class="d">-
</a><a href="#h24-0-25" id="h24-0-25" class="d">-T_: set unversioned &quot;b&quot; = 0x00
</a><a href="#h24-0-26" id="h24-0-26" class="d">-    set Unversioned(&quot;b&quot;) = 0x00
</a><a href="#h24-0-27" id="h24-0-27" class="d">-
</a><a href="#h24-0-28" id="h24-0-28" class="d">-T_: set unversioned &quot;d&quot; = 0x00
</a><a href="#h24-0-29" id="h24-0-29" class="d">-    set Unversioned(&quot;d&quot;) = 0x00
</a><a href="#h24-0-30" id="h24-0-30" class="d">-
</a><a href="#h24-0-31" id="h24-0-31" class="d">-T2: begin read-only → v2 read-only active={}
</a><a href="#h24-0-32" id="h24-0-32" class="d">-
</a><a href="#h24-0-33" id="h24-0-33" class="d">-T2: scan ..
</a><a href="#h24-0-34" id="h24-0-34" class="d">-    &quot;a&quot; = 0x01
</a><a href="#h24-0-35" id="h24-0-35" class="d">-    &quot;b&quot; = 0x01
</a><a href="#h24-0-36" id="h24-0-36" class="d">-    &quot;c&quot; = 0x01
</a><a href="#h24-0-37" id="h24-0-37" class="d">-
</a><a href="#h24-0-38" id="h24-0-38" class="d">-T_: get unversioned &quot;a&quot; → 0x00
</a><a href="#h24-0-39" id="h24-0-39" class="d">-
</a><a href="#h24-0-40" id="h24-0-40" class="d">-T_: get unversioned &quot;b&quot; → 0x00
</a><a href="#h24-0-41" id="h24-0-41" class="d">-
</a><a href="#h24-0-42" id="h24-0-42" class="d">-T_: get unversioned &quot;c&quot; → None
</a><a href="#h24-0-43" id="h24-0-43" class="d">-
</a><a href="#h24-0-44" id="h24-0-44" class="d">-T_: get unversioned &quot;d&quot; → 0x00
</a><a href="#h24-0-45" id="h24-0-45" class="d">-
</a><a href="#h24-0-46" id="h24-0-46" class="d">-T_: set unversioned &quot;a&quot; = 0x01
</a><a href="#h24-0-47" id="h24-0-47" class="d">-    set Unversioned(&quot;a&quot;) = 0x01
</a><a href="#h24-0-48" id="h24-0-48" class="d">-
</a><a href="#h24-0-49" id="h24-0-49" class="d">-T_: get unversioned &quot;a&quot; → 0x01
</a><a href="#h24-0-50" id="h24-0-50" class="d">-
</a><a href="#h24-0-51" id="h24-0-51" class="d">-Engine state:
</a><a href="#h24-0-52" id="h24-0-52" class="d">-NextVersion = 2
</a><a href="#h24-0-53" id="h24-0-53" class="d">-Version(&quot;a&quot;, 1) = 0x01
</a><a href="#h24-0-54" id="h24-0-54" class="d">-Version(&quot;b&quot;, 1) = 0x01
</a><a href="#h24-0-55" id="h24-0-55" class="d">-Version(&quot;c&quot;, 1) = 0x01
</a><a href="#h24-0-56" id="h24-0-56" class="d">-Unversioned(&quot;a&quot;) = 0x01
</a><a href="#h24-0-57" id="h24-0-57" class="d">-Unversioned(&quot;b&quot;) = 0x00
</a><a href="#h24-0-58" id="h24-0-58" class="d">-Unversioned(&quot;d&quot;) = 0x00
</a><b>diff --git a/<a id="h25" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -783,1150 +783,396 @@ impl&lt;&#39;a, E: Engine&gt; DoubleEndedIterator for VersionIterator&lt;&#39;a, E&gt; {
</a> 
 #[cfg(test)]
 pub mod tests {
<a href="#h25-0-3" id="h25-0-3" class="d">-    use super::super::debug;
</a><a href="#h25-0-4" id="h25-0-4" class="d">-    use super::super::engine::test::{self as testengine, Emit};
</a><a href="#h25-0-5" id="h25-0-5" class="d">-    use super::super::Memory;
</a><a href="#h25-0-6" id="h25-0-6" class="i">+    use super::super::engine::test::{Emit, Mirror, Operation};
</a><a href="#h25-0-7" id="h25-0-7" class="i">+    use super::super::{debug, BitCask, Memory};
</a>     use super::*;
     use crossbeam::channel::Receiver;
<a href="#h25-0-10" id="h25-0-10" class="i">+    use itertools::Itertools as _;
</a><a href="#h25-0-11" id="h25-0-11" class="i">+    use regex::Regex;
</a>     use std::collections::HashMap;
<a href="#h25-0-13" id="h25-0-13" class="d">-    use std::io::Write as _;
</a><a href="#h25-0-14" id="h25-0-14" class="d">-
</a><a href="#h25-0-15" id="h25-0-15" class="d">-    const GOLDEN_DIR: &amp;str = &quot;src/storage/golden/mvcc&quot;;
</a><a href="#h25-0-16" id="h25-0-16" class="d">-
</a><a href="#h25-0-17" id="h25-0-17" class="d">-    /// An MVCC wrapper that records transaction schedules to golden masters.
</a><a href="#h25-0-18" id="h25-0-18" class="d">-    /// TODO: migrate this to goldenscript.
</a><a href="#h25-0-19" id="h25-0-19" class="d">-    struct Schedule {
</a><a href="#h25-0-20" id="h25-0-20" class="d">-        mvcc: MVCC&lt;Emit&lt;Memory&gt;&gt;,
</a><a href="#h25-0-21" id="h25-0-21" class="d">-        op_rx: Receiver&lt;testengine::Operation&gt;,
</a><a href="#h25-0-22" id="h25-0-22" class="d">-        mint: goldenfile::Mint,
</a><a href="#h25-0-23" id="h25-0-23" class="d">-        file: Arc&lt;Mutex&lt;std::fs::File&gt;&gt;,
</a><a href="#h25-0-24" id="h25-0-24" class="d">-        next_id: u8,
</a><a href="#h25-0-25" id="h25-0-25" class="d">-    }
</a><a href="#h25-0-26" id="h25-0-26" class="i">+    use std::error::Error as StdError;
</a><a href="#h25-0-27" id="h25-0-27" class="i">+    use std::fmt::Write as _;
</a><a href="#h25-0-28" id="h25-0-28" class="i">+    use std::result::Result as StdResult;
</a><a href="#h25-0-29" id="h25-0-29" class="i">+    use test_case::test_case;
</a><a href="#h25-0-30" id="h25-0-30" class="i">+    use test_each_file::test_each_path;
</a> 
<a href="#h25-0-32" id="h25-0-32" class="d">-    impl Schedule {
</a><a href="#h25-0-33" id="h25-0-33" class="d">-        /// Creates a new schedule using the given golden master filename.
</a><a href="#h25-0-34" id="h25-0-34" class="d">-        fn new(name: &amp;str) -&gt; Result&lt;Self&gt; {
</a><a href="#h25-0-35" id="h25-0-35" class="d">-            let (op_tx, op_rx) = crossbeam::channel::unbounded();
</a><a href="#h25-0-36" id="h25-0-36" class="d">-            let mvcc = MVCC::new(Emit::new(Memory::new(), op_tx));
</a><a href="#h25-0-37" id="h25-0-37" class="d">-            let mut mint = goldenfile::Mint::new(GOLDEN_DIR);
</a><a href="#h25-0-38" id="h25-0-38" class="d">-            let file = Arc::new(Mutex::new(mint.new_goldenfile(name)?));
</a><a href="#h25-0-39" id="h25-0-39" class="d">-            Ok(Self { mvcc, op_rx, mint, file, next_id: 1 })
</a><a href="#h25-0-40" id="h25-0-40" class="d">-        }
</a><a href="#h25-0-41" id="h25-0-41" class="i">+    // Run goldenscript tests in src/storage/testscripts/mvcc.
</a><a href="#h25-0-42" id="h25-0-42" class="i">+    test_each_path! { in &quot;src/storage/testscripts/mvcc&quot; as scripts =&gt; test_goldenscript }
</a> 
<a href="#h25-0-44" id="h25-0-44" class="d">-        /// Sets up an initial, versioned dataset from the given data as a
</a><a href="#h25-0-45" id="h25-0-45" class="d">-        /// vector of key,version,value tuples. These transactions are not
</a><a href="#h25-0-46" id="h25-0-46" class="d">-        /// assigned transaction IDs, nor are the writes logged, except for the
</a><a href="#h25-0-47" id="h25-0-47" class="d">-        /// initial engine state.
</a><a href="#h25-0-48" id="h25-0-48" class="d">-        #[allow(clippy::type_complexity)]
</a><a href="#h25-0-49" id="h25-0-49" class="d">-        fn setup(&amp;mut self, data: Vec&lt;(&amp;[u8], Version, Option&lt;&amp;[u8]&gt;)&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-50" id="h25-0-50" class="d">-            // Segment the writes by version.
</a><a href="#h25-0-51" id="h25-0-51" class="d">-            let mut writes = HashMap::new();
</a><a href="#h25-0-52" id="h25-0-52" class="d">-            for (key, version, value) in data {
</a><a href="#h25-0-53" id="h25-0-53" class="d">-                writes
</a><a href="#h25-0-54" id="h25-0-54" class="d">-                    .entry(version)
</a><a href="#h25-0-55" id="h25-0-55" class="d">-                    .or_insert(Vec::new())
</a><a href="#h25-0-56" id="h25-0-56" class="d">-                    .push((key.to_vec(), value.map(|v| v.to_vec())));
</a><a href="#h25-0-57" id="h25-0-57" class="i">+    fn test_goldenscript(path: &amp;std::path::Path) {
</a><a href="#h25-0-58" id="h25-0-58" class="i">+        goldenscript::run(&amp;mut MVCCRunner::new(), path).expect(&quot;goldenscript failed&quot;)
</a><a href="#h25-0-59" id="h25-0-59" class="i">+    }
</a><a href="#h25-0-60" id="h25-0-60" class="i">+
</a><a href="#h25-0-61" id="h25-0-61" class="i">+    /// Tests that key prefixes are actually prefixes of keys.
</a><a href="#h25-0-62" id="h25-0-62" class="i">+    #[test_case(KeyPrefix::NextVersion, Key::NextVersion; &quot;NextVersion&quot;)]
</a><a href="#h25-0-63" id="h25-0-63" class="i">+    #[test_case(KeyPrefix::TxnActive, Key::TxnActive(1); &quot;TxnActive&quot;)]
</a><a href="#h25-0-64" id="h25-0-64" class="i">+    #[test_case(KeyPrefix::TxnActiveSnapshot, Key::TxnActiveSnapshot(1); &quot;TxnActiveSnapshot&quot;)]
</a><a href="#h25-0-65" id="h25-0-65" class="i">+    #[test_case(KeyPrefix::TxnWrite(1), Key::TxnWrite(1, b&quot;foo&quot;.as_slice().into()); &quot;TxnWrite&quot;)]
</a><a href="#h25-0-66" id="h25-0-66" class="i">+    #[test_case(KeyPrefix::Version(b&quot;foo&quot;.as_slice().into()), Key::Version(b&quot;foo&quot;.as_slice().into(), 1); &quot;Version&quot;)]
</a><a href="#h25-0-67" id="h25-0-67" class="i">+    #[test_case(KeyPrefix::Unversioned, Key::Unversioned(b&quot;foo&quot;.as_slice().into()); &quot;Unversioned&quot;)]
</a><a href="#h25-0-68" id="h25-0-68" class="i">+    fn key_prefix(prefix: KeyPrefix, key: Key) {
</a><a href="#h25-0-69" id="h25-0-69" class="i">+        let prefix = prefix.encode();
</a><a href="#h25-0-70" id="h25-0-70" class="i">+        let key = key.encode();
</a><a href="#h25-0-71" id="h25-0-71" class="i">+        assert_eq!(prefix, key[..prefix.len()])
</a><a href="#h25-0-72" id="h25-0-72" class="i">+    }
</a><a href="#h25-0-73" id="h25-0-73" class="i">+
</a><a href="#h25-0-74" id="h25-0-74" class="i">+    /// Runs MVCC goldenscript tests.
</a><a href="#h25-0-75" id="h25-0-75" class="i">+    pub struct MVCCRunner {
</a><a href="#h25-0-76" id="h25-0-76" class="i">+        mvcc: MVCC&lt;TestEngine&gt;,
</a><a href="#h25-0-77" id="h25-0-77" class="i">+        txns: HashMap&lt;String, Transaction&lt;TestEngine&gt;&gt;,
</a><a href="#h25-0-78" id="h25-0-78" class="i">+        op_rx: Receiver&lt;Operation&gt;,
</a><a href="#h25-0-79" id="h25-0-79" class="i">+        #[allow(dead_code)]
</a><a href="#h25-0-80" id="h25-0-80" class="i">+        tempdir: tempfile::TempDir,
</a><a href="#h25-0-81" id="h25-0-81" class="i">+    }
</a><a href="#h25-0-82" id="h25-0-82" class="i">+
</a><a href="#h25-0-83" id="h25-0-83" class="i">+    type TestEngine = Emit&lt;Mirror&lt;BitCask, Memory&gt;&gt;;
</a><a href="#h25-0-84" id="h25-0-84" class="i">+
</a><a href="#h25-0-85" id="h25-0-85" class="i">+    impl goldenscript::Runner for MVCCRunner {
</a><a href="#h25-0-86" id="h25-0-86" class="i">+        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-87" id="h25-0-87" class="i">+            // Validate tags.
</a><a href="#h25-0-88" id="h25-0-88" class="i">+            if let Some(tag) = command.tags.iter().find(|t| *t != &quot;ops&quot;) {
</a><a href="#h25-0-89" id="h25-0-89" class="i">+                return Err(format!(&quot;invalid tag {tag}&quot;).into());
</a>             }
<a href="#h25-0-91" id="h25-0-91" class="d">-            // Insert the writes with individual transactions.
</a><a href="#h25-0-92" id="h25-0-92" class="d">-            for i in 1..=writes.keys().max().copied().unwrap_or(0) {
</a><a href="#h25-0-93" id="h25-0-93" class="d">-                let txn = self.mvcc.begin()?;
</a><a href="#h25-0-94" id="h25-0-94" class="d">-                for (key, value) in writes.get(&amp;i).unwrap_or(&amp;Vec::new()) {
</a><a href="#h25-0-95" id="h25-0-95" class="d">-                    if let Some(value) = value {
</a><a href="#h25-0-96" id="h25-0-96" class="d">-                        txn.set(key, value.clone())?;
</a><a href="#h25-0-97" id="h25-0-97" class="d">-                    } else {
</a><a href="#h25-0-98" id="h25-0-98" class="d">-                        txn.delete(key)?;
</a><a href="#h25-0-99" id="h25-0-99" class="i">+
</a><a href="#h25-0-100" id="h25-0-100" class="i">+            // Execute command.
</a><a href="#h25-0-101" id="h25-0-101" class="i">+            let mut output = String::new();
</a><a href="#h25-0-102" id="h25-0-102" class="i">+            match command.name.as_str() {
</a><a href="#h25-0-103" id="h25-0-103" class="i">+                // txn: begin [readonly] [as_of=VERSION]
</a><a href="#h25-0-104" id="h25-0-104" class="i">+                &quot;begin&quot; =&gt; {
</a><a href="#h25-0-105" id="h25-0-105" class="i">+                    let name = Self::txn_name(&amp;command.prefix)?;
</a><a href="#h25-0-106" id="h25-0-106" class="i">+                    if self.txns.contains_key(name) {
</a><a href="#h25-0-107" id="h25-0-107" class="i">+                        return Err(format!(&quot;txn {name} already exists&quot;).into());
</a>                     }
<a href="#h25-0-109" id="h25-0-109" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-110" id="h25-0-110" class="i">+                    let readonly = match args.next_pos().map(|a| a.value.as_str()) {
</a><a href="#h25-0-111" id="h25-0-111" class="i">+                        Some(&quot;readonly&quot;) =&gt; true,
</a><a href="#h25-0-112" id="h25-0-112" class="i">+                        None =&gt; false,
</a><a href="#h25-0-113" id="h25-0-113" class="i">+                        Some(v) =&gt; return Err(format!(&quot;invalid argument {v}&quot;).into()),
</a><a href="#h25-0-114" id="h25-0-114" class="i">+                    };
</a><a href="#h25-0-115" id="h25-0-115" class="i">+                    let as_of = args.lookup_parse(&quot;as_of&quot;)?;
</a><a href="#h25-0-116" id="h25-0-116" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-117" id="h25-0-117" class="i">+                    let txn = match (readonly, as_of) {
</a><a href="#h25-0-118" id="h25-0-118" class="i">+                        (false, None) =&gt; self.mvcc.begin()?,
</a><a href="#h25-0-119" id="h25-0-119" class="i">+                        (true, None) =&gt; self.mvcc.begin_read_only()?,
</a><a href="#h25-0-120" id="h25-0-120" class="i">+                        (true, Some(v)) =&gt; self.mvcc.begin_as_of(v)?,
</a><a href="#h25-0-121" id="h25-0-121" class="i">+                        (false, Some(_)) =&gt; return Err(&quot;as_of only valid for read-only txn&quot;.into()),
</a><a href="#h25-0-122" id="h25-0-122" class="i">+                    };
</a><a href="#h25-0-123" id="h25-0-123" class="i">+                    self.txns.insert(name.to_string(), txn);
</a>                 }
<a href="#h25-0-125" id="h25-0-125" class="d">-                txn.commit()?;
</a><a href="#h25-0-126" id="h25-0-126" class="d">-            }
</a><a href="#h25-0-127" id="h25-0-127" class="d">-            // Flush the write log, but dump the engine contents.
</a><a href="#h25-0-128" id="h25-0-128" class="d">-            while self.op_rx.try_recv().is_ok() {}
</a><a href="#h25-0-129" id="h25-0-129" class="d">-            self.print_engine()?;
</a><a href="#h25-0-130" id="h25-0-130" class="d">-            writeln!(&amp;mut self.file.lock()?)?;
</a><a href="#h25-0-131" id="h25-0-131" class="d">-            Ok(())
</a><a href="#h25-0-132" id="h25-0-132" class="d">-        }
</a> 
<a href="#h25-0-134" id="h25-0-134" class="d">-        fn begin(&amp;mut self) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h25-0-135" id="h25-0-135" class="d">-            self.new_txn(&quot;begin&quot;, self.mvcc.begin())
</a><a href="#h25-0-136" id="h25-0-136" class="d">-        }
</a><a href="#h25-0-137" id="h25-0-137" class="i">+                // txn: commit
</a><a href="#h25-0-138" id="h25-0-138" class="i">+                &quot;commit&quot; =&gt; {
</a><a href="#h25-0-139" id="h25-0-139" class="i">+                    let name = Self::txn_name(&amp;command.prefix)?;
</a><a href="#h25-0-140" id="h25-0-140" class="i">+                    let txn = self.txns.remove(name).ok_or(format!(&quot;unknown txn {name}&quot;))?;
</a><a href="#h25-0-141" id="h25-0-141" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h25-0-142" id="h25-0-142" class="i">+                    txn.commit()?;
</a><a href="#h25-0-143" id="h25-0-143" class="i">+                }
</a> 
<a href="#h25-0-145" id="h25-0-145" class="d">-        fn begin_read_only(&amp;mut self) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h25-0-146" id="h25-0-146" class="d">-            self.new_txn(&quot;begin read-only&quot;, self.mvcc.begin_read_only())
</a><a href="#h25-0-147" id="h25-0-147" class="d">-        }
</a><a href="#h25-0-148" id="h25-0-148" class="i">+                // txn: delete KEY...
</a><a href="#h25-0-149" id="h25-0-149" class="i">+                &quot;delete&quot; =&gt; {
</a><a href="#h25-0-150" id="h25-0-150" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-151" id="h25-0-151" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-152" id="h25-0-152" class="i">+                    for arg in args.rest_pos() {
</a><a href="#h25-0-153" id="h25-0-153" class="i">+                        let key = Self::decode_binary(&amp;arg.value);
</a><a href="#h25-0-154" id="h25-0-154" class="i">+                        txn.delete(&amp;key)?;
</a><a href="#h25-0-155" id="h25-0-155" class="i">+                    }
</a><a href="#h25-0-156" id="h25-0-156" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-157" id="h25-0-157" class="i">+                }
</a> 
<a href="#h25-0-159" id="h25-0-159" class="d">-        fn begin_as_of(&amp;mut self, version: Version) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h25-0-160" id="h25-0-160" class="d">-            self.new_txn(&amp;format!(&quot;begin as of {}&quot;, version), self.mvcc.begin_as_of(version))
</a><a href="#h25-0-161" id="h25-0-161" class="d">-        }
</a><a href="#h25-0-162" id="h25-0-162" class="i">+                // dump
</a><a href="#h25-0-163" id="h25-0-163" class="i">+                &quot;dump&quot; =&gt; {
</a><a href="#h25-0-164" id="h25-0-164" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h25-0-165" id="h25-0-165" class="i">+                    let mut engine = self.mvcc.engine.lock().unwrap();
</a><a href="#h25-0-166" id="h25-0-166" class="i">+                    let mut scan = engine.scan(..);
</a><a href="#h25-0-167" id="h25-0-167" class="i">+                    while let Some((key, value)) = scan.next().transpose()? {
</a><a href="#h25-0-168" id="h25-0-168" class="i">+                        let (fkey, Some(fvalue)) = debug::format_key_value(&amp;key, &amp;Some(value))
</a><a href="#h25-0-169" id="h25-0-169" class="i">+                        else {
</a><a href="#h25-0-170" id="h25-0-170" class="i">+                            panic!(&quot;expected option&quot;);
</a><a href="#h25-0-171" id="h25-0-171" class="i">+                        };
</a><a href="#h25-0-172" id="h25-0-172" class="i">+                        writeln!(output, &quot;{fkey} → {fvalue}&quot;)?;
</a><a href="#h25-0-173" id="h25-0-173" class="i">+                    }
</a><a href="#h25-0-174" id="h25-0-174" class="i">+                }
</a> 
<a href="#h25-0-176" id="h25-0-176" class="d">-        fn resume(&amp;mut self, state: TransactionState) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h25-0-177" id="h25-0-177" class="d">-            self.new_txn(&quot;resume&quot;, self.mvcc.resume(state))
</a><a href="#h25-0-178" id="h25-0-178" class="d">-        }
</a><a href="#h25-0-179" id="h25-0-179" class="i">+                // txn: get KEY...
</a><a href="#h25-0-180" id="h25-0-180" class="i">+                &quot;get&quot; =&gt; {
</a><a href="#h25-0-181" id="h25-0-181" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-182" id="h25-0-182" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-183" id="h25-0-183" class="i">+                    for arg in args.rest_pos() {
</a><a href="#h25-0-184" id="h25-0-184" class="i">+                        let key = Self::decode_binary(&amp;arg.value);
</a><a href="#h25-0-185" id="h25-0-185" class="i">+                        let value = txn.get(&amp;key)?;
</a><a href="#h25-0-186" id="h25-0-186" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, value.as_deref()))?;
</a><a href="#h25-0-187" id="h25-0-187" class="i">+                    }
</a><a href="#h25-0-188" id="h25-0-188" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-189" id="h25-0-189" class="i">+                }
</a> 
<a href="#h25-0-191" id="h25-0-191" class="d">-        /// Processes a begin/resume result.
</a><a href="#h25-0-192" id="h25-0-192" class="d">-        fn new_txn(
</a><a href="#h25-0-193" id="h25-0-193" class="d">-            &amp;mut self,
</a><a href="#h25-0-194" id="h25-0-194" class="d">-            name: &amp;str,
</a><a href="#h25-0-195" id="h25-0-195" class="d">-            result: Result&lt;Transaction&lt;Emit&lt;Memory&gt;&gt;&gt;,
</a><a href="#h25-0-196" id="h25-0-196" class="d">-        ) -&gt; Result&lt;ScheduleTransaction&gt; {
</a><a href="#h25-0-197" id="h25-0-197" class="d">-            let id = self.next_id;
</a><a href="#h25-0-198" id="h25-0-198" class="d">-            self.next_id += 1;
</a><a href="#h25-0-199" id="h25-0-199" class="d">-            self.print_begin(id, name, &amp;result)?;
</a><a href="#h25-0-200" id="h25-0-200" class="d">-            result.map(|txn| ScheduleTransaction {
</a><a href="#h25-0-201" id="h25-0-201" class="d">-                id,
</a><a href="#h25-0-202" id="h25-0-202" class="d">-                txn,
</a><a href="#h25-0-203" id="h25-0-203" class="d">-                file: self.file.clone(),
</a><a href="#h25-0-204" id="h25-0-204" class="d">-                op_rx: self.op_rx.clone(),
</a><a href="#h25-0-205" id="h25-0-205" class="d">-            })
</a><a href="#h25-0-206" id="h25-0-206" class="d">-        }
</a><a href="#h25-0-207" id="h25-0-207" class="i">+                // get_unversioned KEY...
</a><a href="#h25-0-208" id="h25-0-208" class="i">+                &quot;get_unversioned&quot; =&gt; {
</a><a href="#h25-0-209" id="h25-0-209" class="i">+                    Self::no_txn(command)?;
</a><a href="#h25-0-210" id="h25-0-210" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-211" id="h25-0-211" class="i">+                    for arg in args.rest_pos() {
</a><a href="#h25-0-212" id="h25-0-212" class="i">+                        let key = Self::decode_binary(&amp;arg.value);
</a><a href="#h25-0-213" id="h25-0-213" class="i">+                        let value = self.mvcc.get_unversioned(&amp;key)?;
</a><a href="#h25-0-214" id="h25-0-214" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, value.as_deref()))?;
</a><a href="#h25-0-215" id="h25-0-215" class="i">+                    }
</a><a href="#h25-0-216" id="h25-0-216" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-217" id="h25-0-217" class="i">+                }
</a> 
<a href="#h25-0-219" id="h25-0-219" class="d">-        /// Prints a transaction begin to the golden file.
</a><a href="#h25-0-220" id="h25-0-220" class="d">-        fn print_begin(
</a><a href="#h25-0-221" id="h25-0-221" class="d">-            &amp;mut self,
</a><a href="#h25-0-222" id="h25-0-222" class="d">-            id: u8,
</a><a href="#h25-0-223" id="h25-0-223" class="d">-            name: &amp;str,
</a><a href="#h25-0-224" id="h25-0-224" class="d">-            result: &amp;Result&lt;Transaction&lt;Emit&lt;Memory&gt;&gt;&gt;,
</a><a href="#h25-0-225" id="h25-0-225" class="d">-        ) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-226" id="h25-0-226" class="d">-            let mut f = self.file.lock()?;
</a><a href="#h25-0-227" id="h25-0-227" class="d">-            write!(f, &quot;T{}: {} → &quot;, id, name)?;
</a><a href="#h25-0-228" id="h25-0-228" class="d">-            match result {
</a><a href="#h25-0-229" id="h25-0-229" class="d">-                Ok(txn) =&gt; writeln!(f, &quot;{}&quot;, debug::format_txn(txn.state()))?,
</a><a href="#h25-0-230" id="h25-0-230" class="d">-                Err(err) =&gt; writeln!(f, &quot;Error::{:?}&quot;, err)?,
</a><a href="#h25-0-231" id="h25-0-231" class="d">-            };
</a><a href="#h25-0-232" id="h25-0-232" class="d">-            Self::print_log(&amp;mut f, &amp;self.op_rx)?;
</a><a href="#h25-0-233" id="h25-0-233" class="d">-            writeln!(f)?;
</a><a href="#h25-0-234" id="h25-0-234" class="d">-            Ok(())
</a><a href="#h25-0-235" id="h25-0-235" class="d">-        }
</a><a href="#h25-0-236" id="h25-0-236" class="d">-        /// Prints the engine write log since the last call to the golden file.
</a><a href="#h25-0-237" id="h25-0-237" class="d">-        fn print_log(
</a><a href="#h25-0-238" id="h25-0-238" class="d">-            f: &amp;mut MutexGuard&lt;&#39;_, std::fs::File&gt;,
</a><a href="#h25-0-239" id="h25-0-239" class="d">-            op_rx: &amp;Receiver&lt;testengine::Operation&gt;,
</a><a href="#h25-0-240" id="h25-0-240" class="d">-        ) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-241" id="h25-0-241" class="d">-            while let Ok(op) = op_rx.try_recv() {
</a><a href="#h25-0-242" id="h25-0-242" class="d">-                match op {
</a><a href="#h25-0-243" id="h25-0-243" class="d">-                    testengine::Operation::Delete { key } =&gt; {
</a><a href="#h25-0-244" id="h25-0-244" class="d">-                        let (fkey, _) = debug::format_key_value(&amp;key, &amp;None);
</a><a href="#h25-0-245" id="h25-0-245" class="d">-                        writeln!(f, &quot;    del {fkey}&quot;)
</a><a href="#h25-0-246" id="h25-0-246" class="i">+                // import [VERSION] KEY=VALUE...
</a><a href="#h25-0-247" id="h25-0-247" class="i">+                &quot;import&quot; =&gt; {
</a><a href="#h25-0-248" id="h25-0-248" class="i">+                    Self::no_txn(command)?;
</a><a href="#h25-0-249" id="h25-0-249" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-250" id="h25-0-250" class="i">+                    let version = args.next_pos().map(|a| a.parse()).transpose()?;
</a><a href="#h25-0-251" id="h25-0-251" class="i">+                    let mut txn = self.mvcc.begin()?;
</a><a href="#h25-0-252" id="h25-0-252" class="i">+                    if let Some(version) = version {
</a><a href="#h25-0-253" id="h25-0-253" class="i">+                        if txn.version() &gt; version {
</a><a href="#h25-0-254" id="h25-0-254" class="i">+                            return Err(format!(&quot;version {version} already used&quot;).into());
</a><a href="#h25-0-255" id="h25-0-255" class="i">+                        }
</a><a href="#h25-0-256" id="h25-0-256" class="i">+                        while txn.version() &lt; version {
</a><a href="#h25-0-257" id="h25-0-257" class="i">+                            txn = self.mvcc.begin()?;
</a><a href="#h25-0-258" id="h25-0-258" class="i">+                        }
</a>                     }
<a href="#h25-0-260" id="h25-0-260" class="d">-                    testengine::Operation::Flush =&gt; writeln!(f, &quot;    flush&quot;),
</a><a href="#h25-0-261" id="h25-0-261" class="d">-                    testengine::Operation::Set { key, value } =&gt; {
</a><a href="#h25-0-262" id="h25-0-262" class="d">-                        let (fkey, fvalue) = debug::format_key_value(&amp;key, &amp;Some(value));
</a><a href="#h25-0-263" id="h25-0-263" class="d">-                        writeln!(f, &quot;    set {} = {}&quot;, fkey, fvalue.unwrap())
</a><a href="#h25-0-264" id="h25-0-264" class="i">+                    for kv in args.rest_key() {
</a><a href="#h25-0-265" id="h25-0-265" class="i">+                        let key = Self::decode_binary(kv.key.as_ref().unwrap());
</a><a href="#h25-0-266" id="h25-0-266" class="i">+                        let value = Self::decode_binary(&amp;kv.value);
</a><a href="#h25-0-267" id="h25-0-267" class="i">+                        if value.is_empty() {
</a><a href="#h25-0-268" id="h25-0-268" class="i">+                            txn.delete(&amp;key)?;
</a><a href="#h25-0-269" id="h25-0-269" class="i">+                        } else {
</a><a href="#h25-0-270" id="h25-0-270" class="i">+                            txn.set(&amp;key, value)?;
</a><a href="#h25-0-271" id="h25-0-271" class="i">+                        }
</a>                     }
<a href="#h25-0-273" id="h25-0-273" class="d">-                }?;
</a><a href="#h25-0-274" id="h25-0-274" class="d">-            }
</a><a href="#h25-0-275" id="h25-0-275" class="d">-            Ok(())
</a><a href="#h25-0-276" id="h25-0-276" class="d">-        }
</a><a href="#h25-0-277" id="h25-0-277" class="d">-
</a><a href="#h25-0-278" id="h25-0-278" class="d">-        /// Prints the engine contents to the golden file.
</a><a href="#h25-0-279" id="h25-0-279" class="d">-        fn print_engine(&amp;self) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-280" id="h25-0-280" class="d">-            let mut f = self.file.lock()?;
</a><a href="#h25-0-281" id="h25-0-281" class="d">-            let mut engine = self.mvcc.engine.lock()?;
</a><a href="#h25-0-282" id="h25-0-282" class="d">-            let mut scan = engine.scan(..);
</a><a href="#h25-0-283" id="h25-0-283" class="d">-            writeln!(f, &quot;Engine state:&quot;)?;
</a><a href="#h25-0-284" id="h25-0-284" class="d">-            while let Some((key, value)) = scan.next().transpose()? {
</a><a href="#h25-0-285" id="h25-0-285" class="d">-                if let (fkey, Some(fvalue)) = debug::format_key_value(&amp;key, &amp;Some(value)) {
</a><a href="#h25-0-286" id="h25-0-286" class="d">-                    writeln!(f, &quot;{} = {}&quot;, fkey, fvalue)?;
</a><a href="#h25-0-287" id="h25-0-287" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-288" id="h25-0-288" class="i">+                    txn.commit()?;
</a>                 }
<a href="#h25-0-290" id="h25-0-290" class="d">-            }
</a><a href="#h25-0-291" id="h25-0-291" class="d">-            Ok(())
</a><a href="#h25-0-292" id="h25-0-292" class="d">-        }
</a> 
<a href="#h25-0-294" id="h25-0-294" class="d">-        fn get_unversioned(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h25-0-295" id="h25-0-295" class="d">-            let value = self.mvcc.get_unversioned(key)?;
</a><a href="#h25-0-296" id="h25-0-296" class="d">-            write!(
</a><a href="#h25-0-297" id="h25-0-297" class="d">-                self.file.lock()?,
</a><a href="#h25-0-298" id="h25-0-298" class="d">-                &quot;T_: get unversioned {} → {}\n\n&quot;,
</a><a href="#h25-0-299" id="h25-0-299" class="d">-                debug::format_raw(key),
</a><a href="#h25-0-300" id="h25-0-300" class="d">-                if let Some(ref value) = value {
</a><a href="#h25-0-301" id="h25-0-301" class="d">-                    debug::format_raw(value)
</a><a href="#h25-0-302" id="h25-0-302" class="d">-                } else {
</a><a href="#h25-0-303" id="h25-0-303" class="d">-                    String::from(&quot;None&quot;)
</a><a href="#h25-0-304" id="h25-0-304" class="i">+                // txn: resume JSON
</a><a href="#h25-0-305" id="h25-0-305" class="i">+                &quot;resume&quot; =&gt; {
</a><a href="#h25-0-306" id="h25-0-306" class="i">+                    let name = Self::txn_name(&amp;command.prefix)?;
</a><a href="#h25-0-307" id="h25-0-307" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-308" id="h25-0-308" class="i">+                    let raw = &amp;args.next_pos().ok_or(&quot;state not given&quot;)?.value;
</a><a href="#h25-0-309" id="h25-0-309" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-310" id="h25-0-310" class="i">+                    let state: TransactionState = serde_json::from_str(raw)?;
</a><a href="#h25-0-311" id="h25-0-311" class="i">+                    let txn = self.mvcc.resume(state)?;
</a><a href="#h25-0-312" id="h25-0-312" class="i">+                    self.txns.insert(name.to_string(), txn);
</a>                 }
<a href="#h25-0-314" id="h25-0-314" class="d">-            )?;
</a><a href="#h25-0-315" id="h25-0-315" class="d">-            Ok(value)
</a><a href="#h25-0-316" id="h25-0-316" class="d">-        }
</a><a href="#h25-0-317" id="h25-0-317" class="d">-
</a><a href="#h25-0-318" id="h25-0-318" class="d">-        fn set_unversioned(&amp;self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-319" id="h25-0-319" class="d">-            let mut f = self.file.lock()?;
</a><a href="#h25-0-320" id="h25-0-320" class="d">-            write!(
</a><a href="#h25-0-321" id="h25-0-321" class="d">-                f,
</a><a href="#h25-0-322" id="h25-0-322" class="d">-                &quot;T_: set unversioned {} = {}&quot;,
</a><a href="#h25-0-323" id="h25-0-323" class="d">-                debug::format_raw(key),
</a><a href="#h25-0-324" id="h25-0-324" class="d">-                debug::format_raw(&amp;value)
</a><a href="#h25-0-325" id="h25-0-325" class="d">-            )?;
</a><a href="#h25-0-326" id="h25-0-326" class="d">-            let result = self.mvcc.set_unversioned(key, value);
</a><a href="#h25-0-327" id="h25-0-327" class="d">-            match &amp;result {
</a><a href="#h25-0-328" id="h25-0-328" class="d">-                Ok(_) =&gt; writeln!(f)?,
</a><a href="#h25-0-329" id="h25-0-329" class="d">-                Err(err) =&gt; writeln!(f, &quot; → Error::{:?}&quot;, err)?,
</a><a href="#h25-0-330" id="h25-0-330" class="d">-            }
</a><a href="#h25-0-331" id="h25-0-331" class="d">-            Schedule::print_log(&amp;mut f, &amp;self.op_rx)?;
</a><a href="#h25-0-332" id="h25-0-332" class="d">-            writeln!(f)?;
</a><a href="#h25-0-333" id="h25-0-333" class="d">-            result
</a><a href="#h25-0-334" id="h25-0-334" class="d">-        }
</a><a href="#h25-0-335" id="h25-0-335" class="d">-    }
</a> 
<a href="#h25-0-337" id="h25-0-337" class="d">-    impl Drop for Schedule {
</a><a href="#h25-0-338" id="h25-0-338" class="d">-        /// Print engine contents when the schedule is dropped.
</a><a href="#h25-0-339" id="h25-0-339" class="d">-        fn drop(&amp;mut self) {
</a><a href="#h25-0-340" id="h25-0-340" class="d">-            _ = self.print_engine();
</a><a href="#h25-0-341" id="h25-0-341" class="d">-            _ = self.mint; // goldenfile assertions run when mint is dropped
</a><a href="#h25-0-342" id="h25-0-342" class="d">-        }
</a><a href="#h25-0-343" id="h25-0-343" class="d">-    }
</a><a href="#h25-0-344" id="h25-0-344" class="d">-
</a><a href="#h25-0-345" id="h25-0-345" class="d">-    struct ScheduleTransaction {
</a><a href="#h25-0-346" id="h25-0-346" class="d">-        id: u8,
</a><a href="#h25-0-347" id="h25-0-347" class="d">-        txn: Transaction&lt;Emit&lt;Memory&gt;&gt;,
</a><a href="#h25-0-348" id="h25-0-348" class="d">-        file: Arc&lt;Mutex&lt;std::fs::File&gt;&gt;,
</a><a href="#h25-0-349" id="h25-0-349" class="d">-        op_rx: Receiver&lt;testengine::Operation&gt;,
</a><a href="#h25-0-350" id="h25-0-350" class="d">-    }
</a><a href="#h25-0-351" id="h25-0-351" class="d">-
</a><a href="#h25-0-352" id="h25-0-352" class="d">-    impl Clone for ScheduleTransaction {
</a><a href="#h25-0-353" id="h25-0-353" class="d">-        /// Allow cloning a schedule transaction, to simplify handling when
</a><a href="#h25-0-354" id="h25-0-354" class="d">-        /// commit/rollback consumes it. We don&#39;t want to allow this in general,
</a><a href="#h25-0-355" id="h25-0-355" class="d">-        /// since a commit/rollback will invalidate the cloned transactions.
</a><a href="#h25-0-356" id="h25-0-356" class="d">-        fn clone(&amp;self) -&gt; Self {
</a><a href="#h25-0-357" id="h25-0-357" class="d">-            let txn = Transaction { engine: self.txn.engine.clone(), st: self.txn.st.clone() };
</a><a href="#h25-0-358" id="h25-0-358" class="d">-            Self { id: self.id, op_rx: self.op_rx.clone(), txn, file: self.file.clone() }
</a><a href="#h25-0-359" id="h25-0-359" class="d">-        }
</a><a href="#h25-0-360" id="h25-0-360" class="d">-    }
</a><a href="#h25-0-361" id="h25-0-361" class="d">-
</a><a href="#h25-0-362" id="h25-0-362" class="d">-    impl ScheduleTransaction {
</a><a href="#h25-0-363" id="h25-0-363" class="d">-        fn state(&amp;self) -&gt; TransactionState {
</a><a href="#h25-0-364" id="h25-0-364" class="d">-            self.txn.state().clone()
</a><a href="#h25-0-365" id="h25-0-365" class="d">-        }
</a><a href="#h25-0-366" id="h25-0-366" class="d">-
</a><a href="#h25-0-367" id="h25-0-367" class="d">-        fn commit(self) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-368" id="h25-0-368" class="d">-            let result = self.clone().txn.commit(); // clone to retain self.txn for printing
</a><a href="#h25-0-369" id="h25-0-369" class="d">-            self.print_mutation(&quot;commit&quot;, &amp;result)?;
</a><a href="#h25-0-370" id="h25-0-370" class="d">-            result
</a><a href="#h25-0-371" id="h25-0-371" class="d">-        }
</a><a href="#h25-0-372" id="h25-0-372" class="i">+                // txn: rollback
</a><a href="#h25-0-373" id="h25-0-373" class="i">+                &quot;rollback&quot; =&gt; {
</a><a href="#h25-0-374" id="h25-0-374" class="i">+                    let name = Self::txn_name(&amp;command.prefix)?;
</a><a href="#h25-0-375" id="h25-0-375" class="i">+                    let txn = self.txns.remove(name).ok_or(format!(&quot;unknown txn {name}&quot;))?;
</a><a href="#h25-0-376" id="h25-0-376" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h25-0-377" id="h25-0-377" class="i">+                    txn.rollback()?;
</a><a href="#h25-0-378" id="h25-0-378" class="i">+                }
</a> 
<a href="#h25-0-380" id="h25-0-380" class="d">-        fn rollback(self) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-381" id="h25-0-381" class="d">-            let result = self.clone().txn.rollback(); // clone to retain self.txn for printing
</a><a href="#h25-0-382" id="h25-0-382" class="d">-            self.print_mutation(&quot;rollback&quot;, &amp;result)?;
</a><a href="#h25-0-383" id="h25-0-383" class="d">-            result
</a><a href="#h25-0-384" id="h25-0-384" class="d">-        }
</a><a href="#h25-0-385" id="h25-0-385" class="i">+                // txn: scan [reverse=BOOL] [RANGE]
</a><a href="#h25-0-386" id="h25-0-386" class="i">+                &quot;scan&quot; =&gt; {
</a><a href="#h25-0-387" id="h25-0-387" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-388" id="h25-0-388" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-389" id="h25-0-389" class="i">+                    let reverse = args.lookup_parse(&quot;reverse&quot;)?.unwrap_or(false);
</a><a href="#h25-0-390" id="h25-0-390" class="i">+                    let range = Self::parse_key_range(
</a><a href="#h25-0-391" id="h25-0-391" class="i">+                        args.next_pos().map(|a| a.value.as_str()).unwrap_or(&quot;..&quot;),
</a><a href="#h25-0-392" id="h25-0-392" class="i">+                    )?;
</a><a href="#h25-0-393" id="h25-0-393" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-394" id="h25-0-394" class="i">+
</a><a href="#h25-0-395" id="h25-0-395" class="i">+                    let mut scan = txn.scan(range)?;
</a><a href="#h25-0-396" id="h25-0-396" class="i">+                    let kvs: Vec&lt;_&gt; = match reverse {
</a><a href="#h25-0-397" id="h25-0-397" class="i">+                        false =&gt; scan.iter().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h25-0-398" id="h25-0-398" class="i">+                        true =&gt; scan.iter().rev().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h25-0-399" id="h25-0-399" class="i">+                    };
</a><a href="#h25-0-400" id="h25-0-400" class="i">+                    for (key, value) in kvs {
</a><a href="#h25-0-401" id="h25-0-401" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h25-0-402" id="h25-0-402" class="i">+                    }
</a><a href="#h25-0-403" id="h25-0-403" class="i">+                }
</a> 
<a href="#h25-0-405" id="h25-0-405" class="d">-        fn delete(&amp;self, key: &amp;[u8]) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-406" id="h25-0-406" class="d">-            let result = self.txn.delete(key);
</a><a href="#h25-0-407" id="h25-0-407" class="d">-            self.print_mutation(&amp;format!(&quot;del {}&quot;, debug::format_raw(key)), &amp;result)?;
</a><a href="#h25-0-408" id="h25-0-408" class="d">-            result
</a><a href="#h25-0-409" id="h25-0-409" class="d">-        }
</a><a href="#h25-0-410" id="h25-0-410" class="i">+                // txn: scan_prefix [reverse=BOOL] PREFIX
</a><a href="#h25-0-411" id="h25-0-411" class="i">+                &quot;scan_prefix&quot; =&gt; {
</a><a href="#h25-0-412" id="h25-0-412" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-413" id="h25-0-413" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-414" id="h25-0-414" class="i">+                    let prefix =
</a><a href="#h25-0-415" id="h25-0-415" class="i">+                        Self::decode_binary(&amp;args.next_pos().ok_or(&quot;prefix not given&quot;)?.value);
</a><a href="#h25-0-416" id="h25-0-416" class="i">+                    let reverse = args.lookup_parse(&quot;reverse&quot;)?.unwrap_or(false);
</a><a href="#h25-0-417" id="h25-0-417" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-418" id="h25-0-418" class="i">+
</a><a href="#h25-0-419" id="h25-0-419" class="i">+                    let mut scan = txn.scan_prefix(&amp;prefix)?;
</a><a href="#h25-0-420" id="h25-0-420" class="i">+                    let kvs: Vec&lt;_&gt; = match reverse {
</a><a href="#h25-0-421" id="h25-0-421" class="i">+                        false =&gt; scan.iter().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h25-0-422" id="h25-0-422" class="i">+                        true =&gt; scan.iter().rev().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h25-0-423" id="h25-0-423" class="i">+                    };
</a><a href="#h25-0-424" id="h25-0-424" class="i">+                    for (key, value) in kvs {
</a><a href="#h25-0-425" id="h25-0-425" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h25-0-426" id="h25-0-426" class="i">+                    }
</a><a href="#h25-0-427" id="h25-0-427" class="i">+                }
</a> 
<a href="#h25-0-429" id="h25-0-429" class="d">-        fn set(&amp;self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-430" id="h25-0-430" class="d">-            let result = self.txn.set(key, value.clone());
</a><a href="#h25-0-431" id="h25-0-431" class="d">-            self.print_mutation(
</a><a href="#h25-0-432" id="h25-0-432" class="d">-                &amp;format!(&quot;set {} = {}&quot;, debug::format_raw(key), debug::format_raw(&amp;value)),
</a><a href="#h25-0-433" id="h25-0-433" class="d">-                &amp;result,
</a><a href="#h25-0-434" id="h25-0-434" class="d">-            )?;
</a><a href="#h25-0-435" id="h25-0-435" class="d">-            result
</a><a href="#h25-0-436" id="h25-0-436" class="d">-        }
</a><a href="#h25-0-437" id="h25-0-437" class="i">+                // txn: set KEY=VALUE...
</a><a href="#h25-0-438" id="h25-0-438" class="i">+                &quot;set&quot; =&gt; {
</a><a href="#h25-0-439" id="h25-0-439" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-440" id="h25-0-440" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-441" id="h25-0-441" class="i">+                    for kv in args.rest_key() {
</a><a href="#h25-0-442" id="h25-0-442" class="i">+                        let key = Self::decode_binary(kv.key.as_ref().unwrap());
</a><a href="#h25-0-443" id="h25-0-443" class="i">+                        let value = Self::decode_binary(&amp;kv.value);
</a><a href="#h25-0-444" id="h25-0-444" class="i">+                        txn.set(&amp;key, value)?;
</a><a href="#h25-0-445" id="h25-0-445" class="i">+                    }
</a><a href="#h25-0-446" id="h25-0-446" class="i">+                    args.reject_rest()?;
</a><a href="#h25-0-447" id="h25-0-447" class="i">+                }
</a> 
<a href="#h25-0-449" id="h25-0-449" class="d">-        fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h25-0-450" id="h25-0-450" class="d">-            let value = self.txn.get(key)?;
</a><a href="#h25-0-451" id="h25-0-451" class="d">-            write!(
</a><a href="#h25-0-452" id="h25-0-452" class="d">-                self.file.lock()?,
</a><a href="#h25-0-453" id="h25-0-453" class="d">-                &quot;T{}: get {} → {}\n\n&quot;,
</a><a href="#h25-0-454" id="h25-0-454" class="d">-                self.id,
</a><a href="#h25-0-455" id="h25-0-455" class="d">-                debug::format_raw(key),
</a><a href="#h25-0-456" id="h25-0-456" class="d">-                if let Some(ref value) = value {
</a><a href="#h25-0-457" id="h25-0-457" class="d">-                    debug::format_raw(value)
</a><a href="#h25-0-458" id="h25-0-458" class="d">-                } else {
</a><a href="#h25-0-459" id="h25-0-459" class="d">-                    String::from(&quot;None&quot;)
</a><a href="#h25-0-460" id="h25-0-460" class="i">+                // set_unversioned KEY=VALUE...
</a><a href="#h25-0-461" id="h25-0-461" class="i">+                &quot;set_unversioned&quot; =&gt; {
</a><a href="#h25-0-462" id="h25-0-462" class="i">+                    Self::no_txn(command)?;
</a><a href="#h25-0-463" id="h25-0-463" class="i">+                    let mut args = command.consume_args();
</a><a href="#h25-0-464" id="h25-0-464" class="i">+                    for kv in args.rest_key() {
</a><a href="#h25-0-465" id="h25-0-465" class="i">+                        let key = Self::decode_binary(kv.key.as_ref().unwrap());
</a><a href="#h25-0-466" id="h25-0-466" class="i">+                        let value = Self::decode_binary(&amp;kv.value);
</a><a href="#h25-0-467" id="h25-0-467" class="i">+                        self.mvcc.set_unversioned(&amp;key, value)?;
</a><a href="#h25-0-468" id="h25-0-468" class="i">+                    }
</a><a href="#h25-0-469" id="h25-0-469" class="i">+                    args.reject_rest()?;
</a>                 }
<a href="#h25-0-471" id="h25-0-471" class="d">-            )?;
</a><a href="#h25-0-472" id="h25-0-472" class="d">-            Ok(value)
</a><a href="#h25-0-473" id="h25-0-473" class="d">-        }
</a> 
<a href="#h25-0-475" id="h25-0-475" class="d">-        fn scan&lt;R: RangeBounds&lt;Vec&lt;u8&gt;&gt;&gt;(&amp;self, range: R) -&gt; Result&lt;Scan&lt;Emit&lt;Memory&gt;&gt;&gt; {
</a><a href="#h25-0-476" id="h25-0-476" class="d">-            let name = format!(
</a><a href="#h25-0-477" id="h25-0-477" class="d">-                &quot;scan {}..{}&quot;,
</a><a href="#h25-0-478" id="h25-0-478" class="d">-                match range.start_bound() {
</a><a href="#h25-0-479" id="h25-0-479" class="d">-                    Bound::Excluded(k) =&gt; format!(&quot;({}&quot;, debug::format_raw(k)),
</a><a href="#h25-0-480" id="h25-0-480" class="d">-                    Bound::Included(k) =&gt; format!(&quot;[{}&quot;, debug::format_raw(k)),
</a><a href="#h25-0-481" id="h25-0-481" class="d">-                    Bound::Unbounded =&gt; &quot;&quot;.to_string(),
</a><a href="#h25-0-482" id="h25-0-482" class="d">-                },
</a><a href="#h25-0-483" id="h25-0-483" class="d">-                match range.end_bound() {
</a><a href="#h25-0-484" id="h25-0-484" class="d">-                    Bound::Excluded(k) =&gt; format!(&quot;{})&quot;, debug::format_raw(k)),
</a><a href="#h25-0-485" id="h25-0-485" class="d">-                    Bound::Included(k) =&gt; format!(&quot;{}]&quot;, debug::format_raw(k)),
</a><a href="#h25-0-486" id="h25-0-486" class="d">-                    Bound::Unbounded =&gt; &quot;&quot;.to_string(),
</a><a href="#h25-0-487" id="h25-0-487" class="d">-                },
</a><a href="#h25-0-488" id="h25-0-488" class="d">-            );
</a><a href="#h25-0-489" id="h25-0-489" class="d">-            let mut scan = self.txn.scan(range)?;
</a><a href="#h25-0-490" id="h25-0-490" class="d">-            self.print_scan(&amp;name, scan.to_vec()?)?;
</a><a href="#h25-0-491" id="h25-0-491" class="d">-            Ok(scan)
</a><a href="#h25-0-492" id="h25-0-492" class="d">-        }
</a><a href="#h25-0-493" id="h25-0-493" class="i">+                // txn: state
</a><a href="#h25-0-494" id="h25-0-494" class="i">+                &quot;state&quot; =&gt; {
</a><a href="#h25-0-495" id="h25-0-495" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h25-0-496" id="h25-0-496" class="i">+                    let txn = self.get_txn(&amp;command.prefix)?;
</a><a href="#h25-0-497" id="h25-0-497" class="i">+                    let state = txn.state();
</a><a href="#h25-0-498" id="h25-0-498" class="i">+                    write!(
</a><a href="#h25-0-499" id="h25-0-499" class="i">+                        output,
</a><a href="#h25-0-500" id="h25-0-500" class="i">+                        &quot;v{} {} active={{{}}}&quot;,
</a><a href="#h25-0-501" id="h25-0-501" class="i">+                        state.version,
</a><a href="#h25-0-502" id="h25-0-502" class="i">+                        if state.read_only { &quot;ro&quot; } else { &quot;rw&quot; },
</a><a href="#h25-0-503" id="h25-0-503" class="i">+                        state.active.iter().sorted().join(&quot;,&quot;)
</a><a href="#h25-0-504" id="h25-0-504" class="i">+                    )?;
</a><a href="#h25-0-505" id="h25-0-505" class="i">+                }
</a> 
<a href="#h25-0-507" id="h25-0-507" class="d">-        fn scan_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Result&lt;Scan&lt;Emit&lt;Memory&gt;&gt;&gt; {
</a><a href="#h25-0-508" id="h25-0-508" class="d">-            let mut scan = self.txn.scan_prefix(prefix)?;
</a><a href="#h25-0-509" id="h25-0-509" class="d">-            self.print_scan(&amp;format!(&quot;scan prefix {}&quot;, debug::format_raw(prefix)), scan.to_vec()?)?;
</a><a href="#h25-0-510" id="h25-0-510" class="d">-            Ok(scan)
</a><a href="#h25-0-511" id="h25-0-511" class="d">-        }
</a><a href="#h25-0-512" id="h25-0-512" class="i">+                // status
</a><a href="#h25-0-513" id="h25-0-513" class="i">+                &quot;status&quot; =&gt; {
</a><a href="#h25-0-514" id="h25-0-514" class="i">+                    let status = self.mvcc.status()?;
</a><a href="#h25-0-515" id="h25-0-515" class="i">+                    writeln!(output, &quot;{status:#?}&quot;)?;
</a><a href="#h25-0-516" id="h25-0-516" class="i">+                }
</a> 
<a href="#h25-0-518" id="h25-0-518" class="d">-        /// Prints the result of a mutation to the golden file.
</a><a href="#h25-0-519" id="h25-0-519" class="d">-        fn print_mutation(&amp;self, name: &amp;str, result: &amp;Result&lt;()&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-520" id="h25-0-520" class="d">-            let mut f = self.file.lock()?;
</a><a href="#h25-0-521" id="h25-0-521" class="d">-            write!(f, &quot;T{}: {}&quot;, self.id, name)?;
</a><a href="#h25-0-522" id="h25-0-522" class="d">-            match result {
</a><a href="#h25-0-523" id="h25-0-523" class="d">-                Ok(_) =&gt; writeln!(f)?,
</a><a href="#h25-0-524" id="h25-0-524" class="d">-                Err(err) =&gt; writeln!(f, &quot; → Error::{:?}&quot;, err)?,
</a><a href="#h25-0-525" id="h25-0-525" class="i">+                name =&gt; return Err(format!(&quot;invalid command {name}&quot;).into()),
</a>             }
<a href="#h25-0-527" id="h25-0-527" class="d">-            Schedule::print_log(&amp;mut f, &amp;self.op_rx)?;
</a><a href="#h25-0-528" id="h25-0-528" class="d">-            writeln!(f)?;
</a><a href="#h25-0-529" id="h25-0-529" class="d">-            Ok(())
</a><a href="#h25-0-530" id="h25-0-530" class="i">+            Ok(output)
</a>         }
 
<a href="#h25-0-533" id="h25-0-533" class="d">-        /// Prints the results of a scan to the golden file.
</a><a href="#h25-0-534" id="h25-0-534" class="d">-        fn print_scan(&amp;self, name: &amp;str, scan: Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-535" id="h25-0-535" class="d">-            let mut f = self.file.lock()?;
</a><a href="#h25-0-536" id="h25-0-536" class="d">-            writeln!(f, &quot;T{}: {}&quot;, self.id, name)?;
</a><a href="#h25-0-537" id="h25-0-537" class="d">-            for (key, value) in scan {
</a><a href="#h25-0-538" id="h25-0-538" class="d">-                writeln!(f, &quot;    {} = {}&quot;, debug::format_raw(&amp;key), debug::format_raw(&amp;value))?
</a><a href="#h25-0-539" id="h25-0-539" class="i">+        fn end_command(
</a><a href="#h25-0-540" id="h25-0-540" class="i">+            &amp;mut self,
</a><a href="#h25-0-541" id="h25-0-541" class="i">+            command: &amp;goldenscript::Command,
</a><a href="#h25-0-542" id="h25-0-542" class="i">+        ) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-543" id="h25-0-543" class="i">+            let mut output = String::new();
</a><a href="#h25-0-544" id="h25-0-544" class="i">+
</a><a href="#h25-0-545" id="h25-0-545" class="i">+            // Output engine operations, if requested. Otherwise, drain them.
</a><a href="#h25-0-546" id="h25-0-546" class="i">+            let show_ops = command.tags.contains(&amp;&quot;ops&quot;.to_string());
</a><a href="#h25-0-547" id="h25-0-547" class="i">+            while let Ok(op) = self.op_rx.try_recv() {
</a><a href="#h25-0-548" id="h25-0-548" class="i">+                if !show_ops {
</a><a href="#h25-0-549" id="h25-0-549" class="i">+                    continue;
</a><a href="#h25-0-550" id="h25-0-550" class="i">+                }
</a><a href="#h25-0-551" id="h25-0-551" class="i">+                match op {
</a><a href="#h25-0-552" id="h25-0-552" class="i">+                    Operation::Delete { key } =&gt; {
</a><a href="#h25-0-553" id="h25-0-553" class="i">+                        let (fkey, _) = debug::format_key_value(&amp;key, &amp;None);
</a><a href="#h25-0-554" id="h25-0-554" class="i">+                        writeln!(output, &quot;engine delete {fkey}&quot;)?
</a><a href="#h25-0-555" id="h25-0-555" class="i">+                    }
</a><a href="#h25-0-556" id="h25-0-556" class="i">+                    Operation::Flush =&gt; writeln!(output, &quot;engine flush&quot;)?,
</a><a href="#h25-0-557" id="h25-0-557" class="i">+                    Operation::Set { key, value } =&gt; {
</a><a href="#h25-0-558" id="h25-0-558" class="i">+                        let (fkey, fvalue) = debug::format_key_value(&amp;key, &amp;Some(value));
</a><a href="#h25-0-559" id="h25-0-559" class="i">+                        writeln!(output, &quot;engine set {} → {}&quot;, fkey, fvalue.unwrap())?
</a><a href="#h25-0-560" id="h25-0-560" class="i">+                    }
</a><a href="#h25-0-561" id="h25-0-561" class="i">+                }
</a>             }
<a href="#h25-0-563" id="h25-0-563" class="d">-            writeln!(f)?;
</a><a href="#h25-0-564" id="h25-0-564" class="d">-            Ok(())
</a><a href="#h25-0-565" id="h25-0-565" class="i">+            Ok(output)
</a>         }
     }
 
<a href="#h25-0-569" id="h25-0-569" class="d">-    /// Asserts that a scan yields the expected result.
</a><a href="#h25-0-570" id="h25-0-570" class="d">-    macro_rules! assert_scan {
</a><a href="#h25-0-571" id="h25-0-571" class="d">-        ( $scan:expr =&gt; { $( $key:expr =&gt; $value:expr),* $(,)? } ) =&gt; {
</a><a href="#h25-0-572" id="h25-0-572" class="d">-            let result = $scan.to_vec()?;
</a><a href="#h25-0-573" id="h25-0-573" class="d">-            let expect = vec![
</a><a href="#h25-0-574" id="h25-0-574" class="d">-                $( ($key.to_vec(), $value.to_vec()), )*
</a><a href="#h25-0-575" id="h25-0-575" class="d">-            ];
</a><a href="#h25-0-576" id="h25-0-576" class="d">-            assert_eq!(result, expect);
</a><a href="#h25-0-577" id="h25-0-577" class="d">-        };
</a><a href="#h25-0-578" id="h25-0-578" class="d">-    }
</a><a href="#h25-0-579" id="h25-0-579" class="i">+    impl MVCCRunner {
</a><a href="#h25-0-580" id="h25-0-580" class="i">+        fn new() -&gt; Self {
</a><a href="#h25-0-581" id="h25-0-581" class="i">+            // Use both a BitCask and a Memory engine, and mirror operations
</a><a href="#h25-0-582" id="h25-0-582" class="i">+            // across them. Emit engine operations to op_rx.
</a><a href="#h25-0-583" id="h25-0-583" class="i">+            let (op_tx, op_rx) = crossbeam::channel::unbounded();
</a><a href="#h25-0-584" id="h25-0-584" class="i">+            let tempdir = tempfile::TempDir::with_prefix(&quot;toydb&quot;).expect(&quot;tempdir failed&quot;);
</a><a href="#h25-0-585" id="h25-0-585" class="i">+            let bitcask = BitCask::new(tempdir.path().join(&quot;bitcask&quot;)).expect(&quot;bitcask failed&quot;);
</a><a href="#h25-0-586" id="h25-0-586" class="i">+            let memory = Memory::new();
</a><a href="#h25-0-587" id="h25-0-587" class="i">+            let engine = Emit::new(Mirror::new(bitcask, memory), op_tx);
</a><a href="#h25-0-588" id="h25-0-588" class="i">+            let mvcc = MVCC::new(engine);
</a><a href="#h25-0-589" id="h25-0-589" class="i">+            Self { mvcc, op_rx, txns: HashMap::new(), tempdir }
</a><a href="#h25-0-590" id="h25-0-590" class="i">+        }
</a> 
<a href="#h25-0-592" id="h25-0-592" class="d">-    // Asserts scan invariants.
</a><a href="#h25-0-593" id="h25-0-593" class="d">-    #[track_caller]
</a><a href="#h25-0-594" id="h25-0-594" class="d">-    fn assert_scan_invariants(scan: &amp;mut Scan&lt;Emit&lt;Memory&gt;&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-595" id="h25-0-595" class="d">-        // Iterator and vec should yield same results.
</a><a href="#h25-0-596" id="h25-0-596" class="d">-        let result = scan.to_vec()?;
</a><a href="#h25-0-597" id="h25-0-597" class="d">-        assert_eq!(scan.iter().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?, result);
</a><a href="#h25-0-598" id="h25-0-598" class="d">-
</a><a href="#h25-0-599" id="h25-0-599" class="d">-        // Forward and reverse scans should give the same results.
</a><a href="#h25-0-600" id="h25-0-600" class="d">-        let mut forward = result.clone();
</a><a href="#h25-0-601" id="h25-0-601" class="d">-        forward.reverse();
</a><a href="#h25-0-602" id="h25-0-602" class="d">-        let reverse = scan.iter().rev().collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h25-0-603" id="h25-0-603" class="d">-        assert_eq!(reverse, forward);
</a><a href="#h25-0-604" id="h25-0-604" class="d">-
</a><a href="#h25-0-605" id="h25-0-605" class="d">-        // Alternating next/next_back calls should give the same results.
</a><a href="#h25-0-606" id="h25-0-606" class="d">-        let mut forward = Vec::new();
</a><a href="#h25-0-607" id="h25-0-607" class="d">-        let mut reverse = Vec::new();
</a><a href="#h25-0-608" id="h25-0-608" class="d">-        let mut iter = scan.iter();
</a><a href="#h25-0-609" id="h25-0-609" class="d">-        while let Some(b) = iter.next().transpose()? {
</a><a href="#h25-0-610" id="h25-0-610" class="d">-            forward.push(b);
</a><a href="#h25-0-611" id="h25-0-611" class="d">-            if let Some(b) = iter.next_back().transpose()? {
</a><a href="#h25-0-612" id="h25-0-612" class="d">-                reverse.push(b);
</a><a href="#h25-0-613" id="h25-0-613" class="i">+        /// Decodes a raw byte vector from a Unicode string. Code points in the
</a><a href="#h25-0-614" id="h25-0-614" class="i">+        /// range U+0080 to U+00FF are converted back to bytes 0x80 to 0xff.
</a><a href="#h25-0-615" id="h25-0-615" class="i">+        /// This allows using e.g. \xff in the input string literal, and getting
</a><a href="#h25-0-616" id="h25-0-616" class="i">+        /// back a 0xff byte in the byte vector. Otherwise, char(0xff) yields
</a><a href="#h25-0-617" id="h25-0-617" class="i">+        /// the UTF-8 bytes 0xc3bf, which is the U+00FF code point as UTF-8.
</a><a href="#h25-0-618" id="h25-0-618" class="i">+        /// These characters are effectively represented as ISO-8859-1 rather
</a><a href="#h25-0-619" id="h25-0-619" class="i">+        /// than UTF-8, but it allows precise use of the entire u8 value range.
</a><a href="#h25-0-620" id="h25-0-620" class="i">+        ///
</a><a href="#h25-0-621" id="h25-0-621" class="i">+        /// TODO: share this with engine::test::Runner.
</a><a href="#h25-0-622" id="h25-0-622" class="i">+        pub fn decode_binary(s: &amp;str) -&gt; Vec&lt;u8&gt; {
</a><a href="#h25-0-623" id="h25-0-623" class="i">+            let mut buf = [0; 4];
</a><a href="#h25-0-624" id="h25-0-624" class="i">+            let mut bytes = Vec::new();
</a><a href="#h25-0-625" id="h25-0-625" class="i">+            for c in s.chars() {
</a><a href="#h25-0-626" id="h25-0-626" class="i">+                // u32 is the Unicode code point, not the UTF-8 encoding.
</a><a href="#h25-0-627" id="h25-0-627" class="i">+                match c as u32 {
</a><a href="#h25-0-628" id="h25-0-628" class="i">+                    b @ 0x80..=0xff =&gt; bytes.push(b as u8),
</a><a href="#h25-0-629" id="h25-0-629" class="i">+                    _ =&gt; bytes.extend(c.encode_utf8(&amp;mut buf).as_bytes()),
</a><a href="#h25-0-630" id="h25-0-630" class="i">+                }
</a>             }
<a href="#h25-0-632" id="h25-0-632" class="i">+            bytes
</a>         }
<a href="#h25-0-634" id="h25-0-634" class="d">-        reverse.reverse();
</a><a href="#h25-0-635" id="h25-0-635" class="d">-        forward.extend_from_slice(&amp;reverse);
</a><a href="#h25-0-636" id="h25-0-636" class="d">-        assert_eq!(forward, result);
</a> 
<a href="#h25-0-638" id="h25-0-638" class="d">-        Ok(())
</a><a href="#h25-0-639" id="h25-0-639" class="d">-    }
</a><a href="#h25-0-640" id="h25-0-640" class="d">-
</a><a href="#h25-0-641" id="h25-0-641" class="d">-    #[test]
</a><a href="#h25-0-642" id="h25-0-642" class="d">-    /// Tests that key prefixes are actually prefixes of keys.
</a><a href="#h25-0-643" id="h25-0-643" class="d">-    fn key_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-644" id="h25-0-644" class="d">-        let cases = vec![
</a><a href="#h25-0-645" id="h25-0-645" class="d">-            (KeyPrefix::NextVersion, Key::NextVersion),
</a><a href="#h25-0-646" id="h25-0-646" class="d">-            (KeyPrefix::TxnActive, Key::TxnActive(1)),
</a><a href="#h25-0-647" id="h25-0-647" class="d">-            (KeyPrefix::TxnActiveSnapshot, Key::TxnActiveSnapshot(1)),
</a><a href="#h25-0-648" id="h25-0-648" class="d">-            (KeyPrefix::TxnWrite(1), Key::TxnWrite(1, b&quot;foo&quot;.as_slice().into())),
</a><a href="#h25-0-649" id="h25-0-649" class="d">-            (
</a><a href="#h25-0-650" id="h25-0-650" class="d">-                KeyPrefix::Version(b&quot;foo&quot;.as_slice().into()),
</a><a href="#h25-0-651" id="h25-0-651" class="d">-                Key::Version(b&quot;foo&quot;.as_slice().into(), 1),
</a><a href="#h25-0-652" id="h25-0-652" class="d">-            ),
</a><a href="#h25-0-653" id="h25-0-653" class="d">-            (KeyPrefix::Unversioned, Key::Unversioned(b&quot;foo&quot;.as_slice().into())),
</a><a href="#h25-0-654" id="h25-0-654" class="d">-        ];
</a><a href="#h25-0-655" id="h25-0-655" class="d">-
</a><a href="#h25-0-656" id="h25-0-656" class="d">-        for (prefix, key) in cases {
</a><a href="#h25-0-657" id="h25-0-657" class="d">-            let prefix = prefix.encode();
</a><a href="#h25-0-658" id="h25-0-658" class="d">-            let key = key.encode();
</a><a href="#h25-0-659" id="h25-0-659" class="d">-            assert_eq!(prefix, key[..prefix.len()])
</a><a href="#h25-0-660" id="h25-0-660" class="i">+        /// Formats a raw binary byte vector, escaping special characters.
</a><a href="#h25-0-661" id="h25-0-661" class="i">+        /// TODO: find a better way to manage and share formatting functions.
</a><a href="#h25-0-662" id="h25-0-662" class="i">+        fn format_bytes(bytes: &amp;[u8]) -&gt; String {
</a><a href="#h25-0-663" id="h25-0-663" class="i">+            let b: Vec&lt;u8&gt; = bytes.iter().copied().flat_map(std::ascii::escape_default).collect();
</a><a href="#h25-0-664" id="h25-0-664" class="i">+            String::from_utf8_lossy(&amp;b).to_string()
</a>         }
<a href="#h25-0-666" id="h25-0-666" class="d">-        Ok(())
</a><a href="#h25-0-667" id="h25-0-667" class="d">-    }
</a><a href="#h25-0-668" id="h25-0-668" class="d">-
</a><a href="#h25-0-669" id="h25-0-669" class="d">-    #[test]
</a><a href="#h25-0-670" id="h25-0-670" class="d">-    /// Begin should create txns with new versions and current active sets.
</a><a href="#h25-0-671" id="h25-0-671" class="d">-    fn begin() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-672" id="h25-0-672" class="d">-        let mut mvcc = Schedule::new(&quot;begin&quot;)?;
</a><a href="#h25-0-673" id="h25-0-673" class="d">-
</a><a href="#h25-0-674" id="h25-0-674" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-675" id="h25-0-675" class="d">-        assert_eq!(
</a><a href="#h25-0-676" id="h25-0-676" class="d">-            t1.state(),
</a><a href="#h25-0-677" id="h25-0-677" class="d">-            TransactionState { version: 1, read_only: false, active: HashSet::new() }
</a><a href="#h25-0-678" id="h25-0-678" class="d">-        );
</a><a href="#h25-0-679" id="h25-0-679" class="d">-
</a><a href="#h25-0-680" id="h25-0-680" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-681" id="h25-0-681" class="d">-        assert_eq!(
</a><a href="#h25-0-682" id="h25-0-682" class="d">-            t2.state(),
</a><a href="#h25-0-683" id="h25-0-683" class="d">-            TransactionState { version: 2, read_only: false, active: HashSet::from([1]) }
</a><a href="#h25-0-684" id="h25-0-684" class="d">-        );
</a><a href="#h25-0-685" id="h25-0-685" class="d">-
</a><a href="#h25-0-686" id="h25-0-686" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-687" id="h25-0-687" class="d">-        assert_eq!(
</a><a href="#h25-0-688" id="h25-0-688" class="d">-            t3.state(),
</a><a href="#h25-0-689" id="h25-0-689" class="d">-            TransactionState { version: 3, read_only: false, active: HashSet::from([1, 2]) }
</a><a href="#h25-0-690" id="h25-0-690" class="d">-        );
</a><a href="#h25-0-691" id="h25-0-691" class="d">-
</a><a href="#h25-0-692" id="h25-0-692" class="d">-        t2.commit()?; // commit to remove from active set
</a><a href="#h25-0-693" id="h25-0-693" class="d">-
</a><a href="#h25-0-694" id="h25-0-694" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-695" id="h25-0-695" class="d">-        assert_eq!(
</a><a href="#h25-0-696" id="h25-0-696" class="d">-            t4.state(),
</a><a href="#h25-0-697" id="h25-0-697" class="d">-            TransactionState { version: 4, read_only: false, active: HashSet::from([1, 3]) }
</a><a href="#h25-0-698" id="h25-0-698" class="d">-        );
</a><a href="#h25-0-699" id="h25-0-699" class="d">-
</a><a href="#h25-0-700" id="h25-0-700" class="d">-        Ok(())
</a><a href="#h25-0-701" id="h25-0-701" class="d">-    }
</a><a href="#h25-0-702" id="h25-0-702" class="d">-
</a><a href="#h25-0-703" id="h25-0-703" class="d">-    #[test]
</a><a href="#h25-0-704" id="h25-0-704" class="d">-    /// Begin read-only should not create a new version, instead using the
</a><a href="#h25-0-705" id="h25-0-705" class="d">-    /// next one, but it should use the current active set.
</a><a href="#h25-0-706" id="h25-0-706" class="d">-    fn begin_read_only() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-707" id="h25-0-707" class="d">-        let mut mvcc = Schedule::new(&quot;begin_read_only&quot;)?;
</a><a href="#h25-0-708" id="h25-0-708" class="d">-
</a><a href="#h25-0-709" id="h25-0-709" class="d">-        // Start an initial read-only transaction, and make sure it&#39;s actually
</a><a href="#h25-0-710" id="h25-0-710" class="d">-        // read-only.
</a><a href="#h25-0-711" id="h25-0-711" class="d">-        let t1 = mvcc.begin_read_only()?;
</a><a href="#h25-0-712" id="h25-0-712" class="d">-        assert_eq!(
</a><a href="#h25-0-713" id="h25-0-713" class="d">-            t1.state(),
</a><a href="#h25-0-714" id="h25-0-714" class="d">-            TransactionState { version: 1, read_only: true, active: HashSet::new() }
</a><a href="#h25-0-715" id="h25-0-715" class="d">-        );
</a><a href="#h25-0-716" id="h25-0-716" class="d">-        assert_eq!(t1.set(b&quot;foo&quot;, vec![1]), Err(Error::ReadOnly));
</a><a href="#h25-0-717" id="h25-0-717" class="d">-        assert_eq!(t1.delete(b&quot;foo&quot;), Err(Error::ReadOnly));
</a><a href="#h25-0-718" id="h25-0-718" class="d">-
</a><a href="#h25-0-719" id="h25-0-719" class="d">-        // Start a new read-write transaction, then another read-only
</a><a href="#h25-0-720" id="h25-0-720" class="d">-        // transaction which should have it in its active set. t1 should not be
</a><a href="#h25-0-721" id="h25-0-721" class="d">-        // in the active set, because it&#39;s read-only.
</a><a href="#h25-0-722" id="h25-0-722" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-723" id="h25-0-723" class="d">-        assert_eq!(
</a><a href="#h25-0-724" id="h25-0-724" class="d">-            t2.state(),
</a><a href="#h25-0-725" id="h25-0-725" class="d">-            TransactionState { version: 1, read_only: false, active: HashSet::new() }
</a><a href="#h25-0-726" id="h25-0-726" class="d">-        );
</a><a href="#h25-0-727" id="h25-0-727" class="d">-
</a><a href="#h25-0-728" id="h25-0-728" class="d">-        let t3 = mvcc.begin_read_only()?;
</a><a href="#h25-0-729" id="h25-0-729" class="d">-        assert_eq!(
</a><a href="#h25-0-730" id="h25-0-730" class="d">-            t3.state(),
</a><a href="#h25-0-731" id="h25-0-731" class="d">-            TransactionState { version: 2, read_only: true, active: HashSet::from([1]) }
</a><a href="#h25-0-732" id="h25-0-732" class="d">-        );
</a><a href="#h25-0-733" id="h25-0-733" class="d">-
</a><a href="#h25-0-734" id="h25-0-734" class="d">-        Ok(())
</a><a href="#h25-0-735" id="h25-0-735" class="d">-    }
</a><a href="#h25-0-736" id="h25-0-736" class="d">-
</a><a href="#h25-0-737" id="h25-0-737" class="d">-    #[test]
</a><a href="#h25-0-738" id="h25-0-738" class="d">-    /// Begin as of should provide a read-only view of a historical version.
</a><a href="#h25-0-739" id="h25-0-739" class="d">-    fn begin_as_of() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-740" id="h25-0-740" class="d">-        let mut mvcc = Schedule::new(&quot;begin_as_of&quot;)?;
</a><a href="#h25-0-741" id="h25-0-741" class="d">-
</a><a href="#h25-0-742" id="h25-0-742" class="d">-        // Start a concurrent transaction that should be invisible.
</a><a href="#h25-0-743" id="h25-0-743" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-744" id="h25-0-744" class="d">-        t1.set(b&quot;other&quot;, vec![1])?;
</a><a href="#h25-0-745" id="h25-0-745" class="d">-
</a><a href="#h25-0-746" id="h25-0-746" class="d">-        // Write a couple of versions for a key.
</a><a href="#h25-0-747" id="h25-0-747" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-748" id="h25-0-748" class="d">-        t2.set(b&quot;key&quot;, vec![2])?;
</a><a href="#h25-0-749" id="h25-0-749" class="d">-        t2.commit()?;
</a><a href="#h25-0-750" id="h25-0-750" class="d">-
</a><a href="#h25-0-751" id="h25-0-751" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-752" id="h25-0-752" class="d">-        t3.set(b&quot;key&quot;, vec![3])?;
</a><a href="#h25-0-753" id="h25-0-753" class="d">-
</a><a href="#h25-0-754" id="h25-0-754" class="d">-        // Reading as of version 3 should only see key=2, because t1 and
</a><a href="#h25-0-755" id="h25-0-755" class="d">-        // t3 haven&#39;t committed yet.
</a><a href="#h25-0-756" id="h25-0-756" class="d">-        let t4 = mvcc.begin_as_of(3)?;
</a><a href="#h25-0-757" id="h25-0-757" class="d">-        assert_eq!(
</a><a href="#h25-0-758" id="h25-0-758" class="d">-            t4.state(),
</a><a href="#h25-0-759" id="h25-0-759" class="d">-            TransactionState { version: 3, read_only: true, active: HashSet::from([1]) }
</a><a href="#h25-0-760" id="h25-0-760" class="d">-        );
</a><a href="#h25-0-761" id="h25-0-761" class="d">-        assert_scan!(t4.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a><a href="#h25-0-762" id="h25-0-762" class="d">-
</a><a href="#h25-0-763" id="h25-0-763" class="d">-        // Writes should error.
</a><a href="#h25-0-764" id="h25-0-764" class="d">-        assert_eq!(t4.set(b&quot;foo&quot;, vec![1]), Err(Error::ReadOnly));
</a><a href="#h25-0-765" id="h25-0-765" class="d">-        assert_eq!(t4.delete(b&quot;foo&quot;), Err(Error::ReadOnly));
</a><a href="#h25-0-766" id="h25-0-766" class="d">-
</a><a href="#h25-0-767" id="h25-0-767" class="d">-        // Once we commit t1 and t3, neither the existing as of transaction nor
</a><a href="#h25-0-768" id="h25-0-768" class="d">-        // a new one should see their writes, since versions must be stable.
</a><a href="#h25-0-769" id="h25-0-769" class="d">-        t1.commit()?;
</a><a href="#h25-0-770" id="h25-0-770" class="d">-        t3.commit()?;
</a><a href="#h25-0-771" id="h25-0-771" class="d">-
</a><a href="#h25-0-772" id="h25-0-772" class="d">-        assert_scan!(t4.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a><a href="#h25-0-773" id="h25-0-773" class="d">-
</a><a href="#h25-0-774" id="h25-0-774" class="d">-        let t5 = mvcc.begin_as_of(3)?;
</a><a href="#h25-0-775" id="h25-0-775" class="d">-        assert_scan!(t5.scan(..)? =&gt; {b&quot;key&quot; =&gt; [2]});
</a><a href="#h25-0-776" id="h25-0-776" class="d">-
</a><a href="#h25-0-777" id="h25-0-777" class="d">-        // Rolling back and committing read-only transactions is noops.
</a><a href="#h25-0-778" id="h25-0-778" class="d">-        t4.rollback()?;
</a><a href="#h25-0-779" id="h25-0-779" class="d">-        t5.commit()?;
</a><a href="#h25-0-780" id="h25-0-780" class="d">-
</a><a href="#h25-0-781" id="h25-0-781" class="d">-        // Commit a new value.
</a><a href="#h25-0-782" id="h25-0-782" class="d">-        let t6 = mvcc.begin()?;
</a><a href="#h25-0-783" id="h25-0-783" class="d">-        t6.set(b&quot;key&quot;, vec![4])?;
</a><a href="#h25-0-784" id="h25-0-784" class="d">-        t6.commit()?;
</a><a href="#h25-0-785" id="h25-0-785" class="d">-
</a><a href="#h25-0-786" id="h25-0-786" class="d">-        // A snapshot as of version 4 should see key=3 and other=1.
</a><a href="#h25-0-787" id="h25-0-787" class="d">-        let t7 = mvcc.begin_as_of(4)?;
</a><a href="#h25-0-788" id="h25-0-788" class="d">-        assert_eq!(
</a><a href="#h25-0-789" id="h25-0-789" class="d">-            t7.state(),
</a><a href="#h25-0-790" id="h25-0-790" class="d">-            TransactionState { version: 4, read_only: true, active: HashSet::new() }
</a><a href="#h25-0-791" id="h25-0-791" class="d">-        );
</a><a href="#h25-0-792" id="h25-0-792" class="d">-        assert_scan!(t7.scan(..)? =&gt; {b&quot;key&quot; =&gt; [3], b&quot;other&quot; =&gt; [1]});
</a><a href="#h25-0-793" id="h25-0-793" class="d">-
</a><a href="#h25-0-794" id="h25-0-794" class="d">-        // Check that future versions are invalid, including the next.
</a><a href="#h25-0-795" id="h25-0-795" class="d">-        assert_eq!(
</a><a href="#h25-0-796" id="h25-0-796" class="d">-            mvcc.begin_as_of(5).err(),
</a><a href="#h25-0-797" id="h25-0-797" class="d">-            Some(Error::InvalidInput(&quot;version 5 does not exist&quot;.into()))
</a><a href="#h25-0-798" id="h25-0-798" class="d">-        );
</a><a href="#h25-0-799" id="h25-0-799" class="d">-        assert_eq!(
</a><a href="#h25-0-800" id="h25-0-800" class="d">-            mvcc.begin_as_of(9).err(),
</a><a href="#h25-0-801" id="h25-0-801" class="d">-            Some(Error::InvalidInput(&quot;version 9 does not exist&quot;.into()))
</a><a href="#h25-0-802" id="h25-0-802" class="d">-        );
</a><a href="#h25-0-803" id="h25-0-803" class="d">-
</a><a href="#h25-0-804" id="h25-0-804" class="d">-        Ok(())
</a><a href="#h25-0-805" id="h25-0-805" class="d">-    }
</a><a href="#h25-0-806" id="h25-0-806" class="d">-
</a><a href="#h25-0-807" id="h25-0-807" class="d">-    #[test]
</a><a href="#h25-0-808" id="h25-0-808" class="d">-    /// Resume should resume a transaction with the same state.
</a><a href="#h25-0-809" id="h25-0-809" class="d">-    fn resume() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-810" id="h25-0-810" class="d">-        let mut mvcc = Schedule::new(&quot;resume&quot;)?;
</a><a href="#h25-0-811" id="h25-0-811" class="d">-
</a><a href="#h25-0-812" id="h25-0-812" class="d">-        // We first write a set of values that should be visible.
</a><a href="#h25-0-813" id="h25-0-813" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-814" id="h25-0-814" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-815" id="h25-0-815" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-816" id="h25-0-816" class="d">-        t1.commit()?;
</a><a href="#h25-0-817" id="h25-0-817" class="d">-
</a><a href="#h25-0-818" id="h25-0-818" class="d">-        // We then start three transactions, of which we will resume t3.
</a><a href="#h25-0-819" id="h25-0-819" class="d">-        // We commit t2 and t4&#39;s changes, which should not be visible,
</a><a href="#h25-0-820" id="h25-0-820" class="d">-        // and write a change for t3 which should be visible.
</a><a href="#h25-0-821" id="h25-0-821" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-822" id="h25-0-822" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-823" id="h25-0-823" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-824" id="h25-0-824" class="d">-
</a><a href="#h25-0-825" id="h25-0-825" class="d">-        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h25-0-826" id="h25-0-826" class="d">-        t3.set(b&quot;b&quot;, vec![3])?;
</a><a href="#h25-0-827" id="h25-0-827" class="d">-        t4.set(b&quot;c&quot;, vec![4])?;
</a><a href="#h25-0-828" id="h25-0-828" class="d">-
</a><a href="#h25-0-829" id="h25-0-829" class="d">-        t2.commit()?;
</a><a href="#h25-0-830" id="h25-0-830" class="d">-        t4.commit()?;
</a><a href="#h25-0-831" id="h25-0-831" class="d">-
</a><a href="#h25-0-832" id="h25-0-832" class="d">-        // We now resume t3, who should only see its own changes.
</a><a href="#h25-0-833" id="h25-0-833" class="d">-        let state = t3.state().clone();
</a><a href="#h25-0-834" id="h25-0-834" class="d">-        assert_eq!(
</a><a href="#h25-0-835" id="h25-0-835" class="d">-            state,
</a><a href="#h25-0-836" id="h25-0-836" class="d">-            TransactionState { version: 3, read_only: false, active: HashSet::from([2]) }
</a><a href="#h25-0-837" id="h25-0-837" class="d">-        );
</a><a href="#h25-0-838" id="h25-0-838" class="d">-        drop(t3);
</a><a href="#h25-0-839" id="h25-0-839" class="d">-
</a><a href="#h25-0-840" id="h25-0-840" class="d">-        let t5 = mvcc.resume(state.clone())?;
</a><a href="#h25-0-841" id="h25-0-841" class="d">-        assert_eq!(t5.state(), state);
</a><a href="#h25-0-842" id="h25-0-842" class="d">-
</a><a href="#h25-0-843" id="h25-0-843" class="d">-        assert_scan!(t5.scan(..)? =&gt; {
</a><a href="#h25-0-844" id="h25-0-844" class="d">-            b&quot;a&quot; =&gt; [1],
</a><a href="#h25-0-845" id="h25-0-845" class="d">-            b&quot;b&quot; =&gt; [3],
</a><a href="#h25-0-846" id="h25-0-846" class="d">-        });
</a><a href="#h25-0-847" id="h25-0-847" class="d">-
</a><a href="#h25-0-848" id="h25-0-848" class="d">-        // A separate transaction should not see t3&#39;s changes.
</a><a href="#h25-0-849" id="h25-0-849" class="d">-        let t6 = mvcc.begin()?;
</a><a href="#h25-0-850" id="h25-0-850" class="d">-        assert_scan!(t6.scan(..)? =&gt; {
</a><a href="#h25-0-851" id="h25-0-851" class="d">-            b&quot;a&quot; =&gt; [2],
</a><a href="#h25-0-852" id="h25-0-852" class="d">-            b&quot;b&quot; =&gt; [1], // not 3
</a><a href="#h25-0-853" id="h25-0-853" class="d">-            b&quot;c&quot; =&gt; [4],
</a><a href="#h25-0-854" id="h25-0-854" class="d">-        });
</a><a href="#h25-0-855" id="h25-0-855" class="d">-        t6.rollback()?;
</a><a href="#h25-0-856" id="h25-0-856" class="d">-
</a><a href="#h25-0-857" id="h25-0-857" class="d">-        // Once t5 commits, a separate transaction should see its changes.
</a><a href="#h25-0-858" id="h25-0-858" class="d">-        t5.commit()?;
</a><a href="#h25-0-859" id="h25-0-859" class="d">-
</a><a href="#h25-0-860" id="h25-0-860" class="d">-        let t7 = mvcc.begin()?;
</a><a href="#h25-0-861" id="h25-0-861" class="d">-        assert_scan!(t7.scan(..)? =&gt; {
</a><a href="#h25-0-862" id="h25-0-862" class="d">-            b&quot;a&quot; =&gt; [2],
</a><a href="#h25-0-863" id="h25-0-863" class="d">-            b&quot;b&quot; =&gt; [3], // now 3
</a><a href="#h25-0-864" id="h25-0-864" class="d">-            b&quot;c&quot; =&gt; [4],
</a><a href="#h25-0-865" id="h25-0-865" class="d">-        });
</a><a href="#h25-0-866" id="h25-0-866" class="d">-        t7.rollback()?;
</a><a href="#h25-0-867" id="h25-0-867" class="d">-
</a><a href="#h25-0-868" id="h25-0-868" class="d">-        // Resuming an inactive transaction should error.
</a><a href="#h25-0-869" id="h25-0-869" class="d">-        assert_eq!(
</a><a href="#h25-0-870" id="h25-0-870" class="d">-            mvcc.resume(state).err(),
</a><a href="#h25-0-871" id="h25-0-871" class="d">-            Some(Error::InvalidInput(&quot;no active transaction at version 3&quot;.into()))
</a><a href="#h25-0-872" id="h25-0-872" class="d">-        );
</a><a href="#h25-0-873" id="h25-0-873" class="d">-
</a><a href="#h25-0-874" id="h25-0-874" class="d">-        // It should also be possible to start a snapshot transaction in t3
</a><a href="#h25-0-875" id="h25-0-875" class="d">-        // and resume it. It should not see t3&#39;s writes, nor t2&#39;s.
</a><a href="#h25-0-876" id="h25-0-876" class="d">-        let t8 = mvcc.begin_as_of(3)?;
</a><a href="#h25-0-877" id="h25-0-877" class="d">-        assert_eq!(
</a><a href="#h25-0-878" id="h25-0-878" class="d">-            t8.state(),
</a><a href="#h25-0-879" id="h25-0-879" class="d">-            TransactionState { version: 3, read_only: true, active: HashSet::from([2]) }
</a><a href="#h25-0-880" id="h25-0-880" class="d">-        );
</a><a href="#h25-0-881" id="h25-0-881" class="d">-
</a><a href="#h25-0-882" id="h25-0-882" class="d">-        assert_scan!(t8.scan(..)? =&gt; {
</a><a href="#h25-0-883" id="h25-0-883" class="d">-            b&quot;a&quot; =&gt; [1],
</a><a href="#h25-0-884" id="h25-0-884" class="d">-            b&quot;b&quot; =&gt; [1],
</a><a href="#h25-0-885" id="h25-0-885" class="d">-        });
</a><a href="#h25-0-886" id="h25-0-886" class="d">-
</a><a href="#h25-0-887" id="h25-0-887" class="d">-        let state = t8.state().clone();
</a><a href="#h25-0-888" id="h25-0-888" class="d">-        drop(t8);
</a><a href="#h25-0-889" id="h25-0-889" class="d">-
</a><a href="#h25-0-890" id="h25-0-890" class="d">-        let t9 = mvcc.resume(state.clone())?;
</a><a href="#h25-0-891" id="h25-0-891" class="d">-        assert_eq!(t9.state(), state);
</a><a href="#h25-0-892" id="h25-0-892" class="d">-        assert_scan!(t9.scan(..)? =&gt; {
</a><a href="#h25-0-893" id="h25-0-893" class="d">-            b&quot;a&quot; =&gt; [1],
</a><a href="#h25-0-894" id="h25-0-894" class="d">-            b&quot;b&quot; =&gt; [1],
</a><a href="#h25-0-895" id="h25-0-895" class="d">-        });
</a><a href="#h25-0-896" id="h25-0-896" class="d">-
</a><a href="#h25-0-897" id="h25-0-897" class="d">-        Ok(())
</a><a href="#h25-0-898" id="h25-0-898" class="d">-    }
</a><a href="#h25-0-899" id="h25-0-899" class="d">-
</a><a href="#h25-0-900" id="h25-0-900" class="d">-    #[test]
</a><a href="#h25-0-901" id="h25-0-901" class="d">-    /// Deletes should work on both existing, missing, and deleted keys, be
</a><a href="#h25-0-902" id="h25-0-902" class="d">-    /// idempotent.
</a><a href="#h25-0-903" id="h25-0-903" class="d">-    fn delete() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-904" id="h25-0-904" class="d">-        let mut mvcc = Schedule::new(&quot;delete&quot;)?;
</a><a href="#h25-0-905" id="h25-0-905" class="d">-        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[1])), (b&quot;tombstone&quot;, 1, None)])?;
</a><a href="#h25-0-906" id="h25-0-906" class="d">-
</a><a href="#h25-0-907" id="h25-0-907" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-908" id="h25-0-908" class="d">-        t1.set(b&quot;key&quot;, vec![2])?;
</a><a href="#h25-0-909" id="h25-0-909" class="d">-        t1.delete(b&quot;key&quot;)?; // delete uncommitted version
</a><a href="#h25-0-910" id="h25-0-910" class="d">-        t1.delete(b&quot;key&quot;)?; // idempotent
</a><a href="#h25-0-911" id="h25-0-911" class="d">-        t1.delete(b&quot;tombstone&quot;)?;
</a><a href="#h25-0-912" id="h25-0-912" class="d">-        t1.delete(b&quot;missing&quot;)?;
</a><a href="#h25-0-913" id="h25-0-913" class="d">-        t1.commit()?;
</a><a href="#h25-0-914" id="h25-0-914" class="d">-
</a><a href="#h25-0-915" id="h25-0-915" class="d">-        Ok(())
</a><a href="#h25-0-916" id="h25-0-916" class="d">-    }
</a><a href="#h25-0-917" id="h25-0-917" class="d">-
</a><a href="#h25-0-918" id="h25-0-918" class="d">-    #[test]
</a><a href="#h25-0-919" id="h25-0-919" class="d">-    /// Delete should return serialization errors both for uncommitted versions
</a><a href="#h25-0-920" id="h25-0-920" class="d">-    /// (past and future), and future committed versions.
</a><a href="#h25-0-921" id="h25-0-921" class="d">-    fn delete_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-922" id="h25-0-922" class="d">-        let mut mvcc = Schedule::new(&quot;delete_conflict&quot;)?;
</a><a href="#h25-0-923" id="h25-0-923" class="d">-
</a><a href="#h25-0-924" id="h25-0-924" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-925" id="h25-0-925" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-926" id="h25-0-926" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-927" id="h25-0-927" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-928" id="h25-0-928" class="d">-
</a><a href="#h25-0-929" id="h25-0-929" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-930" id="h25-0-930" class="d">-        t3.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h25-0-931" id="h25-0-931" class="d">-        t4.set(b&quot;d&quot;, vec![4])?;
</a><a href="#h25-0-932" id="h25-0-932" class="d">-        t4.commit()?;
</a><a href="#h25-0-933" id="h25-0-933" class="d">-
</a><a href="#h25-0-934" id="h25-0-934" class="d">-        assert_eq!(t2.delete(b&quot;a&quot;), Err(Error::Serialization)); // past uncommitted
</a><a href="#h25-0-935" id="h25-0-935" class="d">-        assert_eq!(t2.delete(b&quot;c&quot;), Err(Error::Serialization)); // future uncommitted
</a><a href="#h25-0-936" id="h25-0-936" class="d">-        assert_eq!(t2.delete(b&quot;d&quot;), Err(Error::Serialization)); // future committed
</a><a href="#h25-0-937" id="h25-0-937" class="d">-
</a><a href="#h25-0-938" id="h25-0-938" class="d">-        Ok(())
</a><a href="#h25-0-939" id="h25-0-939" class="d">-    }
</a><a href="#h25-0-940" id="h25-0-940" class="d">-
</a><a href="#h25-0-941" id="h25-0-941" class="d">-    #[test]
</a><a href="#h25-0-942" id="h25-0-942" class="d">-    /// Get should return the correct latest value.
</a><a href="#h25-0-943" id="h25-0-943" class="d">-    fn get() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-944" id="h25-0-944" class="d">-        let mut mvcc = Schedule::new(&quot;get&quot;)?;
</a><a href="#h25-0-945" id="h25-0-945" class="d">-        mvcc.setup(vec![
</a><a href="#h25-0-946" id="h25-0-946" class="d">-            (b&quot;key&quot;, 1, Some(&amp;[1])),
</a><a href="#h25-0-947" id="h25-0-947" class="d">-            (b&quot;updated&quot;, 1, Some(&amp;[1])),
</a><a href="#h25-0-948" id="h25-0-948" class="d">-            (b&quot;updated&quot;, 2, Some(&amp;[2])),
</a><a href="#h25-0-949" id="h25-0-949" class="d">-            (b&quot;deleted&quot;, 1, Some(&amp;[1])),
</a><a href="#h25-0-950" id="h25-0-950" class="d">-            (b&quot;deleted&quot;, 2, None),
</a><a href="#h25-0-951" id="h25-0-951" class="d">-            (b&quot;tombstone&quot;, 1, None),
</a><a href="#h25-0-952" id="h25-0-952" class="d">-        ])?;
</a><a href="#h25-0-953" id="h25-0-953" class="d">-
</a><a href="#h25-0-954" id="h25-0-954" class="d">-        let t1 = mvcc.begin_read_only()?;
</a><a href="#h25-0-955" id="h25-0-955" class="d">-        assert_eq!(t1.get(b&quot;key&quot;)?, Some(vec![1]));
</a><a href="#h25-0-956" id="h25-0-956" class="d">-        assert_eq!(t1.get(b&quot;updated&quot;)?, Some(vec![2]));
</a><a href="#h25-0-957" id="h25-0-957" class="d">-        assert_eq!(t1.get(b&quot;deleted&quot;)?, None);
</a><a href="#h25-0-958" id="h25-0-958" class="d">-        assert_eq!(t1.get(b&quot;tombstone&quot;)?, None);
</a><a href="#h25-0-959" id="h25-0-959" class="d">-
</a><a href="#h25-0-960" id="h25-0-960" class="d">-        Ok(())
</a><a href="#h25-0-961" id="h25-0-961" class="d">-    }
</a> 
<a href="#h25-0-963" id="h25-0-963" class="d">-    #[test]
</a><a href="#h25-0-964" id="h25-0-964" class="d">-    /// Get should be isolated from future and uncommitted transactions.
</a><a href="#h25-0-965" id="h25-0-965" class="d">-    fn get_isolation() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-966" id="h25-0-966" class="d">-        let mut mvcc = Schedule::new(&quot;get_isolation&quot;)?;
</a><a href="#h25-0-967" id="h25-0-967" class="d">-
</a><a href="#h25-0-968" id="h25-0-968" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-969" id="h25-0-969" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-970" id="h25-0-970" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-971" id="h25-0-971" class="d">-        t1.set(b&quot;d&quot;, vec![1])?;
</a><a href="#h25-0-972" id="h25-0-972" class="d">-        t1.set(b&quot;e&quot;, vec![1])?;
</a><a href="#h25-0-973" id="h25-0-973" class="d">-        t1.commit()?;
</a><a href="#h25-0-974" id="h25-0-974" class="d">-
</a><a href="#h25-0-975" id="h25-0-975" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-976" id="h25-0-976" class="d">-        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h25-0-977" id="h25-0-977" class="d">-        t2.delete(b&quot;b&quot;)?;
</a><a href="#h25-0-978" id="h25-0-978" class="d">-        t2.set(b&quot;c&quot;, vec![2])?;
</a><a href="#h25-0-979" id="h25-0-979" class="d">-
</a><a href="#h25-0-980" id="h25-0-980" class="d">-        let t3 = mvcc.begin_read_only()?;
</a><a href="#h25-0-981" id="h25-0-981" class="d">-
</a><a href="#h25-0-982" id="h25-0-982" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-983" id="h25-0-983" class="d">-        t4.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h25-0-984" id="h25-0-984" class="d">-        t4.delete(b&quot;e&quot;)?;
</a><a href="#h25-0-985" id="h25-0-985" class="d">-        t4.set(b&quot;f&quot;, vec![3])?;
</a><a href="#h25-0-986" id="h25-0-986" class="d">-        t4.commit()?;
</a><a href="#h25-0-987" id="h25-0-987" class="d">-
</a><a href="#h25-0-988" id="h25-0-988" class="d">-        assert_eq!(t3.get(b&quot;a&quot;)?, Some(vec![1])); // uncommitted update
</a><a href="#h25-0-989" id="h25-0-989" class="d">-        assert_eq!(t3.get(b&quot;b&quot;)?, Some(vec![1])); // uncommitted delete
</a><a href="#h25-0-990" id="h25-0-990" class="d">-        assert_eq!(t3.get(b&quot;c&quot;)?, None); // uncommitted write
</a><a href="#h25-0-991" id="h25-0-991" class="d">-        assert_eq!(t3.get(b&quot;d&quot;)?, Some(vec![1])); // future update
</a><a href="#h25-0-992" id="h25-0-992" class="d">-        assert_eq!(t3.get(b&quot;e&quot;)?, Some(vec![1])); // future delete
</a><a href="#h25-0-993" id="h25-0-993" class="d">-        assert_eq!(t3.get(b&quot;f&quot;)?, None); // future write
</a><a href="#h25-0-994" id="h25-0-994" class="d">-
</a><a href="#h25-0-995" id="h25-0-995" class="d">-        Ok(())
</a><a href="#h25-0-996" id="h25-0-996" class="d">-    }
</a><a href="#h25-0-997" id="h25-0-997" class="d">-
</a><a href="#h25-0-998" id="h25-0-998" class="d">-    #[test]
</a><a href="#h25-0-999" id="h25-0-999" class="d">-    /// Scans should use correct key and time bounds. Sets up an initial data
</a><a href="#h25-0-1000" id="h25-0-1000" class="d">-    /// set as follows, and asserts results via the golden file.
</a><a href="#h25-0-1001" id="h25-0-1001" class="d">-    ///
</a><a href="#h25-0-1002" id="h25-0-1002" class="d">-    /// T
</a><a href="#h25-0-1003" id="h25-0-1003" class="d">-    /// 4             x   ba,4
</a><a href="#h25-0-1004" id="h25-0-1004" class="d">-    /// 3   x   a,3  b,3        x
</a><a href="#h25-0-1005" id="h25-0-1005" class="d">-    /// 2        x        ba,2 bb,2 bc,2
</a><a href="#h25-0-1006" id="h25-0-1006" class="d">-    /// 1  0,1  a,1   x                  c,1
</a><a href="#h25-0-1007" id="h25-0-1007" class="d">-    ///     B    a    b    ba   bb   bc   c
</a><a href="#h25-0-1008" id="h25-0-1008" class="d">-    fn scan() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1009" id="h25-0-1009" class="d">-        let mut mvcc = Schedule::new(&quot;scan&quot;)?;
</a><a href="#h25-0-1010" id="h25-0-1010" class="d">-        mvcc.setup(vec![
</a><a href="#h25-0-1011" id="h25-0-1011" class="d">-            (b&quot;B&quot;, 1, Some(&amp;[0, 1])),
</a><a href="#h25-0-1012" id="h25-0-1012" class="d">-            (b&quot;B&quot;, 3, None),
</a><a href="#h25-0-1013" id="h25-0-1013" class="d">-            (b&quot;a&quot;, 1, Some(&amp;[0x0a, 1])),
</a><a href="#h25-0-1014" id="h25-0-1014" class="d">-            (b&quot;a&quot;, 2, None),
</a><a href="#h25-0-1015" id="h25-0-1015" class="d">-            (b&quot;a&quot;, 3, Some(&amp;[0x0a, 3])),
</a><a href="#h25-0-1016" id="h25-0-1016" class="d">-            (b&quot;b&quot;, 1, None),
</a><a href="#h25-0-1017" id="h25-0-1017" class="d">-            (b&quot;b&quot;, 3, Some(&amp;[0x0b, 3])),
</a><a href="#h25-0-1018" id="h25-0-1018" class="d">-            (b&quot;b&quot;, 4, None),
</a><a href="#h25-0-1019" id="h25-0-1019" class="d">-            (b&quot;ba&quot;, 2, Some(&amp;[0xba, 2])),
</a><a href="#h25-0-1020" id="h25-0-1020" class="d">-            (b&quot;ba&quot;, 4, Some(&amp;[0xba, 4])),
</a><a href="#h25-0-1021" id="h25-0-1021" class="d">-            (b&quot;bb&quot;, 2, Some(&amp;[0xbb, 2])),
</a><a href="#h25-0-1022" id="h25-0-1022" class="d">-            (b&quot;bb&quot;, 3, None),
</a><a href="#h25-0-1023" id="h25-0-1023" class="d">-            (b&quot;bc&quot;, 2, Some(&amp;[0xbc, 2])),
</a><a href="#h25-0-1024" id="h25-0-1024" class="d">-            (b&quot;c&quot;, 1, Some(&amp;[0x0c, 1])),
</a><a href="#h25-0-1025" id="h25-0-1025" class="d">-        ])?;
</a><a href="#h25-0-1026" id="h25-0-1026" class="d">-
</a><a href="#h25-0-1027" id="h25-0-1027" class="d">-        // Full scans at all timestamps.
</a><a href="#h25-0-1028" id="h25-0-1028" class="d">-        for version in 1..5 {
</a><a href="#h25-0-1029" id="h25-0-1029" class="d">-            let txn = match version {
</a><a href="#h25-0-1030" id="h25-0-1030" class="d">-                5 =&gt; mvcc.begin_read_only()?,
</a><a href="#h25-0-1031" id="h25-0-1031" class="d">-                v =&gt; mvcc.begin_as_of(v)?,
</a><a href="#h25-0-1032" id="h25-0-1032" class="d">-            };
</a><a href="#h25-0-1033" id="h25-0-1033" class="d">-            let mut scan = txn.scan(..)?; // see golden master
</a><a href="#h25-0-1034" id="h25-0-1034" class="d">-            assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h25-0-1035" id="h25-0-1035" class="i">+        /// Formats a key/value pair, or None if the value does not exist.
</a><a href="#h25-0-1036" id="h25-0-1036" class="i">+        /// TODO: share with engine::test::Runner.
</a><a href="#h25-0-1037" id="h25-0-1037" class="i">+        fn format_key_value(key: &amp;[u8], value: Option&lt;&amp;[u8]&gt;) -&gt; String {
</a><a href="#h25-0-1038" id="h25-0-1038" class="i">+            format!(
</a><a href="#h25-0-1039" id="h25-0-1039" class="i">+                &quot;{} → {}&quot;,
</a><a href="#h25-0-1040" id="h25-0-1040" class="i">+                Self::format_bytes(key),
</a><a href="#h25-0-1041" id="h25-0-1041" class="i">+                value.map(Self::format_bytes).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h25-0-1042" id="h25-0-1042" class="i">+            )
</a>         }
 
<a href="#h25-0-1045" id="h25-0-1045" class="d">-        // All bounded scans around ba-bc at version 3.
</a><a href="#h25-0-1046" id="h25-0-1046" class="d">-        let txn = mvcc.begin_as_of(3)?;
</a><a href="#h25-0-1047" id="h25-0-1047" class="d">-        let starts =
</a><a href="#h25-0-1048" id="h25-0-1048" class="d">-            [Bound::Unbounded, Bound::Included(b&quot;ba&quot;.to_vec()), Bound::Excluded(b&quot;ba&quot;.to_vec())];
</a><a href="#h25-0-1049" id="h25-0-1049" class="d">-        let ends =
</a><a href="#h25-0-1050" id="h25-0-1050" class="d">-            [Bound::Unbounded, Bound::Included(b&quot;bc&quot;.to_vec()), Bound::Excluded(b&quot;bc&quot;.to_vec())];
</a><a href="#h25-0-1051" id="h25-0-1051" class="d">-        for start in &amp;starts {
</a><a href="#h25-0-1052" id="h25-0-1052" class="d">-            for end in &amp;ends {
</a><a href="#h25-0-1053" id="h25-0-1053" class="d">-                let mut scan = txn.scan((start.to_owned(), end.to_owned()))?; // see golden master
</a><a href="#h25-0-1054" id="h25-0-1054" class="d">-                assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h25-0-1055" id="h25-0-1055" class="i">+        /// Parses an binary key range, using Rust range syntax.
</a><a href="#h25-0-1056" id="h25-0-1056" class="i">+        /// TODO: share with engine::test:Runner.
</a><a href="#h25-0-1057" id="h25-0-1057" class="i">+        fn parse_key_range(
</a><a href="#h25-0-1058" id="h25-0-1058" class="i">+            s: &amp;str,
</a><a href="#h25-0-1059" id="h25-0-1059" class="i">+        ) -&gt; StdResult&lt;impl std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-1060" id="h25-0-1060" class="i">+            let mut bound = (Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded, Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded);
</a><a href="#h25-0-1061" id="h25-0-1061" class="i">+            let re = Regex::new(r&quot;^(\S+)?\.\.(=)?(\S+)?&quot;).expect(&quot;invalid regex&quot;);
</a><a href="#h25-0-1062" id="h25-0-1062" class="i">+            let groups = re.captures(s).ok_or_else(|| format!(&quot;invalid range {s}&quot;))?;
</a><a href="#h25-0-1063" id="h25-0-1063" class="i">+            if let Some(start) = groups.get(1) {
</a><a href="#h25-0-1064" id="h25-0-1064" class="i">+                bound.0 = Bound::Included(Self::decode_binary(start.as_str()));
</a>             }
<a href="#h25-0-1066" id="h25-0-1066" class="i">+            if let Some(end) = groups.get(3) {
</a><a href="#h25-0-1067" id="h25-0-1067" class="i">+                let end = Self::decode_binary(end.as_str());
</a><a href="#h25-0-1068" id="h25-0-1068" class="i">+                if groups.get(2).is_some() {
</a><a href="#h25-0-1069" id="h25-0-1069" class="i">+                    bound.1 = Bound::Included(end)
</a><a href="#h25-0-1070" id="h25-0-1070" class="i">+                } else {
</a><a href="#h25-0-1071" id="h25-0-1071" class="i">+                    bound.1 = Bound::Excluded(end)
</a><a href="#h25-0-1072" id="h25-0-1072" class="i">+                }
</a><a href="#h25-0-1073" id="h25-0-1073" class="i">+            }
</a><a href="#h25-0-1074" id="h25-0-1074" class="i">+            Ok(bound)
</a>         }
 
<a href="#h25-0-1077" id="h25-0-1077" class="d">-        Ok(())
</a><a href="#h25-0-1078" id="h25-0-1078" class="d">-    }
</a><a href="#h25-0-1079" id="h25-0-1079" class="i">+        /// Fetches the named transaction from a command prefix.
</a><a href="#h25-0-1080" id="h25-0-1080" class="i">+        fn get_txn(
</a><a href="#h25-0-1081" id="h25-0-1081" class="i">+            &amp;mut self,
</a><a href="#h25-0-1082" id="h25-0-1082" class="i">+            prefix: &amp;Option&lt;String&gt;,
</a><a href="#h25-0-1083" id="h25-0-1083" class="i">+        ) -&gt; StdResult&lt;&amp;&#39;_ mut Transaction&lt;TestEngine&gt;, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-1084" id="h25-0-1084" class="i">+            let name = Self::txn_name(prefix)?;
</a><a href="#h25-0-1085" id="h25-0-1085" class="i">+            self.txns.get_mut(name).ok_or(format!(&quot;unknown txn {name}&quot;).into())
</a><a href="#h25-0-1086" id="h25-0-1086" class="i">+        }
</a> 
<a href="#h25-0-1088" id="h25-0-1088" class="d">-    #[test]
</a><a href="#h25-0-1089" id="h25-0-1089" class="d">-    /// Prefix scans should use correct key and time bounds. Sets up an initial
</a><a href="#h25-0-1090" id="h25-0-1090" class="d">-    /// data set as follows, and asserts results via the golden file.
</a><a href="#h25-0-1091" id="h25-0-1091" class="d">-    ///
</a><a href="#h25-0-1092" id="h25-0-1092" class="d">-    /// T
</a><a href="#h25-0-1093" id="h25-0-1093" class="d">-    /// 4             x   ba,4
</a><a href="#h25-0-1094" id="h25-0-1094" class="d">-    /// 3   x   a,3  b,3        x
</a><a href="#h25-0-1095" id="h25-0-1095" class="d">-    /// 2        x        ba,2 bb,2 bc,2
</a><a href="#h25-0-1096" id="h25-0-1096" class="d">-    /// 1  0,1  a,1   x                  c,1
</a><a href="#h25-0-1097" id="h25-0-1097" class="d">-    ///     B    a    b    ba   bb   bc   c
</a><a href="#h25-0-1098" id="h25-0-1098" class="d">-    fn scan_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1099" id="h25-0-1099" class="d">-        let mut mvcc = Schedule::new(&quot;scan_prefix&quot;)?;
</a><a href="#h25-0-1100" id="h25-0-1100" class="d">-        mvcc.setup(vec![
</a><a href="#h25-0-1101" id="h25-0-1101" class="d">-            (b&quot;B&quot;, 1, Some(&amp;[0, 1])),
</a><a href="#h25-0-1102" id="h25-0-1102" class="d">-            (b&quot;B&quot;, 3, None),
</a><a href="#h25-0-1103" id="h25-0-1103" class="d">-            (b&quot;a&quot;, 1, Some(&amp;[0x0a, 1])),
</a><a href="#h25-0-1104" id="h25-0-1104" class="d">-            (b&quot;a&quot;, 2, None),
</a><a href="#h25-0-1105" id="h25-0-1105" class="d">-            (b&quot;a&quot;, 3, Some(&amp;[0x0a, 3])),
</a><a href="#h25-0-1106" id="h25-0-1106" class="d">-            (b&quot;b&quot;, 1, None),
</a><a href="#h25-0-1107" id="h25-0-1107" class="d">-            (b&quot;b&quot;, 3, Some(&amp;[0x0b, 3])),
</a><a href="#h25-0-1108" id="h25-0-1108" class="d">-            (b&quot;b&quot;, 4, None),
</a><a href="#h25-0-1109" id="h25-0-1109" class="d">-            (b&quot;ba&quot;, 2, Some(&amp;[0xba, 2])),
</a><a href="#h25-0-1110" id="h25-0-1110" class="d">-            (b&quot;ba&quot;, 4, Some(&amp;[0xba, 4])),
</a><a href="#h25-0-1111" id="h25-0-1111" class="d">-            (b&quot;bb&quot;, 2, Some(&amp;[0xbb, 2])),
</a><a href="#h25-0-1112" id="h25-0-1112" class="d">-            (b&quot;bb&quot;, 3, None),
</a><a href="#h25-0-1113" id="h25-0-1113" class="d">-            (b&quot;bc&quot;, 2, Some(&amp;[0xbc, 2])),
</a><a href="#h25-0-1114" id="h25-0-1114" class="d">-            (b&quot;c&quot;, 1, Some(&amp;[0x0c, 1])),
</a><a href="#h25-0-1115" id="h25-0-1115" class="d">-        ])?;
</a><a href="#h25-0-1116" id="h25-0-1116" class="d">-
</a><a href="#h25-0-1117" id="h25-0-1117" class="d">-        // Full scans at all timestamps.
</a><a href="#h25-0-1118" id="h25-0-1118" class="d">-        for version in 1..5 {
</a><a href="#h25-0-1119" id="h25-0-1119" class="d">-            let txn = match version {
</a><a href="#h25-0-1120" id="h25-0-1120" class="d">-                5 =&gt; mvcc.begin_read_only()?,
</a><a href="#h25-0-1121" id="h25-0-1121" class="d">-                v =&gt; mvcc.begin_as_of(v)?,
</a><a href="#h25-0-1122" id="h25-0-1122" class="d">-            };
</a><a href="#h25-0-1123" id="h25-0-1123" class="d">-            let mut scan = txn.scan_prefix(&amp;[])?; // see golden master
</a><a href="#h25-0-1124" id="h25-0-1124" class="d">-            assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h25-0-1125" id="h25-0-1125" class="i">+        /// Fetches the txn name from a command prefix, or errors.
</a><a href="#h25-0-1126" id="h25-0-1126" class="i">+        fn txn_name(prefix: &amp;Option&lt;String&gt;) -&gt; StdResult&lt;&amp;str, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-1127" id="h25-0-1127" class="i">+            prefix.as_deref().ok_or(&quot;no txn name&quot;.into())
</a>         }
 
<a href="#h25-0-1130" id="h25-0-1130" class="d">-        // All prefixes at version 3 and version 4.
</a><a href="#h25-0-1131" id="h25-0-1131" class="d">-        for version in 3..=4 {
</a><a href="#h25-0-1132" id="h25-0-1132" class="d">-            let txn = mvcc.begin_as_of(version)?;
</a><a href="#h25-0-1133" id="h25-0-1133" class="d">-            for prefix in [b&quot;B&quot; as &amp;[u8], b&quot;a&quot;, b&quot;b&quot;, b&quot;ba&quot;, b&quot;bb&quot;, b&quot;bbb&quot;, b&quot;bc&quot;, b&quot;c&quot;, b&quot;d&quot;] {
</a><a href="#h25-0-1134" id="h25-0-1134" class="d">-                let mut scan = txn.scan_prefix(prefix)?; // see golden master
</a><a href="#h25-0-1135" id="h25-0-1135" class="d">-                assert_scan_invariants(&amp;mut scan)?;
</a><a href="#h25-0-1136" id="h25-0-1136" class="i">+        /// Errors if a txn prefix is given.
</a><a href="#h25-0-1137" id="h25-0-1137" class="i">+        fn no_txn(command: &amp;goldenscript::Command) -&gt; StdResult&lt;(), Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h25-0-1138" id="h25-0-1138" class="i">+            if let Some(name) = &amp;command.prefix {
</a><a href="#h25-0-1139" id="h25-0-1139" class="i">+                return Err(format!(&quot;can&#39;t run {} with txn {name}&quot;, command.name).into());
</a>             }
<a href="#h25-0-1141" id="h25-0-1141" class="i">+            Ok(())
</a>         }
<a href="#h25-0-1143" id="h25-0-1143" class="d">-
</a><a href="#h25-0-1144" id="h25-0-1144" class="d">-        Ok(())
</a><a href="#h25-0-1145" id="h25-0-1145" class="d">-    }
</a><a href="#h25-0-1146" id="h25-0-1146" class="d">-
</a><a href="#h25-0-1147" id="h25-0-1147" class="d">-    #[test]
</a><a href="#h25-0-1148" id="h25-0-1148" class="d">-    /// Scan should be isolated from future and uncommitted transactions.
</a><a href="#h25-0-1149" id="h25-0-1149" class="d">-    fn scan_isolation() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1150" id="h25-0-1150" class="d">-        let mut mvcc = Schedule::new(&quot;scan_isolation&quot;)?;
</a><a href="#h25-0-1151" id="h25-0-1151" class="d">-
</a><a href="#h25-0-1152" id="h25-0-1152" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1153" id="h25-0-1153" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-1154" id="h25-0-1154" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-1155" id="h25-0-1155" class="d">-        t1.set(b&quot;d&quot;, vec![1])?;
</a><a href="#h25-0-1156" id="h25-0-1156" class="d">-        t1.set(b&quot;e&quot;, vec![1])?;
</a><a href="#h25-0-1157" id="h25-0-1157" class="d">-        t1.commit()?;
</a><a href="#h25-0-1158" id="h25-0-1158" class="d">-
</a><a href="#h25-0-1159" id="h25-0-1159" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1160" id="h25-0-1160" class="d">-        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h25-0-1161" id="h25-0-1161" class="d">-        t2.delete(b&quot;b&quot;)?;
</a><a href="#h25-0-1162" id="h25-0-1162" class="d">-        t2.set(b&quot;c&quot;, vec![2])?;
</a><a href="#h25-0-1163" id="h25-0-1163" class="d">-
</a><a href="#h25-0-1164" id="h25-0-1164" class="d">-        let t3 = mvcc.begin_read_only()?;
</a><a href="#h25-0-1165" id="h25-0-1165" class="d">-
</a><a href="#h25-0-1166" id="h25-0-1166" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-1167" id="h25-0-1167" class="d">-        t4.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h25-0-1168" id="h25-0-1168" class="d">-        t4.delete(b&quot;e&quot;)?;
</a><a href="#h25-0-1169" id="h25-0-1169" class="d">-        t4.set(b&quot;f&quot;, vec![3])?;
</a><a href="#h25-0-1170" id="h25-0-1170" class="d">-        t4.commit()?;
</a><a href="#h25-0-1171" id="h25-0-1171" class="d">-
</a><a href="#h25-0-1172" id="h25-0-1172" class="d">-        assert_scan!(t3.scan(..)? =&gt; {
</a><a href="#h25-0-1173" id="h25-0-1173" class="d">-            b&quot;a&quot; =&gt; [1], // uncommitted update
</a><a href="#h25-0-1174" id="h25-0-1174" class="d">-            b&quot;b&quot; =&gt; [1], // uncommitted delete
</a><a href="#h25-0-1175" id="h25-0-1175" class="d">-            // b&quot;c&quot; is uncommitted write
</a><a href="#h25-0-1176" id="h25-0-1176" class="d">-            b&quot;d&quot; =&gt; [1], // future update
</a><a href="#h25-0-1177" id="h25-0-1177" class="d">-            b&quot;e&quot; =&gt; [1], // future delete
</a><a href="#h25-0-1178" id="h25-0-1178" class="d">-            // b&quot;f&quot; is future write
</a><a href="#h25-0-1179" id="h25-0-1179" class="d">-        });
</a><a href="#h25-0-1180" id="h25-0-1180" class="d">-
</a><a href="#h25-0-1181" id="h25-0-1181" class="d">-        Ok(())
</a><a href="#h25-0-1182" id="h25-0-1182" class="d">-    }
</a><a href="#h25-0-1183" id="h25-0-1183" class="d">-
</a><a href="#h25-0-1184" id="h25-0-1184" class="d">-    #[test]
</a><a href="#h25-0-1185" id="h25-0-1185" class="d">-    /// Tests that the key encoding is resistant to key/version overlap.
</a><a href="#h25-0-1186" id="h25-0-1186" class="d">-    /// For example, a naïve concatenation of keys and versions would
</a><a href="#h25-0-1187" id="h25-0-1187" class="d">-    /// produce incorrect ordering in this case:
</a><a href="#h25-0-1188" id="h25-0-1188" class="d">-    ///
</a><a href="#h25-0-1189" id="h25-0-1189" class="d">-    // 00|00 00 00 00 00 00 00 01
</a><a href="#h25-0-1190" id="h25-0-1190" class="d">-    // 00 00 00 00 00 00 00 00 02|00 00 00 00 00 00 00 02
</a><a href="#h25-0-1191" id="h25-0-1191" class="d">-    // 00|00 00 00 00 00 00 00 03
</a><a href="#h25-0-1192" id="h25-0-1192" class="d">-    fn scan_key_version_encoding() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1193" id="h25-0-1193" class="d">-        let mut mvcc = Schedule::new(&quot;scan_key_version_encoding&quot;)?;
</a><a href="#h25-0-1194" id="h25-0-1194" class="d">-
</a><a href="#h25-0-1195" id="h25-0-1195" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1196" id="h25-0-1196" class="d">-        t1.set(&amp;[0], vec![1])?;
</a><a href="#h25-0-1197" id="h25-0-1197" class="d">-        t1.commit()?;
</a><a href="#h25-0-1198" id="h25-0-1198" class="d">-
</a><a href="#h25-0-1199" id="h25-0-1199" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1200" id="h25-0-1200" class="d">-        t2.set(&amp;[0], vec![2])?;
</a><a href="#h25-0-1201" id="h25-0-1201" class="d">-        t2.set(&amp;[0, 0, 0, 0, 0, 0, 0, 0, 2], vec![2])?;
</a><a href="#h25-0-1202" id="h25-0-1202" class="d">-        t2.commit()?;
</a><a href="#h25-0-1203" id="h25-0-1203" class="d">-
</a><a href="#h25-0-1204" id="h25-0-1204" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-1205" id="h25-0-1205" class="d">-        t3.set(&amp;[0], vec![3])?;
</a><a href="#h25-0-1206" id="h25-0-1206" class="d">-        t3.commit()?;
</a><a href="#h25-0-1207" id="h25-0-1207" class="d">-
</a><a href="#h25-0-1208" id="h25-0-1208" class="d">-        let t4 = mvcc.begin_read_only()?;
</a><a href="#h25-0-1209" id="h25-0-1209" class="d">-        assert_scan!(t4.scan(..)? =&gt; {
</a><a href="#h25-0-1210" id="h25-0-1210" class="d">-            b&quot;\x00&quot; =&gt; [3],
</a><a href="#h25-0-1211" id="h25-0-1211" class="d">-            b&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; =&gt; [2],
</a><a href="#h25-0-1212" id="h25-0-1212" class="d">-        });
</a><a href="#h25-0-1213" id="h25-0-1213" class="d">-        Ok(())
</a><a href="#h25-0-1214" id="h25-0-1214" class="d">-    }
</a><a href="#h25-0-1215" id="h25-0-1215" class="d">-
</a><a href="#h25-0-1216" id="h25-0-1216" class="d">-    #[test]
</a><a href="#h25-0-1217" id="h25-0-1217" class="d">-    /// Sets should work on both existing, missing, and deleted keys, and be
</a><a href="#h25-0-1218" id="h25-0-1218" class="d">-    /// idempotent.
</a><a href="#h25-0-1219" id="h25-0-1219" class="d">-    fn set() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1220" id="h25-0-1220" class="d">-        let mut mvcc = Schedule::new(&quot;set&quot;)?;
</a><a href="#h25-0-1221" id="h25-0-1221" class="d">-        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[1])), (b&quot;tombstone&quot;, 1, None)])?;
</a><a href="#h25-0-1222" id="h25-0-1222" class="d">-
</a><a href="#h25-0-1223" id="h25-0-1223" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1224" id="h25-0-1224" class="d">-        t1.set(b&quot;key&quot;, vec![2])?; // update
</a><a href="#h25-0-1225" id="h25-0-1225" class="d">-        t1.set(b&quot;tombstone&quot;, vec![2])?; // update tombstone
</a><a href="#h25-0-1226" id="h25-0-1226" class="d">-        t1.set(b&quot;new&quot;, vec![1])?; // new write
</a><a href="#h25-0-1227" id="h25-0-1227" class="d">-        t1.set(b&quot;new&quot;, vec![1])?; // idempotent
</a><a href="#h25-0-1228" id="h25-0-1228" class="d">-        t1.set(b&quot;new&quot;, vec![2])?; // update own
</a><a href="#h25-0-1229" id="h25-0-1229" class="d">-        t1.commit()?;
</a><a href="#h25-0-1230" id="h25-0-1230" class="d">-
</a><a href="#h25-0-1231" id="h25-0-1231" class="d">-        Ok(())
</a><a href="#h25-0-1232" id="h25-0-1232" class="d">-    }
</a><a href="#h25-0-1233" id="h25-0-1233" class="d">-
</a><a href="#h25-0-1234" id="h25-0-1234" class="d">-    #[test]
</a><a href="#h25-0-1235" id="h25-0-1235" class="d">-    /// Set should return serialization errors both for uncommitted versions
</a><a href="#h25-0-1236" id="h25-0-1236" class="d">-    /// (past and future), and future committed versions.
</a><a href="#h25-0-1237" id="h25-0-1237" class="d">-    fn set_conflict() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1238" id="h25-0-1238" class="d">-        let mut mvcc = Schedule::new(&quot;set_conflict&quot;)?;
</a><a href="#h25-0-1239" id="h25-0-1239" class="d">-
</a><a href="#h25-0-1240" id="h25-0-1240" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1241" id="h25-0-1241" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1242" id="h25-0-1242" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-1243" id="h25-0-1243" class="d">-        let t4 = mvcc.begin()?;
</a><a href="#h25-0-1244" id="h25-0-1244" class="d">-
</a><a href="#h25-0-1245" id="h25-0-1245" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-1246" id="h25-0-1246" class="d">-        t3.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h25-0-1247" id="h25-0-1247" class="d">-        t4.set(b&quot;d&quot;, vec![4])?;
</a><a href="#h25-0-1248" id="h25-0-1248" class="d">-        t4.commit()?;
</a><a href="#h25-0-1249" id="h25-0-1249" class="d">-
</a><a href="#h25-0-1250" id="h25-0-1250" class="d">-        assert_eq!(t2.set(b&quot;a&quot;, vec![2]), Err(Error::Serialization)); // past uncommitted
</a><a href="#h25-0-1251" id="h25-0-1251" class="d">-        assert_eq!(t2.set(b&quot;c&quot;, vec![2]), Err(Error::Serialization)); // future uncommitted
</a><a href="#h25-0-1252" id="h25-0-1252" class="d">-        assert_eq!(t2.set(b&quot;d&quot;, vec![2]), Err(Error::Serialization)); // future committed
</a><a href="#h25-0-1253" id="h25-0-1253" class="d">-
</a><a href="#h25-0-1254" id="h25-0-1254" class="d">-        Ok(())
</a><a href="#h25-0-1255" id="h25-0-1255" class="d">-    }
</a><a href="#h25-0-1256" id="h25-0-1256" class="d">-
</a><a href="#h25-0-1257" id="h25-0-1257" class="d">-    #[test]
</a><a href="#h25-0-1258" id="h25-0-1258" class="d">-    /// Tests that transaction rollback properly rolls back uncommitted writes,
</a><a href="#h25-0-1259" id="h25-0-1259" class="d">-    /// allowing other concurrent transactions to write the keys.
</a><a href="#h25-0-1260" id="h25-0-1260" class="d">-    fn rollback() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1261" id="h25-0-1261" class="d">-        let mut mvcc = Schedule::new(&quot;rollback&quot;)?;
</a><a href="#h25-0-1262" id="h25-0-1262" class="d">-        mvcc.setup(vec![
</a><a href="#h25-0-1263" id="h25-0-1263" class="d">-            (b&quot;a&quot;, 1, Some(&amp;[0])),
</a><a href="#h25-0-1264" id="h25-0-1264" class="d">-            (b&quot;b&quot;, 1, Some(&amp;[0])),
</a><a href="#h25-0-1265" id="h25-0-1265" class="d">-            (b&quot;c&quot;, 1, Some(&amp;[0])),
</a><a href="#h25-0-1266" id="h25-0-1266" class="d">-            (b&quot;d&quot;, 1, Some(&amp;[0])),
</a><a href="#h25-0-1267" id="h25-0-1267" class="d">-        ])?;
</a><a href="#h25-0-1268" id="h25-0-1268" class="d">-
</a><a href="#h25-0-1269" id="h25-0-1269" class="d">-        // t2 will be rolled back. t1 and t3 are concurrent transactions.
</a><a href="#h25-0-1270" id="h25-0-1270" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1271" id="h25-0-1271" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1272" id="h25-0-1272" class="d">-        let t3 = mvcc.begin()?;
</a><a href="#h25-0-1273" id="h25-0-1273" class="d">-
</a><a href="#h25-0-1274" id="h25-0-1274" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-1275" id="h25-0-1275" class="d">-        t2.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h25-0-1276" id="h25-0-1276" class="d">-        t2.delete(b&quot;c&quot;)?;
</a><a href="#h25-0-1277" id="h25-0-1277" class="d">-        t3.set(b&quot;d&quot;, vec![3])?;
</a><a href="#h25-0-1278" id="h25-0-1278" class="d">-
</a><a href="#h25-0-1279" id="h25-0-1279" class="d">-        // Both t1 and t3 will get serialization errors with t2.
</a><a href="#h25-0-1280" id="h25-0-1280" class="d">-        assert_eq!(t1.set(b&quot;b&quot;, vec![1]), Err(Error::Serialization));
</a><a href="#h25-0-1281" id="h25-0-1281" class="d">-        assert_eq!(t3.set(b&quot;c&quot;, vec![3]), Err(Error::Serialization));
</a><a href="#h25-0-1282" id="h25-0-1282" class="d">-
</a><a href="#h25-0-1283" id="h25-0-1283" class="d">-        // When t2 is rolled back, none of its writes will be visible, and t1
</a><a href="#h25-0-1284" id="h25-0-1284" class="d">-        // and t3 can perform their writes and successfully commit.
</a><a href="#h25-0-1285" id="h25-0-1285" class="d">-        t2.rollback()?;
</a><a href="#h25-0-1286" id="h25-0-1286" class="d">-
</a><a href="#h25-0-1287" id="h25-0-1287" class="d">-        let t4 = mvcc.begin_read_only()?;
</a><a href="#h25-0-1288" id="h25-0-1288" class="d">-        assert_scan!(t4.scan(..)? =&gt; {
</a><a href="#h25-0-1289" id="h25-0-1289" class="d">-            b&quot;a&quot; =&gt; [0],
</a><a href="#h25-0-1290" id="h25-0-1290" class="d">-            b&quot;b&quot; =&gt; [0],
</a><a href="#h25-0-1291" id="h25-0-1291" class="d">-            b&quot;c&quot; =&gt; [0],
</a><a href="#h25-0-1292" id="h25-0-1292" class="d">-            b&quot;d&quot; =&gt; [0],
</a><a href="#h25-0-1293" id="h25-0-1293" class="d">-        });
</a><a href="#h25-0-1294" id="h25-0-1294" class="d">-
</a><a href="#h25-0-1295" id="h25-0-1295" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-1296" id="h25-0-1296" class="d">-        t3.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h25-0-1297" id="h25-0-1297" class="d">-        t1.commit()?;
</a><a href="#h25-0-1298" id="h25-0-1298" class="d">-        t3.commit()?;
</a><a href="#h25-0-1299" id="h25-0-1299" class="d">-
</a><a href="#h25-0-1300" id="h25-0-1300" class="d">-        let t5 = mvcc.begin_read_only()?;
</a><a href="#h25-0-1301" id="h25-0-1301" class="d">-        assert_scan!(t5.scan(..)? =&gt; {
</a><a href="#h25-0-1302" id="h25-0-1302" class="d">-            b&quot;a&quot; =&gt; [1],
</a><a href="#h25-0-1303" id="h25-0-1303" class="d">-            b&quot;b&quot; =&gt; [1],
</a><a href="#h25-0-1304" id="h25-0-1304" class="d">-            b&quot;c&quot; =&gt; [3],
</a><a href="#h25-0-1305" id="h25-0-1305" class="d">-            b&quot;d&quot; =&gt; [3],
</a><a href="#h25-0-1306" id="h25-0-1306" class="d">-        });
</a><a href="#h25-0-1307" id="h25-0-1307" class="d">-
</a><a href="#h25-0-1308" id="h25-0-1308" class="d">-        Ok(())
</a><a href="#h25-0-1309" id="h25-0-1309" class="d">-    }
</a><a href="#h25-0-1310" id="h25-0-1310" class="d">-
</a><a href="#h25-0-1311" id="h25-0-1311" class="d">-    #[test]
</a><a href="#h25-0-1312" id="h25-0-1312" class="d">-    // A dirty write is when t2 overwrites an uncommitted value written by t1.
</a><a href="#h25-0-1313" id="h25-0-1313" class="d">-    // Snapshot isolation prevents this.
</a><a href="#h25-0-1314" id="h25-0-1314" class="d">-    fn anomaly_dirty_write() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1315" id="h25-0-1315" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_dirty_write&quot;)?;
</a><a href="#h25-0-1316" id="h25-0-1316" class="d">-
</a><a href="#h25-0-1317" id="h25-0-1317" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1318" id="h25-0-1318" class="d">-        t1.set(b&quot;key&quot;, vec![1])?;
</a><a href="#h25-0-1319" id="h25-0-1319" class="d">-
</a><a href="#h25-0-1320" id="h25-0-1320" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1321" id="h25-0-1321" class="d">-        assert_eq!(t2.set(b&quot;key&quot;, vec![2]), Err(Error::Serialization));
</a><a href="#h25-0-1322" id="h25-0-1322" class="d">-
</a><a href="#h25-0-1323" id="h25-0-1323" class="d">-        Ok(())
</a><a href="#h25-0-1324" id="h25-0-1324" class="d">-    }
</a><a href="#h25-0-1325" id="h25-0-1325" class="d">-
</a><a href="#h25-0-1326" id="h25-0-1326" class="d">-    #[test]
</a><a href="#h25-0-1327" id="h25-0-1327" class="d">-    // A dirty read is when t2 can read an uncommitted value set by t1.
</a><a href="#h25-0-1328" id="h25-0-1328" class="d">-    // Snapshot isolation prevents this.
</a><a href="#h25-0-1329" id="h25-0-1329" class="d">-    fn anomaly_dirty_read() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1330" id="h25-0-1330" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_dirty_read&quot;)?;
</a><a href="#h25-0-1331" id="h25-0-1331" class="d">-
</a><a href="#h25-0-1332" id="h25-0-1332" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1333" id="h25-0-1333" class="d">-        t1.set(b&quot;key&quot;, vec![1])?;
</a><a href="#h25-0-1334" id="h25-0-1334" class="d">-
</a><a href="#h25-0-1335" id="h25-0-1335" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1336" id="h25-0-1336" class="d">-        assert_eq!(t2.get(b&quot;key&quot;)?, None);
</a><a href="#h25-0-1337" id="h25-0-1337" class="d">-
</a><a href="#h25-0-1338" id="h25-0-1338" class="d">-        Ok(())
</a><a href="#h25-0-1339" id="h25-0-1339" class="d">-    }
</a><a href="#h25-0-1340" id="h25-0-1340" class="d">-
</a><a href="#h25-0-1341" id="h25-0-1341" class="d">-    #[test]
</a><a href="#h25-0-1342" id="h25-0-1342" class="d">-    // A lost update is when t1 and t2 both read a value and update it, where
</a><a href="#h25-0-1343" id="h25-0-1343" class="d">-    // t2&#39;s update replaces t1. Snapshot isolation prevents this.
</a><a href="#h25-0-1344" id="h25-0-1344" class="d">-    fn anomaly_lost_update() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1345" id="h25-0-1345" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_lost_update&quot;)?;
</a><a href="#h25-0-1346" id="h25-0-1346" class="d">-        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[0]))])?;
</a><a href="#h25-0-1347" id="h25-0-1347" class="d">-
</a><a href="#h25-0-1348" id="h25-0-1348" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1349" id="h25-0-1349" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1350" id="h25-0-1350" class="d">-
</a><a href="#h25-0-1351" id="h25-0-1351" class="d">-        t1.get(b&quot;key&quot;)?;
</a><a href="#h25-0-1352" id="h25-0-1352" class="d">-        t2.get(b&quot;key&quot;)?;
</a><a href="#h25-0-1353" id="h25-0-1353" class="d">-
</a><a href="#h25-0-1354" id="h25-0-1354" class="d">-        t1.set(b&quot;key&quot;, vec![1])?;
</a><a href="#h25-0-1355" id="h25-0-1355" class="d">-        assert_eq!(t2.set(b&quot;key&quot;, vec![2]), Err(Error::Serialization));
</a><a href="#h25-0-1356" id="h25-0-1356" class="d">-        t1.commit()?;
</a><a href="#h25-0-1357" id="h25-0-1357" class="d">-
</a><a href="#h25-0-1358" id="h25-0-1358" class="d">-        Ok(())
</a><a href="#h25-0-1359" id="h25-0-1359" class="d">-    }
</a><a href="#h25-0-1360" id="h25-0-1360" class="d">-
</a><a href="#h25-0-1361" id="h25-0-1361" class="d">-    #[test]
</a><a href="#h25-0-1362" id="h25-0-1362" class="d">-    // A fuzzy (or unrepeatable) read is when t2 sees a value change after t1
</a><a href="#h25-0-1363" id="h25-0-1363" class="d">-    // updates it. Snapshot isolation prevents this.
</a><a href="#h25-0-1364" id="h25-0-1364" class="d">-    fn anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1365" id="h25-0-1365" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_fuzzy_read&quot;)?;
</a><a href="#h25-0-1366" id="h25-0-1366" class="d">-        mvcc.setup(vec![(b&quot;key&quot;, 1, Some(&amp;[0]))])?;
</a><a href="#h25-0-1367" id="h25-0-1367" class="d">-
</a><a href="#h25-0-1368" id="h25-0-1368" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1369" id="h25-0-1369" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1370" id="h25-0-1370" class="d">-
</a><a href="#h25-0-1371" id="h25-0-1371" class="d">-        assert_eq!(t2.get(b&quot;key&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1372" id="h25-0-1372" class="d">-        t1.set(b&quot;key&quot;, b&quot;t1&quot;.to_vec())?;
</a><a href="#h25-0-1373" id="h25-0-1373" class="d">-        t1.commit()?;
</a><a href="#h25-0-1374" id="h25-0-1374" class="d">-        assert_eq!(t2.get(b&quot;key&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1375" id="h25-0-1375" class="d">-
</a><a href="#h25-0-1376" id="h25-0-1376" class="d">-        Ok(())
</a><a href="#h25-0-1377" id="h25-0-1377" class="d">-    }
</a><a href="#h25-0-1378" id="h25-0-1378" class="d">-
</a><a href="#h25-0-1379" id="h25-0-1379" class="d">-    #[test]
</a><a href="#h25-0-1380" id="h25-0-1380" class="d">-    // Read skew is when t1 reads a and b, but t2 modifies b in between the
</a><a href="#h25-0-1381" id="h25-0-1381" class="d">-    // reads. Snapshot isolation prevents this.
</a><a href="#h25-0-1382" id="h25-0-1382" class="d">-    fn anomaly_read_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1383" id="h25-0-1383" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_read_skew&quot;)?;
</a><a href="#h25-0-1384" id="h25-0-1384" class="d">-        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[0])), (b&quot;b&quot;, 1, Some(&amp;[0]))])?;
</a><a href="#h25-0-1385" id="h25-0-1385" class="d">-
</a><a href="#h25-0-1386" id="h25-0-1386" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1387" id="h25-0-1387" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1388" id="h25-0-1388" class="d">-
</a><a href="#h25-0-1389" id="h25-0-1389" class="d">-        assert_eq!(t1.get(b&quot;a&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1390" id="h25-0-1390" class="d">-        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h25-0-1391" id="h25-0-1391" class="d">-        t2.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h25-0-1392" id="h25-0-1392" class="d">-        t2.commit()?;
</a><a href="#h25-0-1393" id="h25-0-1393" class="d">-        assert_eq!(t1.get(b&quot;b&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1394" id="h25-0-1394" class="d">-
</a><a href="#h25-0-1395" id="h25-0-1395" class="d">-        Ok(())
</a><a href="#h25-0-1396" id="h25-0-1396" class="d">-    }
</a><a href="#h25-0-1397" id="h25-0-1397" class="d">-
</a><a href="#h25-0-1398" id="h25-0-1398" class="d">-    #[test]
</a><a href="#h25-0-1399" id="h25-0-1399" class="d">-    // A phantom read is when t1 reads entries matching some predicate, but a
</a><a href="#h25-0-1400" id="h25-0-1400" class="d">-    // modification by t2 changes which entries that match the predicate such
</a><a href="#h25-0-1401" id="h25-0-1401" class="d">-    // that a later read by t1 returns them. Snapshot isolation prevents this.
</a><a href="#h25-0-1402" id="h25-0-1402" class="d">-    //
</a><a href="#h25-0-1403" id="h25-0-1403" class="d">-    // We use a prefix scan as our predicate.
</a><a href="#h25-0-1404" id="h25-0-1404" class="d">-    fn anomaly_phantom_read() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1405" id="h25-0-1405" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_phantom_read&quot;)?;
</a><a href="#h25-0-1406" id="h25-0-1406" class="d">-        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[0])), (b&quot;ba&quot;, 1, Some(&amp;[0])), (b&quot;bb&quot;, 1, Some(&amp;[0]))])?;
</a><a href="#h25-0-1407" id="h25-0-1407" class="d">-
</a><a href="#h25-0-1408" id="h25-0-1408" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1409" id="h25-0-1409" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1410" id="h25-0-1410" class="d">-
</a><a href="#h25-0-1411" id="h25-0-1411" class="d">-        assert_scan!(t1.scan_prefix(b&quot;b&quot;)? =&gt; {
</a><a href="#h25-0-1412" id="h25-0-1412" class="d">-            b&quot;ba&quot; =&gt; [0],
</a><a href="#h25-0-1413" id="h25-0-1413" class="d">-            b&quot;bb&quot; =&gt; [0],
</a><a href="#h25-0-1414" id="h25-0-1414" class="d">-        });
</a><a href="#h25-0-1415" id="h25-0-1415" class="d">-
</a><a href="#h25-0-1416" id="h25-0-1416" class="d">-        t2.delete(b&quot;ba&quot;)?;
</a><a href="#h25-0-1417" id="h25-0-1417" class="d">-        t2.set(b&quot;bc&quot;, vec![2])?;
</a><a href="#h25-0-1418" id="h25-0-1418" class="d">-        t2.commit()?;
</a><a href="#h25-0-1419" id="h25-0-1419" class="d">-
</a><a href="#h25-0-1420" id="h25-0-1420" class="d">-        assert_scan!(t1.scan_prefix(b&quot;b&quot;)? =&gt; {
</a><a href="#h25-0-1421" id="h25-0-1421" class="d">-            b&quot;ba&quot; =&gt; [0],
</a><a href="#h25-0-1422" id="h25-0-1422" class="d">-            b&quot;bb&quot; =&gt; [0],
</a><a href="#h25-0-1423" id="h25-0-1423" class="d">-        });
</a><a href="#h25-0-1424" id="h25-0-1424" class="d">-
</a><a href="#h25-0-1425" id="h25-0-1425" class="d">-        Ok(())
</a><a href="#h25-0-1426" id="h25-0-1426" class="d">-    }
</a><a href="#h25-0-1427" id="h25-0-1427" class="d">-
</a><a href="#h25-0-1428" id="h25-0-1428" class="d">-    #[test]
</a><a href="#h25-0-1429" id="h25-0-1429" class="d">-    // Write skew is when t1 reads a and writes it to b while t2 reads b and
</a><a href="#h25-0-1430" id="h25-0-1430" class="d">-    // writes it to a. Snapshot isolation DOES NOT prevent this, which is
</a><a href="#h25-0-1431" id="h25-0-1431" class="d">-    // expected, so we assert the current behavior. Fixing this requires
</a><a href="#h25-0-1432" id="h25-0-1432" class="d">-    // implementing serializable snapshot isolation.
</a><a href="#h25-0-1433" id="h25-0-1433" class="d">-    fn anomaly_write_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1434" id="h25-0-1434" class="d">-        let mut mvcc = Schedule::new(&quot;anomaly_write_skew&quot;)?;
</a><a href="#h25-0-1435" id="h25-0-1435" class="d">-        mvcc.setup(vec![(b&quot;a&quot;, 1, Some(&amp;[1])), (b&quot;b&quot;, 1, Some(&amp;[2]))])?;
</a><a href="#h25-0-1436" id="h25-0-1436" class="d">-
</a><a href="#h25-0-1437" id="h25-0-1437" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1438" id="h25-0-1438" class="d">-        let t2 = mvcc.begin()?;
</a><a href="#h25-0-1439" id="h25-0-1439" class="d">-
</a><a href="#h25-0-1440" id="h25-0-1440" class="d">-        assert_eq!(t1.get(b&quot;a&quot;)?, Some(vec![1]));
</a><a href="#h25-0-1441" id="h25-0-1441" class="d">-        assert_eq!(t2.get(b&quot;b&quot;)?, Some(vec![2]));
</a><a href="#h25-0-1442" id="h25-0-1442" class="d">-
</a><a href="#h25-0-1443" id="h25-0-1443" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-1444" id="h25-0-1444" class="d">-        t2.set(b&quot;a&quot;, vec![2])?;
</a><a href="#h25-0-1445" id="h25-0-1445" class="d">-
</a><a href="#h25-0-1446" id="h25-0-1446" class="d">-        t1.commit()?;
</a><a href="#h25-0-1447" id="h25-0-1447" class="d">-        t2.commit()?;
</a><a href="#h25-0-1448" id="h25-0-1448" class="d">-
</a><a href="#h25-0-1449" id="h25-0-1449" class="d">-        Ok(())
</a><a href="#h25-0-1450" id="h25-0-1450" class="d">-    }
</a><a href="#h25-0-1451" id="h25-0-1451" class="d">-
</a><a href="#h25-0-1452" id="h25-0-1452" class="d">-    #[test]
</a><a href="#h25-0-1453" id="h25-0-1453" class="d">-    /// Tests unversioned key/value pairs, via set/get_unversioned().
</a><a href="#h25-0-1454" id="h25-0-1454" class="d">-    fn unversioned() -&gt; Result&lt;()&gt; {
</a><a href="#h25-0-1455" id="h25-0-1455" class="d">-        let mut mvcc = Schedule::new(&quot;unversioned&quot;)?;
</a><a href="#h25-0-1456" id="h25-0-1456" class="d">-
</a><a href="#h25-0-1457" id="h25-0-1457" class="d">-        // Interleave versioned and unversioned writes.
</a><a href="#h25-0-1458" id="h25-0-1458" class="d">-        mvcc.set_unversioned(b&quot;a&quot;, vec![0])?;
</a><a href="#h25-0-1459" id="h25-0-1459" class="d">-
</a><a href="#h25-0-1460" id="h25-0-1460" class="d">-        let t1 = mvcc.begin()?;
</a><a href="#h25-0-1461" id="h25-0-1461" class="d">-        t1.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-1462" id="h25-0-1462" class="d">-        t1.set(b&quot;b&quot;, vec![1])?;
</a><a href="#h25-0-1463" id="h25-0-1463" class="d">-        t1.set(b&quot;c&quot;, vec![1])?;
</a><a href="#h25-0-1464" id="h25-0-1464" class="d">-        t1.commit()?;
</a><a href="#h25-0-1465" id="h25-0-1465" class="d">-
</a><a href="#h25-0-1466" id="h25-0-1466" class="d">-        mvcc.set_unversioned(b&quot;b&quot;, vec![0])?;
</a><a href="#h25-0-1467" id="h25-0-1467" class="d">-        mvcc.set_unversioned(b&quot;d&quot;, vec![0])?;
</a><a href="#h25-0-1468" id="h25-0-1468" class="d">-
</a><a href="#h25-0-1469" id="h25-0-1469" class="d">-        // Scans should not see the unversioned writes.
</a><a href="#h25-0-1470" id="h25-0-1470" class="d">-        let t2 = mvcc.begin_read_only()?;
</a><a href="#h25-0-1471" id="h25-0-1471" class="d">-        assert_scan!(t2.scan(..)? =&gt; {
</a><a href="#h25-0-1472" id="h25-0-1472" class="d">-            b&quot;a&quot; =&gt; [1],
</a><a href="#h25-0-1473" id="h25-0-1473" class="d">-            b&quot;b&quot; =&gt; [1],
</a><a href="#h25-0-1474" id="h25-0-1474" class="d">-            b&quot;c&quot; =&gt; [1],
</a><a href="#h25-0-1475" id="h25-0-1475" class="d">-        });
</a><a href="#h25-0-1476" id="h25-0-1476" class="d">-
</a><a href="#h25-0-1477" id="h25-0-1477" class="d">-        // Unversioned gets should not see MVCC writes.
</a><a href="#h25-0-1478" id="h25-0-1478" class="d">-        assert_eq!(mvcc.get_unversioned(b&quot;a&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1479" id="h25-0-1479" class="d">-        assert_eq!(mvcc.get_unversioned(b&quot;b&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1480" id="h25-0-1480" class="d">-        assert_eq!(mvcc.get_unversioned(b&quot;c&quot;)?, None);
</a><a href="#h25-0-1481" id="h25-0-1481" class="d">-        assert_eq!(mvcc.get_unversioned(b&quot;d&quot;)?, Some(vec![0]));
</a><a href="#h25-0-1482" id="h25-0-1482" class="d">-
</a><a href="#h25-0-1483" id="h25-0-1483" class="d">-        // Replacing an unversioned key should be fine.
</a><a href="#h25-0-1484" id="h25-0-1484" class="d">-        mvcc.set_unversioned(b&quot;a&quot;, vec![1])?;
</a><a href="#h25-0-1485" id="h25-0-1485" class="d">-        assert_eq!(mvcc.get_unversioned(b&quot;a&quot;)?, Some(vec![1]));
</a><a href="#h25-0-1486" id="h25-0-1486" class="d">-
</a><a href="#h25-0-1487" id="h25-0-1487" class="d">-        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h26" href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a> b/<a href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,61 +0,0 @@
</a><a href="#h26-0-0" id="h26-0-0" class="d">-# Tests various keys.
</a><a href="#h26-0-1" id="h26-0-1" class="d">-
</a><a href="#h26-0-2" id="h26-0-2" class="d">-# Keys are case-sensitive.
</a><a href="#h26-0-3" id="h26-0-3" class="d">-set a=1
</a><a href="#h26-0-4" id="h26-0-4" class="d">-get a
</a><a href="#h26-0-5" id="h26-0-5" class="d">-get A
</a><a href="#h26-0-6" id="h26-0-6" class="d">----
</a><a href="#h26-0-7" id="h26-0-7" class="d">-a → 1
</a><a href="#h26-0-8" id="h26-0-8" class="d">-A → None
</a><a href="#h26-0-9" id="h26-0-9" class="d">-
</a><a href="#h26-0-10" id="h26-0-10" class="d">-set A=2
</a><a href="#h26-0-11" id="h26-0-11" class="d">-get a
</a><a href="#h26-0-12" id="h26-0-12" class="d">-get A
</a><a href="#h26-0-13" id="h26-0-13" class="d">----
</a><a href="#h26-0-14" id="h26-0-14" class="d">-a → 1
</a><a href="#h26-0-15" id="h26-0-15" class="d">-A → 2
</a><a href="#h26-0-16" id="h26-0-16" class="d">-
</a><a href="#h26-0-17" id="h26-0-17" class="d">-delete a
</a><a href="#h26-0-18" id="h26-0-18" class="d">-delete A
</a><a href="#h26-0-19" id="h26-0-19" class="d">-scan
</a><a href="#h26-0-20" id="h26-0-20" class="d">----
</a><a href="#h26-0-21" id="h26-0-21" class="d">-ok
</a><a href="#h26-0-22" id="h26-0-22" class="d">-
</a><a href="#h26-0-23" id="h26-0-23" class="d">-# Empty keys and values are valid.
</a><a href="#h26-0-24" id="h26-0-24" class="d">-set &quot;&quot;=&quot;&quot;
</a><a href="#h26-0-25" id="h26-0-25" class="d">-get &quot;&quot;
</a><a href="#h26-0-26" id="h26-0-26" class="d">-scan
</a><a href="#h26-0-27" id="h26-0-27" class="d">-delete &quot;&quot;
</a><a href="#h26-0-28" id="h26-0-28" class="d">----
</a><a href="#h26-0-29" id="h26-0-29" class="d">- → 
</a><a href="#h26-0-30" id="h26-0-30" class="d">- → 
</a><a href="#h26-0-31" id="h26-0-31" class="d">-
</a><a href="#h26-0-32" id="h26-0-32" class="d">-scan
</a><a href="#h26-0-33" id="h26-0-33" class="d">----
</a><a href="#h26-0-34" id="h26-0-34" class="d">-ok
</a><a href="#h26-0-35" id="h26-0-35" class="d">-
</a><a href="#h26-0-36" id="h26-0-36" class="d">-# NUL keys and values are valid.
</a><a href="#h26-0-37" id="h26-0-37" class="d">-set &quot;\0&quot;=&quot;\0&quot;
</a><a href="#h26-0-38" id="h26-0-38" class="d">-get &quot;\0&quot;
</a><a href="#h26-0-39" id="h26-0-39" class="d">-scan
</a><a href="#h26-0-40" id="h26-0-40" class="d">-delete &quot;\0&quot;
</a><a href="#h26-0-41" id="h26-0-41" class="d">----
</a><a href="#h26-0-42" id="h26-0-42" class="d">-\x00 → \x00
</a><a href="#h26-0-43" id="h26-0-43" class="d">-\x00 → \x00
</a><a href="#h26-0-44" id="h26-0-44" class="d">-
</a><a href="#h26-0-45" id="h26-0-45" class="d">-scan
</a><a href="#h26-0-46" id="h26-0-46" class="d">----
</a><a href="#h26-0-47" id="h26-0-47" class="d">-ok
</a><a href="#h26-0-48" id="h26-0-48" class="d">-
</a><a href="#h26-0-49" id="h26-0-49" class="d">-# Unicode keys and values work, but are shown as raw UTF-8 bytes.
</a><a href="#h26-0-50" id="h26-0-50" class="d">-set &quot;👋&quot;=&quot;👋&quot;
</a><a href="#h26-0-51" id="h26-0-51" class="d">-get &quot;👋&quot;
</a><a href="#h26-0-52" id="h26-0-52" class="d">-scan
</a><a href="#h26-0-53" id="h26-0-53" class="d">-delete &quot;👋&quot;
</a><a href="#h26-0-54" id="h26-0-54" class="d">----
</a><a href="#h26-0-55" id="h26-0-55" class="d">-\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h26-0-56" id="h26-0-56" class="d">-\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h26-0-57" id="h26-0-57" class="d">-
</a><a href="#h26-0-58" id="h26-0-58" class="d">-scan
</a><a href="#h26-0-59" id="h26-0-59" class="d">----
</a><a href="#h26-0-60" id="h26-0-60" class="d">-ok
</a><b>diff --git a/<a id="h27" href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+# A dirty read is when t2 can read an uncommitted value set by t1.Snapshot
</a><a href="#h27-0-1" id="h27-0-1" class="i">+# isolation prevents this.
</a><a href="#h27-0-2" id="h27-0-2" class="i">+
</a><a href="#h27-0-3" id="h27-0-3" class="i">+t1: begin
</a><a href="#h27-0-4" id="h27-0-4" class="i">+t1: set key=1
</a><a href="#h27-0-5" id="h27-0-5" class="i">+---
</a><a href="#h27-0-6" id="h27-0-6" class="i">+ok
</a><a href="#h27-0-7" id="h27-0-7" class="i">+
</a><a href="#h27-0-8" id="h27-0-8" class="i">+t2: begin
</a><a href="#h27-0-9" id="h27-0-9" class="i">+t2: get key
</a><a href="#h27-0-10" id="h27-0-10" class="i">+---
</a><a href="#h27-0-11" id="h27-0-11" class="i">+t2: key → None
</a><b>diff --git a/<a id="h28" href="../file/src/storage/testscripts/mvcc/anomaly_dirty_write.html">src/storage/testscripts/mvcc/anomaly_dirty_write</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_dirty_write.html">src/storage/testscripts/mvcc/anomaly_dirty_write</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+# A dirty write is when t2 overwrites an uncommitted value written by t1.
</a><a href="#h28-0-1" id="h28-0-1" class="i">+# Snapshot isolation prevents this.
</a><a href="#h28-0-2" id="h28-0-2" class="i">+
</a><a href="#h28-0-3" id="h28-0-3" class="i">+t1: begin
</a><a href="#h28-0-4" id="h28-0-4" class="i">+t1: set key=1
</a><a href="#h28-0-5" id="h28-0-5" class="i">+---
</a><a href="#h28-0-6" id="h28-0-6" class="i">+ok
</a><a href="#h28-0-7" id="h28-0-7" class="i">+
</a><a href="#h28-0-8" id="h28-0-8" class="i">+t2: begin
</a><a href="#h28-0-9" id="h28-0-9" class="i">+t2: !set key=2
</a><a href="#h28-0-10" id="h28-0-10" class="i">+---
</a><a href="#h28-0-11" id="h28-0-11" class="i">+t2: Error: serialization failure, retry transaction
</a><b>diff --git a/<a id="h29" href="../file/src/storage/testscripts/mvcc/anomaly_fuzzy_read.html">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_fuzzy_read.html">src/storage/testscripts/mvcc/anomaly_fuzzy_read</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,25 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+# A fuzzy (or unrepeatable) read is when t2 sees a value change after t1
</a><a href="#h29-0-1" id="h29-0-1" class="i">+# updates it. Snapshot isolation prevents this.
</a><a href="#h29-0-2" id="h29-0-2" class="i">+
</a><a href="#h29-0-3" id="h29-0-3" class="i">+# Set up some initial data.
</a><a href="#h29-0-4" id="h29-0-4" class="i">+import key=0
</a><a href="#h29-0-5" id="h29-0-5" class="i">+---
</a><a href="#h29-0-6" id="h29-0-6" class="i">+ok
</a><a href="#h29-0-7" id="h29-0-7" class="i">+
</a><a href="#h29-0-8" id="h29-0-8" class="i">+t1: begin
</a><a href="#h29-0-9" id="h29-0-9" class="i">+t2: begin
</a><a href="#h29-0-10" id="h29-0-10" class="i">+---
</a><a href="#h29-0-11" id="h29-0-11" class="i">+ok
</a><a href="#h29-0-12" id="h29-0-12" class="i">+
</a><a href="#h29-0-13" id="h29-0-13" class="i">+t2: get key
</a><a href="#h29-0-14" id="h29-0-14" class="i">+---
</a><a href="#h29-0-15" id="h29-0-15" class="i">+t2: key → 0
</a><a href="#h29-0-16" id="h29-0-16" class="i">+
</a><a href="#h29-0-17" id="h29-0-17" class="i">+t1: set key=1
</a><a href="#h29-0-18" id="h29-0-18" class="i">+t1: commit
</a><a href="#h29-0-19" id="h29-0-19" class="i">+---
</a><a href="#h29-0-20" id="h29-0-20" class="i">+ok
</a><a href="#h29-0-21" id="h29-0-21" class="i">+
</a><a href="#h29-0-22" id="h29-0-22" class="i">+t2: get key
</a><a href="#h29-0-23" id="h29-0-23" class="i">+---
</a><a href="#h29-0-24" id="h29-0-24" class="i">+t2: key → 0
</a><b>diff --git a/<a id="h30" href="../file/src/storage/testscripts/mvcc/anomaly_lost_update.html">src/storage/testscripts/mvcc/anomaly_lost_update</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_lost_update.html">src/storage/testscripts/mvcc/anomaly_lost_update</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+# A lost update is when t1 and t2 both read a value and update it, where
</a><a href="#h30-0-1" id="h30-0-1" class="i">+# t2&#39;s update replaces t1. Snapshot isolation prevents this.
</a><a href="#h30-0-2" id="h30-0-2" class="i">+
</a><a href="#h30-0-3" id="h30-0-3" class="i">+t1: begin
</a><a href="#h30-0-4" id="h30-0-4" class="i">+t1: get key
</a><a href="#h30-0-5" id="h30-0-5" class="i">+---
</a><a href="#h30-0-6" id="h30-0-6" class="i">+t1: key → None
</a><a href="#h30-0-7" id="h30-0-7" class="i">+
</a><a href="#h30-0-8" id="h30-0-8" class="i">+t2: begin
</a><a href="#h30-0-9" id="h30-0-9" class="i">+t2: get key
</a><a href="#h30-0-10" id="h30-0-10" class="i">+---
</a><a href="#h30-0-11" id="h30-0-11" class="i">+t2: key → None
</a><a href="#h30-0-12" id="h30-0-12" class="i">+
</a><a href="#h30-0-13" id="h30-0-13" class="i">+t1: set key=1
</a><a href="#h30-0-14" id="h30-0-14" class="i">+t2: !set key=2
</a><a href="#h30-0-15" id="h30-0-15" class="i">+---
</a><a href="#h30-0-16" id="h30-0-16" class="i">+t2: Error: serialization failure, retry transaction
</a><b>diff --git a/<a id="h31" href="../file/src/storage/testscripts/mvcc/anomaly_phantom_read.html">src/storage/testscripts/mvcc/anomaly_phantom_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_phantom_read.html">src/storage/testscripts/mvcc/anomaly_phantom_read</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,31 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+# A phantom read is when t1 reads entries matching some predicate, but a
</a><a href="#h31-0-1" id="h31-0-1" class="i">+# modification by t2 changes which entries match the predicate such that a later
</a><a href="#h31-0-2" id="h31-0-2" class="i">+# read by t1 returns them. Snapshot isolation prevents this.
</a><a href="#h31-0-3" id="h31-0-3" class="i">+#
</a><a href="#h31-0-4" id="h31-0-4" class="i">+# We use a prefix scan as our predicate.
</a><a href="#h31-0-5" id="h31-0-5" class="i">+
</a><a href="#h31-0-6" id="h31-0-6" class="i">+# Write some initial data.
</a><a href="#h31-0-7" id="h31-0-7" class="i">+import a=0 ba=0 bb=0
</a><a href="#h31-0-8" id="h31-0-8" class="i">+---
</a><a href="#h31-0-9" id="h31-0-9" class="i">+ok
</a><a href="#h31-0-10" id="h31-0-10" class="i">+
</a><a href="#h31-0-11" id="h31-0-11" class="i">+t1: begin
</a><a href="#h31-0-12" id="h31-0-12" class="i">+t2: begin
</a><a href="#h31-0-13" id="h31-0-13" class="i">+---
</a><a href="#h31-0-14" id="h31-0-14" class="i">+ok
</a><a href="#h31-0-15" id="h31-0-15" class="i">+
</a><a href="#h31-0-16" id="h31-0-16" class="i">+t1: scan_prefix b
</a><a href="#h31-0-17" id="h31-0-17" class="i">+---
</a><a href="#h31-0-18" id="h31-0-18" class="i">+t1: ba → 0
</a><a href="#h31-0-19" id="h31-0-19" class="i">+t1: bb → 0
</a><a href="#h31-0-20" id="h31-0-20" class="i">+
</a><a href="#h31-0-21" id="h31-0-21" class="i">+t2: delete ba
</a><a href="#h31-0-22" id="h31-0-22" class="i">+t2: set bc=2
</a><a href="#h31-0-23" id="h31-0-23" class="i">+t2: commit
</a><a href="#h31-0-24" id="h31-0-24" class="i">+---
</a><a href="#h31-0-25" id="h31-0-25" class="i">+ok
</a><a href="#h31-0-26" id="h31-0-26" class="i">+
</a><a href="#h31-0-27" id="h31-0-27" class="i">+t1: scan_prefix b
</a><a href="#h31-0-28" id="h31-0-28" class="i">+---
</a><a href="#h31-0-29" id="h31-0-29" class="i">+t1: ba → 0
</a><a href="#h31-0-30" id="h31-0-30" class="i">+t1: bb → 0
</a><b>diff --git a/<a id="h32" href="../file/src/storage/testscripts/mvcc/anomaly_read_skew.html">src/storage/testscripts/mvcc/anomaly_read_skew</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_read_skew.html">src/storage/testscripts/mvcc/anomaly_read_skew</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+# Read skew is when t1 reads a and b, but t2 modifies b in between the
</a><a href="#h32-0-1" id="h32-0-1" class="i">+# reads. Snapshot isolation prevents this.
</a><a href="#h32-0-2" id="h32-0-2" class="i">+
</a><a href="#h32-0-3" id="h32-0-3" class="i">+# Set up some initial data.
</a><a href="#h32-0-4" id="h32-0-4" class="i">+import a=0 b=0
</a><a href="#h32-0-5" id="h32-0-5" class="i">+---
</a><a href="#h32-0-6" id="h32-0-6" class="i">+ok
</a><a href="#h32-0-7" id="h32-0-7" class="i">+
</a><a href="#h32-0-8" id="h32-0-8" class="i">+t1: begin
</a><a href="#h32-0-9" id="h32-0-9" class="i">+t2: begin
</a><a href="#h32-0-10" id="h32-0-10" class="i">+---
</a><a href="#h32-0-11" id="h32-0-11" class="i">+ok
</a><a href="#h32-0-12" id="h32-0-12" class="i">+
</a><a href="#h32-0-13" id="h32-0-13" class="i">+t1: get a
</a><a href="#h32-0-14" id="h32-0-14" class="i">+---
</a><a href="#h32-0-15" id="h32-0-15" class="i">+t1: a → 0
</a><a href="#h32-0-16" id="h32-0-16" class="i">+
</a><a href="#h32-0-17" id="h32-0-17" class="i">+t2: set a=2
</a><a href="#h32-0-18" id="h32-0-18" class="i">+t2: set b=2
</a><a href="#h32-0-19" id="h32-0-19" class="i">+t2: commit
</a><a href="#h32-0-20" id="h32-0-20" class="i">+---
</a><a href="#h32-0-21" id="h32-0-21" class="i">+ok
</a><a href="#h32-0-22" id="h32-0-22" class="i">+
</a><a href="#h32-0-23" id="h32-0-23" class="i">+t1: get b
</a><a href="#h32-0-24" id="h32-0-24" class="i">+---
</a><a href="#h32-0-25" id="h32-0-25" class="i">+t1: b → 0
</a><b>diff --git a/<a id="h33" href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,36 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+# Write skew is when t1 reads a and writes it to b while t2 reads b and writes
</a><a href="#h33-0-1" id="h33-0-1" class="i">+# it to a. Snapshot isolation does prevent this, which is expected, so we assert
</a><a href="#h33-0-2" id="h33-0-2" class="i">+# the anomalous behavior. Fixing this would require implementing serializable
</a><a href="#h33-0-3" id="h33-0-3" class="i">+# snapshot isolation.
</a><a href="#h33-0-4" id="h33-0-4" class="i">+
</a><a href="#h33-0-5" id="h33-0-5" class="i">+# Write some initial data.
</a><a href="#h33-0-6" id="h33-0-6" class="i">+import a=1 b=2
</a><a href="#h33-0-7" id="h33-0-7" class="i">+---
</a><a href="#h33-0-8" id="h33-0-8" class="i">+ok
</a><a href="#h33-0-9" id="h33-0-9" class="i">+
</a><a href="#h33-0-10" id="h33-0-10" class="i">+t1: begin
</a><a href="#h33-0-11" id="h33-0-11" class="i">+t2: begin
</a><a href="#h33-0-12" id="h33-0-12" class="i">+---
</a><a href="#h33-0-13" id="h33-0-13" class="i">+ok
</a><a href="#h33-0-14" id="h33-0-14" class="i">+
</a><a href="#h33-0-15" id="h33-0-15" class="i">+t1: get a
</a><a href="#h33-0-16" id="h33-0-16" class="i">+t2: get b
</a><a href="#h33-0-17" id="h33-0-17" class="i">+---
</a><a href="#h33-0-18" id="h33-0-18" class="i">+t1: a → 1
</a><a href="#h33-0-19" id="h33-0-19" class="i">+t2: b → 2
</a><a href="#h33-0-20" id="h33-0-20" class="i">+
</a><a href="#h33-0-21" id="h33-0-21" class="i">+t1: set b=1
</a><a href="#h33-0-22" id="h33-0-22" class="i">+t2: set a=2
</a><a href="#h33-0-23" id="h33-0-23" class="i">+---
</a><a href="#h33-0-24" id="h33-0-24" class="i">+ok
</a><a href="#h33-0-25" id="h33-0-25" class="i">+
</a><a href="#h33-0-26" id="h33-0-26" class="i">+t1: commit
</a><a href="#h33-0-27" id="h33-0-27" class="i">+t2: commit
</a><a href="#h33-0-28" id="h33-0-28" class="i">+---
</a><a href="#h33-0-29" id="h33-0-29" class="i">+ok
</a><a href="#h33-0-30" id="h33-0-30" class="i">+
</a><a href="#h33-0-31" id="h33-0-31" class="i">+t3: begin readonly
</a><a href="#h33-0-32" id="h33-0-32" class="i">+t3: scan
</a><a href="#h33-0-33" id="h33-0-33" class="i">+---
</a><a href="#h33-0-34" id="h33-0-34" class="i">+t3: a → 2
</a><a href="#h33-0-35" id="h33-0-35" class="i">+t3: b → 1
</a><b>diff --git a/<a id="h34" href="../file/src/storage/testscripts/mvcc/begin.html">src/storage/testscripts/mvcc/begin</a> b/<a href="../file/src/storage/testscripts/mvcc/begin.html">src/storage/testscripts/mvcc/begin</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,49 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+# Begin creates new transactions at increasing versions, with concurrent
</a><a href="#h34-0-1" id="h34-0-1" class="i">+# transactions in their active sets.
</a><a href="#h34-0-2" id="h34-0-2" class="i">+
</a><a href="#h34-0-3" id="h34-0-3" class="i">+# Start t1 at v1, with an empty active set. Dump raw engine operations to ensure
</a><a href="#h34-0-4" id="h34-0-4" class="i">+# it bumps the next version and registers itself as active.
</a><a href="#h34-0-5" id="h34-0-5" class="i">+t1: begin [ops]
</a><a href="#h34-0-6" id="h34-0-6" class="i">+t1: state
</a><a href="#h34-0-7" id="h34-0-7" class="i">+---
</a><a href="#h34-0-8" id="h34-0-8" class="i">+t1: engine set NextVersion → 2
</a><a href="#h34-0-9" id="h34-0-9" class="i">+t1: engine set TxnActive(1) → []
</a><a href="#h34-0-10" id="h34-0-10" class="i">+t1: v1 rw active={}
</a><a href="#h34-0-11" id="h34-0-11" class="i">+
</a><a href="#h34-0-12" id="h34-0-12" class="i">+# t2 should have v2, and t1 in its active set. It should persist a snapshot of
</a><a href="#h34-0-13" id="h34-0-13" class="i">+# its active set.
</a><a href="#h34-0-14" id="h34-0-14" class="i">+t2: begin [ops]
</a><a href="#h34-0-15" id="h34-0-15" class="i">+t2: state
</a><a href="#h34-0-16" id="h34-0-16" class="i">+---
</a><a href="#h34-0-17" id="h34-0-17" class="i">+t2: engine set NextVersion → 3
</a><a href="#h34-0-18" id="h34-0-18" class="i">+t2: engine set TxnActiveSnapshot(2) → {1}
</a><a href="#h34-0-19" id="h34-0-19" class="i">+t2: engine set TxnActive(2) → []
</a><a href="#h34-0-20" id="h34-0-20" class="i">+t2: v2 rw active={1}
</a><a href="#h34-0-21" id="h34-0-21" class="i">+
</a><a href="#h34-0-22" id="h34-0-22" class="i">+# Similarly for t3.
</a><a href="#h34-0-23" id="h34-0-23" class="i">+t3: begin [ops]
</a><a href="#h34-0-24" id="h34-0-24" class="i">+t3: state
</a><a href="#h34-0-25" id="h34-0-25" class="i">+---
</a><a href="#h34-0-26" id="h34-0-26" class="i">+t3: engine set NextVersion → 4
</a><a href="#h34-0-27" id="h34-0-27" class="i">+t3: engine set TxnActiveSnapshot(3) → {1,2}
</a><a href="#h34-0-28" id="h34-0-28" class="i">+t3: engine set TxnActive(3) → []
</a><a href="#h34-0-29" id="h34-0-29" class="i">+t3: v3 rw active={1,2}
</a><a href="#h34-0-30" id="h34-0-30" class="i">+
</a><a href="#h34-0-31" id="h34-0-31" class="i">+# Now, commit t2, which unregisters it.
</a><a href="#h34-0-32" id="h34-0-32" class="i">+t2: commit [ops]
</a><a href="#h34-0-33" id="h34-0-33" class="i">+---
</a><a href="#h34-0-34" id="h34-0-34" class="i">+t2: engine delete TxnActive(2)
</a><a href="#h34-0-35" id="h34-0-35" class="i">+
</a><a href="#h34-0-36" id="h34-0-36" class="i">+# It should still be in t3&#39;s active set.
</a><a href="#h34-0-37" id="h34-0-37" class="i">+t3: state
</a><a href="#h34-0-38" id="h34-0-38" class="i">+---
</a><a href="#h34-0-39" id="h34-0-39" class="i">+t3: v3 rw active={1,2}
</a><a href="#h34-0-40" id="h34-0-40" class="i">+
</a><a href="#h34-0-41" id="h34-0-41" class="i">+# But not in a new t4.
</a><a href="#h34-0-42" id="h34-0-42" class="i">+t4: begin [ops]
</a><a href="#h34-0-43" id="h34-0-43" class="i">+t4: state
</a><a href="#h34-0-44" id="h34-0-44" class="i">+---
</a><a href="#h34-0-45" id="h34-0-45" class="i">+t4: engine set NextVersion → 5
</a><a href="#h34-0-46" id="h34-0-46" class="i">+t4: engine set TxnActiveSnapshot(4) → {1,3}
</a><a href="#h34-0-47" id="h34-0-47" class="i">+t4: engine set TxnActive(4) → []
</a><a href="#h34-0-48" id="h34-0-48" class="i">+t4: v4 rw active={1,3}
</a><b>diff --git a/<a id="h35" href="../file/src/storage/testscripts/mvcc/begin_as_of.html">src/storage/testscripts/mvcc/begin_as_of</a> b/<a href="../file/src/storage/testscripts/mvcc/begin_as_of.html">src/storage/testscripts/mvcc/begin_as_of</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,108 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+# Begin read-only as-of should provide a view of a historical version.
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+# Start a concurrent transaction at v1 that should be invisible.
</a><a href="#h35-0-3" id="h35-0-3" class="i">+t1: begin
</a><a href="#h35-0-4" id="h35-0-4" class="i">+t1: set other=1
</a><a href="#h35-0-5" id="h35-0-5" class="i">+---
</a><a href="#h35-0-6" id="h35-0-6" class="i">+ok
</a><a href="#h35-0-7" id="h35-0-7" class="i">+
</a><a href="#h35-0-8" id="h35-0-8" class="i">+# Write and commit a key at v2.
</a><a href="#h35-0-9" id="h35-0-9" class="i">+t2: begin
</a><a href="#h35-0-10" id="h35-0-10" class="i">+t2: set key=2
</a><a href="#h35-0-11" id="h35-0-11" class="i">+t2: commit
</a><a href="#h35-0-12" id="h35-0-12" class="i">+---
</a><a href="#h35-0-13" id="h35-0-13" class="i">+ok
</a><a href="#h35-0-14" id="h35-0-14" class="i">+
</a><a href="#h35-0-15" id="h35-0-15" class="i">+# Write another version at v3, but don&#39;t commit it yet.
</a><a href="#h35-0-16" id="h35-0-16" class="i">+t3: begin
</a><a href="#h35-0-17" id="h35-0-17" class="i">+t3: set key=3
</a><a href="#h35-0-18" id="h35-0-18" class="i">+---
</a><a href="#h35-0-19" id="h35-0-19" class="i">+ok
</a><a href="#h35-0-20" id="h35-0-20" class="i">+
</a><a href="#h35-0-21" id="h35-0-21" class="i">+dump
</a><a href="#h35-0-22" id="h35-0-22" class="i">+---
</a><a href="#h35-0-23" id="h35-0-23" class="i">+NextVersion → 4
</a><a href="#h35-0-24" id="h35-0-24" class="i">+TxnActive(1) → []
</a><a href="#h35-0-25" id="h35-0-25" class="i">+TxnActive(3) → []
</a><a href="#h35-0-26" id="h35-0-26" class="i">+TxnActiveSnapshot(2) → {1}
</a><a href="#h35-0-27" id="h35-0-27" class="i">+TxnActiveSnapshot(3) → {1}
</a><a href="#h35-0-28" id="h35-0-28" class="i">+TxnWrite(1, &quot;other&quot;) → []
</a><a href="#h35-0-29" id="h35-0-29" class="i">+TxnWrite(3, &quot;key&quot;) → []
</a><a href="#h35-0-30" id="h35-0-30" class="i">+Version(&quot;key&quot;, 2) → &quot;2&quot;
</a><a href="#h35-0-31" id="h35-0-31" class="i">+Version(&quot;key&quot;, 3) → &quot;3&quot;
</a><a href="#h35-0-32" id="h35-0-32" class="i">+Version(&quot;other&quot;, 1) → &quot;1&quot;
</a><a href="#h35-0-33" id="h35-0-33" class="i">+
</a><a href="#h35-0-34" id="h35-0-34" class="i">+# Start a read-only transaction as-of version 3. It should only see key=2
</a><a href="#h35-0-35" id="h35-0-35" class="i">+# because t1 and t3 haven&#39;t committed yet. It shouldn&#39;t write any state.
</a><a href="#h35-0-36" id="h35-0-36" class="i">+t4: begin readonly as_of=3 [ops]
</a><a href="#h35-0-37" id="h35-0-37" class="i">+t4: state
</a><a href="#h35-0-38" id="h35-0-38" class="i">+---
</a><a href="#h35-0-39" id="h35-0-39" class="i">+t4: v3 ro active={1}
</a><a href="#h35-0-40" id="h35-0-40" class="i">+
</a><a href="#h35-0-41" id="h35-0-41" class="i">+t4: scan
</a><a href="#h35-0-42" id="h35-0-42" class="i">+---
</a><a href="#h35-0-43" id="h35-0-43" class="i">+t4: key → 2
</a><a href="#h35-0-44" id="h35-0-44" class="i">+
</a><a href="#h35-0-45" id="h35-0-45" class="i">+# Writes should error.
</a><a href="#h35-0-46" id="h35-0-46" class="i">+t4: !set foo=bar
</a><a href="#h35-0-47" id="h35-0-47" class="i">+t4: !delete foo
</a><a href="#h35-0-48" id="h35-0-48" class="i">+---
</a><a href="#h35-0-49" id="h35-0-49" class="i">+t4: Error: read-only transaction
</a><a href="#h35-0-50" id="h35-0-50" class="i">+t4: Error: read-only transaction
</a><a href="#h35-0-51" id="h35-0-51" class="i">+
</a><a href="#h35-0-52" id="h35-0-52" class="i">+# t1 and t3 commit. Their writes still shouldn&#39;t be visible to t4, since
</a><a href="#h35-0-53" id="h35-0-53" class="i">+# versions must be stable.
</a><a href="#h35-0-54" id="h35-0-54" class="i">+t1: commit
</a><a href="#h35-0-55" id="h35-0-55" class="i">+t3: commit
</a><a href="#h35-0-56" id="h35-0-56" class="i">+---
</a><a href="#h35-0-57" id="h35-0-57" class="i">+ok
</a><a href="#h35-0-58" id="h35-0-58" class="i">+
</a><a href="#h35-0-59" id="h35-0-59" class="i">+t4: scan
</a><a href="#h35-0-60" id="h35-0-60" class="i">+---
</a><a href="#h35-0-61" id="h35-0-61" class="i">+t4: key → 2
</a><a href="#h35-0-62" id="h35-0-62" class="i">+
</a><a href="#h35-0-63" id="h35-0-63" class="i">+# A new transaction t5 running as-of v3 shouldn&#39;t see them either.
</a><a href="#h35-0-64" id="h35-0-64" class="i">+t5: begin readonly as_of=3
</a><a href="#h35-0-65" id="h35-0-65" class="i">+t5: state
</a><a href="#h35-0-66" id="h35-0-66" class="i">+---
</a><a href="#h35-0-67" id="h35-0-67" class="i">+t5: v3 ro active={1}
</a><a href="#h35-0-68" id="h35-0-68" class="i">+
</a><a href="#h35-0-69" id="h35-0-69" class="i">+t5: scan
</a><a href="#h35-0-70" id="h35-0-70" class="i">+---
</a><a href="#h35-0-71" id="h35-0-71" class="i">+t5: key → 2
</a><a href="#h35-0-72" id="h35-0-72" class="i">+
</a><a href="#h35-0-73" id="h35-0-73" class="i">+# Committing and rolling back readonly txns is a noop.
</a><a href="#h35-0-74" id="h35-0-74" class="i">+t4: commit [ops]
</a><a href="#h35-0-75" id="h35-0-75" class="i">+t5: rollback [ops]
</a><a href="#h35-0-76" id="h35-0-76" class="i">+---
</a><a href="#h35-0-77" id="h35-0-77" class="i">+ok
</a><a href="#h35-0-78" id="h35-0-78" class="i">+
</a><a href="#h35-0-79" id="h35-0-79" class="i">+# Commit a new value at version 4.
</a><a href="#h35-0-80" id="h35-0-80" class="i">+t6: begin
</a><a href="#h35-0-81" id="h35-0-81" class="i">+t6: state
</a><a href="#h35-0-82" id="h35-0-82" class="i">+t6: set key=4
</a><a href="#h35-0-83" id="h35-0-83" class="i">+t6: commit
</a><a href="#h35-0-84" id="h35-0-84" class="i">+---
</a><a href="#h35-0-85" id="h35-0-85" class="i">+t6: v4 rw active={}
</a><a href="#h35-0-86" id="h35-0-86" class="i">+
</a><a href="#h35-0-87" id="h35-0-87" class="i">+# A snapshot at version 4 should see the old writes, but not those of t6 at v4
</a><a href="#h35-0-88" id="h35-0-88" class="i">+# because as_of is at the start of the version.
</a><a href="#h35-0-89" id="h35-0-89" class="i">+t7: begin readonly as_of=4
</a><a href="#h35-0-90" id="h35-0-90" class="i">+t7: scan
</a><a href="#h35-0-91" id="h35-0-91" class="i">+---
</a><a href="#h35-0-92" id="h35-0-92" class="i">+t7: key → 3
</a><a href="#h35-0-93" id="h35-0-93" class="i">+t7: other → 1
</a><a href="#h35-0-94" id="h35-0-94" class="i">+
</a><a href="#h35-0-95" id="h35-0-95" class="i">+# Running as_of future versions should error, including the next version.
</a><a href="#h35-0-96" id="h35-0-96" class="i">+t8: !begin readonly as_of=5
</a><a href="#h35-0-97" id="h35-0-97" class="i">+t8: !begin readonly as_of=9
</a><a href="#h35-0-98" id="h35-0-98" class="i">+---
</a><a href="#h35-0-99" id="h35-0-99" class="i">+t8: Error: invalid input: version 5 does not exist
</a><a href="#h35-0-100" id="h35-0-100" class="i">+t8: Error: invalid input: version 9 does not exist
</a><a href="#h35-0-101" id="h35-0-101" class="i">+
</a><a href="#h35-0-102" id="h35-0-102" class="i">+# Version 0 works though, but doesn&#39;t show anything.
</a><a href="#h35-0-103" id="h35-0-103" class="i">+t8: begin readonly as_of=0
</a><a href="#h35-0-104" id="h35-0-104" class="i">+t8: state
</a><a href="#h35-0-105" id="h35-0-105" class="i">+t8: scan
</a><a href="#h35-0-106" id="h35-0-106" class="i">+---
</a><a href="#h35-0-107" id="h35-0-107" class="i">+t8: v0 ro active={}
</a><b>diff --git a/<a id="h36" href="../file/src/storage/testscripts/mvcc/begin_readonly.html">src/storage/testscripts/mvcc/begin_readonly</a> b/<a href="../file/src/storage/testscripts/mvcc/begin_readonly.html">src/storage/testscripts/mvcc/begin_readonly</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+# Begin read-only should not create a new version, it should run in the next
</a><a href="#h36-0-1" id="h36-0-1" class="i">+# version but using the current active set.
</a><a href="#h36-0-2" id="h36-0-2" class="i">+
</a><a href="#h36-0-3" id="h36-0-3" class="i">+# Start t1 read-only at v1. It shouldn&#39;t bump the version nor write any state.
</a><a href="#h36-0-4" id="h36-0-4" class="i">+t1: begin readonly [ops]
</a><a href="#h36-0-5" id="h36-0-5" class="i">+t1: state
</a><a href="#h36-0-6" id="h36-0-6" class="i">+---
</a><a href="#h36-0-7" id="h36-0-7" class="i">+t1: v1 ro active={}
</a><a href="#h36-0-8" id="h36-0-8" class="i">+
</a><a href="#h36-0-9" id="h36-0-9" class="i">+# Writes should error.
</a><a href="#h36-0-10" id="h36-0-10" class="i">+t1: !set foo=bar
</a><a href="#h36-0-11" id="h36-0-11" class="i">+t1: !delete foo
</a><a href="#h36-0-12" id="h36-0-12" class="i">+---
</a><a href="#h36-0-13" id="h36-0-13" class="i">+t1: Error: read-only transaction
</a><a href="#h36-0-14" id="h36-0-14" class="i">+t1: Error: read-only transaction
</a><a href="#h36-0-15" id="h36-0-15" class="i">+
</a><a href="#h36-0-16" id="h36-0-16" class="i">+# Start a new read-write transaction, then another read-only transaction which
</a><a href="#h36-0-17" id="h36-0-17" class="i">+# should have it in its active set. t1 should not be in the active set, because
</a><a href="#h36-0-18" id="h36-0-18" class="i">+# it&#39;s read-only.
</a><a href="#h36-0-19" id="h36-0-19" class="i">+t2: begin
</a><a href="#h36-0-20" id="h36-0-20" class="i">+t2: state
</a><a href="#h36-0-21" id="h36-0-21" class="i">+---
</a><a href="#h36-0-22" id="h36-0-22" class="i">+t2: v1 rw active={}
</a><a href="#h36-0-23" id="h36-0-23" class="i">+
</a><a href="#h36-0-24" id="h36-0-24" class="i">+t3: begin readonly [ops]
</a><a href="#h36-0-25" id="h36-0-25" class="i">+t3: state
</a><a href="#h36-0-26" id="h36-0-26" class="i">+---
</a><a href="#h36-0-27" id="h36-0-27" class="i">+t3: v2 ro active={1}
</a><a href="#h36-0-28" id="h36-0-28" class="i">+
</a><a href="#h36-0-29" id="h36-0-29" class="i">+# t2 also shouldn&#39;t be in t1&#39;s active set. Visibility for t2&#39;s writes are
</a><a href="#h36-0-30" id="h36-0-30" class="i">+# handled explicitly for t1.
</a><a href="#h36-0-31" id="h36-0-31" class="i">+t2: state
</a><a href="#h36-0-32" id="h36-0-32" class="i">+---
</a><a href="#h36-0-33" id="h36-0-33" class="i">+t2: v1 rw active={}
</a><a href="#h36-0-34" id="h36-0-34" class="i">+
</a><a href="#h36-0-35" id="h36-0-35" class="i">+# Both committing and rolling back read-only transactions are noops.
</a><a href="#h36-0-36" id="h36-0-36" class="i">+t1: commit [ops]
</a><a href="#h36-0-37" id="h36-0-37" class="i">+t3: commit [ops]
</a><a href="#h36-0-38" id="h36-0-38" class="i">+---
</a><a href="#h36-0-39" id="h36-0-39" class="i">+ok
</a><b>diff --git a/<a id="h37" href="../file/src/storage/testscripts/mvcc/delete.html">src/storage/testscripts/mvcc/delete</a> b/<a href="../file/src/storage/testscripts/mvcc/delete.html">src/storage/testscripts/mvcc/delete</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,62 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+# Deletes should work on both existing, missing, and deleted keys.
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+import 1 a=1 b=1 x=
</a><a href="#h37-0-3" id="h37-0-3" class="i">+---
</a><a href="#h37-0-4" id="h37-0-4" class="i">+ok
</a><a href="#h37-0-5" id="h37-0-5" class="i">+
</a><a href="#h37-0-6" id="h37-0-6" class="i">+# Delete an existing, missing, and deleted key. Show engine operations.
</a><a href="#h37-0-7" id="h37-0-7" class="i">+t1: begin
</a><a href="#h37-0-8" id="h37-0-8" class="i">+t1: delete a m x [ops]
</a><a href="#h37-0-9" id="h37-0-9" class="i">+---
</a><a href="#h37-0-10" id="h37-0-10" class="i">+t1: engine set TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h37-0-11" id="h37-0-11" class="i">+t1: engine set Version(&quot;a&quot;, 2) → None
</a><a href="#h37-0-12" id="h37-0-12" class="i">+t1: engine set TxnWrite(2, &quot;m&quot;) → []
</a><a href="#h37-0-13" id="h37-0-13" class="i">+t1: engine set Version(&quot;m&quot;, 2) → None
</a><a href="#h37-0-14" id="h37-0-14" class="i">+t1: engine set TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h37-0-15" id="h37-0-15" class="i">+t1: engine set Version(&quot;x&quot;, 2) → None
</a><a href="#h37-0-16" id="h37-0-16" class="i">+
</a><a href="#h37-0-17" id="h37-0-17" class="i">+t1: scan
</a><a href="#h37-0-18" id="h37-0-18" class="i">+---
</a><a href="#h37-0-19" id="h37-0-19" class="i">+t1: b → 1
</a><a href="#h37-0-20" id="h37-0-20" class="i">+
</a><a href="#h37-0-21" id="h37-0-21" class="i">+# Set and then delete a key, both an existing an missing one.
</a><a href="#h37-0-22" id="h37-0-22" class="i">+t1: set b=2 c=2 [ops]
</a><a href="#h37-0-23" id="h37-0-23" class="i">+---
</a><a href="#h37-0-24" id="h37-0-24" class="i">+t1: engine set TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h37-0-25" id="h37-0-25" class="i">+t1: engine set Version(&quot;b&quot;, 2) → &quot;2&quot;
</a><a href="#h37-0-26" id="h37-0-26" class="i">+t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h37-0-27" id="h37-0-27" class="i">+t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h37-0-28" id="h37-0-28" class="i">+
</a><a href="#h37-0-29" id="h37-0-29" class="i">+t1: scan
</a><a href="#h37-0-30" id="h37-0-30" class="i">+---
</a><a href="#h37-0-31" id="h37-0-31" class="i">+t1: b → 2
</a><a href="#h37-0-32" id="h37-0-32" class="i">+t1: c → 2
</a><a href="#h37-0-33" id="h37-0-33" class="i">+
</a><a href="#h37-0-34" id="h37-0-34" class="i">+t1: delete b c [ops]
</a><a href="#h37-0-35" id="h37-0-35" class="i">+---
</a><a href="#h37-0-36" id="h37-0-36" class="i">+t1: engine set TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h37-0-37" id="h37-0-37" class="i">+t1: engine set Version(&quot;b&quot;, 2) → None
</a><a href="#h37-0-38" id="h37-0-38" class="i">+t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h37-0-39" id="h37-0-39" class="i">+t1: engine set Version(&quot;c&quot;, 2) → None
</a><a href="#h37-0-40" id="h37-0-40" class="i">+
</a><a href="#h37-0-41" id="h37-0-41" class="i">+t1: scan
</a><a href="#h37-0-42" id="h37-0-42" class="i">+---
</a><a href="#h37-0-43" id="h37-0-43" class="i">+ok
</a><a href="#h37-0-44" id="h37-0-44" class="i">+
</a><a href="#h37-0-45" id="h37-0-45" class="i">+dump
</a><a href="#h37-0-46" id="h37-0-46" class="i">+---
</a><a href="#h37-0-47" id="h37-0-47" class="i">+NextVersion → 3
</a><a href="#h37-0-48" id="h37-0-48" class="i">+TxnActive(2) → []
</a><a href="#h37-0-49" id="h37-0-49" class="i">+TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h37-0-50" id="h37-0-50" class="i">+TxnWrite(2, &quot;b&quot;) → []
</a><a href="#h37-0-51" id="h37-0-51" class="i">+TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h37-0-52" id="h37-0-52" class="i">+TxnWrite(2, &quot;m&quot;) → []
</a><a href="#h37-0-53" id="h37-0-53" class="i">+TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h37-0-54" id="h37-0-54" class="i">+Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h37-0-55" id="h37-0-55" class="i">+Version(&quot;a&quot;, 2) → None
</a><a href="#h37-0-56" id="h37-0-56" class="i">+Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h37-0-57" id="h37-0-57" class="i">+Version(&quot;b&quot;, 2) → None
</a><a href="#h37-0-58" id="h37-0-58" class="i">+Version(&quot;c&quot;, 2) → None
</a><a href="#h37-0-59" id="h37-0-59" class="i">+Version(&quot;m&quot;, 2) → None
</a><a href="#h37-0-60" id="h37-0-60" class="i">+Version(&quot;x&quot;, 1) → None
</a><a href="#h37-0-61" id="h37-0-61" class="i">+Version(&quot;x&quot;, 2) → None
</a><b>diff --git a/<a id="h38" href="../file/src/storage/testscripts/mvcc/delete_conflict.html">src/storage/testscripts/mvcc/delete_conflict</a> b/<a href="../file/src/storage/testscripts/mvcc/delete_conflict.html">src/storage/testscripts/mvcc/delete_conflict</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+# Delete should return serialization errors both for uncommitted versions
</a><a href="#h38-0-1" id="h38-0-1" class="i">+# (past and future), and future committed versions.
</a><a href="#h38-0-2" id="h38-0-2" class="i">+
</a><a href="#h38-0-3" id="h38-0-3" class="i">+t1: begin
</a><a href="#h38-0-4" id="h38-0-4" class="i">+t2: begin
</a><a href="#h38-0-5" id="h38-0-5" class="i">+t3: begin
</a><a href="#h38-0-6" id="h38-0-6" class="i">+t4: begin
</a><a href="#h38-0-7" id="h38-0-7" class="i">+---
</a><a href="#h38-0-8" id="h38-0-8" class="i">+ok
</a><a href="#h38-0-9" id="h38-0-9" class="i">+
</a><a href="#h38-0-10" id="h38-0-10" class="i">+t1: set a=1
</a><a href="#h38-0-11" id="h38-0-11" class="i">+t3: set c=3
</a><a href="#h38-0-12" id="h38-0-12" class="i">+t4: set d=4
</a><a href="#h38-0-13" id="h38-0-13" class="i">+t4: commit
</a><a href="#h38-0-14" id="h38-0-14" class="i">+---
</a><a href="#h38-0-15" id="h38-0-15" class="i">+ok
</a><a href="#h38-0-16" id="h38-0-16" class="i">+
</a><a href="#h38-0-17" id="h38-0-17" class="i">+t2: !delete a # past uncommitted
</a><a href="#h38-0-18" id="h38-0-18" class="i">+t2: !delete c # future uncommitted
</a><a href="#h38-0-19" id="h38-0-19" class="i">+t2: !delete d # future committed
</a><a href="#h38-0-20" id="h38-0-20" class="i">+---
</a><a href="#h38-0-21" id="h38-0-21" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h38-0-22" id="h38-0-22" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h38-0-23" id="h38-0-23" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h38-0-24" id="h38-0-24" class="i">+
</a><a href="#h38-0-25" id="h38-0-25" class="i">+dump
</a><a href="#h38-0-26" id="h38-0-26" class="i">+---
</a><a href="#h38-0-27" id="h38-0-27" class="i">+NextVersion → 5
</a><a href="#h38-0-28" id="h38-0-28" class="i">+TxnActive(1) → []
</a><a href="#h38-0-29" id="h38-0-29" class="i">+TxnActive(2) → []
</a><a href="#h38-0-30" id="h38-0-30" class="i">+TxnActive(3) → []
</a><a href="#h38-0-31" id="h38-0-31" class="i">+TxnActiveSnapshot(2) → {1}
</a><a href="#h38-0-32" id="h38-0-32" class="i">+TxnActiveSnapshot(3) → {1,2}
</a><a href="#h38-0-33" id="h38-0-33" class="i">+TxnActiveSnapshot(4) → {1,2,3}
</a><a href="#h38-0-34" id="h38-0-34" class="i">+TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h38-0-35" id="h38-0-35" class="i">+TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h38-0-36" id="h38-0-36" class="i">+Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h38-0-37" id="h38-0-37" class="i">+Version(&quot;c&quot;, 3) → &quot;3&quot;
</a><a href="#h38-0-38" id="h38-0-38" class="i">+Version(&quot;d&quot;, 4) → &quot;4&quot;
</a><b>diff --git a/<a id="h39" href="../file/src/storage/testscripts/mvcc/get.html">src/storage/testscripts/mvcc/get</a> b/<a href="../file/src/storage/testscripts/mvcc/get.html">src/storage/testscripts/mvcc/get</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,21 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+# Get should return the correct latest value.
</a><a href="#h39-0-1" id="h39-0-1" class="i">+
</a><a href="#h39-0-2" id="h39-0-2" class="i">+import 1 key=1 updated=1 deleted=1 tombstone=
</a><a href="#h39-0-3" id="h39-0-3" class="i">+import 2 updated=2 deleted=
</a><a href="#h39-0-4" id="h39-0-4" class="i">+---
</a><a href="#h39-0-5" id="h39-0-5" class="i">+ok
</a><a href="#h39-0-6" id="h39-0-6" class="i">+
</a><a href="#h39-0-7" id="h39-0-7" class="i">+t1: begin readonly
</a><a href="#h39-0-8" id="h39-0-8" class="i">+t1: scan
</a><a href="#h39-0-9" id="h39-0-9" class="i">+---
</a><a href="#h39-0-10" id="h39-0-10" class="i">+t1: key → 1
</a><a href="#h39-0-11" id="h39-0-11" class="i">+t1: updated → 2
</a><a href="#h39-0-12" id="h39-0-12" class="i">+
</a><a href="#h39-0-13" id="h39-0-13" class="i">+# Get results should mirror scan.
</a><a href="#h39-0-14" id="h39-0-14" class="i">+t1: get key updated deleted tombstone missing
</a><a href="#h39-0-15" id="h39-0-15" class="i">+---
</a><a href="#h39-0-16" id="h39-0-16" class="i">+t1: key → 1
</a><a href="#h39-0-17" id="h39-0-17" class="i">+t1: updated → 2
</a><a href="#h39-0-18" id="h39-0-18" class="i">+t1: deleted → None
</a><a href="#h39-0-19" id="h39-0-19" class="i">+t1: tombstone → None
</a><a href="#h39-0-20" id="h39-0-20" class="i">+t1: missing → None
</a><b>diff --git a/<a id="h40" href="../file/src/storage/testscripts/mvcc/get_isolation.html">src/storage/testscripts/mvcc/get_isolation</a> b/<a href="../file/src/storage/testscripts/mvcc/get_isolation.html">src/storage/testscripts/mvcc/get_isolation</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -0,0 +1,46 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+# Get should be isolated from concurrent transactions.
</a><a href="#h40-0-1" id="h40-0-1" class="i">+
</a><a href="#h40-0-2" id="h40-0-2" class="i">+# Past committed.
</a><a href="#h40-0-3" id="h40-0-3" class="i">+t1: begin
</a><a href="#h40-0-4" id="h40-0-4" class="i">+t1: set a=1 b=1 d=1 e=1
</a><a href="#h40-0-5" id="h40-0-5" class="i">+t1: commit
</a><a href="#h40-0-6" id="h40-0-6" class="i">+---
</a><a href="#h40-0-7" id="h40-0-7" class="i">+ok
</a><a href="#h40-0-8" id="h40-0-8" class="i">+
</a><a href="#h40-0-9" id="h40-0-9" class="i">+# Past uncommitted.
</a><a href="#h40-0-10" id="h40-0-10" class="i">+t2: begin
</a><a href="#h40-0-11" id="h40-0-11" class="i">+t2: set a=2 c=2
</a><a href="#h40-0-12" id="h40-0-12" class="i">+t2: delete b
</a><a href="#h40-0-13" id="h40-0-13" class="i">+---
</a><a href="#h40-0-14" id="h40-0-14" class="i">+ok
</a><a href="#h40-0-15" id="h40-0-15" class="i">+
</a><a href="#h40-0-16" id="h40-0-16" class="i">+# Begin the read transaction.
</a><a href="#h40-0-17" id="h40-0-17" class="i">+t3: begin readonly
</a><a href="#h40-0-18" id="h40-0-18" class="i">+---
</a><a href="#h40-0-19" id="h40-0-19" class="i">+ok
</a><a href="#h40-0-20" id="h40-0-20" class="i">+
</a><a href="#h40-0-21" id="h40-0-21" class="i">+# Future committed.
</a><a href="#h40-0-22" id="h40-0-22" class="i">+t4: begin
</a><a href="#h40-0-23" id="h40-0-23" class="i">+t4: set d=3 f=3
</a><a href="#h40-0-24" id="h40-0-24" class="i">+t4: delete e
</a><a href="#h40-0-25" id="h40-0-25" class="i">+t4: commit
</a><a href="#h40-0-26" id="h40-0-26" class="i">+---
</a><a href="#h40-0-27" id="h40-0-27" class="i">+ok
</a><a href="#h40-0-28" id="h40-0-28" class="i">+
</a><a href="#h40-0-29" id="h40-0-29" class="i">+# Future uncommitted.
</a><a href="#h40-0-30" id="h40-0-30" class="i">+t5: begin
</a><a href="#h40-0-31" id="h40-0-31" class="i">+t5: set d=4 g=4
</a><a href="#h40-0-32" id="h40-0-32" class="i">+t5: delete f
</a><a href="#h40-0-33" id="h40-0-33" class="i">+---
</a><a href="#h40-0-34" id="h40-0-34" class="i">+ok
</a><a href="#h40-0-35" id="h40-0-35" class="i">+
</a><a href="#h40-0-36" id="h40-0-36" class="i">+# Get each key.
</a><a href="#h40-0-37" id="h40-0-37" class="i">+t3: get a b c d e f g
</a><a href="#h40-0-38" id="h40-0-38" class="i">+---
</a><a href="#h40-0-39" id="h40-0-39" class="i">+t3: a → 1
</a><a href="#h40-0-40" id="h40-0-40" class="i">+t3: b → 1
</a><a href="#h40-0-41" id="h40-0-41" class="i">+t3: c → None
</a><a href="#h40-0-42" id="h40-0-42" class="i">+t3: d → 1
</a><a href="#h40-0-43" id="h40-0-43" class="i">+t3: e → 1
</a><a href="#h40-0-44" id="h40-0-44" class="i">+t3: f → None
</a><a href="#h40-0-45" id="h40-0-45" class="i">+t3: g → None
</a><b>diff --git a/<a id="h41" href="../file/src/storage/testscripts/mvcc/resume.html">src/storage/testscripts/mvcc/resume</a> b/<a href="../file/src/storage/testscripts/mvcc/resume.html">src/storage/testscripts/mvcc/resume</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,89 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+# Resume should resume a transaction with the same state.
</a><a href="#h41-0-1" id="h41-0-1" class="i">+
</a><a href="#h41-0-2" id="h41-0-2" class="i">+# Commit some visible values.
</a><a href="#h41-0-3" id="h41-0-3" class="i">+t1: begin
</a><a href="#h41-0-4" id="h41-0-4" class="i">+t1: set a=1 b=1
</a><a href="#h41-0-5" id="h41-0-5" class="i">+t1: commit
</a><a href="#h41-0-6" id="h41-0-6" class="i">+---
</a><a href="#h41-0-7" id="h41-0-7" class="i">+ok
</a><a href="#h41-0-8" id="h41-0-8" class="i">+
</a><a href="#h41-0-9" id="h41-0-9" class="i">+# We then start three transactions, of which we will resume t3.  We commit t2
</a><a href="#h41-0-10" id="h41-0-10" class="i">+# and t4&#39;s changes, which should not be visible, and write a change for t3 which
</a><a href="#h41-0-11" id="h41-0-11" class="i">+# should be visible.
</a><a href="#h41-0-12" id="h41-0-12" class="i">+t2: begin
</a><a href="#h41-0-13" id="h41-0-13" class="i">+t3: begin
</a><a href="#h41-0-14" id="h41-0-14" class="i">+t4: begin
</a><a href="#h41-0-15" id="h41-0-15" class="i">+---
</a><a href="#h41-0-16" id="h41-0-16" class="i">+ok
</a><a href="#h41-0-17" id="h41-0-17" class="i">+
</a><a href="#h41-0-18" id="h41-0-18" class="i">+t2: set a=2
</a><a href="#h41-0-19" id="h41-0-19" class="i">+t3: set b=3
</a><a href="#h41-0-20" id="h41-0-20" class="i">+t4: set c=4
</a><a href="#h41-0-21" id="h41-0-21" class="i">+t2: commit
</a><a href="#h41-0-22" id="h41-0-22" class="i">+t4: commit
</a><a href="#h41-0-23" id="h41-0-23" class="i">+---
</a><a href="#h41-0-24" id="h41-0-24" class="i">+ok
</a><a href="#h41-0-25" id="h41-0-25" class="i">+
</a><a href="#h41-0-26" id="h41-0-26" class="i">+# We now resume t3 as t5.
</a><a href="#h41-0-27" id="h41-0-27" class="i">+t3: state
</a><a href="#h41-0-28" id="h41-0-28" class="i">+---
</a><a href="#h41-0-29" id="h41-0-29" class="i">+t3: v3 rw active={2}
</a><a href="#h41-0-30" id="h41-0-30" class="i">+
</a><a href="#h41-0-31" id="h41-0-31" class="i">+t5: resume &#39;{&quot;version&quot;:3, &quot;read_only&quot;:false, &quot;active&quot;:[2]}&#39;
</a><a href="#h41-0-32" id="h41-0-32" class="i">+t5: state
</a><a href="#h41-0-33" id="h41-0-33" class="i">+---
</a><a href="#h41-0-34" id="h41-0-34" class="i">+t5: v3 rw active={2}
</a><a href="#h41-0-35" id="h41-0-35" class="i">+
</a><a href="#h41-0-36" id="h41-0-36" class="i">+# t5 can see its own changes, but not the others.
</a><a href="#h41-0-37" id="h41-0-37" class="i">+t5: scan
</a><a href="#h41-0-38" id="h41-0-38" class="i">+---
</a><a href="#h41-0-39" id="h41-0-39" class="i">+t5: a → 1
</a><a href="#h41-0-40" id="h41-0-40" class="i">+t5: b → 3
</a><a href="#h41-0-41" id="h41-0-41" class="i">+
</a><a href="#h41-0-42" id="h41-0-42" class="i">+# A new transaction should not see t3/5&#39;s uncommitted changes.
</a><a href="#h41-0-43" id="h41-0-43" class="i">+t6: begin
</a><a href="#h41-0-44" id="h41-0-44" class="i">+t6: scan
</a><a href="#h41-0-45" id="h41-0-45" class="i">+---
</a><a href="#h41-0-46" id="h41-0-46" class="i">+t6: a → 2
</a><a href="#h41-0-47" id="h41-0-47" class="i">+t6: b → 1
</a><a href="#h41-0-48" id="h41-0-48" class="i">+t6: c → 4
</a><a href="#h41-0-49" id="h41-0-49" class="i">+
</a><a href="#h41-0-50" id="h41-0-50" class="i">+# Once t5 commits, a separate transaction should see its changes.
</a><a href="#h41-0-51" id="h41-0-51" class="i">+t5: commit [ops]
</a><a href="#h41-0-52" id="h41-0-52" class="i">+---
</a><a href="#h41-0-53" id="h41-0-53" class="i">+t5: engine delete TxnWrite(3, &quot;b&quot;)
</a><a href="#h41-0-54" id="h41-0-54" class="i">+t5: engine delete TxnActive(3)
</a><a href="#h41-0-55" id="h41-0-55" class="i">+
</a><a href="#h41-0-56" id="h41-0-56" class="i">+t7: begin
</a><a href="#h41-0-57" id="h41-0-57" class="i">+t7: scan
</a><a href="#h41-0-58" id="h41-0-58" class="i">+---
</a><a href="#h41-0-59" id="h41-0-59" class="i">+t7: a → 2
</a><a href="#h41-0-60" id="h41-0-60" class="i">+t7: b → 3
</a><a href="#h41-0-61" id="h41-0-61" class="i">+t7: c → 4
</a><a href="#h41-0-62" id="h41-0-62" class="i">+
</a><a href="#h41-0-63" id="h41-0-63" class="i">+# Resuming a committed transaction should error.
</a><a href="#h41-0-64" id="h41-0-64" class="i">+t8: !resume &#39;{&quot;version&quot;:3, &quot;read_only&quot;:false, &quot;active&quot;:[2]}&#39;
</a><a href="#h41-0-65" id="h41-0-65" class="i">+---
</a><a href="#h41-0-66" id="h41-0-66" class="i">+t8: Error: invalid input: no active transaction at version 3
</a><a href="#h41-0-67" id="h41-0-67" class="i">+
</a><a href="#h41-0-68" id="h41-0-68" class="i">+# It should also be possible to start a snapshot transaction in t3 and resume
</a><a href="#h41-0-69" id="h41-0-69" class="i">+# it. It should not see t3&#39;s writes, nor t2&#39;s.
</a><a href="#h41-0-70" id="h41-0-70" class="i">+t8: begin readonly as_of=3
</a><a href="#h41-0-71" id="h41-0-71" class="i">+t8: state
</a><a href="#h41-0-72" id="h41-0-72" class="i">+---
</a><a href="#h41-0-73" id="h41-0-73" class="i">+t8: v3 ro active={2}
</a><a href="#h41-0-74" id="h41-0-74" class="i">+
</a><a href="#h41-0-75" id="h41-0-75" class="i">+t8: scan
</a><a href="#h41-0-76" id="h41-0-76" class="i">+---
</a><a href="#h41-0-77" id="h41-0-77" class="i">+t8: a → 1
</a><a href="#h41-0-78" id="h41-0-78" class="i">+t8: b → 1
</a><a href="#h41-0-79" id="h41-0-79" class="i">+
</a><a href="#h41-0-80" id="h41-0-80" class="i">+t9: resume &#39;{&quot;version&quot;:3, &quot;read_only&quot;:true, &quot;active&quot;:[2]}&#39;
</a><a href="#h41-0-81" id="h41-0-81" class="i">+t9: state
</a><a href="#h41-0-82" id="h41-0-82" class="i">+---
</a><a href="#h41-0-83" id="h41-0-83" class="i">+t9: v3 ro active={2}
</a><a href="#h41-0-84" id="h41-0-84" class="i">+
</a><a href="#h41-0-85" id="h41-0-85" class="i">+t9: scan
</a><a href="#h41-0-86" id="h41-0-86" class="i">+---
</a><a href="#h41-0-87" id="h41-0-87" class="i">+t9: a → 1
</a><a href="#h41-0-88" id="h41-0-88" class="i">+t9: b → 1
</a><b>diff --git a/<a id="h42" href="../file/src/storage/testscripts/mvcc/rollback.html">src/storage/testscripts/mvcc/rollback</a> b/<a href="../file/src/storage/testscripts/mvcc/rollback.html">src/storage/testscripts/mvcc/rollback</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,95 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+# Tests that transaction rollback properly rolls back uncommitted writes
</a><a href="#h42-0-1" id="h42-0-1" class="i">+# allowing other concurrent transactions to write the keys.
</a><a href="#h42-0-2" id="h42-0-2" class="i">+
</a><a href="#h42-0-3" id="h42-0-3" class="i">+import 1 a=0 b=0 c=0 d=0
</a><a href="#h42-0-4" id="h42-0-4" class="i">+---
</a><a href="#h42-0-5" id="h42-0-5" class="i">+ok
</a><a href="#h42-0-6" id="h42-0-6" class="i">+
</a><a href="#h42-0-7" id="h42-0-7" class="i">+# t2 will be rolled back. t1 and t3 are concurrent transactions.
</a><a href="#h42-0-8" id="h42-0-8" class="i">+t1: begin
</a><a href="#h42-0-9" id="h42-0-9" class="i">+t2: begin
</a><a href="#h42-0-10" id="h42-0-10" class="i">+t3: begin
</a><a href="#h42-0-11" id="h42-0-11" class="i">+---
</a><a href="#h42-0-12" id="h42-0-12" class="i">+ok
</a><a href="#h42-0-13" id="h42-0-13" class="i">+
</a><a href="#h42-0-14" id="h42-0-14" class="i">+t1: set a=1
</a><a href="#h42-0-15" id="h42-0-15" class="i">+t2: set b=2
</a><a href="#h42-0-16" id="h42-0-16" class="i">+t2: delete c
</a><a href="#h42-0-17" id="h42-0-17" class="i">+t3: set d=3
</a><a href="#h42-0-18" id="h42-0-18" class="i">+---
</a><a href="#h42-0-19" id="h42-0-19" class="i">+ok
</a><a href="#h42-0-20" id="h42-0-20" class="i">+
</a><a href="#h42-0-21" id="h42-0-21" class="i">+dump
</a><a href="#h42-0-22" id="h42-0-22" class="i">+---
</a><a href="#h42-0-23" id="h42-0-23" class="i">+NextVersion → 5
</a><a href="#h42-0-24" id="h42-0-24" class="i">+TxnActive(2) → []
</a><a href="#h42-0-25" id="h42-0-25" class="i">+TxnActive(3) → []
</a><a href="#h42-0-26" id="h42-0-26" class="i">+TxnActive(4) → []
</a><a href="#h42-0-27" id="h42-0-27" class="i">+TxnActiveSnapshot(3) → {2}
</a><a href="#h42-0-28" id="h42-0-28" class="i">+TxnActiveSnapshot(4) → {2,3}
</a><a href="#h42-0-29" id="h42-0-29" class="i">+TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h42-0-30" id="h42-0-30" class="i">+TxnWrite(3, &quot;b&quot;) → []
</a><a href="#h42-0-31" id="h42-0-31" class="i">+TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h42-0-32" id="h42-0-32" class="i">+TxnWrite(4, &quot;d&quot;) → []
</a><a href="#h42-0-33" id="h42-0-33" class="i">+Version(&quot;a&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-34" id="h42-0-34" class="i">+Version(&quot;a&quot;, 2) → &quot;1&quot;
</a><a href="#h42-0-35" id="h42-0-35" class="i">+Version(&quot;b&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-36" id="h42-0-36" class="i">+Version(&quot;b&quot;, 3) → &quot;2&quot;
</a><a href="#h42-0-37" id="h42-0-37" class="i">+Version(&quot;c&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-38" id="h42-0-38" class="i">+Version(&quot;c&quot;, 3) → None
</a><a href="#h42-0-39" id="h42-0-39" class="i">+Version(&quot;d&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-40" id="h42-0-40" class="i">+Version(&quot;d&quot;, 4) → &quot;3&quot;
</a><a href="#h42-0-41" id="h42-0-41" class="i">+
</a><a href="#h42-0-42" id="h42-0-42" class="i">+# Both t1 and t3 will conflict with t2.
</a><a href="#h42-0-43" id="h42-0-43" class="i">+t1: !set b=1
</a><a href="#h42-0-44" id="h42-0-44" class="i">+t3: !set c=3
</a><a href="#h42-0-45" id="h42-0-45" class="i">+---
</a><a href="#h42-0-46" id="h42-0-46" class="i">+t1: Error: serialization failure, retry transaction
</a><a href="#h42-0-47" id="h42-0-47" class="i">+t3: Error: serialization failure, retry transaction
</a><a href="#h42-0-48" id="h42-0-48" class="i">+
</a><a href="#h42-0-49" id="h42-0-49" class="i">+# When t2 is rolled back, none of its writes will be visible, and t1 and t3 can
</a><a href="#h42-0-50" id="h42-0-50" class="i">+# perform their writes and successfully commit.
</a><a href="#h42-0-51" id="h42-0-51" class="i">+t2: rollback [ops]
</a><a href="#h42-0-52" id="h42-0-52" class="i">+---
</a><a href="#h42-0-53" id="h42-0-53" class="i">+t2: engine delete Version(&quot;b&quot;, 3)
</a><a href="#h42-0-54" id="h42-0-54" class="i">+t2: engine delete TxnWrite(3, &quot;b&quot;)
</a><a href="#h42-0-55" id="h42-0-55" class="i">+t2: engine delete Version(&quot;c&quot;, 3)
</a><a href="#h42-0-56" id="h42-0-56" class="i">+t2: engine delete TxnWrite(3, &quot;c&quot;)
</a><a href="#h42-0-57" id="h42-0-57" class="i">+t2: engine delete TxnActive(3)
</a><a href="#h42-0-58" id="h42-0-58" class="i">+
</a><a href="#h42-0-59" id="h42-0-59" class="i">+t4: begin readonly
</a><a href="#h42-0-60" id="h42-0-60" class="i">+t4: scan
</a><a href="#h42-0-61" id="h42-0-61" class="i">+---
</a><a href="#h42-0-62" id="h42-0-62" class="i">+t4: a → 0
</a><a href="#h42-0-63" id="h42-0-63" class="i">+t4: b → 0
</a><a href="#h42-0-64" id="h42-0-64" class="i">+t4: c → 0
</a><a href="#h42-0-65" id="h42-0-65" class="i">+t4: d → 0
</a><a href="#h42-0-66" id="h42-0-66" class="i">+
</a><a href="#h42-0-67" id="h42-0-67" class="i">+t1: set b=1
</a><a href="#h42-0-68" id="h42-0-68" class="i">+t1: commit
</a><a href="#h42-0-69" id="h42-0-69" class="i">+t3: set c=3
</a><a href="#h42-0-70" id="h42-0-70" class="i">+t3: commit
</a><a href="#h42-0-71" id="h42-0-71" class="i">+---
</a><a href="#h42-0-72" id="h42-0-72" class="i">+ok
</a><a href="#h42-0-73" id="h42-0-73" class="i">+
</a><a href="#h42-0-74" id="h42-0-74" class="i">+t5: begin readonly
</a><a href="#h42-0-75" id="h42-0-75" class="i">+t5: scan
</a><a href="#h42-0-76" id="h42-0-76" class="i">+---
</a><a href="#h42-0-77" id="h42-0-77" class="i">+t5: a → 1
</a><a href="#h42-0-78" id="h42-0-78" class="i">+t5: b → 1
</a><a href="#h42-0-79" id="h42-0-79" class="i">+t5: c → 3
</a><a href="#h42-0-80" id="h42-0-80" class="i">+t5: d → 3
</a><a href="#h42-0-81" id="h42-0-81" class="i">+
</a><a href="#h42-0-82" id="h42-0-82" class="i">+dump
</a><a href="#h42-0-83" id="h42-0-83" class="i">+---
</a><a href="#h42-0-84" id="h42-0-84" class="i">+NextVersion → 5
</a><a href="#h42-0-85" id="h42-0-85" class="i">+TxnActiveSnapshot(3) → {2}
</a><a href="#h42-0-86" id="h42-0-86" class="i">+TxnActiveSnapshot(4) → {2,3}
</a><a href="#h42-0-87" id="h42-0-87" class="i">+Version(&quot;a&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-88" id="h42-0-88" class="i">+Version(&quot;a&quot;, 2) → &quot;1&quot;
</a><a href="#h42-0-89" id="h42-0-89" class="i">+Version(&quot;b&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-90" id="h42-0-90" class="i">+Version(&quot;b&quot;, 2) → &quot;1&quot;
</a><a href="#h42-0-91" id="h42-0-91" class="i">+Version(&quot;c&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-92" id="h42-0-92" class="i">+Version(&quot;c&quot;, 4) → &quot;3&quot;
</a><a href="#h42-0-93" id="h42-0-93" class="i">+Version(&quot;d&quot;, 1) → &quot;0&quot;
</a><a href="#h42-0-94" id="h42-0-94" class="i">+Version(&quot;d&quot;, 4) → &quot;3&quot;
</a><b>diff --git a/<a id="h43" href="../file/src/storage/testscripts/mvcc/scan.html">src/storage/testscripts/mvcc/scan</a> b/<a href="../file/src/storage/testscripts/mvcc/scan.html">src/storage/testscripts/mvcc/scan</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,101 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+# Scans should use correct key and time bounds. Sets up this dataset:
</a><a href="#h43-0-1" id="h43-0-1" class="i">+# 
</a><a href="#h43-0-2" id="h43-0-2" class="i">+# T
</a><a href="#h43-0-3" id="h43-0-3" class="i">+# 4             x    ba4
</a><a href="#h43-0-4" id="h43-0-4" class="i">+# 3   x    a3   b3        x
</a><a href="#h43-0-5" id="h43-0-5" class="i">+# 2        x         ba2  bb2  bc2
</a><a href="#h43-0-6" id="h43-0-6" class="i">+# 1   B1   a1   x                   c1
</a><a href="#h43-0-7" id="h43-0-7" class="i">+#     B    a    b    ba   bb   bc   c
</a><a href="#h43-0-8" id="h43-0-8" class="i">+
</a><a href="#h43-0-9" id="h43-0-9" class="i">+import 1 B=B1 a=a1 b= c=c1
</a><a href="#h43-0-10" id="h43-0-10" class="i">+import 2 a= ba=ba2 bb=bb2 bc=bc2
</a><a href="#h43-0-11" id="h43-0-11" class="i">+import 3 B= a=a3 b=b3 bb=
</a><a href="#h43-0-12" id="h43-0-12" class="i">+import 4 b= ba=ba4
</a><a href="#h43-0-13" id="h43-0-13" class="i">+---
</a><a href="#h43-0-14" id="h43-0-14" class="i">+ok
</a><a href="#h43-0-15" id="h43-0-15" class="i">+
</a><a href="#h43-0-16" id="h43-0-16" class="i">+# Full scans at all timestamps.
</a><a href="#h43-0-17" id="h43-0-17" class="i">+t1: begin readonly as_of=1
</a><a href="#h43-0-18" id="h43-0-18" class="i">+t1: scan
</a><a href="#h43-0-19" id="h43-0-19" class="i">+---
</a><a href="#h43-0-20" id="h43-0-20" class="i">+ok
</a><a href="#h43-0-21" id="h43-0-21" class="i">+
</a><a href="#h43-0-22" id="h43-0-22" class="i">+t2: begin readonly as_of=2
</a><a href="#h43-0-23" id="h43-0-23" class="i">+t2: scan
</a><a href="#h43-0-24" id="h43-0-24" class="i">+---
</a><a href="#h43-0-25" id="h43-0-25" class="i">+t2: B → B1
</a><a href="#h43-0-26" id="h43-0-26" class="i">+t2: a → a1
</a><a href="#h43-0-27" id="h43-0-27" class="i">+t2: c → c1
</a><a href="#h43-0-28" id="h43-0-28" class="i">+
</a><a href="#h43-0-29" id="h43-0-29" class="i">+t3: begin readonly as_of=3
</a><a href="#h43-0-30" id="h43-0-30" class="i">+t3: scan
</a><a href="#h43-0-31" id="h43-0-31" class="i">+---
</a><a href="#h43-0-32" id="h43-0-32" class="i">+t3: B → B1
</a><a href="#h43-0-33" id="h43-0-33" class="i">+t3: ba → ba2
</a><a href="#h43-0-34" id="h43-0-34" class="i">+t3: bb → bb2
</a><a href="#h43-0-35" id="h43-0-35" class="i">+t3: bc → bc2
</a><a href="#h43-0-36" id="h43-0-36" class="i">+t3: c → c1
</a><a href="#h43-0-37" id="h43-0-37" class="i">+
</a><a href="#h43-0-38" id="h43-0-38" class="i">+t4: begin readonly as_of=4
</a><a href="#h43-0-39" id="h43-0-39" class="i">+t4: scan
</a><a href="#h43-0-40" id="h43-0-40" class="i">+---
</a><a href="#h43-0-41" id="h43-0-41" class="i">+t4: a → a3
</a><a href="#h43-0-42" id="h43-0-42" class="i">+t4: b → b3
</a><a href="#h43-0-43" id="h43-0-43" class="i">+t4: ba → ba2
</a><a href="#h43-0-44" id="h43-0-44" class="i">+t4: bc → bc2
</a><a href="#h43-0-45" id="h43-0-45" class="i">+t4: c → c1
</a><a href="#h43-0-46" id="h43-0-46" class="i">+
</a><a href="#h43-0-47" id="h43-0-47" class="i">+t5: begin readonly
</a><a href="#h43-0-48" id="h43-0-48" class="i">+t5: scan
</a><a href="#h43-0-49" id="h43-0-49" class="i">+---
</a><a href="#h43-0-50" id="h43-0-50" class="i">+t5: a → a3
</a><a href="#h43-0-51" id="h43-0-51" class="i">+t5: ba → ba4
</a><a href="#h43-0-52" id="h43-0-52" class="i">+t5: bc → bc2
</a><a href="#h43-0-53" id="h43-0-53" class="i">+t5: c → c1
</a><a href="#h43-0-54" id="h43-0-54" class="i">+
</a><a href="#h43-0-55" id="h43-0-55" class="i">+# Full reverse scan at version 3.
</a><a href="#h43-0-56" id="h43-0-56" class="i">+t3: scan reverse=true
</a><a href="#h43-0-57" id="h43-0-57" class="i">+---
</a><a href="#h43-0-58" id="h43-0-58" class="i">+t3: c → c1
</a><a href="#h43-0-59" id="h43-0-59" class="i">+t3: bc → bc2
</a><a href="#h43-0-60" id="h43-0-60" class="i">+t3: bb → bb2
</a><a href="#h43-0-61" id="h43-0-61" class="i">+t3: ba → ba2
</a><a href="#h43-0-62" id="h43-0-62" class="i">+t3: B → B1
</a><a href="#h43-0-63" id="h43-0-63" class="i">+
</a><a href="#h43-0-64" id="h43-0-64" class="i">+# Various bounded scans around ba-bc at version 3.
</a><a href="#h43-0-65" id="h43-0-65" class="i">+t3: scan ba..bc
</a><a href="#h43-0-66" id="h43-0-66" class="i">+---
</a><a href="#h43-0-67" id="h43-0-67" class="i">+t3: ba → ba2
</a><a href="#h43-0-68" id="h43-0-68" class="i">+t3: bb → bb2
</a><a href="#h43-0-69" id="h43-0-69" class="i">+
</a><a href="#h43-0-70" id="h43-0-70" class="i">+t3: scan &quot;ba..=bc&quot;
</a><a href="#h43-0-71" id="h43-0-71" class="i">+---
</a><a href="#h43-0-72" id="h43-0-72" class="i">+t3: ba → ba2
</a><a href="#h43-0-73" id="h43-0-73" class="i">+t3: bb → bb2
</a><a href="#h43-0-74" id="h43-0-74" class="i">+t3: bc → bc2
</a><a href="#h43-0-75" id="h43-0-75" class="i">+
</a><a href="#h43-0-76" id="h43-0-76" class="i">+t3: scan &quot;ba..=bc&quot; reverse=true
</a><a href="#h43-0-77" id="h43-0-77" class="i">+---
</a><a href="#h43-0-78" id="h43-0-78" class="i">+t3: bc → bc2
</a><a href="#h43-0-79" id="h43-0-79" class="i">+t3: bb → bb2
</a><a href="#h43-0-80" id="h43-0-80" class="i">+t3: ba → ba2
</a><a href="#h43-0-81" id="h43-0-81" class="i">+
</a><a href="#h43-0-82" id="h43-0-82" class="i">+t3: scan ba..
</a><a href="#h43-0-83" id="h43-0-83" class="i">+---
</a><a href="#h43-0-84" id="h43-0-84" class="i">+t3: ba → ba2
</a><a href="#h43-0-85" id="h43-0-85" class="i">+t3: bb → bb2
</a><a href="#h43-0-86" id="h43-0-86" class="i">+t3: bc → bc2
</a><a href="#h43-0-87" id="h43-0-87" class="i">+t3: c → c1
</a><a href="#h43-0-88" id="h43-0-88" class="i">+
</a><a href="#h43-0-89" id="h43-0-89" class="i">+t3: scan &quot;..bc&quot;
</a><a href="#h43-0-90" id="h43-0-90" class="i">+---
</a><a href="#h43-0-91" id="h43-0-91" class="i">+t3: B → B1
</a><a href="#h43-0-92" id="h43-0-92" class="i">+t3: ba → ba2
</a><a href="#h43-0-93" id="h43-0-93" class="i">+t3: bb → bb2
</a><a href="#h43-0-94" id="h43-0-94" class="i">+
</a><a href="#h43-0-95" id="h43-0-95" class="i">+t3: scan &quot;..=bc&quot;
</a><a href="#h43-0-96" id="h43-0-96" class="i">+---
</a><a href="#h43-0-97" id="h43-0-97" class="i">+t3: B → B1
</a><a href="#h43-0-98" id="h43-0-98" class="i">+t3: ba → ba2
</a><a href="#h43-0-99" id="h43-0-99" class="i">+t3: bb → bb2
</a><a href="#h43-0-100" id="h43-0-100" class="i">+t3: bc → bc2
</a><b>diff --git a/<a id="h44" href="../file/src/storage/testscripts/mvcc/scan_isolation.html">src/storage/testscripts/mvcc/scan_isolation</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_isolation.html">src/storage/testscripts/mvcc/scan_isolation</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -0,0 +1,43 @@
</a><a href="#h44-0-0" id="h44-0-0" class="i">+# Scan should be isolated from concurrent transactions.
</a><a href="#h44-0-1" id="h44-0-1" class="i">+
</a><a href="#h44-0-2" id="h44-0-2" class="i">+# Past committed.
</a><a href="#h44-0-3" id="h44-0-3" class="i">+t1: begin
</a><a href="#h44-0-4" id="h44-0-4" class="i">+t1: set a=1 b=1 d=1 e=1
</a><a href="#h44-0-5" id="h44-0-5" class="i">+t1: commit
</a><a href="#h44-0-6" id="h44-0-6" class="i">+---
</a><a href="#h44-0-7" id="h44-0-7" class="i">+ok
</a><a href="#h44-0-8" id="h44-0-8" class="i">+
</a><a href="#h44-0-9" id="h44-0-9" class="i">+# Past uncommitted.
</a><a href="#h44-0-10" id="h44-0-10" class="i">+t2: begin
</a><a href="#h44-0-11" id="h44-0-11" class="i">+t2: set a=2 c=2
</a><a href="#h44-0-12" id="h44-0-12" class="i">+t2: delete b
</a><a href="#h44-0-13" id="h44-0-13" class="i">+---
</a><a href="#h44-0-14" id="h44-0-14" class="i">+ok
</a><a href="#h44-0-15" id="h44-0-15" class="i">+
</a><a href="#h44-0-16" id="h44-0-16" class="i">+# Begin the read transaction.
</a><a href="#h44-0-17" id="h44-0-17" class="i">+t3: begin readonly
</a><a href="#h44-0-18" id="h44-0-18" class="i">+---
</a><a href="#h44-0-19" id="h44-0-19" class="i">+ok
</a><a href="#h44-0-20" id="h44-0-20" class="i">+
</a><a href="#h44-0-21" id="h44-0-21" class="i">+# Future committed.
</a><a href="#h44-0-22" id="h44-0-22" class="i">+t4: begin
</a><a href="#h44-0-23" id="h44-0-23" class="i">+t4: set d=3 f=3
</a><a href="#h44-0-24" id="h44-0-24" class="i">+t4: delete e
</a><a href="#h44-0-25" id="h44-0-25" class="i">+t4: commit
</a><a href="#h44-0-26" id="h44-0-26" class="i">+---
</a><a href="#h44-0-27" id="h44-0-27" class="i">+ok
</a><a href="#h44-0-28" id="h44-0-28" class="i">+
</a><a href="#h44-0-29" id="h44-0-29" class="i">+# Future uncommitted.
</a><a href="#h44-0-30" id="h44-0-30" class="i">+t5: begin
</a><a href="#h44-0-31" id="h44-0-31" class="i">+t5: set d=4 g=4
</a><a href="#h44-0-32" id="h44-0-32" class="i">+t5: delete f
</a><a href="#h44-0-33" id="h44-0-33" class="i">+---
</a><a href="#h44-0-34" id="h44-0-34" class="i">+ok
</a><a href="#h44-0-35" id="h44-0-35" class="i">+
</a><a href="#h44-0-36" id="h44-0-36" class="i">+# Scan keys.
</a><a href="#h44-0-37" id="h44-0-37" class="i">+t3: scan
</a><a href="#h44-0-38" id="h44-0-38" class="i">+---
</a><a href="#h44-0-39" id="h44-0-39" class="i">+t3: a → 1
</a><a href="#h44-0-40" id="h44-0-40" class="i">+t3: b → 1
</a><a href="#h44-0-41" id="h44-0-41" class="i">+t3: d → 1
</a><a href="#h44-0-42" id="h44-0-42" class="i">+t3: e → 1
</a><b>diff --git a/<a id="h45" href="../file/src/storage/testscripts/mvcc/scan_key_version_encoding.html">src/storage/testscripts/mvcc/scan_key_version_encoding</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_key_version_encoding.html">src/storage/testscripts/mvcc/scan_key_version_encoding</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,37 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+# Tests that the key encoding is resistant to key/version overlap.
</a><a href="#h45-0-1" id="h45-0-1" class="i">+# For example, a naïve concatenation of keys and versions would
</a><a href="#h45-0-2" id="h45-0-2" class="i">+# produce incorrect ordering in this case:
</a><a href="#h45-0-3" id="h45-0-3" class="i">+#
</a><a href="#h45-0-4" id="h45-0-4" class="i">+# 00|00 00 00 00 00 00 00 01
</a><a href="#h45-0-5" id="h45-0-5" class="i">+# 00 00 00 00 00 00 00 00 02|00 00 00 00 00 00 00 02
</a><a href="#h45-0-6" id="h45-0-6" class="i">+# 00|00 00 00 00 00 00 00 03
</a><a href="#h45-0-7" id="h45-0-7" class="i">+
</a><a href="#h45-0-8" id="h45-0-8" class="i">+t1: begin
</a><a href="#h45-0-9" id="h45-0-9" class="i">+t1: set &quot;\x00&quot;=&quot;\x01&quot; [ops]
</a><a href="#h45-0-10" id="h45-0-10" class="i">+t1: commit
</a><a href="#h45-0-11" id="h45-0-11" class="i">+---
</a><a href="#h45-0-12" id="h45-0-12" class="i">+t1: engine set TxnWrite(1, 0x00) → []
</a><a href="#h45-0-13" id="h45-0-13" class="i">+t1: engine set Version(0x00, 1) → 0x01
</a><a href="#h45-0-14" id="h45-0-14" class="i">+
</a><a href="#h45-0-15" id="h45-0-15" class="i">+t2: begin
</a><a href="#h45-0-16" id="h45-0-16" class="i">+t2: set &quot;\x00&quot;=&quot;\x02&quot; [ops]
</a><a href="#h45-0-17" id="h45-0-17" class="i">+t2: set &quot;\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;=&quot;\x02&quot; [ops]
</a><a href="#h45-0-18" id="h45-0-18" class="i">+t2: commit
</a><a href="#h45-0-19" id="h45-0-19" class="i">+---
</a><a href="#h45-0-20" id="h45-0-20" class="i">+t2: engine set TxnWrite(2, 0x00) → []
</a><a href="#h45-0-21" id="h45-0-21" class="i">+t2: engine set Version(0x00, 2) → 0x02
</a><a href="#h45-0-22" id="h45-0-22" class="i">+t2: engine set TxnWrite(2, 0x000000000000000002) → []
</a><a href="#h45-0-23" id="h45-0-23" class="i">+t2: engine set Version(0x000000000000000002, 2) → 0x02
</a><a href="#h45-0-24" id="h45-0-24" class="i">+
</a><a href="#h45-0-25" id="h45-0-25" class="i">+t3: begin
</a><a href="#h45-0-26" id="h45-0-26" class="i">+t3: set &quot;\x00&quot;=&quot;\x03&quot; [ops]
</a><a href="#h45-0-27" id="h45-0-27" class="i">+t3: commit
</a><a href="#h45-0-28" id="h45-0-28" class="i">+---
</a><a href="#h45-0-29" id="h45-0-29" class="i">+t3: engine set TxnWrite(3, 0x00) → []
</a><a href="#h45-0-30" id="h45-0-30" class="i">+t3: engine set Version(0x00, 3) → 0x03
</a><a href="#h45-0-31" id="h45-0-31" class="i">+
</a><a href="#h45-0-32" id="h45-0-32" class="i">+t4: begin readonly
</a><a href="#h45-0-33" id="h45-0-33" class="i">+t4: scan
</a><a href="#h45-0-34" id="h45-0-34" class="i">+---
</a><a href="#h45-0-35" id="h45-0-35" class="i">+t4: \x00 → \x03
</a><a href="#h45-0-36" id="h45-0-36" class="i">+t4: \x00\x00\x00\x00\x00\x00\x00\x00\x02 → \x02
</a><b>diff --git a/<a id="h46" href="../file/src/storage/testscripts/mvcc/scan_prefix.html">src/storage/testscripts/mvcc/scan_prefix</a> b/<a href="../file/src/storage/testscripts/mvcc/scan_prefix.html">src/storage/testscripts/mvcc/scan_prefix</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,104 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+# Prefix scans should use correct key and time bounds. Sets up this dataset:
</a><a href="#h46-0-1" id="h46-0-1" class="i">+# 
</a><a href="#h46-0-2" id="h46-0-2" class="i">+# T
</a><a href="#h46-0-3" id="h46-0-3" class="i">+# 4             x    ba4
</a><a href="#h46-0-4" id="h46-0-4" class="i">+# 3   x    a3   b3        x
</a><a href="#h46-0-5" id="h46-0-5" class="i">+# 2        x         ba2  bb2  bc2
</a><a href="#h46-0-6" id="h46-0-6" class="i">+# 1   B1   a1   x                   c1
</a><a href="#h46-0-7" id="h46-0-7" class="i">+#     B    a    b    ba   bb   bc   c
</a><a href="#h46-0-8" id="h46-0-8" class="i">+
</a><a href="#h46-0-9" id="h46-0-9" class="i">+import 1 B=B1 a=a1 b= c=c1
</a><a href="#h46-0-10" id="h46-0-10" class="i">+import 2 a= ba=ba2 bb=bb2 bc=bc2
</a><a href="#h46-0-11" id="h46-0-11" class="i">+import 3 B= a=a3 b=b3 bb=
</a><a href="#h46-0-12" id="h46-0-12" class="i">+import 4 b= ba=ba4
</a><a href="#h46-0-13" id="h46-0-13" class="i">+---
</a><a href="#h46-0-14" id="h46-0-14" class="i">+ok
</a><a href="#h46-0-15" id="h46-0-15" class="i">+
</a><a href="#h46-0-16" id="h46-0-16" class="i">+# Full scans at all timestamps.
</a><a href="#h46-0-17" id="h46-0-17" class="i">+t1: begin readonly as_of=1
</a><a href="#h46-0-18" id="h46-0-18" class="i">+t1: scan_prefix &quot;&quot;
</a><a href="#h46-0-19" id="h46-0-19" class="i">+---
</a><a href="#h46-0-20" id="h46-0-20" class="i">+ok
</a><a href="#h46-0-21" id="h46-0-21" class="i">+
</a><a href="#h46-0-22" id="h46-0-22" class="i">+t2: begin readonly as_of=2
</a><a href="#h46-0-23" id="h46-0-23" class="i">+t2: scan_prefix &quot;&quot;
</a><a href="#h46-0-24" id="h46-0-24" class="i">+---
</a><a href="#h46-0-25" id="h46-0-25" class="i">+t2: B → B1
</a><a href="#h46-0-26" id="h46-0-26" class="i">+t2: a → a1
</a><a href="#h46-0-27" id="h46-0-27" class="i">+t2: c → c1
</a><a href="#h46-0-28" id="h46-0-28" class="i">+
</a><a href="#h46-0-29" id="h46-0-29" class="i">+t3: begin readonly as_of=3
</a><a href="#h46-0-30" id="h46-0-30" class="i">+t3: scan_prefix &quot;&quot;
</a><a href="#h46-0-31" id="h46-0-31" class="i">+---
</a><a href="#h46-0-32" id="h46-0-32" class="i">+t3: B → B1
</a><a href="#h46-0-33" id="h46-0-33" class="i">+t3: ba → ba2
</a><a href="#h46-0-34" id="h46-0-34" class="i">+t3: bb → bb2
</a><a href="#h46-0-35" id="h46-0-35" class="i">+t3: bc → bc2
</a><a href="#h46-0-36" id="h46-0-36" class="i">+t3: c → c1
</a><a href="#h46-0-37" id="h46-0-37" class="i">+
</a><a href="#h46-0-38" id="h46-0-38" class="i">+t4: begin readonly as_of=4
</a><a href="#h46-0-39" id="h46-0-39" class="i">+t4: scan_prefix &quot;&quot;
</a><a href="#h46-0-40" id="h46-0-40" class="i">+---
</a><a href="#h46-0-41" id="h46-0-41" class="i">+t4: a → a3
</a><a href="#h46-0-42" id="h46-0-42" class="i">+t4: b → b3
</a><a href="#h46-0-43" id="h46-0-43" class="i">+t4: ba → ba2
</a><a href="#h46-0-44" id="h46-0-44" class="i">+t4: bc → bc2
</a><a href="#h46-0-45" id="h46-0-45" class="i">+t4: c → c1
</a><a href="#h46-0-46" id="h46-0-46" class="i">+
</a><a href="#h46-0-47" id="h46-0-47" class="i">+t5: begin readonly
</a><a href="#h46-0-48" id="h46-0-48" class="i">+t5: scan_prefix &quot;&quot;
</a><a href="#h46-0-49" id="h46-0-49" class="i">+---
</a><a href="#h46-0-50" id="h46-0-50" class="i">+t5: a → a3
</a><a href="#h46-0-51" id="h46-0-51" class="i">+t5: ba → ba4
</a><a href="#h46-0-52" id="h46-0-52" class="i">+t5: bc → bc2
</a><a href="#h46-0-53" id="h46-0-53" class="i">+t5: c → c1
</a><a href="#h46-0-54" id="h46-0-54" class="i">+
</a><a href="#h46-0-55" id="h46-0-55" class="i">+# Full reverse scan at version 3.
</a><a href="#h46-0-56" id="h46-0-56" class="i">+t3: scan_prefix reverse=true &quot;&quot;
</a><a href="#h46-0-57" id="h46-0-57" class="i">+---
</a><a href="#h46-0-58" id="h46-0-58" class="i">+t3: c → c1
</a><a href="#h46-0-59" id="h46-0-59" class="i">+t3: bc → bc2
</a><a href="#h46-0-60" id="h46-0-60" class="i">+t3: bb → bb2
</a><a href="#h46-0-61" id="h46-0-61" class="i">+t3: ba → ba2
</a><a href="#h46-0-62" id="h46-0-62" class="i">+t3: B → B1
</a><a href="#h46-0-63" id="h46-0-63" class="i">+
</a><a href="#h46-0-64" id="h46-0-64" class="i">+# Various prefixes at version 3.
</a><a href="#h46-0-65" id="h46-0-65" class="i">+t3: scan_prefix B
</a><a href="#h46-0-66" id="h46-0-66" class="i">+---
</a><a href="#h46-0-67" id="h46-0-67" class="i">+t3: B → B1
</a><a href="#h46-0-68" id="h46-0-68" class="i">+
</a><a href="#h46-0-69" id="h46-0-69" class="i">+t3: scan_prefix b
</a><a href="#h46-0-70" id="h46-0-70" class="i">+---
</a><a href="#h46-0-71" id="h46-0-71" class="i">+t3: ba → ba2
</a><a href="#h46-0-72" id="h46-0-72" class="i">+t3: bb → bb2
</a><a href="#h46-0-73" id="h46-0-73" class="i">+t3: bc → bc2
</a><a href="#h46-0-74" id="h46-0-74" class="i">+
</a><a href="#h46-0-75" id="h46-0-75" class="i">+t3: scan_prefix bb
</a><a href="#h46-0-76" id="h46-0-76" class="i">+---
</a><a href="#h46-0-77" id="h46-0-77" class="i">+t3: bb → bb2
</a><a href="#h46-0-78" id="h46-0-78" class="i">+
</a><a href="#h46-0-79" id="h46-0-79" class="i">+t3: scan_prefix bbb
</a><a href="#h46-0-80" id="h46-0-80" class="i">+---
</a><a href="#h46-0-81" id="h46-0-81" class="i">+ok
</a><a href="#h46-0-82" id="h46-0-82" class="i">+
</a><a href="#h46-0-83" id="h46-0-83" class="i">+# Various prefixes at version 4.
</a><a href="#h46-0-84" id="h46-0-84" class="i">+t4: scan_prefix B
</a><a href="#h46-0-85" id="h46-0-85" class="i">+---
</a><a href="#h46-0-86" id="h46-0-86" class="i">+ok
</a><a href="#h46-0-87" id="h46-0-87" class="i">+
</a><a href="#h46-0-88" id="h46-0-88" class="i">+t4: scan_prefix b
</a><a href="#h46-0-89" id="h46-0-89" class="i">+---
</a><a href="#h46-0-90" id="h46-0-90" class="i">+t4: b → b3
</a><a href="#h46-0-91" id="h46-0-91" class="i">+t4: ba → ba2
</a><a href="#h46-0-92" id="h46-0-92" class="i">+t4: bc → bc2
</a><a href="#h46-0-93" id="h46-0-93" class="i">+
</a><a href="#h46-0-94" id="h46-0-94" class="i">+t4: scan_prefix bb
</a><a href="#h46-0-95" id="h46-0-95" class="i">+---
</a><a href="#h46-0-96" id="h46-0-96" class="i">+ok
</a><a href="#h46-0-97" id="h46-0-97" class="i">+
</a><a href="#h46-0-98" id="h46-0-98" class="i">+# Reverse prefix scan at version 4.
</a><a href="#h46-0-99" id="h46-0-99" class="i">+t4: scan_prefix reverse=true b
</a><a href="#h46-0-100" id="h46-0-100" class="i">+---
</a><a href="#h46-0-101" id="h46-0-101" class="i">+t4: bc → bc2
</a><a href="#h46-0-102" id="h46-0-102" class="i">+t4: ba → ba2
</a><a href="#h46-0-103" id="h46-0-103" class="i">+t4: b → b3
</a><b>diff --git a/<a id="h47" href="../file/src/storage/testscripts/mvcc/set.html">src/storage/testscripts/mvcc/set</a> b/<a href="../file/src/storage/testscripts/mvcc/set.html">src/storage/testscripts/mvcc/set</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,51 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+# Sets should work on both existing, missing, and deleted keys.
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+import a=1 b=1 x=
</a><a href="#h47-0-3" id="h47-0-3" class="i">+---
</a><a href="#h47-0-4" id="h47-0-4" class="i">+ok
</a><a href="#h47-0-5" id="h47-0-5" class="i">+
</a><a href="#h47-0-6" id="h47-0-6" class="i">+# Can replace an existing key and tombstone.
</a><a href="#h47-0-7" id="h47-0-7" class="i">+t1: begin
</a><a href="#h47-0-8" id="h47-0-8" class="i">+t1: set a=2 x=2 [ops]
</a><a href="#h47-0-9" id="h47-0-9" class="i">+---
</a><a href="#h47-0-10" id="h47-0-10" class="i">+t1: engine set TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h47-0-11" id="h47-0-11" class="i">+t1: engine set Version(&quot;a&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-12" id="h47-0-12" class="i">+t1: engine set TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h47-0-13" id="h47-0-13" class="i">+t1: engine set Version(&quot;x&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-14" id="h47-0-14" class="i">+
</a><a href="#h47-0-15" id="h47-0-15" class="i">+t1: scan
</a><a href="#h47-0-16" id="h47-0-16" class="i">+---
</a><a href="#h47-0-17" id="h47-0-17" class="i">+t1: a → 2
</a><a href="#h47-0-18" id="h47-0-18" class="i">+t1: b → 1
</a><a href="#h47-0-19" id="h47-0-19" class="i">+t1: x → 2
</a><a href="#h47-0-20" id="h47-0-20" class="i">+
</a><a href="#h47-0-21" id="h47-0-21" class="i">+# Can write a new key, replace it, and be idempotent.
</a><a href="#h47-0-22" id="h47-0-22" class="i">+t1: set c=1 c=2 c=2 [ops]
</a><a href="#h47-0-23" id="h47-0-23" class="i">+---
</a><a href="#h47-0-24" id="h47-0-24" class="i">+t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h47-0-25" id="h47-0-25" class="i">+t1: engine set Version(&quot;c&quot;, 2) → &quot;1&quot;
</a><a href="#h47-0-26" id="h47-0-26" class="i">+t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h47-0-27" id="h47-0-27" class="i">+t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-28" id="h47-0-28" class="i">+t1: engine set TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h47-0-29" id="h47-0-29" class="i">+t1: engine set Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-30" id="h47-0-30" class="i">+
</a><a href="#h47-0-31" id="h47-0-31" class="i">+t1: scan
</a><a href="#h47-0-32" id="h47-0-32" class="i">+---
</a><a href="#h47-0-33" id="h47-0-33" class="i">+t1: a → 2
</a><a href="#h47-0-34" id="h47-0-34" class="i">+t1: b → 1
</a><a href="#h47-0-35" id="h47-0-35" class="i">+t1: c → 2
</a><a href="#h47-0-36" id="h47-0-36" class="i">+t1: x → 2
</a><a href="#h47-0-37" id="h47-0-37" class="i">+
</a><a href="#h47-0-38" id="h47-0-38" class="i">+dump
</a><a href="#h47-0-39" id="h47-0-39" class="i">+---
</a><a href="#h47-0-40" id="h47-0-40" class="i">+NextVersion → 3
</a><a href="#h47-0-41" id="h47-0-41" class="i">+TxnActive(2) → []
</a><a href="#h47-0-42" id="h47-0-42" class="i">+TxnWrite(2, &quot;a&quot;) → []
</a><a href="#h47-0-43" id="h47-0-43" class="i">+TxnWrite(2, &quot;c&quot;) → []
</a><a href="#h47-0-44" id="h47-0-44" class="i">+TxnWrite(2, &quot;x&quot;) → []
</a><a href="#h47-0-45" id="h47-0-45" class="i">+Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h47-0-46" id="h47-0-46" class="i">+Version(&quot;a&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-47" id="h47-0-47" class="i">+Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h47-0-48" id="h47-0-48" class="i">+Version(&quot;c&quot;, 2) → &quot;2&quot;
</a><a href="#h47-0-49" id="h47-0-49" class="i">+Version(&quot;x&quot;, 1) → None
</a><a href="#h47-0-50" id="h47-0-50" class="i">+Version(&quot;x&quot;, 2) → &quot;2&quot;
</a><b>diff --git a/<a id="h48" href="../file/src/storage/testscripts/mvcc/set_conflict.html">src/storage/testscripts/mvcc/set_conflict</a> b/<a href="../file/src/storage/testscripts/mvcc/set_conflict.html">src/storage/testscripts/mvcc/set_conflict</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -0,0 +1,39 @@
</a><a href="#h48-0-0" id="h48-0-0" class="i">+# Set should return serialization errors both for uncommitted versions
</a><a href="#h48-0-1" id="h48-0-1" class="i">+# (past and future), and future committed versions.
</a><a href="#h48-0-2" id="h48-0-2" class="i">+
</a><a href="#h48-0-3" id="h48-0-3" class="i">+t1: begin
</a><a href="#h48-0-4" id="h48-0-4" class="i">+t2: begin
</a><a href="#h48-0-5" id="h48-0-5" class="i">+t3: begin
</a><a href="#h48-0-6" id="h48-0-6" class="i">+t4: begin
</a><a href="#h48-0-7" id="h48-0-7" class="i">+---
</a><a href="#h48-0-8" id="h48-0-8" class="i">+ok
</a><a href="#h48-0-9" id="h48-0-9" class="i">+
</a><a href="#h48-0-10" id="h48-0-10" class="i">+t1: set a=1
</a><a href="#h48-0-11" id="h48-0-11" class="i">+t3: set c=3
</a><a href="#h48-0-12" id="h48-0-12" class="i">+t4: set d=4
</a><a href="#h48-0-13" id="h48-0-13" class="i">+t4: commit
</a><a href="#h48-0-14" id="h48-0-14" class="i">+---
</a><a href="#h48-0-15" id="h48-0-15" class="i">+ok
</a><a href="#h48-0-16" id="h48-0-16" class="i">+
</a><a href="#h48-0-17" id="h48-0-17" class="i">+t2: !set a=2 # past uncommitted
</a><a href="#h48-0-18" id="h48-0-18" class="i">+t2: !set c=2 # future uncommitted
</a><a href="#h48-0-19" id="h48-0-19" class="i">+t2: !set d=2 # future committed
</a><a href="#h48-0-20" id="h48-0-20" class="i">+---
</a><a href="#h48-0-21" id="h48-0-21" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h48-0-22" id="h48-0-22" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h48-0-23" id="h48-0-23" class="i">+t2: Error: serialization failure, retry transaction
</a><a href="#h48-0-24" id="h48-0-24" class="i">+
</a><a href="#h48-0-25" id="h48-0-25" class="i">+dump
</a><a href="#h48-0-26" id="h48-0-26" class="i">+---
</a><a href="#h48-0-27" id="h48-0-27" class="i">+NextVersion → 5
</a><a href="#h48-0-28" id="h48-0-28" class="i">+TxnActive(1) → []
</a><a href="#h48-0-29" id="h48-0-29" class="i">+TxnActive(2) → []
</a><a href="#h48-0-30" id="h48-0-30" class="i">+TxnActive(3) → []
</a><a href="#h48-0-31" id="h48-0-31" class="i">+TxnActiveSnapshot(2) → {1}
</a><a href="#h48-0-32" id="h48-0-32" class="i">+TxnActiveSnapshot(3) → {1,2}
</a><a href="#h48-0-33" id="h48-0-33" class="i">+TxnActiveSnapshot(4) → {1,2,3}
</a><a href="#h48-0-34" id="h48-0-34" class="i">+TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h48-0-35" id="h48-0-35" class="i">+TxnWrite(3, &quot;c&quot;) → []
</a><a href="#h48-0-36" id="h48-0-36" class="i">+Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h48-0-37" id="h48-0-37" class="i">+Version(&quot;c&quot;, 3) → &quot;3&quot;
</a><a href="#h48-0-38" id="h48-0-38" class="i">+Version(&quot;d&quot;, 4) → &quot;4&quot;
</a><b>diff --git a/<a id="h49" href="../file/src/storage/testscripts/mvcc/unversioned.html">src/storage/testscripts/mvcc/unversioned</a> b/<a href="../file/src/storage/testscripts/mvcc/unversioned.html">src/storage/testscripts/mvcc/unversioned</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -0,0 +1,55 @@
</a><a href="#h49-0-0" id="h49-0-0" class="i">+# Tests unversioned keys.
</a><a href="#h49-0-1" id="h49-0-1" class="i">+
</a><a href="#h49-0-2" id="h49-0-2" class="i">+# Getting a missing unversioned key returns None.
</a><a href="#h49-0-3" id="h49-0-3" class="i">+get_unversioned a
</a><a href="#h49-0-4" id="h49-0-4" class="i">+---
</a><a href="#h49-0-5" id="h49-0-5" class="i">+a → None
</a><a href="#h49-0-6" id="h49-0-6" class="i">+
</a><a href="#h49-0-7" id="h49-0-7" class="i">+# Setting and getting an unversioned key should work. Dump engine operations.
</a><a href="#h49-0-8" id="h49-0-8" class="i">+set_unversioned a=0 [ops]
</a><a href="#h49-0-9" id="h49-0-9" class="i">+get_unversioned a
</a><a href="#h49-0-10" id="h49-0-10" class="i">+---
</a><a href="#h49-0-11" id="h49-0-11" class="i">+engine set Unversioned(&quot;a&quot;) → &quot;0&quot;
</a><a href="#h49-0-12" id="h49-0-12" class="i">+a → 0
</a><a href="#h49-0-13" id="h49-0-13" class="i">+
</a><a href="#h49-0-14" id="h49-0-14" class="i">+# Write some versioned keys with the same keys, interleaved between unversioned.
</a><a href="#h49-0-15" id="h49-0-15" class="i">+# The raw engine writes show that the internal keys are different.
</a><a href="#h49-0-16" id="h49-0-16" class="i">+t1: begin
</a><a href="#h49-0-17" id="h49-0-17" class="i">+t1: set a=1 b=1 c=1 [ops]
</a><a href="#h49-0-18" id="h49-0-18" class="i">+t1: commit
</a><a href="#h49-0-19" id="h49-0-19" class="i">+---
</a><a href="#h49-0-20" id="h49-0-20" class="i">+t1: engine set TxnWrite(1, &quot;a&quot;) → []
</a><a href="#h49-0-21" id="h49-0-21" class="i">+t1: engine set Version(&quot;a&quot;, 1) → &quot;1&quot;
</a><a href="#h49-0-22" id="h49-0-22" class="i">+t1: engine set TxnWrite(1, &quot;b&quot;) → []
</a><a href="#h49-0-23" id="h49-0-23" class="i">+t1: engine set Version(&quot;b&quot;, 1) → &quot;1&quot;
</a><a href="#h49-0-24" id="h49-0-24" class="i">+t1: engine set TxnWrite(1, &quot;c&quot;) → []
</a><a href="#h49-0-25" id="h49-0-25" class="i">+t1: engine set Version(&quot;c&quot;, 1) → &quot;1&quot;
</a><a href="#h49-0-26" id="h49-0-26" class="i">+
</a><a href="#h49-0-27" id="h49-0-27" class="i">+# Set another unversioned key overlapping a versioned key.
</a><a href="#h49-0-28" id="h49-0-28" class="i">+set_unversioned b=0 d=0 [ops]
</a><a href="#h49-0-29" id="h49-0-29" class="i">+---
</a><a href="#h49-0-30" id="h49-0-30" class="i">+engine set Unversioned(&quot;b&quot;) → &quot;0&quot;
</a><a href="#h49-0-31" id="h49-0-31" class="i">+engine set Unversioned(&quot;d&quot;) → &quot;0&quot;
</a><a href="#h49-0-32" id="h49-0-32" class="i">+
</a><a href="#h49-0-33" id="h49-0-33" class="i">+# An MVCC scan shouldn&#39;t see the unversioned keys.
</a><a href="#h49-0-34" id="h49-0-34" class="i">+t2: begin readonly
</a><a href="#h49-0-35" id="h49-0-35" class="i">+t2: scan
</a><a href="#h49-0-36" id="h49-0-36" class="i">+---
</a><a href="#h49-0-37" id="h49-0-37" class="i">+t2: a → 1
</a><a href="#h49-0-38" id="h49-0-38" class="i">+t2: b → 1
</a><a href="#h49-0-39" id="h49-0-39" class="i">+t2: c → 1
</a><a href="#h49-0-40" id="h49-0-40" class="i">+
</a><a href="#h49-0-41" id="h49-0-41" class="i">+# Unversioned gets should not see versioned keys.
</a><a href="#h49-0-42" id="h49-0-42" class="i">+get_unversioned a b c d
</a><a href="#h49-0-43" id="h49-0-43" class="i">+---
</a><a href="#h49-0-44" id="h49-0-44" class="i">+a → 0
</a><a href="#h49-0-45" id="h49-0-45" class="i">+b → 0
</a><a href="#h49-0-46" id="h49-0-46" class="i">+c → None
</a><a href="#h49-0-47" id="h49-0-47" class="i">+d → 0
</a><a href="#h49-0-48" id="h49-0-48" class="i">+
</a><a href="#h49-0-49" id="h49-0-49" class="i">+# Replacing an unversioned key should work too.
</a><a href="#h49-0-50" id="h49-0-50" class="i">+set_unversioned a=2 [ops]
</a><a href="#h49-0-51" id="h49-0-51" class="i">+get_unversioned a
</a><a href="#h49-0-52" id="h49-0-52" class="i">+---
</a><a href="#h49-0-53" id="h49-0-53" class="i">+engine set Unversioned(&quot;a&quot;) → &quot;2&quot;
</a><a href="#h49-0-54" id="h49-0-54" class="i">+a → 2
</a></pre>
</div>
</body>
</html>
