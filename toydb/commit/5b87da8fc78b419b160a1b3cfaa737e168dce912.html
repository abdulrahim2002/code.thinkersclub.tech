<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>utility: remove package, use cbor serialization - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/5b87da8fc78b419b160a1b3cfaa737e168dce912.html">5b87da8fc78b419b160a1b3cfaa737e168dce912</a>
<b>parent</b> <a href="../commit/503a8b81513d74609659948f4f96d05d9bdd59ee.html">503a8b81513d74609659948f4f96d05d9bdd59ee</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Fri, 15 May 2020 00:14:50 +0200

utility: remove package, use cbor serialization

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/error.rs</a></td><td> | </td><td class="num">12</td><td><span class="i"></span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/lib.rs</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">103</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/storage/kv/mvcc.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">src/utility/mod.rs</a></td><td> | </td><td class="num">3</td><td><span class="i"></span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">src/utility/serialize.rs</a></td><td> | </td><td class="num">32</td><td><span class="i"></span><span class="d">--------------------------------</span></td></tr>
</table></pre><pre>9 files changed, 82 insertions(+), 116 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -758,25 +758,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-0-3" id="h0-0-3" class="d">-name = &quot;rmp&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="d">-version = &quot;0.8.9&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-6" id="h0-0-6" class="d">-dependencies = [
</a><a href="#h0-0-7" id="h0-0-7" class="d">- &quot;byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-8" id="h0-0-8" class="d">- &quot;num-traits 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-9" id="h0-0-9" class="d">-]
</a><a href="#h0-0-10" id="h0-0-10" class="d">-
</a><a href="#h0-0-11" id="h0-0-11" class="d">-[[package]]
</a><a href="#h0-0-12" id="h0-0-12" class="d">-name = &quot;rmp-serde&quot;
</a><a href="#h0-0-13" id="h0-0-13" class="d">-version = &quot;0.14.3&quot;
</a><a href="#h0-0-14" id="h0-0-14" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-15" id="h0-0-15" class="d">-dependencies = [
</a><a href="#h0-0-16" id="h0-0-16" class="d">- &quot;byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-17" id="h0-0-17" class="d">- &quot;rmp 0.8.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-18" id="h0-0-18" class="d">- &quot;serde 1.0.106 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-19" id="h0-0-19" class="d">-]
</a><a href="#h0-0-20" id="h0-0-20" class="d">-
</a><a href="#h0-0-21" id="h0-0-21" class="d">-[[package]]
</a> name = &quot;rust-argon2&quot;
 version = &quot;0.7.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-1" id="h0-1" class="h">@@ -1097,7 +1078,6 @@ dependencies = [
</a>  &quot;pretty_assertions 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rand 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;regex 1.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-1-3" id="h0-1-3" class="d">- &quot;rmp-serde 0.14.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rustyline 6.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde 1.0.106 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde_cbor 0.11.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-2" id="h0-2" class="h">@@ -1300,8 +1280,6 @@ dependencies = [
</a> &quot;checksum regex 1.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a6020f034922e3194c711b82a627453881bc4682166cabb07134a10c26ba7692&quot;
 &quot;checksum regex-syntax 0.6.17 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7fe5bd57d1d7414c6b5ed48563a2c855d995ff777729dcd91c369ec7fea395ae&quot;
 &quot;checksum remove_dir_all 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;4a83fa3702a688b9359eccba92d153ac33fd2e8462f9e0e3fdf155239ea7792e&quot;
<a href="#h0-2-3" id="h0-2-3" class="d">-&quot;checksum rmp 0.8.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0f10b46df14cf1ee1ac7baa4d2fbc2c52c0622a4b82fa8740e37bc452ac0184f&quot;
</a><a href="#h0-2-4" id="h0-2-4" class="d">-&quot;checksum rmp-serde 0.14.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;4c1ee98f14fe8b8e9c5ea13d25da7b2a1796169202c57a09d7288de90d56222b&quot;
</a> &quot;checksum rust-argon2 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2bc8af4bda8e1ff4932523b94d3dd20ee30a87232323eda55903ffd71d2fb017&quot;
 &quot;checksum rust-ini 0.13.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3e52c148ef37f8c375d49d5a73aa70713125b7f19095948a923f80afdeb22ec2&quot;
 &quot;checksum rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;138e3e0acb6c9fb258b19b67cb8abd63c00679d2851805ea151465464fe9030a&quot;
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -17,7 +17,6 @@ log = &quot;~0.4.6&quot;
</a> names = &quot;~0.11.0&quot;
 rand = &quot;~0.7.2&quot;
 regex = &quot;~1.3.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-rmp-serde = &quot;~0.14.0&quot;
</a> rustyline = &quot;~6.1.2&quot;
 serde = &quot;~1.0.91&quot;
 serde_cbor = &quot;~0.11.1&quot;
<b>diff --git a/<a id="h2" href="../file/src/error.rs.html">src/error.rs</a> b/<a href="../file/src/error.rs.html">src/error.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -49,18 +49,6 @@ impl From&lt;regex::Error&gt; for Error {
</a>     }
 }
 
<a href="#h2-0-3" id="h2-0-3" class="d">-impl From&lt;rmp_serde::decode::Error&gt; for Error {
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    fn from(err: rmp_serde::decode::Error) -&gt; Self {
</a><a href="#h2-0-5" id="h2-0-5" class="d">-        Error::Internal(err.to_string())
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    }
</a><a href="#h2-0-7" id="h2-0-7" class="d">-}
</a><a href="#h2-0-8" id="h2-0-8" class="d">-
</a><a href="#h2-0-9" id="h2-0-9" class="d">-impl From&lt;rmp_serde::encode::Error&gt; for Error {
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    fn from(err: rmp_serde::encode::Error) -&gt; Self {
</a><a href="#h2-0-11" id="h2-0-11" class="d">-        Error::Internal(err.to_string())
</a><a href="#h2-0-12" id="h2-0-12" class="d">-    }
</a><a href="#h2-0-13" id="h2-0-13" class="d">-}
</a><a href="#h2-0-14" id="h2-0-14" class="d">-
</a> impl From&lt;rustyline::error::ReadlineError&gt; for Error {
     fn from(err: rustyline::error::ReadlineError) -&gt; Self {
         Error::Internal(err.to_string())
<b>diff --git a/<a id="h3" href="../file/src/lib.rs.html">src/lib.rs</a> b/<a href="../file/src/lib.rs.html">src/lib.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -7,7 +7,6 @@ pub mod raft;
</a> pub mod server;
 pub mod sql;
 pub mod storage;
<a href="#h3-0-3" id="h3-0-3" class="d">-mod utility;
</a> 
 pub use client::Client;
 pub use error::Error;
<b>diff --git a/<a id="h4" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -2,9 +2,9 @@ use super::super::schema::{Catalog, Table, Tables};
</a> use super::super::types::{Expression, Row, Value};
 use super::Transaction as _;
 use crate::storage::kv;
<a href="#h4-0-3" id="h4-0-3" class="d">-use crate::utility::{deserialize, serialize};
</a> use crate::Error;
 
<a href="#h4-0-6" id="h4-0-6" class="i">+use serde::{Deserialize, Serialize};
</a> use std::collections::HashSet;
 
 /// A SQL engine based on an underlying MVCC key/value store
<a href="#h4-1" id="h4-1" class="h">@@ -49,6 +49,16 @@ impl&lt;S: kv::Store&gt; super::Engine for KV&lt;S&gt; {
</a>     }
 }
 
<a href="#h4-1-3" id="h4-1-3" class="i">+/// Serializes SQL metadata.
</a><a href="#h4-1-4" id="h4-1-4" class="i">+fn serialize&lt;V: Serialize&gt;(value: &amp;V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h4-1-5" id="h4-1-5" class="i">+    Ok(serde_cbor::ser::to_vec_packed(value)?)
</a><a href="#h4-1-6" id="h4-1-6" class="i">+}
</a><a href="#h4-1-7" id="h4-1-7" class="i">+
</a><a href="#h4-1-8" id="h4-1-8" class="i">+/// Deserializes SQL metadata.
</a><a href="#h4-1-9" id="h4-1-9" class="i">+fn deserialize&lt;&#39;a, V: Deserialize&lt;&#39;a&gt;&gt;(bytes: &amp;&#39;a [u8]) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h4-1-10" id="h4-1-10" class="i">+    Ok(serde_cbor::from_slice(bytes)?)
</a><a href="#h4-1-11" id="h4-1-11" class="i">+}
</a><a href="#h4-1-12" id="h4-1-12" class="i">+
</a> /// An SQL transaction based on an MVCC key/value transaction
 pub struct Transaction&lt;S: kv::Store&gt; {
     txn: kv::mvcc::Transaction&lt;S&gt;,
<b>diff --git a/<a id="h5" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -3,9 +3,9 @@ use super::super::types::{Expression, Row, Value};
</a> use super::{Engine as _, IndexScan, Mode, Scan, Transaction as _};
 use crate::raft;
 use crate::storage::kv;
<a href="#h5-0-3" id="h5-0-3" class="d">-use crate::utility::{deserialize, serialize};
</a> use crate::Error;
 
<a href="#h5-0-6" id="h5-0-6" class="i">+use serde::{Deserialize, Serialize};
</a> use serde_derive::{Deserialize, Serialize};
 use std::collections::HashSet;
 
<a href="#h5-1" id="h5-1" class="h">@@ -83,11 +83,21 @@ impl Raft {
</a>     pub fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
         Ok(Status {
             raft: futures::executor::block_on(self.client.status())?,
<a href="#h5-1-3" id="h5-1-3" class="d">-            mvcc: deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-1-4" id="h5-1-4" class="d">-                self.client.query(serialize(&amp;Query::Status)?),
</a><a href="#h5-1-5" id="h5-1-5" class="i">+            mvcc: Raft::deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-1-6" id="h5-1-6" class="i">+                self.client.query(Raft::serialize(&amp;Query::Status)?),
</a>             )?)?,
         })
     }
<a href="#h5-1-10" id="h5-1-10" class="i">+
</a><a href="#h5-1-11" id="h5-1-11" class="i">+    /// Serializes a command for the Raft SQL state machine.
</a><a href="#h5-1-12" id="h5-1-12" class="i">+    fn serialize&lt;V: Serialize&gt;(value: &amp;V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h5-1-13" id="h5-1-13" class="i">+        Ok(serde_cbor::ser::to_vec_packed(value)?)
</a><a href="#h5-1-14" id="h5-1-14" class="i">+    }
</a><a href="#h5-1-15" id="h5-1-15" class="i">+
</a><a href="#h5-1-16" id="h5-1-16" class="i">+    /// Deserializes a command for the Raft SQL state machine.
</a><a href="#h5-1-17" id="h5-1-17" class="i">+    fn deserialize&lt;&#39;a, V: Deserialize&lt;&#39;a&gt;&gt;(bytes: &amp;&#39;a [u8]) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h5-1-18" id="h5-1-18" class="i">+        Ok(serde_cbor::from_slice(bytes)?)
</a><a href="#h5-1-19" id="h5-1-19" class="i">+    }
</a> }
 
 impl super::Engine for Raft {
<a href="#h5-2" id="h5-2" class="h">@@ -116,28 +126,28 @@ pub struct Transaction {
</a> impl Transaction {
     /// Starts a transaction in the given mode
     fn begin(client: raft::Client, mode: Mode) -&gt; Result&lt;Self, Error&gt; {
<a href="#h5-2-3" id="h5-2-3" class="d">-        let id = deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-2-4" id="h5-2-4" class="d">-            client.mutate(serialize(&amp;Mutation::Begin(mode))?),
</a><a href="#h5-2-5" id="h5-2-5" class="i">+        let id = Raft::deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-2-6" id="h5-2-6" class="i">+            client.mutate(Raft::serialize(&amp;Mutation::Begin(mode))?),
</a>         )?)?;
         Ok(Self { client, id, mode })
     }
 
     /// Resumes an active transaction
     fn resume(client: raft::Client, id: u64) -&gt; Result&lt;Self, Error&gt; {
<a href="#h5-2-13" id="h5-2-13" class="d">-        let (id, mode) = deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-2-14" id="h5-2-14" class="d">-            client.query(serialize(&amp;Query::Resume(id))?),
</a><a href="#h5-2-15" id="h5-2-15" class="i">+        let (id, mode) = Raft::deserialize(&amp;futures::executor::block_on(
</a><a href="#h5-2-16" id="h5-2-16" class="i">+            client.query(Raft::serialize(&amp;Query::Resume(id))?),
</a>         )?)?;
         Ok(Self { client, id, mode })
     }
 
     /// Executes a mutation
     fn mutate(&amp;self, mutation: Mutation) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
<a href="#h5-2-23" id="h5-2-23" class="d">-        futures::executor::block_on(self.client.mutate(serialize(&amp;mutation)?))
</a><a href="#h5-2-24" id="h5-2-24" class="i">+        futures::executor::block_on(self.client.mutate(Raft::serialize(&amp;mutation)?))
</a>     }
 
     /// Executes a query
     fn query(&amp;self, query: Query) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
<a href="#h5-2-29" id="h5-2-29" class="d">-        futures::executor::block_on(self.client.query(serialize(&amp;query)?))
</a><a href="#h5-2-30" id="h5-2-30" class="i">+        futures::executor::block_on(self.client.query(Raft::serialize(&amp;query)?))
</a>     }
 }
 
<a href="#h5-3" id="h5-3" class="h">@@ -151,15 +161,15 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn commit(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-3-3" id="h5-3-3" class="d">-        deserialize(&amp;self.mutate(Mutation::Commit(self.id))?)
</a><a href="#h5-3-4" id="h5-3-4" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Commit(self.id))?)
</a>     }
 
     fn rollback(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-3-8" id="h5-3-8" class="d">-        deserialize(&amp;self.mutate(Mutation::Rollback(self.id))?)
</a><a href="#h5-3-9" id="h5-3-9" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Rollback(self.id))?)
</a>     }
 
     fn create(&amp;mut self, table: &amp;str, row: Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-3-13" id="h5-3-13" class="d">-        deserialize(&amp;self.mutate(Mutation::Create {
</a><a href="#h5-3-14" id="h5-3-14" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Create {
</a>             txn_id: self.id,
             table: table.to_string(),
             row,
<a href="#h5-4" id="h5-4" class="h">@@ -167,7 +177,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn delete(&amp;mut self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-4-3" id="h5-4-3" class="d">-        deserialize(&amp;self.mutate(Mutation::Delete {
</a><a href="#h5-4-4" id="h5-4-4" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Delete {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h5-5" id="h5-5" class="h">@@ -175,7 +185,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;Option&lt;Row&gt;, Error&gt; {
<a href="#h5-5-3" id="h5-5-3" class="d">-        deserialize(&amp;self.query(Query::Read {
</a><a href="#h5-5-4" id="h5-5-4" class="i">+        Raft::deserialize(&amp;self.query(Query::Read {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h5-6" id="h5-6" class="h">@@ -188,7 +198,7 @@ impl super::Transaction for Transaction {
</a>         column: &amp;str,
         value: &amp;Value,
     ) -&gt; Result&lt;HashSet&lt;Value&gt;, Error&gt; {
<a href="#h5-6-3" id="h5-6-3" class="d">-        deserialize(&amp;self.query(Query::ReadIndex {
</a><a href="#h5-6-4" id="h5-6-4" class="i">+        Raft::deserialize(&amp;self.query(Query::ReadIndex {
</a>             txn_id: self.id,
             table: table.to_string(),
             column: column.to_string(),
<a href="#h5-7" id="h5-7" class="h">@@ -198,7 +208,7 @@ impl super::Transaction for Transaction {
</a> 
     fn scan(&amp;self, table: &amp;str, filter: Option&lt;Expression&gt;) -&gt; Result&lt;Scan, Error&gt; {
         Ok(Box::new(
<a href="#h5-7-3" id="h5-7-3" class="d">-            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::Scan {
</a><a href="#h5-7-4" id="h5-7-4" class="i">+            Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::Scan {
</a>                 txn_id: self.id,
                 table: table.to_string(),
                 filter,
<a href="#h5-8" id="h5-8" class="h">@@ -210,7 +220,7 @@ impl super::Transaction for Transaction {
</a> 
     fn scan_index(&amp;self, table: &amp;str, column: &amp;str) -&gt; Result&lt;IndexScan, Error&gt; {
         Ok(Box::new(
<a href="#h5-8-3" id="h5-8-3" class="d">-            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanIndex {
</a><a href="#h5-8-4" id="h5-8-4" class="i">+            Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanIndex {
</a>                 txn_id: self.id,
                 table: table.to_string(),
                 column: column.to_string(),
<a href="#h5-9" id="h5-9" class="h">@@ -221,7 +231,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn update(&amp;mut self, table: &amp;str, id: &amp;Value, row: Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-9-3" id="h5-9-3" class="d">-        deserialize(&amp;self.mutate(Mutation::Update {
</a><a href="#h5-9-4" id="h5-9-4" class="i">+        Raft::deserialize(&amp;self.mutate(Mutation::Update {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h5-10" id="h5-10" class="h">@@ -232,22 +242,27 @@ impl super::Transaction for Transaction {
</a> 
 impl Catalog for Transaction {
     fn create_table(&amp;mut self, table: &amp;Table) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-10-3" id="h5-10-3" class="d">-        deserialize(&amp;self.mutate(Mutation::CreateTable { txn_id: self.id, schema: table.clone() })?)
</a><a href="#h5-10-4" id="h5-10-4" class="i">+        Raft::deserialize(
</a><a href="#h5-10-5" id="h5-10-5" class="i">+            &amp;self.mutate(Mutation::CreateTable { txn_id: self.id, schema: table.clone() })?,
</a><a href="#h5-10-6" id="h5-10-6" class="i">+        )
</a>     }
 
     fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
<a href="#h5-10-10" id="h5-10-10" class="d">-        deserialize(
</a><a href="#h5-10-11" id="h5-10-11" class="i">+        Raft::deserialize(
</a>             &amp;self.mutate(Mutation::DeleteTable { txn_id: self.id, table: table.to_string() })?,
         )
     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;Table&gt;, Error&gt; {
<a href="#h5-10-17" id="h5-10-17" class="d">-        deserialize(&amp;self.query(Query::ReadTable { txn_id: self.id, table: table.to_string() })?)
</a><a href="#h5-10-18" id="h5-10-18" class="i">+        Raft::deserialize(
</a><a href="#h5-10-19" id="h5-10-19" class="i">+            &amp;self.query(Query::ReadTable { txn_id: self.id, table: table.to_string() })?,
</a><a href="#h5-10-20" id="h5-10-20" class="i">+        )
</a>     }
 
     fn scan_tables(&amp;self) -&gt; Result&lt;Tables, Error&gt; {
         Ok(Box::new(
<a href="#h5-10-25" id="h5-10-25" class="d">-            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanTables { txn_id: self.id })?)?.into_iter(),
</a><a href="#h5-10-26" id="h5-10-26" class="i">+            Raft::deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.query(Query::ScanTables { txn_id: self.id })?)?
</a><a href="#h5-10-27" id="h5-10-27" class="i">+                .into_iter(),
</a>         ))
     }
 }
<a href="#h5-11" id="h5-11" class="h">@@ -264,33 +279,35 @@ impl&lt;S: kv::Store&gt; State&lt;S&gt; {
</a>     /// Creates a new Raft state maching using the given MVCC key/value store
     pub fn new(store: kv::MVCC&lt;S&gt;) -&gt; Result&lt;Self, Error&gt; {
         let engine = super::KV::new(store);
<a href="#h5-11-3" id="h5-11-3" class="d">-        let applied_index =
</a><a href="#h5-11-4" id="h5-11-4" class="d">-            engine.get_metadata(b&quot;applied_index&quot;)?.map(|b| deserialize(&amp;b)).unwrap_or(Ok(0))?;
</a><a href="#h5-11-5" id="h5-11-5" class="i">+        let applied_index = engine
</a><a href="#h5-11-6" id="h5-11-6" class="i">+            .get_metadata(b&quot;applied_index&quot;)?
</a><a href="#h5-11-7" id="h5-11-7" class="i">+            .map(|b| Raft::deserialize(&amp;b))
</a><a href="#h5-11-8" id="h5-11-8" class="i">+            .unwrap_or(Ok(0))?;
</a>         Ok(State { engine, applied_index })
     }
 
     /// Applies a state machine mutation
     fn apply(&amp;mut self, mutation: Mutation) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
         match mutation {
<a href="#h5-11-15" id="h5-11-15" class="d">-            Mutation::Begin(mode) =&gt; serialize(&amp;self.engine.begin(mode)?.id()),
</a><a href="#h5-11-16" id="h5-11-16" class="d">-            Mutation::Commit(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.commit()?),
</a><a href="#h5-11-17" id="h5-11-17" class="d">-            Mutation::Rollback(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.rollback()?),
</a><a href="#h5-11-18" id="h5-11-18" class="i">+            Mutation::Begin(mode) =&gt; Raft::serialize(&amp;self.engine.begin(mode)?.id()),
</a><a href="#h5-11-19" id="h5-11-19" class="i">+            Mutation::Commit(txn_id) =&gt; Raft::serialize(&amp;self.engine.resume(txn_id)?.commit()?),
</a><a href="#h5-11-20" id="h5-11-20" class="i">+            Mutation::Rollback(txn_id) =&gt; Raft::serialize(&amp;self.engine.resume(txn_id)?.rollback()?),
</a> 
             Mutation::Create { txn_id, table, row } =&gt; {
<a href="#h5-11-23" id="h5-11-23" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a><a href="#h5-11-24" id="h5-11-24" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.create(&amp;table, row)?)
</a>             }
             Mutation::Delete { txn_id, table, id } =&gt; {
<a href="#h5-11-27" id="h5-11-27" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a><a href="#h5-11-28" id="h5-11-28" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.delete(&amp;table, &amp;id)?)
</a>             }
             Mutation::Update { txn_id, table, id, row } =&gt; {
<a href="#h5-11-31" id="h5-11-31" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a><a href="#h5-11-32" id="h5-11-32" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.update(&amp;table, &amp;id, row)?)
</a>             }
 
             Mutation::CreateTable { txn_id, schema } =&gt; {
<a href="#h5-11-36" id="h5-11-36" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.create_table(&amp;schema)?)
</a><a href="#h5-11-37" id="h5-11-37" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.create_table(&amp;schema)?)
</a>             }
             Mutation::DeleteTable { txn_id, table } =&gt; {
<a href="#h5-11-40" id="h5-11-40" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a><a href="#h5-11-41" id="h5-11-41" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.delete_table(&amp;table)?)
</a>             }
         }
     }
<a href="#h5-12" id="h5-12" class="h">@@ -304,10 +321,10 @@ impl&lt;S: kv::Store&gt; raft::State for State&lt;S&gt; {
</a>     fn mutate(&amp;mut self, index: u64, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
         // We don&#39;t check that index == applied_index + 1, since the Raft log commits no-op
         // entries during leader election which we need to ignore.
<a href="#h5-12-3" id="h5-12-3" class="d">-        match self.apply(deserialize(&amp;command)?) {
</a><a href="#h5-12-4" id="h5-12-4" class="i">+        match self.apply(Raft::deserialize(&amp;command)?) {
</a>             error @ Err(Error::Internal(_)) =&gt; error,
             result =&gt; {
<a href="#h5-12-7" id="h5-12-7" class="d">-                self.engine.set_metadata(b&quot;applied_index&quot;, serialize(&amp;(index))?)?;
</a><a href="#h5-12-8" id="h5-12-8" class="i">+                self.engine.set_metadata(b&quot;applied_index&quot;, Raft::serialize(&amp;(index))?)?;
</a>                 self.applied_index = index;
                 result
             }
<a href="#h5-13" id="h5-13" class="h">@@ -315,40 +332,40 @@ impl&lt;S: kv::Store&gt; raft::State for State&lt;S&gt; {
</a>     }
 
     fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
<a href="#h5-13-3" id="h5-13-3" class="d">-        match deserialize(&amp;command)? {
</a><a href="#h5-13-4" id="h5-13-4" class="i">+        match Raft::deserialize(&amp;command)? {
</a>             Query::Resume(id) =&gt; {
                 let txn = self.engine.resume(id)?;
<a href="#h5-13-7" id="h5-13-7" class="d">-                serialize(&amp;(txn.id(), txn.mode()))
</a><a href="#h5-13-8" id="h5-13-8" class="i">+                Raft::serialize(&amp;(txn.id(), txn.mode()))
</a>             }
 
             Query::Read { txn_id, table, id } =&gt; {
<a href="#h5-13-12" id="h5-13-12" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a><a href="#h5-13-13" id="h5-13-13" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.read(&amp;table, &amp;id)?)
</a>             }
             Query::ReadIndex { txn_id, table, column, value } =&gt; {
<a href="#h5-13-16" id="h5-13-16" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.read_index(&amp;table, &amp;column, &amp;value)?)
</a><a href="#h5-13-17" id="h5-13-17" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.read_index(&amp;table, &amp;column, &amp;value)?)
</a>             }
             // FIXME These need to stream rows somehow
<a href="#h5-13-20" id="h5-13-20" class="d">-            Query::Scan { txn_id, table, filter } =&gt; serialize(
</a><a href="#h5-13-21" id="h5-13-21" class="i">+            Query::Scan { txn_id, table, filter } =&gt; Raft::serialize(
</a>                 &amp;self
                     .engine
                     .resume(txn_id)?
                     .scan(&amp;table, filter)?
                     .collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?,
             ),
<a href="#h5-13-28" id="h5-13-28" class="d">-            Query::ScanIndex { txn_id, table, column } =&gt; serialize(
</a><a href="#h5-13-29" id="h5-13-29" class="i">+            Query::ScanIndex { txn_id, table, column } =&gt; Raft::serialize(
</a>                 &amp;self
                     .engine
                     .resume(txn_id)?
                     .scan_index(&amp;table, &amp;column)?
                     .collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?,
             ),
<a href="#h5-13-36" id="h5-13-36" class="d">-            Query::Status =&gt; serialize(&amp;self.engine.kv.status()?),
</a><a href="#h5-13-37" id="h5-13-37" class="i">+            Query::Status =&gt; Raft::serialize(&amp;self.engine.kv.status()?),
</a> 
             Query::ReadTable { txn_id, table } =&gt; {
<a href="#h5-13-40" id="h5-13-40" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a><a href="#h5-13-41" id="h5-13-41" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.read_table(&amp;table)?)
</a>             }
             Query::ScanTables { txn_id } =&gt; {
<a href="#h5-13-44" id="h5-13-44" class="d">-                serialize(&amp;self.engine.resume(txn_id)?.scan_tables()?.collect::&lt;Vec&lt;_&gt;&gt;())
</a><a href="#h5-13-45" id="h5-13-45" class="i">+                Raft::serialize(&amp;self.engine.resume(txn_id)?.scan_tables()?.collect::&lt;Vec&lt;_&gt;&gt;())
</a>             }
         }
     }
<b>diff --git a/<a id="h6" href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a> b/<a href="../file/src/storage/kv/mvcc.rs.html">src/storage/kv/mvcc.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,7 +1,7 @@
</a> use super::Store;
<a href="#h6-0-1" id="h6-0-1" class="d">-use crate::utility::{deserialize, serialize};
</a> use crate::Error;
 
<a href="#h6-0-4" id="h6-0-4" class="i">+use serde::{Deserialize, Serialize};
</a> use serde_derive::{Deserialize, Serialize};
 use std::collections::HashSet;
 use std::ops::{Bound, RangeBounds};
<a href="#h6-1" id="h6-1" class="h">@@ -81,6 +81,16 @@ impl&lt;S: Store&gt; MVCC&lt;S&gt; {
</a>     }
 }
 
<a href="#h6-1-3" id="h6-1-3" class="i">+/// Serializes MVCC metadata.
</a><a href="#h6-1-4" id="h6-1-4" class="i">+fn serialize&lt;V: Serialize&gt;(value: &amp;V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h6-1-5" id="h6-1-5" class="i">+    Ok(serde_cbor::ser::to_vec_packed(value)?)
</a><a href="#h6-1-6" id="h6-1-6" class="i">+}
</a><a href="#h6-1-7" id="h6-1-7" class="i">+
</a><a href="#h6-1-8" id="h6-1-8" class="i">+/// Deserializes MVCC metadata.
</a><a href="#h6-1-9" id="h6-1-9" class="i">+fn deserialize&lt;&#39;a, V: Deserialize&lt;&#39;a&gt;&gt;(bytes: &amp;&#39;a [u8]) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h6-1-10" id="h6-1-10" class="i">+    Ok(serde_cbor::from_slice(bytes)?)
</a><a href="#h6-1-11" id="h6-1-11" class="i">+}
</a><a href="#h6-1-12" id="h6-1-12" class="i">+
</a> /// An MVCC transaction.
 pub struct Transaction&lt;S: Store&gt; {
     /// The underlying store for the transaction. Shared between transactions using a mutex.
<b>diff --git a/<a id="h7" href="../file/src/utility/mod.rs.html">src/utility/mod.rs</a> b/<a href="../file/src/utility/mod.rs.html">src/utility/mod.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,3 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-mod serialize;
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-pub use serialize::{deserialize, deserialize_read, serialize};
</a><b>diff --git a/<a id="h8" href="../file/src/utility/serialize.rs.html">src/utility/serialize.rs</a> b/<a href="../file/src/utility/serialize.rs.html">src/utility/serialize.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,32 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-use crate::Error;
</a><a href="#h8-0-1" id="h8-0-1" class="d">-
</a><a href="#h8-0-2" id="h8-0-2" class="d">-use serde::{de::DeserializeOwned, Deserialize, Serialize};
</a><a href="#h8-0-3" id="h8-0-3" class="d">-use std::io::Read;
</a><a href="#h8-0-4" id="h8-0-4" class="d">-
</a><a href="#h8-0-5" id="h8-0-5" class="d">-/// Deserializes a value from a byte buffer, using MessagePack.
</a><a href="#h8-0-6" id="h8-0-6" class="d">-/// Returns `Error::Internal` on error.
</a><a href="#h8-0-7" id="h8-0-7" class="d">-pub fn deserialize&lt;&#39;de, V: Deserialize&lt;&#39;de&gt;&gt;(bytes: &amp;[u8]) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h8-0-8" id="h8-0-8" class="d">-    Ok(Deserialize::deserialize(&amp;mut rmp_serde::Deserializer::new(bytes))?)
</a><a href="#h8-0-9" id="h8-0-9" class="d">-}
</a><a href="#h8-0-10" id="h8-0-10" class="d">-
</a><a href="#h8-0-11" id="h8-0-11" class="d">-/// Deserializes the next value from a reader, using MessagePack.
</a><a href="#h8-0-12" id="h8-0-12" class="d">-#[allow(dead_code)]
</a><a href="#h8-0-13" id="h8-0-13" class="d">-pub fn deserialize_read&lt;R: Read, V: DeserializeOwned&gt;(reader: R) -&gt; Result&lt;Option&lt;V&gt;, Error&gt; {
</a><a href="#h8-0-14" id="h8-0-14" class="d">-    match rmp_serde::decode::from_read(reader) {
</a><a href="#h8-0-15" id="h8-0-15" class="d">-        Ok(value) =&gt; Ok(Some(value)),
</a><a href="#h8-0-16" id="h8-0-16" class="d">-        Err(rmp_serde::decode::Error::InvalidMarkerRead(e))
</a><a href="#h8-0-17" id="h8-0-17" class="d">-            if e.kind() == std::io::ErrorKind::UnexpectedEof =&gt;
</a><a href="#h8-0-18" id="h8-0-18" class="d">-        {
</a><a href="#h8-0-19" id="h8-0-19" class="d">-            Ok(None)
</a><a href="#h8-0-20" id="h8-0-20" class="d">-        }
</a><a href="#h8-0-21" id="h8-0-21" class="d">-        Err(err) =&gt; Err(err.into()),
</a><a href="#h8-0-22" id="h8-0-22" class="d">-    }
</a><a href="#h8-0-23" id="h8-0-23" class="d">-}
</a><a href="#h8-0-24" id="h8-0-24" class="d">-
</a><a href="#h8-0-25" id="h8-0-25" class="d">-/// Serializes a value into a byte buffer, using MessagePack.
</a><a href="#h8-0-26" id="h8-0-26" class="d">-/// Returns `Error::Internal` on error.
</a><a href="#h8-0-27" id="h8-0-27" class="d">-pub fn serialize&lt;V: Serialize&gt;(value: &amp;V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h8-0-28" id="h8-0-28" class="d">-    let mut bytes = Vec::new();
</a><a href="#h8-0-29" id="h8-0-29" class="d">-    value.serialize(&amp;mut rmp_serde::Serializer::new(&amp;mut bytes))?;
</a><a href="#h8-0-30" id="h8-0-30" class="d">-    Ok(bytes)
</a><a href="#h8-0-31" id="h8-0-31" class="d">-}
</a></pre>
</div>
</body>
</html>
