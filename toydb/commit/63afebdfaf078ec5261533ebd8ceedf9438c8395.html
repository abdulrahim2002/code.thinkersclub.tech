<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: add transaction tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/63afebdfaf078ec5261533ebd8ceedf9438c8395.html">63afebdfaf078ec5261533ebd8ceedf9438c8395</a>
<b>parent</b> <a href="../commit/e04488cab6dff6b9296e09369bf82e1cd8cde319.html">e04488cab6dff6b9296e09369bf82e1cd8cde319</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Mon, 22 Jul 2024 13:06:37 +0200

sql: add transaction tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/mod.rs</a></td><td> | </td><td class="num">70</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h1">src/sql/testscripts/transactions/anomaly_dirty_read</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">src/sql/testscripts/transactions/anomaly_dirty_write</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">src/sql/testscripts/transactions/anomaly_fuzzy_read</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">src/sql/testscripts/transactions/anomaly_lost_update</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/sql/testscripts/transactions/anomaly_phantom_read</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">src/sql/testscripts/transactions/anomaly_read_skew</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">src/sql/testscripts/transactions/anomaly_write_skew</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">src/sql/testscripts/transactions/begin</a></td><td> | </td><td class="num">80</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/sql/testscripts/transactions/commit</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/sql/testscripts/transactions/isolation</a></td><td> | </td><td class="num">94</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">src/sql/testscripts/transactions/rollback</a></td><td> | </td><td class="num">51</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/sql/testscripts/transactions/schema</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/storage/testscripts/mvcc/anomaly_dirty_read</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/storage/testscripts/mvcc/anomaly_write_skew</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
</table></pre><pre>15 files changed, 540 insertions(+), 32 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a> b/<a href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -74,34 +74,36 @@ pub mod types;
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h0-0-3" id="h0-0-3" class="i">+    use super::engine::{Catalog as _, Session};
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    use super::parser::Parser;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+    use super::planner::{Node, Plan, OPTIMIZERS};
</a>     use crate::encoding::format::{self, Formatter as _};
     use crate::sql::engine::{Engine, Local, StatementResult};
     use crate::sql::planner::{Planner, Scope};
<a href="#h0-0-9" id="h0-0-9" class="d">-    use crate::storage::engine::test::{Emit, Mirror, Operation};
</a><a href="#h0-0-10" id="h0-0-10" class="i">+    use crate::storage::engine::test::{self, Emit, Mirror, Operation};
</a>     use crate::storage::{self, Engine as _};
<a href="#h0-0-12" id="h0-0-12" class="i">+
</a>     use crossbeam::channel::Receiver;
     use itertools::Itertools as _;
<a href="#h0-0-15" id="h0-0-15" class="i">+    use std::collections::HashMap;
</a>     use std::error::Error;
     use std::fmt::Write as _;
     use std::result::Result;
     use test_each_file::test_each_path;
 
<a href="#h0-0-21" id="h0-0-21" class="d">-    use super::engine::{Catalog as _, Session};
</a><a href="#h0-0-22" id="h0-0-22" class="d">-    use super::parser::Parser;
</a><a href="#h0-0-23" id="h0-0-23" class="d">-    use super::planner::{Node, Plan, OPTIMIZERS};
</a><a href="#h0-0-24" id="h0-0-24" class="d">-
</a>     // Run goldenscript tests in src/sql/testscripts.
     test_each_path! { in &quot;src/sql/testscripts/optimizer&quot; as optimizer =&gt; test_goldenscript }
     test_each_path! { in &quot;src/sql/testscripts/queries&quot; as queries =&gt; test_goldenscript }
     test_each_path! { in &quot;src/sql/testscripts/schema&quot; as schema =&gt; test_goldenscript }
<a href="#h0-0-29" id="h0-0-29" class="i">+    test_each_path! { in &quot;src/sql/testscripts/transactions&quot; as transactions =&gt; test_goldenscript }
</a>     test_each_path! { in &quot;src/sql/testscripts/writes&quot; as writes =&gt; test_goldenscript }
     test_each_path! { in &quot;src/sql/testscripts/expressions&quot; as expressions =&gt; test_goldenscript_expr }
 
<a href="#h0-0-33" id="h0-0-33" class="i">+    /// Runs SQL goldenscripts.
</a>     fn test_goldenscript(path: &amp;std::path::Path) {
<a href="#h0-0-35" id="h0-0-35" class="d">-        // Since the runner&#39;s Session can&#39;t reference an Engine stored in the
</a><a href="#h0-0-36" id="h0-0-36" class="d">-        // same struct, we borrow the engine. Use both a BitCask and a Memory
</a><a href="#h0-0-37" id="h0-0-37" class="d">-        // engine, and mirror operations across them. Emit engine operations to
</a><a href="#h0-0-38" id="h0-0-38" class="d">-        // op_rx.
</a><a href="#h0-0-39" id="h0-0-39" class="i">+        // Since the runner&#39;s Session can&#39;t reference an Engine in the same
</a><a href="#h0-0-40" id="h0-0-40" class="i">+        // struct, borrow the engine. Use both a BitCask and a Memory engine,
</a><a href="#h0-0-41" id="h0-0-41" class="i">+        // and mirror operations across them. Emit engine operations to op_rx.
</a>         let (op_tx, op_rx) = crossbeam::channel::unbounded();
         let tempdir = tempfile::TempDir::with_prefix(&quot;toydb&quot;).expect(&quot;tempdir failed&quot;);
         let bitcask =
<a href="#h0-1" id="h0-1" class="h">@@ -113,23 +115,23 @@ mod tests {
</a>         goldenscript::run(&amp;mut runner, path).expect(&quot;goldenscript failed&quot;)
     }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+    /// Runs expression goldenscripts.
</a>     fn test_goldenscript_expr(path: &amp;std::path::Path) {
         goldenscript::run(&amp;mut ExpressionRunner, path).expect(&quot;goldenscript failed&quot;)
     }
 
<a href="#h0-1-8" id="h0-1-8" class="d">-    /// A SQL test runner.
</a><a href="#h0-1-9" id="h0-1-9" class="i">+    /// The SQL test runner.
</a>     struct SQLRunner&lt;&#39;a&gt; {
         engine: &amp;&#39;a TestEngine,
<a href="#h0-1-12" id="h0-1-12" class="d">-        session: Session&lt;&#39;a, TestEngine&gt;,
</a><a href="#h0-1-13" id="h0-1-13" class="i">+        sessions: HashMap&lt;String, Session&lt;&#39;a, TestEngine&gt;&gt;,
</a>         op_rx: Receiver&lt;Operation&gt;,
     }
 
<a href="#h0-1-17" id="h0-1-17" class="d">-    type TestEngine = Local&lt;Emit&lt;Mirror&lt;storage::BitCask, storage::Memory&gt;&gt;&gt;;
</a><a href="#h0-1-18" id="h0-1-18" class="i">+    type TestEngine = Local&lt;test::Emit&lt;test::Mirror&lt;storage::BitCask, storage::Memory&gt;&gt;&gt;;
</a> 
     impl&lt;&#39;a&gt; SQLRunner&lt;&#39;a&gt; {
         fn new(engine: &amp;&#39;a TestEngine, op_rx: Receiver&lt;Operation&gt;) -&gt; Self {
<a href="#h0-1-22" id="h0-1-22" class="d">-            let session = engine.session();
</a><a href="#h0-1-23" id="h0-1-23" class="d">-            Self { engine, session, op_rx }
</a><a href="#h0-1-24" id="h0-1-24" class="i">+            Self { engine, sessions: HashMap::new(), op_rx }
</a>         }
     }
 
<a href="#h0-2" id="h0-2" class="h">@@ -137,6 +139,10 @@ mod tests {
</a>         fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
             let mut output = String::new();
 
<a href="#h0-2-3" id="h0-2-3" class="i">+            // Obtain a session for the command prefix.
</a><a href="#h0-2-4" id="h0-2-4" class="i">+            let prefix = command.prefix.clone().unwrap_or_default();
</a><a href="#h0-2-5" id="h0-2-5" class="i">+            let session = self.sessions.entry(prefix).or_insert_with(|| self.engine.session());
</a><a href="#h0-2-6" id="h0-2-6" class="i">+
</a>             // Handle runner commands.
             match command.name.as_str() {
                 // dump
<a href="#h0-3" id="h0-3" class="h">@@ -162,11 +168,11 @@ mod tests {
</a>                     args.reject_rest()?;
 
                     let schemas = if tables.is_empty() {
<a href="#h0-3-3" id="h0-3-3" class="d">-                        self.session.with_txn(true, |txn| txn.list_tables())?
</a><a href="#h0-3-4" id="h0-3-4" class="i">+                        session.with_txn(true, |txn| txn.list_tables())?
</a>                     } else {
                         tables
                             .into_iter()
<a href="#h0-3-8" id="h0-3-8" class="d">-                            .map(|t| self.session.with_txn(true, |txn| txn.must_get_table(&amp;t)))
</a><a href="#h0-3-9" id="h0-3-9" class="i">+                            .map(|t| session.with_txn(true, |txn| txn.must_get_table(&amp;t)))
</a>                             .try_collect()?
                     };
                     return Ok(schemas.into_iter().map(|s| s.to_string()).join(&quot;\n&quot;));
<a href="#h0-4" id="h0-4" class="h">@@ -184,7 +190,7 @@ mod tests {
</a>             let mut tags = command.tags.clone();
 
             // Execute the statement.
<a href="#h0-4-3" id="h0-4-3" class="d">-            let result = self.session.execute(input)?;
</a><a href="#h0-4-4" id="h0-4-4" class="i">+            let result = session.execute(input)?;
</a> 
             // Output optimizations if requested.
             if tags.remove(&quot;opt&quot;) {
<a href="#h0-5" id="h0-5" class="h">@@ -192,7 +198,7 @@ mod tests {
</a>                     return Err(&quot;no point using both plan and opt&quot;.into());
                 }
                 let ast = Parser::new(input).parse()?;
<a href="#h0-5-3" id="h0-5-3" class="d">-                let plan = self.session.with_txn(true, |txn| Planner::new(txn).build(ast))?;
</a><a href="#h0-5-4" id="h0-5-4" class="i">+                let plan = session.with_txn(true, |txn| Planner::new(txn).build(ast))?;
</a>                 let Plan::Select(mut root) = plan else {
                     return Err(&quot;can only use opt with SELECT plans&quot;.into());
                 };
<a href="#h0-6" id="h0-6" class="h">@@ -211,23 +217,31 @@ mod tests {
</a>             // Output the plan if requested.
             if tags.remove(&quot;plan&quot;) {
                 let query = format!(&quot;EXPLAIN {input}&quot;);
<a href="#h0-6-3" id="h0-6-3" class="d">-                let StatementResult::Explain(plan) = self.session.execute(&amp;query)? else {
</a><a href="#h0-6-4" id="h0-6-4" class="i">+                let StatementResult::Explain(plan) = session.execute(&amp;query)? else {
</a>                     return Err(&quot;unexpected explain response&quot;.into());
                 };
                 writeln!(output, &quot;{plan}&quot;)?;
             }
 
<a href="#h0-6-10" id="h0-6-10" class="d">-            // Output the result if requested. SELECT results are always output,
</a><a href="#h0-6-11" id="h0-6-11" class="d">-            // but the column only if result is given.
</a><a href="#h0-6-12" id="h0-6-12" class="d">-            if let StatementResult::Select { columns, rows } = result {
</a><a href="#h0-6-13" id="h0-6-13" class="d">-                if tags.remove(&quot;header&quot;) {
</a><a href="#h0-6-14" id="h0-6-14" class="d">-                    writeln!(output, &quot;{}&quot;, columns.into_iter().map(|c| c.to_string()).join(&quot;, &quot;))?;
</a><a href="#h0-6-15" id="h0-6-15" class="i">+            // Output the result if requested. SELECT results are always output.
</a><a href="#h0-6-16" id="h0-6-16" class="i">+            let show_result = tags.remove(&quot;result&quot;);
</a><a href="#h0-6-17" id="h0-6-17" class="i">+            match result {
</a><a href="#h0-6-18" id="h0-6-18" class="i">+                StatementResult::Select { columns, rows } =&gt; {
</a><a href="#h0-6-19" id="h0-6-19" class="i">+                    if tags.remove(&quot;header&quot;) {
</a><a href="#h0-6-20" id="h0-6-20" class="i">+                        writeln!(output, &quot;{}&quot;, columns.into_iter().join(&quot;, &quot;))?;
</a><a href="#h0-6-21" id="h0-6-21" class="i">+                    }
</a><a href="#h0-6-22" id="h0-6-22" class="i">+                    for row in rows {
</a><a href="#h0-6-23" id="h0-6-23" class="i">+                        writeln!(output, &quot;{}&quot;, row.into_iter().join(&quot;, &quot;))?;
</a><a href="#h0-6-24" id="h0-6-24" class="i">+                    }
</a>                 }
<a href="#h0-6-26" id="h0-6-26" class="d">-                for row in rows {
</a><a href="#h0-6-27" id="h0-6-27" class="d">-                    writeln!(output, &quot;{}&quot;, row.into_iter().map(|v| v.to_string()).join(&quot;, &quot;))?;
</a><a href="#h0-6-28" id="h0-6-28" class="i">+                StatementResult::Begin { state } if show_result =&gt; {
</a><a href="#h0-6-29" id="h0-6-29" class="i">+                    let version = state.version;
</a><a href="#h0-6-30" id="h0-6-30" class="i">+                    let kind = if state.read_only { &quot;read-only&quot; } else { &quot;read-write&quot; };
</a><a href="#h0-6-31" id="h0-6-31" class="i">+                    let active = state.active.iter().join(&quot;,&quot;);
</a><a href="#h0-6-32" id="h0-6-32" class="i">+                    writeln!(output, &quot;v{version} {kind} active={{{active}}}&quot;)?;
</a>                 }
<a href="#h0-6-34" id="h0-6-34" class="d">-            } else if tags.remove(&quot;result&quot;) {
</a><a href="#h0-6-35" id="h0-6-35" class="d">-                writeln!(output, &quot;{result:?}&quot;)?;
</a><a href="#h0-6-36" id="h0-6-36" class="i">+                result if show_result =&gt; writeln!(output, &quot;{result:?}&quot;)?,
</a><a href="#h0-6-37" id="h0-6-37" class="i">+                _ =&gt; {}
</a>             }
 
             // Output engine ops if requested.
<b>diff --git a/<a id="h1" href="../file/src/sql/testscripts/transactions/anomaly_dirty_read.html">src/sql/testscripts/transactions/anomaly_dirty_read</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_dirty_read.html">src/sql/testscripts/transactions/anomaly_dirty_read</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+# A dirty read is when c2 can read an uncommitted value set by c1. Snapshot
</a><a href="#h1-0-1" id="h1-0-1" class="i">+# isolation prevents this.
</a><a href="#h1-0-2" id="h1-0-2" class="i">+
</a><a href="#h1-0-3" id="h1-0-3" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h1-0-4" id="h1-0-4" class="i">+---
</a><a href="#h1-0-5" id="h1-0-5" class="i">+ok
</a><a href="#h1-0-6" id="h1-0-6" class="i">+
</a><a href="#h1-0-7" id="h1-0-7" class="i">+c1:&gt; BEGIN
</a><a href="#h1-0-8" id="h1-0-8" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h1-0-9" id="h1-0-9" class="i">+---
</a><a href="#h1-0-10" id="h1-0-10" class="i">+ok
</a><a href="#h1-0-11" id="h1-0-11" class="i">+
</a><a href="#h1-0-12" id="h1-0-12" class="i">+c2:&gt; BEGIN
</a><a href="#h1-0-13" id="h1-0-13" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h1-0-14" id="h1-0-14" class="i">+---
</a><a href="#h1-0-15" id="h1-0-15" class="i">+ok
</a><b>diff --git a/<a id="h2" href="../file/src/sql/testscripts/transactions/anomaly_dirty_write.html">src/sql/testscripts/transactions/anomaly_dirty_write</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_dirty_write.html">src/sql/testscripts/transactions/anomaly_dirty_write</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,16 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+# A dirty write is when c2 overwrites an uncommitted value written by c1.
</a><a href="#h2-0-1" id="h2-0-1" class="i">+# Snapshot isolation prevents this.
</a><a href="#h2-0-2" id="h2-0-2" class="i">+
</a><a href="#h2-0-3" id="h2-0-3" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h2-0-4" id="h2-0-4" class="i">+---
</a><a href="#h2-0-5" id="h2-0-5" class="i">+ok
</a><a href="#h2-0-6" id="h2-0-6" class="i">+
</a><a href="#h2-0-7" id="h2-0-7" class="i">+c1:&gt; BEGIN
</a><a href="#h2-0-8" id="h2-0-8" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h2-0-9" id="h2-0-9" class="i">+---
</a><a href="#h2-0-10" id="h2-0-10" class="i">+ok
</a><a href="#h2-0-11" id="h2-0-11" class="i">+
</a><a href="#h2-0-12" id="h2-0-12" class="i">+c2:&gt; BEGIN
</a><a href="#h2-0-13" id="h2-0-13" class="i">+c2:!&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h2-0-14" id="h2-0-14" class="i">+---
</a><a href="#h2-0-15" id="h2-0-15" class="i">+c2: Error: serialization failure, retry transaction
</a><b>diff --git a/<a id="h3" href="../file/src/sql/testscripts/transactions/anomaly_fuzzy_read.html">src/sql/testscripts/transactions/anomaly_fuzzy_read</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_fuzzy_read.html">src/sql/testscripts/transactions/anomaly_fuzzy_read</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+# A fuzzy (or unrepeatable) read is when c2 sees a value change after c1
</a><a href="#h3-0-1" id="h3-0-1" class="i">+# updates it. Snapshot isolation prevents this.
</a><a href="#h3-0-2" id="h3-0-2" class="i">+
</a><a href="#h3-0-3" id="h3-0-3" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h3-0-5" id="h3-0-5" class="i">+---
</a><a href="#h3-0-6" id="h3-0-6" class="i">+ok
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+c1:&gt; BEGIN
</a><a href="#h3-0-9" id="h3-0-9" class="i">+c2:&gt; BEGIN
</a><a href="#h3-0-10" id="h3-0-10" class="i">+---
</a><a href="#h3-0-11" id="h3-0-11" class="i">+ok
</a><a href="#h3-0-12" id="h3-0-12" class="i">+
</a><a href="#h3-0-13" id="h3-0-13" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h3-0-14" id="h3-0-14" class="i">+---
</a><a href="#h3-0-15" id="h3-0-15" class="i">+c2: 1, &#39;a&#39;
</a><a href="#h3-0-16" id="h3-0-16" class="i">+
</a><a href="#h3-0-17" id="h3-0-17" class="i">+c1:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h3-0-18" id="h3-0-18" class="i">+c1:&gt; COMMIT
</a><a href="#h3-0-19" id="h3-0-19" class="i">+c1:&gt; SELECT * FROM test
</a><a href="#h3-0-20" id="h3-0-20" class="i">+---
</a><a href="#h3-0-21" id="h3-0-21" class="i">+c1: 1, &#39;b&#39;
</a><a href="#h3-0-22" id="h3-0-22" class="i">+
</a><a href="#h3-0-23" id="h3-0-23" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h3-0-24" id="h3-0-24" class="i">+---
</a><a href="#h3-0-25" id="h3-0-25" class="i">+c2: 1, &#39;a&#39;
</a><b>diff --git a/<a id="h4" href="../file/src/sql/testscripts/transactions/anomaly_lost_update.html">src/sql/testscripts/transactions/anomaly_lost_update</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_lost_update.html">src/sql/testscripts/transactions/anomaly_lost_update</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+# A lost update is when c1 and c2 both read a value and update it, where
</a><a href="#h4-0-1" id="h4-0-1" class="i">+# c2&#39;s update replaces c1. Snapshot isolation prevents this.
</a><a href="#h4-0-2" id="h4-0-2" class="i">+
</a><a href="#h4-0-3" id="h4-0-3" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h4-0-4" id="h4-0-4" class="i">+---
</a><a href="#h4-0-5" id="h4-0-5" class="i">+ok
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a><a href="#h4-0-7" id="h4-0-7" class="i">+
</a><a href="#h4-0-8" id="h4-0-8" class="i">+c1:&gt; BEGIN
</a><a href="#h4-0-9" id="h4-0-9" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h4-0-10" id="h4-0-10" class="i">+---
</a><a href="#h4-0-11" id="h4-0-11" class="i">+ok
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+c2:&gt; BEGIN
</a><a href="#h4-0-14" id="h4-0-14" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h4-0-15" id="h4-0-15" class="i">+---
</a><a href="#h4-0-16" id="h4-0-16" class="i">+ok
</a><a href="#h4-0-17" id="h4-0-17" class="i">+
</a><a href="#h4-0-18" id="h4-0-18" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h4-0-19" id="h4-0-19" class="i">+c1:&gt; COMMIT
</a><a href="#h4-0-20" id="h4-0-20" class="i">+---
</a><a href="#h4-0-21" id="h4-0-21" class="i">+ok
</a><a href="#h4-0-22" id="h4-0-22" class="i">+
</a><a href="#h4-0-23" id="h4-0-23" class="i">+c2:!&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h4-0-24" id="h4-0-24" class="i">+---
</a><a href="#h4-0-25" id="h4-0-25" class="i">+c2: Error: serialization failure, retry transaction
</a><b>diff --git a/<a id="h5" href="../file/src/sql/testscripts/transactions/anomaly_phantom_read.html">src/sql/testscripts/transactions/anomaly_phantom_read</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_phantom_read.html">src/sql/testscripts/transactions/anomaly_phantom_read</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,29 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+# A phantom read is when t1 reads entries matching some predicate, but a
</a><a href="#h5-0-1" id="h5-0-1" class="i">+# modification by t2 changes which entries match the predicate such that a later
</a><a href="#h5-0-2" id="h5-0-2" class="i">+# read by t1 returns them. Snapshot isolation prevents this.
</a><a href="#h5-0-3" id="h5-0-3" class="i">+
</a><a href="#h5-0-4" id="h5-0-4" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h5-0-5" id="h5-0-5" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;), (3, &#39;c&#39;)
</a><a href="#h5-0-6" id="h5-0-6" class="i">+---
</a><a href="#h5-0-7" id="h5-0-7" class="i">+ok
</a><a href="#h5-0-8" id="h5-0-8" class="i">+
</a><a href="#h5-0-9" id="h5-0-9" class="i">+c1:&gt; BEGIN
</a><a href="#h5-0-10" id="h5-0-10" class="i">+c2:&gt; BEGIN
</a><a href="#h5-0-11" id="h5-0-11" class="i">+---
</a><a href="#h5-0-12" id="h5-0-12" class="i">+ok
</a><a href="#h5-0-13" id="h5-0-13" class="i">+
</a><a href="#h5-0-14" id="h5-0-14" class="i">+c1:&gt; SELECT * FROM test WHERE id &gt; 1
</a><a href="#h5-0-15" id="h5-0-15" class="i">+---
</a><a href="#h5-0-16" id="h5-0-16" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h5-0-17" id="h5-0-17" class="i">+c1: 3, &#39;c&#39;
</a><a href="#h5-0-18" id="h5-0-18" class="i">+
</a><a href="#h5-0-19" id="h5-0-19" class="i">+c2:&gt; DELETE FROM test WHERE id = 2
</a><a href="#h5-0-20" id="h5-0-20" class="i">+c2:&gt; INSERT INTO test VALUES (4, &#39;d&#39;)
</a><a href="#h5-0-21" id="h5-0-21" class="i">+c2:&gt; COMMIT
</a><a href="#h5-0-22" id="h5-0-22" class="i">+---
</a><a href="#h5-0-23" id="h5-0-23" class="i">+ok
</a><a href="#h5-0-24" id="h5-0-24" class="i">+
</a><a href="#h5-0-25" id="h5-0-25" class="i">+c1:&gt; SELECT * FROM test WHERE id &gt; 1
</a><a href="#h5-0-26" id="h5-0-26" class="i">+---
</a><a href="#h5-0-27" id="h5-0-27" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h5-0-28" id="h5-0-28" class="i">+c1: 3, &#39;c&#39;
</a><b>diff --git a/<a id="h6" href="../file/src/sql/testscripts/transactions/anomaly_read_skew.html">src/sql/testscripts/transactions/anomaly_read_skew</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_read_skew.html">src/sql/testscripts/transactions/anomaly_read_skew</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,26 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+# Read skew is when c1 reads a and b, but c2 modifies b in between the
</a><a href="#h6-0-1" id="h6-0-1" class="i">+# reads. Snapshot isolation prevents this.
</a><a href="#h6-0-2" id="h6-0-2" class="i">+
</a><a href="#h6-0-3" id="h6-0-3" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h6-0-4" id="h6-0-4" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h6-0-5" id="h6-0-5" class="i">+---
</a><a href="#h6-0-6" id="h6-0-6" class="i">+ok
</a><a href="#h6-0-7" id="h6-0-7" class="i">+
</a><a href="#h6-0-8" id="h6-0-8" class="i">+c1:&gt; BEGIN
</a><a href="#h6-0-9" id="h6-0-9" class="i">+c2:&gt; BEGIN
</a><a href="#h6-0-10" id="h6-0-10" class="i">+---
</a><a href="#h6-0-11" id="h6-0-11" class="i">+ok
</a><a href="#h6-0-12" id="h6-0-12" class="i">+
</a><a href="#h6-0-13" id="h6-0-13" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h6-0-14" id="h6-0-14" class="i">+---
</a><a href="#h6-0-15" id="h6-0-15" class="i">+c1: 1, &#39;a&#39;
</a><a href="#h6-0-16" id="h6-0-16" class="i">+
</a><a href="#h6-0-17" id="h6-0-17" class="i">+c2:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h6-0-18" id="h6-0-18" class="i">+c2:&gt; UPDATE test SET value = &#39;a&#39; WHERE id = 2
</a><a href="#h6-0-19" id="h6-0-19" class="i">+c2:&gt; COMMIT
</a><a href="#h6-0-20" id="h6-0-20" class="i">+---
</a><a href="#h6-0-21" id="h6-0-21" class="i">+ok
</a><a href="#h6-0-22" id="h6-0-22" class="i">+
</a><a href="#h6-0-23" id="h6-0-23" class="i">+c1:&gt; SELECT * FROM test WHERE id = 2
</a><a href="#h6-0-24" id="h6-0-24" class="i">+---
</a><a href="#h6-0-25" id="h6-0-25" class="i">+c1: 2, &#39;b&#39;
</a><b>diff --git a/<a id="h7" href="../file/src/sql/testscripts/transactions/anomaly_write_skew.html">src/sql/testscripts/transactions/anomaly_write_skew</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_write_skew.html">src/sql/testscripts/transactions/anomaly_write_skew</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,35 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+# Write skew is when c1 reads a and writes it to b while c2 reads b and writes
</a><a href="#h7-0-1" id="h7-0-1" class="i">+# it to a. Snapshot isolation does not prevent this, which is expected, so we
</a><a href="#h7-0-2" id="h7-0-2" class="i">+# assert the anomalous behavior. Fixing this would require implementing
</a><a href="#h7-0-3" id="h7-0-3" class="i">+# serializable snapshot isolation.
</a><a href="#h7-0-4" id="h7-0-4" class="i">+
</a><a href="#h7-0-5" id="h7-0-5" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h7-0-6" id="h7-0-6" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h7-0-7" id="h7-0-7" class="i">+---
</a><a href="#h7-0-8" id="h7-0-8" class="i">+ok
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+c1:&gt; BEGIN
</a><a href="#h7-0-11" id="h7-0-11" class="i">+c2:&gt; BEGIN
</a><a href="#h7-0-12" id="h7-0-12" class="i">+---
</a><a href="#h7-0-13" id="h7-0-13" class="i">+ok
</a><a href="#h7-0-14" id="h7-0-14" class="i">+
</a><a href="#h7-0-15" id="h7-0-15" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h7-0-16" id="h7-0-16" class="i">+c2:&gt; SELECT * FROM test WHERE id = 2
</a><a href="#h7-0-17" id="h7-0-17" class="i">+---
</a><a href="#h7-0-18" id="h7-0-18" class="i">+c1: 1, &#39;a&#39;
</a><a href="#h7-0-19" id="h7-0-19" class="i">+c2: 2, &#39;b&#39;
</a><a href="#h7-0-20" id="h7-0-20" class="i">+
</a><a href="#h7-0-21" id="h7-0-21" class="i">+c1:&gt; UPDATE test SET value = &#39;a&#39; WHERE id = 2
</a><a href="#h7-0-22" id="h7-0-22" class="i">+c2:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h7-0-23" id="h7-0-23" class="i">+---
</a><a href="#h7-0-24" id="h7-0-24" class="i">+ok
</a><a href="#h7-0-25" id="h7-0-25" class="i">+
</a><a href="#h7-0-26" id="h7-0-26" class="i">+c1:&gt; COMMIT
</a><a href="#h7-0-27" id="h7-0-27" class="i">+c2:&gt; COMMIT
</a><a href="#h7-0-28" id="h7-0-28" class="i">+---
</a><a href="#h7-0-29" id="h7-0-29" class="i">+ok
</a><a href="#h7-0-30" id="h7-0-30" class="i">+
</a><a href="#h7-0-31" id="h7-0-31" class="i">+&gt; SELECT * FROM test
</a><a href="#h7-0-32" id="h7-0-32" class="i">+---
</a><a href="#h7-0-33" id="h7-0-33" class="i">+1, &#39;b&#39;
</a><a href="#h7-0-34" id="h7-0-34" class="i">+2, &#39;a&#39;
</a><b>diff --git a/<a id="h8" href="../file/src/sql/testscripts/transactions/begin.html">src/sql/testscripts/transactions/begin</a> b/<a href="../file/src/sql/testscripts/transactions/begin.html">src/sql/testscripts/transactions/begin</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+# Tests BEGIN.
</a><a href="#h8-0-1" id="h8-0-1" class="i">+
</a><a href="#h8-0-2" id="h8-0-2" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h8-0-3" id="h8-0-3" class="i">+&gt; INSERT INTO test VALUES (0, &#39;&#39;)
</a><a href="#h8-0-4" id="h8-0-4" class="i">+---
</a><a href="#h8-0-5" id="h8-0-5" class="i">+ok
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+# BEGIN starts a new transaction. It bumps NextVersion and writes a TxnActive
</a><a href="#h8-0-8" id="h8-0-8" class="i">+# record for itself.
</a><a href="#h8-0-9" id="h8-0-9" class="i">+c1:[result,ops]&gt; BEGIN
</a><a href="#h8-0-10" id="h8-0-10" class="i">+---
</a><a href="#h8-0-11" id="h8-0-11" class="i">+c1: v3 read-write active={}
</a><a href="#h8-0-12" id="h8-0-12" class="i">+c1: storage set mvcc:NextVersion → 4 [&quot;\x00&quot; → &quot;\x04&quot;]
</a><a href="#h8-0-13" id="h8-0-13" class="i">+c1: storage set mvcc:TxnActive(3) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x03&quot; → &quot;&quot;]
</a><a href="#h8-0-14" id="h8-0-14" class="i">+
</a><a href="#h8-0-15" id="h8-0-15" class="i">+# Starting another transaction for c1 errors.
</a><a href="#h8-0-16" id="h8-0-16" class="i">+c1:!&gt; BEGIN
</a><a href="#h8-0-17" id="h8-0-17" class="i">+c1:!&gt; BEGIN READ ONLY
</a><a href="#h8-0-18" id="h8-0-18" class="i">+---
</a><a href="#h8-0-19" id="h8-0-19" class="i">+c1: Error: invalid input: already in a transaction
</a><a href="#h8-0-20" id="h8-0-20" class="i">+c1: Error: invalid input: already in a transaction
</a><a href="#h8-0-21" id="h8-0-21" class="i">+
</a><a href="#h8-0-22" id="h8-0-22" class="i">+# Another client can begin a concurrent transaction, capturing c1&#39;s version in
</a><a href="#h8-0-23" id="h8-0-23" class="i">+# its active set. The active snapshot is persisted to storage.
</a><a href="#h8-0-24" id="h8-0-24" class="i">+c2:[result,ops]&gt; BEGIN
</a><a href="#h8-0-25" id="h8-0-25" class="i">+---
</a><a href="#h8-0-26" id="h8-0-26" class="i">+c2: v4 read-write active={3}
</a><a href="#h8-0-27" id="h8-0-27" class="i">+c2: storage set mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h8-0-28" id="h8-0-28" class="i">+c2: storage set mvcc:TxnActiveSnapshot(4) → {3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x03&quot;]
</a><a href="#h8-0-29" id="h8-0-29" class="i">+c2: storage set mvcc:TxnActive(4) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;&quot;]
</a><a href="#h8-0-30" id="h8-0-30" class="i">+
</a><a href="#h8-0-31" id="h8-0-31" class="i">+# A read-only transaction doesn&#39;t allocate a new version, and doesn&#39;t perform
</a><a href="#h8-0-32" id="h8-0-32" class="i">+# any storage engine writes. It does capture an active set though, and it can&#39;t
</a><a href="#h8-0-33" id="h8-0-33" class="i">+# perform any writes.
</a><a href="#h8-0-34" id="h8-0-34" class="i">+c3:[result,ops]&gt; BEGIN READ ONLY
</a><a href="#h8-0-35" id="h8-0-35" class="i">+c3:!&gt; INSERT INTO test VALUES (0, &#39;&#39;)
</a><a href="#h8-0-36" id="h8-0-36" class="i">+c3:&gt; ROLLBACK
</a><a href="#h8-0-37" id="h8-0-37" class="i">+---
</a><a href="#h8-0-38" id="h8-0-38" class="i">+c3: v5 read-only active={3,4}
</a><a href="#h8-0-39" id="h8-0-39" class="i">+c3: Error: invalid input: primary key 0 already exists
</a><a href="#h8-0-40" id="h8-0-40" class="i">+
</a><a href="#h8-0-41" id="h8-0-41" class="i">+# c1 writes a value and commits.
</a><a href="#h8-0-42" id="h8-0-42" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h8-0-43" id="h8-0-43" class="i">+c1:&gt; COMMIT
</a><a href="#h8-0-44" id="h8-0-44" class="i">+---
</a><a href="#h8-0-45" id="h8-0-45" class="i">+ok
</a><a href="#h8-0-46" id="h8-0-46" class="i">+
</a><a href="#h8-0-47" id="h8-0-47" class="i">+# A transaction as of version 1 doesn&#39;t see anything, since the
</a><a href="#h8-0-48" id="h8-0-48" class="i">+# table was created in this version.
</a><a href="#h8-0-49" id="h8-0-49" class="i">+c3:[result,ops]&gt; BEGIN READ ONLY AS OF SYSTEM TIME 1
</a><a href="#h8-0-50" id="h8-0-50" class="i">+c3:!&gt; SELECT * FROM test
</a><a href="#h8-0-51" id="h8-0-51" class="i">+c3:&gt; ROLLBACK
</a><a href="#h8-0-52" id="h8-0-52" class="i">+---
</a><a href="#h8-0-53" id="h8-0-53" class="i">+c3: v1 read-only active={}
</a><a href="#h8-0-54" id="h8-0-54" class="i">+c3: Error: invalid input: table test does not exist
</a><a href="#h8-0-55" id="h8-0-55" class="i">+
</a><a href="#h8-0-56" id="h8-0-56" class="i">+# It sees the table at version 2, but no rows. The row is visible
</a><a href="#h8-0-57" id="h8-0-57" class="i">+# at version 3, but not c1&#39;s write which was committed at the end
</a><a href="#h8-0-58" id="h8-0-58" class="i">+# of version 3.
</a><a href="#h8-0-59" id="h8-0-59" class="i">+c3:[result,ops]&gt; BEGIN READ ONLY AS OF SYSTEM TIME 2
</a><a href="#h8-0-60" id="h8-0-60" class="i">+c3:&gt; SELECT * FROM test
</a><a href="#h8-0-61" id="h8-0-61" class="i">+c3:&gt; ROLLBACK
</a><a href="#h8-0-62" id="h8-0-62" class="i">+---
</a><a href="#h8-0-63" id="h8-0-63" class="i">+c3: v2 read-only active={}
</a><a href="#h8-0-64" id="h8-0-64" class="i">+
</a><a href="#h8-0-65" id="h8-0-65" class="i">+c3:[result,ops]&gt; BEGIN READ ONLY AS OF SYSTEM TIME 3
</a><a href="#h8-0-66" id="h8-0-66" class="i">+c3:&gt; SELECT * FROM test
</a><a href="#h8-0-67" id="h8-0-67" class="i">+c3:&gt; ROLLBACK
</a><a href="#h8-0-68" id="h8-0-68" class="i">+---
</a><a href="#h8-0-69" id="h8-0-69" class="i">+c3: v3 read-only active={}
</a><a href="#h8-0-70" id="h8-0-70" class="i">+c3: 0, &#39;&#39;
</a><a href="#h8-0-71" id="h8-0-71" class="i">+
</a><a href="#h8-0-72" id="h8-0-72" class="i">+# At version 4, we inherit c2&#39;s active set which excludes c1, and still can&#39;t
</a><a href="#h8-0-73" id="h8-0-73" class="i">+# see c1&#39;s write.
</a><a href="#h8-0-74" id="h8-0-74" class="i">+c3:[result,ops]&gt; BEGIN READ ONLY AS OF SYSTEM TIME 4
</a><a href="#h8-0-75" id="h8-0-75" class="i">+c3:&gt; SELECT * FROM test
</a><a href="#h8-0-76" id="h8-0-76" class="i">+c3:&gt; ROLLBACK
</a><a href="#h8-0-77" id="h8-0-77" class="i">+---
</a><a href="#h8-0-78" id="h8-0-78" class="i">+c3: v4 read-only active={3}
</a><a href="#h8-0-79" id="h8-0-79" class="i">+c3: 0, &#39;&#39;
</a><b>diff --git a/<a id="h9" href="../file/src/sql/testscripts/transactions/commit.html">src/sql/testscripts/transactions/commit</a> b/<a href="../file/src/sql/testscripts/transactions/commit.html">src/sql/testscripts/transactions/commit</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,49 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+# Tests COMMIT.
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h9-0-3" id="h9-0-3" class="i">+---
</a><a href="#h9-0-4" id="h9-0-4" class="i">+ok
</a><a href="#h9-0-5" id="h9-0-5" class="i">+
</a><a href="#h9-0-6" id="h9-0-6" class="i">+# A commit removes the TxnActive record and its TxnWrite records.
</a><a href="#h9-0-7" id="h9-0-7" class="i">+[ops,result]&gt; BEGIN
</a><a href="#h9-0-8" id="h9-0-8" class="i">+[ops,result]&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h9-0-9" id="h9-0-9" class="i">+[ops,result]&gt; COMMIT
</a><a href="#h9-0-10" id="h9-0-10" class="i">+---
</a><a href="#h9-0-11" id="h9-0-11" class="i">+v2 read-write active={}
</a><a href="#h9-0-12" id="h9-0-12" class="i">+storage set mvcc:NextVersion → 3 [&quot;\x00&quot; → &quot;\x03&quot;]
</a><a href="#h9-0-13" id="h9-0-13" class="i">+storage set mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h9-0-14" id="h9-0-14" class="i">+Insert { count: 2 }
</a><a href="#h9-0-15" id="h9-0-15" class="i">+storage set mvcc:TxnWrite(2, sql:Row(test, 1)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00&quot; → &quot;&quot;]
</a><a href="#h9-0-16" id="h9-0-16" class="i">+storage set mvcc:Version(sql:Row(test, 1), 2) → 1,&#39;a&#39; [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x06\x02\x02\x02\x04\x01a&quot;]
</a><a href="#h9-0-17" id="h9-0-17" class="i">+storage set mvcc:TxnWrite(2, sql:Row(test, 2)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00&quot; → &quot;&quot;]
</a><a href="#h9-0-18" id="h9-0-18" class="i">+storage set mvcc:Version(sql:Row(test, 2), 2) → 2,&#39;b&#39; [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x06\x02\x02\x04\x04\x01b&quot;]
</a><a href="#h9-0-19" id="h9-0-19" class="i">+Commit { version: 2 }
</a><a href="#h9-0-20" id="h9-0-20" class="i">+storage delete mvcc:TxnWrite(2, sql:Row(test, 1)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00&quot;]
</a><a href="#h9-0-21" id="h9-0-21" class="i">+storage delete mvcc:TxnWrite(2, sql:Row(test, 2)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00&quot;]
</a><a href="#h9-0-22" id="h9-0-22" class="i">+storage delete mvcc:TxnActive(2) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a><a href="#h9-0-23" id="h9-0-23" class="i">+
</a><a href="#h9-0-24" id="h9-0-24" class="i">+# A later transaction can see its writes.
</a><a href="#h9-0-25" id="h9-0-25" class="i">+c1:&gt; SELECT * FROM test
</a><a href="#h9-0-26" id="h9-0-26" class="i">+---
</a><a href="#h9-0-27" id="h9-0-27" class="i">+c1: 1, &#39;a&#39;
</a><a href="#h9-0-28" id="h9-0-28" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h9-0-29" id="h9-0-29" class="i">+
</a><a href="#h9-0-30" id="h9-0-30" class="i">+# If there are concurrent transactions, it does not remove the TxnActiveSnapshot.
</a><a href="#h9-0-31" id="h9-0-31" class="i">+c1:&gt; BEGIN
</a><a href="#h9-0-32" id="h9-0-32" class="i">+---
</a><a href="#h9-0-33" id="h9-0-33" class="i">+ok
</a><a href="#h9-0-34" id="h9-0-34" class="i">+
</a><a href="#h9-0-35" id="h9-0-35" class="i">+c2:[ops,result]&gt; BEGIN
</a><a href="#h9-0-36" id="h9-0-36" class="i">+c2:[ops,result]&gt; COMMIT
</a><a href="#h9-0-37" id="h9-0-37" class="i">+---
</a><a href="#h9-0-38" id="h9-0-38" class="i">+c2: v4 read-write active={3}
</a><a href="#h9-0-39" id="h9-0-39" class="i">+c2: storage set mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h9-0-40" id="h9-0-40" class="i">+c2: storage set mvcc:TxnActiveSnapshot(4) → {3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x03&quot;]
</a><a href="#h9-0-41" id="h9-0-41" class="i">+c2: storage set mvcc:TxnActive(4) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;&quot;]
</a><a href="#h9-0-42" id="h9-0-42" class="i">+c2: Commit { version: 4 }
</a><a href="#h9-0-43" id="h9-0-43" class="i">+c2: storage delete mvcc:TxnActive(4) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot;]
</a><a href="#h9-0-44" id="h9-0-44" class="i">+
</a><a href="#h9-0-45" id="h9-0-45" class="i">+# Commit errors when there&#39;s no open transaction.
</a><a href="#h9-0-46" id="h9-0-46" class="i">+!&gt; COMMIT
</a><a href="#h9-0-47" id="h9-0-47" class="i">+---
</a><a href="#h9-0-48" id="h9-0-48" class="i">+Error: invalid input: not in a transaction
</a><b>diff --git a/<a id="h10" href="../file/src/sql/testscripts/transactions/isolation.html">src/sql/testscripts/transactions/isolation</a> b/<a href="../file/src/sql/testscripts/transactions/isolation.html">src/sql/testscripts/transactions/isolation</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,94 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+# Tests transaction isolation.
</a><a href="#h10-0-1" id="h10-0-1" class="i">+#
</a><a href="#h10-0-2" id="h10-0-2" class="i">+# Transactions are tested more thoroughly in the MVCC tests, this just does some
</a><a href="#h10-0-3" id="h10-0-3" class="i">+# basic SQL-level testing.
</a><a href="#h10-0-4" id="h10-0-4" class="i">+#
</a><a href="#h10-0-5" id="h10-0-5" class="i">+# Sets up a sequence of transactions that each perform a write, and checks
</a><a href="#h10-0-6" id="h10-0-6" class="i">+# what they can see.
</a><a href="#h10-0-7" id="h10-0-7" class="i">+#
</a><a href="#h10-0-8" id="h10-0-8" class="i">+# c1: past, committed before c4 began
</a><a href="#h10-0-9" id="h10-0-9" class="i">+# c2: past, commits after c4 began
</a><a href="#h10-0-10" id="h10-0-10" class="i">+# c3: past, uncommitted
</a><a href="#h10-0-11" id="h10-0-11" class="i">+# c4: test transaction
</a><a href="#h10-0-12" id="h10-0-12" class="i">+# c5: future, committed
</a><a href="#h10-0-13" id="h10-0-13" class="i">+# c6: future, uncommitted
</a><a href="#h10-0-14" id="h10-0-14" class="i">+# c7: future, AS OF version 4
</a><a href="#h10-0-15" id="h10-0-15" class="i">+
</a><a href="#h10-0-16" id="h10-0-16" class="i">+# c1: past, committed before c4 began
</a><a href="#h10-0-17" id="h10-0-17" class="i">+c1:&gt; BEGIN
</a><a href="#h10-0-18" id="h10-0-18" class="i">+c1:&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h10-0-19" id="h10-0-19" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h10-0-20" id="h10-0-20" class="i">+c1:&gt; COMMIT
</a><a href="#h10-0-21" id="h10-0-21" class="i">+---
</a><a href="#h10-0-22" id="h10-0-22" class="i">+ok
</a><a href="#h10-0-23" id="h10-0-23" class="i">+
</a><a href="#h10-0-24" id="h10-0-24" class="i">+# c2: past, commits after c4 began
</a><a href="#h10-0-25" id="h10-0-25" class="i">+c2:&gt; BEGIN
</a><a href="#h10-0-26" id="h10-0-26" class="i">+c2:&gt; INSERT INTO test VALUES (2, &#39;b&#39;)
</a><a href="#h10-0-27" id="h10-0-27" class="i">+---
</a><a href="#h10-0-28" id="h10-0-28" class="i">+ok
</a><a href="#h10-0-29" id="h10-0-29" class="i">+
</a><a href="#h10-0-30" id="h10-0-30" class="i">+# c3: past, uncommitted
</a><a href="#h10-0-31" id="h10-0-31" class="i">+c3:&gt; BEGIN
</a><a href="#h10-0-32" id="h10-0-32" class="i">+c3:&gt; INSERT INTO test VALUES (3, &#39;c&#39;)
</a><a href="#h10-0-33" id="h10-0-33" class="i">+---
</a><a href="#h10-0-34" id="h10-0-34" class="i">+ok
</a><a href="#h10-0-35" id="h10-0-35" class="i">+
</a><a href="#h10-0-36" id="h10-0-36" class="i">+# c4: test transaction
</a><a href="#h10-0-37" id="h10-0-37" class="i">+c4:[result]&gt; BEGIN
</a><a href="#h10-0-38" id="h10-0-38" class="i">+c4:&gt; INSERT INTO test VALUES (4, &#39;d&#39;)
</a><a href="#h10-0-39" id="h10-0-39" class="i">+---
</a><a href="#h10-0-40" id="h10-0-40" class="i">+c4: v4 read-write active={2,3}
</a><a href="#h10-0-41" id="h10-0-41" class="i">+
</a><a href="#h10-0-42" id="h10-0-42" class="i">+# Commit c2.
</a><a href="#h10-0-43" id="h10-0-43" class="i">+c2:&gt; COMMIT
</a><a href="#h10-0-44" id="h10-0-44" class="i">+---
</a><a href="#h10-0-45" id="h10-0-45" class="i">+ok
</a><a href="#h10-0-46" id="h10-0-46" class="i">+
</a><a href="#h10-0-47" id="h10-0-47" class="i">+# c5: future, committed
</a><a href="#h10-0-48" id="h10-0-48" class="i">+c5:&gt; BEGIN
</a><a href="#h10-0-49" id="h10-0-49" class="i">+c5:&gt; INSERT INTO test VALUES (5, &#39;e&#39;)
</a><a href="#h10-0-50" id="h10-0-50" class="i">+c5:&gt; COMMIT
</a><a href="#h10-0-51" id="h10-0-51" class="i">+---
</a><a href="#h10-0-52" id="h10-0-52" class="i">+ok
</a><a href="#h10-0-53" id="h10-0-53" class="i">+
</a><a href="#h10-0-54" id="h10-0-54" class="i">+# c6: future, uncommitted
</a><a href="#h10-0-55" id="h10-0-55" class="i">+c6:&gt; BEGIN
</a><a href="#h10-0-56" id="h10-0-56" class="i">+c6:&gt; INSERT INTO test VALUES (6, &#39;f&#39;)
</a><a href="#h10-0-57" id="h10-0-57" class="i">+---
</a><a href="#h10-0-58" id="h10-0-58" class="i">+ok
</a><a href="#h10-0-59" id="h10-0-59" class="i">+
</a><a href="#h10-0-60" id="h10-0-60" class="i">+# When c4 scans, it should only see the write of c1 and itself.
</a><a href="#h10-0-61" id="h10-0-61" class="i">+c4:&gt; SELECT * FROM test
</a><a href="#h10-0-62" id="h10-0-62" class="i">+---
</a><a href="#h10-0-63" id="h10-0-63" class="i">+c4: 1, &#39;a&#39;
</a><a href="#h10-0-64" id="h10-0-64" class="i">+c4: 4, &#39;d&#39;
</a><a href="#h10-0-65" id="h10-0-65" class="i">+
</a><a href="#h10-0-66" id="h10-0-66" class="i">+# An AS OF transaction in version 4 should not see c4&#39;s uncomitted write.
</a><a href="#h10-0-67" id="h10-0-67" class="i">+c7:&gt; BEGIN READ ONLY AS OF SYSTEM TIME 4
</a><a href="#h10-0-68" id="h10-0-68" class="i">+c7:&gt; SELECT * FROM test
</a><a href="#h10-0-69" id="h10-0-69" class="i">+c7:&gt; ROLLBACK
</a><a href="#h10-0-70" id="h10-0-70" class="i">+---
</a><a href="#h10-0-71" id="h10-0-71" class="i">+c7: 1, &#39;a&#39;
</a><a href="#h10-0-72" id="h10-0-72" class="i">+
</a><a href="#h10-0-73" id="h10-0-73" class="i">+# c4 can commit.
</a><a href="#h10-0-74" id="h10-0-74" class="i">+c4:&gt; COMMIT
</a><a href="#h10-0-75" id="h10-0-75" class="i">+---
</a><a href="#h10-0-76" id="h10-0-76" class="i">+ok
</a><a href="#h10-0-77" id="h10-0-77" class="i">+
</a><a href="#h10-0-78" id="h10-0-78" class="i">+# An implicit transaction should see c1, c2, c4, c5:
</a><a href="#h10-0-79" id="h10-0-79" class="i">+&gt; SELECT * FROM test
</a><a href="#h10-0-80" id="h10-0-80" class="i">+---
</a><a href="#h10-0-81" id="h10-0-81" class="i">+1, &#39;a&#39;
</a><a href="#h10-0-82" id="h10-0-82" class="i">+2, &#39;b&#39;
</a><a href="#h10-0-83" id="h10-0-83" class="i">+4, &#39;d&#39;
</a><a href="#h10-0-84" id="h10-0-84" class="i">+5, &#39;e&#39;
</a><a href="#h10-0-85" id="h10-0-85" class="i">+
</a><a href="#h10-0-86" id="h10-0-86" class="i">+# An AS OF transaction in version 4 should not see c4&#39;s write even after it
</a><a href="#h10-0-87" id="h10-0-87" class="i">+# has committed, such that it&#39;s consistent with the previous AS OF 4. The
</a><a href="#h10-0-88" id="h10-0-88" class="i">+# snapshot is taken out at the start of the version.
</a><a href="#h10-0-89" id="h10-0-89" class="i">+c7:&gt; BEGIN READ ONLY AS OF SYSTEM TIME 4
</a><a href="#h10-0-90" id="h10-0-90" class="i">+c7:&gt; SELECT * FROM test
</a><a href="#h10-0-91" id="h10-0-91" class="i">+c7:&gt; ROLLBACK
</a><a href="#h10-0-92" id="h10-0-92" class="i">+---
</a><a href="#h10-0-93" id="h10-0-93" class="i">+c7: 1, &#39;a&#39;
</a><b>diff --git a/<a id="h11" href="../file/src/sql/testscripts/transactions/rollback.html">src/sql/testscripts/transactions/rollback</a> b/<a href="../file/src/sql/testscripts/transactions/rollback.html">src/sql/testscripts/transactions/rollback</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,51 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+# Tests ROLLBACK.
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h11-0-3" id="h11-0-3" class="i">+---
</a><a href="#h11-0-4" id="h11-0-4" class="i">+ok
</a><a href="#h11-0-5" id="h11-0-5" class="i">+
</a><a href="#h11-0-6" id="h11-0-6" class="i">+# A rollback removes the row, TxnActive record and its TxnWrite records.
</a><a href="#h11-0-7" id="h11-0-7" class="i">+[ops,result]&gt; BEGIN
</a><a href="#h11-0-8" id="h11-0-8" class="i">+[ops,result]&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h11-0-9" id="h11-0-9" class="i">+[ops,result]&gt; ROLLBACK
</a><a href="#h11-0-10" id="h11-0-10" class="i">+---
</a><a href="#h11-0-11" id="h11-0-11" class="i">+v2 read-write active={}
</a><a href="#h11-0-12" id="h11-0-12" class="i">+storage set mvcc:NextVersion → 3 [&quot;\x00&quot; → &quot;\x03&quot;]
</a><a href="#h11-0-13" id="h11-0-13" class="i">+storage set mvcc:TxnActive(2) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;&quot;]
</a><a href="#h11-0-14" id="h11-0-14" class="i">+Insert { count: 2 }
</a><a href="#h11-0-15" id="h11-0-15" class="i">+storage set mvcc:TxnWrite(2, sql:Row(test, 1)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00&quot; → &quot;&quot;]
</a><a href="#h11-0-16" id="h11-0-16" class="i">+storage set mvcc:Version(sql:Row(test, 1), 2) → 1,&#39;a&#39; [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x06\x02\x02\x02\x04\x01a&quot;]
</a><a href="#h11-0-17" id="h11-0-17" class="i">+storage set mvcc:TxnWrite(2, sql:Row(test, 2)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00&quot; → &quot;&quot;]
</a><a href="#h11-0-18" id="h11-0-18" class="i">+storage set mvcc:Version(sql:Row(test, 2), 2) → 2,&#39;b&#39; [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x06\x02\x02\x04\x04\x01b&quot;]
</a><a href="#h11-0-19" id="h11-0-19" class="i">+Rollback { version: 2 }
</a><a href="#h11-0-20" id="h11-0-20" class="i">+storage delete mvcc:Version(sql:Row(test, 1), 2) [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a><a href="#h11-0-21" id="h11-0-21" class="i">+storage delete mvcc:TxnWrite(2, sql:Row(test, 1)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x01\x00\x00&quot;]
</a><a href="#h11-0-22" id="h11-0-22" class="i">+storage delete mvcc:Version(sql:Row(test, 2), 2) [&quot;\x04\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a><a href="#h11-0-23" id="h11-0-23" class="i">+storage delete mvcc:TxnWrite(2, sql:Row(test, 2)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x02test\x00\xff\x00\xff\x02\x80\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x00\xff\x02\x00\x00&quot;]
</a><a href="#h11-0-24" id="h11-0-24" class="i">+storage delete mvcc:TxnActive(2) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a><a href="#h11-0-25" id="h11-0-25" class="i">+
</a><a href="#h11-0-26" id="h11-0-26" class="i">+# A later transaction can&#39;t see its writes.
</a><a href="#h11-0-27" id="h11-0-27" class="i">+c1:&gt; SELECT * FROM test
</a><a href="#h11-0-28" id="h11-0-28" class="i">+---
</a><a href="#h11-0-29" id="h11-0-29" class="i">+ok
</a><a href="#h11-0-30" id="h11-0-30" class="i">+
</a><a href="#h11-0-31" id="h11-0-31" class="i">+# If there are concurrent transactions, it does not remove the
</a><a href="#h11-0-32" id="h11-0-32" class="i">+# TxnActiveSnapshot. This is needed for consistent AS OF queries.
</a><a href="#h11-0-33" id="h11-0-33" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-34" id="h11-0-34" class="i">+---
</a><a href="#h11-0-35" id="h11-0-35" class="i">+ok
</a><a href="#h11-0-36" id="h11-0-36" class="i">+
</a><a href="#h11-0-37" id="h11-0-37" class="i">+c2:[ops,result]&gt; BEGIN
</a><a href="#h11-0-38" id="h11-0-38" class="i">+c2:[ops,result]&gt; ROLLBACK
</a><a href="#h11-0-39" id="h11-0-39" class="i">+---
</a><a href="#h11-0-40" id="h11-0-40" class="i">+c2: v4 read-write active={3}
</a><a href="#h11-0-41" id="h11-0-41" class="i">+c2: storage set mvcc:NextVersion → 5 [&quot;\x00&quot; → &quot;\x05&quot;]
</a><a href="#h11-0-42" id="h11-0-42" class="i">+c2: storage set mvcc:TxnActiveSnapshot(4) → {3} [&quot;\x02\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;\x01\x03&quot;]
</a><a href="#h11-0-43" id="h11-0-43" class="i">+c2: storage set mvcc:TxnActive(4) → &quot;&quot; [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot; → &quot;&quot;]
</a><a href="#h11-0-44" id="h11-0-44" class="i">+c2: Rollback { version: 4 }
</a><a href="#h11-0-45" id="h11-0-45" class="i">+c2: storage delete mvcc:TxnActive(4) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x04&quot;]
</a><a href="#h11-0-46" id="h11-0-46" class="i">+
</a><a href="#h11-0-47" id="h11-0-47" class="i">+# Rollback errors when there&#39;s no open transaction.
</a><a href="#h11-0-48" id="h11-0-48" class="i">+!&gt; ROLLBACK
</a><a href="#h11-0-49" id="h11-0-49" class="i">+---
</a><a href="#h11-0-50" id="h11-0-50" class="i">+Error: invalid input: not in a transaction
</a><b>diff --git a/<a id="h12" href="../file/src/sql/testscripts/transactions/schema.html">src/sql/testscripts/transactions/schema</a> b/<a href="../file/src/sql/testscripts/transactions/schema.html">src/sql/testscripts/transactions/schema</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,46 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+# Tests that schema changes are transactional.
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+c1:&gt; BEGIN
</a><a href="#h12-0-3" id="h12-0-3" class="i">+c1:[ops]&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h12-0-4" id="h12-0-4" class="i">+c1:&gt; SELECT * FROM test
</a><a href="#h12-0-5" id="h12-0-5" class="i">+---
</a><a href="#h12-0-6" id="h12-0-6" class="i">+c1: storage set mvcc:TxnWrite(1, sql:Table(test)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01\x00\xfftest\x00\xff\x00\xff\x00\x00&quot; → &quot;&quot;]
</a><a href="#h12-0-7" id="h12-0-7" class="i">+c1: storage set mvcc:Version(sql:Table(test), 1) → CREATE TABLE test ( id INTEGER PRIMARY KEY, value STRING DEFAULT NULL ) [&quot;\x04\x00\xfftest\x00\xff\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot; → &quot;\x01\x1d\x04test\x00\x02\x02id\x01\x00\x00\x01\x00\x00\x05value\x03\x01\x01\x00\x00\x00\x00&quot;]
</a><a href="#h12-0-8" id="h12-0-8" class="i">+
</a><a href="#h12-0-9" id="h12-0-9" class="i">+# A concurrent transaction can&#39;t see the uncommitted table.
</a><a href="#h12-0-10" id="h12-0-10" class="i">+c2:!&gt; SELECT * FROM test
</a><a href="#h12-0-11" id="h12-0-11" class="i">+---
</a><a href="#h12-0-12" id="h12-0-12" class="i">+c2: Error: invalid input: table test does not exist
</a><a href="#h12-0-13" id="h12-0-13" class="i">+
</a><a href="#h12-0-14" id="h12-0-14" class="i">+# Rolling back the transaction removes the table.
</a><a href="#h12-0-15" id="h12-0-15" class="i">+c1:[ops]&gt; ROLLBACK
</a><a href="#h12-0-16" id="h12-0-16" class="i">+---
</a><a href="#h12-0-17" id="h12-0-17" class="i">+c1: storage delete mvcc:Version(sql:Table(test), 1) [&quot;\x04\x00\xfftest\x00\xff\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01&quot;]
</a><a href="#h12-0-18" id="h12-0-18" class="i">+c1: storage delete mvcc:TxnWrite(1, sql:Table(test)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x01\x00\xfftest\x00\xff\x00\xff\x00\x00&quot;]
</a><a href="#h12-0-19" id="h12-0-19" class="i">+c1: storage delete mvcc:TxnActive(1) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x01&quot;]
</a><a href="#h12-0-20" id="h12-0-20" class="i">+
</a><a href="#h12-0-21" id="h12-0-21" class="i">+c1:!&gt; SELECT * FROM test
</a><a href="#h12-0-22" id="h12-0-22" class="i">+c2:!&gt; SELECT * FROM test
</a><a href="#h12-0-23" id="h12-0-23" class="i">+---
</a><a href="#h12-0-24" id="h12-0-24" class="i">+c1: Error: invalid input: table test does not exist
</a><a href="#h12-0-25" id="h12-0-25" class="i">+c2: Error: invalid input: table test does not exist
</a><a href="#h12-0-26" id="h12-0-26" class="i">+
</a><a href="#h12-0-27" id="h12-0-27" class="i">+# Committing a transaction does reveal the table.
</a><a href="#h12-0-28" id="h12-0-28" class="i">+c1:&gt; BEGIN
</a><a href="#h12-0-29" id="h12-0-29" class="i">+c1:[ops]&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h12-0-30" id="h12-0-30" class="i">+---
</a><a href="#h12-0-31" id="h12-0-31" class="i">+c1: storage set mvcc:TxnWrite(2, sql:Table(test)) → &quot;&quot; [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\xfftest\x00\xff\x00\xff\x00\x00&quot; → &quot;&quot;]
</a><a href="#h12-0-32" id="h12-0-32" class="i">+c1: storage set mvcc:Version(sql:Table(test), 2) → CREATE TABLE test ( id INTEGER PRIMARY KEY, value STRING DEFAULT NULL ) [&quot;\x04\x00\xfftest\x00\xff\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02&quot; → &quot;\x01\x1d\x04test\x00\x02\x02id\x01\x00\x00\x01\x00\x00\x05value\x03\x01\x01\x00\x00\x00\x00&quot;]
</a><a href="#h12-0-33" id="h12-0-33" class="i">+
</a><a href="#h12-0-34" id="h12-0-34" class="i">+c2:!&gt; SELECT * FROM test
</a><a href="#h12-0-35" id="h12-0-35" class="i">+---
</a><a href="#h12-0-36" id="h12-0-36" class="i">+c2: Error: invalid input: table test does not exist
</a><a href="#h12-0-37" id="h12-0-37" class="i">+
</a><a href="#h12-0-38" id="h12-0-38" class="i">+c1:[ops]&gt; COMMIT
</a><a href="#h12-0-39" id="h12-0-39" class="i">+---
</a><a href="#h12-0-40" id="h12-0-40" class="i">+c1: storage delete mvcc:TxnWrite(2, sql:Table(test)) [&quot;\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\xfftest\x00\xff\x00\xff\x00\x00&quot;]
</a><a href="#h12-0-41" id="h12-0-41" class="i">+c1: storage delete mvcc:TxnActive(2) [&quot;\x01\x00\x00\x00\x00\x00\x00\x00\x02&quot;]
</a><a href="#h12-0-42" id="h12-0-42" class="i">+
</a><a href="#h12-0-43" id="h12-0-43" class="i">+c2:&gt; SELECT * FROM test
</a><a href="#h12-0-44" id="h12-0-44" class="i">+---
</a><a href="#h12-0-45" id="h12-0-45" class="i">+ok
</a><b>diff --git a/<a id="h13" href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_dirty_read.html">src/storage/testscripts/mvcc/anomaly_dirty_read</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-# A dirty read is when t2 can read an uncommitted value set by t1.Snapshot
</a><a href="#h13-0-1" id="h13-0-1" class="i">+# A dirty read is when t2 can read an uncommitted value set by t1. Snapshot
</a> # isolation prevents this.
 
 t1: begin
<b>diff --git a/<a id="h14" href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a> b/<a href="../file/src/storage/testscripts/mvcc/anomaly_write_skew.html">src/storage/testscripts/mvcc/anomaly_write_skew</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,7 +1,7 @@
</a> # Write skew is when t1 reads a and writes it to b while t2 reads b and writes
<a href="#h14-0-1" id="h14-0-1" class="d">-# it to a. Snapshot isolation does prevent this, which is expected, so we assert
</a><a href="#h14-0-2" id="h14-0-2" class="d">-# the anomalous behavior. Fixing this would require implementing serializable
</a><a href="#h14-0-3" id="h14-0-3" class="d">-# snapshot isolation.
</a><a href="#h14-0-4" id="h14-0-4" class="i">+# it to a. Snapshot isolation does not prevent this, which is expected, so we
</a><a href="#h14-0-5" id="h14-0-5" class="i">+# assert the anomalous behavior. Fixing this would require implementing
</a><a href="#h14-0-6" id="h14-0-6" class="i">+# serializable snapshot isolation.
</a> 
 # Write some initial data.
 import a=1 b=2
</pre>
</div>
</body>
</html>
