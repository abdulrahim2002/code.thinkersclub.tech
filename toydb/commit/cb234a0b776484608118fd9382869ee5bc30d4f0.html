<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: clean up node module - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/cb234a0b776484608118fd9382869ee5bc30d4f0.html">cb234a0b776484608118fd9382869ee5bc30d4f0</a>
<b>parent</b> <a href="../commit/2cfaa8d925da939b68fda11a19fc8e7fd3c7c516.html">2cfaa8d925da939b68fda11a19fc8e7fd3c7c516</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat,  8 Jun 2024 12:45:03 +0200

raft: clean up node module

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toysql.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/log.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/message.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node.rs</a></td><td> | </td><td class="num">1328</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/state.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/testscripts/log/get</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/testscripts/node/append</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/raft/testscripts/node/append_base_missing</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/raft/testscripts/node/append_base_missing_all</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/raft/testscripts/node/append_commit_quorum</a></td><td> | </td><td class="num">84</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">src/raft/testscripts/node/append_initial</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/raft/testscripts/node/append_max_entries</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/raft/testscripts/node/append_pipeline</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/raft/testscripts/node/append_probe_divergent_first</a></td><td> | </td><td class="num">88</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/raft/testscripts/node/append_probe_divergent_long</a></td><td> | </td><td class="num">98</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/raft/testscripts/node/append_probe_divergent_short</a></td><td> | </td><td class="num">88</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/raft/testscripts/node/append_probe_divergent_single</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/raft/testscripts/node/append_response_beyond_last_index_panics</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/raft/testscripts/node/append_response_stale_reject</a></td><td> | </td><td class="num">30</td><td><span class="i">+++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">src/raft/testscripts/node/election</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">src/raft/testscripts/node/election_candidate_behind_leader</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">src/raft/testscripts/node/election_candidate_behind_quorum</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/raft/testscripts/node/election_contested</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/raft/testscripts/node/election_tie</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/raft/testscripts/node/election_tie_even</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/raft/testscripts/node/heartbeat_commits_follower</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/raft/testscripts/node/heartbeat_converts_candidate</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/raft/testscripts/node/heartbeat_converts_follower</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">src/raft/testscripts/node/heartbeat_converts_leader</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">src/raft/testscripts/node/heartbeat_lost_append_multiple</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">src/raft/testscripts/node/heartbeat_lost_append_single</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">src/raft/testscripts/node/heartbeat_match_commits</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">src/raft/testscripts/node/heartbeat_old_commit_index</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/raft/testscripts/node/heartbeat_old_last_index</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">src/raft/testscripts/node/heartbeat_probe_divergent</a></td><td> | </td><td class="num">34</td><td><span class="i">+++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">src/raft/testscripts/node/old_campaign_rejected</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">src/raft/testscripts/node/old_campaign_response_ignored</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">src/raft/testscripts/node/old_heartbeat_ignored</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">src/raft/testscripts/node/request_candidate_abort</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">src/raft/testscripts/node/request_follower</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">src/raft/testscripts/node/request_follower_campaign_abort</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">src/raft/testscripts/node/request_follower_disconnect_stall</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">src/raft/testscripts/node/request_follower_leaderless_abort</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">src/raft/testscripts/node/request_leader</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">src/raft/testscripts/node/request_leader_campaign_abort</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">src/raft/testscripts/node/request_leader_change_linearizability</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">src/raft/testscripts/node/request_leader_disconnect</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">src/raft/testscripts/node/request_leader_read_quorum</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">src/raft/testscripts/node/request_leader_read_quorum_sequence</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">src/raft/testscripts/node/request_leader_single</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">src/raft/testscripts/node/request_status</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h54">src/raft/testscripts/node/request_status_single</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h55">src/raft/testscripts/node/tick_candidate</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h56">src/raft/testscripts/node/tick_follower</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h57">src/raft/testscripts/node/tick_follower_leaderless</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h58">src/raft/testscripts/node/tick_leader</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h59">tests/e2e/client.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>60 files changed, 1224 insertions(+), 1275 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -136,7 +136,7 @@ Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk,
</a>                     term = status.raft.term,
                     nodes = status.raft.match_index.len(),
                     committed = status.raft.commit_index,
<a href="#h0-0-3" id="h0-0-3" class="d">-                    applied = status.raft.apply_index,
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                    applied = status.raft.applied_index,
</a>                     raft_storage = status.raft.storage.name,
                     raft_size =
                         format_args!(&quot;{:.3}&quot;, status.raft.storage.size as f64 / 1000.0 / 1000.0),
<b>diff --git a/<a id="h1" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -60,6 +60,9 @@ impl encoding::Key&lt;&#39;_&gt; for KeyPrefix {}
</a> ///   5   |   2  | UPDATE table SET value = &#39;bar&#39; WHERE id = 1
 ///   6   |   2  | DELETE FROM table WHERE id = 1
 ///
<a href="#h1-0-3" id="h1-0-3" class="i">+/// Note that this is for illustration only, and the actual toyDB Raft commands
</a><a href="#h1-0-4" id="h1-0-4" class="i">+/// are not SQL statements but lower-level write operations.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+///
</a> /// A key/value store is used to store the log entries on disk, keyed by index,
 /// along with a few other metadata keys (e.g. who we voted for in this term).
 ///
<b>diff --git a/<a id="h2" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -197,7 +197,7 @@ pub struct Status {
</a>     /// The current commit index.
     pub commit_index: Index,
     /// The current applied index.
<a href="#h2-0-3" id="h2-0-3" class="d">-    pub apply_index: Index,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    pub applied_index: Index,
</a>     /// The log storage engine status.
     pub storage: storage::Status,
 }
<b>diff --git a/<a id="h3" href="../file/src/raft/node.rs.html">src/raft/node.rs</a> b/<a href="../file/src/raft/node.rs.html">src/raft/node.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,24 +1,26 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::{
</a><a href="#h3-0-1" id="h3-0-1" class="d">-    Envelope, Index, Log, Message, ReadSequence, Request, RequestID, Response, State, Status,
</a><a href="#h3-0-2" id="h3-0-2" class="d">-};
</a><a href="#h3-0-3" id="h3-0-3" class="i">+use super::log::{Index, Log};
</a><a href="#h3-0-4" id="h3-0-4" class="i">+use super::message::{Envelope, Message, ReadSequence, Request, RequestID, Response, Status};
</a><a href="#h3-0-5" id="h3-0-5" class="i">+use super::state::State;
</a> use crate::errinput;
 use crate::error::{Error, Result};
 
<a href="#h3-0-9" id="h3-0-9" class="i">+use crossbeam::channel::Sender;
</a> use itertools::Itertools as _;
 use log::{debug, info};
 use rand::Rng as _;
 use std::collections::{HashMap, HashSet, VecDeque};
 
<a href="#h3-0-15" id="h3-0-15" class="d">-/// A node ID.
</a><a href="#h3-0-16" id="h3-0-16" class="i">+/// A node ID. Unique within a cluster. Assigned manually when started.
</a> pub type NodeID = u8;
 
<a href="#h3-0-19" id="h3-0-19" class="d">-/// A leader term.
</a><a href="#h3-0-20" id="h3-0-20" class="i">+/// A leader term number. Increases monotonically.
</a> pub type Term = u64;
 
 /// A logical clock interval as number of ticks.
 pub type Ticks = u8;
 
 /// Raft node options.
<a href="#h3-0-27" id="h3-0-27" class="i">+#[derive(Clone, Debug, PartialEq)]
</a> pub struct Options {
     /// The number of ticks between leader heartbeats.
     pub heartbeat_interval: Ticks,
<a href="#h3-1" id="h3-1" class="h">@@ -39,59 +41,77 @@ impl Default for Options {
</a> }
 
 /// A Raft node, with a dynamic role. The node is driven synchronously by
<a href="#h3-1-3" id="h3-1-3" class="d">-/// processing inbound messages via step() or by advancing time via tick().
</a><a href="#h3-1-4" id="h3-1-4" class="d">-/// These methods consume the current node, and return a new one with a possibly
</a><a href="#h3-1-5" id="h3-1-5" class="d">-/// different role. Outbound messages are sent via the given node_tx channel.
</a><a href="#h3-1-6" id="h3-1-6" class="i">+/// processing inbound messages via `step()` or by advancing time via `tick()`.
</a><a href="#h3-1-7" id="h3-1-7" class="i">+/// These methods consume the node and return a new one with a possibly
</a><a href="#h3-1-8" id="h3-1-8" class="i">+/// different role. Outbound messages are sent via the given `tx` channel, and
</a><a href="#h3-1-9" id="h3-1-9" class="i">+/// must be delivered to the remote peers.
</a> ///
<a href="#h3-1-11" id="h3-1-11" class="d">-/// This enum wraps the RawNode&lt;Role&gt; types, which implement the actual
</a><a href="#h3-1-12" id="h3-1-12" class="d">-/// node logic. It exists for ergonomic use across role transitions, i.e
</a><a href="#h3-1-13" id="h3-1-13" class="d">-/// node = node.step()?.
</a><a href="#h3-1-14" id="h3-1-14" class="i">+/// This enum is the public interface to the node, with a closed set of roles.
</a><a href="#h3-1-15" id="h3-1-15" class="i">+/// It wraps the `RawNode&lt;Role&gt;` types, which implement the actual node logic.
</a><a href="#h3-1-16" id="h3-1-16" class="i">+/// The enum allows ergonomic use across role transitions since it can represent
</a><a href="#h3-1-17" id="h3-1-17" class="i">+/// all roles, e.g.: `node = node.step()?`.
</a> pub enum Node {
<a href="#h3-1-19" id="h3-1-19" class="i">+    /// A candidate campaigns for leadership.
</a>     Candidate(RawNode&lt;Candidate&gt;),
<a href="#h3-1-21" id="h3-1-21" class="i">+    /// A follower replicates entries from a leader.
</a>     Follower(RawNode&lt;Follower&gt;),
<a href="#h3-1-23" id="h3-1-23" class="i">+    /// A leader processes client requests and replicates entries to followers.
</a>     Leader(RawNode&lt;Leader&gt;),
 }
 
<a href="#h3-1-27" id="h3-1-27" class="d">-/// Helper macro which calls a closure on the inner RawNode&lt;R&gt;.
</a><a href="#h3-1-28" id="h3-1-28" class="i">+/// Helper macro which calls a closure on the inner RawNode&lt;Role&gt;.
</a> macro_rules! with_rawnode {
<a href="#h3-1-30" id="h3-1-30" class="d">-    // Borrowed (using ref keyword).
</a><a href="#h3-1-31" id="h3-1-31" class="d">-    (ref $node:expr, $fn:expr) =&gt; {{
</a><a href="#h3-1-32" id="h3-1-32" class="d">-        fn with_rawnode&lt;R: Role, T&gt;(node: &amp;RawNode&lt;R&gt;, f: impl Fn(&amp;RawNode&lt;R&gt;) -&gt; T) -&gt; T {
</a><a href="#h3-1-33" id="h3-1-33" class="i">+    // Node is moved.
</a><a href="#h3-1-34" id="h3-1-34" class="i">+    ($node:expr, $closure:expr) =&gt; {{
</a><a href="#h3-1-35" id="h3-1-35" class="i">+        fn with&lt;R: Role, T&gt;(node: RawNode&lt;R&gt;, f: impl FnOnce(RawNode&lt;R&gt;) -&gt; T) -&gt; T {
</a>             f(node)
         }
         match $node {
<a href="#h3-1-39" id="h3-1-39" class="d">-            Node::Candidate(ref n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-40" id="h3-1-40" class="d">-            Node::Follower(ref n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-41" id="h3-1-41" class="d">-            Node::Leader(ref n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-42" id="h3-1-42" class="i">+            Node::Candidate(node) =&gt; with(node, $closure),
</a><a href="#h3-1-43" id="h3-1-43" class="i">+            Node::Follower(node) =&gt; with(node, $closure),
</a><a href="#h3-1-44" id="h3-1-44" class="i">+            Node::Leader(node) =&gt; with(node, $closure),
</a>         }
     }};
<a href="#h3-1-47" id="h3-1-47" class="d">-    // Owned.
</a><a href="#h3-1-48" id="h3-1-48" class="d">-    ($node:expr, $fn:expr) =&gt; {{
</a><a href="#h3-1-49" id="h3-1-49" class="d">-        fn with_rawnode&lt;R: Role, T&gt;(node: RawNode&lt;R&gt;, f: impl FnOnce(RawNode&lt;R&gt;) -&gt; T) -&gt; T {
</a><a href="#h3-1-50" id="h3-1-50" class="i">+    // Node is borrowed (ref).
</a><a href="#h3-1-51" id="h3-1-51" class="i">+    (ref $node:expr, $closure:expr) =&gt; {{
</a><a href="#h3-1-52" id="h3-1-52" class="i">+        fn with&lt;R: Role, T&gt;(node: &amp;RawNode&lt;R&gt;, f: impl FnOnce(&amp;RawNode&lt;R&gt;) -&gt; T) -&gt; T {
</a>             f(node)
         }
         match $node {
<a href="#h3-1-56" id="h3-1-56" class="d">-            Node::Candidate(n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-57" id="h3-1-57" class="d">-            Node::Follower(n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-58" id="h3-1-58" class="d">-            Node::Leader(n) =&gt; with_rawnode(n, $fn),
</a><a href="#h3-1-59" id="h3-1-59" class="i">+            Node::Candidate(ref node) =&gt; with(node, $closure),
</a><a href="#h3-1-60" id="h3-1-60" class="i">+            Node::Follower(ref node) =&gt; with(node, $closure),
</a><a href="#h3-1-61" id="h3-1-61" class="i">+            Node::Leader(ref node) =&gt; with(node, $closure),
</a><a href="#h3-1-62" id="h3-1-62" class="i">+        }
</a><a href="#h3-1-63" id="h3-1-63" class="i">+    }};
</a><a href="#h3-1-64" id="h3-1-64" class="i">+    // Node is mutably borrowed (ref mut).
</a><a href="#h3-1-65" id="h3-1-65" class="i">+    (ref mut $node:expr, $closure:expr) =&gt; {{
</a><a href="#h3-1-66" id="h3-1-66" class="i">+        fn with&lt;R: Role, T&gt;(node: &amp;mut RawNode&lt;R&gt;, f: impl FnOnce(&amp;mut RawNode&lt;R&gt;) -&gt; T) -&gt; T {
</a><a href="#h3-1-67" id="h3-1-67" class="i">+            f(node)
</a><a href="#h3-1-68" id="h3-1-68" class="i">+        }
</a><a href="#h3-1-69" id="h3-1-69" class="i">+        match $node {
</a><a href="#h3-1-70" id="h3-1-70" class="i">+            Node::Candidate(ref mut node) =&gt; with(node, $closure),
</a><a href="#h3-1-71" id="h3-1-71" class="i">+            Node::Follower(ref mut node) =&gt; with(node, $closure),
</a><a href="#h3-1-72" id="h3-1-72" class="i">+            Node::Leader(ref mut node) =&gt; with(node, $closure),
</a>         }
     }};
 }
 
 impl Node {
<a href="#h3-1-78" id="h3-1-78" class="d">-    /// Creates a new Raft node, starting as a leaderless follower, or leader if
</a><a href="#h3-1-79" id="h3-1-79" class="d">-    /// there are no peers.
</a><a href="#h3-1-80" id="h3-1-80" class="i">+    /// Creates a new Raft node. It starts as a leaderless follower, waiting to
</a><a href="#h3-1-81" id="h3-1-81" class="i">+    /// hear from a leader or otherwise transitioning to candidate and
</a><a href="#h3-1-82" id="h3-1-82" class="i">+    /// campaigning for leadership. In the case of a single-node cluster (no
</a><a href="#h3-1-83" id="h3-1-83" class="i">+    /// peers), the node immediately transitions to leader when created.
</a>     pub fn new(
         id: NodeID,
         peers: HashSet&lt;NodeID&gt;,
         log: Log,
         state: Box&lt;dyn State&gt;,
<a href="#h3-1-89" id="h3-1-89" class="d">-        node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a><a href="#h3-1-90" id="h3-1-90" class="i">+        tx: Sender&lt;Envelope&gt;,
</a>         opts: Options,
     ) -&gt; Result&lt;Self&gt; {
<a href="#h3-1-93" id="h3-1-93" class="d">-        let node = RawNode::new(id, peers, log, state, node_tx, opts)?;
</a><a href="#h3-1-94" id="h3-1-94" class="d">-        if node.peers.is_empty() {
</a><a href="#h3-1-95" id="h3-1-95" class="d">-            // If there are no peers, become leader immediately.
</a><a href="#h3-1-96" id="h3-1-96" class="i">+        let node = RawNode::new(id, peers, log, state, tx, opts)?;
</a><a href="#h3-1-97" id="h3-1-97" class="i">+        // If this is a single-node cluster, become leader immediately.
</a><a href="#h3-1-98" id="h3-1-98" class="i">+        if node.cluster_size() == 1 {
</a>             return Ok(node.into_candidate()?.into_leader()?.into());
         }
         Ok(node.into())
<a href="#h3-2" id="h3-2" class="h">@@ -109,16 +129,15 @@ impl Node {
</a> 
     /// Processes an inbound message.
     pub fn step(self, msg: Envelope) -&gt; Result&lt;Self&gt; {
<a href="#h3-2-3" id="h3-2-3" class="d">-        with_rawnode!(ref self, |n| {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+        with_rawnode!(self, |n| {
</a>             assert_eq!(msg.to, n.id, &quot;message to other node: {msg:?}&quot;);
             assert!(n.peers.contains(&amp;msg.from) || msg.from == n.id, &quot;unknown sender: {msg:?}&quot;);
<a href="#h3-2-7" id="h3-2-7" class="d">-        });
</a><a href="#h3-2-8" id="h3-2-8" class="d">-
</a><a href="#h3-2-9" id="h3-2-9" class="d">-        debug!(&quot;Stepping {msg:?}&quot;);
</a><a href="#h3-2-10" id="h3-2-10" class="d">-        with_rawnode!(self, |n| n.step(msg))
</a><a href="#h3-2-11" id="h3-2-11" class="i">+            debug!(&quot;Stepping {msg:?}&quot;);
</a><a href="#h3-2-12" id="h3-2-12" class="i">+            n.step(msg)
</a><a href="#h3-2-13" id="h3-2-13" class="i">+        })
</a>     }
 
<a href="#h3-2-16" id="h3-2-16" class="d">-    /// Moves time forward by a tick.
</a><a href="#h3-2-17" id="h3-2-17" class="i">+    /// Advances time by a tick.
</a>     pub fn tick(self) -&gt; Result&lt;Self&gt; {
         with_rawnode!(self, |n| n.tick())
     }
<a href="#h3-3" id="h3-3" class="h">@@ -142,20 +161,29 @@ impl From&lt;RawNode&lt;Leader&gt;&gt; for Node {
</a>     }
 }
 
<a href="#h3-3-3" id="h3-3-3" class="d">-/// A Raft role: leader, follower, or candidate.
</a><a href="#h3-3-4" id="h3-3-4" class="i">+/// Marker trait for a Raft role: leader, follower, or candidate.
</a> pub trait Role {}
 
<a href="#h3-3-7" id="h3-3-7" class="d">-/// A Raft node with the concrete role R.
</a><a href="#h3-3-8" id="h3-3-8" class="i">+/// A Raft node with role R.
</a> ///
 /// This implements the typestate pattern, where individual node states (roles)
 /// are encoded as RawNode&lt;Role&gt;. See: http://cliffle.com/blog/rust-typestate/
<a href="#h3-3-12" id="h3-3-12" class="d">-pub struct RawNode&lt;R: Role = Follower&gt; {
</a><a href="#h3-3-13" id="h3-3-13" class="i">+pub struct RawNode&lt;R: Role&gt; {
</a><a href="#h3-3-14" id="h3-3-14" class="i">+    /// The node ID. Must be unique in this cluster.
</a>     id: NodeID,
<a href="#h3-3-16" id="h3-3-16" class="i">+    /// The IDs of the other nodes in the cluster. Does not change while
</a><a href="#h3-3-17" id="h3-3-17" class="i">+    /// running. Can change on restart, but all nodes must have the same node
</a><a href="#h3-3-18" id="h3-3-18" class="i">+    /// set to avoid multiple leaders (i.e. split brain).
</a>     peers: HashSet&lt;NodeID&gt;,
<a href="#h3-3-20" id="h3-3-20" class="i">+    /// The Raft log, containing client commands to be executed.
</a>     log: Log,
<a href="#h3-3-22" id="h3-3-22" class="i">+    /// The Raft state machine, on which client commands are executed.
</a>     state: Box&lt;dyn State&gt;,
<a href="#h3-3-24" id="h3-3-24" class="d">-    node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a><a href="#h3-3-25" id="h3-3-25" class="i">+    /// Channel for sending outbound messages to other nodes.
</a><a href="#h3-3-26" id="h3-3-26" class="i">+    tx: Sender&lt;Envelope&gt;,
</a><a href="#h3-3-27" id="h3-3-27" class="i">+    /// Node options.
</a>     opts: Options,
<a href="#h3-3-29" id="h3-3-29" class="i">+    /// Role-specific state.
</a>     role: R,
 }
 
<a href="#h3-4" id="h3-4" class="h">@@ -167,7 +195,7 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>             peers: self.peers,
             log: self.log,
             state: self.state,
<a href="#h3-4-3" id="h3-4-3" class="d">-            node_tx: self.node_tx,
</a><a href="#h3-4-4" id="h3-4-4" class="i">+            tx: self.tx,
</a>             opts: self.opts,
             role,
         }
<a href="#h3-5" id="h3-5" class="h">@@ -192,179 +220,40 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>     /// order. The slice must have the same size as the cluster.
     fn quorum_value&lt;T: Ord + Copy&gt;(&amp;self, mut values: Vec&lt;T&gt;) -&gt; T {
         assert_eq!(values.len(), self.cluster_size(), &quot;vector size must match cluster size&quot;);
<a href="#h3-5-3" id="h3-5-3" class="d">-        *values.select_nth_unstable_by(self.quorum_size() - 1, |a, b: &amp;T| a.cmp(b).reverse()).1
</a><a href="#h3-5-4" id="h3-5-4" class="i">+        *values.select_nth_unstable_by(self.quorum_size() - 1, |a, b| a.cmp(b).reverse()).1
</a><a href="#h3-5-5" id="h3-5-5" class="i">+    }
</a><a href="#h3-5-6" id="h3-5-6" class="i">+
</a><a href="#h3-5-7" id="h3-5-7" class="i">+    /// Generates a random election timeout.
</a><a href="#h3-5-8" id="h3-5-8" class="i">+    fn random_election_timeout(&amp;self) -&gt; Ticks {
</a><a href="#h3-5-9" id="h3-5-9" class="i">+        rand::thread_rng().gen_range(self.opts.election_timeout_range.clone())
</a>     }
 
<a href="#h3-5-12" id="h3-5-12" class="d">-    /// Sends a message.
</a><a href="#h3-5-13" id="h3-5-13" class="i">+    /// Sends a message to the given recipient.
</a>     fn send(&amp;self, to: NodeID, message: Message) -&gt; Result&lt;()&gt; {
<a href="#h3-5-15" id="h3-5-15" class="d">-        Self::send_with(&amp;self.node_tx, Envelope { from: self.id, to, term: self.term(), message })
</a><a href="#h3-5-16" id="h3-5-16" class="i">+        Self::send_with(&amp;self.tx, Envelope { from: self.id, to, term: self.term(), message })
</a>     }
 
     /// Sends a message without borrowing self, to allow partial borrows.
<a href="#h3-5-20" id="h3-5-20" class="d">-    fn send_with(tx: &amp;crossbeam::channel::Sender&lt;Envelope&gt;, msg: Envelope) -&gt; Result&lt;()&gt; {
</a><a href="#h3-5-21" id="h3-5-21" class="i">+    fn send_with(tx: &amp;Sender&lt;Envelope&gt;, msg: Envelope) -&gt; Result&lt;()&gt; {
</a>         debug!(&quot;Sending {msg:?}&quot;);
         Ok(tx.send(msg)?)
     }
 
     /// Broadcasts a message to all peers.
     fn broadcast(&amp;self, message: Message) -&gt; Result&lt;()&gt; {
<a href="#h3-5-28" id="h3-5-28" class="d">-        // Sort for test determinism.
</a><a href="#h3-5-29" id="h3-5-29" class="i">+        // Send in increasing ID order for test determinism.
</a>         for id in self.peers.iter().copied().sorted() {
             self.send(id, message.clone())?;
         }
         Ok(())
     }
<a href="#h3-5-35" id="h3-5-35" class="d">-
</a><a href="#h3-5-36" id="h3-5-36" class="d">-    /// Generates a randomized election timeout.
</a><a href="#h3-5-37" id="h3-5-37" class="d">-    fn gen_election_timeout(&amp;self) -&gt; Ticks {
</a><a href="#h3-5-38" id="h3-5-38" class="d">-        rand::thread_rng().gen_range(self.opts.election_timeout_range.clone())
</a><a href="#h3-5-39" id="h3-5-39" class="d">-    }
</a><a href="#h3-5-40" id="h3-5-40" class="d">-}
</a><a href="#h3-5-41" id="h3-5-41" class="d">-
</a><a href="#h3-5-42" id="h3-5-42" class="d">-/// A candidate is campaigning to become a leader.
</a><a href="#h3-5-43" id="h3-5-43" class="d">-pub struct Candidate {
</a><a href="#h3-5-44" id="h3-5-44" class="d">-    /// Votes received (including ourself).
</a><a href="#h3-5-45" id="h3-5-45" class="d">-    votes: HashSet&lt;NodeID&gt;,
</a><a href="#h3-5-46" id="h3-5-46" class="d">-    /// Ticks elapsed since election start.
</a><a href="#h3-5-47" id="h3-5-47" class="d">-    election_duration: Ticks,
</a><a href="#h3-5-48" id="h3-5-48" class="d">-    /// Election timeout, in ticks.
</a><a href="#h3-5-49" id="h3-5-49" class="d">-    election_timeout: Ticks,
</a><a href="#h3-5-50" id="h3-5-50" class="d">-}
</a><a href="#h3-5-51" id="h3-5-51" class="d">-
</a><a href="#h3-5-52" id="h3-5-52" class="d">-impl Candidate {
</a><a href="#h3-5-53" id="h3-5-53" class="d">-    /// Creates a new candidate role.
</a><a href="#h3-5-54" id="h3-5-54" class="d">-    fn new(election_timeout: Ticks) -&gt; Self {
</a><a href="#h3-5-55" id="h3-5-55" class="d">-        Self { votes: HashSet::new(), election_duration: 0, election_timeout }
</a><a href="#h3-5-56" id="h3-5-56" class="d">-    }
</a> }
 
<a href="#h3-5-59" id="h3-5-59" class="d">-impl Role for Candidate {}
</a><a href="#h3-5-60" id="h3-5-60" class="d">-
</a><a href="#h3-5-61" id="h3-5-61" class="d">-impl RawNode&lt;Candidate&gt; {
</a><a href="#h3-5-62" id="h3-5-62" class="d">-    /// Transitions the candidate to a follower. We either lost the election and
</a><a href="#h3-5-63" id="h3-5-63" class="d">-    /// follow the winner, or we discovered a new term in which case we step
</a><a href="#h3-5-64" id="h3-5-64" class="d">-    /// into it as a leaderless follower.
</a><a href="#h3-5-65" id="h3-5-65" class="d">-    fn into_follower(mut self, term: Term, leader: Option&lt;NodeID&gt;) -&gt; Result&lt;RawNode&lt;Follower&gt;&gt; {
</a><a href="#h3-5-66" id="h3-5-66" class="d">-        let election_timeout = self.gen_election_timeout();
</a><a href="#h3-5-67" id="h3-5-67" class="d">-        if let Some(leader) = leader {
</a><a href="#h3-5-68" id="h3-5-68" class="d">-            // We lost the election, follow the winner.
</a><a href="#h3-5-69" id="h3-5-69" class="d">-            assert_eq!(term, self.term(), &quot;can&#39;t follow leader in different term&quot;);
</a><a href="#h3-5-70" id="h3-5-70" class="d">-            info!(&quot;Lost election, following leader {leader} in term {term}&quot;);
</a><a href="#h3-5-71" id="h3-5-71" class="d">-            Ok(self.into_role(Follower::new(Some(leader), election_timeout)))
</a><a href="#h3-5-72" id="h3-5-72" class="d">-        } else {
</a><a href="#h3-5-73" id="h3-5-73" class="d">-            // We found a new term, but we don&#39;t necessarily know who the leader
</a><a href="#h3-5-74" id="h3-5-74" class="d">-            // is yet. We&#39;ll find out when we step a message from it.
</a><a href="#h3-5-75" id="h3-5-75" class="d">-            assert_ne!(term, self.term(), &quot;can&#39;t become leaderless follower in current term&quot;);
</a><a href="#h3-5-76" id="h3-5-76" class="d">-            info!(&quot;Discovered new term {term}&quot;);
</a><a href="#h3-5-77" id="h3-5-77" class="d">-            self.log.set_term(term, None)?;
</a><a href="#h3-5-78" id="h3-5-78" class="d">-            Ok(self.into_role(Follower::new(None, election_timeout)))
</a><a href="#h3-5-79" id="h3-5-79" class="d">-        }
</a><a href="#h3-5-80" id="h3-5-80" class="d">-    }
</a><a href="#h3-5-81" id="h3-5-81" class="d">-
</a><a href="#h3-5-82" id="h3-5-82" class="d">-    /// Transitions the candidate to a leader. We won the election.
</a><a href="#h3-5-83" id="h3-5-83" class="d">-    fn into_leader(self) -&gt; Result&lt;RawNode&lt;Leader&gt;&gt; {
</a><a href="#h3-5-84" id="h3-5-84" class="d">-        let (term, vote) = self.log.get_term();
</a><a href="#h3-5-85" id="h3-5-85" class="d">-        assert_ne!(term, 0, &quot;leaders can&#39;t have term 0&quot;);
</a><a href="#h3-5-86" id="h3-5-86" class="d">-        assert_eq!(vote, Some(self.id), &quot;leader did not vote for self&quot;);
</a><a href="#h3-5-87" id="h3-5-87" class="d">-
</a><a href="#h3-5-88" id="h3-5-88" class="d">-        info!(&quot;Won election for term {term}, becoming leader&quot;);
</a><a href="#h3-5-89" id="h3-5-89" class="d">-        let peers = self.peers.clone();
</a><a href="#h3-5-90" id="h3-5-90" class="d">-        let (last_index, _) = self.log.get_last_index();
</a><a href="#h3-5-91" id="h3-5-91" class="d">-        let mut node = self.into_role(Leader::new(peers, last_index));
</a><a href="#h3-5-92" id="h3-5-92" class="d">-
</a><a href="#h3-5-93" id="h3-5-93" class="d">-        // Propose an empty command when assuming leadership, to disambiguate
</a><a href="#h3-5-94" id="h3-5-94" class="d">-        // previous entries in the log. See section 8 in the Raft paper.
</a><a href="#h3-5-95" id="h3-5-95" class="d">-        //
</a><a href="#h3-5-96" id="h3-5-96" class="d">-        // We do this prior to the heartbeat, to avoid a wasted replication
</a><a href="#h3-5-97" id="h3-5-97" class="d">-        // roundtrip if the heartbeat response indicates the peer is behind.
</a><a href="#h3-5-98" id="h3-5-98" class="d">-        node.propose(None)?;
</a><a href="#h3-5-99" id="h3-5-99" class="d">-        node.maybe_commit_and_apply()?;
</a><a href="#h3-5-100" id="h3-5-100" class="d">-        node.heartbeat()?;
</a><a href="#h3-5-101" id="h3-5-101" class="d">-
</a><a href="#h3-5-102" id="h3-5-102" class="d">-        Ok(node)
</a><a href="#h3-5-103" id="h3-5-103" class="d">-    }
</a><a href="#h3-5-104" id="h3-5-104" class="d">-
</a><a href="#h3-5-105" id="h3-5-105" class="d">-    /// Processes a message.
</a><a href="#h3-5-106" id="h3-5-106" class="d">-    fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
</a><a href="#h3-5-107" id="h3-5-107" class="d">-        // Drop messages from past terms.
</a><a href="#h3-5-108" id="h3-5-108" class="d">-        if msg.term &lt; self.term() {
</a><a href="#h3-5-109" id="h3-5-109" class="d">-            debug!(&quot;Dropping message from past term ({:?})&quot;, msg);
</a><a href="#h3-5-110" id="h3-5-110" class="d">-            return Ok(self.into());
</a><a href="#h3-5-111" id="h3-5-111" class="d">-        }
</a><a href="#h3-5-112" id="h3-5-112" class="d">-
</a><a href="#h3-5-113" id="h3-5-113" class="d">-        // If we receive a message for a future term, become a leaderless
</a><a href="#h3-5-114" id="h3-5-114" class="d">-        // follower in it and step the message. If the message is a Heartbeat or
</a><a href="#h3-5-115" id="h3-5-115" class="d">-        // Append from the leader, stepping it will follow the leader.
</a><a href="#h3-5-116" id="h3-5-116" class="d">-        if msg.term &gt; self.term() {
</a><a href="#h3-5-117" id="h3-5-117" class="d">-            return self.into_follower(msg.term, None)?.step(msg);
</a><a href="#h3-5-118" id="h3-5-118" class="d">-        }
</a><a href="#h3-5-119" id="h3-5-119" class="d">-
</a><a href="#h3-5-120" id="h3-5-120" class="d">-        match msg.message {
</a><a href="#h3-5-121" id="h3-5-121" class="d">-            // Don&#39;t grant votes for other candidates who also campaign.
</a><a href="#h3-5-122" id="h3-5-122" class="d">-            Message::Campaign { .. } =&gt; {
</a><a href="#h3-5-123" id="h3-5-123" class="d">-                self.send(msg.from, Message::CampaignResponse { vote: false })?
</a><a href="#h3-5-124" id="h3-5-124" class="d">-            }
</a><a href="#h3-5-125" id="h3-5-125" class="d">-
</a><a href="#h3-5-126" id="h3-5-126" class="d">-            // If we received a vote, record it. If the vote gives us quorum,
</a><a href="#h3-5-127" id="h3-5-127" class="d">-            // assume leadership.
</a><a href="#h3-5-128" id="h3-5-128" class="d">-            Message::CampaignResponse { vote: true } =&gt; {
</a><a href="#h3-5-129" id="h3-5-129" class="d">-                self.role.votes.insert(msg.from);
</a><a href="#h3-5-130" id="h3-5-130" class="d">-                if self.role.votes.len() &gt;= self.quorum_size() {
</a><a href="#h3-5-131" id="h3-5-131" class="d">-                    return Ok(self.into_leader()?.into());
</a><a href="#h3-5-132" id="h3-5-132" class="d">-                }
</a><a href="#h3-5-133" id="h3-5-133" class="d">-            }
</a><a href="#h3-5-134" id="h3-5-134" class="d">-
</a><a href="#h3-5-135" id="h3-5-135" class="d">-            // We didn&#39;t get a vote. :(
</a><a href="#h3-5-136" id="h3-5-136" class="d">-            Message::CampaignResponse { vote: false } =&gt; {}
</a><a href="#h3-5-137" id="h3-5-137" class="d">-
</a><a href="#h3-5-138" id="h3-5-138" class="d">-            // If we receive a heartbeat or entries in this term, we lost the
</a><a href="#h3-5-139" id="h3-5-139" class="d">-            // election and have a new leader. Follow it and step the message.
</a><a href="#h3-5-140" id="h3-5-140" class="d">-            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a><a href="#h3-5-141" id="h3-5-141" class="d">-                return self.into_follower(msg.term, Some(msg.from))?.step(msg);
</a><a href="#h3-5-142" id="h3-5-142" class="d">-            }
</a><a href="#h3-5-143" id="h3-5-143" class="d">-
</a><a href="#h3-5-144" id="h3-5-144" class="d">-            // Abort any inbound client requests while candidate.
</a><a href="#h3-5-145" id="h3-5-145" class="d">-            Message::ClientRequest { id, .. } =&gt; {
</a><a href="#h3-5-146" id="h3-5-146" class="d">-                self.send(msg.from, Message::ClientResponse { id, response: Err(Error::Abort) })?;
</a><a href="#h3-5-147" id="h3-5-147" class="d">-            }
</a><a href="#h3-5-148" id="h3-5-148" class="d">-
</a><a href="#h3-5-149" id="h3-5-149" class="d">-            // We&#39;re not a leader in this term, nor are we forwarding requests,
</a><a href="#h3-5-150" id="h3-5-150" class="d">-            // so we shouldn&#39;t see these.
</a><a href="#h3-5-151" id="h3-5-151" class="d">-            Message::HeartbeatResponse { .. }
</a><a href="#h3-5-152" id="h3-5-152" class="d">-            | Message::AppendResponse { .. }
</a><a href="#h3-5-153" id="h3-5-153" class="d">-            | Message::ClientResponse { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a><a href="#h3-5-154" id="h3-5-154" class="d">-        }
</a><a href="#h3-5-155" id="h3-5-155" class="d">-        Ok(self.into())
</a><a href="#h3-5-156" id="h3-5-156" class="d">-    }
</a><a href="#h3-5-157" id="h3-5-157" class="d">-
</a><a href="#h3-5-158" id="h3-5-158" class="d">-    /// Processes a logical clock tick.
</a><a href="#h3-5-159" id="h3-5-159" class="d">-    fn tick(mut self) -&gt; Result&lt;Node&gt; {
</a><a href="#h3-5-160" id="h3-5-160" class="d">-        self.role.election_duration += 1;
</a><a href="#h3-5-161" id="h3-5-161" class="d">-        if self.role.election_duration &gt;= self.role.election_timeout {
</a><a href="#h3-5-162" id="h3-5-162" class="d">-            self.campaign()?;
</a><a href="#h3-5-163" id="h3-5-163" class="d">-        }
</a><a href="#h3-5-164" id="h3-5-164" class="d">-        assert!(self.role.election_duration &lt; self.role.election_timeout, &quot;past election timeout&quot;);
</a><a href="#h3-5-165" id="h3-5-165" class="d">-        Ok(self.into())
</a><a href="#h3-5-166" id="h3-5-166" class="d">-    }
</a><a href="#h3-5-167" id="h3-5-167" class="d">-
</a><a href="#h3-5-168" id="h3-5-168" class="d">-    /// Campaign for leadership by increasing the term, voting for ourself, and
</a><a href="#h3-5-169" id="h3-5-169" class="d">-    /// soliciting votes from all peers.
</a><a href="#h3-5-170" id="h3-5-170" class="d">-    fn campaign(&amp;mut self) -&gt; Result&lt;()&gt; {
</a><a href="#h3-5-171" id="h3-5-171" class="d">-        let term = self.term() + 1;
</a><a href="#h3-5-172" id="h3-5-172" class="d">-        info!(&quot;Starting new election for term {term}&quot;);
</a><a href="#h3-5-173" id="h3-5-173" class="d">-        self.role = Candidate::new(self.gen_election_timeout());
</a><a href="#h3-5-174" id="h3-5-174" class="d">-        self.role.votes.insert(self.id); // vote for ourself
</a><a href="#h3-5-175" id="h3-5-175" class="d">-        self.log.set_term(term, Some(self.id))?;
</a><a href="#h3-5-176" id="h3-5-176" class="d">-
</a><a href="#h3-5-177" id="h3-5-177" class="d">-        let (last_index, last_term) = self.log.get_last_index();
</a><a href="#h3-5-178" id="h3-5-178" class="d">-        self.broadcast(Message::Campaign { last_index, last_term })?;
</a><a href="#h3-5-179" id="h3-5-179" class="d">-        Ok(())
</a><a href="#h3-5-180" id="h3-5-180" class="d">-    }
</a><a href="#h3-5-181" id="h3-5-181" class="d">-}
</a><a href="#h3-5-182" id="h3-5-182" class="d">-
</a><a href="#h3-5-183" id="h3-5-183" class="d">-// A follower replicates state from a leader.
</a><a href="#h3-5-184" id="h3-5-184" class="i">+// A follower replicates log entries from a leader and forwards client requests.
</a><a href="#h3-5-185" id="h3-5-185" class="i">+// Nodes start as leaderless followers, until they either discover a leader or
</a><a href="#h3-5-186" id="h3-5-186" class="i">+// hold an election.
</a> pub struct Follower {
<a href="#h3-5-188" id="h3-5-188" class="d">-    /// The leader, or None if just initialized.
</a><a href="#h3-5-189" id="h3-5-189" class="i">+    /// The leader, or None if we&#39;re a leaderless follower.
</a>     leader: Option&lt;NodeID&gt;,
     /// The number of ticks since the last message from the leader.
     leader_seen: Ticks,
<a href="#h3-6" id="h3-6" class="h">@@ -391,15 +280,15 @@ impl RawNode&lt;Follower&gt; {
</a>         peers: HashSet&lt;NodeID&gt;,
         log: Log,
         state: Box&lt;dyn State&gt;,
<a href="#h3-6-3" id="h3-6-3" class="d">-        node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
</a><a href="#h3-6-4" id="h3-6-4" class="i">+        tx: Sender&lt;Envelope&gt;,
</a>         opts: Options,
     ) -&gt; Result&lt;Self&gt; {
         if peers.contains(&amp;id) {
             return errinput!(&quot;node ID {id} can&#39;t be in peers&quot;);
         }
         let role = Follower::new(None, 0);
<a href="#h3-6-11" id="h3-6-11" class="d">-        let mut node = Self { id, peers, log, state, node_tx, opts, role };
</a><a href="#h3-6-12" id="h3-6-12" class="d">-        node.role.election_timeout = node.gen_election_timeout();
</a><a href="#h3-6-13" id="h3-6-13" class="i">+        let mut node = Self { id, peers, log, state, tx, opts, role };
</a><a href="#h3-6-14" id="h3-6-14" class="i">+        node.role.election_timeout = node.random_election_timeout();
</a>         Ok(node)
     }
 
<a href="#h3-7" id="h3-7" class="h">@@ -413,7 +302,7 @@ impl RawNode&lt;Follower&gt; {
</a>         self.maybe_apply()?;
 
         // Become candidate and campaign.
<a href="#h3-7-3" id="h3-7-3" class="d">-        let election_timeout = self.gen_election_timeout();
</a><a href="#h3-7-4" id="h3-7-4" class="i">+        let election_timeout = self.random_election_timeout();
</a>         let mut node = self.into_role(Candidate::new(election_timeout));
         node.campaign()?;
 
<a href="#h3-8" id="h3-8" class="h">@@ -425,10 +314,9 @@ impl RawNode&lt;Follower&gt; {
</a>         Ok(node)
     }
 
<a href="#h3-8-3" id="h3-8-3" class="d">-    /// Transitions the follower into a follower, either a leaderless follower
</a><a href="#h3-8-4" id="h3-8-4" class="d">-    /// in a new term (e.g. if someone holds a new election) or following a
</a><a href="#h3-8-5" id="h3-8-5" class="d">-    /// leader in the current term once someone wins the election.
</a><a href="#h3-8-6" id="h3-8-6" class="d">-    fn into_follower(mut self, leader: Option&lt;NodeID&gt;, term: Term) -&gt; Result&lt;RawNode&lt;Follower&gt;&gt; {
</a><a href="#h3-8-7" id="h3-8-7" class="i">+    /// Transitions the follower into either a leaderless follower in a new term
</a><a href="#h3-8-8" id="h3-8-8" class="i">+    /// (e.g. if someone holds a new election) or a follower of a current leader.
</a><a href="#h3-8-9" id="h3-8-9" class="i">+    fn into_follower(mut self, term: Term, leader: Option&lt;NodeID&gt;) -&gt; Result&lt;RawNode&lt;Follower&gt;&gt; {
</a>         assert_ne!(term, 0, &quot;can&#39;t become follower in term 0&quot;);
 
         // Abort any forwarded requests. These must be retried with new leader.
<a href="#h3-9" id="h3-9" class="h">@@ -442,47 +330,43 @@ impl RawNode&lt;Follower&gt; {
</a>             info!(&quot;Following leader {leader} in term {term}&quot;);
             self.role = Follower::new(Some(leader), self.role.election_timeout);
         } else {
<a href="#h3-9-3" id="h3-9-3" class="d">-            // We found a new term, but we don&#39;t necessarily know who the leader
</a><a href="#h3-9-4" id="h3-9-4" class="d">-            // is yet. We&#39;ll find out when we step a message from it.
</a><a href="#h3-9-5" id="h3-9-5" class="i">+            // We found a new term, but we don&#39;t know who the leader is yet.
</a><a href="#h3-9-6" id="h3-9-6" class="i">+            // We&#39;ll find out if we step a message from it.
</a>             assert_ne!(term, self.term(), &quot;can&#39;t become leaderless follower in current term&quot;);
             info!(&quot;Discovered new term {term}&quot;);
             self.log.set_term(term, None)?;
<a href="#h3-9-10" id="h3-9-10" class="d">-            self.role = Follower::new(None, self.gen_election_timeout());
</a><a href="#h3-9-11" id="h3-9-11" class="i">+            self.role = Follower::new(None, self.random_election_timeout());
</a>         }
         Ok(self)
     }
 
<a href="#h3-9-16" id="h3-9-16" class="d">-    /// Processes a message.
</a><a href="#h3-9-17" id="h3-9-17" class="i">+    /// Processes an inbound message.
</a>     fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
<a href="#h3-9-19" id="h3-9-19" class="d">-        // Drop messages from past terms.
</a><a href="#h3-9-20" id="h3-9-20" class="i">+        // Past term: drop the message.
</a>         if msg.term &lt; self.term() {
<a href="#h3-9-22" id="h3-9-22" class="d">-            debug!(&quot;Dropping message from past term ({:?})&quot;, msg);
</a><a href="#h3-9-23" id="h3-9-23" class="i">+            debug!(&quot;Dropping message from past term: {msg:?}&quot;);
</a>             return Ok(self.into());
         }
<a href="#h3-9-26" id="h3-9-26" class="d">-
</a><a href="#h3-9-27" id="h3-9-27" class="d">-        // If we receive a message for a future term, become a leaderless
</a><a href="#h3-9-28" id="h3-9-28" class="d">-        // follower in it and step the message. If the message is a Heartbeat or
</a><a href="#h3-9-29" id="h3-9-29" class="d">-        // Append from the leader, stepping it will follow the leader.
</a><a href="#h3-9-30" id="h3-9-30" class="i">+        // Future term: become leaderless follower and step the message.
</a>         if msg.term &gt; self.term() {
<a href="#h3-9-32" id="h3-9-32" class="d">-            return self.into_follower(None, msg.term)?.step(msg);
</a><a href="#h3-9-33" id="h3-9-33" class="i">+            return self.into_follower(msg.term, None)?.step(msg);
</a>         }
 
         // Record when we last saw a message from the leader (if any).
<a href="#h3-9-37" id="h3-9-37" class="d">-        if self.is_leader(msg.from) {
</a><a href="#h3-9-38" id="h3-9-38" class="i">+        if Some(msg.from) == self.role.leader {
</a>             self.role.leader_seen = 0
         }
 
         match msg.message {
<a href="#h3-9-43" id="h3-9-43" class="d">-            // The leader will send periodic heartbeats. If we don&#39;t have a
</a><a href="#h3-9-44" id="h3-9-44" class="d">-            // leader in this term yet, follow it. If the commit_index advances,
</a><a href="#h3-9-45" id="h3-9-45" class="d">-            // apply state transitions.
</a><a href="#h3-9-46" id="h3-9-46" class="i">+            // The leader sends periodic heartbeats. If we don&#39;t have a leader
</a><a href="#h3-9-47" id="h3-9-47" class="i">+            // yet, follow it. If the commit_index advances, apply commands.
</a>             Message::Heartbeat { last_index, commit_index, read_seq } =&gt; {
                 assert!(commit_index &lt;= last_index, &quot;commit_index after last_index&quot;);
 
<a href="#h3-9-51" id="h3-9-51" class="d">-                // Check that the heartbeat is from our leader.
</a><a href="#h3-9-52" id="h3-9-52" class="i">+                // Make sure the heartbeat is from our leader, or follow it.
</a>                 match self.role.leader {
                     Some(leader) =&gt; assert_eq!(msg.from, leader, &quot;multiple leaders in term&quot;),
<a href="#h3-9-55" id="h3-9-55" class="d">-                    None =&gt; self = self.into_follower(Some(msg.from), msg.term)?,
</a><a href="#h3-9-56" id="h3-9-56" class="i">+                    None =&gt; self = self.into_follower(msg.term, Some(msg.from))?,
</a>                 }
 
                 // Attempt to match the leader&#39;s log and respond to the
<a href="#h3-10" id="h3-10" class="h">@@ -490,10 +374,10 @@ impl RawNode&lt;Follower&gt; {
</a>                 let match_index = if self.log.has(last_index, msg.term)? { last_index } else { 0 };
                 self.send(msg.from, Message::HeartbeatResponse { match_index, read_seq })?;
 
<a href="#h3-10-3" id="h3-10-3" class="d">-                // Advance commit index and apply entries. We can only do this
</a><a href="#h3-10-4" id="h3-10-4" class="d">-                // if the last_index matches the leader, which implies that
</a><a href="#h3-10-5" id="h3-10-5" class="d">-                // the logs are identical up to match_index. This also implies
</a><a href="#h3-10-6" id="h3-10-6" class="d">-                // that the commit_index is present in our log.
</a><a href="#h3-10-7" id="h3-10-7" class="i">+                // Advance the commit index and apply entries. We can only do
</a><a href="#h3-10-8" id="h3-10-8" class="i">+                // this if we matched the leader&#39;s last_index, which implies
</a><a href="#h3-10-9" id="h3-10-9" class="i">+                // that the logs are identical up to match_index. This also
</a><a href="#h3-10-10" id="h3-10-10" class="i">+                // implies that the commit_index is present in our log.
</a>                 if match_index != 0 &amp;&amp; commit_index &gt; self.log.get_commit_index().0 {
                     self.log.commit(commit_index)?;
                     self.maybe_apply()?;
<a href="#h3-11" id="h3-11" class="h">@@ -506,13 +390,13 @@ impl RawNode&lt;Follower&gt; {
</a>                     assert_eq!(base_index, first.index - 1, &quot;base index mismatch&quot;);
                 }
 
<a href="#h3-11-3" id="h3-11-3" class="d">-                // Make sure the message comes from our leader.
</a><a href="#h3-11-4" id="h3-11-4" class="i">+                // Make sure the append is from our leader, or follow it.
</a>                 match self.role.leader {
                     Some(leader) =&gt; assert_eq!(msg.from, leader, &quot;multiple leaders in term&quot;),
<a href="#h3-11-7" id="h3-11-7" class="d">-                    None =&gt; self = self.into_follower(Some(msg.from), msg.term)?,
</a><a href="#h3-11-8" id="h3-11-8" class="i">+                    None =&gt; self = self.into_follower(msg.term, Some(msg.from))?,
</a>                 }
 
<a href="#h3-11-11" id="h3-11-11" class="d">-                // If the base entry is in our log, append the entries.
</a><a href="#h3-11-12" id="h3-11-12" class="i">+                // If the base entry matches our log, append the entries.
</a>                 let (mut reject_index, mut match_index) = (0, 0);
                 if base_index == 0 || self.log.has(base_index, base_term)? {
                     match_index = entries.last().map(|e| e.index).unwrap_or(base_index);
<a href="#h3-12" id="h3-12" class="h">@@ -520,15 +404,16 @@ impl RawNode&lt;Follower&gt; {
</a>                 } else {
                     // Otherwise, reject the base index. If the local log is
                     // shorter than the base index, lower the reject index to
<a href="#h3-12-3" id="h3-12-3" class="d">-                    // skip all the missing entries.
</a><a href="#h3-12-4" id="h3-12-4" class="i">+                    // skip all missing entries.
</a>                     reject_index = std::cmp::min(base_index, self.log.get_last_index().0 + 1);
                 }
                 self.send(msg.from, Message::AppendResponse { reject_index, match_index })?;
             }
 
<a href="#h3-12-10" id="h3-12-10" class="d">-            // A candidate in this term is requesting our vote.
</a><a href="#h3-12-11" id="h3-12-11" class="i">+            // A candidate is requesting our vote. We&#39;ll only grant one.
</a>             Message::Campaign { last_index, last_term } =&gt; {
                 // Don&#39;t vote if we already voted for someone else in this term.
<a href="#h3-12-14" id="h3-12-14" class="i">+                // We can repeat our vote though.
</a>                 if let (_, Some(vote)) = self.log.get_term() {
                     if msg.from != vote {
                         self.send(msg.from, Message::CampaignResponse { vote: false })?;
<a href="#h3-13" id="h3-13" class="h">@@ -537,6 +422,8 @@ impl RawNode&lt;Follower&gt; {
</a>                 }
 
                 // Don&#39;t vote if our log is newer than the candidate&#39;s log.
<a href="#h3-13-3" id="h3-13-3" class="i">+                // This ensures that an elected leader has all committed
</a><a href="#h3-13-4" id="h3-13-4" class="i">+                // entries, see section 5.4.1 in the Raft paper.
</a>                 let (log_index, log_term) = self.log.get_last_index();
                 if log_term &gt; last_term || log_term == last_term &amp;&amp; log_index &gt; last_index {
                     self.send(msg.from, Message::CampaignResponse { vote: false })?;
<a href="#h3-14" id="h3-14" class="h">@@ -549,39 +436,37 @@ impl RawNode&lt;Follower&gt; {
</a>                 self.send(msg.from, Message::CampaignResponse { vote: true })?;
             }
 
<a href="#h3-14-3" id="h3-14-3" class="d">-            // We may receive a vote after we lost an election and followed a
</a><a href="#h3-14-4" id="h3-14-4" class="d">-            // different leader. Ignore it.
</a><a href="#h3-14-5" id="h3-14-5" class="d">-            Message::CampaignResponse { .. } =&gt; {}
</a><a href="#h3-14-6" id="h3-14-6" class="d">-
</a>             // Forward client requests to the leader, or abort them if there is
<a href="#h3-14-8" id="h3-14-8" class="d">-            // none (the client must retry).
</a><a href="#h3-14-9" id="h3-14-9" class="d">-            Message::ClientRequest { id, .. } =&gt; {
</a><a href="#h3-14-10" id="h3-14-10" class="d">-                assert_eq!(msg.from, self.id, &quot;Client request from other node&quot;);
</a><a href="#h3-14-11" id="h3-14-11" class="i">+            // none. These will not be retried, the client should use timeouts.
</a><a href="#h3-14-12" id="h3-14-12" class="i">+            // Local client requests use our node ID as the sender.
</a><a href="#h3-14-13" id="h3-14-13" class="i">+            Message::ClientRequest { id, request: _ } =&gt; {
</a><a href="#h3-14-14" id="h3-14-14" class="i">+                assert_eq!(msg.from, self.id, &quot;client request from other node&quot;);
</a> 
                 if let Some(leader) = self.role.leader {
<a href="#h3-14-17" id="h3-14-17" class="d">-                    debug!(&quot;Forwarding request to leader {}: {:?}&quot;, leader, msg);
</a><a href="#h3-14-18" id="h3-14-18" class="i">+                    debug!(&quot;Forwarding request to leader {leader}: {msg:?}&quot;);
</a>                     self.role.forwarded.insert(id);
                     self.send(leader, msg.message)?
                 } else {
<a href="#h3-14-22" id="h3-14-22" class="d">-                    self.send(
</a><a href="#h3-14-23" id="h3-14-23" class="d">-                        msg.from,
</a><a href="#h3-14-24" id="h3-14-24" class="d">-                        Message::ClientResponse { id, response: Err(Error::Abort) },
</a><a href="#h3-14-25" id="h3-14-25" class="d">-                    )?
</a><a href="#h3-14-26" id="h3-14-26" class="i">+                    let response = Err(Error::Abort);
</a><a href="#h3-14-27" id="h3-14-27" class="i">+                    self.send(msg.from, Message::ClientResponse { id, response })?
</a>                 }
             }
 
<a href="#h3-14-31" id="h3-14-31" class="d">-            // Returns client responses for forwarded requests.
</a><a href="#h3-14-32" id="h3-14-32" class="i">+            // Client responses from the leader are passed on to the client.
</a>             Message::ClientResponse { id, response } =&gt; {
<a href="#h3-14-34" id="h3-14-34" class="d">-                assert!(self.is_leader(msg.from), &quot;Client response from non-leader&quot;);
</a><a href="#h3-14-35" id="h3-14-35" class="i">+                assert_eq!(Some(msg.from), self.role.leader, &quot;client response from non-leader&quot;);
</a> 
                 if self.role.forwarded.remove(&amp;id) {
                     self.send(self.id, Message::ClientResponse { id, response })?;
                 }
             }
 
<a href="#h3-14-42" id="h3-14-42" class="d">-            // We&#39;re not a leader nor candidate in this term, so we shoudn&#39;t see these.
</a><a href="#h3-14-43" id="h3-14-43" class="i">+            // We may receive a vote after we lost an election, ignore it.
</a><a href="#h3-14-44" id="h3-14-44" class="i">+            Message::CampaignResponse { .. } =&gt; {}
</a><a href="#h3-14-45" id="h3-14-45" class="i">+
</a><a href="#h3-14-46" id="h3-14-46" class="i">+            // We&#39;re not leader this term, so we shouldn&#39;t see these.
</a>             Message::HeartbeatResponse { .. } | Message::AppendResponse { .. } =&gt; {
<a href="#h3-14-48" id="h3-14-48" class="d">-                panic!(&quot;Received unexpected message {msg:?}&quot;)
</a><a href="#h3-14-49" id="h3-14-49" class="i">+                panic!(&quot;unexpected message {msg:?}&quot;)
</a>             }
         };
         Ok(self.into())
<a href="#h3-15" id="h3-15" class="h">@@ -596,11 +481,11 @@ impl RawNode&lt;Follower&gt; {
</a>         Ok(self.into())
     }
 
<a href="#h3-15-3" id="h3-15-3" class="d">-    /// Aborts all forwarded requests.
</a><a href="#h3-15-4" id="h3-15-4" class="i">+    /// Aborts all forwarded requests (e.g. on term/leader changes).
</a>     fn abort_forwarded(&amp;mut self) -&gt; Result&lt;()&gt; {
<a href="#h3-15-6" id="h3-15-6" class="d">-        // Sort the IDs for test determinism.
</a><a href="#h3-15-7" id="h3-15-7" class="i">+        // Sort by ID for test determinism.
</a>         for id in std::mem::take(&amp;mut self.role.forwarded).into_iter().sorted() {
<a href="#h3-15-9" id="h3-15-9" class="d">-            debug!(&quot;Aborting forwarded request {:x?}&quot;, id);
</a><a href="#h3-15-10" id="h3-15-10" class="i">+            debug!(&quot;Aborting forwarded request {id}&quot;);
</a>             self.send(self.id, Message::ClientResponse { id, response: Err(Error::Abort) })?;
         }
         Ok(())
<a href="#h3-16" id="h3-16" class="h">@@ -611,34 +496,192 @@ impl RawNode&lt;Follower&gt; {
</a>         let mut iter = self.log.scan_apply(self.state.get_applied_index());
         while let Some(entry) = iter.next().transpose()? {
             debug!(&quot;Applying {entry:?}&quot;);
<a href="#h3-16-3" id="h3-16-3" class="d">-            // Throw away the result, since there is no client waiting for it.
</a><a href="#h3-16-4" id="h3-16-4" class="i">+            // Throw away the result, since only the leader responds to clients.
</a>             // This includes errors -- any non-deterministic errors (e.g. IO
             // errors) must panic instead to avoid replica divergence.
             _ = self.state.apply(entry);
         }
         Ok(())
     }
<a href="#h3-16-11" id="h3-16-11" class="i">+}
</a><a href="#h3-16-12" id="h3-16-12" class="i">+
</a><a href="#h3-16-13" id="h3-16-13" class="i">+/// A candidate is campaigning to become a leader.
</a><a href="#h3-16-14" id="h3-16-14" class="i">+pub struct Candidate {
</a><a href="#h3-16-15" id="h3-16-15" class="i">+    /// Votes received (including our own).
</a><a href="#h3-16-16" id="h3-16-16" class="i">+    votes: HashSet&lt;NodeID&gt;,
</a><a href="#h3-16-17" id="h3-16-17" class="i">+    /// Ticks elapsed since election start.
</a><a href="#h3-16-18" id="h3-16-18" class="i">+    election_duration: Ticks,
</a><a href="#h3-16-19" id="h3-16-19" class="i">+    /// Election timeout, in ticks.
</a><a href="#h3-16-20" id="h3-16-20" class="i">+    election_timeout: Ticks,
</a><a href="#h3-16-21" id="h3-16-21" class="i">+}
</a> 
<a href="#h3-16-23" id="h3-16-23" class="d">-    /// Checks if an address is the current leader.
</a><a href="#h3-16-24" id="h3-16-24" class="d">-    fn is_leader(&amp;self, from: NodeID) -&gt; bool {
</a><a href="#h3-16-25" id="h3-16-25" class="d">-        self.role.leader == Some(from)
</a><a href="#h3-16-26" id="h3-16-26" class="i">+impl Candidate {
</a><a href="#h3-16-27" id="h3-16-27" class="i">+    /// Creates a new candidate role.
</a><a href="#h3-16-28" id="h3-16-28" class="i">+    fn new(election_timeout: Ticks) -&gt; Self {
</a><a href="#h3-16-29" id="h3-16-29" class="i">+        Self { votes: HashSet::new(), election_duration: 0, election_timeout }
</a>     }
 }
 
<a href="#h3-16-33" id="h3-16-33" class="d">-/// Follower replication progress.
</a><a href="#h3-16-34" id="h3-16-34" class="i">+impl Role for Candidate {}
</a><a href="#h3-16-35" id="h3-16-35" class="i">+
</a><a href="#h3-16-36" id="h3-16-36" class="i">+impl RawNode&lt;Candidate&gt; {
</a><a href="#h3-16-37" id="h3-16-37" class="i">+    /// Transitions the candidate to a follower. We either lost the election and
</a><a href="#h3-16-38" id="h3-16-38" class="i">+    /// follow the winner, or we discovered a new term and step into it as a
</a><a href="#h3-16-39" id="h3-16-39" class="i">+    /// leaderless follower.
</a><a href="#h3-16-40" id="h3-16-40" class="i">+    fn into_follower(mut self, term: Term, leader: Option&lt;NodeID&gt;) -&gt; Result&lt;RawNode&lt;Follower&gt;&gt; {
</a><a href="#h3-16-41" id="h3-16-41" class="i">+        let election_timeout = self.random_election_timeout();
</a><a href="#h3-16-42" id="h3-16-42" class="i">+        if let Some(leader) = leader {
</a><a href="#h3-16-43" id="h3-16-43" class="i">+            // We lost the election, follow the winner.
</a><a href="#h3-16-44" id="h3-16-44" class="i">+            assert_eq!(term, self.term(), &quot;can&#39;t follow leader in different term&quot;);
</a><a href="#h3-16-45" id="h3-16-45" class="i">+            info!(&quot;Lost election, following leader {leader} in term {term}&quot;);
</a><a href="#h3-16-46" id="h3-16-46" class="i">+            Ok(self.into_role(Follower::new(Some(leader), election_timeout)))
</a><a href="#h3-16-47" id="h3-16-47" class="i">+        } else {
</a><a href="#h3-16-48" id="h3-16-48" class="i">+            // We found a new term, but we don&#39;t necessarily know who the leader
</a><a href="#h3-16-49" id="h3-16-49" class="i">+            // is yet. We&#39;ll find out when we step a message from it.
</a><a href="#h3-16-50" id="h3-16-50" class="i">+            assert_ne!(term, self.term(), &quot;can&#39;t become leaderless follower in current term&quot;);
</a><a href="#h3-16-51" id="h3-16-51" class="i">+            info!(&quot;Discovered new term {term}&quot;);
</a><a href="#h3-16-52" id="h3-16-52" class="i">+            self.log.set_term(term, None)?;
</a><a href="#h3-16-53" id="h3-16-53" class="i">+            Ok(self.into_role(Follower::new(None, election_timeout)))
</a><a href="#h3-16-54" id="h3-16-54" class="i">+        }
</a><a href="#h3-16-55" id="h3-16-55" class="i">+    }
</a><a href="#h3-16-56" id="h3-16-56" class="i">+
</a><a href="#h3-16-57" id="h3-16-57" class="i">+    /// Transitions the candidate to a leader. We won the election.
</a><a href="#h3-16-58" id="h3-16-58" class="i">+    fn into_leader(self) -&gt; Result&lt;RawNode&lt;Leader&gt;&gt; {
</a><a href="#h3-16-59" id="h3-16-59" class="i">+        let (term, vote) = self.log.get_term();
</a><a href="#h3-16-60" id="h3-16-60" class="i">+        assert_ne!(term, 0, &quot;leaders can&#39;t have term 0&quot;);
</a><a href="#h3-16-61" id="h3-16-61" class="i">+        assert_eq!(vote, Some(self.id), &quot;leader did not vote for self&quot;);
</a><a href="#h3-16-62" id="h3-16-62" class="i">+
</a><a href="#h3-16-63" id="h3-16-63" class="i">+        info!(&quot;Won election for term {term}, becoming leader&quot;);
</a><a href="#h3-16-64" id="h3-16-64" class="i">+        let peers = self.peers.clone();
</a><a href="#h3-16-65" id="h3-16-65" class="i">+        let (last_index, _) = self.log.get_last_index();
</a><a href="#h3-16-66" id="h3-16-66" class="i">+        let mut node = self.into_role(Leader::new(peers, last_index));
</a><a href="#h3-16-67" id="h3-16-67" class="i">+
</a><a href="#h3-16-68" id="h3-16-68" class="i">+        // Propose an empty command when assuming leadership, to disambiguate
</a><a href="#h3-16-69" id="h3-16-69" class="i">+        // previous entries in the log. See section 5.4.2 in the Raft paper.
</a><a href="#h3-16-70" id="h3-16-70" class="i">+        // We do this prior to the heartbeat, to avoid a wasted replication
</a><a href="#h3-16-71" id="h3-16-71" class="i">+        // roundtrip if the heartbeat response indicates the peer is behind.
</a><a href="#h3-16-72" id="h3-16-72" class="i">+        node.propose(None)?;
</a><a href="#h3-16-73" id="h3-16-73" class="i">+        node.maybe_commit_and_apply()?;
</a><a href="#h3-16-74" id="h3-16-74" class="i">+        node.heartbeat()?;
</a><a href="#h3-16-75" id="h3-16-75" class="i">+
</a><a href="#h3-16-76" id="h3-16-76" class="i">+        Ok(node)
</a><a href="#h3-16-77" id="h3-16-77" class="i">+    }
</a><a href="#h3-16-78" id="h3-16-78" class="i">+
</a><a href="#h3-16-79" id="h3-16-79" class="i">+    /// Processes an inbound message.
</a><a href="#h3-16-80" id="h3-16-80" class="i">+    fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
</a><a href="#h3-16-81" id="h3-16-81" class="i">+        // Past term: drop the message.
</a><a href="#h3-16-82" id="h3-16-82" class="i">+        if msg.term &lt; self.term() {
</a><a href="#h3-16-83" id="h3-16-83" class="i">+            debug!(&quot;Dropping message from past term: {msg:?}&quot;);
</a><a href="#h3-16-84" id="h3-16-84" class="i">+            return Ok(self.into());
</a><a href="#h3-16-85" id="h3-16-85" class="i">+        }
</a><a href="#h3-16-86" id="h3-16-86" class="i">+        // Future term: become leaderless follower and step the message.
</a><a href="#h3-16-87" id="h3-16-87" class="i">+        if msg.term &gt; self.term() {
</a><a href="#h3-16-88" id="h3-16-88" class="i">+            return self.into_follower(msg.term, None)?.step(msg);
</a><a href="#h3-16-89" id="h3-16-89" class="i">+        }
</a><a href="#h3-16-90" id="h3-16-90" class="i">+
</a><a href="#h3-16-91" id="h3-16-91" class="i">+        match msg.message {
</a><a href="#h3-16-92" id="h3-16-92" class="i">+            // If we received a vote, record it. If the vote gives us quorum,
</a><a href="#h3-16-93" id="h3-16-93" class="i">+            // assume leadership.
</a><a href="#h3-16-94" id="h3-16-94" class="i">+            Message::CampaignResponse { vote: true } =&gt; {
</a><a href="#h3-16-95" id="h3-16-95" class="i">+                self.role.votes.insert(msg.from);
</a><a href="#h3-16-96" id="h3-16-96" class="i">+                if self.role.votes.len() &gt;= self.quorum_size() {
</a><a href="#h3-16-97" id="h3-16-97" class="i">+                    return Ok(self.into_leader()?.into());
</a><a href="#h3-16-98" id="h3-16-98" class="i">+                }
</a><a href="#h3-16-99" id="h3-16-99" class="i">+            }
</a><a href="#h3-16-100" id="h3-16-100" class="i">+
</a><a href="#h3-16-101" id="h3-16-101" class="i">+            // We didn&#39;t get the vote. :(
</a><a href="#h3-16-102" id="h3-16-102" class="i">+            Message::CampaignResponse { vote: false } =&gt; {}
</a><a href="#h3-16-103" id="h3-16-103" class="i">+
</a><a href="#h3-16-104" id="h3-16-104" class="i">+            // Don&#39;t grant votes for other candidates.
</a><a href="#h3-16-105" id="h3-16-105" class="i">+            Message::Campaign { .. } =&gt; {
</a><a href="#h3-16-106" id="h3-16-106" class="i">+                self.send(msg.from, Message::CampaignResponse { vote: false })?
</a><a href="#h3-16-107" id="h3-16-107" class="i">+            }
</a><a href="#h3-16-108" id="h3-16-108" class="i">+
</a><a href="#h3-16-109" id="h3-16-109" class="i">+            // If we hear from a leader in this term, we lost the election.
</a><a href="#h3-16-110" id="h3-16-110" class="i">+            // Follow it and step the message.
</a><a href="#h3-16-111" id="h3-16-111" class="i">+            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a><a href="#h3-16-112" id="h3-16-112" class="i">+                return self.into_follower(msg.term, Some(msg.from))?.step(msg);
</a><a href="#h3-16-113" id="h3-16-113" class="i">+            }
</a><a href="#h3-16-114" id="h3-16-114" class="i">+
</a><a href="#h3-16-115" id="h3-16-115" class="i">+            // Abort client requests while campaigning. The client must retry.
</a><a href="#h3-16-116" id="h3-16-116" class="i">+            Message::ClientRequest { id, request: _ } =&gt; {
</a><a href="#h3-16-117" id="h3-16-117" class="i">+                self.send(msg.from, Message::ClientResponse { id, response: Err(Error::Abort) })?;
</a><a href="#h3-16-118" id="h3-16-118" class="i">+            }
</a><a href="#h3-16-119" id="h3-16-119" class="i">+
</a><a href="#h3-16-120" id="h3-16-120" class="i">+            // We&#39;re not a leader in this term, nor are we forwarding requests,
</a><a href="#h3-16-121" id="h3-16-121" class="i">+            // so we shouldn&#39;t see these.
</a><a href="#h3-16-122" id="h3-16-122" class="i">+            Message::HeartbeatResponse { .. }
</a><a href="#h3-16-123" id="h3-16-123" class="i">+            | Message::AppendResponse { .. }
</a><a href="#h3-16-124" id="h3-16-124" class="i">+            | Message::ClientResponse { .. } =&gt; panic!(&quot;unexpected message {msg:?}&quot;),
</a><a href="#h3-16-125" id="h3-16-125" class="i">+        }
</a><a href="#h3-16-126" id="h3-16-126" class="i">+        Ok(self.into())
</a><a href="#h3-16-127" id="h3-16-127" class="i">+    }
</a><a href="#h3-16-128" id="h3-16-128" class="i">+
</a><a href="#h3-16-129" id="h3-16-129" class="i">+    /// Processes a logical clock tick.
</a><a href="#h3-16-130" id="h3-16-130" class="i">+    fn tick(mut self) -&gt; Result&lt;Node&gt; {
</a><a href="#h3-16-131" id="h3-16-131" class="i">+        self.role.election_duration += 1;
</a><a href="#h3-16-132" id="h3-16-132" class="i">+        if self.role.election_duration &gt;= self.role.election_timeout {
</a><a href="#h3-16-133" id="h3-16-133" class="i">+            self.campaign()?;
</a><a href="#h3-16-134" id="h3-16-134" class="i">+        }
</a><a href="#h3-16-135" id="h3-16-135" class="i">+        Ok(self.into())
</a><a href="#h3-16-136" id="h3-16-136" class="i">+    }
</a><a href="#h3-16-137" id="h3-16-137" class="i">+
</a><a href="#h3-16-138" id="h3-16-138" class="i">+    /// Hold a new election by increasing the term, voting for ourself, and
</a><a href="#h3-16-139" id="h3-16-139" class="i">+    /// soliciting votes from all peers.
</a><a href="#h3-16-140" id="h3-16-140" class="i">+    fn campaign(&amp;mut self) -&gt; Result&lt;()&gt; {
</a><a href="#h3-16-141" id="h3-16-141" class="i">+        let term = self.term() + 1;
</a><a href="#h3-16-142" id="h3-16-142" class="i">+        info!(&quot;Starting new election for term {term}&quot;);
</a><a href="#h3-16-143" id="h3-16-143" class="i">+        self.role = Candidate::new(self.random_election_timeout());
</a><a href="#h3-16-144" id="h3-16-144" class="i">+        self.role.votes.insert(self.id); // vote for ourself
</a><a href="#h3-16-145" id="h3-16-145" class="i">+        self.log.set_term(term, Some(self.id))?;
</a><a href="#h3-16-146" id="h3-16-146" class="i">+
</a><a href="#h3-16-147" id="h3-16-147" class="i">+        let (last_index, last_term) = self.log.get_last_index();
</a><a href="#h3-16-148" id="h3-16-148" class="i">+        self.broadcast(Message::Campaign { last_index, last_term })
</a><a href="#h3-16-149" id="h3-16-149" class="i">+    }
</a><a href="#h3-16-150" id="h3-16-150" class="i">+}
</a><a href="#h3-16-151" id="h3-16-151" class="i">+
</a><a href="#h3-16-152" id="h3-16-152" class="i">+// A leader serves client requests and replicates the log to followers.
</a><a href="#h3-16-153" id="h3-16-153" class="i">+// If the leader loses leadership, all client requests are aborted.
</a><a href="#h3-16-154" id="h3-16-154" class="i">+pub struct Leader {
</a><a href="#h3-16-155" id="h3-16-155" class="i">+    /// Follower replication progress.
</a><a href="#h3-16-156" id="h3-16-156" class="i">+    progress: HashMap&lt;NodeID, Progress&gt;,
</a><a href="#h3-16-157" id="h3-16-157" class="i">+    /// Tracks pending write requests by log index. Added when the write is
</a><a href="#h3-16-158" id="h3-16-158" class="i">+    /// proposed and appended to the leader&#39;s log, and removed when the command
</a><a href="#h3-16-159" id="h3-16-159" class="i">+    /// is applied to the state machine, returning the result to the client.
</a><a href="#h3-16-160" id="h3-16-160" class="i">+    writes: HashMap&lt;Index, Write&gt;,
</a><a href="#h3-16-161" id="h3-16-161" class="i">+    /// Tracks pending read requests. For linearizability, read requests are
</a><a href="#h3-16-162" id="h3-16-162" class="i">+    /// assigned a sequence number and only executed once a quorum of nodes have
</a><a href="#h3-16-163" id="h3-16-163" class="i">+    /// confirmed it via leader heartbeats. Otherwise, an old leader may serve
</a><a href="#h3-16-164" id="h3-16-164" class="i">+    /// stale reads if a new leader has been elected elsewhere.
</a><a href="#h3-16-165" id="h3-16-165" class="i">+    reads: VecDeque&lt;Read&gt;,
</a><a href="#h3-16-166" id="h3-16-166" class="i">+    /// The read sequence number used for the last read. Initialized to 0 in
</a><a href="#h3-16-167" id="h3-16-167" class="i">+    /// this term, and incremented for every read command.
</a><a href="#h3-16-168" id="h3-16-168" class="i">+    read_seq: ReadSequence,
</a><a href="#h3-16-169" id="h3-16-169" class="i">+    /// Number of ticks since last heartbeat.
</a><a href="#h3-16-170" id="h3-16-170" class="i">+    since_heartbeat: Ticks,
</a><a href="#h3-16-171" id="h3-16-171" class="i">+}
</a><a href="#h3-16-172" id="h3-16-172" class="i">+
</a><a href="#h3-16-173" id="h3-16-173" class="i">+/// Follower replication progress (in this term).
</a> struct Progress {
<a href="#h3-16-175" id="h3-16-175" class="d">-    /// The next index to replicate to the follower.
</a><a href="#h3-16-176" id="h3-16-176" class="d">-    next_index: Index,
</a><a href="#h3-16-177" id="h3-16-177" class="d">-    /// The last index where the follower&#39;s log matches the leader.
</a><a href="#h3-16-178" id="h3-16-178" class="i">+    /// The highest index where the follower&#39;s log is known to match the leader.
</a><a href="#h3-16-179" id="h3-16-179" class="i">+    /// Initialized to 0, increases monotonically.
</a>     match_index: Index,
<a href="#h3-16-181" id="h3-16-181" class="d">-    /// The last read sequence number confirmed by the peer.
</a><a href="#h3-16-182" id="h3-16-182" class="i">+    /// The next index to replicate to the follower. Initialized to
</a><a href="#h3-16-183" id="h3-16-183" class="i">+    /// last_index+1, decreased when probing log mismatches. Always in
</a><a href="#h3-16-184" id="h3-16-184" class="i">+    /// the range [match_index+1, last_index+1].
</a><a href="#h3-16-185" id="h3-16-185" class="i">+    ///
</a><a href="#h3-16-186" id="h3-16-186" class="i">+    /// Entries pending transmission are in the range [next_index, last_index].
</a><a href="#h3-16-187" id="h3-16-187" class="i">+    /// Unacknowledged entries are in the range [match_index+1, next_index).
</a><a href="#h3-16-188" id="h3-16-188" class="i">+    next_index: Index,
</a><a href="#h3-16-189" id="h3-16-189" class="i">+    /// The last read sequence number confirmed by the peer. To avoid stale
</a><a href="#h3-16-190" id="h3-16-190" class="i">+    /// reads on leader changes, a read is only served once its sequence number
</a><a href="#h3-16-191" id="h3-16-191" class="i">+    /// is confirmed by a quorum.
</a>     read_seq: ReadSequence,
 }
 
 impl Progress {
     /// Attempts to advance a follower&#39;s match index, returning true if it did.
<a href="#h3-16-197" id="h3-16-197" class="d">-    /// If next_index is below it, it is advanced to the following index, but
</a><a href="#h3-16-198" id="h3-16-198" class="d">-    /// is otherwise left as is to avoid regressing it unnecessarily.
</a><a href="#h3-16-199" id="h3-16-199" class="i">+    /// If next_index is below it, it is advanced to the following index.
</a>     fn advance(&amp;mut self, match_index: Index) -&gt; bool {
         if match_index &lt;= self.match_index {
             return false;
<a href="#h3-17" id="h3-17" class="h">@@ -657,8 +700,8 @@ impl Progress {
</a>         true
     }
 
<a href="#h3-17-3" id="h3-17-3" class="d">-    /// Regresses the next index to the given index, if it&#39;s currently greater.
</a><a href="#h3-17-4" id="h3-17-4" class="d">-    /// Can&#39;t regress below match_index + 1. Returns true if next_index changes.
</a><a href="#h3-17-5" id="h3-17-5" class="i">+    /// Attempts to regress a follower&#39;s next index to the given index, returning
</a><a href="#h3-17-6" id="h3-17-6" class="i">+    /// true if it did. Won&#39;t regress below match_index + 1.
</a>     fn regress_next(&amp;mut self, next_index: Index) -&gt; bool {
         if next_index &gt;= self.next_index || self.next_index &lt;= self.match_index + 1 {
             return false;
<a href="#h3-18" id="h3-18" class="h">@@ -688,34 +731,6 @@ struct Read {
</a>     command: Vec&lt;u8&gt;,
 }
 
<a href="#h3-18-3" id="h3-18-3" class="d">-// A leader serves requests and replicates the log to followers.
</a><a href="#h3-18-4" id="h3-18-4" class="d">-pub struct Leader {
</a><a href="#h3-18-5" id="h3-18-5" class="d">-    /// Follower replication progress.
</a><a href="#h3-18-6" id="h3-18-6" class="d">-    progress: HashMap&lt;NodeID, Progress&gt;,
</a><a href="#h3-18-7" id="h3-18-7" class="d">-    /// Keeps track of pending write requests, keyed by log index. These are
</a><a href="#h3-18-8" id="h3-18-8" class="d">-    /// added when the write is proposed and appended to the leader&#39;s log, and
</a><a href="#h3-18-9" id="h3-18-9" class="d">-    /// removed when the command is applied to the state machine, sending the
</a><a href="#h3-18-10" id="h3-18-10" class="d">-    /// command result to the waiting client.
</a><a href="#h3-18-11" id="h3-18-11" class="d">-    ///
</a><a href="#h3-18-12" id="h3-18-12" class="d">-    /// If the leader loses leadership, all pending write requests are aborted
</a><a href="#h3-18-13" id="h3-18-13" class="d">-    /// by returning Error::Abort.
</a><a href="#h3-18-14" id="h3-18-14" class="d">-    writes: HashMap&lt;Index, Write&gt;,
</a><a href="#h3-18-15" id="h3-18-15" class="d">-    /// Keeps track of pending read requests. To guarantee linearizability, read
</a><a href="#h3-18-16" id="h3-18-16" class="d">-    /// requests are assigned a sequence number and registered here when
</a><a href="#h3-18-17" id="h3-18-17" class="d">-    /// received, but only executed once a quorum of nodes have confirmed the
</a><a href="#h3-18-18" id="h3-18-18" class="d">-    /// current leader by responding to heartbeats with the sequence number.
</a><a href="#h3-18-19" id="h3-18-19" class="d">-    ///
</a><a href="#h3-18-20" id="h3-18-20" class="d">-    /// If we lose leadership before the command is processed, all pending read
</a><a href="#h3-18-21" id="h3-18-21" class="d">-    /// requests are aborted by returning Error::Abort.
</a><a href="#h3-18-22" id="h3-18-22" class="d">-    reads: VecDeque&lt;Read&gt;,
</a><a href="#h3-18-23" id="h3-18-23" class="d">-    /// The read sequence number used for the last read. Incremented for every
</a><a href="#h3-18-24" id="h3-18-24" class="d">-    /// read command, and reset when we lose leadership (thus only valid for
</a><a href="#h3-18-25" id="h3-18-25" class="d">-    /// this term).
</a><a href="#h3-18-26" id="h3-18-26" class="d">-    read_seq: ReadSequence,
</a><a href="#h3-18-27" id="h3-18-27" class="d">-    /// Number of ticks since last periodic heartbeat.
</a><a href="#h3-18-28" id="h3-18-28" class="d">-    since_heartbeat: Ticks,
</a><a href="#h3-18-29" id="h3-18-29" class="d">-}
</a><a href="#h3-18-30" id="h3-18-30" class="d">-
</a> impl Leader {
     /// Creates a new leader role.
     fn new(peers: HashSet&lt;NodeID&gt;, last_index: Index) -&gt; Self {
<a href="#h3-19" id="h3-19" class="h">@@ -738,54 +753,44 @@ impl Role for Leader {}
</a> 
 impl RawNode&lt;Leader&gt; {
     /// Transitions the leader into a follower. This can only happen if we
<a href="#h3-19-3" id="h3-19-3" class="d">-    /// discover a new term, so we become a leaderless follower. Subsequently
</a><a href="#h3-19-4" id="h3-19-4" class="d">-    /// stepping the received message may discover the leader, if there is one.
</a><a href="#h3-19-5" id="h3-19-5" class="i">+    /// discover a new term, so we become a leaderless follower. Stepping the
</a><a href="#h3-19-6" id="h3-19-6" class="i">+    /// received message may then follow the new leader, if there is one.
</a>     fn into_follower(mut self, term: Term) -&gt; Result&lt;RawNode&lt;Follower&gt;&gt; {
         assert!(term &gt; self.term(), &quot;leader can only become follower in later term&quot;);
<a href="#h3-19-9" id="h3-19-9" class="d">-
</a>         info!(&quot;Discovered new term {term}&quot;);
 
<a href="#h3-19-12" id="h3-19-12" class="d">-        // Cancel in-flight requests.
</a><a href="#h3-19-13" id="h3-19-13" class="i">+        // Abort in-flight requests. The client must retry. Sort the requests
</a><a href="#h3-19-14" id="h3-19-14" class="i">+        // by ID for test determinism.
</a>         for write in std::mem::take(&amp;mut self.role.writes).into_values().sorted_by_key(|w| w.id) {
<a href="#h3-19-16" id="h3-19-16" class="d">-            self.send(
</a><a href="#h3-19-17" id="h3-19-17" class="d">-                write.from,
</a><a href="#h3-19-18" id="h3-19-18" class="d">-                Message::ClientResponse { id: write.id, response: Err(Error::Abort) },
</a><a href="#h3-19-19" id="h3-19-19" class="d">-            )?;
</a><a href="#h3-19-20" id="h3-19-20" class="i">+            let response = Err(Error::Abort);
</a><a href="#h3-19-21" id="h3-19-21" class="i">+            self.send(write.from, Message::ClientResponse { id: write.id, response })?;
</a>         }
         for read in std::mem::take(&amp;mut self.role.reads).into_iter().sorted_by_key(|r| r.id) {
<a href="#h3-19-24" id="h3-19-24" class="d">-            self.send(
</a><a href="#h3-19-25" id="h3-19-25" class="d">-                read.from,
</a><a href="#h3-19-26" id="h3-19-26" class="d">-                Message::ClientResponse { id: read.id, response: Err(Error::Abort) },
</a><a href="#h3-19-27" id="h3-19-27" class="d">-            )?;
</a><a href="#h3-19-28" id="h3-19-28" class="i">+            let response = Err(Error::Abort);
</a><a href="#h3-19-29" id="h3-19-29" class="i">+            self.send(read.from, Message::ClientResponse { id: read.id, response })?;
</a>         }
 
         self.log.set_term(term, None)?;
<a href="#h3-19-33" id="h3-19-33" class="d">-        let election_timeout = self.gen_election_timeout();
</a><a href="#h3-19-34" id="h3-19-34" class="i">+        let election_timeout = self.random_election_timeout();
</a>         Ok(self.into_role(Follower::new(None, election_timeout)))
     }
 
<a href="#h3-19-38" id="h3-19-38" class="d">-    /// Processes a message.
</a><a href="#h3-19-39" id="h3-19-39" class="i">+    /// Processes an inbound message.
</a>     fn step(mut self, msg: Envelope) -&gt; Result&lt;Node&gt; {
<a href="#h3-19-41" id="h3-19-41" class="d">-        // Drop messages from past terms.
</a><a href="#h3-19-42" id="h3-19-42" class="i">+        // Past term: drop the message.
</a>         if msg.term &lt; self.term() {
<a href="#h3-19-44" id="h3-19-44" class="d">-            debug!(&quot;Dropping message from past term ({:?})&quot;, msg);
</a><a href="#h3-19-45" id="h3-19-45" class="i">+            debug!(&quot;Dropping message from past term: {msg:?}&quot;);
</a>             return Ok(self.into());
         }
<a href="#h3-19-48" id="h3-19-48" class="d">-
</a><a href="#h3-19-49" id="h3-19-49" class="d">-        // If we receive a message for a future term, become a leaderless
</a><a href="#h3-19-50" id="h3-19-50" class="d">-        // follower in it and step the message. If the message is a Heartbeat or
</a><a href="#h3-19-51" id="h3-19-51" class="d">-        // Append from the leader, stepping it will follow the leader.
</a><a href="#h3-19-52" id="h3-19-52" class="i">+        // Future term: become leaderless follower and step the message.
</a>         if msg.term &gt; self.term() {
             return self.into_follower(msg.term)?.step(msg);
         }
 
         match msg.message {
<a href="#h3-19-58" id="h3-19-58" class="d">-            // There can&#39;t be two leaders in the same term.
</a><a href="#h3-19-59" id="h3-19-59" class="d">-            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a><a href="#h3-19-60" id="h3-19-60" class="d">-                panic!(&quot;saw other leader {} in term {}&quot;, msg.from, msg.term);
</a><a href="#h3-19-61" id="h3-19-61" class="d">-            }
</a><a href="#h3-19-62" id="h3-19-62" class="d">-
</a>             // A follower received our heartbeat and confirms our leadership.
<a href="#h3-19-64" id="h3-19-64" class="i">+            // We may be able to execute new reads, and we may find that the
</a><a href="#h3-19-65" id="h3-19-65" class="i">+            // follower&#39;s log is lagging and requires us to catch it up.
</a>             Message::HeartbeatResponse { match_index, read_seq } =&gt; {
                 let (last_index, _) = self.log.get_last_index();
                 assert!(match_index &lt;= last_index, &quot;future match index&quot;);
<a href="#h3-20" id="h3-20" class="h">@@ -796,53 +801,53 @@ impl RawNode&lt;Leader&gt; {
</a>                     self.maybe_read()?;
                 }
 
<a href="#h3-20-3" id="h3-20-3" class="i">+                // If the follower didn&#39;t match our last index, an append to it
</a><a href="#h3-20-4" id="h3-20-4" class="i">+                // must have failed (or it&#39;s catching up). Probe it to discover
</a><a href="#h3-20-5" id="h3-20-5" class="i">+                // a matching entry and start replicating. Move next_index back
</a><a href="#h3-20-6" id="h3-20-6" class="i">+                // to last_index since the follower just told us it doesn&#39;t have
</a><a href="#h3-20-7" id="h3-20-7" class="i">+                // it (or a previous last_index).
</a>                 if match_index == 0 {
<a href="#h3-20-9" id="h3-20-9" class="d">-                    // If the follower didn&#39;t match our last index, an append to
</a><a href="#h3-20-10" id="h3-20-10" class="d">-                    // it must have failed (or it&#39;s catching up). Probe it to
</a><a href="#h3-20-11" id="h3-20-11" class="d">-                    // discover a matching entry and start replicating. Move
</a><a href="#h3-20-12" id="h3-20-12" class="d">-                    // next_index back to last_index since the follower just
</a><a href="#h3-20-13" id="h3-20-13" class="d">-                    // told us it doesn&#39;t have it.
</a>                     self.progress(msg.from).regress_next(last_index);
                     self.maybe_send_append(msg.from, true)?;
<a href="#h3-20-16" id="h3-20-16" class="d">-                } else if self.progress(msg.from).advance(match_index) {
</a><a href="#h3-20-17" id="h3-20-17" class="d">-                    // If the follower&#39;s match index advanced, an append
</a><a href="#h3-20-18" id="h3-20-18" class="d">-                    // response got lost. Try to commit.
</a><a href="#h3-20-19" id="h3-20-19" class="d">-                    //
</a><a href="#h3-20-20" id="h3-20-20" class="d">-                    // We don&#39;t need to eagerly send any pending entries, since
</a><a href="#h3-20-21" id="h3-20-21" class="d">-                    // any proposals made after this heartbeat was sent should
</a><a href="#h3-20-22" id="h3-20-22" class="d">-                    // have been eagerly replicated in steady state. If not, the
</a><a href="#h3-20-23" id="h3-20-23" class="d">-                    // next heartbeat will trigger a probe above.
</a><a href="#h3-20-24" id="h3-20-24" class="i">+                }
</a><a href="#h3-20-25" id="h3-20-25" class="i">+
</a><a href="#h3-20-26" id="h3-20-26" class="i">+                // If the follower&#39;s match index advances, an append response
</a><a href="#h3-20-27" id="h3-20-27" class="i">+                // got lost. Try to commit and apply.
</a><a href="#h3-20-28" id="h3-20-28" class="i">+                //
</a><a href="#h3-20-29" id="h3-20-29" class="i">+                // We don&#39;t need to eagerly send any pending entries, since any
</a><a href="#h3-20-30" id="h3-20-30" class="i">+                // proposals made after this heartbeat was sent should have been
</a><a href="#h3-20-31" id="h3-20-31" class="i">+                // eagerly replicated in steady state. If not, the next
</a><a href="#h3-20-32" id="h3-20-32" class="i">+                // heartbeat will trigger a probe above.
</a><a href="#h3-20-33" id="h3-20-33" class="i">+                if self.progress(msg.from).advance(match_index) {
</a>                     self.maybe_commit_and_apply()?;
                 }
             }
 
<a href="#h3-20-38" id="h3-20-38" class="d">-            // A follower appended our log entries. Record its progress and
</a><a href="#h3-20-39" id="h3-20-39" class="d">-            // attempt to commit.
</a><a href="#h3-20-40" id="h3-20-40" class="i">+            // A follower appended our log entries (or a probe found a match).
</a><a href="#h3-20-41" id="h3-20-41" class="i">+            // Record its progress and attempt to commit and apply.
</a>             Message::AppendResponse { match_index, reject_index: 0 } if match_index &gt; 0 =&gt; {
                 let (last_index, _) = self.log.get_last_index();
<a href="#h3-20-44" id="h3-20-44" class="d">-                assert!(match_index &lt;= last_index, &quot;follower matched unknown index&quot;);
</a><a href="#h3-20-45" id="h3-20-45" class="i">+                assert!(match_index &lt;= last_index, &quot;future match index&quot;);
</a> 
                 if self.progress(msg.from).advance(match_index) {
                     self.maybe_commit_and_apply()?;
                 }
 
<a href="#h3-20-51" id="h3-20-51" class="d">-                // Eagerly send any further pending entries. The peer may be
</a><a href="#h3-20-52" id="h3-20-52" class="d">-                // lagging behind the leader, and we&#39;re catching it up one
</a><a href="#h3-20-53" id="h3-20-53" class="d">-                // MAX_APPEND_ENTRIES batch at a time. Or we may have received a
</a><a href="#h3-20-54" id="h3-20-54" class="d">-                // probe response at the known match index, in which case
</a><a href="#h3-20-55" id="h3-20-55" class="d">-                // advance() above would have returned false.
</a><a href="#h3-20-56" id="h3-20-56" class="i">+                // Eagerly send any further pending entries. This may be a
</a><a href="#h3-20-57" id="h3-20-57" class="i">+                // successful probe response, or the peer may be lagging and
</a><a href="#h3-20-58" id="h3-20-58" class="i">+                // we&#39;re catching it up one MAX_APPEND_ENTRIES batch at a time.
</a>                 self.maybe_send_append(msg.from, false)?;
             }
 
<a href="#h3-20-62" id="h3-20-62" class="d">-            // A follower rejected the log entries because the base entry in
</a><a href="#h3-20-63" id="h3-20-63" class="d">-            // reject_index did not match its log. Try a previous entry until we
</a><a href="#h3-20-64" id="h3-20-64" class="d">-            // find a common base.
</a><a href="#h3-20-65" id="h3-20-65" class="i">+            // A follower rejected an append because the base entry in
</a><a href="#h3-20-66" id="h3-20-66" class="i">+            // reject_index did not match its log. Probe the previous entry by
</a><a href="#h3-20-67" id="h3-20-67" class="i">+            // sending an empty append until we find a common base.
</a>             //
             // This linear probing can be slow with long divergent logs, but we
<a href="#h3-20-70" id="h3-20-70" class="d">-            // keep it simple.
</a><a href="#h3-20-71" id="h3-20-71" class="i">+            // keep it simple. See also section 5.3 in the Raft paper.
</a>             Message::AppendResponse { reject_index, match_index: 0 } if reject_index &gt; 0 =&gt; {
                 let (last_index, _) = self.log.get_last_index();
<a href="#h3-20-74" id="h3-20-74" class="d">-                assert!(reject_index &lt;= last_index, &quot;follower rejected unknown index&quot;);
</a><a href="#h3-20-75" id="h3-20-75" class="i">+                assert!(reject_index &lt;= last_index, &quot;future reject index&quot;);
</a> 
                 // If the rejected base index is at or below the match index,
                 // the rejection is stale and can be ignored.
<a href="#h3-21" id="h3-21" class="h">@@ -851,64 +856,47 @@ impl RawNode&lt;Leader&gt; {
</a>                 }
 
                 // Probe below the reject index, if we haven&#39;t already moved
<a href="#h3-21-3" id="h3-21-3" class="d">-                // next_index below it.
</a><a href="#h3-21-4" id="h3-21-4" class="i">+                // next_index below it. This avoids sending duplicate probes
</a><a href="#h3-21-5" id="h3-21-5" class="i">+                // (heartbeats will trigger retries if they&#39;re lost).
</a>                 if self.progress(msg.from).regress_next(reject_index) {
                     self.maybe_send_append(msg.from, true)?;
                 }
             }
 
<a href="#h3-21-11" id="h3-21-11" class="i">+            // AppendResponses must set either match_index or reject_index.
</a>             Message::AppendResponse { .. } =&gt; panic!(&quot;invalid message {msg:?}&quot;),
 
<a href="#h3-21-14" id="h3-21-14" class="d">-            // A client submitted a read command. To ensure linearizability, we
</a><a href="#h3-21-15" id="h3-21-15" class="d">-            // must confirm that we are still the leader by sending a heartbeat
</a><a href="#h3-21-16" id="h3-21-16" class="d">-            // with the read&#39;s sequence number and wait for confirmation from a
</a><a href="#h3-21-17" id="h3-21-17" class="d">-            // quorum before executing the read.
</a><a href="#h3-21-18" id="h3-21-18" class="d">-            Message::ClientRequest { id, request: Request::Read(command) } =&gt; {
</a><a href="#h3-21-19" id="h3-21-19" class="d">-                self.role.read_seq += 1;
</a><a href="#h3-21-20" id="h3-21-20" class="d">-                self.role.reads.push_back(Read {
</a><a href="#h3-21-21" id="h3-21-21" class="d">-                    seq: self.role.read_seq,
</a><a href="#h3-21-22" id="h3-21-22" class="d">-                    from: msg.from,
</a><a href="#h3-21-23" id="h3-21-23" class="d">-                    id,
</a><a href="#h3-21-24" id="h3-21-24" class="d">-                    command,
</a><a href="#h3-21-25" id="h3-21-25" class="d">-                });
</a><a href="#h3-21-26" id="h3-21-26" class="d">-                if self.peers.is_empty() {
</a><a href="#h3-21-27" id="h3-21-27" class="d">-                    self.maybe_read()?;
</a><a href="#h3-21-28" id="h3-21-28" class="d">-                }
</a><a href="#h3-21-29" id="h3-21-29" class="d">-                self.heartbeat()?;
</a><a href="#h3-21-30" id="h3-21-30" class="d">-            }
</a><a href="#h3-21-31" id="h3-21-31" class="d">-
</a><a href="#h3-21-32" id="h3-21-32" class="d">-            // A client submitted a write command. Propose it, and track it
</a><a href="#h3-21-33" id="h3-21-33" class="d">-            // until it&#39;s applied and the response is returned to the client.
</a><a href="#h3-21-34" id="h3-21-34" class="i">+            // A client submitted a write request. Propose it, and wait until
</a><a href="#h3-21-35" id="h3-21-35" class="i">+            // it&#39;s replicated and applied to the state machine before returning
</a><a href="#h3-21-36" id="h3-21-36" class="i">+            // the response to the client.
</a>             Message::ClientRequest { id, request: Request::Write(command) } =&gt; {
                 let index = self.propose(Some(command))?;
                 self.role.writes.insert(index, Write { from: msg.from, id });
<a href="#h3-21-40" id="h3-21-40" class="d">-                if self.peers.is_empty() {
</a><a href="#h3-21-41" id="h3-21-41" class="i">+                if self.cluster_size() == 1 {
</a>                     self.maybe_commit_and_apply()?;
                 }
             }
 
<a href="#h3-21-46" id="h3-21-46" class="i">+            // A client submitted a read request. To ensure linearizability, we
</a><a href="#h3-21-47" id="h3-21-47" class="i">+            // must confirm that we are still the leader by sending a heartbeat
</a><a href="#h3-21-48" id="h3-21-48" class="i">+            // with the read&#39;s sequence number and wait for quorum confirmation.
</a><a href="#h3-21-49" id="h3-21-49" class="i">+            Message::ClientRequest { id, request: Request::Read(command) } =&gt; {
</a><a href="#h3-21-50" id="h3-21-50" class="i">+                self.role.read_seq += 1;
</a><a href="#h3-21-51" id="h3-21-51" class="i">+                let read = Read { seq: self.role.read_seq, from: msg.from, id, command };
</a><a href="#h3-21-52" id="h3-21-52" class="i">+                self.role.reads.push_back(read);
</a><a href="#h3-21-53" id="h3-21-53" class="i">+                self.heartbeat()?;
</a><a href="#h3-21-54" id="h3-21-54" class="i">+                if self.cluster_size() == 1 {
</a><a href="#h3-21-55" id="h3-21-55" class="i">+                    self.maybe_read()?;
</a><a href="#h3-21-56" id="h3-21-56" class="i">+                }
</a><a href="#h3-21-57" id="h3-21-57" class="i">+            }
</a><a href="#h3-21-58" id="h3-21-58" class="i">+
</a><a href="#h3-21-59" id="h3-21-59" class="i">+            // A client submitted a status command.
</a>             Message::ClientRequest { id, request: Request::Status } =&gt; {
<a href="#h3-21-61" id="h3-21-61" class="d">-                let status = Status {
</a><a href="#h3-21-62" id="h3-21-62" class="d">-                    leader: self.id,
</a><a href="#h3-21-63" id="h3-21-63" class="d">-                    term: self.term(),
</a><a href="#h3-21-64" id="h3-21-64" class="d">-                    match_index: self
</a><a href="#h3-21-65" id="h3-21-65" class="d">-                        .role
</a><a href="#h3-21-66" id="h3-21-66" class="d">-                        .progress
</a><a href="#h3-21-67" id="h3-21-67" class="d">-                        .iter()
</a><a href="#h3-21-68" id="h3-21-68" class="d">-                        .map(|(id, p)| (*id, p.match_index))
</a><a href="#h3-21-69" id="h3-21-69" class="d">-                        .chain(std::iter::once((self.id, self.log.get_last_index().0)))
</a><a href="#h3-21-70" id="h3-21-70" class="d">-                        .collect(),
</a><a href="#h3-21-71" id="h3-21-71" class="d">-                    commit_index: self.log.get_commit_index().0,
</a><a href="#h3-21-72" id="h3-21-72" class="d">-                    apply_index: self.state.get_applied_index(),
</a><a href="#h3-21-73" id="h3-21-73" class="d">-                    storage: self.log.status()?,
</a><a href="#h3-21-74" id="h3-21-74" class="d">-                };
</a><a href="#h3-21-75" id="h3-21-75" class="d">-                self.send(
</a><a href="#h3-21-76" id="h3-21-76" class="d">-                    msg.from,
</a><a href="#h3-21-77" id="h3-21-77" class="d">-                    Message::ClientResponse { id, response: Ok(Response::Status(status)) },
</a><a href="#h3-21-78" id="h3-21-78" class="d">-                )?;
</a><a href="#h3-21-79" id="h3-21-79" class="i">+                let response = self.status().map(Response::Status);
</a><a href="#h3-21-80" id="h3-21-80" class="i">+                self.send(msg.from, Message::ClientResponse { id, response })?;
</a>             }
 
<a href="#h3-21-83" id="h3-21-83" class="d">-            // Don&#39;t grant other votes in this term.
</a><a href="#h3-21-84" id="h3-21-84" class="i">+            // Don&#39;t grant any votes (we&#39;ve already voted for ourself).
</a>             Message::Campaign { .. } =&gt; {
                 self.send(msg.from, Message::CampaignResponse { vote: false })?
             }
<a href="#h3-22" id="h3-22" class="h">@@ -916,9 +904,13 @@ impl RawNode&lt;Leader&gt; {
</a>             // Votes can come in after we won the election, ignore them.
             Message::CampaignResponse { .. } =&gt; {}
 
<a href="#h3-22-3" id="h3-22-3" class="d">-            // Leaders never proxy client requests, so we don&#39;t expect to see
</a><a href="#h3-22-4" id="h3-22-4" class="d">-            // responses from other nodes.
</a><a href="#h3-22-5" id="h3-22-5" class="d">-            Message::ClientResponse { .. } =&gt; panic!(&quot;Unexpected message {:?}&quot;, msg),
</a><a href="#h3-22-6" id="h3-22-6" class="i">+            // There can&#39;t be another leader in this term.
</a><a href="#h3-22-7" id="h3-22-7" class="i">+            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a><a href="#h3-22-8" id="h3-22-8" class="i">+                panic!(&quot;saw other leader {} in term {}&quot;, msg.from, msg.term);
</a><a href="#h3-22-9" id="h3-22-9" class="i">+            }
</a><a href="#h3-22-10" id="h3-22-10" class="i">+
</a><a href="#h3-22-11" id="h3-22-11" class="i">+            // Leaders don&#39;t proxy client requests.
</a><a href="#h3-22-12" id="h3-22-12" class="i">+            Message::ClientResponse { .. } =&gt; panic!(&quot;unexpected message {msg:?}&quot;),
</a>         }
 
         Ok(self.into())
<a href="#h3-23" id="h3-23" class="h">@@ -929,7 +921,6 @@ impl RawNode&lt;Leader&gt; {
</a>         self.role.since_heartbeat += 1;
         if self.role.since_heartbeat &gt;= self.opts.heartbeat_interval {
             self.heartbeat()?;
<a href="#h3-23-3" id="h3-23-3" class="d">-            self.role.since_heartbeat = 0;
</a>         }
         Ok(self.into())
     }
<a href="#h3-24" id="h3-24" class="h">@@ -939,18 +930,10 @@ impl RawNode&lt;Leader&gt; {
</a>         let (last_index, last_term) = self.log.get_last_index();
         let (commit_index, _) = self.log.get_commit_index();
         let read_seq = self.role.read_seq;
<a href="#h3-24-3" id="h3-24-3" class="i">+        assert_eq!(last_term, self.term(), &quot;leader&#39;s last_term not in current term&quot;);
</a> 
<a href="#h3-24-5" id="h3-24-5" class="d">-        assert_eq!(last_term, self.term(), &quot;leader has stale last_term&quot;);
</a><a href="#h3-24-6" id="h3-24-6" class="d">-
</a><a href="#h3-24-7" id="h3-24-7" class="d">-        self.broadcast(Message::Heartbeat { last_index, commit_index, read_seq })?;
</a><a href="#h3-24-8" id="h3-24-8" class="d">-        // NB: We don&#39;t reset self.since_heartbeat here, because we want to send
</a><a href="#h3-24-9" id="h3-24-9" class="d">-        // periodic heartbeats regardless of any on-demand heartbeats.
</a><a href="#h3-24-10" id="h3-24-10" class="d">-        Ok(())
</a><a href="#h3-24-11" id="h3-24-11" class="d">-    }
</a><a href="#h3-24-12" id="h3-24-12" class="d">-
</a><a href="#h3-24-13" id="h3-24-13" class="d">-    /// Returns a mutable borrow of a node&#39;s progress.
</a><a href="#h3-24-14" id="h3-24-14" class="d">-    fn progress(&amp;mut self, id: NodeID) -&gt; &amp;mut Progress {
</a><a href="#h3-24-15" id="h3-24-15" class="d">-        self.role.progress.get_mut(&amp;id).expect(&quot;unknown node&quot;)
</a><a href="#h3-24-16" id="h3-24-16" class="i">+        self.role.since_heartbeat = 0;
</a><a href="#h3-24-17" id="h3-24-17" class="i">+        self.broadcast(Message::Heartbeat { last_index, commit_index, read_seq })
</a>     }
 
     /// Proposes a command for consensus by appending it to our log and
<a href="#h3-25" id="h3-25" class="h">@@ -959,10 +942,9 @@ impl RawNode&lt;Leader&gt; {
</a>     fn propose(&amp;mut self, command: Option&lt;Vec&lt;u8&gt;&gt;) -&gt; Result&lt;Index&gt; {
         let index = self.log.append(command)?;
         for peer in self.peers.iter().copied().sorted() {
<a href="#h3-25-3" id="h3-25-3" class="d">-            // Eagerly send the entry to the peer, but only if it is in steady
</a><a href="#h3-25-4" id="h3-25-4" class="d">-            // state where we&#39;ve already sent the previous entries. Otherwise,
</a><a href="#h3-25-5" id="h3-25-5" class="d">-            // we&#39;re probing a lagging or divergent peer, and there&#39;s no point
</a><a href="#h3-25-6" id="h3-25-6" class="d">-            // sending this entry since it will likely be rejected.
</a><a href="#h3-25-7" id="h3-25-7" class="i">+            // Eagerly send the entry to the peer if it&#39;s in steady state and
</a><a href="#h3-25-8" id="h3-25-8" class="i">+            // we&#39;ve sent all previous entries. Otherwise, the peer is lagging
</a><a href="#h3-25-9" id="h3-25-9" class="i">+            // and we&#39;re probing past entries for a match.
</a>             if index == self.progress(peer).next_index {
                 self.maybe_send_append(peer, false)?;
             }
<a href="#h3-26" id="h3-26" class="h">@@ -970,39 +952,35 @@ impl RawNode&lt;Leader&gt; {
</a>         Ok(index)
     }
 
<a href="#h3-26-3" id="h3-26-3" class="d">-    /// Commits any new log entries that have been replicated to a quorum, and
</a><a href="#h3-26-4" id="h3-26-4" class="d">-    /// applies them to the state machine.
</a><a href="#h3-26-5" id="h3-26-5" class="i">+    /// Commits new entries that have been replicated to a quorum and applies
</a><a href="#h3-26-6" id="h3-26-6" class="i">+    /// them to the state machine, returning results to clients.
</a>     fn maybe_commit_and_apply(&amp;mut self) -&gt; Result&lt;Index&gt; {
<a href="#h3-26-8" id="h3-26-8" class="d">-        // Determine the new commit index.
</a><a href="#h3-26-9" id="h3-26-9" class="i">+        // Determine the new commit index by quorum.
</a><a href="#h3-26-10" id="h3-26-10" class="i">+        let (last_index, _) = self.log.get_last_index();
</a>         let quorum_index = self.quorum_value(
<a href="#h3-26-12" id="h3-26-12" class="d">-            self.role
</a><a href="#h3-26-13" id="h3-26-13" class="d">-                .progress
</a><a href="#h3-26-14" id="h3-26-14" class="d">-                .values()
</a><a href="#h3-26-15" id="h3-26-15" class="d">-                .map(|p| p.match_index)
</a><a href="#h3-26-16" id="h3-26-16" class="d">-                .chain(std::iter::once(self.log.get_last_index().0))
</a><a href="#h3-26-17" id="h3-26-17" class="d">-                .collect(),
</a><a href="#h3-26-18" id="h3-26-18" class="i">+            self.role.progress.values().map(|p| p.match_index).chain([last_index]).collect(),
</a>         );
 
         // If the commit index doesn&#39;t advance, do nothing. We don&#39;t assert on
         // this, since the quorum value may regress e.g. following a restart or
<a href="#h3-26-23" id="h3-26-23" class="d">-        // leader change where followers are initialized with log index 0.
</a><a href="#h3-26-24" id="h3-26-24" class="d">-        let (mut commit_index, old_commit_term) = self.log.get_commit_index();
</a><a href="#h3-26-25" id="h3-26-25" class="d">-        if quorum_index &lt;= commit_index {
</a><a href="#h3-26-26" id="h3-26-26" class="d">-            return Ok(commit_index);
</a><a href="#h3-26-27" id="h3-26-27" class="d">-        }
</a><a href="#h3-26-28" id="h3-26-28" class="d">-
</a><a href="#h3-26-29" id="h3-26-29" class="d">-        // We can only safely commit an entry from our own term (see figure 8 in
</a><a href="#h3-26-30" id="h3-26-30" class="d">-        // Raft paper).
</a><a href="#h3-26-31" id="h3-26-31" class="d">-        commit_index = match self.log.get(quorum_index)? {
</a><a href="#h3-26-32" id="h3-26-32" class="d">-            Some(entry) if entry.term == self.term() =&gt; quorum_index,
</a><a href="#h3-26-33" id="h3-26-33" class="d">-            Some(_) =&gt; return Ok(commit_index),
</a><a href="#h3-26-34" id="h3-26-34" class="d">-            None =&gt; panic!(&quot;missing commit index {quorum_index} missing&quot;),
</a><a href="#h3-26-35" id="h3-26-35" class="d">-        };
</a><a href="#h3-26-36" id="h3-26-36" class="i">+        // leader change where followers are initialized with match index 0.
</a><a href="#h3-26-37" id="h3-26-37" class="i">+        let (old_index, old_term) = self.log.get_commit_index();
</a><a href="#h3-26-38" id="h3-26-38" class="i">+        if quorum_index &lt;= old_index {
</a><a href="#h3-26-39" id="h3-26-39" class="i">+            return Ok(old_index);
</a><a href="#h3-26-40" id="h3-26-40" class="i">+        }
</a><a href="#h3-26-41" id="h3-26-41" class="i">+
</a><a href="#h3-26-42" id="h3-26-42" class="i">+        // We can only safely commit an entry from our own term (see section
</a><a href="#h3-26-43" id="h3-26-43" class="i">+        // 5.4.2 in Raft paper).
</a><a href="#h3-26-44" id="h3-26-44" class="i">+        match self.log.get(quorum_index)? {
</a><a href="#h3-26-45" id="h3-26-45" class="i">+            Some(entry) if entry.term == self.term() =&gt; {}
</a><a href="#h3-26-46" id="h3-26-46" class="i">+            Some(_) =&gt; return Ok(old_index),
</a><a href="#h3-26-47" id="h3-26-47" class="i">+            None =&gt; panic!(&quot;commit index {quorum_index} missing&quot;),
</a><a href="#h3-26-48" id="h3-26-48" class="i">+        }
</a> 
<a href="#h3-26-50" id="h3-26-50" class="d">-        // Commit the new entries.
</a><a href="#h3-26-51" id="h3-26-51" class="d">-        self.log.commit(commit_index)?;
</a><a href="#h3-26-52" id="h3-26-52" class="i">+        // Commit entries.
</a><a href="#h3-26-53" id="h3-26-53" class="i">+        self.log.commit(quorum_index)?;
</a> 
<a href="#h3-26-55" id="h3-26-55" class="d">-        // Apply entries and respond to client writers.
</a><a href="#h3-26-56" id="h3-26-56" class="i">+        // Apply entries and respond to clients.
</a>         let term = self.term();
         let mut iter = self.log.scan_apply(self.state.get_applied_index());
         while let Some(entry) = iter.next().transpose()? {
<a href="#h3-27" id="h3-27" class="h">@@ -1012,22 +990,21 @@ impl RawNode&lt;Leader&gt; {
</a> 
             if let Some(Write { id, from: to }) = write {
                 let message = Message::ClientResponse { id, response: result.map(Response::Write) };
<a href="#h3-27-3" id="h3-27-3" class="d">-                Self::send_with(&amp;self.node_tx, Envelope { from: self.id, term, to, message })?;
</a><a href="#h3-27-4" id="h3-27-4" class="i">+                Self::send_with(&amp;self.tx, Envelope { from: self.id, term, to, message })?;
</a>             }
         }
         drop(iter);
 
         // If the commit term changed, there may be pending reads waiting for us
<a href="#h3-27-10" id="h3-27-10" class="d">-        // to commit an entry from our own term. Execute them.
</a><a href="#h3-27-11" id="h3-27-11" class="d">-        if old_commit_term != self.term() {
</a><a href="#h3-27-12" id="h3-27-12" class="i">+        // to commit and apply an entry from our own term. Execute them.
</a><a href="#h3-27-13" id="h3-27-13" class="i">+        if old_term != self.term() {
</a>             self.maybe_read()?;
         }
 
<a href="#h3-27-17" id="h3-27-17" class="d">-        Ok(commit_index)
</a><a href="#h3-27-18" id="h3-27-18" class="i">+        Ok(quorum_index)
</a>     }
 
<a href="#h3-27-21" id="h3-27-21" class="d">-    /// Executes any pending read requests that are now ready after quorum
</a><a href="#h3-27-22" id="h3-27-22" class="d">-    /// confirmation of their sequence number.
</a><a href="#h3-27-23" id="h3-27-23" class="i">+    /// Executes any ready read requests (with confirmed sequence numbers).
</a>     fn maybe_read(&amp;mut self) -&gt; Result&lt;()&gt; {
         if self.role.reads.is_empty() {
             return Ok(());
<a href="#h3-28" id="h3-28" class="h">@@ -1035,8 +1012,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
         // It&#39;s only safe to read if we&#39;ve committed and applied an entry from
         // our own term (the leader appends an entry when elected). Otherwise we
<a href="#h3-28-3" id="h3-28-3" class="d">-        // may be behind on application and serve stale reads, violating
</a><a href="#h3-28-4" id="h3-28-4" class="d">-        // linearizability.
</a><a href="#h3-28-5" id="h3-28-5" class="i">+        // may be behind on application and serve stale reads.
</a>         let (commit_index, commit_term) = self.log.get_commit_index();
         let applied_index = self.state.get_applied_index();
         if commit_term &lt; self.term() || applied_index &lt; commit_index {
<a href="#h3-29" id="h3-29" class="h">@@ -1044,35 +1020,35 @@ impl RawNode&lt;Leader&gt; {
</a>         }
 
         // Determine the maximum read sequence confirmed by quorum.
<a href="#h3-29-3" id="h3-29-3" class="d">-        let read_seq = self.quorum_value(
</a><a href="#h3-29-4" id="h3-29-4" class="d">-            self.role
</a><a href="#h3-29-5" id="h3-29-5" class="d">-                .progress
</a><a href="#h3-29-6" id="h3-29-6" class="d">-                .values()
</a><a href="#h3-29-7" id="h3-29-7" class="d">-                .map(|p| p.read_seq)
</a><a href="#h3-29-8" id="h3-29-8" class="d">-                .chain(std::iter::once(self.role.read_seq))
</a><a href="#h3-29-9" id="h3-29-9" class="d">-                .collect(),
</a><a href="#h3-29-10" id="h3-29-10" class="i">+        let quorum_read_seq = self.quorum_value(
</a><a href="#h3-29-11" id="h3-29-11" class="i">+            self.role.progress.values().map(|p| p.read_seq).chain([self.role.read_seq]).collect(),
</a>         );
 
<a href="#h3-29-14" id="h3-29-14" class="d">-        // Execute the ready reads.
</a><a href="#h3-29-15" id="h3-29-15" class="i">+        // Execute ready reads. The VecDeque is ordered by read_seq, so we
</a><a href="#h3-29-16" id="h3-29-16" class="i">+        // can keep pulling until we hit quorum_read_seq.
</a>         while let Some(read) = self.role.reads.front() {
<a href="#h3-29-18" id="h3-29-18" class="d">-            if read.seq &gt; read_seq {
</a><a href="#h3-29-19" id="h3-29-19" class="i">+            if read.seq &gt; quorum_read_seq {
</a>                 break;
             }
             let read = self.role.reads.pop_front().unwrap();
<a href="#h3-29-23" id="h3-29-23" class="d">-            let result = self.state.read(read.command);
</a><a href="#h3-29-24" id="h3-29-24" class="d">-            self.send(
</a><a href="#h3-29-25" id="h3-29-25" class="d">-                read.from,
</a><a href="#h3-29-26" id="h3-29-26" class="d">-                Message::ClientResponse { id: read.id, response: result.map(Response::Read) },
</a><a href="#h3-29-27" id="h3-29-27" class="d">-            )?;
</a><a href="#h3-29-28" id="h3-29-28" class="i">+            let response = self.state.read(read.command).map(Response::Read);
</a><a href="#h3-29-29" id="h3-29-29" class="i">+            self.send(read.from, Message::ClientResponse { id: read.id, response })?;
</a>         }
<a href="#h3-29-31" id="h3-29-31" class="d">-
</a>         Ok(())
     }
 
<a href="#h3-29-35" id="h3-29-35" class="d">-    // Sends pending log entries to a peer, according to its next_index. Does
</a><a href="#h3-29-36" id="h3-29-36" class="d">-    // not send an append if the peer is already caught up. Sends an empty
</a><a href="#h3-29-37" id="h3-29-37" class="d">-    // append with the last entry as a base if all pending entries are already
</a><a href="#h3-29-38" id="h3-29-38" class="d">-    // in flight, to probe whether they&#39;ve made it to the follower or not.
</a><a href="#h3-29-39" id="h3-29-39" class="i">+    // Sends a batch of pending log entries to a follower in the
</a><a href="#h3-29-40" id="h3-29-40" class="i">+    // [next_index,last_index] range, limited by max_append_entries.
</a><a href="#h3-29-41" id="h3-29-41" class="i">+    //
</a><a href="#h3-29-42" id="h3-29-42" class="i">+    // If probe is true, an empty append probe with base_index of next_index-1
</a><a href="#h3-29-43" id="h3-29-43" class="i">+    // is sent to check if the base entry is present in the follower&#39;s log. If
</a><a href="#h3-29-44" id="h3-29-44" class="i">+    // it is, the actual entries are sent next -- otherwise, next_index is
</a><a href="#h3-29-45" id="h3-29-45" class="i">+    // decremented and another probe is sent until a match is found. See section
</a><a href="#h3-29-46" id="h3-29-46" class="i">+    // 5.3 in the Raft paper.
</a><a href="#h3-29-47" id="h3-29-47" class="i">+    //
</a><a href="#h3-29-48" id="h3-29-48" class="i">+    // The probe is skipped if the follower is up-to-date (according to
</a><a href="#h3-29-49" id="h3-29-49" class="i">+    // match_index and last_index). If the probe&#39;s base_index has already been
</a><a href="#h3-29-50" id="h3-29-50" class="i">+    // confirmed via match_index, an actual append is sent instead.
</a>     fn maybe_send_append(&amp;mut self, peer: NodeID, mut probe: bool) -&gt; Result&lt;()&gt; {
         let (last_index, _) = self.log.get_last_index();
         let progress = self.role.progress.get_mut(&amp;peer).expect(&quot;unknown node&quot;);
<a href="#h3-30" id="h3-30" class="h">@@ -1081,20 +1057,18 @@ impl RawNode&lt;Leader&gt; {
</a>         assert!(progress.match_index &lt;= last_index, &quot;invalid match_index &gt; last_index&quot;);
         assert!(progress.next_index &lt;= last_index + 1, &quot;invalid next_index &gt; last_index + 1&quot;);
 
<a href="#h3-30-3" id="h3-30-3" class="d">-        // If the peer is already caught up, there&#39;s no point sending an append.
</a><a href="#h3-30-4" id="h3-30-4" class="i">+        // If the peer is caught up, there&#39;s no point sending an append.
</a>         if progress.match_index == last_index {
             return Ok(());
         }
 
<a href="#h3-30-9" id="h3-30-9" class="d">-        // If a probe was requested, but next_index is immediately after
</a><a href="#h3-30-10" id="h3-30-10" class="d">-        // match_index (even when 0), there is no point in probing because the
</a><a href="#h3-30-11" id="h3-30-11" class="d">-        // entry must be accepted. Send the entries instead.
</a><a href="#h3-30-12" id="h3-30-12" class="d">-        if probe &amp;&amp; progress.next_index == progress.match_index + 1 {
</a><a href="#h3-30-13" id="h3-30-13" class="d">-            probe = false;
</a><a href="#h3-30-14" id="h3-30-14" class="d">-        }
</a><a href="#h3-30-15" id="h3-30-15" class="i">+        // If a probe was requested, but the base_index has already been
</a><a href="#h3-30-16" id="h3-30-16" class="i">+        // confirmed via match_index, there is no point in probing. Just send
</a><a href="#h3-30-17" id="h3-30-17" class="i">+        // the entries instead.
</a><a href="#h3-30-18" id="h3-30-18" class="i">+        probe = probe &amp;&amp; progress.next_index &gt; progress.match_index + 1;
</a> 
<a href="#h3-30-20" id="h3-30-20" class="d">-        // If there are no pending entries and this is not a probe, there&#39;s
</a><a href="#h3-30-21" id="h3-30-21" class="d">-        // nothing more to send.
</a><a href="#h3-30-22" id="h3-30-22" class="i">+        // If there are no pending entries, and this is not a probe, there&#39;s
</a><a href="#h3-30-23" id="h3-30-23" class="i">+        // nothing more to send until we get a response from the follower.
</a>         if progress.next_index &gt; last_index &amp;&amp; !probe {
             return Ok(());
         }
<a href="#h3-31" id="h3-31" class="h">@@ -1105,57 +1079,64 @@ impl RawNode&lt;Leader&gt; {
</a>             1 =&gt; (0, 0),
             next =&gt; self.log.get(next - 1)?.map(|e| (e.index, e.term)).expect(&quot;missing base entry&quot;),
         };
<a href="#h3-31-3" id="h3-31-3" class="d">-
</a><a href="#h3-31-4" id="h3-31-4" class="d">-        let entries = if !probe {
</a><a href="#h3-31-5" id="h3-31-5" class="d">-            self.log
</a><a href="#h3-31-6" id="h3-31-6" class="i">+        let entries = match probe {
</a><a href="#h3-31-7" id="h3-31-7" class="i">+            false =&gt; self
</a><a href="#h3-31-8" id="h3-31-8" class="i">+                .log
</a>                 .scan(progress.next_index..)
                 .take(self.opts.max_append_entries)
<a href="#h3-31-11" id="h3-31-11" class="d">-                .collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h3-31-12" id="h3-31-12" class="d">-        } else {
</a><a href="#h3-31-13" id="h3-31-13" class="d">-            Vec::new()
</a><a href="#h3-31-14" id="h3-31-14" class="i">+                .collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h3-31-15" id="h3-31-15" class="i">+            true =&gt; Vec::new(),
</a>         };
 
         // Optimistically assume the entries will be accepted by the follower,
<a href="#h3-31-19" id="h3-31-19" class="d">-        // and bump the next_index to avoid resending them until a response.
</a><a href="#h3-31-20" id="h3-31-20" class="i">+        // and bump next_index to avoid resending them until a response.
</a>         if let Some(last) = entries.last() {
             progress.next_index = last.index + 1;
         }
 
         debug!(&quot;Replicating {} entries with base {base_index} to {peer}&quot;, entries.len());
<a href="#h3-31-26" id="h3-31-26" class="d">-        self.send(peer, Message::Append { base_index, base_term, entries })?;
</a><a href="#h3-31-27" id="h3-31-27" class="d">-        Ok(())
</a><a href="#h3-31-28" id="h3-31-28" class="i">+        self.send(peer, Message::Append { base_index, base_term, entries })
</a><a href="#h3-31-29" id="h3-31-29" class="i">+    }
</a><a href="#h3-31-30" id="h3-31-30" class="i">+
</a><a href="#h3-31-31" id="h3-31-31" class="i">+    /// Generates cluster status.
</a><a href="#h3-31-32" id="h3-31-32" class="i">+    fn status(&amp;mut self) -&gt; Result&lt;Status&gt; {
</a><a href="#h3-31-33" id="h3-31-33" class="i">+        Ok(Status {
</a><a href="#h3-31-34" id="h3-31-34" class="i">+            leader: self.id,
</a><a href="#h3-31-35" id="h3-31-35" class="i">+            term: self.term(),
</a><a href="#h3-31-36" id="h3-31-36" class="i">+            match_index: self
</a><a href="#h3-31-37" id="h3-31-37" class="i">+                .role
</a><a href="#h3-31-38" id="h3-31-38" class="i">+                .progress
</a><a href="#h3-31-39" id="h3-31-39" class="i">+                .iter()
</a><a href="#h3-31-40" id="h3-31-40" class="i">+                .map(|(id, p)| (*id, p.match_index))
</a><a href="#h3-31-41" id="h3-31-41" class="i">+                .chain(std::iter::once((self.id, self.log.get_last_index().0)))
</a><a href="#h3-31-42" id="h3-31-42" class="i">+                .collect(),
</a><a href="#h3-31-43" id="h3-31-43" class="i">+            commit_index: self.log.get_commit_index().0,
</a><a href="#h3-31-44" id="h3-31-44" class="i">+            applied_index: self.state.get_applied_index(),
</a><a href="#h3-31-45" id="h3-31-45" class="i">+            storage: self.log.status()?,
</a><a href="#h3-31-46" id="h3-31-46" class="i">+        })
</a><a href="#h3-31-47" id="h3-31-47" class="i">+    }
</a><a href="#h3-31-48" id="h3-31-48" class="i">+
</a><a href="#h3-31-49" id="h3-31-49" class="i">+    /// Returns a mutable borrow of a node&#39;s progress. Convenience method.
</a><a href="#h3-31-50" id="h3-31-50" class="i">+    fn progress(&amp;mut self, id: NodeID) -&gt; &amp;mut Progress {
</a><a href="#h3-31-51" id="h3-31-51" class="i">+        self.role.progress.get_mut(&amp;id).expect(&quot;unknown node&quot;)
</a>     }
 }
 
 #[cfg(test)]
 mod tests {
     use super::*;
<a href="#h3-31-58" id="h3-31-58" class="d">-    use crate::encoding::{bincode, Value as _};
</a><a href="#h3-31-59" id="h3-31-59" class="i">+    use crate::encoding::Value as _;
</a>     use crate::raft::state::test::{self as teststate, KVCommand, KVResponse};
<a href="#h3-31-61" id="h3-31-61" class="d">-    use crate::raft::{
</a><a href="#h3-31-62" id="h3-31-62" class="d">-        Entry, Request, RequestID, Response, ELECTION_TIMEOUT_RANGE, HEARTBEAT_INTERVAL,
</a><a href="#h3-31-63" id="h3-31-63" class="d">-        MAX_APPEND_ENTRIES,
</a><a href="#h3-31-64" id="h3-31-64" class="d">-    };
</a><a href="#h3-31-65" id="h3-31-65" class="i">+    use crate::raft::Entry;
</a>     use crate::storage;
     use crossbeam::channel::Receiver;
     use std::borrow::Borrow;
<a href="#h3-31-69" id="h3-31-69" class="d">-    use std::collections::{HashMap, HashSet};
</a>     use std::error::Error;
<a href="#h3-31-71" id="h3-31-71" class="i">+    use std::fmt::Write as _;
</a>     use std::result::Result;
     use test_case::test_case;
     use test_each_file::test_each_path;
 
<a href="#h3-31-76" id="h3-31-76" class="d">-    /// Test helpers for RawNode.
</a><a href="#h3-31-77" id="h3-31-77" class="d">-    impl RawNode&lt;Follower&gt; {
</a><a href="#h3-31-78" id="h3-31-78" class="d">-        /// Creates a noop node, with a noop state machine and transport.
</a><a href="#h3-31-79" id="h3-31-79" class="d">-        fn new_noop(id: NodeID, peers: HashSet&lt;NodeID&gt;) -&gt; Self {
</a><a href="#h3-31-80" id="h3-31-80" class="d">-            let log = Log::new(storage::Memory::new()).expect(&quot;log failed&quot;);
</a><a href="#h3-31-81" id="h3-31-81" class="d">-            let state = teststate::Noop::new();
</a><a href="#h3-31-82" id="h3-31-82" class="d">-            let (node_tx, _) = crossbeam::channel::unbounded();
</a><a href="#h3-31-83" id="h3-31-83" class="d">-            RawNode::new(id, peers, log, state, node_tx, Options::default()).expect(&quot;node failed&quot;)
</a><a href="#h3-31-84" id="h3-31-84" class="d">-        }
</a><a href="#h3-31-85" id="h3-31-85" class="d">-    }
</a><a href="#h3-31-86" id="h3-31-86" class="d">-
</a>     // Run goldenscript tests in src/raft/testscripts/node.
     test_each_path! { in &quot;src/raft/testscripts/node&quot; as scripts =&gt; test_goldenscript }
 
<a href="#h3-32" id="h3-32" class="h">@@ -1191,7 +1172,45 @@ mod tests {
</a>         node.quorum_value(values)
     }
 
<a href="#h3-32-3" id="h3-32-3" class="d">-    /// Runs Raft goldenscript tests. For available commands, see run().
</a><a href="#h3-32-4" id="h3-32-4" class="i">+    /// Test helpers for RawNode.
</a><a href="#h3-32-5" id="h3-32-5" class="i">+    impl RawNode&lt;Follower&gt; {
</a><a href="#h3-32-6" id="h3-32-6" class="i">+        /// Creates a noop node, with a noop state machine and transport.
</a><a href="#h3-32-7" id="h3-32-7" class="i">+        fn new_noop(id: NodeID, peers: HashSet&lt;NodeID&gt;) -&gt; Self {
</a><a href="#h3-32-8" id="h3-32-8" class="i">+            let log = Log::new(storage::Memory::new()).expect(&quot;log failed&quot;);
</a><a href="#h3-32-9" id="h3-32-9" class="i">+            let state = teststate::Noop::new();
</a><a href="#h3-32-10" id="h3-32-10" class="i">+            let (tx, _) = crossbeam::channel::unbounded();
</a><a href="#h3-32-11" id="h3-32-11" class="i">+            RawNode::new(id, peers, log, state, tx, Options::default()).expect(&quot;node failed&quot;)
</a><a href="#h3-32-12" id="h3-32-12" class="i">+        }
</a><a href="#h3-32-13" id="h3-32-13" class="i">+    }
</a><a href="#h3-32-14" id="h3-32-14" class="i">+
</a><a href="#h3-32-15" id="h3-32-15" class="i">+    /// Test helpers for Node.
</a><a href="#h3-32-16" id="h3-32-16" class="i">+    impl Node {
</a><a href="#h3-32-17" id="h3-32-17" class="i">+        fn get_applied_index(&amp;self) -&gt; Index {
</a><a href="#h3-32-18" id="h3-32-18" class="i">+            with_rawnode!(ref self, |n| n.state.get_applied_index())
</a><a href="#h3-32-19" id="h3-32-19" class="i">+        }
</a><a href="#h3-32-20" id="h3-32-20" class="i">+
</a><a href="#h3-32-21" id="h3-32-21" class="i">+        fn get_commit_index(&amp;self) -&gt; (Index, Term) {
</a><a href="#h3-32-22" id="h3-32-22" class="i">+            with_rawnode!(ref self, |n| n.log.get_commit_index())
</a><a href="#h3-32-23" id="h3-32-23" class="i">+        }
</a><a href="#h3-32-24" id="h3-32-24" class="i">+
</a><a href="#h3-32-25" id="h3-32-25" class="i">+        fn get_last_index(&amp;self) -&gt; (Index, Term) {
</a><a href="#h3-32-26" id="h3-32-26" class="i">+            with_rawnode!(ref self, |n| n.log.get_last_index())
</a><a href="#h3-32-27" id="h3-32-27" class="i">+        }
</a><a href="#h3-32-28" id="h3-32-28" class="i">+
</a><a href="#h3-32-29" id="h3-32-29" class="i">+        fn get_term_vote(&amp;self) -&gt; (Term, Option&lt;NodeID&gt;) {
</a><a href="#h3-32-30" id="h3-32-30" class="i">+            with_rawnode!(ref self, |n| n.log.get_term())
</a><a href="#h3-32-31" id="h3-32-31" class="i">+        }
</a><a href="#h3-32-32" id="h3-32-32" class="i">+
</a><a href="#h3-32-33" id="h3-32-33" class="i">+        fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; crate::error::Result&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h3-32-34" id="h3-32-34" class="i">+            with_rawnode!(ref self, |n| n.state.read(command))
</a><a href="#h3-32-35" id="h3-32-35" class="i">+        }
</a><a href="#h3-32-36" id="h3-32-36" class="i">+
</a><a href="#h3-32-37" id="h3-32-37" class="i">+        fn scan_log(&amp;mut self) -&gt; crate::error::Result&lt;Vec&lt;Entry&gt;&gt; {
</a><a href="#h3-32-38" id="h3-32-38" class="i">+            with_rawnode!(ref mut self, |n| n.log.scan(..).collect())
</a><a href="#h3-32-39" id="h3-32-39" class="i">+        }
</a><a href="#h3-32-40" id="h3-32-40" class="i">+    }
</a><a href="#h3-32-41" id="h3-32-41" class="i">+
</a><a href="#h3-32-42" id="h3-32-42" class="i">+    /// Runs Raft goldenscript tests. See run() for available commands.
</a>     #[derive(Default)]
     struct TestRunner {
         /// IDs of all cluster nodes, in order.
<a href="#h3-33" id="h3-33" class="h">@@ -1204,7 +1223,8 @@ mod tests {
</a>         nodes_pending: HashMap&lt;NodeID, Vec&lt;Envelope&gt;&gt;,
         /// Applied log entries for each node, after state machine application.
         applied_rx: HashMap&lt;NodeID, Receiver&lt;Entry&gt;&gt;,
<a href="#h3-33-3" id="h3-33-3" class="d">-        /// Network partitions, sender  receivers.
</a><a href="#h3-33-4" id="h3-33-4" class="i">+        /// Network partitions (sender  receivers). A symmetric (bidirectional)
</a><a href="#h3-33-5" id="h3-33-5" class="i">+        /// partition needs an entry from each side.
</a>         disconnected: HashMap&lt;NodeID, HashSet&lt;NodeID&gt;&gt;,
         /// In-flight client requests.
         requests: HashMap&lt;RequestID, Request&gt;,
<a href="#h3-34" id="h3-34" class="h">@@ -1218,40 +1238,33 @@ mod tests {
</a>             let mut output = String::new();
             match command.name.as_str() {
                 // campaign [ID...]
<a href="#h3-34-3" id="h3-34-3" class="d">-                //
</a><a href="#h3-34-4" id="h3-34-4" class="d">-                // The given nodes transition to candidates and campaign.
</a><a href="#h3-34-5" id="h3-34-5" class="i">+                // Transition the given nodes to candidates and campaign.
</a>                 &quot;campaign&quot; =&gt; {
                     let ids = self.parse_ids_or_all(&amp;command.args)?;
                     self.campaign(&amp;ids, &amp;mut output)?;
                 }
 
                 // cluster nodes=N [leader=ID] [heartbeat_interval=N] [election_timeout=N] [max_append_entries=N]
<a href="#h3-34-12" id="h3-34-12" class="d">-                //
</a>                 // Creates a new Raft cluster.
                 &quot;cluster&quot; =&gt; {
<a href="#h3-34-15" id="h3-34-15" class="i">+                    let mut opts = Options::default();
</a>                     let mut args = command.consume_args();
                     let nodes = args.lookup_parse(&quot;nodes&quot;)?.unwrap_or(0);
                     let leader = args.lookup_parse(&quot;leader&quot;)?;
<a href="#h3-34-19" id="h3-34-19" class="d">-                    let heartbeat_interval =
</a><a href="#h3-34-20" id="h3-34-20" class="d">-                        args.lookup_parse(&quot;heartbeat_interval&quot;)?.unwrap_or(HEARTBEAT_INTERVAL);
</a><a href="#h3-34-21" id="h3-34-21" class="d">-                    let election_timeout = args
</a><a href="#h3-34-22" id="h3-34-22" class="d">-                        .lookup_parse(&quot;election_timeout&quot;)?
</a><a href="#h3-34-23" id="h3-34-23" class="d">-                        .unwrap_or(ELECTION_TIMEOUT_RANGE.start);
</a><a href="#h3-34-24" id="h3-34-24" class="d">-                    let max_append_entries =
</a><a href="#h3-34-25" id="h3-34-25" class="d">-                        args.lookup_parse(&quot;max_append_entries&quot;)?.unwrap_or(MAX_APPEND_ENTRIES);
</a><a href="#h3-34-26" id="h3-34-26" class="i">+                    if let Some(heartbeat_interval) = args.lookup_parse(&quot;heartbeat_interval&quot;)? {
</a><a href="#h3-34-27" id="h3-34-27" class="i">+                        opts.heartbeat_interval = heartbeat_interval;
</a><a href="#h3-34-28" id="h3-34-28" class="i">+                    };
</a><a href="#h3-34-29" id="h3-34-29" class="i">+                    if let Some(election_timeout) = args.lookup_parse(&quot;election_timeout&quot;)? {
</a><a href="#h3-34-30" id="h3-34-30" class="i">+                        opts.election_timeout_range = election_timeout..election_timeout + 1;
</a><a href="#h3-34-31" id="h3-34-31" class="i">+                    }
</a><a href="#h3-34-32" id="h3-34-32" class="i">+                    if let Some(max_append_entries) = args.lookup_parse(&quot;max_append_entries&quot;)? {
</a><a href="#h3-34-33" id="h3-34-33" class="i">+                        opts.max_append_entries = max_append_entries;
</a><a href="#h3-34-34" id="h3-34-34" class="i">+                    }
</a>                     args.reject_rest()?;
<a href="#h3-34-36" id="h3-34-36" class="d">-                    self.cluster(
</a><a href="#h3-34-37" id="h3-34-37" class="d">-                        nodes,
</a><a href="#h3-34-38" id="h3-34-38" class="d">-                        leader,
</a><a href="#h3-34-39" id="h3-34-39" class="d">-                        heartbeat_interval,
</a><a href="#h3-34-40" id="h3-34-40" class="d">-                        election_timeout,
</a><a href="#h3-34-41" id="h3-34-41" class="d">-                        max_append_entries,
</a><a href="#h3-34-42" id="h3-34-42" class="d">-                        &amp;mut output,
</a><a href="#h3-34-43" id="h3-34-43" class="d">-                    )?;
</a><a href="#h3-34-44" id="h3-34-44" class="i">+                    self.cluster(nodes, leader, opts, &amp;mut output)?;
</a>                 }
 
                 // deliver [from=ID] [ID...]
<a href="#h3-34-48" id="h3-34-48" class="d">-                //
</a>                 // Delivers (steps) pending messages to the given nodes. If from
                 // is given, only messages from the given node is delivered, the
                 // others are left pending.
<a href="#h3-35" id="h3-35" class="h">@@ -1263,7 +1276,6 @@ mod tests {
</a>                 }
 
                 // get ID KEY
<a href="#h3-35-3" id="h3-35-3" class="d">-                //
</a>                 // Sends a client request to the given node to read the given
                 // key from the state machine (key/value store).
                 &quot;get&quot; =&gt; {
<a href="#h3-36" id="h3-36" class="h">@@ -1276,7 +1288,6 @@ mod tests {
</a>                 }
 
                 // heal [ID...]
<a href="#h3-36-3" id="h3-36-3" class="d">-                //
</a>                 // Heals all network partitions for the given nodes.
                 &quot;heal&quot; =&gt; {
                     let ids = self.parse_ids_or_all(&amp;command.args)?;
<a href="#h3-37" id="h3-37" class="h">@@ -1284,7 +1295,6 @@ mod tests {
</a>                 }
 
                 // heartbeat ID...
<a href="#h3-37-3" id="h3-37-3" class="d">-                //
</a>                 // Sends a heartbeat from the given leader nodes.
                 &quot;heartbeat&quot; =&gt; {
                     let ids = self.parse_ids_or_all(&amp;command.args)?;
<a href="#h3-38" id="h3-38" class="h">@@ -1292,7 +1302,6 @@ mod tests {
</a>                 }
 
                 // log [ID...]
<a href="#h3-38-3" id="h3-38-3" class="d">-                //
</a>                 // Outputs the current Raft log for the given nodes.
                 &quot;log&quot; =&gt; {
                     let ids = self.parse_ids_or_all(&amp;command.args)?;
<a href="#h3-39" id="h3-39" class="h">@@ -1300,7 +1309,6 @@ mod tests {
</a>                 }
 
                 // partition ID...
<a href="#h3-39-3" id="h3-39-3" class="d">-                //
</a>                 // Partitions the given nodes away from the rest of the cluster.
                 // They can still communicate with each other, unless they were
                 // previously partitioned.
<a href="#h3-40" id="h3-40" class="h">@@ -1310,7 +1318,6 @@ mod tests {
</a>                 }
 
                 // put ID KEY=VALUE
<a href="#h3-40-3" id="h3-40-3" class="d">-                //
</a>                 // Sends a client request to the given node to write a key/value
                 // pair to the state machine (key/value store).
                 &quot;put&quot; =&gt; {
<a href="#h3-41" id="h3-41" class="h">@@ -1324,7 +1331,6 @@ mod tests {
</a>                 }
 
                 // stabilize [heartbeat=BOOL] [ID...]
<a href="#h3-41-3" id="h3-41-3" class="d">-                //
</a>                 // Stabilizes the given nodes by repeatedly delivering messages
                 // until no more messages are pending. If heartbeat is true, also
                 // emits a heartbeat from the leader and restabilizes, e.g. to
<a href="#h3-42" id="h3-42" class="h">@@ -1337,15 +1343,13 @@ mod tests {
</a>                 }
 
                 // state [ID...]
<a href="#h3-42-3" id="h3-42-3" class="d">-                //
</a>                 // Prints the current state machine contents on the given nodes.
                 &quot;state&quot; =&gt; {
<a href="#h3-42-6" id="h3-42-6" class="d">-                    let ids = self.parse_ids_or_error(&amp;command.args)?;
</a><a href="#h3-42-7" id="h3-42-7" class="i">+                    let ids = self.parse_ids_or_all(&amp;command.args)?;
</a>                     self.state(&amp;ids, &amp;mut output)?;
                 }
 
                 // status [request=BOOL] [ID...]
<a href="#h3-42-12" id="h3-42-12" class="d">-                //
</a>                 // Prints the current node status of the given nodes. If request
                 // is true, sends a status client request to a single node,
                 // otherwise fetches status directly from each node.
<a href="#h3-43" id="h3-43" class="h">@@ -1354,17 +1358,16 @@ mod tests {
</a>                     let request = args.lookup_parse(&quot;request&quot;)?.unwrap_or(false);
                     let ids = self.parse_ids_or_all(&amp;args.rest())?;
                     if request {
<a href="#h3-43-3" id="h3-43-3" class="d">-                        if ids.len() != 1 {
</a><a href="#h3-43-4" id="h3-43-4" class="i">+                        let [id] = *ids.as_slice() else {
</a>                             return Err(&quot;request=true requires 1 node ID&quot;.into());
<a href="#h3-43-6" id="h3-43-6" class="d">-                        }
</a><a href="#h3-43-7" id="h3-43-7" class="d">-                        self.request(ids[0], Request::Status, &amp;mut output)?;
</a><a href="#h3-43-8" id="h3-43-8" class="i">+                        };
</a><a href="#h3-43-9" id="h3-43-9" class="i">+                        self.request(id, Request::Status, &amp;mut output)?;
</a>                     } else {
                         self.status(&amp;ids, &amp;mut output)?;
                     }
                 }
 
                 // step ID JSON
<a href="#h3-43-16" id="h3-43-16" class="d">-                //
</a>                 // Steps a manually generated JSON message on the given node.
                 &quot;step&quot; =&gt; {
                     let mut args = command.consume_args();
<a href="#h3-44" id="h3-44" class="h">@@ -1376,7 +1379,6 @@ mod tests {
</a>                 }
 
                 // tick [ID...]
<a href="#h3-44-3" id="h3-44-3" class="d">-                //
</a>                 // Ticks the given nodes.
                 &quot;tick&quot; =&gt; {
                     let ids = self.parse_ids_or_all(&amp;command.args)?;
<a href="#h3-45" id="h3-45" class="h">@@ -1396,7 +1398,7 @@ mod tests {
</a>             Self { next_request_id: 1, ..Default::default() }
         }
 
<a href="#h3-45-3" id="h3-45-3" class="d">-        /// Makes the given nodes campaign, by transitioning to candidates.
</a><a href="#h3-45-4" id="h3-45-4" class="i">+        /// Transitions nodes to candidates and campaign in a new term.
</a>         fn campaign(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             let campaign = |node| match node {
                 Node::Candidate(mut node) =&gt; {
<a href="#h3-46" id="h3-46" class="h">@@ -1404,7 +1406,10 @@ mod tests {
</a>                     Ok(node.into())
                 }
                 Node::Follower(node) =&gt; Ok(node.into_candidate()?.into()),
<a href="#h3-46-3" id="h3-46-3" class="d">-                Node::Leader(node) =&gt; panic!(&quot;{} is a leader&quot;, node.id),
</a><a href="#h3-46-4" id="h3-46-4" class="i">+                Node::Leader(node) =&gt; {
</a><a href="#h3-46-5" id="h3-46-5" class="i">+                    let term = node.term();
</a><a href="#h3-46-6" id="h3-46-6" class="i">+                    Ok(node.into_follower(term + 1)?.into_candidate()?.into())
</a><a href="#h3-46-7" id="h3-46-7" class="i">+                }
</a>             };
             for id in ids.iter().copied() {
                 self.transition(id, campaign, output)?;
<a href="#h3-47" id="h3-47" class="h">@@ -1417,9 +1422,7 @@ mod tests {
</a>             &amp;mut self,
             nodes: u8,
             leader: Option&lt;NodeID&gt;,
<a href="#h3-47-3" id="h3-47-3" class="d">-            heartbeat_interval: Ticks,
</a><a href="#h3-47-4" id="h3-47-4" class="d">-            election_timeout: Ticks,
</a><a href="#h3-47-5" id="h3-47-5" class="d">-            max_append_entries: usize,
</a><a href="#h3-47-6" id="h3-47-6" class="i">+            opts: Options,
</a>             output: &amp;mut String,
         ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             if !self.ids.is_empty() {
<a href="#h3-48" id="h3-48" class="h">@@ -1434,15 +1437,10 @@ mod tests {
</a>             for id in self.ids.iter().copied() {
                 let (node_tx, node_rx) = crossbeam::channel::unbounded();
                 let (applied_tx, applied_rx) = crossbeam::channel::unbounded();
<a href="#h3-48-3" id="h3-48-3" class="d">-                let peers = self.ids.iter().copied().filter(|i| *i != id).collect();
</a><a href="#h3-48-4" id="h3-48-4" class="i">+                let peers = self.ids.iter().copied().filter(|i| i != &amp;id).collect();
</a>                 let log = Log::new(storage::Memory::new())?;
                 let state = teststate::Emit::new(teststate::KV::new(), applied_tx);
<a href="#h3-48-7" id="h3-48-7" class="d">-                let opts = Options {
</a><a href="#h3-48-8" id="h3-48-8" class="d">-                    heartbeat_interval,
</a><a href="#h3-48-9" id="h3-48-9" class="d">-                    election_timeout_range: election_timeout..election_timeout + 1,
</a><a href="#h3-48-10" id="h3-48-10" class="d">-                    max_append_entries,
</a><a href="#h3-48-11" id="h3-48-11" class="d">-                };
</a><a href="#h3-48-12" id="h3-48-12" class="d">-                self.nodes.insert(id, Node::new(id, peers, log, state, node_tx, opts)?);
</a><a href="#h3-48-13" id="h3-48-13" class="i">+                self.nodes.insert(id, Node::new(id, peers, log, state, node_tx, opts.clone())?);
</a> 
                 while applied_rx.try_recv().is_ok() {} // drain first apply
 
<a href="#h3-49" id="h3-49" class="h">@@ -1467,32 +1465,31 @@ mod tests {
</a>             self.status(&amp;self.ids, output)
         }
 
<a href="#h3-49-3" id="h3-49-3" class="d">-        /// Delivers pending inbound messages to the given nodes. If from is
</a><a href="#h3-49-4" id="h3-49-4" class="d">-        /// given, only delivers messages from the given node ID. Returns the
</a><a href="#h3-49-5" id="h3-49-5" class="d">-        /// number of delivered messages.
</a><a href="#h3-49-6" id="h3-49-6" class="i">+        /// Delivers pending messages to the given nodes. If from is given, only
</a><a href="#h3-49-7" id="h3-49-7" class="i">+        /// delivers messages from that node. Returns the number of delivered
</a><a href="#h3-49-8" id="h3-49-8" class="i">+        /// messages.
</a>         fn deliver(
             &amp;mut self,
             ids: &amp;[NodeID],
             from: Option&lt;NodeID&gt;,
             output: &amp;mut String,
<a href="#h3-49-14" id="h3-49-14" class="d">-        ) -&gt; Result&lt;u32, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h3-49-15" id="h3-49-15" class="i">+        ) -&gt; Result&lt;usize, Box&lt;dyn Error&gt;&gt; {
</a>             // Take a snapshot of the pending queues before delivering any
             // messages. This avoids outbound messages in response to delivery
             // being delivered to higher node IDs in the same loop, which can
             // give unintuitive results.
             let mut step = Vec::new();
             for id in ids.iter().copied() {
<a href="#h3-49-22" id="h3-49-22" class="d">-                let Some(node_pending) = self.nodes_pending.remove(&amp;id) else {
</a><a href="#h3-49-23" id="h3-49-23" class="i">+                let Some(pending) = self.nodes_pending.remove(&amp;id) else {
</a>                     return Err(format!(&quot;unknown node {id}&quot;).into());
                 };
<a href="#h3-49-26" id="h3-49-26" class="d">-                let (deliver, requeue) = node_pending
</a><a href="#h3-49-27" id="h3-49-27" class="d">-                    .into_iter()
</a><a href="#h3-49-28" id="h3-49-28" class="d">-                    .partition(|msg| from.is_none() || from == Some(msg.from));
</a><a href="#h3-49-29" id="h3-49-29" class="i">+                let (deliver, requeue) =
</a><a href="#h3-49-30" id="h3-49-30" class="i">+                    pending.into_iter().partition(|msg| from.is_none() || from == Some(msg.from));
</a>                 self.nodes_pending.insert(id, requeue);
                 step.extend(deliver);
             }
 
<a href="#h3-49-35" id="h3-49-35" class="d">-            let delivered = step.len() as u32;
</a><a href="#h3-49-36" id="h3-49-36" class="i">+            let delivered = step.len();
</a>             for msg in step {
                 self.transition(msg.to, |node| node.step(msg), output)?;
             }
<a href="#h3-50" id="h3-50" class="h">@@ -1515,8 +1512,7 @@ mod tests {
</a>         /// Emits a heartbeat from the given leader nodes.
         fn heartbeat(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             for id in ids.iter().copied() {
<a href="#h3-50-3" id="h3-50-3" class="d">-                let node = self.nodes.get_mut(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a><a href="#h3-50-4" id="h3-50-4" class="d">-                let Node::Leader(leader) = node else {
</a><a href="#h3-50-5" id="h3-50-5" class="i">+                let Some(Node::Leader(leader)) = self.nodes.get_mut(&amp;id) else {
</a>                     return Err(format!(&quot;{id} is not a leader&quot;).into());
                 };
                 leader.heartbeat()?;
<a href="#h3-51" id="h3-51" class="h">@@ -1530,16 +1526,15 @@ mod tests {
</a>             for id in ids {
                 let node = self.nodes.get_mut(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
                 let nodefmt = Self::format_node(node);
<a href="#h3-51-3" id="h3-51-3" class="d">-                let log = Self::borrow_log_mut(node);
</a><a href="#h3-51-4" id="h3-51-4" class="d">-                let (last_index, last_term) = log.get_last_index();
</a><a href="#h3-51-5" id="h3-51-5" class="d">-                let (commit_index, commit_term) = log.get_commit_index();
</a><a href="#h3-51-6" id="h3-51-6" class="d">-                output.push_str(&amp;format!(
</a><a href="#h3-51-7" id="h3-51-7" class="d">-                    &quot;{nodefmt} last={last_index}@{last_term} commit={commit_index}@{commit_term}\n&quot;,
</a><a href="#h3-51-8" id="h3-51-8" class="d">-                ));
</a><a href="#h3-51-9" id="h3-51-9" class="d">-
</a><a href="#h3-51-10" id="h3-51-10" class="d">-                let mut scan = log.scan(..);
</a><a href="#h3-51-11" id="h3-51-11" class="d">-                while let Some(entry) = scan.next().transpose()? {
</a><a href="#h3-51-12" id="h3-51-12" class="d">-                    output.push_str(&amp;format!(&quot;{nodefmt} entry {}\n&quot;, &amp;Self::format_entry(&amp;entry)));
</a><a href="#h3-51-13" id="h3-51-13" class="i">+                let (last_index, last_term) = node.get_last_index();
</a><a href="#h3-51-14" id="h3-51-14" class="i">+                let (commit_index, commit_term) = node.get_commit_index();
</a><a href="#h3-51-15" id="h3-51-15" class="i">+                let (term, vote) = node.get_term_vote();
</a><a href="#h3-51-16" id="h3-51-16" class="i">+                writeln!(
</a><a href="#h3-51-17" id="h3-51-17" class="i">+                    output,
</a><a href="#h3-51-18" id="h3-51-18" class="i">+                    &quot;{nodefmt} term={term} last={last_index}@{last_term} commit={commit_index}@{commit_term} vote={vote:?}&quot;,
</a><a href="#h3-51-19" id="h3-51-19" class="i">+                )?;
</a><a href="#h3-51-20" id="h3-51-20" class="i">+                for entry in node.scan_log()? {
</a><a href="#h3-51-21" id="h3-51-21" class="i">+                    writeln!(output, &quot;{nodefmt} entry {}&quot;, Self::format_entry(&amp;entry))?;
</a>                 }
             }
             Ok(())
<a href="#h3-52" id="h3-52" class="h">@@ -1549,7 +1544,7 @@ mod tests {
</a>         /// (bidirectionally). The given nodes can communicate with each other
         /// unless they were previously partitioned.
         fn partition(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
<a href="#h3-52-3" id="h3-52-3" class="d">-            let ids: HashSet&lt;NodeID&gt; = HashSet::from_iter(ids.iter().copied());
</a><a href="#h3-52-4" id="h3-52-4" class="i">+            let ids = HashSet::&lt;NodeID&gt;::from_iter(ids.iter().copied());
</a>             for id in ids.iter().copied() {
                 for peer in self.ids.iter().copied().filter(|p| !ids.contains(p)) {
                     self.disconnected.entry(id).or_default().insert(peer);
<a href="#h3-53" id="h3-53" class="h">@@ -1564,18 +1559,19 @@ mod tests {
</a>         /// for delivery. Returns the number of received messages.
         fn receive(&amp;mut self, id: NodeID, output: &amp;mut String) -&gt; Result&lt;u32, Box&lt;dyn Error&gt;&gt; {
             let rx = self.nodes_rx.get_mut(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
<a href="#h3-53-3" id="h3-53-3" class="d">-
</a>             let mut count = 0;
             for msg in rx.try_iter() {
                 count += 1;
                 let (from, term, to) = (msg.from, msg.term, msg.to); // simplify formatting
<a href="#h3-53-8" id="h3-53-8" class="i">+                let msgfmt = Self::format_message(&amp;msg.message);
</a> 
                 // If the peer is disconnected, drop the message and output it.
                 if self.disconnected[&amp;msg.from].contains(&amp;msg.to) {
<a href="#h3-53-12" id="h3-53-12" class="d">-                    output.push_str(&amp;format!(
</a><a href="#h3-53-13" id="h3-53-13" class="d">-                        &quot;n{from}@{term}  n{to} {}\n&quot;,
</a><a href="#h3-53-14" id="h3-53-14" class="d">-                        Self::format_strikethrough(&amp;Self::format_message(&amp;msg.message)),
</a><a href="#h3-53-15" id="h3-53-15" class="d">-                    ));
</a><a href="#h3-53-16" id="h3-53-16" class="i">+                    writeln!(
</a><a href="#h3-53-17" id="h3-53-17" class="i">+                        output,
</a><a href="#h3-53-18" id="h3-53-18" class="i">+                        &quot;n{from}@{term}  n{to} {}&quot;,
</a><a href="#h3-53-19" id="h3-53-19" class="i">+                        Self::format_strikethrough(&amp;msgfmt),
</a><a href="#h3-53-20" id="h3-53-20" class="i">+                    )?;
</a>                     continue;
                 }
 
<a href="#h3-54" id="h3-54" class="h">@@ -1584,24 +1580,19 @@ mod tests {
</a>                     let Message::ClientResponse { id, response } = &amp;msg.message else {
                         return Err(format!(&quot;invalid self-addressed message: {msg:?}&quot;).into());
                     };
<a href="#h3-54-3" id="h3-54-3" class="d">-                    output.push_str(&amp;format!(
</a><a href="#h3-54-4" id="h3-54-4" class="d">-                        &quot;n{from}@{term}  c{to} {}\n&quot;,
</a><a href="#h3-54-5" id="h3-54-5" class="d">-                        Self::format_message(&amp;msg.message),
</a><a href="#h3-54-6" id="h3-54-6" class="d">-                    ));
</a><a href="#h3-54-7" id="h3-54-7" class="i">+                    writeln!(output, &quot;n{from}@{term}  c{to} {msgfmt}&quot;)?;
</a>                     let request = &amp;self.requests.remove(id).ok_or(&quot;unknown request id&quot;)?;
<a href="#h3-54-9" id="h3-54-9" class="d">-                    output.push_str(&amp;format!(
</a><a href="#h3-54-10" id="h3-54-10" class="d">-                        &quot;c{to}@{term} {}  {}\n&quot;,
</a><a href="#h3-54-11" id="h3-54-11" class="i">+                    writeln!(
</a><a href="#h3-54-12" id="h3-54-12" class="i">+                        output,
</a><a href="#h3-54-13" id="h3-54-13" class="i">+                        &quot;c{to}@{term} {}  {}&quot;,
</a>                         Self::format_request(request),
                         Self::format_response(response),
<a href="#h3-54-16" id="h3-54-16" class="d">-                    ));
</a><a href="#h3-54-17" id="h3-54-17" class="i">+                    )?;
</a>                     continue;
                 }
 
                 // Output the message and queue it for delivery.
<a href="#h3-54-22" id="h3-54-22" class="d">-                output.push_str(&amp;format!(
</a><a href="#h3-54-23" id="h3-54-23" class="d">-                    &quot;n{from}@{term}  n{to} {}\n&quot;,
</a><a href="#h3-54-24" id="h3-54-24" class="d">-                    Self::format_message(&amp;msg.message)
</a><a href="#h3-54-25" id="h3-54-25" class="d">-                ));
</a><a href="#h3-54-26" id="h3-54-26" class="i">+                writeln!(output, &quot;n{from}@{term}  n{to} {msgfmt}&quot;)?;
</a>                 self.nodes_pending.get_mut(&amp;msg.to).ok_or(format!(&quot;unknown node {to}&quot;))?.push(msg);
             }
             Ok(count)
<a href="#h3-55" id="h3-55" class="h">@@ -1614,24 +1605,18 @@ mod tests {
</a>             request: Request,
             output: &amp;mut String,
         ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
<a href="#h3-55-3" id="h3-55-3" class="d">-            let node = self.nodes.get(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
</a>             let request_id = uuid::Uuid::from_u64_pair(0, self.next_request_id);
             self.next_request_id += 1;
             self.requests.insert(request_id, request.clone());
 
<a href="#h3-55-8" id="h3-55-8" class="i">+            let term = self.nodes.get(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?.term();
</a>             let msg = Envelope {
<a href="#h3-55-10" id="h3-55-10" class="d">-                from: node.id(),
</a><a href="#h3-55-11" id="h3-55-11" class="d">-                to: node.id(),
</a><a href="#h3-55-12" id="h3-55-12" class="d">-                term: node.term(),
</a><a href="#h3-55-13" id="h3-55-13" class="i">+                from: id,
</a><a href="#h3-55-14" id="h3-55-14" class="i">+                to: id,
</a><a href="#h3-55-15" id="h3-55-15" class="i">+                term,
</a>                 message: Message::ClientRequest { id: request_id, request },
             };
<a href="#h3-55-18" id="h3-55-18" class="d">-            output.push_str(&amp;format!(
</a><a href="#h3-55-19" id="h3-55-19" class="d">-                &quot;c{}@{}  n{} {}\n&quot;,
</a><a href="#h3-55-20" id="h3-55-20" class="d">-                msg.from,
</a><a href="#h3-55-21" id="h3-55-21" class="d">-                msg.term,
</a><a href="#h3-55-22" id="h3-55-22" class="d">-                msg.to,
</a><a href="#h3-55-23" id="h3-55-23" class="d">-                Self::format_message(&amp;msg.message)
</a><a href="#h3-55-24" id="h3-55-24" class="d">-            ));
</a><a href="#h3-55-25" id="h3-55-25" class="i">+            writeln!(output, &quot;c{id}@{term}  n{id} {}&quot;, Self::format_message(&amp;msg.message))?;
</a>             self.transition(id, |n| n.step(msg), output)
         }
 
<a href="#h3-56" id="h3-56" class="h">@@ -1646,17 +1631,17 @@ mod tests {
</a>             output: &amp;mut String,
         ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             while self.deliver(ids, None, output)? &gt; 0 {}
<a href="#h3-56-3" id="h3-56-3" class="i">+            // If requested, heartbeat the current leader (with the highest
</a><a href="#h3-56-4" id="h3-56-4" class="i">+            // term) and re-stabilize the nodes.
</a>             if heartbeat {
<a href="#h3-56-6" id="h3-56-6" class="d">-                // Heartbeat the current leader (with the highest term).
</a>                 if let Some(leader) = self
                     .nodes
                     .values()
                     .sorted_by_key(|n| n.term())
                     .rev()
                     .find(|n| matches!(n, Node::Leader(_)))
<a href="#h3-56-13" id="h3-56-13" class="d">-                    .map(|n| n.id())
</a>                 {
<a href="#h3-56-15" id="h3-56-15" class="d">-                    self.heartbeat(&amp;[leader], output)?;
</a><a href="#h3-56-16" id="h3-56-16" class="i">+                    self.heartbeat(&amp;[leader.id()], output)?;
</a>                     self.stabilize(ids, false, output)?;
                 }
             }
<a href="#h3-57" id="h3-57" class="h">@@ -1667,15 +1652,15 @@ mod tests {
</a>         fn state(&amp;mut self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             for id in ids {
                 let node = self.nodes.get_mut(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
<a href="#h3-57-3" id="h3-57-3" class="d">-                let state = Self::borrow_state(node);
</a><a href="#h3-57-4" id="h3-57-4" class="d">-                let applied_index = state.get_applied_index();
</a>                 let nodefmt = Self::format_node(node);
<a href="#h3-57-6" id="h3-57-6" class="d">-                output.push_str(&amp;format!(&quot;{nodefmt} applied={applied_index}\n&quot;));
</a><a href="#h3-57-7" id="h3-57-7" class="d">-
</a><a href="#h3-57-8" id="h3-57-8" class="d">-                let raw = state.read(KVCommand::Scan.encode())?;
</a><a href="#h3-57-9" id="h3-57-9" class="d">-                let kvs: Vec&lt;(String, String)&gt; = bincode::deserialize(&amp;raw)?;
</a><a href="#h3-57-10" id="h3-57-10" class="i">+                let applied_index = node.get_applied_index();
</a><a href="#h3-57-11" id="h3-57-11" class="i">+                let raw = node.read(KVCommand::Scan.encode())?;
</a><a href="#h3-57-12" id="h3-57-12" class="i">+                let KVResponse::Scan(kvs) = KVResponse::decode(&amp;raw)? else {
</a><a href="#h3-57-13" id="h3-57-13" class="i">+                    return Err(&quot;unexpected scan response&quot;.into());
</a><a href="#h3-57-14" id="h3-57-14" class="i">+                };
</a><a href="#h3-57-15" id="h3-57-15" class="i">+                writeln!(output, &quot;{nodefmt} applied={applied_index}&quot;)?;
</a>                 for (key, value) in kvs {
<a href="#h3-57-17" id="h3-57-17" class="d">-                    output.push_str(&amp;format!(&quot;{nodefmt} state {key}={value}\n&quot;));
</a><a href="#h3-57-18" id="h3-57-18" class="i">+                    writeln!(output, &quot;{nodefmt} state {key}={value}&quot;)?;
</a>                 }
             }
             Ok(())
<a href="#h3-58" id="h3-58" class="h">@@ -1685,15 +1670,17 @@ mod tests {
</a>         fn status(&amp;self, ids: &amp;[NodeID], output: &amp;mut String) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             for id in ids {
                 let node = self.nodes.get(id).ok_or(format!(&quot;unknown node {id}&quot;))?;
<a href="#h3-58-3" id="h3-58-3" class="d">-                let (last_index, last_term) = Self::borrow_log(node).get_last_index();
</a><a href="#h3-58-4" id="h3-58-4" class="d">-                let (commit_index, commit_term) = Self::borrow_log(node).get_commit_index();
</a><a href="#h3-58-5" id="h3-58-5" class="d">-                let apply_index = Self::borrow_state(node).get_applied_index();
</a><a href="#h3-58-6" id="h3-58-6" class="d">-                output.push_str(&amp;format!(
</a><a href="#h3-58-7" id="h3-58-7" class="d">-                    &quot;{} last={last_index}@{last_term} commit={commit_index}@{commit_term} apply={apply_index}&quot;,
</a><a href="#h3-58-8" id="h3-58-8" class="i">+                let (last_index, last_term) = node.get_last_index();
</a><a href="#h3-58-9" id="h3-58-9" class="i">+                let (commit_index, commit_term) = node.get_commit_index();
</a><a href="#h3-58-10" id="h3-58-10" class="i">+                let applied_index = node.get_applied_index();
</a><a href="#h3-58-11" id="h3-58-11" class="i">+                write!(
</a><a href="#h3-58-12" id="h3-58-12" class="i">+                    output,
</a><a href="#h3-58-13" id="h3-58-13" class="i">+                    &quot;{} last={last_index}@{last_term} commit={commit_index}@{commit_term} applied={applied_index}&quot;,
</a>                     Self::format_node_role(node)
<a href="#h3-58-15" id="h3-58-15" class="d">-                ));
</a><a href="#h3-58-16" id="h3-58-16" class="i">+                )?;
</a>                 if let Node::Leader(leader) = node {
<a href="#h3-58-18" id="h3-58-18" class="d">-                    output.push_str(&amp;format!(
</a><a href="#h3-58-19" id="h3-58-19" class="i">+                    write!(
</a><a href="#h3-58-20" id="h3-58-20" class="i">+                        output,
</a>                         &quot; progress={{{}}}&quot;,
                         leader
                             .role
<a href="#h3-59" id="h3-59" class="h">@@ -1702,66 +1689,59 @@ mod tests {
</a>                             .sorted_by_key(|(id, _)| *id)
                             .map(|(id, pr)| format!(&quot;{id}:{}{}&quot;, pr.match_index, pr.next_index))
                             .join(&quot; &quot;)
<a href="#h3-59-3" id="h3-59-3" class="d">-                    ))
</a><a href="#h3-59-4" id="h3-59-4" class="i">+                    )?
</a>                 }
                 output.push(&#39;\n&#39;);
             }
             Ok(())
         }
 
<a href="#h3-59-11" id="h3-59-11" class="d">-        /// Applies a node transition (typically a step or tick).
</a><a href="#h3-59-12" id="h3-59-12" class="d">-        fn transition&lt;F: FnOnce(Node) -&gt; crate::error::Result&lt;Node&gt;&gt;(
</a><a href="#h3-59-13" id="h3-59-13" class="i">+        /// Applies a node transition (typically a step or tick), and outputs
</a><a href="#h3-59-14" id="h3-59-14" class="i">+        /// relevant changes.
</a><a href="#h3-59-15" id="h3-59-15" class="i">+        fn transition(
</a>             &amp;mut self,
             id: NodeID,
<a href="#h3-59-18" id="h3-59-18" class="d">-            f: F,
</a><a href="#h3-59-19" id="h3-59-19" class="i">+            f: impl FnOnce(Node) -&gt; crate::error::Result&lt;Node&gt;,
</a>             output: &amp;mut String,
         ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             let mut node = self.nodes.remove(&amp;id).ok_or(format!(&quot;unknown node {id}&quot;))?;
 
<a href="#h3-59-24" id="h3-59-24" class="i">+            // Fetch pre-transition info.
</a>             let old_noderole = Self::format_node_role(&amp;node);
<a href="#h3-59-26" id="h3-59-26" class="d">-            let log = Self::borrow_log_mut(&amp;mut node);
</a><a href="#h3-59-27" id="h3-59-27" class="d">-            let old_commit_index = log.get_commit_index().0;
</a><a href="#h3-59-28" id="h3-59-28" class="d">-            let entries = log.scan(..).collect::&lt;crate::error::Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h3-59-29" id="h3-59-29" class="i">+            let (old_commit_index, _) = node.get_commit_index();
</a><a href="#h3-59-30" id="h3-59-30" class="i">+            let mut old_entries = node.scan_log()?.into_iter();
</a> 
             // Apply the transition.
             node = f(node)?;
 
<a href="#h3-59-35" id="h3-59-35" class="i">+            // Fetch post-transition info.
</a>             let nodefmt = Self::format_node(&amp;node);
             let noderole = Self::format_node_role(&amp;node);
<a href="#h3-59-38" id="h3-59-38" class="i">+            let (commit_index, commit_term) = node.get_commit_index();
</a> 
<a href="#h3-59-40" id="h3-59-40" class="d">-            let log = Self::borrow_log_mut(&amp;mut node);
</a><a href="#h3-59-41" id="h3-59-41" class="d">-            let (commit_index, commit_term) = log.get_commit_index();
</a><a href="#h3-59-42" id="h3-59-42" class="d">-            let mut appended = log.scan(..).collect::&lt;crate::error::Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h3-59-43" id="h3-59-43" class="d">-            match appended.iter().zip(entries.iter()).position(|(a, e)| a.term != e.term) {
</a><a href="#h3-59-44" id="h3-59-44" class="d">-                Some(i) =&gt; appended = appended[i..].to_vec(),
</a><a href="#h3-59-45" id="h3-59-45" class="d">-                None =&gt; appended = appended[entries.len()..].to_vec(),
</a><a href="#h3-59-46" id="h3-59-46" class="d">-            }
</a><a href="#h3-59-47" id="h3-59-47" class="i">+            let entries = node.scan_log()?.into_iter();
</a><a href="#h3-59-48" id="h3-59-48" class="i">+            let appended: Vec&lt;Entry&gt; = entries
</a><a href="#h3-59-49" id="h3-59-49" class="i">+                .skip_while(|e| Some(e.term) == old_entries.next().map(|e| e.term))
</a><a href="#h3-59-50" id="h3-59-50" class="i">+                .collect();
</a> 
             self.nodes.insert(id, node);
 
<a href="#h3-59-54" id="h3-59-54" class="d">-            // Print term/role changes.
</a><a href="#h3-59-55" id="h3-59-55" class="i">+            // Output relevant changes.
</a>             if old_noderole != noderole {
<a href="#h3-59-57" id="h3-59-57" class="d">-                output.push_str(&amp;format!(&quot;{old_noderole}  {noderole}\n&quot;))
</a><a href="#h3-59-58" id="h3-59-58" class="i">+                writeln!(output, &quot;{old_noderole}  {noderole}&quot;)?
</a>             }
<a href="#h3-59-60" id="h3-59-60" class="d">-
</a><a href="#h3-59-61" id="h3-59-61" class="d">-            // Print appended entries.
</a>             for entry in appended {
<a href="#h3-59-63" id="h3-59-63" class="d">-                output.push_str(&amp;format!(&quot;{nodefmt} append {}\n&quot;, Self::format_entry(&amp;entry)))
</a><a href="#h3-59-64" id="h3-59-64" class="i">+                writeln!(output, &quot;{nodefmt} append {}&quot;, Self::format_entry(&amp;entry))?
</a>             }
<a href="#h3-59-66" id="h3-59-66" class="d">-
</a><a href="#h3-59-67" id="h3-59-67" class="d">-            // Print commit index changes.
</a>             if old_commit_index != commit_index {
<a href="#h3-59-69" id="h3-59-69" class="d">-                output.push_str(&amp;format!(&quot;{nodefmt} commit {commit_index}@{commit_term}\n&quot;))
</a><a href="#h3-59-70" id="h3-59-70" class="i">+                writeln!(output, &quot;{nodefmt} commit {commit_index}@{commit_term}&quot;)?;
</a>             }
<a href="#h3-59-72" id="h3-59-72" class="d">-
</a><a href="#h3-59-73" id="h3-59-73" class="d">-            // Print applied entries.
</a>             for entry in self.applied_rx[&amp;id].try_iter() {
<a href="#h3-59-75" id="h3-59-75" class="d">-                output.push_str(&amp;format!(&quot;{nodefmt} apply {}\n&quot;, Self::format_entry(&amp;entry)))
</a><a href="#h3-59-76" id="h3-59-76" class="i">+                writeln!(output, &quot;{nodefmt} apply {}&quot;, Self::format_entry(&amp;entry))?
</a>             }
 
<a href="#h3-59-79" id="h3-59-79" class="d">-            // Receive outbound messages resulting from the transition.
</a><a href="#h3-59-80" id="h3-59-80" class="i">+            // Receive any outbound messages.
</a>             self.receive(id, output)?;
<a href="#h3-59-82" id="h3-59-82" class="d">-
</a>             Ok(())
         }
 
<a href="#h3-60" id="h3-60" class="h">@@ -1791,15 +1771,14 @@ mod tests {
</a>         where
             A: Borrow&lt;goldenscript::Argument&gt;,
         {
<a href="#h3-60-3" id="h3-60-3" class="d">-            let mut ids = self.parse_ids(args)?;
</a><a href="#h3-60-4" id="h3-60-4" class="i">+            let ids = self.parse_ids(args)?;
</a>             if ids.is_empty() {
<a href="#h3-60-6" id="h3-60-6" class="d">-                ids = self.ids.clone();
</a><a href="#h3-60-7" id="h3-60-7" class="i">+                return Ok(self.ids.clone());
</a>             }
             Ok(ids)
         }
 
<a href="#h3-60-12" id="h3-60-12" class="d">-        // Parses node IDs from the given argument values. Errors if no IDs were
</a><a href="#h3-60-13" id="h3-60-13" class="d">-        // given.
</a><a href="#h3-60-14" id="h3-60-14" class="i">+        // Parses node IDs from the given argument values, or errors if none.
</a>         fn parse_ids_or_error&lt;A&gt;(&amp;self, args: &amp;[A]) -&gt; Result&lt;Vec&lt;NodeID&gt;, Box&lt;dyn Error&gt;&gt;
         where
             A: Borrow&lt;goldenscript::Argument&gt;,
<a href="#h3-61" id="h3-61" class="h">@@ -1816,7 +1795,7 @@ mod tests {
</a>             // Return early if the cluster is fully connected.
             if disconnected.iter().all(|(_, peers)| peers.is_empty()) {
                 return format!(
<a href="#h3-61-3" id="h3-61-3" class="d">-                    &quot;{} fully connected&quot;,
</a><a href="#h3-61-4" id="h3-61-4" class="i">+                    &quot;{} fully connected\n&quot;,
</a>                     disconnected.keys().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;)
                 );
             }
<a href="#h3-62" id="h3-62" class="h">@@ -1842,15 +1821,16 @@ mod tests {
</a>                 for peer in peers {
                     // Recompute the peer set sizes for each iteration, since we
                     // modify the peer set below.
<a href="#h3-62-3" id="h3-62-3" class="d">-                    let len = symmetric.get(id).map(|p| p.len()).unwrap_or_default();
</a><a href="#h3-62-4" id="h3-62-4" class="d">-                    let peer_len = symmetric.get(peer).map(|p| p.len()).unwrap_or_default();
</a><a href="#h3-62-5" id="h3-62-5" class="d">-                    if len &lt; peer_len || len == peer_len &amp;&amp; id &lt; peer {
</a><a href="#h3-62-6" id="h3-62-6" class="d">-                        let Some(peers) = symmetric.get_mut(id) else {
</a><a href="#h3-62-7" id="h3-62-7" class="d">-                            continue;
</a><a href="#h3-62-8" id="h3-62-8" class="d">-                        };
</a><a href="#h3-62-9" id="h3-62-9" class="d">-                        peers.remove(peer);
</a><a href="#h3-62-10" id="h3-62-10" class="d">-                        if peers.is_empty() {
</a><a href="#h3-62-11" id="h3-62-11" class="d">-                            symmetric.remove(id);
</a><a href="#h3-62-12" id="h3-62-12" class="i">+                    let len = symmetric.get(id).map(|p| p.len()).unwrap_or(0);
</a><a href="#h3-62-13" id="h3-62-13" class="i">+                    let peer_len = symmetric.get(peer).map(|p| p.len()).unwrap_or(0);
</a><a href="#h3-62-14" id="h3-62-14" class="i">+                    // If this peer set is the smallest (or we&#39;re the higher ID),
</a><a href="#h3-62-15" id="h3-62-15" class="i">+                    // remove the entry. We may no longer be in the map.
</a><a href="#h3-62-16" id="h3-62-16" class="i">+                    if len &lt; peer_len || len == peer_len &amp;&amp; id &gt; peer {
</a><a href="#h3-62-17" id="h3-62-17" class="i">+                        if let Some(peers) = symmetric.get_mut(id) {
</a><a href="#h3-62-18" id="h3-62-18" class="i">+                            peers.remove(peer);
</a><a href="#h3-62-19" id="h3-62-19" class="i">+                            if peers.is_empty() {
</a><a href="#h3-62-20" id="h3-62-20" class="i">+                                symmetric.remove(id);
</a><a href="#h3-62-21" id="h3-62-21" class="i">+                            }
</a>                         }
                     }
                 }
<a href="#h3-63" id="h3-63" class="h">@@ -1861,31 +1841,26 @@ mod tests {
</a>             // separately for symmetric and asymmetric partitions. The vector
             // contains (LHS, RHS, symmetric) groupings for each partition.
             let mut grouped: Vec&lt;(HashSet&lt;NodeID&gt;, HashSet&lt;NodeID&gt;, bool)&gt; = Vec::new();
<a href="#h3-63-3" id="h3-63-3" class="d">-            &#39;outer: for (id, peers, symm) in symmetric
</a><a href="#h3-63-4" id="h3-63-4" class="i">+            for (id, peers, symm) in symmetric
</a>                 .into_iter()
                 .map(|(i, p)| (i, p, true))
                 .chain(asymmetric.into_iter().map(|(i, p)| (i, p, false)))
                 .sorted_by_key(|(id, _, symm)| (*id, !symm))
             {
<a href="#h3-63-10" id="h3-63-10" class="d">-                // Look for an existing LHS group with the same RHS.
</a><a href="#h3-63-11" id="h3-63-11" class="d">-                for (lhs, rhs, s) in grouped.iter_mut() {
</a><a href="#h3-63-12" id="h3-63-12" class="d">-                    if peers == *rhs &amp;&amp; symm == *s {
</a><a href="#h3-63-13" id="h3-63-13" class="d">-                        lhs.insert(id);
</a><a href="#h3-63-14" id="h3-63-14" class="d">-                        continue &#39;outer;
</a><a href="#h3-63-15" id="h3-63-15" class="d">-                    }
</a><a href="#h3-63-16" id="h3-63-16" class="i">+                // Look for an existing LHS group with the same RHS, and insert
</a><a href="#h3-63-17" id="h3-63-17" class="i">+                // this node into it. Otherwise, create a new LHS group.
</a><a href="#h3-63-18" id="h3-63-18" class="i">+                match grouped.iter_mut().find(|(_, rhs, s)| peers == *rhs &amp;&amp; symm == *s) {
</a><a href="#h3-63-19" id="h3-63-19" class="i">+                    Some((lhs, _, _)) =&gt; _ = lhs.insert(id),
</a><a href="#h3-63-20" id="h3-63-20" class="i">+                    None =&gt; grouped.push((HashSet::from([id]), peers, symm)),
</a>                 }
<a href="#h3-63-22" id="h3-63-22" class="d">-                // If we didn&#39;t find a match above, append a new LHS group.
</a><a href="#h3-63-23" id="h3-63-23" class="d">-                grouped.push((HashSet::from([id]), peers, symm))
</a>             }
 
             // Display the groups.
             for (lhs, rhs, symm) in grouped {
<a href="#h3-63-28" id="h3-63-28" class="d">-                output.push_str(&amp;format!(
</a><a href="#h3-63-29" id="h3-63-29" class="d">-                    &quot;{} {} {}\n&quot;,
</a><a href="#h3-63-30" id="h3-63-30" class="d">-                    lhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;),
</a><a href="#h3-63-31" id="h3-63-31" class="d">-                    if symm { &#39;&#39; } else { &#39;&#39; },
</a><a href="#h3-63-32" id="h3-63-32" class="d">-                    rhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;),
</a><a href="#h3-63-33" id="h3-63-33" class="d">-                ))
</a><a href="#h3-63-34" id="h3-63-34" class="i">+                let lhs = lhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;);
</a><a href="#h3-63-35" id="h3-63-35" class="i">+                let sep = if symm { &#39;&#39; } else { &#39;&#39; };
</a><a href="#h3-63-36" id="h3-63-36" class="i">+                let rhs = rhs.iter().sorted().map(|id| format!(&quot;n{id}&quot;)).join(&quot; &quot;);
</a><a href="#h3-63-37" id="h3-63-37" class="i">+                writeln!(output, &quot;{lhs} {sep} {rhs}&quot;).unwrap();
</a>             }
 
             output
<a href="#h3-64" id="h3-64" class="h">@@ -1916,17 +1891,15 @@ mod tests {
</a>                     format!(&quot;HeartbeatResponse match_index={match_index} read_seq={read_seq}&quot;)
                 }
                 Message::Append { base_index, base_term, entries } =&gt; {
<a href="#h3-64-3" id="h3-64-3" class="d">-                    format!(
</a><a href="#h3-64-4" id="h3-64-4" class="d">-                        &quot;Append base={base_index}@{base_term} [{}]&quot;,
</a><a href="#h3-64-5" id="h3-64-5" class="d">-                        entries.iter().map(|e| format!(&quot;{}@{}&quot;, e.index, e.term)).join(&quot; &quot;)
</a><a href="#h3-64-6" id="h3-64-6" class="d">-                    )
</a><a href="#h3-64-7" id="h3-64-7" class="i">+                    let ent = entries.iter().map(|e| format!(&quot;{}@{}&quot;, e.index, e.term)).join(&quot; &quot;);
</a><a href="#h3-64-8" id="h3-64-8" class="i">+                    format!(&quot;Append base={base_index}@{base_term} [{ent}]&quot;)
</a>                 }
                 Message::AppendResponse { match_index, reject_index } =&gt; {
                     match (match_index, reject_index) {
                         (0, 0) =&gt; panic!(&quot;match_index and reject_index both 0&quot;),
                         (match_index, 0) =&gt; format!(&quot;AppendResponse match_index={match_index}&quot;),
                         (0, reject_index) =&gt; format!(&quot;AppendResponse reject_index={reject_index}&quot;),
<a href="#h3-64-15" id="h3-64-15" class="d">-                        (_, _) =&gt; panic!(&quot;match_index and reject_index both non-zero&quot;),
</a><a href="#h3-64-16" id="h3-64-16" class="i">+                        (_, _) =&gt; panic!(&quot;match_index and reject_index both set&quot;),
</a>                     }
                 }
                 Message::ClientRequest { id, request } =&gt; {
<a href="#h3-65" id="h3-65" class="h">@@ -1965,10 +1938,8 @@ mod tests {
</a>             let role = match node {
                 Node::Candidate(_) =&gt; &quot;candidate&quot;.to_string(),
                 Node::Follower(node) =&gt; {
<a href="#h3-65-3" id="h3-65-3" class="d">-                    format!(
</a><a href="#h3-65-4" id="h3-65-4" class="d">-                        &quot;follower({})&quot;,
</a><a href="#h3-65-5" id="h3-65-5" class="d">-                        node.role.leader.map(|id| format!(&quot;n{id}&quot;)).unwrap_or_default()
</a><a href="#h3-65-6" id="h3-65-6" class="d">-                    )
</a><a href="#h3-65-7" id="h3-65-7" class="i">+                    let leader = node.role.leader.map(|id| format!(&quot;n{id}&quot;)).unwrap_or_default();
</a><a href="#h3-65-8" id="h3-65-8" class="i">+                    format!(&quot;follower({leader})&quot;)
</a>                 }
                 Node::Leader(_) =&gt; &quot;leader&quot;.to_string(),
             };
<a href="#h3-66" id="h3-66" class="h">@@ -1998,32 +1969,5 @@ mod tests {
</a>         fn format_strikethrough(s: &amp;str) -&gt; String {
             s.chars().flat_map(|c| [c, &#39;\u{0336}&#39;]).collect()
         }
<a href="#h3-66-3" id="h3-66-3" class="d">-
</a><a href="#h3-66-4" id="h3-66-4" class="d">-        /// Returns a borrow for a node&#39;s log.
</a><a href="#h3-66-5" id="h3-66-5" class="d">-        fn borrow_log(node: &amp;Node) -&gt; &amp;&#39;_ Log {
</a><a href="#h3-66-6" id="h3-66-6" class="d">-            match node {
</a><a href="#h3-66-7" id="h3-66-7" class="d">-                Node::Candidate(n) =&gt; &amp;n.log,
</a><a href="#h3-66-8" id="h3-66-8" class="d">-                Node::Follower(n) =&gt; &amp;n.log,
</a><a href="#h3-66-9" id="h3-66-9" class="d">-                Node::Leader(n) =&gt; &amp;n.log,
</a><a href="#h3-66-10" id="h3-66-10" class="d">-            }
</a><a href="#h3-66-11" id="h3-66-11" class="d">-        }
</a><a href="#h3-66-12" id="h3-66-12" class="d">-
</a><a href="#h3-66-13" id="h3-66-13" class="d">-        /// Returns a mutable borrow for a node&#39;s log.
</a><a href="#h3-66-14" id="h3-66-14" class="d">-        fn borrow_log_mut(node: &amp;mut Node) -&gt; &amp;&#39;_ mut Log {
</a><a href="#h3-66-15" id="h3-66-15" class="d">-            match node {
</a><a href="#h3-66-16" id="h3-66-16" class="d">-                Node::Candidate(n) =&gt; &amp;mut n.log,
</a><a href="#h3-66-17" id="h3-66-17" class="d">-                Node::Follower(n) =&gt; &amp;mut n.log,
</a><a href="#h3-66-18" id="h3-66-18" class="d">-                Node::Leader(n) =&gt; &amp;mut n.log,
</a><a href="#h3-66-19" id="h3-66-19" class="d">-            }
</a><a href="#h3-66-20" id="h3-66-20" class="d">-        }
</a><a href="#h3-66-21" id="h3-66-21" class="d">-
</a><a href="#h3-66-22" id="h3-66-22" class="d">-        /// Returns a borrow for a node&#39;s state machine.
</a><a href="#h3-66-23" id="h3-66-23" class="d">-        fn borrow_state(node: &amp;Node) -&gt; &amp;&#39;_ dyn State {
</a><a href="#h3-66-24" id="h3-66-24" class="d">-            match node {
</a><a href="#h3-66-25" id="h3-66-25" class="d">-                Node::Candidate(n) =&gt; n.state.as_ref(),
</a><a href="#h3-66-26" id="h3-66-26" class="d">-                Node::Follower(n) =&gt; n.state.as_ref(),
</a><a href="#h3-66-27" id="h3-66-27" class="d">-                Node::Leader(n) =&gt; n.state.as_ref(),
</a><a href="#h3-66-28" id="h3-66-28" class="d">-            }
</a><a href="#h3-66-29" id="h3-66-29" class="d">-        }
</a>     }
 }
<b>diff --git a/<a id="h4" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -47,6 +47,9 @@ pub trait State: Send {
</a>     ///
     /// This is only executed on a single replica/node, so it must not result in
     /// any state changes (i.e. it must not write).
<a href="#h4-0-3" id="h4-0-3" class="i">+    ///
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    /// TODO: consider making this &amp;mut, since the storage engine requires
</a><a href="#h4-0-5" id="h4-0-5" class="i">+    /// exclusive access anyway.
</a>     fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;&gt;;
 }
 
<b>diff --git a/<a id="h5" href="../file/src/raft/testscripts/log/get.html">src/raft/testscripts/log/get</a> b/<a href="../file/src/raft/testscripts/log/get.html">src/raft/testscripts/log/get</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -21,7 +21,6 @@ get 1 2
</a> 2@1 foo
 
 # get returns None for missing entries, and for index 0.
<a href="#h5-0-3" id="h5-0-3" class="d">-# TODO: consider erroring on index 0.
</a> get 4 0
 ---
 None
<b>diff --git a/<a id="h6" href="../file/src/raft/testscripts/node/append.html">src/raft/testscripts/node/append</a> b/<a href="../file/src/raft/testscripts/node/append.html">src/raft/testscripts/node/append</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h6-0-3" id="h6-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h6-0-4" id="h6-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h6-0-5" id="h6-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h6-0-6" id="h6-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h6-0-7" id="h6-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h6-0-8" id="h6-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Propose a single write.
 put 1 foo=bar
<a href="#h6-1" id="h6-1" class="h">@@ -16,9 +16,9 @@ n1@1  n3 Append base=1@1 [2@1]
</a> 
 status
 ---
<a href="#h6-1-3" id="h6-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:13 3:13}
</a><a href="#h6-1-4" id="h6-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h6-1-5" id="h6-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h6-1-6" id="h6-1-6" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:13 3:13}
</a><a href="#h6-1-7" id="h6-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h6-1-8" id="h6-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Append it to both followers.
 deliver
<a href="#h6-2" id="h6-2" class="h">@@ -38,6 +38,6 @@ c1@1 put foo=bar  2
</a> 
 status
 ---
<a href="#h6-2-3" id="h6-2-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h6-2-4" id="h6-2-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h6-2-5" id="h6-2-5" class="d">-n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h6-2-6" id="h6-2-6" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h6-2-7" id="h6-2-7" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h6-2-8" id="h6-2-8" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h7" href="../file/src/raft/testscripts/node/append_base_missing.html">src/raft/testscripts/node/append_base_missing</a> b/<a href="../file/src/raft/testscripts/node/append_base_missing.html">src/raft/testscripts/node/append_base_missing</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -4,9 +4,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h7-0-3" id="h7-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h7-0-4" id="h7-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-5" id="h7-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-6" id="h7-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h7-0-7" id="h7-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h7-0-8" id="h7-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n3 so that it does not receive writes.
 partition 3
<a href="#h7-1" id="h7-1" class="h">@@ -20,9 +20,9 @@ n3  n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h7-1-3" id="h7-1-3" class="d">-n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:45 3:15}
</a><a href="#h7-1-4" id="h7-1-4" class="d">-n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h7-1-5" id="h7-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-1-6" id="h7-1-6" class="i">+n1@1 leader last=4@1 commit=4@1 applied=4 progress={2:45 3:15}
</a><a href="#h7-1-7" id="h7-1-7" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 applied=4
</a><a href="#h7-1-8" id="h7-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Heal the partition, and propose another write.
 heal
<a href="#h7-2" id="h7-2" class="h">@@ -47,7 +47,7 @@ deliver 1
</a> status 1
 ---
 n1@1  n3 Append base=1@1 [2@1 3@1 4@1 5@1]
<a href="#h7-2-3" id="h7-2-3" class="d">-n1@1 leader last=5@1 commit=4@1 apply=4 progress={2:46 3:16}
</a><a href="#h7-2-4" id="h7-2-4" class="i">+n1@1 leader last=5@1 commit=4@1 applied=4 progress={2:46 3:16}
</a> 
 deliver 3
 ---
<a href="#h7-3" id="h7-3" class="h">@@ -68,6 +68,6 @@ c1@1 put c=3  5
</a> # The progress is also updated.
 status
 ---
<a href="#h7-3-3" id="h7-3-3" class="d">-n1@1 leader last=5@1 commit=5@1 apply=5 progress={2:46 3:56}
</a><a href="#h7-3-4" id="h7-3-4" class="d">-n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h7-3-5" id="h7-3-5" class="d">-n3@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><a href="#h7-3-6" id="h7-3-6" class="i">+n1@1 leader last=5@1 commit=5@1 applied=5 progress={2:46 3:56}
</a><a href="#h7-3-7" id="h7-3-7" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 applied=4
</a><a href="#h7-3-8" id="h7-3-8" class="i">+n3@1 follower(n1) last=5@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h8" href="../file/src/raft/testscripts/node/append_base_missing_all.html">src/raft/testscripts/node/append_base_missing_all</a> b/<a href="../file/src/raft/testscripts/node/append_base_missing_all.html">src/raft/testscripts/node/append_base_missing_all</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h8-0-3" id="h8-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h8-0-4" id="h8-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h8-0-5" id="h8-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h8-0-6" id="h8-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h8-0-7" id="h8-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h8-0-8" id="h8-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Partition n3 so that it does not receive writes.
 partition 3
<a href="#h8-1" id="h8-1" class="h">@@ -17,9 +17,9 @@ n3  n1 n2
</a> (stabilize)
 status
 ---
<a href="#h8-1-3" id="h8-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:02}
</a><a href="#h8-1-4" id="h8-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h8-1-5" id="h8-1-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h8-1-6" id="h8-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:02}
</a><a href="#h8-1-7" id="h8-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h8-1-8" id="h8-1-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Replicate a couple of writes.
 (put 1 a=1)
<a href="#h8-2" id="h8-2" class="h">@@ -28,9 +28,9 @@ n3@0 follower() last=0@0 commit=0@0 apply=0
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h8-2-3" id="h8-2-3" class="d">-n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:45 3:05}
</a><a href="#h8-2-4" id="h8-2-4" class="d">-n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h8-2-5" id="h8-2-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h8-2-6" id="h8-2-6" class="i">+n1@1 leader last=4@1 commit=4@1 applied=4 progress={2:45 3:05}
</a><a href="#h8-2-7" id="h8-2-7" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 applied=4
</a><a href="#h8-2-8" id="h8-2-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Heal the partition, and propose another write.
 heal
<a href="#h8-3" id="h8-3" class="h">@@ -53,7 +53,7 @@ deliver 1
</a> status 1
 ---
 n1@1  n3 Append base=0@0 [1@1 2@1 3@1 4@1 5@1]
<a href="#h8-3-3" id="h8-3-3" class="d">-n1@1 leader last=5@1 commit=4@1 apply=4 progress={2:46 3:06}
</a><a href="#h8-3-4" id="h8-3-4" class="i">+n1@1 leader last=5@1 commit=4@1 applied=4 progress={2:46 3:06}
</a> 
 deliver 3
 ---
<a href="#h8-4" id="h8-4" class="h">@@ -75,6 +75,6 @@ c1@1 put c=3  5
</a> # The progress is also updated.
 status
 ---
<a href="#h8-4-3" id="h8-4-3" class="d">-n1@1 leader last=5@1 commit=5@1 apply=5 progress={2:46 3:56}
</a><a href="#h8-4-4" id="h8-4-4" class="d">-n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h8-4-5" id="h8-4-5" class="d">-n3@1 follower(n1) last=5@1 commit=0@0 apply=0
</a><a href="#h8-4-6" id="h8-4-6" class="i">+n1@1 leader last=5@1 commit=5@1 applied=5 progress={2:46 3:56}
</a><a href="#h8-4-7" id="h8-4-7" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 applied=4
</a><a href="#h8-4-8" id="h8-4-8" class="i">+n3@1 follower(n1) last=5@1 commit=0@0 applied=0
</a><b>diff --git a/<a id="h9" href="../file/src/raft/testscripts/node/append_commit_quorum.html">src/raft/testscripts/node/append_commit_quorum</a> b/<a href="../file/src/raft/testscripts/node/append_commit_quorum.html">src/raft/testscripts/node/append_commit_quorum</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -3,12 +3,12 @@
</a> 
 cluster nodes=6 leader=1
 ---
<a href="#h9-0-3" id="h9-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12 6:12}
</a><a href="#h9-0-4" id="h9-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-5" id="h9-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-6" id="h9-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-7" id="h9-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-8" id="h9-0-8" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-0-9" id="h9-0-9" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12 6:12}
</a><a href="#h9-0-10" id="h9-0-10" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-0-11" id="h9-0-11" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-0-12" id="h9-0-12" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-0-13" id="h9-0-13" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-0-14" id="h9-0-14" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Incrementally disconnect all nodes except one and then propose a write, to
 # generate an increasing quorum index.
<a href="#h9-1" id="h9-1" class="h">@@ -33,12 +33,12 @@ n2@1  n1 AppendResponse match_index=2
</a> 
 status
 ---
<a href="#h9-1-3" id="h9-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:23 3:13 4:13 5:13 6:13}
</a><a href="#h9-1-4" id="h9-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h9-1-5" id="h9-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-1-6" id="h9-1-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-1-7" id="h9-1-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-1-8" id="h9-1-8" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-1-9" id="h9-1-9" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:23 3:13 4:13 5:13 6:13}
</a><a href="#h9-1-10" id="h9-1-10" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h9-1-11" id="h9-1-11" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-1-12" id="h9-1-12" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-1-13" id="h9-1-13" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-1-14" id="h9-1-14" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicating 2-3 to n3 does not commit.
 heal
<a href="#h9-2" id="h9-2" class="h">@@ -65,12 +65,12 @@ n3@1  n1 AppendResponse match_index=3
</a> 
 status
 ---
<a href="#h9-2-3" id="h9-2-3" class="d">-n1@1 leader last=3@1 commit=1@1 apply=1 progress={2:24 3:34 4:14 5:14 6:14}
</a><a href="#h9-2-4" id="h9-2-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h9-2-5" id="h9-2-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h9-2-6" id="h9-2-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-2-7" id="h9-2-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-2-8" id="h9-2-8" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-2-9" id="h9-2-9" class="i">+n1@1 leader last=3@1 commit=1@1 applied=1 progress={2:24 3:34 4:14 5:14 6:14}
</a><a href="#h9-2-10" id="h9-2-10" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h9-2-11" id="h9-2-11" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h9-2-12" id="h9-2-12" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-2-13" id="h9-2-13" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-2-14" id="h9-2-14" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicating 2-4 to n4 commits 2.
 heal
<a href="#h9-3" id="h9-3" class="h">@@ -102,12 +102,12 @@ c1@1 put a=1  2
</a> 
 status
 ---
<a href="#h9-3-3" id="h9-3-3" class="d">-n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:25 3:35 4:45 5:15 6:15}
</a><a href="#h9-3-4" id="h9-3-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h9-3-5" id="h9-3-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h9-3-6" id="h9-3-6" class="d">-n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h9-3-7" id="h9-3-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-3-8" id="h9-3-8" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-3-9" id="h9-3-9" class="i">+n1@1 leader last=4@1 commit=2@1 applied=2 progress={2:25 3:35 4:45 5:15 6:15}
</a><a href="#h9-3-10" id="h9-3-10" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h9-3-11" id="h9-3-11" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h9-3-12" id="h9-3-12" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><a href="#h9-3-13" id="h9-3-13" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h9-3-14" id="h9-3-14" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicating 2-5 to n5 commits 3.
 heal
<a href="#h9-4" id="h9-4" class="h">@@ -140,12 +140,12 @@ c1@1 put b=2  3
</a> 
 status
 ---
<a href="#h9-4-3" id="h9-4-3" class="d">-n1@1 leader last=5@1 commit=3@1 apply=3 progress={2:26 3:36 4:46 5:56 6:16}
</a><a href="#h9-4-4" id="h9-4-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h9-4-5" id="h9-4-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h9-4-6" id="h9-4-6" class="d">-n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h9-4-7" id="h9-4-7" class="d">-n5@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><a href="#h9-4-8" id="h9-4-8" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h9-4-9" id="h9-4-9" class="i">+n1@1 leader last=5@1 commit=3@1 applied=3 progress={2:26 3:36 4:46 5:56 6:16}
</a><a href="#h9-4-10" id="h9-4-10" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h9-4-11" id="h9-4-11" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h9-4-12" id="h9-4-12" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><a href="#h9-4-13" id="h9-4-13" class="i">+n5@1 follower(n1) last=5@1 commit=1@1 applied=1
</a><a href="#h9-4-14" id="h9-4-14" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicating 2-6 to n6 commits 4.
 heal
<a href="#h9-5" id="h9-5" class="h">@@ -179,12 +179,12 @@ c1@1 put c=3  4
</a> 
 status
 ---
<a href="#h9-5-3" id="h9-5-3" class="d">-n1@1 leader last=6@1 commit=4@1 apply=4 progress={2:27 3:37 4:47 5:57 6:67}
</a><a href="#h9-5-4" id="h9-5-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h9-5-5" id="h9-5-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h9-5-6" id="h9-5-6" class="d">-n4@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h9-5-7" id="h9-5-7" class="d">-n5@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><a href="#h9-5-8" id="h9-5-8" class="d">-n6@1 follower(n1) last=6@1 commit=1@1 apply=1
</a><a href="#h9-5-9" id="h9-5-9" class="i">+n1@1 leader last=6@1 commit=4@1 applied=4 progress={2:27 3:37 4:47 5:57 6:67}
</a><a href="#h9-5-10" id="h9-5-10" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h9-5-11" id="h9-5-11" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h9-5-12" id="h9-5-12" class="i">+n4@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><a href="#h9-5-13" id="h9-5-13" class="i">+n5@1 follower(n1) last=5@1 commit=1@1 applied=1
</a><a href="#h9-5-14" id="h9-5-14" class="i">+n6@1 follower(n1) last=6@1 commit=1@1 applied=1
</a> 
 # Healing the partition and proposing another write replicates and commits all
 # entries.
<a href="#h9-6" id="h9-6" class="h">@@ -244,9 +244,9 @@ c1@1 put f=6  7
</a> 
 status
 ---
<a href="#h9-6-3" id="h9-6-3" class="d">-n1@1 leader last=7@1 commit=7@1 apply=7 progress={2:78 3:78 4:78 5:78 6:78}
</a><a href="#h9-6-4" id="h9-6-4" class="d">-n2@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h9-6-5" id="h9-6-5" class="d">-n3@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h9-6-6" id="h9-6-6" class="d">-n4@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h9-6-7" id="h9-6-7" class="d">-n5@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h9-6-8" id="h9-6-8" class="d">-n6@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h9-6-9" id="h9-6-9" class="i">+n1@1 leader last=7@1 commit=7@1 applied=7 progress={2:78 3:78 4:78 5:78 6:78}
</a><a href="#h9-6-10" id="h9-6-10" class="i">+n2@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><a href="#h9-6-11" id="h9-6-11" class="i">+n3@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><a href="#h9-6-12" id="h9-6-12" class="i">+n4@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><a href="#h9-6-13" id="h9-6-13" class="i">+n5@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><a href="#h9-6-14" id="h9-6-14" class="i">+n6@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h10" href="../file/src/raft/testscripts/node/append_initial.html">src/raft/testscripts/node/append_initial</a> b/<a href="../file/src/raft/testscripts/node/append_initial.html">src/raft/testscripts/node/append_initial</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h10-0-3" id="h10-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h10-0-4" id="h10-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h10-0-5" id="h10-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h10-0-6" id="h10-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h10-0-7" id="h10-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h10-0-8" id="h10-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Partition n3 so that is has an empty log.
 partition 3
<a href="#h10-1" id="h10-1" class="h">@@ -39,9 +39,9 @@ n1@1 apply 1@1 None
</a> 
 status
 ---
<a href="#h10-1-3" id="h10-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:02}
</a><a href="#h10-1-4" id="h10-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h10-1-5" id="h10-1-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h10-1-6" id="h10-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:02}
</a><a href="#h10-1-7" id="h10-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h10-1-8" id="h10-1-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Heal the partition.
 heal
<a href="#h10-2" id="h10-2" class="h">@@ -77,12 +77,12 @@ n3@1  n1 AppendResponse match_index=2
</a> 
 log
 ---
<a href="#h10-2-3" id="h10-2-3" class="d">-n1@1 last=2@1 commit=2@1
</a><a href="#h10-2-4" id="h10-2-4" class="i">+n1@1 term=1 last=2@1 commit=2@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put foo=bar
<a href="#h10-2-7" id="h10-2-7" class="d">-n2@1 last=2@1 commit=0@0
</a><a href="#h10-2-8" id="h10-2-8" class="i">+n2@1 term=1 last=2@1 commit=0@0 vote=Some(1)
</a> n2@1 entry 1@1 None
 n2@1 entry 2@1 put foo=bar
<a href="#h10-2-11" id="h10-2-11" class="d">-n3@1 last=2@1 commit=0@0
</a><a href="#h10-2-12" id="h10-2-12" class="i">+n3@1 term=1 last=2@1 commit=0@0 vote=None
</a> n3@1 entry 1@1 None
 n3@1 entry 2@1 put foo=bar
<b>diff --git a/<a id="h11" href="../file/src/raft/testscripts/node/append_max_entries.html">src/raft/testscripts/node/append_max_entries</a> b/<a href="../file/src/raft/testscripts/node/append_max_entries.html">src/raft/testscripts/node/append_max_entries</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1 max_append_entries=2
 ---
<a href="#h11-0-3" id="h11-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h11-0-4" id="h11-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-5" id="h11-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-6" id="h11-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h11-0-7" id="h11-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h11-0-8" id="h11-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n3.
 partition 3
<a href="#h11-1" id="h11-1" class="h">@@ -23,9 +23,9 @@ n3  n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h11-1-3" id="h11-1-3" class="d">-n1@1 leader last=8@1 commit=8@1 apply=8 progress={2:89 3:19}
</a><a href="#h11-1-4" id="h11-1-4" class="d">-n2@1 follower(n1) last=8@1 commit=8@1 apply=8
</a><a href="#h11-1-5" id="h11-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-1-6" id="h11-1-6" class="i">+n1@1 leader last=8@1 commit=8@1 applied=8 progress={2:89 3:19}
</a><a href="#h11-1-7" id="h11-1-7" class="i">+n2@1 follower(n1) last=8@1 commit=8@1 applied=8
</a><a href="#h11-1-8" id="h11-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Heal the partition.
 heal
<b>diff --git a/<a id="h12" href="../file/src/raft/testscripts/node/append_pipeline.html">src/raft/testscripts/node/append_pipeline</a> b/<a href="../file/src/raft/testscripts/node/append_pipeline.html">src/raft/testscripts/node/append_pipeline</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h12-0-3" id="h12-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h12-0-4" id="h12-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-5" id="h12-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-6" id="h12-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h12-0-7" id="h12-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h12-0-8" id="h12-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Propose a single write. The progress next index increases to 3.
 put 1 a=1
<a href="#h12-1" id="h12-1" class="h">@@ -17,9 +17,9 @@ n1@1  n3 Append base=1@1 [2@1]
</a> 
 status
 ---
<a href="#h12-1-3" id="h12-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:13 3:13}
</a><a href="#h12-1-4" id="h12-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-1-5" id="h12-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-1-6" id="h12-1-6" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:13 3:13}
</a><a href="#h12-1-7" id="h12-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h12-1-8" id="h12-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Propose two more writes. Appends are sent without past duplicates.
 put 1 b=2
<a href="#h12-2" id="h12-2" class="h">@@ -36,9 +36,9 @@ n1@1  n3 Append base=3@1 [4@1]
</a> 
 status
 ---
<a href="#h12-2-3" id="h12-2-3" class="d">-n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:15 3:15}
</a><a href="#h12-2-4" id="h12-2-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-2-5" id="h12-2-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-2-6" id="h12-2-6" class="i">+n1@1 leader last=4@1 commit=1@1 applied=1 progress={2:15 3:15}
</a><a href="#h12-2-7" id="h12-2-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h12-2-8" id="h12-2-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # The appends are received and acked sequentially.
 deliver
<a href="#h12-3" id="h12-3" class="h">@@ -77,6 +77,6 @@ c1@1 put c=3  4
</a> # heartbeat).
 status
 ---
<a href="#h12-3-3" id="h12-3-3" class="d">-n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:45 3:45}
</a><a href="#h12-3-4" id="h12-3-4" class="d">-n2@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h12-3-5" id="h12-3-5" class="d">-n3@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h12-3-6" id="h12-3-6" class="i">+n1@1 leader last=4@1 commit=4@1 applied=4 progress={2:45 3:45}
</a><a href="#h12-3-7" id="h12-3-7" class="i">+n2@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><a href="#h12-3-8" id="h12-3-8" class="i">+n3@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h13" href="../file/src/raft/testscripts/node/append_probe_divergent_first.html">src/raft/testscripts/node/append_probe_divergent_first</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_first.html">src/raft/testscripts/node/append_probe_divergent_first</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -3,11 +3,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h13-0-3" id="h13-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-0-4" id="h13-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-5" id="h13-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-6" id="h13-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-7" id="h13-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-8" id="h13-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-0-9" id="h13-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-0-10" id="h13-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-0-11" id="h13-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-0-12" id="h13-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n1-n2
 partition 1 2
<a href="#h13-1" id="h13-1" class="h">@@ -22,11 +22,11 @@ n1 n2  n3 n4 n5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h13-1-3" id="h13-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-1-4" id="h13-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-1-5" id="h13-1-5" class="d">-n3@2 leader last=3@2 commit=3@2 apply=3 progress={1:04 2:04 4:34 5:34}
</a><a href="#h13-1-6" id="h13-1-6" class="d">-n4@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h13-1-7" id="h13-1-7" class="d">-n5@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h13-1-8" id="h13-1-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-1-9" id="h13-1-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-1-10" id="h13-1-10" class="i">+n3@2 leader last=3@2 commit=3@2 applied=3 progress={1:04 2:04 4:34 5:34}
</a><a href="#h13-1-11" id="h13-1-11" class="i">+n4@2 follower(n3) last=3@2 commit=3@2 applied=3
</a><a href="#h13-1-12" id="h13-1-12" class="i">+n5@2 follower(n3) last=3@2 commit=3@2 applied=3
</a> 
 (campaign 4)
 (stabilize)
<a href="#h13-2" id="h13-2" class="h">@@ -34,11 +34,11 @@ n5@2 follower(n3) last=3@2 commit=3@2 apply=3
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h13-2-3" id="h13-2-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-2-4" id="h13-2-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-2-5" id="h13-2-5" class="d">-n3@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h13-2-6" id="h13-2-6" class="d">-n4@3 leader last=5@3 commit=5@3 apply=5 progress={1:06 2:06 3:56 5:56}
</a><a href="#h13-2-7" id="h13-2-7" class="d">-n5@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h13-2-8" id="h13-2-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-2-9" id="h13-2-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-2-10" id="h13-2-10" class="i">+n3@3 follower(n4) last=5@3 commit=5@3 applied=5
</a><a href="#h13-2-11" id="h13-2-11" class="i">+n4@3 leader last=5@3 commit=5@3 applied=5 progress={1:06 2:06 3:56 5:56}
</a><a href="#h13-2-12" id="h13-2-12" class="i">+n5@3 follower(n4) last=5@3 commit=5@3 applied=5
</a> 
 (campaign 5)
 (stabilize)
<a href="#h13-3" id="h13-3" class="h">@@ -46,11 +46,11 @@ n5@3 follower(n4) last=5@3 commit=5@3 apply=5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h13-3-3" id="h13-3-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-3-4" id="h13-3-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-3-5" id="h13-3-5" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-3-6" id="h13-3-6" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-3-7" id="h13-3-7" class="d">-n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:08 2:08 3:78 4:78}
</a><a href="#h13-3-8" id="h13-3-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h13-3-9" id="h13-3-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h13-3-10" id="h13-3-10" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-3-11" id="h13-3-11" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-3-12" id="h13-3-12" class="i">+n5@4 leader last=7@4 commit=7@4 applied=7 progress={1:08 2:08 3:78 4:78}
</a> 
 # Propose writes in the minority partition as well.
 (put 1 a=2)
<a href="#h13-4" id="h13-4" class="h">@@ -62,15 +62,15 @@ n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:08 2:08 3:78 4:7
</a> (stabilize)
 status
 ---
<a href="#h13-4-3" id="h13-4-3" class="d">-n1@1 leader last=7@1 commit=1@1 apply=1 progress={2:78 3:18 4:18 5:18}
</a><a href="#h13-4-4" id="h13-4-4" class="d">-n2@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h13-4-5" id="h13-4-5" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-4-6" id="h13-4-6" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-4-7" id="h13-4-7" class="d">-n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:08 2:08 3:78 4:78}
</a><a href="#h13-4-8" id="h13-4-8" class="i">+n1@1 leader last=7@1 commit=1@1 applied=1 progress={2:78 3:18 4:18 5:18}
</a><a href="#h13-4-9" id="h13-4-9" class="i">+n2@1 follower(n1) last=7@1 commit=1@1 applied=1
</a><a href="#h13-4-10" id="h13-4-10" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-4-11" id="h13-4-11" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-4-12" id="h13-4-12" class="i">+n5@4 leader last=7@4 commit=7@4 applied=7 progress={1:08 2:08 3:78 4:78}
</a> 
 log 1 5
 ---
<a href="#h13-4-16" id="h13-4-16" class="d">-n1@1 last=7@1 commit=1@1
</a><a href="#h13-4-17" id="h13-4-17" class="i">+n1@1 term=1 last=7@1 commit=1@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put a=2
 n1@1 entry 3@1 put a=3
<a href="#h13-5" id="h13-5" class="h">@@ -78,7 +78,7 @@ n1@1 entry 4@1 put a=4
</a> n1@1 entry 5@1 put a=5
 n1@1 entry 6@1 put a=6
 n1@1 entry 7@1 put a=7
<a href="#h13-5-3" id="h13-5-3" class="d">-n5@4 last=7@4 commit=7@4
</a><a href="#h13-5-4" id="h13-5-4" class="i">+n5@4 term=4 last=7@4 commit=7@4 vote=Some(5)
</a> n5@4 entry 1@1 None
 n5@4 entry 2@2 None
 n5@4 entry 3@2 put a=1
<a href="#h13-6" id="h13-6" class="h">@@ -131,7 +131,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=6@4 []
 n5@4  n2 Append base=6@4 []
<a href="#h13-6-3" id="h13-6-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:07 2:07 3:79 4:79}
</a><a href="#h13-6-4" id="h13-6-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:07 2:07 3:79 4:79}
</a> n1@4  n5 AppendResponse reject_index=6
 n2@4  n5 AppendResponse reject_index=6
 
<a href="#h13-7" id="h13-7" class="h">@@ -143,7 +143,7 @@ n5@4  n1 Append base=5@3 []
</a> n5@4  n2 Append base=5@3 []
 n1@4  n5 AppendResponse reject_index=5
 n2@4  n5 AppendResponse reject_index=5
<a href="#h13-7-3" id="h13-7-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:06 2:06 3:79 4:79}
</a><a href="#h13-7-4" id="h13-7-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:06 2:06 3:79 4:79}
</a> 
 deliver 5
 status 5
<a href="#h13-8" id="h13-8" class="h">@@ -151,7 +151,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=4@3 []
 n5@4  n2 Append base=4@3 []
<a href="#h13-8-3" id="h13-8-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:05 2:05 3:79 4:79}
</a><a href="#h13-8-4" id="h13-8-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:05 2:05 3:79 4:79}
</a> n1@4  n5 AppendResponse reject_index=4
 n2@4  n5 AppendResponse reject_index=4
 
<a href="#h13-9" id="h13-9" class="h">@@ -161,7 +161,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=3@2 []
 n5@4  n2 Append base=3@2 []
<a href="#h13-9-3" id="h13-9-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:04 2:04 3:79 4:79}
</a><a href="#h13-9-4" id="h13-9-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:04 2:04 3:79 4:79}
</a> n1@4  n5 AppendResponse reject_index=3
 n2@4  n5 AppendResponse reject_index=3
 
<a href="#h13-10" id="h13-10" class="h">@@ -171,7 +171,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=2@2 []
 n5@4  n2 Append base=2@2 []
<a href="#h13-10-3" id="h13-10-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:03 2:03 3:79 4:79}
</a><a href="#h13-10-4" id="h13-10-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:03 2:03 3:79 4:79}
</a> n1@4  n5 AppendResponse reject_index=2
 n2@4  n5 AppendResponse reject_index=2
 
<a href="#h13-11" id="h13-11" class="h">@@ -181,7 +181,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=1@1 []
 n5@4  n2 Append base=1@1 []
<a href="#h13-11-3" id="h13-11-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:02 2:02 3:79 4:79}
</a><a href="#h13-11-4" id="h13-11-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:02 2:02 3:79 4:79}
</a> n1@4  n5 AppendResponse match_index=1
 n2@4  n5 AppendResponse match_index=1
 
<a href="#h13-12" id="h13-12" class="h">@@ -192,7 +192,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
 n5@4  n2 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
<a href="#h13-12-3" id="h13-12-3" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:19 2:19 3:79 4:79}
</a><a href="#h13-12-4" id="h13-12-4" class="i">+n5@4 leader last=8@4 commit=7@4 applied=7 progress={1:19 2:19 3:79 4:79}
</a> n1@4 append 2@2 None
 n1@4 append 3@2 put a=1
 n1@4 append 4@3 None
<a href="#h13-13" id="h13-13" class="h">@@ -219,18 +219,18 @@ c5@4 put d=4  8
</a> 
 status
 ---
<a href="#h13-13-3" id="h13-13-3" class="d">-n1@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h13-13-4" id="h13-13-4" class="d">-n2@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h13-13-5" id="h13-13-5" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-13-6" id="h13-13-6" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-13-7" id="h13-13-7" class="d">-n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:89 2:89 3:79 4:79}
</a><a href="#h13-13-8" id="h13-13-8" class="i">+n1@4 follower(n5) last=8@4 commit=1@1 applied=1
</a><a href="#h13-13-9" id="h13-13-9" class="i">+n2@4 follower(n5) last=8@4 commit=1@1 applied=1
</a><a href="#h13-13-10" id="h13-13-10" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-13-11" id="h13-13-11" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 applied=7
</a><a href="#h13-13-12" id="h13-13-12" class="i">+n5@4 leader last=8@4 commit=8@4 applied=8 progress={1:89 2:89 3:79 4:79}
</a> 
 # Stabilize the cluster.
 (stabilize heartbeat=true)
 status
 ---
<a href="#h13-13-18" id="h13-13-18" class="d">-n1@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-13-19" id="h13-13-19" class="d">-n2@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-13-20" id="h13-13-20" class="d">-n3@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-13-21" id="h13-13-21" class="d">-n4@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-13-22" id="h13-13-22" class="d">-n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:89 2:89 3:89 4:89}
</a><a href="#h13-13-23" id="h13-13-23" class="i">+n1@4 follower(n5) last=8@4 commit=8@4 applied=8
</a><a href="#h13-13-24" id="h13-13-24" class="i">+n2@4 follower(n5) last=8@4 commit=8@4 applied=8
</a><a href="#h13-13-25" id="h13-13-25" class="i">+n3@4 follower(n5) last=8@4 commit=8@4 applied=8
</a><a href="#h13-13-26" id="h13-13-26" class="i">+n4@4 follower(n5) last=8@4 commit=8@4 applied=8
</a><a href="#h13-13-27" id="h13-13-27" class="i">+n5@4 leader last=8@4 commit=8@4 applied=8 progress={1:89 2:89 3:89 4:89}
</a><b>diff --git a/<a id="h14" href="../file/src/raft/testscripts/node/append_probe_divergent_long.html">src/raft/testscripts/node/append_probe_divergent_long</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_long.html">src/raft/testscripts/node/append_probe_divergent_long</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -3,11 +3,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h14-0-3" id="h14-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h14-0-4" id="h14-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-5" id="h14-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-6" id="h14-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-7" id="h14-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-8" id="h14-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h14-0-9" id="h14-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h14-0-10" id="h14-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h14-0-11" id="h14-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h14-0-12" id="h14-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Make a couple of writes to ensure a common log prefix.
 (put 1 a=1)
<a href="#h14-1" id="h14-1" class="h">@@ -15,11 +15,11 @@ n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> (stabilize)
 status
 ---
<a href="#h14-1-3" id="h14-1-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-1-4" id="h14-1-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-1-5" id="h14-1-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-1-6" id="h14-1-6" class="d">-n4@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-1-7" id="h14-1-7" class="d">-n5@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-1-8" id="h14-1-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-1-9" id="h14-1-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-1-10" id="h14-1-10" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-1-11" id="h14-1-11" class="i">+n4@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-1-12" id="h14-1-12" class="i">+n5@1 follower(n1) last=3@1 commit=1@1 applied=1
</a> 
 # Partition n1-n2
 partition 1 2
<a href="#h14-2" id="h14-2" class="h">@@ -34,11 +34,11 @@ n1 n2  n3 n4 n5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h14-2-3" id="h14-2-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-2-4" id="h14-2-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-2-5" id="h14-2-5" class="d">-n3@2 leader last=5@2 commit=5@2 apply=5 progress={1:06 2:06 4:56 5:56}
</a><a href="#h14-2-6" id="h14-2-6" class="d">-n4@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h14-2-7" id="h14-2-7" class="d">-n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h14-2-8" id="h14-2-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-2-9" id="h14-2-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-2-10" id="h14-2-10" class="i">+n3@2 leader last=5@2 commit=5@2 applied=5 progress={1:06 2:06 4:56 5:56}
</a><a href="#h14-2-11" id="h14-2-11" class="i">+n4@2 follower(n3) last=5@2 commit=5@2 applied=5
</a><a href="#h14-2-12" id="h14-2-12" class="i">+n5@2 follower(n3) last=5@2 commit=5@2 applied=5
</a> 
 (campaign 4)
 (stabilize)
<a href="#h14-3" id="h14-3" class="h">@@ -46,11 +46,11 @@ n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h14-3-3" id="h14-3-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-3-4" id="h14-3-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-3-5" id="h14-3-5" class="d">-n3@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h14-3-6" id="h14-3-6" class="d">-n4@3 leader last=7@3 commit=7@3 apply=7 progress={1:08 2:08 3:78 5:78}
</a><a href="#h14-3-7" id="h14-3-7" class="d">-n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h14-3-8" id="h14-3-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-3-9" id="h14-3-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-3-10" id="h14-3-10" class="i">+n3@3 follower(n4) last=7@3 commit=7@3 applied=7
</a><a href="#h14-3-11" id="h14-3-11" class="i">+n4@3 leader last=7@3 commit=7@3 applied=7 progress={1:08 2:08 3:78 5:78}
</a><a href="#h14-3-12" id="h14-3-12" class="i">+n5@3 follower(n4) last=7@3 commit=7@3 applied=7
</a> 
 (campaign 5)
 (stabilize)
<a href="#h14-4" id="h14-4" class="h">@@ -58,11 +58,11 @@ n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h14-4-3" id="h14-4-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-4-4" id="h14-4-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-4-5" id="h14-4-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-4-6" id="h14-4-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-4-7" id="h14-4-7" class="d">-n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:910}
</a><a href="#h14-4-8" id="h14-4-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h14-4-9" id="h14-4-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h14-4-10" id="h14-4-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-4-11" id="h14-4-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-4-12" id="h14-4-12" class="i">+n5@4 leader last=9@4 commit=9@4 applied=9 progress={1:010 2:010 3:910 4:910}
</a> 
 # Propose writes in the minority partition as well, to build up a log
 # longer than the majority log.
<a href="#h14-5" id="h14-5" class="h">@@ -78,15 +78,15 @@ n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:9
</a> (stabilize)
 status
 ---
<a href="#h14-5-3" id="h14-5-3" class="d">-n1@1 leader last=12@1 commit=3@1 apply=3 progress={2:1213 3:313 4:313 5:313}
</a><a href="#h14-5-4" id="h14-5-4" class="d">-n2@1 follower(n1) last=12@1 commit=1@1 apply=1
</a><a href="#h14-5-5" id="h14-5-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-5-6" id="h14-5-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-5-7" id="h14-5-7" class="d">-n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:910}
</a><a href="#h14-5-8" id="h14-5-8" class="i">+n1@1 leader last=12@1 commit=3@1 applied=3 progress={2:1213 3:313 4:313 5:313}
</a><a href="#h14-5-9" id="h14-5-9" class="i">+n2@1 follower(n1) last=12@1 commit=1@1 applied=1
</a><a href="#h14-5-10" id="h14-5-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-5-11" id="h14-5-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-5-12" id="h14-5-12" class="i">+n5@4 leader last=9@4 commit=9@4 applied=9 progress={1:010 2:010 3:910 4:910}
</a> 
 log 1 5
 ---
<a href="#h14-5-16" id="h14-5-16" class="d">-n1@1 last=12@1 commit=3@1
</a><a href="#h14-5-17" id="h14-5-17" class="i">+n1@1 term=1 last=12@1 commit=3@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put a=1
 n1@1 entry 3@1 put b=2
<a href="#h14-6" id="h14-6" class="h">@@ -99,7 +99,7 @@ n1@1 entry 9@1 put a=7
</a> n1@1 entry 10@1 put a=8
 n1@1 entry 11@1 put a=9
 n1@1 entry 12@1 put a=10
<a href="#h14-6-3" id="h14-6-3" class="d">-n5@4 last=9@4 commit=9@4
</a><a href="#h14-6-4" id="h14-6-4" class="i">+n5@4 term=4 last=9@4 commit=9@4 vote=Some(5)
</a> n5@4 entry 1@1 None
 n5@4 entry 2@1 put a=1
 n5@4 entry 3@1 put b=2
<a href="#h14-7" id="h14-7" class="h">@@ -160,7 +160,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=8@4 []
 n5@4  n2 Append base=8@4 []
<a href="#h14-7-3" id="h14-7-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:09 2:09 3:911 4:911}
</a><a href="#h14-7-4" id="h14-7-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:09 2:09 3:911 4:911}
</a> n1@4  n5 AppendResponse reject_index=8
 n2@4  n5 AppendResponse reject_index=8
 
<a href="#h14-8" id="h14-8" class="h">@@ -172,7 +172,7 @@ n5@4  n1 Append base=7@3 []
</a> n5@4  n2 Append base=7@3 []
 n1@4  n5 AppendResponse reject_index=7
 n2@4  n5 AppendResponse reject_index=7
<a href="#h14-8-3" id="h14-8-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:08 2:08 3:911 4:911}
</a><a href="#h14-8-4" id="h14-8-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:08 2:08 3:911 4:911}
</a> 
 deliver 5
 status 5
<a href="#h14-9" id="h14-9" class="h">@@ -180,7 +180,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=6@3 []
 n5@4  n2 Append base=6@3 []
<a href="#h14-9-3" id="h14-9-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:07 2:07 3:911 4:911}
</a><a href="#h14-9-4" id="h14-9-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:07 2:07 3:911 4:911}
</a> n1@4  n5 AppendResponse reject_index=6
 n2@4  n5 AppendResponse reject_index=6
 
<a href="#h14-10" id="h14-10" class="h">@@ -190,7 +190,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=5@2 []
 n5@4  n2 Append base=5@2 []
<a href="#h14-10-3" id="h14-10-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:06 2:06 3:911 4:911}
</a><a href="#h14-10-4" id="h14-10-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:06 2:06 3:911 4:911}
</a> n1@4  n5 AppendResponse reject_index=5
 n2@4  n5 AppendResponse reject_index=5
 
<a href="#h14-11" id="h14-11" class="h">@@ -200,7 +200,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=4@2 []
 n5@4  n2 Append base=4@2 []
<a href="#h14-11-3" id="h14-11-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:05 2:05 3:911 4:911}
</a><a href="#h14-11-4" id="h14-11-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:05 2:05 3:911 4:911}
</a> n1@4  n5 AppendResponse reject_index=4
 n2@4  n5 AppendResponse reject_index=4
 
<a href="#h14-12" id="h14-12" class="h">@@ -210,7 +210,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=3@1 []
 n5@4  n2 Append base=3@1 []
<a href="#h14-12-3" id="h14-12-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:04 2:04 3:911 4:911}
</a><a href="#h14-12-4" id="h14-12-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:04 2:04 3:911 4:911}
</a> n1@4  n5 AppendResponse match_index=3
 n2@4  n5 AppendResponse match_index=3
 
<a href="#h14-13" id="h14-13" class="h">@@ -221,7 +221,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
 n5@4  n2 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
<a href="#h14-13-3" id="h14-13-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:311 2:311 3:911 4:911}
</a><a href="#h14-13-4" id="h14-13-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:311 2:311 3:911 4:911}
</a> n1@4 append 4@2 None
 n1@4 append 5@2 put c=3
 n1@4 append 6@3 None
<a href="#h14-14" id="h14-14" class="h">@@ -248,18 +248,18 @@ c5@4 put f=6  10
</a> 
 status
 ---
<a href="#h14-14-3" id="h14-14-3" class="d">-n1@4 follower(n5) last=10@4 commit=3@1 apply=3
</a><a href="#h14-14-4" id="h14-14-4" class="d">-n2@4 follower(n5) last=10@4 commit=1@1 apply=1
</a><a href="#h14-14-5" id="h14-14-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-14-6" id="h14-14-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-14-7" id="h14-14-7" class="d">-n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:1011 2:1011 3:911 4:911}
</a><a href="#h14-14-8" id="h14-14-8" class="i">+n1@4 follower(n5) last=10@4 commit=3@1 applied=3
</a><a href="#h14-14-9" id="h14-14-9" class="i">+n2@4 follower(n5) last=10@4 commit=1@1 applied=1
</a><a href="#h14-14-10" id="h14-14-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-14-11" id="h14-14-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h14-14-12" id="h14-14-12" class="i">+n5@4 leader last=10@4 commit=10@4 applied=10 progress={1:1011 2:1011 3:911 4:911}
</a> 
 # Stabilize the cluster.
 (stabilize heartbeat=true)
 status
 ---
<a href="#h14-14-18" id="h14-14-18" class="d">-n1@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-14-19" id="h14-14-19" class="d">-n2@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-14-20" id="h14-14-20" class="d">-n3@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-14-21" id="h14-14-21" class="d">-n4@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-14-22" id="h14-14-22" class="d">-n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:1011 2:1011 3:1011 4:1011}
</a><a href="#h14-14-23" id="h14-14-23" class="i">+n1@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h14-14-24" id="h14-14-24" class="i">+n2@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h14-14-25" id="h14-14-25" class="i">+n3@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h14-14-26" id="h14-14-26" class="i">+n4@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h14-14-27" id="h14-14-27" class="i">+n5@4 leader last=10@4 commit=10@4 applied=10 progress={1:1011 2:1011 3:1011 4:1011}
</a><b>diff --git a/<a id="h15" href="../file/src/raft/testscripts/node/append_probe_divergent_short.html">src/raft/testscripts/node/append_probe_divergent_short</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_short.html">src/raft/testscripts/node/append_probe_divergent_short</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -3,11 +3,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h15-0-3" id="h15-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h15-0-4" id="h15-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-5" id="h15-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-6" id="h15-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-7" id="h15-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-8" id="h15-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h15-0-9" id="h15-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h15-0-10" id="h15-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h15-0-11" id="h15-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h15-0-12" id="h15-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Make a couple of writes to ensure a common log prefix.
 (put 1 a=1)
<a href="#h15-1" id="h15-1" class="h">@@ -15,11 +15,11 @@ n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> (stabilize)
 status
 ---
<a href="#h15-1-3" id="h15-1-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-1-4" id="h15-1-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-1-5" id="h15-1-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-1-6" id="h15-1-6" class="d">-n4@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-1-7" id="h15-1-7" class="d">-n5@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-1-8" id="h15-1-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-1-9" id="h15-1-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-1-10" id="h15-1-10" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-1-11" id="h15-1-11" class="i">+n4@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-1-12" id="h15-1-12" class="i">+n5@1 follower(n1) last=3@1 commit=1@1 applied=1
</a> 
 # Partition n1-n2
 partition 1 2
<a href="#h15-2" id="h15-2" class="h">@@ -34,11 +34,11 @@ n1 n2  n3 n4 n5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h15-2-3" id="h15-2-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-2-4" id="h15-2-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-2-5" id="h15-2-5" class="d">-n3@2 leader last=5@2 commit=5@2 apply=5 progress={1:06 2:06 4:56 5:56}
</a><a href="#h15-2-6" id="h15-2-6" class="d">-n4@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h15-2-7" id="h15-2-7" class="d">-n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h15-2-8" id="h15-2-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-2-9" id="h15-2-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-2-10" id="h15-2-10" class="i">+n3@2 leader last=5@2 commit=5@2 applied=5 progress={1:06 2:06 4:56 5:56}
</a><a href="#h15-2-11" id="h15-2-11" class="i">+n4@2 follower(n3) last=5@2 commit=5@2 applied=5
</a><a href="#h15-2-12" id="h15-2-12" class="i">+n5@2 follower(n3) last=5@2 commit=5@2 applied=5
</a> 
 (campaign 4)
 (stabilize)
<a href="#h15-3" id="h15-3" class="h">@@ -46,11 +46,11 @@ n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h15-3-3" id="h15-3-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-3-4" id="h15-3-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-3-5" id="h15-3-5" class="d">-n3@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h15-3-6" id="h15-3-6" class="d">-n4@3 leader last=7@3 commit=7@3 apply=7 progress={1:08 2:08 3:78 5:78}
</a><a href="#h15-3-7" id="h15-3-7" class="d">-n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h15-3-8" id="h15-3-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-3-9" id="h15-3-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-3-10" id="h15-3-10" class="i">+n3@3 follower(n4) last=7@3 commit=7@3 applied=7
</a><a href="#h15-3-11" id="h15-3-11" class="i">+n4@3 leader last=7@3 commit=7@3 applied=7 progress={1:08 2:08 3:78 5:78}
</a><a href="#h15-3-12" id="h15-3-12" class="i">+n5@3 follower(n4) last=7@3 commit=7@3 applied=7
</a> 
 (campaign 5)
 (stabilize)
<a href="#h15-4" id="h15-4" class="h">@@ -58,11 +58,11 @@ n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h15-4-3" id="h15-4-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-4-4" id="h15-4-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-4-5" id="h15-4-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-4-6" id="h15-4-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-4-7" id="h15-4-7" class="d">-n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:910}
</a><a href="#h15-4-8" id="h15-4-8" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34 4:34 5:34}
</a><a href="#h15-4-9" id="h15-4-9" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h15-4-10" id="h15-4-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-4-11" id="h15-4-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-4-12" id="h15-4-12" class="i">+n5@4 leader last=9@4 commit=9@4 applied=9 progress={1:010 2:010 3:910 4:910}
</a> 
 # Propose a single write in the minority partition. The divergent minority log
 # is much shorter than the majority log.
<a href="#h15-5" id="h15-5" class="h">@@ -70,20 +70,20 @@ n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:9
</a> (stabilize)
 status
 ---
<a href="#h15-5-3" id="h15-5-3" class="d">-n1@1 leader last=4@1 commit=3@1 apply=3 progress={2:45 3:35 4:35 5:35}
</a><a href="#h15-5-4" id="h15-5-4" class="d">-n2@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h15-5-5" id="h15-5-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-5-6" id="h15-5-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-5-7" id="h15-5-7" class="d">-n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:010 2:010 3:910 4:910}
</a><a href="#h15-5-8" id="h15-5-8" class="i">+n1@1 leader last=4@1 commit=3@1 applied=3 progress={2:45 3:35 4:35 5:35}
</a><a href="#h15-5-9" id="h15-5-9" class="i">+n2@1 follower(n1) last=4@1 commit=1@1 applied=1
</a><a href="#h15-5-10" id="h15-5-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-5-11" id="h15-5-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-5-12" id="h15-5-12" class="i">+n5@4 leader last=9@4 commit=9@4 applied=9 progress={1:010 2:010 3:910 4:910}
</a> 
 log 1 5
 ---
<a href="#h15-5-16" id="h15-5-16" class="d">-n1@1 last=4@1 commit=3@1
</a><a href="#h15-5-17" id="h15-5-17" class="i">+n1@1 term=1 last=4@1 commit=3@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put a=1
 n1@1 entry 3@1 put b=2
 n1@1 entry 4@1 put a=2
<a href="#h15-5-22" id="h15-5-22" class="d">-n5@4 last=9@4 commit=9@4
</a><a href="#h15-5-23" id="h15-5-23" class="i">+n5@4 term=4 last=9@4 commit=9@4 vote=Some(5)
</a> n5@4 entry 1@1 None
 n5@4 entry 2@1 put a=1
 n5@4 entry 3@1 put b=2
<a href="#h15-6" id="h15-6" class="h">@@ -129,7 +129,7 @@ deliver 1 2
</a> ---
 n5@4  n1 Append base=4@2 []
 n5@4  n2 Append base=4@2 []
<a href="#h15-6-3" id="h15-6-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:05 2:05 3:911 4:911}
</a><a href="#h15-6-4" id="h15-6-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:05 2:05 3:911 4:911}
</a> n1@4  n5 AppendResponse reject_index=4
 n2@4  n5 AppendResponse reject_index=4
 
<a href="#h15-7" id="h15-7" class="h">@@ -141,7 +141,7 @@ n5@4  n1 Append base=3@1 []
</a> n5@4  n2 Append base=3@1 []
 n1@4  n5 AppendResponse match_index=3
 n2@4  n5 AppendResponse match_index=3
<a href="#h15-7-3" id="h15-7-3" class="d">-n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:04 2:04 3:911 4:911}
</a><a href="#h15-7-4" id="h15-7-4" class="i">+n5@4 leader last=10@4 commit=9@4 applied=9 progress={1:04 2:04 3:911 4:911}
</a> 
 # n5 can now replicate the tail to n1 and n2, allowing n5 to commit it.
 deliver 5
<a href="#h15-8" id="h15-8" class="h">@@ -175,18 +175,18 @@ c5@4 put f=6  10
</a> 
 status
 ---
<a href="#h15-8-3" id="h15-8-3" class="d">-n1@4 follower(n5) last=10@4 commit=3@1 apply=3
</a><a href="#h15-8-4" id="h15-8-4" class="d">-n2@4 follower(n5) last=10@4 commit=1@1 apply=1
</a><a href="#h15-8-5" id="h15-8-5" class="d">-n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-8-6" id="h15-8-6" class="d">-n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-8-7" id="h15-8-7" class="d">-n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:1011 2:1011 3:911 4:911}
</a><a href="#h15-8-8" id="h15-8-8" class="i">+n1@4 follower(n5) last=10@4 commit=3@1 applied=3
</a><a href="#h15-8-9" id="h15-8-9" class="i">+n2@4 follower(n5) last=10@4 commit=1@1 applied=1
</a><a href="#h15-8-10" id="h15-8-10" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-8-11" id="h15-8-11" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 applied=9
</a><a href="#h15-8-12" id="h15-8-12" class="i">+n5@4 leader last=10@4 commit=10@4 applied=10 progress={1:1011 2:1011 3:911 4:911}
</a> 
 # Stabilize the cluster.
 (stabilize heartbeat=true)
 status
 ---
<a href="#h15-8-18" id="h15-8-18" class="d">-n1@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-8-19" id="h15-8-19" class="d">-n2@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-8-20" id="h15-8-20" class="d">-n3@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-8-21" id="h15-8-21" class="d">-n4@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-8-22" id="h15-8-22" class="d">-n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:1011 2:1011 3:1011 4:1011}
</a><a href="#h15-8-23" id="h15-8-23" class="i">+n1@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h15-8-24" id="h15-8-24" class="i">+n2@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h15-8-25" id="h15-8-25" class="i">+n3@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h15-8-26" id="h15-8-26" class="i">+n4@4 follower(n5) last=10@4 commit=10@4 applied=10
</a><a href="#h15-8-27" id="h15-8-27" class="i">+n5@4 leader last=10@4 commit=10@4 applied=10 progress={1:1011 2:1011 3:1011 4:1011}
</a><b>diff --git a/<a id="h16" href="../file/src/raft/testscripts/node/append_probe_divergent_single.html">src/raft/testscripts/node/append_probe_divergent_single</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_single.html">src/raft/testscripts/node/append_probe_divergent_single</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -2,11 +2,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h16-0-3" id="h16-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h16-0-4" id="h16-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-5" id="h16-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-6" id="h16-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-7" id="h16-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-8" id="h16-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h16-0-9" id="h16-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h16-0-10" id="h16-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h16-0-11" id="h16-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h16-0-12" id="h16-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n3-n5.
 partition 3 4 5
<a href="#h16-1" id="h16-1" class="h">@@ -28,10 +28,10 @@ n2@1  n1 AppendResponse match_index=2
</a> 
 log 1 2
 ---
<a href="#h16-1-3" id="h16-1-3" class="d">-n1@1 last=2@1 commit=1@1
</a><a href="#h16-1-4" id="h16-1-4" class="i">+n1@1 term=1 last=2@1 commit=1@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put a=1
<a href="#h16-1-7" id="h16-1-7" class="d">-n2@1 last=2@1 commit=1@1
</a><a href="#h16-1-8" id="h16-1-8" class="i">+n2@1 term=1 last=2@1 commit=1@1 vote=Some(1)
</a> n2@1 entry 1@1 None
 n2@1 entry 2@1 put a=1
 
<a href="#h16-2" id="h16-2" class="h">@@ -40,11 +40,11 @@ n2@1 entry 2@1 put a=1
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h16-2-3" id="h16-2-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:23 3:13 4:13 5:13}
</a><a href="#h16-2-4" id="h16-2-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h16-2-5" id="h16-2-5" class="d">-n3@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h16-2-6" id="h16-2-6" class="d">-n4@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h16-2-7" id="h16-2-7" class="d">-n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:03 2:03 3:23 4:23}
</a><a href="#h16-2-8" id="h16-2-8" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:23 3:13 4:13 5:13}
</a><a href="#h16-2-9" id="h16-2-9" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h16-2-10" id="h16-2-10" class="i">+n3@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h16-2-11" id="h16-2-11" class="i">+n4@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h16-2-12" id="h16-2-12" class="i">+n5@2 leader last=2@2 commit=2@2 applied=2 progress={1:03 2:03 3:23 4:23}
</a> 
 # Heal the partition and propose a new write.
 heal
<a href="#h16-3" id="h16-3" class="h">@@ -80,10 +80,10 @@ n2@2  n5 AppendResponse match_index=1
</a> 
 log 1 2
 ---
<a href="#h16-3-3" id="h16-3-3" class="d">-n1@2 last=2@1 commit=1@1
</a><a href="#h16-3-4" id="h16-3-4" class="i">+n1@2 term=2 last=2@1 commit=1@1 vote=None
</a> n1@2 entry 1@1 None
 n1@2 entry 2@1 put a=1
<a href="#h16-3-7" id="h16-3-7" class="d">-n2@2 last=2@1 commit=1@1
</a><a href="#h16-3-8" id="h16-3-8" class="i">+n2@2 term=2 last=2@1 commit=1@1 vote=None
</a> n2@2 entry 1@1 None
 n2@2 entry 2@1 put a=1
 
<a href="#h16-4" id="h16-4" class="h">@@ -102,11 +102,11 @@ n2@2  n5 AppendResponse match_index=3
</a> 
 log 1 2
 ---
<a href="#h16-4-3" id="h16-4-3" class="d">-n1@2 last=3@2 commit=1@1
</a><a href="#h16-4-4" id="h16-4-4" class="i">+n1@2 term=2 last=3@2 commit=1@1 vote=None
</a> n1@2 entry 1@1 None
 n1@2 entry 2@2 None
 n1@2 entry 3@2 put b=2
<a href="#h16-4-8" id="h16-4-8" class="d">-n2@2 last=3@2 commit=1@1
</a><a href="#h16-4-9" id="h16-4-9" class="i">+n2@2 term=2 last=3@2 commit=1@1 vote=None
</a> n2@2 entry 1@1 None
 n2@2 entry 2@2 None
 n2@2 entry 3@2 put b=2
<a href="#h16-5" id="h16-5" class="h">@@ -115,8 +115,8 @@ n2@2 entry 3@2 put b=2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h16-5-3" id="h16-5-3" class="d">-n1@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-5-4" id="h16-5-4" class="d">-n2@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-5-5" id="h16-5-5" class="d">-n3@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-5-6" id="h16-5-6" class="d">-n4@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-5-7" id="h16-5-7" class="d">-n5@2 leader last=3@2 commit=3@2 apply=3 progress={1:34 2:34 3:34 4:34}
</a><a href="#h16-5-8" id="h16-5-8" class="i">+n1@2 follower(n5) last=3@2 commit=3@2 applied=3
</a><a href="#h16-5-9" id="h16-5-9" class="i">+n2@2 follower(n5) last=3@2 commit=3@2 applied=3
</a><a href="#h16-5-10" id="h16-5-10" class="i">+n3@2 follower(n5) last=3@2 commit=3@2 applied=3
</a><a href="#h16-5-11" id="h16-5-11" class="i">+n4@2 follower(n5) last=3@2 commit=3@2 applied=3
</a><a href="#h16-5-12" id="h16-5-12" class="i">+n5@2 leader last=3@2 commit=3@2 applied=3 progress={1:34 2:34 3:34 4:34}
</a><b>diff --git a/<a id="h17" href="../file/src/raft/testscripts/node/append_response_beyond_last_index_panics.html">src/raft/testscripts/node/append_response_beyond_last_index_panics</a> b/<a href="../file/src/raft/testscripts/node/append_response_beyond_last_index_panics.html">src/raft/testscripts/node/append_response_beyond_last_index_panics</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h17-0-3" id="h17-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h17-0-4" id="h17-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h17-0-5" id="h17-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h17-0-6" id="h17-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h17-0-7" id="h17-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h17-0-8" id="h17-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Propose a write.
 put 1 foo=bar
<a href="#h17-1" id="h17-1" class="h">@@ -18,4 +18,4 @@ n1@1  n3 Append base=1@1 [2@1]
</a> # An AppendResponse beyond leader&#39;s last log should panic.
 !step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:3,&quot;reject_index&quot;:0}}}&#39;
 ---
<a href="#h17-1-3" id="h17-1-3" class="d">-Panic: follower matched unknown index
</a><a href="#h17-1-4" id="h17-1-4" class="i">+Panic: future match index
</a><b>diff --git a/<a id="h18" href="../file/src/raft/testscripts/node/append_response_stale_reject.html">src/raft/testscripts/node/append_response_stale_reject</a> b/<a href="../file/src/raft/testscripts/node/append_response_stale_reject.html">src/raft/testscripts/node/append_response_stale_reject</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -3,42 +3,42 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h18-0-3" id="h18-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h18-0-4" id="h18-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-5" id="h18-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-6" id="h18-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h18-0-7" id="h18-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h18-0-8" id="h18-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicate a write.
 (put 1 a=1)
 (stabilize heartbeat=true)
 status
 ---
<a href="#h18-0-15" id="h18-0-15" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h18-0-16" id="h18-0-16" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-17" id="h18-0-17" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-18" id="h18-0-18" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h18-0-19" id="h18-0-19" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h18-0-20" id="h18-0-20" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # Propose a few writes.
 (put 1 b=2)
 (put 1 c=3)
 status
 ---
<a href="#h18-0-27" id="h18-0-27" class="d">-n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:25 3:25}
</a><a href="#h18-0-28" id="h18-0-28" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-29" id="h18-0-29" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-30" id="h18-0-30" class="i">+n1@1 leader last=4@1 commit=2@1 applied=2 progress={2:25 3:25}
</a><a href="#h18-0-31" id="h18-0-31" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h18-0-32" id="h18-0-32" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # A reject_index below the follower&#39;s progress match index is ignored.
 step 1 &#39;{&quot;from&quot;:2,&quot;to&quot;:1,&quot;term&quot;:1,&quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:0,&quot;reject_index&quot;:2}}}&#39;
 status
 ---
<a href="#h18-0-38" id="h18-0-38" class="d">-n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:25 3:25}
</a><a href="#h18-0-39" id="h18-0-39" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-40" id="h18-0-40" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-41" id="h18-0-41" class="i">+n1@1 leader last=4@1 commit=2@1 applied=2 progress={2:25 3:25}
</a><a href="#h18-0-42" id="h18-0-42" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h18-0-43" id="h18-0-43" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 step 1 &#39;{&quot;from&quot;:2,&quot;to&quot;:1,&quot;term&quot;:1,&quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:0,&quot;reject_index&quot;:1}}}&#39;
 status
 ---
<a href="#h18-0-48" id="h18-0-48" class="d">-n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:25 3:25}
</a><a href="#h18-0-49" id="h18-0-49" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-50" id="h18-0-50" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h18-0-51" id="h18-0-51" class="i">+n1@1 leader last=4@1 commit=2@1 applied=2 progress={2:25 3:25}
</a><a href="#h18-0-52" id="h18-0-52" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h18-0-53" id="h18-0-53" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # The writes are still replicated without any probes.
 stabilize
<b>diff --git a/<a id="h19" href="../file/src/raft/testscripts/node/election.html">src/raft/testscripts/node/election</a> b/<a href="../file/src/raft/testscripts/node/election.html">src/raft/testscripts/node/election</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 heartbeat_interval=1 election_timeout=2
 ---
<a href="#h19-0-3" id="h19-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h19-0-4" id="h19-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h19-0-5" id="h19-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h19-0-6" id="h19-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h19-0-7" id="h19-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h19-0-8" id="h19-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Tick all nodes. Then tick n1 again to make it campaign.
 tick
<a href="#h19-1" id="h19-1" class="h">@@ -67,6 +67,6 @@ n3@1  n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 status
 ---
<a href="#h19-1-3" id="h19-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h19-1-4" id="h19-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-1-5" id="h19-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-1-6" id="h19-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h19-1-7" id="h19-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h19-1-8" id="h19-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h20" href="../file/src/raft/testscripts/node/election_candidate_behind_leader.html">src/raft/testscripts/node/election_candidate_behind_leader</a> b/<a href="../file/src/raft/testscripts/node/election_candidate_behind_leader.html">src/raft/testscripts/node/election_candidate_behind_leader</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -3,11 +3,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h20-0-3" id="h20-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h20-0-4" id="h20-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-0-5" id="h20-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-0-6" id="h20-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-0-7" id="h20-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-0-8" id="h20-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h20-0-9" id="h20-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h20-0-10" id="h20-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h20-0-11" id="h20-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h20-0-12" id="h20-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n1+n2 away from the cluster.
 partition 1 2
<a href="#h20-1" id="h20-1" class="h">@@ -20,22 +20,22 @@ n1 n2  n3 n4 n5
</a> (stabilize)
 status
 ---
<a href="#h20-1-3" id="h20-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:23 3:13 4:13 5:13}
</a><a href="#h20-1-4" id="h20-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h20-1-5" id="h20-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-1-6" id="h20-1-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-1-7" id="h20-1-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h20-1-8" id="h20-1-8" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:23 3:13 4:13 5:13}
</a><a href="#h20-1-9" id="h20-1-9" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h20-1-10" id="h20-1-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h20-1-11" id="h20-1-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h20-1-12" id="h20-1-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # List the logs on n1 n2 n3 to show the replicated but uncommitted entry.
 log 1 2 3
 ---
<a href="#h20-1-17" id="h20-1-17" class="d">-n1@1 last=2@1 commit=1@1
</a><a href="#h20-1-18" id="h20-1-18" class="i">+n1@1 term=1 last=2@1 commit=1@1 vote=Some(1)
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put foo=bar
<a href="#h20-1-21" id="h20-1-21" class="d">-n2@1 last=2@1 commit=1@1
</a><a href="#h20-1-22" id="h20-1-22" class="i">+n2@1 term=1 last=2@1 commit=1@1 vote=Some(1)
</a> n2@1 entry 1@1 None
 n2@1 entry 2@1 put foo=bar
<a href="#h20-1-25" id="h20-1-25" class="d">-n3@1 last=1@1 commit=1@1
</a><a href="#h20-1-26" id="h20-1-26" class="i">+n3@1 term=1 last=1@1 commit=1@1 vote=Some(1)
</a> n3@1 entry 1@1 None
 
 # Heal the partition.
<a href="#h20-2" id="h20-2" class="h">@@ -116,17 +116,17 @@ n4@2  n5 HeartbeatResponse match_index=2 read_seq=0
</a> # empty log entry appended by n5 when it became leader.
 log 1 2
 ---
<a href="#h20-2-3" id="h20-2-3" class="d">-n1@2 last=2@2 commit=2@2
</a><a href="#h20-2-4" id="h20-2-4" class="i">+n1@2 term=2 last=2@2 commit=2@2 vote=None
</a> n1@2 entry 1@1 None
 n1@2 entry 2@2 None
<a href="#h20-2-7" id="h20-2-7" class="d">-n2@2 last=2@2 commit=2@2
</a><a href="#h20-2-8" id="h20-2-8" class="i">+n2@2 term=2 last=2@2 commit=2@2 vote=None
</a> n2@2 entry 1@1 None
 n2@2 entry 2@2 None
 
 status
 ---
<a href="#h20-2-14" id="h20-2-14" class="d">-n1@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h20-2-15" id="h20-2-15" class="d">-n2@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h20-2-16" id="h20-2-16" class="d">-n3@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h20-2-17" id="h20-2-17" class="d">-n4@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h20-2-18" id="h20-2-18" class="d">-n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:23 2:23 3:23 4:23}
</a><a href="#h20-2-19" id="h20-2-19" class="i">+n1@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h20-2-20" id="h20-2-20" class="i">+n2@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h20-2-21" id="h20-2-21" class="i">+n3@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h20-2-22" id="h20-2-22" class="i">+n4@2 follower(n5) last=2@2 commit=2@2 applied=2
</a><a href="#h20-2-23" id="h20-2-23" class="i">+n5@2 leader last=2@2 commit=2@2 applied=2 progress={1:23 2:23 3:23 4:23}
</a><b>diff --git a/<a id="h21" href="../file/src/raft/testscripts/node/election_candidate_behind_quorum.html">src/raft/testscripts/node/election_candidate_behind_quorum</a> b/<a href="../file/src/raft/testscripts/node/election_candidate_behind_quorum.html">src/raft/testscripts/node/election_candidate_behind_quorum</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -2,11 +2,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h21-0-3" id="h21-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h21-0-4" id="h21-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-0-5" id="h21-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-0-6" id="h21-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-0-7" id="h21-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-0-8" id="h21-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h21-0-9" id="h21-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h21-0-10" id="h21-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h21-0-11" id="h21-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h21-0-12" id="h21-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n4+n5 away from the cluster.
 partition 4 5
<a href="#h21-1" id="h21-1" class="h">@@ -20,11 +20,11 @@ n4 n5  n1 n2 n3
</a> (stabilize)
 status
 ---
<a href="#h21-1-3" id="h21-1-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23 4:13 5:13}
</a><a href="#h21-1-4" id="h21-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h21-1-5" id="h21-1-5" class="d">-n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h21-1-6" id="h21-1-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-1-7" id="h21-1-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h21-1-8" id="h21-1-8" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23 4:13 5:13}
</a><a href="#h21-1-9" id="h21-1-9" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h21-1-10" id="h21-1-10" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h21-1-11" id="h21-1-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h21-1-12" id="h21-1-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Heal the partition.
 heal
<a href="#h21-2" id="h21-2" class="h">@@ -55,19 +55,19 @@ n4@2  n5 CampaignResponse vote=true
</a> 
 status
 ---
<a href="#h21-2-3" id="h21-2-3" class="d">-n1@2 follower() last=2@1 commit=2@1 apply=2
</a><a href="#h21-2-4" id="h21-2-4" class="d">-n2@2 follower() last=2@1 commit=1@1 apply=1
</a><a href="#h21-2-5" id="h21-2-5" class="d">-n3@2 follower() last=2@1 commit=1@1 apply=1
</a><a href="#h21-2-6" id="h21-2-6" class="d">-n4@2 follower() last=1@1 commit=1@1 apply=1
</a><a href="#h21-2-7" id="h21-2-7" class="d">-n5@2 candidate last=1@1 commit=1@1 apply=1
</a><a href="#h21-2-8" id="h21-2-8" class="i">+n1@2 follower() last=2@1 commit=2@1 applied=2
</a><a href="#h21-2-9" id="h21-2-9" class="i">+n2@2 follower() last=2@1 commit=1@1 applied=1
</a><a href="#h21-2-10" id="h21-2-10" class="i">+n3@2 follower() last=2@1 commit=1@1 applied=1
</a><a href="#h21-2-11" id="h21-2-11" class="i">+n4@2 follower() last=1@1 commit=1@1 applied=1
</a><a href="#h21-2-12" id="h21-2-12" class="i">+n5@2 candidate last=1@1 commit=1@1 applied=1
</a> 
 # n2 can campaign and win the election.
 (campaign 2)
 (stabilize heartbeat=true)
 status
 ---
<a href="#h21-2-19" id="h21-2-19" class="d">-n1@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h21-2-20" id="h21-2-20" class="d">-n2@3 leader last=3@3 commit=3@3 apply=3 progress={1:34 3:34 4:34 5:34}
</a><a href="#h21-2-21" id="h21-2-21" class="d">-n3@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h21-2-22" id="h21-2-22" class="d">-n4@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h21-2-23" id="h21-2-23" class="d">-n5@3 follower(n2) last=3@3 commit=3@3 apply=3
</a><a href="#h21-2-24" id="h21-2-24" class="i">+n1@3 follower(n2) last=3@3 commit=3@3 applied=3
</a><a href="#h21-2-25" id="h21-2-25" class="i">+n2@3 leader last=3@3 commit=3@3 applied=3 progress={1:34 3:34 4:34 5:34}
</a><a href="#h21-2-26" id="h21-2-26" class="i">+n3@3 follower(n2) last=3@3 commit=3@3 applied=3
</a><a href="#h21-2-27" id="h21-2-27" class="i">+n4@3 follower(n2) last=3@3 commit=3@3 applied=3
</a><a href="#h21-2-28" id="h21-2-28" class="i">+n5@3 follower(n2) last=3@3 commit=3@3 applied=3
</a><b>diff --git a/<a id="h22" href="../file/src/raft/testscripts/node/election_contested.html">src/raft/testscripts/node/election_contested</a> b/<a href="../file/src/raft/testscripts/node/election_contested.html">src/raft/testscripts/node/election_contested</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -2,11 +2,11 @@
</a> 
 cluster nodes=5 election_timeout=2
 ---
<a href="#h22-0-3" id="h22-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-4" id="h22-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-5" id="h22-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-6" id="h22-0-6" class="d">-n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-7" id="h22-0-7" class="d">-n5@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h22-0-8" id="h22-0-8" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h22-0-9" id="h22-0-9" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h22-0-10" id="h22-0-10" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h22-0-11" id="h22-0-11" class="i">+n4@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h22-0-12" id="h22-0-12" class="i">+n5@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 and n5 campaign.
 tick
<a href="#h22-1" id="h22-1" class="h">@@ -82,8 +82,8 @@ n1@1 apply 1@1 None
</a> 
 status
 ---
<a href="#h22-1-3" id="h22-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h22-1-4" id="h22-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h22-1-5" id="h22-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h22-1-6" id="h22-1-6" class="d">-n4@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h22-1-7" id="h22-1-7" class="d">-n5@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h22-1-8" id="h22-1-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h22-1-9" id="h22-1-9" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h22-1-10" id="h22-1-10" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h22-1-11" id="h22-1-11" class="i">+n4@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h22-1-12" id="h22-1-12" class="i">+n5@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><b>diff --git a/<a id="h23" href="../file/src/raft/testscripts/node/election_tie.html">src/raft/testscripts/node/election_tie</a> b/<a href="../file/src/raft/testscripts/node/election_tie.html">src/raft/testscripts/node/election_tie</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 election_timeout=2
 ---
<a href="#h23-0-3" id="h23-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h23-0-4" id="h23-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h23-0-5" id="h23-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h23-0-6" id="h23-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h23-0-7" id="h23-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h23-0-8" id="h23-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Tick all nodes twice to make them all campaign.
 tick
<a href="#h23-1" id="h23-1" class="h">@@ -32,9 +32,9 @@ n3@1  n2 CampaignResponse vote=false
</a> 
 status
 ---
<a href="#h23-1-3" id="h23-1-3" class="d">-n1@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h23-1-4" id="h23-1-4" class="d">-n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h23-1-5" id="h23-1-5" class="d">-n3@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h23-1-6" id="h23-1-6" class="i">+n1@1 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h23-1-7" id="h23-1-7" class="i">+n2@1 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h23-1-8" id="h23-1-8" class="i">+n3@1 candidate last=0@0 commit=0@0 applied=0
</a> 
 # A node can call another election in a new term and win.
 tick 2
<a href="#h23-2" id="h23-2" class="h">@@ -75,6 +75,6 @@ n2@2 apply 1@2 None
</a> 
 status
 ---
<a href="#h23-2-3" id="h23-2-3" class="d">-n1@2 follower(n2) last=1@2 commit=0@0 apply=0
</a><a href="#h23-2-4" id="h23-2-4" class="d">-n2@2 leader last=1@2 commit=1@2 apply=1 progress={1:12 3:12}
</a><a href="#h23-2-5" id="h23-2-5" class="d">-n3@2 follower(n2) last=1@2 commit=0@0 apply=0
</a><a href="#h23-2-6" id="h23-2-6" class="i">+n1@2 follower(n2) last=1@2 commit=0@0 applied=0
</a><a href="#h23-2-7" id="h23-2-7" class="i">+n2@2 leader last=1@2 commit=1@2 applied=1 progress={1:12 3:12}
</a><a href="#h23-2-8" id="h23-2-8" class="i">+n3@2 follower(n2) last=1@2 commit=0@0 applied=0
</a><b>diff --git a/<a id="h24" href="../file/src/raft/testscripts/node/election_tie_even.html">src/raft/testscripts/node/election_tie_even</a> b/<a href="../file/src/raft/testscripts/node/election_tie_even.html">src/raft/testscripts/node/election_tie_even</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -2,10 +2,10 @@
</a> 
 cluster nodes=4 election_timeout=2
 ---
<a href="#h24-0-3" id="h24-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-4" id="h24-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-5" id="h24-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-6" id="h24-0-6" class="d">-n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-0-7" id="h24-0-7" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h24-0-8" id="h24-0-8" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h24-0-9" id="h24-0-9" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h24-0-10" id="h24-0-10" class="i">+n4@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 and n4 campaign.
 tick
<a href="#h24-1" id="h24-1" class="h">@@ -40,10 +40,10 @@ n4@1  n1 CampaignResponse vote=false
</a> 
 status
 ---
<a href="#h24-1-3" id="h24-1-3" class="d">-n1@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h24-1-4" id="h24-1-4" class="d">-n2@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-1-5" id="h24-1-5" class="d">-n3@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h24-1-6" id="h24-1-6" class="d">-n4@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h24-1-7" id="h24-1-7" class="i">+n1@1 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h24-1-8" id="h24-1-8" class="i">+n2@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h24-1-9" id="h24-1-9" class="i">+n3@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h24-1-10" id="h24-1-10" class="i">+n4@1 candidate last=0@0 commit=0@0 applied=0
</a> 
 # A node can call another election in a new term and win.
 tick 3
<a href="#h24-2" id="h24-2" class="h">@@ -93,7 +93,7 @@ n3@2 apply 1@2 None
</a> 
 status
 ---
<a href="#h24-2-3" id="h24-2-3" class="d">-n1@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><a href="#h24-2-4" id="h24-2-4" class="d">-n2@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><a href="#h24-2-5" id="h24-2-5" class="d">-n3@2 leader last=1@2 commit=1@2 apply=1 progress={1:12 2:12 4:12}
</a><a href="#h24-2-6" id="h24-2-6" class="d">-n4@2 follower(n3) last=1@2 commit=0@0 apply=0
</a><a href="#h24-2-7" id="h24-2-7" class="i">+n1@2 follower(n3) last=1@2 commit=0@0 applied=0
</a><a href="#h24-2-8" id="h24-2-8" class="i">+n2@2 follower(n3) last=1@2 commit=0@0 applied=0
</a><a href="#h24-2-9" id="h24-2-9" class="i">+n3@2 leader last=1@2 commit=1@2 applied=1 progress={1:12 2:12 4:12}
</a><a href="#h24-2-10" id="h24-2-10" class="i">+n4@2 follower(n3) last=1@2 commit=0@0 applied=0
</a><b>diff --git a/<a id="h25" href="../file/src/raft/testscripts/node/heartbeat_commits_follower.html">src/raft/testscripts/node/heartbeat_commits_follower</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_commits_follower.html">src/raft/testscripts/node/heartbeat_commits_follower</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h25-0-3" id="h25-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h25-0-4" id="h25-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h25-0-5" id="h25-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h25-0-6" id="h25-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h25-0-7" id="h25-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h25-0-8" id="h25-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Write on the leader, which replicates then commits and applies locally.
 put 1 foo=bar
<a href="#h25-1" id="h25-1" class="h">@@ -26,9 +26,9 @@ c1@1 put foo=bar  2
</a> # The write has been replicated, but not yet committed and applied on followers.
 status
 ---
<a href="#h25-1-3" id="h25-1-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h25-1-4" id="h25-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h25-1-5" id="h25-1-5" class="d">-n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h25-1-6" id="h25-1-6" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h25-1-7" id="h25-1-7" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h25-1-8" id="h25-1-8" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 applied=1
</a> 
 # A heartbeat commits and applies on followers.
 heartbeat 1
<a href="#h25-2" id="h25-2" class="h">@@ -45,6 +45,6 @@ n3@1  n1 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<a href="#h25-2-3" id="h25-2-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h25-2-4" id="h25-2-4" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h25-2-5" id="h25-2-5" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h25-2-6" id="h25-2-6" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h25-2-7" id="h25-2-7" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h25-2-8" id="h25-2-8" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><b>diff --git a/<a id="h26" href="../file/src/raft/testscripts/node/heartbeat_converts_candidate.html">src/raft/testscripts/node/heartbeat_converts_candidate</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_candidate.html">src/raft/testscripts/node/heartbeat_converts_candidate</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h26-0-3" id="h26-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-4" id="h26-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-5" id="h26-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h26-0-6" id="h26-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h26-0-7" id="h26-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h26-0-8" id="h26-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Partition n3 away from the cluster.
 partition 3
<a href="#h26-1" id="h26-1" class="h">@@ -29,9 +29,9 @@ n2@1  n1 CampaignResponse vote=true
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h26-1-3" id="h26-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:02}
</a><a href="#h26-1-4" id="h26-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h26-1-5" id="h26-1-5" class="d">-n3@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h26-1-6" id="h26-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:02}
</a><a href="#h26-1-7" id="h26-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h26-1-8" id="h26-1-8" class="i">+n3@1 candidate last=0@0 commit=0@0 applied=0
</a> 
 # Heal the partition.
 heal
<a href="#h26-2" id="h26-2" class="h">@@ -53,6 +53,6 @@ n3@1  n1 AppendResponse match_index=1
</a> 
 status
 ---
<a href="#h26-2-3" id="h26-2-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h26-2-4" id="h26-2-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h26-2-5" id="h26-2-5" class="d">-n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h26-2-6" id="h26-2-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h26-2-7" id="h26-2-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h26-2-8" id="h26-2-8" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><b>diff --git a/<a id="h27" href="../file/src/raft/testscripts/node/heartbeat_converts_follower.html">src/raft/testscripts/node/heartbeat_converts_follower</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_follower.html">src/raft/testscripts/node/heartbeat_converts_follower</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h27-0-3" id="h27-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h27-0-4" id="h27-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h27-0-5" id="h27-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h27-0-6" id="h27-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h27-0-7" id="h27-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h27-0-8" id="h27-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n2 away from the cluster.
 partition 2
<a href="#h27-1" id="h27-1" class="h">@@ -17,9 +17,9 @@ n2  n1 n3
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h27-1-3" id="h27-1-3" class="d">-n1@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h27-1-4" id="h27-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h27-1-5" id="h27-1-5" class="d">-n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:23 2:03}
</a><a href="#h27-1-6" id="h27-1-6" class="i">+n1@2 follower(n3) last=2@2 commit=2@2 applied=2
</a><a href="#h27-1-7" id="h27-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h27-1-8" id="h27-1-8" class="i">+n3@2 leader last=2@2 commit=2@2 applied=2 progress={1:23 2:03}
</a> 
 # Heal the partition.
 heal
<a href="#h27-2" id="h27-2" class="h">@@ -49,6 +49,6 @@ n2@2  n3 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<a href="#h27-2-3" id="h27-2-3" class="d">-n1@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h27-2-4" id="h27-2-4" class="d">-n2@2 follower(n3) last=2@2 commit=2@2 apply=2
</a><a href="#h27-2-5" id="h27-2-5" class="d">-n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:23 2:23}
</a><a href="#h27-2-6" id="h27-2-6" class="i">+n1@2 follower(n3) last=2@2 commit=2@2 applied=2
</a><a href="#h27-2-7" id="h27-2-7" class="i">+n2@2 follower(n3) last=2@2 commit=2@2 applied=2
</a><a href="#h27-2-8" id="h27-2-8" class="i">+n3@2 leader last=2@2 commit=2@2 applied=2 progress={1:23 2:23}
</a><b>diff --git a/<a id="h28" href="../file/src/raft/testscripts/node/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h28-0-3" id="h28-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h28-0-4" id="h28-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h28-0-5" id="h28-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h28-0-6" id="h28-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h28-0-7" id="h28-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h28-0-8" id="h28-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Partition n3 away from the cluster.
 partition 3
<a href="#h28-1" id="h28-1" class="h">@@ -16,9 +16,9 @@ n3  n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h28-1-3" id="h28-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:02}
</a><a href="#h28-1-4" id="h28-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h28-1-5" id="h28-1-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h28-1-6" id="h28-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:02}
</a><a href="#h28-1-7" id="h28-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h28-1-8" id="h28-1-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Heal the partition.
 heal
<a href="#h28-2" id="h28-2" class="h">@@ -40,6 +40,6 @@ n3@1  n1 AppendResponse match_index=1
</a> 
 status
 ---
<a href="#h28-2-3" id="h28-2-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h28-2-4" id="h28-2-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h28-2-5" id="h28-2-5" class="d">-n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h28-2-6" id="h28-2-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h28-2-7" id="h28-2-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h28-2-8" id="h28-2-8" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><b>diff --git a/<a id="h29" href="../file/src/raft/testscripts/node/heartbeat_converts_leader.html">src/raft/testscripts/node/heartbeat_converts_leader</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_leader.html">src/raft/testscripts/node/heartbeat_converts_leader</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=3
 ---
<a href="#h29-0-3" id="h29-0-3" class="d">-n1@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h29-0-4" id="h29-0-4" class="d">-n2@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h29-0-5" id="h29-0-5" class="d">-n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:12 2:12}
</a><a href="#h29-0-6" id="h29-0-6" class="i">+n1@1 follower(n3) last=1@1 commit=1@1 applied=1
</a><a href="#h29-0-7" id="h29-0-7" class="i">+n2@1 follower(n3) last=1@1 commit=1@1 applied=1
</a><a href="#h29-0-8" id="h29-0-8" class="i">+n3@1 leader last=1@1 commit=1@1 applied=1 progress={1:12 2:12}
</a> 
 # Partition n3 away from the cluster.
 partition 3
<a href="#h29-1" id="h29-1" class="h">@@ -17,9 +17,9 @@ n3  n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h29-1-3" id="h29-1-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:23 3:03}
</a><a href="#h29-1-4" id="h29-1-4" class="d">-n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h29-1-5" id="h29-1-5" class="d">-n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:12 2:12}
</a><a href="#h29-1-6" id="h29-1-6" class="i">+n1@2 leader last=2@2 commit=2@2 applied=2 progress={2:23 3:03}
</a><a href="#h29-1-7" id="h29-1-7" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 applied=2
</a><a href="#h29-1-8" id="h29-1-8" class="i">+n3@1 leader last=1@1 commit=1@1 applied=1 progress={1:12 2:12}
</a> 
 # Heal the partition.
 heal
<a href="#h29-2" id="h29-2" class="h">@@ -49,6 +49,6 @@ n3@2  n1 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<a href="#h29-2-3" id="h29-2-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:23 3:23}
</a><a href="#h29-2-4" id="h29-2-4" class="d">-n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h29-2-5" id="h29-2-5" class="d">-n3@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h29-2-6" id="h29-2-6" class="i">+n1@2 leader last=2@2 commit=2@2 applied=2 progress={2:23 3:23}
</a><a href="#h29-2-7" id="h29-2-7" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 applied=2
</a><a href="#h29-2-8" id="h29-2-8" class="i">+n3@2 follower(n1) last=2@2 commit=2@2 applied=2
</a><b>diff --git a/<a id="h30" href="../file/src/raft/testscripts/node/heartbeat_lost_append_duplicate.html">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_duplicate.html">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h30-0-3" id="h30-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h30-0-4" id="h30-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h30-0-5" id="h30-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h30-0-6" id="h30-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h30-0-7" id="h30-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h30-0-8" id="h30-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition the leader, submit a write whose appends are dropped,
 # then heal the partition again.
<a href="#h30-1" id="h30-1" class="h">@@ -47,7 +47,7 @@ n3@1  n1 HeartbeatResponse match_index=0 read_seq=0
</a> # The leader has previously matched the followers at index 1.
 status 1
 ---
<a href="#h30-1-3" id="h30-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:13 3:13}
</a><a href="#h30-1-4" id="h30-1-4" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:13 3:13}
</a> 
 # When it receives the heartbeat responses, it sends duplicates of the missing
 # entries.
<b>diff --git a/<a id="h31" href="../file/src/raft/testscripts/node/heartbeat_lost_append_multiple.html">src/raft/testscripts/node/heartbeat_lost_append_multiple</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_multiple.html">src/raft/testscripts/node/heartbeat_lost_append_multiple</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h31-0-3" id="h31-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h31-0-4" id="h31-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-5" id="h31-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-6" id="h31-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h31-0-7" id="h31-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h31-0-8" id="h31-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition the leader, submit three writes whose appends are dropped, then heal
 # the partition again.
<a href="#h31-1" id="h31-1" class="h">@@ -33,9 +33,9 @@ heal
</a> status
 ---
 n1 n2 n3 fully connected
<a href="#h31-1-3" id="h31-1-3" class="d">-n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:15 3:15}
</a><a href="#h31-1-4" id="h31-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-1-5" id="h31-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-1-6" id="h31-1-6" class="i">+n1@1 leader last=4@1 commit=1@1 applied=1 progress={2:15 3:15}
</a><a href="#h31-1-7" id="h31-1-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h31-1-8" id="h31-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # The next heartbeat will result in match_index=0 since the followers
 # don&#39;t have the last_index.
<a href="#h31-2" id="h31-2" class="h">@@ -50,7 +50,7 @@ n3@1  n1 HeartbeatResponse match_index=0 read_seq=0
</a> # The leader has previously matched the followers at index 1.
 status 1
 ---
<a href="#h31-2-3" id="h31-2-3" class="d">-n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:15 3:15}
</a><a href="#h31-2-4" id="h31-2-4" class="i">+n1@1 leader last=4@1 commit=1@1 applied=1 progress={2:15 3:15}
</a> 
 # When it receives the heartbeat response, it probes the previous index 3.
 deliver
<b>diff --git a/<a id="h32" href="../file/src/raft/testscripts/node/heartbeat_lost_append_single.html">src/raft/testscripts/node/heartbeat_lost_append_single</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_single.html">src/raft/testscripts/node/heartbeat_lost_append_single</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h32-0-3" id="h32-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h32-0-4" id="h32-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-5" id="h32-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-6" id="h32-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h32-0-7" id="h32-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h32-0-8" id="h32-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition the leader, submit a write whose appends are dropped,
 # then heal the partition again.
<a href="#h32-1" id="h32-1" class="h">@@ -36,7 +36,7 @@ n3@1  n1 HeartbeatResponse match_index=0 read_seq=0
</a> # The leader has previously matched the followers at index 1.
 status 1
 ---
<a href="#h32-1-3" id="h32-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:13 3:13}
</a><a href="#h32-1-4" id="h32-1-4" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:13 3:13}
</a> 
 # When it receives the heartbeat response, instead of probing index 1 and then
 # sending the actual entries, it simply sends the entries.
<b>diff --git a/<a id="h33" href="../file/src/raft/testscripts/node/heartbeat_match_commits.html">src/raft/testscripts/node/heartbeat_match_commits</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_match_commits.html">src/raft/testscripts/node/heartbeat_match_commits</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h33-0-3" id="h33-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h33-0-4" id="h33-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h33-0-5" id="h33-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h33-0-6" id="h33-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h33-0-7" id="h33-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h33-0-8" id="h33-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Submit a write to the leader.
 put 1 foo=bar
<a href="#h33-1" id="h33-1" class="h">@@ -34,9 +34,9 @@ n1 n2 n3 fully connected
</a> # The write has been replicated, but not yet committed and applied.
 status
 ---
<a href="#h33-1-3" id="h33-1-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:13 3:13}
</a><a href="#h33-1-4" id="h33-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h33-1-5" id="h33-1-5" class="d">-n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h33-1-6" id="h33-1-6" class="i">+n1@1 leader last=2@1 commit=1@1 applied=1 progress={2:13 3:13}
</a><a href="#h33-1-7" id="h33-1-7" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h33-1-8" id="h33-1-8" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 applied=1
</a> 
 # The leader heartbeats. The followers confirm they are caught up.
 heartbeat 1
<a href="#h33-2" id="h33-2" class="h">@@ -58,13 +58,13 @@ c1@1 put foo=bar  2
</a> 
 status 1
 ---
<a href="#h33-2-3" id="h33-2-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:13}
</a><a href="#h33-2-4" id="h33-2-4" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:13}
</a> 
 # Delivery of the second heartbeat advances the match index, but
 # there is nothing more to do.
 deliver
 status
 ---
<a href="#h33-2-11" id="h33-2-11" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h33-2-12" id="h33-2-12" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h33-2-13" id="h33-2-13" class="d">-n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h33-2-14" id="h33-2-14" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h33-2-15" id="h33-2-15" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h33-2-16" id="h33-2-16" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h34" href="../file/src/raft/testscripts/node/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h34-0-3" id="h34-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h34-0-4" id="h34-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-5" id="h34-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-6" id="h34-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h34-0-7" id="h34-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h34-0-8" id="h34-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Leader panics if it sees another leader in the same term.
 !step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;last_index&quot;:1,&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
<b>diff --git a/<a id="h35" href="../file/src/raft/testscripts/node/heartbeat_old_commit_index.html">src/raft/testscripts/node/heartbeat_old_commit_index</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_old_commit_index.html">src/raft/testscripts/node/heartbeat_old_commit_index</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -2,18 +2,18 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h35-0-3" id="h35-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h35-0-4" id="h35-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h35-0-5" id="h35-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h35-0-6" id="h35-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h35-0-7" id="h35-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h35-0-8" id="h35-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicate a write.
 (put 1 foo=bar)
 (stabilize heartbeat=true)
 status
 ---
<a href="#h35-0-15" id="h35-0-15" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h35-0-16" id="h35-0-16" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h35-0-17" id="h35-0-17" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h35-0-18" id="h35-0-18" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h35-0-19" id="h35-0-19" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h35-0-20" id="h35-0-20" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # Step a heartbeat with an outdated commit index.
 step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;last_index&quot;:2,&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
<b>diff --git a/<a id="h36" href="../file/src/raft/testscripts/node/heartbeat_old_last_index.html">src/raft/testscripts/node/heartbeat_old_last_index</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_old_last_index.html">src/raft/testscripts/node/heartbeat_old_last_index</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -2,18 +2,18 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h36-0-3" id="h36-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h36-0-4" id="h36-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h36-0-5" id="h36-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h36-0-6" id="h36-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h36-0-7" id="h36-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h36-0-8" id="h36-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Replicate a write.
 (put 1 foo=bar)
 (stabilize heartbeat=true)
 status
 ---
<a href="#h36-0-15" id="h36-0-15" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h36-0-16" id="h36-0-16" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h36-0-17" id="h36-0-17" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h36-0-18" id="h36-0-18" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h36-0-19" id="h36-0-19" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h36-0-20" id="h36-0-20" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # Step a heartbeat with an outdated last index.
 step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;last_index&quot;:1,&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
<b>diff --git a/<a id="h37" href="../file/src/raft/testscripts/node/heartbeat_probe_divergent.html">src/raft/testscripts/node/heartbeat_probe_divergent</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_probe_divergent.html">src/raft/testscripts/node/heartbeat_probe_divergent</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -4,9 +4,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h37-0-3" id="h37-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h37-0-4" id="h37-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h37-0-5" id="h37-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h37-0-6" id="h37-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h37-0-7" id="h37-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h37-0-8" id="h37-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Make a couple of writes to ensure a common log prefix.
 (put 1 a=1)
<a href="#h37-1" id="h37-1" class="h">@@ -14,9 +14,9 @@ n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> (stabilize)
 status
 ---
<a href="#h37-1-3" id="h37-1-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34}
</a><a href="#h37-1-4" id="h37-1-4" class="d">-n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h37-1-5" id="h37-1-5" class="d">-n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h37-1-6" id="h37-1-6" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34}
</a><a href="#h37-1-7" id="h37-1-7" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 applied=1
</a><a href="#h37-1-8" id="h37-1-8" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 applied=1
</a> 
 # Partition n1
 partition 1
<a href="#h37-2" id="h37-2" class="h">@@ -31,9 +31,9 @@ n1  n2 n3
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h37-2-3" id="h37-2-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34}
</a><a href="#h37-2-4" id="h37-2-4" class="d">-n2@2 leader last=6@2 commit=6@2 apply=6 progress={1:07 3:67}
</a><a href="#h37-2-5" id="h37-2-5" class="d">-n3@2 follower(n2) last=6@2 commit=6@2 apply=6
</a><a href="#h37-2-6" id="h37-2-6" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34}
</a><a href="#h37-2-7" id="h37-2-7" class="i">+n2@2 leader last=6@2 commit=6@2 applied=6 progress={1:07 3:67}
</a><a href="#h37-2-8" id="h37-2-8" class="i">+n3@2 follower(n2) last=6@2 commit=6@2 applied=6
</a> 
 (campaign 3)
 (stabilize)
<a href="#h37-3" id="h37-3" class="h">@@ -42,9 +42,9 @@ n3@2 follower(n2) last=6@2 commit=6@2 apply=6
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h37-3-3" id="h37-3-3" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34}
</a><a href="#h37-3-4" id="h37-3-4" class="d">-n2@3 follower(n3) last=9@3 commit=9@3 apply=9
</a><a href="#h37-3-5" id="h37-3-5" class="d">-n3@3 leader last=9@3 commit=9@3 apply=9 progress={1:010 2:910}
</a><a href="#h37-3-6" id="h37-3-6" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34}
</a><a href="#h37-3-7" id="h37-3-7" class="i">+n2@3 follower(n3) last=9@3 commit=9@3 applied=9
</a><a href="#h37-3-8" id="h37-3-8" class="i">+n3@3 leader last=9@3 commit=9@3 applied=9 progress={1:010 2:910}
</a> 
 # Propose writes in the minority partition as well, to build up a divergent log.
 (put 1 a=2)
<a href="#h37-4" id="h37-4" class="h">@@ -58,9 +58,9 @@ n3@3 leader last=9@3 commit=9@3 apply=9 progress={1:010 2:910}
</a> (stabilize)
 status
 ---
<a href="#h37-4-3" id="h37-4-3" class="d">-n1@1 leader last=11@1 commit=3@1 apply=3 progress={2:312 3:312}
</a><a href="#h37-4-4" id="h37-4-4" class="d">-n2@3 follower(n3) last=9@3 commit=9@3 apply=9
</a><a href="#h37-4-5" id="h37-4-5" class="d">-n3@3 leader last=9@3 commit=9@3 apply=9 progress={1:010 2:910}
</a><a href="#h37-4-6" id="h37-4-6" class="i">+n1@1 leader last=11@1 commit=3@1 applied=3 progress={2:312 3:312}
</a><a href="#h37-4-7" id="h37-4-7" class="i">+n2@3 follower(n3) last=9@3 commit=9@3 applied=9
</a><a href="#h37-4-8" id="h37-4-8" class="i">+n3@3 leader last=9@3 commit=9@3 applied=9 progress={1:010 2:910}
</a> 
 # Heal the partition.
 heal
<a href="#h37-5" id="h37-5" class="h">@@ -108,7 +108,7 @@ n3@3  n1 Heartbeat last_index=10 commit_index=9 read_seq=0
</a> n3@3  n2 Heartbeat last_index=10 commit_index=9 read_seq=0
 n1@3  n3 AppendResponse reject_index=8
 n1@3  n3 HeartbeatResponse match_index=0 read_seq=0
<a href="#h37-5-3" id="h37-5-3" class="d">-n3@3 leader last=10@3 commit=9@3 apply=9 progress={1:09 2:911}
</a><a href="#h37-5-4" id="h37-5-4" class="i">+n3@3 leader last=10@3 commit=9@3 applied=9 progress={1:09 2:911}
</a> 
 # n3 receives probe and heartbeat responses, resulting in duplicate
 # probes being sent at base index 7.
<a href="#h37-6" id="h37-6" class="h">@@ -117,7 +117,7 @@ status 3
</a> ---
 n3@3  n1 Append base=7@3 []
 n3@3  n1 Append base=7@3 []
<a href="#h37-6-3" id="h37-6-3" class="d">-n3@3 leader last=10@3 commit=9@3 apply=9 progress={1:08 2:911}
</a><a href="#h37-6-4" id="h37-6-4" class="i">+n3@3 leader last=10@3 commit=9@3 applied=9 progress={1:08 2:911}
</a> 
 deliver 1
 ---
<b>diff --git a/<a id="h38" href="../file/src/raft/testscripts/node/old_campaign_rejected.html">src/raft/testscripts/node/old_campaign_rejected</a> b/<a href="../file/src/raft/testscripts/node/old_campaign_rejected.html">src/raft/testscripts/node/old_campaign_rejected</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h38-0-3" id="h38-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h38-0-4" id="h38-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h38-0-5" id="h38-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h38-0-6" id="h38-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h38-0-7" id="h38-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h38-0-8" id="h38-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 and n2 campaign.
 campaign 1 2
<a href="#h38-1" id="h38-1" class="h">@@ -43,9 +43,9 @@ n3@1  n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 status
 ---
<a href="#h38-1-3" id="h38-1-3" class="d">-n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:02 3:02}
</a><a href="#h38-1-4" id="h38-1-4" class="d">-n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h38-1-5" id="h38-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h38-1-6" id="h38-1-6" class="i">+n1@1 leader last=1@1 commit=0@0 applied=0 progress={2:02 3:02}
</a><a href="#h38-1-7" id="h38-1-7" class="i">+n2@1 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h38-1-8" id="h38-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=0@0 applied=0
</a> 
 # n1 and n3 receive n2&#39;s Campaign message and reject it.
 deliver 1 3 from=2
<a href="#h38-2" id="h38-2" class="h">@@ -57,6 +57,6 @@ n3@1  n2 CampaignResponse vote=false
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h38-2-3" id="h38-2-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h38-2-4" id="h38-2-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-2-5" id="h38-2-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-2-6" id="h38-2-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h38-2-7" id="h38-2-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h38-2-8" id="h38-2-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h39" href="../file/src/raft/testscripts/node/old_campaign_response_ignored.html">src/raft/testscripts/node/old_campaign_response_ignored</a> b/<a href="../file/src/raft/testscripts/node/old_campaign_response_ignored.html">src/raft/testscripts/node/old_campaign_response_ignored</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -3,13 +3,13 @@
</a> 
 cluster nodes=7
 ---
<a href="#h39-0-3" id="h39-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-4" id="h39-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-5" id="h39-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-6" id="h39-0-6" class="d">-n4@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-7" id="h39-0-7" class="d">-n5@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-8" id="h39-0-8" class="d">-n6@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-9" id="h39-0-9" class="d">-n7@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-0-10" id="h39-0-10" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-11" id="h39-0-11" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-12" id="h39-0-12" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-13" id="h39-0-13" class="i">+n4@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-14" id="h39-0-14" class="i">+n5@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-15" id="h39-0-15" class="i">+n6@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-0-16" id="h39-0-16" class="i">+n7@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 and n2 campaign.
 campaign 1 2
<a href="#h39-1" id="h39-1" class="h">@@ -79,22 +79,22 @@ deliver 1 from=6
</a> deliver 2 from=7
 status
 ---
<a href="#h39-1-3" id="h39-1-3" class="d">-n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:02 3:02 4:02 5:02 6:02 7:02}
</a><a href="#h39-1-4" id="h39-1-4" class="d">-n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h39-1-5" id="h39-1-5" class="d">-n3@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-1-6" id="h39-1-6" class="d">-n4@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-1-7" id="h39-1-7" class="d">-n5@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-1-8" id="h39-1-8" class="d">-n6@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-1-9" id="h39-1-9" class="d">-n7@1 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h39-1-10" id="h39-1-10" class="i">+n1@1 leader last=1@1 commit=0@0 applied=0 progress={2:02 3:02 4:02 5:02 6:02 7:02}
</a><a href="#h39-1-11" id="h39-1-11" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 applied=0
</a><a href="#h39-1-12" id="h39-1-12" class="i">+n3@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-1-13" id="h39-1-13" class="i">+n4@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-1-14" id="h39-1-14" class="i">+n5@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-1-15" id="h39-1-15" class="i">+n6@1 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h39-1-16" id="h39-1-16" class="i">+n7@1 follower() last=0@0 commit=0@0 applied=0
</a> 
 # Stabilizing the cluster results in everyone following n1.
 (stabilize heartbeat=true)
 status
 ---
<a href="#h39-1-22" id="h39-1-22" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12 6:12 7:12}
</a><a href="#h39-1-23" id="h39-1-23" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-24" id="h39-1-24" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-25" id="h39-1-25" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-26" id="h39-1-26" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-27" id="h39-1-27" class="d">-n6@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-28" id="h39-1-28" class="d">-n7@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h39-1-29" id="h39-1-29" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12 6:12 7:12}
</a><a href="#h39-1-30" id="h39-1-30" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h39-1-31" id="h39-1-31" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h39-1-32" id="h39-1-32" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h39-1-33" id="h39-1-33" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h39-1-34" id="h39-1-34" class="i">+n6@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h39-1-35" id="h39-1-35" class="i">+n7@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h40" href="../file/src/raft/testscripts/node/old_heartbeat_ignored.html">src/raft/testscripts/node/old_heartbeat_ignored</a> b/<a href="../file/src/raft/testscripts/node/old_heartbeat_ignored.html">src/raft/testscripts/node/old_heartbeat_ignored</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -3,9 +3,9 @@
</a> # Make n3 leader.
 cluster nodes=3 leader=3
 ---
<a href="#h40-0-3" id="h40-0-3" class="d">-n1@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h40-0-4" id="h40-0-4" class="d">-n2@1 follower(n3) last=1@1 commit=1@1 apply=1
</a><a href="#h40-0-5" id="h40-0-5" class="d">-n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:12 2:12}
</a><a href="#h40-0-6" id="h40-0-6" class="i">+n1@1 follower(n3) last=1@1 commit=1@1 applied=1
</a><a href="#h40-0-7" id="h40-0-7" class="i">+n2@1 follower(n3) last=1@1 commit=1@1 applied=1
</a><a href="#h40-0-8" id="h40-0-8" class="i">+n3@1 leader last=1@1 commit=1@1 applied=1 progress={1:12 2:12}
</a> 
 # Partition n3 away from the cluster.
 partition 3
<a href="#h40-1" id="h40-1" class="h">@@ -17,9 +17,9 @@ n3  n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h40-1-3" id="h40-1-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:23 3:03}
</a><a href="#h40-1-4" id="h40-1-4" class="d">-n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h40-1-5" id="h40-1-5" class="d">-n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:12 2:12}
</a><a href="#h40-1-6" id="h40-1-6" class="i">+n1@2 leader last=2@2 commit=2@2 applied=2 progress={2:23 3:03}
</a><a href="#h40-1-7" id="h40-1-7" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 applied=2
</a><a href="#h40-1-8" id="h40-1-8" class="i">+n3@1 leader last=1@1 commit=1@1 applied=1 progress={1:12 2:12}
</a> 
 # Heal the partition.
 heal
<a href="#h40-2" id="h40-2" class="h">@@ -35,6 +35,6 @@ n3@1  n2 Heartbeat last_index=1 commit_index=1 read_seq=0
</a> 
 status
 ---
<a href="#h40-2-3" id="h40-2-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:23 3:03}
</a><a href="#h40-2-4" id="h40-2-4" class="d">-n2@2 follower(n1) last=2@2 commit=2@2 apply=2
</a><a href="#h40-2-5" id="h40-2-5" class="d">-n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:12 2:12}
</a><a href="#h40-2-6" id="h40-2-6" class="i">+n1@2 leader last=2@2 commit=2@2 applied=2 progress={2:23 3:03}
</a><a href="#h40-2-7" id="h40-2-7" class="i">+n2@2 follower(n1) last=2@2 commit=2@2 applied=2
</a><a href="#h40-2-8" id="h40-2-8" class="i">+n3@1 leader last=1@1 commit=1@1 applied=1 progress={1:12 2:12}
</a><b>diff --git a/<a id="h41" href="../file/src/raft/testscripts/node/request_candidate_abort.html">src/raft/testscripts/node/request_candidate_abort</a> b/<a href="../file/src/raft/testscripts/node/request_candidate_abort.html">src/raft/testscripts/node/request_candidate_abort</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h41-0-3" id="h41-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h41-0-4" id="h41-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h41-0-5" id="h41-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h41-0-6" id="h41-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h41-0-7" id="h41-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h41-0-8" id="h41-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 campaigns.
 campaign 1
<b>diff --git a/<a id="h42" href="../file/src/raft/testscripts/node/request_follower.html">src/raft/testscripts/node/request_follower</a> b/<a href="../file/src/raft/testscripts/node/request_follower.html">src/raft/testscripts/node/request_follower</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h42-0-3" id="h42-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h42-0-4" id="h42-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-5" id="h42-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h42-0-6" id="h42-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h42-0-7" id="h42-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h42-0-8" id="h42-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # An initial get on a follower yields None.
 get 2 foo
<b>diff --git a/<a id="h43" href="../file/src/raft/testscripts/node/request_follower_campaign_abort.html">src/raft/testscripts/node/request_follower_campaign_abort</a> b/<a href="../file/src/raft/testscripts/node/request_follower_campaign_abort.html">src/raft/testscripts/node/request_follower_campaign_abort</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h43-0-3" id="h43-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h43-0-4" id="h43-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-5" id="h43-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h43-0-6" id="h43-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h43-0-7" id="h43-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h43-0-8" id="h43-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Submit a read and write on n2.
 put 2 foo=bar
<b>diff --git a/<a id="h44" href="../file/src/raft/testscripts/node/request_follower_disconnect_stall.html">src/raft/testscripts/node/request_follower_disconnect_stall</a> b/<a href="../file/src/raft/testscripts/node/request_follower_disconnect_stall.html">src/raft/testscripts/node/request_follower_disconnect_stall</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h44-0-3" id="h44-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h44-0-4" id="h44-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h44-0-5" id="h44-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h44-0-6" id="h44-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h44-0-7" id="h44-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h44-0-8" id="h44-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n3 away from the cluster.
 partition 3
<b>diff --git a/<a id="h45" href="../file/src/raft/testscripts/node/request_follower_leaderless_abort.html">src/raft/testscripts/node/request_follower_leaderless_abort</a> b/<a href="../file/src/raft/testscripts/node/request_follower_leaderless_abort.html">src/raft/testscripts/node/request_follower_leaderless_abort</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3
 ---
<a href="#h45-0-3" id="h45-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h45-0-4" id="h45-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h45-0-5" id="h45-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h45-0-6" id="h45-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h45-0-7" id="h45-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h45-0-8" id="h45-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # A read request on n1 should be rejected.
 get 1 foo
<b>diff --git a/<a id="h46" href="../file/src/raft/testscripts/node/request_leader.html">src/raft/testscripts/node/request_leader</a> b/<a href="../file/src/raft/testscripts/node/request_leader.html">src/raft/testscripts/node/request_leader</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h46-0-3" id="h46-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h46-0-4" id="h46-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h46-0-5" id="h46-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h46-0-6" id="h46-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h46-0-7" id="h46-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h46-0-8" id="h46-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # An initial get on the leader yields None.
 get 1 foo
<b>diff --git a/<a id="h47" href="../file/src/raft/testscripts/node/request_leader_campaign_abort.html">src/raft/testscripts/node/request_leader_campaign_abort</a> b/<a href="../file/src/raft/testscripts/node/request_leader_campaign_abort.html">src/raft/testscripts/node/request_leader_campaign_abort</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h47-0-3" id="h47-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h47-0-4" id="h47-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h47-0-5" id="h47-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h47-0-6" id="h47-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h47-0-7" id="h47-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h47-0-8" id="h47-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Submit a read and write on n1.
 put 1 foo=bar
<b>diff --git a/<a id="h48" href="../file/src/raft/testscripts/node/request_leader_change_linearizability.html">src/raft/testscripts/node/request_leader_change_linearizability</a> b/<a href="../file/src/raft/testscripts/node/request_leader_change_linearizability.html">src/raft/testscripts/node/request_leader_change_linearizability</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -2,27 +2,27 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h48-0-3" id="h48-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h48-0-4" id="h48-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h48-0-5" id="h48-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h48-0-6" id="h48-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h48-0-7" id="h48-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h48-0-8" id="h48-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Write an initial value, and propagate the commit index.
 (put 1 a=1)
 (stabilize heartbeat=true)
 status
 ---
<a href="#h48-0-15" id="h48-0-15" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:23}
</a><a href="#h48-0-16" id="h48-0-16" class="d">-n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h48-0-17" id="h48-0-17" class="d">-n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h48-0-18" id="h48-0-18" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:23}
</a><a href="#h48-0-19" id="h48-0-19" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 applied=2
</a><a href="#h48-0-20" id="h48-0-20" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 applied=2
</a> 
 # Write another value, but don&#39;t propagate the commit index.
 (put 1 b=2)
 (stabilize)
 status
 ---
<a href="#h48-0-27" id="h48-0-27" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:34 3:34}
</a><a href="#h48-0-28" id="h48-0-28" class="d">-n2@1 follower(n1) last=3@1 commit=2@1 apply=2
</a><a href="#h48-0-29" id="h48-0-29" class="d">-n3@1 follower(n1) last=3@1 commit=2@1 apply=2
</a><a href="#h48-0-30" id="h48-0-30" class="i">+n1@1 leader last=3@1 commit=3@1 applied=3 progress={2:34 3:34}
</a><a href="#h48-0-31" id="h48-0-31" class="i">+n2@1 follower(n1) last=3@1 commit=2@1 applied=2
</a><a href="#h48-0-32" id="h48-0-32" class="i">+n3@1 follower(n1) last=3@1 commit=2@1 applied=2
</a> 
 # n2 now campaigns and wins, while being behind on commit/apply.
 campaign 2
<a href="#h48-1" id="h48-1" class="h">@@ -53,9 +53,9 @@ heal
</a> status
 ---
 n1 n2 n3 fully connected
<a href="#h48-1-3" id="h48-1-3" class="d">-n1@2 follower() last=3@1 commit=3@1 apply=3
</a><a href="#h48-1-4" id="h48-1-4" class="d">-n2@2 leader last=4@2 commit=2@1 apply=2 progress={1:05 3:05}
</a><a href="#h48-1-5" id="h48-1-5" class="d">-n3@2 follower() last=3@1 commit=2@1 apply=2
</a><a href="#h48-1-6" id="h48-1-6" class="i">+n1@2 follower() last=3@1 commit=3@1 applied=3
</a><a href="#h48-1-7" id="h48-1-7" class="i">+n2@2 leader last=4@2 commit=2@1 applied=2 progress={1:05 3:05}
</a><a href="#h48-1-8" id="h48-1-8" class="i">+n3@2 follower() last=3@1 commit=2@1 applied=2
</a> 
 # Reading from n2 should not result in a stale read even if followers
 # confirm the read sequence.
<b>diff --git a/<a id="h49" href="../file/src/raft/testscripts/node/request_leader_disconnect.html">src/raft/testscripts/node/request_leader_disconnect</a> b/<a href="../file/src/raft/testscripts/node/request_leader_disconnect.html">src/raft/testscripts/node/request_leader_disconnect</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h49-0-3" id="h49-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h49-0-4" id="h49-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h49-0-5" id="h49-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h49-0-6" id="h49-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h49-0-7" id="h49-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h49-0-8" id="h49-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition n1 away from the cluster.
 partition 1
<b>diff --git a/<a id="h50" href="../file/src/raft/testscripts/node/request_leader_read_quorum.html">src/raft/testscripts/node/request_leader_read_quorum</a> b/<a href="../file/src/raft/testscripts/node/request_leader_read_quorum.html">src/raft/testscripts/node/request_leader_read_quorum</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -2,11 +2,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h50-0-3" id="h50-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h50-0-4" id="h50-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-5" id="h50-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-6" id="h50-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-7" id="h50-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h50-0-8" id="h50-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h50-0-9" id="h50-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h50-0-10" id="h50-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h50-0-11" id="h50-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h50-0-12" id="h50-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Write foo=bar.
 (put 1 foo=bar)
<b>diff --git a/<a id="h51" href="../file/src/raft/testscripts/node/request_leader_read_quorum_sequence.html">src/raft/testscripts/node/request_leader_read_quorum_sequence</a> b/<a href="../file/src/raft/testscripts/node/request_leader_read_quorum_sequence.html">src/raft/testscripts/node/request_leader_read_quorum_sequence</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -3,11 +3,11 @@
</a> 
 cluster nodes=5 leader=1
 ---
<a href="#h51-0-3" id="h51-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h51-0-4" id="h51-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h51-0-5" id="h51-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h51-0-6" id="h51-0-6" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h51-0-7" id="h51-0-7" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h51-0-8" id="h51-0-8" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12 4:12 5:12}
</a><a href="#h51-0-9" id="h51-0-9" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h51-0-10" id="h51-0-10" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h51-0-11" id="h51-0-11" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h51-0-12" id="h51-0-12" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Write foo=bar and read it back.
 (put 1 foo=bar)
<b>diff --git a/<a id="h52" href="../file/src/raft/testscripts/node/request_leader_single.html">src/raft/testscripts/node/request_leader_single</a> b/<a href="../file/src/raft/testscripts/node/request_leader_single.html">src/raft/testscripts/node/request_leader_single</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -2,7 +2,7 @@
</a> 
 cluster nodes=1
 ---
<a href="#h52-0-3" id="h52-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={}
</a><a href="#h52-0-4" id="h52-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={}
</a> 
 # An initial get on the leader yields None.
 get 1 foo
<b>diff --git a/<a id="h53" href="../file/src/raft/testscripts/node/request_status.html">src/raft/testscripts/node/request_status</a> b/<a href="../file/src/raft/testscripts/node/request_status.html">src/raft/testscripts/node/request_status</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h53-0-3" id="h53-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h53-0-4" id="h53-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h53-0-5" id="h53-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h53-0-6" id="h53-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h53-0-7" id="h53-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h53-0-8" id="h53-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Partition away n3, so not all nodes have the same log position.
 partition 3
<a href="#h53-1" id="h53-1" class="h">@@ -16,16 +16,16 @@ n3  n1 n2
</a> (stabilize)
 status
 ---
<a href="#h53-1-3" id="h53-1-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:23 3:13}
</a><a href="#h53-1-4" id="h53-1-4" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h53-1-5" id="h53-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h53-1-6" id="h53-1-6" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={2:23 3:13}
</a><a href="#h53-1-7" id="h53-1-7" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 applied=1
</a><a href="#h53-1-8" id="h53-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Run a status request on the leader.
 status request=true 1
 stabilize
 ---
 c1@1  n1 ClientRequest id=0x02 status
<a href="#h53-1-15" id="h53-1-15" class="d">-n1@1  c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h53-1-16" id="h53-1-16" class="i">+n1@1  c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, applied_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a> c1@1 status  Status {
     leader: 1,
     term: 1,
<a href="#h53-2" id="h53-2" class="h">@@ -35,7 +35,7 @@ c1@1 status  Status {
</a>         3: 1,
     },
     commit_index: 2,
<a href="#h53-2-3" id="h53-2-3" class="d">-    apply_index: 2,
</a><a href="#h53-2-4" id="h53-2-4" class="i">+    applied_index: 2,
</a>     storage: Status {
         name: &quot;memory&quot;,
         keys: 4,
<a href="#h53-3" id="h53-3" class="h">@@ -52,8 +52,8 @@ stabilize
</a> ---
 c2@1  n2 ClientRequest id=0x03 status
 n2@1  n1 ClientRequest id=0x03 status
<a href="#h53-3-3" id="h53-3-3" class="d">-n1@1  n2 ClientResponse id=0x03 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h53-3-4" id="h53-3-4" class="d">-n2@1  c2 ClientResponse id=0x03 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h53-3-5" id="h53-3-5" class="i">+n1@1  n2 ClientResponse id=0x03 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, applied_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h53-3-6" id="h53-3-6" class="i">+n2@1  c2 ClientResponse id=0x03 status Status { leader: 1, term: 1, match_index: {1: 2, 2: 2, 3: 1}, commit_index: 2, applied_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a> c2@1 status  Status {
     leader: 1,
     term: 1,
<a href="#h53-4" id="h53-4" class="h">@@ -63,7 +63,7 @@ c2@1 status  Status {
</a>         3: 1,
     },
     commit_index: 2,
<a href="#h53-4-3" id="h53-4-3" class="d">-    apply_index: 2,
</a><a href="#h53-4-4" id="h53-4-4" class="i">+    applied_index: 2,
</a>     storage: Status {
         name: &quot;memory&quot;,
         keys: 4,
<b>diff --git a/<a id="h54" href="../file/src/raft/testscripts/node/request_status_single.html">src/raft/testscripts/node/request_status_single</a> b/<a href="../file/src/raft/testscripts/node/request_status_single.html">src/raft/testscripts/node/request_status_single</a></b>
<a href="#h54-0" id="h54-0" class="h">@@ -2,21 +2,21 @@
</a> 
 cluster nodes=1
 ---
<a href="#h54-0-3" id="h54-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={}
</a><a href="#h54-0-4" id="h54-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={}
</a> 
 # Perform a write.
 (put 1 foo=bar)
 (stabilize)
 status
 ---
<a href="#h54-0-11" id="h54-0-11" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={}
</a><a href="#h54-0-12" id="h54-0-12" class="i">+n1@1 leader last=2@1 commit=2@1 applied=2 progress={}
</a> 
 # Run a status request on the leader.
 status request=true 1
 stabilize
 ---
 c1@1  n1 ClientRequest id=0x02 status
<a href="#h54-0-19" id="h54-0-19" class="d">-n1@1  c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, match_index: {1: 2}, commit_index: 2, apply_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a><a href="#h54-0-20" id="h54-0-20" class="i">+n1@1  c1 ClientResponse id=0x02 status Status { leader: 1, term: 1, match_index: {1: 2}, commit_index: 2, applied_index: 2, storage: Status { name: &quot;memory&quot;, keys: 4, size: 41, total_disk_size: 0, live_disk_size: 0, garbage_disk_size: 0 } }
</a> c1@1 status  Status {
     leader: 1,
     term: 1,
<a href="#h54-1" id="h54-1" class="h">@@ -24,7 +24,7 @@ c1@1 status  Status {
</a>         1: 2,
     },
     commit_index: 2,
<a href="#h54-1-3" id="h54-1-3" class="d">-    apply_index: 2,
</a><a href="#h54-1-4" id="h54-1-4" class="i">+    applied_index: 2,
</a>     storage: Status {
         name: &quot;memory&quot;,
         keys: 4,
<b>diff --git a/<a id="h55" href="../file/src/raft/testscripts/node/tick_candidate.html">src/raft/testscripts/node/tick_candidate</a> b/<a href="../file/src/raft/testscripts/node/tick_candidate.html">src/raft/testscripts/node/tick_candidate</a></b>
<a href="#h55-0" id="h55-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 heartbeat_interval=1 election_timeout=2
 ---
<a href="#h55-0-3" id="h55-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h55-0-4" id="h55-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h55-0-5" id="h55-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h55-0-6" id="h55-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h55-0-7" id="h55-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h55-0-8" id="h55-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # n1 campaigns.
 campaign 1
<a href="#h55-1" id="h55-1" class="h">@@ -27,6 +27,6 @@ n1@2  n3 Campaign last=0@0
</a> 
 status
 ---
<a href="#h55-1-3" id="h55-1-3" class="d">-n1@2 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h55-1-4" id="h55-1-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h55-1-5" id="h55-1-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h55-1-6" id="h55-1-6" class="i">+n1@2 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h55-1-7" id="h55-1-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h55-1-8" id="h55-1-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a><b>diff --git a/<a id="h56" href="../file/src/raft/testscripts/node/tick_follower.html">src/raft/testscripts/node/tick_follower</a> b/<a href="../file/src/raft/testscripts/node/tick_follower.html">src/raft/testscripts/node/tick_follower</a></b>
<a href="#h56-0" id="h56-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1 heartbeat_interval=1 election_timeout=2
 ---
<a href="#h56-0-3" id="h56-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h56-0-4" id="h56-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h56-0-5" id="h56-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h56-0-6" id="h56-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h56-0-7" id="h56-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h56-0-8" id="h56-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # A single follower tick does nothing.
 tick 2
<a href="#h56-1" id="h56-1" class="h">@@ -34,6 +34,6 @@ n2@2  n3 Campaign last=1@1
</a> 
 status
 ---
<a href="#h56-1-3" id="h56-1-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h56-1-4" id="h56-1-4" class="d">-n2@2 candidate last=1@1 commit=1@1 apply=1
</a><a href="#h56-1-5" id="h56-1-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h56-1-6" id="h56-1-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h56-1-7" id="h56-1-7" class="i">+n2@2 candidate last=1@1 commit=1@1 applied=1
</a><a href="#h56-1-8" id="h56-1-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><b>diff --git a/<a id="h57" href="../file/src/raft/testscripts/node/tick_follower_leaderless.html">src/raft/testscripts/node/tick_follower_leaderless</a> b/<a href="../file/src/raft/testscripts/node/tick_follower_leaderless.html">src/raft/testscripts/node/tick_follower_leaderless</a></b>
<a href="#h57-0" id="h57-0" class="h">@@ -2,9 +2,9 @@
</a> 
 cluster nodes=3 heartbeat_interval=1 election_timeout=2
 ---
<a href="#h57-0-3" id="h57-0-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h57-0-4" id="h57-0-4" class="d">-n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h57-0-5" id="h57-0-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h57-0-6" id="h57-0-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h57-0-7" id="h57-0-7" class="i">+n2@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h57-0-8" id="h57-0-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a> 
 # A single follower tick does nothing.
 tick 2
<a href="#h57-1" id="h57-1" class="h">@@ -20,6 +20,6 @@ n2@1  n3 Campaign last=0@0
</a> 
 status
 ---
<a href="#h57-1-3" id="h57-1-3" class="d">-n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h57-1-4" id="h57-1-4" class="d">-n2@1 candidate last=0@0 commit=0@0 apply=0
</a><a href="#h57-1-5" id="h57-1-5" class="d">-n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h57-1-6" id="h57-1-6" class="i">+n1@0 follower() last=0@0 commit=0@0 applied=0
</a><a href="#h57-1-7" id="h57-1-7" class="i">+n2@1 candidate last=0@0 commit=0@0 applied=0
</a><a href="#h57-1-8" id="h57-1-8" class="i">+n3@0 follower() last=0@0 commit=0@0 applied=0
</a><b>diff --git a/<a id="h58" href="../file/src/raft/testscripts/node/tick_leader.html">src/raft/testscripts/node/tick_leader</a> b/<a href="../file/src/raft/testscripts/node/tick_leader.html">src/raft/testscripts/node/tick_leader</a></b>
<a href="#h58-0" id="h58-0" class="h">@@ -3,9 +3,9 @@
</a> 
 cluster nodes=3 leader=1 heartbeat_interval=1 election_timeout=2
 ---
<a href="#h58-0-3" id="h58-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:12 3:12}
</a><a href="#h58-0-4" id="h58-0-4" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h58-0-5" id="h58-0-5" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h58-0-6" id="h58-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 applied=1 progress={2:12 3:12}
</a><a href="#h58-0-7" id="h58-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 applied=1
</a><a href="#h58-0-8" id="h58-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 applied=1
</a> 
 # Ticking n1 will emit a heartbeat.
 tick 1
<b>diff --git a/<a id="h59" href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a> b/<a href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a></b>
<a href="#h59-0" id="h59-0" class="h">@@ -128,7 +128,7 @@ fn status() -&gt; Result&lt;()&gt; {
</a>                 term: 1,
                 match_index: [(1, 27)].into(),
                 commit_index: 27,
<a href="#h59-0-3" id="h59-0-3" class="d">-                apply_index: 27,
</a><a href="#h59-0-4" id="h59-0-4" class="i">+                applied_index: 27,
</a>                 storage: storage::engine::Status {
                     name: &quot;bitcask&quot;.to_string(),
                     keys: 29,
</pre>
</div>
</body>
</html>
