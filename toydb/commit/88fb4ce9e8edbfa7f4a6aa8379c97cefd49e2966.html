<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: remove Context struct - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/88fb4ce9e8edbfa7f4a6aa8379c97cefd49e2966.html">88fb4ce9e8edbfa7f4a6aa8379c97cefd49e2966</a>
<b>parent</b> <a href="../commit/3cb64d998a56b505a115dc983c170316fa19462c.html">3cb64d998a56b505a115dc983c170316fa19462c</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 30 May 2020 19:43:36 +0200

sql: remove Context struct

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/engine/mod.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/execution/aggregation.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/execution/create_table.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/execution/delete.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/execution/drop_table.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/execution/filter.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/sql/execution/index_lookup.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/sql/execution/insert.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/sql/execution/key_lookup.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/sql/execution/limit.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">src/sql/execution/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/sql/execution/nested_loop_join.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/sql/execution/nothing.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/sql/execution/offset.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/sql/execution/order.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/sql/execution/projection.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/sql/execution/scan.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/sql/execution/update.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/sql/plan/mod.rs</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">tests/sql/query.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
</table></pre><pre>20 files changed, 69 insertions(+), 79 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a> b/<a href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -4,7 +4,7 @@ pub mod raft;
</a> pub use kv::KV;
 pub use raft::{Raft, Status};
 
<a href="#h0-0-3" id="h0-0-3" class="d">-use super::execution::{Context, ResultSet};
</a><a href="#h0-0-4" id="h0-0-4" class="i">+use super::execution::ResultSet;
</a> use super::parser::{ast, Parser};
 use super::plan::Plan;
 use super::schema::Catalog;
<a href="#h0-1" id="h0-1" class="h">@@ -116,21 +116,17 @@ impl&lt;E: Engine + &#39;static&gt; Session&lt;E&gt; {
</a>             }),
             statement if self.txn.is_some() =&gt; Plan::build(statement, self.txn.as_mut().unwrap())?
                 .optimize(self.txn.as_mut().unwrap())?
<a href="#h0-1-3" id="h0-1-3" class="d">-                .execute(Context { txn: self.txn.as_mut().unwrap() }),
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                .execute(self.txn.as_mut().unwrap()),
</a>             statement @ ast::Statement::Select { .. } =&gt; {
                 let mut txn = self.engine.begin(Mode::ReadOnly)?;
<a href="#h0-1-7" id="h0-1-7" class="d">-                let result = Plan::build(statement, &amp;mut txn)?
</a><a href="#h0-1-8" id="h0-1-8" class="d">-                    .optimize(&amp;mut txn)?
</a><a href="#h0-1-9" id="h0-1-9" class="d">-                    .execute(Context { txn: &amp;mut txn });
</a><a href="#h0-1-10" id="h0-1-10" class="i">+                let result =
</a><a href="#h0-1-11" id="h0-1-11" class="i">+                    Plan::build(statement, &amp;mut txn)?.optimize(&amp;mut txn)?.execute(&amp;mut txn);
</a>                 txn.rollback()?;
                 result
             }
             statement =&gt; {
                 let mut txn = self.engine.begin(Mode::ReadWrite)?;
<a href="#h0-1-17" id="h0-1-17" class="d">-                match Plan::build(statement, &amp;mut txn)?
</a><a href="#h0-1-18" id="h0-1-18" class="d">-                    .optimize(&amp;mut txn)?
</a><a href="#h0-1-19" id="h0-1-19" class="d">-                    .execute(Context { txn: &amp;mut txn })
</a><a href="#h0-1-20" id="h0-1-20" class="d">-                {
</a><a href="#h0-1-21" id="h0-1-21" class="i">+                match Plan::build(statement, &amp;mut txn)?.optimize(&amp;mut txn)?.execute(&amp;mut txn) {
</a>                     Ok(result) =&gt; {
                         txn.commit()?;
                         Ok(result)
<b>diff --git a/<a id="h1" href="../file/src/sql/execution/aggregation.rs.html">src/sql/execution/aggregation.rs</a> b/<a href="../file/src/sql/execution/aggregation.rs.html">src/sql/execution/aggregation.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,7 +1,7 @@
</a> use super::super::engine::Transaction;
 use super::super::plan::Aggregate;
 use super::super::types::{Column, Value};
<a href="#h1-0-3" id="h1-0-3" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h1-0-4" id="h1-0-4" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 use std::cmp::Ordering;
<a href="#h1-1" id="h1-1" class="h">@@ -25,9 +25,9 @@ impl&lt;T: Transaction&gt; Aggregation&lt;T&gt; {
</a> 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Aggregation&lt;T&gt; {
     #[allow(clippy::or_fun_call)]
<a href="#h1-1-3" id="h1-1-3" class="d">-    fn execute(mut self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    fn execute(mut self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a>         let agg_count = self.aggregates.len();
<a href="#h1-1-6" id="h1-1-6" class="d">-        match self.source.execute(ctx)? {
</a><a href="#h1-1-7" id="h1-1-7" class="i">+        match self.source.execute(txn)? {
</a>             ResultSet::Query { columns, mut rows } =&gt; {
                 while let Some(mut row) = rows.next().transpose()? {
                     self.accumulators
<b>diff --git a/<a id="h2" href="../file/src/sql/execution/create_table.rs.html">src/sql/execution/create_table.rs</a> b/<a href="../file/src/sql/execution/create_table.rs.html">src/sql/execution/create_table.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::schema::Table;
<a href="#h2-0-2" id="h2-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h2-0-3" id="h2-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// A CREATE TABLE executor
<a href="#h2-1" id="h2-1" class="h">@@ -16,8 +16,8 @@ impl CreateTable {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for CreateTable {
<a href="#h2-1-3" id="h2-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h2-1-4" id="h2-1-4" class="d">-        ctx.txn.create_table(&amp;self.table)?;
</a><a href="#h2-1-5" id="h2-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        txn.create_table(&amp;self.table)?;
</a>         Ok(ResultSet::CreateTable { name: self.table.name })
     }
 }
<b>diff --git a/<a id="h3" href="../file/src/sql/execution/delete.rs.html">src/sql/execution/delete.rs</a> b/<a href="../file/src/sql/execution/delete.rs.html">src/sql/execution/delete.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,5 +1,5 @@
</a> use super::super::engine::Transaction;
<a href="#h3-0-1" id="h3-0-1" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h3-0-2" id="h3-0-2" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// A DELETE executor
<a href="#h3-1" id="h3-1" class="h">@@ -17,13 +17,13 @@ impl&lt;T: Transaction&gt; Delete&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Delete&lt;T&gt; {
<a href="#h3-1-3" id="h3-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h3-1-5" id="h3-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h3-1-6" id="h3-1-6" class="i">+        let table = txn.must_read_table(&amp;self.table)?;
</a>         let mut count = 0;
<a href="#h3-1-8" id="h3-1-8" class="d">-        match self.source.execute(ctx)? {
</a><a href="#h3-1-9" id="h3-1-9" class="i">+        match self.source.execute(txn)? {
</a>             ResultSet::Query { mut rows, .. } =&gt; {
                 while let Some(row) = rows.next().transpose()? {
<a href="#h3-1-12" id="h3-1-12" class="d">-                    ctx.txn.delete(&amp;table.name, &amp;table.get_row_key(&amp;row)?)?;
</a><a href="#h3-1-13" id="h3-1-13" class="i">+                    txn.delete(&amp;table.name, &amp;table.get_row_key(&amp;row)?)?;
</a>                     count += 1
                 }
                 Ok(ResultSet::Delete { count })
<b>diff --git a/<a id="h4" href="../file/src/sql/execution/drop_table.rs.html">src/sql/execution/drop_table.rs</a> b/<a href="../file/src/sql/execution/drop_table.rs.html">src/sql/execution/drop_table.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,5 +1,5 @@
</a> use super::super::engine::Transaction;
<a href="#h4-0-1" id="h4-0-1" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h4-0-2" id="h4-0-2" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// A DROP TABLE executor
<a href="#h4-1" id="h4-1" class="h">@@ -15,8 +15,8 @@ impl DropTable {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for DropTable {
<a href="#h4-1-3" id="h4-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h4-1-4" id="h4-1-4" class="d">-        ctx.txn.delete_table(&amp;self.table)?;
</a><a href="#h4-1-5" id="h4-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h4-1-6" id="h4-1-6" class="i">+        txn.delete_table(&amp;self.table)?;
</a>         Ok(ResultSet::DropTable { name: self.table })
     }
 }
<b>diff --git a/<a id="h5" href="../file/src/sql/execution/filter.rs.html">src/sql/execution/filter.rs</a> b/<a href="../file/src/sql/execution/filter.rs.html">src/sql/execution/filter.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,7 +1,7 @@
</a> use super::super::engine::Transaction;
 use super::super::types::Expression;
 use super::super::types::Value;
<a href="#h5-0-3" id="h5-0-3" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h5-0-4" id="h5-0-4" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// A filter executor
<a href="#h5-1" id="h5-1" class="h">@@ -19,8 +19,8 @@ impl&lt;T: Transaction&gt; Filter&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Filter&lt;T&gt; {
<a href="#h5-1-3" id="h5-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h5-1-4" id="h5-1-4" class="d">-        let result = self.source.execute(ctx)?;
</a><a href="#h5-1-5" id="h5-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h5-1-6" id="h5-1-6" class="i">+        let result = self.source.execute(txn)?;
</a>         if let ResultSet::Query { columns, rows } = result {
             let predicate = self.predicate;
             Ok(ResultSet::Query {
<b>diff --git a/<a id="h6" href="../file/src/sql/execution/index_lookup.rs.html">src/sql/execution/index_lookup.rs</a> b/<a href="../file/src/sql/execution/index_lookup.rs.html">src/sql/execution/index_lookup.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::{Column, Row, Value};
<a href="#h6-0-2" id="h6-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h6-0-3" id="h6-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 use std::collections::HashSet;
<a href="#h6-1" id="h6-1" class="h">@@ -30,19 +30,19 @@ impl IndexLookup {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for IndexLookup {
<a href="#h6-1-3" id="h6-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h6-1-4" id="h6-1-4" class="d">-        let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h6-1-5" id="h6-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h6-1-6" id="h6-1-6" class="i">+        let table = txn.must_read_table(&amp;self.table)?;
</a>         let name = if let Some(alias) = &amp;self.alias { alias } else { &amp;table.name };
 
         let mut pks: HashSet&lt;Value&gt; = HashSet::new();
         for key in self.keys {
<a href="#h6-1-11" id="h6-1-11" class="d">-            pks.extend(ctx.txn.read_index(&amp;self.table, &amp;self.column, &amp;key)?);
</a><a href="#h6-1-12" id="h6-1-12" class="i">+            pks.extend(txn.read_index(&amp;self.table, &amp;self.column, &amp;key)?);
</a>         }
 
         // FIXME Is there a way to pass the txn into an iterator closure instead?
         let rows = pks
             .into_iter()
<a href="#h6-1-18" id="h6-1-18" class="d">-            .filter_map(|pk| ctx.txn.read(&amp;table.name, &amp;pk).transpose())
</a><a href="#h6-1-19" id="h6-1-19" class="i">+            .filter_map(|pk| txn.read(&amp;table.name, &amp;pk).transpose())
</a>             .collect::&lt;Result&lt;Vec&lt;Row&gt;&gt;&gt;()?;
 
         Ok(ResultSet::Query {
<b>diff --git a/<a id="h7" href="../file/src/sql/execution/insert.rs.html">src/sql/execution/insert.rs</a> b/<a href="../file/src/sql/execution/insert.rs.html">src/sql/execution/insert.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::Expressions;
<a href="#h7-0-2" id="h7-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h7-0-3" id="h7-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// An INSERT executor
<a href="#h7-1" id="h7-1" class="h">@@ -20,8 +20,8 @@ impl Insert {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Insert {
<a href="#h7-1-3" id="h7-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-        let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h7-1-5" id="h7-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h7-1-6" id="h7-1-6" class="i">+        let table = txn.must_read_table(&amp;self.table)?;
</a>         let mut count = 0;
         for expressions in self.rows {
             let mut row =
<a href="#h7-2" id="h7-2" class="h">@@ -31,7 +31,7 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Insert {
</a>             } else {
                 row = table.make_row(&amp;self.columns, row)?;
             }
<a href="#h7-2-3" id="h7-2-3" class="d">-            ctx.txn.create(&amp;table.name, row)?;
</a><a href="#h7-2-4" id="h7-2-4" class="i">+            txn.create(&amp;table.name, row)?;
</a>             count += 1;
         }
         Ok(ResultSet::Create { count })
<b>diff --git a/<a id="h8" href="../file/src/sql/execution/key_lookup.rs.html">src/sql/execution/key_lookup.rs</a> b/<a href="../file/src/sql/execution/key_lookup.rs.html">src/sql/execution/key_lookup.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::{Column, Row, Value};
<a href="#h8-0-2" id="h8-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h8-0-3" id="h8-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// A primary key lookup executor
<a href="#h8-1" id="h8-1" class="h">@@ -21,15 +21,15 @@ impl KeyLookup {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for KeyLookup {
<a href="#h8-1-3" id="h8-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h8-1-4" id="h8-1-4" class="d">-        let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h8-1-5" id="h8-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h8-1-6" id="h8-1-6" class="i">+        let table = txn.must_read_table(&amp;self.table)?;
</a>         let name = if let Some(alias) = &amp;self.alias { alias } else { &amp;table.name };
 
         // FIXME Is there a way to pass the txn into an iterator closure instead?
         let rows = self
             .keys
             .into_iter()
<a href="#h8-1-13" id="h8-1-13" class="d">-            .filter_map(|key| ctx.txn.read(&amp;table.name, &amp;key).transpose())
</a><a href="#h8-1-14" id="h8-1-14" class="i">+            .filter_map(|key| txn.read(&amp;table.name, &amp;key).transpose())
</a>             .collect::&lt;Result&lt;Vec&lt;Row&gt;&gt;&gt;()?;
 
         Ok(ResultSet::Query {
<b>diff --git a/<a id="h9" href="../file/src/sql/execution/limit.rs.html">src/sql/execution/limit.rs</a> b/<a href="../file/src/sql/execution/limit.rs.html">src/sql/execution/limit.rs</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,5 +1,5 @@
</a> use super::super::engine::Transaction;
<a href="#h9-0-1" id="h9-0-1" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h9-0-2" id="h9-0-2" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// A LIMIT executor
<a href="#h9-1" id="h9-1" class="h">@@ -17,8 +17,8 @@ impl&lt;T: Transaction&gt; Limit&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Limit&lt;T&gt; {
<a href="#h9-1-3" id="h9-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h9-1-4" id="h9-1-4" class="d">-        if let ResultSet::Query { columns, rows } = self.source.execute(ctx)? {
</a><a href="#h9-1-5" id="h9-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h9-1-6" id="h9-1-6" class="i">+        if let ResultSet::Query { columns, rows } = self.source.execute(txn)? {
</a>             Ok(ResultSet::Query { columns, rows: Box::new(rows.take(self.limit as usize)) })
         } else {
             Err(Error::Internal(&quot;Unexpected result&quot;.into()))
<b>diff --git a/<a id="h10" href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a> b/<a href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -43,7 +43,7 @@ use serde_derive::{Deserialize, Serialize};
</a> /// A plan executor
 pub trait Executor&lt;T: Transaction&gt; {
     /// Executes the executor, consuming it and returning a result set
<a href="#h10-0-3" id="h10-0-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt;;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt;;
</a> }
 
 impl&lt;T: Transaction + &#39;static&gt; dyn Executor&lt;T&gt; {
<a href="#h10-1" id="h10-1" class="h">@@ -82,12 +82,6 @@ impl&lt;T: Transaction + &#39;static&gt; dyn Executor&lt;T&gt; {
</a>     }
 }
 
<a href="#h10-1-3" id="h10-1-3" class="d">-/// An execution context
</a><a href="#h10-1-4" id="h10-1-4" class="d">-pub struct Context&lt;&#39;a, T: Transaction&gt; {
</a><a href="#h10-1-5" id="h10-1-5" class="d">-    /// The transaction to execute in
</a><a href="#h10-1-6" id="h10-1-6" class="d">-    pub txn: &amp;&#39;a mut T,
</a><a href="#h10-1-7" id="h10-1-7" class="d">-}
</a><a href="#h10-1-8" id="h10-1-8" class="d">-
</a> /// An executor result set
 #[derive(Derivative, Serialize, Deserialize)]
 #[derivative(Debug, PartialEq)]
<b>diff --git a/<a id="h11" href="../file/src/sql/execution/nested_loop_join.rs.html">src/sql/execution/nested_loop_join.rs</a> b/<a href="../file/src/sql/execution/nested_loop_join.rs.html">src/sql/execution/nested_loop_join.rs</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::{Columns, Expression, Rows};
<a href="#h11-0-2" id="h11-0-2" class="d">-use super::{Context, Executor, ResultSet, Row, Value};
</a><a href="#h11-0-3" id="h11-0-3" class="i">+use super::{Executor, ResultSet, Row, Value};
</a> use crate::error::{Error, Result};
 
 /// A nested loop join executor
<a href="#h11-1" id="h11-1" class="h">@@ -31,11 +31,11 @@ impl&lt;T: Transaction&gt; NestedLoopJoin&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for NestedLoopJoin&lt;T&gt; {
<a href="#h11-1-3" id="h11-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h11-1-4" id="h11-1-4" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a>         let (result, inner) = if self.flip {
<a href="#h11-1-6" id="h11-1-6" class="d">-            (self.inner.execute(ctx)?, self.outer.execute(ctx)?)
</a><a href="#h11-1-7" id="h11-1-7" class="i">+            (self.inner.execute(txn)?, self.outer.execute(txn)?)
</a>         } else {
<a href="#h11-1-9" id="h11-1-9" class="d">-            (self.outer.execute(ctx)?, self.inner.execute(ctx)?)
</a><a href="#h11-1-10" id="h11-1-10" class="i">+            (self.outer.execute(txn)?, self.inner.execute(txn)?)
</a>         };
         if let ResultSet::Query { columns, rows } = result {
             if let ResultSet::Query { columns: inner_columns, rows: inner_rows } = inner {
<b>diff --git a/<a id="h12" href="../file/src/sql/execution/nothing.rs.html">src/sql/execution/nothing.rs</a> b/<a href="../file/src/sql/execution/nothing.rs.html">src/sql/execution/nothing.rs</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::Row;
<a href="#h12-0-2" id="h12-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h12-0-3" id="h12-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// An executor that produces a single empty row
<a href="#h12-1" id="h12-1" class="h">@@ -13,7 +13,7 @@ impl Nothing {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Nothing {
<a href="#h12-1-3" id="h12-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, _ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h12-1-4" id="h12-1-4" class="i">+    fn execute(self: Box&lt;Self&gt;, _: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a>         Ok(ResultSet::Query {
             columns: Vec::new(),
             rows: Box::new(std::iter::once(Ok(Row::new()))),
<b>diff --git a/<a id="h13" href="../file/src/sql/execution/offset.rs.html">src/sql/execution/offset.rs</a> b/<a href="../file/src/sql/execution/offset.rs.html">src/sql/execution/offset.rs</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,5 +1,5 @@
</a> use super::super::engine::Transaction;
<a href="#h13-0-1" id="h13-0-1" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h13-0-2" id="h13-0-2" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// An OFFSET executor
<a href="#h13-1" id="h13-1" class="h">@@ -17,8 +17,8 @@ impl&lt;T: Transaction&gt; Offset&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Offset&lt;T&gt; {
<a href="#h13-1-3" id="h13-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h13-1-4" id="h13-1-4" class="d">-        if let ResultSet::Query { columns, rows } = self.source.execute(ctx)? {
</a><a href="#h13-1-5" id="h13-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h13-1-6" id="h13-1-6" class="i">+        if let ResultSet::Query { columns, rows } = self.source.execute(txn)? {
</a>             Ok(ResultSet::Query { columns, rows: Box::new(rows.skip(self.offset as usize)) })
         } else {
             Err(Error::Internal(&quot;Unexpected result&quot;.into()))
<b>diff --git a/<a id="h14" href="../file/src/sql/execution/order.rs.html">src/sql/execution/order.rs</a> b/<a href="../file/src/sql/execution/order.rs.html">src/sql/execution/order.rs</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,7 +1,7 @@
</a> use super::super::engine::Transaction;
 use super::super::plan::Direction;
 use super::super::types::{Expression, Row, Value};
<a href="#h14-0-3" id="h14-0-3" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h14-0-4" id="h14-0-4" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// An order executor
<a href="#h14-1" id="h14-1" class="h">@@ -19,8 +19,8 @@ impl&lt;T: Transaction&gt; Order&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Order&lt;T&gt; {
<a href="#h14-1-3" id="h14-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h14-1-4" id="h14-1-4" class="d">-        match self.source.execute(ctx)? {
</a><a href="#h14-1-5" id="h14-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h14-1-6" id="h14-1-6" class="i">+        match self.source.execute(txn)? {
</a>             ResultSet::Query { columns, mut rows } =&gt; {
                 // FIXME Since we can&#39;t return errors from the sort_by closure, we have to
                 // pre-evaluate all values. This means that we can&#39;t short-circuit evaluation,
<b>diff --git a/<a id="h15" href="../file/src/sql/execution/projection.rs.html">src/sql/execution/projection.rs</a> b/<a href="../file/src/sql/execution/projection.rs.html">src/sql/execution/projection.rs</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::{Column, Expression, Expressions};
<a href="#h15-0-2" id="h15-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h15-0-3" id="h15-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 /// A filter executor
<a href="#h15-1" id="h15-1" class="h">@@ -24,8 +24,8 @@ impl&lt;T: Transaction&gt; Projection&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Projection&lt;T&gt; {
<a href="#h15-1-3" id="h15-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h15-1-4" id="h15-1-4" class="d">-        match self.source.execute(ctx)? {
</a><a href="#h15-1-5" id="h15-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h15-1-6" id="h15-1-6" class="i">+        match self.source.execute(txn)? {
</a>             ResultSet::Query { columns, rows } =&gt; {
                 let labels = self.labels;
                 let columns = self
<b>diff --git a/<a id="h16" href="../file/src/sql/execution/scan.rs.html">src/sql/execution/scan.rs</a> b/<a href="../file/src/sql/execution/scan.rs.html">src/sql/execution/scan.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::{Column, Expression};
<a href="#h16-0-2" id="h16-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h16-0-3" id="h16-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::Result;
 
 /// A table scan executor
<a href="#h16-1" id="h16-1" class="h">@@ -18,15 +18,15 @@ impl Scan {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Scan {
<a href="#h16-1-3" id="h16-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h16-1-4" id="h16-1-4" class="d">-        let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h16-1-5" id="h16-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h16-1-6" id="h16-1-6" class="i">+        let table = txn.must_read_table(&amp;self.table)?;
</a>         Ok(ResultSet::Query {
             columns: table
                 .columns
                 .iter()
                 .map(|c| Column { table: Some(self.label.clone()), name: Some(c.name.clone()) })
                 .collect(),
<a href="#h16-1-13" id="h16-1-13" class="d">-            rows: Box::new(ctx.txn.scan(&amp;table.name, self.filter)?),
</a><a href="#h16-1-14" id="h16-1-14" class="i">+            rows: Box::new(txn.scan(&amp;table.name, self.filter)?),
</a>         })
     }
 }
<b>diff --git a/<a id="h17" href="../file/src/sql/execution/update.rs.html">src/sql/execution/update.rs</a> b/<a href="../file/src/sql/execution/update.rs.html">src/sql/execution/update.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::engine::Transaction;
 use super::super::types::Expression;
<a href="#h17-0-2" id="h17-0-2" class="d">-use super::{Context, Executor, ResultSet};
</a><a href="#h17-0-3" id="h17-0-3" class="i">+use super::{Executor, ResultSet};
</a> use crate::error::{Error, Result};
 
 use std::collections::{BTreeMap, HashSet};
<a href="#h17-1" id="h17-1" class="h">@@ -27,10 +27,10 @@ impl&lt;T: Transaction&gt; Update&lt;T&gt; {
</a> }
 
 impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
<a href="#h17-1-3" id="h17-1-3" class="d">-    fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h17-1-4" id="h17-1-4" class="d">-        match self.source.execute(ctx)? {
</a><a href="#h17-1-5" id="h17-1-5" class="i">+    fn execute(self: Box&lt;Self&gt;, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h17-1-6" id="h17-1-6" class="i">+        match self.source.execute(txn)? {
</a>             ResultSet::Query { mut rows, .. } =&gt; {
<a href="#h17-1-8" id="h17-1-8" class="d">-                let table = ctx.txn.must_read_table(&amp;self.table)?;
</a><a href="#h17-1-9" id="h17-1-9" class="i">+                let table = txn.must_read_table(&amp;self.table)?;
</a> 
                 // The iterator will see our changes, such that the same item may be iterated over
                 // multiple times. We keep track of the primary keys here to avoid that, althought
<a href="#h17-2" id="h17-2" class="h">@@ -49,7 +49,7 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
</a>                     for (field, expr) in &amp;self.expressions {
                         table.set_row_field(&amp;mut new, field, expr.evaluate(Some(&amp;row))?)?;
                     }
<a href="#h17-2-3" id="h17-2-3" class="d">-                    ctx.txn.update(&amp;table.name, &amp;id, new)?;
</a><a href="#h17-2-4" id="h17-2-4" class="i">+                    txn.update(&amp;table.name, &amp;id, new)?;
</a>                     updated.insert(id);
                 }
                 Ok(ResultSet::Update { count: updated.len() as u64 })
<b>diff --git a/<a id="h18" href="../file/src/sql/plan/mod.rs.html">src/sql/plan/mod.rs</a> b/<a href="../file/src/sql/plan/mod.rs.html">src/sql/plan/mod.rs</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -4,7 +4,7 @@ use optimizer::Optimizer as _;
</a> use planner::Planner;
 
 use super::engine::Transaction;
<a href="#h18-0-3" id="h18-0-3" class="d">-use super::execution::{Context, Executor, ResultSet};
</a><a href="#h18-0-4" id="h18-0-4" class="i">+use super::execution::{Executor, ResultSet};
</a> use super::parser::ast;
 use super::schema::{Catalog, Table};
 use super::types::{Expression, Expressions, Value};
<a href="#h18-1" id="h18-1" class="h">@@ -19,13 +19,14 @@ pub struct Plan(pub Node);
</a> 
 impl Plan {
     /// Builds a plan from an AST statement
<a href="#h18-1-3" id="h18-1-3" class="i">+    /// FIXME Catalog should be generic, not trait object
</a>     pub fn build(statement: ast::Statement, catalog: &amp;mut dyn Catalog) -&gt; Result&lt;Self&gt; {
         Planner::new(catalog).build(statement)
     }
 
     /// Executes the plan, consuming it
<a href="#h18-1-9" id="h18-1-9" class="d">-    pub fn execute&lt;T: Transaction + &#39;static&gt;(self, mut ctx: Context&lt;T&gt;) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h18-1-10" id="h18-1-10" class="d">-        Executor::build(self.0).execute(&amp;mut ctx)
</a><a href="#h18-1-11" id="h18-1-11" class="i">+    pub fn execute&lt;T: Transaction + &#39;static&gt;(self, txn: &amp;mut T) -&gt; Result&lt;ResultSet&gt; {
</a><a href="#h18-1-12" id="h18-1-12" class="i">+        Executor::build(self.0).execute(txn)
</a>     }
 
     /// Optimizes the plan, consuming it
<b>diff --git a/<a id="h19" href="../file/tests/sql/query.rs.html">tests/sql/query.rs</a> b/<a href="../file/tests/sql/query.rs.html">tests/sql/query.rs</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -2,7 +2,7 @@
</a> ///! and compares the results with golden files stored under tests/sql/query/
 use toydb::error::{Error, Result};
 use toydb::sql::engine::{Engine, Mode, Transaction};
<a href="#h19-0-3" id="h19-0-3" class="d">-use toydb::sql::execution::{Context, ResultSet};
</a><a href="#h19-0-4" id="h19-0-4" class="i">+use toydb::sql::execution::ResultSet;
</a> use toydb::sql::parser::Parser;
 use toydb::sql::plan::Plan;
 use toydb::sql::types::Row;
<a href="#h19-1" id="h19-1" class="h">@@ -111,8 +111,7 @@ macro_rules! test_query {
</a>             write!(f, &quot;Query: {}\n\n&quot;, $query)?;
 
             write!(f, &quot;Result:&quot;)?;
<a href="#h19-1-3" id="h19-1-3" class="d">-            let ctx = Context{txn: &amp;mut txn};
</a><a href="#h19-1-4" id="h19-1-4" class="d">-            let result = match plan.execute(ctx) {
</a><a href="#h19-1-5" id="h19-1-5" class="i">+            let result = match plan.execute(&amp;mut txn) {
</a>                 Ok(result) =&gt; result,
                 Err(err) =&gt; {
                     write!(f, &quot; {:?}&quot;, err)?;
</pre>
</div>
</body>
</html>
