<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>server: improve API and add shutdown - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c42426b15ec02dede77e1b63e29612f13a4ef615.html">c42426b15ec02dede77e1b63e29612f13a4ef615</a>
<b>parent</b> <a href="../commit/84a88dd5684c11cb7bc8f3283fa33d33d79f5b88.html">84a88dd5684c11cb7bc8f3283fa33d33d79f5b88</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Fri, 10 Apr 2020 15:00:31 +0200

server: improve API and add shutdown

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toydb.rs</a></td><td> | </td><td class="num">13</td><td><span class="i">+++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/mod.rs</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/server/mod.rs</a></td><td> | </td><td class="num">39</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
</table></pre><pre>3 files changed, 43 insertions(+), 22 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a> b/<a href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -31,21 +31,15 @@ fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a>     }
     simplelog::SimpleLogger::init(loglevel, logconfig.build())?;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-    toydb::Server {
</a><a href="#h0-0-4" id="h0-0-4" class="d">-        id: cfg.id.clone(),
</a><a href="#h0-0-5" id="h0-0-5" class="d">-        peers: cfg.parse_peers()?,
</a><a href="#h0-0-6" id="h0-0-6" class="d">-        addr: cfg.listen,
</a><a href="#h0-0-7" id="h0-0-7" class="d">-        threads: cfg.threads,
</a><a href="#h0-0-8" id="h0-0-8" class="d">-        data_dir: cfg.data_dir,
</a><a href="#h0-0-9" id="h0-0-9" class="d">-    }
</a><a href="#h0-0-10" id="h0-0-10" class="d">-    .listen()
</a><a href="#h0-0-11" id="h0-0-11" class="i">+    let mut server = toydb::Server::new(&amp;cfg.id, cfg.parse_peers()?, &amp;cfg.data_dir)?;
</a><a href="#h0-0-12" id="h0-0-12" class="i">+    server.listen(&amp;cfg.listen, 8)?;
</a><a href="#h0-0-13" id="h0-0-13" class="i">+    server.join()
</a> }
 
 #[derive(Debug, Deserialize)]
 struct Config {
     id: String,
     listen: String,
<a href="#h0-0-20" id="h0-0-20" class="d">-    threads: usize,
</a>     log_level: String,
     data_dir: String,
     peers: HashMap&lt;String, String&gt;,
<a href="#h0-1" id="h0-1" class="h">@@ -56,7 +50,6 @@ impl Config {
</a>         let mut c = config::Config::new();
         c.set_default(&quot;id&quot;, &quot;toydb&quot;)?;
         c.set_default(&quot;listen&quot;, &quot;0.0.0.0:9605&quot;)?;
<a href="#h0-1-3" id="h0-1-3" class="d">-        c.set_default(&quot;threads&quot;, 4)?;
</a>         c.set_default(&quot;log_level&quot;, &quot;info&quot;)?;
         c.set_default(&quot;data_dir&quot;, &quot;/var/lib/toydb&quot;)?;
 
<b>diff --git a/<a id="h1" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -30,6 +30,7 @@ pub trait State {
</a> pub struct Raft {
     call_tx: Sender&lt;(Event, Sender&lt;Event&gt;)&gt;,
     join_rx: Receiver&lt;Result&lt;(), Error&gt;&gt;,
<a href="#h1-0-3" id="h1-0-3" class="i">+    shutdown_tx: Sender&lt;()&gt;,
</a> }
 
 impl Raft {
<a href="#h1-1" id="h1-1" class="h">@@ -51,6 +52,7 @@ impl Raft {
</a>         let (outbound_tx, outbound_rx) = crossbeam_channel::unbounded();
         let (call_tx, call_rx) = crossbeam_channel::unbounded::&lt;(Event, Sender&lt;Event&gt;)&gt;();
         let (join_tx, join_rx) = crossbeam_channel::unbounded();
<a href="#h1-1-3" id="h1-1-3" class="i">+        let (shutdown_tx, shutdown_rx) = crossbeam_channel::unbounded();
</a>         let mut response_txs: HashMap&lt;Vec&lt;u8&gt;, Sender&lt;Event&gt;&gt; = HashMap::new();
         let mut node = Node::new(id, peers, store, state, outbound_tx)?;
 
<a href="#h1-2" id="h1-2" class="h">@@ -62,6 +64,9 @@ impl Raft {
</a>                     // Handle ticks
                     recv(ticker) -&gt; _ =&gt; node = node.tick()?,
 
<a href="#h1-2-3" id="h1-2-3" class="i">+                    // Handle shutdown
</a><a href="#h1-2-4" id="h1-2-4" class="i">+                    recv(shutdown_rx) -&gt; _ =&gt; return Ok(()),
</a><a href="#h1-2-5" id="h1-2-5" class="i">+
</a>                     // Handle local method calls
                     recv(call_rx) -&gt; recv =&gt; {
                         let (event, response_tx) = recv?;
<a href="#h1-3" id="h1-3" class="h">@@ -95,7 +100,7 @@ impl Raft {
</a>             join_tx.send(result).unwrap()
         });
 
<a href="#h1-3-3" id="h1-3-3" class="d">-        Ok(Raft { call_tx, join_rx })
</a><a href="#h1-3-4" id="h1-3-4" class="i">+        Ok(Raft { call_tx, join_rx, shutdown_tx })
</a>     }
 
     /// Waits for the Raft node to complete
<a href="#h1-4" id="h1-4" class="h">@@ -103,6 +108,12 @@ impl Raft {
</a>         self.join_rx.recv()?
     }
 
<a href="#h1-4-3" id="h1-4-3" class="i">+    /// Shuts down the server.
</a><a href="#h1-4-4" id="h1-4-4" class="i">+    pub fn shutdown(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-4-5" id="h1-4-5" class="i">+        self.shutdown_tx.send(())?;
</a><a href="#h1-4-6" id="h1-4-6" class="i">+        self.join()
</a><a href="#h1-4-7" id="h1-4-7" class="i">+    }
</a><a href="#h1-4-8" id="h1-4-8" class="i">+
</a>     /// Runs a synchronous client call on the Raft cluster
     fn call(&amp;self, event: Event) -&gt; Result&lt;Event, Error&gt; {
         let (response_tx, response_rx) = crossbeam_channel::unbounded();
<b>diff --git a/<a id="h2" href="../file/src/server/mod.rs.html">src/server/mod.rs</a> b/<a href="../file/src/server/mod.rs.html">src/server/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -11,19 +11,27 @@ use crate::sql;
</a> use std::collections::HashMap;
 
 pub struct Server {
<a href="#h2-0-3" id="h2-0-3" class="d">-    pub id: String,
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    pub addr: String,
</a><a href="#h2-0-5" id="h2-0-5" class="d">-    pub threads: usize,
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    pub peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h2-0-7" id="h2-0-7" class="d">-    pub data_dir: String,
</a><a href="#h2-0-8" id="h2-0-8" class="i">+    id: String,
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h2-0-10" id="h2-0-10" class="i">+    data_dir: String,
</a><a href="#h2-0-11" id="h2-0-11" class="i">+    grpc: Option&lt;grpc::Server&gt;,
</a><a href="#h2-0-12" id="h2-0-12" class="i">+    raft: Option&lt;Raft&gt;,
</a> }
 
 impl Server {
<a href="#h2-0-16" id="h2-0-16" class="d">-    pub fn listen(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-0-17" id="h2-0-17" class="d">-        info!(&quot;Starting ToyDB node with ID {} on {}&quot;, self.id, self.addr);
</a><a href="#h2-0-18" id="h2-0-18" class="i">+    pub fn new(
</a><a href="#h2-0-19" id="h2-0-19" class="i">+        id: &amp;str,
</a><a href="#h2-0-20" id="h2-0-20" class="i">+        peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h2-0-21" id="h2-0-21" class="i">+        data_dir: &amp;str,
</a><a href="#h2-0-22" id="h2-0-22" class="i">+    ) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h2-0-23" id="h2-0-23" class="i">+        Ok(Server { id: id.into(), peers, data_dir: data_dir.into(), grpc: None, raft: None })
</a><a href="#h2-0-24" id="h2-0-24" class="i">+    }
</a><a href="#h2-0-25" id="h2-0-25" class="i">+
</a><a href="#h2-0-26" id="h2-0-26" class="i">+    pub fn listen(&amp;mut self, addr: &amp;str, threads: usize) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-0-27" id="h2-0-27" class="i">+        info!(&quot;Starting ToyDB node with ID {} on {}&quot;, self.id, addr);
</a>         let mut server = grpc::ServerBuilder::new_plain();
<a href="#h2-0-29" id="h2-0-29" class="d">-        server.http.set_addr(&amp;self.addr)?;
</a><a href="#h2-0-30" id="h2-0-30" class="d">-        server.http.set_cpu_pool_threads(self.threads);
</a><a href="#h2-0-31" id="h2-0-31" class="i">+        server.http.set_addr(addr)?;
</a><a href="#h2-0-32" id="h2-0-32" class="i">+        server.http.set_cpu_pool_threads(threads);
</a>         let data_path = std::path::Path::new(&amp;self.data_dir);
         std::fs::create_dir_all(data_path)?;
 
<a href="#h2-1" id="h2-1" class="h">@@ -54,8 +62,17 @@ impl Server {
</a>             raft: raft.clone(),
             engine: sql::engine::Raft::new(raft.clone()),
         }));
<a href="#h2-1-3" id="h2-1-3" class="d">-        let _s = server.build()?;
</a> 
<a href="#h2-1-5" id="h2-1-5" class="d">-        raft.join()
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        self.grpc = Some(server.build()?);
</a><a href="#h2-1-7" id="h2-1-7" class="i">+        self.raft = Some(raft);
</a><a href="#h2-1-8" id="h2-1-8" class="i">+        Ok(())
</a><a href="#h2-1-9" id="h2-1-9" class="i">+    }
</a><a href="#h2-1-10" id="h2-1-10" class="i">+
</a><a href="#h2-1-11" id="h2-1-11" class="i">+    pub fn join(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-1-12" id="h2-1-12" class="i">+        self.raft.map(|r| r.join()).unwrap_or(Ok(()))
</a><a href="#h2-1-13" id="h2-1-13" class="i">+    }
</a><a href="#h2-1-14" id="h2-1-14" class="i">+
</a><a href="#h2-1-15" id="h2-1-15" class="i">+    pub fn shutdown(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-1-16" id="h2-1-16" class="i">+        self.raft.map(|r| r.shutdown()).unwrap_or(Ok(()))
</a>     }
 }
</pre>
</div>
</body>
</html>
