<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tests: add basic client/server query tests (fixes #11) - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c014281d1574ec81518037261592f1f598e376bc.html">c014281d1574ec81518037261592f1f598e376bc</a>
<b>parent</b> <a href="../commit/1bb3d22fc1563a106a33e818ed40dc0d2a471871.html">1bb3d22fc1563a106a33e818ed40dc0d2a471871</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 11 Apr 2020 15:16:33 +0200

tests: add basic client/server query tests (fixes #11)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/execution/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">tests/client_server.rs</a></td><td> | </td><td class="num">117</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------</span></td></tr>
</table></pre><pre>2 files changed, 108 insertions(+), 11 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a> b/<a href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -79,7 +79,7 @@ pub struct Context&lt;&#39;a, T: Transaction&gt; {
</a> }
 
 /// An executor result set
<a href="#h0-0-3" id="h0-0-3" class="d">-#[derive(Debug, Serialize, Deserialize)]
</a><a href="#h0-0-4" id="h0-0-4" class="i">+#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a> pub enum ResultSet {
     // Transaction started
     Begin { id: u64, mode: Mode },
<b>diff --git a/<a id="h1" href="../file/tests/client_server.rs.html">tests/client_server.rs</a> b/<a href="../file/tests/client_server.rs.html">tests/client_server.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -5,8 +5,9 @@ extern crate tempdir;
</a> extern crate toydb;
 
 use toydb::server::Status;
<a href="#h1-0-3" id="h1-0-3" class="d">-use toydb::sql::schema::{Column, Table};
</a><a href="#h1-0-4" id="h1-0-4" class="d">-use toydb::sql::types::{DataType, Value};
</a><a href="#h1-0-5" id="h1-0-5" class="i">+use toydb::sql::execution::ResultSet;
</a><a href="#h1-0-6" id="h1-0-6" class="i">+use toydb::sql::schema;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+use toydb::sql::types::{Column, DataType, Relation, Row, Value};
</a> use toydb::Error;
 
 use pretty_assertions::assert_eq;
<a href="#h1-1" id="h1-1" class="h">@@ -98,10 +99,10 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>     assert_eq!(c.get_table(&quot;unknown&quot;), Err(Error::Value(&quot;Table unknown does not exist&quot;.into())));
     assert_eq!(
         c.get_table(&quot;movies&quot;)?,
<a href="#h1-1-3" id="h1-1-3" class="d">-        Table {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        schema::Table {
</a>             name: &quot;movies&quot;.into(),
             columns: vec![
<a href="#h1-1-7" id="h1-1-7" class="d">-                Column {
</a><a href="#h1-1-8" id="h1-1-8" class="i">+                schema::Column {
</a>                     name: &quot;id&quot;.into(),
                     datatype: DataType::Integer,
                     primary_key: true,
<a href="#h1-2" id="h1-2" class="h">@@ -110,7 +111,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: true,
                     references: None,
                 },
<a href="#h1-2-3" id="h1-2-3" class="d">-                Column {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+                schema::Column {
</a>                     name: &quot;title&quot;.into(),
                     datatype: DataType::String,
                     primary_key: false,
<a href="#h1-3" id="h1-3" class="h">@@ -119,7 +120,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: false,
                     references: None,
                 },
<a href="#h1-3-3" id="h1-3-3" class="d">-                Column {
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                schema::Column {
</a>                     name: &quot;studio_id&quot;.into(),
                     datatype: DataType::Integer,
                     primary_key: false,
<a href="#h1-4" id="h1-4" class="h">@@ -128,7 +129,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: false,
                     references: Some(&quot;studios&quot;.into()),
                 },
<a href="#h1-4-3" id="h1-4-3" class="d">-                Column {
</a><a href="#h1-4-4" id="h1-4-4" class="i">+                schema::Column {
</a>                     name: &quot;genre_id&quot;.into(),
                     datatype: DataType::Integer,
                     primary_key: false,
<a href="#h1-5" id="h1-5" class="h">@@ -137,7 +138,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: false,
                     references: Some(&quot;genres&quot;.into()),
                 },
<a href="#h1-5-3" id="h1-5-3" class="d">-                Column {
</a><a href="#h1-5-4" id="h1-5-4" class="i">+                schema::Column {
</a>                     name: &quot;released&quot;.into(),
                     datatype: DataType::Integer,
                     primary_key: false,
<a href="#h1-6" id="h1-6" class="h">@@ -146,7 +147,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: false,
                     references: None,
                 },
<a href="#h1-6-3" id="h1-6-3" class="d">-                Column {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+                schema::Column {
</a>                     name: &quot;rating&quot;.into(),
                     datatype: DataType::Float,
                     primary_key: false,
<a href="#h1-7" id="h1-7" class="h">@@ -155,7 +156,7 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>                     unique: false,
                     references: None,
                 },
<a href="#h1-7-3" id="h1-7-3" class="d">-                Column {
</a><a href="#h1-7-4" id="h1-7-4" class="i">+                schema::Column {
</a>                     name: &quot;ultrahd&quot;.into(),
                     datatype: DataType::Boolean,
                     primary_key: false,
<a href="#h1-8" id="h1-8" class="h">@@ -192,3 +193,99 @@ fn status() -&gt; Result&lt;(), Error&gt; {
</a>     );
     Ok(())
 }
<a href="#h1-8-3" id="h1-8-3" class="i">+
</a><a href="#h1-8-4" id="h1-8-4" class="i">+#[test]
</a><a href="#h1-8-5" id="h1-8-5" class="i">+#[serial]
</a><a href="#h1-8-6" id="h1-8-6" class="i">+fn query() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-8-7" id="h1-8-7" class="i">+    // The SQL engine is thoroughly tested in a separate suite, this just exercises the
</a><a href="#h1-8-8" id="h1-8-8" class="i">+    // basic client/server integration.
</a><a href="#h1-8-9" id="h1-8-9" class="i">+    let (mut c, teardown) = setup_movies()?;
</a><a href="#h1-8-10" id="h1-8-10" class="i">+    defer!(teardown());
</a><a href="#h1-8-11" id="h1-8-11" class="i">+
</a><a href="#h1-8-12" id="h1-8-12" class="i">+    // SELECT
</a><a href="#h1-8-13" id="h1-8-13" class="i">+    let result = c.query(&quot;SELECT * FROM genres&quot;)?;
</a><a href="#h1-8-14" id="h1-8-14" class="i">+    assert_eq!(
</a><a href="#h1-8-15" id="h1-8-15" class="i">+        result,
</a><a href="#h1-8-16" id="h1-8-16" class="i">+        ResultSet::Query {
</a><a href="#h1-8-17" id="h1-8-17" class="i">+            relation: Relation {
</a><a href="#h1-8-18" id="h1-8-18" class="i">+                columns: vec![
</a><a href="#h1-8-19" id="h1-8-19" class="i">+                    Column { relation: Some(&quot;genres&quot;.into()), name: Some(&quot;id&quot;.into()) },
</a><a href="#h1-8-20" id="h1-8-20" class="i">+                    Column { relation: Some(&quot;genres&quot;.into()), name: Some(&quot;name&quot;.into()) }
</a><a href="#h1-8-21" id="h1-8-21" class="i">+                ],
</a><a href="#h1-8-22" id="h1-8-22" class="i">+                rows: None
</a><a href="#h1-8-23" id="h1-8-23" class="i">+            }
</a><a href="#h1-8-24" id="h1-8-24" class="i">+        }
</a><a href="#h1-8-25" id="h1-8-25" class="i">+    );
</a><a href="#h1-8-26" id="h1-8-26" class="i">+    if let ResultSet::Query { relation: Relation { rows: Some(rows), .. } } = result {
</a><a href="#h1-8-27" id="h1-8-27" class="i">+        assert_eq!(
</a><a href="#h1-8-28" id="h1-8-28" class="i">+            rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?,
</a><a href="#h1-8-29" id="h1-8-29" class="i">+            vec![
</a><a href="#h1-8-30" id="h1-8-30" class="i">+                vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h1-8-31" id="h1-8-31" class="i">+                vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h1-8-32" id="h1-8-32" class="i">+                vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())]
</a><a href="#h1-8-33" id="h1-8-33" class="i">+            ]
</a><a href="#h1-8-34" id="h1-8-34" class="i">+        )
</a><a href="#h1-8-35" id="h1-8-35" class="i">+    } else {
</a><a href="#h1-8-36" id="h1-8-36" class="i">+        panic!(&quot;result returned no rows&quot;)
</a><a href="#h1-8-37" id="h1-8-37" class="i">+    }
</a><a href="#h1-8-38" id="h1-8-38" class="i">+
</a><a href="#h1-8-39" id="h1-8-39" class="i">+    let result = c.query(&quot;SELECT * FROM genres WHERE FALSE&quot;)?;
</a><a href="#h1-8-40" id="h1-8-40" class="i">+    assert_eq!(
</a><a href="#h1-8-41" id="h1-8-41" class="i">+        result,
</a><a href="#h1-8-42" id="h1-8-42" class="i">+        ResultSet::Query {
</a><a href="#h1-8-43" id="h1-8-43" class="i">+            relation: Relation {
</a><a href="#h1-8-44" id="h1-8-44" class="i">+                columns: vec![
</a><a href="#h1-8-45" id="h1-8-45" class="i">+                    Column { relation: Some(&quot;genres&quot;.into()), name: Some(&quot;id&quot;.into()) },
</a><a href="#h1-8-46" id="h1-8-46" class="i">+                    Column { relation: Some(&quot;genres&quot;.into()), name: Some(&quot;name&quot;.into()) }
</a><a href="#h1-8-47" id="h1-8-47" class="i">+                ],
</a><a href="#h1-8-48" id="h1-8-48" class="i">+                rows: None
</a><a href="#h1-8-49" id="h1-8-49" class="i">+            }
</a><a href="#h1-8-50" id="h1-8-50" class="i">+        }
</a><a href="#h1-8-51" id="h1-8-51" class="i">+    );
</a><a href="#h1-8-52" id="h1-8-52" class="i">+    if let ResultSet::Query { relation: Relation { rows: Some(rows), .. } } = result {
</a><a href="#h1-8-53" id="h1-8-53" class="i">+        assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?, Vec::&lt;Row&gt;::new())
</a><a href="#h1-8-54" id="h1-8-54" class="i">+    } else {
</a><a href="#h1-8-55" id="h1-8-55" class="i">+        panic!(&quot;result returned no rows&quot;)
</a><a href="#h1-8-56" id="h1-8-56" class="i">+    }
</a><a href="#h1-8-57" id="h1-8-57" class="i">+
</a><a href="#h1-8-58" id="h1-8-58" class="i">+    assert_eq!(c.query(&quot;SELECT * FROM x&quot;), Err(Error::Value(&quot;Table x does not exist&quot;.into())));
</a><a href="#h1-8-59" id="h1-8-59" class="i">+
</a><a href="#h1-8-60" id="h1-8-60" class="i">+    // INSERT
</a><a href="#h1-8-61" id="h1-8-61" class="i">+    assert_eq!(
</a><a href="#h1-8-62" id="h1-8-62" class="i">+        c.query(&quot;INSERT INTO genres VALUES (1, &#39;Western&#39;)&quot;),
</a><a href="#h1-8-63" id="h1-8-63" class="i">+        Err(Error::Value(&quot;Primary key 1 already exists for table genres&quot;.into())),
</a><a href="#h1-8-64" id="h1-8-64" class="i">+    );
</a><a href="#h1-8-65" id="h1-8-65" class="i">+    assert_eq!(
</a><a href="#h1-8-66" id="h1-8-66" class="i">+        c.query(&quot;INSERT INTO genres VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h1-8-67" id="h1-8-67" class="i">+        Ok(ResultSet::Create { count: 1 }),
</a><a href="#h1-8-68" id="h1-8-68" class="i">+    );
</a><a href="#h1-8-69" id="h1-8-69" class="i">+    assert_eq!(
</a><a href="#h1-8-70" id="h1-8-70" class="i">+        c.query(&quot;INSERT INTO x VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h1-8-71" id="h1-8-71" class="i">+        Err(Error::Value(&quot;Table x does not exist&quot;.into()))
</a><a href="#h1-8-72" id="h1-8-72" class="i">+    );
</a><a href="#h1-8-73" id="h1-8-73" class="i">+
</a><a href="#h1-8-74" id="h1-8-74" class="i">+    // UPDATE
</a><a href="#h1-8-75" id="h1-8-75" class="i">+    assert_eq!(
</a><a href="#h1-8-76" id="h1-8-76" class="i">+        c.query(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE FALSE&quot;),
</a><a href="#h1-8-77" id="h1-8-77" class="i">+        Ok(ResultSet::Update { count: 0 }),
</a><a href="#h1-8-78" id="h1-8-78" class="i">+    );
</a><a href="#h1-8-79" id="h1-8-79" class="i">+    assert_eq!(
</a><a href="#h1-8-80" id="h1-8-80" class="i">+        c.query(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE id = 9&quot;),
</a><a href="#h1-8-81" id="h1-8-81" class="i">+        Ok(ResultSet::Update { count: 1 }),
</a><a href="#h1-8-82" id="h1-8-82" class="i">+    );
</a><a href="#h1-8-83" id="h1-8-83" class="i">+    assert_eq!(
</a><a href="#h1-8-84" id="h1-8-84" class="i">+        c.query(&quot;UPDATE genres SET id = 1 WHERE id = 9&quot;),
</a><a href="#h1-8-85" id="h1-8-85" class="i">+        Err(Error::Value(&quot;Primary key 1 already exists for table genres&quot;.into()))
</a><a href="#h1-8-86" id="h1-8-86" class="i">+    );
</a><a href="#h1-8-87" id="h1-8-87" class="i">+
</a><a href="#h1-8-88" id="h1-8-88" class="i">+    // DELETE
</a><a href="#h1-8-89" id="h1-8-89" class="i">+    assert_eq!(c.query(&quot;DELETE FROM genres WHERE FALSE&quot;), Ok(ResultSet::Delete { count: 0 }),);
</a><a href="#h1-8-90" id="h1-8-90" class="i">+    // FIXME https://github.com/erikgrinaker/toydb/issues/16
</a><a href="#h1-8-91" id="h1-8-91" class="i">+    //assert_eq!(c.query(&quot;DELETE FROM genres WHERE id = 9&quot;), Ok(ResultSet::Delete { count: 1 }),);
</a><a href="#h1-8-92" id="h1-8-92" class="i">+    assert_eq!(
</a><a href="#h1-8-93" id="h1-8-93" class="i">+        c.query(&quot;DELETE FROM genres WHERE x = 1&quot;),
</a><a href="#h1-8-94" id="h1-8-94" class="i">+        Err(Error::Value(&quot;Unknown field x&quot;.into()))
</a><a href="#h1-8-95" id="h1-8-95" class="i">+    );
</a><a href="#h1-8-96" id="h1-8-96" class="i">+
</a><a href="#h1-8-97" id="h1-8-97" class="i">+    Ok(())
</a><a href="#h1-8-98" id="h1-8-98" class="i">+}
</a></pre>
</div>
</body>
</html>
