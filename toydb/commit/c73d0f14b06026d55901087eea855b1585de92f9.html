<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: add `fsync` option to disable fsync for performance - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/c73d0f14b06026d55901087eea855b1585de92f9.html">c73d0f14b06026d55901087eea855b1585de92f9</a>
<b>parent</b> <a href="../commit/e47aef64c79449bef18e40bac1743a085b09e0b6.html">e47aef64c79449bef18e40bac1743a085b09e0b6</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 23 Jul 2024 14:53:35 +0200

raft: add `fsync` option to disable fsync for performance

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">config/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/bin/toydb.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/log.rs</a></td><td> | </td><td class="num">27</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/storage/bitcask.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
</table></pre><pre>4 files changed, 40 insertions(+), 5 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/config/toydb.yaml.html">config/toydb.yaml</a> b/<a href="../file/config/toydb.yaml.html">config/toydb.yaml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -21,6 +21,12 @@ data_dir: data
</a> storage_raft: bitcask
 storage_sql: bitcask
 
<a href="#h0-0-3" id="h0-0-3" class="i">+# Whether to fsync writes to disk. Disabling this yields much better write
</a><a href="#h0-0-4" id="h0-0-4" class="i">+# performance, but may lose data on host crashes and violate Raft guarantees. It
</a><a href="#h0-0-5" id="h0-0-5" class="i">+# only affects Raft log writes (the SQL state machine is never fsynced since it
</a><a href="#h0-0-6" id="h0-0-6" class="i">+# can be reconstructed from the Raft log).
</a><a href="#h0-0-7" id="h0-0-7" class="i">+fsync: true
</a><a href="#h0-0-8" id="h0-0-8" class="i">+
</a> # The minimum garbage fraction and bytes to trigger Bitcask log compaction on
 # node startup.
 compact_threshold: 0.2
<b>diff --git a/<a id="h1" href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a> b/<a href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -46,6 +46,10 @@ struct Config {
</a>     storage_raft: String,
     /// The SQL storage engine: bitcask or memory.
     storage_sql: String,
<a href="#h1-0-3" id="h1-0-3" class="i">+    /// If false, don&#39;t fsync Raft log writes to disk. Disabling this
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    /// will yield much better write performance, but may lose data on
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    /// host crashes which compromises Raft safety guarantees.
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    fsync: bool,
</a>     /// The garbage fraction threshold at which to trigger compaction.
     compact_threshold: f64,
     /// The minimum bytes of garbage before triggering compaction.
<a href="#h1-1" id="h1-1" class="h">@@ -63,6 +67,7 @@ impl Config {
</a>             .set_default(&quot;data_dir&quot;, &quot;data&quot;)?
             .set_default(&quot;storage_raft&quot;, &quot;bitcask&quot;)?
             .set_default(&quot;storage_sql&quot;, &quot;bitcask&quot;)?
<a href="#h1-1-3" id="h1-1-3" class="i">+            .set_default(&quot;fsync&quot;, true)?
</a>             .set_default(&quot;compact_threshold&quot;, 0.2)?
             .set_default(&quot;compact_min_bytes&quot;, 1_000_000)?
             .add_source(config::File::with_name(file))
<a href="#h1-2" id="h1-2" class="h">@@ -97,7 +102,7 @@ impl Command {
</a> 
         // Initialize the Raft log storage engine.
         let datadir = std::path::Path::new(&amp;cfg.data_dir);
<a href="#h1-2-3" id="h1-2-3" class="d">-        let raft_log = match cfg.storage_raft.as_str() {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+        let mut raft_log = match cfg.storage_raft.as_str() {
</a>             &quot;bitcask&quot; | &quot;&quot; =&gt; {
                 let engine = storage::BitCask::new_compact(
                     datadir.join(&quot;raft&quot;),
<a href="#h1-3" id="h1-3" class="h">@@ -109,6 +114,7 @@ impl Command {
</a>             &quot;memory&quot; =&gt; raft::Log::new(Box::new(storage::Memory::new()))?,
             name =&gt; return errinput!(&quot;invalid Raft storage engine {name}&quot;),
         };
<a href="#h1-3-3" id="h1-3-3" class="i">+        raft_log.enable_fsync(cfg.fsync);
</a> 
         // Initialize the SQL storage engine.
         let raft_state: Box&lt;dyn raft::State&gt; = match cfg.storage_sql.as_str() {
<b>diff --git a/<a id="h2" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -101,6 +101,13 @@ pub struct Log {
</a>     commit_index: Index,
     /// The term of the last committed entry.
     commit_term: Term,
<a href="#h2-0-3" id="h2-0-3" class="i">+    /// If true, fsync entries to disk when appended. This is mandated by Raft,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    /// but comes with a hefty performance penalty (especially since we don&#39;t
</a><a href="#h2-0-5" id="h2-0-5" class="i">+    /// optimize for it by batching entries before fsyncing). Disabling it will
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    /// yield much better write performance, but may lose data on host crashes,
</a><a href="#h2-0-7" id="h2-0-7" class="i">+    /// which in some scenarios can cause log entries to become &quot;uncommitted&quot;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+    /// and state machines diverging.
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    fsync: bool,
</a> }
 
 impl Log {
<a href="#h2-1" id="h2-1" class="h">@@ -125,7 +132,14 @@ impl Log {
</a>             .map(|v| bincode::deserialize(&amp;v))
             .transpose()?
             .unwrap_or((0, 0));
<a href="#h2-1-3" id="h2-1-3" class="d">-        Ok(Self { engine, term, vote, last_index, last_term, commit_index, commit_term })
</a><a href="#h2-1-4" id="h2-1-4" class="i">+        let fsync = true; // fsync by default (NB: BitCask::flush() is a noop in tests)
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        Ok(Self { engine, term, vote, last_index, last_term, commit_index, commit_term, fsync })
</a><a href="#h2-1-6" id="h2-1-6" class="i">+    }
</a><a href="#h2-1-7" id="h2-1-7" class="i">+
</a><a href="#h2-1-8" id="h2-1-8" class="i">+    /// Controls whether to fsync writes. Disabling this may violate Raft
</a><a href="#h2-1-9" id="h2-1-9" class="i">+    /// guarantees, see comment on fsync attribute.
</a><a href="#h2-1-10" id="h2-1-10" class="i">+    pub fn enable_fsync(&amp;mut self, fsync: bool) {
</a><a href="#h2-1-11" id="h2-1-11" class="i">+        self.fsync = fsync
</a>     }
 
     /// Returns the commit index and term.
<a href="#h2-2" id="h2-2" class="h">@@ -154,6 +168,9 @@ impl Log {
</a>             return Ok(());
         }
         self.engine.set(&amp;Key::TermVote.encode(), bincode::serialize(&amp;(term, vote)))?;
<a href="#h2-2-3" id="h2-2-3" class="i">+        // Always fsync, even with Log.fsync = false. Term changes are rare, so
</a><a href="#h2-2-4" id="h2-2-4" class="i">+        // this doesn&#39;t materially affect performance, and double voting could
</a><a href="#h2-2-5" id="h2-2-5" class="i">+        // lead to multiple leaders and split brain which is really bad.
</a>         self.engine.flush()?;
         self.term = term;
         self.vote = vote;
<a href="#h2-3" id="h2-3" class="h">@@ -169,7 +186,9 @@ impl Log {
</a>         // in the key, but we keep it simple.
         let entry = Entry { index: self.last_index + 1, term: self.term, command };
         self.engine.set(&amp;Key::Entry(entry.index).encode(), entry.encode())?;
<a href="#h2-3-3" id="h2-3-3" class="d">-        self.engine.flush()?;
</a><a href="#h2-3-4" id="h2-3-4" class="i">+        if self.fsync {
</a><a href="#h2-3-5" id="h2-3-5" class="i">+            self.engine.flush()?;
</a><a href="#h2-3-6" id="h2-3-6" class="i">+        }
</a>         self.last_index = entry.index;
         self.last_term = entry.term;
         Ok(entry.index)
<a href="#h2-4" id="h2-4" class="h">@@ -306,7 +325,9 @@ impl Log {
</a>         for index in last.index + 1..=self.last_index {
             self.engine.delete(&amp;Key::Entry(index).encode())?;
         }
<a href="#h2-4-3" id="h2-4-3" class="d">-        self.engine.flush()?;
</a><a href="#h2-4-4" id="h2-4-4" class="i">+        if self.fsync {
</a><a href="#h2-4-5" id="h2-4-5" class="i">+            self.engine.flush()?;
</a><a href="#h2-4-6" id="h2-4-6" class="i">+        }
</a> 
         self.last_index = last.index;
         self.last_term = last.term;
<b>diff --git a/<a id="h3" href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a> b/<a href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -117,7 +117,9 @@ impl Engine for BitCask {
</a>     }
 
     fn flush(&amp;mut self) -&gt; Result&lt;()&gt; {
<a href="#h3-0-3" id="h3-0-3" class="d">-        // Don&#39;t fsync in tests, to speed them up.
</a><a href="#h3-0-4" id="h3-0-4" class="i">+        // Don&#39;t fsync in tests, to speed them up. We disable this here, instead
</a><a href="#h3-0-5" id="h3-0-5" class="i">+        // of setting raft::Log::fsync = false in tests, because we want to
</a><a href="#h3-0-6" id="h3-0-6" class="i">+        // assert that the Raft log flushes to disk even if the flush is a noop.
</a>         #[cfg(not(test))]
         self.log.file.sync_all()?;
         Ok(())
</pre>
</div>
</body>
</html>
