<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: rename `Node::Projection::labels` to `aliases` and fix formatting - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/3294a905b4eeacf59a5deb5edd7bc26b9b604bbb.html">3294a905b4eeacf59a5deb5edd7bc26b9b604bbb</a>
<b>parent</b> <a href="../commit/948dfe6aae71b53337f62e3f1c100e9189ef142d.html">948dfe6aae71b53337f62e3f1c100e9189ef142d</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 16 Jul 2024 14:23:58 +0200

sql: rename `Node::Projection::labels` to `aliases` and fix formatting

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/execution/execute.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/planner/planner.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/testscripts/optimizer/short_circuit</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/testscripts/queries/join_inner</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/testscripts/queries/order</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/sql/testscripts/queries/select</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>7 files changed, 26 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a> b/<a href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -116,7 +116,7 @@ pub fn execute(node: Node, txn: &amp;impl Transaction) -&gt; Result&lt;Rows&gt; {
</a>             transform::order(source, orders)
         }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        Node::Projection { source, expressions, labels: _ } =&gt; {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        Node::Projection { source, expressions, aliases: _ } =&gt; {
</a>             let source = execute(*source, txn)?;
             Ok(transform::project(source, expressions))
         }
<b>diff --git a/<a id="h1" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -118,9 +118,9 @@ pub enum Node {
</a>     /// Sorts the source rows by the given expression/direction pairs. Buffers
     /// the entire row set in memory.
     Order { source: Box&lt;Node&gt;, orders: Vec&lt;(Expression, Direction)&gt; },
<a href="#h1-0-3" id="h1-0-3" class="d">-    /// Projects the input rows by evaluating the given expressions.
</a><a href="#h1-0-4" id="h1-0-4" class="d">-    /// The labels are only used when displaying the plan.
</a><a href="#h1-0-5" id="h1-0-5" class="d">-    Projection { source: Box&lt;Node&gt;, expressions: Vec&lt;Expression&gt;, labels: Vec&lt;Label&gt; },
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    /// Projects the input rows by evaluating the given expressions. Aliases are
</a><a href="#h1-0-7" id="h1-0-7" class="i">+    /// only used when displaying the plan.
</a><a href="#h1-0-8" id="h1-0-8" class="i">+    Projection { source: Box&lt;Node&gt;, expressions: Vec&lt;Expression&gt;, aliases: Vec&lt;Label&gt; },
</a>     /// Remaps source columns to the given target column index, or None to drop
     /// the column. Unspecified target columns yield Value::Null.
     Remap { source: Box&lt;Node&gt;, targets: Vec&lt;Option&lt;usize&gt;&gt; },
<a href="#h1-1" id="h1-1" class="h">@@ -179,8 +179,8 @@ impl Node {
</a>             },
             Self::Offset { source, offset } =&gt; Self::Offset { source: transform(source)?, offset },
             Self::Order { source, orders } =&gt; Self::Order { source: transform(source)?, orders },
<a href="#h1-1-3" id="h1-1-3" class="d">-            Self::Projection { source, labels, expressions } =&gt; {
</a><a href="#h1-1-4" id="h1-1-4" class="d">-                Self::Projection { source: transform(source)?, labels, expressions }
</a><a href="#h1-1-5" id="h1-1-5" class="i">+            Self::Projection { source, expressions, aliases } =&gt; {
</a><a href="#h1-1-6" id="h1-1-6" class="i">+                Self::Projection { source: transform(source)?, expressions, aliases }
</a>             }
             Self::Remap { source, targets } =&gt; Self::Remap { source: transform(source)?, targets },
 
<a href="#h1-2" id="h1-2" class="h">@@ -220,13 +220,13 @@ impl Node {
</a>                     outer,
                 }
             }
<a href="#h1-2-3" id="h1-2-3" class="d">-            Self::Projection { source, labels, expressions } =&gt; Self::Projection {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+            Self::Projection { source, expressions, aliases } =&gt; Self::Projection {
</a>                 source,
<a href="#h1-2-6" id="h1-2-6" class="d">-                labels,
</a>                 expressions: expressions
                     .into_iter()
                     .map(|e| e.transform(before, after))
                     .collect::&lt;Result&lt;_&gt;&gt;()?,
<a href="#h1-2-11" id="h1-2-11" class="i">+                aliases,
</a>             },
             Self::Scan { table, alias, filter: Some(filter) } =&gt; {
                 Self::Scan { table, alias, filter: Some(filter.transform(before, after)?) }
<a href="#h1-3" id="h1-3" class="h">@@ -422,8 +422,16 @@ impl Node {
</a>                 write!(f, &quot;Order: {orders}&quot;)?;
                 source.format(f, prefix, false, true)?;
             }
<a href="#h1-3-3" id="h1-3-3" class="d">-            Self::Projection { source, expressions, .. } =&gt; {
</a><a href="#h1-3-4" id="h1-3-4" class="d">-                write!(f, &quot;Projection: {}&quot;, expressions.iter().join(&quot;, &quot;))?;
</a><a href="#h1-3-5" id="h1-3-5" class="i">+            Self::Projection { source, expressions, aliases } =&gt; {
</a><a href="#h1-3-6" id="h1-3-6" class="i">+                let expressions = expressions
</a><a href="#h1-3-7" id="h1-3-7" class="i">+                    .iter()
</a><a href="#h1-3-8" id="h1-3-8" class="i">+                    .enumerate()
</a><a href="#h1-3-9" id="h1-3-9" class="i">+                    .map(|(i, expr)| match aliases.get(i) {
</a><a href="#h1-3-10" id="h1-3-10" class="i">+                        Some(Label::None) | None =&gt; format!(&quot;{expr}&quot;),
</a><a href="#h1-3-11" id="h1-3-11" class="i">+                        Some(alias) =&gt; format!(&quot;{expr} as {alias}&quot;),
</a><a href="#h1-3-12" id="h1-3-12" class="i">+                    })
</a><a href="#h1-3-13" id="h1-3-13" class="i">+                    .join(&quot;, &quot;);
</a><a href="#h1-3-14" id="h1-3-14" class="i">+                write!(f, &quot;Projection: {expressions}&quot;)?;
</a>                 source.format(f, prefix, false, true)?;
             }
             Self::Remap { source, targets } =&gt; {
<b>diff --git a/<a id="h2" href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a> b/<a href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -209,7 +209,7 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>             expressions.extend(hidden);
 
             scope = child_scope;
<a href="#h2-0-3" id="h2-0-3" class="d">-            node = Node::Projection { source: Box::new(node), expressions, labels };
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            node = Node::Projection { source: Box::new(node), expressions, aliases: labels };
</a>         };
 
         // Build HAVING clause.
<b>diff --git a/<a id="h3" href="../file/src/sql/testscripts/optimizer/short_circuit.html">src/sql/testscripts/optimizer/short_circuit</a> b/<a href="../file/src/sql/testscripts/optimizer/short_circuit.html">src/sql/testscripts/optimizer/short_circuit</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -180,7 +180,7 @@ Short circuit:
</a> [opt,header]&gt; SELECT id AS foo, value AS bar FROM test
 ---
 Initial:
<a href="#h3-0-3" id="h3-0-3" class="d">-   Projection: id, value
</a><a href="#h3-0-4" id="h3-0-4" class="i">+   Projection: id as foo, value as bar
</a>    └─ Scan: test
 Short circuit:
    Scan: test
<b>diff --git a/<a id="h4" href="../file/src/sql/testscripts/queries/join_inner.html">src/sql/testscripts/queries/join_inner</a> b/<a href="../file/src/sql/testscripts/queries/join_inner.html">src/sql/testscripts/queries/join_inner</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -223,7 +223,7 @@ Error: invalid input: unknown field movies.unknown_id
</a> ---
 Remap: #0, #1, #2, #3, #4 (dropped: #5)
 └─ Order: m.rating desc, m.released asc, m.id asc
<a href="#h4-0-3" id="h4-0-3" class="d">-   └─ Projection: m.id, m.title, g.name, s.name, m.rating, m.released
</a><a href="#h4-0-4" id="h4-0-4" class="i">+   └─ Projection: m.id, m.title, g.name as genre, s.name as studio, m.rating, m.released
</a>       └─ HashJoin: inner on m.studio_id = s.id
          ├─ HashJoin: inner on m.genre_id = g.id
          │  ├─ Scan: movies as m
<b>diff --git a/<a id="h5" href="../file/src/sql/testscripts/queries/order.html">src/sql/testscripts/queries/order</a> b/<a href="../file/src/sql/testscripts/queries/order.html">src/sql/testscripts/queries/order</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -29,14 +29,14 @@ ok
</a> [plan]&gt; SELECT 1 AS value ORDER BY value ASC
 ---
 Order: value asc
<a href="#h5-0-3" id="h5-0-3" class="d">-└─ Projection: 1
</a><a href="#h5-0-4" id="h5-0-4" class="i">+└─ Projection: 1 as value
</a>    └─ Values: blank row
 1
 
 [plan]&gt; SELECT 1 AS value ORDER BY value DESC
 ---
 Order: value desc
<a href="#h5-0-11" id="h5-0-11" class="d">-└─ Projection: 1
</a><a href="#h5-0-12" id="h5-0-12" class="i">+└─ Projection: 1 as value
</a>    └─ Values: blank row
 1
 
<a href="#h5-1" id="h5-1" class="h">@@ -358,7 +358,7 @@ Error: invalid input: ambiguous field foo
</a> [plan]&gt; SELECT id AS &quot;int&quot; FROM test ORDER BY &quot;int&quot; DESC
 ---
 Order: int desc
<a href="#h5-1-3" id="h5-1-3" class="d">-└─ Projection: id
</a><a href="#h5-1-4" id="h5-1-4" class="i">+└─ Projection: id as int
</a>    └─ Scan: test
 9
 8
<a href="#h5-2" id="h5-2" class="h">@@ -375,7 +375,7 @@ Order: int desc
</a> ---
 Remap: #0 (dropped: #1)
 └─ Order: test.int desc
<a href="#h5-2-3" id="h5-2-3" class="d">-   └─ Projection: id, test.int
</a><a href="#h5-2-4" id="h5-2-4" class="i">+   └─ Projection: id as int, test.int
</a>       └─ Scan: test
 4
 6
<b>diff --git a/<a id="h6" href="../file/src/sql/testscripts/queries/select.html">src/sql/testscripts/queries/select</a> b/<a href="../file/src/sql/testscripts/queries/select.html">src/sql/testscripts/queries/select</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -119,7 +119,7 @@ Error: invalid input: unknown table test
</a> # The AS keyword is optional.
 [header,plan]&gt; SELECT 1 AS one, test.&quot;int&quot; value FROM test
 ---
<a href="#h6-0-3" id="h6-0-3" class="d">-Projection: 1, test.int
</a><a href="#h6-0-4" id="h6-0-4" class="i">+Projection: 1 as one, test.int as value
</a> └─ Scan: test
 one, value
 1, 7
</pre>
</div>
</body>
</html>
