<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: redesign append protocol - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/f592416872d75930b2ad7e2d1bdd8620172bc744.html">f592416872d75930b2ad7e2d1bdd8620172bc744</a>
<b>parent</b> <a href="../commit/bcf719abf653e49574230048a496e447494bef11.html">bcf719abf653e49574230048a496e447494bef11</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Mon,  3 Jun 2024 18:20:48 +0200

raft: redesign append protocol

This patch redesigns the append protocol to improve probing and retries, and
reduce duplicates.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">54</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/mod.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node.rs</a></td><td> | </td><td class="num">278</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/testscripts/node/append</a></td><td> | </td><td class="num">73</td><td><span class="i">++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/testscripts/node/append_base_missing</a></td><td> | </td><td class="num">74</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/raft/testscripts/node/append_base_missing_all</a></td><td> | </td><td class="num">80</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/testscripts/node/append_commit_quorum</a></td><td> | </td><td class="num">79</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">src/raft/testscripts/node/append_conflict_divergent</a></td><td> | </td><td class="num">238</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">src/raft/testscripts/node/append_conflict_replace_term</a></td><td> | </td><td class="num">103</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/raft/testscripts/node/append_initial</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">-------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/raft/testscripts/node/append_max_entries</a></td><td> | </td><td class="num">66</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h11">src/raft/testscripts/node/append_overlap</a></td><td> | </td><td class="num">60</td><td><span class="i"></span><span class="d">------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/raft/testscripts/node/append_pipeline</a></td><td> | </td><td class="num">82</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">src/raft/testscripts/node/append_probe_divergent_first</a></td><td> | </td><td class="num">224</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">src/raft/testscripts/node/append_probe_divergent_long</a></td><td> | </td><td class="num">251</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">src/raft/testscripts/node/append_probe_divergent_short</a></td><td> | </td><td class="num">190</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">src/raft/testscripts/node/append_probe_divergent_single</a></td><td> | </td><td class="num">120</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/raft/testscripts/node/append_response_beyond_last_index_panics</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="D">D</td><td><a href="#h18">src/raft/testscripts/node/append_response_beyond_last_term_panics</a></td><td> | </td><td class="num">21</td><td><span class="i"></span><span class="d">---------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/raft/testscripts/node/append_response_stale_reject</a></td><td> | </td><td class="num">61</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">src/raft/testscripts/node/election</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">src/raft/testscripts/node/election_candidate_behind_leader</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/raft/testscripts/node/election_candidate_behind_quorum</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/raft/testscripts/node/election_contested</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/raft/testscripts/node/election_tie</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/raft/testscripts/node/election_tie_even</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/raft/testscripts/node/heartbeat_commits_follower</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/raft/testscripts/node/heartbeat_converts_candidate</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">src/raft/testscripts/node/heartbeat_converts_follower</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">src/raft/testscripts/node/heartbeat_converts_leader</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">src/raft/testscripts/node/heartbeat_lost_append_multiple</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">src/raft/testscripts/node/heartbeat_lost_append_single</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">src/raft/testscripts/node/heartbeat_match_commits</a></td><td> | </td><td class="num">70</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/raft/testscripts/node/heartbeat_old_commit_index</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">src/raft/testscripts/node/heartbeat_old_last_index</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">src/raft/testscripts/node/heartbeat_probe_divergent</a></td><td> | </td><td class="num">186</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">src/raft/testscripts/node/old_campaign_rejected</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">src/raft/testscripts/node/old_campaign_response_ignored</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h41">src/raft/testscripts/node/old_heartbeat_ignored</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">src/raft/testscripts/node/request_follower</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h43">src/raft/testscripts/node/request_follower_disconnect_stall</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">src/raft/testscripts/node/request_leader</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h45">src/raft/testscripts/node/request_leader_campaign_abort</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h46">src/raft/testscripts/node/request_leader_change_linearizability</a></td><td> | </td><td class="num">26</td><td><span class="i">+++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h47">src/raft/testscripts/node/request_leader_disconnect</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h48">src/raft/testscripts/node/request_leader_read_quorum</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h49">src/raft/testscripts/node/request_leader_read_quorum_sequence</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h50">src/raft/testscripts/node/request_status</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h51">src/raft/testscripts/node/tick_follower</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h52">src/raft/testscripts/node/tick_leader</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h53">src/server.rs</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
</table></pre><pre>54 files changed, 2164 insertions(+), 858 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -28,18 +28,21 @@ pub enum Message {
</a>     /// serves several purposes:
     ///
     /// * Inform nodes about the leader, and prevent elections.
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// * Probe follower log progress.
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    /// * Probe follower log progress, and trigger append/ack retries.
</a>     /// * Advance followers&#39; commit indexes, so they can apply entries.
     /// * Confirm leadership for client reads, to avoid stale reads.
     ///
     /// While some of this could be split out to other messages, the heartbeat
<a href="#h0-0-9" id="h0-0-9" class="d">-    /// periodicity also implicitly provides retries, so it is convenient to
</a><a href="#h0-0-10" id="h0-0-10" class="i">+    /// periodicity implicitly provides retries, so it is convenient to
</a>     /// piggyback on it.
     ///
     /// The Raft paper does not have a distinct heartbeat message, and instead
     /// uses an empty AppendEntries RPC, but we choose to add one for better
     /// separation of concerns.
     Heartbeat {
<a href="#h0-0-17" id="h0-0-17" class="i">+        /// The index of the leader&#39;s last log entry. The term is the leader&#39;s
</a><a href="#h0-0-18" id="h0-0-18" class="i">+        /// current term, since it appends a noop entry on election win.
</a><a href="#h0-0-19" id="h0-0-19" class="i">+        last_index: Index,
</a>         /// The index of the leader&#39;s last committed log entry.
         commit_index: Index,
         /// The term of the leader&#39;s last committed log entry.
<a href="#h0-1" id="h0-1" class="h">@@ -57,10 +60,10 @@ pub enum Message {
</a> 
     /// Followers respond to leader heartbeats if they still consider it leader.
     HeartbeatResponse {
<a href="#h0-1-3" id="h0-1-3" class="d">-        /// The index of the follower&#39;s last log entry.
</a><a href="#h0-1-4" id="h0-1-4" class="d">-        last_index: Index,
</a><a href="#h0-1-5" id="h0-1-5" class="d">-        /// The term of the follower&#39;s last log entry.
</a><a href="#h0-1-6" id="h0-1-6" class="d">-        last_term: Term,
</a><a href="#h0-1-7" id="h0-1-7" class="i">+        /// If non-zero, the heartbeat&#39;s last_index which was matched in the
</a><a href="#h0-1-8" id="h0-1-8" class="i">+        /// follower&#39;s log. Otherwise, the follower is either divergent or
</a><a href="#h0-1-9" id="h0-1-9" class="i">+        /// lagging behind the leader.
</a><a href="#h0-1-10" id="h0-1-10" class="i">+        match_index: Index,
</a>         /// The heartbeat&#39;s read sequence number.
         read_seq: ReadSequence,
     },
<a href="#h0-2" id="h0-2" class="h">@@ -81,36 +84,39 @@ pub enum Message {
</a>     },
 
     /// Leaders replicate log entries to followers by appending to their logs
<a href="#h0-2-3" id="h0-2-3" class="d">-    /// after the given base entry. If the base entry matches the follower&#39;s log
</a><a href="#h0-2-4" id="h0-2-4" class="d">-    /// then their logs are identical up to it (see section 5.3 in the Raft
</a><a href="#h0-2-5" id="h0-2-5" class="d">-    /// paper), and the entries can be appended. Otherwise, the append is
</a><a href="#h0-2-6" id="h0-2-6" class="d">-    /// rejected and the leader must retry an earlier base index until a common
</a><a href="#h0-2-7" id="h0-2-7" class="d">-    /// base is found.
</a><a href="#h0-2-8" id="h0-2-8" class="i">+    /// after the given base entry.
</a><a href="#h0-2-9" id="h0-2-9" class="i">+    ///
</a><a href="#h0-2-10" id="h0-2-10" class="i">+    /// If the base entry matches the follower&#39;s log then their logs are
</a><a href="#h0-2-11" id="h0-2-11" class="i">+    /// identical up to it (see section 5.3 in the Raft paper), and the entries
</a><a href="#h0-2-12" id="h0-2-12" class="i">+    /// can be appended -- possibly replacing conflicting entries. Otherwise,
</a><a href="#h0-2-13" id="h0-2-13" class="i">+    /// the append is rejected and the leader must retry an earlier base index
</a><a href="#h0-2-14" id="h0-2-14" class="i">+    /// until a common base is found.
</a><a href="#h0-2-15" id="h0-2-15" class="i">+    ///
</a><a href="#h0-2-16" id="h0-2-16" class="i">+    /// Empty appends messages (no entries) are used to probe follower logs for
</a><a href="#h0-2-17" id="h0-2-17" class="i">+    /// a common match index in the case of divergent logs, restarted nodes, or
</a><a href="#h0-2-18" id="h0-2-18" class="i">+    /// dropped messages. This is typically done by sending probes with a
</a><a href="#h0-2-19" id="h0-2-19" class="i">+    /// decrementing base index until a match is found, at which point the
</a><a href="#h0-2-20" id="h0-2-20" class="i">+    /// subsequent entries can be sent.
</a>     Append {
         /// The index of the log entry to append after.
         base_index: Index,
         /// The term of the log entry to append after.
         base_term: Term,
<a href="#h0-2-26" id="h0-2-26" class="d">-        /// Log entries to append.
</a><a href="#h0-2-27" id="h0-2-27" class="i">+        /// Log entries to append. Must start at base_index + 1.
</a>         entries: Vec&lt;Entry&gt;,
     },
 
     /// Followers accept or reject appends from the leader depending on whether
<a href="#h0-2-32" id="h0-2-32" class="d">-    /// the base entry matches in both logs.
</a><a href="#h0-2-33" id="h0-2-33" class="i">+    /// the base entry matches their log.
</a>     AppendResponse {
<a href="#h0-2-35" id="h0-2-35" class="i">+        /// If non-zero, the follower accepted entries to this index. The entire
</a><a href="#h0-2-36" id="h0-2-36" class="i">+        /// log up to this index is consistent with the leader.
</a><a href="#h0-2-37" id="h0-2-37" class="i">+        match_index: Index,
</a>         /// If non-zero, the follower rejected an append at this base index
<a href="#h0-2-39" id="h0-2-39" class="d">-        /// because the base index/term did not match its log.
</a><a href="#h0-2-40" id="h0-2-40" class="i">+        /// because the base index/term did not match its log. This may be
</a><a href="#h0-2-41" id="h0-2-41" class="i">+        /// lowered by the follower if its log is shorter than the base index,
</a><a href="#h0-2-42" id="h0-2-42" class="i">+        /// to avoid trying each missing entry.
</a>         reject_index: Index,
<a href="#h0-2-44" id="h0-2-44" class="d">-        /// The index of the follower&#39;s last log entry.
</a><a href="#h0-2-45" id="h0-2-45" class="d">-        ///
</a><a href="#h0-2-46" id="h0-2-46" class="d">-        /// NB: if the entries already existed in the follower&#39;s log, the append
</a><a href="#h0-2-47" id="h0-2-47" class="d">-        /// is a noop and the last_index may be greater than the latest entry in
</a><a href="#h0-2-48" id="h0-2-48" class="d">-        /// the append. That&#39;s fine -- if we&#39;re still the leader then our logs
</a><a href="#h0-2-49" id="h0-2-49" class="d">-        /// must be consistent, otherwise the follower will have stopped
</a><a href="#h0-2-50" id="h0-2-50" class="d">-        /// accepting our appends anyway.
</a><a href="#h0-2-51" id="h0-2-51" class="d">-        last_index: Index,
</a><a href="#h0-2-52" id="h0-2-52" class="d">-        /// The term of the follower&#39;s last log entry.
</a><a href="#h0-2-53" id="h0-2-53" class="d">-        last_term: Term,
</a>     },
 
     /// A client request. This can be submitted to the leader, or to a follower
<b>diff --git a/<a id="h1" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -18,3 +18,6 @@ pub const HEARTBEAT_INTERVAL: Ticks = 3;
</a> /// The default election timeout range, in ticks. This is randomized in this
 /// interval, to avoid election ties.
 pub const ELECTION_TIMEOUT_RANGE: std::ops::Range&lt;Ticks&gt; = 10..20;
<a href="#h1-0-3" id="h1-0-3" class="i">+
</a><a href="#h1-0-4" id="h1-0-4" class="i">+/// The maximum number of entries to send in a single append message.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+pub const MAX_APPEND_ENTRIES: usize = 100;
</a><b>diff --git a/<a id="h2" href="../file/src/raft/node.rs.html">src/raft/node.rs</a> b/<a href="../file/src/raft/node.rs.html">src/raft/node.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -34,14 +34,17 @@ pub enum Node {
</a> impl Node {
     /// Creates a new Raft node, starting as a leaderless follower, or leader if
     /// there are no peers.
<a href="#h2-0-3" id="h2-0-3" class="i">+    #[allow(clippy::too_many_arguments)]
</a>     pub fn new(
         id: NodeID,
         peers: HashSet&lt;NodeID&gt;,
         log: Log,
         state: Box&lt;dyn State&gt;,
         node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
<a href="#h2-0-10" id="h2-0-10" class="i">+        // TODO: these don&#39;t need to be passed in, mutate the fields instead.
</a>         heartbeat_interval: Ticks,
         election_timeout_range: std::ops::Range&lt;Ticks&gt;,
<a href="#h2-0-13" id="h2-0-13" class="i">+        max_append_entries: usize,
</a>     ) -&gt; Result&lt;Self&gt; {
         let node = RawNode::new(
             id,
<a href="#h2-1" id="h2-1" class="h">@@ -51,6 +54,7 @@ impl Node {
</a>             node_tx,
             heartbeat_interval,
             election_timeout_range,
<a href="#h2-1-3" id="h2-1-3" class="i">+            max_append_entries,
</a>         )?;
         if node.peers.is_empty() {
             // If there are no peers, become leader immediately.
<a href="#h2-2" id="h2-2" class="h">@@ -131,6 +135,7 @@ pub struct RawNode&lt;R: Role = Follower&gt; {
</a>     node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
     heartbeat_interval: Ticks,
     election_timeout_range: std::ops::Range&lt;Ticks&gt;,
<a href="#h2-2-3" id="h2-2-3" class="i">+    max_append_entries: usize,
</a>     role: R,
 }
 
<a href="#h2-3" id="h2-3" class="h">@@ -146,6 +151,7 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>             node_tx: self.node_tx,
             heartbeat_interval: self.heartbeat_interval,
             election_timeout_range: self.election_timeout_range,
<a href="#h2-3-3" id="h2-3-3" class="i">+            max_append_entries: self.max_append_entries,
</a>             role,
         }
     }
<a href="#h2-4" id="h2-4" class="h">@@ -426,6 +432,7 @@ impl Role for Follower {}
</a> 
 impl RawNode&lt;Follower&gt; {
     /// Creates a new node as a leaderless follower.
<a href="#h2-4-3" id="h2-4-3" class="i">+    #[allow(clippy::too_many_arguments)]
</a>     fn new(
         id: NodeID,
         peers: HashSet&lt;NodeID&gt;,
<a href="#h2-5" id="h2-5" class="h">@@ -434,6 +441,7 @@ impl RawNode&lt;Follower&gt; {
</a>         node_tx: crossbeam::channel::Sender&lt;Envelope&gt;,
         heartbeat_interval: Ticks,
         election_timeout_range: std::ops::Range&lt;Ticks&gt;,
<a href="#h2-5-3" id="h2-5-3" class="i">+        max_append_entries: usize,
</a>     ) -&gt; Result&lt;Self&gt; {
         let (term, vote) = log.get_term()?;
         let role = Follower::new(None, vote, 0);
<a href="#h2-6" id="h2-6" class="h">@@ -446,6 +454,7 @@ impl RawNode&lt;Follower&gt; {
</a>             node_tx,
             heartbeat_interval,
             election_timeout_range,
<a href="#h2-6-3" id="h2-6-3" class="i">+            max_append_entries,
</a>             role,
         };
         node.role.election_timeout = node.gen_election_timeout();
<a href="#h2-7" id="h2-7" class="h">@@ -543,19 +552,17 @@ impl RawNode&lt;Follower&gt; {
</a>             // The leader will send periodic heartbeats. If we don&#39;t have a
             // leader in this term yet, follow it. If the commit_index advances,
             // apply state transitions.
<a href="#h2-7-3" id="h2-7-3" class="d">-            Message::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
</a><a href="#h2-7-4" id="h2-7-4" class="i">+            Message::Heartbeat { last_index, commit_index, commit_term, read_seq } =&gt; {
</a>                 // Check that the heartbeat is from our leader.
                 match self.role.leader {
                     Some(leader) =&gt; assert_eq!(msg.from, leader, &quot;multiple leaders in term&quot;),
                     None =&gt; self = self.into_follower(Some(msg.from), msg.term)?,
                 }
 
<a href="#h2-7-11" id="h2-7-11" class="d">-                // Respond to the heartbeat.
</a><a href="#h2-7-12" id="h2-7-12" class="d">-                let (last_index, last_term) = self.log.get_last_index();
</a><a href="#h2-7-13" id="h2-7-13" class="d">-                self.send(
</a><a href="#h2-7-14" id="h2-7-14" class="d">-                    msg.from,
</a><a href="#h2-7-15" id="h2-7-15" class="d">-                    Message::HeartbeatResponse { last_index, last_term, read_seq },
</a><a href="#h2-7-16" id="h2-7-16" class="d">-                )?;
</a><a href="#h2-7-17" id="h2-7-17" class="i">+                // Attempt to match the leader&#39;s log and respond to the
</a><a href="#h2-7-18" id="h2-7-18" class="i">+                // heartbeat. last_index always has the leader&#39;s term.
</a><a href="#h2-7-19" id="h2-7-19" class="i">+                let match_index = if self.log.has(last_index, msg.term)? { last_index } else { 0 };
</a><a href="#h2-7-20" id="h2-7-20" class="i">+                self.send(msg.from, Message::HeartbeatResponse { match_index, read_seq })?;
</a> 
                 // Advance commit index and apply entries.
                 if commit_index &gt; self.log.get_commit_index().0
<a href="#h2-8" id="h2-8" class="h">@@ -568,8 +575,9 @@ impl RawNode&lt;Follower&gt; {
</a> 
             // Append log entries from the leader to the local log.
             Message::Append { base_index, base_term, entries } =&gt; {
<a href="#h2-8-3" id="h2-8-3" class="d">-                let Some(first) = entries.first() else { panic!(&quot;empty append message&quot;) };
</a><a href="#h2-8-4" id="h2-8-4" class="d">-                assert_eq!(base_index, first.index - 1, &quot;base index mismatch&quot;);
</a><a href="#h2-8-5" id="h2-8-5" class="i">+                if let Some(first) = entries.first() {
</a><a href="#h2-8-6" id="h2-8-6" class="i">+                    assert_eq!(base_index, first.index - 1, &quot;base index mismatch&quot;);
</a><a href="#h2-8-7" id="h2-8-7" class="i">+                }
</a> 
                 // Make sure the message comes from our leader.
                 match self.role.leader {
<a href="#h2-9" id="h2-9" class="h">@@ -578,17 +586,17 @@ impl RawNode&lt;Follower&gt; {
</a>                 }
 
                 // If the base entry is in our log, append the entries.
<a href="#h2-9-3" id="h2-9-3" class="d">-                let mut reject_index = 0;
</a><a href="#h2-9-4" id="h2-9-4" class="i">+                let (mut reject_index, mut match_index) = (0, 0);
</a>                 if base_index == 0 || self.log.has(base_index, base_term)? {
<a href="#h2-9-6" id="h2-9-6" class="i">+                    match_index = entries.last().map(|e| e.index).unwrap_or(base_index);
</a>                     self.log.splice(entries)?;
                 } else {
<a href="#h2-9-9" id="h2-9-9" class="d">-                    reject_index = base_index;
</a><a href="#h2-9-10" id="h2-9-10" class="i">+                    // Otherwise, reject the base index. If the local log is
</a><a href="#h2-9-11" id="h2-9-11" class="i">+                    // shorter than the base index, lower the reject index to
</a><a href="#h2-9-12" id="h2-9-12" class="i">+                    // skip all the missing entries.
</a><a href="#h2-9-13" id="h2-9-13" class="i">+                    reject_index = std::cmp::min(base_index, self.log.get_last_index().0 + 1);
</a>                 }
<a href="#h2-9-15" id="h2-9-15" class="d">-                let (last_index, last_term) = self.log.get_last_index();
</a><a href="#h2-9-16" id="h2-9-16" class="d">-                self.send(
</a><a href="#h2-9-17" id="h2-9-17" class="d">-                    msg.from,
</a><a href="#h2-9-18" id="h2-9-18" class="d">-                    Message::AppendResponse { reject_index, last_index, last_term },
</a><a href="#h2-9-19" id="h2-9-19" class="d">-                )?;
</a><a href="#h2-9-20" id="h2-9-20" class="i">+                self.send(msg.from, Message::AppendResponse { reject_index, match_index })?;
</a>             }
 
             // A candidate in this term is requesting our vote.
<a href="#h2-10" id="h2-10" class="h">@@ -692,6 +700,39 @@ struct Progress {
</a>     read_seq: ReadSequence,
 }
 
<a href="#h2-10-3" id="h2-10-3" class="i">+impl Progress {
</a><a href="#h2-10-4" id="h2-10-4" class="i">+    /// Attempts to advance a follower&#39;s match index, returning true if it did.
</a><a href="#h2-10-5" id="h2-10-5" class="i">+    /// If next_index is below it, it is advanced to the following index, but
</a><a href="#h2-10-6" id="h2-10-6" class="i">+    /// is otherwise left as is to avoid regressing it unnecessarily.
</a><a href="#h2-10-7" id="h2-10-7" class="i">+    fn advance(&amp;mut self, match_index: Index) -&gt; bool {
</a><a href="#h2-10-8" id="h2-10-8" class="i">+        if match_index &lt;= self.match_index {
</a><a href="#h2-10-9" id="h2-10-9" class="i">+            return false;
</a><a href="#h2-10-10" id="h2-10-10" class="i">+        }
</a><a href="#h2-10-11" id="h2-10-11" class="i">+        self.match_index = match_index;
</a><a href="#h2-10-12" id="h2-10-12" class="i">+        self.next_index = std::cmp::max(self.next_index, match_index + 1);
</a><a href="#h2-10-13" id="h2-10-13" class="i">+        true
</a><a href="#h2-10-14" id="h2-10-14" class="i">+    }
</a><a href="#h2-10-15" id="h2-10-15" class="i">+
</a><a href="#h2-10-16" id="h2-10-16" class="i">+    /// Attempts to advance a follower&#39;s read_seq, returning true if it did.
</a><a href="#h2-10-17" id="h2-10-17" class="i">+    fn advance_read(&amp;mut self, read_seq: ReadSequence) -&gt; bool {
</a><a href="#h2-10-18" id="h2-10-18" class="i">+        if read_seq &lt;= self.read_seq {
</a><a href="#h2-10-19" id="h2-10-19" class="i">+            return false;
</a><a href="#h2-10-20" id="h2-10-20" class="i">+        }
</a><a href="#h2-10-21" id="h2-10-21" class="i">+        self.read_seq = read_seq;
</a><a href="#h2-10-22" id="h2-10-22" class="i">+        true
</a><a href="#h2-10-23" id="h2-10-23" class="i">+    }
</a><a href="#h2-10-24" id="h2-10-24" class="i">+
</a><a href="#h2-10-25" id="h2-10-25" class="i">+    /// Regresses the next index to the given index, if it&#39;s currently greater.
</a><a href="#h2-10-26" id="h2-10-26" class="i">+    /// Can&#39;t regress below match_index + 1. Returns true if next_index changes.
</a><a href="#h2-10-27" id="h2-10-27" class="i">+    fn regress_next(&amp;mut self, next_index: Index) -&gt; bool {
</a><a href="#h2-10-28" id="h2-10-28" class="i">+        if next_index &gt;= self.next_index || self.next_index &lt;= self.match_index + 1 {
</a><a href="#h2-10-29" id="h2-10-29" class="i">+            return false;
</a><a href="#h2-10-30" id="h2-10-30" class="i">+        }
</a><a href="#h2-10-31" id="h2-10-31" class="i">+        self.next_index = std::cmp::max(next_index, self.match_index + 1);
</a><a href="#h2-10-32" id="h2-10-32" class="i">+        true
</a><a href="#h2-10-33" id="h2-10-33" class="i">+    }
</a><a href="#h2-10-34" id="h2-10-34" class="i">+}
</a><a href="#h2-10-35" id="h2-10-35" class="i">+
</a> /// A pending client write request.
 #[derive(Clone, Debug, PartialEq)]
 struct Write {
<a href="#h2-11" id="h2-11" class="h">@@ -830,62 +871,84 @@ impl RawNode&lt;Leader&gt; {
</a>                 panic!(&quot;saw other leader {} in term {}&quot;, msg.from, msg.term);
             }
 
<a href="#h2-11-3" id="h2-11-3" class="d">-            // A follower received one of our heartbeats and confirms that we
</a><a href="#h2-11-4" id="h2-11-4" class="d">-            // are its leader. If its log is incomplete, append entries. If the
</a><a href="#h2-11-5" id="h2-11-5" class="d">-            // peer&#39;s read sequence number increased, process any pending reads.
</a><a href="#h2-11-6" id="h2-11-6" class="i">+            // A follower received our heartbeat and confirms our leadership.
</a>             //
             // TODO: this needs to commit and apply entries following a leader
             // change too, otherwise we can serve stale reads if the new leader
             // hadn&#39;t fully committed and applied entries yet.
<a href="#h2-11-11" id="h2-11-11" class="d">-            Message::HeartbeatResponse { last_index, last_term, read_seq } =&gt; {
</a><a href="#h2-11-12" id="h2-11-12" class="d">-                assert!(read_seq &lt;= self.role.read_seq, &quot;Future read sequence number&quot;);
</a><a href="#h2-11-13" id="h2-11-13" class="i">+            Message::HeartbeatResponse { match_index, read_seq } =&gt; {
</a><a href="#h2-11-14" id="h2-11-14" class="i">+                let (last_index, _) = self.log.get_last_index();
</a><a href="#h2-11-15" id="h2-11-15" class="i">+                assert!(match_index &lt;= last_index, &quot;future match index&quot;);
</a><a href="#h2-11-16" id="h2-11-16" class="i">+                assert!(read_seq &lt;= self.role.read_seq, &quot;future read sequence number&quot;);
</a> 
<a href="#h2-11-18" id="h2-11-18" class="d">-                let progress = self.role.progress.get_mut(&amp;msg.from).unwrap();
</a><a href="#h2-11-19" id="h2-11-19" class="d">-                if read_seq &gt; progress.read_seq {
</a><a href="#h2-11-20" id="h2-11-20" class="d">-                    progress.read_seq = read_seq;
</a><a href="#h2-11-21" id="h2-11-21" class="i">+                // If the read sequence number advances, try to execute reads.
</a><a href="#h2-11-22" id="h2-11-22" class="i">+                if self.progress(msg.from).advance_read(read_seq) {
</a>                     self.maybe_read()?;
                 }
 
<a href="#h2-11-26" id="h2-11-26" class="d">-                if last_index &lt; self.log.get_last_index().0
</a><a href="#h2-11-27" id="h2-11-27" class="d">-                    || (last_index &gt; 0 &amp;&amp; !self.log.has(last_index, last_term)?)
</a><a href="#h2-11-28" id="h2-11-28" class="d">-                {
</a><a href="#h2-11-29" id="h2-11-29" class="d">-                    self.send_log(msg.from)?;
</a><a href="#h2-11-30" id="h2-11-30" class="i">+                if match_index == 0 {
</a><a href="#h2-11-31" id="h2-11-31" class="i">+                    // If the follower didn&#39;t match our last index, an append to
</a><a href="#h2-11-32" id="h2-11-32" class="i">+                    // it must have failed (or it&#39;s catching up). Probe it to
</a><a href="#h2-11-33" id="h2-11-33" class="i">+                    // discover a matching entry and start replicating. Move
</a><a href="#h2-11-34" id="h2-11-34" class="i">+                    // next_index back to last_index since the follower just
</a><a href="#h2-11-35" id="h2-11-35" class="i">+                    // told us it doesn&#39;t have it.
</a><a href="#h2-11-36" id="h2-11-36" class="i">+                    self.progress(msg.from).regress_next(last_index);
</a><a href="#h2-11-37" id="h2-11-37" class="i">+                    self.maybe_send_append(msg.from, true)?;
</a><a href="#h2-11-38" id="h2-11-38" class="i">+                } else if self.progress(msg.from).advance(match_index) {
</a><a href="#h2-11-39" id="h2-11-39" class="i">+                    // If the follower&#39;s match index advanced, an append
</a><a href="#h2-11-40" id="h2-11-40" class="i">+                    // response got lost. Try to commit.
</a><a href="#h2-11-41" id="h2-11-41" class="i">+                    //
</a><a href="#h2-11-42" id="h2-11-42" class="i">+                    // We don&#39;t need to eagerly send any pending entries, since
</a><a href="#h2-11-43" id="h2-11-43" class="i">+                    // any proposals made after this heartbeat was sent should
</a><a href="#h2-11-44" id="h2-11-44" class="i">+                    // have been eagerly replicated in steady state. If not, the
</a><a href="#h2-11-45" id="h2-11-45" class="i">+                    // next heartbeat will trigger a probe above.
</a><a href="#h2-11-46" id="h2-11-46" class="i">+                    self.maybe_commit_and_apply()?;
</a>                 }
             }
 
             // A follower appended our log entries. Record its progress and
             // attempt to commit.
<a href="#h2-11-52" id="h2-11-52" class="d">-            Message::AppendResponse { reject_index: 0, last_index, last_term } =&gt; {
</a><a href="#h2-11-53" id="h2-11-53" class="d">-                let (li, lt) = self.log.get_last_index();
</a><a href="#h2-11-54" id="h2-11-54" class="d">-                assert!(last_index &lt;= li &amp;&amp; last_term &lt;= lt, &quot;follower appended future entries&quot;);
</a><a href="#h2-11-55" id="h2-11-55" class="d">-                debug_assert!(self.log.has(last_index, last_term)?, &quot;follower has unknown tail&quot;);
</a><a href="#h2-11-56" id="h2-11-56" class="d">-
</a><a href="#h2-11-57" id="h2-11-57" class="d">-                let progress = self.role.progress.get_mut(&amp;msg.from).expect(&quot;unknown node&quot;);
</a><a href="#h2-11-58" id="h2-11-58" class="d">-                if last_index &gt; progress.match_index {
</a><a href="#h2-11-59" id="h2-11-59" class="d">-                    progress.match_index = last_index;
</a><a href="#h2-11-60" id="h2-11-60" class="d">-                    progress.next_index = last_index + 1;
</a><a href="#h2-11-61" id="h2-11-61" class="i">+            Message::AppendResponse { match_index, reject_index: 0 } if match_index &gt; 0 =&gt; {
</a><a href="#h2-11-62" id="h2-11-62" class="i">+                let (last_index, _) = self.log.get_last_index();
</a><a href="#h2-11-63" id="h2-11-63" class="i">+                assert!(match_index &lt;= last_index, &quot;follower matched unknown index&quot;);
</a><a href="#h2-11-64" id="h2-11-64" class="i">+
</a><a href="#h2-11-65" id="h2-11-65" class="i">+                if self.progress(msg.from).advance(match_index) {
</a>                     self.maybe_commit_and_apply()?;
                 }
<a href="#h2-11-68" id="h2-11-68" class="i">+
</a><a href="#h2-11-69" id="h2-11-69" class="i">+                // Eagerly send any further pending entries. The peer may be
</a><a href="#h2-11-70" id="h2-11-70" class="i">+                // lagging behind the leader, and we&#39;re catching it up one
</a><a href="#h2-11-71" id="h2-11-71" class="i">+                // MAX_APPEND_ENTRIES batch at a time. Or we may have received a
</a><a href="#h2-11-72" id="h2-11-72" class="i">+                // probe response at the known match index, in which case
</a><a href="#h2-11-73" id="h2-11-73" class="i">+                // advance() above would have returned false.
</a><a href="#h2-11-74" id="h2-11-74" class="i">+                self.maybe_send_append(msg.from, false)?;
</a>             }
 
             // A follower rejected the log entries because the base entry in
<a href="#h2-11-78" id="h2-11-78" class="d">-            // reject_index did not match its log. Try the previous entry until
</a><a href="#h2-11-79" id="h2-11-79" class="d">-            // we find a common base.
</a><a href="#h2-11-80" id="h2-11-80" class="i">+            // reject_index did not match its log. Try a previous entry until we
</a><a href="#h2-11-81" id="h2-11-81" class="i">+            // find a common base.
</a>             //
             // This linear probing can be slow with long divergent logs, but we
             // keep it simple.
<a href="#h2-11-85" id="h2-11-85" class="d">-            Message::AppendResponse { reject_index, last_index, last_term: _ } =&gt; {
</a><a href="#h2-11-86" id="h2-11-86" class="d">-                let progress = self.role.progress.get_mut(&amp;msg.from).expect(&quot;unknown node&quot;);
</a><a href="#h2-11-87" id="h2-11-87" class="d">-
</a><a href="#h2-11-88" id="h2-11-88" class="d">-                // If the next index was rejected, try the previous one.
</a><a href="#h2-11-89" id="h2-11-89" class="d">-                // Otherwise, the rejection is stale and can be ignored. If the
</a><a href="#h2-11-90" id="h2-11-90" class="d">-                // follower&#39;s log is shorter, skip straight to its last index.
</a><a href="#h2-11-91" id="h2-11-91" class="d">-                if progress.next_index == reject_index + 1 {
</a><a href="#h2-11-92" id="h2-11-92" class="d">-                    progress.next_index = std::cmp::min(progress.next_index - 1, last_index + 1);
</a><a href="#h2-11-93" id="h2-11-93" class="d">-                    self.send_log(msg.from)?;
</a><a href="#h2-11-94" id="h2-11-94" class="i">+            Message::AppendResponse { reject_index, match_index: 0 } if reject_index &gt; 0 =&gt; {
</a><a href="#h2-11-95" id="h2-11-95" class="i">+                let (last_index, _) = self.log.get_last_index();
</a><a href="#h2-11-96" id="h2-11-96" class="i">+                assert!(reject_index &lt;= last_index, &quot;follower rejected unknown index&quot;);
</a><a href="#h2-11-97" id="h2-11-97" class="i">+
</a><a href="#h2-11-98" id="h2-11-98" class="i">+                // If the rejected base index is at or below the match index,
</a><a href="#h2-11-99" id="h2-11-99" class="i">+                // the rejection is stale and can be ignored.
</a><a href="#h2-11-100" id="h2-11-100" class="i">+                if reject_index &lt;= self.progress(msg.from).match_index {
</a><a href="#h2-11-101" id="h2-11-101" class="i">+                    return Ok(self.into());
</a><a href="#h2-11-102" id="h2-11-102" class="i">+                }
</a><a href="#h2-11-103" id="h2-11-103" class="i">+
</a><a href="#h2-11-104" id="h2-11-104" class="i">+                // Probe below the reject index, if we haven&#39;t already moved
</a><a href="#h2-11-105" id="h2-11-105" class="i">+                // next_index below it.
</a><a href="#h2-11-106" id="h2-11-106" class="i">+                if self.progress(msg.from).regress_next(reject_index) {
</a><a href="#h2-11-107" id="h2-11-107" class="i">+                    self.maybe_send_append(msg.from, true)?;
</a>                 }
             }
 
<a href="#h2-11-111" id="h2-11-111" class="i">+            Message::AppendResponse { .. } =&gt; panic!(&quot;invalid message {msg:?}&quot;),
</a><a href="#h2-11-112" id="h2-11-112" class="i">+
</a>             // A client submitted a read command. To ensure linearizability, we
             // must confirm that we are still the leader by sending a heartbeat
             // with the read&#39;s sequence number and wait for confirmation from a
<a href="#h2-12" id="h2-12" class="h">@@ -966,21 +1029,37 @@ impl RawNode&lt;Leader&gt; {
</a> 
     /// Broadcasts a heartbeat to all peers.
     fn heartbeat(&amp;mut self) -&gt; Result&lt;()&gt; {
<a href="#h2-12-3" id="h2-12-3" class="i">+        let (last_index, last_term) = self.log.get_last_index();
</a>         let (commit_index, commit_term) = self.log.get_commit_index();
         let read_seq = self.role.read_seq;
<a href="#h2-12-6" id="h2-12-6" class="d">-        self.broadcast(Message::Heartbeat { commit_index, commit_term, read_seq })?;
</a><a href="#h2-12-7" id="h2-12-7" class="i">+
</a><a href="#h2-12-8" id="h2-12-8" class="i">+        assert_eq!(last_term, self.term, &quot;leader has stale last_term&quot;);
</a><a href="#h2-12-9" id="h2-12-9" class="i">+
</a><a href="#h2-12-10" id="h2-12-10" class="i">+        let msg = Message::Heartbeat { last_index, commit_index, commit_term, read_seq };
</a><a href="#h2-12-11" id="h2-12-11" class="i">+        self.broadcast(msg)?;
</a>         // NB: We don&#39;t reset self.since_heartbeat here, because we want to send
         // periodic heartbeats regardless of any on-demand heartbeats.
         Ok(())
     }
 
<a href="#h2-12-17" id="h2-12-17" class="i">+    /// Returns a mutable borrow of a node&#39;s progress.
</a><a href="#h2-12-18" id="h2-12-18" class="i">+    fn progress(&amp;mut self, id: NodeID) -&gt; &amp;mut Progress {
</a><a href="#h2-12-19" id="h2-12-19" class="i">+        self.role.progress.get_mut(&amp;id).expect(&quot;unknown node&quot;)
</a><a href="#h2-12-20" id="h2-12-20" class="i">+    }
</a><a href="#h2-12-21" id="h2-12-21" class="i">+
</a>     /// Proposes a command for consensus by appending it to our log and
     /// replicating it to peers. If successful, it will eventually be committed
     /// and applied to the state machine.
     fn propose(&amp;mut self, command: Option&lt;Vec&lt;u8&gt;&gt;) -&gt; Result&lt;Index&gt; {
         let index = self.log.append(self.term, command)?;
         for peer in self.peers.iter().copied().sorted() {
<a href="#h2-12-28" id="h2-12-28" class="d">-            self.send_log(peer)?;
</a><a href="#h2-12-29" id="h2-12-29" class="i">+            // Eagerly send the entry to the peer, but only if it is in steady
</a><a href="#h2-12-30" id="h2-12-30" class="i">+            // state where we&#39;ve already sent the previous entries. Otherwise,
</a><a href="#h2-12-31" id="h2-12-31" class="i">+            // we&#39;re probing a lagging or divergent peer, and there&#39;s no point
</a><a href="#h2-12-32" id="h2-12-32" class="i">+            // sending this entry since it will likely be rejected.
</a><a href="#h2-12-33" id="h2-12-33" class="i">+            if index == self.progress(peer).next_index {
</a><a href="#h2-12-34" id="h2-12-34" class="i">+                self.maybe_send_append(peer, false)?;
</a><a href="#h2-12-35" id="h2-12-35" class="i">+            }
</a>         }
         Ok(index)
     }
<a href="#h2-13" id="h2-13" class="h">@@ -1070,21 +1149,59 @@ impl RawNode&lt;Leader&gt; {
</a>         Ok(())
     }
 
<a href="#h2-13-3" id="h2-13-3" class="d">-    /// Sends pending log entries to a peer.
</a><a href="#h2-13-4" id="h2-13-4" class="d">-    fn send_log(&amp;mut self, peer: NodeID) -&gt; Result&lt;()&gt; {
</a><a href="#h2-13-5" id="h2-13-5" class="d">-        let (base_index, base_term) = match self.role.progress.get(&amp;peer) {
</a><a href="#h2-13-6" id="h2-13-6" class="d">-            Some(Progress { next_index, .. }) if *next_index &gt; 1 =&gt; {
</a><a href="#h2-13-7" id="h2-13-7" class="d">-                match self.log.get(next_index - 1)? {
</a><a href="#h2-13-8" id="h2-13-8" class="d">-                    Some(entry) =&gt; (entry.index, entry.term),
</a><a href="#h2-13-9" id="h2-13-9" class="d">-                    None =&gt; panic!(&quot;missing base entry {}&quot;, next_index - 1),
</a><a href="#h2-13-10" id="h2-13-10" class="d">-                }
</a><a href="#h2-13-11" id="h2-13-11" class="d">-            }
</a><a href="#h2-13-12" id="h2-13-12" class="d">-            Some(_) =&gt; (0, 0),
</a><a href="#h2-13-13" id="h2-13-13" class="d">-            None =&gt; panic!(&quot;unknown peer {}&quot;, peer),
</a><a href="#h2-13-14" id="h2-13-14" class="i">+    // Sends pending log entries to a peer, according to its next_index. Does
</a><a href="#h2-13-15" id="h2-13-15" class="i">+    // not send an append if the peer is already caught up. Sends an empty
</a><a href="#h2-13-16" id="h2-13-16" class="i">+    // append with the last entry as a base if all pending entries are already
</a><a href="#h2-13-17" id="h2-13-17" class="i">+    // in flight, to probe whether they&#39;ve made it to the follower or not.
</a><a href="#h2-13-18" id="h2-13-18" class="i">+    fn maybe_send_append(&amp;mut self, peer: NodeID, mut probe: bool) -&gt; Result&lt;()&gt; {
</a><a href="#h2-13-19" id="h2-13-19" class="i">+        let (last_index, _) = self.log.get_last_index();
</a><a href="#h2-13-20" id="h2-13-20" class="i">+        let progress = self.role.progress.get_mut(&amp;peer).expect(&quot;unknown node&quot;);
</a><a href="#h2-13-21" id="h2-13-21" class="i">+        assert_ne!(progress.next_index, 0, &quot;invalid next_index&quot;);
</a><a href="#h2-13-22" id="h2-13-22" class="i">+        assert!(progress.next_index &gt; progress.match_index, &quot;invalid next_index &lt;= match_index&quot;);
</a><a href="#h2-13-23" id="h2-13-23" class="i">+        assert!(progress.match_index &lt;= last_index, &quot;invalid match_index &gt; last_index&quot;);
</a><a href="#h2-13-24" id="h2-13-24" class="i">+        assert!(progress.next_index &lt;= last_index + 1, &quot;invalid next_index &gt; last_index + 1&quot;);
</a><a href="#h2-13-25" id="h2-13-25" class="i">+
</a><a href="#h2-13-26" id="h2-13-26" class="i">+        // If the peer is already caught up, there&#39;s no point sending an append.
</a><a href="#h2-13-27" id="h2-13-27" class="i">+        if progress.match_index == last_index {
</a><a href="#h2-13-28" id="h2-13-28" class="i">+            return Ok(());
</a><a href="#h2-13-29" id="h2-13-29" class="i">+        }
</a><a href="#h2-13-30" id="h2-13-30" class="i">+
</a><a href="#h2-13-31" id="h2-13-31" class="i">+        // If a probe was requested, but next_index is immediately after
</a><a href="#h2-13-32" id="h2-13-32" class="i">+        // match_index (even when 0), there is no point in probing because the
</a><a href="#h2-13-33" id="h2-13-33" class="i">+        // entry must be accepted. Send the entries instead.
</a><a href="#h2-13-34" id="h2-13-34" class="i">+        if probe &amp;&amp; progress.next_index == progress.match_index + 1 {
</a><a href="#h2-13-35" id="h2-13-35" class="i">+            probe = false;
</a><a href="#h2-13-36" id="h2-13-36" class="i">+        }
</a><a href="#h2-13-37" id="h2-13-37" class="i">+
</a><a href="#h2-13-38" id="h2-13-38" class="i">+        // If there are no pending entries and this is not a probe, there&#39;s
</a><a href="#h2-13-39" id="h2-13-39" class="i">+        // nothing more to send.
</a><a href="#h2-13-40" id="h2-13-40" class="i">+        if progress.next_index &gt; last_index &amp;&amp; !probe {
</a><a href="#h2-13-41" id="h2-13-41" class="i">+            return Ok(());
</a><a href="#h2-13-42" id="h2-13-42" class="i">+        }
</a><a href="#h2-13-43" id="h2-13-43" class="i">+
</a><a href="#h2-13-44" id="h2-13-44" class="i">+        // Fetch the base and entries.
</a><a href="#h2-13-45" id="h2-13-45" class="i">+        let (base_index, base_term) = match progress.next_index {
</a><a href="#h2-13-46" id="h2-13-46" class="i">+            0 =&gt; panic!(&quot;next_index=0 for node {peer}&quot;),
</a><a href="#h2-13-47" id="h2-13-47" class="i">+            1 =&gt; (0, 0),
</a><a href="#h2-13-48" id="h2-13-48" class="i">+            next =&gt; self.log.get(next - 1)?.map(|e| (e.index, e.term)).expect(&quot;missing base entry&quot;),
</a><a href="#h2-13-49" id="h2-13-49" class="i">+        };
</a><a href="#h2-13-50" id="h2-13-50" class="i">+
</a><a href="#h2-13-51" id="h2-13-51" class="i">+        let entries = if !probe {
</a><a href="#h2-13-52" id="h2-13-52" class="i">+            self.log
</a><a href="#h2-13-53" id="h2-13-53" class="i">+                .scan(progress.next_index..)?
</a><a href="#h2-13-54" id="h2-13-54" class="i">+                .take(self.max_append_entries)
</a><a href="#h2-13-55" id="h2-13-55" class="i">+                .collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h2-13-56" id="h2-13-56" class="i">+        } else {
</a><a href="#h2-13-57" id="h2-13-57" class="i">+            Vec::new()
</a>         };
 
<a href="#h2-13-60" id="h2-13-60" class="d">-        let entries = self.log.scan((base_index + 1)..)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h2-13-61" id="h2-13-61" class="d">-        debug!(&quot;Replicating {} entries at base {} to {}&quot;, entries.len(), base_index, peer);
</a><a href="#h2-13-62" id="h2-13-62" class="i">+        // Optimistically assume the entries will be accepted by the follower,
</a><a href="#h2-13-63" id="h2-13-63" class="i">+        // and bump the next_index to avoid resending them until a response.
</a><a href="#h2-13-64" id="h2-13-64" class="i">+        if let Some(last) = entries.last() {
</a><a href="#h2-13-65" id="h2-13-65" class="i">+            progress.next_index = last.index + 1;
</a><a href="#h2-13-66" id="h2-13-66" class="i">+        }
</a><a href="#h2-13-67" id="h2-13-67" class="i">+
</a><a href="#h2-13-68" id="h2-13-68" class="i">+        debug!(&quot;Replicating {} entries with base {base_index} to {peer}&quot;, entries.len());
</a>         self.send(peer, Message::Append { base_index, base_term, entries })?;
         Ok(())
     }
<a href="#h2-14" id="h2-14" class="h">@@ -1110,6 +1227,7 @@ mod tests {
</a>     use crate::errassert;
     use crate::raft::{
         Entry, Request, RequestID, Response, ELECTION_TIMEOUT_RANGE, HEARTBEAT_INTERVAL,
<a href="#h2-14-3" id="h2-14-3" class="i">+        MAX_APPEND_ENTRIES,
</a>     };
     use crossbeam::channel::{Receiver, Sender};
     use pretty_assertions::assert_eq;
<a href="#h2-15" id="h2-15" class="h">@@ -1177,7 +1295,7 @@ mod tests {
</a>                     self.campaign(&amp;ids, &amp;mut output)?;
                 }
 
<a href="#h2-15-3" id="h2-15-3" class="d">-                // cluster nodes=N [leader=ID] [heartbeat_interval=N] [election_timeout=N]
</a><a href="#h2-15-4" id="h2-15-4" class="i">+                // cluster nodes=N [leader=ID] [heartbeat_interval=N] [election_timeout=N] [max_append_entries=N]
</a>                 //
                 // Creates a new Raft cluster.
                 &quot;cluster&quot; =&gt; {
<a href="#h2-16" id="h2-16" class="h">@@ -1189,8 +1307,17 @@ mod tests {
</a>                     let election_timeout = args
                         .lookup_parse(&quot;election_timeout&quot;)?
                         .unwrap_or(ELECTION_TIMEOUT_RANGE.start);
<a href="#h2-16-3" id="h2-16-3" class="i">+                    let max_append_entries =
</a><a href="#h2-16-4" id="h2-16-4" class="i">+                        args.lookup_parse(&quot;max_append_entries&quot;)?.unwrap_or(MAX_APPEND_ENTRIES);
</a>                     args.reject_rest()?;
<a href="#h2-16-6" id="h2-16-6" class="d">-                    self.cluster(nodes, leader, heartbeat_interval, election_timeout, &amp;mut output)?;
</a><a href="#h2-16-7" id="h2-16-7" class="i">+                    self.cluster(
</a><a href="#h2-16-8" id="h2-16-8" class="i">+                        nodes,
</a><a href="#h2-16-9" id="h2-16-9" class="i">+                        leader,
</a><a href="#h2-16-10" id="h2-16-10" class="i">+                        heartbeat_interval,
</a><a href="#h2-16-11" id="h2-16-11" class="i">+                        election_timeout,
</a><a href="#h2-16-12" id="h2-16-12" class="i">+                        max_append_entries,
</a><a href="#h2-16-13" id="h2-16-13" class="i">+                        &amp;mut output,
</a><a href="#h2-16-14" id="h2-16-14" class="i">+                    )?;
</a>                 }
 
                 // deliver [from=ID] [ID...]
<a href="#h2-17" id="h2-17" class="h">@@ -1362,6 +1489,7 @@ mod tests {
</a>             leader: Option&lt;NodeID&gt;,
             heartbeat_interval: Ticks,
             election_timeout: Ticks,
<a href="#h2-17-3" id="h2-17-3" class="i">+            max_append_entries: usize,
</a>             output: &amp;mut String,
         ) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
             if !self.ids.is_empty() {
<a href="#h2-18" id="h2-18" class="h">@@ -1389,6 +1517,7 @@ mod tests {
</a>                         node_tx,
                         heartbeat_interval,
                         election_timeout..election_timeout + 1,
<a href="#h2-18-3" id="h2-18-3" class="i">+                        max_append_entries,
</a>                     )?,
                 );
                 self.nodes_rx.insert(id, node_rx);
<a href="#h2-19" id="h2-19" class="h">@@ -1675,6 +1804,8 @@ mod tests {
</a> 
             let log = Self::borrow_log_mut(&amp;mut node);
             let (commit_index, commit_term) = log.get_commit_index();
<a href="#h2-19-3" id="h2-19-3" class="i">+            // TODO: this doesn&#39;t handle replaced indexes. It needs to fetch the
</a><a href="#h2-19-4" id="h2-19-4" class="i">+            // index/term of all entries and compare them.
</a>             let appended: Vec&lt;_&gt; =
                 log.scan(old_last_index + 1..)?.collect::&lt;crate::error::Result&lt;_&gt;&gt;()?;
 
<a href="#h2-20" id="h2-20" class="h">@@ -1850,11 +1981,11 @@ mod tests {
</a>                 Message::CampaignResponse { vote } =&gt; {
                     format!(&quot;CampaignResponse vote={vote}&quot;)
                 }
<a href="#h2-20-3" id="h2-20-3" class="d">-                Message::Heartbeat { commit_index, commit_term, read_seq } =&gt; {
</a><a href="#h2-20-4" id="h2-20-4" class="d">-                    format!(&quot;Heartbeat commit={commit_index}@{commit_term} read_seq={read_seq}&quot;)
</a><a href="#h2-20-5" id="h2-20-5" class="i">+                Message::Heartbeat { last_index, commit_index, commit_term, read_seq } =&gt; {
</a><a href="#h2-20-6" id="h2-20-6" class="i">+                    format!(&quot;Heartbeat last_index={last_index} commit={commit_index}@{commit_term} read_seq={read_seq}&quot;)
</a>                 }
<a href="#h2-20-8" id="h2-20-8" class="d">-                Message::HeartbeatResponse { last_index, last_term, read_seq } =&gt; {
</a><a href="#h2-20-9" id="h2-20-9" class="d">-                    format!(&quot;HeartbeatResponse last={last_index}@{last_term} read_seq={read_seq}&quot;)
</a><a href="#h2-20-10" id="h2-20-10" class="i">+                Message::HeartbeatResponse { match_index, read_seq } =&gt; {
</a><a href="#h2-20-11" id="h2-20-11" class="i">+                    format!(&quot;HeartbeatResponse match_index={match_index} read_seq={read_seq}&quot;)
</a>                 }
                 Message::Append { base_index, base_term, entries } =&gt; {
                     format!(
<a href="#h2-21" id="h2-21" class="h">@@ -1862,8 +1993,13 @@ mod tests {
</a>                         entries.iter().map(|e| format!(&quot;{}@{}&quot;, e.index, e.term)).join(&quot; &quot;)
                     )
                 }
<a href="#h2-21-3" id="h2-21-3" class="d">-                Message::AppendResponse { reject_index, last_index, last_term } =&gt; {
</a><a href="#h2-21-4" id="h2-21-4" class="d">-                    format!(&quot;AppendResponse last={last_index}@{last_term} reject={reject_index}&quot;)
</a><a href="#h2-21-5" id="h2-21-5" class="i">+                Message::AppendResponse { match_index, reject_index } =&gt; {
</a><a href="#h2-21-6" id="h2-21-6" class="i">+                    match (match_index, reject_index) {
</a><a href="#h2-21-7" id="h2-21-7" class="i">+                        (0, 0) =&gt; panic!(&quot;match_index and reject_index both 0&quot;),
</a><a href="#h2-21-8" id="h2-21-8" class="i">+                        (match_index, 0) =&gt; format!(&quot;AppendResponse match_index={match_index}&quot;),
</a><a href="#h2-21-9" id="h2-21-9" class="i">+                        (0, reject_index) =&gt; format!(&quot;AppendResponse reject_index={reject_index}&quot;),
</a><a href="#h2-21-10" id="h2-21-10" class="i">+                        (_, _) =&gt; panic!(&quot;match_index and reject_index both non-zero&quot;),
</a><a href="#h2-21-11" id="h2-21-11" class="i">+                    }
</a>                 }
                 Message::ClientRequest { id, request } =&gt; {
                     format!(
<b>diff --git a/<a id="h3" href="../file/src/raft/testscripts/node/append.html">src/raft/testscripts/node/append</a> b/<a href="../file/src/raft/testscripts/node/append.html">src/raft/testscripts/node/append</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-# Can append both a single and multiple entries.
</a><a href="#h3-0-1" id="h3-0-1" class="i">+# Can append single entries in steady state.
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h3-1" id="h3-1" class="h">@@ -6,67 +6,38 @@ n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a> n2@1 follower(n1) last=1@1 commit=1@1 apply=1
 n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 
<a href="#h3-1-3" id="h3-1-3" class="d">-# Partition n3 so that it does not receive writes.
</a><a href="#h3-1-4" id="h3-1-4" class="d">-partition 3
</a><a href="#h3-1-5" id="h3-1-5" class="d">----
</a><a href="#h3-1-6" id="h3-1-6" class="d">-n3 ⇹ n1 n2
</a><a href="#h3-1-7" id="h3-1-7" class="d">-
</a><a href="#h3-1-8" id="h3-1-8" class="d">-# Propose a single write, and append it to n2.
</a><a href="#h3-1-9" id="h3-1-9" class="i">+# Propose a single write.
</a> put 1 foo=bar
 ---
 c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
 n1@1 append 2@1 put foo=bar
 n1@1 → n2 Append base=1@1 [2@1]
<a href="#h3-1-15" id="h3-1-15" class="d">-n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h3-1-16" id="h3-1-16" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a> 
<a href="#h3-1-18" id="h3-1-18" class="d">-stabilize
</a><a href="#h3-1-19" id="h3-1-19" class="i">+status
</a> ---
<a href="#h3-1-21" id="h3-1-21" class="d">-n2@1 append 2@1 put foo=bar
</a><a href="#h3-1-22" id="h3-1-22" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h3-1-23" id="h3-1-23" class="d">-n1@1 commit 2@1
</a><a href="#h3-1-24" id="h3-1-24" class="d">-n1@1 apply 2@1 put foo=bar
</a><a href="#h3-1-25" id="h3-1-25" class="d">-n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h3-1-26" id="h3-1-26" class="d">-c1@1 put foo=bar ⇒ 2
</a><a href="#h3-1-27" id="h3-1-27" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:1→3 3:1→3}
</a><a href="#h3-1-28" id="h3-1-28" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h3-1-29" id="h3-1-29" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> 
<a href="#h3-1-31" id="h3-1-31" class="d">-# Propose another write.
</a><a href="#h3-1-32" id="h3-1-32" class="d">-put 1 a=1
</a><a href="#h3-1-33" id="h3-1-33" class="i">+# Append it to both followers.
</a><a href="#h3-1-34" id="h3-1-34" class="i">+deliver
</a> ---
<a href="#h3-1-36" id="h3-1-36" class="d">-c1@1 → n1 ClientRequest id=0x02 write 0x0101610131
</a><a href="#h3-1-37" id="h3-1-37" class="d">-n1@1 append 3@1 put a=1
</a><a href="#h3-1-38" id="h3-1-38" class="d">-n1@1 → n2 Append base=2@1 [3@1]
</a><a href="#h3-1-39" id="h3-1-39" class="d">-n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h3-1-40" id="h3-1-40" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h3-1-41" id="h3-1-41" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h3-1-42" id="h3-1-42" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h3-1-43" id="h3-1-43" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> 
<a href="#h3-1-45" id="h3-1-45" class="i">+# The leader commits and applies the write.
</a> stabilize
 ---
<a href="#h3-1-48" id="h3-1-48" class="d">-n2@1 append 3@1 put a=1
</a><a href="#h3-1-49" id="h3-1-49" class="d">-n2@1 → n1 AppendResponse last=3@1 reject=0
</a><a href="#h3-1-50" id="h3-1-50" class="d">-n1@1 commit 3@1
</a><a href="#h3-1-51" id="h3-1-51" class="d">-n1@1 apply 3@1 put a=1
</a><a href="#h3-1-52" id="h3-1-52" class="d">-n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h3-1-53" id="h3-1-53" class="d">-c1@1 put a=1 ⇒ 3
</a><a href="#h3-1-54" id="h3-1-54" class="d">-
</a><a href="#h3-1-55" id="h3-1-55" class="d">-# Heal the partition and propose another write. All writes are sent to
</a><a href="#h3-1-56" id="h3-1-56" class="d">-# n3 as a single message.
</a><a href="#h3-1-57" id="h3-1-57" class="d">-heal
</a><a href="#h3-1-58" id="h3-1-58" class="d">----
</a><a href="#h3-1-59" id="h3-1-59" class="d">-n1 n2 n3 fully connected
</a><a href="#h3-1-60" id="h3-1-60" class="d">-
</a><a href="#h3-1-61" id="h3-1-61" class="d">-put 1 b=2
</a><a href="#h3-1-62" id="h3-1-62" class="d">----
</a><a href="#h3-1-63" id="h3-1-63" class="d">-c1@1 → n1 ClientRequest id=0x03 write 0x0101620132
</a><a href="#h3-1-64" id="h3-1-64" class="d">-n1@1 append 4@1 put b=2
</a><a href="#h3-1-65" id="h3-1-65" class="d">-n1@1 → n2 Append base=3@1 [4@1]
</a><a href="#h3-1-66" id="h3-1-66" class="d">-n1@1 → n3 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h3-1-67" id="h3-1-67" class="i">+n1@1 commit 2@1
</a><a href="#h3-1-68" id="h3-1-68" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h3-1-69" id="h3-1-69" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h3-1-70" id="h3-1-70" class="i">+c1@1 put foo=bar ⇒ 2
</a> 
<a href="#h3-1-72" id="h3-1-72" class="d">-stabilize
</a><a href="#h3-1-73" id="h3-1-73" class="i">+status
</a> ---
<a href="#h3-1-75" id="h3-1-75" class="d">-n2@1 append 4@1 put b=2
</a><a href="#h3-1-76" id="h3-1-76" class="d">-n2@1 → n1 AppendResponse last=4@1 reject=0
</a><a href="#h3-1-77" id="h3-1-77" class="d">-n3@1 append 2@1 put foo=bar
</a><a href="#h3-1-78" id="h3-1-78" class="d">-n3@1 append 3@1 put a=1
</a><a href="#h3-1-79" id="h3-1-79" class="d">-n3@1 append 4@1 put b=2
</a><a href="#h3-1-80" id="h3-1-80" class="d">-n3@1 → n1 AppendResponse last=4@1 reject=0
</a><a href="#h3-1-81" id="h3-1-81" class="d">-n1@1 commit 4@1
</a><a href="#h3-1-82" id="h3-1-82" class="d">-n1@1 apply 4@1 put b=2
</a><a href="#h3-1-83" id="h3-1-83" class="d">-n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h3-1-84" id="h3-1-84" class="d">-c1@1 put b=2 ⇒ 4
</a><a href="#h3-1-85" id="h3-1-85" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h3-1-86" id="h3-1-86" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h3-1-87" id="h3-1-87" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h4" href="../file/src/raft/testscripts/node/append_base_missing.html">src/raft/testscripts/node/append_base_missing</a> b/<a href="../file/src/raft/testscripts/node/append_base_missing.html">src/raft/testscripts/node/append_base_missing</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,4 +1,6 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-# Appends with a base beyond the node&#39;s last log entry work.
</a><a href="#h4-0-1" id="h4-0-1" class="i">+# Appends with a base beyond the node&#39;s last log entry should result in a
</a><a href="#h4-0-2" id="h4-0-2" class="i">+# rejection at the index following the last entry, and the leader appending
</a><a href="#h4-0-3" id="h4-0-3" class="i">+# the tail of the log.
</a> 
 cluster nodes=3 leader=1
 ---
<a href="#h4-1" id="h4-1" class="h">@@ -14,64 +16,58 @@ n3 ⇹ n1 n2
</a> # Replicate a couple of writes.
 (put 1 a=1)
 (put 1 b=2)
<a href="#h4-1-3" id="h4-1-3" class="i">+(put 1 c=3)
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h4-1-7" id="h4-1-7" class="d">-n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:1→2}
</a><a href="#h4-1-8" id="h4-1-8" class="d">-n2@1 follower(n1) last=3@1 commit=3@1 apply=3
</a><a href="#h4-1-9" id="h4-1-9" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h4-1-10" id="h4-1-10" class="d">-
</a><a href="#h4-1-11" id="h4-1-11" class="d">-# Elect n2 as a new leader.
</a><a href="#h4-1-12" id="h4-1-12" class="d">-(campaign 2)
</a><a href="#h4-1-13" id="h4-1-13" class="d">-(stabilize heartbeat=true)
</a><a href="#h4-1-14" id="h4-1-14" class="d">-status
</a><a href="#h4-1-15" id="h4-1-15" class="d">----
</a><a href="#h4-1-16" id="h4-1-16" class="d">-n1@2 follower(n2) last=4@2 commit=4@2 apply=4
</a><a href="#h4-1-17" id="h4-1-17" class="d">-n2@2 leader last=4@2 commit=4@2 apply=4 progress={1:4→5 3:0→4}
</a><a href="#h4-1-18" id="h4-1-18" class="i">+n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:4→5 3:1→5}
</a><a href="#h4-1-19" id="h4-1-19" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a> n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 
 # Heal the partition, and propose another write.
 heal
<a href="#h4-1-24" id="h4-1-24" class="d">-put 2 c=3
</a><a href="#h4-1-25" id="h4-1-25" class="i">+put 1 c=3
</a> ---
 n1 n2 n3 fully connected
<a href="#h4-1-28" id="h4-1-28" class="d">-c2@2 → n2 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h4-1-29" id="h4-1-29" class="d">-n2@2 append 5@2 put c=3
</a><a href="#h4-1-30" id="h4-1-30" class="d">-n2@2 → n1 Append base=4@2 [5@2]
</a><a href="#h4-1-31" id="h4-1-31" class="d">-n2@2 → n3 Append base=3@1 [4@2 5@2]
</a><a href="#h4-1-32" id="h4-1-32" class="i">+c1@1 → n1 ClientRequest id=0x04 write 0x0101630133
</a><a href="#h4-1-33" id="h4-1-33" class="i">+n1@1 append 5@1 put c=3
</a><a href="#h4-1-34" id="h4-1-34" class="i">+n1@1 → n2 Append base=4@1 [5@1]
</a><a href="#h4-1-35" id="h4-1-35" class="i">+n1@1 → n3 Append base=4@1 [5@1]
</a> 
<a href="#h4-1-37" id="h4-1-37" class="d">-# The 3@1 base is beyond n3&#39;s last index 1@1, so the append is rejected.
</a><a href="#h4-1-38" id="h4-1-38" class="i">+# The 4@1 base is beyond n3&#39;s last index 1@1, so the append is rejected.
</a><a href="#h4-1-39" id="h4-1-39" class="i">+# However, the follower returns reject_index=2 immediately after its
</a><a href="#h4-1-40" id="h4-1-40" class="i">+# last index, rather than the original base index 4.
</a> deliver 3
 ---
<a href="#h4-1-43" id="h4-1-43" class="d">-n3@1 follower(n1) ⇨ n3@2 follower(n2)
</a><a href="#h4-1-44" id="h4-1-44" class="d">-n3@2 → n2 AppendResponse last=1@1 reject=3
</a><a href="#h4-1-45" id="h4-1-45" class="i">+n3@1 → n1 AppendResponse reject_index=2
</a> 
<a href="#h4-1-47" id="h4-1-47" class="d">-# n2 tries replicating using n3&#39;s last index as a base, which succeeds.
</a><a href="#h4-1-48" id="h4-1-48" class="d">-deliver 2
</a><a href="#h4-1-49" id="h4-1-49" class="d">-status 2
</a><a href="#h4-1-50" id="h4-1-50" class="i">+# Because index 1 is already matched with the leader, it doesn&#39;t have to probe
</a><a href="#h4-1-51" id="h4-1-51" class="i">+# and simply sends the entire tail, which is accepted.
</a><a href="#h4-1-52" id="h4-1-52" class="i">+deliver 1
</a><a href="#h4-1-53" id="h4-1-53" class="i">+status 1
</a> ---
<a href="#h4-1-55" id="h4-1-55" class="d">-n2@2 → n3 Append base=1@1 [2@1 3@1 4@2 5@2]
</a><a href="#h4-1-56" id="h4-1-56" class="d">-n2@2 leader last=5@2 commit=4@2 apply=4 progress={1:4→5 3:0→2}
</a><a href="#h4-1-57" id="h4-1-57" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1 4@1 5@1]
</a><a href="#h4-1-58" id="h4-1-58" class="i">+n1@1 leader last=5@1 commit=4@1 apply=4 progress={2:4→6 3:1→6}
</a> 
 deliver 3
 ---
<a href="#h4-1-62" id="h4-1-62" class="d">-n3@2 append 2@1 put a=1
</a><a href="#h4-1-63" id="h4-1-63" class="d">-n3@2 append 3@1 put b=2
</a><a href="#h4-1-64" id="h4-1-64" class="d">-n3@2 append 4@2 None
</a><a href="#h4-1-65" id="h4-1-65" class="d">-n3@2 append 5@2 put c=3
</a><a href="#h4-1-66" id="h4-1-66" class="d">-n3@2 → n2 AppendResponse last=5@2 reject=0
</a><a href="#h4-1-67" id="h4-1-67" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h4-1-68" id="h4-1-68" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h4-1-69" id="h4-1-69" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h4-1-70" id="h4-1-70" class="i">+n3@1 append 5@1 put c=3
</a><a href="#h4-1-71" id="h4-1-71" class="i">+n3@1 → n1 AppendResponse match_index=5
</a> 
<a href="#h4-1-73" id="h4-1-73" class="d">-# When n2 receives the ack, it commits and applies the write.
</a><a href="#h4-1-74" id="h4-1-74" class="d">-deliver 2
</a><a href="#h4-1-75" id="h4-1-75" class="i">+# When n1 receives the ack, it commits and applies the write.
</a><a href="#h4-1-76" id="h4-1-76" class="i">+deliver 1
</a> ---
<a href="#h4-1-78" id="h4-1-78" class="d">-n2@2 commit 5@2
</a><a href="#h4-1-79" id="h4-1-79" class="d">-n2@2 apply 5@2 put c=3
</a><a href="#h4-1-80" id="h4-1-80" class="d">-n2@2 → c2 ClientResponse id=0x03 write 0x0105
</a><a href="#h4-1-81" id="h4-1-81" class="d">-c2@2 put c=3 ⇒ 5
</a><a href="#h4-1-82" id="h4-1-82" class="i">+n1@1 commit 5@1
</a><a href="#h4-1-83" id="h4-1-83" class="i">+n1@1 apply 5@1 put c=3
</a><a href="#h4-1-84" id="h4-1-84" class="i">+n1@1 → c1 ClientResponse id=0x04 write 0x0105
</a><a href="#h4-1-85" id="h4-1-85" class="i">+c1@1 put c=3 ⇒ 5
</a> 
 # The progress is also updated.
 status
 ---
<a href="#h4-1-90" id="h4-1-90" class="d">-n1@2 follower(n2) last=4@2 commit=4@2 apply=4
</a><a href="#h4-1-91" id="h4-1-91" class="d">-n2@2 leader last=5@2 commit=5@2 apply=5 progress={1:4→5 3:5→6}
</a><a href="#h4-1-92" id="h4-1-92" class="d">-n3@2 follower(n2) last=5@2 commit=1@1 apply=1
</a><a href="#h4-1-93" id="h4-1-93" class="i">+n1@1 leader last=5@1 commit=5@1 apply=5 progress={2:4→6 3:5→6}
</a><a href="#h4-1-94" id="h4-1-94" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h4-1-95" id="h4-1-95" class="i">+n3@1 follower(n1) last=5@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h5" href="../file/src/raft/testscripts/node/append_base_missing_all.html">src/raft/testscripts/node/append_base_missing_all</a> b/<a href="../file/src/raft/testscripts/node/append_base_missing_all.html">src/raft/testscripts/node/append_base_missing_all</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,80 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+# Appends to a node with an empty log should result in a rejection of index 1,
</a><a href="#h5-0-1" id="h5-0-1" class="i">+# allowing the leader to send the entire log.
</a><a href="#h5-0-2" id="h5-0-2" class="i">+
</a><a href="#h5-0-3" id="h5-0-3" class="i">+cluster nodes=3
</a><a href="#h5-0-4" id="h5-0-4" class="i">+---
</a><a href="#h5-0-5" id="h5-0-5" class="i">+n1@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h5-0-6" id="h5-0-6" class="i">+n2@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h5-0-7" id="h5-0-7" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h5-0-8" id="h5-0-8" class="i">+
</a><a href="#h5-0-9" id="h5-0-9" class="i">+# Partition n3 so that it does not receive writes.
</a><a href="#h5-0-10" id="h5-0-10" class="i">+partition 3
</a><a href="#h5-0-11" id="h5-0-11" class="i">+---
</a><a href="#h5-0-12" id="h5-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h5-0-13" id="h5-0-13" class="i">+
</a><a href="#h5-0-14" id="h5-0-14" class="i">+# Elect n1 as leader.
</a><a href="#h5-0-15" id="h5-0-15" class="i">+(campaign 1)
</a><a href="#h5-0-16" id="h5-0-16" class="i">+(stabilize)
</a><a href="#h5-0-17" id="h5-0-17" class="i">+status
</a><a href="#h5-0-18" id="h5-0-18" class="i">+---
</a><a href="#h5-0-19" id="h5-0-19" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→2}
</a><a href="#h5-0-20" id="h5-0-20" class="i">+n2@1 follower(n1) last=1@1 commit=0@0 apply=0
</a><a href="#h5-0-21" id="h5-0-21" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h5-0-22" id="h5-0-22" class="i">+
</a><a href="#h5-0-23" id="h5-0-23" class="i">+# Replicate a couple of writes.
</a><a href="#h5-0-24" id="h5-0-24" class="i">+(put 1 a=1)
</a><a href="#h5-0-25" id="h5-0-25" class="i">+(put 1 b=2)
</a><a href="#h5-0-26" id="h5-0-26" class="i">+(put 1 c=3)
</a><a href="#h5-0-27" id="h5-0-27" class="i">+(stabilize heartbeat=true)
</a><a href="#h5-0-28" id="h5-0-28" class="i">+status
</a><a href="#h5-0-29" id="h5-0-29" class="i">+---
</a><a href="#h5-0-30" id="h5-0-30" class="i">+n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:4→5 3:0→5}
</a><a href="#h5-0-31" id="h5-0-31" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h5-0-32" id="h5-0-32" class="i">+n3@0 follower() last=0@0 commit=0@0 apply=0
</a><a href="#h5-0-33" id="h5-0-33" class="i">+
</a><a href="#h5-0-34" id="h5-0-34" class="i">+# Heal the partition, and propose another write.
</a><a href="#h5-0-35" id="h5-0-35" class="i">+heal
</a><a href="#h5-0-36" id="h5-0-36" class="i">+put 1 c=3
</a><a href="#h5-0-37" id="h5-0-37" class="i">+---
</a><a href="#h5-0-38" id="h5-0-38" class="i">+n1 n2 n3 fully connected
</a><a href="#h5-0-39" id="h5-0-39" class="i">+c1@1 → n1 ClientRequest id=0x04 write 0x0101630133
</a><a href="#h5-0-40" id="h5-0-40" class="i">+n1@1 append 5@1 put c=3
</a><a href="#h5-0-41" id="h5-0-41" class="i">+n1@1 → n2 Append base=4@1 [5@1]
</a><a href="#h5-0-42" id="h5-0-42" class="i">+n1@1 → n3 Append base=4@1 [5@1]
</a><a href="#h5-0-43" id="h5-0-43" class="i">+
</a><a href="#h5-0-44" id="h5-0-44" class="i">+# n3 has no entries, so it rejects with reject_index=1.
</a><a href="#h5-0-45" id="h5-0-45" class="i">+deliver 3
</a><a href="#h5-0-46" id="h5-0-46" class="i">+---
</a><a href="#h5-0-47" id="h5-0-47" class="i">+n3@0 follower() ⇨ n3@1 follower(n1)
</a><a href="#h5-0-48" id="h5-0-48" class="i">+n3@1 → n1 AppendResponse reject_index=1
</a><a href="#h5-0-49" id="h5-0-49" class="i">+
</a><a href="#h5-0-50" id="h5-0-50" class="i">+# This allows n1 to send the entire log, without having to probe.
</a><a href="#h5-0-51" id="h5-0-51" class="i">+deliver 1
</a><a href="#h5-0-52" id="h5-0-52" class="i">+status 1
</a><a href="#h5-0-53" id="h5-0-53" class="i">+---
</a><a href="#h5-0-54" id="h5-0-54" class="i">+n1@1 → n3 Append base=0@0 [1@1 2@1 3@1 4@1 5@1]
</a><a href="#h5-0-55" id="h5-0-55" class="i">+n1@1 leader last=5@1 commit=4@1 apply=4 progress={2:4→6 3:0→6}
</a><a href="#h5-0-56" id="h5-0-56" class="i">+
</a><a href="#h5-0-57" id="h5-0-57" class="i">+deliver 3
</a><a href="#h5-0-58" id="h5-0-58" class="i">+---
</a><a href="#h5-0-59" id="h5-0-59" class="i">+n3@1 append 1@1 None
</a><a href="#h5-0-60" id="h5-0-60" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h5-0-61" id="h5-0-61" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h5-0-62" id="h5-0-62" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h5-0-63" id="h5-0-63" class="i">+n3@1 append 5@1 put c=3
</a><a href="#h5-0-64" id="h5-0-64" class="i">+n3@1 → n1 AppendResponse match_index=5
</a><a href="#h5-0-65" id="h5-0-65" class="i">+
</a><a href="#h5-0-66" id="h5-0-66" class="i">+# When n1 receives the ack, it commits and applies the write.
</a><a href="#h5-0-67" id="h5-0-67" class="i">+deliver 1
</a><a href="#h5-0-68" id="h5-0-68" class="i">+---
</a><a href="#h5-0-69" id="h5-0-69" class="i">+n1@1 commit 5@1
</a><a href="#h5-0-70" id="h5-0-70" class="i">+n1@1 apply 5@1 put c=3
</a><a href="#h5-0-71" id="h5-0-71" class="i">+n1@1 → c1 ClientResponse id=0x04 write 0x0105
</a><a href="#h5-0-72" id="h5-0-72" class="i">+c1@1 put c=3 ⇒ 5
</a><a href="#h5-0-73" id="h5-0-73" class="i">+
</a><a href="#h5-0-74" id="h5-0-74" class="i">+# The progress is also updated.
</a><a href="#h5-0-75" id="h5-0-75" class="i">+status
</a><a href="#h5-0-76" id="h5-0-76" class="i">+---
</a><a href="#h5-0-77" id="h5-0-77" class="i">+n1@1 leader last=5@1 commit=5@1 apply=5 progress={2:4→6 3:5→6}
</a><a href="#h5-0-78" id="h5-0-78" class="i">+n2@1 follower(n1) last=4@1 commit=4@1 apply=4
</a><a href="#h5-0-79" id="h5-0-79" class="i">+n3@1 follower(n1) last=5@1 commit=0@0 apply=0
</a><b>diff --git a/<a id="h6" href="../file/src/raft/testscripts/node/append_commit_quorum.html">src/raft/testscripts/node/append_commit_quorum</a> b/<a href="../file/src/raft/testscripts/node/append_commit_quorum.html">src/raft/testscripts/node/append_commit_quorum</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -29,11 +29,11 @@ n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a> n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
 n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
 n2@1 append 2@1 put a=1
<a href="#h6-0-3" id="h6-0-3" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h6-0-4" id="h6-0-4" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> 
 status
 ---
<a href="#h6-0-8" id="h6-0-8" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2 6:1→2}
</a><a href="#h6-0-9" id="h6-0-9" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→3 4:1→3 5:1→3 6:1→3}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 n4@1 follower(n1) last=1@1 commit=1@1 apply=1
<a href="#h6-1" id="h6-1" class="h">@@ -53,17 +53,19 @@ stabilize
</a> c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
 n1@1 append 3@1 put b=2
 n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
<a href="#h6-1-3" id="h6-1-3" class="i">+n1@1 → n3 Append base=2@1 [3@1]
</a><a href="#h6-1-4" id="h6-1-4" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h6-1-5" id="h6-1-5" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h6-1-6" id="h6-1-6" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h6-1-7" id="h6-1-7" class="i">+n3@1 → n1 AppendResponse reject_index=2
</a> n1@1 → n3 Append base=1@1 [2@1 3@1]
<a href="#h6-1-9" id="h6-1-9" class="d">-n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h6-1-10" id="h6-1-10" class="d">-n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a><a href="#h6-1-11" id="h6-1-11" class="d">-n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶]̶
</a> n3@1 append 2@1 put a=1
 n3@1 append 3@1 put b=2
<a href="#h6-1-14" id="h6-1-14" class="d">-n3@1 → n1 AppendResponse last=3@1 reject=0
</a><a href="#h6-1-15" id="h6-1-15" class="i">+n3@1 → n1 AppendResponse match_index=3
</a> 
 status
 ---
<a href="#h6-1-19" id="h6-1-19" class="d">-n1@1 leader last=3@1 commit=1@1 apply=1 progress={2:2→3 3:3→4 4:1→2 5:1→2 6:1→2}
</a><a href="#h6-1-20" id="h6-1-20" class="i">+n1@1 leader last=3@1 commit=1@1 apply=1 progress={2:2→4 3:3→4 4:1→4 5:1→4 6:1→4}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=3@1 commit=1@1 apply=1
 n4@1 follower(n1) last=1@1 commit=1@1 apply=1
<a href="#h6-2" id="h6-2" class="h">@@ -82,15 +84,17 @@ stabilize
</a> ---
 c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
 n1@1 append 4@1 put c=3
<a href="#h6-2-3" id="h6-2-3" class="d">-n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a><a href="#h6-2-4" id="h6-2-4" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a> n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
<a href="#h6-2-6" id="h6-2-6" class="i">+n1@1 → n4 Append base=3@1 [4@1]
</a><a href="#h6-2-7" id="h6-2-7" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a><a href="#h6-2-8" id="h6-2-8" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a><a href="#h6-2-9" id="h6-2-9" class="i">+n4@1 → n1 AppendResponse reject_index=2
</a> n1@1 → n4 Append base=1@1 [2@1 3@1 4@1]
<a href="#h6-2-11" id="h6-2-11" class="d">-n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a><a href="#h6-2-12" id="h6-2-12" class="d">-n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶]̶
</a> n4@1 append 2@1 put a=1
 n4@1 append 3@1 put b=2
 n4@1 append 4@1 put c=3
<a href="#h6-2-16" id="h6-2-16" class="d">-n4@1 → n1 AppendResponse last=4@1 reject=0
</a><a href="#h6-2-17" id="h6-2-17" class="i">+n4@1 → n1 AppendResponse match_index=4
</a> n1@1 commit 2@1
 n1@1 apply 2@1 put a=1
 n1@1 → c1 ClientResponse id=0x01 write 0x0102
<a href="#h6-3" id="h6-3" class="h">@@ -98,7 +102,7 @@ c1@1 put a=1 ⇒ 2
</a> 
 status
 ---
<a href="#h6-3-3" id="h6-3-3" class="d">-n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→3 3:3→4 4:4→5 5:1→2 6:1→2}
</a><a href="#h6-3-4" id="h6-3-4" class="i">+n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→5 3:3→5 4:4→5 5:1→5 6:1→5}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=3@1 commit=1@1 apply=1
 n4@1 follower(n1) last=4@1 commit=1@1 apply=1
<a href="#h6-4" id="h6-4" class="h">@@ -117,16 +121,18 @@ stabilize
</a> ---
 c1@1 → n1 ClientRequest id=0x04 write 0x0101640134
 n1@1 append 5@1 put d=4
<a href="#h6-4-3" id="h6-4-3" class="d">-n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a><a href="#h6-4-4" id="h6-4-4" class="d">-n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a><a href="#h6-4-5" id="h6-4-5" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶]̶
</a><a href="#h6-4-6" id="h6-4-6" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶]̶
</a> n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶]̶
<a href="#h6-4-8" id="h6-4-8" class="i">+n1@1 → n5 Append base=4@1 [5@1]
</a><a href="#h6-4-9" id="h6-4-9" class="i">+n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶]̶
</a><a href="#h6-4-10" id="h6-4-10" class="i">+n5@1 → n1 AppendResponse reject_index=2
</a> n1@1 → n5 Append base=1@1 [2@1 3@1 4@1 5@1]
<a href="#h6-4-12" id="h6-4-12" class="d">-n1@1 ⇥ n6 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶ ̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶]̶
</a> n5@1 append 2@1 put a=1
 n5@1 append 3@1 put b=2
 n5@1 append 4@1 put c=3
 n5@1 append 5@1 put d=4
<a href="#h6-4-17" id="h6-4-17" class="d">-n5@1 → n1 AppendResponse last=5@1 reject=0
</a><a href="#h6-4-18" id="h6-4-18" class="i">+n5@1 → n1 AppendResponse match_index=5
</a> n1@1 commit 3@1
 n1@1 apply 3@1 put b=2
 n1@1 → c1 ClientResponse id=0x02 write 0x0103
<a href="#h6-5" id="h6-5" class="h">@@ -134,7 +140,7 @@ c1@1 put b=2 ⇒ 3
</a> 
 status
 ---
<a href="#h6-5-3" id="h6-5-3" class="d">-n1@1 leader last=5@1 commit=3@1 apply=3 progress={2:2→3 3:3→4 4:4→5 5:5→6 6:1→2}
</a><a href="#h6-5-4" id="h6-5-4" class="i">+n1@1 leader last=5@1 commit=3@1 apply=3 progress={2:2→6 3:3→6 4:4→6 5:5→6 6:1→6}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=3@1 commit=1@1 apply=1
 n4@1 follower(n1) last=4@1 commit=1@1 apply=1
<a href="#h6-6" id="h6-6" class="h">@@ -153,17 +159,19 @@ stabilize
</a> ---
 c1@1 → n1 ClientRequest id=0x05 write 0x0101650135
 n1@1 append 6@1 put e=5
<a href="#h6-6-3" id="h6-6-3" class="d">-n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶ ̶4̶@̶1̶ ̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h6-6-4" id="h6-6-4" class="d">-n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶ ̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h6-6-5" id="h6-6-5" class="d">-n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶4̶@̶1̶ ̶[̶5̶@̶1̶ ̶6̶@̶1̶]̶
</a><a href="#h6-6-6" id="h6-6-6" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶5̶@̶1̶ ̶[̶6̶@̶1̶]̶
</a><a href="#h6-6-7" id="h6-6-7" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶5̶@̶1̶ ̶[̶6̶@̶1̶]̶
</a><a href="#h6-6-8" id="h6-6-8" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶5̶@̶1̶ ̶[̶6̶@̶1̶]̶
</a> n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶5̶@̶1̶ ̶[̶6̶@̶1̶]̶
<a href="#h6-6-10" id="h6-6-10" class="i">+n1@1 → n6 Append base=5@1 [6@1]
</a><a href="#h6-6-11" id="h6-6-11" class="i">+n6@1 → n1 AppendResponse reject_index=2
</a> n1@1 → n6 Append base=1@1 [2@1 3@1 4@1 5@1 6@1]
 n6@1 append 2@1 put a=1
 n6@1 append 3@1 put b=2
 n6@1 append 4@1 put c=3
 n6@1 append 5@1 put d=4
 n6@1 append 6@1 put e=5
<a href="#h6-6-18" id="h6-6-18" class="d">-n6@1 → n1 AppendResponse last=6@1 reject=0
</a><a href="#h6-6-19" id="h6-6-19" class="i">+n6@1 → n1 AppendResponse match_index=6
</a> n1@1 commit 4@1
 n1@1 apply 4@1 put c=3
 n1@1 → c1 ClientResponse id=0x03 write 0x0104
<a href="#h6-7" id="h6-7" class="h">@@ -171,7 +179,7 @@ c1@1 put c=3 ⇒ 4
</a> 
 status
 ---
<a href="#h6-7-3" id="h6-7-3" class="d">-n1@1 leader last=6@1 commit=4@1 apply=4 progress={2:2→3 3:3→4 4:4→5 5:5→6 6:6→7}
</a><a href="#h6-7-4" id="h6-7-4" class="i">+n1@1 leader last=6@1 commit=4@1 apply=4 progress={2:2→7 3:3→7 4:4→7 5:5→7 6:6→7}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=3@1 commit=1@1 apply=1
 n4@1 follower(n1) last=4@1 commit=1@1 apply=1
<a href="#h6-8" id="h6-8" class="h">@@ -189,41 +197,48 @@ stabilize
</a> ---
 c1@1 → n1 ClientRequest id=0x06 write 0x0101660136
 n1@1 append 7@1 put f=6
<a href="#h6-8-3" id="h6-8-3" class="i">+n1@1 → n2 Append base=6@1 [7@1]
</a><a href="#h6-8-4" id="h6-8-4" class="i">+n1@1 → n3 Append base=6@1 [7@1]
</a><a href="#h6-8-5" id="h6-8-5" class="i">+n1@1 → n4 Append base=6@1 [7@1]
</a><a href="#h6-8-6" id="h6-8-6" class="i">+n1@1 → n5 Append base=6@1 [7@1]
</a><a href="#h6-8-7" id="h6-8-7" class="i">+n1@1 → n6 Append base=6@1 [7@1]
</a><a href="#h6-8-8" id="h6-8-8" class="i">+n2@1 → n1 AppendResponse reject_index=3
</a><a href="#h6-8-9" id="h6-8-9" class="i">+n3@1 → n1 AppendResponse reject_index=4
</a><a href="#h6-8-10" id="h6-8-10" class="i">+n4@1 → n1 AppendResponse reject_index=5
</a><a href="#h6-8-11" id="h6-8-11" class="i">+n5@1 → n1 AppendResponse reject_index=6
</a><a href="#h6-8-12" id="h6-8-12" class="i">+n6@1 append 7@1 put f=6
</a><a href="#h6-8-13" id="h6-8-13" class="i">+n6@1 → n1 AppendResponse match_index=7
</a> n1@1 → n2 Append base=2@1 [3@1 4@1 5@1 6@1 7@1]
 n1@1 → n3 Append base=3@1 [4@1 5@1 6@1 7@1]
 n1@1 → n4 Append base=4@1 [5@1 6@1 7@1]
 n1@1 → n5 Append base=5@1 [6@1 7@1]
<a href="#h6-8-18" id="h6-8-18" class="d">-n1@1 → n6 Append base=6@1 [7@1]
</a> n2@1 append 3@1 put b=2
 n2@1 append 4@1 put c=3
 n2@1 append 5@1 put d=4
 n2@1 append 6@1 put e=5
 n2@1 append 7@1 put f=6
<a href="#h6-8-24" id="h6-8-24" class="d">-n2@1 → n1 AppendResponse last=7@1 reject=0
</a><a href="#h6-8-25" id="h6-8-25" class="i">+n2@1 → n1 AppendResponse match_index=7
</a> n3@1 append 4@1 put c=3
 n3@1 append 5@1 put d=4
 n3@1 append 6@1 put e=5
 n3@1 append 7@1 put f=6
<a href="#h6-8-30" id="h6-8-30" class="d">-n3@1 → n1 AppendResponse last=7@1 reject=0
</a><a href="#h6-8-31" id="h6-8-31" class="i">+n3@1 → n1 AppendResponse match_index=7
</a> n4@1 append 5@1 put d=4
 n4@1 append 6@1 put e=5
 n4@1 append 7@1 put f=6
<a href="#h6-8-35" id="h6-8-35" class="d">-n4@1 → n1 AppendResponse last=7@1 reject=0
</a><a href="#h6-8-36" id="h6-8-36" class="i">+n4@1 → n1 AppendResponse match_index=7
</a> n5@1 append 6@1 put e=5
 n5@1 append 7@1 put f=6
<a href="#h6-8-39" id="h6-8-39" class="d">-n5@1 → n1 AppendResponse last=7@1 reject=0
</a><a href="#h6-8-40" id="h6-8-40" class="d">-n6@1 append 7@1 put f=6
</a><a href="#h6-8-41" id="h6-8-41" class="d">-n6@1 → n1 AppendResponse last=7@1 reject=0
</a><a href="#h6-8-42" id="h6-8-42" class="i">+n5@1 → n1 AppendResponse match_index=7
</a> n1@1 commit 5@1
 n1@1 apply 5@1 put d=4
 n1@1 → c1 ClientResponse id=0x04 write 0x0105
 c1@1 put d=4 ⇒ 5
<a href="#h6-8-47" id="h6-8-47" class="d">-n1@1 commit 6@1
</a><a href="#h6-8-48" id="h6-8-48" class="i">+n1@1 commit 7@1
</a> n1@1 apply 6@1 put e=5
<a href="#h6-8-50" id="h6-8-50" class="i">+n1@1 apply 7@1 put f=6
</a> n1@1 → c1 ClientResponse id=0x05 write 0x0106
 c1@1 put e=5 ⇒ 6
<a href="#h6-8-53" id="h6-8-53" class="d">-n1@1 commit 7@1
</a><a href="#h6-8-54" id="h6-8-54" class="d">-n1@1 apply 7@1 put f=6
</a> n1@1 → c1 ClientResponse id=0x06 write 0x0107
 c1@1 put f=6 ⇒ 7
 
<b>diff --git a/<a id="h7" href="../file/src/raft/testscripts/node/append_conflict_divergent.html">src/raft/testscripts/node/append_conflict_divergent</a> b/<a href="../file/src/raft/testscripts/node/append_conflict_divergent.html">src/raft/testscripts/node/append_conflict_divergent</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,238 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-# Appends with a divergent follower retries until it finds a commit base.
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-cluster nodes=5 leader=1
</a><a href="#h7-0-3" id="h7-0-3" class="d">----
</a><a href="#h7-0-4" id="h7-0-4" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h7-0-5" id="h7-0-5" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-6" id="h7-0-6" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-7" id="h7-0-7" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-8" id="h7-0-8" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-9" id="h7-0-9" class="d">-
</a><a href="#h7-0-10" id="h7-0-10" class="d">-# Partition n1-n2
</a><a href="#h7-0-11" id="h7-0-11" class="d">-partition 1 2
</a><a href="#h7-0-12" id="h7-0-12" class="d">----
</a><a href="#h7-0-13" id="h7-0-13" class="d">-n1 n2 ⇹ n3 n4 n5
</a><a href="#h7-0-14" id="h7-0-14" class="d">-
</a><a href="#h7-0-15" id="h7-0-15" class="d">-# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h7-0-16" id="h7-0-16" class="d">-(campaign 3)
</a><a href="#h7-0-17" id="h7-0-17" class="d">-(stabilize)
</a><a href="#h7-0-18" id="h7-0-18" class="d">-(put 3 a=1)
</a><a href="#h7-0-19" id="h7-0-19" class="d">-(stabilize heartbeat=true)
</a><a href="#h7-0-20" id="h7-0-20" class="d">-status
</a><a href="#h7-0-21" id="h7-0-21" class="d">----
</a><a href="#h7-0-22" id="h7-0-22" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h7-0-23" id="h7-0-23" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-24" id="h7-0-24" class="d">-n3@2 leader last=3@2 commit=3@2 apply=3 progress={1:0→2 2:0→2 4:3→4 5:3→4}
</a><a href="#h7-0-25" id="h7-0-25" class="d">-n4@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h7-0-26" id="h7-0-26" class="d">-n5@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h7-0-27" id="h7-0-27" class="d">-
</a><a href="#h7-0-28" id="h7-0-28" class="d">-(campaign 4)
</a><a href="#h7-0-29" id="h7-0-29" class="d">-(stabilize)
</a><a href="#h7-0-30" id="h7-0-30" class="d">-(put 4 b=2)
</a><a href="#h7-0-31" id="h7-0-31" class="d">-(stabilize heartbeat=true)
</a><a href="#h7-0-32" id="h7-0-32" class="d">-status
</a><a href="#h7-0-33" id="h7-0-33" class="d">----
</a><a href="#h7-0-34" id="h7-0-34" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h7-0-35" id="h7-0-35" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-36" id="h7-0-36" class="d">-n3@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h7-0-37" id="h7-0-37" class="d">-n4@3 leader last=5@3 commit=5@3 apply=5 progress={1:0→4 2:0→4 3:5→6 5:5→6}
</a><a href="#h7-0-38" id="h7-0-38" class="d">-n5@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h7-0-39" id="h7-0-39" class="d">-
</a><a href="#h7-0-40" id="h7-0-40" class="d">-(campaign 5)
</a><a href="#h7-0-41" id="h7-0-41" class="d">-(stabilize)
</a><a href="#h7-0-42" id="h7-0-42" class="d">-(put 5 c=3)
</a><a href="#h7-0-43" id="h7-0-43" class="d">-(stabilize heartbeat=true)
</a><a href="#h7-0-44" id="h7-0-44" class="d">-status
</a><a href="#h7-0-45" id="h7-0-45" class="d">----
</a><a href="#h7-0-46" id="h7-0-46" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h7-0-47" id="h7-0-47" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h7-0-48" id="h7-0-48" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-49" id="h7-0-49" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-50" id="h7-0-50" class="d">-n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→6 2:0→6 3:7→8 4:7→8}
</a><a href="#h7-0-51" id="h7-0-51" class="d">-
</a><a href="#h7-0-52" id="h7-0-52" class="d">-# Propose writes in the minority partition as well, to build up a log
</a><a href="#h7-0-53" id="h7-0-53" class="d">-# beyond the length of the majory log.
</a><a href="#h7-0-54" id="h7-0-54" class="d">-(put 1 a=1)
</a><a href="#h7-0-55" id="h7-0-55" class="d">-(put 1 a=2)
</a><a href="#h7-0-56" id="h7-0-56" class="d">-(put 1 a=3)
</a><a href="#h7-0-57" id="h7-0-57" class="d">-(put 1 a=4)
</a><a href="#h7-0-58" id="h7-0-58" class="d">-(put 1 a=5)
</a><a href="#h7-0-59" id="h7-0-59" class="d">-(put 1 a=6)
</a><a href="#h7-0-60" id="h7-0-60" class="d">-(put 1 a=7)
</a><a href="#h7-0-61" id="h7-0-61" class="d">-(put 1 a=8)
</a><a href="#h7-0-62" id="h7-0-62" class="d">-(put 1 a=9)
</a><a href="#h7-0-63" id="h7-0-63" class="d">-(stabilize)
</a><a href="#h7-0-64" id="h7-0-64" class="d">-status
</a><a href="#h7-0-65" id="h7-0-65" class="d">----
</a><a href="#h7-0-66" id="h7-0-66" class="d">-n1@1 leader last=10@1 commit=1@1 apply=1 progress={2:10→11 3:1→2 4:1→2 5:1→2}
</a><a href="#h7-0-67" id="h7-0-67" class="d">-n2@1 follower(n1) last=10@1 commit=1@1 apply=1
</a><a href="#h7-0-68" id="h7-0-68" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-69" id="h7-0-69" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-70" id="h7-0-70" class="d">-n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→6 2:0→6 3:7→8 4:7→8}
</a><a href="#h7-0-71" id="h7-0-71" class="d">-
</a><a href="#h7-0-72" id="h7-0-72" class="d">-log 1 5
</a><a href="#h7-0-73" id="h7-0-73" class="d">----
</a><a href="#h7-0-74" id="h7-0-74" class="d">-n1@1 last=10@1 commit=1@1
</a><a href="#h7-0-75" id="h7-0-75" class="d">-n1@1 entry 1@1 None
</a><a href="#h7-0-76" id="h7-0-76" class="d">-n1@1 entry 2@1 put a=1
</a><a href="#h7-0-77" id="h7-0-77" class="d">-n1@1 entry 3@1 put a=2
</a><a href="#h7-0-78" id="h7-0-78" class="d">-n1@1 entry 4@1 put a=3
</a><a href="#h7-0-79" id="h7-0-79" class="d">-n1@1 entry 5@1 put a=4
</a><a href="#h7-0-80" id="h7-0-80" class="d">-n1@1 entry 6@1 put a=5
</a><a href="#h7-0-81" id="h7-0-81" class="d">-n1@1 entry 7@1 put a=6
</a><a href="#h7-0-82" id="h7-0-82" class="d">-n1@1 entry 8@1 put a=7
</a><a href="#h7-0-83" id="h7-0-83" class="d">-n1@1 entry 9@1 put a=8
</a><a href="#h7-0-84" id="h7-0-84" class="d">-n1@1 entry 10@1 put a=9
</a><a href="#h7-0-85" id="h7-0-85" class="d">-n5@4 last=7@4 commit=7@4
</a><a href="#h7-0-86" id="h7-0-86" class="d">-n5@4 entry 1@1 None
</a><a href="#h7-0-87" id="h7-0-87" class="d">-n5@4 entry 2@2 None
</a><a href="#h7-0-88" id="h7-0-88" class="d">-n5@4 entry 3@2 put a=1
</a><a href="#h7-0-89" id="h7-0-89" class="d">-n5@4 entry 4@3 None
</a><a href="#h7-0-90" id="h7-0-90" class="d">-n5@4 entry 5@3 put b=2
</a><a href="#h7-0-91" id="h7-0-91" class="d">-n5@4 entry 6@4 None
</a><a href="#h7-0-92" id="h7-0-92" class="d">-n5@4 entry 7@4 put c=3
</a><a href="#h7-0-93" id="h7-0-93" class="d">-
</a><a href="#h7-0-94" id="h7-0-94" class="d">-# Heal the partition.
</a><a href="#h7-0-95" id="h7-0-95" class="d">-heal
</a><a href="#h7-0-96" id="h7-0-96" class="d">----
</a><a href="#h7-0-97" id="h7-0-97" class="d">-n1 n2 n3 n4 n5 fully connected
</a><a href="#h7-0-98" id="h7-0-98" class="d">-
</a><a href="#h7-0-99" id="h7-0-99" class="d">-# Propose another write on the majority leader.
</a><a href="#h7-0-100" id="h7-0-100" class="d">-put 5 d=4
</a><a href="#h7-0-101" id="h7-0-101" class="d">----
</a><a href="#h7-0-102" id="h7-0-102" class="d">-c5@4 → n5 ClientRequest id=0x0d write 0x0101640134
</a><a href="#h7-0-103" id="h7-0-103" class="d">-n5@4 append 8@4 put d=4
</a><a href="#h7-0-104" id="h7-0-104" class="d">-n5@4 → n1 Append base=5@3 [6@4 7@4 8@4]
</a><a href="#h7-0-105" id="h7-0-105" class="d">-n5@4 → n2 Append base=5@3 [6@4 7@4 8@4]
</a><a href="#h7-0-106" id="h7-0-106" class="d">-n5@4 → n3 Append base=7@4 [8@4]
</a><a href="#h7-0-107" id="h7-0-107" class="d">-n5@4 → n4 Append base=7@4 [8@4]
</a><a href="#h7-0-108" id="h7-0-108" class="d">-
</a><a href="#h7-0-109" id="h7-0-109" class="d">-# Delivering the appends to n1 and n2 should reject the appends. It also 
</a><a href="#h7-0-110" id="h7-0-110" class="d">-# cancels the write requests on n1.
</a><a href="#h7-0-111" id="h7-0-111" class="d">-deliver 1 2
</a><a href="#h7-0-112" id="h7-0-112" class="d">----
</a><a href="#h7-0-113" id="h7-0-113" class="d">-n1@1 leader ⇨ n1@4 follower(n5)
</a><a href="#h7-0-114" id="h7-0-114" class="d">-n1@1 → c1 ClientResponse id=0x04 Error::Abort
</a><a href="#h7-0-115" id="h7-0-115" class="d">-c1@1 put a=1 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-116" id="h7-0-116" class="d">-n1@1 → c1 ClientResponse id=0x05 Error::Abort
</a><a href="#h7-0-117" id="h7-0-117" class="d">-c1@1 put a=2 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-118" id="h7-0-118" class="d">-n1@1 → c1 ClientResponse id=0x06 Error::Abort
</a><a href="#h7-0-119" id="h7-0-119" class="d">-c1@1 put a=3 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-120" id="h7-0-120" class="d">-n1@1 → c1 ClientResponse id=0x07 Error::Abort
</a><a href="#h7-0-121" id="h7-0-121" class="d">-c1@1 put a=4 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-122" id="h7-0-122" class="d">-n1@1 → c1 ClientResponse id=0x08 Error::Abort
</a><a href="#h7-0-123" id="h7-0-123" class="d">-c1@1 put a=5 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-124" id="h7-0-124" class="d">-n1@1 → c1 ClientResponse id=0x09 Error::Abort
</a><a href="#h7-0-125" id="h7-0-125" class="d">-c1@1 put a=6 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-126" id="h7-0-126" class="d">-n1@1 → c1 ClientResponse id=0x0a Error::Abort
</a><a href="#h7-0-127" id="h7-0-127" class="d">-c1@1 put a=7 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-128" id="h7-0-128" class="d">-n1@1 → c1 ClientResponse id=0x0b Error::Abort
</a><a href="#h7-0-129" id="h7-0-129" class="d">-c1@1 put a=8 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-130" id="h7-0-130" class="d">-n1@1 → c1 ClientResponse id=0x0c Error::Abort
</a><a href="#h7-0-131" id="h7-0-131" class="d">-c1@1 put a=9 ⇒ Error::Abort (operation aborted)
</a><a href="#h7-0-132" id="h7-0-132" class="d">-n1@4 → n5 AppendResponse last=10@1 reject=5
</a><a href="#h7-0-133" id="h7-0-133" class="d">-n2@1 follower(n1) ⇨ n2@4 follower(n5)
</a><a href="#h7-0-134" id="h7-0-134" class="d">-n2@4 → n5 AppendResponse last=10@1 reject=5
</a><a href="#h7-0-135" id="h7-0-135" class="d">-
</a><a href="#h7-0-136" id="h7-0-136" class="d">-# n5 will send the previous entry, which is again rejected.
</a><a href="#h7-0-137" id="h7-0-137" class="d">-deliver 5
</a><a href="#h7-0-138" id="h7-0-138" class="d">-deliver 1 2
</a><a href="#h7-0-139" id="h7-0-139" class="d">-status 5
</a><a href="#h7-0-140" id="h7-0-140" class="d">----
</a><a href="#h7-0-141" id="h7-0-141" class="d">-n5@4 → n1 Append base=4@3 [5@3 6@4 7@4 8@4]
</a><a href="#h7-0-142" id="h7-0-142" class="d">-n5@4 → n2 Append base=4@3 [5@3 6@4 7@4 8@4]
</a><a href="#h7-0-143" id="h7-0-143" class="d">-n1@4 → n5 AppendResponse last=10@1 reject=4
</a><a href="#h7-0-144" id="h7-0-144" class="d">-n2@4 → n5 AppendResponse last=10@1 reject=4
</a><a href="#h7-0-145" id="h7-0-145" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→5 2:0→5 3:7→8 4:7→8}
</a><a href="#h7-0-146" id="h7-0-146" class="d">-
</a><a href="#h7-0-147" id="h7-0-147" class="d">-# This repeats until they find a common base at 1@1.
</a><a href="#h7-0-148" id="h7-0-148" class="d">-deliver 5
</a><a href="#h7-0-149" id="h7-0-149" class="d">-deliver 1 2
</a><a href="#h7-0-150" id="h7-0-150" class="d">-status 5
</a><a href="#h7-0-151" id="h7-0-151" class="d">----
</a><a href="#h7-0-152" id="h7-0-152" class="d">-n5@4 → n1 Append base=3@2 [4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-153" id="h7-0-153" class="d">-n5@4 → n2 Append base=3@2 [4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-154" id="h7-0-154" class="d">-n1@4 → n5 AppendResponse last=10@1 reject=3
</a><a href="#h7-0-155" id="h7-0-155" class="d">-n2@4 → n5 AppendResponse last=10@1 reject=3
</a><a href="#h7-0-156" id="h7-0-156" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→4 2:0→4 3:7→8 4:7→8}
</a><a href="#h7-0-157" id="h7-0-157" class="d">-
</a><a href="#h7-0-158" id="h7-0-158" class="d">-deliver 5
</a><a href="#h7-0-159" id="h7-0-159" class="d">-deliver 1 2
</a><a href="#h7-0-160" id="h7-0-160" class="d">-status 5
</a><a href="#h7-0-161" id="h7-0-161" class="d">----
</a><a href="#h7-0-162" id="h7-0-162" class="d">-n5@4 → n1 Append base=2@2 [3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-163" id="h7-0-163" class="d">-n5@4 → n2 Append base=2@2 [3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-164" id="h7-0-164" class="d">-n1@4 → n5 AppendResponse last=10@1 reject=2
</a><a href="#h7-0-165" id="h7-0-165" class="d">-n2@4 → n5 AppendResponse last=10@1 reject=2
</a><a href="#h7-0-166" id="h7-0-166" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→3 2:0→3 3:7→8 4:7→8}
</a><a href="#h7-0-167" id="h7-0-167" class="d">-
</a><a href="#h7-0-168" id="h7-0-168" class="d">-deliver 5
</a><a href="#h7-0-169" id="h7-0-169" class="d">-deliver 5
</a><a href="#h7-0-170" id="h7-0-170" class="d">-deliver 1 2
</a><a href="#h7-0-171" id="h7-0-171" class="d">-status 5
</a><a href="#h7-0-172" id="h7-0-172" class="d">----
</a><a href="#h7-0-173" id="h7-0-173" class="d">-n5@4 → n1 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-174" id="h7-0-174" class="d">-n5@4 → n2 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h7-0-175" id="h7-0-175" class="d">-n1@4 → n5 AppendResponse last=8@4 reject=0
</a><a href="#h7-0-176" id="h7-0-176" class="d">-n2@4 → n5 AppendResponse last=8@4 reject=0
</a><a href="#h7-0-177" id="h7-0-177" class="d">-n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→2 2:0→2 3:7→8 4:7→8}
</a><a href="#h7-0-178" id="h7-0-178" class="d">-
</a><a href="#h7-0-179" id="h7-0-179" class="d">-# The new write can now commit and apply.
</a><a href="#h7-0-180" id="h7-0-180" class="d">-deliver 5
</a><a href="#h7-0-181" id="h7-0-181" class="d">----
</a><a href="#h7-0-182" id="h7-0-182" class="d">-n5@4 commit 8@4
</a><a href="#h7-0-183" id="h7-0-183" class="d">-n5@4 apply 8@4 put d=4
</a><a href="#h7-0-184" id="h7-0-184" class="d">-n5@4 → c5 ClientResponse id=0x0d write 0x0108
</a><a href="#h7-0-185" id="h7-0-185" class="d">-c5@4 put d=4 ⇒ 8
</a><a href="#h7-0-186" id="h7-0-186" class="d">-
</a><a href="#h7-0-187" id="h7-0-187" class="d">-status
</a><a href="#h7-0-188" id="h7-0-188" class="d">----
</a><a href="#h7-0-189" id="h7-0-189" class="d">-n1@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h7-0-190" id="h7-0-190" class="d">-n2@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h7-0-191" id="h7-0-191" class="d">-n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-192" id="h7-0-192" class="d">-n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h7-0-193" id="h7-0-193" class="d">-n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:7→8 4:7→8}
</a><a href="#h7-0-194" id="h7-0-194" class="d">-
</a><a href="#h7-0-195" id="h7-0-195" class="d">-# A heartbeat brings the cluster into agreement.
</a><a href="#h7-0-196" id="h7-0-196" class="d">-stabilize heartbeat=true
</a><a href="#h7-0-197" id="h7-0-197" class="d">----
</a><a href="#h7-0-198" id="h7-0-198" class="d">-n3@4 append 8@4 put d=4
</a><a href="#h7-0-199" id="h7-0-199" class="d">-n3@4 → n5 AppendResponse last=8@4 reject=0
</a><a href="#h7-0-200" id="h7-0-200" class="d">-n4@4 append 8@4 put d=4
</a><a href="#h7-0-201" id="h7-0-201" class="d">-n4@4 → n5 AppendResponse last=8@4 reject=0
</a><a href="#h7-0-202" id="h7-0-202" class="d">-n5@4 → n1 Heartbeat commit=8@4 read_seq=0
</a><a href="#h7-0-203" id="h7-0-203" class="d">-n5@4 → n2 Heartbeat commit=8@4 read_seq=0
</a><a href="#h7-0-204" id="h7-0-204" class="d">-n5@4 → n3 Heartbeat commit=8@4 read_seq=0
</a><a href="#h7-0-205" id="h7-0-205" class="d">-n5@4 → n4 Heartbeat commit=8@4 read_seq=0
</a><a href="#h7-0-206" id="h7-0-206" class="d">-n1@4 commit 8@4
</a><a href="#h7-0-207" id="h7-0-207" class="d">-n1@4 apply 2@2 None
</a><a href="#h7-0-208" id="h7-0-208" class="d">-n1@4 apply 3@2 put a=1
</a><a href="#h7-0-209" id="h7-0-209" class="d">-n1@4 apply 4@3 None
</a><a href="#h7-0-210" id="h7-0-210" class="d">-n1@4 apply 5@3 put b=2
</a><a href="#h7-0-211" id="h7-0-211" class="d">-n1@4 apply 6@4 None
</a><a href="#h7-0-212" id="h7-0-212" class="d">-n1@4 apply 7@4 put c=3
</a><a href="#h7-0-213" id="h7-0-213" class="d">-n1@4 apply 8@4 put d=4
</a><a href="#h7-0-214" id="h7-0-214" class="d">-n1@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h7-0-215" id="h7-0-215" class="d">-n2@4 commit 8@4
</a><a href="#h7-0-216" id="h7-0-216" class="d">-n2@4 apply 2@2 None
</a><a href="#h7-0-217" id="h7-0-217" class="d">-n2@4 apply 3@2 put a=1
</a><a href="#h7-0-218" id="h7-0-218" class="d">-n2@4 apply 4@3 None
</a><a href="#h7-0-219" id="h7-0-219" class="d">-n2@4 apply 5@3 put b=2
</a><a href="#h7-0-220" id="h7-0-220" class="d">-n2@4 apply 6@4 None
</a><a href="#h7-0-221" id="h7-0-221" class="d">-n2@4 apply 7@4 put c=3
</a><a href="#h7-0-222" id="h7-0-222" class="d">-n2@4 apply 8@4 put d=4
</a><a href="#h7-0-223" id="h7-0-223" class="d">-n2@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h7-0-224" id="h7-0-224" class="d">-n3@4 commit 8@4
</a><a href="#h7-0-225" id="h7-0-225" class="d">-n3@4 apply 8@4 put d=4
</a><a href="#h7-0-226" id="h7-0-226" class="d">-n3@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h7-0-227" id="h7-0-227" class="d">-n4@4 commit 8@4
</a><a href="#h7-0-228" id="h7-0-228" class="d">-n4@4 apply 8@4 put d=4
</a><a href="#h7-0-229" id="h7-0-229" class="d">-n4@4 → n5 HeartbeatResponse last=8@4 read_seq=0
</a><a href="#h7-0-230" id="h7-0-230" class="d">-
</a><a href="#h7-0-231" id="h7-0-231" class="d">-status
</a><a href="#h7-0-232" id="h7-0-232" class="d">----
</a><a href="#h7-0-233" id="h7-0-233" class="d">-n1@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h7-0-234" id="h7-0-234" class="d">-n2@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h7-0-235" id="h7-0-235" class="d">-n3@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h7-0-236" id="h7-0-236" class="d">-n4@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h7-0-237" id="h7-0-237" class="d">-n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:8→9 4:8→9}
</a><b>diff --git a/<a id="h8" href="../file/src/raft/testscripts/node/append_conflict_replace_term.html">src/raft/testscripts/node/append_conflict_replace_term</a> b/<a href="../file/src/raft/testscripts/node/append_conflict_replace_term.html">src/raft/testscripts/node/append_conflict_replace_term</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,103 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-# An append replaces a conflict at the tail for a single term.
</a><a href="#h8-0-1" id="h8-0-1" class="d">-
</a><a href="#h8-0-2" id="h8-0-2" class="d">-cluster nodes=5 leader=1
</a><a href="#h8-0-3" id="h8-0-3" class="d">----
</a><a href="#h8-0-4" id="h8-0-4" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h8-0-5" id="h8-0-5" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-6" id="h8-0-6" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-7" id="h8-0-7" class="d">-n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-8" id="h8-0-8" class="d">-n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h8-0-9" id="h8-0-9" class="d">-
</a><a href="#h8-0-10" id="h8-0-10" class="d">-# Partition n3-n5.
</a><a href="#h8-0-11" id="h8-0-11" class="d">-partition 3 4 5
</a><a href="#h8-0-12" id="h8-0-12" class="d">----
</a><a href="#h8-0-13" id="h8-0-13" class="d">-n1 n2 ⇹ n3 n4 n5
</a><a href="#h8-0-14" id="h8-0-14" class="d">-
</a><a href="#h8-0-15" id="h8-0-15" class="d">-# Propose and replicate a write to n2.
</a><a href="#h8-0-16" id="h8-0-16" class="d">-put 1 a=1
</a><a href="#h8-0-17" id="h8-0-17" class="d">-stabilize
</a><a href="#h8-0-18" id="h8-0-18" class="d">----
</a><a href="#h8-0-19" id="h8-0-19" class="d">-c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h8-0-20" id="h8-0-20" class="d">-n1@1 append 2@1 put a=1
</a><a href="#h8-0-21" id="h8-0-21" class="d">-n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h8-0-22" id="h8-0-22" class="d">-n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h8-0-23" id="h8-0-23" class="d">-n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h8-0-24" id="h8-0-24" class="d">-n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h8-0-25" id="h8-0-25" class="d">-n2@1 append 2@1 put a=1
</a><a href="#h8-0-26" id="h8-0-26" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h8-0-27" id="h8-0-27" class="d">-
</a><a href="#h8-0-28" id="h8-0-28" class="d">-log 1 2
</a><a href="#h8-0-29" id="h8-0-29" class="d">----
</a><a href="#h8-0-30" id="h8-0-30" class="d">-n1@1 last=2@1 commit=1@1
</a><a href="#h8-0-31" id="h8-0-31" class="d">-n1@1 entry 1@1 None
</a><a href="#h8-0-32" id="h8-0-32" class="d">-n1@1 entry 2@1 put a=1
</a><a href="#h8-0-33" id="h8-0-33" class="d">-n2@1 last=2@1 commit=1@1
</a><a href="#h8-0-34" id="h8-0-34" class="d">-n2@1 entry 1@1 None
</a><a href="#h8-0-35" id="h8-0-35" class="d">-n2@1 entry 2@1 put a=1
</a><a href="#h8-0-36" id="h8-0-36" class="d">-
</a><a href="#h8-0-37" id="h8-0-37" class="d">-# Elect n5 as a new leader while partitioned.
</a><a href="#h8-0-38" id="h8-0-38" class="d">-(campaign 5)
</a><a href="#h8-0-39" id="h8-0-39" class="d">-(stabilize)
</a><a href="#h8-0-40" id="h8-0-40" class="d">-status
</a><a href="#h8-0-41" id="h8-0-41" class="d">----
</a><a href="#h8-0-42" id="h8-0-42" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h8-0-43" id="h8-0-43" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h8-0-44" id="h8-0-44" class="d">-n3@2 follower(n5) last=2@2 commit=1@1 apply=1
</a><a href="#h8-0-45" id="h8-0-45" class="d">-n4@2 follower(n5) last=2@2 commit=1@1 apply=1
</a><a href="#h8-0-46" id="h8-0-46" class="d">-n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:0→2 2:0→2 3:2→3 4:2→3}
</a><a href="#h8-0-47" id="h8-0-47" class="d">-
</a><a href="#h8-0-48" id="h8-0-48" class="d">-# Replicate a write via n5.
</a><a href="#h8-0-49" id="h8-0-49" class="d">-(put 5 b=2)
</a><a href="#h8-0-50" id="h8-0-50" class="d">-(stabilize)
</a><a href="#h8-0-51" id="h8-0-51" class="d">-status
</a><a href="#h8-0-52" id="h8-0-52" class="d">----
</a><a href="#h8-0-53" id="h8-0-53" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h8-0-54" id="h8-0-54" class="d">-n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h8-0-55" id="h8-0-55" class="d">-n3@2 follower(n5) last=3@2 commit=1@1 apply=1
</a><a href="#h8-0-56" id="h8-0-56" class="d">-n4@2 follower(n5) last=3@2 commit=1@1 apply=1
</a><a href="#h8-0-57" id="h8-0-57" class="d">-n5@2 leader last=3@2 commit=3@2 apply=3 progress={1:0→2 2:0→2 3:3→4 4:3→4}
</a><a href="#h8-0-58" id="h8-0-58" class="d">-
</a><a href="#h8-0-59" id="h8-0-59" class="d">-# Heal the partition, and submit another write on n5. This will attempt to
</a><a href="#h8-0-60" id="h8-0-60" class="d">-# replicate the tail 2-4 to n1,n2.
</a><a href="#h8-0-61" id="h8-0-61" class="d">-#
</a><a href="#h8-0-62" id="h8-0-62" class="d">-# TODO: to avoid quadratic behavior, this should only attempt to replicate the
</a><a href="#h8-0-63" id="h8-0-63" class="d">-# single appended entry (if it matches the follower&#39;s next index) instead of all
</a><a href="#h8-0-64" id="h8-0-64" class="d">-# entries from next up to it.
</a><a href="#h8-0-65" id="h8-0-65" class="d">-heal
</a><a href="#h8-0-66" id="h8-0-66" class="d">-put 5 c=3
</a><a href="#h8-0-67" id="h8-0-67" class="d">----
</a><a href="#h8-0-68" id="h8-0-68" class="d">-n1 n2 n3 n4 n5 fully connected
</a><a href="#h8-0-69" id="h8-0-69" class="d">-c5@2 → n5 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h8-0-70" id="h8-0-70" class="d">-n5@2 append 4@2 put c=3
</a><a href="#h8-0-71" id="h8-0-71" class="d">-n5@2 → n1 Append base=1@1 [2@2 3@2 4@2]
</a><a href="#h8-0-72" id="h8-0-72" class="d">-n5@2 → n2 Append base=1@1 [2@2 3@2 4@2]
</a><a href="#h8-0-73" id="h8-0-73" class="d">-n5@2 → n3 Append base=3@2 [4@2]
</a><a href="#h8-0-74" id="h8-0-74" class="d">-n5@2 → n4 Append base=3@2 [4@2]
</a><a href="#h8-0-75" id="h8-0-75" class="d">-
</a><a href="#h8-0-76" id="h8-0-76" class="d">-# Delivering the append messages to n1,n2 will make them follow n5 and
</a><a href="#h8-0-77" id="h8-0-77" class="d">-# replace the tail of the logs with n5&#39;s log.
</a><a href="#h8-0-78" id="h8-0-78" class="d">-deliver 1 2
</a><a href="#h8-0-79" id="h8-0-79" class="d">----
</a><a href="#h8-0-80" id="h8-0-80" class="d">-n1@1 leader ⇨ n1@2 follower(n5)
</a><a href="#h8-0-81" id="h8-0-81" class="d">-n1@2 append 3@2 put b=2
</a><a href="#h8-0-82" id="h8-0-82" class="d">-n1@2 append 4@2 put c=3
</a><a href="#h8-0-83" id="h8-0-83" class="d">-n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h8-0-84" id="h8-0-84" class="d">-c1@1 put a=1 ⇒ Error::Abort (operation aborted)
</a><a href="#h8-0-85" id="h8-0-85" class="d">-n1@2 → n5 AppendResponse last=4@2 reject=0
</a><a href="#h8-0-86" id="h8-0-86" class="d">-n2@1 follower(n1) ⇨ n2@2 follower(n5)
</a><a href="#h8-0-87" id="h8-0-87" class="d">-n2@2 append 3@2 put b=2
</a><a href="#h8-0-88" id="h8-0-88" class="d">-n2@2 append 4@2 put c=3
</a><a href="#h8-0-89" id="h8-0-89" class="d">-n2@2 → n5 AppendResponse last=4@2 reject=0
</a><a href="#h8-0-90" id="h8-0-90" class="d">-
</a><a href="#h8-0-91" id="h8-0-91" class="d">-log 1 2
</a><a href="#h8-0-92" id="h8-0-92" class="d">----
</a><a href="#h8-0-93" id="h8-0-93" class="d">-n1@2 last=4@2 commit=1@1
</a><a href="#h8-0-94" id="h8-0-94" class="d">-n1@2 entry 1@1 None
</a><a href="#h8-0-95" id="h8-0-95" class="d">-n1@2 entry 2@2 None
</a><a href="#h8-0-96" id="h8-0-96" class="d">-n1@2 entry 3@2 put b=2
</a><a href="#h8-0-97" id="h8-0-97" class="d">-n1@2 entry 4@2 put c=3
</a><a href="#h8-0-98" id="h8-0-98" class="d">-n2@2 last=4@2 commit=1@1
</a><a href="#h8-0-99" id="h8-0-99" class="d">-n2@2 entry 1@1 None
</a><a href="#h8-0-100" id="h8-0-100" class="d">-n2@2 entry 2@2 None
</a><a href="#h8-0-101" id="h8-0-101" class="d">-n2@2 entry 3@2 put b=2
</a><a href="#h8-0-102" id="h8-0-102" class="d">-n2@2 entry 4@2 put c=3
</a><b>diff --git a/<a id="h9" href="../file/src/raft/testscripts/node/append_initial.html">src/raft/testscripts/node/append_initial</a> b/<a href="../file/src/raft/testscripts/node/append_initial.html">src/raft/testscripts/node/append_initial</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -28,18 +28,18 @@ n1@1 candidate ⇨ n1@1 leader
</a> n1@1 append 1@1 None
 n1@1 → n2 Append base=0@0 [1@1]
 n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶0̶@̶0̶ ̶[̶1̶@̶1̶]̶
<a href="#h9-0-3" id="h9-0-3" class="d">-n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h9-0-4" id="h9-0-4" class="d">-n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶0̶@̶0̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h9-0-5" id="h9-0-5" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h9-0-6" id="h9-0-6" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶1̶ ̶c̶o̶m̶m̶i̶t̶=̶0̶@̶0̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a> n2@1 follower() ⇨ n2@1 follower(n1)
 n2@1 append 1@1 None
<a href="#h9-0-9" id="h9-0-9" class="d">-n2@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h9-0-10" id="h9-0-10" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h9-0-11" id="h9-0-11" class="i">+n2@1 → n1 AppendResponse match_index=1
</a><a href="#h9-0-12" id="h9-0-12" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n1@1 commit 1@1
 n1@1 apply 1@1 None
 
 status
 ---
<a href="#h9-0-18" id="h9-0-18" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h9-0-19" id="h9-0-19" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→2}
</a> n2@1 follower(n1) last=1@1 commit=0@0 apply=0
 n3@0 follower() last=0@0 commit=0@0 apply=0
 
<a href="#h9-1" id="h9-1" class="h">@@ -48,26 +48,36 @@ heal
</a> ---
 n1 n2 n3 fully connected
 
<a href="#h9-1-3" id="h9-1-3" class="d">-# Propose a write. This appends entry 2 to n2 at base 1, and entries 1-2 to n3 at base 0.
</a><a href="#h9-1-4" id="h9-1-4" class="i">+# Propose a write. This appends entry 2 to n2 at base 1, but is rejected by n3
</a><a href="#h9-1-5" id="h9-1-5" class="i">+# which doesn&#39;t have entry 1.
</a> put 1 foo=bar
<a href="#h9-1-7" id="h9-1-7" class="i">+deliver
</a> ---
 c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
 n1@1 append 2@1 put foo=bar
 n1@1 → n2 Append base=1@1 [2@1]
<a href="#h9-1-12" id="h9-1-12" class="d">-n1@1 → n3 Append base=0@0 [1@1 2@1]
</a><a href="#h9-1-13" id="h9-1-13" class="d">-
</a><a href="#h9-1-14" id="h9-1-14" class="d">-deliver
</a><a href="#h9-1-15" id="h9-1-15" class="d">----
</a><a href="#h9-1-16" id="h9-1-16" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a> n2@1 append 2@1 put foo=bar
<a href="#h9-1-18" id="h9-1-18" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h9-1-19" id="h9-1-19" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> n3@0 follower() ⇨ n3@1 follower(n1)
<a href="#h9-1-21" id="h9-1-21" class="i">+n3@1 → n1 AppendResponse reject_index=1
</a><a href="#h9-1-22" id="h9-1-22" class="i">+
</a><a href="#h9-1-23" id="h9-1-23" class="i">+# Since n3 rejected base 1, n1 sends an append with all messages, which
</a><a href="#h9-1-24" id="h9-1-24" class="i">+# is accepted.
</a><a href="#h9-1-25" id="h9-1-25" class="i">+stabilize
</a><a href="#h9-1-26" id="h9-1-26" class="i">+---
</a><a href="#h9-1-27" id="h9-1-27" class="i">+n1@1 commit 2@1
</a><a href="#h9-1-28" id="h9-1-28" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h9-1-29" id="h9-1-29" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h9-1-30" id="h9-1-30" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h9-1-31" id="h9-1-31" class="i">+n1@1 → n3 Append base=0@0 [1@1 2@1]
</a> n3@1 append 1@1 None
 n3@1 append 2@1 put foo=bar
<a href="#h9-1-34" id="h9-1-34" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h9-1-35" id="h9-1-35" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> 
 log
 ---
<a href="#h9-1-39" id="h9-1-39" class="d">-n1@1 last=2@1 commit=1@1
</a><a href="#h9-1-40" id="h9-1-40" class="i">+n1@1 last=2@1 commit=2@1
</a> n1@1 entry 1@1 None
 n1@1 entry 2@1 put foo=bar
 n2@1 last=2@1 commit=0@0
<b>diff --git a/<a id="h10" href="../file/src/raft/testscripts/node/append_max_entries.html">src/raft/testscripts/node/append_max_entries</a> b/<a href="../file/src/raft/testscripts/node/append_max_entries.html">src/raft/testscripts/node/append_max_entries</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,66 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+# Large appends are limited to MAX_APPEND_ENTRIES, and each successful append
</a><a href="#h10-0-1" id="h10-0-1" class="i">+# triggers the next append batch.
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+cluster nodes=3 leader=1 max_append_entries=2
</a><a href="#h10-0-4" id="h10-0-4" class="i">+---
</a><a href="#h10-0-5" id="h10-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h10-0-6" id="h10-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-7" id="h10-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-8" id="h10-0-8" class="i">+
</a><a href="#h10-0-9" id="h10-0-9" class="i">+# Partition n3.
</a><a href="#h10-0-10" id="h10-0-10" class="i">+partition 3
</a><a href="#h10-0-11" id="h10-0-11" class="i">+---
</a><a href="#h10-0-12" id="h10-0-12" class="i">+n3 ⇹ n1 n2
</a><a href="#h10-0-13" id="h10-0-13" class="i">+
</a><a href="#h10-0-14" id="h10-0-14" class="i">+# Make a bunch of writes.
</a><a href="#h10-0-15" id="h10-0-15" class="i">+(put 1 a=1)
</a><a href="#h10-0-16" id="h10-0-16" class="i">+(put 1 a=2)
</a><a href="#h10-0-17" id="h10-0-17" class="i">+(put 1 a=3)
</a><a href="#h10-0-18" id="h10-0-18" class="i">+(put 1 a=4)
</a><a href="#h10-0-19" id="h10-0-19" class="i">+(put 1 a=5)
</a><a href="#h10-0-20" id="h10-0-20" class="i">+(put 1 a=6)
</a><a href="#h10-0-21" id="h10-0-21" class="i">+(put 1 a=7)
</a><a href="#h10-0-22" id="h10-0-22" class="i">+(stabilize heartbeat=true)
</a><a href="#h10-0-23" id="h10-0-23" class="i">+status
</a><a href="#h10-0-24" id="h10-0-24" class="i">+---
</a><a href="#h10-0-25" id="h10-0-25" class="i">+n1@1 leader last=8@1 commit=8@1 apply=8 progress={2:8→9 3:1→9}
</a><a href="#h10-0-26" id="h10-0-26" class="i">+n2@1 follower(n1) last=8@1 commit=8@1 apply=8
</a><a href="#h10-0-27" id="h10-0-27" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h10-0-28" id="h10-0-28" class="i">+
</a><a href="#h10-0-29" id="h10-0-29" class="i">+# Heal the partition.
</a><a href="#h10-0-30" id="h10-0-30" class="i">+heal
</a><a href="#h10-0-31" id="h10-0-31" class="i">+---
</a><a href="#h10-0-32" id="h10-0-32" class="i">+n1 n2 n3 fully connected
</a><a href="#h10-0-33" id="h10-0-33" class="i">+
</a><a href="#h10-0-34" id="h10-0-34" class="i">+# The next heartbeat triggers a probe.
</a><a href="#h10-0-35" id="h10-0-35" class="i">+heartbeat 1
</a><a href="#h10-0-36" id="h10-0-36" class="i">+deliver
</a><a href="#h10-0-37" id="h10-0-37" class="i">+deliver
</a><a href="#h10-0-38" id="h10-0-38" class="i">+deliver
</a><a href="#h10-0-39" id="h10-0-39" class="i">+---
</a><a href="#h10-0-40" id="h10-0-40" class="i">+n1@1 → n2 Heartbeat last_index=8 commit=8@1 read_seq=0
</a><a href="#h10-0-41" id="h10-0-41" class="i">+n1@1 → n3 Heartbeat last_index=8 commit=8@1 read_seq=0
</a><a href="#h10-0-42" id="h10-0-42" class="i">+n2@1 → n1 HeartbeatResponse match_index=8 read_seq=0
</a><a href="#h10-0-43" id="h10-0-43" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h10-0-44" id="h10-0-44" class="i">+n1@1 → n3 Append base=7@1 []
</a><a href="#h10-0-45" id="h10-0-45" class="i">+n3@1 → n1 AppendResponse reject_index=2
</a><a href="#h10-0-46" id="h10-0-46" class="i">+
</a><a href="#h10-0-47" id="h10-0-47" class="i">+# When the leader receives the probe response, it begins appending in batches of
</a><a href="#h10-0-48" id="h10-0-48" class="i">+# max_append_entries until the follower is caught up.
</a><a href="#h10-0-49" id="h10-0-49" class="i">+stabilize
</a><a href="#h10-0-50" id="h10-0-50" class="i">+---
</a><a href="#h10-0-51" id="h10-0-51" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1]
</a><a href="#h10-0-52" id="h10-0-52" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h10-0-53" id="h10-0-53" class="i">+n3@1 append 3@1 put a=2
</a><a href="#h10-0-54" id="h10-0-54" class="i">+n3@1 → n1 AppendResponse match_index=3
</a><a href="#h10-0-55" id="h10-0-55" class="i">+n1@1 → n3 Append base=3@1 [4@1 5@1]
</a><a href="#h10-0-56" id="h10-0-56" class="i">+n3@1 append 4@1 put a=3
</a><a href="#h10-0-57" id="h10-0-57" class="i">+n3@1 append 5@1 put a=4
</a><a href="#h10-0-58" id="h10-0-58" class="i">+n3@1 → n1 AppendResponse match_index=5
</a><a href="#h10-0-59" id="h10-0-59" class="i">+n1@1 → n3 Append base=5@1 [6@1 7@1]
</a><a href="#h10-0-60" id="h10-0-60" class="i">+n3@1 append 6@1 put a=5
</a><a href="#h10-0-61" id="h10-0-61" class="i">+n3@1 append 7@1 put a=6
</a><a href="#h10-0-62" id="h10-0-62" class="i">+n3@1 → n1 AppendResponse match_index=7
</a><a href="#h10-0-63" id="h10-0-63" class="i">+n1@1 → n3 Append base=7@1 [8@1]
</a><a href="#h10-0-64" id="h10-0-64" class="i">+n3@1 append 8@1 put a=7
</a><a href="#h10-0-65" id="h10-0-65" class="i">+n3@1 → n1 AppendResponse match_index=8
</a><b>diff --git a/<a id="h11" href="../file/src/raft/testscripts/node/append_overlap.html">src/raft/testscripts/node/append_overlap</a> b/<a href="../file/src/raft/testscripts/node/append_overlap.html">src/raft/testscripts/node/append_overlap</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -1,60 +0,0 @@
</a><a href="#h11-0-0" id="h11-0-0" class="d">-# Overlapping entries are appended just fine.
</a><a href="#h11-0-1" id="h11-0-1" class="d">-
</a><a href="#h11-0-2" id="h11-0-2" class="d">-cluster nodes=3 leader=1
</a><a href="#h11-0-3" id="h11-0-3" class="d">----
</a><a href="#h11-0-4" id="h11-0-4" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h11-0-5" id="h11-0-5" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-6" id="h11-0-6" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h11-0-7" id="h11-0-7" class="d">-
</a><a href="#h11-0-8" id="h11-0-8" class="d">-# Propose three writes before the acks are received. This emits duplicate,
</a><a href="#h11-0-9" id="h11-0-9" class="d">-# overlapping entries in successive messages, which should all be accepted.
</a><a href="#h11-0-10" id="h11-0-10" class="d">-put 1 a=1
</a><a href="#h11-0-11" id="h11-0-11" class="d">-deliver 2 3
</a><a href="#h11-0-12" id="h11-0-12" class="d">----
</a><a href="#h11-0-13" id="h11-0-13" class="d">-c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h11-0-14" id="h11-0-14" class="d">-n1@1 append 2@1 put a=1
</a><a href="#h11-0-15" id="h11-0-15" class="d">-n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h11-0-16" id="h11-0-16" class="d">-n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h11-0-17" id="h11-0-17" class="d">-n2@1 append 2@1 put a=1
</a><a href="#h11-0-18" id="h11-0-18" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h11-0-19" id="h11-0-19" class="d">-n3@1 append 2@1 put a=1
</a><a href="#h11-0-20" id="h11-0-20" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h11-0-21" id="h11-0-21" class="d">-
</a><a href="#h11-0-22" id="h11-0-22" class="d">-put 1 b=2
</a><a href="#h11-0-23" id="h11-0-23" class="d">-deliver 2 3
</a><a href="#h11-0-24" id="h11-0-24" class="d">----
</a><a href="#h11-0-25" id="h11-0-25" class="d">-c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h11-0-26" id="h11-0-26" class="d">-n1@1 append 3@1 put b=2
</a><a href="#h11-0-27" id="h11-0-27" class="d">-n1@1 → n2 Append base=1@1 [2@1 3@1]
</a><a href="#h11-0-28" id="h11-0-28" class="d">-n1@1 → n3 Append base=1@1 [2@1 3@1]
</a><a href="#h11-0-29" id="h11-0-29" class="d">-n2@1 append 3@1 put b=2
</a><a href="#h11-0-30" id="h11-0-30" class="d">-n2@1 → n1 AppendResponse last=3@1 reject=0
</a><a href="#h11-0-31" id="h11-0-31" class="d">-n3@1 append 3@1 put b=2
</a><a href="#h11-0-32" id="h11-0-32" class="d">-n3@1 → n1 AppendResponse last=3@1 reject=0
</a><a href="#h11-0-33" id="h11-0-33" class="d">-
</a><a href="#h11-0-34" id="h11-0-34" class="d">-put 1 c=3
</a><a href="#h11-0-35" id="h11-0-35" class="d">-deliver 2 3
</a><a href="#h11-0-36" id="h11-0-36" class="d">----
</a><a href="#h11-0-37" id="h11-0-37" class="d">-c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h11-0-38" id="h11-0-38" class="d">-n1@1 append 4@1 put c=3
</a><a href="#h11-0-39" id="h11-0-39" class="d">-n1@1 → n2 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h11-0-40" id="h11-0-40" class="d">-n1@1 → n3 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h11-0-41" id="h11-0-41" class="d">-n2@1 append 4@1 put c=3
</a><a href="#h11-0-42" id="h11-0-42" class="d">-n2@1 → n1 AppendResponse last=4@1 reject=0
</a><a href="#h11-0-43" id="h11-0-43" class="d">-n3@1 append 4@1 put c=3
</a><a href="#h11-0-44" id="h11-0-44" class="d">-n3@1 → n1 AppendResponse last=4@1 reject=0
</a><a href="#h11-0-45" id="h11-0-45" class="d">-
</a><a href="#h11-0-46" id="h11-0-46" class="d">-stabilize
</a><a href="#h11-0-47" id="h11-0-47" class="d">----
</a><a href="#h11-0-48" id="h11-0-48" class="d">-n1@1 commit 2@1
</a><a href="#h11-0-49" id="h11-0-49" class="d">-n1@1 apply 2@1 put a=1
</a><a href="#h11-0-50" id="h11-0-50" class="d">-n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h11-0-51" id="h11-0-51" class="d">-c1@1 put a=1 ⇒ 2
</a><a href="#h11-0-52" id="h11-0-52" class="d">-n1@1 commit 3@1
</a><a href="#h11-0-53" id="h11-0-53" class="d">-n1@1 apply 3@1 put b=2
</a><a href="#h11-0-54" id="h11-0-54" class="d">-n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h11-0-55" id="h11-0-55" class="d">-c1@1 put b=2 ⇒ 3
</a><a href="#h11-0-56" id="h11-0-56" class="d">-n1@1 commit 4@1
</a><a href="#h11-0-57" id="h11-0-57" class="d">-n1@1 apply 4@1 put c=3
</a><a href="#h11-0-58" id="h11-0-58" class="d">-n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h11-0-59" id="h11-0-59" class="d">-c1@1 put c=3 ⇒ 4
</a><b>diff --git a/<a id="h12" href="../file/src/raft/testscripts/node/append_pipeline.html">src/raft/testscripts/node/append_pipeline</a> b/<a href="../file/src/raft/testscripts/node/append_pipeline.html">src/raft/testscripts/node/append_pipeline</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,82 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+# Multiple appends are pipelined before acks are received, without
</a><a href="#h12-0-1" id="h12-0-1" class="i">+# retransmitting the unacked entries.
</a><a href="#h12-0-2" id="h12-0-2" class="i">+
</a><a href="#h12-0-3" id="h12-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h12-0-4" id="h12-0-4" class="i">+---
</a><a href="#h12-0-5" id="h12-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h12-0-6" id="h12-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-7" id="h12-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-8" id="h12-0-8" class="i">+
</a><a href="#h12-0-9" id="h12-0-9" class="i">+# Propose a single write. The progress next index increases to 3.
</a><a href="#h12-0-10" id="h12-0-10" class="i">+put 1 a=1
</a><a href="#h12-0-11" id="h12-0-11" class="i">+---
</a><a href="#h12-0-12" id="h12-0-12" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h12-0-13" id="h12-0-13" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h12-0-14" id="h12-0-14" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h12-0-15" id="h12-0-15" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h12-0-16" id="h12-0-16" class="i">+
</a><a href="#h12-0-17" id="h12-0-17" class="i">+status
</a><a href="#h12-0-18" id="h12-0-18" class="i">+---
</a><a href="#h12-0-19" id="h12-0-19" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:1→3 3:1→3}
</a><a href="#h12-0-20" id="h12-0-20" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-21" id="h12-0-21" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-22" id="h12-0-22" class="i">+
</a><a href="#h12-0-23" id="h12-0-23" class="i">+# Propose two more writes. Appends are sent without past duplicates.
</a><a href="#h12-0-24" id="h12-0-24" class="i">+put 1 b=2
</a><a href="#h12-0-25" id="h12-0-25" class="i">+put 1 c=3
</a><a href="#h12-0-26" id="h12-0-26" class="i">+---
</a><a href="#h12-0-27" id="h12-0-27" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h12-0-28" id="h12-0-28" class="i">+n1@1 append 3@1 put b=2
</a><a href="#h12-0-29" id="h12-0-29" class="i">+n1@1 → n2 Append base=2@1 [3@1]
</a><a href="#h12-0-30" id="h12-0-30" class="i">+n1@1 → n3 Append base=2@1 [3@1]
</a><a href="#h12-0-31" id="h12-0-31" class="i">+c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h12-0-32" id="h12-0-32" class="i">+n1@1 append 4@1 put c=3
</a><a href="#h12-0-33" id="h12-0-33" class="i">+n1@1 → n2 Append base=3@1 [4@1]
</a><a href="#h12-0-34" id="h12-0-34" class="i">+n1@1 → n3 Append base=3@1 [4@1]
</a><a href="#h12-0-35" id="h12-0-35" class="i">+
</a><a href="#h12-0-36" id="h12-0-36" class="i">+status
</a><a href="#h12-0-37" id="h12-0-37" class="i">+---
</a><a href="#h12-0-38" id="h12-0-38" class="i">+n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:1→5 3:1→5}
</a><a href="#h12-0-39" id="h12-0-39" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-40" id="h12-0-40" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h12-0-41" id="h12-0-41" class="i">+
</a><a href="#h12-0-42" id="h12-0-42" class="i">+# The appends are received and acked sequentially.
</a><a href="#h12-0-43" id="h12-0-43" class="i">+deliver
</a><a href="#h12-0-44" id="h12-0-44" class="i">+---
</a><a href="#h12-0-45" id="h12-0-45" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h12-0-46" id="h12-0-46" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h12-0-47" id="h12-0-47" class="i">+n2@1 append 3@1 put b=2
</a><a href="#h12-0-48" id="h12-0-48" class="i">+n2@1 → n1 AppendResponse match_index=3
</a><a href="#h12-0-49" id="h12-0-49" class="i">+n2@1 append 4@1 put c=3
</a><a href="#h12-0-50" id="h12-0-50" class="i">+n2@1 → n1 AppendResponse match_index=4
</a><a href="#h12-0-51" id="h12-0-51" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h12-0-52" id="h12-0-52" class="i">+n3@1 → n1 AppendResponse match_index=2
</a><a href="#h12-0-53" id="h12-0-53" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h12-0-54" id="h12-0-54" class="i">+n3@1 → n1 AppendResponse match_index=3
</a><a href="#h12-0-55" id="h12-0-55" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h12-0-56" id="h12-0-56" class="i">+n3@1 → n1 AppendResponse match_index=4
</a><a href="#h12-0-57" id="h12-0-57" class="i">+
</a><a href="#h12-0-58" id="h12-0-58" class="i">+# The leader receives the acks and commits the writes one by one,
</a><a href="#h12-0-59" id="h12-0-59" class="i">+# without retransmitting the in-flight (to it) entries.
</a><a href="#h12-0-60" id="h12-0-60" class="i">+deliver
</a><a href="#h12-0-61" id="h12-0-61" class="i">+---
</a><a href="#h12-0-62" id="h12-0-62" class="i">+n1@1 commit 2@1
</a><a href="#h12-0-63" id="h12-0-63" class="i">+n1@1 apply 2@1 put a=1
</a><a href="#h12-0-64" id="h12-0-64" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h12-0-65" id="h12-0-65" class="i">+c1@1 put a=1 ⇒ 2
</a><a href="#h12-0-66" id="h12-0-66" class="i">+n1@1 commit 3@1
</a><a href="#h12-0-67" id="h12-0-67" class="i">+n1@1 apply 3@1 put b=2
</a><a href="#h12-0-68" id="h12-0-68" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h12-0-69" id="h12-0-69" class="i">+c1@1 put b=2 ⇒ 3
</a><a href="#h12-0-70" id="h12-0-70" class="i">+n1@1 commit 4@1
</a><a href="#h12-0-71" id="h12-0-71" class="i">+n1@1 apply 4@1 put c=3
</a><a href="#h12-0-72" id="h12-0-72" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h12-0-73" id="h12-0-73" class="i">+c1@1 put c=3 ⇒ 4
</a><a href="#h12-0-74" id="h12-0-74" class="i">+
</a><a href="#h12-0-75" id="h12-0-75" class="i">+# All nodes are now caught up on logs (but not commit/apply, which needs a
</a><a href="#h12-0-76" id="h12-0-76" class="i">+# heartbeat).
</a><a href="#h12-0-77" id="h12-0-77" class="i">+status
</a><a href="#h12-0-78" id="h12-0-78" class="i">+---
</a><a href="#h12-0-79" id="h12-0-79" class="i">+n1@1 leader last=4@1 commit=4@1 apply=4 progress={2:4→5 3:4→5}
</a><a href="#h12-0-80" id="h12-0-80" class="i">+n2@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h12-0-81" id="h12-0-81" class="i">+n3@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h13" href="../file/src/raft/testscripts/node/append_probe_divergent_first.html">src/raft/testscripts/node/append_probe_divergent_first</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_first.html">src/raft/testscripts/node/append_probe_divergent_first</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,224 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+# Appends to a previous leader and follower with a divergent tail all
</a><a href="#h13-0-1" id="h13-0-1" class="i">+# the way back to the first entry works.
</a><a href="#h13-0-2" id="h13-0-2" class="i">+
</a><a href="#h13-0-3" id="h13-0-3" class="i">+cluster nodes=5 leader=1
</a><a href="#h13-0-4" id="h13-0-4" class="i">+---
</a><a href="#h13-0-5" id="h13-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h13-0-6" id="h13-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-7" id="h13-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-8" id="h13-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-9" id="h13-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-10" id="h13-0-10" class="i">+
</a><a href="#h13-0-11" id="h13-0-11" class="i">+# Partition n1-n2
</a><a href="#h13-0-12" id="h13-0-12" class="i">+partition 1 2
</a><a href="#h13-0-13" id="h13-0-13" class="i">+---
</a><a href="#h13-0-14" id="h13-0-14" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h13-0-15" id="h13-0-15" class="i">+
</a><a href="#h13-0-16" id="h13-0-16" class="i">+# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h13-0-17" id="h13-0-17" class="i">+# Multiple leaders ensures the log has multiple terms.
</a><a href="#h13-0-18" id="h13-0-18" class="i">+(campaign 3)
</a><a href="#h13-0-19" id="h13-0-19" class="i">+(stabilize)
</a><a href="#h13-0-20" id="h13-0-20" class="i">+(put 3 a=1)
</a><a href="#h13-0-21" id="h13-0-21" class="i">+(stabilize heartbeat=true)
</a><a href="#h13-0-22" id="h13-0-22" class="i">+status
</a><a href="#h13-0-23" id="h13-0-23" class="i">+---
</a><a href="#h13-0-24" id="h13-0-24" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h13-0-25" id="h13-0-25" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-26" id="h13-0-26" class="i">+n3@2 leader last=3@2 commit=3@2 apply=3 progress={1:0→4 2:0→4 4:3→4 5:3→4}
</a><a href="#h13-0-27" id="h13-0-27" class="i">+n4@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h13-0-28" id="h13-0-28" class="i">+n5@2 follower(n3) last=3@2 commit=3@2 apply=3
</a><a href="#h13-0-29" id="h13-0-29" class="i">+
</a><a href="#h13-0-30" id="h13-0-30" class="i">+(campaign 4)
</a><a href="#h13-0-31" id="h13-0-31" class="i">+(stabilize)
</a><a href="#h13-0-32" id="h13-0-32" class="i">+(put 4 b=2)
</a><a href="#h13-0-33" id="h13-0-33" class="i">+(stabilize heartbeat=true)
</a><a href="#h13-0-34" id="h13-0-34" class="i">+status
</a><a href="#h13-0-35" id="h13-0-35" class="i">+---
</a><a href="#h13-0-36" id="h13-0-36" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h13-0-37" id="h13-0-37" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-38" id="h13-0-38" class="i">+n3@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h13-0-39" id="h13-0-39" class="i">+n4@3 leader last=5@3 commit=5@3 apply=5 progress={1:0→6 2:0→6 3:5→6 5:5→6}
</a><a href="#h13-0-40" id="h13-0-40" class="i">+n5@3 follower(n4) last=5@3 commit=5@3 apply=5
</a><a href="#h13-0-41" id="h13-0-41" class="i">+
</a><a href="#h13-0-42" id="h13-0-42" class="i">+(campaign 5)
</a><a href="#h13-0-43" id="h13-0-43" class="i">+(stabilize)
</a><a href="#h13-0-44" id="h13-0-44" class="i">+(put 5 c=3)
</a><a href="#h13-0-45" id="h13-0-45" class="i">+(stabilize heartbeat=true)
</a><a href="#h13-0-46" id="h13-0-46" class="i">+status
</a><a href="#h13-0-47" id="h13-0-47" class="i">+---
</a><a href="#h13-0-48" id="h13-0-48" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h13-0-49" id="h13-0-49" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h13-0-50" id="h13-0-50" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-51" id="h13-0-51" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-52" id="h13-0-52" class="i">+n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→8 2:0→8 3:7→8 4:7→8}
</a><a href="#h13-0-53" id="h13-0-53" class="i">+
</a><a href="#h13-0-54" id="h13-0-54" class="i">+# Propose writes in the minority partition as well.
</a><a href="#h13-0-55" id="h13-0-55" class="i">+(put 1 a=2)
</a><a href="#h13-0-56" id="h13-0-56" class="i">+(put 1 a=3)
</a><a href="#h13-0-57" id="h13-0-57" class="i">+(put 1 a=4)
</a><a href="#h13-0-58" id="h13-0-58" class="i">+(put 1 a=5)
</a><a href="#h13-0-59" id="h13-0-59" class="i">+(put 1 a=6)
</a><a href="#h13-0-60" id="h13-0-60" class="i">+(put 1 a=7)
</a><a href="#h13-0-61" id="h13-0-61" class="i">+(stabilize)
</a><a href="#h13-0-62" id="h13-0-62" class="i">+status
</a><a href="#h13-0-63" id="h13-0-63" class="i">+---
</a><a href="#h13-0-64" id="h13-0-64" class="i">+n1@1 leader last=7@1 commit=1@1 apply=1 progress={2:7→8 3:1→8 4:1→8 5:1→8}
</a><a href="#h13-0-65" id="h13-0-65" class="i">+n2@1 follower(n1) last=7@1 commit=1@1 apply=1
</a><a href="#h13-0-66" id="h13-0-66" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-67" id="h13-0-67" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-68" id="h13-0-68" class="i">+n5@4 leader last=7@4 commit=7@4 apply=7 progress={1:0→8 2:0→8 3:7→8 4:7→8}
</a><a href="#h13-0-69" id="h13-0-69" class="i">+
</a><a href="#h13-0-70" id="h13-0-70" class="i">+log 1 5
</a><a href="#h13-0-71" id="h13-0-71" class="i">+---
</a><a href="#h13-0-72" id="h13-0-72" class="i">+n1@1 last=7@1 commit=1@1
</a><a href="#h13-0-73" id="h13-0-73" class="i">+n1@1 entry 1@1 None
</a><a href="#h13-0-74" id="h13-0-74" class="i">+n1@1 entry 2@1 put a=2
</a><a href="#h13-0-75" id="h13-0-75" class="i">+n1@1 entry 3@1 put a=3
</a><a href="#h13-0-76" id="h13-0-76" class="i">+n1@1 entry 4@1 put a=4
</a><a href="#h13-0-77" id="h13-0-77" class="i">+n1@1 entry 5@1 put a=5
</a><a href="#h13-0-78" id="h13-0-78" class="i">+n1@1 entry 6@1 put a=6
</a><a href="#h13-0-79" id="h13-0-79" class="i">+n1@1 entry 7@1 put a=7
</a><a href="#h13-0-80" id="h13-0-80" class="i">+n5@4 last=7@4 commit=7@4
</a><a href="#h13-0-81" id="h13-0-81" class="i">+n5@4 entry 1@1 None
</a><a href="#h13-0-82" id="h13-0-82" class="i">+n5@4 entry 2@2 None
</a><a href="#h13-0-83" id="h13-0-83" class="i">+n5@4 entry 3@2 put a=1
</a><a href="#h13-0-84" id="h13-0-84" class="i">+n5@4 entry 4@3 None
</a><a href="#h13-0-85" id="h13-0-85" class="i">+n5@4 entry 5@3 put b=2
</a><a href="#h13-0-86" id="h13-0-86" class="i">+n5@4 entry 6@4 None
</a><a href="#h13-0-87" id="h13-0-87" class="i">+n5@4 entry 7@4 put c=3
</a><a href="#h13-0-88" id="h13-0-88" class="i">+
</a><a href="#h13-0-89" id="h13-0-89" class="i">+# Heal the partition.
</a><a href="#h13-0-90" id="h13-0-90" class="i">+heal
</a><a href="#h13-0-91" id="h13-0-91" class="i">+---
</a><a href="#h13-0-92" id="h13-0-92" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h13-0-93" id="h13-0-93" class="i">+
</a><a href="#h13-0-94" id="h13-0-94" class="i">+# Propose another write on the majority leader.
</a><a href="#h13-0-95" id="h13-0-95" class="i">+put 5 d=4
</a><a href="#h13-0-96" id="h13-0-96" class="i">+---
</a><a href="#h13-0-97" id="h13-0-97" class="i">+c5@4 → n5 ClientRequest id=0x0a write 0x0101640134
</a><a href="#h13-0-98" id="h13-0-98" class="i">+n5@4 append 8@4 put d=4
</a><a href="#h13-0-99" id="h13-0-99" class="i">+n5@4 → n1 Append base=7@4 [8@4]
</a><a href="#h13-0-100" id="h13-0-100" class="i">+n5@4 → n2 Append base=7@4 [8@4]
</a><a href="#h13-0-101" id="h13-0-101" class="i">+n5@4 → n3 Append base=7@4 [8@4]
</a><a href="#h13-0-102" id="h13-0-102" class="i">+n5@4 → n4 Append base=7@4 [8@4]
</a><a href="#h13-0-103" id="h13-0-103" class="i">+
</a><a href="#h13-0-104" id="h13-0-104" class="i">+# Delivering the appends to n1 and n2 should reject them. It also cancels the
</a><a href="#h13-0-105" id="h13-0-105" class="i">+# in-flight write requests on n1.
</a><a href="#h13-0-106" id="h13-0-106" class="i">+deliver 1 2
</a><a href="#h13-0-107" id="h13-0-107" class="i">+---
</a><a href="#h13-0-108" id="h13-0-108" class="i">+n1@1 leader ⇨ n1@4 follower(n5)
</a><a href="#h13-0-109" id="h13-0-109" class="i">+n1@1 → c1 ClientResponse id=0x04 Error::Abort
</a><a href="#h13-0-110" id="h13-0-110" class="i">+c1@1 put a=2 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-111" id="h13-0-111" class="i">+n1@1 → c1 ClientResponse id=0x05 Error::Abort
</a><a href="#h13-0-112" id="h13-0-112" class="i">+c1@1 put a=3 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-113" id="h13-0-113" class="i">+n1@1 → c1 ClientResponse id=0x06 Error::Abort
</a><a href="#h13-0-114" id="h13-0-114" class="i">+c1@1 put a=4 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-115" id="h13-0-115" class="i">+n1@1 → c1 ClientResponse id=0x07 Error::Abort
</a><a href="#h13-0-116" id="h13-0-116" class="i">+c1@1 put a=5 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-117" id="h13-0-117" class="i">+n1@1 → c1 ClientResponse id=0x08 Error::Abort
</a><a href="#h13-0-118" id="h13-0-118" class="i">+c1@1 put a=6 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-119" id="h13-0-119" class="i">+n1@1 → c1 ClientResponse id=0x09 Error::Abort
</a><a href="#h13-0-120" id="h13-0-120" class="i">+c1@1 put a=7 ⇒ Error::Abort (operation aborted)
</a><a href="#h13-0-121" id="h13-0-121" class="i">+n1@4 → n5 AppendResponse reject_index=7
</a><a href="#h13-0-122" id="h13-0-122" class="i">+n2@1 follower(n1) ⇨ n2@4 follower(n5)
</a><a href="#h13-0-123" id="h13-0-123" class="i">+n2@4 → n5 AppendResponse reject_index=7
</a><a href="#h13-0-124" id="h13-0-124" class="i">+
</a><a href="#h13-0-125" id="h13-0-125" class="i">+# n5 will probe the previous base, which is again rejected. This repeats until
</a><a href="#h13-0-126" id="h13-0-126" class="i">+# a common base is found at 1@1.
</a><a href="#h13-0-127" id="h13-0-127" class="i">+deliver 5
</a><a href="#h13-0-128" id="h13-0-128" class="i">+status 5
</a><a href="#h13-0-129" id="h13-0-129" class="i">+deliver 1 2
</a><a href="#h13-0-130" id="h13-0-130" class="i">+---
</a><a href="#h13-0-131" id="h13-0-131" class="i">+n5@4 → n1 Append base=6@4 []
</a><a href="#h13-0-132" id="h13-0-132" class="i">+n5@4 → n2 Append base=6@4 []
</a><a href="#h13-0-133" id="h13-0-133" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→7 2:0→7 3:7→9 4:7→9}
</a><a href="#h13-0-134" id="h13-0-134" class="i">+n1@4 → n5 AppendResponse reject_index=6
</a><a href="#h13-0-135" id="h13-0-135" class="i">+n2@4 → n5 AppendResponse reject_index=6
</a><a href="#h13-0-136" id="h13-0-136" class="i">+
</a><a href="#h13-0-137" id="h13-0-137" class="i">+deliver 5
</a><a href="#h13-0-138" id="h13-0-138" class="i">+deliver 1 2
</a><a href="#h13-0-139" id="h13-0-139" class="i">+status 5
</a><a href="#h13-0-140" id="h13-0-140" class="i">+---
</a><a href="#h13-0-141" id="h13-0-141" class="i">+n5@4 → n1 Append base=5@3 []
</a><a href="#h13-0-142" id="h13-0-142" class="i">+n5@4 → n2 Append base=5@3 []
</a><a href="#h13-0-143" id="h13-0-143" class="i">+n1@4 → n5 AppendResponse reject_index=5
</a><a href="#h13-0-144" id="h13-0-144" class="i">+n2@4 → n5 AppendResponse reject_index=5
</a><a href="#h13-0-145" id="h13-0-145" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→6 2:0→6 3:7→9 4:7→9}
</a><a href="#h13-0-146" id="h13-0-146" class="i">+
</a><a href="#h13-0-147" id="h13-0-147" class="i">+deliver 5
</a><a href="#h13-0-148" id="h13-0-148" class="i">+status 5
</a><a href="#h13-0-149" id="h13-0-149" class="i">+deliver 1 2
</a><a href="#h13-0-150" id="h13-0-150" class="i">+---
</a><a href="#h13-0-151" id="h13-0-151" class="i">+n5@4 → n1 Append base=4@3 []
</a><a href="#h13-0-152" id="h13-0-152" class="i">+n5@4 → n2 Append base=4@3 []
</a><a href="#h13-0-153" id="h13-0-153" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→5 2:0→5 3:7→9 4:7→9}
</a><a href="#h13-0-154" id="h13-0-154" class="i">+n1@4 → n5 AppendResponse reject_index=4
</a><a href="#h13-0-155" id="h13-0-155" class="i">+n2@4 → n5 AppendResponse reject_index=4
</a><a href="#h13-0-156" id="h13-0-156" class="i">+
</a><a href="#h13-0-157" id="h13-0-157" class="i">+deliver 5
</a><a href="#h13-0-158" id="h13-0-158" class="i">+status 5
</a><a href="#h13-0-159" id="h13-0-159" class="i">+deliver 1 2
</a><a href="#h13-0-160" id="h13-0-160" class="i">+---
</a><a href="#h13-0-161" id="h13-0-161" class="i">+n5@4 → n1 Append base=3@2 []
</a><a href="#h13-0-162" id="h13-0-162" class="i">+n5@4 → n2 Append base=3@2 []
</a><a href="#h13-0-163" id="h13-0-163" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→4 2:0→4 3:7→9 4:7→9}
</a><a href="#h13-0-164" id="h13-0-164" class="i">+n1@4 → n5 AppendResponse reject_index=3
</a><a href="#h13-0-165" id="h13-0-165" class="i">+n2@4 → n5 AppendResponse reject_index=3
</a><a href="#h13-0-166" id="h13-0-166" class="i">+
</a><a href="#h13-0-167" id="h13-0-167" class="i">+deliver 5
</a><a href="#h13-0-168" id="h13-0-168" class="i">+status 5
</a><a href="#h13-0-169" id="h13-0-169" class="i">+deliver 1 2
</a><a href="#h13-0-170" id="h13-0-170" class="i">+---
</a><a href="#h13-0-171" id="h13-0-171" class="i">+n5@4 → n1 Append base=2@2 []
</a><a href="#h13-0-172" id="h13-0-172" class="i">+n5@4 → n2 Append base=2@2 []
</a><a href="#h13-0-173" id="h13-0-173" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→3 2:0→3 3:7→9 4:7→9}
</a><a href="#h13-0-174" id="h13-0-174" class="i">+n1@4 → n5 AppendResponse reject_index=2
</a><a href="#h13-0-175" id="h13-0-175" class="i">+n2@4 → n5 AppendResponse reject_index=2
</a><a href="#h13-0-176" id="h13-0-176" class="i">+
</a><a href="#h13-0-177" id="h13-0-177" class="i">+deliver 5
</a><a href="#h13-0-178" id="h13-0-178" class="i">+status 5
</a><a href="#h13-0-179" id="h13-0-179" class="i">+deliver 1 2
</a><a href="#h13-0-180" id="h13-0-180" class="i">+---
</a><a href="#h13-0-181" id="h13-0-181" class="i">+n5@4 → n1 Append base=1@1 []
</a><a href="#h13-0-182" id="h13-0-182" class="i">+n5@4 → n2 Append base=1@1 []
</a><a href="#h13-0-183" id="h13-0-183" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:0→2 2:0→2 3:7→9 4:7→9}
</a><a href="#h13-0-184" id="h13-0-184" class="i">+n1@4 → n5 AppendResponse match_index=1
</a><a href="#h13-0-185" id="h13-0-185" class="i">+n2@4 → n5 AppendResponse match_index=1
</a><a href="#h13-0-186" id="h13-0-186" class="i">+
</a><a href="#h13-0-187" id="h13-0-187" class="i">+# n5 can now replicate the tail to n1 and n2, allowing n5 to commit it.
</a><a href="#h13-0-188" id="h13-0-188" class="i">+deliver 5
</a><a href="#h13-0-189" id="h13-0-189" class="i">+status 5
</a><a href="#h13-0-190" id="h13-0-190" class="i">+deliver 1 2
</a><a href="#h13-0-191" id="h13-0-191" class="i">+---
</a><a href="#h13-0-192" id="h13-0-192" class="i">+n5@4 → n1 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h13-0-193" id="h13-0-193" class="i">+n5@4 → n2 Append base=1@1 [2@2 3@2 4@3 5@3 6@4 7@4 8@4]
</a><a href="#h13-0-194" id="h13-0-194" class="i">+n5@4 leader last=8@4 commit=7@4 apply=7 progress={1:1→9 2:1→9 3:7→9 4:7→9}
</a><a href="#h13-0-195" id="h13-0-195" class="i">+n1@4 append 8@4 put d=4
</a><a href="#h13-0-196" id="h13-0-196" class="i">+n1@4 → n5 AppendResponse match_index=8
</a><a href="#h13-0-197" id="h13-0-197" class="i">+n2@4 append 8@4 put d=4
</a><a href="#h13-0-198" id="h13-0-198" class="i">+n2@4 → n5 AppendResponse match_index=8
</a><a href="#h13-0-199" id="h13-0-199" class="i">+
</a><a href="#h13-0-200" id="h13-0-200" class="i">+deliver 5
</a><a href="#h13-0-201" id="h13-0-201" class="i">+---
</a><a href="#h13-0-202" id="h13-0-202" class="i">+n5@4 commit 8@4
</a><a href="#h13-0-203" id="h13-0-203" class="i">+n5@4 apply 8@4 put d=4
</a><a href="#h13-0-204" id="h13-0-204" class="i">+n5@4 → c5 ClientResponse id=0x0a write 0x0108
</a><a href="#h13-0-205" id="h13-0-205" class="i">+c5@4 put d=4 ⇒ 8
</a><a href="#h13-0-206" id="h13-0-206" class="i">+
</a><a href="#h13-0-207" id="h13-0-207" class="i">+status
</a><a href="#h13-0-208" id="h13-0-208" class="i">+---
</a><a href="#h13-0-209" id="h13-0-209" class="i">+n1@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h13-0-210" id="h13-0-210" class="i">+n2@4 follower(n5) last=8@4 commit=1@1 apply=1
</a><a href="#h13-0-211" id="h13-0-211" class="i">+n3@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-212" id="h13-0-212" class="i">+n4@4 follower(n5) last=7@4 commit=7@4 apply=7
</a><a href="#h13-0-213" id="h13-0-213" class="i">+n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:7→9 4:7→9}
</a><a href="#h13-0-214" id="h13-0-214" class="i">+
</a><a href="#h13-0-215" id="h13-0-215" class="i">+# Stabilize the cluster.
</a><a href="#h13-0-216" id="h13-0-216" class="i">+(stabilize heartbeat=true)
</a><a href="#h13-0-217" id="h13-0-217" class="i">+status
</a><a href="#h13-0-218" id="h13-0-218" class="i">+---
</a><a href="#h13-0-219" id="h13-0-219" class="i">+n1@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-0-220" id="h13-0-220" class="i">+n2@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-0-221" id="h13-0-221" class="i">+n3@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-0-222" id="h13-0-222" class="i">+n4@4 follower(n5) last=8@4 commit=8@4 apply=8
</a><a href="#h13-0-223" id="h13-0-223" class="i">+n5@4 leader last=8@4 commit=8@4 apply=8 progress={1:8→9 2:8→9 3:8→9 4:8→9}
</a><b>diff --git a/<a id="h14" href="../file/src/raft/testscripts/node/append_probe_divergent_long.html">src/raft/testscripts/node/append_probe_divergent_long</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_long.html">src/raft/testscripts/node/append_probe_divergent_long</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,251 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+# Appends to a previous leader and follower with a long divergent tail requires
</a><a href="#h14-0-1" id="h14-0-1" class="i">+# the leader to repeatedly probe until it finds a common base.
</a><a href="#h14-0-2" id="h14-0-2" class="i">+
</a><a href="#h14-0-3" id="h14-0-3" class="i">+cluster nodes=5 leader=1
</a><a href="#h14-0-4" id="h14-0-4" class="i">+---
</a><a href="#h14-0-5" id="h14-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h14-0-6" id="h14-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-7" id="h14-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-8" id="h14-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-9" id="h14-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h14-0-10" id="h14-0-10" class="i">+
</a><a href="#h14-0-11" id="h14-0-11" class="i">+# Make a couple of writes to ensure a common log prefix.
</a><a href="#h14-0-12" id="h14-0-12" class="i">+(put 1 a=1)
</a><a href="#h14-0-13" id="h14-0-13" class="i">+(put 1 b=2)
</a><a href="#h14-0-14" id="h14-0-14" class="i">+(stabilize)
</a><a href="#h14-0-15" id="h14-0-15" class="i">+status
</a><a href="#h14-0-16" id="h14-0-16" class="i">+---
</a><a href="#h14-0-17" id="h14-0-17" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h14-0-18" id="h14-0-18" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-19" id="h14-0-19" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-20" id="h14-0-20" class="i">+n4@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-21" id="h14-0-21" class="i">+n5@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-22" id="h14-0-22" class="i">+
</a><a href="#h14-0-23" id="h14-0-23" class="i">+# Partition n1-n2
</a><a href="#h14-0-24" id="h14-0-24" class="i">+partition 1 2
</a><a href="#h14-0-25" id="h14-0-25" class="i">+---
</a><a href="#h14-0-26" id="h14-0-26" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h14-0-29" id="h14-0-29" class="i">+# Multiple leaders ensures the log has multiple terms.
</a><a href="#h14-0-30" id="h14-0-30" class="i">+(campaign 3)
</a><a href="#h14-0-31" id="h14-0-31" class="i">+(stabilize)
</a><a href="#h14-0-32" id="h14-0-32" class="i">+(put 3 c=3)
</a><a href="#h14-0-33" id="h14-0-33" class="i">+(stabilize heartbeat=true)
</a><a href="#h14-0-34" id="h14-0-34" class="i">+status
</a><a href="#h14-0-35" id="h14-0-35" class="i">+---
</a><a href="#h14-0-36" id="h14-0-36" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h14-0-37" id="h14-0-37" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-38" id="h14-0-38" class="i">+n3@2 leader last=5@2 commit=5@2 apply=5 progress={1:0→6 2:0→6 4:5→6 5:5→6}
</a><a href="#h14-0-39" id="h14-0-39" class="i">+n4@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h14-0-40" id="h14-0-40" class="i">+n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h14-0-41" id="h14-0-41" class="i">+
</a><a href="#h14-0-42" id="h14-0-42" class="i">+(campaign 4)
</a><a href="#h14-0-43" id="h14-0-43" class="i">+(stabilize)
</a><a href="#h14-0-44" id="h14-0-44" class="i">+(put 4 d=4)
</a><a href="#h14-0-45" id="h14-0-45" class="i">+(stabilize heartbeat=true)
</a><a href="#h14-0-46" id="h14-0-46" class="i">+status
</a><a href="#h14-0-47" id="h14-0-47" class="i">+---
</a><a href="#h14-0-48" id="h14-0-48" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h14-0-49" id="h14-0-49" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-50" id="h14-0-50" class="i">+n3@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h14-0-51" id="h14-0-51" class="i">+n4@3 leader last=7@3 commit=7@3 apply=7 progress={1:0→8 2:0→8 3:7→8 5:7→8}
</a><a href="#h14-0-52" id="h14-0-52" class="i">+n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h14-0-53" id="h14-0-53" class="i">+
</a><a href="#h14-0-54" id="h14-0-54" class="i">+(campaign 5)
</a><a href="#h14-0-55" id="h14-0-55" class="i">+(stabilize)
</a><a href="#h14-0-56" id="h14-0-56" class="i">+(put 5 e=5)
</a><a href="#h14-0-57" id="h14-0-57" class="i">+(stabilize heartbeat=true)
</a><a href="#h14-0-58" id="h14-0-58" class="i">+status
</a><a href="#h14-0-59" id="h14-0-59" class="i">+---
</a><a href="#h14-0-60" id="h14-0-60" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h14-0-61" id="h14-0-61" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h14-0-62" id="h14-0-62" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-63" id="h14-0-63" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-64" id="h14-0-64" class="i">+n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:0→10 2:0→10 3:9→10 4:9→10}
</a><a href="#h14-0-65" id="h14-0-65" class="i">+
</a><a href="#h14-0-66" id="h14-0-66" class="i">+# Propose writes in the minority partition as well, to build up a log
</a><a href="#h14-0-67" id="h14-0-67" class="i">+# longer than the majority log.
</a><a href="#h14-0-68" id="h14-0-68" class="i">+(put 1 a=2)
</a><a href="#h14-0-69" id="h14-0-69" class="i">+(put 1 a=3)
</a><a href="#h14-0-70" id="h14-0-70" class="i">+(put 1 a=4)
</a><a href="#h14-0-71" id="h14-0-71" class="i">+(put 1 a=5)
</a><a href="#h14-0-72" id="h14-0-72" class="i">+(put 1 a=6)
</a><a href="#h14-0-73" id="h14-0-73" class="i">+(put 1 a=7)
</a><a href="#h14-0-74" id="h14-0-74" class="i">+(put 1 a=8)
</a><a href="#h14-0-75" id="h14-0-75" class="i">+(put 1 a=9)
</a><a href="#h14-0-76" id="h14-0-76" class="i">+(put 1 a=10)
</a><a href="#h14-0-77" id="h14-0-77" class="i">+(stabilize)
</a><a href="#h14-0-78" id="h14-0-78" class="i">+status
</a><a href="#h14-0-79" id="h14-0-79" class="i">+---
</a><a href="#h14-0-80" id="h14-0-80" class="i">+n1@1 leader last=12@1 commit=3@1 apply=3 progress={2:12→13 3:3→13 4:3→13 5:3→13}
</a><a href="#h14-0-81" id="h14-0-81" class="i">+n2@1 follower(n1) last=12@1 commit=1@1 apply=1
</a><a href="#h14-0-82" id="h14-0-82" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-83" id="h14-0-83" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-84" id="h14-0-84" class="i">+n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:0→10 2:0→10 3:9→10 4:9→10}
</a><a href="#h14-0-85" id="h14-0-85" class="i">+
</a><a href="#h14-0-86" id="h14-0-86" class="i">+log 1 5
</a><a href="#h14-0-87" id="h14-0-87" class="i">+---
</a><a href="#h14-0-88" id="h14-0-88" class="i">+n1@1 last=12@1 commit=3@1
</a><a href="#h14-0-89" id="h14-0-89" class="i">+n1@1 entry 1@1 None
</a><a href="#h14-0-90" id="h14-0-90" class="i">+n1@1 entry 2@1 put a=1
</a><a href="#h14-0-91" id="h14-0-91" class="i">+n1@1 entry 3@1 put b=2
</a><a href="#h14-0-92" id="h14-0-92" class="i">+n1@1 entry 4@1 put a=2
</a><a href="#h14-0-93" id="h14-0-93" class="i">+n1@1 entry 5@1 put a=3
</a><a href="#h14-0-94" id="h14-0-94" class="i">+n1@1 entry 6@1 put a=4
</a><a href="#h14-0-95" id="h14-0-95" class="i">+n1@1 entry 7@1 put a=5
</a><a href="#h14-0-96" id="h14-0-96" class="i">+n1@1 entry 8@1 put a=6
</a><a href="#h14-0-97" id="h14-0-97" class="i">+n1@1 entry 9@1 put a=7
</a><a href="#h14-0-98" id="h14-0-98" class="i">+n1@1 entry 10@1 put a=8
</a><a href="#h14-0-99" id="h14-0-99" class="i">+n1@1 entry 11@1 put a=9
</a><a href="#h14-0-100" id="h14-0-100" class="i">+n1@1 entry 12@1 put a=10
</a><a href="#h14-0-101" id="h14-0-101" class="i">+n5@4 last=9@4 commit=9@4
</a><a href="#h14-0-102" id="h14-0-102" class="i">+n5@4 entry 1@1 None
</a><a href="#h14-0-103" id="h14-0-103" class="i">+n5@4 entry 2@1 put a=1
</a><a href="#h14-0-104" id="h14-0-104" class="i">+n5@4 entry 3@1 put b=2
</a><a href="#h14-0-105" id="h14-0-105" class="i">+n5@4 entry 4@2 None
</a><a href="#h14-0-106" id="h14-0-106" class="i">+n5@4 entry 5@2 put c=3
</a><a href="#h14-0-107" id="h14-0-107" class="i">+n5@4 entry 6@3 None
</a><a href="#h14-0-108" id="h14-0-108" class="i">+n5@4 entry 7@3 put d=4
</a><a href="#h14-0-109" id="h14-0-109" class="i">+n5@4 entry 8@4 None
</a><a href="#h14-0-110" id="h14-0-110" class="i">+n5@4 entry 9@4 put e=5
</a><a href="#h14-0-111" id="h14-0-111" class="i">+
</a><a href="#h14-0-112" id="h14-0-112" class="i">+# Heal the partition.
</a><a href="#h14-0-113" id="h14-0-113" class="i">+heal
</a><a href="#h14-0-114" id="h14-0-114" class="i">+---
</a><a href="#h14-0-115" id="h14-0-115" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h14-0-116" id="h14-0-116" class="i">+
</a><a href="#h14-0-117" id="h14-0-117" class="i">+# Propose another write on the majority leader.
</a><a href="#h14-0-118" id="h14-0-118" class="i">+put 5 f=6
</a><a href="#h14-0-119" id="h14-0-119" class="i">+---
</a><a href="#h14-0-120" id="h14-0-120" class="i">+c5@4 → n5 ClientRequest id=0x0f write 0x0101660136
</a><a href="#h14-0-121" id="h14-0-121" class="i">+n5@4 append 10@4 put f=6
</a><a href="#h14-0-122" id="h14-0-122" class="i">+n5@4 → n1 Append base=9@4 [10@4]
</a><a href="#h14-0-123" id="h14-0-123" class="i">+n5@4 → n2 Append base=9@4 [10@4]
</a><a href="#h14-0-124" id="h14-0-124" class="i">+n5@4 → n3 Append base=9@4 [10@4]
</a><a href="#h14-0-125" id="h14-0-125" class="i">+n5@4 → n4 Append base=9@4 [10@4]
</a><a href="#h14-0-126" id="h14-0-126" class="i">+
</a><a href="#h14-0-127" id="h14-0-127" class="i">+# Delivering the appends to n1 and n2 should reject them. It also cancels the
</a><a href="#h14-0-128" id="h14-0-128" class="i">+# in-flight write requests on n1.
</a><a href="#h14-0-129" id="h14-0-129" class="i">+deliver 1 2
</a><a href="#h14-0-130" id="h14-0-130" class="i">+---
</a><a href="#h14-0-131" id="h14-0-131" class="i">+n1@1 leader ⇨ n1@4 follower(n5)
</a><a href="#h14-0-132" id="h14-0-132" class="i">+n1@1 → c1 ClientResponse id=0x06 Error::Abort
</a><a href="#h14-0-133" id="h14-0-133" class="i">+c1@1 put a=2 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-134" id="h14-0-134" class="i">+n1@1 → c1 ClientResponse id=0x07 Error::Abort
</a><a href="#h14-0-135" id="h14-0-135" class="i">+c1@1 put a=3 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-136" id="h14-0-136" class="i">+n1@1 → c1 ClientResponse id=0x08 Error::Abort
</a><a href="#h14-0-137" id="h14-0-137" class="i">+c1@1 put a=4 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-138" id="h14-0-138" class="i">+n1@1 → c1 ClientResponse id=0x09 Error::Abort
</a><a href="#h14-0-139" id="h14-0-139" class="i">+c1@1 put a=5 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-140" id="h14-0-140" class="i">+n1@1 → c1 ClientResponse id=0x0a Error::Abort
</a><a href="#h14-0-141" id="h14-0-141" class="i">+c1@1 put a=6 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-142" id="h14-0-142" class="i">+n1@1 → c1 ClientResponse id=0x0b Error::Abort
</a><a href="#h14-0-143" id="h14-0-143" class="i">+c1@1 put a=7 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-144" id="h14-0-144" class="i">+n1@1 → c1 ClientResponse id=0x0c Error::Abort
</a><a href="#h14-0-145" id="h14-0-145" class="i">+c1@1 put a=8 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-146" id="h14-0-146" class="i">+n1@1 → c1 ClientResponse id=0x0d Error::Abort
</a><a href="#h14-0-147" id="h14-0-147" class="i">+c1@1 put a=9 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-148" id="h14-0-148" class="i">+n1@1 → c1 ClientResponse id=0x0e Error::Abort
</a><a href="#h14-0-149" id="h14-0-149" class="i">+c1@1 put a=10 ⇒ Error::Abort (operation aborted)
</a><a href="#h14-0-150" id="h14-0-150" class="i">+n1@4 → n5 AppendResponse reject_index=9
</a><a href="#h14-0-151" id="h14-0-151" class="i">+n2@1 follower(n1) ⇨ n2@4 follower(n5)
</a><a href="#h14-0-152" id="h14-0-152" class="i">+n2@4 → n5 AppendResponse reject_index=9
</a><a href="#h14-0-153" id="h14-0-153" class="i">+
</a><a href="#h14-0-154" id="h14-0-154" class="i">+# n5 will probe the previous base, which is again rejected. This repeats until
</a><a href="#h14-0-155" id="h14-0-155" class="i">+# a common base is found at 3@1.
</a><a href="#h14-0-156" id="h14-0-156" class="i">+deliver 5
</a><a href="#h14-0-157" id="h14-0-157" class="i">+status 5
</a><a href="#h14-0-158" id="h14-0-158" class="i">+deliver 1 2
</a><a href="#h14-0-159" id="h14-0-159" class="i">+---
</a><a href="#h14-0-160" id="h14-0-160" class="i">+n5@4 → n1 Append base=8@4 []
</a><a href="#h14-0-161" id="h14-0-161" class="i">+n5@4 → n2 Append base=8@4 []
</a><a href="#h14-0-162" id="h14-0-162" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→9 2:0→9 3:9→11 4:9→11}
</a><a href="#h14-0-163" id="h14-0-163" class="i">+n1@4 → n5 AppendResponse reject_index=8
</a><a href="#h14-0-164" id="h14-0-164" class="i">+n2@4 → n5 AppendResponse reject_index=8
</a><a href="#h14-0-165" id="h14-0-165" class="i">+
</a><a href="#h14-0-166" id="h14-0-166" class="i">+deliver 5
</a><a href="#h14-0-167" id="h14-0-167" class="i">+deliver 1 2
</a><a href="#h14-0-168" id="h14-0-168" class="i">+status 5
</a><a href="#h14-0-169" id="h14-0-169" class="i">+---
</a><a href="#h14-0-170" id="h14-0-170" class="i">+n5@4 → n1 Append base=7@3 []
</a><a href="#h14-0-171" id="h14-0-171" class="i">+n5@4 → n2 Append base=7@3 []
</a><a href="#h14-0-172" id="h14-0-172" class="i">+n1@4 → n5 AppendResponse reject_index=7
</a><a href="#h14-0-173" id="h14-0-173" class="i">+n2@4 → n5 AppendResponse reject_index=7
</a><a href="#h14-0-174" id="h14-0-174" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→8 2:0→8 3:9→11 4:9→11}
</a><a href="#h14-0-175" id="h14-0-175" class="i">+
</a><a href="#h14-0-176" id="h14-0-176" class="i">+deliver 5
</a><a href="#h14-0-177" id="h14-0-177" class="i">+status 5
</a><a href="#h14-0-178" id="h14-0-178" class="i">+deliver 1 2
</a><a href="#h14-0-179" id="h14-0-179" class="i">+---
</a><a href="#h14-0-180" id="h14-0-180" class="i">+n5@4 → n1 Append base=6@3 []
</a><a href="#h14-0-181" id="h14-0-181" class="i">+n5@4 → n2 Append base=6@3 []
</a><a href="#h14-0-182" id="h14-0-182" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→7 2:0→7 3:9→11 4:9→11}
</a><a href="#h14-0-183" id="h14-0-183" class="i">+n1@4 → n5 AppendResponse reject_index=6
</a><a href="#h14-0-184" id="h14-0-184" class="i">+n2@4 → n5 AppendResponse reject_index=6
</a><a href="#h14-0-185" id="h14-0-185" class="i">+
</a><a href="#h14-0-186" id="h14-0-186" class="i">+deliver 5
</a><a href="#h14-0-187" id="h14-0-187" class="i">+status 5
</a><a href="#h14-0-188" id="h14-0-188" class="i">+deliver 1 2
</a><a href="#h14-0-189" id="h14-0-189" class="i">+---
</a><a href="#h14-0-190" id="h14-0-190" class="i">+n5@4 → n1 Append base=5@2 []
</a><a href="#h14-0-191" id="h14-0-191" class="i">+n5@4 → n2 Append base=5@2 []
</a><a href="#h14-0-192" id="h14-0-192" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→6 2:0→6 3:9→11 4:9→11}
</a><a href="#h14-0-193" id="h14-0-193" class="i">+n1@4 → n5 AppendResponse reject_index=5
</a><a href="#h14-0-194" id="h14-0-194" class="i">+n2@4 → n5 AppendResponse reject_index=5
</a><a href="#h14-0-195" id="h14-0-195" class="i">+
</a><a href="#h14-0-196" id="h14-0-196" class="i">+deliver 5
</a><a href="#h14-0-197" id="h14-0-197" class="i">+status 5
</a><a href="#h14-0-198" id="h14-0-198" class="i">+deliver 1 2
</a><a href="#h14-0-199" id="h14-0-199" class="i">+---
</a><a href="#h14-0-200" id="h14-0-200" class="i">+n5@4 → n1 Append base=4@2 []
</a><a href="#h14-0-201" id="h14-0-201" class="i">+n5@4 → n2 Append base=4@2 []
</a><a href="#h14-0-202" id="h14-0-202" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→5 2:0→5 3:9→11 4:9→11}
</a><a href="#h14-0-203" id="h14-0-203" class="i">+n1@4 → n5 AppendResponse reject_index=4
</a><a href="#h14-0-204" id="h14-0-204" class="i">+n2@4 → n5 AppendResponse reject_index=4
</a><a href="#h14-0-205" id="h14-0-205" class="i">+
</a><a href="#h14-0-206" id="h14-0-206" class="i">+deliver 5
</a><a href="#h14-0-207" id="h14-0-207" class="i">+status 5
</a><a href="#h14-0-208" id="h14-0-208" class="i">+deliver 1 2
</a><a href="#h14-0-209" id="h14-0-209" class="i">+---
</a><a href="#h14-0-210" id="h14-0-210" class="i">+n5@4 → n1 Append base=3@1 []
</a><a href="#h14-0-211" id="h14-0-211" class="i">+n5@4 → n2 Append base=3@1 []
</a><a href="#h14-0-212" id="h14-0-212" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→4 2:0→4 3:9→11 4:9→11}
</a><a href="#h14-0-213" id="h14-0-213" class="i">+n1@4 → n5 AppendResponse match_index=3
</a><a href="#h14-0-214" id="h14-0-214" class="i">+n2@4 → n5 AppendResponse match_index=3
</a><a href="#h14-0-215" id="h14-0-215" class="i">+
</a><a href="#h14-0-216" id="h14-0-216" class="i">+# n5 can now replicate the tail to n1 and n2, allowing n5 to commit it.
</a><a href="#h14-0-217" id="h14-0-217" class="i">+deliver 5
</a><a href="#h14-0-218" id="h14-0-218" class="i">+status 5
</a><a href="#h14-0-219" id="h14-0-219" class="i">+deliver 1 2
</a><a href="#h14-0-220" id="h14-0-220" class="i">+---
</a><a href="#h14-0-221" id="h14-0-221" class="i">+n5@4 → n1 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
</a><a href="#h14-0-222" id="h14-0-222" class="i">+n5@4 → n2 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
</a><a href="#h14-0-223" id="h14-0-223" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:3→11 2:3→11 3:9→11 4:9→11}
</a><a href="#h14-0-224" id="h14-0-224" class="i">+n1@4 → n5 AppendResponse match_index=10
</a><a href="#h14-0-225" id="h14-0-225" class="i">+n2@4 → n5 AppendResponse match_index=10
</a><a href="#h14-0-226" id="h14-0-226" class="i">+
</a><a href="#h14-0-227" id="h14-0-227" class="i">+deliver 5
</a><a href="#h14-0-228" id="h14-0-228" class="i">+---
</a><a href="#h14-0-229" id="h14-0-229" class="i">+n5@4 commit 10@4
</a><a href="#h14-0-230" id="h14-0-230" class="i">+n5@4 apply 10@4 put f=6
</a><a href="#h14-0-231" id="h14-0-231" class="i">+n5@4 → c5 ClientResponse id=0x0f write 0x010a
</a><a href="#h14-0-232" id="h14-0-232" class="i">+c5@4 put f=6 ⇒ 10
</a><a href="#h14-0-233" id="h14-0-233" class="i">+
</a><a href="#h14-0-234" id="h14-0-234" class="i">+status
</a><a href="#h14-0-235" id="h14-0-235" class="i">+---
</a><a href="#h14-0-236" id="h14-0-236" class="i">+n1@4 follower(n5) last=10@4 commit=3@1 apply=3
</a><a href="#h14-0-237" id="h14-0-237" class="i">+n2@4 follower(n5) last=10@4 commit=1@1 apply=1
</a><a href="#h14-0-238" id="h14-0-238" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-239" id="h14-0-239" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h14-0-240" id="h14-0-240" class="i">+n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:10→11 2:10→11 3:9→11 4:9→11}
</a><a href="#h14-0-241" id="h14-0-241" class="i">+
</a><a href="#h14-0-242" id="h14-0-242" class="i">+# Stabilize the cluster.
</a><a href="#h14-0-243" id="h14-0-243" class="i">+(stabilize heartbeat=true)
</a><a href="#h14-0-244" id="h14-0-244" class="i">+status
</a><a href="#h14-0-245" id="h14-0-245" class="i">+---
</a><a href="#h14-0-246" id="h14-0-246" class="i">+n1@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-0-247" id="h14-0-247" class="i">+n2@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-0-248" id="h14-0-248" class="i">+n3@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-0-249" id="h14-0-249" class="i">+n4@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h14-0-250" id="h14-0-250" class="i">+n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:10→11 2:10→11 3:10→11 4:10→11}
</a><b>diff --git a/<a id="h15" href="../file/src/raft/testscripts/node/append_probe_divergent_short.html">src/raft/testscripts/node/append_probe_divergent_short</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_short.html">src/raft/testscripts/node/append_probe_divergent_short</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,190 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+# Appends to a previous leader and follower with a shorter divergent tail skips
</a><a href="#h15-0-1" id="h15-0-1" class="i">+# the missing entries before probing.
</a><a href="#h15-0-2" id="h15-0-2" class="i">+
</a><a href="#h15-0-3" id="h15-0-3" class="i">+cluster nodes=5 leader=1
</a><a href="#h15-0-4" id="h15-0-4" class="i">+---
</a><a href="#h15-0-5" id="h15-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h15-0-6" id="h15-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-7" id="h15-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-8" id="h15-0-8" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-9" id="h15-0-9" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h15-0-10" id="h15-0-10" class="i">+
</a><a href="#h15-0-11" id="h15-0-11" class="i">+# Make a couple of writes to ensure a common log prefix.
</a><a href="#h15-0-12" id="h15-0-12" class="i">+(put 1 a=1)
</a><a href="#h15-0-13" id="h15-0-13" class="i">+(put 1 b=2)
</a><a href="#h15-0-14" id="h15-0-14" class="i">+(stabilize)
</a><a href="#h15-0-15" id="h15-0-15" class="i">+status
</a><a href="#h15-0-16" id="h15-0-16" class="i">+---
</a><a href="#h15-0-17" id="h15-0-17" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h15-0-18" id="h15-0-18" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-19" id="h15-0-19" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-20" id="h15-0-20" class="i">+n4@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-21" id="h15-0-21" class="i">+n5@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-22" id="h15-0-22" class="i">+
</a><a href="#h15-0-23" id="h15-0-23" class="i">+# Partition n1-n2
</a><a href="#h15-0-24" id="h15-0-24" class="i">+partition 1 2
</a><a href="#h15-0-25" id="h15-0-25" class="i">+---
</a><a href="#h15-0-26" id="h15-0-26" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h15-0-27" id="h15-0-27" class="i">+
</a><a href="#h15-0-28" id="h15-0-28" class="i">+# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h15-0-29" id="h15-0-29" class="i">+# Multiple leaders ensures the log has multiple terms.
</a><a href="#h15-0-30" id="h15-0-30" class="i">+(campaign 3)
</a><a href="#h15-0-31" id="h15-0-31" class="i">+(stabilize)
</a><a href="#h15-0-32" id="h15-0-32" class="i">+(put 3 c=3)
</a><a href="#h15-0-33" id="h15-0-33" class="i">+(stabilize heartbeat=true)
</a><a href="#h15-0-34" id="h15-0-34" class="i">+status
</a><a href="#h15-0-35" id="h15-0-35" class="i">+---
</a><a href="#h15-0-36" id="h15-0-36" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h15-0-37" id="h15-0-37" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-38" id="h15-0-38" class="i">+n3@2 leader last=5@2 commit=5@2 apply=5 progress={1:0→6 2:0→6 4:5→6 5:5→6}
</a><a href="#h15-0-39" id="h15-0-39" class="i">+n4@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h15-0-40" id="h15-0-40" class="i">+n5@2 follower(n3) last=5@2 commit=5@2 apply=5
</a><a href="#h15-0-41" id="h15-0-41" class="i">+
</a><a href="#h15-0-42" id="h15-0-42" class="i">+(campaign 4)
</a><a href="#h15-0-43" id="h15-0-43" class="i">+(stabilize)
</a><a href="#h15-0-44" id="h15-0-44" class="i">+(put 4 d=4)
</a><a href="#h15-0-45" id="h15-0-45" class="i">+(stabilize heartbeat=true)
</a><a href="#h15-0-46" id="h15-0-46" class="i">+status
</a><a href="#h15-0-47" id="h15-0-47" class="i">+---
</a><a href="#h15-0-48" id="h15-0-48" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h15-0-49" id="h15-0-49" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-50" id="h15-0-50" class="i">+n3@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h15-0-51" id="h15-0-51" class="i">+n4@3 leader last=7@3 commit=7@3 apply=7 progress={1:0→8 2:0→8 3:7→8 5:7→8}
</a><a href="#h15-0-52" id="h15-0-52" class="i">+n5@3 follower(n4) last=7@3 commit=7@3 apply=7
</a><a href="#h15-0-53" id="h15-0-53" class="i">+
</a><a href="#h15-0-54" id="h15-0-54" class="i">+(campaign 5)
</a><a href="#h15-0-55" id="h15-0-55" class="i">+(stabilize)
</a><a href="#h15-0-56" id="h15-0-56" class="i">+(put 5 e=5)
</a><a href="#h15-0-57" id="h15-0-57" class="i">+(stabilize heartbeat=true)
</a><a href="#h15-0-58" id="h15-0-58" class="i">+status
</a><a href="#h15-0-59" id="h15-0-59" class="i">+---
</a><a href="#h15-0-60" id="h15-0-60" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4 4:3→4 5:3→4}
</a><a href="#h15-0-61" id="h15-0-61" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h15-0-62" id="h15-0-62" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-63" id="h15-0-63" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-64" id="h15-0-64" class="i">+n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:0→10 2:0→10 3:9→10 4:9→10}
</a><a href="#h15-0-65" id="h15-0-65" class="i">+
</a><a href="#h15-0-66" id="h15-0-66" class="i">+# Propose a single write in the minority partition. The divergent minority log
</a><a href="#h15-0-67" id="h15-0-67" class="i">+# is much shorter than the majority log.
</a><a href="#h15-0-68" id="h15-0-68" class="i">+(put 1 a=2)
</a><a href="#h15-0-69" id="h15-0-69" class="i">+(stabilize)
</a><a href="#h15-0-70" id="h15-0-70" class="i">+status
</a><a href="#h15-0-71" id="h15-0-71" class="i">+---
</a><a href="#h15-0-72" id="h15-0-72" class="i">+n1@1 leader last=4@1 commit=3@1 apply=3 progress={2:4→5 3:3→5 4:3→5 5:3→5}
</a><a href="#h15-0-73" id="h15-0-73" class="i">+n2@1 follower(n1) last=4@1 commit=1@1 apply=1
</a><a href="#h15-0-74" id="h15-0-74" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-75" id="h15-0-75" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-76" id="h15-0-76" class="i">+n5@4 leader last=9@4 commit=9@4 apply=9 progress={1:0→10 2:0→10 3:9→10 4:9→10}
</a><a href="#h15-0-77" id="h15-0-77" class="i">+
</a><a href="#h15-0-78" id="h15-0-78" class="i">+log 1 5
</a><a href="#h15-0-79" id="h15-0-79" class="i">+---
</a><a href="#h15-0-80" id="h15-0-80" class="i">+n1@1 last=4@1 commit=3@1
</a><a href="#h15-0-81" id="h15-0-81" class="i">+n1@1 entry 1@1 None
</a><a href="#h15-0-82" id="h15-0-82" class="i">+n1@1 entry 2@1 put a=1
</a><a href="#h15-0-83" id="h15-0-83" class="i">+n1@1 entry 3@1 put b=2
</a><a href="#h15-0-84" id="h15-0-84" class="i">+n1@1 entry 4@1 put a=2
</a><a href="#h15-0-85" id="h15-0-85" class="i">+n5@4 last=9@4 commit=9@4
</a><a href="#h15-0-86" id="h15-0-86" class="i">+n5@4 entry 1@1 None
</a><a href="#h15-0-87" id="h15-0-87" class="i">+n5@4 entry 2@1 put a=1
</a><a href="#h15-0-88" id="h15-0-88" class="i">+n5@4 entry 3@1 put b=2
</a><a href="#h15-0-89" id="h15-0-89" class="i">+n5@4 entry 4@2 None
</a><a href="#h15-0-90" id="h15-0-90" class="i">+n5@4 entry 5@2 put c=3
</a><a href="#h15-0-91" id="h15-0-91" class="i">+n5@4 entry 6@3 None
</a><a href="#h15-0-92" id="h15-0-92" class="i">+n5@4 entry 7@3 put d=4
</a><a href="#h15-0-93" id="h15-0-93" class="i">+n5@4 entry 8@4 None
</a><a href="#h15-0-94" id="h15-0-94" class="i">+n5@4 entry 9@4 put e=5
</a><a href="#h15-0-95" id="h15-0-95" class="i">+
</a><a href="#h15-0-96" id="h15-0-96" class="i">+# Heal the partition.
</a><a href="#h15-0-97" id="h15-0-97" class="i">+heal
</a><a href="#h15-0-98" id="h15-0-98" class="i">+---
</a><a href="#h15-0-99" id="h15-0-99" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h15-0-100" id="h15-0-100" class="i">+
</a><a href="#h15-0-101" id="h15-0-101" class="i">+# Propose another write on the majority leader.
</a><a href="#h15-0-102" id="h15-0-102" class="i">+put 5 f=6
</a><a href="#h15-0-103" id="h15-0-103" class="i">+---
</a><a href="#h15-0-104" id="h15-0-104" class="i">+c5@4 → n5 ClientRequest id=0x07 write 0x0101660136
</a><a href="#h15-0-105" id="h15-0-105" class="i">+n5@4 append 10@4 put f=6
</a><a href="#h15-0-106" id="h15-0-106" class="i">+n5@4 → n1 Append base=9@4 [10@4]
</a><a href="#h15-0-107" id="h15-0-107" class="i">+n5@4 → n2 Append base=9@4 [10@4]
</a><a href="#h15-0-108" id="h15-0-108" class="i">+n5@4 → n3 Append base=9@4 [10@4]
</a><a href="#h15-0-109" id="h15-0-109" class="i">+n5@4 → n4 Append base=9@4 [10@4]
</a><a href="#h15-0-110" id="h15-0-110" class="i">+
</a><a href="#h15-0-111" id="h15-0-111" class="i">+# Delivering the appends to n1 and n2 should reject them, but with a
</a><a href="#h15-0-112" id="h15-0-112" class="i">+# reject_index=5 after their last index instead of the original base 9. It also
</a><a href="#h15-0-113" id="h15-0-113" class="i">+# cancels the in-flight write requests on n1.
</a><a href="#h15-0-114" id="h15-0-114" class="i">+deliver 1 2
</a><a href="#h15-0-115" id="h15-0-115" class="i">+---
</a><a href="#h15-0-116" id="h15-0-116" class="i">+n1@1 leader ⇨ n1@4 follower(n5)
</a><a href="#h15-0-117" id="h15-0-117" class="i">+n1@1 → c1 ClientResponse id=0x06 Error::Abort
</a><a href="#h15-0-118" id="h15-0-118" class="i">+c1@1 put a=2 ⇒ Error::Abort (operation aborted)
</a><a href="#h15-0-119" id="h15-0-119" class="i">+n1@4 → n5 AppendResponse reject_index=5
</a><a href="#h15-0-120" id="h15-0-120" class="i">+n2@1 follower(n1) ⇨ n2@4 follower(n5)
</a><a href="#h15-0-121" id="h15-0-121" class="i">+n2@4 → n5 AppendResponse reject_index=5
</a><a href="#h15-0-122" id="h15-0-122" class="i">+
</a><a href="#h15-0-123" id="h15-0-123" class="i">+# n5 will probe the previous base, which is again rejected. This repeats until
</a><a href="#h15-0-124" id="h15-0-124" class="i">+# a common base is found at 3@1.
</a><a href="#h15-0-125" id="h15-0-125" class="i">+deliver 5
</a><a href="#h15-0-126" id="h15-0-126" class="i">+status 5
</a><a href="#h15-0-127" id="h15-0-127" class="i">+deliver 1 2
</a><a href="#h15-0-128" id="h15-0-128" class="i">+---
</a><a href="#h15-0-129" id="h15-0-129" class="i">+n5@4 → n1 Append base=4@2 []
</a><a href="#h15-0-130" id="h15-0-130" class="i">+n5@4 → n2 Append base=4@2 []
</a><a href="#h15-0-131" id="h15-0-131" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→5 2:0→5 3:9→11 4:9→11}
</a><a href="#h15-0-132" id="h15-0-132" class="i">+n1@4 → n5 AppendResponse reject_index=4
</a><a href="#h15-0-133" id="h15-0-133" class="i">+n2@4 → n5 AppendResponse reject_index=4
</a><a href="#h15-0-134" id="h15-0-134" class="i">+
</a><a href="#h15-0-135" id="h15-0-135" class="i">+deliver 5
</a><a href="#h15-0-136" id="h15-0-136" class="i">+deliver 1 2
</a><a href="#h15-0-137" id="h15-0-137" class="i">+status 5
</a><a href="#h15-0-138" id="h15-0-138" class="i">+---
</a><a href="#h15-0-139" id="h15-0-139" class="i">+n5@4 → n1 Append base=3@1 []
</a><a href="#h15-0-140" id="h15-0-140" class="i">+n5@4 → n2 Append base=3@1 []
</a><a href="#h15-0-141" id="h15-0-141" class="i">+n1@4 → n5 AppendResponse match_index=3
</a><a href="#h15-0-142" id="h15-0-142" class="i">+n2@4 → n5 AppendResponse match_index=3
</a><a href="#h15-0-143" id="h15-0-143" class="i">+n5@4 leader last=10@4 commit=9@4 apply=9 progress={1:0→4 2:0→4 3:9→11 4:9→11}
</a><a href="#h15-0-144" id="h15-0-144" class="i">+
</a><a href="#h15-0-145" id="h15-0-145" class="i">+# n5 can now replicate the tail to n1 and n2, allowing n5 to commit it.
</a><a href="#h15-0-146" id="h15-0-146" class="i">+deliver 5
</a><a href="#h15-0-147" id="h15-0-147" class="i">+deliver 1 2
</a><a href="#h15-0-148" id="h15-0-148" class="i">+---
</a><a href="#h15-0-149" id="h15-0-149" class="i">+n5@4 → n1 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
</a><a href="#h15-0-150" id="h15-0-150" class="i">+n5@4 → n2 Append base=3@1 [4@2 5@2 6@3 7@3 8@4 9@4 10@4]
</a><a href="#h15-0-151" id="h15-0-151" class="i">+n1@4 append 5@2 put c=3
</a><a href="#h15-0-152" id="h15-0-152" class="i">+n1@4 append 6@3 None
</a><a href="#h15-0-153" id="h15-0-153" class="i">+n1@4 append 7@3 put d=4
</a><a href="#h15-0-154" id="h15-0-154" class="i">+n1@4 append 8@4 None
</a><a href="#h15-0-155" id="h15-0-155" class="i">+n1@4 append 9@4 put e=5
</a><a href="#h15-0-156" id="h15-0-156" class="i">+n1@4 append 10@4 put f=6
</a><a href="#h15-0-157" id="h15-0-157" class="i">+n1@4 → n5 AppendResponse match_index=10
</a><a href="#h15-0-158" id="h15-0-158" class="i">+n2@4 append 5@2 put c=3
</a><a href="#h15-0-159" id="h15-0-159" class="i">+n2@4 append 6@3 None
</a><a href="#h15-0-160" id="h15-0-160" class="i">+n2@4 append 7@3 put d=4
</a><a href="#h15-0-161" id="h15-0-161" class="i">+n2@4 append 8@4 None
</a><a href="#h15-0-162" id="h15-0-162" class="i">+n2@4 append 9@4 put e=5
</a><a href="#h15-0-163" id="h15-0-163" class="i">+n2@4 append 10@4 put f=6
</a><a href="#h15-0-164" id="h15-0-164" class="i">+n2@4 → n5 AppendResponse match_index=10
</a><a href="#h15-0-165" id="h15-0-165" class="i">+
</a><a href="#h15-0-166" id="h15-0-166" class="i">+deliver 5
</a><a href="#h15-0-167" id="h15-0-167" class="i">+---
</a><a href="#h15-0-168" id="h15-0-168" class="i">+n5@4 commit 10@4
</a><a href="#h15-0-169" id="h15-0-169" class="i">+n5@4 apply 10@4 put f=6
</a><a href="#h15-0-170" id="h15-0-170" class="i">+n5@4 → c5 ClientResponse id=0x07 write 0x010a
</a><a href="#h15-0-171" id="h15-0-171" class="i">+c5@4 put f=6 ⇒ 10
</a><a href="#h15-0-172" id="h15-0-172" class="i">+
</a><a href="#h15-0-173" id="h15-0-173" class="i">+status
</a><a href="#h15-0-174" id="h15-0-174" class="i">+---
</a><a href="#h15-0-175" id="h15-0-175" class="i">+n1@4 follower(n5) last=10@4 commit=3@1 apply=3
</a><a href="#h15-0-176" id="h15-0-176" class="i">+n2@4 follower(n5) last=10@4 commit=1@1 apply=1
</a><a href="#h15-0-177" id="h15-0-177" class="i">+n3@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-178" id="h15-0-178" class="i">+n4@4 follower(n5) last=9@4 commit=9@4 apply=9
</a><a href="#h15-0-179" id="h15-0-179" class="i">+n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:10→11 2:10→11 3:9→11 4:9→11}
</a><a href="#h15-0-180" id="h15-0-180" class="i">+
</a><a href="#h15-0-181" id="h15-0-181" class="i">+# Stabilize the cluster.
</a><a href="#h15-0-182" id="h15-0-182" class="i">+(stabilize heartbeat=true)
</a><a href="#h15-0-183" id="h15-0-183" class="i">+status
</a><a href="#h15-0-184" id="h15-0-184" class="i">+---
</a><a href="#h15-0-185" id="h15-0-185" class="i">+n1@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-0-186" id="h15-0-186" class="i">+n2@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-0-187" id="h15-0-187" class="i">+n3@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-0-188" id="h15-0-188" class="i">+n4@4 follower(n5) last=10@4 commit=10@4 apply=10
</a><a href="#h15-0-189" id="h15-0-189" class="i">+n5@4 leader last=10@4 commit=10@4 apply=10 progress={1:10→11 2:10→11 3:10→11 4:10→11}
</a><b>diff --git a/<a id="h16" href="../file/src/raft/testscripts/node/append_probe_divergent_single.html">src/raft/testscripts/node/append_probe_divergent_single</a> b/<a href="../file/src/raft/testscripts/node/append_probe_divergent_single.html">src/raft/testscripts/node/append_probe_divergent_single</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,120 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+# An append replaces a conflict at the tail for a single term.
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+cluster nodes=5 leader=1
</a><a href="#h16-0-3" id="h16-0-3" class="i">+---
</a><a href="#h16-0-4" id="h16-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2 4:1→2 5:1→2}
</a><a href="#h16-0-5" id="h16-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-6" id="h16-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-7" id="h16-0-7" class="i">+n4@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-8" id="h16-0-8" class="i">+n5@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h16-0-9" id="h16-0-9" class="i">+
</a><a href="#h16-0-10" id="h16-0-10" class="i">+# Partition n3-n5.
</a><a href="#h16-0-11" id="h16-0-11" class="i">+partition 3 4 5
</a><a href="#h16-0-12" id="h16-0-12" class="i">+---
</a><a href="#h16-0-13" id="h16-0-13" class="i">+n1 n2 ⇹ n3 n4 n5
</a><a href="#h16-0-14" id="h16-0-14" class="i">+
</a><a href="#h16-0-15" id="h16-0-15" class="i">+# Propose and replicate a write in the minority partition.
</a><a href="#h16-0-16" id="h16-0-16" class="i">+put 1 a=1
</a><a href="#h16-0-17" id="h16-0-17" class="i">+stabilize
</a><a href="#h16-0-18" id="h16-0-18" class="i">+---
</a><a href="#h16-0-19" id="h16-0-19" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h16-0-20" id="h16-0-20" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h16-0-21" id="h16-0-21" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h16-0-22" id="h16-0-22" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h16-0-23" id="h16-0-23" class="i">+n1@1 ⇥ n4 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h16-0-24" id="h16-0-24" class="i">+n1@1 ⇥ n5 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h16-0-25" id="h16-0-25" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h16-0-26" id="h16-0-26" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h16-0-27" id="h16-0-27" class="i">+
</a><a href="#h16-0-28" id="h16-0-28" class="i">+log 1 2
</a><a href="#h16-0-29" id="h16-0-29" class="i">+---
</a><a href="#h16-0-30" id="h16-0-30" class="i">+n1@1 last=2@1 commit=1@1
</a><a href="#h16-0-31" id="h16-0-31" class="i">+n1@1 entry 1@1 None
</a><a href="#h16-0-32" id="h16-0-32" class="i">+n1@1 entry 2@1 put a=1
</a><a href="#h16-0-33" id="h16-0-33" class="i">+n2@1 last=2@1 commit=1@1
</a><a href="#h16-0-34" id="h16-0-34" class="i">+n2@1 entry 1@1 None
</a><a href="#h16-0-35" id="h16-0-35" class="i">+n2@1 entry 2@1 put a=1
</a><a href="#h16-0-36" id="h16-0-36" class="i">+
</a><a href="#h16-0-37" id="h16-0-37" class="i">+# Elect n5 as a new majority partition leader. It appends an empty entry.
</a><a href="#h16-0-38" id="h16-0-38" class="i">+(campaign 5)
</a><a href="#h16-0-39" id="h16-0-39" class="i">+(stabilize heartbeat=true)
</a><a href="#h16-0-40" id="h16-0-40" class="i">+status
</a><a href="#h16-0-41" id="h16-0-41" class="i">+---
</a><a href="#h16-0-42" id="h16-0-42" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→3 4:1→3 5:1→3}
</a><a href="#h16-0-43" id="h16-0-43" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h16-0-44" id="h16-0-44" class="i">+n3@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h16-0-45" id="h16-0-45" class="i">+n4@2 follower(n5) last=2@2 commit=2@2 apply=2
</a><a href="#h16-0-46" id="h16-0-46" class="i">+n5@2 leader last=2@2 commit=2@2 apply=2 progress={1:0→3 2:0→3 3:2→3 4:2→3}
</a><a href="#h16-0-47" id="h16-0-47" class="i">+
</a><a href="#h16-0-48" id="h16-0-48" class="i">+# Heal the partition and propose a new write.
</a><a href="#h16-0-49" id="h16-0-49" class="i">+heal
</a><a href="#h16-0-50" id="h16-0-50" class="i">+put 5 b=2
</a><a href="#h16-0-51" id="h16-0-51" class="i">+---
</a><a href="#h16-0-52" id="h16-0-52" class="i">+n1 n2 n3 n4 n5 fully connected
</a><a href="#h16-0-53" id="h16-0-53" class="i">+c5@2 → n5 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h16-0-54" id="h16-0-54" class="i">+n5@2 append 3@2 put b=2
</a><a href="#h16-0-55" id="h16-0-55" class="i">+n5@2 → n1 Append base=2@2 [3@2]
</a><a href="#h16-0-56" id="h16-0-56" class="i">+n5@2 → n2 Append base=2@2 [3@2]
</a><a href="#h16-0-57" id="h16-0-57" class="i">+n5@2 → n3 Append base=2@2 [3@2]
</a><a href="#h16-0-58" id="h16-0-58" class="i">+n5@2 → n4 Append base=2@2 [3@2]
</a><a href="#h16-0-59" id="h16-0-59" class="i">+
</a><a href="#h16-0-60" id="h16-0-60" class="i">+# Delivering the append messages to n1,n2 will make them follow n5 and
</a><a href="#h16-0-61" id="h16-0-61" class="i">+# reject the appends due to a log mismatch.
</a><a href="#h16-0-62" id="h16-0-62" class="i">+deliver 1 2
</a><a href="#h16-0-63" id="h16-0-63" class="i">+---
</a><a href="#h16-0-64" id="h16-0-64" class="i">+n1@1 leader ⇨ n1@2 follower(n5)
</a><a href="#h16-0-65" id="h16-0-65" class="i">+n1@1 → c1 ClientResponse id=0x01 Error::Abort
</a><a href="#h16-0-66" id="h16-0-66" class="i">+c1@1 put a=1 ⇒ Error::Abort (operation aborted)
</a><a href="#h16-0-67" id="h16-0-67" class="i">+n1@2 → n5 AppendResponse reject_index=2
</a><a href="#h16-0-68" id="h16-0-68" class="i">+n2@1 follower(n1) ⇨ n2@2 follower(n5)
</a><a href="#h16-0-69" id="h16-0-69" class="i">+n2@2 → n5 AppendResponse reject_index=2
</a><a href="#h16-0-70" id="h16-0-70" class="i">+
</a><a href="#h16-0-71" id="h16-0-71" class="i">+# n5 probes index 1, which succeeds. 1 and 2 still has the old logs.
</a><a href="#h16-0-72" id="h16-0-72" class="i">+deliver 5
</a><a href="#h16-0-73" id="h16-0-73" class="i">+deliver 1 2
</a><a href="#h16-0-74" id="h16-0-74" class="i">+---
</a><a href="#h16-0-75" id="h16-0-75" class="i">+n5@2 → n1 Append base=1@1 []
</a><a href="#h16-0-76" id="h16-0-76" class="i">+n5@2 → n2 Append base=1@1 []
</a><a href="#h16-0-77" id="h16-0-77" class="i">+n1@2 → n5 AppendResponse match_index=1
</a><a href="#h16-0-78" id="h16-0-78" class="i">+n2@2 → n5 AppendResponse match_index=1
</a><a href="#h16-0-79" id="h16-0-79" class="i">+
</a><a href="#h16-0-80" id="h16-0-80" class="i">+log 1 2
</a><a href="#h16-0-81" id="h16-0-81" class="i">+---
</a><a href="#h16-0-82" id="h16-0-82" class="i">+n1@2 last=2@1 commit=1@1
</a><a href="#h16-0-83" id="h16-0-83" class="i">+n1@2 entry 1@1 None
</a><a href="#h16-0-84" id="h16-0-84" class="i">+n1@2 entry 2@1 put a=1
</a><a href="#h16-0-85" id="h16-0-85" class="i">+n2@2 last=2@1 commit=1@1
</a><a href="#h16-0-86" id="h16-0-86" class="i">+n2@2 entry 1@1 None
</a><a href="#h16-0-87" id="h16-0-87" class="i">+n2@2 entry 2@1 put a=1
</a><a href="#h16-0-88" id="h16-0-88" class="i">+
</a><a href="#h16-0-89" id="h16-0-89" class="i">+# n5 now replicates the tail of its log, which replaces the old logs.
</a><a href="#h16-0-90" id="h16-0-90" class="i">+deliver 5
</a><a href="#h16-0-91" id="h16-0-91" class="i">+deliver 1 2
</a><a href="#h16-0-92" id="h16-0-92" class="i">+---
</a><a href="#h16-0-93" id="h16-0-93" class="i">+n5@2 → n1 Append base=1@1 [2@2 3@2]
</a><a href="#h16-0-94" id="h16-0-94" class="i">+n5@2 → n2 Append base=1@1 [2@2 3@2]
</a><a href="#h16-0-95" id="h16-0-95" class="i">+n1@2 append 3@2 put b=2
</a><a href="#h16-0-96" id="h16-0-96" class="i">+n1@2 → n5 AppendResponse match_index=3
</a><a href="#h16-0-97" id="h16-0-97" class="i">+n2@2 append 3@2 put b=2
</a><a href="#h16-0-98" id="h16-0-98" class="i">+n2@2 → n5 AppendResponse match_index=3
</a><a href="#h16-0-99" id="h16-0-99" class="i">+
</a><a href="#h16-0-100" id="h16-0-100" class="i">+log 1 2
</a><a href="#h16-0-101" id="h16-0-101" class="i">+---
</a><a href="#h16-0-102" id="h16-0-102" class="i">+n1@2 last=3@2 commit=1@1
</a><a href="#h16-0-103" id="h16-0-103" class="i">+n1@2 entry 1@1 None
</a><a href="#h16-0-104" id="h16-0-104" class="i">+n1@2 entry 2@2 None
</a><a href="#h16-0-105" id="h16-0-105" class="i">+n1@2 entry 3@2 put b=2
</a><a href="#h16-0-106" id="h16-0-106" class="i">+n2@2 last=3@2 commit=1@1
</a><a href="#h16-0-107" id="h16-0-107" class="i">+n2@2 entry 1@1 None
</a><a href="#h16-0-108" id="h16-0-108" class="i">+n2@2 entry 2@2 None
</a><a href="#h16-0-109" id="h16-0-109" class="i">+n2@2 entry 3@2 put b=2
</a><a href="#h16-0-110" id="h16-0-110" class="i">+
</a><a href="#h16-0-111" id="h16-0-111" class="i">+# Stabilize the cluster.
</a><a href="#h16-0-112" id="h16-0-112" class="i">+(stabilize heartbeat=true)
</a><a href="#h16-0-113" id="h16-0-113" class="i">+status
</a><a href="#h16-0-114" id="h16-0-114" class="i">+---
</a><a href="#h16-0-115" id="h16-0-115" class="i">+n1@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-0-116" id="h16-0-116" class="i">+n2@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-0-117" id="h16-0-117" class="i">+n3@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-0-118" id="h16-0-118" class="i">+n4@2 follower(n5) last=3@2 commit=3@2 apply=3
</a><a href="#h16-0-119" id="h16-0-119" class="i">+n5@2 leader last=3@2 commit=3@2 apply=3 progress={1:3→4 2:3→4 3:3→4 4:3→4}
</a><b>diff --git a/<a id="h17" href="../file/src/raft/testscripts/node/append_response_beyond_last_index_panics.html">src/raft/testscripts/node/append_response_beyond_last_index_panics</a> b/<a href="../file/src/raft/testscripts/node/append_response_beyond_last_index_panics.html">src/raft/testscripts/node/append_response_beyond_last_index_panics</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -16,6 +16,6 @@ n1@1 → n2 Append base=1@1 [2@1]
</a> n1@1 → n3 Append base=1@1 [2@1]
 
 # An AppendResponse beyond leader&#39;s last log should panic.
<a href="#h17-0-3" id="h17-0-3" class="d">-!step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;last_index&quot;:3,&quot;last_term&quot;:1,&quot;reject_index&quot;:0}}}&#39;
</a><a href="#h17-0-4" id="h17-0-4" class="i">+!step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:3,&quot;reject_index&quot;:0}}}&#39;
</a> ---
<a href="#h17-0-6" id="h17-0-6" class="d">-Panic: follower appended future entries
</a><a href="#h17-0-7" id="h17-0-7" class="i">+Panic: follower matched unknown index
</a><b>diff --git a/<a id="h18" href="../file/src/raft/testscripts/node/append_response_beyond_last_term_panics.html">src/raft/testscripts/node/append_response_beyond_last_term_panics</a> b/<a href="../file/src/raft/testscripts/node/append_response_beyond_last_term_panics.html">src/raft/testscripts/node/append_response_beyond_last_term_panics</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,21 +0,0 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-# A successful AppendResponse with last term beyond leader&#39;s last term
</a><a href="#h18-0-1" id="h18-0-1" class="d">-# should panic.
</a><a href="#h18-0-2" id="h18-0-2" class="d">-
</a><a href="#h18-0-3" id="h18-0-3" class="d">-cluster nodes=3 leader=1
</a><a href="#h18-0-4" id="h18-0-4" class="d">----
</a><a href="#h18-0-5" id="h18-0-5" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h18-0-6" id="h18-0-6" class="d">-n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-7" id="h18-0-7" class="d">-n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h18-0-8" id="h18-0-8" class="d">-
</a><a href="#h18-0-9" id="h18-0-9" class="d">-# Propose a write.
</a><a href="#h18-0-10" id="h18-0-10" class="d">-put 1 foo=bar
</a><a href="#h18-0-11" id="h18-0-11" class="d">----
</a><a href="#h18-0-12" id="h18-0-12" class="d">-c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h18-0-13" id="h18-0-13" class="d">-n1@1 append 2@1 put foo=bar
</a><a href="#h18-0-14" id="h18-0-14" class="d">-n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h18-0-15" id="h18-0-15" class="d">-n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h18-0-16" id="h18-0-16" class="d">-
</a><a href="#h18-0-17" id="h18-0-17" class="d">-# An AppendResponse beyond leader&#39;s last term should panic.
</a><a href="#h18-0-18" id="h18-0-18" class="d">-!step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;last_index&quot;:2,&quot;last_term&quot;:2,&quot;reject_index&quot;:0}}}&#39;
</a><a href="#h18-0-19" id="h18-0-19" class="d">----
</a><a href="#h18-0-20" id="h18-0-20" class="d">-Panic: follower appended future entries
</a><b>diff --git a/<a id="h19" href="../file/src/raft/testscripts/node/append_response_stale_reject.html">src/raft/testscripts/node/append_response_stale_reject</a> b/<a href="../file/src/raft/testscripts/node/append_response_stale_reject.html">src/raft/testscripts/node/append_response_stale_reject</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,61 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+# A successful AppendResponse with a reject_index below the match index
</a><a href="#h19-0-1" id="h19-0-1" class="i">+# should be ignored.
</a><a href="#h19-0-2" id="h19-0-2" class="i">+
</a><a href="#h19-0-3" id="h19-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h19-0-4" id="h19-0-4" class="i">+---
</a><a href="#h19-0-5" id="h19-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h19-0-6" id="h19-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-7" id="h19-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h19-0-8" id="h19-0-8" class="i">+
</a><a href="#h19-0-9" id="h19-0-9" class="i">+# Replicate a write.
</a><a href="#h19-0-10" id="h19-0-10" class="i">+(put 1 a=1)
</a><a href="#h19-0-11" id="h19-0-11" class="i">+(stabilize heartbeat=true)
</a><a href="#h19-0-12" id="h19-0-12" class="i">+status
</a><a href="#h19-0-13" id="h19-0-13" class="i">+---
</a><a href="#h19-0-14" id="h19-0-14" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h19-0-15" id="h19-0-15" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-16" id="h19-0-16" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-17" id="h19-0-17" class="i">+
</a><a href="#h19-0-18" id="h19-0-18" class="i">+# Propose a few writes.
</a><a href="#h19-0-19" id="h19-0-19" class="i">+(put 1 b=2)
</a><a href="#h19-0-20" id="h19-0-20" class="i">+(put 1 c=3)
</a><a href="#h19-0-21" id="h19-0-21" class="i">+status
</a><a href="#h19-0-22" id="h19-0-22" class="i">+---
</a><a href="#h19-0-23" id="h19-0-23" class="i">+n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→5 3:2→5}
</a><a href="#h19-0-24" id="h19-0-24" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-25" id="h19-0-25" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-26" id="h19-0-26" class="i">+
</a><a href="#h19-0-27" id="h19-0-27" class="i">+# A reject_index below the follower&#39;s progress match index is ignored.
</a><a href="#h19-0-28" id="h19-0-28" class="i">+step 1 &#39;{&quot;from&quot;:2,&quot;to&quot;:1,&quot;term&quot;:1,&quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:0,&quot;reject_index&quot;:2}}}&#39;
</a><a href="#h19-0-29" id="h19-0-29" class="i">+status
</a><a href="#h19-0-30" id="h19-0-30" class="i">+---
</a><a href="#h19-0-31" id="h19-0-31" class="i">+n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→5 3:2→5}
</a><a href="#h19-0-32" id="h19-0-32" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-33" id="h19-0-33" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-34" id="h19-0-34" class="i">+
</a><a href="#h19-0-35" id="h19-0-35" class="i">+step 1 &#39;{&quot;from&quot;:2,&quot;to&quot;:1,&quot;term&quot;:1,&quot;message&quot;:{&quot;AppendResponse&quot;:{&quot;match_index&quot;:0,&quot;reject_index&quot;:1}}}&#39;
</a><a href="#h19-0-36" id="h19-0-36" class="i">+status
</a><a href="#h19-0-37" id="h19-0-37" class="i">+---
</a><a href="#h19-0-38" id="h19-0-38" class="i">+n1@1 leader last=4@1 commit=2@1 apply=2 progress={2:2→5 3:2→5}
</a><a href="#h19-0-39" id="h19-0-39" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-40" id="h19-0-40" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h19-0-41" id="h19-0-41" class="i">+
</a><a href="#h19-0-42" id="h19-0-42" class="i">+# The writes are still replicated without any probes.
</a><a href="#h19-0-43" id="h19-0-43" class="i">+stabilize
</a><a href="#h19-0-44" id="h19-0-44" class="i">+---
</a><a href="#h19-0-45" id="h19-0-45" class="i">+n2@1 append 3@1 put b=2
</a><a href="#h19-0-46" id="h19-0-46" class="i">+n2@1 → n1 AppendResponse match_index=3
</a><a href="#h19-0-47" id="h19-0-47" class="i">+n2@1 append 4@1 put c=3
</a><a href="#h19-0-48" id="h19-0-48" class="i">+n2@1 → n1 AppendResponse match_index=4
</a><a href="#h19-0-49" id="h19-0-49" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h19-0-50" id="h19-0-50" class="i">+n3@1 → n1 AppendResponse match_index=3
</a><a href="#h19-0-51" id="h19-0-51" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h19-0-52" id="h19-0-52" class="i">+n3@1 → n1 AppendResponse match_index=4
</a><a href="#h19-0-53" id="h19-0-53" class="i">+n1@1 commit 3@1
</a><a href="#h19-0-54" id="h19-0-54" class="i">+n1@1 apply 3@1 put b=2
</a><a href="#h19-0-55" id="h19-0-55" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h19-0-56" id="h19-0-56" class="i">+c1@1 put b=2 ⇒ 3
</a><a href="#h19-0-57" id="h19-0-57" class="i">+n1@1 commit 4@1
</a><a href="#h19-0-58" id="h19-0-58" class="i">+n1@1 apply 4@1 put c=3
</a><a href="#h19-0-59" id="h19-0-59" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h19-0-60" id="h19-0-60" class="i">+c1@1 put c=3 ⇒ 4
</a><b>diff --git a/<a id="h20" href="../file/src/raft/testscripts/node/election.html">src/raft/testscripts/node/election</a> b/<a href="../file/src/raft/testscripts/node/election.html">src/raft/testscripts/node/election</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -33,37 +33,37 @@ n1@1 candidate ⇨ n1@1 leader
</a> n1@1 append 1@1 None
 n1@1 → n2 Append base=0@0 [1@1]
 n1@1 → n3 Append base=0@0 [1@1]
<a href="#h20-0-3" id="h20-0-3" class="d">-n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-4" id="h20-0-4" class="d">-n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h20-0-5" id="h20-0-5" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h20-0-6" id="h20-0-6" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 # All nodes become n1 followers.
 stabilize
 ---
 n2@1 follower() ⇨ n2@1 follower(n1)
 n2@1 append 1@1 None
<a href="#h20-0-13" id="h20-0-13" class="d">-n2@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h20-0-14" id="h20-0-14" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-15" id="h20-0-15" class="i">+n2@1 → n1 AppendResponse match_index=1
</a><a href="#h20-0-16" id="h20-0-16" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n3@1 follower() ⇨ n3@1 follower(n1)
 n3@1 append 1@1 None
<a href="#h20-0-19" id="h20-0-19" class="d">-n3@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h20-0-20" id="h20-0-20" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-21" id="h20-0-21" class="i">+n3@1 → n1 AppendResponse match_index=1
</a><a href="#h20-0-22" id="h20-0-22" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n1@1 commit 1@1
 n1@1 apply 1@1 None
 
 # n1&#39;s heartbeats are accepted by followers, who commit and apply the entry.
 tick 1
 ---
<a href="#h20-0-29" id="h20-0-29" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h20-0-30" id="h20-0-30" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h20-0-31" id="h20-0-31" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h20-0-32" id="h20-0-32" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a> 
 stabilize
 ---
 n2@1 commit 1@1
 n2@1 apply 1@1 None
<a href="#h20-0-38" id="h20-0-38" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-39" id="h20-0-39" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n3@1 commit 1@1
 n3@1 apply 1@1 None
<a href="#h20-0-42" id="h20-0-42" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h20-0-43" id="h20-0-43" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 status
 ---
<b>diff --git a/<a id="h21" href="../file/src/raft/testscripts/node/election_candidate_behind_leader.html">src/raft/testscripts/node/election_candidate_behind_leader</a> b/<a href="../file/src/raft/testscripts/node/election_candidate_behind_leader.html">src/raft/testscripts/node/election_candidate_behind_leader</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -20,7 +20,7 @@ n1 n2 ⇹ n3 n4 n5
</a> (stabilize)
 status
 ---
<a href="#h21-0-3" id="h21-0-3" class="d">-n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→2 4:1→2 5:1→2}
</a><a href="#h21-0-4" id="h21-0-4" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:2→3 3:1→3 4:1→3 5:1→3}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 n4@1 follower(n1) last=1@1 commit=1@1 apply=1
<a href="#h21-1" id="h21-1" class="h">@@ -73,42 +73,42 @@ n5@2 → n1 Append base=1@1 [2@2]
</a> n5@2 → n2 Append base=1@1 [2@2]
 n5@2 → n3 Append base=1@1 [2@2]
 n5@2 → n4 Append base=1@1 [2@2]
<a href="#h21-1-3" id="h21-1-3" class="d">-n5@2 → n1 Heartbeat commit=1@1 read_seq=0
</a><a href="#h21-1-4" id="h21-1-4" class="d">-n5@2 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h21-1-5" id="h21-1-5" class="d">-n5@2 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h21-1-6" id="h21-1-6" class="d">-n5@2 → n4 Heartbeat commit=1@1 read_seq=0
</a><a href="#h21-1-7" id="h21-1-7" class="i">+n5@2 → n1 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h21-1-8" id="h21-1-8" class="i">+n5@2 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h21-1-9" id="h21-1-9" class="i">+n5@2 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h21-1-10" id="h21-1-10" class="i">+n5@2 → n4 Heartbeat last_index=2 commit=1@1 read_seq=0
</a> n1@2 follower() ⇨ n1@2 follower(n5)
<a href="#h21-1-12" id="h21-1-12" class="d">-n1@2 → n5 AppendResponse last=2@2 reject=0
</a><a href="#h21-1-13" id="h21-1-13" class="d">-n1@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-14" id="h21-1-14" class="i">+n1@2 → n5 AppendResponse match_index=2
</a><a href="#h21-1-15" id="h21-1-15" class="i">+n1@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n2@2 follower() ⇨ n2@2 follower(n5)
<a href="#h21-1-17" id="h21-1-17" class="d">-n2@2 → n5 AppendResponse last=2@2 reject=0
</a><a href="#h21-1-18" id="h21-1-18" class="d">-n2@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-19" id="h21-1-19" class="i">+n2@2 → n5 AppendResponse match_index=2
</a><a href="#h21-1-20" id="h21-1-20" class="i">+n2@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n3@2 follower() ⇨ n3@2 follower(n5)
 n3@2 append 2@2 None
<a href="#h21-1-23" id="h21-1-23" class="d">-n3@2 → n5 AppendResponse last=2@2 reject=0
</a><a href="#h21-1-24" id="h21-1-24" class="d">-n3@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-25" id="h21-1-25" class="i">+n3@2 → n5 AppendResponse match_index=2
</a><a href="#h21-1-26" id="h21-1-26" class="i">+n3@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n4@2 follower() ⇨ n4@2 follower(n5)
 n4@2 append 2@2 None
<a href="#h21-1-29" id="h21-1-29" class="d">-n4@2 → n5 AppendResponse last=2@2 reject=0
</a><a href="#h21-1-30" id="h21-1-30" class="d">-n4@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-31" id="h21-1-31" class="i">+n4@2 → n5 AppendResponse match_index=2
</a><a href="#h21-1-32" id="h21-1-32" class="i">+n4@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n5@2 commit 2@2
 n5@2 apply 2@2 None
<a href="#h21-1-35" id="h21-1-35" class="d">-n5@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h21-1-36" id="h21-1-36" class="d">-n5@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h21-1-37" id="h21-1-37" class="d">-n5@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h21-1-38" id="h21-1-38" class="d">-n5@2 → n4 Heartbeat commit=2@2 read_seq=0
</a><a href="#h21-1-39" id="h21-1-39" class="i">+n5@2 → n1 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h21-1-40" id="h21-1-40" class="i">+n5@2 → n2 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h21-1-41" id="h21-1-41" class="i">+n5@2 → n3 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h21-1-42" id="h21-1-42" class="i">+n5@2 → n4 Heartbeat last_index=2 commit=2@2 read_seq=0
</a> n1@2 commit 2@2
 n1@2 apply 2@2 None
<a href="#h21-1-45" id="h21-1-45" class="d">-n1@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-46" id="h21-1-46" class="i">+n1@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n2@2 commit 2@2
 n2@2 apply 2@2 None
<a href="#h21-1-49" id="h21-1-49" class="d">-n2@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-50" id="h21-1-50" class="i">+n2@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n3@2 commit 2@2
 n3@2 apply 2@2 None
<a href="#h21-1-53" id="h21-1-53" class="d">-n3@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-54" id="h21-1-54" class="i">+n3@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> n4@2 commit 2@2
 n4@2 apply 2@2 None
<a href="#h21-1-57" id="h21-1-57" class="d">-n4@2 → n5 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h21-1-58" id="h21-1-58" class="i">+n4@2 → n5 HeartbeatResponse match_index=2 read_seq=0
</a> 
 # n1+n2&#39;s in-flight write at log position 2 has been replaced by the
 # empty log entry appended by n5 when it became leader.
<b>diff --git a/<a id="h22" href="../file/src/raft/testscripts/node/election_candidate_behind_quorum.html">src/raft/testscripts/node/election_candidate_behind_quorum</a> b/<a href="../file/src/raft/testscripts/node/election_candidate_behind_quorum.html">src/raft/testscripts/node/election_candidate_behind_quorum</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -20,7 +20,7 @@ n4 n5 ⇹ n1 n2 n3
</a> (stabilize)
 status
 ---
<a href="#h22-0-3" id="h22-0-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3 4:1→2 5:1→2}
</a><a href="#h22-0-4" id="h22-0-4" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3 4:1→3 5:1→3}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=2@1 commit=1@1 apply=1
 n4@1 follower(n1) last=1@1 commit=1@1 apply=1
<b>diff --git a/<a id="h23" href="../file/src/raft/testscripts/node/election_contested.html">src/raft/testscripts/node/election_contested</a> b/<a href="../file/src/raft/testscripts/node/election_contested.html">src/raft/testscripts/node/election_contested</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -53,30 +53,30 @@ n1@1 → n2 Append base=0@0 [1@1]
</a> n1@1 → n3 Append base=0@0 [1@1]
 n1@1 → n4 Append base=0@0 [1@1]
 n1@1 → n5 Append base=0@0 [1@1]
<a href="#h23-0-3" id="h23-0-3" class="d">-n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h23-0-4" id="h23-0-4" class="d">-n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h23-0-5" id="h23-0-5" class="d">-n1@1 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h23-0-6" id="h23-0-6" class="d">-n1@1 → n5 Heartbeat commit=0@0 read_seq=0
</a><a href="#h23-0-7" id="h23-0-7" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h23-0-8" id="h23-0-8" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h23-0-9" id="h23-0-9" class="i">+n1@1 → n4 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h23-0-10" id="h23-0-10" class="i">+n1@1 → n5 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 # All nodes accept n1 as leader in term 1 and become followers.
 stabilize
 ---
 n2@1 follower() ⇨ n2@1 follower(n1)
 n2@1 append 1@1 None
<a href="#h23-0-17" id="h23-0-17" class="d">-n2@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h23-0-18" id="h23-0-18" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h23-0-19" id="h23-0-19" class="i">+n2@1 → n1 AppendResponse match_index=1
</a><a href="#h23-0-20" id="h23-0-20" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n3@1 follower() ⇨ n3@1 follower(n1)
 n3@1 append 1@1 None
<a href="#h23-0-23" id="h23-0-23" class="d">-n3@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h23-0-24" id="h23-0-24" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h23-0-25" id="h23-0-25" class="i">+n3@1 → n1 AppendResponse match_index=1
</a><a href="#h23-0-26" id="h23-0-26" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n4@1 follower() ⇨ n4@1 follower(n1)
 n4@1 append 1@1 None
<a href="#h23-0-29" id="h23-0-29" class="d">-n4@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h23-0-30" id="h23-0-30" class="d">-n4@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h23-0-31" id="h23-0-31" class="i">+n4@1 → n1 AppendResponse match_index=1
</a><a href="#h23-0-32" id="h23-0-32" class="i">+n4@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n5@1 candidate ⇨ n5@1 follower(n1)
 n5@1 append 1@1 None
<a href="#h23-0-35" id="h23-0-35" class="d">-n5@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h23-0-36" id="h23-0-36" class="d">-n5@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h23-0-37" id="h23-0-37" class="i">+n5@1 → n1 AppendResponse match_index=1
</a><a href="#h23-0-38" id="h23-0-38" class="i">+n5@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n1@1 commit 1@1
 n1@1 apply 1@1 None
 
<b>diff --git a/<a id="h24" href="../file/src/raft/testscripts/node/election_tie.html">src/raft/testscripts/node/election_tie</a> b/<a href="../file/src/raft/testscripts/node/election_tie.html">src/raft/testscripts/node/election_tie</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -57,19 +57,19 @@ n2@2 candidate ⇨ n2@2 leader
</a> n2@2 append 1@2 None
 n2@2 → n1 Append base=0@0 [1@2]
 n2@2 → n3 Append base=0@0 [1@2]
<a href="#h24-0-3" id="h24-0-3" class="d">-n2@2 → n1 Heartbeat commit=0@0 read_seq=0
</a><a href="#h24-0-4" id="h24-0-4" class="d">-n2@2 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h24-0-5" id="h24-0-5" class="i">+n2@2 → n1 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h24-0-6" id="h24-0-6" class="i">+n2@2 → n3 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 stabilize
 ---
 n1@2 follower() ⇨ n1@2 follower(n2)
 n1@2 append 1@2 None
<a href="#h24-0-12" id="h24-0-12" class="d">-n1@2 → n2 AppendResponse last=1@2 reject=0
</a><a href="#h24-0-13" id="h24-0-13" class="d">-n1@2 → n2 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h24-0-14" id="h24-0-14" class="i">+n1@2 → n2 AppendResponse match_index=1
</a><a href="#h24-0-15" id="h24-0-15" class="i">+n1@2 → n2 HeartbeatResponse match_index=1 read_seq=0
</a> n3@2 follower() ⇨ n3@2 follower(n2)
 n3@2 append 1@2 None
<a href="#h24-0-18" id="h24-0-18" class="d">-n3@2 → n2 AppendResponse last=1@2 reject=0
</a><a href="#h24-0-19" id="h24-0-19" class="d">-n3@2 → n2 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h24-0-20" id="h24-0-20" class="i">+n3@2 → n2 AppendResponse match_index=1
</a><a href="#h24-0-21" id="h24-0-21" class="i">+n3@2 → n2 HeartbeatResponse match_index=1 read_seq=0
</a> n2@2 commit 1@2
 n2@2 apply 1@2 None
 
<b>diff --git a/<a id="h25" href="../file/src/raft/testscripts/node/election_tie_even.html">src/raft/testscripts/node/election_tie_even</a> b/<a href="../file/src/raft/testscripts/node/election_tie_even.html">src/raft/testscripts/node/election_tie_even</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -70,24 +70,24 @@ n3@2 append 1@2 None
</a> n3@2 → n1 Append base=0@0 [1@2]
 n3@2 → n2 Append base=0@0 [1@2]
 n3@2 → n4 Append base=0@0 [1@2]
<a href="#h25-0-3" id="h25-0-3" class="d">-n3@2 → n1 Heartbeat commit=0@0 read_seq=0
</a><a href="#h25-0-4" id="h25-0-4" class="d">-n3@2 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h25-0-5" id="h25-0-5" class="d">-n3@2 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h25-0-6" id="h25-0-6" class="i">+n3@2 → n1 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h25-0-7" id="h25-0-7" class="i">+n3@2 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h25-0-8" id="h25-0-8" class="i">+n3@2 → n4 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 stabilize
 ---
 n1@2 follower() ⇨ n1@2 follower(n3)
 n1@2 append 1@2 None
<a href="#h25-0-14" id="h25-0-14" class="d">-n1@2 → n3 AppendResponse last=1@2 reject=0
</a><a href="#h25-0-15" id="h25-0-15" class="d">-n1@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h25-0-16" id="h25-0-16" class="i">+n1@2 → n3 AppendResponse match_index=1
</a><a href="#h25-0-17" id="h25-0-17" class="i">+n1@2 → n3 HeartbeatResponse match_index=1 read_seq=0
</a> n2@2 follower() ⇨ n2@2 follower(n3)
 n2@2 append 1@2 None
<a href="#h25-0-20" id="h25-0-20" class="d">-n2@2 → n3 AppendResponse last=1@2 reject=0
</a><a href="#h25-0-21" id="h25-0-21" class="d">-n2@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h25-0-22" id="h25-0-22" class="i">+n2@2 → n3 AppendResponse match_index=1
</a><a href="#h25-0-23" id="h25-0-23" class="i">+n2@2 → n3 HeartbeatResponse match_index=1 read_seq=0
</a> n4@2 follower() ⇨ n4@2 follower(n3)
 n4@2 append 1@2 None
<a href="#h25-0-26" id="h25-0-26" class="d">-n4@2 → n3 AppendResponse last=1@2 reject=0
</a><a href="#h25-0-27" id="h25-0-27" class="d">-n4@2 → n3 HeartbeatResponse last=1@2 read_seq=0
</a><a href="#h25-0-28" id="h25-0-28" class="i">+n4@2 → n3 AppendResponse match_index=1
</a><a href="#h25-0-29" id="h25-0-29" class="i">+n4@2 → n3 HeartbeatResponse match_index=1 read_seq=0
</a> n3@2 commit 1@2
 n3@2 apply 1@2 None
 
<b>diff --git a/<a id="h26" href="../file/src/raft/testscripts/node/heartbeat_commits_follower.html">src/raft/testscripts/node/heartbeat_commits_follower</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_commits_follower.html">src/raft/testscripts/node/heartbeat_commits_follower</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -15,9 +15,9 @@ n1@1 append 2@1 put foo=bar
</a> n1@1 → n2 Append base=1@1 [2@1]
 n1@1 → n3 Append base=1@1 [2@1]
 n2@1 append 2@1 put foo=bar
<a href="#h26-0-3" id="h26-0-3" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h26-0-4" id="h26-0-4" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> n3@1 append 2@1 put foo=bar
<a href="#h26-0-6" id="h26-0-6" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h26-0-7" id="h26-0-7" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> n1@1 commit 2@1
 n1@1 apply 2@1 put foo=bar
 n1@1 → c1 ClientResponse id=0x01 write 0x0102
<a href="#h26-1" id="h26-1" class="h">@@ -34,14 +34,14 @@ n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a> heartbeat 1
 stabilize
 ---
<a href="#h26-1-3" id="h26-1-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=0
</a><a href="#h26-1-4" id="h26-1-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=0
</a><a href="#h26-1-5" id="h26-1-5" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=0
</a><a href="#h26-1-6" id="h26-1-6" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=0
</a> n2@1 commit 2@1
 n2@1 apply 2@1 put foo=bar
<a href="#h26-1-9" id="h26-1-9" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><a href="#h26-1-10" id="h26-1-10" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=0
</a> n3@1 commit 2@1
 n3@1 apply 2@1 put foo=bar
<a href="#h26-1-13" id="h26-1-13" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><a href="#h26-1-14" id="h26-1-14" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<b>diff --git a/<a id="h27" href="../file/src/raft/testscripts/node/heartbeat_converts_candidate.html">src/raft/testscripts/node/heartbeat_converts_candidate</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_candidate.html">src/raft/testscripts/node/heartbeat_converts_candidate</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -29,7 +29,7 @@ n2@1 → n1 CampaignResponse vote=true
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h27-0-3" id="h27-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h27-0-4" id="h27-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→2}
</a> n2@1 follower(n1) last=1@1 commit=1@1 apply=1
 n3@1 candidate last=0@0 commit=0@0 apply=0
 
<a href="#h27-1" id="h27-1" class="h">@@ -42,14 +42,14 @@ n1 n2 n3 fully connected
</a> heartbeat 1
 stabilize
 ---
<a href="#h27-1-3" id="h27-1-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h27-1-4" id="h27-1-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h27-1-5" id="h27-1-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h27-1-6" id="h27-1-6" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h27-1-7" id="h27-1-7" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h27-1-8" id="h27-1-8" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n3@1 candidate ⇨ n3@1 follower(n1)
<a href="#h27-1-10" id="h27-1-10" class="d">-n3@1 → n1 HeartbeatResponse last=0@0 read_seq=0
</a><a href="#h27-1-11" id="h27-1-11" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a> n1@1 → n3 Append base=0@0 [1@1]
 n3@1 append 1@1 None
<a href="#h27-1-14" id="h27-1-14" class="d">-n3@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h27-1-15" id="h27-1-15" class="i">+n3@1 → n1 AppendResponse match_index=1
</a> 
 status
 ---
<b>diff --git a/<a id="h28" href="../file/src/raft/testscripts/node/heartbeat_converts_follower.html">src/raft/testscripts/node/heartbeat_converts_follower</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_follower.html">src/raft/testscripts/node/heartbeat_converts_follower</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -19,7 +19,7 @@ status
</a> ---
 n1@2 follower(n3) last=2@2 commit=2@2 apply=2
 n2@1 follower(n1) last=1@1 commit=1@1 apply=1
<a href="#h28-0-3" id="h28-0-3" class="d">-n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:2→3 2:0→2}
</a><a href="#h28-0-4" id="h28-0-4" class="i">+n3@2 leader last=2@2 commit=2@2 apply=2 progress={1:2→3 2:0→3}
</a> 
 # Heal the partition.
 heal
<a href="#h28-1" id="h28-1" class="h">@@ -30,20 +30,22 @@ n1 n2 n3 fully connected
</a> heartbeat 3
 stabilize heartbeat=true
 ---
<a href="#h28-1-3" id="h28-1-3" class="d">-n3@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h28-1-4" id="h28-1-4" class="d">-n3@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h28-1-5" id="h28-1-5" class="d">-n1@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h28-1-6" id="h28-1-6" class="i">+n3@2 → n1 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h28-1-7" id="h28-1-7" class="i">+n3@2 → n2 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h28-1-8" id="h28-1-8" class="i">+n1@2 → n3 HeartbeatResponse match_index=2 read_seq=0
</a> n2@1 follower(n1) ⇨ n2@2 follower(n3)
<a href="#h28-1-10" id="h28-1-10" class="d">-n2@2 → n3 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h28-1-11" id="h28-1-11" class="i">+n2@2 → n3 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h28-1-12" id="h28-1-12" class="i">+n3@2 → n2 Append base=1@1 []
</a><a href="#h28-1-13" id="h28-1-13" class="i">+n2@2 → n3 AppendResponse match_index=1
</a> n3@2 → n2 Append base=1@1 [2@2]
 n2@2 append 2@2 None
<a href="#h28-1-16" id="h28-1-16" class="d">-n2@2 → n3 AppendResponse last=2@2 reject=0
</a><a href="#h28-1-17" id="h28-1-17" class="d">-n3@2 → n1 Heartbeat commit=2@2 read_seq=0
</a><a href="#h28-1-18" id="h28-1-18" class="d">-n3@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h28-1-19" id="h28-1-19" class="d">-n1@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h28-1-20" id="h28-1-20" class="i">+n2@2 → n3 AppendResponse match_index=2
</a><a href="#h28-1-21" id="h28-1-21" class="i">+n3@2 → n1 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h28-1-22" id="h28-1-22" class="i">+n3@2 → n2 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h28-1-23" id="h28-1-23" class="i">+n1@2 → n3 HeartbeatResponse match_index=2 read_seq=0
</a> n2@2 commit 2@2
 n2@2 apply 2@2 None
<a href="#h28-1-26" id="h28-1-26" class="d">-n2@2 → n3 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h28-1-27" id="h28-1-27" class="i">+n2@2 → n3 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<b>diff --git a/<a id="h29" href="../file/src/raft/testscripts/node/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_follower_leaderless.html">src/raft/testscripts/node/heartbeat_converts_follower_leaderless</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -16,7 +16,7 @@ n3 ⇹ n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h29-0-3" id="h29-0-3" class="d">-n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→1}
</a><a href="#h29-0-4" id="h29-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:0→2}
</a> n2@1 follower(n1) last=1@1 commit=1@1 apply=1
 n3@0 follower() last=0@0 commit=0@0 apply=0
 
<a href="#h29-1" id="h29-1" class="h">@@ -29,14 +29,14 @@ n1 n2 n3 fully connected
</a> heartbeat 1
 stabilize
 ---
<a href="#h29-1-3" id="h29-1-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h29-1-4" id="h29-1-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h29-1-5" id="h29-1-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h29-1-6" id="h29-1-6" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h29-1-7" id="h29-1-7" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h29-1-8" id="h29-1-8" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> n3@0 follower() ⇨ n3@1 follower(n1)
<a href="#h29-1-10" id="h29-1-10" class="d">-n3@1 → n1 HeartbeatResponse last=0@0 read_seq=0
</a><a href="#h29-1-11" id="h29-1-11" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a> n1@1 → n3 Append base=0@0 [1@1]
 n3@1 append 1@1 None
<a href="#h29-1-14" id="h29-1-14" class="d">-n3@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h29-1-15" id="h29-1-15" class="i">+n3@1 → n1 AppendResponse match_index=1
</a> 
 status
 ---
<b>diff --git a/<a id="h30" href="../file/src/raft/testscripts/node/heartbeat_converts_leader.html">src/raft/testscripts/node/heartbeat_converts_leader</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_converts_leader.html">src/raft/testscripts/node/heartbeat_converts_leader</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -17,7 +17,7 @@ n3 ⇹ n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h30-0-3" id="h30-0-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h30-0-4" id="h30-0-4" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→3}
</a> n2@2 follower(n1) last=2@2 commit=2@2 apply=2
 n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
 
<a href="#h30-1" id="h30-1" class="h">@@ -30,20 +30,22 @@ n1 n2 n3 fully connected
</a> heartbeat 1
 stabilize heartbeat=true
 ---
<a href="#h30-1-3" id="h30-1-3" class="d">-n1@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h30-1-4" id="h30-1-4" class="d">-n1@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h30-1-5" id="h30-1-5" class="d">-n2@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h30-1-6" id="h30-1-6" class="i">+n1@2 → n2 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h30-1-7" id="h30-1-7" class="i">+n1@2 → n3 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h30-1-8" id="h30-1-8" class="i">+n2@2 → n1 HeartbeatResponse match_index=2 read_seq=0
</a> n3@1 leader ⇨ n3@2 follower(n1)
<a href="#h30-1-10" id="h30-1-10" class="d">-n3@2 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h30-1-11" id="h30-1-11" class="i">+n3@2 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h30-1-12" id="h30-1-12" class="i">+n1@2 → n3 Append base=1@1 []
</a><a href="#h30-1-13" id="h30-1-13" class="i">+n3@2 → n1 AppendResponse match_index=1
</a> n1@2 → n3 Append base=1@1 [2@2]
 n3@2 append 2@2 None
<a href="#h30-1-16" id="h30-1-16" class="d">-n3@2 → n1 AppendResponse last=2@2 reject=0
</a><a href="#h30-1-17" id="h30-1-17" class="d">-n1@2 → n2 Heartbeat commit=2@2 read_seq=0
</a><a href="#h30-1-18" id="h30-1-18" class="d">-n1@2 → n3 Heartbeat commit=2@2 read_seq=0
</a><a href="#h30-1-19" id="h30-1-19" class="d">-n2@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h30-1-20" id="h30-1-20" class="i">+n3@2 → n1 AppendResponse match_index=2
</a><a href="#h30-1-21" id="h30-1-21" class="i">+n1@2 → n2 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h30-1-22" id="h30-1-22" class="i">+n1@2 → n3 Heartbeat last_index=2 commit=2@2 read_seq=0
</a><a href="#h30-1-23" id="h30-1-23" class="i">+n2@2 → n1 HeartbeatResponse match_index=2 read_seq=0
</a> n3@2 commit 2@2
 n3@2 apply 2@2 None
<a href="#h30-1-26" id="h30-1-26" class="d">-n3@2 → n1 HeartbeatResponse last=2@2 read_seq=0
</a><a href="#h30-1-27" id="h30-1-27" class="i">+n3@2 → n1 HeartbeatResponse match_index=2 read_seq=0
</a> 
 status
 ---
<b>diff --git a/<a id="h31" href="../file/src/raft/testscripts/node/heartbeat_lost_append_duplicate.html">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_duplicate.html">src/raft/testscripts/node/heartbeat_lost_append_duplicate</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,77 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+# Duplicate heartbeats and responses with a lost append will
</a><a href="#h31-0-1" id="h31-0-1" class="i">+# trigger duplicate resends, but it will eventually resolve.
</a><a href="#h31-0-2" id="h31-0-2" class="i">+
</a><a href="#h31-0-3" id="h31-0-3" class="i">+cluster nodes=3 leader=1
</a><a href="#h31-0-4" id="h31-0-4" class="i">+---
</a><a href="#h31-0-5" id="h31-0-5" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h31-0-6" id="h31-0-6" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-7" id="h31-0-7" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h31-0-8" id="h31-0-8" class="i">+
</a><a href="#h31-0-9" id="h31-0-9" class="i">+# Partition the leader, submit a write whose appends are dropped,
</a><a href="#h31-0-10" id="h31-0-10" class="i">+# then heal the partition again.
</a><a href="#h31-0-11" id="h31-0-11" class="i">+partition 1
</a><a href="#h31-0-12" id="h31-0-12" class="i">+---
</a><a href="#h31-0-13" id="h31-0-13" class="i">+n1 ⇹ n2 n3
</a><a href="#h31-0-14" id="h31-0-14" class="i">+
</a><a href="#h31-0-15" id="h31-0-15" class="i">+put 1 foo=bar
</a><a href="#h31-0-16" id="h31-0-16" class="i">+---
</a><a href="#h31-0-17" id="h31-0-17" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h31-0-18" id="h31-0-18" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h31-0-19" id="h31-0-19" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h31-0-20" id="h31-0-20" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h31-0-21" id="h31-0-21" class="i">+
</a><a href="#h31-0-22" id="h31-0-22" class="i">+heal
</a><a href="#h31-0-23" id="h31-0-23" class="i">+---
</a><a href="#h31-0-24" id="h31-0-24" class="i">+n1 n2 n3 fully connected
</a><a href="#h31-0-25" id="h31-0-25" class="i">+
</a><a href="#h31-0-26" id="h31-0-26" class="i">+# The next heartbeat will result in match_index=0 since the followers
</a><a href="#h31-0-27" id="h31-0-27" class="i">+# don&#39;t have the last_index. 3 heartbeats are made.
</a><a href="#h31-0-28" id="h31-0-28" class="i">+heartbeat 1
</a><a href="#h31-0-29" id="h31-0-29" class="i">+heartbeat 1
</a><a href="#h31-0-30" id="h31-0-30" class="i">+heartbeat 1
</a><a href="#h31-0-31" id="h31-0-31" class="i">+deliver
</a><a href="#h31-0-32" id="h31-0-32" class="i">+---
</a><a href="#h31-0-33" id="h31-0-33" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-34" id="h31-0-34" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-35" id="h31-0-35" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-36" id="h31-0-36" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-37" id="h31-0-37" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-38" id="h31-0-38" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h31-0-39" id="h31-0-39" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-40" id="h31-0-40" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-41" id="h31-0-41" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-42" id="h31-0-42" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-43" id="h31-0-43" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-44" id="h31-0-44" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h31-0-45" id="h31-0-45" class="i">+
</a><a href="#h31-0-46" id="h31-0-46" class="i">+# The leader has previously matched the followers at index 1.
</a><a href="#h31-0-47" id="h31-0-47" class="i">+status 1
</a><a href="#h31-0-48" id="h31-0-48" class="i">+---
</a><a href="#h31-0-49" id="h31-0-49" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:1→3 3:1→3}
</a><a href="#h31-0-50" id="h31-0-50" class="i">+
</a><a href="#h31-0-51" id="h31-0-51" class="i">+# When it receives the heartbeat responses, it sends duplicates of the missing
</a><a href="#h31-0-52" id="h31-0-52" class="i">+# entries.
</a><a href="#h31-0-53" id="h31-0-53" class="i">+deliver
</a><a href="#h31-0-54" id="h31-0-54" class="i">+---
</a><a href="#h31-0-55" id="h31-0-55" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h31-0-56" id="h31-0-56" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h31-0-57" id="h31-0-57" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h31-0-58" id="h31-0-58" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h31-0-59" id="h31-0-59" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h31-0-60" id="h31-0-60" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h31-0-61" id="h31-0-61" class="i">+
</a><a href="#h31-0-62" id="h31-0-62" class="i">+# The followers accept the duplicate appends and the leader commits and applies.
</a><a href="#h31-0-63" id="h31-0-63" class="i">+stabilize
</a><a href="#h31-0-64" id="h31-0-64" class="i">+---
</a><a href="#h31-0-65" id="h31-0-65" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h31-0-66" id="h31-0-66" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-67" id="h31-0-67" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-68" id="h31-0-68" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-69" id="h31-0-69" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h31-0-70" id="h31-0-70" class="i">+n3@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-71" id="h31-0-71" class="i">+n3@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-72" id="h31-0-72" class="i">+n3@1 → n1 AppendResponse match_index=2
</a><a href="#h31-0-73" id="h31-0-73" class="i">+n1@1 commit 2@1
</a><a href="#h31-0-74" id="h31-0-74" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h31-0-75" id="h31-0-75" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h31-0-76" id="h31-0-76" class="i">+c1@1 put foo=bar ⇒ 2
</a><b>diff --git a/<a id="h32" href="../file/src/raft/testscripts/node/heartbeat_lost_append_multiple.html">src/raft/testscripts/node/heartbeat_lost_append_multiple</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_multiple.html">src/raft/testscripts/node/heartbeat_lost_append_multiple</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,95 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+# A heartbeat response triggers a probe and resend of lost appends.
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h32-0-3" id="h32-0-3" class="i">+---
</a><a href="#h32-0-4" id="h32-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h32-0-5" id="h32-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-6" id="h32-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-7" id="h32-0-7" class="i">+
</a><a href="#h32-0-8" id="h32-0-8" class="i">+# Partition the leader, submit three writes whose appends are dropped, then heal
</a><a href="#h32-0-9" id="h32-0-9" class="i">+# the partition again.
</a><a href="#h32-0-10" id="h32-0-10" class="i">+partition 1
</a><a href="#h32-0-11" id="h32-0-11" class="i">+---
</a><a href="#h32-0-12" id="h32-0-12" class="i">+n1 ⇹ n2 n3
</a><a href="#h32-0-13" id="h32-0-13" class="i">+
</a><a href="#h32-0-14" id="h32-0-14" class="i">+put 1 a=1
</a><a href="#h32-0-15" id="h32-0-15" class="i">+put 1 b=2
</a><a href="#h32-0-16" id="h32-0-16" class="i">+put 1 c=3
</a><a href="#h32-0-17" id="h32-0-17" class="i">+---
</a><a href="#h32-0-18" id="h32-0-18" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0101610131
</a><a href="#h32-0-19" id="h32-0-19" class="i">+n1@1 append 2@1 put a=1
</a><a href="#h32-0-20" id="h32-0-20" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h32-0-21" id="h32-0-21" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h32-0-22" id="h32-0-22" class="i">+c1@1 → n1 ClientRequest id=0x02 write 0x0101620132
</a><a href="#h32-0-23" id="h32-0-23" class="i">+n1@1 append 3@1 put b=2
</a><a href="#h32-0-24" id="h32-0-24" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h32-0-25" id="h32-0-25" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶2̶@̶1̶ ̶[̶3̶@̶1̶]̶
</a><a href="#h32-0-26" id="h32-0-26" class="i">+c1@1 → n1 ClientRequest id=0x03 write 0x0101630133
</a><a href="#h32-0-27" id="h32-0-27" class="i">+n1@1 append 4@1 put c=3
</a><a href="#h32-0-28" id="h32-0-28" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a><a href="#h32-0-29" id="h32-0-29" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶1̶]̶
</a><a href="#h32-0-30" id="h32-0-30" class="i">+
</a><a href="#h32-0-31" id="h32-0-31" class="i">+heal
</a><a href="#h32-0-32" id="h32-0-32" class="i">+status
</a><a href="#h32-0-33" id="h32-0-33" class="i">+---
</a><a href="#h32-0-34" id="h32-0-34" class="i">+n1 n2 n3 fully connected
</a><a href="#h32-0-35" id="h32-0-35" class="i">+n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:1→5 3:1→5}
</a><a href="#h32-0-36" id="h32-0-36" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-37" id="h32-0-37" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h32-0-38" id="h32-0-38" class="i">+
</a><a href="#h32-0-39" id="h32-0-39" class="i">+# The next heartbeat will result in match_index=0 since the followers
</a><a href="#h32-0-40" id="h32-0-40" class="i">+# don&#39;t have the last_index.
</a><a href="#h32-0-41" id="h32-0-41" class="i">+heartbeat 1
</a><a href="#h32-0-42" id="h32-0-42" class="i">+deliver
</a><a href="#h32-0-43" id="h32-0-43" class="i">+---
</a><a href="#h32-0-44" id="h32-0-44" class="i">+n1@1 → n2 Heartbeat last_index=4 commit=1@1 read_seq=0
</a><a href="#h32-0-45" id="h32-0-45" class="i">+n1@1 → n3 Heartbeat last_index=4 commit=1@1 read_seq=0
</a><a href="#h32-0-46" id="h32-0-46" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h32-0-47" id="h32-0-47" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h32-0-48" id="h32-0-48" class="i">+
</a><a href="#h32-0-49" id="h32-0-49" class="i">+# The leader has previously matched the followers at index 1.
</a><a href="#h32-0-50" id="h32-0-50" class="i">+status 1
</a><a href="#h32-0-51" id="h32-0-51" class="i">+---
</a><a href="#h32-0-52" id="h32-0-52" class="i">+n1@1 leader last=4@1 commit=1@1 apply=1 progress={2:1→5 3:1→5}
</a><a href="#h32-0-53" id="h32-0-53" class="i">+
</a><a href="#h32-0-54" id="h32-0-54" class="i">+# When it receives the heartbeat response, it probes the previous index 3.
</a><a href="#h32-0-55" id="h32-0-55" class="i">+deliver
</a><a href="#h32-0-56" id="h32-0-56" class="i">+---
</a><a href="#h32-0-57" id="h32-0-57" class="i">+n1@1 → n2 Append base=3@1 []
</a><a href="#h32-0-58" id="h32-0-58" class="i">+n1@1 → n3 Append base=3@1 []
</a><a href="#h32-0-59" id="h32-0-59" class="i">+
</a><a href="#h32-0-60" id="h32-0-60" class="i">+# The followers don&#39;t have index 3. They don&#39;t have index 2 either, but they
</a><a href="#h32-0-61" id="h32-0-61" class="i">+# do have 1, so they respond with a reject_index=2.
</a><a href="#h32-0-62" id="h32-0-62" class="i">+deliver
</a><a href="#h32-0-63" id="h32-0-63" class="i">+---
</a><a href="#h32-0-64" id="h32-0-64" class="i">+n2@1 → n1 AppendResponse reject_index=2
</a><a href="#h32-0-65" id="h32-0-65" class="i">+n3@1 → n1 AppendResponse reject_index=2
</a><a href="#h32-0-66" id="h32-0-66" class="i">+
</a><a href="#h32-0-67" id="h32-0-67" class="i">+# The leader has already matched index 1, so it doesn&#39;t have to probe for it,
</a><a href="#h32-0-68" id="h32-0-68" class="i">+# and can simply send the tail of the log.
</a><a href="#h32-0-69" id="h32-0-69" class="i">+deliver
</a><a href="#h32-0-70" id="h32-0-70" class="i">+---
</a><a href="#h32-0-71" id="h32-0-71" class="i">+n1@1 → n2 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h32-0-72" id="h32-0-72" class="i">+n1@1 → n3 Append base=1@1 [2@1 3@1 4@1]
</a><a href="#h32-0-73" id="h32-0-73" class="i">+
</a><a href="#h32-0-74" id="h32-0-74" class="i">+# The followers accept the append and the leader commits and applies.
</a><a href="#h32-0-75" id="h32-0-75" class="i">+stabilize
</a><a href="#h32-0-76" id="h32-0-76" class="i">+---
</a><a href="#h32-0-77" id="h32-0-77" class="i">+n2@1 append 2@1 put a=1
</a><a href="#h32-0-78" id="h32-0-78" class="i">+n2@1 append 3@1 put b=2
</a><a href="#h32-0-79" id="h32-0-79" class="i">+n2@1 append 4@1 put c=3
</a><a href="#h32-0-80" id="h32-0-80" class="i">+n2@1 → n1 AppendResponse match_index=4
</a><a href="#h32-0-81" id="h32-0-81" class="i">+n3@1 append 2@1 put a=1
</a><a href="#h32-0-82" id="h32-0-82" class="i">+n3@1 append 3@1 put b=2
</a><a href="#h32-0-83" id="h32-0-83" class="i">+n3@1 append 4@1 put c=3
</a><a href="#h32-0-84" id="h32-0-84" class="i">+n3@1 → n1 AppendResponse match_index=4
</a><a href="#h32-0-85" id="h32-0-85" class="i">+n1@1 commit 4@1
</a><a href="#h32-0-86" id="h32-0-86" class="i">+n1@1 apply 2@1 put a=1
</a><a href="#h32-0-87" id="h32-0-87" class="i">+n1@1 apply 3@1 put b=2
</a><a href="#h32-0-88" id="h32-0-88" class="i">+n1@1 apply 4@1 put c=3
</a><a href="#h32-0-89" id="h32-0-89" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h32-0-90" id="h32-0-90" class="i">+c1@1 put a=1 ⇒ 2
</a><a href="#h32-0-91" id="h32-0-91" class="i">+n1@1 → c1 ClientResponse id=0x02 write 0x0103
</a><a href="#h32-0-92" id="h32-0-92" class="i">+c1@1 put b=2 ⇒ 3
</a><a href="#h32-0-93" id="h32-0-93" class="i">+n1@1 → c1 ClientResponse id=0x03 write 0x0104
</a><a href="#h32-0-94" id="h32-0-94" class="i">+c1@1 put c=3 ⇒ 4
</a><b>diff --git a/<a id="h33" href="../file/src/raft/testscripts/node/heartbeat_lost_append_single.html">src/raft/testscripts/node/heartbeat_lost_append_single</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_lost_append_single.html">src/raft/testscripts/node/heartbeat_lost_append_single</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+# A heartbeat response triggers a resend of a lost append.
</a><a href="#h33-0-1" id="h33-0-1" class="i">+
</a><a href="#h33-0-2" id="h33-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h33-0-3" id="h33-0-3" class="i">+---
</a><a href="#h33-0-4" id="h33-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h33-0-5" id="h33-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h33-0-6" id="h33-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h33-0-7" id="h33-0-7" class="i">+
</a><a href="#h33-0-8" id="h33-0-8" class="i">+# Partition the leader, submit a write whose appends are dropped,
</a><a href="#h33-0-9" id="h33-0-9" class="i">+# then heal the partition again.
</a><a href="#h33-0-10" id="h33-0-10" class="i">+partition 1
</a><a href="#h33-0-11" id="h33-0-11" class="i">+---
</a><a href="#h33-0-12" id="h33-0-12" class="i">+n1 ⇹ n2 n3
</a><a href="#h33-0-13" id="h33-0-13" class="i">+
</a><a href="#h33-0-14" id="h33-0-14" class="i">+put 1 foo=bar
</a><a href="#h33-0-15" id="h33-0-15" class="i">+---
</a><a href="#h33-0-16" id="h33-0-16" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h33-0-17" id="h33-0-17" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h33-0-18" id="h33-0-18" class="i">+n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h33-0-19" id="h33-0-19" class="i">+n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
</a><a href="#h33-0-20" id="h33-0-20" class="i">+
</a><a href="#h33-0-21" id="h33-0-21" class="i">+heal
</a><a href="#h33-0-22" id="h33-0-22" class="i">+---
</a><a href="#h33-0-23" id="h33-0-23" class="i">+n1 n2 n3 fully connected
</a><a href="#h33-0-24" id="h33-0-24" class="i">+
</a><a href="#h33-0-25" id="h33-0-25" class="i">+# The next heartbeat will result in match_index=0 since the followers
</a><a href="#h33-0-26" id="h33-0-26" class="i">+# don&#39;t have the last_index.
</a><a href="#h33-0-27" id="h33-0-27" class="i">+heartbeat 1
</a><a href="#h33-0-28" id="h33-0-28" class="i">+deliver
</a><a href="#h33-0-29" id="h33-0-29" class="i">+---
</a><a href="#h33-0-30" id="h33-0-30" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h33-0-31" id="h33-0-31" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h33-0-32" id="h33-0-32" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h33-0-33" id="h33-0-33" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h33-0-34" id="h33-0-34" class="i">+
</a><a href="#h33-0-35" id="h33-0-35" class="i">+# The leader has previously matched the followers at index 1.
</a><a href="#h33-0-36" id="h33-0-36" class="i">+status 1
</a><a href="#h33-0-37" id="h33-0-37" class="i">+---
</a><a href="#h33-0-38" id="h33-0-38" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:1→3 3:1→3}
</a><a href="#h33-0-39" id="h33-0-39" class="i">+
</a><a href="#h33-0-40" id="h33-0-40" class="i">+# When it receives the heartbeat response, instead of probing index 1 and then
</a><a href="#h33-0-41" id="h33-0-41" class="i">+# sending the actual entries, it simply sends the entries.
</a><a href="#h33-0-42" id="h33-0-42" class="i">+deliver
</a><a href="#h33-0-43" id="h33-0-43" class="i">+---
</a><a href="#h33-0-44" id="h33-0-44" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h33-0-45" id="h33-0-45" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h33-0-46" id="h33-0-46" class="i">+
</a><a href="#h33-0-47" id="h33-0-47" class="i">+# The followers accept the append and the leader commits and applies.
</a><a href="#h33-0-48" id="h33-0-48" class="i">+stabilize
</a><a href="#h33-0-49" id="h33-0-49" class="i">+---
</a><a href="#h33-0-50" id="h33-0-50" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h33-0-51" id="h33-0-51" class="i">+n2@1 → n1 AppendResponse match_index=2
</a><a href="#h33-0-52" id="h33-0-52" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h33-0-53" id="h33-0-53" class="i">+n3@1 → n1 AppendResponse match_index=2
</a><a href="#h33-0-54" id="h33-0-54" class="i">+n1@1 commit 2@1
</a><a href="#h33-0-55" id="h33-0-55" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h33-0-56" id="h33-0-56" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h33-0-57" id="h33-0-57" class="i">+c1@1 put foo=bar ⇒ 2
</a><b>diff --git a/<a id="h34" href="../file/src/raft/testscripts/node/heartbeat_match_commits.html">src/raft/testscripts/node/heartbeat_match_commits</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_match_commits.html">src/raft/testscripts/node/heartbeat_match_commits</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,70 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+# A heartbeat response can advance a follower match index and commit+apply.
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h34-0-3" id="h34-0-3" class="i">+---
</a><a href="#h34-0-4" id="h34-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h34-0-5" id="h34-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-6" id="h34-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h34-0-7" id="h34-0-7" class="i">+
</a><a href="#h34-0-8" id="h34-0-8" class="i">+# Submit a write to the leader.
</a><a href="#h34-0-9" id="h34-0-9" class="i">+put 1 foo=bar
</a><a href="#h34-0-10" id="h34-0-10" class="i">+---
</a><a href="#h34-0-11" id="h34-0-11" class="i">+c1@1 → n1 ClientRequest id=0x01 write 0x0103666f6f03626172
</a><a href="#h34-0-12" id="h34-0-12" class="i">+n1@1 append 2@1 put foo=bar
</a><a href="#h34-0-13" id="h34-0-13" class="i">+n1@1 → n2 Append base=1@1 [2@1]
</a><a href="#h34-0-14" id="h34-0-14" class="i">+n1@1 → n3 Append base=1@1 [2@1]
</a><a href="#h34-0-15" id="h34-0-15" class="i">+
</a><a href="#h34-0-16" id="h34-0-16" class="i">+# Partition n1 away from the followers as they send the append acks, then heal
</a><a href="#h34-0-17" id="h34-0-17" class="i">+# the partition.
</a><a href="#h34-0-18" id="h34-0-18" class="i">+partition 1
</a><a href="#h34-0-19" id="h34-0-19" class="i">+---
</a><a href="#h34-0-20" id="h34-0-20" class="i">+n1 ⇹ n2 n3
</a><a href="#h34-0-21" id="h34-0-21" class="i">+
</a><a href="#h34-0-22" id="h34-0-22" class="i">+stabilize
</a><a href="#h34-0-23" id="h34-0-23" class="i">+---
</a><a href="#h34-0-24" id="h34-0-24" class="i">+n2@1 append 2@1 put foo=bar
</a><a href="#h34-0-25" id="h34-0-25" class="i">+n2@1 ⇥ n1 A̶p̶p̶e̶n̶d̶R̶e̶s̶p̶o̶n̶s̶e̶ ̶m̶a̶t̶c̶h̶_̶i̶n̶d̶e̶x̶=̶2̶
</a><a href="#h34-0-26" id="h34-0-26" class="i">+n3@1 append 2@1 put foo=bar
</a><a href="#h34-0-27" id="h34-0-27" class="i">+n3@1 ⇥ n1 A̶p̶p̶e̶n̶d̶R̶e̶s̶p̶o̶n̶s̶e̶ ̶m̶a̶t̶c̶h̶_̶i̶n̶d̶e̶x̶=̶2̶
</a><a href="#h34-0-28" id="h34-0-28" class="i">+
</a><a href="#h34-0-29" id="h34-0-29" class="i">+heal
</a><a href="#h34-0-30" id="h34-0-30" class="i">+---
</a><a href="#h34-0-31" id="h34-0-31" class="i">+n1 n2 n3 fully connected
</a><a href="#h34-0-32" id="h34-0-32" class="i">+
</a><a href="#h34-0-33" id="h34-0-33" class="i">+# The write has been replicated, but not yet committed and applied.
</a><a href="#h34-0-34" id="h34-0-34" class="i">+status
</a><a href="#h34-0-35" id="h34-0-35" class="i">+---
</a><a href="#h34-0-36" id="h34-0-36" class="i">+n1@1 leader last=2@1 commit=1@1 apply=1 progress={2:1→3 3:1→3}
</a><a href="#h34-0-37" id="h34-0-37" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h34-0-38" id="h34-0-38" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h34-0-39" id="h34-0-39" class="i">+
</a><a href="#h34-0-40" id="h34-0-40" class="i">+# The leader heartbeats. The followers confirm they are caught up.
</a><a href="#h34-0-41" id="h34-0-41" class="i">+heartbeat 1
</a><a href="#h34-0-42" id="h34-0-42" class="i">+deliver
</a><a href="#h34-0-43" id="h34-0-43" class="i">+---
</a><a href="#h34-0-44" id="h34-0-44" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h34-0-45" id="h34-0-45" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=0
</a><a href="#h34-0-46" id="h34-0-46" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=0
</a><a href="#h34-0-47" id="h34-0-47" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=0
</a><a href="#h34-0-48" id="h34-0-48" class="i">+
</a><a href="#h34-0-49" id="h34-0-49" class="i">+# When the leader receives the first heartbeat, it commits and applies
</a><a href="#h34-0-50" id="h34-0-50" class="i">+# the write.
</a><a href="#h34-0-51" id="h34-0-51" class="i">+deliver 1 from=2
</a><a href="#h34-0-52" id="h34-0-52" class="i">+---
</a><a href="#h34-0-53" id="h34-0-53" class="i">+n1@1 commit 2@1
</a><a href="#h34-0-54" id="h34-0-54" class="i">+n1@1 apply 2@1 put foo=bar
</a><a href="#h34-0-55" id="h34-0-55" class="i">+n1@1 → c1 ClientResponse id=0x01 write 0x0102
</a><a href="#h34-0-56" id="h34-0-56" class="i">+c1@1 put foo=bar ⇒ 2
</a><a href="#h34-0-57" id="h34-0-57" class="i">+
</a><a href="#h34-0-58" id="h34-0-58" class="i">+status 1
</a><a href="#h34-0-59" id="h34-0-59" class="i">+---
</a><a href="#h34-0-60" id="h34-0-60" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:1→3}
</a><a href="#h34-0-61" id="h34-0-61" class="i">+
</a><a href="#h34-0-62" id="h34-0-62" class="i">+# Delivery of the second heartbeat advances the match index, but
</a><a href="#h34-0-63" id="h34-0-63" class="i">+# there is nothing more to do.
</a><a href="#h34-0-64" id="h34-0-64" class="i">+deliver
</a><a href="#h34-0-65" id="h34-0-65" class="i">+status
</a><a href="#h34-0-66" id="h34-0-66" class="i">+---
</a><a href="#h34-0-67" id="h34-0-67" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h34-0-68" id="h34-0-68" class="i">+n2@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><a href="#h34-0-69" id="h34-0-69" class="i">+n3@1 follower(n1) last=2@1 commit=1@1 apply=1
</a><b>diff --git a/<a id="h35" href="../file/src/raft/testscripts/node/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_multiple_leaders_panic.html">src/raft/testscripts/node/heartbeat_multiple_leaders_panic</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -7,12 +7,12 @@ n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 
 # Leader panics if it sees another leader in the same term.
<a href="#h35-0-3" id="h35-0-3" class="d">-!step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a><a href="#h35-0-4" id="h35-0-4" class="i">+!step 1 &#39;{&quot;from&quot;:2, &quot;to&quot;:1, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;last_index&quot;:1,&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a> ---
 Panic: saw other leader 2 in term 1
 
 # Follower panics too.
<a href="#h35-0-9" id="h35-0-9" class="d">-!step 2 &#39;{&quot;from&quot;:3, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a><a href="#h35-0-10" id="h35-0-10" class="i">+!step 2 &#39;{&quot;from&quot;:3, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;: {&quot;Heartbeat&quot;:{&quot;last_index&quot;:1,&quot;commit_index&quot;:0, &quot;commit_term&quot;:0, &quot;read_seq&quot;:0}}}&#39;
</a> ---
 Panic: assertion `left == right` failed: multiple leaders in term
   left: 3
<b>diff --git a/<a id="h36" href="../file/src/raft/testscripts/node/heartbeat_old_commit_index.html">src/raft/testscripts/node/heartbeat_old_commit_index</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_old_commit_index.html">src/raft/testscripts/node/heartbeat_old_commit_index</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -16,7 +16,7 @@ n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a> n3@1 follower(n1) last=2@1 commit=2@1 apply=2
 
 # Step a heartbeat with an outdated commit index.
<a href="#h36-0-3" id="h36-0-3" class="d">-step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
</a><a href="#h36-0-4" id="h36-0-4" class="i">+step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;last_index&quot;:2,&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
</a> stabilize
 ---
<a href="#h36-0-7" id="h36-0-7" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=0
</a><a href="#h36-0-8" id="h36-0-8" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=0
</a><b>diff --git a/<a id="h37" href="../file/src/raft/testscripts/node/heartbeat_old_last_index.html">src/raft/testscripts/node/heartbeat_old_last_index</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_old_last_index.html">src/raft/testscripts/node/heartbeat_old_last_index</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+# A heartbeat with an old last index is matched by a follower.
</a><a href="#h37-0-1" id="h37-0-1" class="i">+
</a><a href="#h37-0-2" id="h37-0-2" class="i">+cluster nodes=3 leader=1
</a><a href="#h37-0-3" id="h37-0-3" class="i">+---
</a><a href="#h37-0-4" id="h37-0-4" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h37-0-5" id="h37-0-5" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h37-0-6" id="h37-0-6" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h37-0-7" id="h37-0-7" class="i">+
</a><a href="#h37-0-8" id="h37-0-8" class="i">+# Replicate a write.
</a><a href="#h37-0-9" id="h37-0-9" class="i">+(put 1 foo=bar)
</a><a href="#h37-0-10" id="h37-0-10" class="i">+(stabilize heartbeat=true)
</a><a href="#h37-0-11" id="h37-0-11" class="i">+status
</a><a href="#h37-0-12" id="h37-0-12" class="i">+---
</a><a href="#h37-0-13" id="h37-0-13" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:2→3}
</a><a href="#h37-0-14" id="h37-0-14" class="i">+n2@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h37-0-15" id="h37-0-15" class="i">+n3@1 follower(n1) last=2@1 commit=2@1 apply=2
</a><a href="#h37-0-16" id="h37-0-16" class="i">+
</a><a href="#h37-0-17" id="h37-0-17" class="i">+# Step a heartbeat with an outdated last index.
</a><a href="#h37-0-18" id="h37-0-18" class="i">+step 2 &#39;{&quot;from&quot;:1, &quot;to&quot;:2, &quot;term&quot;:1, &quot;message&quot;:{&quot;Heartbeat&quot;:{&quot;last_index&quot;:1,&quot;commit_index&quot;:1,&quot;commit_term&quot;:1,&quot;read_seq&quot;:0}}}&#39;
</a><a href="#h37-0-19" id="h37-0-19" class="i">+stabilize
</a><a href="#h37-0-20" id="h37-0-20" class="i">+---
</a><a href="#h37-0-21" id="h37-0-21" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a><b>diff --git a/<a id="h38" href="../file/src/raft/testscripts/node/heartbeat_probe_divergent.html">src/raft/testscripts/node/heartbeat_probe_divergent</a> b/<a href="../file/src/raft/testscripts/node/heartbeat_probe_divergent.html">src/raft/testscripts/node/heartbeat_probe_divergent</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,186 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+# A heartbeat while the leader is probing a follower with a long divergent tail
</a><a href="#h38-0-1" id="h38-0-1" class="i">+# doesn&#39;t disrupt the probing, and won&#39;t result in a quadratically increasing
</a><a href="#h38-0-2" id="h38-0-2" class="i">+# amount of probes with each heartbeat.
</a><a href="#h38-0-3" id="h38-0-3" class="i">+
</a><a href="#h38-0-4" id="h38-0-4" class="i">+cluster nodes=3 leader=1
</a><a href="#h38-0-5" id="h38-0-5" class="i">+---
</a><a href="#h38-0-6" id="h38-0-6" class="i">+n1@1 leader last=1@1 commit=1@1 apply=1 progress={2:1→2 3:1→2}
</a><a href="#h38-0-7" id="h38-0-7" class="i">+n2@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-0-8" id="h38-0-8" class="i">+n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a><a href="#h38-0-9" id="h38-0-9" class="i">+
</a><a href="#h38-0-10" id="h38-0-10" class="i">+# Make a couple of writes to ensure a common log prefix.
</a><a href="#h38-0-11" id="h38-0-11" class="i">+(put 1 a=1)
</a><a href="#h38-0-12" id="h38-0-12" class="i">+(put 1 b=2)
</a><a href="#h38-0-13" id="h38-0-13" class="i">+(stabilize)
</a><a href="#h38-0-14" id="h38-0-14" class="i">+status
</a><a href="#h38-0-15" id="h38-0-15" class="i">+---
</a><a href="#h38-0-16" id="h38-0-16" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4}
</a><a href="#h38-0-17" id="h38-0-17" class="i">+n2@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h38-0-18" id="h38-0-18" class="i">+n3@1 follower(n1) last=3@1 commit=1@1 apply=1
</a><a href="#h38-0-19" id="h38-0-19" class="i">+
</a><a href="#h38-0-20" id="h38-0-20" class="i">+# Partition n1
</a><a href="#h38-0-21" id="h38-0-21" class="i">+partition 1
</a><a href="#h38-0-22" id="h38-0-22" class="i">+---
</a><a href="#h38-0-23" id="h38-0-23" class="i">+n1 ⇹ n2 n3
</a><a href="#h38-0-24" id="h38-0-24" class="i">+
</a><a href="#h38-0-25" id="h38-0-25" class="i">+# Elect new leaders in the majority partition and replicate a few writes.
</a><a href="#h38-0-26" id="h38-0-26" class="i">+(campaign 2)
</a><a href="#h38-0-27" id="h38-0-27" class="i">+(stabilize)
</a><a href="#h38-0-28" id="h38-0-28" class="i">+(put 2 c=3)
</a><a href="#h38-0-29" id="h38-0-29" class="i">+(put 2 d=4)
</a><a href="#h38-0-30" id="h38-0-30" class="i">+(stabilize heartbeat=true)
</a><a href="#h38-0-31" id="h38-0-31" class="i">+status
</a><a href="#h38-0-32" id="h38-0-32" class="i">+---
</a><a href="#h38-0-33" id="h38-0-33" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4}
</a><a href="#h38-0-34" id="h38-0-34" class="i">+n2@2 leader last=6@2 commit=6@2 apply=6 progress={1:0→7 3:6→7}
</a><a href="#h38-0-35" id="h38-0-35" class="i">+n3@2 follower(n2) last=6@2 commit=6@2 apply=6
</a><a href="#h38-0-36" id="h38-0-36" class="i">+
</a><a href="#h38-0-37" id="h38-0-37" class="i">+(campaign 3)
</a><a href="#h38-0-38" id="h38-0-38" class="i">+(stabilize)
</a><a href="#h38-0-39" id="h38-0-39" class="i">+(put 2 e=5)
</a><a href="#h38-0-40" id="h38-0-40" class="i">+(put 2 f=6)
</a><a href="#h38-0-41" id="h38-0-41" class="i">+(stabilize heartbeat=true)
</a><a href="#h38-0-42" id="h38-0-42" class="i">+status
</a><a href="#h38-0-43" id="h38-0-43" class="i">+---
</a><a href="#h38-0-44" id="h38-0-44" class="i">+n1@1 leader last=3@1 commit=3@1 apply=3 progress={2:3→4 3:3→4}
</a><a href="#h38-0-45" id="h38-0-45" class="i">+n2@3 follower(n3) last=9@3 commit=9@3 apply=9
</a><a href="#h38-0-46" id="h38-0-46" class="i">+n3@3 leader last=9@3 commit=9@3 apply=9 progress={1:0→10 2:9→10}
</a><a href="#h38-0-47" id="h38-0-47" class="i">+
</a><a href="#h38-0-48" id="h38-0-48" class="i">+# Propose writes in the minority partition as well, to build up a divergent log.
</a><a href="#h38-0-49" id="h38-0-49" class="i">+(put 1 a=2)
</a><a href="#h38-0-50" id="h38-0-50" class="i">+(put 1 a=3)
</a><a href="#h38-0-51" id="h38-0-51" class="i">+(put 1 a=4)
</a><a href="#h38-0-52" id="h38-0-52" class="i">+(put 1 a=5)
</a><a href="#h38-0-53" id="h38-0-53" class="i">+(put 1 a=6)
</a><a href="#h38-0-54" id="h38-0-54" class="i">+(put 1 a=7)
</a><a href="#h38-0-55" id="h38-0-55" class="i">+(put 1 a=8)
</a><a href="#h38-0-56" id="h38-0-56" class="i">+(put 1 a=9)
</a><a href="#h38-0-57" id="h38-0-57" class="i">+(stabilize)
</a><a href="#h38-0-58" id="h38-0-58" class="i">+status
</a><a href="#h38-0-59" id="h38-0-59" class="i">+---
</a><a href="#h38-0-60" id="h38-0-60" class="i">+n1@1 leader last=11@1 commit=3@1 apply=3 progress={2:3→12 3:3→12}
</a><a href="#h38-0-61" id="h38-0-61" class="i">+n2@3 follower(n3) last=9@3 commit=9@3 apply=9
</a><a href="#h38-0-62" id="h38-0-62" class="i">+n3@3 leader last=9@3 commit=9@3 apply=9 progress={1:0→10 2:9→10}
</a><a href="#h38-0-63" id="h38-0-63" class="i">+
</a><a href="#h38-0-64" id="h38-0-64" class="i">+# Heal the partition.
</a><a href="#h38-0-65" id="h38-0-65" class="i">+heal
</a><a href="#h38-0-66" id="h38-0-66" class="i">+---
</a><a href="#h38-0-67" id="h38-0-67" class="i">+n1 n2 n3 fully connected
</a><a href="#h38-0-68" id="h38-0-68" class="i">+
</a><a href="#h38-0-69" id="h38-0-69" class="i">+# Propose another write on the majority leader to start probing.
</a><a href="#h38-0-70" id="h38-0-70" class="i">+put 3 g=7
</a><a href="#h38-0-71" id="h38-0-71" class="i">+---
</a><a href="#h38-0-72" id="h38-0-72" class="i">+c3@3 → n3 ClientRequest id=0x0f write 0x0101670137
</a><a href="#h38-0-73" id="h38-0-73" class="i">+n3@3 append 10@3 put g=7
</a><a href="#h38-0-74" id="h38-0-74" class="i">+n3@3 → n1 Append base=9@3 [10@3]
</a><a href="#h38-0-75" id="h38-0-75" class="i">+n3@3 → n2 Append base=9@3 [10@3]
</a><a href="#h38-0-76" id="h38-0-76" class="i">+
</a><a href="#h38-0-77" id="h38-0-77" class="i">+# The append should be rejected by n1, canceling the writes.
</a><a href="#h38-0-78" id="h38-0-78" class="i">+deliver 1
</a><a href="#h38-0-79" id="h38-0-79" class="i">+---
</a><a href="#h38-0-80" id="h38-0-80" class="i">+n1@1 leader ⇨ n1@3 follower(n3)
</a><a href="#h38-0-81" id="h38-0-81" class="i">+n1@1 → c1 ClientResponse id=0x07 Error::Abort
</a><a href="#h38-0-82" id="h38-0-82" class="i">+c1@1 put a=2 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-83" id="h38-0-83" class="i">+n1@1 → c1 ClientResponse id=0x08 Error::Abort
</a><a href="#h38-0-84" id="h38-0-84" class="i">+c1@1 put a=3 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-85" id="h38-0-85" class="i">+n1@1 → c1 ClientResponse id=0x09 Error::Abort
</a><a href="#h38-0-86" id="h38-0-86" class="i">+c1@1 put a=4 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-87" id="h38-0-87" class="i">+n1@1 → c1 ClientResponse id=0x0a Error::Abort
</a><a href="#h38-0-88" id="h38-0-88" class="i">+c1@1 put a=5 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-89" id="h38-0-89" class="i">+n1@1 → c1 ClientResponse id=0x0b Error::Abort
</a><a href="#h38-0-90" id="h38-0-90" class="i">+c1@1 put a=6 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-91" id="h38-0-91" class="i">+n1@1 → c1 ClientResponse id=0x0c Error::Abort
</a><a href="#h38-0-92" id="h38-0-92" class="i">+c1@1 put a=7 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-93" id="h38-0-93" class="i">+n1@1 → c1 ClientResponse id=0x0d Error::Abort
</a><a href="#h38-0-94" id="h38-0-94" class="i">+c1@1 put a=8 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-95" id="h38-0-95" class="i">+n1@1 → c1 ClientResponse id=0x0e Error::Abort
</a><a href="#h38-0-96" id="h38-0-96" class="i">+c1@1 put a=9 ⇒ Error::Abort (operation aborted)
</a><a href="#h38-0-97" id="h38-0-97" class="i">+n1@3 → n3 AppendResponse reject_index=9
</a><a href="#h38-0-98" id="h38-0-98" class="i">+
</a><a href="#h38-0-99" id="h38-0-99" class="i">+# n3 begins probing, and also heartbeats.
</a><a href="#h38-0-100" id="h38-0-100" class="i">+deliver 3
</a><a href="#h38-0-101" id="h38-0-101" class="i">+heartbeat 3
</a><a href="#h38-0-102" id="h38-0-102" class="i">+deliver 1
</a><a href="#h38-0-103" id="h38-0-103" class="i">+status 3
</a><a href="#h38-0-104" id="h38-0-104" class="i">+---
</a><a href="#h38-0-105" id="h38-0-105" class="i">+n3@3 → n1 Append base=8@3 []
</a><a href="#h38-0-106" id="h38-0-106" class="i">+n3@3 → n1 Heartbeat last_index=10 commit=9@3 read_seq=0
</a><a href="#h38-0-107" id="h38-0-107" class="i">+n3@3 → n2 Heartbeat last_index=10 commit=9@3 read_seq=0
</a><a href="#h38-0-108" id="h38-0-108" class="i">+n1@3 → n3 AppendResponse reject_index=8
</a><a href="#h38-0-109" id="h38-0-109" class="i">+n1@3 → n3 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h38-0-110" id="h38-0-110" class="i">+n3@3 leader last=10@3 commit=9@3 apply=9 progress={1:0→9 2:9→11}
</a><a href="#h38-0-111" id="h38-0-111" class="i">+
</a><a href="#h38-0-112" id="h38-0-112" class="i">+# n3 receives probe and heartbeat responses, resulting in duplicate
</a><a href="#h38-0-113" id="h38-0-113" class="i">+# probes being sent at base index 7.
</a><a href="#h38-0-114" id="h38-0-114" class="i">+deliver 3
</a><a href="#h38-0-115" id="h38-0-115" class="i">+status 3
</a><a href="#h38-0-116" id="h38-0-116" class="i">+---
</a><a href="#h38-0-117" id="h38-0-117" class="i">+n3@3 → n1 Append base=7@3 []
</a><a href="#h38-0-118" id="h38-0-118" class="i">+n3@3 → n1 Append base=7@3 []
</a><a href="#h38-0-119" id="h38-0-119" class="i">+n3@3 leader last=10@3 commit=9@3 apply=9 progress={1:0→8 2:9→11}
</a><a href="#h38-0-120" id="h38-0-120" class="i">+
</a><a href="#h38-0-121" id="h38-0-121" class="i">+deliver 1
</a><a href="#h38-0-122" id="h38-0-122" class="i">+---
</a><a href="#h38-0-123" id="h38-0-123" class="i">+n1@3 → n3 AppendResponse reject_index=7
</a><a href="#h38-0-124" id="h38-0-124" class="i">+n1@3 → n3 AppendResponse reject_index=7
</a><a href="#h38-0-125" id="h38-0-125" class="i">+
</a><a href="#h38-0-126" id="h38-0-126" class="i">+# However, when receiving the duplicate probe responses, they are
</a><a href="#h38-0-127" id="h38-0-127" class="i">+# deduplicated and only a single new probe is sent.
</a><a href="#h38-0-128" id="h38-0-128" class="i">+deliver 3
</a><a href="#h38-0-129" id="h38-0-129" class="i">+---
</a><a href="#h38-0-130" id="h38-0-130" class="i">+n3@3 → n1 Append base=6@2 []
</a><a href="#h38-0-131" id="h38-0-131" class="i">+
</a><a href="#h38-0-132" id="h38-0-132" class="i">+deliver 1
</a><a href="#h38-0-133" id="h38-0-133" class="i">+---
</a><a href="#h38-0-134" id="h38-0-134" class="i">+n1@3 → n3 AppendResponse reject_index=6
</a><a href="#h38-0-135" id="h38-0-135" class="i">+
</a><a href="#h38-0-136" id="h38-0-136" class="i">+# n3 heartbeats again before sending the next probe. This results in
</a><a href="#h38-0-137" id="h38-0-137" class="i">+# two probes: the heartbeat response resends the probe at base 5, while
</a><a href="#h38-0-138" id="h38-0-138" class="i">+# the probe response triggers a new probe at base 4.
</a><a href="#h38-0-139" id="h38-0-139" class="i">+heartbeat 3
</a><a href="#h38-0-140" id="h38-0-140" class="i">+deliver 3
</a><a href="#h38-0-141" id="h38-0-141" class="i">+---
</a><a href="#h38-0-142" id="h38-0-142" class="i">+n3@3 → n1 Heartbeat last_index=10 commit=9@3 read_seq=0
</a><a href="#h38-0-143" id="h38-0-143" class="i">+n3@3 → n2 Heartbeat last_index=10 commit=9@3 read_seq=0
</a><a href="#h38-0-144" id="h38-0-144" class="i">+n3@3 → n1 Append base=5@2 []
</a><a href="#h38-0-145" id="h38-0-145" class="i">+
</a><a href="#h38-0-146" id="h38-0-146" class="i">+deliver 1
</a><a href="#h38-0-147" id="h38-0-147" class="i">+---
</a><a href="#h38-0-148" id="h38-0-148" class="i">+n1@3 → n3 HeartbeatResponse match_index=0 read_seq=0
</a><a href="#h38-0-149" id="h38-0-149" class="i">+n1@3 → n3 AppendResponse reject_index=5
</a><a href="#h38-0-150" id="h38-0-150" class="i">+
</a><a href="#h38-0-151" id="h38-0-151" class="i">+deliver 3
</a><a href="#h38-0-152" id="h38-0-152" class="i">+---
</a><a href="#h38-0-153" id="h38-0-153" class="i">+n3@3 → n1 Append base=5@2 []
</a><a href="#h38-0-154" id="h38-0-154" class="i">+n3@3 → n1 Append base=4@2 []
</a><a href="#h38-0-155" id="h38-0-155" class="i">+
</a><a href="#h38-0-156" id="h38-0-156" class="i">+deliver 1
</a><a href="#h38-0-157" id="h38-0-157" class="i">+---
</a><a href="#h38-0-158" id="h38-0-158" class="i">+n1@3 → n3 AppendResponse reject_index=5
</a><a href="#h38-0-159" id="h38-0-159" class="i">+n1@3 → n3 AppendResponse reject_index=4
</a><a href="#h38-0-160" id="h38-0-160" class="i">+
</a><a href="#h38-0-161" id="h38-0-161" class="i">+# The probe response at reject_index=5 is ignored, since we&#39;re already probed
</a><a href="#h38-0-162" id="h38-0-162" class="i">+# it. Only a single new probe is sent at base 4.
</a><a href="#h38-0-163" id="h38-0-163" class="i">+deliver 3
</a><a href="#h38-0-164" id="h38-0-164" class="i">+---
</a><a href="#h38-0-165" id="h38-0-165" class="i">+n3@3 → n1 Append base=3@1 []
</a><a href="#h38-0-166" id="h38-0-166" class="i">+
</a><a href="#h38-0-167" id="h38-0-167" class="i">+# When delivered, we finally get a match, and the follower gets caught up.
</a><a href="#h38-0-168" id="h38-0-168" class="i">+deliver 1
</a><a href="#h38-0-169" id="h38-0-169" class="i">+---
</a><a href="#h38-0-170" id="h38-0-170" class="i">+n1@3 → n3 AppendResponse match_index=3
</a><a href="#h38-0-171" id="h38-0-171" class="i">+
</a><a href="#h38-0-172" id="h38-0-172" class="i">+deliver 3
</a><a href="#h38-0-173" id="h38-0-173" class="i">+---
</a><a href="#h38-0-174" id="h38-0-174" class="i">+n3@3 → n1 Append base=3@1 [4@2 5@2 6@2 7@3 8@3 9@3 10@3]
</a><a href="#h38-0-175" id="h38-0-175" class="i">+
</a><a href="#h38-0-176" id="h38-0-176" class="i">+deliver 1
</a><a href="#h38-0-177" id="h38-0-177" class="i">+---
</a><a href="#h38-0-178" id="h38-0-178" class="i">+n1@3 → n3 AppendResponse match_index=10
</a><a href="#h38-0-179" id="h38-0-179" class="i">+
</a><a href="#h38-0-180" id="h38-0-180" class="i">+deliver 3
</a><a href="#h38-0-181" id="h38-0-181" class="i">+---
</a><a href="#h38-0-182" id="h38-0-182" class="i">+n3@3 commit 10@3
</a><a href="#h38-0-183" id="h38-0-183" class="i">+n3@3 apply 10@3 put g=7
</a><a href="#h38-0-184" id="h38-0-184" class="i">+n3@3 → c3 ClientResponse id=0x0f write 0x010a
</a><a href="#h38-0-185" id="h38-0-185" class="i">+c3@3 put g=7 ⇒ 10
</a><b>diff --git a/<a id="h39" href="../file/src/raft/testscripts/node/old_campaign_rejected.html">src/raft/testscripts/node/old_campaign_rejected</a> b/<a href="../file/src/raft/testscripts/node/old_campaign_rejected.html">src/raft/testscripts/node/old_campaign_rejected</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -30,20 +30,20 @@ n1@1 candidate ⇨ n1@1 leader
</a> n1@1 append 1@1 None
 n1@1 → n2 Append base=0@0 [1@1]
 n1@1 → n3 Append base=0@0 [1@1]
<a href="#h39-0-3" id="h39-0-3" class="d">-n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h39-0-4" id="h39-0-4" class="d">-n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h39-0-5" id="h39-0-5" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h39-0-6" id="h39-0-6" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 # n3 receives n1&#39;s heartbeat and becomes follower.
 deliver 3 from=1
 ---
 n3@1 follower() ⇨ n3@1 follower(n1)
 n3@1 append 1@1 None
<a href="#h39-0-13" id="h39-0-13" class="d">-n3@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h39-0-14" id="h39-0-14" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h39-0-15" id="h39-0-15" class="i">+n3@1 → n1 AppendResponse match_index=1
</a><a href="#h39-0-16" id="h39-0-16" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 status
 ---
<a href="#h39-0-20" id="h39-0-20" class="d">-n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→1 3:0→1}
</a><a href="#h39-0-21" id="h39-0-21" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→2 3:0→2}
</a> n2@1 candidate last=0@0 commit=0@0 apply=0
 n3@1 follower(n1) last=1@1 commit=0@0 apply=0
 
<b>diff --git a/<a id="h40" href="../file/src/raft/testscripts/node/old_campaign_response_ignored.html">src/raft/testscripts/node/old_campaign_response_ignored</a> b/<a href="../file/src/raft/testscripts/node/old_campaign_response_ignored.html">src/raft/testscripts/node/old_campaign_response_ignored</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -57,12 +57,12 @@ n1@1 → n4 Append base=0@0 [1@1]
</a> n1@1 → n5 Append base=0@0 [1@1]
 n1@1 → n6 Append base=0@0 [1@1]
 n1@1 → n7 Append base=0@0 [1@1]
<a href="#h40-0-3" id="h40-0-3" class="d">-n1@1 → n2 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-4" id="h40-0-4" class="d">-n1@1 → n3 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-5" id="h40-0-5" class="d">-n1@1 → n4 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-6" id="h40-0-6" class="d">-n1@1 → n5 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-7" id="h40-0-7" class="d">-n1@1 → n6 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-8" id="h40-0-8" class="d">-n1@1 → n7 Heartbeat commit=0@0 read_seq=0
</a><a href="#h40-0-9" id="h40-0-9" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h40-0-10" id="h40-0-10" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h40-0-11" id="h40-0-11" class="i">+n1@1 → n4 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h40-0-12" id="h40-0-12" class="i">+n1@1 → n5 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h40-0-13" id="h40-0-13" class="i">+n1@1 → n6 Heartbeat last_index=1 commit=0@0 read_seq=0
</a><a href="#h40-0-14" id="h40-0-14" class="i">+n1@1 → n7 Heartbeat last_index=1 commit=0@0 read_seq=0
</a> 
 # n2 receives n1&#39;s heartbeats and becomes follower.
 deliver 2 from=1
<a href="#h40-1" id="h40-1" class="h">@@ -70,8 +70,8 @@ deliver 2 from=1
</a> n2@1 → n1 CampaignResponse vote=false
 n2@1 candidate ⇨ n2@1 follower(n1)
 n2@1 append 1@1 None
<a href="#h40-1-3" id="h40-1-3" class="d">-n2@1 → n1 AppendResponse last=1@1 reject=0
</a><a href="#h40-1-4" id="h40-1-4" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h40-1-5" id="h40-1-5" class="i">+n2@1 → n1 AppendResponse match_index=1
</a><a href="#h40-1-6" id="h40-1-6" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 # n1 (leader) receives n6&#39;s vote and ignores it. n2 (follower) receives n7&#39;s
 # vote and ignores it. They remain leader and follower.
<a href="#h40-2" id="h40-2" class="h">@@ -79,7 +79,7 @@ deliver 1 from=6
</a> deliver 2 from=7
 status
 ---
<a href="#h40-2-3" id="h40-2-3" class="d">-n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→1 3:0→1 4:0→1 5:0→1 6:0→1 7:0→1}
</a><a href="#h40-2-4" id="h40-2-4" class="i">+n1@1 leader last=1@1 commit=0@0 apply=0 progress={2:0→2 3:0→2 4:0→2 5:0→2 6:0→2 7:0→2}
</a> n2@1 follower(n1) last=1@1 commit=0@0 apply=0
 n3@1 follower() last=0@0 commit=0@0 apply=0
 n4@1 follower() last=0@0 commit=0@0 apply=0
<b>diff --git a/<a id="h41" href="../file/src/raft/testscripts/node/old_heartbeat_ignored.html">src/raft/testscripts/node/old_heartbeat_ignored</a> b/<a href="../file/src/raft/testscripts/node/old_heartbeat_ignored.html">src/raft/testscripts/node/old_heartbeat_ignored</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -17,7 +17,7 @@ n3 ⇹ n1 n2
</a> (stabilize heartbeat=true)
 status
 ---
<a href="#h41-0-3" id="h41-0-3" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h41-0-4" id="h41-0-4" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→3}
</a> n2@2 follower(n1) last=2@2 commit=2@2 apply=2
 n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
 
<a href="#h41-1" id="h41-1" class="h">@@ -30,11 +30,11 @@ n1 n2 n3 fully connected
</a> heartbeat 3
 stabilize
 ---
<a href="#h41-1-3" id="h41-1-3" class="d">-n3@1 → n1 Heartbeat commit=1@1 read_seq=0
</a><a href="#h41-1-4" id="h41-1-4" class="d">-n3@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h41-1-5" id="h41-1-5" class="i">+n3@1 → n1 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h41-1-6" id="h41-1-6" class="i">+n3@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a> 
 status
 ---
<a href="#h41-1-10" id="h41-1-10" class="d">-n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→2}
</a><a href="#h41-1-11" id="h41-1-11" class="i">+n1@2 leader last=2@2 commit=2@2 apply=2 progress={2:2→3 3:0→3}
</a> n2@2 follower(n1) last=2@2 commit=2@2 apply=2
 n3@1 leader last=1@1 commit=1@1 apply=1 progress={1:1→2 2:1→2}
<b>diff --git a/<a id="h42" href="../file/src/raft/testscripts/node/request_follower.html">src/raft/testscripts/node/request_follower</a> b/<a href="../file/src/raft/testscripts/node/request_follower.html">src/raft/testscripts/node/request_follower</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -12,10 +12,10 @@ stabilize
</a> ---
 c2@1 → n2 ClientRequest id=0x01 read 0x0003666f6f
 n2@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
<a href="#h42-0-3" id="h42-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h42-0-4" id="h42-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h42-0-5" id="h42-0-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h42-0-6" id="h42-0-6" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h42-0-7" id="h42-0-7" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=1
</a><a href="#h42-0-8" id="h42-0-8" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=1
</a><a href="#h42-0-9" id="h42-0-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=1
</a><a href="#h42-0-10" id="h42-0-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=1
</a> n1@1 → n2 ClientResponse id=0x01 read 0x0000
 n2@1 → c2 ClientResponse id=0x01 read 0x0000
 c2@1 get foo ⇒ None
<a href="#h42-1" id="h42-1" class="h">@@ -31,9 +31,9 @@ n1@1 append 2@1 put foo=bar
</a> n1@1 → n2 Append base=1@1 [2@1]
 n1@1 → n3 Append base=1@1 [2@1]
 n2@1 append 2@1 put foo=bar
<a href="#h42-1-3" id="h42-1-3" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h42-1-4" id="h42-1-4" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> n3@1 append 2@1 put foo=bar
<a href="#h42-1-6" id="h42-1-6" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h42-1-7" id="h42-1-7" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> n1@1 commit 2@1
 n1@1 apply 2@1 put foo=bar
 n1@1 → n2 ClientResponse id=0x02 write 0x0102
<a href="#h42-2" id="h42-2" class="h">@@ -46,10 +46,10 @@ stabilize
</a> ---
 c2@1 → n2 ClientRequest id=0x03 read 0x0003666f6f
 n2@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
<a href="#h42-2-3" id="h42-2-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-2-4" id="h42-2-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h42-2-5" id="h42-2-5" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h42-2-6" id="h42-2-6" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h42-2-7" id="h42-2-7" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h42-2-8" id="h42-2-8" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h42-2-9" id="h42-2-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a><a href="#h42-2-10" id="h42-2-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a> n1@1 → n2 ClientResponse id=0x03 read 0x000103626172
 n2@1 → c2 ClientResponse id=0x03 read 0x000103626172
 c2@1 get foo ⇒ bar
<b>diff --git a/<a id="h43" href="../file/src/raft/testscripts/node/request_follower_disconnect_stall.html">src/raft/testscripts/node/request_follower_disconnect_stall</a> b/<a href="../file/src/raft/testscripts/node/request_follower_disconnect_stall.html">src/raft/testscripts/node/request_follower_disconnect_stall</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -29,7 +29,7 @@ n1 n2 n3 fully connected
</a> 
 stabilize heartbeat=true
 ---
<a href="#h43-0-3" id="h43-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h43-0-4" id="h43-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h43-0-5" id="h43-0-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h43-0-6" id="h43-0-6" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h43-0-7" id="h43-0-7" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h43-0-8" id="h43-0-8" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h43-0-9" id="h43-0-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a><a href="#h43-0-10" id="h43-0-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a><b>diff --git a/<a id="h44" href="../file/src/raft/testscripts/node/request_leader.html">src/raft/testscripts/node/request_leader</a> b/<a href="../file/src/raft/testscripts/node/request_leader.html">src/raft/testscripts/node/request_leader</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -11,10 +11,10 @@ get 1 foo
</a> stabilize
 ---
 c1@1 → n1 ClientRequest id=0x01 read 0x0003666f6f
<a href="#h44-0-3" id="h44-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h44-0-4" id="h44-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h44-0-5" id="h44-0-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h44-0-6" id="h44-0-6" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h44-0-7" id="h44-0-7" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=1
</a><a href="#h44-0-8" id="h44-0-8" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=1
</a><a href="#h44-0-9" id="h44-0-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=1
</a><a href="#h44-0-10" id="h44-0-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=1
</a> n1@1 → c1 ClientResponse id=0x01 read 0x0000
 c1@1 get foo ⇒ None
 
<a href="#h44-1" id="h44-1" class="h">@@ -28,9 +28,9 @@ n1@1 append 2@1 put foo=bar
</a> n1@1 → n2 Append base=1@1 [2@1]
 n1@1 → n3 Append base=1@1 [2@1]
 n2@1 append 2@1 put foo=bar
<a href="#h44-1-3" id="h44-1-3" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h44-1-4" id="h44-1-4" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> n3@1 append 2@1 put foo=bar
<a href="#h44-1-6" id="h44-1-6" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h44-1-7" id="h44-1-7" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> n1@1 commit 2@1
 n1@1 apply 2@1 put foo=bar
 n1@1 → c1 ClientResponse id=0x02 write 0x0102
<a href="#h44-2" id="h44-2" class="h">@@ -41,9 +41,9 @@ get 1 foo
</a> stabilize
 ---
 c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
<a href="#h44-2-3" id="h44-2-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h44-2-4" id="h44-2-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h44-2-5" id="h44-2-5" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h44-2-6" id="h44-2-6" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h44-2-7" id="h44-2-7" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h44-2-8" id="h44-2-8" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h44-2-9" id="h44-2-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a><a href="#h44-2-10" id="h44-2-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a> n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
 c1@1 get foo ⇒ bar
<b>diff --git a/<a id="h45" href="../file/src/raft/testscripts/node/request_leader_campaign_abort.html">src/raft/testscripts/node/request_leader_campaign_abort</a> b/<a href="../file/src/raft/testscripts/node/request_leader_campaign_abort.html">src/raft/testscripts/node/request_leader_campaign_abort</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -15,8 +15,8 @@ n1@1 append 2@1 put foo=bar
</a> n1@1 → n2 Append base=1@1 [2@1]
 n1@1 → n3 Append base=1@1 [2@1]
 c1@1 → n1 ClientRequest id=0x02 read 0x0003666f6f
<a href="#h45-0-3" id="h45-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h45-0-4" id="h45-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h45-0-5" id="h45-0-5" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=1
</a><a href="#h45-0-6" id="h45-0-6" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=1
</a> 
 # n2 campaigns before n1&#39;s requests achieve quorum.
 campaign 2
<b>diff --git a/<a id="h46" href="../file/src/raft/testscripts/node/request_leader_change_linearizability.html">src/raft/testscripts/node/request_leader_change_linearizability</a> b/<a href="../file/src/raft/testscripts/node/request_leader_change_linearizability.html">src/raft/testscripts/node/request_leader_change_linearizability</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -46,39 +46,43 @@ n2@2 candidate ⇨ n2@2 leader
</a> n2@2 append 4@2 None
 n2@2 ⇥ n1 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶2̶]̶
 n2@2 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶3̶@̶1̶ ̶[̶4̶@̶2̶]̶
<a href="#h46-0-3" id="h46-0-3" class="d">-n2@2 ⇥ n1 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h46-0-4" id="h46-0-4" class="d">-n2@2 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h46-0-5" id="h46-0-5" class="i">+n2@2 ⇥ n1 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶4̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a><a href="#h46-0-6" id="h46-0-6" class="i">+n2@2 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶4̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶0̶
</a> 
 heal
 status
 ---
 n1 n2 n3 fully connected
 n1@2 follower() last=3@1 commit=3@1 apply=3
<a href="#h46-0-13" id="h46-0-13" class="d">-n2@2 leader last=4@2 commit=2@1 apply=2 progress={1:0→4 3:0→4}
</a><a href="#h46-0-14" id="h46-0-14" class="i">+n2@2 leader last=4@2 commit=2@1 apply=2 progress={1:0→5 3:0→5}
</a> n3@2 follower() last=3@1 commit=2@1 apply=2
 
 # Reading from n2 should not result in a stale read.
 #
<a href="#h46-0-19" id="h46-0-19" class="d">-# TODO: this currently results in a stale read, since n2 does not commit and
</a><a href="#h46-0-20" id="h46-0-20" class="d">-# apply in response to heartbeat messages.
</a><a href="#h46-0-21" id="h46-0-21" class="i">+# TODO: this currently results in a stale read, since n2 does not wait to commit
</a><a href="#h46-0-22" id="h46-0-22" class="i">+# and apply an entry from its own term before serving reads.
</a> get 2 b
 stabilize
 ---
 c2@2 → n2 ClientRequest id=0x03 read 0x000162
<a href="#h46-0-27" id="h46-0-27" class="d">-n2@2 → n1 Heartbeat commit=2@1 read_seq=1
</a><a href="#h46-0-28" id="h46-0-28" class="d">-n2@2 → n3 Heartbeat commit=2@1 read_seq=1
</a><a href="#h46-0-29" id="h46-0-29" class="i">+n2@2 → n1 Heartbeat last_index=4 commit=2@1 read_seq=1
</a><a href="#h46-0-30" id="h46-0-30" class="i">+n2@2 → n3 Heartbeat last_index=4 commit=2@1 read_seq=1
</a> n1@2 follower() ⇨ n1@2 follower(n2)
<a href="#h46-0-32" id="h46-0-32" class="d">-n1@2 → n2 HeartbeatResponse last=3@1 read_seq=1
</a><a href="#h46-0-33" id="h46-0-33" class="i">+n1@2 → n2 HeartbeatResponse match_index=0 read_seq=1
</a> n3@2 follower() ⇨ n3@2 follower(n2)
<a href="#h46-0-35" id="h46-0-35" class="d">-n3@2 → n2 HeartbeatResponse last=3@1 read_seq=1
</a><a href="#h46-0-36" id="h46-0-36" class="i">+n3@2 → n2 HeartbeatResponse match_index=0 read_seq=1
</a> n2@2 → c2 ClientResponse id=0x03 read 0x0000
 c2@2 get b ⇒ None
<a href="#h46-0-39" id="h46-0-39" class="i">+n2@2 → n1 Append base=3@1 []
</a><a href="#h46-0-40" id="h46-0-40" class="i">+n2@2 → n3 Append base=3@1 []
</a><a href="#h46-0-41" id="h46-0-41" class="i">+n1@2 → n2 AppendResponse match_index=3
</a><a href="#h46-0-42" id="h46-0-42" class="i">+n3@2 → n2 AppendResponse match_index=3
</a> n2@2 → n1 Append base=3@1 [4@2]
 n2@2 → n3 Append base=3@1 [4@2]
 n1@2 append 4@2 None
<a href="#h46-0-46" id="h46-0-46" class="d">-n1@2 → n2 AppendResponse last=4@2 reject=0
</a><a href="#h46-0-47" id="h46-0-47" class="i">+n1@2 → n2 AppendResponse match_index=4
</a> n3@2 append 4@2 None
<a href="#h46-0-49" id="h46-0-49" class="d">-n3@2 → n2 AppendResponse last=4@2 reject=0
</a><a href="#h46-0-50" id="h46-0-50" class="i">+n3@2 → n2 AppendResponse match_index=4
</a> n2@2 commit 4@2
 n2@2 apply 3@1 put b=2
 n2@2 apply 4@2 None
<b>diff --git a/<a id="h47" href="../file/src/raft/testscripts/node/request_leader_disconnect.html">src/raft/testscripts/node/request_leader_disconnect</a> b/<a href="../file/src/raft/testscripts/node/request_leader_disconnect.html">src/raft/testscripts/node/request_leader_disconnect</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -22,28 +22,28 @@ n1@1 append 2@1 put foo=bar
</a> n1@1 ⇥ n2 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
 n1@1 ⇥ n3 A̶p̶p̶e̶n̶d̶ ̶b̶a̶s̶e̶=̶1̶@̶1̶ ̶[̶2̶@̶1̶]̶
 c1@1 → n1 ClientRequest id=0x02 read 0x0003666f6f
<a href="#h47-0-3" id="h47-0-3" class="d">-n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a><a href="#h47-0-4" id="h47-0-4" class="d">-n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a><a href="#h47-0-5" id="h47-0-5" class="i">+n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a><a href="#h47-0-6" id="h47-0-6" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶1̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶1̶
</a> 
<a href="#h47-0-8" id="h47-0-8" class="d">-# Heal the partition and heartbeat. The requests return a result.
</a><a href="#h47-0-9" id="h47-0-9" class="i">+# Heal the partition and heartbeat. The requests eventually return results.
</a> heal
 ---
 n1 n2 n3 fully connected
 
 stabilize heartbeat=true
 ---
<a href="#h47-0-16" id="h47-0-16" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=1
</a><a href="#h47-0-17" id="h47-0-17" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=1
</a><a href="#h47-0-18" id="h47-0-18" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h47-0-19" id="h47-0-19" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=1
</a><a href="#h47-0-20" id="h47-0-20" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=1@1 read_seq=1
</a><a href="#h47-0-21" id="h47-0-21" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=1@1 read_seq=1
</a><a href="#h47-0-22" id="h47-0-22" class="i">+n2@1 → n1 HeartbeatResponse match_index=0 read_seq=1
</a><a href="#h47-0-23" id="h47-0-23" class="i">+n3@1 → n1 HeartbeatResponse match_index=0 read_seq=1
</a> n1@1 → c1 ClientResponse id=0x02 read 0x0000
 c1@1 get foo ⇒ None
 n1@1 → n2 Append base=1@1 [2@1]
 n1@1 → n3 Append base=1@1 [2@1]
 n2@1 append 2@1 put foo=bar
<a href="#h47-0-29" id="h47-0-29" class="d">-n2@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h47-0-30" id="h47-0-30" class="i">+n2@1 → n1 AppendResponse match_index=2
</a> n3@1 append 2@1 put foo=bar
<a href="#h47-0-32" id="h47-0-32" class="d">-n3@1 → n1 AppendResponse last=2@1 reject=0
</a><a href="#h47-0-33" id="h47-0-33" class="i">+n3@1 → n1 AppendResponse match_index=2
</a> n1@1 commit 2@1
 n1@1 apply 2@1 put foo=bar
 n1@1 → c1 ClientResponse id=0x01 write 0x0102
<b>diff --git a/<a id="h48" href="../file/src/raft/testscripts/node/request_leader_read_quorum.html">src/raft/testscripts/node/request_leader_read_quorum</a> b/<a href="../file/src/raft/testscripts/node/request_leader_read_quorum.html">src/raft/testscripts/node/request_leader_read_quorum</a></b>
<a href="#h48-0" id="h48-0" class="h">@@ -25,20 +25,20 @@ ok
</a> get 1 foo
 ---
 c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
<a href="#h48-0-3" id="h48-0-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=2
</a><a href="#h48-0-4" id="h48-0-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=2
</a><a href="#h48-0-5" id="h48-0-5" class="d">-n1@1 → n4 Heartbeat commit=2@1 read_seq=2
</a><a href="#h48-0-6" id="h48-0-6" class="d">-n1@1 → n5 Heartbeat commit=2@1 read_seq=2
</a><a href="#h48-0-7" id="h48-0-7" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h48-0-8" id="h48-0-8" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h48-0-9" id="h48-0-9" class="i">+n1@1 → n4 Heartbeat last_index=2 commit=2@1 read_seq=2
</a><a href="#h48-0-10" id="h48-0-10" class="i">+n1@1 → n5 Heartbeat last_index=2 commit=2@1 read_seq=2
</a> 
 deliver 2
 deliver 1
 ---
<a href="#h48-0-15" id="h48-0-15" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h48-0-16" id="h48-0-16" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a> 
 deliver 3
 deliver 1
 ---
<a href="#h48-0-21" id="h48-0-21" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=2
</a><a href="#h48-0-22" id="h48-0-22" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=2
</a> n1@1 → c1 ClientResponse id=0x03 read 0x000103626172
 c1@1 get foo ⇒ bar
 
<b>diff --git a/<a id="h49" href="../file/src/raft/testscripts/node/request_leader_read_quorum_sequence.html">src/raft/testscripts/node/request_leader_read_quorum_sequence</a> b/<a href="../file/src/raft/testscripts/node/request_leader_read_quorum_sequence.html">src/raft/testscripts/node/request_leader_read_quorum_sequence</a></b>
<a href="#h49-0" id="h49-0" class="h">@@ -21,14 +21,14 @@ ok
</a> heartbeat 1
 deliver
 ---
<a href="#h49-0-3" id="h49-0-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=1
</a><a href="#h49-0-4" id="h49-0-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=1
</a><a href="#h49-0-5" id="h49-0-5" class="d">-n1@1 → n4 Heartbeat commit=2@1 read_seq=1
</a><a href="#h49-0-6" id="h49-0-6" class="d">-n1@1 → n5 Heartbeat commit=2@1 read_seq=1
</a><a href="#h49-0-7" id="h49-0-7" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h49-0-8" id="h49-0-8" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h49-0-9" id="h49-0-9" class="d">-n4@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h49-0-10" id="h49-0-10" class="d">-n5@1 → n1 HeartbeatResponse last=2@1 read_seq=1
</a><a href="#h49-0-11" id="h49-0-11" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=1
</a><a href="#h49-0-12" id="h49-0-12" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=1
</a><a href="#h49-0-13" id="h49-0-13" class="i">+n1@1 → n4 Heartbeat last_index=2 commit=2@1 read_seq=1
</a><a href="#h49-0-14" id="h49-0-14" class="i">+n1@1 → n5 Heartbeat last_index=2 commit=2@1 read_seq=1
</a><a href="#h49-0-15" id="h49-0-15" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=1
</a><a href="#h49-0-16" id="h49-0-16" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=1
</a><a href="#h49-0-17" id="h49-0-17" class="i">+n4@1 → n1 HeartbeatResponse match_index=2 read_seq=1
</a><a href="#h49-0-18" id="h49-0-18" class="i">+n5@1 → n1 HeartbeatResponse match_index=2 read_seq=1
</a> 
 # Partition n1 away.
 partition 1
<a href="#h49-1" id="h49-1" class="h">@@ -39,10 +39,10 @@ n1 ⇹ n2 n3 n4 n5
</a> get 1 foo
 ---
 c1@1 → n1 ClientRequest id=0x03 read 0x0003666f6f
<a href="#h49-1-3" id="h49-1-3" class="d">-n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-4" id="h49-1-4" class="d">-n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-5" id="h49-1-5" class="d">-n1@1 ⇥ n4 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-6" id="h49-1-6" class="d">-n1@1 ⇥ n5 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-7" id="h49-1-7" class="i">+n1@1 ⇥ n2 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-8" id="h49-1-8" class="i">+n1@1 ⇥ n3 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-9" id="h49-1-9" class="i">+n1@1 ⇥ n4 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a><a href="#h49-1-10" id="h49-1-10" class="i">+n1@1 ⇥ n5 H̶e̶a̶r̶t̶b̶e̶a̶t̶ ̶l̶a̶s̶t̶_̶i̶n̶d̶e̶x̶=̶2̶ ̶c̶o̶m̶m̶i̶t̶=̶2̶@̶1̶ ̶r̶e̶a̶d̶_̶s̶e̶q̶=̶2̶
</a> 
 # Deliver the heartbeat responses at sequence number 1. These should not satisfy
 # the read at sequence number 2.
<a href="#h49-2" id="h49-2" class="h">@@ -57,17 +57,17 @@ get 1 foo
</a> ---
 n1 n2 n3 n4 n5 fully connected
 c1@1 → n1 ClientRequest id=0x04 read 0x0003666f6f
<a href="#h49-2-3" id="h49-2-3" class="d">-n1@1 → n2 Heartbeat commit=2@1 read_seq=3
</a><a href="#h49-2-4" id="h49-2-4" class="d">-n1@1 → n3 Heartbeat commit=2@1 read_seq=3
</a><a href="#h49-2-5" id="h49-2-5" class="d">-n1@1 → n4 Heartbeat commit=2@1 read_seq=3
</a><a href="#h49-2-6" id="h49-2-6" class="d">-n1@1 → n5 Heartbeat commit=2@1 read_seq=3
</a><a href="#h49-2-7" id="h49-2-7" class="i">+n1@1 → n2 Heartbeat last_index=2 commit=2@1 read_seq=3
</a><a href="#h49-2-8" id="h49-2-8" class="i">+n1@1 → n3 Heartbeat last_index=2 commit=2@1 read_seq=3
</a><a href="#h49-2-9" id="h49-2-9" class="i">+n1@1 → n4 Heartbeat last_index=2 commit=2@1 read_seq=3
</a><a href="#h49-2-10" id="h49-2-10" class="i">+n1@1 → n5 Heartbeat last_index=2 commit=2@1 read_seq=3
</a> 
 deliver
 ---
<a href="#h49-2-14" id="h49-2-14" class="d">-n2@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h49-2-15" id="h49-2-15" class="d">-n3@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h49-2-16" id="h49-2-16" class="d">-n4@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h49-2-17" id="h49-2-17" class="d">-n5@1 → n1 HeartbeatResponse last=2@1 read_seq=3
</a><a href="#h49-2-18" id="h49-2-18" class="i">+n2@1 → n1 HeartbeatResponse match_index=2 read_seq=3
</a><a href="#h49-2-19" id="h49-2-19" class="i">+n3@1 → n1 HeartbeatResponse match_index=2 read_seq=3
</a><a href="#h49-2-20" id="h49-2-20" class="i">+n4@1 → n1 HeartbeatResponse match_index=2 read_seq=3
</a><a href="#h49-2-21" id="h49-2-21" class="i">+n5@1 → n1 HeartbeatResponse match_index=2 read_seq=3
</a> 
 # Once n1 receives two heartbeat responses it has a read quorum and
 # serves both the read at seqnums 2 (id=0x03) and 3 (id=0x04).
<b>diff --git a/<a id="h50" href="../file/src/raft/testscripts/node/request_status.html">src/raft/testscripts/node/request_status</a> b/<a href="../file/src/raft/testscripts/node/request_status.html">src/raft/testscripts/node/request_status</a></b>
<a href="#h50-0" id="h50-0" class="h">@@ -16,7 +16,7 @@ n3 ⇹ n1 n2
</a> (stabilize)
 status
 ---
<a href="#h50-0-3" id="h50-0-3" class="d">-n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:1→2}
</a><a href="#h50-0-4" id="h50-0-4" class="i">+n1@1 leader last=2@1 commit=2@1 apply=2 progress={2:2→3 3:1→3}
</a> n2@1 follower(n1) last=2@1 commit=1@1 apply=1
 n3@1 follower(n1) last=1@1 commit=1@1 apply=1
 
<b>diff --git a/<a id="h51" href="../file/src/raft/testscripts/node/tick_follower.html">src/raft/testscripts/node/tick_follower</a> b/<a href="../file/src/raft/testscripts/node/tick_follower.html">src/raft/testscripts/node/tick_follower</a></b>
<a href="#h51-0" id="h51-0" class="h">@@ -16,10 +16,10 @@ ok
</a> heartbeat 1
 stabilize
 ---
<a href="#h51-0-3" id="h51-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h51-0-4" id="h51-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h51-0-5" id="h51-0-5" class="d">-n2@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h51-0-6" id="h51-0-6" class="d">-n3@1 → n1 HeartbeatResponse last=1@1 read_seq=0
</a><a href="#h51-0-7" id="h51-0-7" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h51-0-8" id="h51-0-8" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h51-0-9" id="h51-0-9" class="i">+n2@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a><a href="#h51-0-10" id="h51-0-10" class="i">+n3@1 → n1 HeartbeatResponse match_index=1 read_seq=0
</a> 
 tick 2
 ---
<b>diff --git a/<a id="h52" href="../file/src/raft/testscripts/node/tick_leader.html">src/raft/testscripts/node/tick_leader</a> b/<a href="../file/src/raft/testscripts/node/tick_leader.html">src/raft/testscripts/node/tick_leader</a></b>
<a href="#h52-0" id="h52-0" class="h">@@ -10,8 +10,8 @@ n3@1 follower(n1) last=1@1 commit=1@1 apply=1
</a> # Ticking n1 will emit a heartbeat.
 tick 1
 ---
<a href="#h52-0-3" id="h52-0-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-0-4" id="h52-0-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-0-5" id="h52-0-5" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-0-6" id="h52-0-6" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a> 
 # Ticking n1 again will emit further heartbeats, even when it hasn&#39;t heard from
 # any followers.
<a href="#h52-1" id="h52-1" class="h">@@ -19,9 +19,9 @@ tick 1
</a> tick 1
 tick 1
 ---
<a href="#h52-1-3" id="h52-1-3" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-4" id="h52-1-4" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-5" id="h52-1-5" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-6" id="h52-1-6" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-7" id="h52-1-7" class="d">-n1@1 → n2 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-8" id="h52-1-8" class="d">-n1@1 → n3 Heartbeat commit=1@1 read_seq=0
</a><a href="#h52-1-9" id="h52-1-9" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-1-10" id="h52-1-10" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-1-11" id="h52-1-11" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-1-12" id="h52-1-12" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-1-13" id="h52-1-13" class="i">+n1@1 → n2 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><a href="#h52-1-14" id="h52-1-14" class="i">+n1@1 → n3 Heartbeat last_index=1 commit=1@1 read_seq=0
</a><b>diff --git a/<a id="h53" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h53-0" id="h53-0" class="h">@@ -59,6 +59,7 @@ impl Server {
</a>                 node_tx,
                 raft::HEARTBEAT_INTERVAL,
                 raft::ELECTION_TIMEOUT_RANGE,
<a href="#h53-0-3" id="h53-0-3" class="i">+                raft::MAX_APPEND_ENTRIES,
</a>             )?,
             peers,
             node_rx,
</pre>
</div>
</body>
</html>
