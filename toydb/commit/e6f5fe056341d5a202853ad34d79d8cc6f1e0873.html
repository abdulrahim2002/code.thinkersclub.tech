<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>storage: use goldenscript for `Engine` tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/e6f5fe056341d5a202853ad34d79d8cc6f1e0873.html">e6f5fe056341d5a202853ad34d79d8cc6f1e0873</a>
<b>parent</b> <a href="../commit/6a5e30e00af35fdac6169e3f2e35aea18b212ca7.html">6a5e30e00af35fdac6169e3f2e35aea18b212ca7</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 11 Jun 2024 13:21:01 +0200

storage: use goldenscript for `Engine` tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/log.rs</a></td><td> | </td><td class="num">15</td><td><span class="i">++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/storage/bitcask.rs</a></td><td> | </td><td class="num">368</td><td><span class="i">+++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/storage/engine.rs</a></td><td> | </td><td class="num">404</td><td><span class="i">++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">src/storage/golden/bitcask/compact-after</a></td><td> | </td><td class="num">30</td><td><span class="i"></span><span class="d">------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">src/storage/golden/bitcask/compact-before</a></td><td> | </td><td class="num">72</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">src/storage/golden/bitcask/log</a></td><td> | </td><td class="num">72</td><td><span class="i"></span><span class="d">------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/storage/memory.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/storage/testscripts/bitcask/compact</a></td><td> | </td><td class="num">137</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/storage/testscripts/bitcask/compact_open</a></td><td> | </td><td class="num">83</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">src/storage/testscripts/bitcask/log</a></td><td> | </td><td class="num">118</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/storage/testscripts/bitcask/status</a></td><td> | </td><td class="num">40</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">src/storage/testscripts/engine/keys</a></td><td> | </td><td class="num">61</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">src/storage/testscripts/engine/point</a></td><td> | </td><td class="num">53</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">src/storage/testscripts/engine/scan</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">src/storage/testscripts/engine/scan_prefix</a></td><td> | </td><td class="num">111</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">src/storage/testscripts/memory/status</a></td><td> | </td><td class="num">22</td><td><span class="i">++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>18 files changed, 1004 insertions(+), 660 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -614,9 +614,9 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;goldenscript&quot;
<a href="#h0-0-3" id="h0-0-3" class="d">-version = &quot;0.5.0&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+version = &quot;0.6.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-0-6" id="h0-0-6" class="d">-checksum = &quot;55ca7296b5d8221d19ba6c21483871e2c89fd198d4dd275d63cb36329c5219da&quot;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+checksum = &quot;cfece0a141db386f13437cae6b9707c2069fc39b08485cdf92ba9f4f1e55923a&quot;
</a> dependencies = [
  &quot;goldenfile&quot;,
  &quot;nom&quot;,
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -34,7 +34,7 @@ uuid = { version = &quot;1.8.0&quot;, features = [&quot;serde&quot;, &quot;v4&quot;] }
</a> [dev-dependencies]
 escargot = &quot;0.5.10&quot;
 goldenfile = &quot;1.7.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-goldenscript = &quot;0.5.0&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+goldenscript = &quot;0.6.0&quot;
</a> paste = &quot;1.0.14&quot;
 pretty_assertions = &quot;1.4.0&quot;
 serde_json = &quot;1.0.117&quot;
<b>diff --git a/<a id="h2" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -342,6 +342,7 @@ impl&lt;&#39;a&gt; std::iter::Iterator for Iterator&lt;&#39;a&gt; {
</a> mod tests {
     use super::*;
     use crossbeam::channel::Receiver;
<a href="#h2-0-3" id="h2-0-3" class="i">+    use regex::Regex;
</a>     use std::{error::Error, result::Result};
     use storage::engine::test as testengine;
     use test_each_file::test_each_path;
<a href="#h2-1" id="h2-1" class="h">@@ -581,7 +582,7 @@ mod tests {
</a> 
         /// Parses an index@term pair.
         fn parse_index_term(s: &amp;str) -&gt; Result&lt;(Index, Term), Box&lt;dyn Error&gt;&gt; {
<a href="#h2-1-3" id="h2-1-3" class="d">-            let re = regex::Regex::new(r&quot;^(\d+)@(\d+)$&quot;).expect(&quot;invalid regex&quot;);
</a><a href="#h2-1-4" id="h2-1-4" class="i">+            let re = Regex::new(r&quot;^(\d+)@(\d+)$&quot;).expect(&quot;invalid regex&quot;);
</a>             let groups = re.captures(s).ok_or_else(|| format!(&quot;invalid index/term {s}&quot;))?;
             let index = groups.get(1).unwrap().as_str().parse()?;
             let term = groups.get(2).unwrap().as_str().parse()?;
<a href="#h2-2" id="h2-2" class="h">@@ -590,19 +591,19 @@ mod tests {
</a> 
         /// Parses an index range, in Rust range syntax.
         fn parse_index_range(s: &amp;str) -&gt; Result&lt;impl std::ops::RangeBounds&lt;Index&gt;, Box&lt;dyn Error&gt;&gt; {
<a href="#h2-2-3" id="h2-2-3" class="d">-            let mut bound =
</a><a href="#h2-2-4" id="h2-2-4" class="d">-                (std::ops::Bound::&lt;Index&gt;::Unbounded, std::ops::Bound::&lt;Index&gt;::Unbounded);
</a><a href="#h2-2-5" id="h2-2-5" class="d">-            let re = regex::Regex::new(r&quot;^(\d+)?\.\.(=)?(\d+)?&quot;).expect(&quot;invalid regex&quot;);
</a><a href="#h2-2-6" id="h2-2-6" class="i">+            use std::ops::Bound;
</a><a href="#h2-2-7" id="h2-2-7" class="i">+            let mut bound = (Bound::&lt;Index&gt;::Unbounded, Bound::&lt;Index&gt;::Unbounded);
</a><a href="#h2-2-8" id="h2-2-8" class="i">+            let re = Regex::new(r&quot;^(\d+)?\.\.(=)?(\d+)?&quot;).expect(&quot;invalid regex&quot;);
</a>             let groups = re.captures(s).ok_or_else(|| format!(&quot;invalid range {s}&quot;))?;
             if let Some(start) = groups.get(1) {
<a href="#h2-2-11" id="h2-2-11" class="d">-                bound.0 = std::ops::Bound::Included(start.as_str().parse()?);
</a><a href="#h2-2-12" id="h2-2-12" class="i">+                bound.0 = Bound::Included(start.as_str().parse()?);
</a>             }
             if let Some(end) = groups.get(3) {
                 let end = end.as_str().parse()?;
                 if groups.get(2).is_some() {
<a href="#h2-2-17" id="h2-2-17" class="d">-                    bound.1 = std::ops::Bound::Included(end)
</a><a href="#h2-2-18" id="h2-2-18" class="i">+                    bound.1 = Bound::Included(end)
</a>                 } else {
<a href="#h2-2-20" id="h2-2-20" class="d">-                    bound.1 = std::ops::Bound::Excluded(end)
</a><a href="#h2-2-21" id="h2-2-21" class="i">+                    bound.1 = Bound::Excluded(end)
</a>                 }
             }
             Ok(bound)
<b>diff --git a/<a id="h3" href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a> b/<a href="../file/src/storage/bitcask.rs.html">src/storage/bitcask.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -63,6 +63,8 @@ impl BitCask {
</a> 
     /// Opens a BitCask database, and automatically compacts it if the amount
     /// of garbage exceeds the given ratio and byte size when opened.
<a href="#h3-0-3" id="h3-0-3" class="i">+    ///
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    /// TODO rename garbage_min_ratio to fraction throughout.
</a>     pub fn new_compact(
         path: PathBuf,
         garbage_min_ratio: f64,
<a href="#h3-1" id="h3-1" class="h">@@ -71,15 +73,16 @@ impl BitCask {
</a>         let mut s = Self::new(path)?;
 
         let status = s.status()?;
<a href="#h3-1-3" id="h3-1-3" class="d">-        let garbage_ratio = status.garbage_disk_size as f64 / status.total_disk_size as f64;
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        if status.garbage_disk_size &gt; 0
</a><a href="#h3-1-5" id="h3-1-5" class="d">-            &amp;&amp; status.garbage_disk_size &gt;= garbage_min_bytes
</a><a href="#h3-1-6" id="h3-1-6" class="d">-            &amp;&amp; garbage_ratio &gt;= garbage_min_ratio
</a><a href="#h3-1-7" id="h3-1-7" class="d">-        {
</a><a href="#h3-1-8" id="h3-1-8" class="i">+        if Self::should_compact(
</a><a href="#h3-1-9" id="h3-1-9" class="i">+            status.garbage_disk_size,
</a><a href="#h3-1-10" id="h3-1-10" class="i">+            status.total_disk_size,
</a><a href="#h3-1-11" id="h3-1-11" class="i">+            garbage_min_ratio,
</a><a href="#h3-1-12" id="h3-1-12" class="i">+            garbage_min_bytes,
</a><a href="#h3-1-13" id="h3-1-13" class="i">+        ) {
</a>             log::info!(
                 &quot;Compacting {} to remove {:.0}% garbage ({} MB out of {} MB)&quot;,
                 s.log.path.display(),
<a href="#h3-1-17" id="h3-1-17" class="d">-                garbage_ratio * 100.0,
</a><a href="#h3-1-18" id="h3-1-18" class="i">+                status.garbage_disk_size as f64 / status.total_disk_size as f64 * 100.0,
</a>                 status.garbage_disk_size / 1024 / 1024,
                 status.total_disk_size / 1024 / 1024
             );
<a href="#h3-2" id="h3-2" class="h">@@ -93,6 +96,12 @@ impl BitCask {
</a> 
         Ok(s)
     }
<a href="#h3-2-3" id="h3-2-3" class="i">+
</a><a href="#h3-2-4" id="h3-2-4" class="i">+    /// Returns true if the log file should be compacted.
</a><a href="#h3-2-5" id="h3-2-5" class="i">+    fn should_compact(garbage_size: u64, total_size: u64, min_ratio: f64, min_bytes: u64) -&gt; bool {
</a><a href="#h3-2-6" id="h3-2-6" class="i">+        let garbage_ratio = garbage_size as f64 / total_size as f64;
</a><a href="#h3-2-7" id="h3-2-7" class="i">+        garbage_size &gt; 0 &amp;&amp; garbage_size &gt;= min_bytes &amp;&amp; garbage_ratio &gt;= min_ratio
</a><a href="#h3-2-8" id="h3-2-8" class="i">+    }
</a> }
 
 impl Engine for BitCask {
<a href="#h3-3" id="h3-3" class="h">@@ -343,216 +352,160 @@ impl Log {
</a> 
         Ok((pos, len))
     }
<a href="#h3-3-3" id="h3-3-3" class="d">-
</a><a href="#h3-3-4" id="h3-3-4" class="d">-    #[cfg(test)]
</a><a href="#h3-3-5" id="h3-3-5" class="d">-    /// Prints the entire log file to the given writer in human-readable form.
</a><a href="#h3-3-6" id="h3-3-6" class="d">-    fn print&lt;W: Write&gt;(&amp;mut self, w: &amp;mut W) -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-7" id="h3-3-7" class="d">-        let mut len_buf = [0u8; 4];
</a><a href="#h3-3-8" id="h3-3-8" class="d">-        let file_len = self.file.metadata()?.len();
</a><a href="#h3-3-9" id="h3-3-9" class="d">-        let mut r = BufReader::new(&amp;mut self.file);
</a><a href="#h3-3-10" id="h3-3-10" class="d">-        let mut pos = r.seek(SeekFrom::Start(0))?;
</a><a href="#h3-3-11" id="h3-3-11" class="d">-        let mut idx = 0;
</a><a href="#h3-3-12" id="h3-3-12" class="d">-
</a><a href="#h3-3-13" id="h3-3-13" class="d">-        while pos &lt; file_len {
</a><a href="#h3-3-14" id="h3-3-14" class="d">-            writeln!(w, &quot;entry = {}, offset {}&quot;, idx, pos)?;
</a><a href="#h3-3-15" id="h3-3-15" class="d">-
</a><a href="#h3-3-16" id="h3-3-16" class="d">-            r.read_exact(&amp;mut len_buf)?;
</a><a href="#h3-3-17" id="h3-3-17" class="d">-            let key_len = u32::from_be_bytes(len_buf);
</a><a href="#h3-3-18" id="h3-3-18" class="d">-            writeln!(w, &quot;klen  = {} {:x?}&quot;, key_len, len_buf)?;
</a><a href="#h3-3-19" id="h3-3-19" class="d">-
</a><a href="#h3-3-20" id="h3-3-20" class="d">-            r.read_exact(&amp;mut len_buf)?;
</a><a href="#h3-3-21" id="h3-3-21" class="d">-            let value_len_or_tombstone = i32::from_be_bytes(len_buf); // NB: -1 for tombstones
</a><a href="#h3-3-22" id="h3-3-22" class="d">-            let value_len = value_len_or_tombstone.max(0) as u32;
</a><a href="#h3-3-23" id="h3-3-23" class="d">-            writeln!(w, &quot;vlen  = {} {:x?}&quot;, value_len_or_tombstone, len_buf)?;
</a><a href="#h3-3-24" id="h3-3-24" class="d">-
</a><a href="#h3-3-25" id="h3-3-25" class="d">-            let mut key = vec![0; key_len as usize];
</a><a href="#h3-3-26" id="h3-3-26" class="d">-            r.read_exact(&amp;mut key)?;
</a><a href="#h3-3-27" id="h3-3-27" class="d">-            write!(w, &quot;key   = &quot;)?;
</a><a href="#h3-3-28" id="h3-3-28" class="d">-            if let Ok(str) = std::str::from_utf8(&amp;key) {
</a><a href="#h3-3-29" id="h3-3-29" class="d">-                write!(w, r#&quot;&quot;{}&quot; &quot;#, str)?;
</a><a href="#h3-3-30" id="h3-3-30" class="d">-            }
</a><a href="#h3-3-31" id="h3-3-31" class="d">-            writeln!(w, &quot;{:x?}&quot;, key)?;
</a><a href="#h3-3-32" id="h3-3-32" class="d">-
</a><a href="#h3-3-33" id="h3-3-33" class="d">-            let mut value = vec![0; value_len as usize];
</a><a href="#h3-3-34" id="h3-3-34" class="d">-            r.read_exact(&amp;mut value)?;
</a><a href="#h3-3-35" id="h3-3-35" class="d">-            write!(w, &quot;value = &quot;)?;
</a><a href="#h3-3-36" id="h3-3-36" class="d">-            if value_len_or_tombstone &lt; 0 {
</a><a href="#h3-3-37" id="h3-3-37" class="d">-                write!(w, &quot;tombstone &quot;)?;
</a><a href="#h3-3-38" id="h3-3-38" class="d">-            } else if let Ok(str) = std::str::from_utf8(&amp;value) {
</a><a href="#h3-3-39" id="h3-3-39" class="d">-                if str.chars().all(|c| !c.is_control()) {
</a><a href="#h3-3-40" id="h3-3-40" class="d">-                    write!(w, r#&quot;&quot;{}&quot; &quot;#, str)?;
</a><a href="#h3-3-41" id="h3-3-41" class="d">-                }
</a><a href="#h3-3-42" id="h3-3-42" class="d">-            }
</a><a href="#h3-3-43" id="h3-3-43" class="d">-            write!(w, &quot;{:x?}\n\n&quot;, value)?;
</a><a href="#h3-3-44" id="h3-3-44" class="d">-
</a><a href="#h3-3-45" id="h3-3-45" class="d">-            pos += 4 + 4 + key_len as u64 + value_len as u64;
</a><a href="#h3-3-46" id="h3-3-46" class="d">-            idx += 1;
</a><a href="#h3-3-47" id="h3-3-47" class="d">-        }
</a><a href="#h3-3-48" id="h3-3-48" class="d">-        Ok(())
</a><a href="#h3-3-49" id="h3-3-49" class="d">-    }
</a> }
 
 #[cfg(test)]
 mod tests {
<a href="#h3-3-54" id="h3-3-54" class="i">+    use super::super::engine::test::Runner;
</a>     use super::*;
<a href="#h3-3-56" id="h3-3-56" class="i">+    use std::error::Error as StdError;
</a><a href="#h3-3-57" id="h3-3-57" class="i">+    use std::fmt::Write as _;
</a><a href="#h3-3-58" id="h3-3-58" class="i">+    use std::result::Result as StdResult;
</a><a href="#h3-3-59" id="h3-3-59" class="i">+    use test_case::test_case;
</a><a href="#h3-3-60" id="h3-3-60" class="i">+    use test_each_file::test_each_path;
</a> 
<a href="#h3-3-62" id="h3-3-62" class="d">-    const GOLDEN_DIR: &amp;str = &quot;src/storage/golden/bitcask&quot;;
</a><a href="#h3-3-63" id="h3-3-63" class="i">+    // Run common goldenscript tests in src/storage/testscripts/engine.
</a><a href="#h3-3-64" id="h3-3-64" class="i">+    test_each_path! { in &quot;src/storage/testscripts/engine&quot; as engine =&gt; test_goldenscript }
</a><a href="#h3-3-65" id="h3-3-65" class="i">+
</a><a href="#h3-3-66" id="h3-3-66" class="i">+    // Also run BitCask-specific tests in src/storage/testscripts/bitcask.
</a><a href="#h3-3-67" id="h3-3-67" class="i">+    test_each_path! { in &quot;src/storage/testscripts/bitcask&quot; as scripts =&gt; test_goldenscript }
</a><a href="#h3-3-68" id="h3-3-68" class="i">+
</a><a href="#h3-3-69" id="h3-3-69" class="i">+    fn test_goldenscript(path: &amp;std::path::Path) {
</a><a href="#h3-3-70" id="h3-3-70" class="i">+        goldenscript::run(&amp;mut BitCaskRunner::new(), path).expect(&quot;goldenscript failed&quot;)
</a><a href="#h3-3-71" id="h3-3-71" class="i">+    }
</a> 
     super::super::engine::tests::test_engine!({
         let path = tempdir::TempDir::new(&quot;toydb&quot;)?.path().join(&quot;toydb&quot;);
         BitCask::new(path)?
     });
 
<a href="#h3-3-78" id="h3-3-78" class="d">-    /// Creates a new BitCask engine for testing.
</a><a href="#h3-3-79" id="h3-3-79" class="d">-    fn setup() -&gt; Result&lt;BitCask&gt; {
</a><a href="#h3-3-80" id="h3-3-80" class="d">-        BitCask::new(tempdir::TempDir::new(&quot;toydb&quot;)?.path().join(&quot;toydb&quot;))
</a><a href="#h3-3-81" id="h3-3-81" class="i">+    /// Tests that should_compact() handles parameters correctly.
</a><a href="#h3-3-82" id="h3-3-82" class="i">+    #[test_case(100, 100, -01.0, 0 =&gt; true; &quot;ratio negative all garbage&quot;)]
</a><a href="#h3-3-83" id="h3-3-83" class="i">+    #[test_case(100, 100, 0.0, 0 =&gt; true; &quot;ratio 0 all garbage&quot;)]
</a><a href="#h3-3-84" id="h3-3-84" class="i">+    #[test_case(100, 100, 1.0, 0 =&gt; true; &quot;ratio 1 all garbage&quot;)]
</a><a href="#h3-3-85" id="h3-3-85" class="i">+    #[test_case(100, 100, 2.0, 0 =&gt; false; &quot;ratio 2 all garbage&quot;)]
</a><a href="#h3-3-86" id="h3-3-86" class="i">+    #[test_case(0, 100, 0.0, 0 =&gt; false; &quot;ratio 0 no garbage&quot;)]
</a><a href="#h3-3-87" id="h3-3-87" class="i">+    #[test_case(1, 100, 0.0, 0 =&gt; true; &quot;ratio 0 tiny garbage&quot;)]
</a><a href="#h3-3-88" id="h3-3-88" class="i">+    #[test_case(49, 100, 0.5, 0 =&gt; false; &quot;below ratio&quot;)]
</a><a href="#h3-3-89" id="h3-3-89" class="i">+    #[test_case(50, 100, 0.5, 0 =&gt; true; &quot;at ratio&quot;)]
</a><a href="#h3-3-90" id="h3-3-90" class="i">+    #[test_case(51, 100, 0.5, 0 =&gt; true; &quot;above ratio&quot;)]
</a><a href="#h3-3-91" id="h3-3-91" class="i">+    #[test_case(49, 100, 0.0, 50 =&gt; false; &quot;below min bytes&quot;)]
</a><a href="#h3-3-92" id="h3-3-92" class="i">+    #[test_case(50, 100, 0.0, 50 =&gt; true; &quot;at min bytes&quot;)]
</a><a href="#h3-3-93" id="h3-3-93" class="i">+    #[test_case(51, 100, 0.0, 50 =&gt; true; &quot;above min bytes&quot;)]
</a><a href="#h3-3-94" id="h3-3-94" class="i">+    fn should_compact(garbage_size: u64, total_size: u64, min_ratio: f64, min_bytes: u64) -&gt; bool {
</a><a href="#h3-3-95" id="h3-3-95" class="i">+        BitCask::should_compact(garbage_size, total_size, min_ratio, min_bytes)
</a>     }
 
<a href="#h3-3-98" id="h3-3-98" class="d">-    /// Writes various values primarily for testing log file handling.
</a><a href="#h3-3-99" id="h3-3-99" class="d">-    ///
</a><a href="#h3-3-100" id="h3-3-100" class="d">-    /// - &#39;&#39;: empty key and value
</a><a href="#h3-3-101" id="h3-3-101" class="d">-    /// - a: write
</a><a href="#h3-3-102" id="h3-3-102" class="d">-    /// - b: write, write
</a><a href="#h3-3-103" id="h3-3-103" class="d">-    /// - c: write, delete, write
</a><a href="#h3-3-104" id="h3-3-104" class="d">-    /// - d: delete, write
</a><a href="#h3-3-105" id="h3-3-105" class="d">-    /// - e: write, delete
</a><a href="#h3-3-106" id="h3-3-106" class="d">-    /// - f: delete
</a><a href="#h3-3-107" id="h3-3-107" class="d">-    fn setup_log(s: &amp;mut BitCask) -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-108" id="h3-3-108" class="d">-        s.set(b&quot;b&quot;, vec![0x01])?;
</a><a href="#h3-3-109" id="h3-3-109" class="d">-        s.set(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h3-3-110" id="h3-3-110" class="d">-
</a><a href="#h3-3-111" id="h3-3-111" class="d">-        s.set(b&quot;e&quot;, vec![0x05])?;
</a><a href="#h3-3-112" id="h3-3-112" class="d">-        s.delete(b&quot;e&quot;)?;
</a><a href="#h3-3-113" id="h3-3-113" class="d">-
</a><a href="#h3-3-114" id="h3-3-114" class="d">-        s.set(b&quot;c&quot;, vec![0x00])?;
</a><a href="#h3-3-115" id="h3-3-115" class="d">-        s.delete(b&quot;c&quot;)?;
</a><a href="#h3-3-116" id="h3-3-116" class="d">-        s.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h3-3-117" id="h3-3-117" class="d">-
</a><a href="#h3-3-118" id="h3-3-118" class="d">-        s.set(b&quot;&quot;, vec![])?;
</a><a href="#h3-3-119" id="h3-3-119" class="d">-
</a><a href="#h3-3-120" id="h3-3-120" class="d">-        s.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h3-3-121" id="h3-3-121" class="d">-
</a><a href="#h3-3-122" id="h3-3-122" class="d">-        s.delete(b&quot;f&quot;)?;
</a><a href="#h3-3-123" id="h3-3-123" class="d">-
</a><a href="#h3-3-124" id="h3-3-124" class="d">-        s.delete(b&quot;d&quot;)?;
</a><a href="#h3-3-125" id="h3-3-125" class="d">-        s.set(b&quot;d&quot;, vec![0x04])?;
</a><a href="#h3-3-126" id="h3-3-126" class="d">-
</a><a href="#h3-3-127" id="h3-3-127" class="d">-        // Make sure the scan yields the expected results.
</a><a href="#h3-3-128" id="h3-3-128" class="d">-        assert_eq!(
</a><a href="#h3-3-129" id="h3-3-129" class="d">-            vec![
</a><a href="#h3-3-130" id="h3-3-130" class="d">-                (b&quot;&quot;.to_vec(), vec![]),
</a><a href="#h3-3-131" id="h3-3-131" class="d">-                (b&quot;a&quot;.to_vec(), vec![0x01]),
</a><a href="#h3-3-132" id="h3-3-132" class="d">-                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h3-3-133" id="h3-3-133" class="d">-                (b&quot;c&quot;.to_vec(), vec![0x03]),
</a><a href="#h3-3-134" id="h3-3-134" class="d">-                (b&quot;d&quot;.to_vec(), vec![0x04]),
</a><a href="#h3-3-135" id="h3-3-135" class="d">-            ],
</a><a href="#h3-3-136" id="h3-3-136" class="d">-            s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,
</a><a href="#h3-3-137" id="h3-3-137" class="d">-        );
</a><a href="#h3-3-138" id="h3-3-138" class="d">-
</a><a href="#h3-3-139" id="h3-3-139" class="d">-        Ok(())
</a><a href="#h3-3-140" id="h3-3-140" class="i">+    /// A BitCask-specific goldenscript runner, which dispatches through to the
</a><a href="#h3-3-141" id="h3-3-141" class="i">+    /// standard Engine runner.
</a><a href="#h3-3-142" id="h3-3-142" class="i">+    struct BitCaskRunner {
</a><a href="#h3-3-143" id="h3-3-143" class="i">+        inner: Runner&lt;BitCask&gt;,
</a><a href="#h3-3-144" id="h3-3-144" class="i">+        tempdir: tempdir::TempDir,
</a>     }
 
<a href="#h3-3-147" id="h3-3-147" class="d">-    #[test]
</a><a href="#h3-3-148" id="h3-3-148" class="d">-    /// Tests that logs are written correctly using a golden file.
</a><a href="#h3-3-149" id="h3-3-149" class="d">-    fn log() -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-150" id="h3-3-150" class="d">-        let mut s = setup()?;
</a><a href="#h3-3-151" id="h3-3-151" class="d">-        setup_log(&amp;mut s)?;
</a><a href="#h3-3-152" id="h3-3-152" class="d">-
</a><a href="#h3-3-153" id="h3-3-153" class="d">-        let mut mint = goldenfile::Mint::new(GOLDEN_DIR);
</a><a href="#h3-3-154" id="h3-3-154" class="d">-        s.log.print(&amp;mut mint.new_goldenfile(&quot;log&quot;)?)?;
</a><a href="#h3-3-155" id="h3-3-155" class="d">-        Ok(())
</a><a href="#h3-3-156" id="h3-3-156" class="d">-    }
</a><a href="#h3-3-157" id="h3-3-157" class="i">+    impl goldenscript::Runner for BitCaskRunner {
</a><a href="#h3-3-158" id="h3-3-158" class="i">+        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h3-3-159" id="h3-3-159" class="i">+            let mut output = String::new();
</a><a href="#h3-3-160" id="h3-3-160" class="i">+            match command.name.as_str() {
</a><a href="#h3-3-161" id="h3-3-161" class="i">+                // compact
</a><a href="#h3-3-162" id="h3-3-162" class="i">+                // Compacts the BitCask entry log.
</a><a href="#h3-3-163" id="h3-3-163" class="i">+                &quot;compact&quot; =&gt; {
</a><a href="#h3-3-164" id="h3-3-164" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h3-3-165" id="h3-3-165" class="i">+                    self.inner.engine.compact()?;
</a><a href="#h3-3-166" id="h3-3-166" class="i">+                }
</a> 
<a href="#h3-3-168" id="h3-3-168" class="d">-    #[test]
</a><a href="#h3-3-169" id="h3-3-169" class="d">-    /// Tests that writing and then reading a file yields the same results.
</a><a href="#h3-3-170" id="h3-3-170" class="d">-    fn reopen() -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-171" id="h3-3-171" class="d">-        // NB: Don&#39;t use setup(), because the tempdir will be removed when
</a><a href="#h3-3-172" id="h3-3-172" class="d">-        // the path falls out of scope.
</a><a href="#h3-3-173" id="h3-3-173" class="d">-        let path = tempdir::TempDir::new(&quot;toydb&quot;)?.path().join(&quot;toydb&quot;);
</a><a href="#h3-3-174" id="h3-3-174" class="d">-        let mut s = BitCask::new(path.clone())?;
</a><a href="#h3-3-175" id="h3-3-175" class="d">-        setup_log(&amp;mut s)?;
</a><a href="#h3-3-176" id="h3-3-176" class="i">+                // dump
</a><a href="#h3-3-177" id="h3-3-177" class="i">+                // Dumps the full BitCask entry log.
</a><a href="#h3-3-178" id="h3-3-178" class="i">+                &quot;dump&quot; =&gt; {
</a><a href="#h3-3-179" id="h3-3-179" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h3-3-180" id="h3-3-180" class="i">+                    self.dump(&amp;mut output)?;
</a><a href="#h3-3-181" id="h3-3-181" class="i">+                }
</a> 
<a href="#h3-3-183" id="h3-3-183" class="d">-        let expect = s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h3-3-184" id="h3-3-184" class="d">-        drop(s);
</a><a href="#h3-3-185" id="h3-3-185" class="d">-        let mut s = BitCask::new(path)?;
</a><a href="#h3-3-186" id="h3-3-186" class="d">-        assert_eq!(expect, s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,);
</a><a href="#h3-3-187" id="h3-3-187" class="i">+                // reopen [compact_fraction=FLOAT]
</a><a href="#h3-3-188" id="h3-3-188" class="i">+                // Closes and reopens the BitCask database. If compact_ratio is
</a><a href="#h3-3-189" id="h3-3-189" class="i">+                // given, it specifies a garbage ratio beyond which the log
</a><a href="#h3-3-190" id="h3-3-190" class="i">+                // should be auto-compacted on open.
</a><a href="#h3-3-191" id="h3-3-191" class="i">+                &quot;reopen&quot; =&gt; {
</a><a href="#h3-3-192" id="h3-3-192" class="i">+                    let mut args = command.consume_args();
</a><a href="#h3-3-193" id="h3-3-193" class="i">+                    let compact_fraction = args.lookup_parse(&quot;compact_fraction&quot;)?;
</a><a href="#h3-3-194" id="h3-3-194" class="i">+                    args.reject_rest()?;
</a><a href="#h3-3-195" id="h3-3-195" class="i">+                    // We need to close the file before we can reopen it, which
</a><a href="#h3-3-196" id="h3-3-196" class="i">+                    // happens when the database is dropped. Replace the engine
</a><a href="#h3-3-197" id="h3-3-197" class="i">+                    // with a temporary empty engine then reopen the file.
</a><a href="#h3-3-198" id="h3-3-198" class="i">+                    let path = self.inner.engine.log.path.clone();
</a><a href="#h3-3-199" id="h3-3-199" class="i">+                    self.inner.engine = BitCask::new(self.tempdir.path().join(&quot;empty&quot;))?;
</a><a href="#h3-3-200" id="h3-3-200" class="i">+                    if let Some(garbage_ratio) = compact_fraction {
</a><a href="#h3-3-201" id="h3-3-201" class="i">+                        self.inner.engine = BitCask::new_compact(path, garbage_ratio, 0)?;
</a><a href="#h3-3-202" id="h3-3-202" class="i">+                    } else {
</a><a href="#h3-3-203" id="h3-3-203" class="i">+                        self.inner.engine = BitCask::new(path)?;
</a><a href="#h3-3-204" id="h3-3-204" class="i">+                    }
</a><a href="#h3-3-205" id="h3-3-205" class="i">+                }
</a> 
<a href="#h3-3-207" id="h3-3-207" class="d">-        Ok(())
</a><a href="#h3-3-208" id="h3-3-208" class="i">+                // Pass other commands to the standard engine runner.
</a><a href="#h3-3-209" id="h3-3-209" class="i">+                _ =&gt; return self.inner.run(command),
</a><a href="#h3-3-210" id="h3-3-210" class="i">+            }
</a><a href="#h3-3-211" id="h3-3-211" class="i">+            Ok(output)
</a><a href="#h3-3-212" id="h3-3-212" class="i">+        }
</a>     }
 
<a href="#h3-3-215" id="h3-3-215" class="d">-    #[test]
</a><a href="#h3-3-216" id="h3-3-216" class="d">-    /// Tests log compaction, by writing golden files of the before/after state,
</a><a href="#h3-3-217" id="h3-3-217" class="d">-    /// and checking that the database contains the same results, even after
</a><a href="#h3-3-218" id="h3-3-218" class="d">-    /// reopening the file.
</a><a href="#h3-3-219" id="h3-3-219" class="d">-    fn compact() -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-220" id="h3-3-220" class="d">-        // NB: Don&#39;t use setup(), because the tempdir will be removed when
</a><a href="#h3-3-221" id="h3-3-221" class="d">-        // the path falls out of scope.
</a><a href="#h3-3-222" id="h3-3-222" class="d">-        let path = tempdir::TempDir::new(&quot;toydb&quot;)?.path().join(&quot;toydb&quot;);
</a><a href="#h3-3-223" id="h3-3-223" class="d">-        let mut s = BitCask::new(path.clone())?;
</a><a href="#h3-3-224" id="h3-3-224" class="d">-        setup_log(&amp;mut s)?;
</a><a href="#h3-3-225" id="h3-3-225" class="d">-
</a><a href="#h3-3-226" id="h3-3-226" class="d">-        // Dump the initial log file.
</a><a href="#h3-3-227" id="h3-3-227" class="d">-        let mut mint = goldenfile::Mint::new(GOLDEN_DIR);
</a><a href="#h3-3-228" id="h3-3-228" class="d">-        s.log.print(&amp;mut mint.new_goldenfile(&quot;compact-before&quot;)?)?;
</a><a href="#h3-3-229" id="h3-3-229" class="d">-        let expect = s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h3-3-230" id="h3-3-230" class="d">-
</a><a href="#h3-3-231" id="h3-3-231" class="d">-        // Compact the log file and assert the new log file contents.
</a><a href="#h3-3-232" id="h3-3-232" class="d">-        s.compact()?;
</a><a href="#h3-3-233" id="h3-3-233" class="d">-        assert_eq!(path, s.log.path);
</a><a href="#h3-3-234" id="h3-3-234" class="d">-        assert_eq!(expect, s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,);
</a><a href="#h3-3-235" id="h3-3-235" class="d">-        s.log.print(&amp;mut mint.new_goldenfile(&quot;compact-after&quot;)?)?;
</a><a href="#h3-3-236" id="h3-3-236" class="d">-
</a><a href="#h3-3-237" id="h3-3-237" class="d">-        // Reopen the log file and assert that the contents are the same.
</a><a href="#h3-3-238" id="h3-3-238" class="d">-        drop(s);
</a><a href="#h3-3-239" id="h3-3-239" class="d">-        let mut s = BitCask::new(path)?;
</a><a href="#h3-3-240" id="h3-3-240" class="d">-        assert_eq!(expect, s.scan(..).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,);
</a><a href="#h3-3-241" id="h3-3-241" class="i">+    impl BitCaskRunner {
</a><a href="#h3-3-242" id="h3-3-242" class="i">+        fn new() -&gt; Self {
</a><a href="#h3-3-243" id="h3-3-243" class="i">+            let tempdir = tempdir::TempDir::new(&quot;toydb&quot;).expect(&quot;tempdir failed&quot;);
</a><a href="#h3-3-244" id="h3-3-244" class="i">+            let engine = BitCask::new(tempdir.path().join(&quot;bitcask&quot;)).expect(&quot;bitcask failed&quot;);
</a><a href="#h3-3-245" id="h3-3-245" class="i">+            let inner = Runner::new(engine);
</a><a href="#h3-3-246" id="h3-3-246" class="i">+            Self { inner, tempdir }
</a><a href="#h3-3-247" id="h3-3-247" class="i">+        }
</a> 
<a href="#h3-3-249" id="h3-3-249" class="d">-        Ok(())
</a><a href="#h3-3-250" id="h3-3-250" class="d">-    }
</a><a href="#h3-3-251" id="h3-3-251" class="i">+        /// Dumps the full BitCask entry log.
</a><a href="#h3-3-252" id="h3-3-252" class="i">+        fn dump(&amp;mut self, output: &amp;mut String) -&gt; StdResult&lt;(), Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h3-3-253" id="h3-3-253" class="i">+            let file = &amp;mut self.inner.engine.log.file;
</a><a href="#h3-3-254" id="h3-3-254" class="i">+            let file_len = file.metadata()?.len();
</a><a href="#h3-3-255" id="h3-3-255" class="i">+            let mut r = BufReader::new(file);
</a><a href="#h3-3-256" id="h3-3-256" class="i">+            let mut pos = r.seek(SeekFrom::Start(0))?;
</a><a href="#h3-3-257" id="h3-3-257" class="i">+            let mut len_buf = [0; 4];
</a><a href="#h3-3-258" id="h3-3-258" class="i">+            let mut idx = 0;
</a><a href="#h3-3-259" id="h3-3-259" class="i">+
</a><a href="#h3-3-260" id="h3-3-260" class="i">+            while pos &lt; file_len {
</a><a href="#h3-3-261" id="h3-3-261" class="i">+                if idx &gt; 0 {
</a><a href="#h3-3-262" id="h3-3-262" class="i">+                    writeln!(output, &quot;--------&quot;)?;
</a><a href="#h3-3-263" id="h3-3-263" class="i">+                }
</a><a href="#h3-3-264" id="h3-3-264" class="i">+                write!(output, &quot;{:&lt;7}&quot;, format!(&quot;{idx}@{pos}&quot;))?;
</a> 
<a href="#h3-3-266" id="h3-3-266" class="d">-    #[test]
</a><a href="#h3-3-267" id="h3-3-267" class="d">-    /// Tests that new_compact() will automatically compact the file when appropriate.
</a><a href="#h3-3-268" id="h3-3-268" class="d">-    fn new_compact() -&gt; Result&lt;()&gt; {
</a><a href="#h3-3-269" id="h3-3-269" class="d">-        // Create an initial log file with a few entries.
</a><a href="#h3-3-270" id="h3-3-270" class="d">-        let dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h3-3-271" id="h3-3-271" class="d">-        let path = dir.path().join(&quot;orig&quot;);
</a><a href="#h3-3-272" id="h3-3-272" class="d">-        let compactpath = dir.path().join(&quot;compact&quot;);
</a><a href="#h3-3-273" id="h3-3-273" class="i">+                r.read_exact(&amp;mut len_buf)?;
</a><a href="#h3-3-274" id="h3-3-274" class="i">+                let key_len = u32::from_be_bytes(len_buf);
</a><a href="#h3-3-275" id="h3-3-275" class="i">+                write!(output, &quot; keylen={key_len} [{}]&quot;, hex::encode(len_buf))?;
</a> 
<a href="#h3-3-277" id="h3-3-277" class="d">-        let mut s = BitCask::new_compact(path.clone(), 0.2, 0)?;
</a><a href="#h3-3-278" id="h3-3-278" class="d">-        setup_log(&amp;mut s)?;
</a><a href="#h3-3-279" id="h3-3-279" class="d">-        let status = s.status()?;
</a><a href="#h3-3-280" id="h3-3-280" class="d">-        let garbage_ratio = status.garbage_disk_size as f64 / status.total_disk_size as f64;
</a><a href="#h3-3-281" id="h3-3-281" class="d">-        let garbage_size = status.garbage_disk_size;
</a><a href="#h3-3-282" id="h3-3-282" class="d">-        drop(s);
</a><a href="#h3-3-283" id="h3-3-283" class="i">+                r.read_exact(&amp;mut len_buf)?;
</a><a href="#h3-3-284" id="h3-3-284" class="i">+                let value_len_or_tombstone = i32::from_be_bytes(len_buf); // NB: -1 for tombstones
</a><a href="#h3-3-285" id="h3-3-285" class="i">+                let value_len = value_len_or_tombstone.max(0) as u32;
</a><a href="#h3-3-286" id="h3-3-286" class="i">+                writeln!(output, &quot; valuelen={value_len_or_tombstone} [{}]&quot;, hex::encode(len_buf))?;
</a> 
<a href="#h3-3-288" id="h3-3-288" class="d">-        // Test a few ratio/size thresholds and assert whether it should trigger compaction.
</a><a href="#h3-3-289" id="h3-3-289" class="d">-        let cases = vec![
</a><a href="#h3-3-290" id="h3-3-290" class="d">-            (-1.0, 0, true),
</a><a href="#h3-3-291" id="h3-3-291" class="d">-            (0.0, 0, true),
</a><a href="#h3-3-292" id="h3-3-292" class="d">-            (garbage_ratio - 0.001, 0, true),
</a><a href="#h3-3-293" id="h3-3-293" class="d">-            (garbage_ratio, 0, true),
</a><a href="#h3-3-294" id="h3-3-294" class="d">-            (garbage_ratio + 0.001, 0, false),
</a><a href="#h3-3-295" id="h3-3-295" class="d">-            (1.0, 0, false),
</a><a href="#h3-3-296" id="h3-3-296" class="d">-            (2.0, 0, false),
</a><a href="#h3-3-297" id="h3-3-297" class="d">-            (0.0, 1, true),
</a><a href="#h3-3-298" id="h3-3-298" class="d">-            (0.0, garbage_size - 1, true),
</a><a href="#h3-3-299" id="h3-3-299" class="d">-            (0.0, garbage_size, true),
</a><a href="#h3-3-300" id="h3-3-300" class="d">-            (0.0, garbage_size + 1, false),
</a><a href="#h3-3-301" id="h3-3-301" class="d">-        ];
</a><a href="#h3-3-302" id="h3-3-302" class="d">-        for (min_ratio, min_size, expect_compact) in cases.into_iter() {
</a><a href="#h3-3-303" id="h3-3-303" class="d">-            std::fs::copy(&amp;path, &amp;compactpath)?;
</a><a href="#h3-3-304" id="h3-3-304" class="d">-            let mut s = BitCask::new_compact(compactpath.clone(), min_ratio, min_size)?;
</a><a href="#h3-3-305" id="h3-3-305" class="d">-            let new_status = s.status()?;
</a><a href="#h3-3-306" id="h3-3-306" class="d">-            assert_eq!(new_status.live_disk_size, status.live_disk_size);
</a><a href="#h3-3-307" id="h3-3-307" class="d">-            if expect_compact {
</a><a href="#h3-3-308" id="h3-3-308" class="d">-                assert_eq!(new_status.total_disk_size, status.live_disk_size);
</a><a href="#h3-3-309" id="h3-3-309" class="d">-                assert_eq!(new_status.garbage_disk_size, 0);
</a><a href="#h3-3-310" id="h3-3-310" class="d">-            } else {
</a><a href="#h3-3-311" id="h3-3-311" class="d">-                assert_eq!(new_status, status);
</a><a href="#h3-3-312" id="h3-3-312" class="i">+                let mut key = vec![0; key_len as usize];
</a><a href="#h3-3-313" id="h3-3-313" class="i">+                r.read_exact(&amp;mut key)?;
</a><a href="#h3-3-314" id="h3-3-314" class="i">+                let mut value = vec![0; value_len as usize];
</a><a href="#h3-3-315" id="h3-3-315" class="i">+                r.read_exact(&amp;mut value)?;
</a><a href="#h3-3-316" id="h3-3-316" class="i">+                let size = 4 + 4 + key_len as u64 + value_len as u64;
</a><a href="#h3-3-317" id="h3-3-317" class="i">+                writeln!(
</a><a href="#h3-3-318" id="h3-3-318" class="i">+                    output,
</a><a href="#h3-3-319" id="h3-3-319" class="i">+                    &quot;{:&lt;7} key=\&quot;{}\&quot; [{}] {}&quot;,
</a><a href="#h3-3-320" id="h3-3-320" class="i">+                    format!(&quot;{size}b&quot;),
</a><a href="#h3-3-321" id="h3-3-321" class="i">+                    Runner::&lt;BitCask&gt;::format_bytes(&amp;key),
</a><a href="#h3-3-322" id="h3-3-322" class="i">+                    hex::encode(key),
</a><a href="#h3-3-323" id="h3-3-323" class="i">+                    match value_len_or_tombstone {
</a><a href="#h3-3-324" id="h3-3-324" class="i">+                        -1 =&gt; &quot;tombstone&quot;.to_string(),
</a><a href="#h3-3-325" id="h3-3-325" class="i">+                        _ =&gt; format!(
</a><a href="#h3-3-326" id="h3-3-326" class="i">+                            &quot;value=\&quot;{}\&quot; [{}]&quot;,
</a><a href="#h3-3-327" id="h3-3-327" class="i">+                            Runner::&lt;BitCask&gt;::format_bytes(&amp;value),
</a><a href="#h3-3-328" id="h3-3-328" class="i">+                            hex::encode(&amp;value)
</a><a href="#h3-3-329" id="h3-3-329" class="i">+                        ),
</a><a href="#h3-3-330" id="h3-3-330" class="i">+                    },
</a><a href="#h3-3-331" id="h3-3-331" class="i">+                )?;
</a><a href="#h3-3-332" id="h3-3-332" class="i">+
</a><a href="#h3-3-333" id="h3-3-333" class="i">+                pos += size;
</a><a href="#h3-3-334" id="h3-3-334" class="i">+                idx += 1;
</a>             }
<a href="#h3-3-336" id="h3-3-336" class="i">+            Ok(())
</a>         }
<a href="#h3-3-338" id="h3-3-338" class="d">-
</a><a href="#h3-3-339" id="h3-3-339" class="d">-        Ok(())
</a>     }
 
     #[test]
<a href="#h3-4" id="h3-4" class="h">@@ -625,41 +578,4 @@ mod tests {
</a> 
         Ok(())
     }
<a href="#h3-4-3" id="h3-4-3" class="d">-
</a><a href="#h3-4-4" id="h3-4-4" class="d">-    #[test]
</a><a href="#h3-4-5" id="h3-4-5" class="d">-    /// Tests status(), both for a log file with known garbage, and
</a><a href="#h3-4-6" id="h3-4-6" class="d">-    /// after compacting it when the live size must equal the file size.
</a><a href="#h3-4-7" id="h3-4-7" class="d">-    fn status_full() -&gt; Result&lt;()&gt; {
</a><a href="#h3-4-8" id="h3-4-8" class="d">-        let mut s = setup()?;
</a><a href="#h3-4-9" id="h3-4-9" class="d">-        setup_log(&amp;mut s)?;
</a><a href="#h3-4-10" id="h3-4-10" class="d">-
</a><a href="#h3-4-11" id="h3-4-11" class="d">-        // Before compaction.
</a><a href="#h3-4-12" id="h3-4-12" class="d">-        assert_eq!(
</a><a href="#h3-4-13" id="h3-4-13" class="d">-            s.status()?,
</a><a href="#h3-4-14" id="h3-4-14" class="d">-            Status {
</a><a href="#h3-4-15" id="h3-4-15" class="d">-                name: &quot;bitcask&quot;.to_string(),
</a><a href="#h3-4-16" id="h3-4-16" class="d">-                keys: 5,
</a><a href="#h3-4-17" id="h3-4-17" class="d">-                size: 8,
</a><a href="#h3-4-18" id="h3-4-18" class="d">-                total_disk_size: 114,
</a><a href="#h3-4-19" id="h3-4-19" class="d">-                live_disk_size: 48,
</a><a href="#h3-4-20" id="h3-4-20" class="d">-                garbage_disk_size: 66
</a><a href="#h3-4-21" id="h3-4-21" class="d">-            }
</a><a href="#h3-4-22" id="h3-4-22" class="d">-        );
</a><a href="#h3-4-23" id="h3-4-23" class="d">-
</a><a href="#h3-4-24" id="h3-4-24" class="d">-        // After compaction.
</a><a href="#h3-4-25" id="h3-4-25" class="d">-        s.compact()?;
</a><a href="#h3-4-26" id="h3-4-26" class="d">-        assert_eq!(
</a><a href="#h3-4-27" id="h3-4-27" class="d">-            s.status()?,
</a><a href="#h3-4-28" id="h3-4-28" class="d">-            Status {
</a><a href="#h3-4-29" id="h3-4-29" class="d">-                name: &quot;bitcask&quot;.to_string(),
</a><a href="#h3-4-30" id="h3-4-30" class="d">-                keys: 5,
</a><a href="#h3-4-31" id="h3-4-31" class="d">-                size: 8,
</a><a href="#h3-4-32" id="h3-4-32" class="d">-                total_disk_size: 48,
</a><a href="#h3-4-33" id="h3-4-33" class="d">-                live_disk_size: 48,
</a><a href="#h3-4-34" id="h3-4-34" class="d">-                garbage_disk_size: 0,
</a><a href="#h3-4-35" id="h3-4-35" class="d">-            }
</a><a href="#h3-4-36" id="h3-4-36" class="d">-        );
</a><a href="#h3-4-37" id="h3-4-37" class="d">-
</a><a href="#h3-4-38" id="h3-4-38" class="d">-        Ok(())
</a><a href="#h3-4-39" id="h3-4-39" class="d">-    }
</a> }
<b>diff --git a/<a id="h4" href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a> b/<a href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -80,11 +80,159 @@ pub struct Status {
</a>     pub garbage_disk_size: u64,
 }
 
<a href="#h4-0-3" id="h4-0-3" class="i">+/// Test helpers for engines.
</a> #[cfg(test)]
<a href="#h4-0-5" id="h4-0-5" class="d">-/// Test helper engines.
</a> pub mod test {
     use super::*;
     use crossbeam::channel::Sender;
<a href="#h4-0-9" id="h4-0-9" class="i">+    use regex::Regex;
</a><a href="#h4-0-10" id="h4-0-10" class="i">+    use std::error::Error as StdError;
</a><a href="#h4-0-11" id="h4-0-11" class="i">+    use std::fmt::Write as _;
</a><a href="#h4-0-12" id="h4-0-12" class="i">+    use std::result::Result as StdResult;
</a><a href="#h4-0-13" id="h4-0-13" class="i">+
</a><a href="#h4-0-14" id="h4-0-14" class="i">+    /// Goldenscript runner for engines. All engines use a common set of
</a><a href="#h4-0-15" id="h4-0-15" class="i">+    /// goldenscripts in src/storage/testscripts/engine, as well as their own
</a><a href="#h4-0-16" id="h4-0-16" class="i">+    /// engine-specific tests.
</a><a href="#h4-0-17" id="h4-0-17" class="i">+    pub struct Runner&lt;E: Engine&gt; {
</a><a href="#h4-0-18" id="h4-0-18" class="i">+        pub engine: E,
</a><a href="#h4-0-19" id="h4-0-19" class="i">+    }
</a><a href="#h4-0-20" id="h4-0-20" class="i">+
</a><a href="#h4-0-21" id="h4-0-21" class="i">+    impl&lt;E: Engine&gt; goldenscript::Runner for Runner&lt;E&gt; {
</a><a href="#h4-0-22" id="h4-0-22" class="i">+        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h4-0-23" id="h4-0-23" class="i">+            let mut output = String::new();
</a><a href="#h4-0-24" id="h4-0-24" class="i">+            match command.name.as_str() {
</a><a href="#h4-0-25" id="h4-0-25" class="i">+                // delete KEY
</a><a href="#h4-0-26" id="h4-0-26" class="i">+                &quot;delete&quot; =&gt; {
</a><a href="#h4-0-27" id="h4-0-27" class="i">+                    let mut args = command.consume_args();
</a><a href="#h4-0-28" id="h4-0-28" class="i">+                    let key = Self::decode_binary(&amp;args.next_pos().ok_or(&quot;key not given&quot;)?.value);
</a><a href="#h4-0-29" id="h4-0-29" class="i">+                    args.reject_rest()?;
</a><a href="#h4-0-30" id="h4-0-30" class="i">+                    self.engine.delete(&amp;key)?;
</a><a href="#h4-0-31" id="h4-0-31" class="i">+                }
</a><a href="#h4-0-32" id="h4-0-32" class="i">+
</a><a href="#h4-0-33" id="h4-0-33" class="i">+                // get KEY
</a><a href="#h4-0-34" id="h4-0-34" class="i">+                &quot;get&quot; =&gt; {
</a><a href="#h4-0-35" id="h4-0-35" class="i">+                    let mut args = command.consume_args();
</a><a href="#h4-0-36" id="h4-0-36" class="i">+                    let key = Self::decode_binary(&amp;args.next_pos().ok_or(&quot;key not given&quot;)?.value);
</a><a href="#h4-0-37" id="h4-0-37" class="i">+                    args.reject_rest()?;
</a><a href="#h4-0-38" id="h4-0-38" class="i">+                    let value = self.engine.get(&amp;key)?;
</a><a href="#h4-0-39" id="h4-0-39" class="i">+                    output.push_str(&amp;Self::format_key_value(&amp;key, value.as_deref()))
</a><a href="#h4-0-40" id="h4-0-40" class="i">+                }
</a><a href="#h4-0-41" id="h4-0-41" class="i">+
</a><a href="#h4-0-42" id="h4-0-42" class="i">+                // scan [reverse=BOOL] RANGE
</a><a href="#h4-0-43" id="h4-0-43" class="i">+                &quot;scan&quot; =&gt; {
</a><a href="#h4-0-44" id="h4-0-44" class="i">+                    let mut args = command.consume_args();
</a><a href="#h4-0-45" id="h4-0-45" class="i">+                    let reverse = args.lookup_parse(&quot;reverse&quot;)?.unwrap_or(false);
</a><a href="#h4-0-46" id="h4-0-46" class="i">+                    let range = Self::parse_key_range(
</a><a href="#h4-0-47" id="h4-0-47" class="i">+                        args.next_pos().map(|a| a.value.as_str()).unwrap_or(&quot;..&quot;),
</a><a href="#h4-0-48" id="h4-0-48" class="i">+                    )?;
</a><a href="#h4-0-49" id="h4-0-49" class="i">+                    args.reject_rest()?;
</a><a href="#h4-0-50" id="h4-0-50" class="i">+                    let items: Vec&lt;_&gt; = if reverse {
</a><a href="#h4-0-51" id="h4-0-51" class="i">+                        self.engine.scan(range).rev().collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h4-0-52" id="h4-0-52" class="i">+                    } else {
</a><a href="#h4-0-53" id="h4-0-53" class="i">+                        self.engine.scan(range).collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h4-0-54" id="h4-0-54" class="i">+                    };
</a><a href="#h4-0-55" id="h4-0-55" class="i">+                    for (key, value) in items {
</a><a href="#h4-0-56" id="h4-0-56" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h4-0-57" id="h4-0-57" class="i">+                    }
</a><a href="#h4-0-58" id="h4-0-58" class="i">+                }
</a><a href="#h4-0-59" id="h4-0-59" class="i">+
</a><a href="#h4-0-60" id="h4-0-60" class="i">+                // scan_prefix PREFIX
</a><a href="#h4-0-61" id="h4-0-61" class="i">+                &quot;scan_prefix&quot; =&gt; {
</a><a href="#h4-0-62" id="h4-0-62" class="i">+                    let mut args = command.consume_args();
</a><a href="#h4-0-63" id="h4-0-63" class="i">+                    let prefix =
</a><a href="#h4-0-64" id="h4-0-64" class="i">+                        Self::decode_binary(&amp;args.next_pos().ok_or(&quot;prefix not given&quot;)?.value);
</a><a href="#h4-0-65" id="h4-0-65" class="i">+                    args.reject_rest()?;
</a><a href="#h4-0-66" id="h4-0-66" class="i">+                    let mut scan = self.engine.scan_prefix(&amp;prefix);
</a><a href="#h4-0-67" id="h4-0-67" class="i">+                    while let Some((key, value)) = scan.next().transpose()? {
</a><a href="#h4-0-68" id="h4-0-68" class="i">+                        writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
</a><a href="#h4-0-69" id="h4-0-69" class="i">+                    }
</a><a href="#h4-0-70" id="h4-0-70" class="i">+                }
</a><a href="#h4-0-71" id="h4-0-71" class="i">+
</a><a href="#h4-0-72" id="h4-0-72" class="i">+                // set KEY=VALUE
</a><a href="#h4-0-73" id="h4-0-73" class="i">+                &quot;set&quot; =&gt; {
</a><a href="#h4-0-74" id="h4-0-74" class="i">+                    let mut args = command.consume_args();
</a><a href="#h4-0-75" id="h4-0-75" class="i">+                    let kv = args.next_key().ok_or(&quot;key=value not given&quot;)?.clone();
</a><a href="#h4-0-76" id="h4-0-76" class="i">+                    let key = Self::decode_binary(&amp;kv.key.unwrap());
</a><a href="#h4-0-77" id="h4-0-77" class="i">+                    let value = Self::decode_binary(&amp;kv.value);
</a><a href="#h4-0-78" id="h4-0-78" class="i">+                    args.reject_rest()?;
</a><a href="#h4-0-79" id="h4-0-79" class="i">+                    self.engine.set(&amp;key, value)?;
</a><a href="#h4-0-80" id="h4-0-80" class="i">+                }
</a><a href="#h4-0-81" id="h4-0-81" class="i">+
</a><a href="#h4-0-82" id="h4-0-82" class="i">+                // status
</a><a href="#h4-0-83" id="h4-0-83" class="i">+                &quot;status&quot; =&gt; {
</a><a href="#h4-0-84" id="h4-0-84" class="i">+                    command.consume_args().reject_rest()?;
</a><a href="#h4-0-85" id="h4-0-85" class="i">+                    writeln!(output, &quot;{:#?}&quot;, self.engine.status()?)?;
</a><a href="#h4-0-86" id="h4-0-86" class="i">+                }
</a><a href="#h4-0-87" id="h4-0-87" class="i">+
</a><a href="#h4-0-88" id="h4-0-88" class="i">+                name =&gt; return Err(format!(&quot;invalid command {name}&quot;).into()),
</a><a href="#h4-0-89" id="h4-0-89" class="i">+            }
</a><a href="#h4-0-90" id="h4-0-90" class="i">+            Ok(output)
</a><a href="#h4-0-91" id="h4-0-91" class="i">+        }
</a><a href="#h4-0-92" id="h4-0-92" class="i">+    }
</a><a href="#h4-0-93" id="h4-0-93" class="i">+
</a><a href="#h4-0-94" id="h4-0-94" class="i">+    impl&lt;E: Engine&gt; Runner&lt;E&gt; {
</a><a href="#h4-0-95" id="h4-0-95" class="i">+        pub fn new(engine: E) -&gt; Self {
</a><a href="#h4-0-96" id="h4-0-96" class="i">+            Self { engine }
</a><a href="#h4-0-97" id="h4-0-97" class="i">+        }
</a><a href="#h4-0-98" id="h4-0-98" class="i">+
</a><a href="#h4-0-99" id="h4-0-99" class="i">+        /// Decodes a raw byte vector from a Unicode string. Code points in the
</a><a href="#h4-0-100" id="h4-0-100" class="i">+        /// range U+0080 to U+00FF are converted back to bytes 0x80 to 0xff.
</a><a href="#h4-0-101" id="h4-0-101" class="i">+        /// This allows using e.g. \xff in the input string literal, and getting
</a><a href="#h4-0-102" id="h4-0-102" class="i">+        /// back a 0xff byte in the byte vector. Otherwise, char(0xff) yields
</a><a href="#h4-0-103" id="h4-0-103" class="i">+        /// the UTF-8 bytes 0xc3bf, which is the U+00FF code point as UTF-8.
</a><a href="#h4-0-104" id="h4-0-104" class="i">+        /// These characters are effectively represented as ISO-8859-1 rather
</a><a href="#h4-0-105" id="h4-0-105" class="i">+        /// than UTF-8, but it allows precise use of the entire u8 value range.
</a><a href="#h4-0-106" id="h4-0-106" class="i">+        pub fn decode_binary(s: &amp;str) -&gt; Vec&lt;u8&gt; {
</a><a href="#h4-0-107" id="h4-0-107" class="i">+            let mut buf = [0; 4];
</a><a href="#h4-0-108" id="h4-0-108" class="i">+            let mut bytes = Vec::new();
</a><a href="#h4-0-109" id="h4-0-109" class="i">+            for c in s.chars() {
</a><a href="#h4-0-110" id="h4-0-110" class="i">+                // u32 is the Unicode code point, not the UTF-8 encoding.
</a><a href="#h4-0-111" id="h4-0-111" class="i">+                match c as u32 {
</a><a href="#h4-0-112" id="h4-0-112" class="i">+                    b @ 0x80..=0xff =&gt; bytes.push(b as u8),
</a><a href="#h4-0-113" id="h4-0-113" class="i">+                    _ =&gt; bytes.extend(c.encode_utf8(&amp;mut buf).as_bytes()),
</a><a href="#h4-0-114" id="h4-0-114" class="i">+                }
</a><a href="#h4-0-115" id="h4-0-115" class="i">+            }
</a><a href="#h4-0-116" id="h4-0-116" class="i">+            bytes
</a><a href="#h4-0-117" id="h4-0-117" class="i">+        }
</a><a href="#h4-0-118" id="h4-0-118" class="i">+
</a><a href="#h4-0-119" id="h4-0-119" class="i">+        /// Formats a raw binary byte vector, escaping special characters.
</a><a href="#h4-0-120" id="h4-0-120" class="i">+        /// TODO: find a better way to manage and share formatting functions.
</a><a href="#h4-0-121" id="h4-0-121" class="i">+        pub fn format_bytes(bytes: &amp;[u8]) -&gt; String {
</a><a href="#h4-0-122" id="h4-0-122" class="i">+            let b: Vec&lt;u8&gt; = bytes.iter().copied().flat_map(std::ascii::escape_default).collect();
</a><a href="#h4-0-123" id="h4-0-123" class="i">+            String::from_utf8_lossy(&amp;b).to_string()
</a><a href="#h4-0-124" id="h4-0-124" class="i">+        }
</a><a href="#h4-0-125" id="h4-0-125" class="i">+
</a><a href="#h4-0-126" id="h4-0-126" class="i">+        /// Formats a key/value pair, or None if the value does not exist.
</a><a href="#h4-0-127" id="h4-0-127" class="i">+        pub fn format_key_value(key: &amp;[u8], value: Option&lt;&amp;[u8]&gt;) -&gt; String {
</a><a href="#h4-0-128" id="h4-0-128" class="i">+            format!(
</a><a href="#h4-0-129" id="h4-0-129" class="i">+                &quot;{} → {}&quot;,
</a><a href="#h4-0-130" id="h4-0-130" class="i">+                Self::format_bytes(key),
</a><a href="#h4-0-131" id="h4-0-131" class="i">+                value.map(|v| Self::format_bytes(v)).unwrap_or(&quot;None&quot;.to_string())
</a><a href="#h4-0-132" id="h4-0-132" class="i">+            )
</a><a href="#h4-0-133" id="h4-0-133" class="i">+        }
</a><a href="#h4-0-134" id="h4-0-134" class="i">+
</a><a href="#h4-0-135" id="h4-0-135" class="i">+        /// Parses an binary key range, using Rust range syntax.
</a><a href="#h4-0-136" id="h4-0-136" class="i">+        fn parse_key_range(
</a><a href="#h4-0-137" id="h4-0-137" class="i">+            s: &amp;str,
</a><a href="#h4-0-138" id="h4-0-138" class="i">+        ) -&gt; StdResult&lt;impl std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h4-0-139" id="h4-0-139" class="i">+            use std::ops::Bound;
</a><a href="#h4-0-140" id="h4-0-140" class="i">+            let mut bound = (Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded, Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded);
</a><a href="#h4-0-141" id="h4-0-141" class="i">+            let re = Regex::new(r&quot;^(\S+)?\.\.(=)?(\S+)?&quot;).expect(&quot;invalid regex&quot;);
</a><a href="#h4-0-142" id="h4-0-142" class="i">+            let groups = re.captures(s).ok_or_else(|| format!(&quot;invalid range {s}&quot;))?;
</a><a href="#h4-0-143" id="h4-0-143" class="i">+            if let Some(start) = groups.get(1) {
</a><a href="#h4-0-144" id="h4-0-144" class="i">+                bound.0 = Bound::Included(Self::decode_binary(start.as_str()));
</a><a href="#h4-0-145" id="h4-0-145" class="i">+            }
</a><a href="#h4-0-146" id="h4-0-146" class="i">+            if let Some(end) = groups.get(3) {
</a><a href="#h4-0-147" id="h4-0-147" class="i">+                let end = Self::decode_binary(end.as_str());
</a><a href="#h4-0-148" id="h4-0-148" class="i">+                if groups.get(2).is_some() {
</a><a href="#h4-0-149" id="h4-0-149" class="i">+                    bound.1 = Bound::Included(end)
</a><a href="#h4-0-150" id="h4-0-150" class="i">+                } else {
</a><a href="#h4-0-151" id="h4-0-151" class="i">+                    bound.1 = Bound::Excluded(end)
</a><a href="#h4-0-152" id="h4-0-152" class="i">+                }
</a><a href="#h4-0-153" id="h4-0-153" class="i">+            }
</a><a href="#h4-0-154" id="h4-0-154" class="i">+            Ok(bound)
</a><a href="#h4-0-155" id="h4-0-155" class="i">+        }
</a><a href="#h4-0-156" id="h4-0-156" class="i">+    }
</a> 
     /// Wraps another engine and emits write events to the given channel.
     pub struct Emit&lt;E: Engine&gt; {
<a href="#h4-1" id="h4-1" class="h">@@ -150,74 +298,14 @@ pub mod test {
</a> }
 
 #[cfg(test)]
<a href="#h4-1-3" id="h4-1-3" class="d">-pub(crate) mod tests {
</a><a href="#h4-1-4" id="h4-1-4" class="i">+pub mod tests {
</a>     /// Generates common tests for any Engine implementation.
<a href="#h4-1-6" id="h4-1-6" class="i">+    ///
</a><a href="#h4-1-7" id="h4-1-7" class="i">+    /// TODO: split these out. In particular, the randomized runner should be
</a><a href="#h4-1-8" id="h4-1-8" class="i">+    /// rewritten as a Mirror engine that mirrors operations on multiple engines
</a><a href="#h4-1-9" id="h4-1-9" class="i">+    /// and compares them.
</a>     macro_rules! test_engine {
         ($setup:expr) =&gt; {
<a href="#h4-1-12" id="h4-1-12" class="d">-            #[track_caller]
</a><a href="#h4-1-13" id="h4-1-13" class="d">-            /// Asserts that a scan yields the expected items.
</a><a href="#h4-1-14" id="h4-1-14" class="d">-            fn assert_scan&lt;I&gt;(iter: I, expect: Vec&lt;(&amp;[u8], Vec&lt;u8&gt;)&gt;) -&gt; Result&lt;()&gt;
</a><a href="#h4-1-15" id="h4-1-15" class="d">-            where
</a><a href="#h4-1-16" id="h4-1-16" class="d">-                I: Iterator&lt;Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;&gt;,
</a><a href="#h4-1-17" id="h4-1-17" class="d">-            {
</a><a href="#h4-1-18" id="h4-1-18" class="d">-                assert_eq!(
</a><a href="#h4-1-19" id="h4-1-19" class="d">-                    iter.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?,
</a><a href="#h4-1-20" id="h4-1-20" class="d">-                    expect.into_iter().map(|(k, v)| (k.to_vec(), v)).collect::&lt;Vec&lt;_&gt;&gt;()
</a><a href="#h4-1-21" id="h4-1-21" class="d">-                );
</a><a href="#h4-1-22" id="h4-1-22" class="d">-                Ok(())
</a><a href="#h4-1-23" id="h4-1-23" class="d">-            }
</a><a href="#h4-1-24" id="h4-1-24" class="d">-
</a><a href="#h4-1-25" id="h4-1-25" class="d">-            /// Tests Engine point operations, i.e. set, get, and delete.
</a><a href="#h4-1-26" id="h4-1-26" class="d">-            #[test]
</a><a href="#h4-1-27" id="h4-1-27" class="d">-            fn point_ops() -&gt; Result&lt;()&gt; {
</a><a href="#h4-1-28" id="h4-1-28" class="d">-                let mut s = $setup;
</a><a href="#h4-1-29" id="h4-1-29" class="d">-
</a><a href="#h4-1-30" id="h4-1-30" class="d">-                // Getting a missing key should return None.
</a><a href="#h4-1-31" id="h4-1-31" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, None);
</a><a href="#h4-1-32" id="h4-1-32" class="d">-
</a><a href="#h4-1-33" id="h4-1-33" class="d">-                // Setting and getting a key should return its value.
</a><a href="#h4-1-34" id="h4-1-34" class="d">-                s.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h4-1-35" id="h4-1-35" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, Some(vec![1]));
</a><a href="#h4-1-36" id="h4-1-36" class="d">-
</a><a href="#h4-1-37" id="h4-1-37" class="d">-                // Setting a different key should not affect the first.
</a><a href="#h4-1-38" id="h4-1-38" class="d">-                s.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h4-1-39" id="h4-1-39" class="d">-                assert_eq!(s.get(b&quot;b&quot;)?, Some(vec![2]));
</a><a href="#h4-1-40" id="h4-1-40" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, Some(vec![1]));
</a><a href="#h4-1-41" id="h4-1-41" class="d">-
</a><a href="#h4-1-42" id="h4-1-42" class="d">-                // Getting a different missing key should return None. The
</a><a href="#h4-1-43" id="h4-1-43" class="d">-                // comparison is case-insensitive for strings.
</a><a href="#h4-1-44" id="h4-1-44" class="d">-                assert_eq!(s.get(b&quot;c&quot;)?, None);
</a><a href="#h4-1-45" id="h4-1-45" class="d">-                assert_eq!(s.get(b&quot;A&quot;)?, None);
</a><a href="#h4-1-46" id="h4-1-46" class="d">-
</a><a href="#h4-1-47" id="h4-1-47" class="d">-                // Setting an existing key should replace its value.
</a><a href="#h4-1-48" id="h4-1-48" class="d">-                s.set(b&quot;a&quot;, vec![0])?;
</a><a href="#h4-1-49" id="h4-1-49" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, Some(vec![0]));
</a><a href="#h4-1-50" id="h4-1-50" class="d">-
</a><a href="#h4-1-51" id="h4-1-51" class="d">-                // Deleting a key should remove it, but not affect others.
</a><a href="#h4-1-52" id="h4-1-52" class="d">-                s.delete(b&quot;a&quot;)?;
</a><a href="#h4-1-53" id="h4-1-53" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, None);
</a><a href="#h4-1-54" id="h4-1-54" class="d">-                assert_eq!(s.get(b&quot;b&quot;)?, Some(vec![2]));
</a><a href="#h4-1-55" id="h4-1-55" class="d">-
</a><a href="#h4-1-56" id="h4-1-56" class="d">-                // Deletes are idempotent.
</a><a href="#h4-1-57" id="h4-1-57" class="d">-                s.delete(b&quot;a&quot;)?;
</a><a href="#h4-1-58" id="h4-1-58" class="d">-                assert_eq!(s.get(b&quot;a&quot;)?, None);
</a><a href="#h4-1-59" id="h4-1-59" class="d">-
</a><a href="#h4-1-60" id="h4-1-60" class="d">-                Ok(())
</a><a href="#h4-1-61" id="h4-1-61" class="d">-            }
</a><a href="#h4-1-62" id="h4-1-62" class="d">-
</a><a href="#h4-1-63" id="h4-1-63" class="d">-            #[test]
</a><a href="#h4-1-64" id="h4-1-64" class="d">-            /// Tests Engine point operations on empty keys and values. These
</a><a href="#h4-1-65" id="h4-1-65" class="d">-            /// are as valid as any other key/value.
</a><a href="#h4-1-66" id="h4-1-66" class="d">-            fn point_ops_empty() -&gt; Result&lt;()&gt; {
</a><a href="#h4-1-67" id="h4-1-67" class="d">-                let mut s = $setup;
</a><a href="#h4-1-68" id="h4-1-68" class="d">-                assert_eq!(s.get(b&quot;&quot;)?, None);
</a><a href="#h4-1-69" id="h4-1-69" class="d">-                s.set(b&quot;&quot;, vec![])?;
</a><a href="#h4-1-70" id="h4-1-70" class="d">-                assert_eq!(s.get(b&quot;&quot;)?, Some(vec![]));
</a><a href="#h4-1-71" id="h4-1-71" class="d">-                s.delete(b&quot;&quot;)?;
</a><a href="#h4-1-72" id="h4-1-72" class="d">-                assert_eq!(s.get(b&quot;&quot;)?, None);
</a><a href="#h4-1-73" id="h4-1-73" class="d">-                Ok(())
</a><a href="#h4-1-74" id="h4-1-74" class="d">-            }
</a><a href="#h4-1-75" id="h4-1-75" class="d">-
</a>             #[test]
             /// Tests Engine point operations on keys and values of increasing
             /// sizes, up to 16 MB.
<a href="#h4-2" id="h4-2" class="h">@@ -241,170 +329,6 @@ pub(crate) mod tests {
</a>             }
 
             #[test]
<a href="#h4-2-3" id="h4-2-3" class="d">-            /// Tests various Engine scans.
</a><a href="#h4-2-4" id="h4-2-4" class="d">-            fn scan() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-5" id="h4-2-5" class="d">-                let mut s = $setup;
</a><a href="#h4-2-6" id="h4-2-6" class="d">-                s.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h4-2-7" id="h4-2-7" class="d">-                s.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h4-2-8" id="h4-2-8" class="d">-                s.set(b&quot;ba&quot;, vec![2, 1])?;
</a><a href="#h4-2-9" id="h4-2-9" class="d">-                s.set(b&quot;bb&quot;, vec![2, 2])?;
</a><a href="#h4-2-10" id="h4-2-10" class="d">-                s.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h4-2-11" id="h4-2-11" class="d">-                s.set(b&quot;C&quot;, vec![3])?;
</a><a href="#h4-2-12" id="h4-2-12" class="d">-
</a><a href="#h4-2-13" id="h4-2-13" class="d">-                // Forward/reverse scans.
</a><a href="#h4-2-14" id="h4-2-14" class="d">-                assert_scan(
</a><a href="#h4-2-15" id="h4-2-15" class="d">-                    s.scan(b&quot;b&quot;.to_vec()..b&quot;bz&quot;.to_vec()),
</a><a href="#h4-2-16" id="h4-2-16" class="d">-                    vec![(b&quot;b&quot;, vec![2]), (b&quot;ba&quot;, vec![2, 1]), (b&quot;bb&quot;, vec![2, 2])],
</a><a href="#h4-2-17" id="h4-2-17" class="d">-                )?;
</a><a href="#h4-2-18" id="h4-2-18" class="d">-                assert_scan(
</a><a href="#h4-2-19" id="h4-2-19" class="d">-                    s.scan(b&quot;b&quot;.to_vec()..b&quot;bz&quot;.to_vec()).rev(),
</a><a href="#h4-2-20" id="h4-2-20" class="d">-                    vec![(b&quot;bb&quot;, vec![2, 2]), (b&quot;ba&quot;, vec![2, 1]), (b&quot;b&quot;, vec![2])],
</a><a href="#h4-2-21" id="h4-2-21" class="d">-                )?;
</a><a href="#h4-2-22" id="h4-2-22" class="d">-
</a><a href="#h4-2-23" id="h4-2-23" class="d">-                // Inclusive/exclusive ranges.
</a><a href="#h4-2-24" id="h4-2-24" class="d">-                assert_scan(
</a><a href="#h4-2-25" id="h4-2-25" class="d">-                    s.scan(b&quot;b&quot;.to_vec()..b&quot;bb&quot;.to_vec()),
</a><a href="#h4-2-26" id="h4-2-26" class="d">-                    vec![(b&quot;b&quot;, vec![2]), (b&quot;ba&quot;, vec![2, 1])],
</a><a href="#h4-2-27" id="h4-2-27" class="d">-                )?;
</a><a href="#h4-2-28" id="h4-2-28" class="d">-                assert_scan(
</a><a href="#h4-2-29" id="h4-2-29" class="d">-                    s.scan(b&quot;b&quot;.to_vec()..=b&quot;bb&quot;.to_vec()),
</a><a href="#h4-2-30" id="h4-2-30" class="d">-                    vec![(b&quot;b&quot;, vec![2]), (b&quot;ba&quot;, vec![2, 1]), (b&quot;bb&quot;, vec![2, 2])],
</a><a href="#h4-2-31" id="h4-2-31" class="d">-                )?;
</a><a href="#h4-2-32" id="h4-2-32" class="d">-
</a><a href="#h4-2-33" id="h4-2-33" class="d">-                // Open ranges.
</a><a href="#h4-2-34" id="h4-2-34" class="d">-                assert_scan(s.scan(b&quot;bb&quot;.to_vec()..), vec![(b&quot;bb&quot;, vec![2, 2]), (b&quot;c&quot;, vec![3])])?;
</a><a href="#h4-2-35" id="h4-2-35" class="d">-                assert_scan(
</a><a href="#h4-2-36" id="h4-2-36" class="d">-                    s.scan(..=b&quot;b&quot;.to_vec()),
</a><a href="#h4-2-37" id="h4-2-37" class="d">-                    vec![(b&quot;C&quot;, vec![3]), (b&quot;a&quot;, vec![1]), (b&quot;b&quot;, vec![2])],
</a><a href="#h4-2-38" id="h4-2-38" class="d">-                )?;
</a><a href="#h4-2-39" id="h4-2-39" class="d">-
</a><a href="#h4-2-40" id="h4-2-40" class="d">-                // Full range.
</a><a href="#h4-2-41" id="h4-2-41" class="d">-                assert_scan(
</a><a href="#h4-2-42" id="h4-2-42" class="d">-                    s.scan(..),
</a><a href="#h4-2-43" id="h4-2-43" class="d">-                    vec![
</a><a href="#h4-2-44" id="h4-2-44" class="d">-                        (b&quot;C&quot;, vec![3]),
</a><a href="#h4-2-45" id="h4-2-45" class="d">-                        (b&quot;a&quot;, vec![1]),
</a><a href="#h4-2-46" id="h4-2-46" class="d">-                        (b&quot;b&quot;, vec![2]),
</a><a href="#h4-2-47" id="h4-2-47" class="d">-                        (b&quot;ba&quot;, vec![2, 1]),
</a><a href="#h4-2-48" id="h4-2-48" class="d">-                        (b&quot;bb&quot;, vec![2, 2]),
</a><a href="#h4-2-49" id="h4-2-49" class="d">-                        (b&quot;c&quot;, vec![3]),
</a><a href="#h4-2-50" id="h4-2-50" class="d">-                    ],
</a><a href="#h4-2-51" id="h4-2-51" class="d">-                )?;
</a><a href="#h4-2-52" id="h4-2-52" class="d">-                Ok(())
</a><a href="#h4-2-53" id="h4-2-53" class="d">-            }
</a><a href="#h4-2-54" id="h4-2-54" class="d">-
</a><a href="#h4-2-55" id="h4-2-55" class="d">-            #[test]
</a><a href="#h4-2-56" id="h4-2-56" class="d">-            /// Tests prefix scans.
</a><a href="#h4-2-57" id="h4-2-57" class="d">-            fn scan_prefix() -&gt; Result&lt;()&gt; {
</a><a href="#h4-2-58" id="h4-2-58" class="d">-                let mut s = $setup;
</a><a href="#h4-2-59" id="h4-2-59" class="d">-                s.set(b&quot;a&quot;, vec![1])?;
</a><a href="#h4-2-60" id="h4-2-60" class="d">-                s.set(b&quot;b&quot;, vec![2])?;
</a><a href="#h4-2-61" id="h4-2-61" class="d">-                s.set(b&quot;ba&quot;, vec![2, 1])?;
</a><a href="#h4-2-62" id="h4-2-62" class="d">-                s.set(b&quot;bb&quot;, vec![2, 2])?;
</a><a href="#h4-2-63" id="h4-2-63" class="d">-                s.set(b&quot;b\xff&quot;, vec![2, 0xff])?;
</a><a href="#h4-2-64" id="h4-2-64" class="d">-                s.set(b&quot;b\xff\x00&quot;, vec![2, 0xff, 0x00])?;
</a><a href="#h4-2-65" id="h4-2-65" class="d">-                s.set(b&quot;b\xffb&quot;, vec![2, 0xff, 2])?;
</a><a href="#h4-2-66" id="h4-2-66" class="d">-                s.set(b&quot;b\xff\xff&quot;, vec![2, 0xff, 0xff])?;
</a><a href="#h4-2-67" id="h4-2-67" class="d">-                s.set(b&quot;c&quot;, vec![3])?;
</a><a href="#h4-2-68" id="h4-2-68" class="d">-                s.set(b&quot;\xff&quot;, vec![0xff])?;
</a><a href="#h4-2-69" id="h4-2-69" class="d">-                s.set(b&quot;\xff\xff&quot;, vec![0xff, 0xff])?;
</a><a href="#h4-2-70" id="h4-2-70" class="d">-                s.set(b&quot;\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff])?;
</a><a href="#h4-2-71" id="h4-2-71" class="d">-                s.set(b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff])?;
</a><a href="#h4-2-72" id="h4-2-72" class="d">-
</a><a href="#h4-2-73" id="h4-2-73" class="d">-                assert_scan(
</a><a href="#h4-2-74" id="h4-2-74" class="d">-                    s.scan_prefix(b&quot;&quot;),
</a><a href="#h4-2-75" id="h4-2-75" class="d">-                    vec![
</a><a href="#h4-2-76" id="h4-2-76" class="d">-                        (b&quot;a&quot;, vec![1]),
</a><a href="#h4-2-77" id="h4-2-77" class="d">-                        (b&quot;b&quot;, vec![2]),
</a><a href="#h4-2-78" id="h4-2-78" class="d">-                        (b&quot;ba&quot;, vec![2, 1]),
</a><a href="#h4-2-79" id="h4-2-79" class="d">-                        (b&quot;bb&quot;, vec![2, 2]),
</a><a href="#h4-2-80" id="h4-2-80" class="d">-                        (b&quot;b\xff&quot;, vec![2, 0xff]),
</a><a href="#h4-2-81" id="h4-2-81" class="d">-                        (b&quot;b\xff\x00&quot;, vec![2, 0xff, 0x00]),
</a><a href="#h4-2-82" id="h4-2-82" class="d">-                        (b&quot;b\xffb&quot;, vec![2, 0xff, 2]),
</a><a href="#h4-2-83" id="h4-2-83" class="d">-                        (b&quot;b\xff\xff&quot;, vec![2, 0xff, 0xff]),
</a><a href="#h4-2-84" id="h4-2-84" class="d">-                        (b&quot;c&quot;, vec![3]),
</a><a href="#h4-2-85" id="h4-2-85" class="d">-                        (b&quot;\xff&quot;, vec![0xff]),
</a><a href="#h4-2-86" id="h4-2-86" class="d">-                        (b&quot;\xff\xff&quot;, vec![0xff, 0xff]),
</a><a href="#h4-2-87" id="h4-2-87" class="d">-                        (b&quot;\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff]),
</a><a href="#h4-2-88" id="h4-2-88" class="d">-                        (b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff]),
</a><a href="#h4-2-89" id="h4-2-89" class="d">-                    ],
</a><a href="#h4-2-90" id="h4-2-90" class="d">-                )?;
</a><a href="#h4-2-91" id="h4-2-91" class="d">-
</a><a href="#h4-2-92" id="h4-2-92" class="d">-                assert_scan(
</a><a href="#h4-2-93" id="h4-2-93" class="d">-                    s.scan_prefix(b&quot;b&quot;),
</a><a href="#h4-2-94" id="h4-2-94" class="d">-                    vec![
</a><a href="#h4-2-95" id="h4-2-95" class="d">-                        (b&quot;b&quot;, vec![2]),
</a><a href="#h4-2-96" id="h4-2-96" class="d">-                        (b&quot;ba&quot;, vec![2, 1]),
</a><a href="#h4-2-97" id="h4-2-97" class="d">-                        (b&quot;bb&quot;, vec![2, 2]),
</a><a href="#h4-2-98" id="h4-2-98" class="d">-                        (b&quot;b\xff&quot;, vec![2, 0xff]),
</a><a href="#h4-2-99" id="h4-2-99" class="d">-                        (b&quot;b\xff\x00&quot;, vec![2, 0xff, 0x00]),
</a><a href="#h4-2-100" id="h4-2-100" class="d">-                        (b&quot;b\xffb&quot;, vec![2, 0xff, 2]),
</a><a href="#h4-2-101" id="h4-2-101" class="d">-                        (b&quot;b\xff\xff&quot;, vec![2, 0xff, 0xff]),
</a><a href="#h4-2-102" id="h4-2-102" class="d">-                    ],
</a><a href="#h4-2-103" id="h4-2-103" class="d">-                )?;
</a><a href="#h4-2-104" id="h4-2-104" class="d">-
</a><a href="#h4-2-105" id="h4-2-105" class="d">-                assert_scan(s.scan_prefix(b&quot;bb&quot;), vec![(b&quot;bb&quot;, vec![2, 2])])?;
</a><a href="#h4-2-106" id="h4-2-106" class="d">-
</a><a href="#h4-2-107" id="h4-2-107" class="d">-                assert_scan(s.scan_prefix(b&quot;bq&quot;), vec![])?;
</a><a href="#h4-2-108" id="h4-2-108" class="d">-
</a><a href="#h4-2-109" id="h4-2-109" class="d">-                assert_scan(
</a><a href="#h4-2-110" id="h4-2-110" class="d">-                    s.scan_prefix(b&quot;b\xff&quot;),
</a><a href="#h4-2-111" id="h4-2-111" class="d">-                    vec![
</a><a href="#h4-2-112" id="h4-2-112" class="d">-                        (b&quot;b\xff&quot;, vec![2, 0xff]),
</a><a href="#h4-2-113" id="h4-2-113" class="d">-                        (b&quot;b\xff\x00&quot;, vec![2, 0xff, 0x00]),
</a><a href="#h4-2-114" id="h4-2-114" class="d">-                        (b&quot;b\xffb&quot;, vec![2, 0xff, 2]),
</a><a href="#h4-2-115" id="h4-2-115" class="d">-                        (b&quot;b\xff\xff&quot;, vec![2, 0xff, 0xff]),
</a><a href="#h4-2-116" id="h4-2-116" class="d">-                    ],
</a><a href="#h4-2-117" id="h4-2-117" class="d">-                )?;
</a><a href="#h4-2-118" id="h4-2-118" class="d">-
</a><a href="#h4-2-119" id="h4-2-119" class="d">-                assert_scan(
</a><a href="#h4-2-120" id="h4-2-120" class="d">-                    s.scan_prefix(b&quot;b\xff\x00&quot;),
</a><a href="#h4-2-121" id="h4-2-121" class="d">-                    vec![(b&quot;b\xff\x00&quot;, vec![2, 0xff, 0x00])],
</a><a href="#h4-2-122" id="h4-2-122" class="d">-                )?;
</a><a href="#h4-2-123" id="h4-2-123" class="d">-
</a><a href="#h4-2-124" id="h4-2-124" class="d">-                assert_scan(
</a><a href="#h4-2-125" id="h4-2-125" class="d">-                    s.scan_prefix(b&quot;b\xff\xff&quot;),
</a><a href="#h4-2-126" id="h4-2-126" class="d">-                    vec![(b&quot;b\xff\xff&quot;, vec![2, 0xff, 0xff])],
</a><a href="#h4-2-127" id="h4-2-127" class="d">-                )?;
</a><a href="#h4-2-128" id="h4-2-128" class="d">-
</a><a href="#h4-2-129" id="h4-2-129" class="d">-                assert_scan(
</a><a href="#h4-2-130" id="h4-2-130" class="d">-                    s.scan_prefix(b&quot;\xff&quot;),
</a><a href="#h4-2-131" id="h4-2-131" class="d">-                    vec![
</a><a href="#h4-2-132" id="h4-2-132" class="d">-                        (b&quot;\xff&quot;, vec![0xff]),
</a><a href="#h4-2-133" id="h4-2-133" class="d">-                        (b&quot;\xff\xff&quot;, vec![0xff, 0xff]),
</a><a href="#h4-2-134" id="h4-2-134" class="d">-                        (b&quot;\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff]),
</a><a href="#h4-2-135" id="h4-2-135" class="d">-                        (b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff]),
</a><a href="#h4-2-136" id="h4-2-136" class="d">-                    ],
</a><a href="#h4-2-137" id="h4-2-137" class="d">-                )?;
</a><a href="#h4-2-138" id="h4-2-138" class="d">-
</a><a href="#h4-2-139" id="h4-2-139" class="d">-                assert_scan(
</a><a href="#h4-2-140" id="h4-2-140" class="d">-                    s.scan_prefix(b&quot;\xff\xff&quot;),
</a><a href="#h4-2-141" id="h4-2-141" class="d">-                    vec![
</a><a href="#h4-2-142" id="h4-2-142" class="d">-                        (b&quot;\xff\xff&quot;, vec![0xff, 0xff]),
</a><a href="#h4-2-143" id="h4-2-143" class="d">-                        (b&quot;\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff]),
</a><a href="#h4-2-144" id="h4-2-144" class="d">-                        (b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff]),
</a><a href="#h4-2-145" id="h4-2-145" class="d">-                    ],
</a><a href="#h4-2-146" id="h4-2-146" class="d">-                )?;
</a><a href="#h4-2-147" id="h4-2-147" class="d">-
</a><a href="#h4-2-148" id="h4-2-148" class="d">-                assert_scan(
</a><a href="#h4-2-149" id="h4-2-149" class="d">-                    s.scan_prefix(b&quot;\xff\xff\xff&quot;),
</a><a href="#h4-2-150" id="h4-2-150" class="d">-                    vec![
</a><a href="#h4-2-151" id="h4-2-151" class="d">-                        (b&quot;\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff]),
</a><a href="#h4-2-152" id="h4-2-152" class="d">-                        (b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff]),
</a><a href="#h4-2-153" id="h4-2-153" class="d">-                    ],
</a><a href="#h4-2-154" id="h4-2-154" class="d">-                )?;
</a><a href="#h4-2-155" id="h4-2-155" class="d">-
</a><a href="#h4-2-156" id="h4-2-156" class="d">-                assert_scan(
</a><a href="#h4-2-157" id="h4-2-157" class="d">-                    s.scan_prefix(b&quot;\xff\xff\xff\xff&quot;),
</a><a href="#h4-2-158" id="h4-2-158" class="d">-                    vec![(b&quot;\xff\xff\xff\xff&quot;, vec![0xff, 0xff, 0xff, 0xff])],
</a><a href="#h4-2-159" id="h4-2-159" class="d">-                )?;
</a><a href="#h4-2-160" id="h4-2-160" class="d">-
</a><a href="#h4-2-161" id="h4-2-161" class="d">-                assert_scan(s.scan_prefix(b&quot;\xff\xff\xff\xff\xff&quot;), vec![])?;
</a><a href="#h4-2-162" id="h4-2-162" class="d">-
</a><a href="#h4-2-163" id="h4-2-163" class="d">-                Ok(())
</a><a href="#h4-2-164" id="h4-2-164" class="d">-            }
</a><a href="#h4-2-165" id="h4-2-165" class="d">-
</a><a href="#h4-2-166" id="h4-2-166" class="d">-            #[test]
</a>             /// Runs random operations both on a Engine and a known-good
             /// BTreeMap, comparing the results of each operation as well as the
             /// final state.
<a href="#h4-3" id="h4-3" class="h">@@ -512,26 +436,6 @@ pub(crate) mod tests {
</a> 
                 Ok(())
             }
<a href="#h4-3-3" id="h4-3-3" class="d">-
</a><a href="#h4-3-4" id="h4-3-4" class="d">-            #[test]
</a><a href="#h4-3-5" id="h4-3-5" class="d">-            /// Tests implementation-independent aspects of Status.
</a><a href="#h4-3-6" id="h4-3-6" class="d">-            fn status() -&gt; Result&lt;()&gt; {
</a><a href="#h4-3-7" id="h4-3-7" class="d">-                let mut s = $setup;
</a><a href="#h4-3-8" id="h4-3-8" class="d">-                s.set(b&quot;foo&quot;, vec![1, 2, 3])?;
</a><a href="#h4-3-9" id="h4-3-9" class="d">-                s.set(b&quot;bar&quot;, vec![1])?;
</a><a href="#h4-3-10" id="h4-3-10" class="d">-                s.delete(b&quot;bar&quot;)?;
</a><a href="#h4-3-11" id="h4-3-11" class="d">-                s.set(b&quot;baz&quot;, vec![1])?;
</a><a href="#h4-3-12" id="h4-3-12" class="d">-                s.set(b&quot;baz&quot;, vec![2])?;
</a><a href="#h4-3-13" id="h4-3-13" class="d">-                s.set(b&quot;baz&quot;, vec![3])?;
</a><a href="#h4-3-14" id="h4-3-14" class="d">-                s.delete(b&quot;qux&quot;)?;
</a><a href="#h4-3-15" id="h4-3-15" class="d">-
</a><a href="#h4-3-16" id="h4-3-16" class="d">-                let status = s.status()?;
</a><a href="#h4-3-17" id="h4-3-17" class="d">-                assert!(status.name.len() &gt; 0);
</a><a href="#h4-3-18" id="h4-3-18" class="d">-                assert_eq!(status.keys, 2);
</a><a href="#h4-3-19" id="h4-3-19" class="d">-                assert_eq!(status.size, 10);
</a><a href="#h4-3-20" id="h4-3-20" class="d">-
</a><a href="#h4-3-21" id="h4-3-21" class="d">-                Ok(())
</a><a href="#h4-3-22" id="h4-3-22" class="d">-            }
</a>         };
     }
 
<b>diff --git a/<a id="h5" href="../file/src/storage/golden/bitcask/compact-after.html">src/storage/golden/bitcask/compact-after</a> b/<a href="../file/src/storage/golden/bitcask/compact-after.html">src/storage/golden/bitcask/compact-after</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,30 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-entry = 0, offset 0
</a><a href="#h5-0-1" id="h5-0-1" class="d">-klen  = 0 [0, 0, 0, 0]
</a><a href="#h5-0-2" id="h5-0-2" class="d">-vlen  = 0 [0, 0, 0, 0]
</a><a href="#h5-0-3" id="h5-0-3" class="d">-key   = &quot;&quot; []
</a><a href="#h5-0-4" id="h5-0-4" class="d">-value = &quot;&quot; []
</a><a href="#h5-0-5" id="h5-0-5" class="d">-
</a><a href="#h5-0-6" id="h5-0-6" class="d">-entry = 1, offset 8
</a><a href="#h5-0-7" id="h5-0-7" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-8" id="h5-0-8" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-9" id="h5-0-9" class="d">-key   = &quot;a&quot; [61]
</a><a href="#h5-0-10" id="h5-0-10" class="d">-value = [1]
</a><a href="#h5-0-11" id="h5-0-11" class="d">-
</a><a href="#h5-0-12" id="h5-0-12" class="d">-entry = 2, offset 18
</a><a href="#h5-0-13" id="h5-0-13" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-14" id="h5-0-14" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-15" id="h5-0-15" class="d">-key   = &quot;b&quot; [62]
</a><a href="#h5-0-16" id="h5-0-16" class="d">-value = [2]
</a><a href="#h5-0-17" id="h5-0-17" class="d">-
</a><a href="#h5-0-18" id="h5-0-18" class="d">-entry = 3, offset 28
</a><a href="#h5-0-19" id="h5-0-19" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-20" id="h5-0-20" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-21" id="h5-0-21" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h5-0-22" id="h5-0-22" class="d">-value = [3]
</a><a href="#h5-0-23" id="h5-0-23" class="d">-
</a><a href="#h5-0-24" id="h5-0-24" class="d">-entry = 4, offset 38
</a><a href="#h5-0-25" id="h5-0-25" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-26" id="h5-0-26" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h5-0-27" id="h5-0-27" class="d">-key   = &quot;d&quot; [64]
</a><a href="#h5-0-28" id="h5-0-28" class="d">-value = [4]
</a><a href="#h5-0-29" id="h5-0-29" class="d">-
</a><b>diff --git a/<a id="h6" href="../file/src/storage/golden/bitcask/compact-before.html">src/storage/golden/bitcask/compact-before</a> b/<a href="../file/src/storage/golden/bitcask/compact-before.html">src/storage/golden/bitcask/compact-before</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,72 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-entry = 0, offset 0
</a><a href="#h6-0-1" id="h6-0-1" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-2" id="h6-0-2" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-3" id="h6-0-3" class="d">-key   = &quot;b&quot; [62]
</a><a href="#h6-0-4" id="h6-0-4" class="d">-value = [1]
</a><a href="#h6-0-5" id="h6-0-5" class="d">-
</a><a href="#h6-0-6" id="h6-0-6" class="d">-entry = 1, offset 10
</a><a href="#h6-0-7" id="h6-0-7" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-8" id="h6-0-8" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-9" id="h6-0-9" class="d">-key   = &quot;b&quot; [62]
</a><a href="#h6-0-10" id="h6-0-10" class="d">-value = [2]
</a><a href="#h6-0-11" id="h6-0-11" class="d">-
</a><a href="#h6-0-12" id="h6-0-12" class="d">-entry = 2, offset 20
</a><a href="#h6-0-13" id="h6-0-13" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-14" id="h6-0-14" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-15" id="h6-0-15" class="d">-key   = &quot;e&quot; [65]
</a><a href="#h6-0-16" id="h6-0-16" class="d">-value = [5]
</a><a href="#h6-0-17" id="h6-0-17" class="d">-
</a><a href="#h6-0-18" id="h6-0-18" class="d">-entry = 3, offset 30
</a><a href="#h6-0-19" id="h6-0-19" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-20" id="h6-0-20" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h6-0-21" id="h6-0-21" class="d">-key   = &quot;e&quot; [65]
</a><a href="#h6-0-22" id="h6-0-22" class="d">-value = tombstone []
</a><a href="#h6-0-23" id="h6-0-23" class="d">-
</a><a href="#h6-0-24" id="h6-0-24" class="d">-entry = 4, offset 39
</a><a href="#h6-0-25" id="h6-0-25" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-26" id="h6-0-26" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-27" id="h6-0-27" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h6-0-28" id="h6-0-28" class="d">-value = [0]
</a><a href="#h6-0-29" id="h6-0-29" class="d">-
</a><a href="#h6-0-30" id="h6-0-30" class="d">-entry = 5, offset 49
</a><a href="#h6-0-31" id="h6-0-31" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-32" id="h6-0-32" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h6-0-33" id="h6-0-33" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h6-0-34" id="h6-0-34" class="d">-value = tombstone []
</a><a href="#h6-0-35" id="h6-0-35" class="d">-
</a><a href="#h6-0-36" id="h6-0-36" class="d">-entry = 6, offset 58
</a><a href="#h6-0-37" id="h6-0-37" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-38" id="h6-0-38" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-39" id="h6-0-39" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h6-0-40" id="h6-0-40" class="d">-value = [3]
</a><a href="#h6-0-41" id="h6-0-41" class="d">-
</a><a href="#h6-0-42" id="h6-0-42" class="d">-entry = 7, offset 68
</a><a href="#h6-0-43" id="h6-0-43" class="d">-klen  = 0 [0, 0, 0, 0]
</a><a href="#h6-0-44" id="h6-0-44" class="d">-vlen  = 0 [0, 0, 0, 0]
</a><a href="#h6-0-45" id="h6-0-45" class="d">-key   = &quot;&quot; []
</a><a href="#h6-0-46" id="h6-0-46" class="d">-value = &quot;&quot; []
</a><a href="#h6-0-47" id="h6-0-47" class="d">-
</a><a href="#h6-0-48" id="h6-0-48" class="d">-entry = 8, offset 76
</a><a href="#h6-0-49" id="h6-0-49" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-50" id="h6-0-50" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-51" id="h6-0-51" class="d">-key   = &quot;a&quot; [61]
</a><a href="#h6-0-52" id="h6-0-52" class="d">-value = [1]
</a><a href="#h6-0-53" id="h6-0-53" class="d">-
</a><a href="#h6-0-54" id="h6-0-54" class="d">-entry = 9, offset 86
</a><a href="#h6-0-55" id="h6-0-55" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-56" id="h6-0-56" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h6-0-57" id="h6-0-57" class="d">-key   = &quot;f&quot; [66]
</a><a href="#h6-0-58" id="h6-0-58" class="d">-value = tombstone []
</a><a href="#h6-0-59" id="h6-0-59" class="d">-
</a><a href="#h6-0-60" id="h6-0-60" class="d">-entry = 10, offset 95
</a><a href="#h6-0-61" id="h6-0-61" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-62" id="h6-0-62" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h6-0-63" id="h6-0-63" class="d">-key   = &quot;d&quot; [64]
</a><a href="#h6-0-64" id="h6-0-64" class="d">-value = tombstone []
</a><a href="#h6-0-65" id="h6-0-65" class="d">-
</a><a href="#h6-0-66" id="h6-0-66" class="d">-entry = 11, offset 104
</a><a href="#h6-0-67" id="h6-0-67" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-68" id="h6-0-68" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h6-0-69" id="h6-0-69" class="d">-key   = &quot;d&quot; [64]
</a><a href="#h6-0-70" id="h6-0-70" class="d">-value = [4]
</a><a href="#h6-0-71" id="h6-0-71" class="d">-
</a><b>diff --git a/<a id="h7" href="../file/src/storage/golden/bitcask/log.html">src/storage/golden/bitcask/log</a> b/<a href="../file/src/storage/golden/bitcask/log.html">src/storage/golden/bitcask/log</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,72 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-entry = 0, offset 0
</a><a href="#h7-0-1" id="h7-0-1" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-2" id="h7-0-2" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-3" id="h7-0-3" class="d">-key   = &quot;b&quot; [62]
</a><a href="#h7-0-4" id="h7-0-4" class="d">-value = [1]
</a><a href="#h7-0-5" id="h7-0-5" class="d">-
</a><a href="#h7-0-6" id="h7-0-6" class="d">-entry = 1, offset 10
</a><a href="#h7-0-7" id="h7-0-7" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-8" id="h7-0-8" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-9" id="h7-0-9" class="d">-key   = &quot;b&quot; [62]
</a><a href="#h7-0-10" id="h7-0-10" class="d">-value = [2]
</a><a href="#h7-0-11" id="h7-0-11" class="d">-
</a><a href="#h7-0-12" id="h7-0-12" class="d">-entry = 2, offset 20
</a><a href="#h7-0-13" id="h7-0-13" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-14" id="h7-0-14" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-15" id="h7-0-15" class="d">-key   = &quot;e&quot; [65]
</a><a href="#h7-0-16" id="h7-0-16" class="d">-value = [5]
</a><a href="#h7-0-17" id="h7-0-17" class="d">-
</a><a href="#h7-0-18" id="h7-0-18" class="d">-entry = 3, offset 30
</a><a href="#h7-0-19" id="h7-0-19" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-20" id="h7-0-20" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h7-0-21" id="h7-0-21" class="d">-key   = &quot;e&quot; [65]
</a><a href="#h7-0-22" id="h7-0-22" class="d">-value = tombstone []
</a><a href="#h7-0-23" id="h7-0-23" class="d">-
</a><a href="#h7-0-24" id="h7-0-24" class="d">-entry = 4, offset 39
</a><a href="#h7-0-25" id="h7-0-25" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-26" id="h7-0-26" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-27" id="h7-0-27" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h7-0-28" id="h7-0-28" class="d">-value = [0]
</a><a href="#h7-0-29" id="h7-0-29" class="d">-
</a><a href="#h7-0-30" id="h7-0-30" class="d">-entry = 5, offset 49
</a><a href="#h7-0-31" id="h7-0-31" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-32" id="h7-0-32" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h7-0-33" id="h7-0-33" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h7-0-34" id="h7-0-34" class="d">-value = tombstone []
</a><a href="#h7-0-35" id="h7-0-35" class="d">-
</a><a href="#h7-0-36" id="h7-0-36" class="d">-entry = 6, offset 58
</a><a href="#h7-0-37" id="h7-0-37" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-38" id="h7-0-38" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-39" id="h7-0-39" class="d">-key   = &quot;c&quot; [63]
</a><a href="#h7-0-40" id="h7-0-40" class="d">-value = [3]
</a><a href="#h7-0-41" id="h7-0-41" class="d">-
</a><a href="#h7-0-42" id="h7-0-42" class="d">-entry = 7, offset 68
</a><a href="#h7-0-43" id="h7-0-43" class="d">-klen  = 0 [0, 0, 0, 0]
</a><a href="#h7-0-44" id="h7-0-44" class="d">-vlen  = 0 [0, 0, 0, 0]
</a><a href="#h7-0-45" id="h7-0-45" class="d">-key   = &quot;&quot; []
</a><a href="#h7-0-46" id="h7-0-46" class="d">-value = &quot;&quot; []
</a><a href="#h7-0-47" id="h7-0-47" class="d">-
</a><a href="#h7-0-48" id="h7-0-48" class="d">-entry = 8, offset 76
</a><a href="#h7-0-49" id="h7-0-49" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-50" id="h7-0-50" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-51" id="h7-0-51" class="d">-key   = &quot;a&quot; [61]
</a><a href="#h7-0-52" id="h7-0-52" class="d">-value = [1]
</a><a href="#h7-0-53" id="h7-0-53" class="d">-
</a><a href="#h7-0-54" id="h7-0-54" class="d">-entry = 9, offset 86
</a><a href="#h7-0-55" id="h7-0-55" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-56" id="h7-0-56" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h7-0-57" id="h7-0-57" class="d">-key   = &quot;f&quot; [66]
</a><a href="#h7-0-58" id="h7-0-58" class="d">-value = tombstone []
</a><a href="#h7-0-59" id="h7-0-59" class="d">-
</a><a href="#h7-0-60" id="h7-0-60" class="d">-entry = 10, offset 95
</a><a href="#h7-0-61" id="h7-0-61" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-62" id="h7-0-62" class="d">-vlen  = -1 [ff, ff, ff, ff]
</a><a href="#h7-0-63" id="h7-0-63" class="d">-key   = &quot;d&quot; [64]
</a><a href="#h7-0-64" id="h7-0-64" class="d">-value = tombstone []
</a><a href="#h7-0-65" id="h7-0-65" class="d">-
</a><a href="#h7-0-66" id="h7-0-66" class="d">-entry = 11, offset 104
</a><a href="#h7-0-67" id="h7-0-67" class="d">-klen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-68" id="h7-0-68" class="d">-vlen  = 1 [0, 0, 0, 1]
</a><a href="#h7-0-69" id="h7-0-69" class="d">-key   = &quot;d&quot; [64]
</a><a href="#h7-0-70" id="h7-0-70" class="d">-value = [4]
</a><a href="#h7-0-71" id="h7-0-71" class="d">-
</a><b>diff --git a/<a id="h8" href="../file/src/storage/memory.rs.html">src/storage/memory.rs</a> b/<a href="../file/src/storage/memory.rs.html">src/storage/memory.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -85,7 +85,19 @@ impl&lt;&#39;a&gt; DoubleEndedIterator for ScanIterator&lt;&#39;a&gt; {
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h8-0-3" id="h8-0-3" class="i">+    use super::super::engine::test::Runner;
</a>     use super::*;
<a href="#h8-0-5" id="h8-0-5" class="i">+    use test_each_file::test_each_path;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+    // Run common goldenscript tests in src/storage/testscripts/engine.
</a><a href="#h8-0-8" id="h8-0-8" class="i">+    test_each_path! { in &quot;src/storage/testscripts/engine&quot; as engine =&gt; test_goldenscript }
</a><a href="#h8-0-9" id="h8-0-9" class="i">+
</a><a href="#h8-0-10" id="h8-0-10" class="i">+    // Also run Memory-specific tests in src/storage/testscripts/memory.
</a><a href="#h8-0-11" id="h8-0-11" class="i">+    test_each_path! { in &quot;src/storage/testscripts/memory&quot; as scripts =&gt; test_goldenscript }
</a><a href="#h8-0-12" id="h8-0-12" class="i">+
</a><a href="#h8-0-13" id="h8-0-13" class="i">+    fn test_goldenscript(path: &amp;std::path::Path) {
</a><a href="#h8-0-14" id="h8-0-14" class="i">+        goldenscript::run(&amp;mut Runner::new(Memory::new()), path).expect(&quot;goldenscript failed&quot;)
</a><a href="#h8-0-15" id="h8-0-15" class="i">+    }
</a> 
     super::super::engine::tests::test_engine!(Memory::new());
 }
<b>diff --git a/<a id="h9" href="../file/src/storage/testscripts/bitcask/compact.html">src/storage/testscripts/bitcask/compact</a> b/<a href="../file/src/storage/testscripts/bitcask/compact.html">src/storage/testscripts/bitcask/compact</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,137 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+# Tests compaction.
</a><a href="#h9-0-1" id="h9-0-1" class="i">+
</a><a href="#h9-0-2" id="h9-0-2" class="i">+# Write some initial data out of order, with some overwrites and deletes.
</a><a href="#h9-0-3" id="h9-0-3" class="i">+set foo=bar
</a><a href="#h9-0-4" id="h9-0-4" class="i">+set b=1
</a><a href="#h9-0-5" id="h9-0-5" class="i">+set b=2
</a><a href="#h9-0-6" id="h9-0-6" class="i">+set e=5
</a><a href="#h9-0-7" id="h9-0-7" class="i">+delete e
</a><a href="#h9-0-8" id="h9-0-8" class="i">+set c=0
</a><a href="#h9-0-9" id="h9-0-9" class="i">+delete c
</a><a href="#h9-0-10" id="h9-0-10" class="i">+set c=3
</a><a href="#h9-0-11" id="h9-0-11" class="i">+set &quot;&quot;=&quot;&quot;
</a><a href="#h9-0-12" id="h9-0-12" class="i">+set a=1
</a><a href="#h9-0-13" id="h9-0-13" class="i">+delete f
</a><a href="#h9-0-14" id="h9-0-14" class="i">+delete d
</a><a href="#h9-0-15" id="h9-0-15" class="i">+set d=4
</a><a href="#h9-0-16" id="h9-0-16" class="i">+scan
</a><a href="#h9-0-17" id="h9-0-17" class="i">+---
</a><a href="#h9-0-18" id="h9-0-18" class="i">+ → 
</a><a href="#h9-0-19" id="h9-0-19" class="i">+a → 1
</a><a href="#h9-0-20" id="h9-0-20" class="i">+b → 2
</a><a href="#h9-0-21" id="h9-0-21" class="i">+c → 3
</a><a href="#h9-0-22" id="h9-0-22" class="i">+d → 4
</a><a href="#h9-0-23" id="h9-0-23" class="i">+foo → bar
</a><a href="#h9-0-24" id="h9-0-24" class="i">+
</a><a href="#h9-0-25" id="h9-0-25" class="i">+# Show status.
</a><a href="#h9-0-26" id="h9-0-26" class="i">+status
</a><a href="#h9-0-27" id="h9-0-27" class="i">+---
</a><a href="#h9-0-28" id="h9-0-28" class="i">+Status {
</a><a href="#h9-0-29" id="h9-0-29" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h9-0-30" id="h9-0-30" class="i">+    keys: 6,
</a><a href="#h9-0-31" id="h9-0-31" class="i">+    size: 14,
</a><a href="#h9-0-32" id="h9-0-32" class="i">+    total_disk_size: 128,
</a><a href="#h9-0-33" id="h9-0-33" class="i">+    live_disk_size: 62,
</a><a href="#h9-0-34" id="h9-0-34" class="i">+    garbage_disk_size: 66,
</a><a href="#h9-0-35" id="h9-0-35" class="i">+}
</a><a href="#h9-0-36" id="h9-0-36" class="i">+
</a><a href="#h9-0-37" id="h9-0-37" class="i">+# Dump the log.
</a><a href="#h9-0-38" id="h9-0-38" class="i">+dump
</a><a href="#h9-0-39" id="h9-0-39" class="i">+---
</a><a href="#h9-0-40" id="h9-0-40" class="i">+0@0     keylen=3 [00000003] valuelen=3 [00000003]
</a><a href="#h9-0-41" id="h9-0-41" class="i">+14b     key=&quot;foo&quot; [666f6f] value=&quot;bar&quot; [626172]
</a><a href="#h9-0-42" id="h9-0-42" class="i">+--------
</a><a href="#h9-0-43" id="h9-0-43" class="i">+1@14    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-44" id="h9-0-44" class="i">+10b     key=&quot;b&quot; [62] value=&quot;1&quot; [31]
</a><a href="#h9-0-45" id="h9-0-45" class="i">+--------
</a><a href="#h9-0-46" id="h9-0-46" class="i">+2@24    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-47" id="h9-0-47" class="i">+10b     key=&quot;b&quot; [62] value=&quot;2&quot; [32]
</a><a href="#h9-0-48" id="h9-0-48" class="i">+--------
</a><a href="#h9-0-49" id="h9-0-49" class="i">+3@34    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-50" id="h9-0-50" class="i">+10b     key=&quot;e&quot; [65] value=&quot;5&quot; [35]
</a><a href="#h9-0-51" id="h9-0-51" class="i">+--------
</a><a href="#h9-0-52" id="h9-0-52" class="i">+4@44    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h9-0-53" id="h9-0-53" class="i">+9b      key=&quot;e&quot; [65] tombstone
</a><a href="#h9-0-54" id="h9-0-54" class="i">+--------
</a><a href="#h9-0-55" id="h9-0-55" class="i">+5@53    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-56" id="h9-0-56" class="i">+10b     key=&quot;c&quot; [63] value=&quot;0&quot; [30]
</a><a href="#h9-0-57" id="h9-0-57" class="i">+--------
</a><a href="#h9-0-58" id="h9-0-58" class="i">+6@63    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h9-0-59" id="h9-0-59" class="i">+9b      key=&quot;c&quot; [63] tombstone
</a><a href="#h9-0-60" id="h9-0-60" class="i">+--------
</a><a href="#h9-0-61" id="h9-0-61" class="i">+7@72    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-62" id="h9-0-62" class="i">+10b     key=&quot;c&quot; [63] value=&quot;3&quot; [33]
</a><a href="#h9-0-63" id="h9-0-63" class="i">+--------
</a><a href="#h9-0-64" id="h9-0-64" class="i">+8@82    keylen=0 [00000000] valuelen=0 [00000000]
</a><a href="#h9-0-65" id="h9-0-65" class="i">+8b      key=&quot;&quot; [] value=&quot;&quot; []
</a><a href="#h9-0-66" id="h9-0-66" class="i">+--------
</a><a href="#h9-0-67" id="h9-0-67" class="i">+9@90    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-68" id="h9-0-68" class="i">+10b     key=&quot;a&quot; [61] value=&quot;1&quot; [31]
</a><a href="#h9-0-69" id="h9-0-69" class="i">+--------
</a><a href="#h9-0-70" id="h9-0-70" class="i">+10@100  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h9-0-71" id="h9-0-71" class="i">+9b      key=&quot;f&quot; [66] tombstone
</a><a href="#h9-0-72" id="h9-0-72" class="i">+--------
</a><a href="#h9-0-73" id="h9-0-73" class="i">+11@109  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h9-0-74" id="h9-0-74" class="i">+9b      key=&quot;d&quot; [64] tombstone
</a><a href="#h9-0-75" id="h9-0-75" class="i">+--------
</a><a href="#h9-0-76" id="h9-0-76" class="i">+12@118  keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-77" id="h9-0-77" class="i">+10b     key=&quot;d&quot; [64] value=&quot;4&quot; [34]
</a><a href="#h9-0-78" id="h9-0-78" class="i">+
</a><a href="#h9-0-79" id="h9-0-79" class="i">+# Compact it.
</a><a href="#h9-0-80" id="h9-0-80" class="i">+compact
</a><a href="#h9-0-81" id="h9-0-81" class="i">+---
</a><a href="#h9-0-82" id="h9-0-82" class="i">+ok
</a><a href="#h9-0-83" id="h9-0-83" class="i">+
</a><a href="#h9-0-84" id="h9-0-84" class="i">+# Scan should still give same results.
</a><a href="#h9-0-85" id="h9-0-85" class="i">+scan
</a><a href="#h9-0-86" id="h9-0-86" class="i">+---
</a><a href="#h9-0-87" id="h9-0-87" class="i">+ → 
</a><a href="#h9-0-88" id="h9-0-88" class="i">+a → 1
</a><a href="#h9-0-89" id="h9-0-89" class="i">+b → 2
</a><a href="#h9-0-90" id="h9-0-90" class="i">+c → 3
</a><a href="#h9-0-91" id="h9-0-91" class="i">+d → 4
</a><a href="#h9-0-92" id="h9-0-92" class="i">+foo → bar
</a><a href="#h9-0-93" id="h9-0-93" class="i">+
</a><a href="#h9-0-94" id="h9-0-94" class="i">+# Status should show no garbage.
</a><a href="#h9-0-95" id="h9-0-95" class="i">+status
</a><a href="#h9-0-96" id="h9-0-96" class="i">+---
</a><a href="#h9-0-97" id="h9-0-97" class="i">+Status {
</a><a href="#h9-0-98" id="h9-0-98" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h9-0-99" id="h9-0-99" class="i">+    keys: 6,
</a><a href="#h9-0-100" id="h9-0-100" class="i">+    size: 14,
</a><a href="#h9-0-101" id="h9-0-101" class="i">+    total_disk_size: 62,
</a><a href="#h9-0-102" id="h9-0-102" class="i">+    live_disk_size: 62,
</a><a href="#h9-0-103" id="h9-0-103" class="i">+    garbage_disk_size: 0,
</a><a href="#h9-0-104" id="h9-0-104" class="i">+}
</a><a href="#h9-0-105" id="h9-0-105" class="i">+
</a><a href="#h9-0-106" id="h9-0-106" class="i">+# Dump the compacted log.
</a><a href="#h9-0-107" id="h9-0-107" class="i">+dump
</a><a href="#h9-0-108" id="h9-0-108" class="i">+---
</a><a href="#h9-0-109" id="h9-0-109" class="i">+0@0     keylen=0 [00000000] valuelen=0 [00000000]
</a><a href="#h9-0-110" id="h9-0-110" class="i">+8b      key=&quot;&quot; [] value=&quot;&quot; []
</a><a href="#h9-0-111" id="h9-0-111" class="i">+--------
</a><a href="#h9-0-112" id="h9-0-112" class="i">+1@8     keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-113" id="h9-0-113" class="i">+10b     key=&quot;a&quot; [61] value=&quot;1&quot; [31]
</a><a href="#h9-0-114" id="h9-0-114" class="i">+--------
</a><a href="#h9-0-115" id="h9-0-115" class="i">+2@18    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-116" id="h9-0-116" class="i">+10b     key=&quot;b&quot; [62] value=&quot;2&quot; [32]
</a><a href="#h9-0-117" id="h9-0-117" class="i">+--------
</a><a href="#h9-0-118" id="h9-0-118" class="i">+3@28    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-119" id="h9-0-119" class="i">+10b     key=&quot;c&quot; [63] value=&quot;3&quot; [33]
</a><a href="#h9-0-120" id="h9-0-120" class="i">+--------
</a><a href="#h9-0-121" id="h9-0-121" class="i">+4@38    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h9-0-122" id="h9-0-122" class="i">+10b     key=&quot;d&quot; [64] value=&quot;4&quot; [34]
</a><a href="#h9-0-123" id="h9-0-123" class="i">+--------
</a><a href="#h9-0-124" id="h9-0-124" class="i">+5@48    keylen=3 [00000003] valuelen=3 [00000003]
</a><a href="#h9-0-125" id="h9-0-125" class="i">+14b     key=&quot;foo&quot; [666f6f] value=&quot;bar&quot; [626172]
</a><a href="#h9-0-126" id="h9-0-126" class="i">+
</a><a href="#h9-0-127" id="h9-0-127" class="i">+# Reopening the file works and shows the same data.
</a><a href="#h9-0-128" id="h9-0-128" class="i">+reopen
</a><a href="#h9-0-129" id="h9-0-129" class="i">+scan
</a><a href="#h9-0-130" id="h9-0-130" class="i">+---
</a><a href="#h9-0-131" id="h9-0-131" class="i">+ → 
</a><a href="#h9-0-132" id="h9-0-132" class="i">+a → 1
</a><a href="#h9-0-133" id="h9-0-133" class="i">+b → 2
</a><a href="#h9-0-134" id="h9-0-134" class="i">+c → 3
</a><a href="#h9-0-135" id="h9-0-135" class="i">+d → 4
</a><a href="#h9-0-136" id="h9-0-136" class="i">+foo → bar
</a><b>diff --git a/<a id="h10" href="../file/src/storage/testscripts/bitcask/compact_open.html">src/storage/testscripts/bitcask/compact_open</a> b/<a href="../file/src/storage/testscripts/bitcask/compact_open.html">src/storage/testscripts/bitcask/compact_open</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,83 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+# Tests that the log is auto-compacted on startup if the fraction of garbage
</a><a href="#h10-0-1" id="h10-0-1" class="i">+# exceeds the given threshold.
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+# Write some initial data out of order, with some overwrites and deletes.
</a><a href="#h10-0-4" id="h10-0-4" class="i">+set foo=bar
</a><a href="#h10-0-5" id="h10-0-5" class="i">+set b=1
</a><a href="#h10-0-6" id="h10-0-6" class="i">+set b=2
</a><a href="#h10-0-7" id="h10-0-7" class="i">+set e=5
</a><a href="#h10-0-8" id="h10-0-8" class="i">+delete e
</a><a href="#h10-0-9" id="h10-0-9" class="i">+set c=0
</a><a href="#h10-0-10" id="h10-0-10" class="i">+delete c
</a><a href="#h10-0-11" id="h10-0-11" class="i">+set c=3
</a><a href="#h10-0-12" id="h10-0-12" class="i">+set &quot;&quot;=&quot;&quot;
</a><a href="#h10-0-13" id="h10-0-13" class="i">+set a=1
</a><a href="#h10-0-14" id="h10-0-14" class="i">+delete f
</a><a href="#h10-0-15" id="h10-0-15" class="i">+delete d
</a><a href="#h10-0-16" id="h10-0-16" class="i">+set d=4
</a><a href="#h10-0-17" id="h10-0-17" class="i">+scan
</a><a href="#h10-0-18" id="h10-0-18" class="i">+---
</a><a href="#h10-0-19" id="h10-0-19" class="i">+ → 
</a><a href="#h10-0-20" id="h10-0-20" class="i">+a → 1
</a><a href="#h10-0-21" id="h10-0-21" class="i">+b → 2
</a><a href="#h10-0-22" id="h10-0-22" class="i">+c → 3
</a><a href="#h10-0-23" id="h10-0-23" class="i">+d → 4
</a><a href="#h10-0-24" id="h10-0-24" class="i">+foo → bar
</a><a href="#h10-0-25" id="h10-0-25" class="i">+
</a><a href="#h10-0-26" id="h10-0-26" class="i">+# Status shows the garbage fraction is 0.51.
</a><a href="#h10-0-27" id="h10-0-27" class="i">+status
</a><a href="#h10-0-28" id="h10-0-28" class="i">+---
</a><a href="#h10-0-29" id="h10-0-29" class="i">+Status {
</a><a href="#h10-0-30" id="h10-0-30" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h10-0-31" id="h10-0-31" class="i">+    keys: 6,
</a><a href="#h10-0-32" id="h10-0-32" class="i">+    size: 14,
</a><a href="#h10-0-33" id="h10-0-33" class="i">+    total_disk_size: 128,
</a><a href="#h10-0-34" id="h10-0-34" class="i">+    live_disk_size: 62,
</a><a href="#h10-0-35" id="h10-0-35" class="i">+    garbage_disk_size: 66,
</a><a href="#h10-0-36" id="h10-0-36" class="i">+}
</a><a href="#h10-0-37" id="h10-0-37" class="i">+
</a><a href="#h10-0-38" id="h10-0-38" class="i">+# Reopening with a garbage fraction of 0.6 does not compact.
</a><a href="#h10-0-39" id="h10-0-39" class="i">+reopen compact_fraction=0.6
</a><a href="#h10-0-40" id="h10-0-40" class="i">+status
</a><a href="#h10-0-41" id="h10-0-41" class="i">+---
</a><a href="#h10-0-42" id="h10-0-42" class="i">+Status {
</a><a href="#h10-0-43" id="h10-0-43" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h10-0-44" id="h10-0-44" class="i">+    keys: 6,
</a><a href="#h10-0-45" id="h10-0-45" class="i">+    size: 14,
</a><a href="#h10-0-46" id="h10-0-46" class="i">+    total_disk_size: 128,
</a><a href="#h10-0-47" id="h10-0-47" class="i">+    live_disk_size: 62,
</a><a href="#h10-0-48" id="h10-0-48" class="i">+    garbage_disk_size: 66,
</a><a href="#h10-0-49" id="h10-0-49" class="i">+}
</a><a href="#h10-0-50" id="h10-0-50" class="i">+
</a><a href="#h10-0-51" id="h10-0-51" class="i">+# Reopening with a fraction of 0.5 does compact.
</a><a href="#h10-0-52" id="h10-0-52" class="i">+reopen compact_fraction=0.5
</a><a href="#h10-0-53" id="h10-0-53" class="i">+status
</a><a href="#h10-0-54" id="h10-0-54" class="i">+---
</a><a href="#h10-0-55" id="h10-0-55" class="i">+Status {
</a><a href="#h10-0-56" id="h10-0-56" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h10-0-57" id="h10-0-57" class="i">+    keys: 6,
</a><a href="#h10-0-58" id="h10-0-58" class="i">+    size: 14,
</a><a href="#h10-0-59" id="h10-0-59" class="i">+    total_disk_size: 62,
</a><a href="#h10-0-60" id="h10-0-60" class="i">+    live_disk_size: 62,
</a><a href="#h10-0-61" id="h10-0-61" class="i">+    garbage_disk_size: 0,
</a><a href="#h10-0-62" id="h10-0-62" class="i">+}
</a><a href="#h10-0-63" id="h10-0-63" class="i">+
</a><a href="#h10-0-64" id="h10-0-64" class="i">+dump
</a><a href="#h10-0-65" id="h10-0-65" class="i">+---
</a><a href="#h10-0-66" id="h10-0-66" class="i">+0@0     keylen=0 [00000000] valuelen=0 [00000000]
</a><a href="#h10-0-67" id="h10-0-67" class="i">+8b      key=&quot;&quot; [] value=&quot;&quot; []
</a><a href="#h10-0-68" id="h10-0-68" class="i">+--------
</a><a href="#h10-0-69" id="h10-0-69" class="i">+1@8     keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h10-0-70" id="h10-0-70" class="i">+10b     key=&quot;a&quot; [61] value=&quot;1&quot; [31]
</a><a href="#h10-0-71" id="h10-0-71" class="i">+--------
</a><a href="#h10-0-72" id="h10-0-72" class="i">+2@18    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h10-0-73" id="h10-0-73" class="i">+10b     key=&quot;b&quot; [62] value=&quot;2&quot; [32]
</a><a href="#h10-0-74" id="h10-0-74" class="i">+--------
</a><a href="#h10-0-75" id="h10-0-75" class="i">+3@28    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h10-0-76" id="h10-0-76" class="i">+10b     key=&quot;c&quot; [63] value=&quot;3&quot; [33]
</a><a href="#h10-0-77" id="h10-0-77" class="i">+--------
</a><a href="#h10-0-78" id="h10-0-78" class="i">+4@38    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h10-0-79" id="h10-0-79" class="i">+10b     key=&quot;d&quot; [64] value=&quot;4&quot; [34]
</a><a href="#h10-0-80" id="h10-0-80" class="i">+--------
</a><a href="#h10-0-81" id="h10-0-81" class="i">+5@48    keylen=3 [00000003] valuelen=3 [00000003]
</a><a href="#h10-0-82" id="h10-0-82" class="i">+14b     key=&quot;foo&quot; [666f6f] value=&quot;bar&quot; [626172]
</a><b>diff --git a/<a id="h11" href="../file/src/storage/testscripts/bitcask/log.html">src/storage/testscripts/bitcask/log</a> b/<a href="../file/src/storage/testscripts/bitcask/log.html">src/storage/testscripts/bitcask/log</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,118 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+# Assert the raw structure of the BitCask log.
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+# Write some initial data out of order, with some overwrites and deletes.
</a><a href="#h11-0-3" id="h11-0-3" class="i">+set foo=bar
</a><a href="#h11-0-4" id="h11-0-4" class="i">+set b=1
</a><a href="#h11-0-5" id="h11-0-5" class="i">+set b=2
</a><a href="#h11-0-6" id="h11-0-6" class="i">+set e=5
</a><a href="#h11-0-7" id="h11-0-7" class="i">+delete e
</a><a href="#h11-0-8" id="h11-0-8" class="i">+set c=0
</a><a href="#h11-0-9" id="h11-0-9" class="i">+delete c
</a><a href="#h11-0-10" id="h11-0-10" class="i">+set c=3
</a><a href="#h11-0-11" id="h11-0-11" class="i">+set &quot;&quot;=&quot;&quot;
</a><a href="#h11-0-12" id="h11-0-12" class="i">+set a=1
</a><a href="#h11-0-13" id="h11-0-13" class="i">+delete f
</a><a href="#h11-0-14" id="h11-0-14" class="i">+delete d
</a><a href="#h11-0-15" id="h11-0-15" class="i">+set d=4
</a><a href="#h11-0-16" id="h11-0-16" class="i">+scan
</a><a href="#h11-0-17" id="h11-0-17" class="i">+---
</a><a href="#h11-0-18" id="h11-0-18" class="i">+ → 
</a><a href="#h11-0-19" id="h11-0-19" class="i">+a → 1
</a><a href="#h11-0-20" id="h11-0-20" class="i">+b → 2
</a><a href="#h11-0-21" id="h11-0-21" class="i">+c → 3
</a><a href="#h11-0-22" id="h11-0-22" class="i">+d → 4
</a><a href="#h11-0-23" id="h11-0-23" class="i">+foo → bar
</a><a href="#h11-0-24" id="h11-0-24" class="i">+
</a><a href="#h11-0-25" id="h11-0-25" class="i">+# Dump the log.
</a><a href="#h11-0-26" id="h11-0-26" class="i">+dump
</a><a href="#h11-0-27" id="h11-0-27" class="i">+---
</a><a href="#h11-0-28" id="h11-0-28" class="i">+0@0     keylen=3 [00000003] valuelen=3 [00000003]
</a><a href="#h11-0-29" id="h11-0-29" class="i">+14b     key=&quot;foo&quot; [666f6f] value=&quot;bar&quot; [626172]
</a><a href="#h11-0-30" id="h11-0-30" class="i">+--------
</a><a href="#h11-0-31" id="h11-0-31" class="i">+1@14    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-32" id="h11-0-32" class="i">+10b     key=&quot;b&quot; [62] value=&quot;1&quot; [31]
</a><a href="#h11-0-33" id="h11-0-33" class="i">+--------
</a><a href="#h11-0-34" id="h11-0-34" class="i">+2@24    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-35" id="h11-0-35" class="i">+10b     key=&quot;b&quot; [62] value=&quot;2&quot; [32]
</a><a href="#h11-0-36" id="h11-0-36" class="i">+--------
</a><a href="#h11-0-37" id="h11-0-37" class="i">+3@34    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-38" id="h11-0-38" class="i">+10b     key=&quot;e&quot; [65] value=&quot;5&quot; [35]
</a><a href="#h11-0-39" id="h11-0-39" class="i">+--------
</a><a href="#h11-0-40" id="h11-0-40" class="i">+4@44    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-41" id="h11-0-41" class="i">+9b      key=&quot;e&quot; [65] tombstone
</a><a href="#h11-0-42" id="h11-0-42" class="i">+--------
</a><a href="#h11-0-43" id="h11-0-43" class="i">+5@53    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-44" id="h11-0-44" class="i">+10b     key=&quot;c&quot; [63] value=&quot;0&quot; [30]
</a><a href="#h11-0-45" id="h11-0-45" class="i">+--------
</a><a href="#h11-0-46" id="h11-0-46" class="i">+6@63    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-47" id="h11-0-47" class="i">+9b      key=&quot;c&quot; [63] tombstone
</a><a href="#h11-0-48" id="h11-0-48" class="i">+--------
</a><a href="#h11-0-49" id="h11-0-49" class="i">+7@72    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-50" id="h11-0-50" class="i">+10b     key=&quot;c&quot; [63] value=&quot;3&quot; [33]
</a><a href="#h11-0-51" id="h11-0-51" class="i">+--------
</a><a href="#h11-0-52" id="h11-0-52" class="i">+8@82    keylen=0 [00000000] valuelen=0 [00000000]
</a><a href="#h11-0-53" id="h11-0-53" class="i">+8b      key=&quot;&quot; [] value=&quot;&quot; []
</a><a href="#h11-0-54" id="h11-0-54" class="i">+--------
</a><a href="#h11-0-55" id="h11-0-55" class="i">+9@90    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-56" id="h11-0-56" class="i">+10b     key=&quot;a&quot; [61] value=&quot;1&quot; [31]
</a><a href="#h11-0-57" id="h11-0-57" class="i">+--------
</a><a href="#h11-0-58" id="h11-0-58" class="i">+10@100  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-59" id="h11-0-59" class="i">+9b      key=&quot;f&quot; [66] tombstone
</a><a href="#h11-0-60" id="h11-0-60" class="i">+--------
</a><a href="#h11-0-61" id="h11-0-61" class="i">+11@109  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-62" id="h11-0-62" class="i">+9b      key=&quot;d&quot; [64] tombstone
</a><a href="#h11-0-63" id="h11-0-63" class="i">+--------
</a><a href="#h11-0-64" id="h11-0-64" class="i">+12@118  keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-65" id="h11-0-65" class="i">+10b     key=&quot;d&quot; [64] value=&quot;4&quot; [34]
</a><a href="#h11-0-66" id="h11-0-66" class="i">+
</a><a href="#h11-0-67" id="h11-0-67" class="i">+# Reopen the log, which shows the same data.
</a><a href="#h11-0-68" id="h11-0-68" class="i">+reopen
</a><a href="#h11-0-69" id="h11-0-69" class="i">+scan
</a><a href="#h11-0-70" id="h11-0-70" class="i">+---
</a><a href="#h11-0-71" id="h11-0-71" class="i">+ → 
</a><a href="#h11-0-72" id="h11-0-72" class="i">+a → 1
</a><a href="#h11-0-73" id="h11-0-73" class="i">+b → 2
</a><a href="#h11-0-74" id="h11-0-74" class="i">+c → 3
</a><a href="#h11-0-75" id="h11-0-75" class="i">+d → 4
</a><a href="#h11-0-76" id="h11-0-76" class="i">+foo → bar
</a><a href="#h11-0-77" id="h11-0-77" class="i">+
</a><a href="#h11-0-78" id="h11-0-78" class="i">+dump
</a><a href="#h11-0-79" id="h11-0-79" class="i">+---
</a><a href="#h11-0-80" id="h11-0-80" class="i">+0@0     keylen=3 [00000003] valuelen=3 [00000003]
</a><a href="#h11-0-81" id="h11-0-81" class="i">+14b     key=&quot;foo&quot; [666f6f] value=&quot;bar&quot; [626172]
</a><a href="#h11-0-82" id="h11-0-82" class="i">+--------
</a><a href="#h11-0-83" id="h11-0-83" class="i">+1@14    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-84" id="h11-0-84" class="i">+10b     key=&quot;b&quot; [62] value=&quot;1&quot; [31]
</a><a href="#h11-0-85" id="h11-0-85" class="i">+--------
</a><a href="#h11-0-86" id="h11-0-86" class="i">+2@24    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-87" id="h11-0-87" class="i">+10b     key=&quot;b&quot; [62] value=&quot;2&quot; [32]
</a><a href="#h11-0-88" id="h11-0-88" class="i">+--------
</a><a href="#h11-0-89" id="h11-0-89" class="i">+3@34    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-90" id="h11-0-90" class="i">+10b     key=&quot;e&quot; [65] value=&quot;5&quot; [35]
</a><a href="#h11-0-91" id="h11-0-91" class="i">+--------
</a><a href="#h11-0-92" id="h11-0-92" class="i">+4@44    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-93" id="h11-0-93" class="i">+9b      key=&quot;e&quot; [65] tombstone
</a><a href="#h11-0-94" id="h11-0-94" class="i">+--------
</a><a href="#h11-0-95" id="h11-0-95" class="i">+5@53    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-96" id="h11-0-96" class="i">+10b     key=&quot;c&quot; [63] value=&quot;0&quot; [30]
</a><a href="#h11-0-97" id="h11-0-97" class="i">+--------
</a><a href="#h11-0-98" id="h11-0-98" class="i">+6@63    keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-99" id="h11-0-99" class="i">+9b      key=&quot;c&quot; [63] tombstone
</a><a href="#h11-0-100" id="h11-0-100" class="i">+--------
</a><a href="#h11-0-101" id="h11-0-101" class="i">+7@72    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-102" id="h11-0-102" class="i">+10b     key=&quot;c&quot; [63] value=&quot;3&quot; [33]
</a><a href="#h11-0-103" id="h11-0-103" class="i">+--------
</a><a href="#h11-0-104" id="h11-0-104" class="i">+8@82    keylen=0 [00000000] valuelen=0 [00000000]
</a><a href="#h11-0-105" id="h11-0-105" class="i">+8b      key=&quot;&quot; [] value=&quot;&quot; []
</a><a href="#h11-0-106" id="h11-0-106" class="i">+--------
</a><a href="#h11-0-107" id="h11-0-107" class="i">+9@90    keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-108" id="h11-0-108" class="i">+10b     key=&quot;a&quot; [61] value=&quot;1&quot; [31]
</a><a href="#h11-0-109" id="h11-0-109" class="i">+--------
</a><a href="#h11-0-110" id="h11-0-110" class="i">+10@100  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-111" id="h11-0-111" class="i">+9b      key=&quot;f&quot; [66] tombstone
</a><a href="#h11-0-112" id="h11-0-112" class="i">+--------
</a><a href="#h11-0-113" id="h11-0-113" class="i">+11@109  keylen=1 [00000001] valuelen=-1 [ffffffff]
</a><a href="#h11-0-114" id="h11-0-114" class="i">+9b      key=&quot;d&quot; [64] tombstone
</a><a href="#h11-0-115" id="h11-0-115" class="i">+--------
</a><a href="#h11-0-116" id="h11-0-116" class="i">+12@118  keylen=1 [00000001] valuelen=1 [00000001]
</a><a href="#h11-0-117" id="h11-0-117" class="i">+10b     key=&quot;d&quot; [64] value=&quot;4&quot; [34]
</a><b>diff --git a/<a id="h12" href="../file/src/storage/testscripts/bitcask/status.html">src/storage/testscripts/bitcask/status</a> b/<a href="../file/src/storage/testscripts/bitcask/status.html">src/storage/testscripts/bitcask/status</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,40 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+# Tests status for BitCask engine.
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+set foo=123
</a><a href="#h12-0-3" id="h12-0-3" class="i">+set bar=1
</a><a href="#h12-0-4" id="h12-0-4" class="i">+delete bar
</a><a href="#h12-0-5" id="h12-0-5" class="i">+set baz=1
</a><a href="#h12-0-6" id="h12-0-6" class="i">+set baz=2
</a><a href="#h12-0-7" id="h12-0-7" class="i">+set baz=3
</a><a href="#h12-0-8" id="h12-0-8" class="i">+delete qux
</a><a href="#h12-0-9" id="h12-0-9" class="i">+---
</a><a href="#h12-0-10" id="h12-0-10" class="i">+ok
</a><a href="#h12-0-11" id="h12-0-11" class="i">+
</a><a href="#h12-0-12" id="h12-0-12" class="i">+scan
</a><a href="#h12-0-13" id="h12-0-13" class="i">+---
</a><a href="#h12-0-14" id="h12-0-14" class="i">+baz → 3
</a><a href="#h12-0-15" id="h12-0-15" class="i">+foo → 123
</a><a href="#h12-0-16" id="h12-0-16" class="i">+
</a><a href="#h12-0-17" id="h12-0-17" class="i">+status
</a><a href="#h12-0-18" id="h12-0-18" class="i">+---
</a><a href="#h12-0-19" id="h12-0-19" class="i">+Status {
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h12-0-21" id="h12-0-21" class="i">+    keys: 2,
</a><a href="#h12-0-22" id="h12-0-22" class="i">+    size: 10,
</a><a href="#h12-0-23" id="h12-0-23" class="i">+    total_disk_size: 84,
</a><a href="#h12-0-24" id="h12-0-24" class="i">+    live_disk_size: 26,
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    garbage_disk_size: 58,
</a><a href="#h12-0-26" id="h12-0-26" class="i">+}
</a><a href="#h12-0-27" id="h12-0-27" class="i">+
</a><a href="#h12-0-28" id="h12-0-28" class="i">+# Compact the log and show status again.
</a><a href="#h12-0-29" id="h12-0-29" class="i">+compact
</a><a href="#h12-0-30" id="h12-0-30" class="i">+status
</a><a href="#h12-0-31" id="h12-0-31" class="i">+---
</a><a href="#h12-0-32" id="h12-0-32" class="i">+Status {
</a><a href="#h12-0-33" id="h12-0-33" class="i">+    name: &quot;bitcask&quot;,
</a><a href="#h12-0-34" id="h12-0-34" class="i">+    keys: 2,
</a><a href="#h12-0-35" id="h12-0-35" class="i">+    size: 10,
</a><a href="#h12-0-36" id="h12-0-36" class="i">+    total_disk_size: 26,
</a><a href="#h12-0-37" id="h12-0-37" class="i">+    live_disk_size: 26,
</a><a href="#h12-0-38" id="h12-0-38" class="i">+    garbage_disk_size: 0,
</a><a href="#h12-0-39" id="h12-0-39" class="i">+}
</a><b>diff --git a/<a id="h13" href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a> b/<a href="../file/src/storage/testscripts/engine/keys.html">src/storage/testscripts/engine/keys</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,61 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+# Tests various keys.
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+# Keys are case-sensitive.
</a><a href="#h13-0-3" id="h13-0-3" class="i">+set a=1
</a><a href="#h13-0-4" id="h13-0-4" class="i">+get a
</a><a href="#h13-0-5" id="h13-0-5" class="i">+get A
</a><a href="#h13-0-6" id="h13-0-6" class="i">+---
</a><a href="#h13-0-7" id="h13-0-7" class="i">+a → 1
</a><a href="#h13-0-8" id="h13-0-8" class="i">+A → None
</a><a href="#h13-0-9" id="h13-0-9" class="i">+
</a><a href="#h13-0-10" id="h13-0-10" class="i">+set A=2
</a><a href="#h13-0-11" id="h13-0-11" class="i">+get a
</a><a href="#h13-0-12" id="h13-0-12" class="i">+get A
</a><a href="#h13-0-13" id="h13-0-13" class="i">+---
</a><a href="#h13-0-14" id="h13-0-14" class="i">+a → 1
</a><a href="#h13-0-15" id="h13-0-15" class="i">+A → 2
</a><a href="#h13-0-16" id="h13-0-16" class="i">+
</a><a href="#h13-0-17" id="h13-0-17" class="i">+delete a
</a><a href="#h13-0-18" id="h13-0-18" class="i">+delete A
</a><a href="#h13-0-19" id="h13-0-19" class="i">+scan
</a><a href="#h13-0-20" id="h13-0-20" class="i">+---
</a><a href="#h13-0-21" id="h13-0-21" class="i">+ok
</a><a href="#h13-0-22" id="h13-0-22" class="i">+
</a><a href="#h13-0-23" id="h13-0-23" class="i">+# Empty keys and values are valid.
</a><a href="#h13-0-24" id="h13-0-24" class="i">+set &quot;&quot;=&quot;&quot;
</a><a href="#h13-0-25" id="h13-0-25" class="i">+get &quot;&quot;
</a><a href="#h13-0-26" id="h13-0-26" class="i">+scan
</a><a href="#h13-0-27" id="h13-0-27" class="i">+delete &quot;&quot;
</a><a href="#h13-0-28" id="h13-0-28" class="i">+---
</a><a href="#h13-0-29" id="h13-0-29" class="i">+ → 
</a><a href="#h13-0-30" id="h13-0-30" class="i">+ → 
</a><a href="#h13-0-31" id="h13-0-31" class="i">+
</a><a href="#h13-0-32" id="h13-0-32" class="i">+scan
</a><a href="#h13-0-33" id="h13-0-33" class="i">+---
</a><a href="#h13-0-34" id="h13-0-34" class="i">+ok
</a><a href="#h13-0-35" id="h13-0-35" class="i">+
</a><a href="#h13-0-36" id="h13-0-36" class="i">+# NUL keys and values are valid.
</a><a href="#h13-0-37" id="h13-0-37" class="i">+set &quot;\0&quot;=&quot;\0&quot;
</a><a href="#h13-0-38" id="h13-0-38" class="i">+get &quot;\0&quot;
</a><a href="#h13-0-39" id="h13-0-39" class="i">+scan
</a><a href="#h13-0-40" id="h13-0-40" class="i">+delete &quot;\0&quot;
</a><a href="#h13-0-41" id="h13-0-41" class="i">+---
</a><a href="#h13-0-42" id="h13-0-42" class="i">+\x00 → \x00
</a><a href="#h13-0-43" id="h13-0-43" class="i">+\x00 → \x00
</a><a href="#h13-0-44" id="h13-0-44" class="i">+
</a><a href="#h13-0-45" id="h13-0-45" class="i">+scan
</a><a href="#h13-0-46" id="h13-0-46" class="i">+---
</a><a href="#h13-0-47" id="h13-0-47" class="i">+ok
</a><a href="#h13-0-48" id="h13-0-48" class="i">+
</a><a href="#h13-0-49" id="h13-0-49" class="i">+# Unicode keys and values work, but are shown as raw UTF-8 bytes.
</a><a href="#h13-0-50" id="h13-0-50" class="i">+set &quot;👋&quot;=&quot;👋&quot;
</a><a href="#h13-0-51" id="h13-0-51" class="i">+get &quot;👋&quot;
</a><a href="#h13-0-52" id="h13-0-52" class="i">+scan
</a><a href="#h13-0-53" id="h13-0-53" class="i">+delete &quot;👋&quot;
</a><a href="#h13-0-54" id="h13-0-54" class="i">+---
</a><a href="#h13-0-55" id="h13-0-55" class="i">+\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h13-0-56" id="h13-0-56" class="i">+\xf0\x9f\x91\x8b → \xf0\x9f\x91\x8b
</a><a href="#h13-0-57" id="h13-0-57" class="i">+
</a><a href="#h13-0-58" id="h13-0-58" class="i">+scan
</a><a href="#h13-0-59" id="h13-0-59" class="i">+---
</a><a href="#h13-0-60" id="h13-0-60" class="i">+ok
</a><b>diff --git a/<a id="h14" href="../file/src/storage/testscripts/engine/point.html">src/storage/testscripts/engine/point</a> b/<a href="../file/src/storage/testscripts/engine/point.html">src/storage/testscripts/engine/point</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,53 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+# Tests basic point operations.
</a><a href="#h14-0-1" id="h14-0-1" class="i">+
</a><a href="#h14-0-2" id="h14-0-2" class="i">+# Getting a missing key in an empty store should return None.
</a><a href="#h14-0-3" id="h14-0-3" class="i">+get a
</a><a href="#h14-0-4" id="h14-0-4" class="i">+---
</a><a href="#h14-0-5" id="h14-0-5" class="i">+a → None
</a><a href="#h14-0-6" id="h14-0-6" class="i">+
</a><a href="#h14-0-7" id="h14-0-7" class="i">+# Write a couple of keys.
</a><a href="#h14-0-8" id="h14-0-8" class="i">+set a=1
</a><a href="#h14-0-9" id="h14-0-9" class="i">+set b=2
</a><a href="#h14-0-10" id="h14-0-10" class="i">+---
</a><a href="#h14-0-11" id="h14-0-11" class="i">+ok
</a><a href="#h14-0-12" id="h14-0-12" class="i">+
</a><a href="#h14-0-13" id="h14-0-13" class="i">+# Reading the value back should return it. An unknown key should return None.
</a><a href="#h14-0-14" id="h14-0-14" class="i">+get a
</a><a href="#h14-0-15" id="h14-0-15" class="i">+get b
</a><a href="#h14-0-16" id="h14-0-16" class="i">+get c
</a><a href="#h14-0-17" id="h14-0-17" class="i">+---
</a><a href="#h14-0-18" id="h14-0-18" class="i">+a → 1
</a><a href="#h14-0-19" id="h14-0-19" class="i">+b → 2
</a><a href="#h14-0-20" id="h14-0-20" class="i">+c → None
</a><a href="#h14-0-21" id="h14-0-21" class="i">+
</a><a href="#h14-0-22" id="h14-0-22" class="i">+# Replacing a key should return the new value.
</a><a href="#h14-0-23" id="h14-0-23" class="i">+set a=foo
</a><a href="#h14-0-24" id="h14-0-24" class="i">+get a
</a><a href="#h14-0-25" id="h14-0-25" class="i">+---
</a><a href="#h14-0-26" id="h14-0-26" class="i">+a → foo
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+# Deleting a key should remove it, but not affect other keys.
</a><a href="#h14-0-29" id="h14-0-29" class="i">+delete a
</a><a href="#h14-0-30" id="h14-0-30" class="i">+get a
</a><a href="#h14-0-31" id="h14-0-31" class="i">+get b
</a><a href="#h14-0-32" id="h14-0-32" class="i">+---
</a><a href="#h14-0-33" id="h14-0-33" class="i">+a → None
</a><a href="#h14-0-34" id="h14-0-34" class="i">+b → 2
</a><a href="#h14-0-35" id="h14-0-35" class="i">+
</a><a href="#h14-0-36" id="h14-0-36" class="i">+# Deletes are idempotent.
</a><a href="#h14-0-37" id="h14-0-37" class="i">+delete a
</a><a href="#h14-0-38" id="h14-0-38" class="i">+get a
</a><a href="#h14-0-39" id="h14-0-39" class="i">+---
</a><a href="#h14-0-40" id="h14-0-40" class="i">+a → None
</a><a href="#h14-0-41" id="h14-0-41" class="i">+
</a><a href="#h14-0-42" id="h14-0-42" class="i">+# Writing a deleted key works fine.
</a><a href="#h14-0-43" id="h14-0-43" class="i">+set a=1
</a><a href="#h14-0-44" id="h14-0-44" class="i">+get a
</a><a href="#h14-0-45" id="h14-0-45" class="i">+---
</a><a href="#h14-0-46" id="h14-0-46" class="i">+a → 1
</a><a href="#h14-0-47" id="h14-0-47" class="i">+
</a><a href="#h14-0-48" id="h14-0-48" class="i">+# Scan the final state.
</a><a href="#h14-0-49" id="h14-0-49" class="i">+scan
</a><a href="#h14-0-50" id="h14-0-50" class="i">+---
</a><a href="#h14-0-51" id="h14-0-51" class="i">+a → 1
</a><a href="#h14-0-52" id="h14-0-52" class="i">+b → 2
</a><b>diff --git a/<a id="h15" href="../file/src/storage/testscripts/engine/scan.html">src/storage/testscripts/engine/scan</a> b/<a href="../file/src/storage/testscripts/engine/scan.html">src/storage/testscripts/engine/scan</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,60 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+# Tests range scans.
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+# Write some initial data.
</a><a href="#h15-0-3" id="h15-0-3" class="i">+set a=1
</a><a href="#h15-0-4" id="h15-0-4" class="i">+set b=2
</a><a href="#h15-0-5" id="h15-0-5" class="i">+set ba=21
</a><a href="#h15-0-6" id="h15-0-6" class="i">+set bb=22
</a><a href="#h15-0-7" id="h15-0-7" class="i">+set c=3
</a><a href="#h15-0-8" id="h15-0-8" class="i">+set C=3
</a><a href="#h15-0-9" id="h15-0-9" class="i">+---
</a><a href="#h15-0-10" id="h15-0-10" class="i">+ok
</a><a href="#h15-0-11" id="h15-0-11" class="i">+
</a><a href="#h15-0-12" id="h15-0-12" class="i">+# Forward and reverse scans.
</a><a href="#h15-0-13" id="h15-0-13" class="i">+scan
</a><a href="#h15-0-14" id="h15-0-14" class="i">+---
</a><a href="#h15-0-15" id="h15-0-15" class="i">+C → 3
</a><a href="#h15-0-16" id="h15-0-16" class="i">+a → 1
</a><a href="#h15-0-17" id="h15-0-17" class="i">+b → 2
</a><a href="#h15-0-18" id="h15-0-18" class="i">+ba → 21
</a><a href="#h15-0-19" id="h15-0-19" class="i">+bb → 22
</a><a href="#h15-0-20" id="h15-0-20" class="i">+c → 3
</a><a href="#h15-0-21" id="h15-0-21" class="i">+
</a><a href="#h15-0-22" id="h15-0-22" class="i">+scan reverse=true
</a><a href="#h15-0-23" id="h15-0-23" class="i">+---
</a><a href="#h15-0-24" id="h15-0-24" class="i">+c → 3
</a><a href="#h15-0-25" id="h15-0-25" class="i">+bb → 22
</a><a href="#h15-0-26" id="h15-0-26" class="i">+ba → 21
</a><a href="#h15-0-27" id="h15-0-27" class="i">+b → 2
</a><a href="#h15-0-28" id="h15-0-28" class="i">+a → 1
</a><a href="#h15-0-29" id="h15-0-29" class="i">+C → 3
</a><a href="#h15-0-30" id="h15-0-30" class="i">+
</a><a href="#h15-0-31" id="h15-0-31" class="i">+# Inclusive and exclusive ranges.
</a><a href="#h15-0-32" id="h15-0-32" class="i">+scan b..bb
</a><a href="#h15-0-33" id="h15-0-33" class="i">+---
</a><a href="#h15-0-34" id="h15-0-34" class="i">+b → 2
</a><a href="#h15-0-35" id="h15-0-35" class="i">+ba → 21
</a><a href="#h15-0-36" id="h15-0-36" class="i">+
</a><a href="#h15-0-37" id="h15-0-37" class="i">+scan &quot;b..=bb&quot;
</a><a href="#h15-0-38" id="h15-0-38" class="i">+---
</a><a href="#h15-0-39" id="h15-0-39" class="i">+b → 2
</a><a href="#h15-0-40" id="h15-0-40" class="i">+ba → 21
</a><a href="#h15-0-41" id="h15-0-41" class="i">+bb → 22
</a><a href="#h15-0-42" id="h15-0-42" class="i">+
</a><a href="#h15-0-43" id="h15-0-43" class="i">+scan &quot;b..=bb&quot; reverse=true
</a><a href="#h15-0-44" id="h15-0-44" class="i">+---
</a><a href="#h15-0-45" id="h15-0-45" class="i">+bb → 22
</a><a href="#h15-0-46" id="h15-0-46" class="i">+ba → 21
</a><a href="#h15-0-47" id="h15-0-47" class="i">+b → 2
</a><a href="#h15-0-48" id="h15-0-48" class="i">+
</a><a href="#h15-0-49" id="h15-0-49" class="i">+# Open ranges.
</a><a href="#h15-0-50" id="h15-0-50" class="i">+scan bb..
</a><a href="#h15-0-51" id="h15-0-51" class="i">+---
</a><a href="#h15-0-52" id="h15-0-52" class="i">+bb → 22
</a><a href="#h15-0-53" id="h15-0-53" class="i">+c → 3
</a><a href="#h15-0-54" id="h15-0-54" class="i">+
</a><a href="#h15-0-55" id="h15-0-55" class="i">+scan &quot;..=b&quot;
</a><a href="#h15-0-56" id="h15-0-56" class="i">+---
</a><a href="#h15-0-57" id="h15-0-57" class="i">+C → 3
</a><a href="#h15-0-58" id="h15-0-58" class="i">+a → 1
</a><a href="#h15-0-59" id="h15-0-59" class="i">+b → 2
</a><b>diff --git a/<a id="h16" href="../file/src/storage/testscripts/engine/scan_prefix.html">src/storage/testscripts/engine/scan_prefix</a> b/<a href="../file/src/storage/testscripts/engine/scan_prefix.html">src/storage/testscripts/engine/scan_prefix</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,111 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+# Tests prefix scans.
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+# Set up an initial dataset of keys with overlapping or adjacent prefixes.
</a><a href="#h16-0-3" id="h16-0-3" class="i">+set a=1
</a><a href="#h16-0-4" id="h16-0-4" class="i">+set b=2
</a><a href="#h16-0-5" id="h16-0-5" class="i">+set ba=21
</a><a href="#h16-0-6" id="h16-0-6" class="i">+set bb=22
</a><a href="#h16-0-7" id="h16-0-7" class="i">+set &quot;b\xff&quot;=2f
</a><a href="#h16-0-8" id="h16-0-8" class="i">+set &quot;b\xff\x00&quot;=2f0
</a><a href="#h16-0-9" id="h16-0-9" class="i">+set &quot;b\xffb&quot;=2fb
</a><a href="#h16-0-10" id="h16-0-10" class="i">+set &quot;b\xff\xff&quot;=2ff
</a><a href="#h16-0-11" id="h16-0-11" class="i">+set c=3
</a><a href="#h16-0-12" id="h16-0-12" class="i">+set &quot;\xff&quot;=f
</a><a href="#h16-0-13" id="h16-0-13" class="i">+set &quot;\xff\xff&quot;=ff
</a><a href="#h16-0-14" id="h16-0-14" class="i">+set &quot;\xff\xff\xff&quot;=fff
</a><a href="#h16-0-15" id="h16-0-15" class="i">+set &quot;\xff\xff\xff\xff&quot;=ffff
</a><a href="#h16-0-16" id="h16-0-16" class="i">+scan
</a><a href="#h16-0-17" id="h16-0-17" class="i">+---
</a><a href="#h16-0-18" id="h16-0-18" class="i">+a → 1
</a><a href="#h16-0-19" id="h16-0-19" class="i">+b → 2
</a><a href="#h16-0-20" id="h16-0-20" class="i">+ba → 21
</a><a href="#h16-0-21" id="h16-0-21" class="i">+bb → 22
</a><a href="#h16-0-22" id="h16-0-22" class="i">+b\xff → 2f
</a><a href="#h16-0-23" id="h16-0-23" class="i">+b\xff\x00 → 2f0
</a><a href="#h16-0-24" id="h16-0-24" class="i">+b\xffb → 2fb
</a><a href="#h16-0-25" id="h16-0-25" class="i">+b\xff\xff → 2ff
</a><a href="#h16-0-26" id="h16-0-26" class="i">+c → 3
</a><a href="#h16-0-27" id="h16-0-27" class="i">+\xff → f
</a><a href="#h16-0-28" id="h16-0-28" class="i">+\xff\xff → ff
</a><a href="#h16-0-29" id="h16-0-29" class="i">+\xff\xff\xff → fff
</a><a href="#h16-0-30" id="h16-0-30" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-31" id="h16-0-31" class="i">+
</a><a href="#h16-0-32" id="h16-0-32" class="i">+# An empty prefix returns everything.
</a><a href="#h16-0-33" id="h16-0-33" class="i">+scan_prefix &quot;&quot;
</a><a href="#h16-0-34" id="h16-0-34" class="i">+---
</a><a href="#h16-0-35" id="h16-0-35" class="i">+a → 1
</a><a href="#h16-0-36" id="h16-0-36" class="i">+b → 2
</a><a href="#h16-0-37" id="h16-0-37" class="i">+ba → 21
</a><a href="#h16-0-38" id="h16-0-38" class="i">+bb → 22
</a><a href="#h16-0-39" id="h16-0-39" class="i">+b\xff → 2f
</a><a href="#h16-0-40" id="h16-0-40" class="i">+b\xff\x00 → 2f0
</a><a href="#h16-0-41" id="h16-0-41" class="i">+b\xffb → 2fb
</a><a href="#h16-0-42" id="h16-0-42" class="i">+b\xff\xff → 2ff
</a><a href="#h16-0-43" id="h16-0-43" class="i">+c → 3
</a><a href="#h16-0-44" id="h16-0-44" class="i">+\xff → f
</a><a href="#h16-0-45" id="h16-0-45" class="i">+\xff\xff → ff
</a><a href="#h16-0-46" id="h16-0-46" class="i">+\xff\xff\xff → fff
</a><a href="#h16-0-47" id="h16-0-47" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-48" id="h16-0-48" class="i">+
</a><a href="#h16-0-49" id="h16-0-49" class="i">+# A missing prefix returns nothing.
</a><a href="#h16-0-50" id="h16-0-50" class="i">+scan_prefix bx
</a><a href="#h16-0-51" id="h16-0-51" class="i">+---
</a><a href="#h16-0-52" id="h16-0-52" class="i">+ok
</a><a href="#h16-0-53" id="h16-0-53" class="i">+
</a><a href="#h16-0-54" id="h16-0-54" class="i">+# Various prefixes under b. In particular, this tests that the bounds generation
</a><a href="#h16-0-55" id="h16-0-55" class="i">+# handles 0xff bytes properly.
</a><a href="#h16-0-56" id="h16-0-56" class="i">+scan_prefix b
</a><a href="#h16-0-57" id="h16-0-57" class="i">+---
</a><a href="#h16-0-58" id="h16-0-58" class="i">+b → 2
</a><a href="#h16-0-59" id="h16-0-59" class="i">+ba → 21
</a><a href="#h16-0-60" id="h16-0-60" class="i">+bb → 22
</a><a href="#h16-0-61" id="h16-0-61" class="i">+b\xff → 2f
</a><a href="#h16-0-62" id="h16-0-62" class="i">+b\xff\x00 → 2f0
</a><a href="#h16-0-63" id="h16-0-63" class="i">+b\xffb → 2fb
</a><a href="#h16-0-64" id="h16-0-64" class="i">+b\xff\xff → 2ff
</a><a href="#h16-0-65" id="h16-0-65" class="i">+
</a><a href="#h16-0-66" id="h16-0-66" class="i">+scan_prefix bb
</a><a href="#h16-0-67" id="h16-0-67" class="i">+---
</a><a href="#h16-0-68" id="h16-0-68" class="i">+bb → 22
</a><a href="#h16-0-69" id="h16-0-69" class="i">+
</a><a href="#h16-0-70" id="h16-0-70" class="i">+scan_prefix &quot;b\xff&quot;
</a><a href="#h16-0-71" id="h16-0-71" class="i">+---
</a><a href="#h16-0-72" id="h16-0-72" class="i">+b\xff → 2f
</a><a href="#h16-0-73" id="h16-0-73" class="i">+b\xff\x00 → 2f0
</a><a href="#h16-0-74" id="h16-0-74" class="i">+b\xffb → 2fb
</a><a href="#h16-0-75" id="h16-0-75" class="i">+b\xff\xff → 2ff
</a><a href="#h16-0-76" id="h16-0-76" class="i">+
</a><a href="#h16-0-77" id="h16-0-77" class="i">+scan_prefix &quot;b\xff\x00&quot;
</a><a href="#h16-0-78" id="h16-0-78" class="i">+---
</a><a href="#h16-0-79" id="h16-0-79" class="i">+b\xff\x00 → 2f0
</a><a href="#h16-0-80" id="h16-0-80" class="i">+
</a><a href="#h16-0-81" id="h16-0-81" class="i">+scan_prefix &quot;b\xff\xff&quot;
</a><a href="#h16-0-82" id="h16-0-82" class="i">+---
</a><a href="#h16-0-83" id="h16-0-83" class="i">+b\xff\xff → 2ff
</a><a href="#h16-0-84" id="h16-0-84" class="i">+
</a><a href="#h16-0-85" id="h16-0-85" class="i">+# Chains of \xff prefixes.
</a><a href="#h16-0-86" id="h16-0-86" class="i">+scan_prefix &quot;\xff&quot;
</a><a href="#h16-0-87" id="h16-0-87" class="i">+---
</a><a href="#h16-0-88" id="h16-0-88" class="i">+\xff → f
</a><a href="#h16-0-89" id="h16-0-89" class="i">+\xff\xff → ff
</a><a href="#h16-0-90" id="h16-0-90" class="i">+\xff\xff\xff → fff
</a><a href="#h16-0-91" id="h16-0-91" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-92" id="h16-0-92" class="i">+
</a><a href="#h16-0-93" id="h16-0-93" class="i">+scan_prefix &quot;\xff\xff&quot;
</a><a href="#h16-0-94" id="h16-0-94" class="i">+---
</a><a href="#h16-0-95" id="h16-0-95" class="i">+\xff\xff → ff
</a><a href="#h16-0-96" id="h16-0-96" class="i">+\xff\xff\xff → fff
</a><a href="#h16-0-97" id="h16-0-97" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-98" id="h16-0-98" class="i">+
</a><a href="#h16-0-99" id="h16-0-99" class="i">+scan_prefix &quot;\xff\xff\xff&quot;
</a><a href="#h16-0-100" id="h16-0-100" class="i">+---
</a><a href="#h16-0-101" id="h16-0-101" class="i">+\xff\xff\xff → fff
</a><a href="#h16-0-102" id="h16-0-102" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-103" id="h16-0-103" class="i">+
</a><a href="#h16-0-104" id="h16-0-104" class="i">+scan_prefix &quot;\xff\xff\xff\xff&quot;
</a><a href="#h16-0-105" id="h16-0-105" class="i">+---
</a><a href="#h16-0-106" id="h16-0-106" class="i">+\xff\xff\xff\xff → ffff
</a><a href="#h16-0-107" id="h16-0-107" class="i">+
</a><a href="#h16-0-108" id="h16-0-108" class="i">+scan_prefix &quot;\xff\xff\xff\xff\xff&quot;
</a><a href="#h16-0-109" id="h16-0-109" class="i">+---
</a><a href="#h16-0-110" id="h16-0-110" class="i">+ok
</a><b>diff --git a/<a id="h17" href="../file/src/storage/testscripts/memory/status.html">src/storage/testscripts/memory/status</a> b/<a href="../file/src/storage/testscripts/memory/status.html">src/storage/testscripts/memory/status</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,22 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+# Tests status for Memory engine.
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+set foo=123
</a><a href="#h17-0-3" id="h17-0-3" class="i">+set bar=1
</a><a href="#h17-0-4" id="h17-0-4" class="i">+delete bar
</a><a href="#h17-0-5" id="h17-0-5" class="i">+set baz=1
</a><a href="#h17-0-6" id="h17-0-6" class="i">+set baz=2
</a><a href="#h17-0-7" id="h17-0-7" class="i">+set baz=3
</a><a href="#h17-0-8" id="h17-0-8" class="i">+delete qux
</a><a href="#h17-0-9" id="h17-0-9" class="i">+---
</a><a href="#h17-0-10" id="h17-0-10" class="i">+ok
</a><a href="#h17-0-11" id="h17-0-11" class="i">+
</a><a href="#h17-0-12" id="h17-0-12" class="i">+status
</a><a href="#h17-0-13" id="h17-0-13" class="i">+---
</a><a href="#h17-0-14" id="h17-0-14" class="i">+Status {
</a><a href="#h17-0-15" id="h17-0-15" class="i">+    name: &quot;memory&quot;,
</a><a href="#h17-0-16" id="h17-0-16" class="i">+    keys: 2,
</a><a href="#h17-0-17" id="h17-0-17" class="i">+    size: 10,
</a><a href="#h17-0-18" id="h17-0-18" class="i">+    total_disk_size: 0,
</a><a href="#h17-0-19" id="h17-0-19" class="i">+    live_disk_size: 0,
</a><a href="#h17-0-20" id="h17-0-20" class="i">+    garbage_disk_size: 0,
</a><a href="#h17-0-21" id="h17-0-21" class="i">+}
</a></pre>
</div>
</body>
</html>
