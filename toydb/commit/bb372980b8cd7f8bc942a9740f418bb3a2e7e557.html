<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: rewrote expression environment handling - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/bb372980b8cd7f8bc942a9740f418bb3a2e7e557.html">bb372980b8cd7f8bc942a9740f418bb3a2e7e557</a>
<b>parent</b> <a href="../commit/be92b05a75dec76f05b4a52fa60bb0f4ba8e39e3.html">be92b05a75dec76f05b4a52fa60bb0f4ba8e39e3</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 12 Apr 2020 16:37:21 +0200

sql: rewrote expression environment handling

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/execution/insert.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/execution/mod.rs</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/execution/update.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/plan/optimizer.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/plan/planner.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/schema.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/sql/types/expression.rs</a></td><td> | </td><td class="num">118</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">tests/sql/query/order_field_ambiguous</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">tests/sql/query/where_field_ambiguous</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>9 files changed, 109 insertions(+), 93 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/execution/insert.rs.html">src/sql/execution/insert.rs</a> b/<a href="../file/src/sql/execution/insert.rs.html">src/sql/execution/insert.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,10 +1,8 @@
</a> use super::super::engine::Transaction;
<a href="#h0-0-1" id="h0-0-1" class="d">-use super::super::types::Expressions;
</a><a href="#h0-0-2" id="h0-0-2" class="i">+use super::super::types::{Environment, Expressions};
</a> use super::{Context, Executor, ResultSet};
 use crate::Error;
 
<a href="#h0-0-6" id="h0-0-6" class="d">-use std::collections::HashMap;
</a><a href="#h0-0-7" id="h0-0-7" class="d">-
</a> /// An INSERT executor
 pub struct Insert {
     /// The table to insert into
<a href="#h0-1" id="h0-1" class="h">@@ -24,7 +22,7 @@ impl Insert {
</a> impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Insert {
     fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet, Error&gt; {
         let table = ctx.txn.must_read_table(&amp;self.table)?;
<a href="#h0-1-3" id="h0-1-3" class="d">-        let env = HashMap::new();
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        let env = Environment::new();
</a>         let mut count = 0;
         for expressions in self.rows {
             let mut row = expressions
<b>diff --git a/<a id="h1" href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a> b/<a href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -126,8 +126,12 @@ impl ResultColumns {
</a>         Self { columns: columns.into_iter().map(|c| (c.relation, c.name)).collect() }
     }
 
<a href="#h1-0-3" id="h1-0-3" class="d">-    fn as_env&lt;&#39;b&gt;(&amp;&#39;b self, row: &amp;&#39;b [Value]) -&gt; ResultEnv&lt;&#39;b&gt; {
</a><a href="#h1-0-4" id="h1-0-4" class="d">-        ResultEnv { columns: &amp;self, row }
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    fn as_env&lt;&#39;b&gt;(&amp;&#39;b self, row: &amp;&#39;b [Value]) -&gt; Environment&lt;&#39;b&gt; {
</a><a href="#h1-0-6" id="h1-0-6" class="i">+        let mut env = Environment::new();
</a><a href="#h1-0-7" id="h1-0-7" class="i">+        for ((relation, field), value) in self.columns.iter().zip(row.iter()) {
</a><a href="#h1-0-8" id="h1-0-8" class="i">+            env.append(relation.as_deref(), field.as_deref(), value)
</a><a href="#h1-0-9" id="h1-0-9" class="i">+        }
</a><a href="#h1-0-10" id="h1-0-10" class="i">+        env
</a>     }
 
     fn format(&amp;self, relation: Option&lt;&amp;str&gt;, field: &amp;str) -&gt; String {
<a href="#h1-1" id="h1-1" class="h">@@ -203,20 +207,3 @@ impl ResultColumns {
</a>         self.columns.iter().map(|(_, c)| c.clone()).collect()
     }
 }
<a href="#h1-1-3" id="h1-1-3" class="d">-
</a><a href="#h1-1-4" id="h1-1-4" class="d">-// Environment for a result row
</a><a href="#h1-1-5" id="h1-1-5" class="d">-// FIXME This should be removed
</a><a href="#h1-1-6" id="h1-1-6" class="d">-struct ResultEnv&lt;&#39;a&gt; {
</a><a href="#h1-1-7" id="h1-1-7" class="d">-    columns: &amp;&#39;a ResultColumns,
</a><a href="#h1-1-8" id="h1-1-8" class="d">-    row: &amp;&#39;a [Value],
</a><a href="#h1-1-9" id="h1-1-9" class="d">-}
</a><a href="#h1-1-10" id="h1-1-10" class="d">-
</a><a href="#h1-1-11" id="h1-1-11" class="d">-impl&lt;&#39;a&gt; Environment for ResultEnv&lt;&#39;a&gt; {
</a><a href="#h1-1-12" id="h1-1-12" class="d">-    fn lookup(&amp;self, relation: Option&lt;&amp;str&gt;, field: &amp;str) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h1-1-13" id="h1-1-13" class="d">-        self.lookup_index(self.columns.index(relation, field)?)
</a><a href="#h1-1-14" id="h1-1-14" class="d">-    }
</a><a href="#h1-1-15" id="h1-1-15" class="d">-
</a><a href="#h1-1-16" id="h1-1-16" class="d">-    fn lookup_index(&amp;self, index: usize) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h1-1-17" id="h1-1-17" class="d">-        self.row.get(index).cloned().ok_or_else(|| Error::Value(&quot;index out of bounds&quot;.into()))
</a><a href="#h1-1-18" id="h1-1-18" class="d">-    }
</a><a href="#h1-1-19" id="h1-1-19" class="d">-}
</a><b>diff --git a/<a id="h2" href="../file/src/sql/execution/update.rs.html">src/sql/execution/update.rs</a> b/<a href="../file/src/sql/execution/update.rs.html">src/sql/execution/update.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -32,13 +32,14 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
</a>             ResultSet::Query { mut relation } =&gt; {
                 let table = ctx.txn.must_read_table(&amp;self.table)?;
                 let mut count = 0;
<a href="#h2-0-3" id="h2-0-3" class="d">-                while let Some(mut row) = relation.next().transpose()? {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                while let Some(row) = relation.next().transpose()? {
</a>                     let id = table.get_row_key(&amp;row)?;
<a href="#h2-0-6" id="h2-0-6" class="d">-                    let env = table.make_row_hashmap(row.clone());
</a><a href="#h2-0-7" id="h2-0-7" class="i">+                    let env = table.row_env(&amp;row);
</a><a href="#h2-0-8" id="h2-0-8" class="i">+                    let mut new = row.clone();
</a>                     for (field, expr) in &amp;self.expressions {
<a href="#h2-0-10" id="h2-0-10" class="d">-                        table.set_row_field(&amp;mut row, field, expr.evaluate(&amp;env)?)?;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+                        table.set_row_field(&amp;mut new, field, expr.evaluate(&amp;env)?)?;
</a>                     }
<a href="#h2-0-13" id="h2-0-13" class="d">-                    ctx.txn.update(&amp;table.name, &amp;id, row)?;
</a><a href="#h2-0-14" id="h2-0-14" class="i">+                    ctx.txn.update(&amp;table.name, &amp;id, new)?;
</a>                     count += 1
                 }
                 Ok(ResultSet::Update { count })
<b>diff --git a/<a id="h3" href="../file/src/sql/plan/optimizer.rs.html">src/sql/plan/optimizer.rs</a> b/<a href="../file/src/sql/plan/optimizer.rs.html">src/sql/plan/optimizer.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,9 +1,7 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::super::types::Expression;
</a><a href="#h3-0-1" id="h3-0-1" class="i">+use super::super::types::{Environment, Expression};
</a> use super::Node;
 use crate::Error;
 
<a href="#h3-0-5" id="h3-0-5" class="d">-use std::collections::HashMap;
</a><a href="#h3-0-6" id="h3-0-6" class="d">-
</a> /// A plan optimizer
 pub trait Optimizer {
     fn optimize(&amp;mut self, node: Node) -&gt; Result&lt;Node, Error&gt;;
<a href="#h3-1" id="h3-1" class="h">@@ -16,7 +14,7 @@ pub struct ConstantFolder;
</a> 
 impl Optimizer for ConstantFolder {
     fn optimize(&amp;mut self, node: Node) -&gt; Result&lt;Node, Error&gt; {
<a href="#h3-1-3" id="h3-1-3" class="d">-        let env = HashMap::new();
</a><a href="#h3-1-4" id="h3-1-4" class="i">+        let env = Environment::new();
</a>         node.transform(&amp;|n| Ok(n), &amp;|n| {
             n.transform_expressions(&amp;|e| Ok(e), &amp;|e| {
                 Ok(if e.is_constant() { Expression::Constant(e.evaluate(&amp;env)?) } else { e })
<b>diff --git a/<a id="h4" href="../file/src/sql/plan/planner.rs.html">src/sql/plan/planner.rs</a> b/<a href="../file/src/sql/plan/planner.rs.html">src/sql/plan/planner.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,11 +1,9 @@
</a> use super::super::parser::ast;
 use super::super::schema;
<a href="#h4-0-2" id="h4-0-2" class="d">-use super::super::types::{Expression, Expressions, Value};
</a><a href="#h4-0-3" id="h4-0-3" class="i">+use super::super::types::{Environment, Expression, Expressions, Value};
</a> use super::{Aggregate, Aggregates, Node, Plan};
 use crate::Error;
 
<a href="#h4-0-7" id="h4-0-7" class="d">-use std::collections::HashMap;
</a><a href="#h4-0-8" id="h4-0-8" class="d">-
</a> /// The plan builder
 pub struct Planner {}
 
<a href="#h4-1" id="h4-1" class="h">@@ -184,7 +182,7 @@ impl Planner {
</a>                     }
                     n = Node::Offset {
                         source: Box::new(n),
<a href="#h4-1-3" id="h4-1-3" class="d">-                        offset: match expr.evaluate(&amp;HashMap::new())? {
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                        offset: match expr.evaluate(&amp;Environment::new())? {
</a>                             Value::Integer(i) if i &gt;= 0 =&gt; i as u64,
                             v =&gt; {
                                 return Err(Error::Value(format!(&quot;Invalid value {} for offset&quot;, v)))
<a href="#h4-2" id="h4-2" class="h">@@ -199,7 +197,7 @@ impl Planner {
</a>                     }
                     n = Node::Limit {
                         source: Box::new(n),
<a href="#h4-2-3" id="h4-2-3" class="d">-                        limit: match expr.evaluate(&amp;HashMap::new())? {
</a><a href="#h4-2-4" id="h4-2-4" class="i">+                        limit: match expr.evaluate(&amp;Environment::new())? {
</a>                             Value::Integer(i) if i &gt;= 0 =&gt; i as u64,
                             v =&gt; {
                                 return Err(Error::Value(format!(&quot;Invalid value {} for limit&quot;, v)))
<a href="#h4-3" id="h4-3" class="h">@@ -297,7 +295,7 @@ impl Planner {
</a>                                 c.name
                             )));
                         }
<a href="#h4-3-3" id="h4-3-3" class="d">-                        Some(expr.evaluate(&amp;HashMap::new())?)
</a><a href="#h4-3-4" id="h4-3-4" class="i">+                        Some(expr.evaluate(&amp;Environment::new())?)
</a>                     } else if nullable {
                         Some(Value::Null)
                     } else {
<b>diff --git a/<a id="h5" href="../file/src/sql/schema.rs.html">src/sql/schema.rs</a> b/<a href="../file/src/sql/schema.rs.html">src/sql/schema.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,6 +1,6 @@
</a> use super::engine::Transaction;
 use super::parser::format_ident;
<a href="#h5-0-2" id="h5-0-2" class="d">-use super::types::{DataType, Row, Value};
</a><a href="#h5-0-3" id="h5-0-3" class="i">+use super::types::{DataType, Environment, Row, Value};
</a> use crate::Error;
 
 use std::collections::HashMap;
<a href="#h5-1" id="h5-1" class="h">@@ -142,15 +142,6 @@ impl Table {
</a>         Ok(row)
     }
 
<a href="#h5-1-3" id="h5-1-3" class="d">-    /// Makes a hashmap for a row
</a><a href="#h5-1-4" id="h5-1-4" class="d">-    pub fn make_row_hashmap(&amp;self, row: Row) -&gt; HashMap&lt;String, Value&gt; {
</a><a href="#h5-1-5" id="h5-1-5" class="d">-        self.columns
</a><a href="#h5-1-6" id="h5-1-6" class="d">-            .iter()
</a><a href="#h5-1-7" id="h5-1-7" class="d">-            .map(|c| c.name.clone())
</a><a href="#h5-1-8" id="h5-1-8" class="d">-            .zip(row.into_iter().chain(std::iter::repeat(Value::Null)))
</a><a href="#h5-1-9" id="h5-1-9" class="d">-            .collect()
</a><a href="#h5-1-10" id="h5-1-10" class="d">-    }
</a><a href="#h5-1-11" id="h5-1-11" class="d">-
</a>     /// Pads a row with default values where possible
     pub fn pad_row(&amp;self, mut row: Row) -&gt; Result&lt;Row, Error&gt; {
         for column in self.columns.iter().skip(row.len()) {
<a href="#h5-2" id="h5-2" class="h">@@ -163,6 +154,15 @@ impl Table {
</a>         Ok(row)
     }
 
<a href="#h5-2-3" id="h5-2-3" class="i">+    /// Creates an expression environment for a row in a table
</a><a href="#h5-2-4" id="h5-2-4" class="i">+    pub fn row_env&lt;&#39;a&gt;(&amp;&#39;a self, row: &amp;&#39;a Row) -&gt; Environment&lt;&#39;a&gt; {
</a><a href="#h5-2-5" id="h5-2-5" class="i">+        let mut env = Environment::new();
</a><a href="#h5-2-6" id="h5-2-6" class="i">+        for (c, v) in self.columns.iter().zip(row.iter().chain(std::iter::repeat(&amp;Value::Null))) {
</a><a href="#h5-2-7" id="h5-2-7" class="i">+            env.append(Some(&amp;self.name), Some(&amp;c.name), v)
</a><a href="#h5-2-8" id="h5-2-8" class="i">+        }
</a><a href="#h5-2-9" id="h5-2-9" class="i">+        env
</a><a href="#h5-2-10" id="h5-2-10" class="i">+    }
</a><a href="#h5-2-11" id="h5-2-11" class="i">+
</a>     /// Sets a named row field to a value
     pub fn set_row_field(&amp;self, row: &amp;mut Row, field: &amp;str, value: Value) -&gt; Result&lt;(), Error&gt; {
         *row.get_mut(self.get_column_index(field)?)
<b>diff --git a/<a id="h6" href="../file/src/sql/types/expression.rs.html">src/sql/types/expression.rs</a> b/<a href="../file/src/sql/types/expression.rs.html">src/sql/types/expression.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -2,10 +2,10 @@ use super::Value;
</a> use crate::Error;
 
 use regex::Regex;
<a href="#h6-0-3" id="h6-0-3" class="d">-use std::collections::HashMap;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+use std::collections::{HashMap, HashSet};
</a> 
 /// An expression, made up of constants and operations
<a href="#h6-0-7" id="h6-0-7" class="d">-#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h6-0-8" id="h6-0-8" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a> pub enum Expression {
     // Values
     Constant(Value),
<a href="#h6-1" id="h6-1" class="h">@@ -43,16 +43,16 @@ pub type Expressions = Vec&lt;Expression&gt;;
</a> 
 impl Expression {
     /// Evaluates an expression to a value, given an environment
<a href="#h6-1-3" id="h6-1-3" class="d">-    pub fn evaluate&lt;E: Environment&gt;(&amp;self, e: &amp;E) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    pub fn evaluate(&amp;self, env: &amp;Environment) -&gt; Result&lt;Value, Error&gt; {
</a>         use Value::*;
         Ok(match self {
             // Constant values
             Self::Constant(c) =&gt; c.clone(),
<a href="#h6-1-9" id="h6-1-9" class="d">-            Self::Field(r, f) =&gt; e.lookup(r.as_deref(), f)?,
</a><a href="#h6-1-10" id="h6-1-10" class="d">-            Self::Column(i) =&gt; e.lookup_index(*i)?,
</a><a href="#h6-1-11" id="h6-1-11" class="i">+            Self::Field(r, f) =&gt; env.lookup_field(r.as_deref(), f)?,
</a><a href="#h6-1-12" id="h6-1-12" class="i">+            Self::Column(i) =&gt; env.lookup_index(*i)?,
</a> 
             // Logical operations
<a href="#h6-1-15" id="h6-1-15" class="d">-            Self::And(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-1-16" id="h6-1-16" class="i">+            Self::And(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Boolean(lhs), Boolean(rhs)) =&gt; Boolean(lhs &amp;&amp; rhs),
                 (Boolean(lhs), Null) if !lhs =&gt; Boolean(false),
                 (Boolean(_), Null) =&gt; Null,
<a href="#h6-2" id="h6-2" class="h">@@ -61,12 +61,12 @@ impl Expression {
</a>                 (Null, Null) =&gt; Null,
                 (lhs, rhs) =&gt; return Err(Error::Value(format!(&quot;Can&#39;t and {} and {}&quot;, lhs, rhs))),
             },
<a href="#h6-2-3" id="h6-2-3" class="d">-            Self::Not(expr) =&gt; match expr.evaluate(e)? {
</a><a href="#h6-2-4" id="h6-2-4" class="i">+            Self::Not(expr) =&gt; match expr.evaluate(env)? {
</a>                 Boolean(b) =&gt; Boolean(!b),
                 Null =&gt; Null,
                 value =&gt; return Err(Error::Value(format!(&quot;Can&#39;t negate {}&quot;, value))),
             },
<a href="#h6-2-9" id="h6-2-9" class="d">-            Self::Or(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-2-10" id="h6-2-10" class="i">+            Self::Or(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Boolean(lhs), Boolean(rhs)) =&gt; Boolean(lhs || rhs),
                 (Boolean(lhs), Null) if lhs =&gt; Boolean(true),
                 (Boolean(_), Null) =&gt; Null,
<a href="#h6-3" id="h6-3" class="h">@@ -78,7 +78,7 @@ impl Expression {
</a> 
             // Comparison operations
             #[allow(clippy::float_cmp)] // Up to the user if they want to compare or not
<a href="#h6-3-3" id="h6-3-3" class="d">-            Self::Equal(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-3-4" id="h6-3-4" class="i">+            Self::Equal(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Boolean(lhs), Boolean(rhs)) =&gt; Boolean(lhs == rhs),
                 (Integer(lhs), Integer(rhs)) =&gt; Boolean(lhs == rhs),
                 (Integer(lhs), Float(rhs)) =&gt; Boolean(lhs as f64 == rhs),
<a href="#h6-4" id="h6-4" class="h">@@ -90,7 +90,7 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t compare {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-4-3" id="h6-4-3" class="d">-            Self::GreaterThan(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-4-4" id="h6-4-4" class="i">+            Self::GreaterThan(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 #[allow(clippy::bool_comparison)]
                 (Boolean(lhs), Boolean(rhs)) =&gt; Boolean(lhs &gt; rhs),
                 (Integer(lhs), Integer(rhs)) =&gt; Boolean(lhs &gt; rhs),
<a href="#h6-5" id="h6-5" class="h">@@ -103,7 +103,7 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t compare {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-5-3" id="h6-5-3" class="d">-            Self::LessThan(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-5-4" id="h6-5-4" class="i">+            Self::LessThan(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 #[allow(clippy::bool_comparison)]
                 (Boolean(lhs), Boolean(rhs)) =&gt; Boolean(lhs &lt; rhs),
                 (Integer(lhs), Integer(rhs)) =&gt; Boolean(lhs &lt; rhs),
<a href="#h6-6" id="h6-6" class="h">@@ -116,13 +116,13 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t compare {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-6-3" id="h6-6-3" class="d">-            Self::IsNull(expr) =&gt; match expr.evaluate(e)? {
</a><a href="#h6-6-4" id="h6-6-4" class="i">+            Self::IsNull(expr) =&gt; match expr.evaluate(env)? {
</a>                 Null =&gt; Boolean(true),
                 _ =&gt; Boolean(false),
             },
 
             // Mathematical operations
<a href="#h6-6-10" id="h6-6-10" class="d">-            Self::Add(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-6-11" id="h6-6-11" class="i">+            Self::Add(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Integer(lhs), Integer(rhs)) =&gt; Integer(
                     lhs.checked_add(rhs).ok_or_else(|| Error::Value(&quot;Integer overflow&quot;.into()))?,
                 ),
<a href="#h6-7" id="h6-7" class="h">@@ -136,13 +136,13 @@ impl Expression {
</a>                 (Null, Null) =&gt; Null,
                 (lhs, rhs) =&gt; return Err(Error::Value(format!(&quot;Can&#39;t add {} and {}&quot;, lhs, rhs))),
             },
<a href="#h6-7-3" id="h6-7-3" class="d">-            Self::Assert(expr) =&gt; match expr.evaluate(e)? {
</a><a href="#h6-7-4" id="h6-7-4" class="i">+            Self::Assert(expr) =&gt; match expr.evaluate(env)? {
</a>                 Float(f) =&gt; Float(f),
                 Integer(i) =&gt; Integer(i),
                 Null =&gt; Null,
                 expr =&gt; return Err(Error::Value(format!(&quot;Can&#39;t take the positive of {}&quot;, expr))),
             },
<a href="#h6-7-10" id="h6-7-10" class="d">-            Self::Divide(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-7-11" id="h6-7-11" class="i">+            Self::Divide(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Integer(_), Integer(rhs)) if rhs == 0 =&gt; {
                     return Err(Error::Value(&quot;Can&#39;t divide by zero&quot;.into()))
                 }
<a href="#h6-8" id="h6-8" class="h">@@ -159,7 +159,7 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t divide {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-8-3" id="h6-8-3" class="d">-            Self::Exponentiate(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-8-4" id="h6-8-4" class="i">+            Self::Exponentiate(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Integer(lhs), Integer(rhs)) if rhs &gt;= 0 =&gt; Integer(
                     lhs.checked_pow(rhs as u32)
                         .ok_or_else(|| Error::Value(&quot;Integer overflow&quot;.into()))?,
<a href="#h6-9" id="h6-9" class="h">@@ -177,7 +177,7 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t exponentiate {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-9-3" id="h6-9-3" class="d">-            Self::Factorial(expr) =&gt; match expr.evaluate(e)? {
</a><a href="#h6-9-4" id="h6-9-4" class="i">+            Self::Factorial(expr) =&gt; match expr.evaluate(env)? {
</a>                 Integer(i) if i &lt; 0 =&gt; {
                     return Err(Error::Value(&quot;Can&#39;t take factorial of negative number&quot;.into()))
                 }
<a href="#h6-10" id="h6-10" class="h">@@ -185,7 +185,7 @@ impl Expression {
</a>                 Null =&gt; Null,
                 value =&gt; return Err(Error::Value(format!(&quot;Can&#39;t take factorial of {}&quot;, value))),
             },
<a href="#h6-10-3" id="h6-10-3" class="d">-            Self::Modulo(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-10-4" id="h6-10-4" class="i">+            Self::Modulo(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 // This uses remainder semantics, like Postgres.
                 (Integer(_), Integer(rhs)) if rhs == 0 =&gt; {
                     return Err(Error::Value(&quot;Can&#39;t divide by zero&quot;.into()))
<a href="#h6-11" id="h6-11" class="h">@@ -203,7 +203,7 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t take modulo of {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-11-3" id="h6-11-3" class="d">-            Self::Multiply(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-11-4" id="h6-11-4" class="i">+            Self::Multiply(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Integer(lhs), Integer(rhs)) =&gt; Integer(
                     lhs.checked_mul(rhs).ok_or_else(|| Error::Value(&quot;Integer overflow&quot;.into()))?,
                 ),
<a href="#h6-12" id="h6-12" class="h">@@ -219,13 +219,13 @@ impl Expression {
</a>                     return Err(Error::Value(format!(&quot;Can&#39;t multiply {} and {}&quot;, lhs, rhs)))
                 }
             },
<a href="#h6-12-3" id="h6-12-3" class="d">-            Self::Negate(expr) =&gt; match expr.evaluate(e)? {
</a><a href="#h6-12-4" id="h6-12-4" class="i">+            Self::Negate(expr) =&gt; match expr.evaluate(env)? {
</a>                 Integer(i) =&gt; Integer(-i),
                 Float(f) =&gt; Float(-f),
                 Null =&gt; Null,
                 value =&gt; return Err(Error::Value(format!(&quot;Can&#39;t negate {}&quot;, value))),
             },
<a href="#h6-12-10" id="h6-12-10" class="d">-            Self::Subtract(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-12-11" id="h6-12-11" class="i">+            Self::Subtract(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (Integer(lhs), Integer(rhs)) =&gt; Integer(
                     lhs.checked_sub(rhs).ok_or_else(|| Error::Value(&quot;Integer overflow&quot;.into()))?,
                 ),
<a href="#h6-13" id="h6-13" class="h">@@ -243,7 +243,7 @@ impl Expression {
</a>             },
 
             // String operations
<a href="#h6-13-3" id="h6-13-3" class="d">-            Self::Like(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
</a><a href="#h6-13-4" id="h6-13-4" class="i">+            Self::Like(lhs, rhs) =&gt; match (lhs.evaluate(env)?, rhs.evaluate(env)?) {
</a>                 (String(lhs), String(rhs)) =&gt; Boolean(
                     Regex::new(&amp;format!(
                         &quot;^{}$&quot;,
<a href="#h6-14" id="h6-14" class="h">@@ -373,31 +373,65 @@ impl Expression {
</a> }
 
 /// An expression evaluation environment
<a href="#h6-14-3" id="h6-14-3" class="d">-/// FIXME Redesign this
</a><a href="#h6-14-4" id="h6-14-4" class="d">-pub trait Environment {
</a><a href="#h6-14-5" id="h6-14-5" class="d">-    /// Fetches a field value from the environment
</a><a href="#h6-14-6" id="h6-14-6" class="d">-    fn lookup(&amp;self, relation: Option&lt;&amp;str&gt;, field: &amp;str) -&gt; Result&lt;Value, Error&gt;;
</a><a href="#h6-14-7" id="h6-14-7" class="d">-
</a><a href="#h6-14-8" id="h6-14-8" class="d">-    /// Fetches a field value by index from the environment
</a><a href="#h6-14-9" id="h6-14-9" class="d">-    fn lookup_index(&amp;self, index: usize) -&gt; Result&lt;Value, Error&gt;;
</a><a href="#h6-14-10" id="h6-14-10" class="i">+pub struct Environment&lt;&#39;a&gt; {
</a><a href="#h6-14-11" id="h6-14-11" class="i">+    // For lookups by index (i.e. column number)
</a><a href="#h6-14-12" id="h6-14-12" class="i">+    index: Vec&lt;&amp;&#39;a Value&gt;,
</a><a href="#h6-14-13" id="h6-14-13" class="i">+    // For qualified lookups, with both relation and field name
</a><a href="#h6-14-14" id="h6-14-14" class="i">+    qualified: HashMap&lt;(&amp;&#39;a str, &amp;&#39;a str), &amp;&#39;a Value&gt;,
</a><a href="#h6-14-15" id="h6-14-15" class="i">+    // For unqualified lookups. Multiple fields with same unqualified name are ambiguous.
</a><a href="#h6-14-16" id="h6-14-16" class="i">+    unqualified: HashMap&lt;&amp;&#39;a str, &amp;&#39;a Value&gt;,
</a><a href="#h6-14-17" id="h6-14-17" class="i">+    ambiguous: HashSet&lt;&amp;&#39;a str&gt;,
</a> }
 
<a href="#h6-14-20" id="h6-14-20" class="d">-impl&lt;S: std::hash::BuildHasher&gt; Environment for HashMap&lt;String, Value, S&gt; {
</a><a href="#h6-14-21" id="h6-14-21" class="d">-    fn lookup(&amp;self, relation: Option&lt;&amp;str&gt;, field: &amp;str) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h6-14-22" id="h6-14-22" class="d">-        if relation.is_some() {
</a><a href="#h6-14-23" id="h6-14-23" class="d">-            Err(Error::Value(&quot;Qualified fields not supported for HashMap environments&quot;.into()))
</a><a href="#h6-14-24" id="h6-14-24" class="d">-        } else if let Some(value) = self.get(field) {
</a><a href="#h6-14-25" id="h6-14-25" class="d">-            Ok(value.clone())
</a><a href="#h6-14-26" id="h6-14-26" class="i">+impl&lt;&#39;a&gt; Environment&lt;&#39;a&gt; {
</a><a href="#h6-14-27" id="h6-14-27" class="i">+    /// Creates a new environment
</a><a href="#h6-14-28" id="h6-14-28" class="i">+    pub fn new() -&gt; Self {
</a><a href="#h6-14-29" id="h6-14-29" class="i">+        Self {
</a><a href="#h6-14-30" id="h6-14-30" class="i">+            index: Vec::new(),
</a><a href="#h6-14-31" id="h6-14-31" class="i">+            qualified: HashMap::new(),
</a><a href="#h6-14-32" id="h6-14-32" class="i">+            unqualified: HashMap::new(),
</a><a href="#h6-14-33" id="h6-14-33" class="i">+            ambiguous: HashSet::new(),
</a><a href="#h6-14-34" id="h6-14-34" class="i">+        }
</a><a href="#h6-14-35" id="h6-14-35" class="i">+    }
</a><a href="#h6-14-36" id="h6-14-36" class="i">+
</a><a href="#h6-14-37" id="h6-14-37" class="i">+    /// Appends a value to the environment
</a><a href="#h6-14-38" id="h6-14-38" class="i">+    pub fn append(&amp;mut self, relation: Option&lt;&amp;&#39;a str&gt;, field: Option&lt;&amp;&#39;a str&gt;, value: &amp;&#39;a Value) {
</a><a href="#h6-14-39" id="h6-14-39" class="i">+        self.index.push(value);
</a><a href="#h6-14-40" id="h6-14-40" class="i">+        if let Some(field) = field {
</a><a href="#h6-14-41" id="h6-14-41" class="i">+            if self.unqualified.contains_key(field) {
</a><a href="#h6-14-42" id="h6-14-42" class="i">+                self.unqualified.remove(field);
</a><a href="#h6-14-43" id="h6-14-43" class="i">+                self.ambiguous.insert(field);
</a><a href="#h6-14-44" id="h6-14-44" class="i">+            } else {
</a><a href="#h6-14-45" id="h6-14-45" class="i">+                self.unqualified.insert(field, value);
</a><a href="#h6-14-46" id="h6-14-46" class="i">+            }
</a><a href="#h6-14-47" id="h6-14-47" class="i">+        }
</a><a href="#h6-14-48" id="h6-14-48" class="i">+        if let (Some(relation), Some(field)) = (relation, field) {
</a><a href="#h6-14-49" id="h6-14-49" class="i">+            self.qualified.insert((relation, field), value);
</a><a href="#h6-14-50" id="h6-14-50" class="i">+        }
</a><a href="#h6-14-51" id="h6-14-51" class="i">+    }
</a><a href="#h6-14-52" id="h6-14-52" class="i">+
</a><a href="#h6-14-53" id="h6-14-53" class="i">+    /// Looks up a value by field
</a><a href="#h6-14-54" id="h6-14-54" class="i">+    pub fn lookup_field(&amp;self, relation: Option&lt;&amp;&#39;a str&gt;, field: &amp;&#39;a str) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h6-14-55" id="h6-14-55" class="i">+        if let Some(relation) = relation {
</a><a href="#h6-14-56" id="h6-14-56" class="i">+            match self.qualified.get(&amp;(relation, field)) {
</a><a href="#h6-14-57" id="h6-14-57" class="i">+                Some(r) =&gt; Ok(r.clone().clone()),
</a><a href="#h6-14-58" id="h6-14-58" class="i">+                None =&gt; Err(Error::Value(format!(&quot;Unknown field {}.{}&quot;, relation, field))),
</a><a href="#h6-14-59" id="h6-14-59" class="i">+            }
</a><a href="#h6-14-60" id="h6-14-60" class="i">+        } else if self.ambiguous.contains(field) {
</a><a href="#h6-14-61" id="h6-14-61" class="i">+            Err(Error::Value(format!(&quot;Ambiguous field {}&quot;, field)))
</a>         } else {
<a href="#h6-14-63" id="h6-14-63" class="d">-            Err(Error::Value(format!(&quot;Unknown field {}&quot;, field)))
</a><a href="#h6-14-64" id="h6-14-64" class="i">+            match self.unqualified.get(field) {
</a><a href="#h6-14-65" id="h6-14-65" class="i">+                Some(r) =&gt; Ok(r.clone().clone()),
</a><a href="#h6-14-66" id="h6-14-66" class="i">+                None =&gt; Err(Error::Value(format!(&quot;Unknown field {}&quot;, field))),
</a><a href="#h6-14-67" id="h6-14-67" class="i">+            }
</a>         }
     }
 
<a href="#h6-14-71" id="h6-14-71" class="d">-    fn lookup_index(&amp;self, index: usize) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h6-14-72" id="h6-14-72" class="d">-        self.iter()
</a><a href="#h6-14-73" id="h6-14-73" class="d">-            .nth(index)
</a><a href="#h6-14-74" id="h6-14-74" class="d">-            .map(|(_, value)| value)
</a><a href="#h6-14-75" id="h6-14-75" class="d">-            .cloned()
</a><a href="#h6-14-76" id="h6-14-76" class="d">-            .ok_or_else(|| Error::Value(&quot;Index out of bounds&quot;.into()))
</a><a href="#h6-14-77" id="h6-14-77" class="i">+    /// Looks up a value by index
</a><a href="#h6-14-78" id="h6-14-78" class="i">+    pub fn lookup_index(&amp;self, index: usize) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h6-14-79" id="h6-14-79" class="i">+        match self.index.get(index) {
</a><a href="#h6-14-80" id="h6-14-80" class="i">+            Some(r) =&gt; Ok(r.clone().clone()),
</a><a href="#h6-14-81" id="h6-14-81" class="i">+            None =&gt; Err(Error::Value(format!(&quot;Index {} out of bounds&quot;, index))),
</a><a href="#h6-14-82" id="h6-14-82" class="i">+        }
</a>     }
 }
<b>diff --git a/<a id="h7" href="../file/tests/sql/query/order_field_ambiguous.html">tests/sql/query/order_field_ambiguous</a> b/<a href="../file/tests/sql/query/order_field_ambiguous.html">tests/sql/query/order_field_ambiguous</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -142,4 +142,4 @@ Optimized plan: Plan(
</a> 
 Query: SELECT * FROM movies, genres WHERE movies.genre_id = genres.id ORDER BY id
 
<a href="#h7-0-3" id="h7-0-3" class="d">-Result: Value(&quot;Field reference id is ambiguous&quot;)
</a><a href="#h7-0-4" id="h7-0-4" class="d">-\ No newline at end of file
</a><a href="#h7-0-5" id="h7-0-5" class="i">+Result: Value(&quot;Ambiguous field id&quot;)
</a><a href="#h7-0-6" id="h7-0-6" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/tests/sql/query/where_field_ambiguous.html">tests/sql/query/where_field_ambiguous</a> b/<a href="../file/tests/sql/query/where_field_ambiguous.html">tests/sql/query/where_field_ambiguous</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -185,4 +185,4 @@ Optimized plan: Plan(
</a> 
 Query: SELECT movies.id, genres.id FROM movies, genres WHERE id &gt;= 3
 
<a href="#h8-0-3" id="h8-0-3" class="d">-Result: Value(&quot;Field reference id is ambiguous&quot;)
</a><a href="#h8-0-4" id="h8-0-4" class="d">-\ No newline at end of file
</a><a href="#h8-0-5" id="h8-0-5" class="i">+Result: Value(&quot;Ambiguous field id&quot;)
</a><a href="#h8-0-6" id="h8-0-6" class="i">+\ No newline at end of file
</a></pre>
</div>
</body>
</html>
