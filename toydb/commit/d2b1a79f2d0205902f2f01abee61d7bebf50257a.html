<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Remove `raft::Address::Local` - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d2b1a79f2d0205902f2f01abee61d7bebf50257a.html">d2b1a79f2d0205902f2f01abee61d7bebf50257a</a>
<b>parent</b> <a href="../commit/0349becbd8fc2abd67f5cafd7a2acc38a405ca72.html">0349becbd8fc2abd67f5cafd7a2acc38a405ca72</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 18 Nov 2023 21:44:47 +0100

Remove `raft::Address::Local`

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/follower.rs</a></td><td> | </td><td class="num">52</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/leader.rs</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/server.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/state.rs</a></td><td> | </td><td class="num">25</td><td><span class="i">++++++++++++++</span><span class="d">-----------</span></td></tr>
</table></pre><pre>7 files changed, 69 insertions(+), 74 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -11,8 +11,6 @@ pub enum Address {
</a>     /// A node with the specified node ID (local or remote). Valid both as
     /// sender and recipient.
     Node(NodeID),
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// The local node.
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    Local,
</a>     /// A local client.
     Client,
 }
<b>diff --git a/<a id="h1" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -172,7 +172,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h1-0-3" id="h1-0-3" class="d">-                from: Address::Local,
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
<a href="#h1-1" id="h1-1" class="h">@@ -197,7 +197,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h1-1-3" id="h1-1-3" class="d">-                from: Address::Local,
</a><a href="#h1-1-4" id="h1-1-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 4,
                 event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
<a href="#h1-2" id="h1-2" class="h">@@ -252,7 +252,7 @@ mod tests {
</a>         assert_eq!(
             node_rx.try_recv()?,
             Message {
<a href="#h1-2-3" id="h1-2-3" class="d">-                from: Address::Local,
</a><a href="#h1-2-4" id="h1-2-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Broadcast,
                 term: 3,
                 event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
<a href="#h1-3" id="h1-3" class="h">@@ -263,7 +263,7 @@ mod tests {
</a>             assert_eq!(
                 node_rx.try_recv()?,
                 Message {
<a href="#h1-3-3" id="h1-3-3" class="d">-                    from: Address::Local,
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(to),
                     term: 3,
                     event: Event::ReplicateEntries {
<a href="#h1-4" id="h1-4" class="h">@@ -288,7 +288,7 @@ mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h1-4-3" id="h1-4-3" class="d">-            to: Address::Local,
</a><a href="#h1-4-4" id="h1-4-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
         })?;
<a href="#h1-5" id="h1-5" class="h">@@ -296,7 +296,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h1-5-3" id="h1-5-3" class="d">-                from: Address::Local,
</a><a href="#h1-5-4" id="h1-5-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Client,
                 term: 3,
                 event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
<a href="#h1-6" id="h1-6" class="h">@@ -322,7 +322,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h1-6-3" id="h1-6-3" class="d">-                from: Address::Local,
</a><a href="#h1-6-4" id="h1-6-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Broadcast,
                 term: 4,
                 event: Event::SolicitVote { last_index: 3, last_term: 2 },
<b>diff --git a/<a id="h2" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -228,7 +228,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-0-3" id="h2-0-3" class="d">-                from: Address::Local,
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
<a href="#h2-1" id="h2-1" class="h">@@ -257,7 +257,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-1-3" id="h2-1-3" class="d">-                from: Address::Local,
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 3, has_committed: false },
<a href="#h2-2" id="h2-2" class="h">@@ -281,7 +281,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-2-3" id="h2-2-3" class="d">-                from: Address::Local,
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 5, has_committed: false },
<a href="#h2-3" id="h2-3" class="h">@@ -322,7 +322,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-3-3" id="h2-3-3" class="d">-                from: Address::Local,
</a><a href="#h2-3-4" id="h2-3-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(3),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
<a href="#h2-4" id="h2-4" class="h">@@ -351,7 +351,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-4-3" id="h2-4-3" class="d">-                from: Address::Local,
</a><a href="#h2-4-4" id="h2-4-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
<a href="#h2-5" id="h2-5" class="h">@@ -375,7 +375,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-5-3" id="h2-5-3" class="d">-                from: Address::Local,
</a><a href="#h2-5-4" id="h2-5-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(3),
                 term: 4,
                 event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
<a href="#h2-6" id="h2-6" class="h">@@ -422,7 +422,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-6-3" id="h2-6-3" class="d">-                from: Address::Local,
</a><a href="#h2-6-4" id="h2-6-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(3),
                 term: 3,
                 event: Event::GrantVote,
<a href="#h2-7" id="h2-7" class="h">@@ -441,7 +441,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-7-3" id="h2-7-3" class="d">-                from: Address::Local,
</a><a href="#h2-7-4" id="h2-7-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(3),
                 term: 3,
                 event: Event::GrantVote,
<a href="#h2-8" id="h2-8" class="h">@@ -552,7 +552,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-8-3" id="h2-8-3" class="d">-                from: Address::Local,
</a><a href="#h2-8-4" id="h2-8-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::AcceptEntries { last_index: 2 },
<a href="#h2-9" id="h2-9" class="h">@@ -589,7 +589,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-9-3" id="h2-9-3" class="d">-                from: Address::Local,
</a><a href="#h2-9-4" id="h2-9-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::AcceptEntries { last_index: 5 },
<a href="#h2-10" id="h2-10" class="h">@@ -625,7 +625,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-10-3" id="h2-10-3" class="d">-                from: Address::Local,
</a><a href="#h2-10-4" id="h2-10-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::AcceptEntries { last_index: 4 },
<a href="#h2-11" id="h2-11" class="h">@@ -661,7 +661,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-11-3" id="h2-11-3" class="d">-                from: Address::Local,
</a><a href="#h2-11-4" id="h2-11-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::AcceptEntries { last_index: 4 },
<a href="#h2-12" id="h2-12" class="h">@@ -697,7 +697,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-12-3" id="h2-12-3" class="d">-                from: Address::Local,
</a><a href="#h2-12-4" id="h2-12-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::AcceptEntries { last_index: 4 },
<a href="#h2-13" id="h2-13" class="h">@@ -729,7 +729,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-13-3" id="h2-13-3" class="d">-                from: Address::Local,
</a><a href="#h2-13-4" id="h2-13-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::RejectEntries,
<a href="#h2-14" id="h2-14" class="h">@@ -761,7 +761,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-14-3" id="h2-14-3" class="d">-                from: Address::Local,
</a><a href="#h2-14-4" id="h2-14-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::RejectEntries,
<a href="#h2-15" id="h2-15" class="h">@@ -779,7 +779,7 @@ pub mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h2-15-3" id="h2-15-3" class="d">-            to: Address::Local,
</a><a href="#h2-15-4" id="h2-15-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
         })?;
<a href="#h2-16" id="h2-16" class="h">@@ -791,7 +791,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-16-3" id="h2-16-3" class="d">-                from: Address::Local,
</a><a href="#h2-16-4" id="h2-16-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ClientRequest {
<a href="#h2-17" id="h2-17" class="h">@@ -815,7 +815,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-17-3" id="h2-17-3" class="d">-                from: Address::Local,
</a><a href="#h2-17-4" id="h2-17-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Client,
                 term: 3,
                 event: Event::ClientResponse {
<a href="#h2-18" id="h2-18" class="h">@@ -837,7 +837,7 @@ pub mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h2-18-3" id="h2-18-3" class="d">-            to: Address::Local,
</a><a href="#h2-18-4" id="h2-18-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
         })?;
<a href="#h2-19" id="h2-19" class="h">@@ -845,7 +845,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-19-3" id="h2-19-3" class="d">-                from: Address::Local,
</a><a href="#h2-19-4" id="h2-19-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Client,
                 term: 3,
                 event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
<a href="#h2-20" id="h2-20" class="h">@@ -863,7 +863,7 @@ pub mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h2-20-3" id="h2-20-3" class="d">-            to: Address::Local,
</a><a href="#h2-20-4" id="h2-20-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
         })?;
<a href="#h2-21" id="h2-21" class="h">@@ -875,7 +875,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-21-3" id="h2-21-3" class="d">-                from: Address::Local,
</a><a href="#h2-21-4" id="h2-21-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ClientRequest {
<a href="#h2-22" id="h2-22" class="h">@@ -898,13 +898,13 @@ pub mod tests {
</a>             &amp;mut node_rx,
             vec![
                 Message {
<a href="#h2-22-3" id="h2-22-3" class="d">-                    from: Address::Local,
</a><a href="#h2-22-4" id="h2-22-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Client,
                     term: 4,
                     event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) },
                 },
                 Message {
<a href="#h2-22-10" id="h2-22-10" class="d">-                    from: Address::Local,
</a><a href="#h2-22-11" id="h2-22-11" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(3),
                     term: 4,
                     event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
<a href="#h2-23" id="h2-23" class="h">@@ -940,7 +940,7 @@ pub mod tests {
</a>             assert_messages(
                 &amp;mut node_rx,
                 vec![Message {
<a href="#h2-23-3" id="h2-23-3" class="d">-                    from: Address::Local,
</a><a href="#h2-23-4" id="h2-23-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(2),
                     term: 3,
                     event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
<a href="#h2-24" id="h2-24" class="h">@@ -957,7 +957,7 @@ pub mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h2-24-3" id="h2-24-3" class="d">-                from: Address::Local,
</a><a href="#h2-24-4" id="h2-24-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Broadcast,
                 term: 4,
                 event: Event::SolicitVote { last_index: 3, last_term: 2 },
<b>diff --git a/<a id="h3" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -153,7 +153,7 @@ impl RoleNode&lt;Leader&gt; {
</a>                 self.state_tx.send(Instruction::Vote {
                     term: self.term,
                     index: commit_index,
<a href="#h3-0-3" id="h3-0-3" class="d">-                    address: Address::Local,
</a><a href="#h3-0-4" id="h3-0-4" class="i">+                    address: Address::Node(self.id),
</a>                 })?;
                 if !self.peers.is_empty() {
                     self.send(Address::Broadcast, Event::Heartbeat { commit_index, commit_term })?;
<a href="#h3-1" id="h3-1" class="h">@@ -294,7 +294,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h3-1-3" id="h3-1-3" class="d">-                from: Address::Local,
</a><a href="#h3-1-4" id="h3-1-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 3,
                 event: Event::ReplicateEntries { base_index: 5, base_term: 3, entries: vec![] },
<a href="#h3-2" id="h3-2" class="h">@@ -341,7 +341,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h3-2-3" id="h3-2-3" class="d">-                from: Address::Local,
</a><a href="#h3-2-4" id="h3-2-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 4,
                 event: Event::ConfirmLeader { commit_index: 7, has_committed: false },
<a href="#h3-3" id="h3-3" class="h">@@ -524,7 +524,7 @@ mod tests {
</a>             assert_messages(
                 &amp;mut node_rx,
                 vec![Message {
<a href="#h3-3-3" id="h3-3-3" class="d">-                    from: Address::Local,
</a><a href="#h3-3-4" id="h3-3-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(2),
                     term: 3,
                     event: Event::ReplicateEntries {
<a href="#h3-4" id="h3-4" class="h">@@ -551,7 +551,7 @@ mod tests {
</a>         let mut node: Node = leader.into();
         node = node.step(Message {
             from: Address::Client,
<a href="#h3-4-3" id="h3-4-3" class="d">-            to: Address::Local,
</a><a href="#h3-4-4" id="h3-4-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Query(vec![0xaf]) },
         })?;
<a href="#h3-5" id="h3-5" class="h">@@ -559,7 +559,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut node_rx,
             vec![Message {
<a href="#h3-5-3" id="h3-5-3" class="d">-                from: Address::Local,
</a><a href="#h3-5-4" id="h3-5-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Broadcast,
                 term: 3,
                 event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
<a href="#h3-6" id="h3-6" class="h">@@ -576,7 +576,7 @@ mod tests {
</a>                     index: 2,
                     quorum,
                 },
<a href="#h3-6-3" id="h3-6-3" class="d">-                Instruction::Vote { term: 3, index: 2, address: Address::Local },
</a><a href="#h3-6-4" id="h3-6-4" class="i">+                Instruction::Vote { term: 3, index: 2, address: Address::Node(1) },
</a>             ],
         );
         Ok(())
<a href="#h3-7" id="h3-7" class="h">@@ -591,7 +591,7 @@ mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h3-7-3" id="h3-7-3" class="d">-            to: Address::Local,
</a><a href="#h3-7-4" id="h3-7-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Mutate(vec![0xaf]) },
         })?;
<a href="#h3-8" id="h3-8" class="h">@@ -605,7 +605,7 @@ mod tests {
</a>             assert_eq!(
                 node_rx.try_recv()?,
                 Message {
<a href="#h3-8-3" id="h3-8-3" class="d">-                    from: Address::Local,
</a><a href="#h3-8-4" id="h3-8-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(peer),
                     term: 3,
                     event: Event::ReplicateEntries {
<a href="#h3-9" id="h3-9" class="h">@@ -633,7 +633,7 @@ mod tests {
</a> 
         node = node.step(Message {
             from: Address::Client,
<a href="#h3-9-3" id="h3-9-3" class="d">-            to: Address::Local,
</a><a href="#h3-9-4" id="h3-9-4" class="i">+            to: Address::Node(1),
</a>             term: 0,
             event: Event::ClientRequest { id: vec![0x01], request: Request::Status },
         })?;
<a href="#h3-10" id="h3-10" class="h">@@ -677,7 +677,7 @@ mod tests {
</a>             assert_eq!(
                 node_rx.try_recv()?,
                 Message {
<a href="#h3-10-3" id="h3-10-3" class="d">-                    from: Address::Local,
</a><a href="#h3-10-4" id="h3-10-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Broadcast,
                     term: 3,
                     event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
<b>diff --git a/<a id="h4" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -58,7 +58,7 @@ impl Node {
</a>         node_tx: mpsc::UnboundedSender&lt;Message&gt;,
     ) -&gt; Result&lt;Self&gt; {
         let (state_tx, state_rx) = mpsc::unbounded_channel();
<a href="#h4-0-3" id="h4-0-3" class="d">-        let mut driver = Driver::new(state_rx, node_tx.clone());
</a><a href="#h4-0-4" id="h4-0-4" class="i">+        let mut driver = Driver::new(id, state_rx, node_tx.clone());
</a>         driver.apply_log(&amp;mut *state, &amp;mut log)?;
         tokio::spawn(driver.drive(state));
 
<a href="#h4-1" id="h4-1" class="h">@@ -172,7 +172,7 @@ impl&lt;R&gt; RoleNode&lt;R&gt; {
</a> 
     /// Sends an event
     fn send(&amp;self, to: Address, event: Event) -&gt; Result&lt;()&gt; {
<a href="#h4-1-3" id="h4-1-3" class="d">-        let msg = Message { term: self.term, from: Address::Local, to, event };
</a><a href="#h4-1-4" id="h4-1-4" class="i">+        let msg = Message { term: self.term, from: Address::Node(self.id), to, event };
</a>         debug!(&quot;Sending {:?}&quot;, msg);
         Ok(self.node_tx.send(msg)?)
     }
<a href="#h4-2" id="h4-2" class="h">@@ -183,7 +183,6 @@ impl&lt;R&gt; RoleNode&lt;R&gt; {
</a>             Address::Broadcast =&gt; {
                 return Err(Error::Internal(&quot;Message from broadcast address&quot;.into()))
             }
<a href="#h4-2-3" id="h4-2-3" class="d">-            Address::Local =&gt; return Err(Error::Internal(&quot;Message from local node&quot;.into())),
</a>             Address::Client if !matches!(msg.event, Event::ClientRequest { .. }) =&gt; {
                 return Err(Error::Internal(&quot;Non-request message from client&quot;.into()));
             }
<a href="#h4-3" id="h4-3" class="h">@@ -199,7 +198,6 @@ impl&lt;R&gt; RoleNode&lt;R&gt; {
</a> 
         match msg.to {
             Address::Node(id) if id == self.id =&gt; Ok(()),
<a href="#h4-3-3" id="h4-3-3" class="d">-            Address::Local =&gt; Ok(()),
</a>             Address::Broadcast =&gt; Ok(()),
             Address::Node(id) =&gt; {
                 Err(Error::Internal(format!(&quot;Received message for other node {}&quot;, id)))
<a href="#h4-4" id="h4-4" class="h">@@ -511,7 +509,7 @@ mod tests {
</a>         assert_messages(
             &amp;mut rx,
             vec![Message {
<a href="#h4-4-3" id="h4-4-3" class="d">-                from: Address::Local,
</a><a href="#h4-4-4" id="h4-4-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Node(2),
                 term: 1,
                 event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
<b>diff --git a/<a id="h5" href="../file/src/raft/server.rs.html">src/raft/server.rs</a> b/<a href="../file/src/raft/server.rs.html">src/raft/server.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -48,8 +48,7 @@ impl Server {
</a>         let (tcp_out_tx, tcp_out_rx) = mpsc::unbounded_channel::&lt;Message&gt;();
         let (task, tcp_receiver) = Self::tcp_receive(listener, tcp_in_tx).remote_handle();
         tokio::spawn(task);
<a href="#h5-0-3" id="h5-0-3" class="d">-        let (task, tcp_sender) =
</a><a href="#h5-0-4" id="h5-0-4" class="d">-            Self::tcp_send(self.node.id(), self.peers, tcp_out_rx).remote_handle();
</a><a href="#h5-0-5" id="h5-0-5" class="i">+        let (task, tcp_sender) = Self::tcp_send(self.peers, tcp_out_rx).remote_handle();
</a>         tokio::spawn(task);
         let (task, eventloop) =
             Self::eventloop(self.node, self.node_rx, client_rx, tcp_in_rx, tcp_out_tx)
<a href="#h5-1" id="h5-1" class="h">@@ -97,13 +96,14 @@ impl Server {
</a> 
                 Some((request, response_tx)) = client_rx.next() =&gt; {
                     let id = Uuid::new_v4().as_bytes().to_vec();
<a href="#h5-1-3" id="h5-1-3" class="d">-                    requests.insert(id.clone(), response_tx);
</a><a href="#h5-1-4" id="h5-1-4" class="d">-                    node = node.step(Message{
</a><a href="#h5-1-5" id="h5-1-5" class="i">+                    let msg = Message{
</a>                         from: Address::Client,
<a href="#h5-1-7" id="h5-1-7" class="d">-                        to: Address::Local,
</a><a href="#h5-1-8" id="h5-1-8" class="i">+                        to: Address::Node(node.id()),
</a>                         term: 0,
<a href="#h5-1-10" id="h5-1-10" class="d">-                        event: Event::ClientRequest{id, request},
</a><a href="#h5-1-11" id="h5-1-11" class="d">-                    })?;
</a><a href="#h5-1-12" id="h5-1-12" class="i">+                        event: Event::ClientRequest{id: id.clone(), request},
</a><a href="#h5-1-13" id="h5-1-13" class="i">+                    };
</a><a href="#h5-1-14" id="h5-1-14" class="i">+                    node = node.step(msg)?;
</a><a href="#h5-1-15" id="h5-1-15" class="i">+                    requests.insert(id, response_tx);
</a>                 }
             }
         }
<a href="#h5-2" id="h5-2" class="h">@@ -146,7 +146,6 @@ impl Server {
</a> 
     /// Sends outbound messages to peers via TCP.
     async fn tcp_send(
<a href="#h5-2-3" id="h5-2-3" class="d">-        node_id: NodeID,
</a>         peers: HashMap&lt;NodeID, String&gt;,
         out_rx: mpsc::UnboundedReceiver&lt;Message&gt;,
     ) -&gt; Result&lt;()&gt; {
<a href="#h5-3" id="h5-3" class="h">@@ -159,10 +158,7 @@ impl Server {
</a>             tokio::spawn(Self::tcp_send_peer(addr, rx));
         }
 
<a href="#h5-3-3" id="h5-3-3" class="d">-        while let Some(mut message) = out_rx.next().await {
</a><a href="#h5-3-4" id="h5-3-4" class="d">-            if message.from == Address::Local {
</a><a href="#h5-3-5" id="h5-3-5" class="d">-                message.from = Address::Node(node_id)
</a><a href="#h5-3-6" id="h5-3-6" class="d">-            }
</a><a href="#h5-3-7" id="h5-3-7" class="i">+        while let Some(message) = out_rx.next().await {
</a>             let to = match message.to {
                 Address::Broadcast =&gt; peer_txs.keys().copied().collect(),
                 Address::Node(peer) =&gt; vec![peer],
<b>diff --git a/<a id="h6" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-use super::{Address, Entry, Event, Index, Log, Message, Response, Status, Term};
</a><a href="#h6-0-1" id="h6-0-1" class="i">+use super::{Address, Entry, Event, Index, Log, Message, NodeID, Response, Status, Term};
</a> use crate::error::{Error, Result};
 
 use log::{debug, error};
<a href="#h6-1" id="h6-1" class="h">@@ -56,6 +56,7 @@ struct Query {
</a> 
 /// Drives a state machine, taking operations from state_rx and sending results via node_tx.
 pub struct Driver {
<a href="#h6-1-3" id="h6-1-3" class="i">+    node_id: NodeID,
</a>     state_rx: UnboundedReceiverStream&lt;Instruction&gt;,
     node_tx: mpsc::UnboundedSender&lt;Message&gt;,
     /// Notify clients when their mutation is applied. &lt;index, (client, id)&gt;
<a href="#h6-2" id="h6-2" class="h">@@ -67,10 +68,12 @@ pub struct Driver {
</a> impl Driver {
     /// Creates a new state machine driver.
     pub fn new(
<a href="#h6-2-3" id="h6-2-3" class="i">+        node_id: NodeID,
</a>         state_rx: mpsc::UnboundedReceiver&lt;Instruction&gt;,
         node_tx: mpsc::UnboundedSender&lt;Message&gt;,
     ) -&gt; Self {
         Self {
<a href="#h6-2-8" id="h6-2-8" class="i">+            node_id,
</a>             state_rx: UnboundedReceiverStream::new(state_rx),
             node_tx,
             notify: HashMap::new(),
<a href="#h6-3" id="h6-3" class="h">@@ -248,7 +251,7 @@ impl Driver {
</a> 
     /// Sends a message.
     fn send(&amp;self, to: Address, event: Event) -&gt; Result&lt;()&gt; {
<a href="#h6-3-3" id="h6-3-3" class="d">-        let msg = Message { from: Address::Local, to, term: 0, event };
</a><a href="#h6-3-4" id="h6-3-4" class="i">+        let msg = Message { from: Address::Node(self.node_id), to, term: 0, event };
</a>         debug!(&quot;Sending {:?}&quot;, msg);
         Ok(self.node_tx.send(msg)?)
     }
<a href="#h6-4" id="h6-4" class="h">@@ -308,7 +311,7 @@ pub mod tests {
</a>         let state = Box::new(TestState::new(0));
         let (state_tx, state_rx) = mpsc::unbounded_channel();
         let (node_tx, node_rx) = mpsc::unbounded_channel();
<a href="#h6-4-3" id="h6-4-3" class="d">-        tokio::spawn(Driver::new(state_rx, node_tx).drive(state.clone()));
</a><a href="#h6-4-4" id="h6-4-4" class="i">+        tokio::spawn(Driver::new(1, state_rx, node_tx).drive(state.clone()));
</a>         Ok((state, state_tx, node_rx))
     }
 
<a href="#h6-5" id="h6-5" class="h">@@ -329,7 +332,7 @@ pub mod tests {
</a>             index: 1,
             quorum: 2,
         })?;
<a href="#h6-5-3" id="h6-5-3" class="d">-        state_tx.send(Instruction::Vote { term: 1, index: 1, address: Address::Local })?;
</a><a href="#h6-5-4" id="h6-5-4" class="i">+        state_tx.send(Instruction::Vote { term: 1, index: 1, address: Address::Node(1) })?;
</a>         state_tx.send(Instruction::Abort)?;
         std::mem::drop(state_tx);
 
<a href="#h6-6" id="h6-6" class="h">@@ -338,13 +341,13 @@ pub mod tests {
</a>             node_rx.collect::&lt;Vec&lt;_&gt;&gt;().await,
             vec![
                 Message {
<a href="#h6-6-3" id="h6-6-3" class="d">-                    from: Address::Local,
</a><a href="#h6-6-4" id="h6-6-4" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Node(1),
                     term: 0,
                     event: Event::ClientResponse { id: vec![0x01], response: Err(Error::Abort) }
                 },
                 Message {
<a href="#h6-6-10" id="h6-6-10" class="d">-                    from: Address::Local,
</a><a href="#h6-6-11" id="h6-6-11" class="i">+                    from: Address::Node(1),
</a>                     to: Address::Client,
                     term: 0,
                     event: Event::ClientResponse { id: vec![0x02], response: Err(Error::Abort) }
<a href="#h6-7" id="h6-7" class="h">@@ -376,7 +379,7 @@ pub mod tests {
</a>         assert_eq!(
             node_rx.collect::&lt;Vec&lt;_&gt;&gt;().await,
             vec![Message {
<a href="#h6-7-3" id="h6-7-3" class="d">-                from: Address::Local,
</a><a href="#h6-7-4" id="h6-7-4" class="i">+                from: Address::Node(1),
</a>                 to: Address::Client,
                 term: 0,
                 event: Event::ClientResponse {
<a href="#h6-8" id="h6-8" class="h">@@ -406,15 +409,15 @@ pub mod tests {
</a>         state_tx.send(Instruction::Apply {
             entry: Entry { index: 1, term: 2, command: Some(vec![0xaf]) },
         })?;
<a href="#h6-8-3" id="h6-8-3" class="d">-        state_tx.send(Instruction::Vote { term: 2, index: 1, address: Address::Local })?;
</a>         state_tx.send(Instruction::Vote { term: 2, index: 1, address: Address::Node(1) })?;
<a href="#h6-8-5" id="h6-8-5" class="i">+        state_tx.send(Instruction::Vote { term: 2, index: 1, address: Address::Node(2) })?;
</a>         std::mem::drop(state_tx);
 
         let node_rx = UnboundedReceiverStream::new(node_rx);
         assert_eq!(
             node_rx.collect::&lt;Vec&lt;_&gt;&gt;().await,
             vec![Message {
<a href="#h6-8-12" id="h6-8-12" class="d">-                from: Address::Local,
</a><a href="#h6-8-13" id="h6-8-13" class="i">+                from: Address::Node(1),
</a>                 to: Address::Client,
                 term: 0,
                 event: Event::ClientResponse {
<a href="#h6-9" id="h6-9" class="h">@@ -443,7 +446,7 @@ pub mod tests {
</a>         state_tx.send(Instruction::Apply {
             entry: Entry { index: 1, term: 1, command: Some(vec![0xaf]) },
         })?;
<a href="#h6-9-3" id="h6-9-3" class="d">-        state_tx.send(Instruction::Vote { term: 2, index: 1, address: Address::Local })?;
</a><a href="#h6-9-4" id="h6-9-4" class="i">+        state_tx.send(Instruction::Vote { term: 2, index: 1, address: Address::Node(1) })?;
</a>         state_tx.send(Instruction::Vote { term: 1, index: 1, address: Address::Node(1) })?;
         std::mem::drop(state_tx);
 
<a href="#h6-10" id="h6-10" class="h">@@ -467,7 +470,7 @@ pub mod tests {
</a>         state_tx.send(Instruction::Apply {
             entry: Entry { index: 1, term: 1, command: Some(vec![0xaf]) },
         })?;
<a href="#h6-10-3" id="h6-10-3" class="d">-        state_tx.send(Instruction::Vote { term: 1, index: 1, address: Address::Local })?;
</a><a href="#h6-10-4" id="h6-10-4" class="i">+        state_tx.send(Instruction::Vote { term: 1, index: 1, address: Address::Node(1) })?;
</a>         std::mem::drop(state_tx);
 
         let node_rx = UnboundedReceiverStream::new(node_rx);
</pre>
</div>
</body>
</html>
