<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Renamed Raft read operation to query - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d93ee30e93f1975b80e68b00f204cf03c8ca9b75.html">d93ee30e93f1975b80e68b00f204cf03c8ca9b75</a>
<b>parent</b> <a href="../commit/9a8ff77e28ddc17b39d762883ce29da3ca4b75c7.html">9a8ff77e28ddc17b39d762883ce29da3ca4b75c7</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun,  1 Dec 2019 16:52:14 +0100

Renamed Raft read operation to query

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">protobuf/raft.proto</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/mod.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/follower.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/leader.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/node/mod.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/transport.rs</a></td><td> | </td><td class="num">7</td><td><span class="i">+++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/server/raft.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
</table></pre><pre>9 files changed, 24 insertions(+), 24 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a> b/<a href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -21,7 +21,7 @@ message Message {
</a>     ReplicateEntries replicate_entries = 8;
     AcceptEntries accept_entries = 9;
     RejectEntries reject_entries = 10;
<a href="#h0-0-3" id="h0-0-3" class="d">-    ReadState read_state = 11;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    QueryState query_state = 11;
</a>     MutateState mutate_state = 12;
     RespondState respond_state = 13;
     RespondError respond_error = 14;
<a href="#h0-1" id="h0-1" class="h">@@ -60,7 +60,7 @@ message AcceptEntries { uint64 last_index = 1; }
</a> 
 message RejectEntries {}
 
<a href="#h0-1-3" id="h0-1-3" class="d">-message ReadState {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+message QueryState {
</a>   bytes call_id = 1;
   bytes command = 2;
 }
<b>diff --git a/<a id="h1" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -126,9 +126,9 @@ impl Raft {
</a>         }
     }
 
<a href="#h1-0-3" id="h1-0-3" class="d">-    /// Reads from the Raft state machine.
</a><a href="#h1-0-4" id="h1-0-4" class="d">-    pub fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h1-0-5" id="h1-0-5" class="d">-        match self.call(Event::ReadState { call_id: Self::call_id(), command })? {
</a><a href="#h1-0-6" id="h1-0-6" class="i">+    /// Queries the Raft state machine.
</a><a href="#h1-0-7" id="h1-0-7" class="i">+    pub fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h1-0-8" id="h1-0-8" class="i">+        match self.call(Event::QueryState { call_id: Self::call_id(), command })? {
</a>             Event::RespondState { response, .. } =&gt; Ok(response),
             event =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft read response {:?}&quot;, event))),
         }
<b>diff --git a/<a id="h2" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -79,7 +79,7 @@ impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Candidate, L, S&gt; {
</a>             Event::AcceptEntries { .. } =&gt; {}
             Event::RejectEntries { .. } =&gt; {}
             // FIXME These should be queued or something
<a href="#h2-0-3" id="h2-0-3" class="d">-            Event::ReadState { .. } =&gt; {}
</a><a href="#h2-0-4" id="h2-0-4" class="i">+            Event::QueryState { .. } =&gt; {}
</a>             Event::MutateState { .. } =&gt; {}
             Event::RespondState { .. } =&gt; {}
             Event::RespondError { .. } =&gt; {}
<b>diff --git a/<a id="h3" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -121,7 +121,7 @@ impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Follower, L, S&gt; {
</a>                     }
                 }
             }
<a href="#h3-0-3" id="h3-0-3" class="d">-            Event::ReadState { ref call_id, .. } | Event::MutateState { ref call_id, .. } =&gt; {
</a><a href="#h3-0-4" id="h3-0-4" class="i">+            Event::QueryState { ref call_id, .. } | Event::MutateState { ref call_id, .. } =&gt; {
</a>                 self.role.proxy_calls.insert(call_id.clone(), msg.from);
                 self.send(self.role.leader.as_deref(), msg.event)?;
             }
<a href="#h3-1" id="h3-1" class="h">@@ -766,7 +766,7 @@ pub mod tests {
</a>     fn step_readstate_mutatestate_respond() {
         let calls = vec![
             Event::MutateState { call_id: vec![0x02], command: vec![0x02] },
<a href="#h3-1-3" id="h3-1-3" class="d">-            Event::ReadState { call_id: vec![0x01], command: vec![0x01] },
</a><a href="#h3-1-4" id="h3-1-4" class="i">+            Event::QueryState { call_id: vec![0x01], command: vec![0x01] },
</a>         ];
         let responses = vec![
             Event::RespondError { call_id: vec![], error: &quot;b00m&quot;.into() },
<b>diff --git a/<a id="h4" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -159,7 +159,7 @@ impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Leader, L, S&gt; {
</a>                     self.replicate(&amp;from)?;
                 }
             }
<a href="#h4-0-3" id="h4-0-3" class="d">-            Event::ReadState { call_id, command } =&gt; {
</a><a href="#h4-0-4" id="h4-0-4" class="i">+            Event::QueryState { call_id, command } =&gt; {
</a>                 let (commit_index, commit_term) = self.log.get_committed();
                 self.role.calls.register(Call {
                     id: call_id,
<a href="#h4-1" id="h4-1" class="h">@@ -660,7 +660,7 @@ mod tests {
</a>                 from: None,
                 to: None,
                 term: 0,
<a href="#h4-1-3" id="h4-1-3" class="d">-                event: Event::ReadState { call_id: vec![0x02], command: vec![0x06] },
</a><a href="#h4-1-4" id="h4-1-4" class="i">+                event: Event::QueryState { call_id: vec![0x02], command: vec![0x06] },
</a>             })
             .unwrap();
         assert_node(&amp;node).is_leader().term(3);
<b>diff --git a/<a id="h5" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -422,7 +422,7 @@ mod tests {
</a>             from: None,
             to: None,
             term: 0,
<a href="#h5-0-3" id="h5-0-3" class="d">-            event: Event::ReadState { call_id: vec![], command: vec![] },
</a><a href="#h5-0-4" id="h5-0-4" class="i">+            event: Event::QueryState { call_id: vec![], command: vec![] },
</a>         };
         assert!(node.normalize_message(&amp;mut msg));
         assert_eq!(
<a href="#h5-1" id="h5-1" class="h">@@ -431,7 +431,7 @@ mod tests {
</a>                 from: None,
                 to: Some(&quot;a&quot;.into()),
                 term: 1,
<a href="#h5-1-3" id="h5-1-3" class="d">-                event: Event::ReadState { call_id: vec![], command: vec![] },
</a><a href="#h5-1-4" id="h5-1-4" class="i">+                event: Event::QueryState { call_id: vec![], command: vec![] },
</a>             }
         );
 
<b>diff --git a/<a id="h6" href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a> b/<a href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -103,8 +103,8 @@ pub enum Event {
</a>     },
     /// Followers may also reject a set of log entries from a leader.
     RejectEntries,
<a href="#h6-0-3" id="h6-0-3" class="d">-    /// Reads from the state machine.
</a><a href="#h6-0-4" id="h6-0-4" class="d">-    ReadState {
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    /// Queries the state machine.
</a><a href="#h6-0-6" id="h6-0-6" class="i">+    QueryState {
</a>         /// The call ID.
         call_id: Vec&lt;u8&gt;,
         /// The state machine command.
<a href="#h6-1" id="h6-1" class="h">@@ -137,7 +137,7 @@ impl Event {
</a>     /// Returns the call ID for the event, if any
     pub fn call_id(&amp;self) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
         match self {
<a href="#h6-1-3" id="h6-1-3" class="d">-            Event::ReadState { call_id, .. }
</a><a href="#h6-1-4" id="h6-1-4" class="i">+            Event::QueryState { call_id, .. }
</a>             | Event::MutateState { call_id, .. }
             | Event::RespondState { call_id, .. }
             | Event::RespondError { call_id, .. } =&gt; Some(call_id.clone()),
<a href="#h6-2" id="h6-2" class="h">@@ -219,5 +219,4 @@ mod tests {
</a>         .validate(&quot;a&quot;, 3)
         .is_err());
     }
<a href="#h6-2-3" id="h6-2-3" class="d">-
</a> }
<b>diff --git a/<a id="h7" href="../file/src/server/raft.rs.html">src/server/raft.rs</a> b/<a href="../file/src/server/raft.rs.html">src/server/raft.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -96,8 +96,8 @@ fn message_from_protobuf(pb: service::Message) -&gt; Result&lt;Message, Error&gt; {
</a>                 Event::SolicitVote { last_index: e.last_index, last_term: e.last_term }
             }
             Some(service::Message_oneof_event::grant_vote(_)) =&gt; Event::GrantVote,
<a href="#h7-0-3" id="h7-0-3" class="d">-            Some(service::Message_oneof_event::read_state(e)) =&gt; {
</a><a href="#h7-0-4" id="h7-0-4" class="d">-                Event::ReadState { call_id: e.call_id, command: e.command }
</a><a href="#h7-0-5" id="h7-0-5" class="i">+            Some(service::Message_oneof_event::query_state(e)) =&gt; {
</a><a href="#h7-0-6" id="h7-0-6" class="i">+                Event::QueryState { call_id: e.call_id, command: e.command }
</a>             }
             Some(service::Message_oneof_event::mutate_state(e)) =&gt; {
                 Event::MutateState { call_id: e.call_id, command: e.command }
<a href="#h7-1" id="h7-1" class="h">@@ -159,8 +159,8 @@ fn message_to_protobuf(msg: Message) -&gt; service::Message {
</a>                 })
             }
             Event::GrantVote =&gt; service::Message_oneof_event::grant_vote(service::GrantVote::new()),
<a href="#h7-1-3" id="h7-1-3" class="d">-            Event::ReadState { call_id, command } =&gt; {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-                service::Message_oneof_event::read_state(service::ReadState {
</a><a href="#h7-1-5" id="h7-1-5" class="i">+            Event::QueryState { call_id, command } =&gt; {
</a><a href="#h7-1-6" id="h7-1-6" class="i">+                service::Message_oneof_event::query_state(service::QueryState {
</a>                     call_id,
                     command,
                     ..Default::default()
<b>diff --git a/<a id="h8" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -100,7 +100,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
<a href="#h8-0-3" id="h8-0-3" class="d">-        deserialize(self.raft.read(serialize(Query::Read {
</a><a href="#h8-0-4" id="h8-0-4" class="i">+        deserialize(self.raft.query(serialize(Query::Read {
</a>             txn_id: self.id,
             table: table.into(),
             id: id.clone(),
<a href="#h8-1" id="h8-1" class="h">@@ -110,7 +110,8 @@ impl super::Transaction for Transaction {
</a>     fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
         Ok(Box::new(
             deserialize::&lt;Vec&lt;types::Row&gt;&gt;(
<a href="#h8-1-3" id="h8-1-3" class="d">-                self.raft.read(serialize(Query::Scan { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h8-1-4" id="h8-1-4" class="i">+                self.raft
</a><a href="#h8-1-5" id="h8-1-5" class="i">+                    .query(serialize(Query::Scan { txn_id: self.id, table: table.into() })?)?,
</a>             )?
             .into_iter()
             .map(Ok),
<a href="#h8-2" id="h8-2" class="h">@@ -145,13 +146,13 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt; {
<a href="#h8-2-3" id="h8-2-3" class="d">-        deserialize(self.raft.read(serialize(Query::ListTables { txn_id: self.id })?)?)
</a><a href="#h8-2-4" id="h8-2-4" class="i">+        deserialize(self.raft.query(serialize(Query::ListTables { txn_id: self.id })?)?)
</a>     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
         deserialize(
             self.raft
<a href="#h8-2-10" id="h8-2-10" class="d">-                .read(serialize(Query::ReadTable { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h8-2-11" id="h8-2-11" class="i">+                .query(serialize(Query::ReadTable { txn_id: self.id, table: table.into() })?)?,
</a>         )
     }
 }
</pre>
</div>
</body>
</html>
