<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>storage: use stdlib `Error` and `Result` in MVCC tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/021be0dfa633aeb71e98606a38c5c4894b344946.html">021be0dfa633aeb71e98606a38c5c4894b344946</a>
<b>parent</b> <a href="../commit/4f4aca1e60d07bc34ca6b0a9b4251a7a9de6a28a.html">4f4aca1e60d07bc34ca6b0a9b4251a7a9de6a28a</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Fri, 14 Jun 2024 00:11:30 +0200

storage: use stdlib `Error` and `Result` in MVCC tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/storage/mvcc.rs</a></td><td> | </td><td class="num">25</td><td><span class="i">+++++++++++</span><span class="d">--------------</span></td></tr>
</table></pre><pre>1 file changed, 11 insertions(+), 14 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -790,9 +790,8 @@ pub mod tests {
</a>     use itertools::Itertools as _;
     use regex::Regex;
     use std::collections::HashMap;
<a href="#h0-0-3" id="h0-0-3" class="d">-    use std::error::Error as StdError;
</a>     use std::fmt::Write as _;
<a href="#h0-0-5" id="h0-0-5" class="d">-    use std::result::Result as StdResult;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    use std::{error::Error, result::Result};
</a>     use test_case::test_case;
     use test_each_file::test_each_path;
 
<a href="#h0-1" id="h0-1" class="h">@@ -828,7 +827,7 @@ pub mod tests {
</a>     type TestEngine = Emit&lt;Mirror&lt;BitCask, Memory&gt;&gt;;
 
     impl goldenscript::Runner for MVCCRunner {
<a href="#h0-1-3" id="h0-1-3" class="d">-        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a>             let mut output = String::new();
             match command.name.as_str() {
                 // txn: begin [readonly] [as_of=VERSION]
<a href="#h0-2" id="h0-2" class="h">@@ -969,8 +968,8 @@ pub mod tests {
</a> 
                     let mut scan = txn.scan(range)?;
                     let kvs: Vec&lt;_&gt; = match reverse {
<a href="#h0-2-3" id="h0-2-3" class="d">-                        false =&gt; scan.iter().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h0-2-4" id="h0-2-4" class="d">-                        true =&gt; scan.iter().rev().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h0-2-5" id="h0-2-5" class="i">+                        false =&gt; scan.iter().collect::&lt;crate::error::Result&lt;_&gt;&gt;()?,
</a><a href="#h0-2-6" id="h0-2-6" class="i">+                        true =&gt; scan.iter().rev().collect::&lt;crate::error::Result&lt;_&gt;&gt;()?,
</a>                     };
                     for (key, value) in kvs {
                         writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
<a href="#h0-3" id="h0-3" class="h">@@ -988,8 +987,8 @@ pub mod tests {
</a> 
                     let mut scan = txn.scan_prefix(&amp;prefix)?;
                     let kvs: Vec&lt;_&gt; = match reverse {
<a href="#h0-3-3" id="h0-3-3" class="d">-                        false =&gt; scan.iter().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h0-3-4" id="h0-3-4" class="d">-                        true =&gt; scan.iter().rev().collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h0-3-5" id="h0-3-5" class="i">+                        false =&gt; scan.iter().collect::&lt;crate::error::Result&lt;_&gt;&gt;()?,
</a><a href="#h0-3-6" id="h0-3-6" class="i">+                        true =&gt; scan.iter().rev().collect::&lt;crate::error::Result&lt;_&gt;&gt;()?,
</a>                     };
                     for (key, value) in kvs {
                         writeln!(output, &quot;{}&quot;, Self::format_key_value(&amp;key, Some(&amp;value)))?;
<a href="#h0-4" id="h0-4" class="h">@@ -1049,7 +1048,7 @@ pub mod tests {
</a>         fn end_command(
             &amp;mut self,
             command: &amp;goldenscript::Command,
<a href="#h0-4-3" id="h0-4-3" class="d">-        ) -&gt; StdResult&lt;String, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-4-4" id="h0-4-4" class="i">+        ) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a>             // Parse tags.
             let mut show_ops = false;
             for tag in &amp;command.tags {
<a href="#h0-5" id="h0-5" class="h">@@ -1133,9 +1132,7 @@ pub mod tests {
</a> 
         /// Parses an binary key range, using Rust range syntax.
         /// TODO: share with engine::test:Runner.
<a href="#h0-5-3" id="h0-5-3" class="d">-        fn parse_key_range(
</a><a href="#h0-5-4" id="h0-5-4" class="d">-            s: &amp;str,
</a><a href="#h0-5-5" id="h0-5-5" class="d">-        ) -&gt; StdResult&lt;impl std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-5-6" id="h0-5-6" class="i">+        fn parse_key_range(s: &amp;str) -&gt; Result&lt;impl std::ops::RangeBounds&lt;Vec&lt;u8&gt;&gt;, Box&lt;dyn Error&gt;&gt; {
</a>             let mut bound = (Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded, Bound::&lt;Vec&lt;u8&gt;&gt;::Unbounded);
             let re = Regex::new(r&quot;^(\S+)?\.\.(=)?(\S+)?&quot;).expect(&quot;invalid regex&quot;);
             let groups = re.captures(s).ok_or_else(|| format!(&quot;invalid range {s}&quot;))?;
<a href="#h0-6" id="h0-6" class="h">@@ -1157,18 +1154,18 @@ pub mod tests {
</a>         fn get_txn(
             &amp;mut self,
             prefix: &amp;Option&lt;String&gt;,
<a href="#h0-6-3" id="h0-6-3" class="d">-        ) -&gt; StdResult&lt;&amp;&#39;_ mut Transaction&lt;TestEngine&gt;, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-6-4" id="h0-6-4" class="i">+        ) -&gt; Result&lt;&amp;&#39;_ mut Transaction&lt;TestEngine&gt;, Box&lt;dyn Error&gt;&gt; {
</a>             let name = Self::txn_name(prefix)?;
             self.txns.get_mut(name).ok_or(format!(&quot;unknown txn {name}&quot;).into())
         }
 
         /// Fetches the txn name from a command prefix, or errors.
<a href="#h0-6-10" id="h0-6-10" class="d">-        fn txn_name(prefix: &amp;Option&lt;String&gt;) -&gt; StdResult&lt;&amp;str, Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-6-11" id="h0-6-11" class="i">+        fn txn_name(prefix: &amp;Option&lt;String&gt;) -&gt; Result&lt;&amp;str, Box&lt;dyn Error&gt;&gt; {
</a>             prefix.as_deref().ok_or(&quot;no txn name&quot;.into())
         }
 
         /// Errors if a txn prefix is given.
<a href="#h0-6-16" id="h0-6-16" class="d">-        fn no_txn(command: &amp;goldenscript::Command) -&gt; StdResult&lt;(), Box&lt;dyn StdError&gt;&gt; {
</a><a href="#h0-6-17" id="h0-6-17" class="i">+        fn no_txn(command: &amp;goldenscript::Command) -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</a>             if let Some(name) = &amp;command.prefix {
                 return Err(format!(&quot;can&#39;t run {} with txn {name}&quot;, command.name).into());
             }
</pre>
</div>
</body>
</html>
