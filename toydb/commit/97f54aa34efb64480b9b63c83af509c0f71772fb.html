<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: simplify `Label` - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/97f54aa34efb64480b9b63c83af509c0f71772fb.html">97f54aa34efb64480b9b63c83af509c0f71772fb</a>
<b>parent</b> <a href="../commit/647899650023a8dd3b2b655e9ad1cf7bf9dc07f7.html">647899650023a8dd3b2b655e9ad1cf7bf9dc07f7</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Wed, 17 Jul 2024 14:02:54 +0200

sql: simplify `Label`

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toysql.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/planner/planner.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/types/value.rs</a></td><td> | </td><td class="num">49</td><td><span class="i">+++++++++++++++++</span><span class="d">--------------------------------</span></td></tr>
</table></pre><pre>4 files changed, 28 insertions(+), 43 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -199,10 +199,10 @@ Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk,
</a>             StatementResult::Explain(plan) =&gt; println!(&quot;{}&quot;, plan),
             StatementResult::Select { columns, rows } =&gt; {
                 if self.show_headers {
<a href="#h0-0-3" id="h0-0-3" class="d">-                    println!(&quot;{}&quot;, columns.into_iter().map(|c| c.as_header()).join(&quot;|&quot;));
</a><a href="#h0-0-4" id="h0-0-4" class="i">+                    println!(&quot;{}&quot;, columns.iter().map(|c| c.as_header()).join(&quot;|&quot;));
</a>                 }
                 for row in rows {
<a href="#h0-0-7" id="h0-0-7" class="d">-                    println!(&quot;{}&quot;, row.into_iter().map(|v| v.to_string()).join(&quot;|&quot;));
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                    println!(&quot;{}&quot;, row.iter().join(&quot;|&quot;));
</a>                 }
             }
         }
<b>diff --git a/<a id="h1" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -268,13 +268,13 @@ impl Node {
</a>     /// Returns a label for a column, if any. Only used for display purposes.
     pub fn column_label(&amp;self, index: usize) -&gt; Label {
         match self {
<a href="#h1-0-3" id="h1-0-3" class="d">-            // Source nodes use the table/column name, calling name() to handle
</a><a href="#h1-0-4" id="h1-0-4" class="d">-            // any aliases.
</a><a href="#h1-0-5" id="h1-0-5" class="d">-            Self::IndexLookup { table, .. }
</a><a href="#h1-0-6" id="h1-0-6" class="d">-            | Self::KeyLookup { table, .. }
</a><a href="#h1-0-7" id="h1-0-7" class="d">-            | Self::Scan { table, .. } =&gt; {
</a><a href="#h1-0-8" id="h1-0-8" class="d">-                Label::maybe_qualified(self.name(), table.columns[index].name.clone())
</a><a href="#h1-0-9" id="h1-0-9" class="d">-            }
</a><a href="#h1-0-10" id="h1-0-10" class="i">+            // Source nodes use the table/column name.
</a><a href="#h1-0-11" id="h1-0-11" class="i">+            Self::IndexLookup { table, alias, .. }
</a><a href="#h1-0-12" id="h1-0-12" class="i">+            | Self::KeyLookup { table, alias, .. }
</a><a href="#h1-0-13" id="h1-0-13" class="i">+            | Self::Scan { table, alias, .. } =&gt; Label::Qualified(
</a><a href="#h1-0-14" id="h1-0-14" class="i">+                alias.as_ref().unwrap_or(&amp;table.name).clone(),
</a><a href="#h1-0-15" id="h1-0-15" class="i">+                table.columns[index].name.clone(),
</a><a href="#h1-0-16" id="h1-0-16" class="i">+            ),
</a> 
             // Some nodes rearrange columns. Route them to the correct
             // upstream column where appropriate.
<b>diff --git a/<a id="h2" href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a> b/<a href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -184,7 +184,7 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>             // verify that they&#39;re all used in GROUP BY as well.
             if select.is_empty() {
                 select = (0..node.size())
<a href="#h2-0-3" id="h2-0-3" class="d">-                    .map(|i| (node.column_label(i).into_ast_field().expect(&quot;no FROM label&quot;), None))
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                    .map(|i| (ast::Expression::from(node.column_label(i)), None))
</a>                     .collect();
             }
             node = self.build_aggregate(&amp;mut scope, node, group_by, aggregates)?;
<a href="#h2-1" id="h2-1" class="h">@@ -200,7 +200,7 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>             let mut labels = Vec::with_capacity(select.len());
             for (expr, alias) in select {
                 expressions.push(Self::build_expression(expr, &amp;scope)?);
<a href="#h2-1-3" id="h2-1-3" class="d">-                labels.push(Label::maybe_name(alias));
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                labels.push(Label::from(alias));
</a>             }
 
             // Add hidden columns for HAVING and ORDER BY columns not in SELECT.
<b>diff --git a/<a id="h3" href="../file/src/sql/types/value.rs.html">src/sql/types/value.rs</a> b/<a href="../file/src/sql/types/value.rs.html">src/sql/types/value.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -373,14 +373,14 @@ dyn_clone::clone_trait_object!(RowIterator);
</a> 
 impl&lt;I: Iterator&lt;Item = Result&lt;Row&gt;&gt; + DynClone&gt; RowIterator for I {}
 
<a href="#h3-0-3" id="h3-0-3" class="d">-/// A column label, used in result sets and query plans.
</a><a href="#h3-0-4" id="h3-0-4" class="i">+/// A column label, used in query results and plans.
</a> #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
 pub enum Label {
     /// No label.
     None,
     /// An unqualified column name.
     Unqualified(String),
<a href="#h3-0-11" id="h3-0-11" class="d">-    /// A fully qualified column name.
</a><a href="#h3-0-12" id="h3-0-12" class="i">+    /// A fully qualified table/column name.
</a>     Qualified(String, String),
 }
 
<a href="#h3-1" id="h3-1" class="h">@@ -395,43 +395,28 @@ impl std::fmt::Display for Label {
</a> }
 
 impl Label {
<a href="#h3-1-3" id="h3-1-3" class="d">-    /// Creates an unqualified label for a Some.
</a><a href="#h3-1-4" id="h3-1-4" class="d">-    pub fn maybe_name(name: Option&lt;String&gt;) -&gt; Self {
</a><a href="#h3-1-5" id="h3-1-5" class="d">-        name.map(Self::Unqualified).unwrap_or(Self::None)
</a><a href="#h3-1-6" id="h3-1-6" class="d">-    }
</a><a href="#h3-1-7" id="h3-1-7" class="d">-
</a><a href="#h3-1-8" id="h3-1-8" class="d">-    /// Creates a qualified label if table is given, otherwise unqualified.
</a><a href="#h3-1-9" id="h3-1-9" class="d">-    pub fn maybe_qualified(table: Option&lt;String&gt;, column: String) -&gt; Self {
</a><a href="#h3-1-10" id="h3-1-10" class="d">-        match table {
</a><a href="#h3-1-11" id="h3-1-11" class="d">-            Some(table) =&gt; Self::Qualified(table, column),
</a><a href="#h3-1-12" id="h3-1-12" class="d">-            None =&gt; Self::Unqualified(column),
</a><a href="#h3-1-13" id="h3-1-13" class="d">-        }
</a><a href="#h3-1-14" id="h3-1-14" class="d">-    }
</a><a href="#h3-1-15" id="h3-1-15" class="d">-
</a>     /// Formats the label as a short column header.
<a href="#h3-1-17" id="h3-1-17" class="d">-    pub fn as_header(&amp;self) -&gt; String {
</a><a href="#h3-1-18" id="h3-1-18" class="i">+    pub fn as_header(&amp;self) -&gt; &amp;str {
</a>         match self {
<a href="#h3-1-20" id="h3-1-20" class="d">-            Self::Qualified(_, column) | Self::Unqualified(column) =&gt; column.to_string(),
</a><a href="#h3-1-21" id="h3-1-21" class="d">-            Self::None =&gt; &quot;?&quot;.to_string(),
</a><a href="#h3-1-22" id="h3-1-22" class="i">+            Self::Qualified(_, column) | Self::Unqualified(column) =&gt; column.as_str(),
</a><a href="#h3-1-23" id="h3-1-23" class="i">+            Self::None =&gt; &quot;?&quot;,
</a>         }
     }
<a href="#h3-1-26" id="h3-1-26" class="i">+}
</a> 
<a href="#h3-1-28" id="h3-1-28" class="d">-    /// Converts the label into an AST field expression.
</a><a href="#h3-1-29" id="h3-1-29" class="d">-    pub fn into_ast_field(self) -&gt; Option&lt;ast::Expression&gt; {
</a><a href="#h3-1-30" id="h3-1-30" class="d">-        match self {
</a><a href="#h3-1-31" id="h3-1-31" class="d">-            Label::Qualified(table, column) =&gt; Some(ast::Expression::Field(Some(table), column)),
</a><a href="#h3-1-32" id="h3-1-32" class="d">-            Label::Unqualified(column) =&gt; Some(ast::Expression::Field(None, column)),
</a><a href="#h3-1-33" id="h3-1-33" class="d">-            Label::None =&gt; None,
</a><a href="#h3-1-34" id="h3-1-34" class="i">+impl From&lt;Label&gt; for ast::Expression {
</a><a href="#h3-1-35" id="h3-1-35" class="i">+    /// Builds an ast::Expression::Field for a label. Can&#39;t be None.
</a><a href="#h3-1-36" id="h3-1-36" class="i">+    fn from(label: Label) -&gt; Self {
</a><a href="#h3-1-37" id="h3-1-37" class="i">+        match label {
</a><a href="#h3-1-38" id="h3-1-38" class="i">+            Label::Qualified(table, column) =&gt; ast::Expression::Field(Some(table), column),
</a><a href="#h3-1-39" id="h3-1-39" class="i">+            Label::Unqualified(column) =&gt; ast::Expression::Field(None, column),
</a><a href="#h3-1-40" id="h3-1-40" class="i">+            Label::None =&gt; panic!(&quot;can&#39;t convert None label to AST expression&quot;), // shouldn&#39;t happen
</a>         }
     }
<a href="#h3-1-43" id="h3-1-43" class="i">+}
</a> 
<a href="#h3-1-45" id="h3-1-45" class="d">-    /// Returns true if the label is None.
</a><a href="#h3-1-46" id="h3-1-46" class="d">-    pub fn is_none(&amp;self) -&gt; bool {
</a><a href="#h3-1-47" id="h3-1-47" class="d">-        matches!(self, Self::None)
</a><a href="#h3-1-48" id="h3-1-48" class="d">-    }
</a><a href="#h3-1-49" id="h3-1-49" class="d">-
</a><a href="#h3-1-50" id="h3-1-50" class="d">-    /// Returns true if the label is not None.
</a><a href="#h3-1-51" id="h3-1-51" class="d">-    pub fn is_some(&amp;self) -&gt; bool {
</a><a href="#h3-1-52" id="h3-1-52" class="d">-        !self.is_none()
</a><a href="#h3-1-53" id="h3-1-53" class="i">+impl From&lt;Option&lt;String&gt;&gt; for Label {
</a><a href="#h3-1-54" id="h3-1-54" class="i">+    fn from(name: Option&lt;String&gt;) -&gt; Self {
</a><a href="#h3-1-55" id="h3-1-55" class="i">+        name.map(Label::Unqualified).unwrap_or(Label::None)
</a>     }
 }
</pre>
</div>
</body>
</html>
