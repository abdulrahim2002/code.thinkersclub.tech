<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tests: rewrite end-to-end tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/4a5239485fc59a2dc43f9f1416386c231dd5e48b.html">4a5239485fc59a2dc43f9f1416386c231dd5e48b</a>
<b>parent</b> <a href="../commit/31c8e1d70164d57f97f25e34df5398d6a474dd33.html">31c8e1d70164d57f97f25e34df5398d6a474dd33</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Mon, 22 Jul 2024 17:21:57 +0200

tests: rewrite end-to-end tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.github/workflows/ci.yml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.lock</a></td><td> | </td><td class="num">182</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">Cargo.toml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/testscripts/transactions/anomaly_phantom_read</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">tests/README.md</a></td><td> | </td><td class="num">4</td><td><span class="i"></span><span class="d">----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h5">tests/e2e/client.rs</a></td><td> | </td><td class="num">421</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">tests/e2e/dataset.rs</a></td><td> | </td><td class="num">51</td><td><span class="i"></span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h7">tests/e2e/isolation.rs</a></td><td> | </td><td class="num">156</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h8">tests/e2e/mod.rs</a></td><td> | </td><td class="num">27</td><td><span class="i"></span><span class="d">---------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">tests/e2e/recovery.rs</a></td><td> | </td><td class="num">50</td><td><span class="i"></span><span class="d">--------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">tests/e2e/testcluster.rs</a></td><td> | </td><td class="num">177</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">tests/scripts/anomalies</a></td><td> | </td><td class="num">205</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">tests/scripts/client</a></td><td> | </td><td class="num">195</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">tests/scripts/errors</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">tests/scripts/isolation</a></td><td> | </td><td class="num">98</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">tests/scripts/queries</a></td><td> | </td><td class="num">104</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">tests/testcluster.rs</a></td><td> | </td><td class="num">144</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">tests/tests.rs</a></td><td> | </td><td class="num">160</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
</table></pre><pre>18 files changed, 950 insertions(+), 1075 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.github/workflows/ci.yml.html">.github/workflows/ci.yml</a> b/<a href="../file/.github/workflows/ci.yml.html">.github/workflows/ci.yml</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -19,7 +19,7 @@ jobs:
</a>       with:
         path: target
         key: ${{runner.os}}-target-${{steps.toolchain.outputs.cachekey}}-${{hashFiles(&#39;Cargo.lock&#39;)}}
<a href="#h0-0-3" id="h0-0-3" class="d">-    - run: cargo build --tests
</a><a href="#h0-0-4" id="h0-0-4" class="i">+    - run: cargo build --bins --tests
</a>     - run: cargo test
     - run: cargo clippy --tests --no-deps -- -D warnings
     - run: cargo fmt --check
 \ No newline at end of file
<b>diff --git a/<a id="h1" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -487,83 +487,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-0-3" id="h1-0-3" class="d">-name = &quot;futures&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-5" id="h1-0-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-6" id="h1-0-6" class="d">-checksum = &quot;645c6916888f6cb6350d2550b80fb63e734897a8498abe35cfb732b6487804b0&quot;
</a><a href="#h1-0-7" id="h1-0-7" class="d">-dependencies = [
</a><a href="#h1-0-8" id="h1-0-8" class="d">- &quot;futures-channel&quot;,
</a><a href="#h1-0-9" id="h1-0-9" class="d">- &quot;futures-core&quot;,
</a><a href="#h1-0-10" id="h1-0-10" class="d">- &quot;futures-executor&quot;,
</a><a href="#h1-0-11" id="h1-0-11" class="d">- &quot;futures-io&quot;,
</a><a href="#h1-0-12" id="h1-0-12" class="d">- &quot;futures-sink&quot;,
</a><a href="#h1-0-13" id="h1-0-13" class="d">- &quot;futures-task&quot;,
</a><a href="#h1-0-14" id="h1-0-14" class="d">- &quot;futures-util&quot;,
</a><a href="#h1-0-15" id="h1-0-15" class="d">-]
</a><a href="#h1-0-16" id="h1-0-16" class="d">-
</a><a href="#h1-0-17" id="h1-0-17" class="d">-[[package]]
</a><a href="#h1-0-18" id="h1-0-18" class="d">-name = &quot;futures-channel&quot;
</a><a href="#h1-0-19" id="h1-0-19" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-20" id="h1-0-20" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-21" id="h1-0-21" class="d">-checksum = &quot;eac8f7d7865dcb88bd4373ab671c8cf4508703796caa2b1985a9ca867b3fcb78&quot;
</a><a href="#h1-0-22" id="h1-0-22" class="d">-dependencies = [
</a><a href="#h1-0-23" id="h1-0-23" class="d">- &quot;futures-core&quot;,
</a><a href="#h1-0-24" id="h1-0-24" class="d">- &quot;futures-sink&quot;,
</a><a href="#h1-0-25" id="h1-0-25" class="d">-]
</a><a href="#h1-0-26" id="h1-0-26" class="d">-
</a><a href="#h1-0-27" id="h1-0-27" class="d">-[[package]]
</a><a href="#h1-0-28" id="h1-0-28" class="d">-name = &quot;futures-core&quot;
</a><a href="#h1-0-29" id="h1-0-29" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-30" id="h1-0-30" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-31" id="h1-0-31" class="d">-checksum = &quot;dfc6580bb841c5a68e9ef15c77ccc837b40a7504914d52e47b8b0e9bbda25a1d&quot;
</a><a href="#h1-0-32" id="h1-0-32" class="d">-
</a><a href="#h1-0-33" id="h1-0-33" class="d">-[[package]]
</a><a href="#h1-0-34" id="h1-0-34" class="d">-name = &quot;futures-executor&quot;
</a><a href="#h1-0-35" id="h1-0-35" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-36" id="h1-0-36" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-37" id="h1-0-37" class="d">-checksum = &quot;a576fc72ae164fca6b9db127eaa9a9dda0d61316034f33a0a0d4eda41f02b01d&quot;
</a><a href="#h1-0-38" id="h1-0-38" class="d">-dependencies = [
</a><a href="#h1-0-39" id="h1-0-39" class="d">- &quot;futures-core&quot;,
</a><a href="#h1-0-40" id="h1-0-40" class="d">- &quot;futures-task&quot;,
</a><a href="#h1-0-41" id="h1-0-41" class="d">- &quot;futures-util&quot;,
</a><a href="#h1-0-42" id="h1-0-42" class="d">-]
</a><a href="#h1-0-43" id="h1-0-43" class="d">-
</a><a href="#h1-0-44" id="h1-0-44" class="d">-[[package]]
</a><a href="#h1-0-45" id="h1-0-45" class="d">-name = &quot;futures-io&quot;
</a><a href="#h1-0-46" id="h1-0-46" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-47" id="h1-0-47" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-48" id="h1-0-48" class="d">-checksum = &quot;a44623e20b9681a318efdd71c299b6b222ed6f231972bfe2f224ebad6311f0c1&quot;
</a><a href="#h1-0-49" id="h1-0-49" class="d">-
</a><a href="#h1-0-50" id="h1-0-50" class="d">-[[package]]
</a><a href="#h1-0-51" id="h1-0-51" class="d">-name = &quot;futures-sink&quot;
</a><a href="#h1-0-52" id="h1-0-52" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-53" id="h1-0-53" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-54" id="h1-0-54" class="d">-checksum = &quot;9fb8e00e87438d937621c1c6269e53f536c14d3fbd6a042bb24879e57d474fb5&quot;
</a><a href="#h1-0-55" id="h1-0-55" class="d">-
</a><a href="#h1-0-56" id="h1-0-56" class="d">-[[package]]
</a><a href="#h1-0-57" id="h1-0-57" class="d">-name = &quot;futures-task&quot;
</a><a href="#h1-0-58" id="h1-0-58" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-59" id="h1-0-59" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-60" id="h1-0-60" class="d">-checksum = &quot;38d84fa142264698cdce1a9f9172cf383a0c82de1bddcf3092901442c4097004&quot;
</a><a href="#h1-0-61" id="h1-0-61" class="d">-
</a><a href="#h1-0-62" id="h1-0-62" class="d">-[[package]]
</a><a href="#h1-0-63" id="h1-0-63" class="d">-name = &quot;futures-util&quot;
</a><a href="#h1-0-64" id="h1-0-64" class="d">-version = &quot;0.3.30&quot;
</a><a href="#h1-0-65" id="h1-0-65" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-0-66" id="h1-0-66" class="d">-checksum = &quot;3d6401deb83407ab3da39eba7e33987a73c3df0c82b4bb5813ee871c19c41d48&quot;
</a><a href="#h1-0-67" id="h1-0-67" class="d">-dependencies = [
</a><a href="#h1-0-68" id="h1-0-68" class="d">- &quot;futures-channel&quot;,
</a><a href="#h1-0-69" id="h1-0-69" class="d">- &quot;futures-core&quot;,
</a><a href="#h1-0-70" id="h1-0-70" class="d">- &quot;futures-io&quot;,
</a><a href="#h1-0-71" id="h1-0-71" class="d">- &quot;futures-sink&quot;,
</a><a href="#h1-0-72" id="h1-0-72" class="d">- &quot;futures-task&quot;,
</a><a href="#h1-0-73" id="h1-0-73" class="d">- &quot;memchr&quot;,
</a><a href="#h1-0-74" id="h1-0-74" class="d">- &quot;pin-project-lite&quot;,
</a><a href="#h1-0-75" id="h1-0-75" class="d">- &quot;pin-utils&quot;,
</a><a href="#h1-0-76" id="h1-0-76" class="d">- &quot;slab&quot;,
</a><a href="#h1-0-77" id="h1-0-77" class="d">-]
</a><a href="#h1-0-78" id="h1-0-78" class="d">-
</a><a href="#h1-0-79" id="h1-0-79" class="d">-[[package]]
</a> name = &quot;generic-array&quot;
 version = &quot;0.14.7&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-1" id="h1-1" class="h">@@ -721,16 +644,6 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> checksum = &quot;78b3ae25bc7c8c38cec158d1f2757ee79e9b3740fbc7ccf0e59e4b08d793fa89&quot;
 
 [[package]]
<a href="#h1-1-3" id="h1-1-3" class="d">-name = &quot;lock_api&quot;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-version = &quot;0.4.12&quot;
</a><a href="#h1-1-5" id="h1-1-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-1-6" id="h1-1-6" class="d">-checksum = &quot;07af8b9cdd281b7915f413fa73f29ebd5d55d0d3f0155584dade1ff18cea1b17&quot;
</a><a href="#h1-1-7" id="h1-1-7" class="d">-dependencies = [
</a><a href="#h1-1-8" id="h1-1-8" class="d">- &quot;autocfg&quot;,
</a><a href="#h1-1-9" id="h1-1-9" class="d">- &quot;scopeguard&quot;,
</a><a href="#h1-1-10" id="h1-1-10" class="d">-]
</a><a href="#h1-1-11" id="h1-1-11" class="d">-
</a><a href="#h1-1-12" id="h1-1-12" class="d">-[[package]]
</a> name = &quot;log&quot;
 version = &quot;0.4.22&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-2" id="h1-2" class="h">@@ -840,29 +753,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-2-3" id="h1-2-3" class="d">-name = &quot;parking_lot&quot;
</a><a href="#h1-2-4" id="h1-2-4" class="d">-version = &quot;0.12.3&quot;
</a><a href="#h1-2-5" id="h1-2-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-2-6" id="h1-2-6" class="d">-checksum = &quot;f1bf18183cf54e8d6059647fc3063646a1801cf30896933ec2311622cc4b9a27&quot;
</a><a href="#h1-2-7" id="h1-2-7" class="d">-dependencies = [
</a><a href="#h1-2-8" id="h1-2-8" class="d">- &quot;lock_api&quot;,
</a><a href="#h1-2-9" id="h1-2-9" class="d">- &quot;parking_lot_core&quot;,
</a><a href="#h1-2-10" id="h1-2-10" class="d">-]
</a><a href="#h1-2-11" id="h1-2-11" class="d">-
</a><a href="#h1-2-12" id="h1-2-12" class="d">-[[package]]
</a><a href="#h1-2-13" id="h1-2-13" class="d">-name = &quot;parking_lot_core&quot;
</a><a href="#h1-2-14" id="h1-2-14" class="d">-version = &quot;0.9.10&quot;
</a><a href="#h1-2-15" id="h1-2-15" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-2-16" id="h1-2-16" class="d">-checksum = &quot;1e401f977ab385c9e4e3ab30627d6f26d00e2c73eef317493c4ec6d468726cf8&quot;
</a><a href="#h1-2-17" id="h1-2-17" class="d">-dependencies = [
</a><a href="#h1-2-18" id="h1-2-18" class="d">- &quot;cfg-if&quot;,
</a><a href="#h1-2-19" id="h1-2-19" class="d">- &quot;libc&quot;,
</a><a href="#h1-2-20" id="h1-2-20" class="d">- &quot;redox_syscall&quot;,
</a><a href="#h1-2-21" id="h1-2-21" class="d">- &quot;smallvec&quot;,
</a><a href="#h1-2-22" id="h1-2-22" class="d">- &quot;windows-targets&quot;,
</a><a href="#h1-2-23" id="h1-2-23" class="d">-]
</a><a href="#h1-2-24" id="h1-2-24" class="d">-
</a><a href="#h1-2-25" id="h1-2-25" class="d">-[[package]]
</a> name = &quot;paste&quot;
 version = &quot;1.0.15&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-3" id="h1-3" class="h">@@ -934,18 +824,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-3-3" id="h1-3-3" class="d">-name = &quot;pin-project-lite&quot;
</a><a href="#h1-3-4" id="h1-3-4" class="d">-version = &quot;0.2.14&quot;
</a><a href="#h1-3-5" id="h1-3-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-3-6" id="h1-3-6" class="d">-checksum = &quot;bda66fc9667c18cb2758a2ac84d1167245054bcf85d5d1aaa6923f45801bdd02&quot;
</a><a href="#h1-3-7" id="h1-3-7" class="d">-
</a><a href="#h1-3-8" id="h1-3-8" class="d">-[[package]]
</a><a href="#h1-3-9" id="h1-3-9" class="d">-name = &quot;pin-utils&quot;
</a><a href="#h1-3-10" id="h1-3-10" class="d">-version = &quot;0.1.0&quot;
</a><a href="#h1-3-11" id="h1-3-11" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-3-12" id="h1-3-12" class="d">-checksum = &quot;8b870d8c151b6f2fb93e84a13146138f05d02ed11c7e7c54f8826aaaf7c9f184&quot;
</a><a href="#h1-3-13" id="h1-3-13" class="d">-
</a><a href="#h1-3-14" id="h1-3-14" class="d">-[[package]]
</a> name = &quot;powerfmt&quot;
 version = &quot;0.2.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-4" id="h1-4" class="h">@@ -1016,15 +894,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-4-3" id="h1-4-3" class="d">-name = &quot;redox_syscall&quot;
</a><a href="#h1-4-4" id="h1-4-4" class="d">-version = &quot;0.5.3&quot;
</a><a href="#h1-4-5" id="h1-4-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-4-6" id="h1-4-6" class="d">-checksum = &quot;2a908a6e00f1fdd0dfd9c0eb08ce85126f6d8bbda50017e74bc4a4b7d4a926a4&quot;
</a><a href="#h1-4-7" id="h1-4-7" class="d">-dependencies = [
</a><a href="#h1-4-8" id="h1-4-8" class="d">- &quot;bitflags&quot;,
</a><a href="#h1-4-9" id="h1-4-9" class="d">-]
</a><a href="#h1-4-10" id="h1-4-10" class="d">-
</a><a href="#h1-4-11" id="h1-4-11" class="d">-[[package]]
</a> name = &quot;regex&quot;
 version = &quot;1.10.5&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-5" id="h1-5" class="h">@@ -1134,27 +1003,12 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> checksum = &quot;f3cb5ba0dc43242ce17de99c180e96db90b235b8a9fdc9543c96d2209116bd9f&quot;
 
 [[package]]
<a href="#h1-5-3" id="h1-5-3" class="d">-name = &quot;scc&quot;
</a><a href="#h1-5-4" id="h1-5-4" class="d">-version = &quot;2.1.4&quot;
</a><a href="#h1-5-5" id="h1-5-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-5-6" id="h1-5-6" class="d">-checksum = &quot;a4465c22496331e20eb047ff46e7366455bc01c0c02015c4a376de0b2cd3a1af&quot;
</a><a href="#h1-5-7" id="h1-5-7" class="d">-dependencies = [
</a><a href="#h1-5-8" id="h1-5-8" class="d">- &quot;sdd&quot;,
</a><a href="#h1-5-9" id="h1-5-9" class="d">-]
</a><a href="#h1-5-10" id="h1-5-10" class="d">-
</a><a href="#h1-5-11" id="h1-5-11" class="d">-[[package]]
</a> name = &quot;scopeguard&quot;
 version = &quot;1.2.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 checksum = &quot;94143f37725109f92c262ed2cf5e59bce7498c01bcc1502d7b9afe439a4e9f49&quot;
 
 [[package]]
<a href="#h1-5-18" id="h1-5-18" class="d">-name = &quot;sdd&quot;
</a><a href="#h1-5-19" id="h1-5-19" class="d">-version = &quot;1.6.0&quot;
</a><a href="#h1-5-20" id="h1-5-20" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-5-21" id="h1-5-21" class="d">-checksum = &quot;8eb0dde0ccd15e337a3cf738a9a38115c6d8e74795d074e73973dad3d229a897&quot;
</a><a href="#h1-5-22" id="h1-5-22" class="d">-
</a><a href="#h1-5-23" id="h1-5-23" class="d">-[[package]]
</a> name = &quot;serde&quot;
 version = &quot;1.0.204&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-6" id="h1-6" class="h">@@ -1204,31 +1058,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-6-3" id="h1-6-3" class="d">-name = &quot;serial_test&quot;
</a><a href="#h1-6-4" id="h1-6-4" class="d">-version = &quot;3.1.1&quot;
</a><a href="#h1-6-5" id="h1-6-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-6-6" id="h1-6-6" class="d">-checksum = &quot;4b4b487fe2acf240a021cf57c6b2b4903b1e78ca0ecd862a71b71d2a51fed77d&quot;
</a><a href="#h1-6-7" id="h1-6-7" class="d">-dependencies = [
</a><a href="#h1-6-8" id="h1-6-8" class="d">- &quot;futures&quot;,
</a><a href="#h1-6-9" id="h1-6-9" class="d">- &quot;log&quot;,
</a><a href="#h1-6-10" id="h1-6-10" class="d">- &quot;once_cell&quot;,
</a><a href="#h1-6-11" id="h1-6-11" class="d">- &quot;parking_lot&quot;,
</a><a href="#h1-6-12" id="h1-6-12" class="d">- &quot;scc&quot;,
</a><a href="#h1-6-13" id="h1-6-13" class="d">- &quot;serial_test_derive&quot;,
</a><a href="#h1-6-14" id="h1-6-14" class="d">-]
</a><a href="#h1-6-15" id="h1-6-15" class="d">-
</a><a href="#h1-6-16" id="h1-6-16" class="d">-[[package]]
</a><a href="#h1-6-17" id="h1-6-17" class="d">-name = &quot;serial_test_derive&quot;
</a><a href="#h1-6-18" id="h1-6-18" class="d">-version = &quot;3.1.1&quot;
</a><a href="#h1-6-19" id="h1-6-19" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-6-20" id="h1-6-20" class="d">-checksum = &quot;82fe9db325bcef1fbcde82e078a5cc4efdf787e96b3b9cf45b50b529f2083d67&quot;
</a><a href="#h1-6-21" id="h1-6-21" class="d">-dependencies = [
</a><a href="#h1-6-22" id="h1-6-22" class="d">- &quot;proc-macro2&quot;,
</a><a href="#h1-6-23" id="h1-6-23" class="d">- &quot;quote&quot;,
</a><a href="#h1-6-24" id="h1-6-24" class="d">- &quot;syn&quot;,
</a><a href="#h1-6-25" id="h1-6-25" class="d">-]
</a><a href="#h1-6-26" id="h1-6-26" class="d">-
</a><a href="#h1-6-27" id="h1-6-27" class="d">-[[package]]
</a> name = &quot;sha2&quot;
 version = &quot;0.10.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-7" id="h1-7" class="h">@@ -1271,15 +1100,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h1-7-3" id="h1-7-3" class="d">-name = &quot;slab&quot;
</a><a href="#h1-7-4" id="h1-7-4" class="d">-version = &quot;0.4.9&quot;
</a><a href="#h1-7-5" id="h1-7-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h1-7-6" id="h1-7-6" class="d">-checksum = &quot;8f92a496fb766b417c996b9c5e57daf2f7ad3b0bebe1ccfca4856390e3d3bb67&quot;
</a><a href="#h1-7-7" id="h1-7-7" class="d">-dependencies = [
</a><a href="#h1-7-8" id="h1-7-8" class="d">- &quot;autocfg&quot;,
</a><a href="#h1-7-9" id="h1-7-9" class="d">-]
</a><a href="#h1-7-10" id="h1-7-10" class="d">-
</a><a href="#h1-7-11" id="h1-7-11" class="d">-[[package]]
</a> name = &quot;smallvec&quot;
 version = &quot;1.13.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h1-8" id="h1-8" class="h">@@ -1475,7 +1295,6 @@ dependencies = [
</a>  &quot;dyn-clone&quot;,
  &quot;escargot&quot;,
  &quot;fs4&quot;,
<a href="#h1-8-3" id="h1-8-3" class="d">- &quot;goldenfile&quot;,
</a>  &quot;goldenscript&quot;,
  &quot;hdrhistogram&quot;,
  &quot;hex&quot;,
<a href="#h1-9" id="h1-9" class="h">@@ -1490,7 +1309,6 @@ dependencies = [
</a>  &quot;serde&quot;,
  &quot;serde_bytes&quot;,
  &quot;serde_json&quot;,
<a href="#h1-9-3" id="h1-9-3" class="d">- &quot;serial_test&quot;,
</a>  &quot;simplelog&quot;,
  &quot;tempfile&quot;,
  &quot;test-case&quot;,
<b>diff --git a/<a id="h2" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -31,12 +31,10 @@ uuid = { version = &quot;1.8.0&quot;, features = [&quot;serde&quot;, &quot;v4&quot;] }
</a> 
 [dev-dependencies]
 escargot = &quot;0.5.10&quot;
<a href="#h2-0-3" id="h2-0-3" class="d">-goldenfile = &quot;1.7.1&quot;
</a> goldenscript = &quot;0.7.0&quot;
 hex = &quot;0.4.3&quot;
 paste = &quot;1.0.14&quot;
 serde_json = &quot;1.0.117&quot;
<a href="#h2-0-8" id="h2-0-8" class="d">-serial_test = &quot;3.1.1&quot;
</a> tempfile = &quot;3.10.1&quot;
 test-case = &quot;3.3.1&quot;
 test_each_file = &quot;0.3.2&quot;
<b>diff --git a/<a id="h3" href="../file/src/sql/testscripts/transactions/anomaly_phantom_read.html">src/sql/testscripts/transactions/anomaly_phantom_read</a> b/<a href="../file/src/sql/testscripts/transactions/anomaly_phantom_read.html">src/sql/testscripts/transactions/anomaly_phantom_read</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,6 +1,6 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-# A phantom read is when t1 reads entries matching some predicate, but a
</a><a href="#h3-0-1" id="h3-0-1" class="d">-# modification by t2 changes which entries match the predicate such that a later
</a><a href="#h3-0-2" id="h3-0-2" class="d">-# read by t1 returns them. Snapshot isolation prevents this.
</a><a href="#h3-0-3" id="h3-0-3" class="i">+# A phantom read is when c1 reads entries matching some predicate, but a
</a><a href="#h3-0-4" id="h3-0-4" class="i">+# modification by c2 changes which entries match the predicate such that a later
</a><a href="#h3-0-5" id="h3-0-5" class="i">+# read by c1 returns them. Snapshot isolation prevents this.
</a> 
 &gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
 &gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;), (3, &#39;c&#39;)
<b>diff --git a/<a id="h4" href="../file/tests/README.md.html">tests/README.md</a> b/<a href="../file/tests/README.md.html">tests/README.md</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,3 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-This is only a small set of end-to-end tests. Most tests are integration or unit
</a><a href="#h4-0-1" id="h4-0-1" class="d">-tests under `src/` -- in particular the various `testscripts` directories which
</a><a href="#h4-0-2" id="h4-0-2" class="d">-use [Goldenscript](https://github.com/erikgrinaker/goldenscript).
</a><a href="#h4-0-3" id="h4-0-3" class="d">-\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a> b/<a href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,421 +0,0 @@
</a><a href="#h5-0-0" id="h5-0-0" class="d">-use std::collections::BTreeSet;
</a><a href="#h5-0-1" id="h5-0-1" class="d">-
</a><a href="#h5-0-2" id="h5-0-2" class="d">-use super::{assert_row, assert_rows, dataset, TestCluster};
</a><a href="#h5-0-3" id="h5-0-3" class="d">-
</a><a href="#h5-0-4" id="h5-0-4" class="d">-use toydb::error::{Error, Result};
</a><a href="#h5-0-5" id="h5-0-5" class="d">-use toydb::raft;
</a><a href="#h5-0-6" id="h5-0-6" class="d">-use toydb::server::Status;
</a><a href="#h5-0-7" id="h5-0-7" class="d">-use toydb::sql::engine::StatementResult;
</a><a href="#h5-0-8" id="h5-0-8" class="d">-use toydb::sql::types::{Column, DataType, Label, Table, Value};
</a><a href="#h5-0-9" id="h5-0-9" class="d">-use toydb::storage::{engine, mvcc};
</a><a href="#h5-0-10" id="h5-0-10" class="d">-
</a><a href="#h5-0-11" id="h5-0-11" class="d">-use serial_test::serial;
</a><a href="#h5-0-12" id="h5-0-12" class="d">-
</a><a href="#h5-0-13" id="h5-0-13" class="d">-#[test]
</a><a href="#h5-0-14" id="h5-0-14" class="d">-#[serial]
</a><a href="#h5-0-15" id="h5-0-15" class="d">-fn get_table() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-16" id="h5-0-16" class="d">-    let tc = TestCluster::run_with(5, dataset::MOVIES)?;
</a><a href="#h5-0-17" id="h5-0-17" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h5-0-18" id="h5-0-18" class="d">-
</a><a href="#h5-0-19" id="h5-0-19" class="d">-    assert_eq!(
</a><a href="#h5-0-20" id="h5-0-20" class="d">-        c.get_table(&quot;unknown&quot;),
</a><a href="#h5-0-21" id="h5-0-21" class="d">-        Err(Error::InvalidInput(&quot;table unknown does not exist&quot;.into()))
</a><a href="#h5-0-22" id="h5-0-22" class="d">-    );
</a><a href="#h5-0-23" id="h5-0-23" class="d">-    assert_eq!(
</a><a href="#h5-0-24" id="h5-0-24" class="d">-        c.get_table(&quot;movies&quot;)?,
</a><a href="#h5-0-25" id="h5-0-25" class="d">-        Table {
</a><a href="#h5-0-26" id="h5-0-26" class="d">-            name: &quot;movies&quot;.into(),
</a><a href="#h5-0-27" id="h5-0-27" class="d">-            primary_key: 0,
</a><a href="#h5-0-28" id="h5-0-28" class="d">-            columns: vec![
</a><a href="#h5-0-29" id="h5-0-29" class="d">-                Column {
</a><a href="#h5-0-30" id="h5-0-30" class="d">-                    name: &quot;id&quot;.into(),
</a><a href="#h5-0-31" id="h5-0-31" class="d">-                    datatype: DataType::Integer,
</a><a href="#h5-0-32" id="h5-0-32" class="d">-                    nullable: false,
</a><a href="#h5-0-33" id="h5-0-33" class="d">-                    default: None,
</a><a href="#h5-0-34" id="h5-0-34" class="d">-                    unique: true,
</a><a href="#h5-0-35" id="h5-0-35" class="d">-                    index: false,
</a><a href="#h5-0-36" id="h5-0-36" class="d">-                    references: None,
</a><a href="#h5-0-37" id="h5-0-37" class="d">-                },
</a><a href="#h5-0-38" id="h5-0-38" class="d">-                Column {
</a><a href="#h5-0-39" id="h5-0-39" class="d">-                    name: &quot;title&quot;.into(),
</a><a href="#h5-0-40" id="h5-0-40" class="d">-                    datatype: DataType::String,
</a><a href="#h5-0-41" id="h5-0-41" class="d">-                    nullable: false,
</a><a href="#h5-0-42" id="h5-0-42" class="d">-                    default: None,
</a><a href="#h5-0-43" id="h5-0-43" class="d">-                    unique: false,
</a><a href="#h5-0-44" id="h5-0-44" class="d">-                    index: false,
</a><a href="#h5-0-45" id="h5-0-45" class="d">-                    references: None,
</a><a href="#h5-0-46" id="h5-0-46" class="d">-                },
</a><a href="#h5-0-47" id="h5-0-47" class="d">-                Column {
</a><a href="#h5-0-48" id="h5-0-48" class="d">-                    name: &quot;studio_id&quot;.into(),
</a><a href="#h5-0-49" id="h5-0-49" class="d">-                    datatype: DataType::Integer,
</a><a href="#h5-0-50" id="h5-0-50" class="d">-                    nullable: false,
</a><a href="#h5-0-51" id="h5-0-51" class="d">-                    default: None,
</a><a href="#h5-0-52" id="h5-0-52" class="d">-                    unique: false,
</a><a href="#h5-0-53" id="h5-0-53" class="d">-                    index: true,
</a><a href="#h5-0-54" id="h5-0-54" class="d">-                    references: Some(&quot;studios&quot;.into()),
</a><a href="#h5-0-55" id="h5-0-55" class="d">-                },
</a><a href="#h5-0-56" id="h5-0-56" class="d">-                Column {
</a><a href="#h5-0-57" id="h5-0-57" class="d">-                    name: &quot;genre_id&quot;.into(),
</a><a href="#h5-0-58" id="h5-0-58" class="d">-                    datatype: DataType::Integer,
</a><a href="#h5-0-59" id="h5-0-59" class="d">-                    nullable: false,
</a><a href="#h5-0-60" id="h5-0-60" class="d">-                    default: None,
</a><a href="#h5-0-61" id="h5-0-61" class="d">-                    unique: false,
</a><a href="#h5-0-62" id="h5-0-62" class="d">-                    index: true,
</a><a href="#h5-0-63" id="h5-0-63" class="d">-                    references: Some(&quot;genres&quot;.into()),
</a><a href="#h5-0-64" id="h5-0-64" class="d">-                },
</a><a href="#h5-0-65" id="h5-0-65" class="d">-                Column {
</a><a href="#h5-0-66" id="h5-0-66" class="d">-                    name: &quot;released&quot;.into(),
</a><a href="#h5-0-67" id="h5-0-67" class="d">-                    datatype: DataType::Integer,
</a><a href="#h5-0-68" id="h5-0-68" class="d">-                    nullable: false,
</a><a href="#h5-0-69" id="h5-0-69" class="d">-                    default: None,
</a><a href="#h5-0-70" id="h5-0-70" class="d">-                    unique: false,
</a><a href="#h5-0-71" id="h5-0-71" class="d">-                    index: false,
</a><a href="#h5-0-72" id="h5-0-72" class="d">-                    references: None,
</a><a href="#h5-0-73" id="h5-0-73" class="d">-                },
</a><a href="#h5-0-74" id="h5-0-74" class="d">-                Column {
</a><a href="#h5-0-75" id="h5-0-75" class="d">-                    name: &quot;rating&quot;.into(),
</a><a href="#h5-0-76" id="h5-0-76" class="d">-                    datatype: DataType::Float,
</a><a href="#h5-0-77" id="h5-0-77" class="d">-                    nullable: true,
</a><a href="#h5-0-78" id="h5-0-78" class="d">-                    default: Some(Value::Null),
</a><a href="#h5-0-79" id="h5-0-79" class="d">-                    unique: false,
</a><a href="#h5-0-80" id="h5-0-80" class="d">-                    index: false,
</a><a href="#h5-0-81" id="h5-0-81" class="d">-                    references: None,
</a><a href="#h5-0-82" id="h5-0-82" class="d">-                },
</a><a href="#h5-0-83" id="h5-0-83" class="d">-                Column {
</a><a href="#h5-0-84" id="h5-0-84" class="d">-                    name: &quot;ultrahd&quot;.into(),
</a><a href="#h5-0-85" id="h5-0-85" class="d">-                    datatype: DataType::Boolean,
</a><a href="#h5-0-86" id="h5-0-86" class="d">-                    nullable: true,
</a><a href="#h5-0-87" id="h5-0-87" class="d">-                    default: Some(Value::Null),
</a><a href="#h5-0-88" id="h5-0-88" class="d">-                    unique: false,
</a><a href="#h5-0-89" id="h5-0-89" class="d">-                    index: false,
</a><a href="#h5-0-90" id="h5-0-90" class="d">-                    references: None,
</a><a href="#h5-0-91" id="h5-0-91" class="d">-                },
</a><a href="#h5-0-92" id="h5-0-92" class="d">-            ]
</a><a href="#h5-0-93" id="h5-0-93" class="d">-        }
</a><a href="#h5-0-94" id="h5-0-94" class="d">-    );
</a><a href="#h5-0-95" id="h5-0-95" class="d">-    Ok(())
</a><a href="#h5-0-96" id="h5-0-96" class="d">-}
</a><a href="#h5-0-97" id="h5-0-97" class="d">-
</a><a href="#h5-0-98" id="h5-0-98" class="d">-#[test]
</a><a href="#h5-0-99" id="h5-0-99" class="d">-#[serial]
</a><a href="#h5-0-100" id="h5-0-100" class="d">-fn list_tables() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-101" id="h5-0-101" class="d">-    let tc = TestCluster::run_with(5, dataset::MOVIES)?;
</a><a href="#h5-0-102" id="h5-0-102" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h5-0-103" id="h5-0-103" class="d">-
</a><a href="#h5-0-104" id="h5-0-104" class="d">-    assert_eq!(c.list_tables()?, vec![&quot;countries&quot;, &quot;genres&quot;, &quot;movies&quot;, &quot;studios&quot;]);
</a><a href="#h5-0-105" id="h5-0-105" class="d">-    Ok(())
</a><a href="#h5-0-106" id="h5-0-106" class="d">-}
</a><a href="#h5-0-107" id="h5-0-107" class="d">-
</a><a href="#h5-0-108" id="h5-0-108" class="d">-#[test]
</a><a href="#h5-0-109" id="h5-0-109" class="d">-#[serial]
</a><a href="#h5-0-110" id="h5-0-110" class="d">-fn status() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-111" id="h5-0-111" class="d">-    let tc = TestCluster::run_with(1, dataset::MOVIES)?;
</a><a href="#h5-0-112" id="h5-0-112" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h5-0-113" id="h5-0-113" class="d">-
</a><a href="#h5-0-114" id="h5-0-114" class="d">-    assert_eq!(
</a><a href="#h5-0-115" id="h5-0-115" class="d">-        c.status()?,
</a><a href="#h5-0-116" id="h5-0-116" class="d">-        Status {
</a><a href="#h5-0-117" id="h5-0-117" class="d">-            server: 1,
</a><a href="#h5-0-118" id="h5-0-118" class="d">-            raft: raft::Status {
</a><a href="#h5-0-119" id="h5-0-119" class="d">-                leader: 1,
</a><a href="#h5-0-120" id="h5-0-120" class="d">-                term: 1,
</a><a href="#h5-0-121" id="h5-0-121" class="d">-                match_index: [(1, 11)].into(),
</a><a href="#h5-0-122" id="h5-0-122" class="d">-                commit_index: 11,
</a><a href="#h5-0-123" id="h5-0-123" class="d">-                applied_index: 11,
</a><a href="#h5-0-124" id="h5-0-124" class="d">-                storage: engine::Status {
</a><a href="#h5-0-125" id="h5-0-125" class="d">-                    name: &quot;bitcask&quot;.to_string(),
</a><a href="#h5-0-126" id="h5-0-126" class="d">-                    keys: 13,
</a><a href="#h5-0-127" id="h5-0-127" class="d">-                    size: 952,
</a><a href="#h5-0-128" id="h5-0-128" class="d">-                    total_disk_size: 1166,
</a><a href="#h5-0-129" id="h5-0-129" class="d">-                    live_disk_size: 1056,
</a><a href="#h5-0-130" id="h5-0-130" class="d">-                    garbage_disk_size: 110,
</a><a href="#h5-0-131" id="h5-0-131" class="d">-                },
</a><a href="#h5-0-132" id="h5-0-132" class="d">-            },
</a><a href="#h5-0-133" id="h5-0-133" class="d">-            mvcc: mvcc::Status {
</a><a href="#h5-0-134" id="h5-0-134" class="d">-                versions: 1,
</a><a href="#h5-0-135" id="h5-0-135" class="d">-                active_txns: 0,
</a><a href="#h5-0-136" id="h5-0-136" class="d">-                storage: engine::Status {
</a><a href="#h5-0-137" id="h5-0-137" class="d">-                    name: &quot;bitcask&quot;.to_string(),
</a><a href="#h5-0-138" id="h5-0-138" class="d">-                    keys: 36,
</a><a href="#h5-0-139" id="h5-0-139" class="d">-                    size: 2177,
</a><a href="#h5-0-140" id="h5-0-140" class="d">-                    total_disk_size: 7601,
</a><a href="#h5-0-141" id="h5-0-141" class="d">-                    live_disk_size: 2465,
</a><a href="#h5-0-142" id="h5-0-142" class="d">-                    garbage_disk_size: 5136,
</a><a href="#h5-0-143" id="h5-0-143" class="d">-                },
</a><a href="#h5-0-144" id="h5-0-144" class="d">-            }
</a><a href="#h5-0-145" id="h5-0-145" class="d">-        },
</a><a href="#h5-0-146" id="h5-0-146" class="d">-    );
</a><a href="#h5-0-147" id="h5-0-147" class="d">-    Ok(())
</a><a href="#h5-0-148" id="h5-0-148" class="d">-}
</a><a href="#h5-0-149" id="h5-0-149" class="d">-
</a><a href="#h5-0-150" id="h5-0-150" class="d">-#[test]
</a><a href="#h5-0-151" id="h5-0-151" class="d">-#[serial]
</a><a href="#h5-0-152" id="h5-0-152" class="d">-fn execute() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-153" id="h5-0-153" class="d">-    let tc = TestCluster::run_with(5, dataset::MOVIES)?;
</a><a href="#h5-0-154" id="h5-0-154" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h5-0-155" id="h5-0-155" class="d">-
</a><a href="#h5-0-156" id="h5-0-156" class="d">-    // SELECT
</a><a href="#h5-0-157" id="h5-0-157" class="d">-    let result = c.execute(&quot;SELECT * FROM genres&quot;)?;
</a><a href="#h5-0-158" id="h5-0-158" class="d">-    assert_eq!(
</a><a href="#h5-0-159" id="h5-0-159" class="d">-        result,
</a><a href="#h5-0-160" id="h5-0-160" class="d">-        StatementResult::Select {
</a><a href="#h5-0-161" id="h5-0-161" class="d">-            columns: vec![
</a><a href="#h5-0-162" id="h5-0-162" class="d">-                Label::Qualified(&quot;genres&quot;.into(), &quot;id&quot;.into()),
</a><a href="#h5-0-163" id="h5-0-163" class="d">-                Label::Qualified(&quot;genres&quot;.into(), &quot;name&quot;.into()),
</a><a href="#h5-0-164" id="h5-0-164" class="d">-            ],
</a><a href="#h5-0-165" id="h5-0-165" class="d">-            rows: vec![
</a><a href="#h5-0-166" id="h5-0-166" class="d">-                vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h5-0-167" id="h5-0-167" class="d">-                vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h5-0-168" id="h5-0-168" class="d">-                vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h5-0-169" id="h5-0-169" class="d">-            ],
</a><a href="#h5-0-170" id="h5-0-170" class="d">-        }
</a><a href="#h5-0-171" id="h5-0-171" class="d">-    );
</a><a href="#h5-0-172" id="h5-0-172" class="d">-
</a><a href="#h5-0-173" id="h5-0-173" class="d">-    let result = c.execute(&quot;SELECT * FROM genres WHERE FALSE&quot;)?;
</a><a href="#h5-0-174" id="h5-0-174" class="d">-    assert_eq!(
</a><a href="#h5-0-175" id="h5-0-175" class="d">-        result,
</a><a href="#h5-0-176" id="h5-0-176" class="d">-        StatementResult::Select {
</a><a href="#h5-0-177" id="h5-0-177" class="d">-            columns: vec![
</a><a href="#h5-0-178" id="h5-0-178" class="d">-                Label::Qualified(&quot;genres&quot;.into(), &quot;id&quot;.into()),
</a><a href="#h5-0-179" id="h5-0-179" class="d">-                Label::Qualified(&quot;genres&quot;.into(), &quot;name&quot;.into()),
</a><a href="#h5-0-180" id="h5-0-180" class="d">-            ],
</a><a href="#h5-0-181" id="h5-0-181" class="d">-            rows: vec![],
</a><a href="#h5-0-182" id="h5-0-182" class="d">-        }
</a><a href="#h5-0-183" id="h5-0-183" class="d">-    );
</a><a href="#h5-0-184" id="h5-0-184" class="d">-
</a><a href="#h5-0-185" id="h5-0-185" class="d">-    assert_eq!(
</a><a href="#h5-0-186" id="h5-0-186" class="d">-        c.execute(&quot;SELECT * FROM x&quot;),
</a><a href="#h5-0-187" id="h5-0-187" class="d">-        Err(Error::InvalidInput(&quot;table x does not exist&quot;.into()))
</a><a href="#h5-0-188" id="h5-0-188" class="d">-    );
</a><a href="#h5-0-189" id="h5-0-189" class="d">-
</a><a href="#h5-0-190" id="h5-0-190" class="d">-    // INSERT
</a><a href="#h5-0-191" id="h5-0-191" class="d">-    assert_eq!(
</a><a href="#h5-0-192" id="h5-0-192" class="d">-        c.execute(&quot;INSERT INTO genres VALUES (1, &#39;Western&#39;)&quot;),
</a><a href="#h5-0-193" id="h5-0-193" class="d">-        Err(Error::InvalidInput(&quot;primary key 1 already exists&quot;.into())),
</a><a href="#h5-0-194" id="h5-0-194" class="d">-    );
</a><a href="#h5-0-195" id="h5-0-195" class="d">-    assert_eq!(
</a><a href="#h5-0-196" id="h5-0-196" class="d">-        c.execute(&quot;INSERT INTO genres VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h5-0-197" id="h5-0-197" class="d">-        Ok(StatementResult::Insert { count: 1 }),
</a><a href="#h5-0-198" id="h5-0-198" class="d">-    );
</a><a href="#h5-0-199" id="h5-0-199" class="d">-    assert_eq!(
</a><a href="#h5-0-200" id="h5-0-200" class="d">-        c.execute(&quot;INSERT INTO x VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h5-0-201" id="h5-0-201" class="d">-        Err(Error::InvalidInput(&quot;table x does not exist&quot;.into()))
</a><a href="#h5-0-202" id="h5-0-202" class="d">-    );
</a><a href="#h5-0-203" id="h5-0-203" class="d">-
</a><a href="#h5-0-204" id="h5-0-204" class="d">-    // UPDATE
</a><a href="#h5-0-205" id="h5-0-205" class="d">-    assert_eq!(
</a><a href="#h5-0-206" id="h5-0-206" class="d">-        c.execute(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE FALSE&quot;),
</a><a href="#h5-0-207" id="h5-0-207" class="d">-        Ok(StatementResult::Update { count: 0 }),
</a><a href="#h5-0-208" id="h5-0-208" class="d">-    );
</a><a href="#h5-0-209" id="h5-0-209" class="d">-    assert_eq!(
</a><a href="#h5-0-210" id="h5-0-210" class="d">-        c.execute(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE id = 9&quot;),
</a><a href="#h5-0-211" id="h5-0-211" class="d">-        Ok(StatementResult::Update { count: 1 }),
</a><a href="#h5-0-212" id="h5-0-212" class="d">-    );
</a><a href="#h5-0-213" id="h5-0-213" class="d">-    assert_eq!(
</a><a href="#h5-0-214" id="h5-0-214" class="d">-        c.execute(&quot;UPDATE genres SET id = 1 WHERE id = 9&quot;),
</a><a href="#h5-0-215" id="h5-0-215" class="d">-        Err(Error::InvalidInput(&quot;primary key 1 already exists&quot;.into()))
</a><a href="#h5-0-216" id="h5-0-216" class="d">-    );
</a><a href="#h5-0-217" id="h5-0-217" class="d">-
</a><a href="#h5-0-218" id="h5-0-218" class="d">-    // DELETE
</a><a href="#h5-0-219" id="h5-0-219" class="d">-    assert_eq!(
</a><a href="#h5-0-220" id="h5-0-220" class="d">-        c.execute(&quot;DELETE FROM genres WHERE FALSE&quot;),
</a><a href="#h5-0-221" id="h5-0-221" class="d">-        Ok(StatementResult::Delete { count: 0 }),
</a><a href="#h5-0-222" id="h5-0-222" class="d">-    );
</a><a href="#h5-0-223" id="h5-0-223" class="d">-    assert_eq!(
</a><a href="#h5-0-224" id="h5-0-224" class="d">-        c.execute(&quot;DELETE FROM genres WHERE id = 9&quot;),
</a><a href="#h5-0-225" id="h5-0-225" class="d">-        Ok(StatementResult::Delete { count: 1 }),
</a><a href="#h5-0-226" id="h5-0-226" class="d">-    );
</a><a href="#h5-0-227" id="h5-0-227" class="d">-    assert_eq!(
</a><a href="#h5-0-228" id="h5-0-228" class="d">-        c.execute(&quot;DELETE FROM genres WHERE x = 1&quot;),
</a><a href="#h5-0-229" id="h5-0-229" class="d">-        Err(Error::InvalidInput(&quot;unknown column x&quot;.into()))
</a><a href="#h5-0-230" id="h5-0-230" class="d">-    );
</a><a href="#h5-0-231" id="h5-0-231" class="d">-
</a><a href="#h5-0-232" id="h5-0-232" class="d">-    Ok(())
</a><a href="#h5-0-233" id="h5-0-233" class="d">-}
</a><a href="#h5-0-234" id="h5-0-234" class="d">-
</a><a href="#h5-0-235" id="h5-0-235" class="d">-#[test]
</a><a href="#h5-0-236" id="h5-0-236" class="d">-#[serial]
</a><a href="#h5-0-237" id="h5-0-237" class="d">-fn execute_txn() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-238" id="h5-0-238" class="d">-    let tc = TestCluster::run_with(5, dataset::MOVIES)?;
</a><a href="#h5-0-239" id="h5-0-239" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h5-0-240" id="h5-0-240" class="d">-
</a><a href="#h5-0-241" id="h5-0-241" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h5-0-242" id="h5-0-242" class="d">-
</a><a href="#h5-0-243" id="h5-0-243" class="d">-    // Committing a change in a txn should work
</a><a href="#h5-0-244" id="h5-0-244" class="d">-    assert_eq!(
</a><a href="#h5-0-245" id="h5-0-245" class="d">-        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h5-0-246" id="h5-0-246" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-247" id="h5-0-247" class="d">-            version: 2,
</a><a href="#h5-0-248" id="h5-0-248" class="d">-            read_only: false,
</a><a href="#h5-0-249" id="h5-0-249" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-250" id="h5-0-250" class="d">-        })
</a><a href="#h5-0-251" id="h5-0-251" class="d">-    );
</a><a href="#h5-0-252" id="h5-0-252" class="d">-    assert_eq!(
</a><a href="#h5-0-253" id="h5-0-253" class="d">-        c.txn(),
</a><a href="#h5-0-254" id="h5-0-254" class="d">-        Some(&amp;mvcc::TransactionState { version: 2, read_only: false, active: BTreeSet::new() })
</a><a href="#h5-0-255" id="h5-0-255" class="d">-    );
</a><a href="#h5-0-256" id="h5-0-256" class="d">-    c.execute(&quot;INSERT INTO genres VALUES (4, &#39;Drama&#39;)&quot;)?;
</a><a href="#h5-0-257" id="h5-0-257" class="d">-    assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 2 });
</a><a href="#h5-0-258" id="h5-0-258" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h5-0-259" id="h5-0-259" class="d">-    assert_row(
</a><a href="#h5-0-260" id="h5-0-260" class="d">-        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h5-0-261" id="h5-0-261" class="d">-        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h5-0-262" id="h5-0-262" class="d">-    );
</a><a href="#h5-0-263" id="h5-0-263" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h5-0-264" id="h5-0-264" class="d">-
</a><a href="#h5-0-265" id="h5-0-265" class="d">-    // Rolling back a change in a txn should also work
</a><a href="#h5-0-266" id="h5-0-266" class="d">-    assert_eq!(
</a><a href="#h5-0-267" id="h5-0-267" class="d">-        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h5-0-268" id="h5-0-268" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-269" id="h5-0-269" class="d">-            version: 3,
</a><a href="#h5-0-270" id="h5-0-270" class="d">-            read_only: false,
</a><a href="#h5-0-271" id="h5-0-271" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-272" id="h5-0-272" class="d">-        })
</a><a href="#h5-0-273" id="h5-0-273" class="d">-    );
</a><a href="#h5-0-274" id="h5-0-274" class="d">-    assert_eq!(
</a><a href="#h5-0-275" id="h5-0-275" class="d">-        c.txn(),
</a><a href="#h5-0-276" id="h5-0-276" class="d">-        Some(&amp;mvcc::TransactionState { version: 3, read_only: false, active: BTreeSet::new() })
</a><a href="#h5-0-277" id="h5-0-277" class="d">-    );
</a><a href="#h5-0-278" id="h5-0-278" class="d">-    c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;)?;
</a><a href="#h5-0-279" id="h5-0-279" class="d">-    assert_row(
</a><a href="#h5-0-280" id="h5-0-280" class="d">-        c.execute(&quot;SELECT * FROM genres WHERE id = 5&quot;)?,
</a><a href="#h5-0-281" id="h5-0-281" class="d">-        vec![Value::Integer(5), Value::String(&quot;Musical&quot;.into())],
</a><a href="#h5-0-282" id="h5-0-282" class="d">-    );
</a><a href="#h5-0-283" id="h5-0-283" class="d">-    assert_eq!(c.execute(&quot;ROLLBACK&quot;)?, StatementResult::Rollback { version: 3 });
</a><a href="#h5-0-284" id="h5-0-284" class="d">-    assert_rows(c.execute(&quot;SELECT * FROM genres WHERE id = 5&quot;)?, Vec::new());
</a><a href="#h5-0-285" id="h5-0-285" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h5-0-286" id="h5-0-286" class="d">-
</a><a href="#h5-0-287" id="h5-0-287" class="d">-    // Starting a read-only txn should block writes
</a><a href="#h5-0-288" id="h5-0-288" class="d">-    assert_eq!(
</a><a href="#h5-0-289" id="h5-0-289" class="d">-        c.execute(&quot;BEGIN READ ONLY&quot;)?,
</a><a href="#h5-0-290" id="h5-0-290" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-291" id="h5-0-291" class="d">-            version: 4,
</a><a href="#h5-0-292" id="h5-0-292" class="d">-            read_only: true,
</a><a href="#h5-0-293" id="h5-0-293" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-294" id="h5-0-294" class="d">-        })
</a><a href="#h5-0-295" id="h5-0-295" class="d">-    );
</a><a href="#h5-0-296" id="h5-0-296" class="d">-    assert_eq!(
</a><a href="#h5-0-297" id="h5-0-297" class="d">-        c.txn(),
</a><a href="#h5-0-298" id="h5-0-298" class="d">-        Some(&amp;mvcc::TransactionState { version: 4, read_only: true, active: BTreeSet::new() })
</a><a href="#h5-0-299" id="h5-0-299" class="d">-    );
</a><a href="#h5-0-300" id="h5-0-300" class="d">-    assert_row(
</a><a href="#h5-0-301" id="h5-0-301" class="d">-        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h5-0-302" id="h5-0-302" class="d">-        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h5-0-303" id="h5-0-303" class="d">-    );
</a><a href="#h5-0-304" id="h5-0-304" class="d">-    assert_eq!(c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h5-0-305" id="h5-0-305" class="d">-    assert_row(
</a><a href="#h5-0-306" id="h5-0-306" class="d">-        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h5-0-307" id="h5-0-307" class="d">-        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h5-0-308" id="h5-0-308" class="d">-    );
</a><a href="#h5-0-309" id="h5-0-309" class="d">-    assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 4 });
</a><a href="#h5-0-310" id="h5-0-310" class="d">-
</a><a href="#h5-0-311" id="h5-0-311" class="d">-    // Starting a time-travel txn should work, it shouldn&#39;t see recent changes, and it should
</a><a href="#h5-0-312" id="h5-0-312" class="d">-    // block writes
</a><a href="#h5-0-313" id="h5-0-313" class="d">-    assert_eq!(
</a><a href="#h5-0-314" id="h5-0-314" class="d">-        c.execute(&quot;BEGIN READ ONLY AS OF SYSTEM TIME 2&quot;)?,
</a><a href="#h5-0-315" id="h5-0-315" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-316" id="h5-0-316" class="d">-            version: 2,
</a><a href="#h5-0-317" id="h5-0-317" class="d">-            read_only: true,
</a><a href="#h5-0-318" id="h5-0-318" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-319" id="h5-0-319" class="d">-        }),
</a><a href="#h5-0-320" id="h5-0-320" class="d">-    );
</a><a href="#h5-0-321" id="h5-0-321" class="d">-    assert_eq!(
</a><a href="#h5-0-322" id="h5-0-322" class="d">-        c.txn(),
</a><a href="#h5-0-323" id="h5-0-323" class="d">-        Some(&amp;mvcc::TransactionState { version: 2, read_only: true, active: BTreeSet::new() })
</a><a href="#h5-0-324" id="h5-0-324" class="d">-    );
</a><a href="#h5-0-325" id="h5-0-325" class="d">-    assert_rows(
</a><a href="#h5-0-326" id="h5-0-326" class="d">-        c.execute(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h5-0-327" id="h5-0-327" class="d">-        vec![
</a><a href="#h5-0-328" id="h5-0-328" class="d">-            vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h5-0-329" id="h5-0-329" class="d">-            vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h5-0-330" id="h5-0-330" class="d">-            vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h5-0-331" id="h5-0-331" class="d">-        ],
</a><a href="#h5-0-332" id="h5-0-332" class="d">-    );
</a><a href="#h5-0-333" id="h5-0-333" class="d">-    assert_eq!(c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h5-0-334" id="h5-0-334" class="d">-    assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 2 });
</a><a href="#h5-0-335" id="h5-0-335" class="d">-
</a><a href="#h5-0-336" id="h5-0-336" class="d">-    // A txn should still be usable after an error occurs
</a><a href="#h5-0-337" id="h5-0-337" class="d">-    assert_eq!(
</a><a href="#h5-0-338" id="h5-0-338" class="d">-        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h5-0-339" id="h5-0-339" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-340" id="h5-0-340" class="d">-            version: 4,
</a><a href="#h5-0-341" id="h5-0-341" class="d">-            read_only: false,
</a><a href="#h5-0-342" id="h5-0-342" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-343" id="h5-0-343" class="d">-        })
</a><a href="#h5-0-344" id="h5-0-344" class="d">-    );
</a><a href="#h5-0-345" id="h5-0-345" class="d">-    c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Horror&#39;)&quot;)?;
</a><a href="#h5-0-346" id="h5-0-346" class="d">-    assert_eq!(
</a><a href="#h5-0-347" id="h5-0-347" class="d">-        c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;),
</a><a href="#h5-0-348" id="h5-0-348" class="d">-        Err(Error::InvalidInput(&quot;primary key 5 already exists&quot;.into()))
</a><a href="#h5-0-349" id="h5-0-349" class="d">-    );
</a><a href="#h5-0-350" id="h5-0-350" class="d">-    assert_eq!(
</a><a href="#h5-0-351" id="h5-0-351" class="d">-        c.txn(),
</a><a href="#h5-0-352" id="h5-0-352" class="d">-        Some(&amp;mvcc::TransactionState { version: 4, read_only: false, active: BTreeSet::new() })
</a><a href="#h5-0-353" id="h5-0-353" class="d">-    );
</a><a href="#h5-0-354" id="h5-0-354" class="d">-    c.execute(&quot;INSERT INTO genres VALUES (6, &#39;Western&#39;)&quot;)?;
</a><a href="#h5-0-355" id="h5-0-355" class="d">-    assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 4 });
</a><a href="#h5-0-356" id="h5-0-356" class="d">-    assert_rows(
</a><a href="#h5-0-357" id="h5-0-357" class="d">-        c.execute(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h5-0-358" id="h5-0-358" class="d">-        vec![
</a><a href="#h5-0-359" id="h5-0-359" class="d">-            vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h5-0-360" id="h5-0-360" class="d">-            vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
</a><a href="#h5-0-361" id="h5-0-361" class="d">-            vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
</a><a href="#h5-0-362" id="h5-0-362" class="d">-            vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h5-0-363" id="h5-0-363" class="d">-            vec![Value::Integer(5), Value::String(&quot;Horror&quot;.into())],
</a><a href="#h5-0-364" id="h5-0-364" class="d">-            vec![Value::Integer(6), Value::String(&quot;Western&quot;.into())],
</a><a href="#h5-0-365" id="h5-0-365" class="d">-        ],
</a><a href="#h5-0-366" id="h5-0-366" class="d">-    );
</a><a href="#h5-0-367" id="h5-0-367" class="d">-
</a><a href="#h5-0-368" id="h5-0-368" class="d">-    Ok(())
</a><a href="#h5-0-369" id="h5-0-369" class="d">-}
</a><a href="#h5-0-370" id="h5-0-370" class="d">-
</a><a href="#h5-0-371" id="h5-0-371" class="d">-#[test]
</a><a href="#h5-0-372" id="h5-0-372" class="d">-#[serial]
</a><a href="#h5-0-373" id="h5-0-373" class="d">-fn execute_txn_concurrent() -&gt; Result&lt;()&gt; {
</a><a href="#h5-0-374" id="h5-0-374" class="d">-    let tc = TestCluster::run_with(5, dataset::MOVIES)?;
</a><a href="#h5-0-375" id="h5-0-375" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h5-0-376" id="h5-0-376" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h5-0-377" id="h5-0-377" class="d">-
</a><a href="#h5-0-378" id="h5-0-378" class="d">-    // Concurrent updates should throw a serialization failure on conflict.
</a><a href="#h5-0-379" id="h5-0-379" class="d">-    assert_eq!(
</a><a href="#h5-0-380" id="h5-0-380" class="d">-        a.execute(&quot;BEGIN&quot;)?,
</a><a href="#h5-0-381" id="h5-0-381" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-382" id="h5-0-382" class="d">-            version: 2,
</a><a href="#h5-0-383" id="h5-0-383" class="d">-            read_only: false,
</a><a href="#h5-0-384" id="h5-0-384" class="d">-            active: BTreeSet::new()
</a><a href="#h5-0-385" id="h5-0-385" class="d">-        })
</a><a href="#h5-0-386" id="h5-0-386" class="d">-    );
</a><a href="#h5-0-387" id="h5-0-387" class="d">-    assert_eq!(
</a><a href="#h5-0-388" id="h5-0-388" class="d">-        b.execute(&quot;BEGIN&quot;)?,
</a><a href="#h5-0-389" id="h5-0-389" class="d">-        StatementResult::Begin(mvcc::TransactionState {
</a><a href="#h5-0-390" id="h5-0-390" class="d">-            version: 3,
</a><a href="#h5-0-391" id="h5-0-391" class="d">-            read_only: false,
</a><a href="#h5-0-392" id="h5-0-392" class="d">-            active: BTreeSet::from([2])
</a><a href="#h5-0-393" id="h5-0-393" class="d">-        })
</a><a href="#h5-0-394" id="h5-0-394" class="d">-    );
</a><a href="#h5-0-395" id="h5-0-395" class="d">-
</a><a href="#h5-0-396" id="h5-0-396" class="d">-    assert_row(
</a><a href="#h5-0-397" id="h5-0-397" class="d">-        a.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h5-0-398" id="h5-0-398" class="d">-        vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h5-0-399" id="h5-0-399" class="d">-    );
</a><a href="#h5-0-400" id="h5-0-400" class="d">-    assert_row(
</a><a href="#h5-0-401" id="h5-0-401" class="d">-        b.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h5-0-402" id="h5-0-402" class="d">-        vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a><a href="#h5-0-403" id="h5-0-403" class="d">-    );
</a><a href="#h5-0-404" id="h5-0-404" class="d">-
</a><a href="#h5-0-405" id="h5-0-405" class="d">-    assert_eq!(
</a><a href="#h5-0-406" id="h5-0-406" class="d">-        a.execute(&quot;UPDATE genres SET name = &#39;x&#39; WHERE id = 1&quot;),
</a><a href="#h5-0-407" id="h5-0-407" class="d">-        Ok(StatementResult::Update { count: 1 })
</a><a href="#h5-0-408" id="h5-0-408" class="d">-    );
</a><a href="#h5-0-409" id="h5-0-409" class="d">-    assert_eq!(b.execute(&quot;UPDATE genres SET name = &#39;y&#39; WHERE id = 1&quot;), Err(Error::Serialization));
</a><a href="#h5-0-410" id="h5-0-410" class="d">-
</a><a href="#h5-0-411" id="h5-0-411" class="d">-    assert_eq!(a.execute(&quot;COMMIT&quot;), Ok(StatementResult::Commit { version: 2 }));
</a><a href="#h5-0-412" id="h5-0-412" class="d">-    assert_eq!(b.execute(&quot;ROLLBACK&quot;), Ok(StatementResult::Rollback { version: 3 }));
</a><a href="#h5-0-413" id="h5-0-413" class="d">-
</a><a href="#h5-0-414" id="h5-0-414" class="d">-    assert_row(
</a><a href="#h5-0-415" id="h5-0-415" class="d">-        a.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h5-0-416" id="h5-0-416" class="d">-        vec![Value::Integer(1), Value::String(&quot;x&quot;.into())],
</a><a href="#h5-0-417" id="h5-0-417" class="d">-    );
</a><a href="#h5-0-418" id="h5-0-418" class="d">-
</a><a href="#h5-0-419" id="h5-0-419" class="d">-    Ok(())
</a><a href="#h5-0-420" id="h5-0-420" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/tests/e2e/dataset.rs.html">tests/e2e/dataset.rs</a> b/<a href="../file/tests/e2e/dataset.rs.html">tests/e2e/dataset.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,51 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-//! Pre-defined datasets.
</a><a href="#h6-0-1" id="h6-0-1" class="d">-
</a><a href="#h6-0-2" id="h6-0-2" class="d">-pub static TEST_TABLE: &amp;str = &quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;;
</a><a href="#h6-0-3" id="h6-0-3" class="d">-
</a><a href="#h6-0-4" id="h6-0-4" class="d">-pub static MOVIES: &amp;str = &quot;
</a><a href="#h6-0-5" id="h6-0-5" class="d">-        CREATE TABLE countries (
</a><a href="#h6-0-6" id="h6-0-6" class="d">-            id STRING PRIMARY KEY,
</a><a href="#h6-0-7" id="h6-0-7" class="d">-            name STRING NOT NULL
</a><a href="#h6-0-8" id="h6-0-8" class="d">-        );
</a><a href="#h6-0-9" id="h6-0-9" class="d">-        INSERT INTO countries VALUES
</a><a href="#h6-0-10" id="h6-0-10" class="d">-            (&#39;fr&#39;, &#39;France&#39;),
</a><a href="#h6-0-11" id="h6-0-11" class="d">-            (&#39;ru&#39;, &#39;Russia&#39;),
</a><a href="#h6-0-12" id="h6-0-12" class="d">-            (&#39;us&#39;, &#39;United States of America&#39;);
</a><a href="#h6-0-13" id="h6-0-13" class="d">-        CREATE TABLE genres (
</a><a href="#h6-0-14" id="h6-0-14" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h6-0-15" id="h6-0-15" class="d">-            name STRING NOT NULL
</a><a href="#h6-0-16" id="h6-0-16" class="d">-        );
</a><a href="#h6-0-17" id="h6-0-17" class="d">-        INSERT INTO genres VALUES
</a><a href="#h6-0-18" id="h6-0-18" class="d">-            (1, &#39;Science Fiction&#39;),
</a><a href="#h6-0-19" id="h6-0-19" class="d">-            (2, &#39;Action&#39;),
</a><a href="#h6-0-20" id="h6-0-20" class="d">-            (3, &#39;Comedy&#39;);
</a><a href="#h6-0-21" id="h6-0-21" class="d">-        CREATE TABLE studios (
</a><a href="#h6-0-22" id="h6-0-22" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h6-0-23" id="h6-0-23" class="d">-            name STRING NOT NULL,
</a><a href="#h6-0-24" id="h6-0-24" class="d">-            country_id STRING REFERENCES countries
</a><a href="#h6-0-25" id="h6-0-25" class="d">-        );
</a><a href="#h6-0-26" id="h6-0-26" class="d">-        INSERT INTO studios VALUES
</a><a href="#h6-0-27" id="h6-0-27" class="d">-            (1, &#39;Mosfilm&#39;, &#39;ru&#39;),
</a><a href="#h6-0-28" id="h6-0-28" class="d">-            (2, &#39;Lionsgate&#39;, &#39;us&#39;),
</a><a href="#h6-0-29" id="h6-0-29" class="d">-            (3, &#39;StudioCanal&#39;, &#39;fr&#39;),
</a><a href="#h6-0-30" id="h6-0-30" class="d">-            (4, &#39;Warner Bros&#39;, &#39;us&#39;);
</a><a href="#h6-0-31" id="h6-0-31" class="d">-        CREATE TABLE movies (
</a><a href="#h6-0-32" id="h6-0-32" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h6-0-33" id="h6-0-33" class="d">-            title STRING NOT NULL,
</a><a href="#h6-0-34" id="h6-0-34" class="d">-            studio_id INTEGER NOT NULL REFERENCES studios,
</a><a href="#h6-0-35" id="h6-0-35" class="d">-            genre_id INTEGER NOT NULL REFERENCES genres,
</a><a href="#h6-0-36" id="h6-0-36" class="d">-            released INTEGER NOT NULL,
</a><a href="#h6-0-37" id="h6-0-37" class="d">-            rating FLOAT,
</a><a href="#h6-0-38" id="h6-0-38" class="d">-            ultrahd BOOLEAN
</a><a href="#h6-0-39" id="h6-0-39" class="d">-        );
</a><a href="#h6-0-40" id="h6-0-40" class="d">-        INSERT INTO movies VALUES
</a><a href="#h6-0-41" id="h6-0-41" class="d">-            (1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL),
</a><a href="#h6-0-42" id="h6-0-42" class="d">-            (2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE),
</a><a href="#h6-0-43" id="h6-0-43" class="d">-            (3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL),
</a><a href="#h6-0-44" id="h6-0-44" class="d">-            (4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE),
</a><a href="#h6-0-45" id="h6-0-45" class="d">-            (5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE),
</a><a href="#h6-0-46" id="h6-0-46" class="d">-            (6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL),
</a><a href="#h6-0-47" id="h6-0-47" class="d">-            (7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE),
</a><a href="#h6-0-48" id="h6-0-48" class="d">-            (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE),
</a><a href="#h6-0-49" id="h6-0-49" class="d">-            (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE),
</a><a href="#h6-0-50" id="h6-0-50" class="d">-            (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)&quot;;
</a><b>diff --git a/<a id="h7" href="../file/tests/e2e/isolation.rs.html">tests/e2e/isolation.rs</a> b/<a href="../file/tests/e2e/isolation.rs.html">tests/e2e/isolation.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,156 +0,0 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-use super::{assert_row, assert_rows, dataset, TestCluster};
</a><a href="#h7-0-1" id="h7-0-1" class="d">-
</a><a href="#h7-0-2" id="h7-0-2" class="d">-use serial_test::serial;
</a><a href="#h7-0-3" id="h7-0-3" class="d">-use toydb::error::{Error, Result};
</a><a href="#h7-0-4" id="h7-0-4" class="d">-use toydb::sql::types::Value;
</a><a href="#h7-0-5" id="h7-0-5" class="d">-
</a><a href="#h7-0-6" id="h7-0-6" class="d">-#[test]
</a><a href="#h7-0-7" id="h7-0-7" class="d">-#[serial]
</a><a href="#h7-0-8" id="h7-0-8" class="d">-// A dirty write is when b overwrites an uncommitted value written by a.
</a><a href="#h7-0-9" id="h7-0-9" class="d">-fn dirty_write() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-10" id="h7-0-10" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-11" id="h7-0-11" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-12" id="h7-0-12" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-13" id="h7-0-13" class="d">-
</a><a href="#h7-0-14" id="h7-0-14" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-15" id="h7-0-15" class="d">-    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h7-0-16" id="h7-0-16" class="d">-
</a><a href="#h7-0-17" id="h7-0-17" class="d">-    assert_eq!(b.execute(&quot;INSERT INTO test VALUES (1, &#39;b&#39;)&quot;), Err(Error::Serialization));
</a><a href="#h7-0-18" id="h7-0-18" class="d">-
</a><a href="#h7-0-19" id="h7-0-19" class="d">-    a.execute(&quot;COMMIT&quot;)?;
</a><a href="#h7-0-20" id="h7-0-20" class="d">-    assert_row(
</a><a href="#h7-0-21" id="h7-0-21" class="d">-        a.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h7-0-22" id="h7-0-22" class="d">-        vec![Value::Integer(1), Value::String(&quot;a&quot;.into())],
</a><a href="#h7-0-23" id="h7-0-23" class="d">-    );
</a><a href="#h7-0-24" id="h7-0-24" class="d">-
</a><a href="#h7-0-25" id="h7-0-25" class="d">-    Ok(())
</a><a href="#h7-0-26" id="h7-0-26" class="d">-}
</a><a href="#h7-0-27" id="h7-0-27" class="d">-
</a><a href="#h7-0-28" id="h7-0-28" class="d">-#[test]
</a><a href="#h7-0-29" id="h7-0-29" class="d">-#[serial]
</a><a href="#h7-0-30" id="h7-0-30" class="d">-// A dirty read is when b can read an uncommitted value set by a.
</a><a href="#h7-0-31" id="h7-0-31" class="d">-fn anomaly_dirty_read() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-32" id="h7-0-32" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-33" id="h7-0-33" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-34" id="h7-0-34" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-35" id="h7-0-35" class="d">-
</a><a href="#h7-0-36" id="h7-0-36" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-37" id="h7-0-37" class="d">-    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h7-0-38" id="h7-0-38" class="d">-
</a><a href="#h7-0-39" id="h7-0-39" class="d">-    assert_rows(b.execute(&quot;SELECT * FROM test&quot;)?, vec![]);
</a><a href="#h7-0-40" id="h7-0-40" class="d">-
</a><a href="#h7-0-41" id="h7-0-41" class="d">-    Ok(())
</a><a href="#h7-0-42" id="h7-0-42" class="d">-}
</a><a href="#h7-0-43" id="h7-0-43" class="d">-
</a><a href="#h7-0-44" id="h7-0-44" class="d">-#[test]
</a><a href="#h7-0-45" id="h7-0-45" class="d">-#[serial]
</a><a href="#h7-0-46" id="h7-0-46" class="d">-// A lost update is when a and b both read a value and update it, where b&#39;s update replaces a.
</a><a href="#h7-0-47" id="h7-0-47" class="d">-fn anomaly_lost_update() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-48" id="h7-0-48" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-49" id="h7-0-49" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-50" id="h7-0-50" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-51" id="h7-0-51" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h7-0-52" id="h7-0-52" class="d">-
</a><a href="#h7-0-53" id="h7-0-53" class="d">-    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;)?;
</a><a href="#h7-0-54" id="h7-0-54" class="d">-
</a><a href="#h7-0-55" id="h7-0-55" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-56" id="h7-0-56" class="d">-    b.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-57" id="h7-0-57" class="d">-
</a><a href="#h7-0-58" id="h7-0-58" class="d">-    a.execute(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;)?;
</a><a href="#h7-0-59" id="h7-0-59" class="d">-    assert_eq!(b.execute(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 1&quot;), Err(Error::Serialization));
</a><a href="#h7-0-60" id="h7-0-60" class="d">-    a.execute(&quot;COMMIT&quot;)?;
</a><a href="#h7-0-61" id="h7-0-61" class="d">-
</a><a href="#h7-0-62" id="h7-0-62" class="d">-    assert_row(
</a><a href="#h7-0-63" id="h7-0-63" class="d">-        c.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h7-0-64" id="h7-0-64" class="d">-        vec![Value::Integer(1), Value::String(&quot;a&quot;.into())],
</a><a href="#h7-0-65" id="h7-0-65" class="d">-    );
</a><a href="#h7-0-66" id="h7-0-66" class="d">-
</a><a href="#h7-0-67" id="h7-0-67" class="d">-    Ok(())
</a><a href="#h7-0-68" id="h7-0-68" class="d">-}
</a><a href="#h7-0-69" id="h7-0-69" class="d">-
</a><a href="#h7-0-70" id="h7-0-70" class="d">-#[test]
</a><a href="#h7-0-71" id="h7-0-71" class="d">-#[serial]
</a><a href="#h7-0-72" id="h7-0-72" class="d">-// A fuzzy (or unrepeatable) read is when b sees a value change after a updates it.
</a><a href="#h7-0-73" id="h7-0-73" class="d">-fn anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-74" id="h7-0-74" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-75" id="h7-0-75" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-76" id="h7-0-76" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-77" id="h7-0-77" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h7-0-78" id="h7-0-78" class="d">-
</a><a href="#h7-0-79" id="h7-0-79" class="d">-    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;)?;
</a><a href="#h7-0-80" id="h7-0-80" class="d">-
</a><a href="#h7-0-81" id="h7-0-81" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-82" id="h7-0-82" class="d">-    b.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-83" id="h7-0-83" class="d">-
</a><a href="#h7-0-84" id="h7-0-84" class="d">-    assert_row(
</a><a href="#h7-0-85" id="h7-0-85" class="d">-        b.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h7-0-86" id="h7-0-86" class="d">-        vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
</a><a href="#h7-0-87" id="h7-0-87" class="d">-    );
</a><a href="#h7-0-88" id="h7-0-88" class="d">-    a.execute(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;)?;
</a><a href="#h7-0-89" id="h7-0-89" class="d">-    a.execute(&quot;COMMIT&quot;)?;
</a><a href="#h7-0-90" id="h7-0-90" class="d">-    assert_row(
</a><a href="#h7-0-91" id="h7-0-91" class="d">-        b.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h7-0-92" id="h7-0-92" class="d">-        vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
</a><a href="#h7-0-93" id="h7-0-93" class="d">-    );
</a><a href="#h7-0-94" id="h7-0-94" class="d">-
</a><a href="#h7-0-95" id="h7-0-95" class="d">-    Ok(())
</a><a href="#h7-0-96" id="h7-0-96" class="d">-}
</a><a href="#h7-0-97" id="h7-0-97" class="d">-
</a><a href="#h7-0-98" id="h7-0-98" class="d">-#[test]
</a><a href="#h7-0-99" id="h7-0-99" class="d">-#[serial]
</a><a href="#h7-0-100" id="h7-0-100" class="d">-// Read skew is when a reads 1 and 2, but b modifies 2 in between the reads.
</a><a href="#h7-0-101" id="h7-0-101" class="d">-fn anomaly_read_skew() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-102" id="h7-0-102" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-103" id="h7-0-103" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-104" id="h7-0-104" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-105" id="h7-0-105" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h7-0-106" id="h7-0-106" class="d">-
</a><a href="#h7-0-107" id="h7-0-107" class="d">-    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;), (2, &#39;c&#39;)&quot;)?;
</a><a href="#h7-0-108" id="h7-0-108" class="d">-
</a><a href="#h7-0-109" id="h7-0-109" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-110" id="h7-0-110" class="d">-    b.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-111" id="h7-0-111" class="d">-
</a><a href="#h7-0-112" id="h7-0-112" class="d">-    assert_row(
</a><a href="#h7-0-113" id="h7-0-113" class="d">-        a.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h7-0-114" id="h7-0-114" class="d">-        vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
</a><a href="#h7-0-115" id="h7-0-115" class="d">-    );
</a><a href="#h7-0-116" id="h7-0-116" class="d">-    b.execute(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 2&quot;)?;
</a><a href="#h7-0-117" id="h7-0-117" class="d">-    b.execute(&quot;COMMIT&quot;)?;
</a><a href="#h7-0-118" id="h7-0-118" class="d">-    assert_row(
</a><a href="#h7-0-119" id="h7-0-119" class="d">-        a.execute(&quot;SELECT * FROM test WHERE id = 2&quot;)?,
</a><a href="#h7-0-120" id="h7-0-120" class="d">-        vec![Value::Integer(2), Value::String(&quot;c&quot;.into())],
</a><a href="#h7-0-121" id="h7-0-121" class="d">-    );
</a><a href="#h7-0-122" id="h7-0-122" class="d">-
</a><a href="#h7-0-123" id="h7-0-123" class="d">-    Ok(())
</a><a href="#h7-0-124" id="h7-0-124" class="d">-}
</a><a href="#h7-0-125" id="h7-0-125" class="d">-
</a><a href="#h7-0-126" id="h7-0-126" class="d">-#[test]
</a><a href="#h7-0-127" id="h7-0-127" class="d">-#[serial]
</a><a href="#h7-0-128" id="h7-0-128" class="d">-// A phantom read is when a reads entries matching some predicate, but a modification by
</a><a href="#h7-0-129" id="h7-0-129" class="d">-// b changes the entries that match the predicate such that a later read by a returns them.
</a><a href="#h7-0-130" id="h7-0-130" class="d">-fn anomaly_phantom_read() -&gt; Result&lt;()&gt; {
</a><a href="#h7-0-131" id="h7-0-131" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h7-0-132" id="h7-0-132" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h7-0-133" id="h7-0-133" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h7-0-134" id="h7-0-134" class="d">-    let mut c = tc.connect_any()?;
</a><a href="#h7-0-135" id="h7-0-135" class="d">-
</a><a href="#h7-0-136" id="h7-0-136" class="d">-    c.execute(&quot;INSERT INTO test VALUES (1, &#39;true&#39;), (2, &#39;false&#39;)&quot;)?;
</a><a href="#h7-0-137" id="h7-0-137" class="d">-
</a><a href="#h7-0-138" id="h7-0-138" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-139" id="h7-0-139" class="d">-    b.execute(&quot;BEGIN&quot;)?;
</a><a href="#h7-0-140" id="h7-0-140" class="d">-
</a><a href="#h7-0-141" id="h7-0-141" class="d">-    assert_rows(
</a><a href="#h7-0-142" id="h7-0-142" class="d">-        a.execute(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;)?,
</a><a href="#h7-0-143" id="h7-0-143" class="d">-        vec![vec![Value::Integer(1), Value::String(&quot;true&quot;.into())]],
</a><a href="#h7-0-144" id="h7-0-144" class="d">-    );
</a><a href="#h7-0-145" id="h7-0-145" class="d">-    b.execute(&quot;UPDATE test SET value = &#39;true&#39; WHERE id = 2&quot;)?;
</a><a href="#h7-0-146" id="h7-0-146" class="d">-    b.execute(&quot;COMMIT&quot;)?;
</a><a href="#h7-0-147" id="h7-0-147" class="d">-    assert_rows(
</a><a href="#h7-0-148" id="h7-0-148" class="d">-        a.execute(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;)?,
</a><a href="#h7-0-149" id="h7-0-149" class="d">-        vec![vec![Value::Integer(1), Value::String(&quot;true&quot;.into())]],
</a><a href="#h7-0-150" id="h7-0-150" class="d">-    );
</a><a href="#h7-0-151" id="h7-0-151" class="d">-
</a><a href="#h7-0-152" id="h7-0-152" class="d">-    Ok(())
</a><a href="#h7-0-153" id="h7-0-153" class="d">-}
</a><a href="#h7-0-154" id="h7-0-154" class="d">-
</a><a href="#h7-0-155" id="h7-0-155" class="d">-// FIXME We should test write skew, but we need to implement serializable snapshot isolation first.
</a><b>diff --git a/<a id="h8" href="../file/tests/e2e/mod.rs.html">tests/e2e/mod.rs</a> b/<a href="../file/tests/e2e/mod.rs.html">tests/e2e/mod.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,27 +0,0 @@
</a><a href="#h8-0-0" id="h8-0-0" class="d">-//! End-to-end tests for toyDB. These spin up toyDB clusters as separate child
</a><a href="#h8-0-1" id="h8-0-1" class="d">-//! processes using a built binary.
</a><a href="#h8-0-2" id="h8-0-2" class="d">-//!
</a><a href="#h8-0-3" id="h8-0-3" class="d">-//! TODO: these tests should be rewritten as data-driven golden master tests.
</a><a href="#h8-0-4" id="h8-0-4" class="d">-
</a><a href="#h8-0-5" id="h8-0-5" class="d">-mod client;
</a><a href="#h8-0-6" id="h8-0-6" class="d">-pub mod dataset;
</a><a href="#h8-0-7" id="h8-0-7" class="d">-mod isolation;
</a><a href="#h8-0-8" id="h8-0-8" class="d">-mod recovery;
</a><a href="#h8-0-9" id="h8-0-9" class="d">-mod testcluster;
</a><a href="#h8-0-10" id="h8-0-10" class="d">-
</a><a href="#h8-0-11" id="h8-0-11" class="d">-use testcluster::TestCluster;
</a><a href="#h8-0-12" id="h8-0-12" class="d">-
</a><a href="#h8-0-13" id="h8-0-13" class="d">-/// Asserts that a resultset contains the expected rows.
</a><a href="#h8-0-14" id="h8-0-14" class="d">-fn assert_rows(result: toydb::StatementResult, expect: Vec&lt;toydb::sql::types::Row&gt;) {
</a><a href="#h8-0-15" id="h8-0-15" class="d">-    match result {
</a><a href="#h8-0-16" id="h8-0-16" class="d">-        toydb::StatementResult::Select { rows, .. } =&gt; {
</a><a href="#h8-0-17" id="h8-0-17" class="d">-            assert_eq!(rows, expect)
</a><a href="#h8-0-18" id="h8-0-18" class="d">-        }
</a><a href="#h8-0-19" id="h8-0-19" class="d">-        r =&gt; panic!(&quot;Unexpected result {:?}&quot;, r),
</a><a href="#h8-0-20" id="h8-0-20" class="d">-    }
</a><a href="#h8-0-21" id="h8-0-21" class="d">-}
</a><a href="#h8-0-22" id="h8-0-22" class="d">-
</a><a href="#h8-0-23" id="h8-0-23" class="d">-/// Asserts that a resultset contains the single expected row.
</a><a href="#h8-0-24" id="h8-0-24" class="d">-fn assert_row(result: toydb::StatementResult, expect: toydb::sql::types::Row) {
</a><a href="#h8-0-25" id="h8-0-25" class="d">-    assert_rows(result, vec![expect])
</a><a href="#h8-0-26" id="h8-0-26" class="d">-}
</a><b>diff --git a/<a id="h9" href="../file/tests/e2e/recovery.rs.html">tests/e2e/recovery.rs</a> b/<a href="../file/tests/e2e/recovery.rs.html">tests/e2e/recovery.rs</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,50 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-use super::{assert_row, dataset, TestCluster};
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-use serial_test::serial;
</a><a href="#h9-0-3" id="h9-0-3" class="d">-use toydb::error::{Error, Result};
</a><a href="#h9-0-4" id="h9-0-4" class="d">-use toydb::sql::types::Value;
</a><a href="#h9-0-5" id="h9-0-5" class="d">-
</a><a href="#h9-0-6" id="h9-0-6" class="d">-#[test]
</a><a href="#h9-0-7" id="h9-0-7" class="d">-#[serial]
</a><a href="#h9-0-8" id="h9-0-8" class="d">-// A client disconnect or termination should roll back its transaction.
</a><a href="#h9-0-9" id="h9-0-9" class="d">-fn client_disconnect_rollback() -&gt; Result&lt;()&gt; {
</a><a href="#h9-0-10" id="h9-0-10" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h9-0-11" id="h9-0-11" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h9-0-12" id="h9-0-12" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h9-0-13" id="h9-0-13" class="d">-
</a><a href="#h9-0-14" id="h9-0-14" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h9-0-15" id="h9-0-15" class="d">-    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h9-0-16" id="h9-0-16" class="d">-    std::mem::drop(a);
</a><a href="#h9-0-17" id="h9-0-17" class="d">-
</a><a href="#h9-0-18" id="h9-0-18" class="d">-    // This would fail with a serialization error if the txn is not rolled back.
</a><a href="#h9-0-19" id="h9-0-19" class="d">-    b.execute(&quot;INSERT INTO test VALUES (1, &#39;b&#39;)&quot;)?;
</a><a href="#h9-0-20" id="h9-0-20" class="d">-    assert_row(
</a><a href="#h9-0-21" id="h9-0-21" class="d">-        b.execute(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h9-0-22" id="h9-0-22" class="d">-        vec![Value::Integer(1), Value::String(&quot;b&quot;.into())],
</a><a href="#h9-0-23" id="h9-0-23" class="d">-    );
</a><a href="#h9-0-24" id="h9-0-24" class="d">-
</a><a href="#h9-0-25" id="h9-0-25" class="d">-    Ok(())
</a><a href="#h9-0-26" id="h9-0-26" class="d">-}
</a><a href="#h9-0-27" id="h9-0-27" class="d">-
</a><a href="#h9-0-28" id="h9-0-28" class="d">-#[test]
</a><a href="#h9-0-29" id="h9-0-29" class="d">-#[serial]
</a><a href="#h9-0-30" id="h9-0-30" class="d">-fn client_commit_error() -&gt; Result&lt;()&gt; {
</a><a href="#h9-0-31" id="h9-0-31" class="d">-    let tc = TestCluster::run_with(5, dataset::TEST_TABLE)?;
</a><a href="#h9-0-32" id="h9-0-32" class="d">-    let mut a = tc.connect_any()?;
</a><a href="#h9-0-33" id="h9-0-33" class="d">-    let mut b = tc.connect_any()?;
</a><a href="#h9-0-34" id="h9-0-34" class="d">-
</a><a href="#h9-0-35" id="h9-0-35" class="d">-    a.execute(&quot;BEGIN&quot;)?;
</a><a href="#h9-0-36" id="h9-0-36" class="d">-    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h9-0-37" id="h9-0-37" class="d">-
</a><a href="#h9-0-38" id="h9-0-38" class="d">-    // When B gets a serialization error, it should still be in the txn and able to roll it back.
</a><a href="#h9-0-39" id="h9-0-39" class="d">-    b.execute(&quot;BEGIN&quot;)?;
</a><a href="#h9-0-40" id="h9-0-40" class="d">-    b.execute(&quot;INSERT INTO test VALUES (2, &#39;b&#39;)&quot;)?;
</a><a href="#h9-0-41" id="h9-0-41" class="d">-    assert_eq!(b.execute(&quot;INSERT INTO test VALUES (1, &#39;b&#39;)&quot;), Err(Error::Serialization));
</a><a href="#h9-0-42" id="h9-0-42" class="d">-    b.execute(&quot;ROLLBACK&quot;)?;
</a><a href="#h9-0-43" id="h9-0-43" class="d">-
</a><a href="#h9-0-44" id="h9-0-44" class="d">-    // Once rolled back, A should be able to write ID 2 and commit.
</a><a href="#h9-0-45" id="h9-0-45" class="d">-    a.execute(&quot;INSERT INTO test VALUES (2, &#39;a&#39;)&quot;)?;
</a><a href="#h9-0-46" id="h9-0-46" class="d">-    a.execute(&quot;COMMIT&quot;)?;
</a><a href="#h9-0-47" id="h9-0-47" class="d">-
</a><a href="#h9-0-48" id="h9-0-48" class="d">-    Ok(())
</a><a href="#h9-0-49" id="h9-0-49" class="d">-}
</a><b>diff --git a/<a id="h10" href="../file/tests/e2e/testcluster.rs.html">tests/e2e/testcluster.rs</a> b/<a href="../file/tests/e2e/testcluster.rs.html">tests/e2e/testcluster.rs</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,177 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-use rand::Rng;
</a><a href="#h10-0-1" id="h10-0-1" class="d">-use toydb::error::Result;
</a><a href="#h10-0-2" id="h10-0-2" class="d">-use toydb::raft::NodeID;
</a><a href="#h10-0-3" id="h10-0-3" class="d">-use toydb::Client;
</a><a href="#h10-0-4" id="h10-0-4" class="d">-
</a><a href="#h10-0-5" id="h10-0-5" class="d">-/// Runs a toyDB cluster using the built binary in a temporary directory. The
</a><a href="#h10-0-6" id="h10-0-6" class="d">-/// cluster will be killed and removed when dropped.
</a><a href="#h10-0-7" id="h10-0-7" class="d">-///
</a><a href="#h10-0-8" id="h10-0-8" class="d">-/// This runs the cluster as child processes using the built binary instead of
</a><a href="#h10-0-9" id="h10-0-9" class="d">-/// spawning in-memory threads for a couple of reasons: it avoids having to
</a><a href="#h10-0-10" id="h10-0-10" class="d">-/// gracefully shut down the server (which is complicated by e.g.
</a><a href="#h10-0-11" id="h10-0-11" class="d">-/// TcpListener::accept() not being interruptable), and it tests the entire
</a><a href="#h10-0-12" id="h10-0-12" class="d">-/// server (and eventually the toySQL client) end-to-end.
</a><a href="#h10-0-13" id="h10-0-13" class="d">-pub struct TestCluster {
</a><a href="#h10-0-14" id="h10-0-14" class="d">-    nodes: u8,
</a><a href="#h10-0-15" id="h10-0-15" class="d">-    dir: tempfile::TempDir,
</a><a href="#h10-0-16" id="h10-0-16" class="d">-    children: std::collections::HashMap&lt;NodeID, std::process::Child&gt;,
</a><a href="#h10-0-17" id="h10-0-17" class="d">-}
</a><a href="#h10-0-18" id="h10-0-18" class="d">-
</a><a href="#h10-0-19" id="h10-0-19" class="d">-impl TestCluster {
</a><a href="#h10-0-20" id="h10-0-20" class="d">-    const SQL_BASE_PORT: u16 = 19600;
</a><a href="#h10-0-21" id="h10-0-21" class="d">-    const RAFT_BASE_PORT: u16 = 19700;
</a><a href="#h10-0-22" id="h10-0-22" class="d">-
</a><a href="#h10-0-23" id="h10-0-23" class="d">-    /// Creates a new test cluster.
</a><a href="#h10-0-24" id="h10-0-24" class="d">-    pub fn new(nodes: u8) -&gt; Result&lt;Self&gt; {
</a><a href="#h10-0-25" id="h10-0-25" class="d">-        Ok(Self {
</a><a href="#h10-0-26" id="h10-0-26" class="d">-            nodes,
</a><a href="#h10-0-27" id="h10-0-27" class="d">-            dir: tempfile::TempDir::with_prefix(&quot;toydb&quot;)?,
</a><a href="#h10-0-28" id="h10-0-28" class="d">-            children: std::collections::HashMap::new(),
</a><a href="#h10-0-29" id="h10-0-29" class="d">-        })
</a><a href="#h10-0-30" id="h10-0-30" class="d">-    }
</a><a href="#h10-0-31" id="h10-0-31" class="d">-
</a><a href="#h10-0-32" id="h10-0-32" class="d">-    /// Creates a new test cluster and starts it.
</a><a href="#h10-0-33" id="h10-0-33" class="d">-    pub fn run(nodes: u8) -&gt; Result&lt;Self&gt; {
</a><a href="#h10-0-34" id="h10-0-34" class="d">-        let mut tc = Self::new(nodes)?;
</a><a href="#h10-0-35" id="h10-0-35" class="d">-        tc.start()?;
</a><a href="#h10-0-36" id="h10-0-36" class="d">-        Ok(tc)
</a><a href="#h10-0-37" id="h10-0-37" class="d">-    }
</a><a href="#h10-0-38" id="h10-0-38" class="d">-
</a><a href="#h10-0-39" id="h10-0-39" class="d">-    /// Creates a new test cluster, starts it, and imports an initial dataset.
</a><a href="#h10-0-40" id="h10-0-40" class="d">-    pub fn run_with(nodes: u8, init: &amp;str) -&gt; Result&lt;Self&gt; {
</a><a href="#h10-0-41" id="h10-0-41" class="d">-        let tc = Self::run(nodes)?;
</a><a href="#h10-0-42" id="h10-0-42" class="d">-
</a><a href="#h10-0-43" id="h10-0-43" class="d">-        let mut c = tc.connect_any()?;
</a><a href="#h10-0-44" id="h10-0-44" class="d">-        c.execute(&quot;BEGIN&quot;)?;
</a><a href="#h10-0-45" id="h10-0-45" class="d">-        for stmt in init.split(&#39;;&#39;) {
</a><a href="#h10-0-46" id="h10-0-46" class="d">-            c.execute(stmt)?;
</a><a href="#h10-0-47" id="h10-0-47" class="d">-        }
</a><a href="#h10-0-48" id="h10-0-48" class="d">-        c.execute(&quot;COMMIT&quot;)?;
</a><a href="#h10-0-49" id="h10-0-49" class="d">-
</a><a href="#h10-0-50" id="h10-0-50" class="d">-        Ok(tc)
</a><a href="#h10-0-51" id="h10-0-51" class="d">-    }
</a><a href="#h10-0-52" id="h10-0-52" class="d">-
</a><a href="#h10-0-53" id="h10-0-53" class="d">-    /// Returns an iterator over the cluster node IDs.
</a><a href="#h10-0-54" id="h10-0-54" class="d">-    fn ids(&amp;self) -&gt; impl Iterator&lt;Item = NodeID&gt; {
</a><a href="#h10-0-55" id="h10-0-55" class="d">-        1..=self.nodes
</a><a href="#h10-0-56" id="h10-0-56" class="d">-    }
</a><a href="#h10-0-57" id="h10-0-57" class="d">-
</a><a href="#h10-0-58" id="h10-0-58" class="d">-    /// Asserts that the given node ID exists.
</a><a href="#h10-0-59" id="h10-0-59" class="d">-    fn assert_id(&amp;self, id: NodeID) {
</a><a href="#h10-0-60" id="h10-0-60" class="d">-        assert!(id &gt; 0 &amp;&amp; id &lt;= self.nodes, &quot;invalid node ID {}&quot;, id)
</a><a href="#h10-0-61" id="h10-0-61" class="d">-    }
</a><a href="#h10-0-62" id="h10-0-62" class="d">-
</a><a href="#h10-0-63" id="h10-0-63" class="d">-    /// Asserts that all children are still alive.
</a><a href="#h10-0-64" id="h10-0-64" class="d">-    fn assert_alive(&amp;mut self) {
</a><a href="#h10-0-65" id="h10-0-65" class="d">-        for (id, child) in self.children.iter_mut() {
</a><a href="#h10-0-66" id="h10-0-66" class="d">-            if let Some(s) = child.try_wait().expect(&quot;Failed to check child exit status&quot;) {
</a><a href="#h10-0-67" id="h10-0-67" class="d">-                panic!(&quot;Node {id} exited with status {s}&quot;)
</a><a href="#h10-0-68" id="h10-0-68" class="d">-            }
</a><a href="#h10-0-69" id="h10-0-69" class="d">-        }
</a><a href="#h10-0-70" id="h10-0-70" class="d">-    }
</a><a href="#h10-0-71" id="h10-0-71" class="d">-
</a><a href="#h10-0-72" id="h10-0-72" class="d">-    /// Returns the path to the given node&#39;s directory.
</a><a href="#h10-0-73" id="h10-0-73" class="d">-    fn node_path(&amp;self, id: NodeID) -&gt; std::path::PathBuf {
</a><a href="#h10-0-74" id="h10-0-74" class="d">-        self.assert_id(id);
</a><a href="#h10-0-75" id="h10-0-75" class="d">-        self.dir.path().join(format!(&quot;toydb{}&quot;, id))
</a><a href="#h10-0-76" id="h10-0-76" class="d">-    }
</a><a href="#h10-0-77" id="h10-0-77" class="d">-
</a><a href="#h10-0-78" id="h10-0-78" class="d">-    /// Generates a config file for the given node.
</a><a href="#h10-0-79" id="h10-0-79" class="d">-    fn node_config(&amp;self, id: NodeID) -&gt; String {
</a><a href="#h10-0-80" id="h10-0-80" class="d">-        self.assert_id(id);
</a><a href="#h10-0-81" id="h10-0-81" class="d">-        let mut cfg = String::new();
</a><a href="#h10-0-82" id="h10-0-82" class="d">-        cfg.push_str(&amp;format!(&quot;id: {}\n&quot;, id));
</a><a href="#h10-0-83" id="h10-0-83" class="d">-        cfg.push_str(&amp;format!(&quot;data_dir: {}\n&quot;, self.node_path(id).to_string_lossy()));
</a><a href="#h10-0-84" id="h10-0-84" class="d">-        cfg.push_str(&amp;format!(&quot;listen_sql: {}\n&quot;, self.node_address_sql(id)));
</a><a href="#h10-0-85" id="h10-0-85" class="d">-        cfg.push_str(&amp;format!(&quot;listen_raft: {}\n&quot;, self.node_address_raft(id)));
</a><a href="#h10-0-86" id="h10-0-86" class="d">-        cfg.push_str(&quot;peers: {\n&quot;);
</a><a href="#h10-0-87" id="h10-0-87" class="d">-        for peer in self.ids().filter(|p| p != &amp;id) {
</a><a href="#h10-0-88" id="h10-0-88" class="d">-            cfg.push_str(&amp;format!(&quot;  &#39;{}&#39;: {},\n&quot;, peer, self.node_address_raft(peer)))
</a><a href="#h10-0-89" id="h10-0-89" class="d">-        }
</a><a href="#h10-0-90" id="h10-0-90" class="d">-        cfg.push_str(&quot;}\n&quot;);
</a><a href="#h10-0-91" id="h10-0-91" class="d">-        cfg
</a><a href="#h10-0-92" id="h10-0-92" class="d">-    }
</a><a href="#h10-0-93" id="h10-0-93" class="d">-
</a><a href="#h10-0-94" id="h10-0-94" class="d">-    /// Returns the given node&#39;s Raft TCP address.
</a><a href="#h10-0-95" id="h10-0-95" class="d">-    fn node_address_raft(&amp;self, id: NodeID) -&gt; String {
</a><a href="#h10-0-96" id="h10-0-96" class="d">-        self.assert_id(id);
</a><a href="#h10-0-97" id="h10-0-97" class="d">-        format!(&quot;localhost:{}&quot;, Self::RAFT_BASE_PORT + id as u16)
</a><a href="#h10-0-98" id="h10-0-98" class="d">-    }
</a><a href="#h10-0-99" id="h10-0-99" class="d">-
</a><a href="#h10-0-100" id="h10-0-100" class="d">-    /// Returns the given node&#39;s SQL TCP address.
</a><a href="#h10-0-101" id="h10-0-101" class="d">-    fn node_address_sql(&amp;self, id: NodeID) -&gt; String {
</a><a href="#h10-0-102" id="h10-0-102" class="d">-        self.assert_id(id);
</a><a href="#h10-0-103" id="h10-0-103" class="d">-        format!(&quot;localhost:{}&quot;, Self::SQL_BASE_PORT + id as u16)
</a><a href="#h10-0-104" id="h10-0-104" class="d">-    }
</a><a href="#h10-0-105" id="h10-0-105" class="d">-
</a><a href="#h10-0-106" id="h10-0-106" class="d">-    /// Starts the test cluster. It keeps running until the cluster is dropped.
</a><a href="#h10-0-107" id="h10-0-107" class="d">-    pub fn start(&amp;mut self) -&gt; Result&lt;()&gt; {
</a><a href="#h10-0-108" id="h10-0-108" class="d">-        // Build the binary.
</a><a href="#h10-0-109" id="h10-0-109" class="d">-        let build = escargot::CargoBuild::new().bin(&quot;toydb&quot;).run().expect(&quot;Failed to build binary&quot;);
</a><a href="#h10-0-110" id="h10-0-110" class="d">-
</a><a href="#h10-0-111" id="h10-0-111" class="d">-        // Spawn nodes.
</a><a href="#h10-0-112" id="h10-0-112" class="d">-        for id in self.ids() {
</a><a href="#h10-0-113" id="h10-0-113" class="d">-            // Create node directory and config file.
</a><a href="#h10-0-114" id="h10-0-114" class="d">-            std::fs::create_dir_all(&amp;self.node_path(id))?;
</a><a href="#h10-0-115" id="h10-0-115" class="d">-            std::fs::write(&amp;self.node_path(id).join(&quot;toydb.yaml&quot;), self.node_config(id))?;
</a><a href="#h10-0-116" id="h10-0-116" class="d">-
</a><a href="#h10-0-117" id="h10-0-117" class="d">-            // Spawn node. Silence output by default, since there doesn&#39;t appear
</a><a href="#h10-0-118" id="h10-0-118" class="d">-            // to be a way to pass the output to the &quot;cargo test&quot; output capture
</a><a href="#h10-0-119" id="h10-0-119" class="d">-            // without a thread piping it through println!.
</a><a href="#h10-0-120" id="h10-0-120" class="d">-            //
</a><a href="#h10-0-121" id="h10-0-121" class="d">-            // TODO: see if there&#39;s a way to send this to &quot;cargo test&quot; and have
</a><a href="#h10-0-122" id="h10-0-122" class="d">-            // it capture it like println!.
</a><a href="#h10-0-123" id="h10-0-123" class="d">-            let child = build
</a><a href="#h10-0-124" id="h10-0-124" class="d">-                .command()
</a><a href="#h10-0-125" id="h10-0-125" class="d">-                .args(vec![&quot;-c&quot;, &amp;self.node_path(id).join(&quot;toydb.yaml&quot;).to_string_lossy()])
</a><a href="#h10-0-126" id="h10-0-126" class="d">-                .stdout(std::process::Stdio::null())
</a><a href="#h10-0-127" id="h10-0-127" class="d">-                .stderr(std::process::Stdio::null())
</a><a href="#h10-0-128" id="h10-0-128" class="d">-                .spawn()?;
</a><a href="#h10-0-129" id="h10-0-129" class="d">-            self.children.insert(id, child);
</a><a href="#h10-0-130" id="h10-0-130" class="d">-        }
</a><a href="#h10-0-131" id="h10-0-131" class="d">-        self.assert_alive();
</a><a href="#h10-0-132" id="h10-0-132" class="d">-
</a><a href="#h10-0-133" id="h10-0-133" class="d">-        // Wait for all nodes to be ready, by connecting to them and fetching
</a><a href="#h10-0-134" id="h10-0-134" class="d">-        // the cluster status.
</a><a href="#h10-0-135" id="h10-0-135" class="d">-        const TIMEOUT: std::time::Duration = std::time::Duration::from_secs(5);
</a><a href="#h10-0-136" id="h10-0-136" class="d">-        const COOLDOWN: std::time::Duration = std::time::Duration::from_millis(200);
</a><a href="#h10-0-137" id="h10-0-137" class="d">-
</a><a href="#h10-0-138" id="h10-0-138" class="d">-        let deadline = std::time::Instant::now().checked_add(TIMEOUT).unwrap();
</a><a href="#h10-0-139" id="h10-0-139" class="d">-        for id in self.ids() {
</a><a href="#h10-0-140" id="h10-0-140" class="d">-            while let Err(e) = self.connect(id).and_then(|mut c| c.status()) {
</a><a href="#h10-0-141" id="h10-0-141" class="d">-                self.assert_alive();
</a><a href="#h10-0-142" id="h10-0-142" class="d">-                if std::time::Instant::now() &gt;= deadline {
</a><a href="#h10-0-143" id="h10-0-143" class="d">-                    return Err(e);
</a><a href="#h10-0-144" id="h10-0-144" class="d">-                }
</a><a href="#h10-0-145" id="h10-0-145" class="d">-                std::thread::sleep(COOLDOWN);
</a><a href="#h10-0-146" id="h10-0-146" class="d">-            }
</a><a href="#h10-0-147" id="h10-0-147" class="d">-        }
</a><a href="#h10-0-148" id="h10-0-148" class="d">-
</a><a href="#h10-0-149" id="h10-0-149" class="d">-        Ok(())
</a><a href="#h10-0-150" id="h10-0-150" class="d">-    }
</a><a href="#h10-0-151" id="h10-0-151" class="d">-
</a><a href="#h10-0-152" id="h10-0-152" class="d">-    /// Connects to the given cluster node.
</a><a href="#h10-0-153" id="h10-0-153" class="d">-    pub fn connect(&amp;self, id: NodeID) -&gt; Result&lt;Client&gt; {
</a><a href="#h10-0-154" id="h10-0-154" class="d">-        self.assert_id(id);
</a><a href="#h10-0-155" id="h10-0-155" class="d">-        Client::connect(self.node_address_sql(id))
</a><a href="#h10-0-156" id="h10-0-156" class="d">-    }
</a><a href="#h10-0-157" id="h10-0-157" class="d">-
</a><a href="#h10-0-158" id="h10-0-158" class="d">-    /// Connects to a random cluster node.
</a><a href="#h10-0-159" id="h10-0-159" class="d">-    pub fn connect_any(&amp;self) -&gt; Result&lt;Client&gt; {
</a><a href="#h10-0-160" id="h10-0-160" class="d">-        self.connect(rand::thread_rng().gen_range(1..=self.nodes))
</a><a href="#h10-0-161" id="h10-0-161" class="d">-    }
</a><a href="#h10-0-162" id="h10-0-162" class="d">-}
</a><a href="#h10-0-163" id="h10-0-163" class="d">-
</a><a href="#h10-0-164" id="h10-0-164" class="d">-impl Drop for TestCluster {
</a><a href="#h10-0-165" id="h10-0-165" class="d">-    /// Kills the child processes when the cluster is dropped. The temp dir is
</a><a href="#h10-0-166" id="h10-0-166" class="d">-    /// removed by TempDir::drop().
</a><a href="#h10-0-167" id="h10-0-167" class="d">-    ///
</a><a href="#h10-0-168" id="h10-0-168" class="d">-    /// Note that cargo will itself kill all child processes if the tests are
</a><a href="#h10-0-169" id="h10-0-169" class="d">-    /// aborted via e.g. Ctrl-C: https://github.com/rust-lang/cargo/issues/5598
</a><a href="#h10-0-170" id="h10-0-170" class="d">-    fn drop(&amp;mut self) {
</a><a href="#h10-0-171" id="h10-0-171" class="d">-        for (_, mut child) in self.children.drain() {
</a><a href="#h10-0-172" id="h10-0-172" class="d">-            child.kill().expect(&quot;Failed to kill node&quot;);
</a><a href="#h10-0-173" id="h10-0-173" class="d">-            child.wait().expect(&quot;Failed to wait for node to terminate&quot;);
</a><a href="#h10-0-174" id="h10-0-174" class="d">-        }
</a><a href="#h10-0-175" id="h10-0-175" class="d">-    }
</a><a href="#h10-0-176" id="h10-0-176" class="d">-}
</a><b>diff --git a/<a id="h11" href="../file/tests/scripts/anomalies.html">tests/scripts/anomalies</a> b/<a href="../file/tests/scripts/anomalies.html">tests/scripts/anomalies</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,205 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+# Tests transaction anomalies. This is also tested at the MVCC and SQL
</a><a href="#h11-0-1" id="h11-0-1" class="i">+# levels, but we may as well have an end-to-end test for them.
</a><a href="#h11-0-2" id="h11-0-2" class="i">+#
</a><a href="#h11-0-3" id="h11-0-3" class="i">+# Uses a single script to avoid cluster startup times for each test.
</a><a href="#h11-0-4" id="h11-0-4" class="i">+
</a><a href="#h11-0-5" id="h11-0-5" class="i">+cluster nodes=5
</a><a href="#h11-0-6" id="h11-0-6" class="i">+---
</a><a href="#h11-0-7" id="h11-0-7" class="i">+ok
</a><a href="#h11-0-8" id="h11-0-8" class="i">+
</a><a href="#h11-0-9" id="h11-0-9" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h11-0-10" id="h11-0-10" class="i">+---
</a><a href="#h11-0-11" id="h11-0-11" class="i">+ok
</a><a href="#h11-0-12" id="h11-0-12" class="i">+
</a><a href="#h11-0-13" id="h11-0-13" class="i">+# Dirty read: when c2 can read an uncommitted value written by c1. Snapshot
</a><a href="#h11-0-14" id="h11-0-14" class="i">+# isolation prevents this.
</a><a href="#h11-0-15" id="h11-0-15" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-16" id="h11-0-16" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-17" id="h11-0-17" class="i">+---
</a><a href="#h11-0-18" id="h11-0-18" class="i">+ok
</a><a href="#h11-0-19" id="h11-0-19" class="i">+
</a><a href="#h11-0-20" id="h11-0-20" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-21" id="h11-0-21" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-22" id="h11-0-22" class="i">+---
</a><a href="#h11-0-23" id="h11-0-23" class="i">+ok
</a><a href="#h11-0-24" id="h11-0-24" class="i">+
</a><a href="#h11-0-25" id="h11-0-25" class="i">+c1:&gt; ROLLBACK
</a><a href="#h11-0-26" id="h11-0-26" class="i">+c2:&gt; ROLLBACK
</a><a href="#h11-0-27" id="h11-0-27" class="i">+---
</a><a href="#h11-0-28" id="h11-0-28" class="i">+ok
</a><a href="#h11-0-29" id="h11-0-29" class="i">+
</a><a href="#h11-0-30" id="h11-0-30" class="i">+# Dirty write: when c2 overwrites an uncommitted value written by c1. Snapshot
</a><a href="#h11-0-31" id="h11-0-31" class="i">+# isolation prevents this.
</a><a href="#h11-0-32" id="h11-0-32" class="i">+
</a><a href="#h11-0-33" id="h11-0-33" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-34" id="h11-0-34" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-35" id="h11-0-35" class="i">+---
</a><a href="#h11-0-36" id="h11-0-36" class="i">+ok
</a><a href="#h11-0-37" id="h11-0-37" class="i">+
</a><a href="#h11-0-38" id="h11-0-38" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-39" id="h11-0-39" class="i">+c2:!&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-40" id="h11-0-40" class="i">+---
</a><a href="#h11-0-41" id="h11-0-41" class="i">+c2: Error: serialization failure, retry transaction
</a><a href="#h11-0-42" id="h11-0-42" class="i">+
</a><a href="#h11-0-43" id="h11-0-43" class="i">+c1:&gt; ROLLBACK
</a><a href="#h11-0-44" id="h11-0-44" class="i">+c2:&gt; ROLLBACK
</a><a href="#h11-0-45" id="h11-0-45" class="i">+---
</a><a href="#h11-0-46" id="h11-0-46" class="i">+ok
</a><a href="#h11-0-47" id="h11-0-47" class="i">+
</a><a href="#h11-0-48" id="h11-0-48" class="i">+# Fuzzy (or unrepeatable) read: when c2 sees a value change after c1 updates it.
</a><a href="#h11-0-49" id="h11-0-49" class="i">+# Snapshot isolation prevents this.
</a><a href="#h11-0-50" id="h11-0-50" class="i">+
</a><a href="#h11-0-51" id="h11-0-51" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-52" id="h11-0-52" class="i">+---
</a><a href="#h11-0-53" id="h11-0-53" class="i">+ok
</a><a href="#h11-0-54" id="h11-0-54" class="i">+
</a><a href="#h11-0-55" id="h11-0-55" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-56" id="h11-0-56" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-57" id="h11-0-57" class="i">+---
</a><a href="#h11-0-58" id="h11-0-58" class="i">+ok
</a><a href="#h11-0-59" id="h11-0-59" class="i">+
</a><a href="#h11-0-60" id="h11-0-60" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-61" id="h11-0-61" class="i">+---
</a><a href="#h11-0-62" id="h11-0-62" class="i">+c2: 1, &#39;a&#39;
</a><a href="#h11-0-63" id="h11-0-63" class="i">+
</a><a href="#h11-0-64" id="h11-0-64" class="i">+c1:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h11-0-65" id="h11-0-65" class="i">+c1:&gt; COMMIT
</a><a href="#h11-0-66" id="h11-0-66" class="i">+c1:&gt; SELECT * FROM test
</a><a href="#h11-0-67" id="h11-0-67" class="i">+---
</a><a href="#h11-0-68" id="h11-0-68" class="i">+c1: 1, &#39;b&#39;
</a><a href="#h11-0-69" id="h11-0-69" class="i">+
</a><a href="#h11-0-70" id="h11-0-70" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-71" id="h11-0-71" class="i">+---
</a><a href="#h11-0-72" id="h11-0-72" class="i">+c2: 1, &#39;a&#39;
</a><a href="#h11-0-73" id="h11-0-73" class="i">+
</a><a href="#h11-0-74" id="h11-0-74" class="i">+c2:&gt; ROLLBACK
</a><a href="#h11-0-75" id="h11-0-75" class="i">+&gt; DELETE FROM test
</a><a href="#h11-0-76" id="h11-0-76" class="i">+---
</a><a href="#h11-0-77" id="h11-0-77" class="i">+ok
</a><a href="#h11-0-78" id="h11-0-78" class="i">+
</a><a href="#h11-0-79" id="h11-0-79" class="i">+# Lost update: when c1 and c2 both read a value and update it, where c2&#39;s update
</a><a href="#h11-0-80" id="h11-0-80" class="i">+# replaces c1. Snapshot isolation prevents this.
</a><a href="#h11-0-81" id="h11-0-81" class="i">+
</a><a href="#h11-0-82" id="h11-0-82" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-83" id="h11-0-83" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-84" id="h11-0-84" class="i">+---
</a><a href="#h11-0-85" id="h11-0-85" class="i">+ok
</a><a href="#h11-0-86" id="h11-0-86" class="i">+
</a><a href="#h11-0-87" id="h11-0-87" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-88" id="h11-0-88" class="i">+c2:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-89" id="h11-0-89" class="i">+---
</a><a href="#h11-0-90" id="h11-0-90" class="i">+ok
</a><a href="#h11-0-91" id="h11-0-91" class="i">+
</a><a href="#h11-0-92" id="h11-0-92" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-93" id="h11-0-93" class="i">+c1:&gt; COMMIT
</a><a href="#h11-0-94" id="h11-0-94" class="i">+---
</a><a href="#h11-0-95" id="h11-0-95" class="i">+ok
</a><a href="#h11-0-96" id="h11-0-96" class="i">+
</a><a href="#h11-0-97" id="h11-0-97" class="i">+c2:!&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h11-0-98" id="h11-0-98" class="i">+---
</a><a href="#h11-0-99" id="h11-0-99" class="i">+c2: Error: serialization failure, retry transaction
</a><a href="#h11-0-100" id="h11-0-100" class="i">+
</a><a href="#h11-0-101" id="h11-0-101" class="i">+c2:&gt; ROLLBACK
</a><a href="#h11-0-102" id="h11-0-102" class="i">+&gt; DELETE FROM test
</a><a href="#h11-0-103" id="h11-0-103" class="i">+---
</a><a href="#h11-0-104" id="h11-0-104" class="i">+ok
</a><a href="#h11-0-105" id="h11-0-105" class="i">+
</a><a href="#h11-0-106" id="h11-0-106" class="i">+# Phantom read: when c1 reads entries matching some predicate, but a
</a><a href="#h11-0-107" id="h11-0-107" class="i">+# modification by c2 changes which entries match the predicate such that a later
</a><a href="#h11-0-108" id="h11-0-108" class="i">+# read by c1 returns them. Snapshot isolation prevents this.
</a><a href="#h11-0-109" id="h11-0-109" class="i">+
</a><a href="#h11-0-110" id="h11-0-110" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;), (3, &#39;c&#39;)
</a><a href="#h11-0-111" id="h11-0-111" class="i">+---
</a><a href="#h11-0-112" id="h11-0-112" class="i">+ok
</a><a href="#h11-0-113" id="h11-0-113" class="i">+
</a><a href="#h11-0-114" id="h11-0-114" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-115" id="h11-0-115" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-116" id="h11-0-116" class="i">+---
</a><a href="#h11-0-117" id="h11-0-117" class="i">+ok
</a><a href="#h11-0-118" id="h11-0-118" class="i">+
</a><a href="#h11-0-119" id="h11-0-119" class="i">+c1:&gt; SELECT * FROM test WHERE id &gt; 1
</a><a href="#h11-0-120" id="h11-0-120" class="i">+---
</a><a href="#h11-0-121" id="h11-0-121" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h11-0-122" id="h11-0-122" class="i">+c1: 3, &#39;c&#39;
</a><a href="#h11-0-123" id="h11-0-123" class="i">+
</a><a href="#h11-0-124" id="h11-0-124" class="i">+c2:&gt; DELETE FROM test WHERE id = 2
</a><a href="#h11-0-125" id="h11-0-125" class="i">+c2:&gt; INSERT INTO test VALUES (4, &#39;d&#39;)
</a><a href="#h11-0-126" id="h11-0-126" class="i">+c2:&gt; COMMIT
</a><a href="#h11-0-127" id="h11-0-127" class="i">+---
</a><a href="#h11-0-128" id="h11-0-128" class="i">+ok
</a><a href="#h11-0-129" id="h11-0-129" class="i">+
</a><a href="#h11-0-130" id="h11-0-130" class="i">+c1:&gt; SELECT * FROM test WHERE id &gt; 1
</a><a href="#h11-0-131" id="h11-0-131" class="i">+---
</a><a href="#h11-0-132" id="h11-0-132" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h11-0-133" id="h11-0-133" class="i">+c1: 3, &#39;c&#39;
</a><a href="#h11-0-134" id="h11-0-134" class="i">+
</a><a href="#h11-0-135" id="h11-0-135" class="i">+c1:&gt; ROLLBACK
</a><a href="#h11-0-136" id="h11-0-136" class="i">+&gt; DELETE FROM test
</a><a href="#h11-0-137" id="h11-0-137" class="i">+---
</a><a href="#h11-0-138" id="h11-0-138" class="i">+ok
</a><a href="#h11-0-139" id="h11-0-139" class="i">+
</a><a href="#h11-0-140" id="h11-0-140" class="i">+# Read skew: when c1 reads a and b, but c2 modifies b in between the reads.
</a><a href="#h11-0-141" id="h11-0-141" class="i">+# Snapshot isolation prevents this.
</a><a href="#h11-0-142" id="h11-0-142" class="i">+
</a><a href="#h11-0-143" id="h11-0-143" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h11-0-144" id="h11-0-144" class="i">+---
</a><a href="#h11-0-145" id="h11-0-145" class="i">+ok
</a><a href="#h11-0-146" id="h11-0-146" class="i">+
</a><a href="#h11-0-147" id="h11-0-147" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-148" id="h11-0-148" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-149" id="h11-0-149" class="i">+---
</a><a href="#h11-0-150" id="h11-0-150" class="i">+ok
</a><a href="#h11-0-151" id="h11-0-151" class="i">+
</a><a href="#h11-0-152" id="h11-0-152" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-153" id="h11-0-153" class="i">+---
</a><a href="#h11-0-154" id="h11-0-154" class="i">+c1: 1, &#39;a&#39;
</a><a href="#h11-0-155" id="h11-0-155" class="i">+
</a><a href="#h11-0-156" id="h11-0-156" class="i">+c2:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h11-0-157" id="h11-0-157" class="i">+c2:&gt; UPDATE test SET value = &#39;a&#39; WHERE id = 2
</a><a href="#h11-0-158" id="h11-0-158" class="i">+c2:&gt; COMMIT
</a><a href="#h11-0-159" id="h11-0-159" class="i">+---
</a><a href="#h11-0-160" id="h11-0-160" class="i">+ok
</a><a href="#h11-0-161" id="h11-0-161" class="i">+
</a><a href="#h11-0-162" id="h11-0-162" class="i">+c1:&gt; SELECT * FROM test WHERE id = 2
</a><a href="#h11-0-163" id="h11-0-163" class="i">+---
</a><a href="#h11-0-164" id="h11-0-164" class="i">+c1: 2, &#39;b&#39;
</a><a href="#h11-0-165" id="h11-0-165" class="i">+
</a><a href="#h11-0-166" id="h11-0-166" class="i">+c1:&gt; ROLLBACK
</a><a href="#h11-0-167" id="h11-0-167" class="i">+&gt; DELETE FROM test
</a><a href="#h11-0-168" id="h11-0-168" class="i">+---
</a><a href="#h11-0-169" id="h11-0-169" class="i">+ok
</a><a href="#h11-0-170" id="h11-0-170" class="i">+
</a><a href="#h11-0-171" id="h11-0-171" class="i">+# Write skew: when c1 reads a and writes it to b while c2 reads b and writes it
</a><a href="#h11-0-172" id="h11-0-172" class="i">+# to a. Snapshot isolation does not prevent this, which is expected, so we
</a><a href="#h11-0-173" id="h11-0-173" class="i">+# assert the anomalous behavior. Fixing this would require implementing
</a><a href="#h11-0-174" id="h11-0-174" class="i">+# serializable snapshot isolation.
</a><a href="#h11-0-175" id="h11-0-175" class="i">+
</a><a href="#h11-0-176" id="h11-0-176" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;), (2, &#39;b&#39;)
</a><a href="#h11-0-177" id="h11-0-177" class="i">+---
</a><a href="#h11-0-178" id="h11-0-178" class="i">+ok
</a><a href="#h11-0-179" id="h11-0-179" class="i">+
</a><a href="#h11-0-180" id="h11-0-180" class="i">+c1:&gt; BEGIN
</a><a href="#h11-0-181" id="h11-0-181" class="i">+c2:&gt; BEGIN
</a><a href="#h11-0-182" id="h11-0-182" class="i">+---
</a><a href="#h11-0-183" id="h11-0-183" class="i">+ok
</a><a href="#h11-0-184" id="h11-0-184" class="i">+
</a><a href="#h11-0-185" id="h11-0-185" class="i">+c1:&gt; SELECT * FROM test WHERE id = 1
</a><a href="#h11-0-186" id="h11-0-186" class="i">+c2:&gt; SELECT * FROM test WHERE id = 2
</a><a href="#h11-0-187" id="h11-0-187" class="i">+---
</a><a href="#h11-0-188" id="h11-0-188" class="i">+c1: 1, &#39;a&#39;
</a><a href="#h11-0-189" id="h11-0-189" class="i">+c2: 2, &#39;b&#39;
</a><a href="#h11-0-190" id="h11-0-190" class="i">+
</a><a href="#h11-0-191" id="h11-0-191" class="i">+c1:&gt; UPDATE test SET value = &#39;a&#39; WHERE id = 2
</a><a href="#h11-0-192" id="h11-0-192" class="i">+c2:&gt; UPDATE test SET value = &#39;b&#39; WHERE id = 1
</a><a href="#h11-0-193" id="h11-0-193" class="i">+---
</a><a href="#h11-0-194" id="h11-0-194" class="i">+ok
</a><a href="#h11-0-195" id="h11-0-195" class="i">+
</a><a href="#h11-0-196" id="h11-0-196" class="i">+c1:&gt; COMMIT
</a><a href="#h11-0-197" id="h11-0-197" class="i">+c2:&gt; COMMIT
</a><a href="#h11-0-198" id="h11-0-198" class="i">+---
</a><a href="#h11-0-199" id="h11-0-199" class="i">+ok
</a><a href="#h11-0-200" id="h11-0-200" class="i">+
</a><a href="#h11-0-201" id="h11-0-201" class="i">+&gt; SELECT * FROM test
</a><a href="#h11-0-202" id="h11-0-202" class="i">+---
</a><a href="#h11-0-203" id="h11-0-203" class="i">+1, &#39;b&#39;
</a><a href="#h11-0-204" id="h11-0-204" class="i">+2, &#39;a&#39;
</a><b>diff --git a/<a id="h12" href="../file/tests/scripts/client.html">tests/scripts/client</a> b/<a href="../file/tests/scripts/client.html">tests/scripts/client</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,195 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+# Tests various client operations.
</a><a href="#h12-0-1" id="h12-0-1" class="i">+#
</a><a href="#h12-0-2" id="h12-0-2" class="i">+# Uses a single-node cluster for determinism.
</a><a href="#h12-0-3" id="h12-0-3" class="i">+
</a><a href="#h12-0-4" id="h12-0-4" class="i">+cluster nodes=1
</a><a href="#h12-0-5" id="h12-0-5" class="i">+---
</a><a href="#h12-0-6" id="h12-0-6" class="i">+ok
</a><a href="#h12-0-7" id="h12-0-7" class="i">+
</a><a href="#h12-0-8" id="h12-0-8" class="i">+# Add some tables and data.
</a><a href="#h12-0-9" id="h12-0-9" class="i">+&gt; CREATE TABLE countries (id STRING PRIMARY KEY, name STRING NOT NULL)
</a><a href="#h12-0-10" id="h12-0-10" class="i">+&gt; INSERT INTO countries VALUES (&#39;fr&#39;, &#39;France&#39;), (&#39;ru&#39;, &#39;Russia&#39;), (&#39;us&#39;, &#39;United States of America&#39;)
</a><a href="#h12-0-11" id="h12-0-11" class="i">+&gt; CREATE TABLE genres (id INTEGER PRIMARY KEY, name STRING NOT NULL)
</a><a href="#h12-0-12" id="h12-0-12" class="i">+&gt; INSERT INTO genres VALUES (1, &#39;Science Fiction&#39;), (2, &#39;Action&#39;), (3, &#39;Comedy&#39;)
</a><a href="#h12-0-13" id="h12-0-13" class="i">+&gt; CREATE TABLE studios (id INTEGER PRIMARY KEY, name STRING NOT NULL, country_id STRING REFERENCES countries)
</a><a href="#h12-0-14" id="h12-0-14" class="i">+&gt; INSERT INTO studios VALUES (1, &#39;Mosfilm&#39;, &#39;ru&#39;), (2, &#39;Lionsgate&#39;, &#39;us&#39;), (3, &#39;StudioCanal&#39;, &#39;fr&#39;), (4, &#39;Warner Bros&#39;, &#39;us&#39;)
</a><a href="#h12-0-15" id="h12-0-15" class="i">+&gt; CREATE TABLE movies ( \
</a><a href="#h12-0-16" id="h12-0-16" class="i">+    id INTEGER PRIMARY KEY, \
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    title STRING NOT NULL, \
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    studio_id INTEGER NOT NULL REFERENCES studios, \
</a><a href="#h12-0-19" id="h12-0-19" class="i">+    genre_id INTEGER NOT NULL REFERENCES genres, \
</a><a href="#h12-0-20" id="h12-0-20" class="i">+    released INTEGER NOT NULL, \
</a><a href="#h12-0-21" id="h12-0-21" class="i">+    rating FLOAT, \
</a><a href="#h12-0-22" id="h12-0-22" class="i">+    ultrahd BOOLEAN \
</a><a href="#h12-0-23" id="h12-0-23" class="i">+)
</a><a href="#h12-0-24" id="h12-0-24" class="i">+&gt; INSERT INTO movies VALUES \
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    (1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL), \
</a><a href="#h12-0-26" id="h12-0-26" class="i">+    (2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE), \
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    (3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL), \
</a><a href="#h12-0-28" id="h12-0-28" class="i">+    (4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE), \
</a><a href="#h12-0-29" id="h12-0-29" class="i">+    (5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE), \
</a><a href="#h12-0-30" id="h12-0-30" class="i">+    (6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL), \
</a><a href="#h12-0-31" id="h12-0-31" class="i">+    (7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE), \
</a><a href="#h12-0-32" id="h12-0-32" class="i">+    (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE), \
</a><a href="#h12-0-33" id="h12-0-33" class="i">+    (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE), \
</a><a href="#h12-0-34" id="h12-0-34" class="i">+    (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)
</a><a href="#h12-0-35" id="h12-0-35" class="i">+---
</a><a href="#h12-0-36" id="h12-0-36" class="i">+ok
</a><a href="#h12-0-37" id="h12-0-37" class="i">+
</a><a href="#h12-0-38" id="h12-0-38" class="i">+# List the tables and display table schemas. Error on missing table.
</a><a href="#h12-0-39" id="h12-0-39" class="i">+tables
</a><a href="#h12-0-40" id="h12-0-40" class="i">+---
</a><a href="#h12-0-41" id="h12-0-41" class="i">+countries
</a><a href="#h12-0-42" id="h12-0-42" class="i">+genres
</a><a href="#h12-0-43" id="h12-0-43" class="i">+movies
</a><a href="#h12-0-44" id="h12-0-44" class="i">+studios
</a><a href="#h12-0-45" id="h12-0-45" class="i">+
</a><a href="#h12-0-46" id="h12-0-46" class="i">+table movies
</a><a href="#h12-0-47" id="h12-0-47" class="i">+---
</a><a href="#h12-0-48" id="h12-0-48" class="i">+CREATE TABLE movies (
</a><a href="#h12-0-49" id="h12-0-49" class="i">+  id INTEGER PRIMARY KEY,
</a><a href="#h12-0-50" id="h12-0-50" class="i">+  title STRING NOT NULL,
</a><a href="#h12-0-51" id="h12-0-51" class="i">+  studio_id INTEGER NOT NULL INDEX REFERENCES studios,
</a><a href="#h12-0-52" id="h12-0-52" class="i">+  genre_id INTEGER NOT NULL INDEX REFERENCES genres,
</a><a href="#h12-0-53" id="h12-0-53" class="i">+  released INTEGER NOT NULL,
</a><a href="#h12-0-54" id="h12-0-54" class="i">+  rating FLOAT DEFAULT NULL,
</a><a href="#h12-0-55" id="h12-0-55" class="i">+  ultrahd BOOLEAN DEFAULT NULL
</a><a href="#h12-0-56" id="h12-0-56" class="i">+)
</a><a href="#h12-0-57" id="h12-0-57" class="i">+
</a><a href="#h12-0-58" id="h12-0-58" class="i">+table movies raw=true
</a><a href="#h12-0-59" id="h12-0-59" class="i">+---
</a><a href="#h12-0-60" id="h12-0-60" class="i">+Table {
</a><a href="#h12-0-61" id="h12-0-61" class="i">+    name: &quot;movies&quot;,
</a><a href="#h12-0-62" id="h12-0-62" class="i">+    primary_key: 0,
</a><a href="#h12-0-63" id="h12-0-63" class="i">+    columns: [
</a><a href="#h12-0-64" id="h12-0-64" class="i">+        Column {
</a><a href="#h12-0-65" id="h12-0-65" class="i">+            name: &quot;id&quot;,
</a><a href="#h12-0-66" id="h12-0-66" class="i">+            datatype: Integer,
</a><a href="#h12-0-67" id="h12-0-67" class="i">+            nullable: false,
</a><a href="#h12-0-68" id="h12-0-68" class="i">+            default: None,
</a><a href="#h12-0-69" id="h12-0-69" class="i">+            unique: true,
</a><a href="#h12-0-70" id="h12-0-70" class="i">+            index: false,
</a><a href="#h12-0-71" id="h12-0-71" class="i">+            references: None,
</a><a href="#h12-0-72" id="h12-0-72" class="i">+        },
</a><a href="#h12-0-73" id="h12-0-73" class="i">+        Column {
</a><a href="#h12-0-74" id="h12-0-74" class="i">+            name: &quot;title&quot;,
</a><a href="#h12-0-75" id="h12-0-75" class="i">+            datatype: String,
</a><a href="#h12-0-76" id="h12-0-76" class="i">+            nullable: false,
</a><a href="#h12-0-77" id="h12-0-77" class="i">+            default: None,
</a><a href="#h12-0-78" id="h12-0-78" class="i">+            unique: false,
</a><a href="#h12-0-79" id="h12-0-79" class="i">+            index: false,
</a><a href="#h12-0-80" id="h12-0-80" class="i">+            references: None,
</a><a href="#h12-0-81" id="h12-0-81" class="i">+        },
</a><a href="#h12-0-82" id="h12-0-82" class="i">+        Column {
</a><a href="#h12-0-83" id="h12-0-83" class="i">+            name: &quot;studio_id&quot;,
</a><a href="#h12-0-84" id="h12-0-84" class="i">+            datatype: Integer,
</a><a href="#h12-0-85" id="h12-0-85" class="i">+            nullable: false,
</a><a href="#h12-0-86" id="h12-0-86" class="i">+            default: None,
</a><a href="#h12-0-87" id="h12-0-87" class="i">+            unique: false,
</a><a href="#h12-0-88" id="h12-0-88" class="i">+            index: true,
</a><a href="#h12-0-89" id="h12-0-89" class="i">+            references: Some(
</a><a href="#h12-0-90" id="h12-0-90" class="i">+                &quot;studios&quot;,
</a><a href="#h12-0-91" id="h12-0-91" class="i">+            ),
</a><a href="#h12-0-92" id="h12-0-92" class="i">+        },
</a><a href="#h12-0-93" id="h12-0-93" class="i">+        Column {
</a><a href="#h12-0-94" id="h12-0-94" class="i">+            name: &quot;genre_id&quot;,
</a><a href="#h12-0-95" id="h12-0-95" class="i">+            datatype: Integer,
</a><a href="#h12-0-96" id="h12-0-96" class="i">+            nullable: false,
</a><a href="#h12-0-97" id="h12-0-97" class="i">+            default: None,
</a><a href="#h12-0-98" id="h12-0-98" class="i">+            unique: false,
</a><a href="#h12-0-99" id="h12-0-99" class="i">+            index: true,
</a><a href="#h12-0-100" id="h12-0-100" class="i">+            references: Some(
</a><a href="#h12-0-101" id="h12-0-101" class="i">+                &quot;genres&quot;,
</a><a href="#h12-0-102" id="h12-0-102" class="i">+            ),
</a><a href="#h12-0-103" id="h12-0-103" class="i">+        },
</a><a href="#h12-0-104" id="h12-0-104" class="i">+        Column {
</a><a href="#h12-0-105" id="h12-0-105" class="i">+            name: &quot;released&quot;,
</a><a href="#h12-0-106" id="h12-0-106" class="i">+            datatype: Integer,
</a><a href="#h12-0-107" id="h12-0-107" class="i">+            nullable: false,
</a><a href="#h12-0-108" id="h12-0-108" class="i">+            default: None,
</a><a href="#h12-0-109" id="h12-0-109" class="i">+            unique: false,
</a><a href="#h12-0-110" id="h12-0-110" class="i">+            index: false,
</a><a href="#h12-0-111" id="h12-0-111" class="i">+            references: None,
</a><a href="#h12-0-112" id="h12-0-112" class="i">+        },
</a><a href="#h12-0-113" id="h12-0-113" class="i">+        Column {
</a><a href="#h12-0-114" id="h12-0-114" class="i">+            name: &quot;rating&quot;,
</a><a href="#h12-0-115" id="h12-0-115" class="i">+            datatype: Float,
</a><a href="#h12-0-116" id="h12-0-116" class="i">+            nullable: true,
</a><a href="#h12-0-117" id="h12-0-117" class="i">+            default: Some(
</a><a href="#h12-0-118" id="h12-0-118" class="i">+                Null,
</a><a href="#h12-0-119" id="h12-0-119" class="i">+            ),
</a><a href="#h12-0-120" id="h12-0-120" class="i">+            unique: false,
</a><a href="#h12-0-121" id="h12-0-121" class="i">+            index: false,
</a><a href="#h12-0-122" id="h12-0-122" class="i">+            references: None,
</a><a href="#h12-0-123" id="h12-0-123" class="i">+        },
</a><a href="#h12-0-124" id="h12-0-124" class="i">+        Column {
</a><a href="#h12-0-125" id="h12-0-125" class="i">+            name: &quot;ultrahd&quot;,
</a><a href="#h12-0-126" id="h12-0-126" class="i">+            datatype: Boolean,
</a><a href="#h12-0-127" id="h12-0-127" class="i">+            nullable: true,
</a><a href="#h12-0-128" id="h12-0-128" class="i">+            default: Some(
</a><a href="#h12-0-129" id="h12-0-129" class="i">+                Null,
</a><a href="#h12-0-130" id="h12-0-130" class="i">+            ),
</a><a href="#h12-0-131" id="h12-0-131" class="i">+            unique: false,
</a><a href="#h12-0-132" id="h12-0-132" class="i">+            index: false,
</a><a href="#h12-0-133" id="h12-0-133" class="i">+            references: None,
</a><a href="#h12-0-134" id="h12-0-134" class="i">+        },
</a><a href="#h12-0-135" id="h12-0-135" class="i">+    ],
</a><a href="#h12-0-136" id="h12-0-136" class="i">+}
</a><a href="#h12-0-137" id="h12-0-137" class="i">+
</a><a href="#h12-0-138" id="h12-0-138" class="i">+table countries
</a><a href="#h12-0-139" id="h12-0-139" class="i">+table genres
</a><a href="#h12-0-140" id="h12-0-140" class="i">+table studios
</a><a href="#h12-0-141" id="h12-0-141" class="i">+---
</a><a href="#h12-0-142" id="h12-0-142" class="i">+CREATE TABLE countries (
</a><a href="#h12-0-143" id="h12-0-143" class="i">+  id STRING PRIMARY KEY,
</a><a href="#h12-0-144" id="h12-0-144" class="i">+  name STRING NOT NULL
</a><a href="#h12-0-145" id="h12-0-145" class="i">+)
</a><a href="#h12-0-146" id="h12-0-146" class="i">+CREATE TABLE genres (
</a><a href="#h12-0-147" id="h12-0-147" class="i">+  id INTEGER PRIMARY KEY,
</a><a href="#h12-0-148" id="h12-0-148" class="i">+  name STRING NOT NULL
</a><a href="#h12-0-149" id="h12-0-149" class="i">+)
</a><a href="#h12-0-150" id="h12-0-150" class="i">+CREATE TABLE studios (
</a><a href="#h12-0-151" id="h12-0-151" class="i">+  id INTEGER PRIMARY KEY,
</a><a href="#h12-0-152" id="h12-0-152" class="i">+  name STRING NOT NULL,
</a><a href="#h12-0-153" id="h12-0-153" class="i">+  country_id STRING DEFAULT NULL INDEX REFERENCES countries
</a><a href="#h12-0-154" id="h12-0-154" class="i">+)
</a><a href="#h12-0-155" id="h12-0-155" class="i">+
</a><a href="#h12-0-156" id="h12-0-156" class="i">+!table missing
</a><a href="#h12-0-157" id="h12-0-157" class="i">+---
</a><a href="#h12-0-158" id="h12-0-158" class="i">+Error: invalid input: table missing does not exist
</a><a href="#h12-0-159" id="h12-0-159" class="i">+
</a><a href="#h12-0-160" id="h12-0-160" class="i">+# Fetch server status.
</a><a href="#h12-0-161" id="h12-0-161" class="i">+status
</a><a href="#h12-0-162" id="h12-0-162" class="i">+---
</a><a href="#h12-0-163" id="h12-0-163" class="i">+Status {
</a><a href="#h12-0-164" id="h12-0-164" class="i">+    server: 1,
</a><a href="#h12-0-165" id="h12-0-165" class="i">+    raft: Status {
</a><a href="#h12-0-166" id="h12-0-166" class="i">+        leader: 1,
</a><a href="#h12-0-167" id="h12-0-167" class="i">+        term: 1,
</a><a href="#h12-0-168" id="h12-0-168" class="i">+        match_index: {
</a><a href="#h12-0-169" id="h12-0-169" class="i">+            1: 25,
</a><a href="#h12-0-170" id="h12-0-170" class="i">+        },
</a><a href="#h12-0-171" id="h12-0-171" class="i">+        commit_index: 25,
</a><a href="#h12-0-172" id="h12-0-172" class="i">+        applied_index: 25,
</a><a href="#h12-0-173" id="h12-0-173" class="i">+        storage: Status {
</a><a href="#h12-0-174" id="h12-0-174" class="i">+            name: &quot;bitcask&quot;,
</a><a href="#h12-0-175" id="h12-0-175" class="i">+            keys: 27,
</a><a href="#h12-0-176" id="h12-0-176" class="i">+            size: 1169,
</a><a href="#h12-0-177" id="h12-0-177" class="i">+            total_disk_size: 1649,
</a><a href="#h12-0-178" id="h12-0-178" class="i">+            live_disk_size: 1385,
</a><a href="#h12-0-179" id="h12-0-179" class="i">+            garbage_disk_size: 264,
</a><a href="#h12-0-180" id="h12-0-180" class="i">+        },
</a><a href="#h12-0-181" id="h12-0-181" class="i">+    },
</a><a href="#h12-0-182" id="h12-0-182" class="i">+    mvcc: Status {
</a><a href="#h12-0-183" id="h12-0-183" class="i">+        versions: 8,
</a><a href="#h12-0-184" id="h12-0-184" class="i">+        active_txns: 0,
</a><a href="#h12-0-185" id="h12-0-185" class="i">+        storage: Status {
</a><a href="#h12-0-186" id="h12-0-186" class="i">+            name: &quot;bitcask&quot;,
</a><a href="#h12-0-187" id="h12-0-187" class="i">+            keys: 36,
</a><a href="#h12-0-188" id="h12-0-188" class="i">+            size: 2177,
</a><a href="#h12-0-189" id="h12-0-189" class="i">+            total_disk_size: 8259,
</a><a href="#h12-0-190" id="h12-0-190" class="i">+            live_disk_size: 2465,
</a><a href="#h12-0-191" id="h12-0-191" class="i">+            garbage_disk_size: 5794,
</a><a href="#h12-0-192" id="h12-0-192" class="i">+        },
</a><a href="#h12-0-193" id="h12-0-193" class="i">+    },
</a><a href="#h12-0-194" id="h12-0-194" class="i">+}
</a><b>diff --git a/<a id="h13" href="../file/tests/scripts/errors.html">tests/scripts/errors</a> b/<a href="../file/tests/scripts/errors.html">tests/scripts/errors</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,41 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+# Tests various error handling.
</a><a href="#h13-0-1" id="h13-0-1" class="i">+
</a><a href="#h13-0-2" id="h13-0-2" class="i">+cluster nodes=5
</a><a href="#h13-0-3" id="h13-0-3" class="i">+---
</a><a href="#h13-0-4" id="h13-0-4" class="i">+ok
</a><a href="#h13-0-5" id="h13-0-5" class="i">+
</a><a href="#h13-0-6" id="h13-0-6" class="i">+# A transaction can continue and commit after encountering an error.
</a><a href="#h13-0-7" id="h13-0-7" class="i">+&gt; BEGIN
</a><a href="#h13-0-8" id="h13-0-8" class="i">+&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h13-0-9" id="h13-0-9" class="i">+&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h13-0-10" id="h13-0-10" class="i">+!&gt; INSERT INTO test VALUES (NULL, &#39;b&#39;)
</a><a href="#h13-0-11" id="h13-0-11" class="i">+&gt; INSERT INTO test VALUES (2, &#39;b&#39;)
</a><a href="#h13-0-12" id="h13-0-12" class="i">+&gt; COMMIT
</a><a href="#h13-0-13" id="h13-0-13" class="i">+---
</a><a href="#h13-0-14" id="h13-0-14" class="i">+Error: invalid input: invalid primary key NULL
</a><a href="#h13-0-15" id="h13-0-15" class="i">+
</a><a href="#h13-0-16" id="h13-0-16" class="i">+&gt; SELECT * FROM test
</a><a href="#h13-0-17" id="h13-0-17" class="i">+---
</a><a href="#h13-0-18" id="h13-0-18" class="i">+1, &#39;a&#39;
</a><a href="#h13-0-19" id="h13-0-19" class="i">+2, &#39;b&#39;
</a><a href="#h13-0-20" id="h13-0-20" class="i">+
</a><a href="#h13-0-21" id="h13-0-21" class="i">+# Closing/disconnecting a client rolls back an open transaction.
</a><a href="#h13-0-22" id="h13-0-22" class="i">+c1:&gt; BEGIN
</a><a href="#h13-0-23" id="h13-0-23" class="i">+c1:&gt; INSERT INTO test VALUES (3, &#39;c&#39;)
</a><a href="#h13-0-24" id="h13-0-24" class="i">+---
</a><a href="#h13-0-25" id="h13-0-25" class="i">+ok
</a><a href="#h13-0-26" id="h13-0-26" class="i">+
</a><a href="#h13-0-27" id="h13-0-27" class="i">+c2:!&gt; INSERT INTO test VALUES (3, &#39;c&#39;)
</a><a href="#h13-0-28" id="h13-0-28" class="i">+---
</a><a href="#h13-0-29" id="h13-0-29" class="i">+c2: Error: serialization failure, retry transaction
</a><a href="#h13-0-30" id="h13-0-30" class="i">+
</a><a href="#h13-0-31" id="h13-0-31" class="i">+c1:&gt; close
</a><a href="#h13-0-32" id="h13-0-32" class="i">+---
</a><a href="#h13-0-33" id="h13-0-33" class="i">+ok
</a><a href="#h13-0-34" id="h13-0-34" class="i">+
</a><a href="#h13-0-35" id="h13-0-35" class="i">+c2:&gt; INSERT INTO test VALUES (3, &#39;c&#39;)
</a><a href="#h13-0-36" id="h13-0-36" class="i">+c2:&gt; SELECT * FROM test
</a><a href="#h13-0-37" id="h13-0-37" class="i">+---
</a><a href="#h13-0-38" id="h13-0-38" class="i">+c2: 1, &#39;a&#39;
</a><a href="#h13-0-39" id="h13-0-39" class="i">+c2: 2, &#39;b&#39;
</a><a href="#h13-0-40" id="h13-0-40" class="i">+c2: 3, &#39;c&#39;
</a><b>diff --git a/<a id="h14" href="../file/tests/scripts/isolation.html">tests/scripts/isolation</a> b/<a href="../file/tests/scripts/isolation.html">tests/scripts/isolation</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,98 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+# Tests transaction isolation.
</a><a href="#h14-0-1" id="h14-0-1" class="i">+#
</a><a href="#h14-0-2" id="h14-0-2" class="i">+# Transactions are tested more thoroughly in the MVCC tests, this just does some
</a><a href="#h14-0-3" id="h14-0-3" class="i">+# basic SQL-level testing.
</a><a href="#h14-0-4" id="h14-0-4" class="i">+#
</a><a href="#h14-0-5" id="h14-0-5" class="i">+# Sets up a sequence of transactions that each perform a write, and checks
</a><a href="#h14-0-6" id="h14-0-6" class="i">+# what they can see.
</a><a href="#h14-0-7" id="h14-0-7" class="i">+#
</a><a href="#h14-0-8" id="h14-0-8" class="i">+# c1: past, committed before c4 began
</a><a href="#h14-0-9" id="h14-0-9" class="i">+# c2: past, commits after c4 began
</a><a href="#h14-0-10" id="h14-0-10" class="i">+# c3: past, uncommitted
</a><a href="#h14-0-11" id="h14-0-11" class="i">+# c4: test transaction
</a><a href="#h14-0-12" id="h14-0-12" class="i">+# c5: future, committed
</a><a href="#h14-0-13" id="h14-0-13" class="i">+# c6: future, uncommitted
</a><a href="#h14-0-14" id="h14-0-14" class="i">+# c7: future, AS OF version 4
</a><a href="#h14-0-15" id="h14-0-15" class="i">+
</a><a href="#h14-0-16" id="h14-0-16" class="i">+cluster nodes=5
</a><a href="#h14-0-17" id="h14-0-17" class="i">+---
</a><a href="#h14-0-18" id="h14-0-18" class="i">+ok
</a><a href="#h14-0-19" id="h14-0-19" class="i">+
</a><a href="#h14-0-20" id="h14-0-20" class="i">+# c1: past, committed before c4 began
</a><a href="#h14-0-21" id="h14-0-21" class="i">+c1:&gt; BEGIN
</a><a href="#h14-0-22" id="h14-0-22" class="i">+c1:&gt; CREATE TABLE test (id INT PRIMARY KEY, value STRING)
</a><a href="#h14-0-23" id="h14-0-23" class="i">+c1:&gt; INSERT INTO test VALUES (1, &#39;a&#39;)
</a><a href="#h14-0-24" id="h14-0-24" class="i">+c1:&gt; COMMIT
</a><a href="#h14-0-25" id="h14-0-25" class="i">+---
</a><a href="#h14-0-26" id="h14-0-26" class="i">+ok
</a><a href="#h14-0-27" id="h14-0-27" class="i">+
</a><a href="#h14-0-28" id="h14-0-28" class="i">+# c2: past, commits after c4 began
</a><a href="#h14-0-29" id="h14-0-29" class="i">+c2:&gt; BEGIN
</a><a href="#h14-0-30" id="h14-0-30" class="i">+c2:&gt; INSERT INTO test VALUES (2, &#39;b&#39;)
</a><a href="#h14-0-31" id="h14-0-31" class="i">+---
</a><a href="#h14-0-32" id="h14-0-32" class="i">+ok
</a><a href="#h14-0-33" id="h14-0-33" class="i">+
</a><a href="#h14-0-34" id="h14-0-34" class="i">+# c3: past, uncommitted
</a><a href="#h14-0-35" id="h14-0-35" class="i">+c3:&gt; BEGIN
</a><a href="#h14-0-36" id="h14-0-36" class="i">+c3:&gt; INSERT INTO test VALUES (3, &#39;c&#39;)
</a><a href="#h14-0-37" id="h14-0-37" class="i">+---
</a><a href="#h14-0-38" id="h14-0-38" class="i">+ok
</a><a href="#h14-0-39" id="h14-0-39" class="i">+
</a><a href="#h14-0-40" id="h14-0-40" class="i">+# c4: test transaction
</a><a href="#h14-0-41" id="h14-0-41" class="i">+c4:[result]&gt; BEGIN
</a><a href="#h14-0-42" id="h14-0-42" class="i">+c4:&gt; INSERT INTO test VALUES (4, &#39;d&#39;)
</a><a href="#h14-0-43" id="h14-0-43" class="i">+---
</a><a href="#h14-0-44" id="h14-0-44" class="i">+c4: Begin(TransactionState { version: 4, read_only: false, active: {2, 3} })
</a><a href="#h14-0-45" id="h14-0-45" class="i">+
</a><a href="#h14-0-46" id="h14-0-46" class="i">+# Commit c2.
</a><a href="#h14-0-47" id="h14-0-47" class="i">+c2:&gt; COMMIT
</a><a href="#h14-0-48" id="h14-0-48" class="i">+---
</a><a href="#h14-0-49" id="h14-0-49" class="i">+ok
</a><a href="#h14-0-50" id="h14-0-50" class="i">+
</a><a href="#h14-0-51" id="h14-0-51" class="i">+# c5: future, committed
</a><a href="#h14-0-52" id="h14-0-52" class="i">+c5:&gt; BEGIN
</a><a href="#h14-0-53" id="h14-0-53" class="i">+c5:&gt; INSERT INTO test VALUES (5, &#39;e&#39;)
</a><a href="#h14-0-54" id="h14-0-54" class="i">+c5:&gt; COMMIT
</a><a href="#h14-0-55" id="h14-0-55" class="i">+---
</a><a href="#h14-0-56" id="h14-0-56" class="i">+ok
</a><a href="#h14-0-57" id="h14-0-57" class="i">+
</a><a href="#h14-0-58" id="h14-0-58" class="i">+# c6: future, uncommitted
</a><a href="#h14-0-59" id="h14-0-59" class="i">+c6:&gt; BEGIN
</a><a href="#h14-0-60" id="h14-0-60" class="i">+c6:&gt; INSERT INTO test VALUES (6, &#39;f&#39;)
</a><a href="#h14-0-61" id="h14-0-61" class="i">+---
</a><a href="#h14-0-62" id="h14-0-62" class="i">+ok
</a><a href="#h14-0-63" id="h14-0-63" class="i">+
</a><a href="#h14-0-64" id="h14-0-64" class="i">+# When c4 scans, it should only see the write of c1 and itself.
</a><a href="#h14-0-65" id="h14-0-65" class="i">+c4:&gt; SELECT * FROM test
</a><a href="#h14-0-66" id="h14-0-66" class="i">+---
</a><a href="#h14-0-67" id="h14-0-67" class="i">+c4: 1, &#39;a&#39;
</a><a href="#h14-0-68" id="h14-0-68" class="i">+c4: 4, &#39;d&#39;
</a><a href="#h14-0-69" id="h14-0-69" class="i">+
</a><a href="#h14-0-70" id="h14-0-70" class="i">+# An AS OF transaction in version 4 should not see c4&#39;s uncomitted write.
</a><a href="#h14-0-71" id="h14-0-71" class="i">+c7:&gt; BEGIN READ ONLY AS OF SYSTEM TIME 4
</a><a href="#h14-0-72" id="h14-0-72" class="i">+c7:&gt; SELECT * FROM test
</a><a href="#h14-0-73" id="h14-0-73" class="i">+c7:&gt; ROLLBACK
</a><a href="#h14-0-74" id="h14-0-74" class="i">+---
</a><a href="#h14-0-75" id="h14-0-75" class="i">+c7: 1, &#39;a&#39;
</a><a href="#h14-0-76" id="h14-0-76" class="i">+
</a><a href="#h14-0-77" id="h14-0-77" class="i">+# c4 can commit.
</a><a href="#h14-0-78" id="h14-0-78" class="i">+c4:&gt; COMMIT
</a><a href="#h14-0-79" id="h14-0-79" class="i">+---
</a><a href="#h14-0-80" id="h14-0-80" class="i">+ok
</a><a href="#h14-0-81" id="h14-0-81" class="i">+
</a><a href="#h14-0-82" id="h14-0-82" class="i">+# An implicit transaction should see c1, c2, c4, c5:
</a><a href="#h14-0-83" id="h14-0-83" class="i">+&gt; SELECT * FROM test
</a><a href="#h14-0-84" id="h14-0-84" class="i">+---
</a><a href="#h14-0-85" id="h14-0-85" class="i">+1, &#39;a&#39;
</a><a href="#h14-0-86" id="h14-0-86" class="i">+2, &#39;b&#39;
</a><a href="#h14-0-87" id="h14-0-87" class="i">+4, &#39;d&#39;
</a><a href="#h14-0-88" id="h14-0-88" class="i">+5, &#39;e&#39;
</a><a href="#h14-0-89" id="h14-0-89" class="i">+
</a><a href="#h14-0-90" id="h14-0-90" class="i">+# An AS OF transaction in version 4 should not see c4&#39;s write even after it
</a><a href="#h14-0-91" id="h14-0-91" class="i">+# has committed, such that it&#39;s consistent with the previous AS OF 4. The
</a><a href="#h14-0-92" id="h14-0-92" class="i">+# snapshot is taken out at the start of the version.
</a><a href="#h14-0-93" id="h14-0-93" class="i">+c7:&gt; BEGIN READ ONLY AS OF SYSTEM TIME 4
</a><a href="#h14-0-94" id="h14-0-94" class="i">+c7:&gt; SELECT * FROM test
</a><a href="#h14-0-95" id="h14-0-95" class="i">+c7:&gt; ROLLBACK
</a><a href="#h14-0-96" id="h14-0-96" class="i">+---
</a><a href="#h14-0-97" id="h14-0-97" class="i">+c7: 1, &#39;a&#39;
</a><b>diff --git a/<a id="h15" href="../file/tests/scripts/queries.html">tests/scripts/queries</a> b/<a href="../file/tests/scripts/queries.html">tests/scripts/queries</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,104 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+# Tests some basic queries. This is more thorougly tested in the SQL tests, this
</a><a href="#h15-0-1" id="h15-0-1" class="i">+# just tries a few basic things.
</a><a href="#h15-0-2" id="h15-0-2" class="i">+
</a><a href="#h15-0-3" id="h15-0-3" class="i">+cluster nodes=5
</a><a href="#h15-0-4" id="h15-0-4" class="i">+---
</a><a href="#h15-0-5" id="h15-0-5" class="i">+ok
</a><a href="#h15-0-6" id="h15-0-6" class="i">+
</a><a href="#h15-0-7" id="h15-0-7" class="i">+# Add a movie dataset.
</a><a href="#h15-0-8" id="h15-0-8" class="i">+&gt; CREATE TABLE countries (id STRING PRIMARY KEY, name STRING NOT NULL)
</a><a href="#h15-0-9" id="h15-0-9" class="i">+&gt; INSERT INTO countries VALUES (&#39;fr&#39;, &#39;France&#39;), (&#39;ru&#39;, &#39;Russia&#39;), (&#39;us&#39;, &#39;United States of America&#39;)
</a><a href="#h15-0-10" id="h15-0-10" class="i">+&gt; CREATE TABLE genres (id INTEGER PRIMARY KEY, name STRING NOT NULL)
</a><a href="#h15-0-11" id="h15-0-11" class="i">+&gt; INSERT INTO genres VALUES (1, &#39;Science Fiction&#39;), (2, &#39;Action&#39;), (3, &#39;Comedy&#39;)
</a><a href="#h15-0-12" id="h15-0-12" class="i">+&gt; CREATE TABLE studios (id INTEGER PRIMARY KEY, name STRING NOT NULL, country_id STRING REFERENCES countries)
</a><a href="#h15-0-13" id="h15-0-13" class="i">+&gt; INSERT INTO studios VALUES (1, &#39;Mosfilm&#39;, &#39;ru&#39;), (2, &#39;Lionsgate&#39;, &#39;us&#39;), (3, &#39;StudioCanal&#39;, &#39;fr&#39;), (4, &#39;Warner Bros&#39;, &#39;us&#39;)
</a><a href="#h15-0-14" id="h15-0-14" class="i">+&gt; CREATE TABLE movies ( \
</a><a href="#h15-0-15" id="h15-0-15" class="i">+    id INTEGER PRIMARY KEY, \
</a><a href="#h15-0-16" id="h15-0-16" class="i">+    title STRING NOT NULL, \
</a><a href="#h15-0-17" id="h15-0-17" class="i">+    studio_id INTEGER NOT NULL REFERENCES studios, \
</a><a href="#h15-0-18" id="h15-0-18" class="i">+    genre_id INTEGER NOT NULL REFERENCES genres, \
</a><a href="#h15-0-19" id="h15-0-19" class="i">+    released INTEGER NOT NULL, \
</a><a href="#h15-0-20" id="h15-0-20" class="i">+    rating FLOAT, \
</a><a href="#h15-0-21" id="h15-0-21" class="i">+    ultrahd BOOLEAN \
</a><a href="#h15-0-22" id="h15-0-22" class="i">+)
</a><a href="#h15-0-23" id="h15-0-23" class="i">+&gt; INSERT INTO movies VALUES \
</a><a href="#h15-0-24" id="h15-0-24" class="i">+    (1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL), \
</a><a href="#h15-0-25" id="h15-0-25" class="i">+    (2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE), \
</a><a href="#h15-0-26" id="h15-0-26" class="i">+    (3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL), \
</a><a href="#h15-0-27" id="h15-0-27" class="i">+    (4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE), \
</a><a href="#h15-0-28" id="h15-0-28" class="i">+    (5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE), \
</a><a href="#h15-0-29" id="h15-0-29" class="i">+    (6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL), \
</a><a href="#h15-0-30" id="h15-0-30" class="i">+    (7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE), \
</a><a href="#h15-0-31" id="h15-0-31" class="i">+    (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE), \
</a><a href="#h15-0-32" id="h15-0-32" class="i">+    (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE), \
</a><a href="#h15-0-33" id="h15-0-33" class="i">+    (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)
</a><a href="#h15-0-34" id="h15-0-34" class="i">+---
</a><a href="#h15-0-35" id="h15-0-35" class="i">+ok
</a><a href="#h15-0-36" id="h15-0-36" class="i">+
</a><a href="#h15-0-37" id="h15-0-37" class="i">+# Full table scan and point queries. With/without column headers.
</a><a href="#h15-0-38" id="h15-0-38" class="i">+[header]&gt; SELECT * FROM movies
</a><a href="#h15-0-39" id="h15-0-39" class="i">+---
</a><a href="#h15-0-40" id="h15-0-40" class="i">+movies.id, movies.title, movies.studio_id, movies.genre_id, movies.released, movies.rating, movies.ultrahd
</a><a href="#h15-0-41" id="h15-0-41" class="i">+1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL
</a><a href="#h15-0-42" id="h15-0-42" class="i">+2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE
</a><a href="#h15-0-43" id="h15-0-43" class="i">+3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL
</a><a href="#h15-0-44" id="h15-0-44" class="i">+4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE
</a><a href="#h15-0-45" id="h15-0-45" class="i">+5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE
</a><a href="#h15-0-46" id="h15-0-46" class="i">+6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL
</a><a href="#h15-0-47" id="h15-0-47" class="i">+7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE
</a><a href="#h15-0-48" id="h15-0-48" class="i">+8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE
</a><a href="#h15-0-49" id="h15-0-49" class="i">+9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE
</a><a href="#h15-0-50" id="h15-0-50" class="i">+10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE
</a><a href="#h15-0-51" id="h15-0-51" class="i">+
</a><a href="#h15-0-52" id="h15-0-52" class="i">+&gt; SELECT * FROM genres WHERE id = 2
</a><a href="#h15-0-53" id="h15-0-53" class="i">+---
</a><a href="#h15-0-54" id="h15-0-54" class="i">+2, &#39;Action&#39;
</a><a href="#h15-0-55" id="h15-0-55" class="i">+
</a><a href="#h15-0-56" id="h15-0-56" class="i">+# Aggregate query.
</a><a href="#h15-0-57" id="h15-0-57" class="i">+[header]&gt; SELECT s.name AS studio, COUNT(*) AS movies, AVG(m.rating) AS rating \
</a><a href="#h15-0-58" id="h15-0-58" class="i">+    FROM movies m JOIN studios s ON m.studio_id = s.id \
</a><a href="#h15-0-59" id="h15-0-59" class="i">+    GROUP BY s.name ORDER BY rating DESC
</a><a href="#h15-0-60" id="h15-0-60" class="i">+---
</a><a href="#h15-0-61" id="h15-0-61" class="i">+studio, movies, rating
</a><a href="#h15-0-62" id="h15-0-62" class="i">+&#39;Mosfilm&#39;, 2, 8.149999999999999
</a><a href="#h15-0-63" id="h15-0-63" class="i">+&#39;Warner Bros&#39;, 5, 7.919999999999999
</a><a href="#h15-0-64" id="h15-0-64" class="i">+&#39;Lionsgate&#39;, 2, 7.5
</a><a href="#h15-0-65" id="h15-0-65" class="i">+&#39;StudioCanal&#39;, 1, 6.9
</a><a href="#h15-0-66" id="h15-0-66" class="i">+
</a><a href="#h15-0-67" id="h15-0-67" class="i">+# Try a complex multi-way join with multiple joins of the same table. Uses GROUP
</a><a href="#h15-0-68" id="h15-0-68" class="i">+# BY to discard duplicates from the cross join. The query finds all movies
</a><a href="#h15-0-69" id="h15-0-69" class="i">+# belonging to a studio that&#39;s released at least one movies rated 8 or higher.
</a><a href="#h15-0-70" id="h15-0-70" class="i">+&gt; SELECT m.id, m.title, g.name AS genre, s.name AS studio, m.rating \
</a><a href="#h15-0-71" id="h15-0-71" class="i">+  FROM movies m JOIN genres g ON m.genre_id = g.id, \
</a><a href="#h15-0-72" id="h15-0-72" class="i">+    studios s JOIN movies good ON good.studio_id = s.id AND good.rating &gt;= 8 \
</a><a href="#h15-0-73" id="h15-0-73" class="i">+  WHERE m.studio_id = s.id \
</a><a href="#h15-0-74" id="h15-0-74" class="i">+  GROUP BY m.id, m.title, g.name, s.name, m.rating, m.released \
</a><a href="#h15-0-75" id="h15-0-75" class="i">+  ORDER BY m.rating DESC, m.released ASC, m.id ASC
</a><a href="#h15-0-76" id="h15-0-76" class="i">+---
</a><a href="#h15-0-77" id="h15-0-77" class="i">+10, &#39;Inception&#39;, &#39;Science Fiction&#39;, &#39;Warner Bros&#39;, 8.8
</a><a href="#h15-0-78" id="h15-0-78" class="i">+1, &#39;Stalker&#39;, &#39;Science Fiction&#39;, &#39;Mosfilm&#39;, 8.2
</a><a href="#h15-0-79" id="h15-0-79" class="i">+4, &#39;Heat&#39;, &#39;Action&#39;, &#39;Warner Bros&#39;, 8.2
</a><a href="#h15-0-80" id="h15-0-80" class="i">+6, &#39;Solaris&#39;, &#39;Science Fiction&#39;, &#39;Mosfilm&#39;, 8.1
</a><a href="#h15-0-81" id="h15-0-81" class="i">+7, &#39;Gravity&#39;, &#39;Science Fiction&#39;, &#39;Warner Bros&#39;, 7.7
</a><a href="#h15-0-82" id="h15-0-82" class="i">+9, &#39;Birdman&#39;, &#39;Comedy&#39;, &#39;Warner Bros&#39;, 7.7
</a><a href="#h15-0-83" id="h15-0-83" class="i">+5, &#39;The Fountain&#39;, &#39;Science Fiction&#39;, &#39;Warner Bros&#39;, 7.2
</a><a href="#h15-0-84" id="h15-0-84" class="i">+
</a><a href="#h15-0-85" id="h15-0-85" class="i">+# Explain that query.
</a><a href="#h15-0-86" id="h15-0-86" class="i">+&gt; EXPLAIN SELECT m.id, m.title, g.name AS genre, s.name AS studio, m.rating \
</a><a href="#h15-0-87" id="h15-0-87" class="i">+  FROM movies m JOIN genres g ON m.genre_id = g.id, \
</a><a href="#h15-0-88" id="h15-0-88" class="i">+    studios s JOIN movies good ON good.studio_id = s.id AND good.rating &gt;= 8 \
</a><a href="#h15-0-89" id="h15-0-89" class="i">+  WHERE m.studio_id = s.id \
</a><a href="#h15-0-90" id="h15-0-90" class="i">+  GROUP BY m.id, m.title, g.name, s.name, m.rating, m.released \
</a><a href="#h15-0-91" id="h15-0-91" class="i">+  ORDER BY m.rating DESC, m.released ASC, m.id ASC
</a><a href="#h15-0-92" id="h15-0-92" class="i">+---
</a><a href="#h15-0-93" id="h15-0-93" class="i">+Remap: m.id, m.title, genre, studio, m.rating (dropped: m.released)
</a><a href="#h15-0-94" id="h15-0-94" class="i">+└─ Order: m.rating desc, m.released asc, m.id asc
</a><a href="#h15-0-95" id="h15-0-95" class="i">+   └─ Projection: m.id, m.title, g.name as genre, s.name as studio, m.rating, m.released
</a><a href="#h15-0-96" id="h15-0-96" class="i">+      └─ Aggregate: m.id, m.title, g.name, s.name, m.rating, m.released
</a><a href="#h15-0-97" id="h15-0-97" class="i">+         └─ HashJoin: inner on m.studio_id = s.id
</a><a href="#h15-0-98" id="h15-0-98" class="i">+            ├─ HashJoin: inner on m.genre_id = g.id
</a><a href="#h15-0-99" id="h15-0-99" class="i">+            │  ├─ Scan: movies as m
</a><a href="#h15-0-100" id="h15-0-100" class="i">+            │  └─ Scan: genres as g
</a><a href="#h15-0-101" id="h15-0-101" class="i">+            └─ HashJoin: inner on s.id = good.studio_id
</a><a href="#h15-0-102" id="h15-0-102" class="i">+               ├─ Scan: studios as s
</a><a href="#h15-0-103" id="h15-0-103" class="i">+               └─ Scan: movies as good (good.rating &gt; 8 OR good.rating = 8)
</a><b>diff --git a/<a id="h16" href="../file/tests/testcluster.rs.html">tests/testcluster.rs</a> b/<a href="../file/tests/testcluster.rs.html">tests/testcluster.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,144 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+use rand::Rng;
</a><a href="#h16-0-1" id="h16-0-1" class="i">+use std::collections::BTreeMap;
</a><a href="#h16-0-2" id="h16-0-2" class="i">+use std::error::Error;
</a><a href="#h16-0-3" id="h16-0-3" class="i">+use std::fmt::Write as _;
</a><a href="#h16-0-4" id="h16-0-4" class="i">+use std::path::Path;
</a><a href="#h16-0-5" id="h16-0-5" class="i">+use std::time::Duration;
</a><a href="#h16-0-6" id="h16-0-6" class="i">+use toydb::raft::NodeID;
</a><a href="#h16-0-7" id="h16-0-7" class="i">+use toydb::Client;
</a><a href="#h16-0-8" id="h16-0-8" class="i">+
</a><a href="#h16-0-9" id="h16-0-9" class="i">+/// Timeout for node readiness.
</a><a href="#h16-0-10" id="h16-0-10" class="i">+const TIMEOUT: Duration = Duration::from_secs(5);
</a><a href="#h16-0-11" id="h16-0-11" class="i">+
</a><a href="#h16-0-12" id="h16-0-12" class="i">+/// The base SQL port (+id).
</a><a href="#h16-0-13" id="h16-0-13" class="i">+const SQL_BASE_PORT: u16 = 19600;
</a><a href="#h16-0-14" id="h16-0-14" class="i">+
</a><a href="#h16-0-15" id="h16-0-15" class="i">+/// The base Raft port (+id).
</a><a href="#h16-0-16" id="h16-0-16" class="i">+const RAFT_BASE_PORT: u16 = 19700;
</a><a href="#h16-0-17" id="h16-0-17" class="i">+
</a><a href="#h16-0-18" id="h16-0-18" class="i">+/// Runs a toyDB cluster using the built binary in a temporary directory. The
</a><a href="#h16-0-19" id="h16-0-19" class="i">+/// cluster will be killed and removed when dropped.
</a><a href="#h16-0-20" id="h16-0-20" class="i">+///
</a><a href="#h16-0-21" id="h16-0-21" class="i">+/// This runs the cluster as child processes using the built binary instead of
</a><a href="#h16-0-22" id="h16-0-22" class="i">+/// spawning in-memory threads for a couple of reasons: it avoids having to
</a><a href="#h16-0-23" id="h16-0-23" class="i">+/// gracefully shut down the server (which is complicated by e.g.
</a><a href="#h16-0-24" id="h16-0-24" class="i">+/// TcpListener::accept() not being interruptable), and it tests the entire
</a><a href="#h16-0-25" id="h16-0-25" class="i">+/// server (and eventually the toySQL client) end-to-end.
</a><a href="#h16-0-26" id="h16-0-26" class="i">+pub struct TestCluster {
</a><a href="#h16-0-27" id="h16-0-27" class="i">+    servers: BTreeMap&lt;NodeID, TestServer&gt;,
</a><a href="#h16-0-28" id="h16-0-28" class="i">+    #[allow(dead_code)]
</a><a href="#h16-0-29" id="h16-0-29" class="i">+    dir: tempfile::TempDir, // deleted when dropped
</a><a href="#h16-0-30" id="h16-0-30" class="i">+}
</a><a href="#h16-0-31" id="h16-0-31" class="i">+
</a><a href="#h16-0-32" id="h16-0-32" class="i">+type NodePorts = BTreeMap&lt;NodeID, (u16, u16)&gt;; // raft,sql on localhost
</a><a href="#h16-0-33" id="h16-0-33" class="i">+
</a><a href="#h16-0-34" id="h16-0-34" class="i">+impl TestCluster {
</a><a href="#h16-0-35" id="h16-0-35" class="i">+    /// Runs and returns a test cluster. It keeps running until dropped.
</a><a href="#h16-0-36" id="h16-0-36" class="i">+    pub fn run(nodes: u8) -&gt; Result&lt;Self, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h16-0-37" id="h16-0-37" class="i">+        // Create temporary directory.
</a><a href="#h16-0-38" id="h16-0-38" class="i">+        let dir = tempfile::TempDir::with_prefix(&quot;toydb&quot;)?;
</a><a href="#h16-0-39" id="h16-0-39" class="i">+
</a><a href="#h16-0-40" id="h16-0-40" class="i">+        // Allocate port numbers for nodes.
</a><a href="#h16-0-41" id="h16-0-41" class="i">+        let ports: NodePorts = (1..=nodes)
</a><a href="#h16-0-42" id="h16-0-42" class="i">+            .map(|id| (id, (RAFT_BASE_PORT + id as u16, SQL_BASE_PORT + id as u16)))
</a><a href="#h16-0-43" id="h16-0-43" class="i">+            .collect();
</a><a href="#h16-0-44" id="h16-0-44" class="i">+
</a><a href="#h16-0-45" id="h16-0-45" class="i">+        // Start nodes.
</a><a href="#h16-0-46" id="h16-0-46" class="i">+        let mut servers = BTreeMap::new();
</a><a href="#h16-0-47" id="h16-0-47" class="i">+        for id in 1..=nodes {
</a><a href="#h16-0-48" id="h16-0-48" class="i">+            let dir = dir.path().join(format!(&quot;toydb{id}&quot;));
</a><a href="#h16-0-49" id="h16-0-49" class="i">+            servers.insert(id, TestServer::run(id, &amp;dir, &amp;ports)?);
</a><a href="#h16-0-50" id="h16-0-50" class="i">+        }
</a><a href="#h16-0-51" id="h16-0-51" class="i">+
</a><a href="#h16-0-52" id="h16-0-52" class="i">+        // Wait for the nodes to be ready, by fetching the server status.
</a><a href="#h16-0-53" id="h16-0-53" class="i">+        let started = std::time::Instant::now();
</a><a href="#h16-0-54" id="h16-0-54" class="i">+        for server in servers.values_mut() {
</a><a href="#h16-0-55" id="h16-0-55" class="i">+            while let Err(error) = server.connect().and_then(|mut c| Ok(c.status()?)) {
</a><a href="#h16-0-56" id="h16-0-56" class="i">+                server.assert_alive();
</a><a href="#h16-0-57" id="h16-0-57" class="i">+                if started.elapsed() &gt;= TIMEOUT {
</a><a href="#h16-0-58" id="h16-0-58" class="i">+                    return Err(error);
</a><a href="#h16-0-59" id="h16-0-59" class="i">+                }
</a><a href="#h16-0-60" id="h16-0-60" class="i">+                std::thread::sleep(Duration::from_millis(200));
</a><a href="#h16-0-61" id="h16-0-61" class="i">+            }
</a><a href="#h16-0-62" id="h16-0-62" class="i">+        }
</a><a href="#h16-0-63" id="h16-0-63" class="i">+
</a><a href="#h16-0-64" id="h16-0-64" class="i">+        Ok(Self { servers, dir })
</a><a href="#h16-0-65" id="h16-0-65" class="i">+    }
</a><a href="#h16-0-66" id="h16-0-66" class="i">+
</a><a href="#h16-0-67" id="h16-0-67" class="i">+    /// Connects to a random cluster node using a Rust client. Testing with
</a><a href="#h16-0-68" id="h16-0-68" class="i">+    /// toysql is too annoying, since we have to deal with rustyline, PTYs,
</a><a href="#h16-0-69" id="h16-0-69" class="i">+    /// echoing, multiline editing, etc.
</a><a href="#h16-0-70" id="h16-0-70" class="i">+    pub fn connect(&amp;self) -&gt; Result&lt;Client, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h16-0-71" id="h16-0-71" class="i">+        let id = rand::thread_rng().gen_range(1..=self.servers.len()) as NodeID;
</a><a href="#h16-0-72" id="h16-0-72" class="i">+        self.servers.get(&amp;id).unwrap().connect()
</a><a href="#h16-0-73" id="h16-0-73" class="i">+    }
</a><a href="#h16-0-74" id="h16-0-74" class="i">+}
</a><a href="#h16-0-75" id="h16-0-75" class="i">+
</a><a href="#h16-0-76" id="h16-0-76" class="i">+/// A toyDB server.
</a><a href="#h16-0-77" id="h16-0-77" class="i">+pub struct TestServer {
</a><a href="#h16-0-78" id="h16-0-78" class="i">+    id: NodeID,
</a><a href="#h16-0-79" id="h16-0-79" class="i">+    child: std::process::Child,
</a><a href="#h16-0-80" id="h16-0-80" class="i">+    sql_port: u16,
</a><a href="#h16-0-81" id="h16-0-81" class="i">+}
</a><a href="#h16-0-82" id="h16-0-82" class="i">+
</a><a href="#h16-0-83" id="h16-0-83" class="i">+impl TestServer {
</a><a href="#h16-0-84" id="h16-0-84" class="i">+    /// Runs a toyDB server.
</a><a href="#h16-0-85" id="h16-0-85" class="i">+    fn run(id: NodeID, dir: &amp;Path, ports: &amp;NodePorts) -&gt; Result&lt;Self, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h16-0-86" id="h16-0-86" class="i">+        // Build and write the configuration file.
</a><a href="#h16-0-87" id="h16-0-87" class="i">+        let configfile = dir.join(&quot;toydb.yaml&quot;);
</a><a href="#h16-0-88" id="h16-0-88" class="i">+        std::fs::create_dir_all(dir)?;
</a><a href="#h16-0-89" id="h16-0-89" class="i">+        std::fs::write(&amp;configfile, Self::build_config(id, dir, ports)?)?;
</a><a href="#h16-0-90" id="h16-0-90" class="i">+
</a><a href="#h16-0-91" id="h16-0-91" class="i">+        // Build the binary.
</a><a href="#h16-0-92" id="h16-0-92" class="i">+        //
</a><a href="#h16-0-93" id="h16-0-93" class="i">+        // TODO: this may contribute to slow tests, consider building once.
</a><a href="#h16-0-94" id="h16-0-94" class="i">+        let build = escargot::CargoBuild::new().bin(&quot;toydb&quot;).run()?;
</a><a href="#h16-0-95" id="h16-0-95" class="i">+
</a><a href="#h16-0-96" id="h16-0-96" class="i">+        // Spawn process. Discard output.
</a><a href="#h16-0-97" id="h16-0-97" class="i">+        let child = build
</a><a href="#h16-0-98" id="h16-0-98" class="i">+            .command()
</a><a href="#h16-0-99" id="h16-0-99" class="i">+            .args([&quot;-c&quot;, &amp;configfile.to_string_lossy()])
</a><a href="#h16-0-100" id="h16-0-100" class="i">+            .stdout(std::process::Stdio::null())
</a><a href="#h16-0-101" id="h16-0-101" class="i">+            .stderr(std::process::Stdio::null())
</a><a href="#h16-0-102" id="h16-0-102" class="i">+            .spawn()?;
</a><a href="#h16-0-103" id="h16-0-103" class="i">+
</a><a href="#h16-0-104" id="h16-0-104" class="i">+        let (_, sql_port) = ports.get(&amp;id).copied().expect(&quot;node not in ports&quot;);
</a><a href="#h16-0-105" id="h16-0-105" class="i">+        Ok(Self { id, child, sql_port })
</a><a href="#h16-0-106" id="h16-0-106" class="i">+    }
</a><a href="#h16-0-107" id="h16-0-107" class="i">+
</a><a href="#h16-0-108" id="h16-0-108" class="i">+    /// Generates a config file for the given node.
</a><a href="#h16-0-109" id="h16-0-109" class="i">+    fn build_config(id: NodeID, dir: &amp;Path, ports: &amp;NodePorts) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h16-0-110" id="h16-0-110" class="i">+        let (raft_port, sql_port) = ports.get(&amp;id).expect(&quot;node not in ports&quot;);
</a><a href="#h16-0-111" id="h16-0-111" class="i">+        let mut cfg = String::new();
</a><a href="#h16-0-112" id="h16-0-112" class="i">+        writeln!(cfg, &quot;id: {id}&quot;)?;
</a><a href="#h16-0-113" id="h16-0-113" class="i">+        writeln!(cfg, &quot;data_dir: {}&quot;, dir.to_string_lossy())?;
</a><a href="#h16-0-114" id="h16-0-114" class="i">+        writeln!(cfg, &quot;listen_raft: localhost:{raft_port}&quot;)?;
</a><a href="#h16-0-115" id="h16-0-115" class="i">+        writeln!(cfg, &quot;listen_sql: localhost:{sql_port}&quot;)?;
</a><a href="#h16-0-116" id="h16-0-116" class="i">+        writeln!(cfg, &quot;peers: {{&quot;)?;
</a><a href="#h16-0-117" id="h16-0-117" class="i">+        for (peer_id, (peer_raft_port, _)) in ports.iter().filter(|(peer, _)| **peer != id) {
</a><a href="#h16-0-118" id="h16-0-118" class="i">+            writeln!(cfg, &quot;  &#39;{peer_id}&#39;: localhost:{peer_raft_port},&quot;)?;
</a><a href="#h16-0-119" id="h16-0-119" class="i">+        }
</a><a href="#h16-0-120" id="h16-0-120" class="i">+        writeln!(cfg, &quot;}}&quot;)?;
</a><a href="#h16-0-121" id="h16-0-121" class="i">+        Ok(cfg)
</a><a href="#h16-0-122" id="h16-0-122" class="i">+    }
</a><a href="#h16-0-123" id="h16-0-123" class="i">+
</a><a href="#h16-0-124" id="h16-0-124" class="i">+    /// Asserts that the server is still running.
</a><a href="#h16-0-125" id="h16-0-125" class="i">+    fn assert_alive(&amp;mut self) {
</a><a href="#h16-0-126" id="h16-0-126" class="i">+        if let Some(status) = self.child.try_wait().expect(&quot;failed to check exit status&quot;) {
</a><a href="#h16-0-127" id="h16-0-127" class="i">+            panic!(&quot;node {id} exited with status {status}&quot;, id = self.id)
</a><a href="#h16-0-128" id="h16-0-128" class="i">+        }
</a><a href="#h16-0-129" id="h16-0-129" class="i">+    }
</a><a href="#h16-0-130" id="h16-0-130" class="i">+
</a><a href="#h16-0-131" id="h16-0-131" class="i">+    /// Connects to the server using a regular client.
</a><a href="#h16-0-132" id="h16-0-132" class="i">+    fn connect(&amp;self) -&gt; Result&lt;Client, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h16-0-133" id="h16-0-133" class="i">+        Ok(Client::connect((&quot;localhost&quot;, self.sql_port))?)
</a><a href="#h16-0-134" id="h16-0-134" class="i">+    }
</a><a href="#h16-0-135" id="h16-0-135" class="i">+}
</a><a href="#h16-0-136" id="h16-0-136" class="i">+
</a><a href="#h16-0-137" id="h16-0-137" class="i">+impl Drop for TestServer {
</a><a href="#h16-0-138" id="h16-0-138" class="i">+    // Kills the child process when dropped.
</a><a href="#h16-0-139" id="h16-0-139" class="i">+    fn drop(&amp;mut self) {
</a><a href="#h16-0-140" id="h16-0-140" class="i">+        self.child.kill().expect(&quot;failed to kill node&quot;);
</a><a href="#h16-0-141" id="h16-0-141" class="i">+        self.child.wait().expect(&quot;failed to wait for node to terminate&quot;);
</a><a href="#h16-0-142" id="h16-0-142" class="i">+    }
</a><a href="#h16-0-143" id="h16-0-143" class="i">+}
</a><b>diff --git a/<a id="h17" href="../file/tests/tests.rs.html">tests/tests.rs</a> b/<a href="../file/tests/tests.rs.html">tests/tests.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -1,3 +1,161 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+//! A basic set of end-to-end tests as Goldenscripts under tests/scripts/. These
</a><a href="#h17-0-1" id="h17-0-1" class="i">+//! spin up actual clusters using the built binary and run operations against
</a><a href="#h17-0-2" id="h17-0-2" class="i">+//! them from multiple clients.
</a><a href="#h17-0-3" id="h17-0-3" class="i">+//!
</a><a href="#h17-0-4" id="h17-0-4" class="i">+//! There are more comprehensive tests elsewhere in the codebase, see the various
</a><a href="#h17-0-5" id="h17-0-5" class="i">+//! src/*/testscript scripts.
</a><a href="#h17-0-6" id="h17-0-6" class="i">+
</a> #![warn(clippy::all)]
 
<a href="#h17-0-9" id="h17-0-9" class="d">-mod e2e;
</a><a href="#h17-0-10" id="h17-0-10" class="i">+mod testcluster;
</a><a href="#h17-0-11" id="h17-0-11" class="i">+
</a><a href="#h17-0-12" id="h17-0-12" class="i">+use itertools::Itertools as _;
</a><a href="#h17-0-13" id="h17-0-13" class="i">+use std::fmt::Write as _;
</a><a href="#h17-0-14" id="h17-0-14" class="i">+use std::{collections::HashMap, error::Error};
</a><a href="#h17-0-15" id="h17-0-15" class="i">+use test_each_file::test_each_path;
</a><a href="#h17-0-16" id="h17-0-16" class="i">+use testcluster::TestCluster;
</a><a href="#h17-0-17" id="h17-0-17" class="i">+use toydb::{Client, StatementResult};
</a><a href="#h17-0-18" id="h17-0-18" class="i">+
</a><a href="#h17-0-19" id="h17-0-19" class="i">+// Run goldenscript tests in tests/scripts.
</a><a href="#h17-0-20" id="h17-0-20" class="i">+test_each_path! { in &quot;tests/scripts&quot; =&gt; test_goldenscript }
</a><a href="#h17-0-21" id="h17-0-21" class="i">+
</a><a href="#h17-0-22" id="h17-0-22" class="i">+fn test_goldenscript(path: &amp;std::path::Path) {
</a><a href="#h17-0-23" id="h17-0-23" class="i">+    // We can&#39;t run tests concurrently, because the test clusters end up using
</a><a href="#h17-0-24" id="h17-0-24" class="i">+    // the same ports (and we don&#39;t want to run a ton of them). We can&#39;t use the
</a><a href="#h17-0-25" id="h17-0-25" class="i">+    // #[serial] macro either, since it doesn&#39;t work with test_each_path. Just
</a><a href="#h17-0-26" id="h17-0-26" class="i">+    // use a mutex to serialize them, and ignore any poisoning.
</a><a href="#h17-0-27" id="h17-0-27" class="i">+    static MUTEX: std::sync::OnceLock&lt;std::sync::Mutex&lt;()&gt;&gt; = std::sync::OnceLock::new();
</a><a href="#h17-0-28" id="h17-0-28" class="i">+    let mutex = MUTEX.get_or_init(|| std::sync::Mutex::new(()));
</a><a href="#h17-0-29" id="h17-0-29" class="i">+    let _guard = mutex.lock().unwrap_or_else(|error| error.into_inner());
</a><a href="#h17-0-30" id="h17-0-30" class="i">+
</a><a href="#h17-0-31" id="h17-0-31" class="i">+    goldenscript::run(&amp;mut Runner::new(), path).expect(&quot;goldenscript failed&quot;)
</a><a href="#h17-0-32" id="h17-0-32" class="i">+}
</a><a href="#h17-0-33" id="h17-0-33" class="i">+
</a><a href="#h17-0-34" id="h17-0-34" class="i">+/// Runs Raft goldenscript tests. See run() for available commands.
</a><a href="#h17-0-35" id="h17-0-35" class="i">+struct Runner {
</a><a href="#h17-0-36" id="h17-0-36" class="i">+    cluster: Option&lt;TestCluster&gt;,
</a><a href="#h17-0-37" id="h17-0-37" class="i">+    clients: HashMap&lt;String, Client&gt;,
</a><a href="#h17-0-38" id="h17-0-38" class="i">+}
</a><a href="#h17-0-39" id="h17-0-39" class="i">+
</a><a href="#h17-0-40" id="h17-0-40" class="i">+impl Runner {
</a><a href="#h17-0-41" id="h17-0-41" class="i">+    fn new() -&gt; Self {
</a><a href="#h17-0-42" id="h17-0-42" class="i">+        Self { cluster: None, clients: HashMap::new() }
</a><a href="#h17-0-43" id="h17-0-43" class="i">+    }
</a><a href="#h17-0-44" id="h17-0-44" class="i">+
</a><a href="#h17-0-45" id="h17-0-45" class="i">+    /// Fetches a client for the given prefix, or creates a new one.
</a><a href="#h17-0-46" id="h17-0-46" class="i">+    fn get_client(&amp;mut self, prefix: &amp;Option&lt;String&gt;) -&gt; Result&lt;&amp;mut Client, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h17-0-47" id="h17-0-47" class="i">+        let name = Self::client_name(prefix);
</a><a href="#h17-0-48" id="h17-0-48" class="i">+        if !self.clients.contains_key(name) {
</a><a href="#h17-0-49" id="h17-0-49" class="i">+            let Some(cluster) = self.cluster.as_mut() else {
</a><a href="#h17-0-50" id="h17-0-50" class="i">+                return Err(&quot;no cluster&quot;.into());
</a><a href="#h17-0-51" id="h17-0-51" class="i">+            };
</a><a href="#h17-0-52" id="h17-0-52" class="i">+            let client = cluster.connect()?;
</a><a href="#h17-0-53" id="h17-0-53" class="i">+            self.clients.insert(name.to_string(), client);
</a><a href="#h17-0-54" id="h17-0-54" class="i">+        }
</a><a href="#h17-0-55" id="h17-0-55" class="i">+        Ok(self.clients.get_mut(name).expect(&quot;no client&quot;))
</a><a href="#h17-0-56" id="h17-0-56" class="i">+    }
</a><a href="#h17-0-57" id="h17-0-57" class="i">+
</a><a href="#h17-0-58" id="h17-0-58" class="i">+    /// Returns a client name for a prefix.
</a><a href="#h17-0-59" id="h17-0-59" class="i">+    fn client_name(prefix: &amp;Option&lt;String&gt;) -&gt; &amp;str {
</a><a href="#h17-0-60" id="h17-0-60" class="i">+        prefix.as_deref().unwrap_or_default()
</a><a href="#h17-0-61" id="h17-0-61" class="i">+    }
</a><a href="#h17-0-62" id="h17-0-62" class="i">+}
</a><a href="#h17-0-63" id="h17-0-63" class="i">+
</a><a href="#h17-0-64" id="h17-0-64" class="i">+impl goldenscript::Runner for Runner {
</a><a href="#h17-0-65" id="h17-0-65" class="i">+    /// Runs a goldenscript command.
</a><a href="#h17-0-66" id="h17-0-66" class="i">+    fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h17-0-67" id="h17-0-67" class="i">+        let mut output = String::new();
</a><a href="#h17-0-68" id="h17-0-68" class="i">+        let mut tags = command.tags.clone();
</a><a href="#h17-0-69" id="h17-0-69" class="i">+
</a><a href="#h17-0-70" id="h17-0-70" class="i">+        // Handle simple, non-SQL commands.
</a><a href="#h17-0-71" id="h17-0-71" class="i">+        match command.name.as_str() {
</a><a href="#h17-0-72" id="h17-0-72" class="i">+            // close
</a><a href="#h17-0-73" id="h17-0-73" class="i">+            &quot;close&quot; =&gt; {
</a><a href="#h17-0-74" id="h17-0-74" class="i">+                command.consume_args().reject_rest()?;
</a><a href="#h17-0-75" id="h17-0-75" class="i">+                let name = Self::client_name(&amp;command.prefix);
</a><a href="#h17-0-76" id="h17-0-76" class="i">+                if self.clients.remove(name).is_none() {
</a><a href="#h17-0-77" id="h17-0-77" class="i">+                    return Err(&quot;no client to close&quot;.into());
</a><a href="#h17-0-78" id="h17-0-78" class="i">+                }
</a><a href="#h17-0-79" id="h17-0-79" class="i">+                return Ok(output);
</a><a href="#h17-0-80" id="h17-0-80" class="i">+            }
</a><a href="#h17-0-81" id="h17-0-81" class="i">+
</a><a href="#h17-0-82" id="h17-0-82" class="i">+            // cluster nodes=N
</a><a href="#h17-0-83" id="h17-0-83" class="i">+            &quot;cluster&quot; =&gt; {
</a><a href="#h17-0-84" id="h17-0-84" class="i">+                let mut args = command.consume_args();
</a><a href="#h17-0-85" id="h17-0-85" class="i">+                let nodes = args.lookup_parse(&quot;nodes&quot;)?.unwrap_or(0);
</a><a href="#h17-0-86" id="h17-0-86" class="i">+                args.reject_rest()?;
</a><a href="#h17-0-87" id="h17-0-87" class="i">+                if self.cluster.is_some() {
</a><a href="#h17-0-88" id="h17-0-88" class="i">+                    return Err(&quot;cluster already exists&quot;.into());
</a><a href="#h17-0-89" id="h17-0-89" class="i">+                }
</a><a href="#h17-0-90" id="h17-0-90" class="i">+                self.cluster = Some(TestCluster::run(nodes)?);
</a><a href="#h17-0-91" id="h17-0-91" class="i">+                return Ok(output);
</a><a href="#h17-0-92" id="h17-0-92" class="i">+            }
</a><a href="#h17-0-93" id="h17-0-93" class="i">+
</a><a href="#h17-0-94" id="h17-0-94" class="i">+            // status
</a><a href="#h17-0-95" id="h17-0-95" class="i">+            &quot;status&quot; =&gt; {
</a><a href="#h17-0-96" id="h17-0-96" class="i">+                command.consume_args().reject_rest()?;
</a><a href="#h17-0-97" id="h17-0-97" class="i">+                let status = self.get_client(&amp;command.prefix)?.status()?;
</a><a href="#h17-0-98" id="h17-0-98" class="i">+                write!(output, &quot;{status:#?}&quot;)?;
</a><a href="#h17-0-99" id="h17-0-99" class="i">+                return Ok(output);
</a><a href="#h17-0-100" id="h17-0-100" class="i">+            }
</a><a href="#h17-0-101" id="h17-0-101" class="i">+
</a><a href="#h17-0-102" id="h17-0-102" class="i">+            // table [TABLE]
</a><a href="#h17-0-103" id="h17-0-103" class="i">+            &quot;table&quot; =&gt; {
</a><a href="#h17-0-104" id="h17-0-104" class="i">+                let mut args = command.consume_args();
</a><a href="#h17-0-105" id="h17-0-105" class="i">+                let name = &amp;args.next_pos().ok_or(&quot;table not given&quot;)?.value;
</a><a href="#h17-0-106" id="h17-0-106" class="i">+                let raw = args.lookup_parse(&quot;raw&quot;)?.unwrap_or(false);
</a><a href="#h17-0-107" id="h17-0-107" class="i">+                args.reject_rest()?;
</a><a href="#h17-0-108" id="h17-0-108" class="i">+                let table = self.get_client(&amp;command.prefix)?.get_table(name)?;
</a><a href="#h17-0-109" id="h17-0-109" class="i">+                if raw {
</a><a href="#h17-0-110" id="h17-0-110" class="i">+                    write!(output, &quot;{table:#?}&quot;)?;
</a><a href="#h17-0-111" id="h17-0-111" class="i">+                } else {
</a><a href="#h17-0-112" id="h17-0-112" class="i">+                    write!(output, &quot;{table}&quot;)?;
</a><a href="#h17-0-113" id="h17-0-113" class="i">+                }
</a><a href="#h17-0-114" id="h17-0-114" class="i">+                return Ok(output);
</a><a href="#h17-0-115" id="h17-0-115" class="i">+            }
</a><a href="#h17-0-116" id="h17-0-116" class="i">+
</a><a href="#h17-0-117" id="h17-0-117" class="i">+            // tables
</a><a href="#h17-0-118" id="h17-0-118" class="i">+            &quot;tables&quot; =&gt; {
</a><a href="#h17-0-119" id="h17-0-119" class="i">+                command.consume_args().reject_rest()?;
</a><a href="#h17-0-120" id="h17-0-120" class="i">+                let tables = self.get_client(&amp;command.prefix)?.list_tables()?;
</a><a href="#h17-0-121" id="h17-0-121" class="i">+                for table in tables {
</a><a href="#h17-0-122" id="h17-0-122" class="i">+                    writeln!(output, &quot;{table}&quot;)?;
</a><a href="#h17-0-123" id="h17-0-123" class="i">+                }
</a><a href="#h17-0-124" id="h17-0-124" class="i">+                return Ok(output);
</a><a href="#h17-0-125" id="h17-0-125" class="i">+            }
</a><a href="#h17-0-126" id="h17-0-126" class="i">+
</a><a href="#h17-0-127" id="h17-0-127" class="i">+            _ =&gt; {}
</a><a href="#h17-0-128" id="h17-0-128" class="i">+        }
</a><a href="#h17-0-129" id="h17-0-129" class="i">+
</a><a href="#h17-0-130" id="h17-0-130" class="i">+        // Otherwise, interpret the entire command as a SQL statement.
</a><a href="#h17-0-131" id="h17-0-131" class="i">+        if !command.args.is_empty() {
</a><a href="#h17-0-132" id="h17-0-132" class="i">+            return Err(&quot;statements should be given as a command with no args&quot;.into());
</a><a href="#h17-0-133" id="h17-0-133" class="i">+        }
</a><a href="#h17-0-134" id="h17-0-134" class="i">+        let client = self.get_client(&amp;command.prefix)?;
</a><a href="#h17-0-135" id="h17-0-135" class="i">+        let input = &amp;command.name;
</a><a href="#h17-0-136" id="h17-0-136" class="i">+
</a><a href="#h17-0-137" id="h17-0-137" class="i">+        // Execute the command and display the result if requested.
</a><a href="#h17-0-138" id="h17-0-138" class="i">+        // SELECT and EXPLAIN results are always output.
</a><a href="#h17-0-139" id="h17-0-139" class="i">+        let result = client.execute(input)?;
</a><a href="#h17-0-140" id="h17-0-140" class="i">+
</a><a href="#h17-0-141" id="h17-0-141" class="i">+        match result {
</a><a href="#h17-0-142" id="h17-0-142" class="i">+            StatementResult::Select { columns, rows } =&gt; {
</a><a href="#h17-0-143" id="h17-0-143" class="i">+                if tags.remove(&quot;header&quot;) {
</a><a href="#h17-0-144" id="h17-0-144" class="i">+                    writeln!(output, &quot;{}&quot;, columns.into_iter().join(&quot;, &quot;))?;
</a><a href="#h17-0-145" id="h17-0-145" class="i">+                }
</a><a href="#h17-0-146" id="h17-0-146" class="i">+                for row in rows {
</a><a href="#h17-0-147" id="h17-0-147" class="i">+                    writeln!(output, &quot;{}&quot;, row.into_iter().join(&quot;, &quot;))?;
</a><a href="#h17-0-148" id="h17-0-148" class="i">+                }
</a><a href="#h17-0-149" id="h17-0-149" class="i">+            }
</a><a href="#h17-0-150" id="h17-0-150" class="i">+            StatementResult::Explain(root) =&gt; writeln!(output, &quot;{root}&quot;)?,
</a><a href="#h17-0-151" id="h17-0-151" class="i">+            result if tags.remove(&quot;result&quot;) =&gt; writeln!(output, &quot;{result:?}&quot;)?,
</a><a href="#h17-0-152" id="h17-0-152" class="i">+            _ =&gt; {}
</a><a href="#h17-0-153" id="h17-0-153" class="i">+        }
</a><a href="#h17-0-154" id="h17-0-154" class="i">+
</a><a href="#h17-0-155" id="h17-0-155" class="i">+        if let Some(tag) = tags.iter().next() {
</a><a href="#h17-0-156" id="h17-0-156" class="i">+            return Err(format!(&quot;invalid tag {tag}&quot;).into());
</a><a href="#h17-0-157" id="h17-0-157" class="i">+        }
</a><a href="#h17-0-158" id="h17-0-158" class="i">+
</a><a href="#h17-0-159" id="h17-0-159" class="i">+        Ok(output)
</a><a href="#h17-0-160" id="h17-0-160" class="i">+    }
</a><a href="#h17-0-161" id="h17-0-161" class="i">+}
</a></pre>
</div>
</body>
</html>
