<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: replace `Address::Broadcast` with `Node.broadcast()` - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/8722954d9618daa16150e292865e2dee8b86c660.html">8722954d9618daa16150e292865e2dee8b86c660</a>
<b>parent</b> <a href="../commit/89f895cc7345c80ab8f54eab3f27ca784b68446e.html">89f895cc7345c80ab8f54eab3f27ca784b68446e</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Thu, 11 Apr 2024 11:12:22 +0200

raft: replace `Address::Broadcast` with `Node.broadcast()`

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">52</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/follower.rs</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/leader.rs</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/node/mod.rs</a></td><td> | </td><td class="num">17</td><td><span class="i">++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/server.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+</span><span class="d">--------</span></td></tr>
</table></pre><pre>6 files changed, 82 insertions(+), 67 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -14,8 +14,6 @@ pub type ClientReceiver =
</a> /// A message address.
 #[derive(Clone, Copy, Debug, Eq, Hash, PartialEq, Serialize, Deserialize)]
 pub enum Address {
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// Broadcast to all peers. Only valid as an outbound recipient (to).
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    Broadcast,
</a>     /// A node with the specified node ID (local or remote). Valid both as
     /// sender and recipient.
     Node(NodeID),
<b>diff --git a/<a id="h1" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-use super::super::{Address, Event, Message};
</a><a href="#h1-0-1" id="h1-0-1" class="i">+use super::super::{Event, Message};
</a> use super::{rand_election_timeout, Follower, Leader, Node, NodeID, RawNode, Role, Term, Ticks};
 use crate::error::{Error, Result};
 
<a href="#h1-1" id="h1-1" class="h">@@ -161,7 +161,7 @@ impl RawNode&lt;Candidate&gt; {
</a>         self.log.set_term(term, Some(self.id))?;
 
         let (last_index, last_term) = self.log.get_last_index();
<a href="#h1-1-3" id="h1-1-3" class="d">-        self.send(Address::Broadcast, Event::SolicitVote { last_index, last_term })?;
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        self.broadcast(Event::SolicitVote { last_index, last_term })?;
</a>         Ok(())
     }
 }
<a href="#h1-2" id="h1-2" class="h">@@ -169,10 +169,11 @@ impl RawNode&lt;Candidate&gt; {
</a> #[cfg(test)]
 mod tests {
     use super::super::super::state::tests::TestState;
<a href="#h1-2-3" id="h1-2-3" class="d">-    use super::super::super::{Entry, Log, Request};
</a><a href="#h1-2-4" id="h1-2-4" class="i">+    use super::super::super::{Address, Entry, Log, Request};
</a>     use super::super::tests::{assert_messages, assert_node};
     use super::*;
     use crate::storage;
<a href="#h1-2-8" id="h1-2-8" class="i">+    use itertools::Itertools as _;
</a> 
     #[allow(clippy::type_complexity)]
     fn setup() -&gt; Result&lt;(RawNode&lt;Candidate&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
<a href="#h1-3" id="h1-3" class="h">@@ -286,17 +287,19 @@ mod tests {
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3);
 
<a href="#h1-3-3" id="h1-3-3" class="d">-        assert_eq!(
</a><a href="#h1-3-4" id="h1-3-4" class="d">-            node_rx.try_recv()?,
</a><a href="#h1-3-5" id="h1-3-5" class="d">-            Message {
</a><a href="#h1-3-6" id="h1-3-6" class="d">-                from: Address::Node(1),
</a><a href="#h1-3-7" id="h1-3-7" class="d">-                to: Address::Broadcast,
</a><a href="#h1-3-8" id="h1-3-8" class="d">-                term: 3,
</a><a href="#h1-3-9" id="h1-3-9" class="d">-                event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h1-3-10" id="h1-3-10" class="d">-            },
</a><a href="#h1-3-11" id="h1-3-11" class="d">-        );
</a><a href="#h1-3-12" id="h1-3-12" class="i">+        for to in peers.iter().copied().sorted() {
</a><a href="#h1-3-13" id="h1-3-13" class="i">+            assert_eq!(
</a><a href="#h1-3-14" id="h1-3-14" class="i">+                node_rx.try_recv()?,
</a><a href="#h1-3-15" id="h1-3-15" class="i">+                Message {
</a><a href="#h1-3-16" id="h1-3-16" class="i">+                    from: Address::Node(1),
</a><a href="#h1-3-17" id="h1-3-17" class="i">+                    to: Address::Node(to),
</a><a href="#h1-3-18" id="h1-3-18" class="i">+                    term: 3,
</a><a href="#h1-3-19" id="h1-3-19" class="i">+                    event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h1-3-20" id="h1-3-20" class="i">+                },
</a><a href="#h1-3-21" id="h1-3-21" class="i">+            );
</a><a href="#h1-3-22" id="h1-3-22" class="i">+        }
</a> 
<a href="#h1-3-24" id="h1-3-24" class="d">-        for to in peers.iter().cloned() {
</a><a href="#h1-3-25" id="h1-3-25" class="i">+        for to in peers.iter().copied() {
</a>             assert_eq!(
                 node_rx.try_recv()?,
                 Message {
<a href="#h1-4" id="h1-4" class="h">@@ -343,7 +346,8 @@ mod tests {
</a> 
     #[test]
     fn tick() -&gt; Result&lt;()&gt; {
<a href="#h1-4-3" id="h1-4-3" class="d">-        let (candidate, mut node_rx) = setup()?;
</a><a href="#h1-4-4" id="h1-4-4" class="i">+        let (candidate, node_rx) = setup()?;
</a><a href="#h1-4-5" id="h1-4-5" class="i">+        let peers = candidate.peers.clone();
</a>         let timeout = candidate.role.election_timeout;
         let mut node = Node::Candidate(candidate);
 
<a href="#h1-5" id="h1-5" class="h">@@ -354,15 +358,17 @@ mod tests {
</a>         }
         assert_node(&amp;mut node).is_candidate().term(4);
 
<a href="#h1-5-3" id="h1-5-3" class="d">-        assert_messages(
</a><a href="#h1-5-4" id="h1-5-4" class="d">-            &amp;mut node_rx,
</a><a href="#h1-5-5" id="h1-5-5" class="d">-            vec![Message {
</a><a href="#h1-5-6" id="h1-5-6" class="d">-                from: Address::Node(1),
</a><a href="#h1-5-7" id="h1-5-7" class="d">-                to: Address::Broadcast,
</a><a href="#h1-5-8" id="h1-5-8" class="d">-                term: 4,
</a><a href="#h1-5-9" id="h1-5-9" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h1-5-10" id="h1-5-10" class="d">-            }],
</a><a href="#h1-5-11" id="h1-5-11" class="d">-        );
</a><a href="#h1-5-12" id="h1-5-12" class="i">+        for to in peers.iter().copied().sorted() {
</a><a href="#h1-5-13" id="h1-5-13" class="i">+            assert_eq!(
</a><a href="#h1-5-14" id="h1-5-14" class="i">+                node_rx.try_recv()?,
</a><a href="#h1-5-15" id="h1-5-15" class="i">+                Message {
</a><a href="#h1-5-16" id="h1-5-16" class="i">+                    from: Address::Node(1),
</a><a href="#h1-5-17" id="h1-5-17" class="i">+                    to: Address::Node(to),
</a><a href="#h1-5-18" id="h1-5-18" class="i">+                    term: 4,
</a><a href="#h1-5-19" id="h1-5-19" class="i">+                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h1-5-20" id="h1-5-20" class="i">+                },
</a><a href="#h1-5-21" id="h1-5-21" class="i">+            );
</a><a href="#h1-5-22" id="h1-5-22" class="i">+        }
</a>         Ok(())
     }
 }
<b>diff --git a/<a id="h2" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -287,6 +287,7 @@ pub mod tests {
</a>     use super::*;
     use crate::error::Error;
     use crate::storage;
<a href="#h2-0-3" id="h2-0-3" class="i">+    use itertools::Itertools as _;
</a> 
     #[allow(clippy::type_complexity)]
     fn setup() -&gt; Result&lt;(RawNode&lt;Follower&gt;, crossbeam::channel::Receiver&lt;Message&gt;)&gt; {
<a href="#h2-1" id="h2-1" class="h">@@ -971,6 +972,7 @@ pub mod tests {
</a>     #[test]
     fn tick() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h2-1-3" id="h2-1-3" class="i">+        let peers = follower.peers.clone();
</a>         let timeout = follower.role.election_timeout;
         let mut node = Node::Follower(follower);
 
<a href="#h2-2" id="h2-2" class="h">@@ -1002,15 +1004,17 @@ pub mod tests {
</a>         }
         assert_node(&amp;mut node).is_candidate().term(4);
 
<a href="#h2-2-3" id="h2-2-3" class="d">-        assert_messages(
</a><a href="#h2-2-4" id="h2-2-4" class="d">-            &amp;mut node_rx,
</a><a href="#h2-2-5" id="h2-2-5" class="d">-            vec![Message {
</a><a href="#h2-2-6" id="h2-2-6" class="d">-                from: Address::Node(1),
</a><a href="#h2-2-7" id="h2-2-7" class="d">-                to: Address::Broadcast,
</a><a href="#h2-2-8" id="h2-2-8" class="d">-                term: 4,
</a><a href="#h2-2-9" id="h2-2-9" class="d">-                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-2-10" id="h2-2-10" class="d">-            }],
</a><a href="#h2-2-11" id="h2-2-11" class="d">-        );
</a><a href="#h2-2-12" id="h2-2-12" class="i">+        for to in peers.iter().copied().sorted() {
</a><a href="#h2-2-13" id="h2-2-13" class="i">+            assert_eq!(
</a><a href="#h2-2-14" id="h2-2-14" class="i">+                node_rx.try_recv()?,
</a><a href="#h2-2-15" id="h2-2-15" class="i">+                Message {
</a><a href="#h2-2-16" id="h2-2-16" class="i">+                    from: Address::Node(1),
</a><a href="#h2-2-17" id="h2-2-17" class="i">+                    to: Address::Node(to),
</a><a href="#h2-2-18" id="h2-2-18" class="i">+                    term: 4,
</a><a href="#h2-2-19" id="h2-2-19" class="i">+                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-2-20" id="h2-2-20" class="i">+                },
</a><a href="#h2-2-21" id="h2-2-21" class="i">+            );
</a><a href="#h2-2-22" id="h2-2-22" class="i">+        }
</a>         Ok(())
     }
 }
<b>diff --git a/<a id="h3" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -279,7 +279,7 @@ impl RawNode&lt;Leader&gt; {
</a>     pub(super) fn heartbeat(&amp;mut self) -&gt; Result&lt;()&gt; {
         let (commit_index, commit_term) = self.log.get_commit_index();
         let read_seq = self.role.read_seq;
<a href="#h3-0-3" id="h3-0-3" class="d">-        self.send(Address::Broadcast, Event::Heartbeat { commit_index, commit_term, read_seq })?;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+        self.broadcast(Event::Heartbeat { commit_index, commit_term, read_seq })?;
</a>         // NB: We don&#39;t reset self.since_heartbeat here, because we want to send
         // periodic heartbeats regardless of any on-demand heartbeats.
         Ok(())
<a href="#h3-1" id="h3-1" class="h">@@ -406,6 +406,7 @@ mod tests {
</a>     use super::super::tests::{assert_messages, assert_node};
     use super::*;
     use crate::storage;
<a href="#h3-1-3" id="h3-1-3" class="i">+    use itertools::Itertools as _;
</a>     use pretty_assertions::assert_eq;
 
     #[allow(clippy::type_complexity)]
<a href="#h3-2" id="h3-2" class="h">@@ -663,7 +664,8 @@ mod tests {
</a>     #[test]
     // Sending a client query request will pass it to the state machine and trigger heartbeats.
     fn step_clientrequest_query() -&gt; Result&lt;()&gt; {
<a href="#h3-2-3" id="h3-2-3" class="d">-        let (leader, mut node_rx) = setup()?;
</a><a href="#h3-2-4" id="h3-2-4" class="i">+        let (leader, node_rx) = setup()?;
</a><a href="#h3-2-5" id="h3-2-5" class="i">+        let peers = leader.peers.clone();
</a>         let mut node: Node = leader.into();
         node = node.step(Message {
             from: Address::Client,
<a href="#h3-3" id="h3-3" class="h">@@ -672,15 +674,17 @@ mod tests {
</a>             event: Event::ClientRequest { id: vec![0x01], request: Request::Query(vec![0xaf]) },
         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2).last(5);
<a href="#h3-3-3" id="h3-3-3" class="d">-        assert_messages(
</a><a href="#h3-3-4" id="h3-3-4" class="d">-            &amp;mut node_rx,
</a><a href="#h3-3-5" id="h3-3-5" class="d">-            vec![Message {
</a><a href="#h3-3-6" id="h3-3-6" class="d">-                from: Address::Node(1),
</a><a href="#h3-3-7" id="h3-3-7" class="d">-                to: Address::Broadcast,
</a><a href="#h3-3-8" id="h3-3-8" class="d">-                term: 3,
</a><a href="#h3-3-9" id="h3-3-9" class="d">-                event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 1 },
</a><a href="#h3-3-10" id="h3-3-10" class="d">-            }],
</a><a href="#h3-3-11" id="h3-3-11" class="d">-        );
</a><a href="#h3-3-12" id="h3-3-12" class="i">+        for to in peers.iter().copied().sorted() {
</a><a href="#h3-3-13" id="h3-3-13" class="i">+            assert_eq!(
</a><a href="#h3-3-14" id="h3-3-14" class="i">+                node_rx.try_recv()?,
</a><a href="#h3-3-15" id="h3-3-15" class="i">+                Message {
</a><a href="#h3-3-16" id="h3-3-16" class="i">+                    from: Address::Node(1),
</a><a href="#h3-3-17" id="h3-3-17" class="i">+                    to: Address::Node(to),
</a><a href="#h3-3-18" id="h3-3-18" class="i">+                    term: 3,
</a><a href="#h3-3-19" id="h3-3-19" class="i">+                    event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 1 },
</a><a href="#h3-3-20" id="h3-3-20" class="i">+                },
</a><a href="#h3-3-21" id="h3-3-21" class="i">+            );
</a><a href="#h3-3-22" id="h3-3-22" class="i">+        }
</a>         Ok(())
     }
 
<a href="#h3-4" id="h3-4" class="h">@@ -768,6 +772,7 @@ mod tests {
</a>     #[test]
     fn tick() -&gt; Result&lt;()&gt; {
         let (leader, mut node_rx) = setup()?;
<a href="#h3-4-3" id="h3-4-3" class="i">+        let peers = leader.peers.clone();
</a>         let mut node: Node = leader.into();
         for _ in 0..5 {
             for _ in 0..HEARTBEAT_INTERVAL {
<a href="#h3-5" id="h3-5" class="h">@@ -776,15 +781,17 @@ mod tests {
</a>                 assert_node(&amp;mut node).is_leader().term(3).committed(2);
             }
 
<a href="#h3-5-3" id="h3-5-3" class="d">-            assert_eq!(
</a><a href="#h3-5-4" id="h3-5-4" class="d">-                node_rx.try_recv()?,
</a><a href="#h3-5-5" id="h3-5-5" class="d">-                Message {
</a><a href="#h3-5-6" id="h3-5-6" class="d">-                    from: Address::Node(1),
</a><a href="#h3-5-7" id="h3-5-7" class="d">-                    to: Address::Broadcast,
</a><a href="#h3-5-8" id="h3-5-8" class="d">-                    term: 3,
</a><a href="#h3-5-9" id="h3-5-9" class="d">-                    event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h3-5-10" id="h3-5-10" class="d">-                }
</a><a href="#h3-5-11" id="h3-5-11" class="d">-            );
</a><a href="#h3-5-12" id="h3-5-12" class="i">+            for to in peers.iter().copied().sorted() {
</a><a href="#h3-5-13" id="h3-5-13" class="i">+                assert_eq!(
</a><a href="#h3-5-14" id="h3-5-14" class="i">+                    node_rx.try_recv()?,
</a><a href="#h3-5-15" id="h3-5-15" class="i">+                    Message {
</a><a href="#h3-5-16" id="h3-5-16" class="i">+                        from: Address::Node(1),
</a><a href="#h3-5-17" id="h3-5-17" class="i">+                        to: Address::Node(to),
</a><a href="#h3-5-18" id="h3-5-18" class="i">+                        term: 3,
</a><a href="#h3-5-19" id="h3-5-19" class="i">+                        event: Event::Heartbeat { commit_index: 2, commit_term: 1, read_seq: 0 },
</a><a href="#h3-5-20" id="h3-5-20" class="i">+                    }
</a><a href="#h3-5-21" id="h3-5-21" class="i">+                );
</a><a href="#h3-5-22" id="h3-5-22" class="i">+            }
</a>         }
         Ok(())
     }
<b>diff --git a/<a id="h4" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -8,7 +8,8 @@ use candidate::Candidate;
</a> use follower::Follower;
 use leader::Leader;
 
<a href="#h4-0-3" id="h4-0-3" class="d">-use ::log::debug;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+use itertools::Itertools as _;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+use log::debug;
</a> use rand::Rng as _;
 use std::collections::HashSet;
 
<a href="#h4-1" id="h4-1" class="h">@@ -204,6 +205,15 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>         Ok(self.node_tx.send(msg)?)
     }
 
<a href="#h4-1-3" id="h4-1-3" class="i">+    /// Broadcasts an event to all peers.
</a><a href="#h4-1-4" id="h4-1-4" class="i">+    fn broadcast(&amp;self, event: Event) -&gt; Result&lt;()&gt; {
</a><a href="#h4-1-5" id="h4-1-5" class="i">+        // Sort for test determinism.
</a><a href="#h4-1-6" id="h4-1-6" class="i">+        for id in self.peers.iter().copied().sorted() {
</a><a href="#h4-1-7" id="h4-1-7" class="i">+            self.send(Address::Node(id), event.clone())?;
</a><a href="#h4-1-8" id="h4-1-8" class="i">+        }
</a><a href="#h4-1-9" id="h4-1-9" class="i">+        Ok(())
</a><a href="#h4-1-10" id="h4-1-10" class="i">+    }
</a><a href="#h4-1-11" id="h4-1-11" class="i">+
</a>     /// Asserts common node invariants.
     fn assert_node(&amp;mut self) -&gt; Result&lt;()&gt; {
         debug_assert_eq!(self.term, self.log.get_term()?.0, &quot;Term does not match log&quot;);
<a href="#h4-2" id="h4-2" class="h">@@ -215,16 +225,13 @@ impl&lt;R: Role&gt; RawNode&lt;R&gt; {
</a>     /// In a real production database, these should be errors instead, since
     /// external input from the network can&#39;t be trusted to uphold invariants.
     fn assert_step(&amp;self, msg: &amp;Message) {
<a href="#h4-2-3" id="h4-2-3" class="d">-        // Messages must be addressed to the local node, or a broadcast.
</a><a href="#h4-2-4" id="h4-2-4" class="i">+        // Messages must be addressed to the local node.
</a>         match msg.to {
<a href="#h4-2-6" id="h4-2-6" class="d">-            Address::Broadcast =&gt; {}
</a>             Address::Client =&gt; panic!(&quot;Message to client&quot;),
             Address::Node(id) =&gt; assert_eq!(id, self.id, &quot;Message to other node&quot;),
         }
 
         match msg.from {
<a href="#h4-2-12" id="h4-2-12" class="d">-            // The broadcast address can&#39;t send anything.
</a><a href="#h4-2-13" id="h4-2-13" class="d">-            Address::Broadcast =&gt; panic!(&quot;Message from broadcast address&quot;),
</a>             // Clients can only send ClientRequest without a term.
             Address::Client =&gt; {
                 assert_eq!(msg.term, 0, &quot;Client message with term&quot;);
<b>diff --git a/<a id="h5" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -243,17 +243,10 @@ impl Server {
</a>                 recv(node_rx) -&gt; msg =&gt; {
                     let msg = msg?;
                     match msg {
<a href="#h5-0-3" id="h5-0-3" class="d">-                        // FIXME: move broadcast into raft, do request/response differently.
</a><a href="#h5-0-4" id="h5-0-4" class="i">+                        // FIXME: do request/response differently.
</a>                         raft::Message{to: raft::Address::Node(to), ..} =&gt; {
                             peers_tx.get_mut(&amp;to).expect(&quot;Unknown peer&quot;).send(msg)?;
                         },
<a href="#h5-0-8" id="h5-0-8" class="d">-                        raft::Message{to: raft::Address::Broadcast, ..} =&gt; {
</a><a href="#h5-0-9" id="h5-0-9" class="d">-                            for (to, peer_tx) in peers_tx.iter() {
</a><a href="#h5-0-10" id="h5-0-10" class="d">-                                let mut msg = msg.clone();
</a><a href="#h5-0-11" id="h5-0-11" class="d">-                                msg.to = raft::Address::Node(*to);
</a><a href="#h5-0-12" id="h5-0-12" class="d">-                                peer_tx.send(msg)?;
</a><a href="#h5-0-13" id="h5-0-13" class="d">-                            }
</a><a href="#h5-0-14" id="h5-0-14" class="d">-                        },
</a>                         raft::Message{to: raft::Address::Client, event: raft::Event::ClientResponse{ id, response }, ..} =&gt; {
                             if let Some(response_tx) = requests.remove(&amp;id) {
                                 response_tx
</pre>
</div>
</body>
</html>
