<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Added basic MVCC key-value store and new SQL storage engine concept. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/e74e446b2e4b6304b519dbff0dd72783b6ea14a7.html">e74e446b2e4b6304b519dbff0dd72783b6ea14a7</a>
<b>parent</b> <a href="../commit/73cc5af1a2d92097f93a721723acb30ac69896f8.html">73cc5af1a2d92097f93a721723acb30ac69896f8</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun,  1 Dec 2019 14:02:10 +0100

Added basic MVCC key-value store and new SQL storage engine concept.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">README.md</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/error.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h2">src/kv/file.rs</a></td><td> | </td><td class="num">70</td><td><span class="i"></span><span class="d">----------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">src/kv/memory.rs</a></td><td> | </td><td class="num">53</td><td><span class="i"></span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/kv/mod.rs</a></td><td> | </td><td class="num">130</td><td><span class="i">++++</span><span class="d">----------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/kv/mvcc.rs</a></td><td> | </td><td class="num">761</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h6">src/kv/raft.rs</a></td><td> | </td><td class="num">121</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">src/kv/simple.rs</a></td><td> | </td><td class="num">110</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">src/kv/storage/file.rs</a></td><td> | </td><td class="num">79</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/kv/storage/memory.rs</a></td><td> | </td><td class="num">58</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/kv/storage/mod.rs</a></td><td> | </td><td class="num">88</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/raft/log.rs</a></td><td> | </td><td class="num">32</td><td><span class="i">++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/raft/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/raft/node/follower.rs</a></td><td> | </td><td class="num">22</td><td><span class="i">+++++++++++++</span><span class="d">---------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/raft/node/leader.rs</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++++</span><span class="d">-------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/raft/node/mod.rs</a></td><td> | </td><td class="num">79</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/server/mod.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/server/toydb.rs</a></td><td> | </td><td class="num">24</td><td><span class="i">++++++++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">145</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">src/sql/engine/mod.rs</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">264</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/sql/executor/create_table.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/sql/executor/delete.rs</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/sql/executor/drop_table.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/sql/executor/filter.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/sql/executor/insert.rs</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/sql/executor/limit.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">src/sql/executor/mod.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">src/sql/executor/nothing.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">src/sql/executor/offset.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">src/sql/executor/order.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">src/sql/executor/projection.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">src/sql/executor/scan.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">src/sql/executor/update.rs</a></td><td> | </td><td class="num">11</td><td><span class="i">++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h35">src/sql/mod.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/sql/parser/ast.rs</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h37">src/sql/parser/lexer.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h38">src/sql/parser/mod.rs</a></td><td> | </td><td class="num">18</td><td><span class="i">+++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h39">src/sql/planner/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h40">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h41">src/sql/storage.rs</a></td><td> | </td><td class="num">111</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h42">src/sql/tests.rs</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
</table></pre><pre>43 files changed, 1858 insertions(+), 653 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -48,13 +48,15 @@ toydb&gt; SELECT * FROM movies
</a> 
 - [ ] **Schemas:** Compulsory singluar primary keys, unique and foreign key constraints, indexes.
 
<a href="#h0-0-3" id="h0-0-3" class="d">-- [ ] **Transactions:** Self-written ACID-compliant transaction engine with MVCC-based serializable snapshot isolation.
</a><a href="#h0-0-4" id="h0-0-4" class="i">+- [ ] **Transactions:** Self-written ACID-compliant transaction engine with MVCC-based snapshot isolation.
</a><a href="#h0-0-5" id="h0-0-5" class="i">+
</a><a href="#h0-0-6" id="h0-0-6" class="i">+  - [ ] Serializable snapshot isolation.
</a> 
 - [x] **Query Engine:** Self-written iterator-based engine with simple heuristic optimizer.
 
<a href="#h0-0-10" id="h0-0-10" class="d">-  - [ ] Predicate pushdown
</a><a href="#h0-0-11" id="h0-0-11" class="i">+  - [ ] Predicate pushdown.
</a> 
<a href="#h0-0-13" id="h0-0-13" class="d">-  - [ ] Time travel queries
</a><a href="#h0-0-14" id="h0-0-14" class="i">+  - [ ] Time travel queries.
</a> 
 - [ ] **Language:** Self-written SQL parser with support for:
 
<a href="#h0-1" id="h0-1" class="h">@@ -97,6 +99,10 @@ Below is an incomplete list of known issues preventing this from being a &quot;real&quot; 
</a> 
 * **Garbage collection:** old Raft log entries or MVCC versions are never removed, giving unbounded disk usage but also unbounded data history.
 
<a href="#h0-1-3" id="h0-1-3" class="i">+### Transactions
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a><a href="#h0-1-5" id="h0-1-5" class="i">+* **Abortion:** client disconnects or system crashes do not abort transactions, which may cause serialization failures for other transactions due to uncommitted writes.
</a><a href="#h0-1-6" id="h0-1-6" class="i">+
</a> ### Schema
 
 * **Single database:** only a single, unnamed database is supported per ToyDB cluster.
<b>diff --git a/<a id="h1" href="../file/src/error.rs.html">src/error.rs</a> b/<a href="../file/src/error.rs.html">src/error.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,6 +1,8 @@
</a> #[derive(Clone, Debug, PartialEq)]
 pub enum Error {
     RaftBaseNotFound { index: u64, term: u64 },
<a href="#h1-0-3" id="h1-0-3" class="i">+    Serialization,
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    ReadOnly,
</a>     Config(String),
     IO(String),
     Internal(String),
<a href="#h1-1" id="h1-1" class="h">@@ -21,6 +23,8 @@ impl std::fmt::Display for Error {
</a>             Error::RaftBaseNotFound { index, term } =&gt; {
                 write!(f, &quot;Base entry at index {} with term {} not found&quot;, index, term)
             }
<a href="#h1-1-3" id="h1-1-3" class="i">+            Error::Serialization =&gt; write!(f, &quot;Serialization failure, retry transaction&quot;),
</a><a href="#h1-1-4" id="h1-1-4" class="i">+            Error::ReadOnly =&gt; write!(f, &quot;Read-only transaction&quot;),
</a>         }
     }
 }
<b>diff --git a/<a id="h2" href="../file/src/kv/file.rs.html">src/kv/file.rs</a> b/<a href="../file/src/kv/file.rs.html">src/kv/file.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,70 +0,0 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-use super::{Iter, Range, Store};
</a><a href="#h2-0-1" id="h2-0-1" class="d">-use crate::Error;
</a><a href="#h2-0-2" id="h2-0-2" class="d">-use std::collections::BTreeMap;
</a><a href="#h2-0-3" id="h2-0-3" class="d">-use std::io::Seek;
</a><a href="#h2-0-4" id="h2-0-4" class="d">-
</a><a href="#h2-0-5" id="h2-0-5" class="d">-/// A prototype on-disk key-value store. The current version keeps all data in
</a><a href="#h2-0-6" id="h2-0-6" class="d">-/// memory and writes out the entire dataset to disk on every write. It is a
</a><a href="#h2-0-7" id="h2-0-7" class="d">-/// stop-gap solution until a proper store can be written.
</a><a href="#h2-0-8" id="h2-0-8" class="d">-#[derive(Debug)]
</a><a href="#h2-0-9" id="h2-0-9" class="d">-pub struct File {
</a><a href="#h2-0-10" id="h2-0-10" class="d">-    file: std::fs::File,
</a><a href="#h2-0-11" id="h2-0-11" class="d">-    data: BTreeMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;,
</a><a href="#h2-0-12" id="h2-0-12" class="d">-}
</a><a href="#h2-0-13" id="h2-0-13" class="d">-
</a><a href="#h2-0-14" id="h2-0-14" class="d">-impl File {
</a><a href="#h2-0-15" id="h2-0-15" class="d">-    /// Creates a new file-backed key-value store.
</a><a href="#h2-0-16" id="h2-0-16" class="d">-    pub fn new(file: std::fs::File) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h2-0-17" id="h2-0-17" class="d">-        let data = if file.metadata()?.len() &gt; 0 {
</a><a href="#h2-0-18" id="h2-0-18" class="d">-            rmp_serde::decode::from_read(file.try_clone()?)?
</a><a href="#h2-0-19" id="h2-0-19" class="d">-        } else {
</a><a href="#h2-0-20" id="h2-0-20" class="d">-            BTreeMap::new()
</a><a href="#h2-0-21" id="h2-0-21" class="d">-        };
</a><a href="#h2-0-22" id="h2-0-22" class="d">-        Ok(Self { file, data })
</a><a href="#h2-0-23" id="h2-0-23" class="d">-    }
</a><a href="#h2-0-24" id="h2-0-24" class="d">-
</a><a href="#h2-0-25" id="h2-0-25" class="d">-    /// Writes out the entire dataset to the file.
</a><a href="#h2-0-26" id="h2-0-26" class="d">-    fn flush(&amp;mut self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-0-27" id="h2-0-27" class="d">-        self.file.seek(std::io::SeekFrom::Start(0))?;
</a><a href="#h2-0-28" id="h2-0-28" class="d">-        rmp_serde::encode::write(&amp;mut self.file, &amp;self.data)?;
</a><a href="#h2-0-29" id="h2-0-29" class="d">-        Ok(())
</a><a href="#h2-0-30" id="h2-0-30" class="d">-    }
</a><a href="#h2-0-31" id="h2-0-31" class="d">-}
</a><a href="#h2-0-32" id="h2-0-32" class="d">-
</a><a href="#h2-0-33" id="h2-0-33" class="d">-impl Store for File {
</a><a href="#h2-0-34" id="h2-0-34" class="d">-    fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-0-35" id="h2-0-35" class="d">-        self.data.remove(key);
</a><a href="#h2-0-36" id="h2-0-36" class="d">-        self.flush()?;
</a><a href="#h2-0-37" id="h2-0-37" class="d">-        Ok(())
</a><a href="#h2-0-38" id="h2-0-38" class="d">-    }
</a><a href="#h2-0-39" id="h2-0-39" class="d">-
</a><a href="#h2-0-40" id="h2-0-40" class="d">-    fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h2-0-41" id="h2-0-41" class="d">-        Ok(self.data.get(key).cloned())
</a><a href="#h2-0-42" id="h2-0-42" class="d">-    }
</a><a href="#h2-0-43" id="h2-0-43" class="d">-
</a><a href="#h2-0-44" id="h2-0-44" class="d">-    fn iter_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Box&lt;Range&gt; {
</a><a href="#h2-0-45" id="h2-0-45" class="d">-        let from = prefix.to_vec();
</a><a href="#h2-0-46" id="h2-0-46" class="d">-        let mut to = from.clone();
</a><a href="#h2-0-47" id="h2-0-47" class="d">-        to.extend_from_slice(std::char::MAX.to_string().as_bytes());
</a><a href="#h2-0-48" id="h2-0-48" class="d">-        Box::new(Iter::from(self.data.range(from..to)))
</a><a href="#h2-0-49" id="h2-0-49" class="d">-    }
</a><a href="#h2-0-50" id="h2-0-50" class="d">-
</a><a href="#h2-0-51" id="h2-0-51" class="d">-    fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h2-0-52" id="h2-0-52" class="d">-        self.data.insert(key.to_vec(), value);
</a><a href="#h2-0-53" id="h2-0-53" class="d">-        self.flush()?;
</a><a href="#h2-0-54" id="h2-0-54" class="d">-        Ok(())
</a><a href="#h2-0-55" id="h2-0-55" class="d">-    }
</a><a href="#h2-0-56" id="h2-0-56" class="d">-}
</a><a href="#h2-0-57" id="h2-0-57" class="d">-
</a><a href="#h2-0-58" id="h2-0-58" class="d">-#[cfg(test)]
</a><a href="#h2-0-59" id="h2-0-59" class="d">-mod tests {
</a><a href="#h2-0-60" id="h2-0-60" class="d">-    extern crate tempfile;
</a><a href="#h2-0-61" id="h2-0-61" class="d">-    use super::super::tests::Suite;
</a><a href="#h2-0-62" id="h2-0-62" class="d">-    use super::*;
</a><a href="#h2-0-63" id="h2-0-63" class="d">-    use tempfile::tempfile;
</a><a href="#h2-0-64" id="h2-0-64" class="d">-
</a><a href="#h2-0-65" id="h2-0-65" class="d">-    #[test]
</a><a href="#h2-0-66" id="h2-0-66" class="d">-    fn suite() {
</a><a href="#h2-0-67" id="h2-0-67" class="d">-        Suite::new(|| Box::new(File::new(tempfile().unwrap()).unwrap())).test()
</a><a href="#h2-0-68" id="h2-0-68" class="d">-    }
</a><a href="#h2-0-69" id="h2-0-69" class="d">-}
</a><b>diff --git a/<a id="h3" href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a> b/<a href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,53 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::{Iter, Range, Store};
</a><a href="#h3-0-1" id="h3-0-1" class="d">-use crate::Error;
</a><a href="#h3-0-2" id="h3-0-2" class="d">-use std::collections::BTreeMap;
</a><a href="#h3-0-3" id="h3-0-3" class="d">-use std::sync::{Arc, RwLock};
</a><a href="#h3-0-4" id="h3-0-4" class="d">-
</a><a href="#h3-0-5" id="h3-0-5" class="d">-/// An in-memory key-value store. It is primarily used for
</a><a href="#h3-0-6" id="h3-0-6" class="d">-/// prototyping and testing, and protects its internal state
</a><a href="#h3-0-7" id="h3-0-7" class="d">-/// using a arc-mutex so it can be shared between threads.
</a><a href="#h3-0-8" id="h3-0-8" class="d">-#[derive(Clone, Debug)]
</a><a href="#h3-0-9" id="h3-0-9" class="d">-pub struct Memory {
</a><a href="#h3-0-10" id="h3-0-10" class="d">-    data: Arc&lt;RwLock&lt;BTreeMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h3-0-11" id="h3-0-11" class="d">-}
</a><a href="#h3-0-12" id="h3-0-12" class="d">-
</a><a href="#h3-0-13" id="h3-0-13" class="d">-impl Memory {
</a><a href="#h3-0-14" id="h3-0-14" class="d">-    /// Creates a new Memory key-value store
</a><a href="#h3-0-15" id="h3-0-15" class="d">-    pub fn new() -&gt; Self {
</a><a href="#h3-0-16" id="h3-0-16" class="d">-        Self { data: Arc::new(RwLock::new(BTreeMap::new())) }
</a><a href="#h3-0-17" id="h3-0-17" class="d">-    }
</a><a href="#h3-0-18" id="h3-0-18" class="d">-}
</a><a href="#h3-0-19" id="h3-0-19" class="d">-
</a><a href="#h3-0-20" id="h3-0-20" class="d">-impl Store for Memory {
</a><a href="#h3-0-21" id="h3-0-21" class="d">-    fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-0-22" id="h3-0-22" class="d">-        self.data.write()?.remove(key);
</a><a href="#h3-0-23" id="h3-0-23" class="d">-        Ok(())
</a><a href="#h3-0-24" id="h3-0-24" class="d">-    }
</a><a href="#h3-0-25" id="h3-0-25" class="d">-
</a><a href="#h3-0-26" id="h3-0-26" class="d">-    fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h3-0-27" id="h3-0-27" class="d">-        Ok(self.data.read()?.get(key).cloned())
</a><a href="#h3-0-28" id="h3-0-28" class="d">-    }
</a><a href="#h3-0-29" id="h3-0-29" class="d">-
</a><a href="#h3-0-30" id="h3-0-30" class="d">-    fn iter_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Box&lt;Range&gt; {
</a><a href="#h3-0-31" id="h3-0-31" class="d">-        let from = prefix.to_vec();
</a><a href="#h3-0-32" id="h3-0-32" class="d">-        let mut to = from.clone();
</a><a href="#h3-0-33" id="h3-0-33" class="d">-        to.extend_from_slice(std::char::MAX.to_string().as_bytes());
</a><a href="#h3-0-34" id="h3-0-34" class="d">-        Box::new(Iter::from(self.data.read().unwrap().range(from..to)))
</a><a href="#h3-0-35" id="h3-0-35" class="d">-    }
</a><a href="#h3-0-36" id="h3-0-36" class="d">-
</a><a href="#h3-0-37" id="h3-0-37" class="d">-    fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h3-0-38" id="h3-0-38" class="d">-        self.data.write()?.insert(key.to_vec(), value);
</a><a href="#h3-0-39" id="h3-0-39" class="d">-        Ok(())
</a><a href="#h3-0-40" id="h3-0-40" class="d">-    }
</a><a href="#h3-0-41" id="h3-0-41" class="d">-}
</a><a href="#h3-0-42" id="h3-0-42" class="d">-
</a><a href="#h3-0-43" id="h3-0-43" class="d">-#[cfg(test)]
</a><a href="#h3-0-44" id="h3-0-44" class="d">-mod tests {
</a><a href="#h3-0-45" id="h3-0-45" class="d">-    use super::super::tests::Suite;
</a><a href="#h3-0-46" id="h3-0-46" class="d">-    use super::*;
</a><a href="#h3-0-47" id="h3-0-47" class="d">-
</a><a href="#h3-0-48" id="h3-0-48" class="d">-    #[test]
</a><a href="#h3-0-49" id="h3-0-49" class="d">-    fn suite() {
</a><a href="#h3-0-50" id="h3-0-50" class="d">-        Suite::new(|| Box::new(Memory::new())).test()
</a><a href="#h3-0-51" id="h3-0-51" class="d">-    }
</a><a href="#h3-0-52" id="h3-0-52" class="d">-}
</a><b>diff --git a/<a id="h4" href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a> b/<a href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,126 +1,6 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-mod file;
</a><a href="#h4-0-1" id="h4-0-1" class="d">-#[cfg(test)]
</a><a href="#h4-0-2" id="h4-0-2" class="d">-mod memory;
</a><a href="#h4-0-3" id="h4-0-3" class="d">-mod raft;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+mod mvcc;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+mod simple;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+pub mod storage;
</a> 
<a href="#h4-0-8" id="h4-0-8" class="d">-use crate::Error;
</a><a href="#h4-0-9" id="h4-0-9" class="d">-pub use file::File;
</a><a href="#h4-0-10" id="h4-0-10" class="d">-#[cfg(test)]
</a><a href="#h4-0-11" id="h4-0-11" class="d">-pub use memory::Memory;
</a><a href="#h4-0-12" id="h4-0-12" class="d">-pub use raft::Raft;
</a><a href="#h4-0-13" id="h4-0-13" class="d">-
</a><a href="#h4-0-14" id="h4-0-14" class="d">-type Range = dyn Iterator&lt;Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;), Error&gt;&gt; + Sync + Send;
</a><a href="#h4-0-15" id="h4-0-15" class="d">-
</a><a href="#h4-0-16" id="h4-0-16" class="d">-/// A key-value store
</a><a href="#h4-0-17" id="h4-0-17" class="d">-pub trait Store: &#39;static + Sync + Send + std::fmt::Debug {
</a><a href="#h4-0-18" id="h4-0-18" class="d">-    /// Deletes a value in the store, regardless of whether it existed before.
</a><a href="#h4-0-19" id="h4-0-19" class="d">-    fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h4-0-20" id="h4-0-20" class="d">-
</a><a href="#h4-0-21" id="h4-0-21" class="d">-    /// Gets a value from the store
</a><a href="#h4-0-22" id="h4-0-22" class="d">-    fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt;;
</a><a href="#h4-0-23" id="h4-0-23" class="d">-
</a><a href="#h4-0-24" id="h4-0-24" class="d">-    /// Returns an iterator over all pairs in the store under a key prefix
</a><a href="#h4-0-25" id="h4-0-25" class="d">-    fn iter_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Box&lt;Range&gt;;
</a><a href="#h4-0-26" id="h4-0-26" class="d">-
</a><a href="#h4-0-27" id="h4-0-27" class="d">-    /// Sets a value in the store
</a><a href="#h4-0-28" id="h4-0-28" class="d">-    fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h4-0-29" id="h4-0-29" class="d">-}
</a><a href="#h4-0-30" id="h4-0-30" class="d">-
</a><a href="#h4-0-31" id="h4-0-31" class="d">-/// This is a terrible, temporary iterator implementation which is prepopulated
</a><a href="#h4-0-32" id="h4-0-32" class="d">-/// with all data, to avoid having to deal with trait lifetimes right now.
</a><a href="#h4-0-33" id="h4-0-33" class="d">-struct Iter {
</a><a href="#h4-0-34" id="h4-0-34" class="d">-    #[allow(clippy::type_complexity)]
</a><a href="#h4-0-35" id="h4-0-35" class="d">-    stack: Vec&lt;Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;), Error&gt;&gt;,
</a><a href="#h4-0-36" id="h4-0-36" class="d">-}
</a><a href="#h4-0-37" id="h4-0-37" class="d">-
</a><a href="#h4-0-38" id="h4-0-38" class="d">-impl Iter {
</a><a href="#h4-0-39" id="h4-0-39" class="d">-    fn from&lt;&#39;a, I&gt;(iter: I) -&gt; Self
</a><a href="#h4-0-40" id="h4-0-40" class="d">-    where
</a><a href="#h4-0-41" id="h4-0-41" class="d">-        I: DoubleEndedIterator + Iterator&lt;Item = (&amp;&#39;a Vec&lt;u8&gt;, &amp;&#39;a Vec&lt;u8&gt;)&gt;,
</a><a href="#h4-0-42" id="h4-0-42" class="d">-    {
</a><a href="#h4-0-43" id="h4-0-43" class="d">-        Self { stack: iter.map(|(k, v)| Ok((k.clone(), v.clone()))).rev().collect() }
</a><a href="#h4-0-44" id="h4-0-44" class="d">-    }
</a><a href="#h4-0-45" id="h4-0-45" class="d">-
</a><a href="#h4-0-46" id="h4-0-46" class="d">-    fn from_vec(vec: Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;) -&gt; Self {
</a><a href="#h4-0-47" id="h4-0-47" class="d">-        Self { stack: vec.into_iter().map(Ok).rev().collect() }
</a><a href="#h4-0-48" id="h4-0-48" class="d">-    }
</a><a href="#h4-0-49" id="h4-0-49" class="d">-}
</a><a href="#h4-0-50" id="h4-0-50" class="d">-
</a><a href="#h4-0-51" id="h4-0-51" class="d">-impl Iterator for Iter {
</a><a href="#h4-0-52" id="h4-0-52" class="d">-    type Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;), Error&gt;;
</a><a href="#h4-0-53" id="h4-0-53" class="d">-
</a><a href="#h4-0-54" id="h4-0-54" class="d">-    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
</a><a href="#h4-0-55" id="h4-0-55" class="d">-        self.stack.pop()
</a><a href="#h4-0-56" id="h4-0-56" class="d">-    }
</a><a href="#h4-0-57" id="h4-0-57" class="d">-}
</a><a href="#h4-0-58" id="h4-0-58" class="d">-
</a><a href="#h4-0-59" id="h4-0-59" class="d">-#[cfg(test)]
</a><a href="#h4-0-60" id="h4-0-60" class="d">-pub mod tests {
</a><a href="#h4-0-61" id="h4-0-61" class="d">-    use super::*;
</a><a href="#h4-0-62" id="h4-0-62" class="d">-
</a><a href="#h4-0-63" id="h4-0-63" class="d">-    pub struct Suite {
</a><a href="#h4-0-64" id="h4-0-64" class="d">-        factory: Box&lt;dyn Fn() -&gt; Box&lt;dyn Store&gt;&gt;,
</a><a href="#h4-0-65" id="h4-0-65" class="d">-    }
</a><a href="#h4-0-66" id="h4-0-66" class="d">-
</a><a href="#h4-0-67" id="h4-0-67" class="d">-    impl Suite {
</a><a href="#h4-0-68" id="h4-0-68" class="d">-        pub fn new&lt;F&gt;(setup: F) -&gt; Self
</a><a href="#h4-0-69" id="h4-0-69" class="d">-        where
</a><a href="#h4-0-70" id="h4-0-70" class="d">-            F: &#39;static + Fn() -&gt; Box&lt;dyn Store&gt;,
</a><a href="#h4-0-71" id="h4-0-71" class="d">-        {
</a><a href="#h4-0-72" id="h4-0-72" class="d">-            Self { factory: Box::new(setup) }
</a><a href="#h4-0-73" id="h4-0-73" class="d">-        }
</a><a href="#h4-0-74" id="h4-0-74" class="d">-
</a><a href="#h4-0-75" id="h4-0-75" class="d">-        fn setup(&amp;self) -&gt; Box&lt;dyn Store&gt; {
</a><a href="#h4-0-76" id="h4-0-76" class="d">-            (&amp;self.factory)()
</a><a href="#h4-0-77" id="h4-0-77" class="d">-        }
</a><a href="#h4-0-78" id="h4-0-78" class="d">-
</a><a href="#h4-0-79" id="h4-0-79" class="d">-        pub fn test(&amp;self) {
</a><a href="#h4-0-80" id="h4-0-80" class="d">-            self.test_delete();
</a><a href="#h4-0-81" id="h4-0-81" class="d">-            self.test_get();
</a><a href="#h4-0-82" id="h4-0-82" class="d">-            self.test_iter_prefix();
</a><a href="#h4-0-83" id="h4-0-83" class="d">-            self.test_set();
</a><a href="#h4-0-84" id="h4-0-84" class="d">-        }
</a><a href="#h4-0-85" id="h4-0-85" class="d">-
</a><a href="#h4-0-86" id="h4-0-86" class="d">-        pub fn test_delete(&amp;self) {
</a><a href="#h4-0-87" id="h4-0-87" class="d">-            let mut s = self.setup();
</a><a href="#h4-0-88" id="h4-0-88" class="d">-            s.set(b&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h4-0-89" id="h4-0-89" class="d">-            assert_eq!(vec![0x01], s.get(b&quot;a&quot;).unwrap().unwrap());
</a><a href="#h4-0-90" id="h4-0-90" class="d">-            s.delete(b&quot;a&quot;).unwrap();
</a><a href="#h4-0-91" id="h4-0-91" class="d">-            assert_eq!(None, s.get(b&quot;a&quot;).unwrap());
</a><a href="#h4-0-92" id="h4-0-92" class="d">-            s.delete(b&quot;b&quot;).unwrap();
</a><a href="#h4-0-93" id="h4-0-93" class="d">-        }
</a><a href="#h4-0-94" id="h4-0-94" class="d">-
</a><a href="#h4-0-95" id="h4-0-95" class="d">-        pub fn test_get(&amp;self) {
</a><a href="#h4-0-96" id="h4-0-96" class="d">-            let mut s = self.setup();
</a><a href="#h4-0-97" id="h4-0-97" class="d">-            s.set(b&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h4-0-98" id="h4-0-98" class="d">-            assert_eq!(vec![0x01], s.get(b&quot;a&quot;).unwrap().unwrap());
</a><a href="#h4-0-99" id="h4-0-99" class="d">-            assert_eq!(None, s.get(b&quot;b&quot;).unwrap());
</a><a href="#h4-0-100" id="h4-0-100" class="d">-        }
</a><a href="#h4-0-101" id="h4-0-101" class="d">-
</a><a href="#h4-0-102" id="h4-0-102" class="d">-        pub fn test_iter_prefix(&amp;self) {
</a><a href="#h4-0-103" id="h4-0-103" class="d">-            let mut s = self.setup();
</a><a href="#h4-0-104" id="h4-0-104" class="d">-            s.set(b&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h4-0-105" id="h4-0-105" class="d">-            s.set(b&quot;b&quot;, vec![0x02]).unwrap();
</a><a href="#h4-0-106" id="h4-0-106" class="d">-            s.set(b&quot;ba&quot;, vec![0x02, 0x01]).unwrap();
</a><a href="#h4-0-107" id="h4-0-107" class="d">-            s.set(b&quot;bb&quot;, vec![0x02, 0x02]).unwrap();
</a><a href="#h4-0-108" id="h4-0-108" class="d">-            s.set(b&quot;c&quot;, vec![0x03]).unwrap();
</a><a href="#h4-0-109" id="h4-0-109" class="d">-
</a><a href="#h4-0-110" id="h4-0-110" class="d">-            assert_eq!(
</a><a href="#h4-0-111" id="h4-0-111" class="d">-                vec![
</a><a href="#h4-0-112" id="h4-0-112" class="d">-                    (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h4-0-113" id="h4-0-113" class="d">-                    (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h4-0-114" id="h4-0-114" class="d">-                    (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h4-0-115" id="h4-0-115" class="d">-                ],
</a><a href="#h4-0-116" id="h4-0-116" class="d">-                s.iter_prefix(b&quot;b&quot;).collect::&lt;Result&lt;Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;, Error&gt;&gt;().unwrap()
</a><a href="#h4-0-117" id="h4-0-117" class="d">-            )
</a><a href="#h4-0-118" id="h4-0-118" class="d">-        }
</a><a href="#h4-0-119" id="h4-0-119" class="d">-
</a><a href="#h4-0-120" id="h4-0-120" class="d">-        pub fn test_set(&amp;self) {
</a><a href="#h4-0-121" id="h4-0-121" class="d">-            let mut s = self.setup();
</a><a href="#h4-0-122" id="h4-0-122" class="d">-            s.set(b&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h4-0-123" id="h4-0-123" class="d">-            assert_eq!(vec![0x01], s.get(b&quot;a&quot;).unwrap().unwrap());
</a><a href="#h4-0-124" id="h4-0-124" class="d">-            s.set(b&quot;a&quot;, vec![0x02]).unwrap();
</a><a href="#h4-0-125" id="h4-0-125" class="d">-            assert_eq!(vec![0x02], s.get(b&quot;a&quot;).unwrap().unwrap());
</a><a href="#h4-0-126" id="h4-0-126" class="d">-        }
</a><a href="#h4-0-127" id="h4-0-127" class="d">-    }
</a><a href="#h4-0-128" id="h4-0-128" class="d">-}
</a><a href="#h4-0-129" id="h4-0-129" class="i">+pub use mvcc::{Transaction, MVCC};
</a><a href="#h4-0-130" id="h4-0-130" class="i">+pub use simple::Simple;
</a><b>diff --git a/<a id="h5" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,761 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+use super::storage::{Range, Storage};
</a><a href="#h5-0-1" id="h5-0-1" class="i">+use crate::utility::{deserialize, serialize};
</a><a href="#h5-0-2" id="h5-0-2" class="i">+use crate::Error;
</a><a href="#h5-0-3" id="h5-0-3" class="i">+
</a><a href="#h5-0-4" id="h5-0-4" class="i">+use std::collections::HashSet;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+use std::ops::{Bound, RangeBounds};
</a><a href="#h5-0-6" id="h5-0-6" class="i">+use std::sync::{Arc, RwLock, RwLockWriteGuard};
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+/// An MVCC-based transactional key-value store
</a><a href="#h5-0-9" id="h5-0-9" class="i">+pub struct MVCC&lt;S: Storage&gt; {
</a><a href="#h5-0-10" id="h5-0-10" class="i">+    storage: Arc&lt;RwLock&lt;S&gt;&gt;,
</a><a href="#h5-0-11" id="h5-0-11" class="i">+}
</a><a href="#h5-0-12" id="h5-0-12" class="i">+
</a><a href="#h5-0-13" id="h5-0-13" class="i">+impl&lt;S: Storage&gt; MVCC&lt;S&gt; {
</a><a href="#h5-0-14" id="h5-0-14" class="i">+    /// Creates a new MVCC key-value store
</a><a href="#h5-0-15" id="h5-0-15" class="i">+    pub fn new(storage: S) -&gt; Self {
</a><a href="#h5-0-16" id="h5-0-16" class="i">+        Self { storage: Arc::new(RwLock::new(storage)) }
</a><a href="#h5-0-17" id="h5-0-17" class="i">+    }
</a><a href="#h5-0-18" id="h5-0-18" class="i">+
</a><a href="#h5-0-19" id="h5-0-19" class="i">+    /// Begins a new transaction
</a><a href="#h5-0-20" id="h5-0-20" class="i">+    pub fn begin(&amp;self) -&gt; Result&lt;Transaction&lt;S&gt;, Error&gt; {
</a><a href="#h5-0-21" id="h5-0-21" class="i">+        Transaction::new(self.storage.clone())
</a><a href="#h5-0-22" id="h5-0-22" class="i">+    }
</a><a href="#h5-0-23" id="h5-0-23" class="i">+
</a><a href="#h5-0-24" id="h5-0-24" class="i">+    /// Begins a new read-only transaction, optionally at the given version
</a><a href="#h5-0-25" id="h5-0-25" class="i">+    #[allow(dead_code)]
</a><a href="#h5-0-26" id="h5-0-26" class="i">+    pub fn begin_readonly(&amp;self, version: Option&lt;u64&gt;) -&gt; Result&lt;Transaction&lt;S&gt;, Error&gt; {
</a><a href="#h5-0-27" id="h5-0-27" class="i">+        Transaction::new_readonly(self.storage.clone(), version)
</a><a href="#h5-0-28" id="h5-0-28" class="i">+    }
</a><a href="#h5-0-29" id="h5-0-29" class="i">+}
</a><a href="#h5-0-30" id="h5-0-30" class="i">+
</a><a href="#h5-0-31" id="h5-0-31" class="i">+/// An MVCC transaction
</a><a href="#h5-0-32" id="h5-0-32" class="i">+pub struct Transaction&lt;S: Storage&gt; {
</a><a href="#h5-0-33" id="h5-0-33" class="i">+    storage: Arc&lt;RwLock&lt;S&gt;&gt;,
</a><a href="#h5-0-34" id="h5-0-34" class="i">+    id: u64,
</a><a href="#h5-0-35" id="h5-0-35" class="i">+    readonly: bool,
</a><a href="#h5-0-36" id="h5-0-36" class="i">+    invisible: HashSet&lt;u64&gt;,
</a><a href="#h5-0-37" id="h5-0-37" class="i">+    updated: HashSet&lt;Vec&lt;u8&gt;&gt;,
</a><a href="#h5-0-38" id="h5-0-38" class="i">+}
</a><a href="#h5-0-39" id="h5-0-39" class="i">+
</a><a href="#h5-0-40" id="h5-0-40" class="i">+impl&lt;S: Storage&gt; Transaction&lt;S&gt; {
</a><a href="#h5-0-41" id="h5-0-41" class="i">+    /// Creates a new transaction
</a><a href="#h5-0-42" id="h5-0-42" class="i">+    fn new(storage: Arc&lt;RwLock&lt;S&gt;&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h5-0-43" id="h5-0-43" class="i">+        let mut txn = Self {
</a><a href="#h5-0-44" id="h5-0-44" class="i">+            storage,
</a><a href="#h5-0-45" id="h5-0-45" class="i">+            id: 0,
</a><a href="#h5-0-46" id="h5-0-46" class="i">+            readonly: false,
</a><a href="#h5-0-47" id="h5-0-47" class="i">+            invisible: HashSet::new(),
</a><a href="#h5-0-48" id="h5-0-48" class="i">+            updated: HashSet::new(),
</a><a href="#h5-0-49" id="h5-0-49" class="i">+        };
</a><a href="#h5-0-50" id="h5-0-50" class="i">+        {
</a><a href="#h5-0-51" id="h5-0-51" class="i">+            let mut storage = txn.storage.write()?;
</a><a href="#h5-0-52" id="h5-0-52" class="i">+            txn.id = match storage.read(&amp;Key::TxnNext.encode())? {
</a><a href="#h5-0-53" id="h5-0-53" class="i">+                Some(v) =&gt; deserialize(v)?,
</a><a href="#h5-0-54" id="h5-0-54" class="i">+                None =&gt; 0,
</a><a href="#h5-0-55" id="h5-0-55" class="i">+            };
</a><a href="#h5-0-56" id="h5-0-56" class="i">+            storage.write(&amp;Key::TxnNext.encode(), serialize(txn.id + 1)?)?;
</a><a href="#h5-0-57" id="h5-0-57" class="i">+            storage.write(&amp;Key::TxnActive(txn.id).encode(), serialize(true)?)?;
</a><a href="#h5-0-58" id="h5-0-58" class="i">+
</a><a href="#h5-0-59" id="h5-0-59" class="i">+            for r in storage.scan(&amp;Key::TxnActive(0).encode()..&amp;Key::TxnActive(txn.id).encode()) {
</a><a href="#h5-0-60" id="h5-0-60" class="i">+                let (k, _) = r?;
</a><a href="#h5-0-61" id="h5-0-61" class="i">+                match Key::decode(k)? {
</a><a href="#h5-0-62" id="h5-0-62" class="i">+                    Key::TxnActive(id) =&gt; txn.invisible.insert(id),
</a><a href="#h5-0-63" id="h5-0-63" class="i">+                    _ =&gt; return Err(Error::Value(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
</a><a href="#h5-0-64" id="h5-0-64" class="i">+                };
</a><a href="#h5-0-65" id="h5-0-65" class="i">+            }
</a><a href="#h5-0-66" id="h5-0-66" class="i">+        }
</a><a href="#h5-0-67" id="h5-0-67" class="i">+        Ok(txn)
</a><a href="#h5-0-68" id="h5-0-68" class="i">+    }
</a><a href="#h5-0-69" id="h5-0-69" class="i">+
</a><a href="#h5-0-70" id="h5-0-70" class="i">+    /// Creates a new read-only transaction at the given version
</a><a href="#h5-0-71" id="h5-0-71" class="i">+    fn new_readonly(storage: Arc&lt;RwLock&lt;S&gt;&gt;, id: Option&lt;u64&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h5-0-72" id="h5-0-72" class="i">+        let next_id = match storage.read()?.read(&amp;Key::TxnNext.encode())? {
</a><a href="#h5-0-73" id="h5-0-73" class="i">+            Some(v) =&gt; deserialize(v)?,
</a><a href="#h5-0-74" id="h5-0-74" class="i">+            None =&gt; 1,
</a><a href="#h5-0-75" id="h5-0-75" class="i">+        };
</a><a href="#h5-0-76" id="h5-0-76" class="i">+        let id = id.unwrap_or_else(|| next_id - 1);
</a><a href="#h5-0-77" id="h5-0-77" class="i">+        if id &gt;= next_id {
</a><a href="#h5-0-78" id="h5-0-78" class="i">+            return Err(Error::Value(&quot;Can&#39;t start read-only transaction in the future&quot;.into()));
</a><a href="#h5-0-79" id="h5-0-79" class="i">+        }
</a><a href="#h5-0-80" id="h5-0-80" class="i">+        let mut txn = Self {
</a><a href="#h5-0-81" id="h5-0-81" class="i">+            storage,
</a><a href="#h5-0-82" id="h5-0-82" class="i">+            id,
</a><a href="#h5-0-83" id="h5-0-83" class="i">+            readonly: true,
</a><a href="#h5-0-84" id="h5-0-84" class="i">+            invisible: HashSet::new(),
</a><a href="#h5-0-85" id="h5-0-85" class="i">+            updated: HashSet::new(),
</a><a href="#h5-0-86" id="h5-0-86" class="i">+        };
</a><a href="#h5-0-87" id="h5-0-87" class="i">+        for r in
</a><a href="#h5-0-88" id="h5-0-88" class="i">+            txn.storage.read()?.scan(&amp;Key::TxnActive(0).encode()..=&amp;Key::TxnActive(txn.id).encode())
</a><a href="#h5-0-89" id="h5-0-89" class="i">+        {
</a><a href="#h5-0-90" id="h5-0-90" class="i">+            let (k, _) = r?;
</a><a href="#h5-0-91" id="h5-0-91" class="i">+            match Key::decode(k)? {
</a><a href="#h5-0-92" id="h5-0-92" class="i">+                Key::TxnActive(id) =&gt; txn.invisible.insert(id),
</a><a href="#h5-0-93" id="h5-0-93" class="i">+                _ =&gt; return Err(Error::Value(&quot;Unexpected MVCC key, wanted TxnActive&quot;.into())),
</a><a href="#h5-0-94" id="h5-0-94" class="i">+            };
</a><a href="#h5-0-95" id="h5-0-95" class="i">+        }
</a><a href="#h5-0-96" id="h5-0-96" class="i">+        Ok(txn)
</a><a href="#h5-0-97" id="h5-0-97" class="i">+    }
</a><a href="#h5-0-98" id="h5-0-98" class="i">+
</a><a href="#h5-0-99" id="h5-0-99" class="i">+    /// Returns the transaction ID
</a><a href="#h5-0-100" id="h5-0-100" class="i">+    pub fn id(&amp;self) -&gt; u64 {
</a><a href="#h5-0-101" id="h5-0-101" class="i">+        self.id
</a><a href="#h5-0-102" id="h5-0-102" class="i">+    }
</a><a href="#h5-0-103" id="h5-0-103" class="i">+
</a><a href="#h5-0-104" id="h5-0-104" class="i">+    /// Commits the transaction
</a><a href="#h5-0-105" id="h5-0-105" class="i">+    pub fn commit(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-106" id="h5-0-106" class="i">+        if !self.readonly {
</a><a href="#h5-0-107" id="h5-0-107" class="i">+            self.storage.write()?.remove(&amp;Key::TxnActive(self.id).encode())?;
</a><a href="#h5-0-108" id="h5-0-108" class="i">+        }
</a><a href="#h5-0-109" id="h5-0-109" class="i">+        Ok(())
</a><a href="#h5-0-110" id="h5-0-110" class="i">+    }
</a><a href="#h5-0-111" id="h5-0-111" class="i">+
</a><a href="#h5-0-112" id="h5-0-112" class="i">+    /// Rolls back the transaction
</a><a href="#h5-0-113" id="h5-0-113" class="i">+    pub fn rollback(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-114" id="h5-0-114" class="i">+        if !self.readonly {
</a><a href="#h5-0-115" id="h5-0-115" class="i">+            let mut storage = self.storage.write()?;
</a><a href="#h5-0-116" id="h5-0-116" class="i">+            for key in self.updated.iter() {
</a><a href="#h5-0-117" id="h5-0-117" class="i">+                storage.remove(key)?;
</a><a href="#h5-0-118" id="h5-0-118" class="i">+            }
</a><a href="#h5-0-119" id="h5-0-119" class="i">+            storage.remove(&amp;Key::TxnActive(self.id).encode())?;
</a><a href="#h5-0-120" id="h5-0-120" class="i">+        }
</a><a href="#h5-0-121" id="h5-0-121" class="i">+        Ok(())
</a><a href="#h5-0-122" id="h5-0-122" class="i">+    }
</a><a href="#h5-0-123" id="h5-0-123" class="i">+
</a><a href="#h5-0-124" id="h5-0-124" class="i">+    /// Deletes a key
</a><a href="#h5-0-125" id="h5-0-125" class="i">+    pub fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-126" id="h5-0-126" class="i">+        self.assert_mutable()?;
</a><a href="#h5-0-127" id="h5-0-127" class="i">+        let mut storage = self.storage.write()?;
</a><a href="#h5-0-128" id="h5-0-128" class="i">+        if self.is_dirty(&amp;mut storage, key)? {
</a><a href="#h5-0-129" id="h5-0-129" class="i">+            return Err(Error::Serialization);
</a><a href="#h5-0-130" id="h5-0-130" class="i">+        }
</a><a href="#h5-0-131" id="h5-0-131" class="i">+        let key = Key::Record(key.to_vec(), self.id).encode();
</a><a href="#h5-0-132" id="h5-0-132" class="i">+        storage.write(&amp;key, Value::Delete.encode())?;
</a><a href="#h5-0-133" id="h5-0-133" class="i">+        self.updated.insert(key);
</a><a href="#h5-0-134" id="h5-0-134" class="i">+        Ok(())
</a><a href="#h5-0-135" id="h5-0-135" class="i">+    }
</a><a href="#h5-0-136" id="h5-0-136" class="i">+
</a><a href="#h5-0-137" id="h5-0-137" class="i">+    /// Fetches a key
</a><a href="#h5-0-138" id="h5-0-138" class="i">+    pub fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h5-0-139" id="h5-0-139" class="i">+        let from = Key::Record(key.to_vec(), 0).encode();
</a><a href="#h5-0-140" id="h5-0-140" class="i">+        let to = Key::Record(key.to_vec(), self.id).encode();
</a><a href="#h5-0-141" id="h5-0-141" class="i">+        let mut range = self.storage.read()?.scan(from..=to).rev();
</a><a href="#h5-0-142" id="h5-0-142" class="i">+        while let Some((k, v)) = range.next().transpose()? {
</a><a href="#h5-0-143" id="h5-0-143" class="i">+            if !self.is_visible(Key::decode(k)?.version()?)? {
</a><a href="#h5-0-144" id="h5-0-144" class="i">+                continue;
</a><a href="#h5-0-145" id="h5-0-145" class="i">+            }
</a><a href="#h5-0-146" id="h5-0-146" class="i">+            return match Value::decode(v)? {
</a><a href="#h5-0-147" id="h5-0-147" class="i">+                Value::Set(v) =&gt; Ok(Some(v)),
</a><a href="#h5-0-148" id="h5-0-148" class="i">+                Value::Delete =&gt; Ok(None),
</a><a href="#h5-0-149" id="h5-0-149" class="i">+            };
</a><a href="#h5-0-150" id="h5-0-150" class="i">+        }
</a><a href="#h5-0-151" id="h5-0-151" class="i">+        Ok(None)
</a><a href="#h5-0-152" id="h5-0-152" class="i">+    }
</a><a href="#h5-0-153" id="h5-0-153" class="i">+
</a><a href="#h5-0-154" id="h5-0-154" class="i">+    /// Scans a key range
</a><a href="#h5-0-155" id="h5-0-155" class="i">+    pub fn scan(&amp;self, range: impl RangeBounds&lt;Vec&lt;u8&gt;&gt;) -&gt; Result&lt;Range, Error&gt; {
</a><a href="#h5-0-156" id="h5-0-156" class="i">+        let from = match range.start_bound() {
</a><a href="#h5-0-157" id="h5-0-157" class="i">+            Bound::Excluded(key) =&gt; Bound::Included(Key::Record(key.clone(), 0).encode()),
</a><a href="#h5-0-158" id="h5-0-158" class="i">+            Bound::Included(key) =&gt; Bound::Included(Key::Record(key.clone(), 0).encode()),
</a><a href="#h5-0-159" id="h5-0-159" class="i">+            Bound::Unbounded =&gt; Bound::Included(Key::RecordStart.encode()),
</a><a href="#h5-0-160" id="h5-0-160" class="i">+        };
</a><a href="#h5-0-161" id="h5-0-161" class="i">+        let to = match range.end_bound() {
</a><a href="#h5-0-162" id="h5-0-162" class="i">+            Bound::Excluded(key) =&gt; Bound::Excluded(Key::Record(key.clone(), 0).encode()),
</a><a href="#h5-0-163" id="h5-0-163" class="i">+            Bound::Included(key) =&gt; {
</a><a href="#h5-0-164" id="h5-0-164" class="i">+                Bound::Included(Key::Record(key.clone(), std::u64::MAX).encode())
</a><a href="#h5-0-165" id="h5-0-165" class="i">+            }
</a><a href="#h5-0-166" id="h5-0-166" class="i">+            Bound::Unbounded =&gt; Bound::Included(Key::RecordEnd.encode()),
</a><a href="#h5-0-167" id="h5-0-167" class="i">+        };
</a><a href="#h5-0-168" id="h5-0-168" class="i">+        Ok(Box::new(Scan {
</a><a href="#h5-0-169" id="h5-0-169" class="i">+            range: self.storage.read()?.scan((from, to)),
</a><a href="#h5-0-170" id="h5-0-170" class="i">+            id: self.id,
</a><a href="#h5-0-171" id="h5-0-171" class="i">+            seen: None,
</a><a href="#h5-0-172" id="h5-0-172" class="i">+            rev_ignore: None,
</a><a href="#h5-0-173" id="h5-0-173" class="i">+            invisible: self.invisible.clone(),
</a><a href="#h5-0-174" id="h5-0-174" class="i">+        }))
</a><a href="#h5-0-175" id="h5-0-175" class="i">+    }
</a><a href="#h5-0-176" id="h5-0-176" class="i">+
</a><a href="#h5-0-177" id="h5-0-177" class="i">+    /// Sets a key
</a><a href="#h5-0-178" id="h5-0-178" class="i">+    pub fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-179" id="h5-0-179" class="i">+        self.assert_mutable()?;
</a><a href="#h5-0-180" id="h5-0-180" class="i">+        let mut storage = self.storage.write()?;
</a><a href="#h5-0-181" id="h5-0-181" class="i">+        if self.is_dirty(&amp;mut storage, key)? {
</a><a href="#h5-0-182" id="h5-0-182" class="i">+            return Err(Error::Serialization);
</a><a href="#h5-0-183" id="h5-0-183" class="i">+        }
</a><a href="#h5-0-184" id="h5-0-184" class="i">+        let key = Key::Record(key.to_vec(), self.id).encode();
</a><a href="#h5-0-185" id="h5-0-185" class="i">+        storage.write(&amp;key, Value::Set(value).encode())?;
</a><a href="#h5-0-186" id="h5-0-186" class="i">+        self.updated.insert(key);
</a><a href="#h5-0-187" id="h5-0-187" class="i">+        Ok(())
</a><a href="#h5-0-188" id="h5-0-188" class="i">+    }
</a><a href="#h5-0-189" id="h5-0-189" class="i">+
</a><a href="#h5-0-190" id="h5-0-190" class="i">+    /// Asserts that the transaction is read-write, otherwise returns an error
</a><a href="#h5-0-191" id="h5-0-191" class="i">+    fn assert_mutable(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-192" id="h5-0-192" class="i">+        if self.readonly {
</a><a href="#h5-0-193" id="h5-0-193" class="i">+            Err(Error::ReadOnly)
</a><a href="#h5-0-194" id="h5-0-194" class="i">+        } else {
</a><a href="#h5-0-195" id="h5-0-195" class="i">+            Ok(())
</a><a href="#h5-0-196" id="h5-0-196" class="i">+        }
</a><a href="#h5-0-197" id="h5-0-197" class="i">+    }
</a><a href="#h5-0-198" id="h5-0-198" class="i">+
</a><a href="#h5-0-199" id="h5-0-199" class="i">+    /// Checks whether the key is dirty, i.e. if it has any uncommitted changes
</a><a href="#h5-0-200" id="h5-0-200" class="i">+    fn is_dirty(&amp;self, storage: &amp;mut RwLockWriteGuard&lt;S&gt;, key: &amp;[u8]) -&gt; Result&lt;bool, Error&gt; {
</a><a href="#h5-0-201" id="h5-0-201" class="i">+        let mut min = self.id + 1;
</a><a href="#h5-0-202" id="h5-0-202" class="i">+        for id in self.invisible.iter().cloned() {
</a><a href="#h5-0-203" id="h5-0-203" class="i">+            if id &lt; min {
</a><a href="#h5-0-204" id="h5-0-204" class="i">+                min = id
</a><a href="#h5-0-205" id="h5-0-205" class="i">+            }
</a><a href="#h5-0-206" id="h5-0-206" class="i">+        }
</a><a href="#h5-0-207" id="h5-0-207" class="i">+        let from = Key::Record(key.to_vec(), min).encode();
</a><a href="#h5-0-208" id="h5-0-208" class="i">+        let to = Key::Record(key.to_vec(), std::u64::MAX).encode();
</a><a href="#h5-0-209" id="h5-0-209" class="i">+        let mut range = storage.scan(from..to);
</a><a href="#h5-0-210" id="h5-0-210" class="i">+        while let Some((k, _)) = range.next().transpose()? {
</a><a href="#h5-0-211" id="h5-0-211" class="i">+            if !self.is_visible(Key::decode(k)?.version()?)? {
</a><a href="#h5-0-212" id="h5-0-212" class="i">+                return Ok(true);
</a><a href="#h5-0-213" id="h5-0-213" class="i">+            }
</a><a href="#h5-0-214" id="h5-0-214" class="i">+        }
</a><a href="#h5-0-215" id="h5-0-215" class="i">+        Ok(false)
</a><a href="#h5-0-216" id="h5-0-216" class="i">+    }
</a><a href="#h5-0-217" id="h5-0-217" class="i">+
</a><a href="#h5-0-218" id="h5-0-218" class="i">+    /// Checks whether the given version is visible to us
</a><a href="#h5-0-219" id="h5-0-219" class="i">+    fn is_visible(&amp;self, version: u64) -&gt; Result&lt;bool, Error&gt; {
</a><a href="#h5-0-220" id="h5-0-220" class="i">+        Ok(version &lt;= self.id &amp;&amp; self.invisible.get(&amp;version).is_none())
</a><a href="#h5-0-221" id="h5-0-221" class="i">+    }
</a><a href="#h5-0-222" id="h5-0-222" class="i">+}
</a><a href="#h5-0-223" id="h5-0-223" class="i">+
</a><a href="#h5-0-224" id="h5-0-224" class="i">+/// A key range scan
</a><a href="#h5-0-225" id="h5-0-225" class="i">+pub struct Scan {
</a><a href="#h5-0-226" id="h5-0-226" class="i">+    range: Range,
</a><a href="#h5-0-227" id="h5-0-227" class="i">+    id: u64,
</a><a href="#h5-0-228" id="h5-0-228" class="i">+    invisible: HashSet&lt;u64&gt;,
</a><a href="#h5-0-229" id="h5-0-229" class="i">+    seen: Option&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;,
</a><a href="#h5-0-230" id="h5-0-230" class="i">+    rev_ignore: Option&lt;(Vec&lt;u8&gt;)&gt;,
</a><a href="#h5-0-231" id="h5-0-231" class="i">+}
</a><a href="#h5-0-232" id="h5-0-232" class="i">+
</a><a href="#h5-0-233" id="h5-0-233" class="i">+impl Iterator for Scan {
</a><a href="#h5-0-234" id="h5-0-234" class="i">+    type Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;), Error&gt;;
</a><a href="#h5-0-235" id="h5-0-235" class="i">+
</a><a href="#h5-0-236" id="h5-0-236" class="i">+    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
</a><a href="#h5-0-237" id="h5-0-237" class="i">+        while let Some(r) = self.range.next() {
</a><a href="#h5-0-238" id="h5-0-238" class="i">+            match r {
</a><a href="#h5-0-239" id="h5-0-239" class="i">+                Ok((k, v)) =&gt; {
</a><a href="#h5-0-240" id="h5-0-240" class="i">+                    let (key, version) = match Key::decode(k).unwrap() {
</a><a href="#h5-0-241" id="h5-0-241" class="i">+                        Key::Record(key, version) =&gt; (key, version),
</a><a href="#h5-0-242" id="h5-0-242" class="i">+                        _ =&gt; panic!(&quot;Not implemented&quot;),
</a><a href="#h5-0-243" id="h5-0-243" class="i">+                    };
</a><a href="#h5-0-244" id="h5-0-244" class="i">+                    if version &gt; self.id || self.invisible.get(&amp;version).is_some() {
</a><a href="#h5-0-245" id="h5-0-245" class="i">+                        continue;
</a><a href="#h5-0-246" id="h5-0-246" class="i">+                    }
</a><a href="#h5-0-247" id="h5-0-247" class="i">+                    let value = match Value::decode(v).unwrap() {
</a><a href="#h5-0-248" id="h5-0-248" class="i">+                        Value::Set(value) =&gt; value,
</a><a href="#h5-0-249" id="h5-0-249" class="i">+                        Value::Delete =&gt; {
</a><a href="#h5-0-250" id="h5-0-250" class="i">+                            let mut clear_seen = false;
</a><a href="#h5-0-251" id="h5-0-251" class="i">+                            if let Some((k, _)) = &amp;self.seen {
</a><a href="#h5-0-252" id="h5-0-252" class="i">+                                if k == &amp;key {
</a><a href="#h5-0-253" id="h5-0-253" class="i">+                                    clear_seen = true;
</a><a href="#h5-0-254" id="h5-0-254" class="i">+                                }
</a><a href="#h5-0-255" id="h5-0-255" class="i">+                            }
</a><a href="#h5-0-256" id="h5-0-256" class="i">+                            if clear_seen {
</a><a href="#h5-0-257" id="h5-0-257" class="i">+                                self.seen = None;
</a><a href="#h5-0-258" id="h5-0-258" class="i">+                            }
</a><a href="#h5-0-259" id="h5-0-259" class="i">+                            continue;
</a><a href="#h5-0-260" id="h5-0-260" class="i">+                        }
</a><a href="#h5-0-261" id="h5-0-261" class="i">+                    };
</a><a href="#h5-0-262" id="h5-0-262" class="i">+
</a><a href="#h5-0-263" id="h5-0-263" class="i">+                    let mut ret = None;
</a><a href="#h5-0-264" id="h5-0-264" class="i">+                    if let Some((k, v)) = &amp;self.seen {
</a><a href="#h5-0-265" id="h5-0-265" class="i">+                        if k != &amp;key {
</a><a href="#h5-0-266" id="h5-0-266" class="i">+                            ret = Some(Ok((k.clone(), v.clone())));
</a><a href="#h5-0-267" id="h5-0-267" class="i">+                        }
</a><a href="#h5-0-268" id="h5-0-268" class="i">+                    };
</a><a href="#h5-0-269" id="h5-0-269" class="i">+                    self.seen = Some((key, value));
</a><a href="#h5-0-270" id="h5-0-270" class="i">+                    if ret.is_some() {
</a><a href="#h5-0-271" id="h5-0-271" class="i">+                        return ret;
</a><a href="#h5-0-272" id="h5-0-272" class="i">+                    }
</a><a href="#h5-0-273" id="h5-0-273" class="i">+                }
</a><a href="#h5-0-274" id="h5-0-274" class="i">+                Err(err) =&gt; return Some(Err(err)),
</a><a href="#h5-0-275" id="h5-0-275" class="i">+            }
</a><a href="#h5-0-276" id="h5-0-276" class="i">+        }
</a><a href="#h5-0-277" id="h5-0-277" class="i">+        let mut pair = None;
</a><a href="#h5-0-278" id="h5-0-278" class="i">+        if let Some((k, v)) = &amp;self.seen {
</a><a href="#h5-0-279" id="h5-0-279" class="i">+            pair = Some(Ok((k.clone(), v.clone())));
</a><a href="#h5-0-280" id="h5-0-280" class="i">+        }
</a><a href="#h5-0-281" id="h5-0-281" class="i">+        self.seen = None;
</a><a href="#h5-0-282" id="h5-0-282" class="i">+        pair
</a><a href="#h5-0-283" id="h5-0-283" class="i">+    }
</a><a href="#h5-0-284" id="h5-0-284" class="i">+}
</a><a href="#h5-0-285" id="h5-0-285" class="i">+
</a><a href="#h5-0-286" id="h5-0-286" class="i">+impl DoubleEndedIterator for Scan {
</a><a href="#h5-0-287" id="h5-0-287" class="i">+    fn next_back(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
</a><a href="#h5-0-288" id="h5-0-288" class="i">+        while let Some(r) = self.range.next_back() {
</a><a href="#h5-0-289" id="h5-0-289" class="i">+            match r {
</a><a href="#h5-0-290" id="h5-0-290" class="i">+                Ok((k, v)) =&gt; {
</a><a href="#h5-0-291" id="h5-0-291" class="i">+                    let (key, version) = match Key::decode(k).unwrap() {
</a><a href="#h5-0-292" id="h5-0-292" class="i">+                        Key::Record(key, version) =&gt; (key, version),
</a><a href="#h5-0-293" id="h5-0-293" class="i">+                        _ =&gt; panic!(&quot;Not implemented&quot;),
</a><a href="#h5-0-294" id="h5-0-294" class="i">+                    };
</a><a href="#h5-0-295" id="h5-0-295" class="i">+                    if version &gt; self.id || self.invisible.get(&amp;version).is_some() {
</a><a href="#h5-0-296" id="h5-0-296" class="i">+                        continue;
</a><a href="#h5-0-297" id="h5-0-297" class="i">+                    }
</a><a href="#h5-0-298" id="h5-0-298" class="i">+                    if let Some(ignore) = &amp;self.rev_ignore {
</a><a href="#h5-0-299" id="h5-0-299" class="i">+                        if &amp;key == ignore {
</a><a href="#h5-0-300" id="h5-0-300" class="i">+                            continue;
</a><a href="#h5-0-301" id="h5-0-301" class="i">+                        }
</a><a href="#h5-0-302" id="h5-0-302" class="i">+                    }
</a><a href="#h5-0-303" id="h5-0-303" class="i">+                    self.rev_ignore = Some(key.clone());
</a><a href="#h5-0-304" id="h5-0-304" class="i">+                    let value = match Value::decode(v).unwrap() {
</a><a href="#h5-0-305" id="h5-0-305" class="i">+                        Value::Set(value) =&gt; value,
</a><a href="#h5-0-306" id="h5-0-306" class="i">+                        Value::Delete =&gt; continue,
</a><a href="#h5-0-307" id="h5-0-307" class="i">+                    };
</a><a href="#h5-0-308" id="h5-0-308" class="i">+                    return Some(Ok((key, value)));
</a><a href="#h5-0-309" id="h5-0-309" class="i">+                }
</a><a href="#h5-0-310" id="h5-0-310" class="i">+                Err(err) =&gt; return Some(Err(err)),
</a><a href="#h5-0-311" id="h5-0-311" class="i">+            }
</a><a href="#h5-0-312" id="h5-0-312" class="i">+        }
</a><a href="#h5-0-313" id="h5-0-313" class="i">+        None
</a><a href="#h5-0-314" id="h5-0-314" class="i">+    }
</a><a href="#h5-0-315" id="h5-0-315" class="i">+}
</a><a href="#h5-0-316" id="h5-0-316" class="i">+
</a><a href="#h5-0-317" id="h5-0-317" class="i">+#[derive(Debug)]
</a><a href="#h5-0-318" id="h5-0-318" class="i">+enum Key {
</a><a href="#h5-0-319" id="h5-0-319" class="i">+    TxnNext,
</a><a href="#h5-0-320" id="h5-0-320" class="i">+    TxnActive(u64),
</a><a href="#h5-0-321" id="h5-0-321" class="i">+    Record(Vec&lt;u8&gt;, u64),
</a><a href="#h5-0-322" id="h5-0-322" class="i">+    RecordStart,
</a><a href="#h5-0-323" id="h5-0-323" class="i">+    RecordEnd,
</a><a href="#h5-0-324" id="h5-0-324" class="i">+}
</a><a href="#h5-0-325" id="h5-0-325" class="i">+
</a><a href="#h5-0-326" id="h5-0-326" class="i">+impl Key {
</a><a href="#h5-0-327" id="h5-0-327" class="i">+    fn decode(key: Vec&lt;u8&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h5-0-328" id="h5-0-328" class="i">+        let mut iter = key.into_iter();
</a><a href="#h5-0-329" id="h5-0-329" class="i">+        match iter.next() {
</a><a href="#h5-0-330" id="h5-0-330" class="i">+            Some(0x01) =&gt; Ok(Key::TxnNext),
</a><a href="#h5-0-331" id="h5-0-331" class="i">+            Some(0x02) =&gt; {
</a><a href="#h5-0-332" id="h5-0-332" class="i">+                let bytes: Vec&lt;u8&gt; = iter.collect();
</a><a href="#h5-0-333" id="h5-0-333" class="i">+                if bytes.len() != 8 {
</a><a href="#h5-0-334" id="h5-0-334" class="i">+                    return Err(Error::Value(&quot;Unable to parse MVCC active transaction ID&quot;.into()));
</a><a href="#h5-0-335" id="h5-0-335" class="i">+                }
</a><a href="#h5-0-336" id="h5-0-336" class="i">+                let mut id = [0; 8];
</a><a href="#h5-0-337" id="h5-0-337" class="i">+                id.copy_from_slice(&amp;bytes[..]);
</a><a href="#h5-0-338" id="h5-0-338" class="i">+                Ok(Key::TxnActive(u64::from_be_bytes(id)))
</a><a href="#h5-0-339" id="h5-0-339" class="i">+            }
</a><a href="#h5-0-340" id="h5-0-340" class="i">+
</a><a href="#h5-0-341" id="h5-0-341" class="i">+            Some(0xf1) =&gt; {
</a><a href="#h5-0-342" id="h5-0-342" class="i">+                let mut key: Vec&lt;u8&gt; = iter.collect();
</a><a href="#h5-0-343" id="h5-0-343" class="i">+                if key.len() &lt; 9 {
</a><a href="#h5-0-344" id="h5-0-344" class="i">+                    return Err(Error::Value(&quot;Unable to parse MVCC record key&quot;.into()));
</a><a href="#h5-0-345" id="h5-0-345" class="i">+                }
</a><a href="#h5-0-346" id="h5-0-346" class="i">+                let mut v = [0; 8];
</a><a href="#h5-0-347" id="h5-0-347" class="i">+                v.copy_from_slice(&amp;key.split_off(key.len() - 8)[..]);
</a><a href="#h5-0-348" id="h5-0-348" class="i">+                assert_eq!(Some(0x00), key.pop());
</a><a href="#h5-0-349" id="h5-0-349" class="i">+                let version = u64::from_be_bytes(v);
</a><a href="#h5-0-350" id="h5-0-350" class="i">+
</a><a href="#h5-0-351" id="h5-0-351" class="i">+                Ok(Self::Record(Self::unescape(key), version))
</a><a href="#h5-0-352" id="h5-0-352" class="i">+            }
</a><a href="#h5-0-353" id="h5-0-353" class="i">+            _ =&gt; Err(Error::Value(&quot;Unable to parse MVCC key&quot;.into())),
</a><a href="#h5-0-354" id="h5-0-354" class="i">+        }
</a><a href="#h5-0-355" id="h5-0-355" class="i">+    }
</a><a href="#h5-0-356" id="h5-0-356" class="i">+
</a><a href="#h5-0-357" id="h5-0-357" class="i">+    fn encode(self) -&gt; Vec&lt;u8&gt; {
</a><a href="#h5-0-358" id="h5-0-358" class="i">+        match self {
</a><a href="#h5-0-359" id="h5-0-359" class="i">+            Self::TxnNext =&gt; vec![0x01],
</a><a href="#h5-0-360" id="h5-0-360" class="i">+            Self::TxnActive(id) =&gt; [vec![0x02], id.to_be_bytes().to_vec()].concat(),
</a><a href="#h5-0-361" id="h5-0-361" class="i">+            Self::RecordStart =&gt; vec![0xf0],
</a><a href="#h5-0-362" id="h5-0-362" class="i">+            Self::Record(key, version) =&gt; {
</a><a href="#h5-0-363" id="h5-0-363" class="i">+                // We have to use 0x00 as a key/version separator, and use 0x00 0xff as an
</a><a href="#h5-0-364" id="h5-0-364" class="i">+                // escape sequence for 0x00 in order to avoid key/version overlaps from
</a><a href="#h5-0-365" id="h5-0-365" class="i">+                // messing up the key sequence during scans. For more information, see:
</a><a href="#h5-0-366" id="h5-0-366" class="i">+                // https://activesphere.com/blog/2018/08/17/order-preserving-serialization
</a><a href="#h5-0-367" id="h5-0-367" class="i">+                [vec![0xf1], Self::escape(key), vec![0x00], version.to_be_bytes().to_vec()].concat()
</a><a href="#h5-0-368" id="h5-0-368" class="i">+            }
</a><a href="#h5-0-369" id="h5-0-369" class="i">+            Self::RecordEnd =&gt; vec![0xf2],
</a><a href="#h5-0-370" id="h5-0-370" class="i">+        }
</a><a href="#h5-0-371" id="h5-0-371" class="i">+    }
</a><a href="#h5-0-372" id="h5-0-372" class="i">+
</a><a href="#h5-0-373" id="h5-0-373" class="i">+    fn escape(bytes: Vec&lt;u8&gt;) -&gt; Vec&lt;u8&gt; {
</a><a href="#h5-0-374" id="h5-0-374" class="i">+        let mut escaped = vec![];
</a><a href="#h5-0-375" id="h5-0-375" class="i">+        for b in bytes.into_iter() {
</a><a href="#h5-0-376" id="h5-0-376" class="i">+            escaped.push(b);
</a><a href="#h5-0-377" id="h5-0-377" class="i">+            if b == 0x00 {
</a><a href="#h5-0-378" id="h5-0-378" class="i">+                escaped.push(0xff);
</a><a href="#h5-0-379" id="h5-0-379" class="i">+            }
</a><a href="#h5-0-380" id="h5-0-380" class="i">+        }
</a><a href="#h5-0-381" id="h5-0-381" class="i">+        escaped
</a><a href="#h5-0-382" id="h5-0-382" class="i">+    }
</a><a href="#h5-0-383" id="h5-0-383" class="i">+
</a><a href="#h5-0-384" id="h5-0-384" class="i">+    fn unescape(bytes: Vec&lt;u8&gt;) -&gt; Vec&lt;u8&gt; {
</a><a href="#h5-0-385" id="h5-0-385" class="i">+        let mut unescaped = vec![];
</a><a href="#h5-0-386" id="h5-0-386" class="i">+        let mut iter = bytes.into_iter();
</a><a href="#h5-0-387" id="h5-0-387" class="i">+        while let Some(b) = iter.next() {
</a><a href="#h5-0-388" id="h5-0-388" class="i">+            unescaped.push(b);
</a><a href="#h5-0-389" id="h5-0-389" class="i">+            if b == 0x00 {
</a><a href="#h5-0-390" id="h5-0-390" class="i">+                assert_eq!(Some(0xff), iter.next())
</a><a href="#h5-0-391" id="h5-0-391" class="i">+            }
</a><a href="#h5-0-392" id="h5-0-392" class="i">+        }
</a><a href="#h5-0-393" id="h5-0-393" class="i">+        unescaped
</a><a href="#h5-0-394" id="h5-0-394" class="i">+    }
</a><a href="#h5-0-395" id="h5-0-395" class="i">+
</a><a href="#h5-0-396" id="h5-0-396" class="i">+    fn version(&amp;self) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h5-0-397" id="h5-0-397" class="i">+        match self {
</a><a href="#h5-0-398" id="h5-0-398" class="i">+            Self::Record(_, version) =&gt; Ok(*version),
</a><a href="#h5-0-399" id="h5-0-399" class="i">+            _ =&gt; Err(Error::Value(format!(&quot;MVCC key {:?} has no version&quot;, self))),
</a><a href="#h5-0-400" id="h5-0-400" class="i">+        }
</a><a href="#h5-0-401" id="h5-0-401" class="i">+    }
</a><a href="#h5-0-402" id="h5-0-402" class="i">+}
</a><a href="#h5-0-403" id="h5-0-403" class="i">+
</a><a href="#h5-0-404" id="h5-0-404" class="i">+enum Value {
</a><a href="#h5-0-405" id="h5-0-405" class="i">+    Delete,
</a><a href="#h5-0-406" id="h5-0-406" class="i">+    Set(Vec&lt;u8&gt;),
</a><a href="#h5-0-407" id="h5-0-407" class="i">+}
</a><a href="#h5-0-408" id="h5-0-408" class="i">+
</a><a href="#h5-0-409" id="h5-0-409" class="i">+impl Value {
</a><a href="#h5-0-410" id="h5-0-410" class="i">+    fn decode(value: Vec&lt;u8&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h5-0-411" id="h5-0-411" class="i">+        let mut iter = value.into_iter();
</a><a href="#h5-0-412" id="h5-0-412" class="i">+        match iter.next() {
</a><a href="#h5-0-413" id="h5-0-413" class="i">+            Some(0x00) =&gt; Ok(Value::Delete),
</a><a href="#h5-0-414" id="h5-0-414" class="i">+            Some(0xff) =&gt; Ok(Value::Set(iter.collect())),
</a><a href="#h5-0-415" id="h5-0-415" class="i">+            None =&gt; Err(Error::Value(&quot;No MVCC value found&quot;.into())),
</a><a href="#h5-0-416" id="h5-0-416" class="i">+            _ =&gt; Err(Error::Value(&quot;Unable to decode invalid MVCC value&quot;.into())),
</a><a href="#h5-0-417" id="h5-0-417" class="i">+        }
</a><a href="#h5-0-418" id="h5-0-418" class="i">+    }
</a><a href="#h5-0-419" id="h5-0-419" class="i">+
</a><a href="#h5-0-420" id="h5-0-420" class="i">+    fn encode(self) -&gt; Vec&lt;u8&gt; {
</a><a href="#h5-0-421" id="h5-0-421" class="i">+        match self {
</a><a href="#h5-0-422" id="h5-0-422" class="i">+            Self::Delete =&gt; vec![0x00],
</a><a href="#h5-0-423" id="h5-0-423" class="i">+            Self::Set(value) =&gt; [vec![0xff], value].concat(),
</a><a href="#h5-0-424" id="h5-0-424" class="i">+        }
</a><a href="#h5-0-425" id="h5-0-425" class="i">+    }
</a><a href="#h5-0-426" id="h5-0-426" class="i">+}
</a><a href="#h5-0-427" id="h5-0-427" class="i">+
</a><a href="#h5-0-428" id="h5-0-428" class="i">+#[cfg(test)]
</a><a href="#h5-0-429" id="h5-0-429" class="i">+pub mod tests {
</a><a href="#h5-0-430" id="h5-0-430" class="i">+    use super::*;
</a><a href="#h5-0-431" id="h5-0-431" class="i">+
</a><a href="#h5-0-432" id="h5-0-432" class="i">+    fn setup() -&gt; MVCC&lt;super::super::storage::Memory&gt; {
</a><a href="#h5-0-433" id="h5-0-433" class="i">+        MVCC::new(super::super::storage::Memory::new())
</a><a href="#h5-0-434" id="h5-0-434" class="i">+    }
</a><a href="#h5-0-435" id="h5-0-435" class="i">+
</a><a href="#h5-0-436" id="h5-0-436" class="i">+    #[test]
</a><a href="#h5-0-437" id="h5-0-437" class="i">+    fn test_begin() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-438" id="h5-0-438" class="i">+        let mvcc = setup();
</a><a href="#h5-0-439" id="h5-0-439" class="i">+
</a><a href="#h5-0-440" id="h5-0-440" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-441" id="h5-0-441" class="i">+        assert_eq!(txn.id(), 0);
</a><a href="#h5-0-442" id="h5-0-442" class="i">+        txn.commit()?;
</a><a href="#h5-0-443" id="h5-0-443" class="i">+
</a><a href="#h5-0-444" id="h5-0-444" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-445" id="h5-0-445" class="i">+        assert_eq!(txn.id(), 1);
</a><a href="#h5-0-446" id="h5-0-446" class="i">+        txn.commit()?;
</a><a href="#h5-0-447" id="h5-0-447" class="i">+
</a><a href="#h5-0-448" id="h5-0-448" class="i">+        Ok(())
</a><a href="#h5-0-449" id="h5-0-449" class="i">+    }
</a><a href="#h5-0-450" id="h5-0-450" class="i">+
</a><a href="#h5-0-451" id="h5-0-451" class="i">+    #[test]
</a><a href="#h5-0-452" id="h5-0-452" class="i">+    fn test_begin_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-453" id="h5-0-453" class="i">+        let mvcc = setup();
</a><a href="#h5-0-454" id="h5-0-454" class="i">+
</a><a href="#h5-0-455" id="h5-0-455" class="i">+        let txn = mvcc.begin_readonly(None)?;
</a><a href="#h5-0-456" id="h5-0-456" class="i">+        assert_eq!(txn.id(), 0);
</a><a href="#h5-0-457" id="h5-0-457" class="i">+        txn.commit()?;
</a><a href="#h5-0-458" id="h5-0-458" class="i">+
</a><a href="#h5-0-459" id="h5-0-459" class="i">+        let txn = mvcc.begin_readonly(None)?;
</a><a href="#h5-0-460" id="h5-0-460" class="i">+        assert_eq!(txn.id(), 0);
</a><a href="#h5-0-461" id="h5-0-461" class="i">+        txn.commit()?;
</a><a href="#h5-0-462" id="h5-0-462" class="i">+
</a><a href="#h5-0-463" id="h5-0-463" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-464" id="h5-0-464" class="i">+        txn.commit()?;
</a><a href="#h5-0-465" id="h5-0-465" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-466" id="h5-0-466" class="i">+        txn.commit()?;
</a><a href="#h5-0-467" id="h5-0-467" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-468" id="h5-0-468" class="i">+        txn.commit()?;
</a><a href="#h5-0-469" id="h5-0-469" class="i">+
</a><a href="#h5-0-470" id="h5-0-470" class="i">+        let txn = mvcc.begin_readonly(None)?;
</a><a href="#h5-0-471" id="h5-0-471" class="i">+        assert_eq!(txn.id(), 2);
</a><a href="#h5-0-472" id="h5-0-472" class="i">+        txn.commit()?;
</a><a href="#h5-0-473" id="h5-0-473" class="i">+
</a><a href="#h5-0-474" id="h5-0-474" class="i">+        Ok(())
</a><a href="#h5-0-475" id="h5-0-475" class="i">+    }
</a><a href="#h5-0-476" id="h5-0-476" class="i">+
</a><a href="#h5-0-477" id="h5-0-477" class="i">+    #[test]
</a><a href="#h5-0-478" id="h5-0-478" class="i">+    fn test_txn_delete_conflict() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-479" id="h5-0-479" class="i">+        let mvcc = setup();
</a><a href="#h5-0-480" id="h5-0-480" class="i">+
</a><a href="#h5-0-481" id="h5-0-481" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-482" id="h5-0-482" class="i">+        txn.set(b&quot;key&quot;, vec![0x00])?;
</a><a href="#h5-0-483" id="h5-0-483" class="i">+        txn.commit()?;
</a><a href="#h5-0-484" id="h5-0-484" class="i">+
</a><a href="#h5-0-485" id="h5-0-485" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-486" id="h5-0-486" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h5-0-487" id="h5-0-487" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-488" id="h5-0-488" class="i">+
</a><a href="#h5-0-489" id="h5-0-489" class="i">+        t2.delete(b&quot;key&quot;)?;
</a><a href="#h5-0-490" id="h5-0-490" class="i">+        assert_eq!(Err(Error::Serialization), t1.delete(b&quot;key&quot;));
</a><a href="#h5-0-491" id="h5-0-491" class="i">+        assert_eq!(Err(Error::Serialization), t3.delete(b&quot;key&quot;));
</a><a href="#h5-0-492" id="h5-0-492" class="i">+        t2.commit()?;
</a><a href="#h5-0-493" id="h5-0-493" class="i">+
</a><a href="#h5-0-494" id="h5-0-494" class="i">+        Ok(())
</a><a href="#h5-0-495" id="h5-0-495" class="i">+    }
</a><a href="#h5-0-496" id="h5-0-496" class="i">+
</a><a href="#h5-0-497" id="h5-0-497" class="i">+    #[test]
</a><a href="#h5-0-498" id="h5-0-498" class="i">+    fn test_txn_delete_idempotent() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-499" id="h5-0-499" class="i">+        let mvcc = setup();
</a><a href="#h5-0-500" id="h5-0-500" class="i">+
</a><a href="#h5-0-501" id="h5-0-501" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-502" id="h5-0-502" class="i">+        txn.delete(b&quot;key&quot;)?;
</a><a href="#h5-0-503" id="h5-0-503" class="i">+        txn.commit()?;
</a><a href="#h5-0-504" id="h5-0-504" class="i">+
</a><a href="#h5-0-505" id="h5-0-505" class="i">+        Ok(())
</a><a href="#h5-0-506" id="h5-0-506" class="i">+    }
</a><a href="#h5-0-507" id="h5-0-507" class="i">+
</a><a href="#h5-0-508" id="h5-0-508" class="i">+    #[test]
</a><a href="#h5-0-509" id="h5-0-509" class="i">+    fn test_txn_get() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-510" id="h5-0-510" class="i">+        let mvcc = setup();
</a><a href="#h5-0-511" id="h5-0-511" class="i">+
</a><a href="#h5-0-512" id="h5-0-512" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-513" id="h5-0-513" class="i">+        assert_eq!(None, txn.get(b&quot;a&quot;)?);
</a><a href="#h5-0-514" id="h5-0-514" class="i">+        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-515" id="h5-0-515" class="i">+        assert_eq!(Some(vec![0x01]), txn.get(b&quot;a&quot;)?);
</a><a href="#h5-0-516" id="h5-0-516" class="i">+        txn.set(b&quot;a&quot;, vec![0x02])?;
</a><a href="#h5-0-517" id="h5-0-517" class="i">+        assert_eq!(Some(vec![0x02]), txn.get(b&quot;a&quot;)?);
</a><a href="#h5-0-518" id="h5-0-518" class="i">+        txn.commit()?;
</a><a href="#h5-0-519" id="h5-0-519" class="i">+
</a><a href="#h5-0-520" id="h5-0-520" class="i">+        Ok(())
</a><a href="#h5-0-521" id="h5-0-521" class="i">+    }
</a><a href="#h5-0-522" id="h5-0-522" class="i">+
</a><a href="#h5-0-523" id="h5-0-523" class="i">+    #[test]
</a><a href="#h5-0-524" id="h5-0-524" class="i">+    fn test_txn_get_deleted() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-525" id="h5-0-525" class="i">+        let mvcc = setup();
</a><a href="#h5-0-526" id="h5-0-526" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-527" id="h5-0-527" class="i">+        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-528" id="h5-0-528" class="i">+        txn.commit()?;
</a><a href="#h5-0-529" id="h5-0-529" class="i">+
</a><a href="#h5-0-530" id="h5-0-530" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-531" id="h5-0-531" class="i">+        txn.delete(b&quot;a&quot;)?;
</a><a href="#h5-0-532" id="h5-0-532" class="i">+        txn.commit()?;
</a><a href="#h5-0-533" id="h5-0-533" class="i">+
</a><a href="#h5-0-534" id="h5-0-534" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-535" id="h5-0-535" class="i">+        assert_eq!(None, txn.get(b&quot;a&quot;)?);
</a><a href="#h5-0-536" id="h5-0-536" class="i">+        txn.commit()?;
</a><a href="#h5-0-537" id="h5-0-537" class="i">+
</a><a href="#h5-0-538" id="h5-0-538" class="i">+        Ok(())
</a><a href="#h5-0-539" id="h5-0-539" class="i">+    }
</a><a href="#h5-0-540" id="h5-0-540" class="i">+
</a><a href="#h5-0-541" id="h5-0-541" class="i">+    #[test]
</a><a href="#h5-0-542" id="h5-0-542" class="i">+    fn test_txn_get_hides_newer() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-543" id="h5-0-543" class="i">+        let mvcc = setup();
</a><a href="#h5-0-544" id="h5-0-544" class="i">+
</a><a href="#h5-0-545" id="h5-0-545" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-546" id="h5-0-546" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h5-0-547" id="h5-0-547" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-548" id="h5-0-548" class="i">+
</a><a href="#h5-0-549" id="h5-0-549" class="i">+        t1.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-550" id="h5-0-550" class="i">+        t1.commit()?;
</a><a href="#h5-0-551" id="h5-0-551" class="i">+        t3.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h5-0-552" id="h5-0-552" class="i">+        t3.commit()?;
</a><a href="#h5-0-553" id="h5-0-553" class="i">+
</a><a href="#h5-0-554" id="h5-0-554" class="i">+        assert_eq!(None, t2.get(b&quot;a&quot;)?);
</a><a href="#h5-0-555" id="h5-0-555" class="i">+        assert_eq!(None, t2.get(b&quot;c&quot;)?);
</a><a href="#h5-0-556" id="h5-0-556" class="i">+
</a><a href="#h5-0-557" id="h5-0-557" class="i">+        Ok(())
</a><a href="#h5-0-558" id="h5-0-558" class="i">+    }
</a><a href="#h5-0-559" id="h5-0-559" class="i">+
</a><a href="#h5-0-560" id="h5-0-560" class="i">+    #[test]
</a><a href="#h5-0-561" id="h5-0-561" class="i">+    fn test_txn_get_hides_uncommitted() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-562" id="h5-0-562" class="i">+        let mvcc = setup();
</a><a href="#h5-0-563" id="h5-0-563" class="i">+
</a><a href="#h5-0-564" id="h5-0-564" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-565" id="h5-0-565" class="i">+        t1.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-566" id="h5-0-566" class="i">+        let t2 = mvcc.begin()?;
</a><a href="#h5-0-567" id="h5-0-567" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-568" id="h5-0-568" class="i">+        t3.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h5-0-569" id="h5-0-569" class="i">+
</a><a href="#h5-0-570" id="h5-0-570" class="i">+        assert_eq!(None, t2.get(b&quot;a&quot;)?);
</a><a href="#h5-0-571" id="h5-0-571" class="i">+        assert_eq!(None, t2.get(b&quot;c&quot;)?);
</a><a href="#h5-0-572" id="h5-0-572" class="i">+
</a><a href="#h5-0-573" id="h5-0-573" class="i">+        Ok(())
</a><a href="#h5-0-574" id="h5-0-574" class="i">+    }
</a><a href="#h5-0-575" id="h5-0-575" class="i">+
</a><a href="#h5-0-576" id="h5-0-576" class="i">+    #[test]
</a><a href="#h5-0-577" id="h5-0-577" class="i">+    fn test_txn_get_readonly_hides_uncomitted() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-578" id="h5-0-578" class="i">+        let mvcc = setup();
</a><a href="#h5-0-579" id="h5-0-579" class="i">+
</a><a href="#h5-0-580" id="h5-0-580" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-581" id="h5-0-581" class="i">+        t1.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-582" id="h5-0-582" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h5-0-583" id="h5-0-583" class="i">+        t2.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h5-0-584" id="h5-0-584" class="i">+
</a><a href="#h5-0-585" id="h5-0-585" class="i">+        let tr = mvcc.begin_readonly(None)?;
</a><a href="#h5-0-586" id="h5-0-586" class="i">+        assert_eq!(None, tr.get(b&quot;a&quot;)?);
</a><a href="#h5-0-587" id="h5-0-587" class="i">+        assert_eq!(None, tr.get(b&quot;c&quot;)?);
</a><a href="#h5-0-588" id="h5-0-588" class="i">+
</a><a href="#h5-0-589" id="h5-0-589" class="i">+        Ok(())
</a><a href="#h5-0-590" id="h5-0-590" class="i">+    }
</a><a href="#h5-0-591" id="h5-0-591" class="i">+
</a><a href="#h5-0-592" id="h5-0-592" class="i">+    #[test]
</a><a href="#h5-0-593" id="h5-0-593" class="i">+    fn test_txn_get_readonly_historical() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-594" id="h5-0-594" class="i">+        let mvcc = setup();
</a><a href="#h5-0-595" id="h5-0-595" class="i">+
</a><a href="#h5-0-596" id="h5-0-596" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-597" id="h5-0-597" class="i">+        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-598" id="h5-0-598" class="i">+        txn.commit()?;
</a><a href="#h5-0-599" id="h5-0-599" class="i">+
</a><a href="#h5-0-600" id="h5-0-600" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-601" id="h5-0-601" class="i">+        txn.set(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h5-0-602" id="h5-0-602" class="i">+        txn.commit()?;
</a><a href="#h5-0-603" id="h5-0-603" class="i">+
</a><a href="#h5-0-604" id="h5-0-604" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-605" id="h5-0-605" class="i">+        txn.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h5-0-606" id="h5-0-606" class="i">+        txn.commit()?;
</a><a href="#h5-0-607" id="h5-0-607" class="i">+
</a><a href="#h5-0-608" id="h5-0-608" class="i">+        let tr = mvcc.begin_readonly(Some(1))?;
</a><a href="#h5-0-609" id="h5-0-609" class="i">+        assert_eq!(Some(vec![0x01]), tr.get(b&quot;a&quot;)?);
</a><a href="#h5-0-610" id="h5-0-610" class="i">+        assert_eq!(Some(vec![0x02]), tr.get(b&quot;b&quot;)?);
</a><a href="#h5-0-611" id="h5-0-611" class="i">+        assert_eq!(None, tr.get(b&quot;c&quot;)?);
</a><a href="#h5-0-612" id="h5-0-612" class="i">+
</a><a href="#h5-0-613" id="h5-0-613" class="i">+        Ok(())
</a><a href="#h5-0-614" id="h5-0-614" class="i">+    }
</a><a href="#h5-0-615" id="h5-0-615" class="i">+
</a><a href="#h5-0-616" id="h5-0-616" class="i">+    #[test]
</a><a href="#h5-0-617" id="h5-0-617" class="i">+    fn test_txn_get_serial() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-618" id="h5-0-618" class="i">+        let mvcc = setup();
</a><a href="#h5-0-619" id="h5-0-619" class="i">+
</a><a href="#h5-0-620" id="h5-0-620" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-621" id="h5-0-621" class="i">+        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-622" id="h5-0-622" class="i">+        txn.commit()?;
</a><a href="#h5-0-623" id="h5-0-623" class="i">+
</a><a href="#h5-0-624" id="h5-0-624" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-625" id="h5-0-625" class="i">+        assert_eq!(Some(vec![0x01]), txn.get(b&quot;a&quot;)?);
</a><a href="#h5-0-626" id="h5-0-626" class="i">+
</a><a href="#h5-0-627" id="h5-0-627" class="i">+        Ok(())
</a><a href="#h5-0-628" id="h5-0-628" class="i">+    }
</a><a href="#h5-0-629" id="h5-0-629" class="i">+
</a><a href="#h5-0-630" id="h5-0-630" class="i">+    #[test]
</a><a href="#h5-0-631" id="h5-0-631" class="i">+    fn test_txn_scan() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-632" id="h5-0-632" class="i">+        let mvcc = setup();
</a><a href="#h5-0-633" id="h5-0-633" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-634" id="h5-0-634" class="i">+
</a><a href="#h5-0-635" id="h5-0-635" class="i">+        txn.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h5-0-636" id="h5-0-636" class="i">+
</a><a href="#h5-0-637" id="h5-0-637" class="i">+        txn.delete(b&quot;b&quot;)?;
</a><a href="#h5-0-638" id="h5-0-638" class="i">+
</a><a href="#h5-0-639" id="h5-0-639" class="i">+        txn.set(b&quot;c&quot;, vec![0x01])?;
</a><a href="#h5-0-640" id="h5-0-640" class="i">+        txn.set(b&quot;c&quot;, vec![0x02])?;
</a><a href="#h5-0-641" id="h5-0-641" class="i">+        txn.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h5-0-642" id="h5-0-642" class="i">+
</a><a href="#h5-0-643" id="h5-0-643" class="i">+        txn.set(b&quot;d&quot;, vec![0x01])?;
</a><a href="#h5-0-644" id="h5-0-644" class="i">+        txn.set(b&quot;d&quot;, vec![0x02])?;
</a><a href="#h5-0-645" id="h5-0-645" class="i">+        txn.set(b&quot;d&quot;, vec![0x03])?;
</a><a href="#h5-0-646" id="h5-0-646" class="i">+        txn.set(b&quot;d&quot;, vec![0x04])?;
</a><a href="#h5-0-647" id="h5-0-647" class="i">+        txn.delete(b&quot;d&quot;)?;
</a><a href="#h5-0-648" id="h5-0-648" class="i">+
</a><a href="#h5-0-649" id="h5-0-649" class="i">+        txn.set(b&quot;e&quot;, vec![0x01])?;
</a><a href="#h5-0-650" id="h5-0-650" class="i">+        txn.set(b&quot;e&quot;, vec![0x02])?;
</a><a href="#h5-0-651" id="h5-0-651" class="i">+        txn.set(b&quot;e&quot;, vec![0x03])?;
</a><a href="#h5-0-652" id="h5-0-652" class="i">+        txn.set(b&quot;e&quot;, vec![0x04])?;
</a><a href="#h5-0-653" id="h5-0-653" class="i">+        txn.delete(b&quot;e&quot;)?;
</a><a href="#h5-0-654" id="h5-0-654" class="i">+        txn.set(b&quot;e&quot;, vec![0x05])?;
</a><a href="#h5-0-655" id="h5-0-655" class="i">+        txn.commit()?;
</a><a href="#h5-0-656" id="h5-0-656" class="i">+
</a><a href="#h5-0-657" id="h5-0-657" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-658" id="h5-0-658" class="i">+        assert_eq!(
</a><a href="#h5-0-659" id="h5-0-659" class="i">+            vec![
</a><a href="#h5-0-660" id="h5-0-660" class="i">+                (b&quot;a&quot;.to_vec(), vec![0x01]),
</a><a href="#h5-0-661" id="h5-0-661" class="i">+                (b&quot;c&quot;.to_vec(), vec![0x03]),
</a><a href="#h5-0-662" id="h5-0-662" class="i">+                (b&quot;e&quot;.to_vec(), vec![0x05]),
</a><a href="#h5-0-663" id="h5-0-663" class="i">+            ],
</a><a href="#h5-0-664" id="h5-0-664" class="i">+            txn.scan(..)?.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?
</a><a href="#h5-0-665" id="h5-0-665" class="i">+        );
</a><a href="#h5-0-666" id="h5-0-666" class="i">+
</a><a href="#h5-0-667" id="h5-0-667" class="i">+        assert_eq!(
</a><a href="#h5-0-668" id="h5-0-668" class="i">+            vec![
</a><a href="#h5-0-669" id="h5-0-669" class="i">+                (b&quot;e&quot;.to_vec(), vec![0x05]),
</a><a href="#h5-0-670" id="h5-0-670" class="i">+                (b&quot;c&quot;.to_vec(), vec![0x03]),
</a><a href="#h5-0-671" id="h5-0-671" class="i">+                (b&quot;a&quot;.to_vec(), vec![0x01]),
</a><a href="#h5-0-672" id="h5-0-672" class="i">+            ],
</a><a href="#h5-0-673" id="h5-0-673" class="i">+            txn.scan(..)?.rev().collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?
</a><a href="#h5-0-674" id="h5-0-674" class="i">+        );
</a><a href="#h5-0-675" id="h5-0-675" class="i">+        txn.commit()?;
</a><a href="#h5-0-676" id="h5-0-676" class="i">+
</a><a href="#h5-0-677" id="h5-0-677" class="i">+        Ok(())
</a><a href="#h5-0-678" id="h5-0-678" class="i">+    }
</a><a href="#h5-0-679" id="h5-0-679" class="i">+
</a><a href="#h5-0-680" id="h5-0-680" class="i">+    #[test]
</a><a href="#h5-0-681" id="h5-0-681" class="i">+    fn test_txn_scan_key_version_overlap() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-682" id="h5-0-682" class="i">+        // The idea here is that with a naive key/version concatenation
</a><a href="#h5-0-683" id="h5-0-683" class="i">+        // we get overlapping entries that mess up scans. For example:
</a><a href="#h5-0-684" id="h5-0-684" class="i">+        //
</a><a href="#h5-0-685" id="h5-0-685" class="i">+        // 00|00 00 00 00 00 00 00 01
</a><a href="#h5-0-686" id="h5-0-686" class="i">+        // 00 00 00 00 00 00 00 00 02|00 00 00 00 00 00 00 02
</a><a href="#h5-0-687" id="h5-0-687" class="i">+        // 00|00 00 00 00 00 00 00 03
</a><a href="#h5-0-688" id="h5-0-688" class="i">+        //
</a><a href="#h5-0-689" id="h5-0-689" class="i">+        // The key encoding should be resistant to this.
</a><a href="#h5-0-690" id="h5-0-690" class="i">+        let mvcc = setup();
</a><a href="#h5-0-691" id="h5-0-691" class="i">+
</a><a href="#h5-0-692" id="h5-0-692" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-693" id="h5-0-693" class="i">+        txn.set(&amp;vec![0], vec![0])?; // v0
</a><a href="#h5-0-694" id="h5-0-694" class="i">+        txn.set(&amp;vec![0], vec![1])?; // v1
</a><a href="#h5-0-695" id="h5-0-695" class="i">+        txn.set(&amp;vec![0, 0, 0, 0, 0, 0, 0, 0, 2], vec![2])?; // v2
</a><a href="#h5-0-696" id="h5-0-696" class="i">+        txn.set(&amp;vec![0], vec![3])?; // v3
</a><a href="#h5-0-697" id="h5-0-697" class="i">+        txn.commit()?;
</a><a href="#h5-0-698" id="h5-0-698" class="i">+
</a><a href="#h5-0-699" id="h5-0-699" class="i">+        let txn = mvcc.begin()?;
</a><a href="#h5-0-700" id="h5-0-700" class="i">+        assert_eq!(
</a><a href="#h5-0-701" id="h5-0-701" class="i">+            vec![(vec![0].to_vec(), vec![3]), (vec![0, 0, 0, 0, 0, 0, 0, 0, 2].to_vec(), vec![2]),],
</a><a href="#h5-0-702" id="h5-0-702" class="i">+            txn.scan(..)?.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?
</a><a href="#h5-0-703" id="h5-0-703" class="i">+        );
</a><a href="#h5-0-704" id="h5-0-704" class="i">+        Ok(())
</a><a href="#h5-0-705" id="h5-0-705" class="i">+    }
</a><a href="#h5-0-706" id="h5-0-706" class="i">+
</a><a href="#h5-0-707" id="h5-0-707" class="i">+    #[test]
</a><a href="#h5-0-708" id="h5-0-708" class="i">+    fn test_txn_set_conflict() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-709" id="h5-0-709" class="i">+        let mvcc = setup();
</a><a href="#h5-0-710" id="h5-0-710" class="i">+
</a><a href="#h5-0-711" id="h5-0-711" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-712" id="h5-0-712" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h5-0-713" id="h5-0-713" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-714" id="h5-0-714" class="i">+
</a><a href="#h5-0-715" id="h5-0-715" class="i">+        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h5-0-716" id="h5-0-716" class="i">+        assert_eq!(Err(Error::Serialization), t1.set(b&quot;key&quot;, vec![0x01]));
</a><a href="#h5-0-717" id="h5-0-717" class="i">+        assert_eq!(Err(Error::Serialization), t3.set(b&quot;key&quot;, vec![0x03]));
</a><a href="#h5-0-718" id="h5-0-718" class="i">+        t2.commit()?;
</a><a href="#h5-0-719" id="h5-0-719" class="i">+
</a><a href="#h5-0-720" id="h5-0-720" class="i">+        Ok(())
</a><a href="#h5-0-721" id="h5-0-721" class="i">+    }
</a><a href="#h5-0-722" id="h5-0-722" class="i">+
</a><a href="#h5-0-723" id="h5-0-723" class="i">+    #[test]
</a><a href="#h5-0-724" id="h5-0-724" class="i">+    fn test_txn_set_conflict_committed() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-725" id="h5-0-725" class="i">+        let mvcc = setup();
</a><a href="#h5-0-726" id="h5-0-726" class="i">+
</a><a href="#h5-0-727" id="h5-0-727" class="i">+        let mut t1 = mvcc.begin()?;
</a><a href="#h5-0-728" id="h5-0-728" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h5-0-729" id="h5-0-729" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-730" id="h5-0-730" class="i">+
</a><a href="#h5-0-731" id="h5-0-731" class="i">+        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h5-0-732" id="h5-0-732" class="i">+        t2.commit()?;
</a><a href="#h5-0-733" id="h5-0-733" class="i">+        assert_eq!(Err(Error::Serialization), t1.set(b&quot;key&quot;, vec![0x01]));
</a><a href="#h5-0-734" id="h5-0-734" class="i">+        assert_eq!(Err(Error::Serialization), t3.set(b&quot;key&quot;, vec![0x03]));
</a><a href="#h5-0-735" id="h5-0-735" class="i">+
</a><a href="#h5-0-736" id="h5-0-736" class="i">+        Ok(())
</a><a href="#h5-0-737" id="h5-0-737" class="i">+    }
</a><a href="#h5-0-738" id="h5-0-738" class="i">+
</a><a href="#h5-0-739" id="h5-0-739" class="i">+    #[test]
</a><a href="#h5-0-740" id="h5-0-740" class="i">+    fn test_txn_set_rollback() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h5-0-741" id="h5-0-741" class="i">+        let mvcc = setup();
</a><a href="#h5-0-742" id="h5-0-742" class="i">+
</a><a href="#h5-0-743" id="h5-0-743" class="i">+        let mut txn = mvcc.begin()?;
</a><a href="#h5-0-744" id="h5-0-744" class="i">+        txn.set(b&quot;key&quot;, vec![0x00])?;
</a><a href="#h5-0-745" id="h5-0-745" class="i">+        txn.commit()?;
</a><a href="#h5-0-746" id="h5-0-746" class="i">+
</a><a href="#h5-0-747" id="h5-0-747" class="i">+        let t1 = mvcc.begin()?;
</a><a href="#h5-0-748" id="h5-0-748" class="i">+        let mut t2 = mvcc.begin()?;
</a><a href="#h5-0-749" id="h5-0-749" class="i">+        let mut t3 = mvcc.begin()?;
</a><a href="#h5-0-750" id="h5-0-750" class="i">+
</a><a href="#h5-0-751" id="h5-0-751" class="i">+        t2.set(b&quot;key&quot;, vec![0x02])?;
</a><a href="#h5-0-752" id="h5-0-752" class="i">+        t2.rollback()?;
</a><a href="#h5-0-753" id="h5-0-753" class="i">+        assert_eq!(Some(vec![0x00]), t1.get(b&quot;key&quot;)?);
</a><a href="#h5-0-754" id="h5-0-754" class="i">+        t1.commit()?;
</a><a href="#h5-0-755" id="h5-0-755" class="i">+        t3.set(b&quot;key&quot;, vec![0x03])?;
</a><a href="#h5-0-756" id="h5-0-756" class="i">+        t3.commit()?;
</a><a href="#h5-0-757" id="h5-0-757" class="i">+
</a><a href="#h5-0-758" id="h5-0-758" class="i">+        Ok(())
</a><a href="#h5-0-759" id="h5-0-759" class="i">+    }
</a><a href="#h5-0-760" id="h5-0-760" class="i">+}
</a><b>diff --git a/<a id="h6" href="../file/src/kv/raft.rs.html">src/kv/raft.rs</a> b/<a href="../file/src/kv/raft.rs.html">src/kv/raft.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,121 +0,0 @@
</a><a href="#h6-0-0" id="h6-0-0" class="d">-use super::{Iter, Range, Store};
</a><a href="#h6-0-1" id="h6-0-1" class="d">-use crate::raft;
</a><a href="#h6-0-2" id="h6-0-2" class="d">-use crate::utility::{deserialize, serialize};
</a><a href="#h6-0-3" id="h6-0-3" class="d">-use crate::Error;
</a><a href="#h6-0-4" id="h6-0-4" class="d">-
</a><a href="#h6-0-5" id="h6-0-5" class="d">-/// A Raft-backed key-value store. The underlying Raft state machine must be
</a><a href="#h6-0-6" id="h6-0-6" class="d">-/// generated from Raft::new_state().
</a><a href="#h6-0-7" id="h6-0-7" class="d">-pub struct Raft {
</a><a href="#h6-0-8" id="h6-0-8" class="d">-    raft: raft::Raft,
</a><a href="#h6-0-9" id="h6-0-9" class="d">-}
</a><a href="#h6-0-10" id="h6-0-10" class="d">-
</a><a href="#h6-0-11" id="h6-0-11" class="d">-impl std::fmt::Debug for Raft {
</a><a href="#h6-0-12" id="h6-0-12" class="d">-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h6-0-13" id="h6-0-13" class="d">-        write!(f, &quot;Raft&quot;)
</a><a href="#h6-0-14" id="h6-0-14" class="d">-    }
</a><a href="#h6-0-15" id="h6-0-15" class="d">-}
</a><a href="#h6-0-16" id="h6-0-16" class="d">-
</a><a href="#h6-0-17" id="h6-0-17" class="d">-impl Raft {
</a><a href="#h6-0-18" id="h6-0-18" class="d">-    /// Creates a new key-value store around a Raft cluster.
</a><a href="#h6-0-19" id="h6-0-19" class="d">-    pub fn new(raft: raft::Raft) -&gt; Self {
</a><a href="#h6-0-20" id="h6-0-20" class="d">-        Self { raft }
</a><a href="#h6-0-21" id="h6-0-21" class="d">-    }
</a><a href="#h6-0-22" id="h6-0-22" class="d">-
</a><a href="#h6-0-23" id="h6-0-23" class="d">-    /// Creates an underlying Raft state machine, which is itself a key-value store.
</a><a href="#h6-0-24" id="h6-0-24" class="d">-    pub fn new_state&lt;S: Store&gt;(store: S) -&gt; State {
</a><a href="#h6-0-25" id="h6-0-25" class="d">-        State::new(store)
</a><a href="#h6-0-26" id="h6-0-26" class="d">-    }
</a><a href="#h6-0-27" id="h6-0-27" class="d">-}
</a><a href="#h6-0-28" id="h6-0-28" class="d">-
</a><a href="#h6-0-29" id="h6-0-29" class="d">-impl Store for Raft {
</a><a href="#h6-0-30" id="h6-0-30" class="d">-    fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h6-0-31" id="h6-0-31" class="d">-        self.raft.mutate(serialize(Mutation::Delete(key.to_vec()))?)?;
</a><a href="#h6-0-32" id="h6-0-32" class="d">-        Ok(())
</a><a href="#h6-0-33" id="h6-0-33" class="d">-    }
</a><a href="#h6-0-34" id="h6-0-34" class="d">-
</a><a href="#h6-0-35" id="h6-0-35" class="d">-    fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h6-0-36" id="h6-0-36" class="d">-        Ok(deserialize(self.raft.read(serialize(Read::Get(key.to_vec()))?)?)?)
</a><a href="#h6-0-37" id="h6-0-37" class="d">-    }
</a><a href="#h6-0-38" id="h6-0-38" class="d">-
</a><a href="#h6-0-39" id="h6-0-39" class="d">-    fn iter_prefix(&amp;self, prefix: &amp;[u8]) -&gt; Box&lt;Range&gt; {
</a><a href="#h6-0-40" id="h6-0-40" class="d">-        let items: Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt; = deserialize(
</a><a href="#h6-0-41" id="h6-0-41" class="d">-            self.raft.read(serialize(Read::GetPrefix(prefix.to_vec())).unwrap()).unwrap(),
</a><a href="#h6-0-42" id="h6-0-42" class="d">-        )
</a><a href="#h6-0-43" id="h6-0-43" class="d">-        .unwrap();
</a><a href="#h6-0-44" id="h6-0-44" class="d">-        Box::new(Iter::from_vec(items))
</a><a href="#h6-0-45" id="h6-0-45" class="d">-    }
</a><a href="#h6-0-46" id="h6-0-46" class="d">-
</a><a href="#h6-0-47" id="h6-0-47" class="d">-    fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h6-0-48" id="h6-0-48" class="d">-        self.raft.mutate(serialize(Mutation::Set(key.to_vec(), value))?)?;
</a><a href="#h6-0-49" id="h6-0-49" class="d">-        Ok(())
</a><a href="#h6-0-50" id="h6-0-50" class="d">-    }
</a><a href="#h6-0-51" id="h6-0-51" class="d">-}
</a><a href="#h6-0-52" id="h6-0-52" class="d">-
</a><a href="#h6-0-53" id="h6-0-53" class="d">-/// A state machine mutation
</a><a href="#h6-0-54" id="h6-0-54" class="d">-#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h6-0-55" id="h6-0-55" class="d">-enum Mutation {
</a><a href="#h6-0-56" id="h6-0-56" class="d">-    /// Deletes a key
</a><a href="#h6-0-57" id="h6-0-57" class="d">-    Delete(Vec&lt;u8&gt;),
</a><a href="#h6-0-58" id="h6-0-58" class="d">-    /// Sets a key to a value
</a><a href="#h6-0-59" id="h6-0-59" class="d">-    Set(Vec&lt;u8&gt;, Vec&lt;u8&gt;),
</a><a href="#h6-0-60" id="h6-0-60" class="d">-}
</a><a href="#h6-0-61" id="h6-0-61" class="d">-
</a><a href="#h6-0-62" id="h6-0-62" class="d">-/// A state machine read
</a><a href="#h6-0-63" id="h6-0-63" class="d">-#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h6-0-64" id="h6-0-64" class="d">-enum Read {
</a><a href="#h6-0-65" id="h6-0-65" class="d">-    /// Fetches a key
</a><a href="#h6-0-66" id="h6-0-66" class="d">-    Get(Vec&lt;u8&gt;),
</a><a href="#h6-0-67" id="h6-0-67" class="d">-    /// Fetches an array of pairs under a key prefix
</a><a href="#h6-0-68" id="h6-0-68" class="d">-    GetPrefix(Vec&lt;u8&gt;),
</a><a href="#h6-0-69" id="h6-0-69" class="d">-}
</a><a href="#h6-0-70" id="h6-0-70" class="d">-
</a><a href="#h6-0-71" id="h6-0-71" class="d">-/// The underlying state machine for the store
</a><a href="#h6-0-72" id="h6-0-72" class="d">-pub struct State {
</a><a href="#h6-0-73" id="h6-0-73" class="d">-    store: Box&lt;dyn Store&gt;,
</a><a href="#h6-0-74" id="h6-0-74" class="d">-}
</a><a href="#h6-0-75" id="h6-0-75" class="d">-
</a><a href="#h6-0-76" id="h6-0-76" class="d">-impl std::fmt::Debug for State {
</a><a href="#h6-0-77" id="h6-0-77" class="d">-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h6-0-78" id="h6-0-78" class="d">-        write!(f, &quot;State&quot;)
</a><a href="#h6-0-79" id="h6-0-79" class="d">-    }
</a><a href="#h6-0-80" id="h6-0-80" class="d">-}
</a><a href="#h6-0-81" id="h6-0-81" class="d">-
</a><a href="#h6-0-82" id="h6-0-82" class="d">-impl State {
</a><a href="#h6-0-83" id="h6-0-83" class="d">-    pub fn new&lt;S: Store&gt;(store: S) -&gt; Self {
</a><a href="#h6-0-84" id="h6-0-84" class="d">-        State { store: Box::new(store) }
</a><a href="#h6-0-85" id="h6-0-85" class="d">-    }
</a><a href="#h6-0-86" id="h6-0-86" class="d">-}
</a><a href="#h6-0-87" id="h6-0-87" class="d">-
</a><a href="#h6-0-88" id="h6-0-88" class="d">-impl raft::State for State {
</a><a href="#h6-0-89" id="h6-0-89" class="d">-    fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h6-0-90" id="h6-0-90" class="d">-        let mutation: Mutation = deserialize(command)?;
</a><a href="#h6-0-91" id="h6-0-91" class="d">-        match mutation {
</a><a href="#h6-0-92" id="h6-0-92" class="d">-            Mutation::Delete(key) =&gt; {
</a><a href="#h6-0-93" id="h6-0-93" class="d">-                info!(&quot;Deleting {:?}&quot;, key);
</a><a href="#h6-0-94" id="h6-0-94" class="d">-                self.store.delete(&amp;key)?;
</a><a href="#h6-0-95" id="h6-0-95" class="d">-                Ok(vec![])
</a><a href="#h6-0-96" id="h6-0-96" class="d">-            }
</a><a href="#h6-0-97" id="h6-0-97" class="d">-            Mutation::Set(key, value) =&gt; {
</a><a href="#h6-0-98" id="h6-0-98" class="d">-                info!(&quot;Setting {:?} to {:?}&quot;, key, value);
</a><a href="#h6-0-99" id="h6-0-99" class="d">-                self.store.set(&amp;key, value)?;
</a><a href="#h6-0-100" id="h6-0-100" class="d">-                Ok(vec![])
</a><a href="#h6-0-101" id="h6-0-101" class="d">-            }
</a><a href="#h6-0-102" id="h6-0-102" class="d">-        }
</a><a href="#h6-0-103" id="h6-0-103" class="d">-    }
</a><a href="#h6-0-104" id="h6-0-104" class="d">-
</a><a href="#h6-0-105" id="h6-0-105" class="d">-    fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h6-0-106" id="h6-0-106" class="d">-        let read: Read = deserialize(command)?;
</a><a href="#h6-0-107" id="h6-0-107" class="d">-        match read {
</a><a href="#h6-0-108" id="h6-0-108" class="d">-            Read::Get(key) =&gt; {
</a><a href="#h6-0-109" id="h6-0-109" class="d">-                info!(&quot;Getting {:?}&quot;, key);
</a><a href="#h6-0-110" id="h6-0-110" class="d">-                Ok(serialize(self.store.get(&amp;key)?)?)
</a><a href="#h6-0-111" id="h6-0-111" class="d">-            }
</a><a href="#h6-0-112" id="h6-0-112" class="d">-            Read::GetPrefix(prefix) =&gt; {
</a><a href="#h6-0-113" id="h6-0-113" class="d">-                info!(&quot;Getting pairs under prefix {:?}&quot;, prefix);
</a><a href="#h6-0-114" id="h6-0-114" class="d">-                let pairs: Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt; =
</a><a href="#h6-0-115" id="h6-0-115" class="d">-                    self.store.iter_prefix(&amp;prefix).collect::&lt;Result&lt;_, Error&gt;&gt;()?;
</a><a href="#h6-0-116" id="h6-0-116" class="d">-                Ok(serialize(pairs)?)
</a><a href="#h6-0-117" id="h6-0-117" class="d">-            }
</a><a href="#h6-0-118" id="h6-0-118" class="d">-        }
</a><a href="#h6-0-119" id="h6-0-119" class="d">-    }
</a><a href="#h6-0-120" id="h6-0-120" class="d">-}
</a><b>diff --git a/<a id="h7" href="../file/src/kv/simple.rs.html">src/kv/simple.rs</a> b/<a href="../file/src/kv/simple.rs.html">src/kv/simple.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,110 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+use super::storage::{Range, Storage};
</a><a href="#h7-0-1" id="h7-0-1" class="i">+use crate::Error;
</a><a href="#h7-0-2" id="h7-0-2" class="i">+
</a><a href="#h7-0-3" id="h7-0-3" class="i">+use std::ops::RangeBounds;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+use std::sync::{Arc, RwLock};
</a><a href="#h7-0-5" id="h7-0-5" class="i">+
</a><a href="#h7-0-6" id="h7-0-6" class="i">+/// A simple key-value store
</a><a href="#h7-0-7" id="h7-0-7" class="i">+#[derive(Clone, Debug)]
</a><a href="#h7-0-8" id="h7-0-8" class="i">+pub struct Simple&lt;S: Storage&gt; {
</a><a href="#h7-0-9" id="h7-0-9" class="i">+    storage: Arc&lt;RwLock&lt;S&gt;&gt;,
</a><a href="#h7-0-10" id="h7-0-10" class="i">+}
</a><a href="#h7-0-11" id="h7-0-11" class="i">+
</a><a href="#h7-0-12" id="h7-0-12" class="i">+impl&lt;S: Storage&gt; Simple&lt;S&gt; {
</a><a href="#h7-0-13" id="h7-0-13" class="i">+    /// Creates a new Simple store
</a><a href="#h7-0-14" id="h7-0-14" class="i">+    pub fn new(storage: S) -&gt; Self {
</a><a href="#h7-0-15" id="h7-0-15" class="i">+        Self { storage: Arc::new(RwLock::new(storage)) }
</a><a href="#h7-0-16" id="h7-0-16" class="i">+    }
</a><a href="#h7-0-17" id="h7-0-17" class="i">+
</a><a href="#h7-0-18" id="h7-0-18" class="i">+    /// Deletes a key
</a><a href="#h7-0-19" id="h7-0-19" class="i">+    pub fn delete(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-20" id="h7-0-20" class="i">+        self.storage.write()?.remove(key)
</a><a href="#h7-0-21" id="h7-0-21" class="i">+    }
</a><a href="#h7-0-22" id="h7-0-22" class="i">+
</a><a href="#h7-0-23" id="h7-0-23" class="i">+    /// Fetches a key
</a><a href="#h7-0-24" id="h7-0-24" class="i">+    pub fn get(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h7-0-25" id="h7-0-25" class="i">+        self.storage.read()?.read(key)
</a><a href="#h7-0-26" id="h7-0-26" class="i">+    }
</a><a href="#h7-0-27" id="h7-0-27" class="i">+
</a><a href="#h7-0-28" id="h7-0-28" class="i">+    /// Scans a key range
</a><a href="#h7-0-29" id="h7-0-29" class="i">+    #[allow(dead_code)]
</a><a href="#h7-0-30" id="h7-0-30" class="i">+    pub fn scan(&amp;self, range: impl RangeBounds&lt;Vec&lt;u8&gt;&gt;) -&gt; Result&lt;Range, Error&gt; {
</a><a href="#h7-0-31" id="h7-0-31" class="i">+        Ok(self.storage.read()?.scan(range))
</a><a href="#h7-0-32" id="h7-0-32" class="i">+    }
</a><a href="#h7-0-33" id="h7-0-33" class="i">+
</a><a href="#h7-0-34" id="h7-0-34" class="i">+    /// Sets a key
</a><a href="#h7-0-35" id="h7-0-35" class="i">+    pub fn set(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-36" id="h7-0-36" class="i">+        self.storage.write()?.write(key, value)
</a><a href="#h7-0-37" id="h7-0-37" class="i">+    }
</a><a href="#h7-0-38" id="h7-0-38" class="i">+}
</a><a href="#h7-0-39" id="h7-0-39" class="i">+
</a><a href="#h7-0-40" id="h7-0-40" class="i">+#[cfg(test)]
</a><a href="#h7-0-41" id="h7-0-41" class="i">+pub mod tests {
</a><a href="#h7-0-42" id="h7-0-42" class="i">+    use super::super::storage::Memory;
</a><a href="#h7-0-43" id="h7-0-43" class="i">+    use super::*;
</a><a href="#h7-0-44" id="h7-0-44" class="i">+
</a><a href="#h7-0-45" id="h7-0-45" class="i">+    fn setup() -&gt; Simple&lt;Memory&gt; {
</a><a href="#h7-0-46" id="h7-0-46" class="i">+        Simple::new(Memory::new())
</a><a href="#h7-0-47" id="h7-0-47" class="i">+    }
</a><a href="#h7-0-48" id="h7-0-48" class="i">+
</a><a href="#h7-0-49" id="h7-0-49" class="i">+    #[test]
</a><a href="#h7-0-50" id="h7-0-50" class="i">+    fn test_delete() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-51" id="h7-0-51" class="i">+        let mut s = setup();
</a><a href="#h7-0-52" id="h7-0-52" class="i">+        s.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h7-0-53" id="h7-0-53" class="i">+        assert_eq!(Some(vec![0x01]), s.get(b&quot;a&quot;)?);
</a><a href="#h7-0-54" id="h7-0-54" class="i">+        s.delete(b&quot;a&quot;)?;
</a><a href="#h7-0-55" id="h7-0-55" class="i">+        assert_eq!(None, s.get(b&quot;a&quot;)?);
</a><a href="#h7-0-56" id="h7-0-56" class="i">+        s.delete(b&quot;b&quot;)?;
</a><a href="#h7-0-57" id="h7-0-57" class="i">+        Ok(())
</a><a href="#h7-0-58" id="h7-0-58" class="i">+    }
</a><a href="#h7-0-59" id="h7-0-59" class="i">+
</a><a href="#h7-0-60" id="h7-0-60" class="i">+    #[test]
</a><a href="#h7-0-61" id="h7-0-61" class="i">+    fn test_get() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-62" id="h7-0-62" class="i">+        let mut s = setup();
</a><a href="#h7-0-63" id="h7-0-63" class="i">+        s.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h7-0-64" id="h7-0-64" class="i">+        assert_eq!(Some(vec![0x01]), s.get(b&quot;a&quot;)?);
</a><a href="#h7-0-65" id="h7-0-65" class="i">+        assert_eq!(None, s.get(b&quot;b&quot;)?);
</a><a href="#h7-0-66" id="h7-0-66" class="i">+        Ok(())
</a><a href="#h7-0-67" id="h7-0-67" class="i">+    }
</a><a href="#h7-0-68" id="h7-0-68" class="i">+
</a><a href="#h7-0-69" id="h7-0-69" class="i">+    #[test]
</a><a href="#h7-0-70" id="h7-0-70" class="i">+    fn test_scan() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-71" id="h7-0-71" class="i">+        let mut s = setup();
</a><a href="#h7-0-72" id="h7-0-72" class="i">+        s.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h7-0-73" id="h7-0-73" class="i">+        s.set(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h7-0-74" id="h7-0-74" class="i">+        s.set(b&quot;ba&quot;, vec![0x02, 0x01])?;
</a><a href="#h7-0-75" id="h7-0-75" class="i">+        s.set(b&quot;bb&quot;, vec![0x02, 0x02])?;
</a><a href="#h7-0-76" id="h7-0-76" class="i">+        s.set(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h7-0-77" id="h7-0-77" class="i">+
</a><a href="#h7-0-78" id="h7-0-78" class="i">+        assert_eq!(
</a><a href="#h7-0-79" id="h7-0-79" class="i">+            vec![
</a><a href="#h7-0-80" id="h7-0-80" class="i">+                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h7-0-81" id="h7-0-81" class="i">+                (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h7-0-82" id="h7-0-82" class="i">+                (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h7-0-83" id="h7-0-83" class="i">+            ],
</a><a href="#h7-0-84" id="h7-0-84" class="i">+            s.scan(b&quot;b&quot;.to_vec()..b&quot;c&quot;.to_vec())?
</a><a href="#h7-0-85" id="h7-0-85" class="i">+                .collect::&lt;Result&lt;Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;, Error&gt;&gt;()?,
</a><a href="#h7-0-86" id="h7-0-86" class="i">+        );
</a><a href="#h7-0-87" id="h7-0-87" class="i">+        assert_eq!(
</a><a href="#h7-0-88" id="h7-0-88" class="i">+            vec![
</a><a href="#h7-0-89" id="h7-0-89" class="i">+                (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h7-0-90" id="h7-0-90" class="i">+                (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h7-0-91" id="h7-0-91" class="i">+                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h7-0-92" id="h7-0-92" class="i">+            ],
</a><a href="#h7-0-93" id="h7-0-93" class="i">+            s.scan(b&quot;b&quot;.to_vec()..b&quot;c&quot;.to_vec())?
</a><a href="#h7-0-94" id="h7-0-94" class="i">+                .rev()
</a><a href="#h7-0-95" id="h7-0-95" class="i">+                .collect::&lt;Result&lt;Vec&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;)&gt;, Error&gt;&gt;()?,
</a><a href="#h7-0-96" id="h7-0-96" class="i">+        );
</a><a href="#h7-0-97" id="h7-0-97" class="i">+        Ok(())
</a><a href="#h7-0-98" id="h7-0-98" class="i">+    }
</a><a href="#h7-0-99" id="h7-0-99" class="i">+
</a><a href="#h7-0-100" id="h7-0-100" class="i">+    #[test]
</a><a href="#h7-0-101" id="h7-0-101" class="i">+    fn test_set() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h7-0-102" id="h7-0-102" class="i">+        let mut s = setup();
</a><a href="#h7-0-103" id="h7-0-103" class="i">+        s.set(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h7-0-104" id="h7-0-104" class="i">+        assert_eq!(Some(vec![0x01]), s.get(b&quot;a&quot;)?);
</a><a href="#h7-0-105" id="h7-0-105" class="i">+        s.set(b&quot;a&quot;, vec![0x02])?;
</a><a href="#h7-0-106" id="h7-0-106" class="i">+        assert_eq!(Some(vec![0x02]), s.get(b&quot;a&quot;)?);
</a><a href="#h7-0-107" id="h7-0-107" class="i">+        Ok(())
</a><a href="#h7-0-108" id="h7-0-108" class="i">+    }
</a><a href="#h7-0-109" id="h7-0-109" class="i">+}
</a><b>diff --git a/<a id="h8" href="../file/src/kv/storage/file.rs.html">src/kv/storage/file.rs</a> b/<a href="../file/src/kv/storage/file.rs.html">src/kv/storage/file.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,79 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+use super::{Range, Storage};
</a><a href="#h8-0-1" id="h8-0-1" class="i">+use crate::Error;
</a><a href="#h8-0-2" id="h8-0-2" class="i">+
</a><a href="#h8-0-3" id="h8-0-3" class="i">+use std::collections::BTreeMap;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+use std::io::Seek;
</a><a href="#h8-0-5" id="h8-0-5" class="i">+use std::ops::RangeBounds;
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+/// A prototype file-based key-value backend. Keeps the entire dataset in
</a><a href="#h8-0-8" id="h8-0-8" class="i">+/// memory and writes it out to disk on every write, as a stop-gap solution
</a><a href="#h8-0-9" id="h8-0-9" class="i">+/// until a proper store is written.
</a><a href="#h8-0-10" id="h8-0-10" class="i">+#[derive(Debug)]
</a><a href="#h8-0-11" id="h8-0-11" class="i">+pub struct File {
</a><a href="#h8-0-12" id="h8-0-12" class="i">+    file: std::fs::File,
</a><a href="#h8-0-13" id="h8-0-13" class="i">+    data: BTreeMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;,
</a><a href="#h8-0-14" id="h8-0-14" class="i">+}
</a><a href="#h8-0-15" id="h8-0-15" class="i">+
</a><a href="#h8-0-16" id="h8-0-16" class="i">+impl File {
</a><a href="#h8-0-17" id="h8-0-17" class="i">+    /// Creates a new file-based key-value storage backend
</a><a href="#h8-0-18" id="h8-0-18" class="i">+    pub fn new(file: std::fs::File) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h8-0-19" id="h8-0-19" class="i">+        let data = if file.metadata()?.len() &gt; 0 {
</a><a href="#h8-0-20" id="h8-0-20" class="i">+            rmp_serde::decode::from_read(file.try_clone()?)?
</a><a href="#h8-0-21" id="h8-0-21" class="i">+        } else {
</a><a href="#h8-0-22" id="h8-0-22" class="i">+            BTreeMap::new()
</a><a href="#h8-0-23" id="h8-0-23" class="i">+        };
</a><a href="#h8-0-24" id="h8-0-24" class="i">+        Ok(Self { file, data })
</a><a href="#h8-0-25" id="h8-0-25" class="i">+    }
</a><a href="#h8-0-26" id="h8-0-26" class="i">+
</a><a href="#h8-0-27" id="h8-0-27" class="i">+    /// Writes out the entire dataset to the file
</a><a href="#h8-0-28" id="h8-0-28" class="i">+    fn flush(&amp;mut self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-0-29" id="h8-0-29" class="i">+        self.file.seek(std::io::SeekFrom::Start(0))?;
</a><a href="#h8-0-30" id="h8-0-30" class="i">+        rmp_serde::encode::write(&amp;mut self.file, &amp;self.data)?;
</a><a href="#h8-0-31" id="h8-0-31" class="i">+        Ok(())
</a><a href="#h8-0-32" id="h8-0-32" class="i">+    }
</a><a href="#h8-0-33" id="h8-0-33" class="i">+}
</a><a href="#h8-0-34" id="h8-0-34" class="i">+
</a><a href="#h8-0-35" id="h8-0-35" class="i">+impl Storage for File {
</a><a href="#h8-0-36" id="h8-0-36" class="i">+    fn read(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h8-0-37" id="h8-0-37" class="i">+        Ok(self.data.get(key).cloned())
</a><a href="#h8-0-38" id="h8-0-38" class="i">+    }
</a><a href="#h8-0-39" id="h8-0-39" class="i">+
</a><a href="#h8-0-40" id="h8-0-40" class="i">+    fn remove(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-0-41" id="h8-0-41" class="i">+        self.data.remove(key);
</a><a href="#h8-0-42" id="h8-0-42" class="i">+        self.flush()?;
</a><a href="#h8-0-43" id="h8-0-43" class="i">+        Ok(())
</a><a href="#h8-0-44" id="h8-0-44" class="i">+    }
</a><a href="#h8-0-45" id="h8-0-45" class="i">+
</a><a href="#h8-0-46" id="h8-0-46" class="i">+    fn scan(&amp;self, range: impl RangeBounds&lt;Vec&lt;u8&gt;&gt;) -&gt; Range {
</a><a href="#h8-0-47" id="h8-0-47" class="i">+        // FIXME This copies everything into a separate vec to not have to deal with
</a><a href="#h8-0-48" id="h8-0-48" class="i">+        // lifetimes, which is pretty terrible.
</a><a href="#h8-0-49" id="h8-0-49" class="i">+        Box::new(
</a><a href="#h8-0-50" id="h8-0-50" class="i">+            self.data
</a><a href="#h8-0-51" id="h8-0-51" class="i">+                .range(range)
</a><a href="#h8-0-52" id="h8-0-52" class="i">+                .map(|(k, v)| Ok((k.clone(), v.clone())))
</a><a href="#h8-0-53" id="h8-0-53" class="i">+                .collect::&lt;Vec&lt;Result&lt;_, Error&gt;&gt;&gt;()
</a><a href="#h8-0-54" id="h8-0-54" class="i">+                .into_iter(),
</a><a href="#h8-0-55" id="h8-0-55" class="i">+        )
</a><a href="#h8-0-56" id="h8-0-56" class="i">+    }
</a><a href="#h8-0-57" id="h8-0-57" class="i">+
</a><a href="#h8-0-58" id="h8-0-58" class="i">+    fn write(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-0-59" id="h8-0-59" class="i">+        self.data.insert(key.to_vec(), value);
</a><a href="#h8-0-60" id="h8-0-60" class="i">+        self.flush()?;
</a><a href="#h8-0-61" id="h8-0-61" class="i">+        Ok(())
</a><a href="#h8-0-62" id="h8-0-62" class="i">+    }
</a><a href="#h8-0-63" id="h8-0-63" class="i">+}
</a><a href="#h8-0-64" id="h8-0-64" class="i">+
</a><a href="#h8-0-65" id="h8-0-65" class="i">+#[cfg(test)]
</a><a href="#h8-0-66" id="h8-0-66" class="i">+impl super::TestSuite&lt;File&gt; for File {
</a><a href="#h8-0-67" id="h8-0-67" class="i">+    fn setup() -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h8-0-68" id="h8-0-68" class="i">+        extern crate tempfile;
</a><a href="#h8-0-69" id="h8-0-69" class="i">+        use tempfile::tempfile;
</a><a href="#h8-0-70" id="h8-0-70" class="i">+        File::new(tempfile()?)
</a><a href="#h8-0-71" id="h8-0-71" class="i">+    }
</a><a href="#h8-0-72" id="h8-0-72" class="i">+}
</a><a href="#h8-0-73" id="h8-0-73" class="i">+
</a><a href="#h8-0-74" id="h8-0-74" class="i">+#[test]
</a><a href="#h8-0-75" id="h8-0-75" class="i">+fn tests() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h8-0-76" id="h8-0-76" class="i">+    use super::TestSuite;
</a><a href="#h8-0-77" id="h8-0-77" class="i">+    File::test()
</a><a href="#h8-0-78" id="h8-0-78" class="i">+}
</a><b>diff --git a/<a id="h9" href="../file/src/kv/storage/memory.rs.html">src/kv/storage/memory.rs</a> b/<a href="../file/src/kv/storage/memory.rs.html">src/kv/storage/memory.rs</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,58 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+use super::{Range, Storage};
</a><a href="#h9-0-1" id="h9-0-1" class="i">+use crate::Error;
</a><a href="#h9-0-2" id="h9-0-2" class="i">+use std::collections::BTreeMap;
</a><a href="#h9-0-3" id="h9-0-3" class="i">+use std::ops::RangeBounds;
</a><a href="#h9-0-4" id="h9-0-4" class="i">+
</a><a href="#h9-0-5" id="h9-0-5" class="i">+/// In-memory key-value storage. Primarily used for prototyping and testing.
</a><a href="#h9-0-6" id="h9-0-6" class="i">+#[derive(Clone, Debug)]
</a><a href="#h9-0-7" id="h9-0-7" class="i">+pub struct Memory {
</a><a href="#h9-0-8" id="h9-0-8" class="i">+    data: BTreeMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;,
</a><a href="#h9-0-9" id="h9-0-9" class="i">+}
</a><a href="#h9-0-10" id="h9-0-10" class="i">+
</a><a href="#h9-0-11" id="h9-0-11" class="i">+impl Memory {
</a><a href="#h9-0-12" id="h9-0-12" class="i">+    /// Creates a new Memory key-value storage engine
</a><a href="#h9-0-13" id="h9-0-13" class="i">+    pub fn new() -&gt; Self {
</a><a href="#h9-0-14" id="h9-0-14" class="i">+        Self { data: BTreeMap::new() }
</a><a href="#h9-0-15" id="h9-0-15" class="i">+    }
</a><a href="#h9-0-16" id="h9-0-16" class="i">+}
</a><a href="#h9-0-17" id="h9-0-17" class="i">+
</a><a href="#h9-0-18" id="h9-0-18" class="i">+impl Storage for Memory {
</a><a href="#h9-0-19" id="h9-0-19" class="i">+    fn read(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h9-0-20" id="h9-0-20" class="i">+        Ok(self.data.get(key).cloned())
</a><a href="#h9-0-21" id="h9-0-21" class="i">+    }
</a><a href="#h9-0-22" id="h9-0-22" class="i">+
</a><a href="#h9-0-23" id="h9-0-23" class="i">+    fn remove(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h9-0-24" id="h9-0-24" class="i">+        self.data.remove(key);
</a><a href="#h9-0-25" id="h9-0-25" class="i">+        Ok(())
</a><a href="#h9-0-26" id="h9-0-26" class="i">+    }
</a><a href="#h9-0-27" id="h9-0-27" class="i">+
</a><a href="#h9-0-28" id="h9-0-28" class="i">+    fn scan(&amp;self, range: impl RangeBounds&lt;Vec&lt;u8&gt;&gt;) -&gt; Range {
</a><a href="#h9-0-29" id="h9-0-29" class="i">+        // FIXME This copies everything into a separate vec to not have to deal with
</a><a href="#h9-0-30" id="h9-0-30" class="i">+        // lifetimes, which is pretty terrible.
</a><a href="#h9-0-31" id="h9-0-31" class="i">+        Box::new(
</a><a href="#h9-0-32" id="h9-0-32" class="i">+            self.data
</a><a href="#h9-0-33" id="h9-0-33" class="i">+                .range(range)
</a><a href="#h9-0-34" id="h9-0-34" class="i">+                .map(|(k, v)| Ok((k.clone(), v.clone())))
</a><a href="#h9-0-35" id="h9-0-35" class="i">+                .collect::&lt;Vec&lt;Result&lt;_, Error&gt;&gt;&gt;()
</a><a href="#h9-0-36" id="h9-0-36" class="i">+                .into_iter(),
</a><a href="#h9-0-37" id="h9-0-37" class="i">+        )
</a><a href="#h9-0-38" id="h9-0-38" class="i">+    }
</a><a href="#h9-0-39" id="h9-0-39" class="i">+
</a><a href="#h9-0-40" id="h9-0-40" class="i">+    fn write(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h9-0-41" id="h9-0-41" class="i">+        self.data.insert(key.to_vec(), value);
</a><a href="#h9-0-42" id="h9-0-42" class="i">+        Ok(())
</a><a href="#h9-0-43" id="h9-0-43" class="i">+    }
</a><a href="#h9-0-44" id="h9-0-44" class="i">+}
</a><a href="#h9-0-45" id="h9-0-45" class="i">+
</a><a href="#h9-0-46" id="h9-0-46" class="i">+#[cfg(test)]
</a><a href="#h9-0-47" id="h9-0-47" class="i">+impl super::TestSuite&lt;Memory&gt; for Memory {
</a><a href="#h9-0-48" id="h9-0-48" class="i">+    fn setup() -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h9-0-49" id="h9-0-49" class="i">+        Ok(Memory::new())
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    }
</a><a href="#h9-0-51" id="h9-0-51" class="i">+}
</a><a href="#h9-0-52" id="h9-0-52" class="i">+
</a><a href="#h9-0-53" id="h9-0-53" class="i">+#[test]
</a><a href="#h9-0-54" id="h9-0-54" class="i">+fn tests() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h9-0-55" id="h9-0-55" class="i">+    use super::TestSuite;
</a><a href="#h9-0-56" id="h9-0-56" class="i">+    Memory::test()
</a><a href="#h9-0-57" id="h9-0-57" class="i">+}
</a><b>diff --git a/<a id="h10" href="../file/src/kv/storage/mod.rs.html">src/kv/storage/mod.rs</a> b/<a href="../file/src/kv/storage/mod.rs.html">src/kv/storage/mod.rs</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,88 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+mod file;
</a><a href="#h10-0-1" id="h10-0-1" class="i">+#[cfg(test)]
</a><a href="#h10-0-2" id="h10-0-2" class="i">+mod memory;
</a><a href="#h10-0-3" id="h10-0-3" class="i">+
</a><a href="#h10-0-4" id="h10-0-4" class="i">+pub use file::File;
</a><a href="#h10-0-5" id="h10-0-5" class="i">+#[cfg(test)]
</a><a href="#h10-0-6" id="h10-0-6" class="i">+pub use memory::Memory;
</a><a href="#h10-0-7" id="h10-0-7" class="i">+
</a><a href="#h10-0-8" id="h10-0-8" class="i">+use crate::Error;
</a><a href="#h10-0-9" id="h10-0-9" class="i">+use std::ops::RangeBounds;
</a><a href="#h10-0-10" id="h10-0-10" class="i">+
</a><a href="#h10-0-11" id="h10-0-11" class="i">+/// KV storage backend
</a><a href="#h10-0-12" id="h10-0-12" class="i">+pub trait Storage: &#39;static + Sync + Send {
</a><a href="#h10-0-13" id="h10-0-13" class="i">+    /// Reads a value
</a><a href="#h10-0-14" id="h10-0-14" class="i">+    fn read(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt;;
</a><a href="#h10-0-15" id="h10-0-15" class="i">+
</a><a href="#h10-0-16" id="h10-0-16" class="i">+    /// Removes a value
</a><a href="#h10-0-17" id="h10-0-17" class="i">+    fn remove(&amp;mut self, key: &amp;[u8]) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h10-0-18" id="h10-0-18" class="i">+
</a><a href="#h10-0-19" id="h10-0-19" class="i">+    /// Returns an iterator over a range of pairs (inclusive)
</a><a href="#h10-0-20" id="h10-0-20" class="i">+    fn scan(&amp;self, range: impl RangeBounds&lt;Vec&lt;u8&gt;&gt;) -&gt; Range;
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+    /// Writes a value
</a><a href="#h10-0-23" id="h10-0-23" class="i">+    fn write(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h10-0-24" id="h10-0-24" class="i">+}
</a><a href="#h10-0-25" id="h10-0-25" class="i">+
</a><a href="#h10-0-26" id="h10-0-26" class="i">+/// Iterator over a key range
</a><a href="#h10-0-27" id="h10-0-27" class="i">+pub type Range =
</a><a href="#h10-0-28" id="h10-0-28" class="i">+    Box&lt;dyn DoubleEndedIterator&lt;Item = Result&lt;(Vec&lt;u8&gt;, Vec&lt;u8&gt;), Error&gt;&gt; + &#39;static + Sync + Send&gt;;
</a><a href="#h10-0-29" id="h10-0-29" class="i">+
</a><a href="#h10-0-30" id="h10-0-30" class="i">+#[cfg(test)]
</a><a href="#h10-0-31" id="h10-0-31" class="i">+trait TestSuite&lt;S: Storage&gt; {
</a><a href="#h10-0-32" id="h10-0-32" class="i">+    fn setup() -&gt; Result&lt;S, Error&gt;;
</a><a href="#h10-0-33" id="h10-0-33" class="i">+
</a><a href="#h10-0-34" id="h10-0-34" class="i">+    fn test() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-35" id="h10-0-35" class="i">+        Self::test_range()?;
</a><a href="#h10-0-36" id="h10-0-36" class="i">+        Self::test_read()?;
</a><a href="#h10-0-37" id="h10-0-37" class="i">+        Self::test_remove()?;
</a><a href="#h10-0-38" id="h10-0-38" class="i">+        Self::test_write()?;
</a><a href="#h10-0-39" id="h10-0-39" class="i">+        Ok(())
</a><a href="#h10-0-40" id="h10-0-40" class="i">+    }
</a><a href="#h10-0-41" id="h10-0-41" class="i">+
</a><a href="#h10-0-42" id="h10-0-42" class="i">+    fn test_range() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-43" id="h10-0-43" class="i">+        let mut s = Self::setup()?;
</a><a href="#h10-0-44" id="h10-0-44" class="i">+        s.write(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h10-0-45" id="h10-0-45" class="i">+        s.write(b&quot;b&quot;, vec![0x02])?;
</a><a href="#h10-0-46" id="h10-0-46" class="i">+        s.write(b&quot;ba&quot;, vec![0x02, 0x01])?;
</a><a href="#h10-0-47" id="h10-0-47" class="i">+        s.write(b&quot;bb&quot;, vec![0x02, 0x02])?;
</a><a href="#h10-0-48" id="h10-0-48" class="i">+        s.write(b&quot;c&quot;, vec![0x03])?;
</a><a href="#h10-0-49" id="h10-0-49" class="i">+
</a><a href="#h10-0-50" id="h10-0-50" class="i">+        assert_eq!(
</a><a href="#h10-0-51" id="h10-0-51" class="i">+            vec![
</a><a href="#h10-0-52" id="h10-0-52" class="i">+                (b&quot;b&quot;.to_vec(), vec![0x02]),
</a><a href="#h10-0-53" id="h10-0-53" class="i">+                (b&quot;ba&quot;.to_vec(), vec![0x02, 0x01]),
</a><a href="#h10-0-54" id="h10-0-54" class="i">+                (b&quot;bb&quot;.to_vec(), vec![0x02, 0x02]),
</a><a href="#h10-0-55" id="h10-0-55" class="i">+            ],
</a><a href="#h10-0-56" id="h10-0-56" class="i">+            s.scan(b&quot;b&quot;.to_vec()..b&quot;bz&quot;.to_vec()).collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;()?
</a><a href="#h10-0-57" id="h10-0-57" class="i">+        );
</a><a href="#h10-0-58" id="h10-0-58" class="i">+        Ok(())
</a><a href="#h10-0-59" id="h10-0-59" class="i">+    }
</a><a href="#h10-0-60" id="h10-0-60" class="i">+
</a><a href="#h10-0-61" id="h10-0-61" class="i">+    fn test_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        let mut b = Self::setup()?;
</a><a href="#h10-0-63" id="h10-0-63" class="i">+        b.write(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h10-0-64" id="h10-0-64" class="i">+        assert_eq!(Some(vec![0x01]), b.read(b&quot;a&quot;)?);
</a><a href="#h10-0-65" id="h10-0-65" class="i">+        assert_eq!(None, b.read(b&quot;b&quot;)?);
</a><a href="#h10-0-66" id="h10-0-66" class="i">+        Ok(())
</a><a href="#h10-0-67" id="h10-0-67" class="i">+    }
</a><a href="#h10-0-68" id="h10-0-68" class="i">+
</a><a href="#h10-0-69" id="h10-0-69" class="i">+    fn test_remove() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-70" id="h10-0-70" class="i">+        let mut b = Self::setup()?;
</a><a href="#h10-0-71" id="h10-0-71" class="i">+        b.write(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h10-0-72" id="h10-0-72" class="i">+        assert_eq!(Some(vec![0x01]), b.read(b&quot;a&quot;)?);
</a><a href="#h10-0-73" id="h10-0-73" class="i">+        b.remove(b&quot;a&quot;)?;
</a><a href="#h10-0-74" id="h10-0-74" class="i">+        assert_eq!(None, b.read(b&quot;a&quot;)?);
</a><a href="#h10-0-75" id="h10-0-75" class="i">+        b.remove(b&quot;b&quot;)?;
</a><a href="#h10-0-76" id="h10-0-76" class="i">+        Ok(())
</a><a href="#h10-0-77" id="h10-0-77" class="i">+    }
</a><a href="#h10-0-78" id="h10-0-78" class="i">+
</a><a href="#h10-0-79" id="h10-0-79" class="i">+    fn test_write() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-80" id="h10-0-80" class="i">+        let mut b = Self::setup()?;
</a><a href="#h10-0-81" id="h10-0-81" class="i">+        b.write(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h10-0-82" id="h10-0-82" class="i">+        assert_eq!(Some(vec![0x01]), b.read(b&quot;a&quot;)?);
</a><a href="#h10-0-83" id="h10-0-83" class="i">+        b.write(b&quot;a&quot;, vec![0x02])?;
</a><a href="#h10-0-84" id="h10-0-84" class="i">+        assert_eq!(Some(vec![0x02]), b.read(b&quot;a&quot;)?);
</a><a href="#h10-0-85" id="h10-0-85" class="i">+        Ok(())
</a><a href="#h10-0-86" id="h10-0-86" class="i">+    }
</a><a href="#h10-0-87" id="h10-0-87" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -14,9 +14,9 @@ pub struct Entry {
</a> 
 /// The replicated Raft log
 #[derive(Debug)]
<a href="#h11-0-3" id="h11-0-3" class="d">-pub struct Log {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+pub struct Log&lt;S: kv::storage::Storage&gt; {
</a>     /// The underlying key-value store
<a href="#h11-0-6" id="h11-0-6" class="d">-    kv: Box&lt;dyn kv::Store&gt;,
</a><a href="#h11-0-7" id="h11-0-7" class="i">+    kv: kv::Simple&lt;S&gt;,
</a>     /// The index of the last stored entry.
     last_index: u64,
     /// The term of the last stored entry.
<a href="#h11-1" id="h11-1" class="h">@@ -33,9 +33,9 @@ pub struct Log {
</a>     apply_term: u64,
 }
 
<a href="#h11-1-3" id="h11-1-3" class="d">-impl Log {
</a><a href="#h11-1-4" id="h11-1-4" class="i">+impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a>     /// Creates a new log, using a kv::Store for storage.
<a href="#h11-1-6" id="h11-1-6" class="d">-    pub fn new&lt;S: kv::Store&gt;(store: S) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h11-1-7" id="h11-1-7" class="i">+    pub fn new(store: kv::Simple&lt;S&gt;) -&gt; Result&lt;Self, Error&gt; {
</a>         let apply_index = match store.get(b&quot;apply_index&quot;)? {
             Some(v) =&gt; deserialize(v)?,
             None =&gt; 0,
<a href="#h11-2" id="h11-2" class="h">@@ -60,7 +60,7 @@ impl Log {
</a>             }
         }
         Ok(Self {
<a href="#h11-2-3" id="h11-2-3" class="d">-            kv: Box::new(store),
</a><a href="#h11-2-4" id="h11-2-4" class="i">+            kv: store,
</a>             last_index,
             last_term,
             commit_index,
<a href="#h11-3" id="h11-3" class="h">@@ -83,7 +83,7 @@ impl Log {
</a>     /// Applies the next committed entry to the state machine, if any.
     /// Returns the applied entry index and output, or None if no entry.
     #[allow(clippy::borrowed_box)] // Currently this is correct
<a href="#h11-3-3" id="h11-3-3" class="d">-    pub fn apply(&amp;mut self, state: &amp;mut Box&lt;dyn State&gt;) -&gt; Result&lt;Option&lt;(u64, Vec&lt;u8&gt;)&gt;, Error&gt; {
</a><a href="#h11-3-4" id="h11-3-4" class="i">+    pub fn apply(&amp;mut self, state: &amp;mut impl State) -&gt; Result&lt;Option&lt;(u64, Vec&lt;u8&gt;)&gt;, Error&gt; {
</a>         if self.apply_index &gt;= self.commit_index {
             return Ok(None);
         }
<a href="#h11-4" id="h11-4" class="h">@@ -250,8 +250,8 @@ mod tests {
</a>     use super::super::tests::TestState;
     use super::*;
 
<a href="#h11-4-3" id="h11-4-3" class="d">-    fn setup() -&gt; (Log, kv::Memory) {
</a><a href="#h11-4-4" id="h11-4-4" class="d">-        let store = kv::Memory::new();
</a><a href="#h11-4-5" id="h11-4-5" class="i">+    fn setup() -&gt; (Log&lt;kv::storage::Memory&gt;, kv::Simple&lt;kv::storage::Memory&gt;) {
</a><a href="#h11-4-6" id="h11-4-6" class="i">+        let store = kv::Simple::new(kv::storage::Memory::new());
</a>         let log = Log::new(store.clone()).unwrap();
         (log, store)
     }
<a href="#h11-5" id="h11-5" class="h">@@ -307,20 +307,20 @@ mod tests {
</a>         l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
         l.commit(3).unwrap();
 
<a href="#h11-5-3" id="h11-5-3" class="d">-        let state = TestState::new();
</a><a href="#h11-5-4" id="h11-5-4" class="d">-        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-5-5" id="h11-5-5" class="i">+        let mut state = TestState::new();
</a><a href="#h11-5-6" id="h11-5-6" class="i">+        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state));
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h11-5-10" id="h11-5-10" class="d">-        assert_eq!(Ok(Some((2, vec![]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-5-11" id="h11-5-11" class="i">+        assert_eq!(Ok(Some((2, vec![]))), l.apply(&amp;mut state));
</a>         assert_eq!((2, 2), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h11-5-15" id="h11-5-15" class="d">-        assert_eq!(Ok(Some((3, vec![0xff, 0x03]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-5-16" id="h11-5-16" class="i">+        assert_eq!(Ok(Some((3, vec![0xff, 0x03]))), l.apply(&amp;mut state));
</a>         assert_eq!((3, 2), l.get_applied());
         assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
 
<a href="#h11-5-20" id="h11-5-20" class="d">-        assert_eq!(Ok(None), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-5-21" id="h11-5-21" class="i">+        assert_eq!(Ok(None), l.apply(&amp;mut state));
</a>         assert_eq!((3, 2), l.get_applied());
         assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
 
<a href="#h11-6" id="h11-6" class="h">@@ -339,12 +339,12 @@ mod tests {
</a>         l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
         l.commit(1).unwrap();
 
<a href="#h11-6-3" id="h11-6-3" class="d">-        let state = TestState::new();
</a><a href="#h11-6-4" id="h11-6-4" class="d">-        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-6-5" id="h11-6-5" class="i">+        let mut state = TestState::new();
</a><a href="#h11-6-6" id="h11-6-6" class="i">+        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state));
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
 
<a href="#h11-6-10" id="h11-6-10" class="d">-        assert_eq!(Ok(None), l.apply(&amp;mut state.boxed()));
</a><a href="#h11-6-11" id="h11-6-11" class="i">+        assert_eq!(Ok(None), l.apply(&amp;mut state));
</a>         assert_eq!((1, 1), l.get_applied());
         assert_eq!(vec![vec![0x01],], state.list());
     }
<b>diff --git a/<a id="h12" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -31,12 +31,12 @@ impl Raft {
</a>         id: &amp;str,
         peers: Vec&lt;String&gt;,
         state: S,
<a href="#h12-0-3" id="h12-0-3" class="d">-        store: L,
</a><a href="#h12-0-4" id="h12-0-4" class="i">+        store: kv::Simple&lt;L&gt;,
</a>         transport: T,
     ) -&gt; Result&lt;Raft, Error&gt;
     where
         S: State,
<a href="#h12-0-9" id="h12-0-9" class="d">-        L: kv::Store,
</a><a href="#h12-0-10" id="h12-0-10" class="i">+        L: kv::storage::Storage,
</a>         T: Transport,
     {
         let ticker = crossbeam_channel::tick(TICK);
<a href="#h12-1" id="h12-1" class="h">@@ -144,10 +144,6 @@ pub mod tests {
</a>             Self { commands: Arc::new(Mutex::new(Vec::new())) }
         }
 
<a href="#h12-1-3" id="h12-1-3" class="d">-        pub fn boxed(&amp;self) -&gt; Box&lt;dyn State&gt; {
</a><a href="#h12-1-4" id="h12-1-4" class="d">-            Box::new(self.clone())
</a><a href="#h12-1-5" id="h12-1-5" class="d">-        }
</a><a href="#h12-1-6" id="h12-1-6" class="d">-
</a>         pub fn list(&amp;self) -&gt; Vec&lt;Vec&lt;u8&gt;&gt; {
             self.commands.lock().unwrap().clone()
         }
<b>diff --git a/<a id="h13" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -25,16 +25,20 @@ impl Candidate {
</a>     }
 }
 
<a href="#h13-0-3" id="h13-0-3" class="d">-impl RoleNode&lt;Candidate&gt; {
</a><a href="#h13-0-4" id="h13-0-4" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Candidate, L, S&gt; {
</a>     /// Transition to follower role.
<a href="#h13-0-6" id="h13-0-6" class="d">-    fn become_follower(mut self, term: u64, leader: &amp;str) -&gt; Result&lt;RoleNode&lt;Follower&gt;, Error&gt; {
</a><a href="#h13-0-7" id="h13-0-7" class="i">+    fn become_follower(
</a><a href="#h13-0-8" id="h13-0-8" class="i">+        mut self,
</a><a href="#h13-0-9" id="h13-0-9" class="i">+        term: u64,
</a><a href="#h13-0-10" id="h13-0-10" class="i">+        leader: &amp;str,
</a><a href="#h13-0-11" id="h13-0-11" class="i">+    ) -&gt; Result&lt;RoleNode&lt;Follower, L, S&gt;, Error&gt; {
</a>         info!(&quot;Discovered leader {} for term {}, following&quot;, leader, term);
         self.save_term(term, None)?;
         self.become_role(Follower::new(Some(leader), None))
     }
 
     /// Transition to leader role.
<a href="#h13-0-18" id="h13-0-18" class="d">-    fn become_leader(self) -&gt; Result&lt;RoleNode&lt;Leader&gt;, Error&gt; {
</a><a href="#h13-0-19" id="h13-0-19" class="i">+    fn become_leader(self) -&gt; Result&lt;RoleNode&lt;Leader, L, S&gt;, Error&gt; {
</a>         info!(&quot;Won election for term {}, becoming leader&quot;, self.term);
         let peers = self.peers.clone();
         let (last_index, _) = self.log.get_last();
<a href="#h13-1" id="h13-1" class="h">@@ -46,7 +50,7 @@ impl RoleNode&lt;Candidate&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h13-1-3" id="h13-1-3" class="d">-    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h13-1-4" id="h13-1-4" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         if !self.normalize_message(&amp;mut msg) {
             return Ok(self.into());
         }
<a href="#h13-2" id="h13-2" class="h">@@ -84,7 +88,7 @@ impl RoleNode&lt;Candidate&gt; {
</a>     }
 
     /// Processes a logical clock tick.
<a href="#h13-2-3" id="h13-2-3" class="d">-    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h13-2-4" id="h13-2-4" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         while let Some(_) = self.log.apply(&amp;mut self.state)? {}
         // If the election times out, start a new one for the next term.
         self.role.election_ticks += 1;
<a href="#h13-3" id="h13-3" class="h">@@ -105,10 +109,10 @@ mod tests {
</a>     use super::*;
     use crossbeam_channel::Receiver;
 
<a href="#h13-3-3" id="h13-3-3" class="d">-    fn setup() -&gt; (RoleNode&lt;Candidate&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h13-3-4" id="h13-3-4" class="i">+    fn setup() -&gt; (RoleNode&lt;Candidate, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a>         let (sender, receiver) = crossbeam_channel::unbounded();
<a href="#h13-3-6" id="h13-3-6" class="d">-        let mut state = TestState::new().boxed();
</a><a href="#h13-3-7" id="h13-3-7" class="d">-        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h13-3-8" id="h13-3-8" class="i">+        let mut state = TestState::new();
</a><a href="#h13-3-9" id="h13-3-9" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
         log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
         log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
<b>diff --git a/<a id="h14" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -31,9 +31,9 @@ impl Follower {
</a>     }
 }
 
<a href="#h14-0-3" id="h14-0-3" class="d">-impl RoleNode&lt;Follower&gt; {
</a><a href="#h14-0-4" id="h14-0-4" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Follower, L, S&gt; {
</a>     /// Transforms the node into a candidate.
<a href="#h14-0-6" id="h14-0-6" class="d">-    fn become_candidate(self) -&gt; Result&lt;RoleNode&lt;Candidate&gt;, Error&gt; {
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    fn become_candidate(self) -&gt; Result&lt;RoleNode&lt;Candidate, L, S&gt;, Error&gt; {
</a>         info!(&quot;Starting election for term {}&quot;, self.term + 1);
         let mut node = self.become_role(Candidate::new())?;
         node.save_term(node.term + 1, None)?;
<a href="#h14-1" id="h14-1" class="h">@@ -53,7 +53,7 @@ impl RoleNode&lt;Follower&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h14-1-3" id="h14-1-3" class="d">-    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h14-1-4" id="h14-1-4" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         if !self.normalize_message(&amp;mut msg) {
             return Ok(self.into());
         }
<a href="#h14-2" id="h14-2" class="h">@@ -139,7 +139,7 @@ impl RoleNode&lt;Follower&gt; {
</a>     }
 
     /// Processes a logical clock tick.
<a href="#h14-2-3" id="h14-2-3" class="d">-    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h14-2-4" id="h14-2-4" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         while let Some(_) = self.log.apply(&amp;mut self.state)? {}
         self.role.leader_seen_ticks += 1;
         if self.role.leader_seen_ticks &gt;= self.role.leader_seen_timeout {
<a href="#h14-3" id="h14-3" class="h">@@ -156,18 +156,22 @@ pub mod tests {
</a>     use super::*;
     use crossbeam_channel::Receiver;
 
<a href="#h14-3-3" id="h14-3-3" class="d">-    pub fn follower_leader(node: &amp;RoleNode&lt;Follower&gt;) -&gt; Option&lt;String&gt; {
</a><a href="#h14-3-4" id="h14-3-4" class="i">+    pub fn follower_leader&lt;L: kv::storage::Storage, S: State&gt;(
</a><a href="#h14-3-5" id="h14-3-5" class="i">+        node: &amp;RoleNode&lt;Follower, L, S&gt;,
</a><a href="#h14-3-6" id="h14-3-6" class="i">+    ) -&gt; Option&lt;String&gt; {
</a>         node.role.leader.clone()
     }
 
<a href="#h14-3-10" id="h14-3-10" class="d">-    pub fn follower_voted_for(node: &amp;RoleNode&lt;Follower&gt;) -&gt; Option&lt;String&gt; {
</a><a href="#h14-3-11" id="h14-3-11" class="i">+    pub fn follower_voted_for&lt;L: kv::storage::Storage, S: State&gt;(
</a><a href="#h14-3-12" id="h14-3-12" class="i">+        node: &amp;RoleNode&lt;Follower, L, S&gt;,
</a><a href="#h14-3-13" id="h14-3-13" class="i">+    ) -&gt; Option&lt;String&gt; {
</a>         node.role.voted_for.clone()
     }
 
<a href="#h14-3-17" id="h14-3-17" class="d">-    fn setup() -&gt; (RoleNode&lt;Follower&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h14-3-18" id="h14-3-18" class="i">+    fn setup() -&gt; (RoleNode&lt;Follower, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a>         let (sender, receiver) = crossbeam_channel::unbounded();
<a href="#h14-3-20" id="h14-3-20" class="d">-        let mut state = TestState::new().boxed();
</a><a href="#h14-3-21" id="h14-3-21" class="d">-        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h14-3-22" id="h14-3-22" class="i">+        let mut state = TestState::new();
</a><a href="#h14-3-23" id="h14-3-23" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
         log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
         log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
<b>diff --git a/<a id="h15" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -31,9 +31,13 @@ impl Leader {
</a>     }
 }
 
<a href="#h15-0-3" id="h15-0-3" class="d">-impl RoleNode&lt;Leader&gt; {
</a><a href="#h15-0-4" id="h15-0-4" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Leader, L, S&gt; {
</a>     /// Transforms the leader into a follower
<a href="#h15-0-6" id="h15-0-6" class="d">-    fn become_follower(mut self, term: u64, leader: &amp;str) -&gt; Result&lt;RoleNode&lt;Follower&gt;, Error&gt; {
</a><a href="#h15-0-7" id="h15-0-7" class="i">+    fn become_follower(
</a><a href="#h15-0-8" id="h15-0-8" class="i">+        mut self,
</a><a href="#h15-0-9" id="h15-0-9" class="i">+        term: u64,
</a><a href="#h15-0-10" id="h15-0-10" class="i">+        leader: &amp;str,
</a><a href="#h15-0-11" id="h15-0-11" class="i">+    ) -&gt; Result&lt;RoleNode&lt;Follower, L, S&gt;, Error&gt; {
</a>         info!(&quot;Discovered new leader {} for term {}, following&quot;, leader, term);
         self.save_term(term, None)?;
         self.become_role(Follower::new(Some(leader), None))
<a href="#h15-1" id="h15-1" class="h">@@ -118,7 +122,7 @@ impl RoleNode&lt;Leader&gt; {
</a>     }
 
     /// Processes a message.
<a href="#h15-1-3" id="h15-1-3" class="d">-    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h15-1-4" id="h15-1-4" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         if !self.normalize_message(&amp;mut msg) {
             return Ok(self.into());
         }
<a href="#h15-2" id="h15-2" class="h">@@ -196,7 +200,7 @@ impl RoleNode&lt;Leader&gt; {
</a>     }
 
     /// Processes a logical clock tick.
<a href="#h15-2-3" id="h15-2-3" class="d">-    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h15-2-4" id="h15-2-4" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node&lt;L, S&gt;, Error&gt; {
</a>         self.apply()?;
         self.role.heartbeat_ticks += 1;
         if self.role.heartbeat_ticks &gt;= HEARTBEAT_INTERVAL {
<a href="#h15-3" id="h15-3" class="h">@@ -281,10 +285,10 @@ mod tests {
</a>     use super::*;
     use crossbeam_channel::Receiver;
 
<a href="#h15-3-3" id="h15-3-3" class="d">-    fn setup() -&gt; (RoleNode&lt;Leader&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h15-3-4" id="h15-3-4" class="i">+    fn setup() -&gt; (RoleNode&lt;Leader, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a>         let (sender, receiver) = crossbeam_channel::unbounded();
<a href="#h15-3-6" id="h15-3-6" class="d">-        let mut state = TestState::new().boxed();
</a><a href="#h15-3-7" id="h15-3-7" class="d">-        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h15-3-8" id="h15-3-8" class="i">+        let mut state = TestState::new();
</a><a href="#h15-3-9" id="h15-3-9" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap();
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
         log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
         log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
<a href="#h15-4" id="h15-4" class="h">@@ -313,7 +317,7 @@ mod tests {
</a>     // ConfirmLeader with has_committed has no effect without any calls
     fn step_confirmleader() {
         let (leader, rx) = setup();
<a href="#h15-4-3" id="h15-4-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-4-4" id="h15-4-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-5" id="h15-5" class="h">@@ -331,7 +335,7 @@ mod tests {
</a>     // ConfirmLeader without has_committed triggers replication
     fn step_confirmleader_without_has_committed() {
         let (leader, rx) = setup();
<a href="#h15-5-3" id="h15-5-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-5-4" id="h15-5-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-6" id="h15-6" class="h">@@ -357,7 +361,7 @@ mod tests {
</a>     // Heartbeats from other leaders in current term are ignored.
     fn step_heartbeat_current_term() {
         let (leader, rx) = setup();
<a href="#h15-6-3" id="h15-6-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-6-4" id="h15-6-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-7" id="h15-7" class="h">@@ -375,7 +379,7 @@ mod tests {
</a>     // Heartbeats from other leaders in future term converts to follower and steps.
     fn step_heartbeat_future_term() {
         let (leader, rx) = setup();
<a href="#h15-7-3" id="h15-7-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-7-4" id="h15-7-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-8" id="h15-8" class="h">@@ -401,7 +405,7 @@ mod tests {
</a>     // Heartbeats from other leaders in past terms are ignored.
     fn step_heartbeat_past_term() {
         let (leader, rx) = setup();
<a href="#h15-8-3" id="h15-8-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-8-4" id="h15-8-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-9" id="h15-9" class="h">@@ -418,7 +422,7 @@ mod tests {
</a>     #[test]
     fn step_acceptentries() {
         let (leader, rx) = setup();
<a href="#h15-9-3" id="h15-9-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-9-4" id="h15-9-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         node = node
             .step(Message {
<a href="#h15-10" id="h15-10" class="h">@@ -460,7 +464,7 @@ mod tests {
</a>     // Duplicate AcceptEntries from single node should not trigger commit.
     fn step_acceptentries_duplicate() {
         let (leader, rx) = setup();
<a href="#h15-10-3" id="h15-10-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-10-4" id="h15-10-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         for _ in 0..5 {
             node = node
<a href="#h15-11" id="h15-11" class="h">@@ -481,7 +485,7 @@ mod tests {
</a>     fn step_acceptentries_past_term() {
         let (leader, rx) = setup();
         let peers = leader.peers.clone();
<a href="#h15-11-3" id="h15-11-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-11-4" id="h15-11-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         for peer in peers.into_iter() {
             node = node
<a href="#h15-12" id="h15-12" class="h">@@ -502,7 +506,7 @@ mod tests {
</a>     fn step_acceptentries_future_index() {
         let (leader, rx) = setup();
         let peers = leader.peers.clone();
<a href="#h15-12-3" id="h15-12-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-12-4" id="h15-12-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         for (i, peer) in peers.into_iter().enumerate() {
             node = node
<a href="#h15-13" id="h15-13" class="h">@@ -526,7 +530,7 @@ mod tests {
</a>     fn step_rejectentries() {
         let (leader, rx) = setup();
         let entries = leader.log.range(0..).unwrap();
<a href="#h15-13-3" id="h15-13-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-13-4" id="h15-13-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         for i in 0..(entries.len() + 3) {
             node = node
<a href="#h15-14" id="h15-14" class="h">@@ -565,7 +569,7 @@ mod tests {
</a>         let (leader, rx) = setup();
         let peers = leader.peers.clone();
         let quorum = leader.quorum();
<a href="#h15-14-3" id="h15-14-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-14-4" id="h15-14-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a> 
         // Submit the mutate call from local sender, and observe it being
         // appended to log and replicated to peers. The mutate command will be
<a href="#h15-15" id="h15-15" class="h">@@ -744,7 +748,7 @@ mod tests {
</a>     fn tick() {
         let (leader, rx) = setup();
         let peers = leader.peers.clone();
<a href="#h15-15-3" id="h15-15-3" class="d">-        let mut node: Node = leader.into();
</a><a href="#h15-15-4" id="h15-15-4" class="i">+        let mut node: Node&lt;_, _&gt; = leader.into();
</a>         for _ in 0..5 {
             for _ in 0..HEARTBEAT_INTERVAL {
                 assert_messages(&amp;rx, vec![]);
<b>diff --git a/<a id="h16" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -27,21 +27,21 @@ const ELECTION_TIMEOUT_MAX: u64 = 15 * HEARTBEAT_INTERVAL;
</a> 
 /// The local Raft node state machine.
 #[derive(Debug)]
<a href="#h16-0-3" id="h16-0-3" class="d">-pub enum Node {
</a><a href="#h16-0-4" id="h16-0-4" class="d">-    Candidate(RoleNode&lt;Candidate&gt;),
</a><a href="#h16-0-5" id="h16-0-5" class="d">-    Follower(RoleNode&lt;Follower&gt;),
</a><a href="#h16-0-6" id="h16-0-6" class="d">-    Leader(RoleNode&lt;Leader&gt;),
</a><a href="#h16-0-7" id="h16-0-7" class="i">+pub enum Node&lt;L: kv::storage::Storage, S: State&gt; {
</a><a href="#h16-0-8" id="h16-0-8" class="i">+    Candidate(RoleNode&lt;Candidate, L, S&gt;),
</a><a href="#h16-0-9" id="h16-0-9" class="i">+    Follower(RoleNode&lt;Follower, L, S&gt;),
</a><a href="#h16-0-10" id="h16-0-10" class="i">+    Leader(RoleNode&lt;Leader, L, S&gt;),
</a> }
 
<a href="#h16-0-13" id="h16-0-13" class="d">-impl Node {
</a><a href="#h16-0-14" id="h16-0-14" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; Node&lt;L, S&gt; {
</a>     /// Creates a new Raft node, starting as a follower, or leader if no peers.
<a href="#h16-0-16" id="h16-0-16" class="d">-    pub fn new&lt;L: kv::Store, S: State&gt;(
</a><a href="#h16-0-17" id="h16-0-17" class="i">+    pub fn new(
</a>         id: &amp;str,
         peers: Vec&lt;String&gt;,
<a href="#h16-0-20" id="h16-0-20" class="d">-        logstore: L,
</a><a href="#h16-0-21" id="h16-0-21" class="i">+        logstore: kv::Simple&lt;L&gt;,
</a>         state: S,
         sender: Sender&lt;Message&gt;,
<a href="#h16-0-24" id="h16-0-24" class="d">-    ) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h16-0-25" id="h16-0-25" class="i">+    ) -&gt; Result&lt;Self, Error&gt; {
</a>         let log = Log::new(logstore)?;
         let (term, voted_for) = log.load_term()?;
         let node = RoleNode {
<a href="#h16-1" id="h16-1" class="h">@@ -49,7 +49,7 @@ impl Node {
</a>             peers,
             term,
             log,
<a href="#h16-1-3" id="h16-1-3" class="d">-            state: Box::new(state),
</a><a href="#h16-1-4" id="h16-1-4" class="i">+            state,
</a>             sender,
             role: Follower::new(None, voted_for.as_deref()),
         };
<a href="#h16-2" id="h16-2" class="h">@@ -63,7 +63,7 @@ impl Node {
</a>     }
 
     /// Processes a message.
<a href="#h16-2-3" id="h16-2-3" class="d">-    pub fn step(self, msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h16-2-4" id="h16-2-4" class="i">+    pub fn step(self, msg: Message) -&gt; Result&lt;Self, Error&gt; {
</a>         debug!(&quot;Stepping {:?}&quot;, msg);
         match self {
             Node::Candidate(n) =&gt; n.step(msg),
<a href="#h16-3" id="h16-3" class="h">@@ -73,7 +73,7 @@ impl Node {
</a>     }
 
     /// Moves time forward by a tick.
<a href="#h16-3-3" id="h16-3-3" class="d">-    pub fn tick(self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h16-3-4" id="h16-3-4" class="i">+    pub fn tick(self) -&gt; Result&lt;Self, Error&gt; {
</a>         match self {
             Node::Candidate(n) =&gt; n.tick(),
             Node::Follower(n) =&gt; n.tick(),
<a href="#h16-4" id="h16-4" class="h">@@ -82,39 +82,39 @@ impl Node {
</a>     }
 }
 
<a href="#h16-4-3" id="h16-4-3" class="d">-impl From&lt;RoleNode&lt;Candidate&gt;&gt; for Node {
</a><a href="#h16-4-4" id="h16-4-4" class="d">-    fn from(rn: RoleNode&lt;Candidate&gt;) -&gt; Self {
</a><a href="#h16-4-5" id="h16-4-5" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Candidate, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h16-4-6" id="h16-4-6" class="i">+    fn from(rn: RoleNode&lt;Candidate, L, S&gt;) -&gt; Self {
</a>         Node::Candidate(rn)
     }
 }
 
<a href="#h16-4-11" id="h16-4-11" class="d">-impl From&lt;RoleNode&lt;Follower&gt;&gt; for Node {
</a><a href="#h16-4-12" id="h16-4-12" class="d">-    fn from(rn: RoleNode&lt;Follower&gt;) -&gt; Self {
</a><a href="#h16-4-13" id="h16-4-13" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Follower, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h16-4-14" id="h16-4-14" class="i">+    fn from(rn: RoleNode&lt;Follower, L, S&gt;) -&gt; Self {
</a>         Node::Follower(rn)
     }
 }
 
<a href="#h16-4-19" id="h16-4-19" class="d">-impl From&lt;RoleNode&lt;Leader&gt;&gt; for Node {
</a><a href="#h16-4-20" id="h16-4-20" class="d">-    fn from(rn: RoleNode&lt;Leader&gt;) -&gt; Self {
</a><a href="#h16-4-21" id="h16-4-21" class="i">+impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Leader, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h16-4-22" id="h16-4-22" class="i">+    fn from(rn: RoleNode&lt;Leader, L, S&gt;) -&gt; Self {
</a>         Node::Leader(rn)
     }
 }
 
 // A Raft node with role R
 #[derive(Debug)]
<a href="#h16-4-29" id="h16-4-29" class="d">-pub struct RoleNode&lt;R&gt; {
</a><a href="#h16-4-30" id="h16-4-30" class="i">+pub struct RoleNode&lt;R, L: kv::storage::Storage, S: State&gt; {
</a>     id: String,
     peers: Vec&lt;String&gt;,
     term: u64,
<a href="#h16-4-34" id="h16-4-34" class="d">-    log: Log,
</a><a href="#h16-4-35" id="h16-4-35" class="d">-    state: Box&lt;dyn State&gt;,
</a><a href="#h16-4-36" id="h16-4-36" class="i">+    log: Log&lt;L&gt;,
</a><a href="#h16-4-37" id="h16-4-37" class="i">+    state: S,
</a>     sender: Sender&lt;Message&gt;,
     role: R,
 }
 
<a href="#h16-4-42" id="h16-4-42" class="d">-impl&lt;R&gt; RoleNode&lt;R&gt; {
</a><a href="#h16-4-43" id="h16-4-43" class="i">+impl&lt;R, L: kv::storage::Storage, S: State&gt; RoleNode&lt;R, L, S&gt; {
</a>     /// Transforms the node into another role.
<a href="#h16-4-45" id="h16-4-45" class="d">-    fn become_role&lt;T&gt;(self, role: T) -&gt; Result&lt;RoleNode&lt;T&gt;, Error&gt; {
</a><a href="#h16-4-46" id="h16-4-46" class="i">+    fn become_role&lt;T&gt;(self, role: T) -&gt; Result&lt;RoleNode&lt;T, L, S&gt;, Error&gt; {
</a>         Ok(RoleNode {
             id: self.id,
             peers: self.peers,
<a href="#h16-5" id="h16-5" class="h">@@ -179,16 +179,16 @@ mod tests {
</a>     use super::*;
     use crossbeam_channel::Receiver;
 
<a href="#h16-5-3" id="h16-5-3" class="d">-    pub struct NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h16-5-4" id="h16-5-4" class="d">-        node: &amp;&#39;a Node,
</a><a href="#h16-5-5" id="h16-5-5" class="i">+    pub struct NodeAsserter&lt;&#39;a, L: kv::storage::Storage, S: State&gt; {
</a><a href="#h16-5-6" id="h16-5-6" class="i">+        node: &amp;&#39;a Node&lt;L, S&gt;,
</a>     }
 
<a href="#h16-5-9" id="h16-5-9" class="d">-    impl&lt;&#39;a&gt; NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h16-5-10" id="h16-5-10" class="d">-        pub fn new(node: &amp;&#39;a Node) -&gt; Self {
</a><a href="#h16-5-11" id="h16-5-11" class="i">+    impl&lt;&#39;a, L: kv::storage::Storage, S: State&gt; NodeAsserter&lt;&#39;a, L, S&gt; {
</a><a href="#h16-5-12" id="h16-5-12" class="i">+        pub fn new(node: &amp;&#39;a Node&lt;L, S&gt;) -&gt; Self {
</a>             Self { node }
         }
 
<a href="#h16-5-16" id="h16-5-16" class="d">-        fn log(&amp;self) -&gt; &amp;&#39;a Log {
</a><a href="#h16-5-17" id="h16-5-17" class="i">+        fn log(&amp;self) -&gt; &amp;&#39;a Log&lt;L&gt; {
</a>             match self.node {
                 Node::Candidate(n) =&gt; &amp;n.log,
                 Node::Follower(n) =&gt; &amp;n.log,
<a href="#h16-6" id="h16-6" class="h">@@ -306,23 +306,25 @@ mod tests {
</a>         }
     }
 
<a href="#h16-6-3" id="h16-6-3" class="d">-    pub fn assert_node(node: &amp;Node) -&gt; NodeAsserter {
</a><a href="#h16-6-4" id="h16-6-4" class="i">+    pub fn assert_node&lt;L: kv::storage::Storage, S: State&gt;(node: &amp;Node&lt;L, S&gt;) -&gt; NodeAsserter&lt;L, S&gt; {
</a>         NodeAsserter::new(node)
     }
 
<a href="#h16-6-8" id="h16-6-8" class="d">-    fn setup_rolenode() -&gt; (RoleNode&lt;()&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h16-6-9" id="h16-6-9" class="i">+    fn setup_rolenode() -&gt; (RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a>         setup_rolenode_peers(vec![&quot;b&quot;.into(), &quot;c&quot;.into()])
     }
 
<a href="#h16-6-13" id="h16-6-13" class="d">-    fn setup_rolenode_peers(peers: Vec&lt;String&gt;) -&gt; (RoleNode&lt;()&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h16-6-14" id="h16-6-14" class="i">+    fn setup_rolenode_peers(
</a><a href="#h16-6-15" id="h16-6-15" class="i">+        peers: Vec&lt;String&gt;,
</a><a href="#h16-6-16" id="h16-6-16" class="i">+    ) -&gt; (RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;) {
</a>         let (sender, receiver) = crossbeam_channel::unbounded();
         let node = RoleNode {
             role: (),
             id: &quot;a&quot;.into(),
             peers,
             term: 1,
<a href="#h16-6-23" id="h16-6-23" class="d">-            log: Log::new(kv::Memory::new()).unwrap(),
</a><a href="#h16-6-24" id="h16-6-24" class="d">-            state: TestState::new().boxed(),
</a><a href="#h16-6-25" id="h16-6-25" class="i">+            log: Log::new(kv::Simple::new(kv::storage::Memory::new())).unwrap(),
</a><a href="#h16-6-26" id="h16-6-26" class="i">+            state: TestState::new(),
</a>             sender,
         };
         (node, receiver)
<a href="#h16-7" id="h16-7" class="h">@@ -334,7 +336,7 @@ mod tests {
</a>         let node = Node::new(
             &quot;a&quot;,
             vec![&quot;b&quot;.into(), &quot;c&quot;.into()],
<a href="#h16-7-3" id="h16-7-3" class="d">-            kv::Memory::new(),
</a><a href="#h16-7-4" id="h16-7-4" class="i">+            kv::Simple::new(kv::storage::Memory::new()),
</a>             TestState::new(),
             sender,
         )
<a href="#h16-8" id="h16-8" class="h">@@ -352,7 +354,7 @@ mod tests {
</a>     #[test]
     fn new_loads_term() {
         let (sender, _) = crossbeam_channel::unbounded();
<a href="#h16-8-3" id="h16-8-3" class="d">-        let store = kv::Memory::new();
</a><a href="#h16-8-4" id="h16-8-4" class="i">+        let store = kv::Simple::new(kv::storage::Memory::new());
</a>         Log::new(store.clone()).unwrap().save_term(3, Some(&quot;c&quot;)).unwrap();
         let node =
             Node::new(&quot;a&quot;, vec![&quot;b&quot;.into(), &quot;c&quot;.into()], store, TestState::new(), sender).unwrap();
<a href="#h16-9" id="h16-9" class="h">@@ -365,7 +367,14 @@ mod tests {
</a>     #[test]
     fn new_single() {
         let (sender, _) = crossbeam_channel::unbounded();
<a href="#h16-9-3" id="h16-9-3" class="d">-        let node = Node::new(&quot;a&quot;, vec![], kv::Memory::new(), TestState::new(), sender).unwrap();
</a><a href="#h16-9-4" id="h16-9-4" class="i">+        let node = Node::new(
</a><a href="#h16-9-5" id="h16-9-5" class="i">+            &quot;a&quot;,
</a><a href="#h16-9-6" id="h16-9-6" class="i">+            vec![],
</a><a href="#h16-9-7" id="h16-9-7" class="i">+            kv::Simple::new(kv::storage::Memory::new()),
</a><a href="#h16-9-8" id="h16-9-8" class="i">+            TestState::new(),
</a><a href="#h16-9-9" id="h16-9-9" class="i">+            sender,
</a><a href="#h16-9-10" id="h16-9-10" class="i">+        )
</a><a href="#h16-9-11" id="h16-9-11" class="i">+        .unwrap();
</a>         match node {
             Node::Leader(rolenode) =&gt; {
                 assert_eq!(rolenode.id, &quot;a&quot;.to_owned());
<b>diff --git a/<a id="h17" href="../file/src/server/mod.rs.html">src/server/mod.rs</a> b/<a href="../file/src/server/mod.rs.html">src/server/mod.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -6,7 +6,7 @@ use crate::error::Error;
</a> use crate::kv;
 use crate::raft::Raft;
 use crate::service;
<a href="#h17-0-3" id="h17-0-3" class="d">-use crate::sql::Storage;
</a><a href="#h17-0-4" id="h17-0-4" class="i">+use crate::sql;
</a> 
 use std::collections::HashMap;
 
<a href="#h17-1" id="h17-1" class="h">@@ -32,27 +32,27 @@ impl Server {
</a>         let raft = Raft::start(
             &amp;self.id,
             self.peers.keys().cloned().collect(),
<a href="#h17-1-3" id="h17-1-3" class="d">-            kv::Raft::new_state(kv::File::new(
</a><a href="#h17-1-4" id="h17-1-4" class="i">+            sql::engine::Raft::new_state(kv::MVCC::new(kv::storage::File::new(
</a>                 std::fs::OpenOptions::new()
                     .read(true)
                     .write(true)
                     .create(true)
                     .open(data_path.join(&quot;state&quot;))?,
<a href="#h17-1-10" id="h17-1-10" class="d">-            )?),
</a><a href="#h17-1-11" id="h17-1-11" class="d">-            kv::File::new(
</a><a href="#h17-1-12" id="h17-1-12" class="i">+            )?)),
</a><a href="#h17-1-13" id="h17-1-13" class="i">+            kv::Simple::new(kv::storage::File::new(
</a>                 std::fs::OpenOptions::new()
                     .read(true)
                     .write(true)
                     .create(true)
                     .open(data_path.join(&quot;raft&quot;))?,
<a href="#h17-1-19" id="h17-1-19" class="d">-            )?,
</a><a href="#h17-1-20" id="h17-1-20" class="i">+            )?),
</a>             raft_transport,
         )?;
 
         server.add_service(service::ToyDBServer::new_service_def(ToyDB {
             id: self.id.clone(),
             raft: raft.clone(),
<a href="#h17-1-27" id="h17-1-27" class="d">-            storage: Box::new(Storage::new(kv::Raft::new(raft.clone()))),
</a><a href="#h17-1-28" id="h17-1-28" class="i">+            engine: sql::engine::Raft::new(raft.clone()),
</a>         }));
         let _s = server.build()?;
 
<b>diff --git a/<a id="h18" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -4,11 +4,13 @@ use crate::sql;
</a> use crate::sql::types::{Row, Value};
 use crate::utility::serialize;
 use crate::Error;
<a href="#h18-0-3" id="h18-0-3" class="i">+use sql::engine::Engine;
</a><a href="#h18-0-4" id="h18-0-4" class="i">+use sql::engine::Transaction;
</a> 
 pub struct ToyDB {
     pub id: String,
     pub raft: Raft,
<a href="#h18-0-9" id="h18-0-9" class="d">-    pub storage: Box&lt;sql::Storage&gt;,
</a><a href="#h18-0-10" id="h18-0-10" class="i">+    pub engine: sql::engine::Raft,
</a> }
 
 impl service::ToyDB for ToyDB {
<a href="#h18-1" id="h18-1" class="h">@@ -18,7 +20,8 @@ impl service::ToyDB for ToyDB {
</a>         req: service::GetTableRequest,
     ) -&gt; grpc::SingleResponse&lt;service::GetTableResponse&gt; {
         let mut resp = service::GetTableResponse::new();
<a href="#h18-1-3" id="h18-1-3" class="d">-        match self.storage.get_table(&amp;req.name) {
</a><a href="#h18-1-4" id="h18-1-4" class="i">+        let txn = self.engine.begin().unwrap();
</a><a href="#h18-1-5" id="h18-1-5" class="i">+        match txn.read_table(&amp;req.name) {
</a>             Ok(Some(schema)) =&gt; resp.sql = schema.to_query(),
             Ok(None) =&gt; {
                 resp.error = Self::error_to_protobuf(Error::Value(format!(
<a href="#h18-2" id="h18-2" class="h">@@ -28,6 +31,7 @@ impl service::ToyDB for ToyDB {
</a>             }
             Err(err) =&gt; resp.error = Self::error_to_protobuf(err),
         };
<a href="#h18-2-3" id="h18-2-3" class="i">+        txn.rollback().unwrap();
</a>         grpc::SingleResponse::completed(resp)
     }
 
<a href="#h18-3" id="h18-3" class="h">@@ -37,10 +41,15 @@ impl service::ToyDB for ToyDB {
</a>         _: service::Empty,
     ) -&gt; grpc::SingleResponse&lt;service::ListTablesResponse&gt; {
         let mut resp = service::ListTablesResponse::new();
<a href="#h18-3-3" id="h18-3-3" class="d">-        match self.storage.list_tables() {
</a><a href="#h18-3-4" id="h18-3-4" class="d">-            Ok(tables) =&gt; resp.name = protobuf::RepeatedField::from_vec(tables),
</a><a href="#h18-3-5" id="h18-3-5" class="i">+        let txn = self.engine.begin().unwrap();
</a><a href="#h18-3-6" id="h18-3-6" class="i">+        match txn.list_tables() {
</a><a href="#h18-3-7" id="h18-3-7" class="i">+            Ok(tables) =&gt; {
</a><a href="#h18-3-8" id="h18-3-8" class="i">+                resp.name =
</a><a href="#h18-3-9" id="h18-3-9" class="i">+                    protobuf::RepeatedField::from_vec(tables.into_iter().map(|s| s.name).collect())
</a><a href="#h18-3-10" id="h18-3-10" class="i">+            }
</a>             Err(err) =&gt; resp.error = Self::error_to_protobuf(err),
         };
<a href="#h18-3-13" id="h18-3-13" class="i">+        txn.rollback().unwrap();
</a>         grpc::SingleResponse::completed(resp)
     }
 
<a href="#h18-4" id="h18-4" class="h">@@ -88,9 +97,12 @@ impl service::ToyDB for ToyDB {
</a> impl ToyDB {
     /// Executes an SQL statement
     fn execute(&amp;self, query: &amp;str) -&gt; Result&lt;sql::types::ResultSet, Error&gt; {
<a href="#h18-4-3" id="h18-4-3" class="d">-        sql::Plan::build(sql::Parser::new(query).parse()?)?
</a><a href="#h18-4-4" id="h18-4-4" class="i">+        let mut txn = self.engine.begin()?;
</a><a href="#h18-4-5" id="h18-4-5" class="i">+        let rs = sql::Plan::build(sql::Parser::new(query).parse()?)?
</a>             .optimize()?
<a href="#h18-4-7" id="h18-4-7" class="d">-            .execute(sql::Context { storage: self.storage.clone() })
</a><a href="#h18-4-8" id="h18-4-8" class="i">+            .execute(sql::Context { txn: &amp;mut txn })?;
</a><a href="#h18-4-9" id="h18-4-9" class="i">+        txn.commit()?;
</a><a href="#h18-4-10" id="h18-4-10" class="i">+        Ok(rs)
</a>     }
 
     /// Converts an error into a protobuf object
<b>diff --git a/<a id="h19" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,145 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+use super::super::schema;
</a><a href="#h19-0-1" id="h19-0-1" class="i">+use super::super::types;
</a><a href="#h19-0-2" id="h19-0-2" class="i">+use crate::kv;
</a><a href="#h19-0-3" id="h19-0-3" class="i">+use crate::utility::{deserialize, serialize};
</a><a href="#h19-0-4" id="h19-0-4" class="i">+use crate::Error;
</a><a href="#h19-0-5" id="h19-0-5" class="i">+
</a><a href="#h19-0-6" id="h19-0-6" class="i">+pub struct KV&lt;S: kv::storage::Storage&gt; {
</a><a href="#h19-0-7" id="h19-0-7" class="i">+    kv: kv::MVCC&lt;S&gt;,
</a><a href="#h19-0-8" id="h19-0-8" class="i">+}
</a><a href="#h19-0-9" id="h19-0-9" class="i">+
</a><a href="#h19-0-10" id="h19-0-10" class="i">+impl&lt;S: kv::storage::Storage&gt; KV&lt;S&gt; {
</a><a href="#h19-0-11" id="h19-0-11" class="i">+    pub fn new(kv: kv::MVCC&lt;S&gt;) -&gt; Self {
</a><a href="#h19-0-12" id="h19-0-12" class="i">+        Self { kv }
</a><a href="#h19-0-13" id="h19-0-13" class="i">+    }
</a><a href="#h19-0-14" id="h19-0-14" class="i">+}
</a><a href="#h19-0-15" id="h19-0-15" class="i">+
</a><a href="#h19-0-16" id="h19-0-16" class="i">+impl&lt;S: kv::storage::Storage&gt; super::Engine for KV&lt;S&gt; {
</a><a href="#h19-0-17" id="h19-0-17" class="i">+    type Transaction = Transaction&lt;S&gt;;
</a><a href="#h19-0-18" id="h19-0-18" class="i">+
</a><a href="#h19-0-19" id="h19-0-19" class="i">+    fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h19-0-20" id="h19-0-20" class="i">+        Ok(Self::Transaction::new(self.kv.begin()?))
</a><a href="#h19-0-21" id="h19-0-21" class="i">+    }
</a><a href="#h19-0-22" id="h19-0-22" class="i">+}
</a><a href="#h19-0-23" id="h19-0-23" class="i">+
</a><a href="#h19-0-24" id="h19-0-24" class="i">+pub struct Transaction&lt;S: kv::storage::Storage&gt; {
</a><a href="#h19-0-25" id="h19-0-25" class="i">+    txn: kv::Transaction&lt;S&gt;,
</a><a href="#h19-0-26" id="h19-0-26" class="i">+}
</a><a href="#h19-0-27" id="h19-0-27" class="i">+
</a><a href="#h19-0-28" id="h19-0-28" class="i">+impl&lt;S: kv::storage::Storage&gt; Transaction&lt;S&gt; {
</a><a href="#h19-0-29" id="h19-0-29" class="i">+    fn new(txn: kv::Transaction&lt;S&gt;) -&gt; Self {
</a><a href="#h19-0-30" id="h19-0-30" class="i">+        Self { txn }
</a><a href="#h19-0-31" id="h19-0-31" class="i">+    }
</a><a href="#h19-0-32" id="h19-0-32" class="i">+}
</a><a href="#h19-0-33" id="h19-0-33" class="i">+
</a><a href="#h19-0-34" id="h19-0-34" class="i">+impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a><a href="#h19-0-35" id="h19-0-35" class="i">+    fn id(&amp;self) -&gt; u64 {
</a><a href="#h19-0-36" id="h19-0-36" class="i">+        self.txn.id()
</a><a href="#h19-0-37" id="h19-0-37" class="i">+    }
</a><a href="#h19-0-38" id="h19-0-38" class="i">+
</a><a href="#h19-0-39" id="h19-0-39" class="i">+    fn commit(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-40" id="h19-0-40" class="i">+        self.txn.commit()
</a><a href="#h19-0-41" id="h19-0-41" class="i">+    }
</a><a href="#h19-0-42" id="h19-0-42" class="i">+
</a><a href="#h19-0-43" id="h19-0-43" class="i">+    fn rollback(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-44" id="h19-0-44" class="i">+        self.txn.rollback()
</a><a href="#h19-0-45" id="h19-0-45" class="i">+    }
</a><a href="#h19-0-46" id="h19-0-46" class="i">+
</a><a href="#h19-0-47" id="h19-0-47" class="i">+    fn create(&amp;mut self, table: &amp;str, row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-48" id="h19-0-48" class="i">+        let table = self
</a><a href="#h19-0-49" id="h19-0-49" class="i">+            .read_table(&amp;table)?
</a><a href="#h19-0-50" id="h19-0-50" class="i">+            .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
</a><a href="#h19-0-51" id="h19-0-51" class="i">+        table.validate_row(&amp;row)?;
</a><a href="#h19-0-52" id="h19-0-52" class="i">+        let pk = row.get(table.primary_key).unwrap();
</a><a href="#h19-0-53" id="h19-0-53" class="i">+        if self.read(&amp;table.name, &amp;pk)?.is_some() {
</a><a href="#h19-0-54" id="h19-0-54" class="i">+            return Err(Error::Value(format!(
</a><a href="#h19-0-55" id="h19-0-55" class="i">+                &quot;Primary key {} already exists for table {}&quot;,
</a><a href="#h19-0-56" id="h19-0-56" class="i">+                pk, table.name
</a><a href="#h19-0-57" id="h19-0-57" class="i">+            )));
</a><a href="#h19-0-58" id="h19-0-58" class="i">+        }
</a><a href="#h19-0-59" id="h19-0-59" class="i">+        self.txn.set(&amp;Key::Row(&amp;table.name, &amp;pk).encode(), serialize(row)?)?;
</a><a href="#h19-0-60" id="h19-0-60" class="i">+        Ok(())
</a><a href="#h19-0-61" id="h19-0-61" class="i">+    }
</a><a href="#h19-0-62" id="h19-0-62" class="i">+
</a><a href="#h19-0-63" id="h19-0-63" class="i">+    fn delete(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-64" id="h19-0-64" class="i">+        self.txn.delete(&amp;Key::Row(table, id).encode())
</a><a href="#h19-0-65" id="h19-0-65" class="i">+    }
</a><a href="#h19-0-66" id="h19-0-66" class="i">+
</a><a href="#h19-0-67" id="h19-0-67" class="i">+    fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
</a><a href="#h19-0-68" id="h19-0-68" class="i">+        self.txn.get(&amp;Key::Row(table, id).encode())?.map(deserialize).transpose()
</a><a href="#h19-0-69" id="h19-0-69" class="i">+    }
</a><a href="#h19-0-70" id="h19-0-70" class="i">+
</a><a href="#h19-0-71" id="h19-0-71" class="i">+    fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
</a><a href="#h19-0-72" id="h19-0-72" class="i">+        let from = Key::RowStart(table).encode();
</a><a href="#h19-0-73" id="h19-0-73" class="i">+        let to = Key::RowEnd(table).encode();
</a><a href="#h19-0-74" id="h19-0-74" class="i">+        Ok(Box::new(self.txn.scan(&amp;from..&amp;to)?.map(|res| match res {
</a><a href="#h19-0-75" id="h19-0-75" class="i">+            Ok((_, v)) =&gt; deserialize(v),
</a><a href="#h19-0-76" id="h19-0-76" class="i">+            Err(err) =&gt; Err(err),
</a><a href="#h19-0-77" id="h19-0-77" class="i">+        })))
</a><a href="#h19-0-78" id="h19-0-78" class="i">+    }
</a><a href="#h19-0-79" id="h19-0-79" class="i">+
</a><a href="#h19-0-80" id="h19-0-80" class="i">+    fn update(&amp;mut self, table: &amp;str, id: &amp;types::Value, row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-81" id="h19-0-81" class="i">+        // FIXME For now, we&#39;re lazy and just do a delete + create
</a><a href="#h19-0-82" id="h19-0-82" class="i">+        self.delete(table, id)?;
</a><a href="#h19-0-83" id="h19-0-83" class="i">+        self.create(table, row)
</a><a href="#h19-0-84" id="h19-0-84" class="i">+    }
</a><a href="#h19-0-85" id="h19-0-85" class="i">+
</a><a href="#h19-0-86" id="h19-0-86" class="i">+    fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-87" id="h19-0-87" class="i">+        if self.read_table(&amp;table.name)?.is_some() {
</a><a href="#h19-0-88" id="h19-0-88" class="i">+            return Err(Error::Value(format!(&quot;Table {} already exists&quot;, table.name)));
</a><a href="#h19-0-89" id="h19-0-89" class="i">+        }
</a><a href="#h19-0-90" id="h19-0-90" class="i">+        self.txn.set(&amp;Key::Table(&amp;table.name).encode(), serialize(table)?)
</a><a href="#h19-0-91" id="h19-0-91" class="i">+    }
</a><a href="#h19-0-92" id="h19-0-92" class="i">+
</a><a href="#h19-0-93" id="h19-0-93" class="i">+    fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h19-0-94" id="h19-0-94" class="i">+        if self.read_table(table)?.is_none() {
</a><a href="#h19-0-95" id="h19-0-95" class="i">+            return Err(Error::Value(format!(&quot;Table {} does not exist&quot;, table)));
</a><a href="#h19-0-96" id="h19-0-96" class="i">+        }
</a><a href="#h19-0-97" id="h19-0-97" class="i">+        // FIXME Needs to delete all table data as well
</a><a href="#h19-0-98" id="h19-0-98" class="i">+        self.txn.delete(&amp;Key::Table(table).encode())
</a><a href="#h19-0-99" id="h19-0-99" class="i">+    }
</a><a href="#h19-0-100" id="h19-0-100" class="i">+
</a><a href="#h19-0-101" id="h19-0-101" class="i">+    fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h19-0-102" id="h19-0-102" class="i">+        self.txn
</a><a href="#h19-0-103" id="h19-0-103" class="i">+            .scan(&amp;Key::TableStart.encode()..&amp;Key::TableEnd.encode())?
</a><a href="#h19-0-104" id="h19-0-104" class="i">+            .collect::&lt;Result&lt;Vec&lt;_&gt;, Error&gt;&gt;()?
</a><a href="#h19-0-105" id="h19-0-105" class="i">+            .into_iter()
</a><a href="#h19-0-106" id="h19-0-106" class="i">+            .map(|(_, v)| deserialize(v))
</a><a href="#h19-0-107" id="h19-0-107" class="i">+            .collect()
</a><a href="#h19-0-108" id="h19-0-108" class="i">+    }
</a><a href="#h19-0-109" id="h19-0-109" class="i">+
</a><a href="#h19-0-110" id="h19-0-110" class="i">+    fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h19-0-111" id="h19-0-111" class="i">+        self.txn.get(&amp;Key::Table(table).encode())?.map(deserialize).transpose()
</a><a href="#h19-0-112" id="h19-0-112" class="i">+    }
</a><a href="#h19-0-113" id="h19-0-113" class="i">+}
</a><a href="#h19-0-114" id="h19-0-114" class="i">+
</a><a href="#h19-0-115" id="h19-0-115" class="i">+enum Key&lt;&#39;a&gt; {
</a><a href="#h19-0-116" id="h19-0-116" class="i">+    TableStart,
</a><a href="#h19-0-117" id="h19-0-117" class="i">+    Table(&amp;&#39;a str),
</a><a href="#h19-0-118" id="h19-0-118" class="i">+    TableEnd,
</a><a href="#h19-0-119" id="h19-0-119" class="i">+    RowStart(&amp;&#39;a str),
</a><a href="#h19-0-120" id="h19-0-120" class="i">+    Row(&amp;&#39;a str, &amp;&#39;a types::Value),
</a><a href="#h19-0-121" id="h19-0-121" class="i">+    RowEnd(&amp;&#39;a str),
</a><a href="#h19-0-122" id="h19-0-122" class="i">+}
</a><a href="#h19-0-123" id="h19-0-123" class="i">+
</a><a href="#h19-0-124" id="h19-0-124" class="i">+impl&lt;&#39;a&gt; Key&lt;&#39;a&gt; {
</a><a href="#h19-0-125" id="h19-0-125" class="i">+    fn encode(self) -&gt; Vec&lt;u8&gt; {
</a><a href="#h19-0-126" id="h19-0-126" class="i">+        match self {
</a><a href="#h19-0-127" id="h19-0-127" class="i">+            Self::TableStart =&gt; vec![0x01],
</a><a href="#h19-0-128" id="h19-0-128" class="i">+            Self::Table(name) =&gt; [vec![0x01], name.as_bytes().to_vec()].concat(),
</a><a href="#h19-0-129" id="h19-0-129" class="i">+            Self::TableEnd =&gt; vec![0x02],
</a><a href="#h19-0-130" id="h19-0-130" class="i">+            Self::RowStart(table) =&gt; [vec![0x03], table.as_bytes().to_vec(), vec![0x00]].concat(),
</a><a href="#h19-0-131" id="h19-0-131" class="i">+            Self::Row(table, pk) =&gt; [
</a><a href="#h19-0-132" id="h19-0-132" class="i">+                vec![0x03],
</a><a href="#h19-0-133" id="h19-0-133" class="i">+                table.as_bytes().to_vec(),
</a><a href="#h19-0-134" id="h19-0-134" class="i">+                vec![0x00],
</a><a href="#h19-0-135" id="h19-0-135" class="i">+                match pk {
</a><a href="#h19-0-136" id="h19-0-136" class="i">+                    types::Value::Integer(i) =&gt; i.to_be_bytes().to_vec(),
</a><a href="#h19-0-137" id="h19-0-137" class="i">+                    _ =&gt; unimplemented!(),
</a><a href="#h19-0-138" id="h19-0-138" class="i">+                },
</a><a href="#h19-0-139" id="h19-0-139" class="i">+            ]
</a><a href="#h19-0-140" id="h19-0-140" class="i">+            .concat(),
</a><a href="#h19-0-141" id="h19-0-141" class="i">+            Self::RowEnd(table) =&gt; [vec![0x03], table.as_bytes().to_vec(), vec![0xff]].concat(),
</a><a href="#h19-0-142" id="h19-0-142" class="i">+        }
</a><a href="#h19-0-143" id="h19-0-143" class="i">+    }
</a><a href="#h19-0-144" id="h19-0-144" class="i">+}
</a><b>diff --git a/<a id="h20" href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a> b/<a href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,35 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+mod kv;
</a><a href="#h20-0-1" id="h20-0-1" class="i">+mod raft;
</a><a href="#h20-0-2" id="h20-0-2" class="i">+
</a><a href="#h20-0-3" id="h20-0-3" class="i">+pub use kv::KV;
</a><a href="#h20-0-4" id="h20-0-4" class="i">+pub use raft::Raft;
</a><a href="#h20-0-5" id="h20-0-5" class="i">+
</a><a href="#h20-0-6" id="h20-0-6" class="i">+use super::schema;
</a><a href="#h20-0-7" id="h20-0-7" class="i">+use super::types;
</a><a href="#h20-0-8" id="h20-0-8" class="i">+use crate::Error;
</a><a href="#h20-0-9" id="h20-0-9" class="i">+
</a><a href="#h20-0-10" id="h20-0-10" class="i">+pub trait Engine {
</a><a href="#h20-0-11" id="h20-0-11" class="i">+    type Transaction: Transaction;
</a><a href="#h20-0-12" id="h20-0-12" class="i">+
</a><a href="#h20-0-13" id="h20-0-13" class="i">+    fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt;;
</a><a href="#h20-0-14" id="h20-0-14" class="i">+}
</a><a href="#h20-0-15" id="h20-0-15" class="i">+
</a><a href="#h20-0-16" id="h20-0-16" class="i">+pub trait Transaction {
</a><a href="#h20-0-17" id="h20-0-17" class="i">+    fn id(&amp;self) -&gt; u64;
</a><a href="#h20-0-18" id="h20-0-18" class="i">+    fn commit(self) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-19" id="h20-0-19" class="i">+    fn rollback(self) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-20" id="h20-0-20" class="i">+
</a><a href="#h20-0-21" id="h20-0-21" class="i">+    fn create(&amp;mut self, table: &amp;str, row: types::Row) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-22" id="h20-0-22" class="i">+    fn delete(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-23" id="h20-0-23" class="i">+    fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt;;
</a><a href="#h20-0-24" id="h20-0-24" class="i">+    fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;Scan, Error&gt;;
</a><a href="#h20-0-25" id="h20-0-25" class="i">+    fn update(&amp;mut self, table: &amp;str, id: &amp;types::Value, row: types::Row) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-26" id="h20-0-26" class="i">+
</a><a href="#h20-0-27" id="h20-0-27" class="i">+    fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-28" id="h20-0-28" class="i">+    fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-29" id="h20-0-29" class="i">+    fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt;;
</a><a href="#h20-0-30" id="h20-0-30" class="i">+    fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt;;
</a><a href="#h20-0-31" id="h20-0-31" class="i">+}
</a><a href="#h20-0-32" id="h20-0-32" class="i">+
</a><a href="#h20-0-33" id="h20-0-33" class="i">+pub type Scan =
</a><a href="#h20-0-34" id="h20-0-34" class="i">+    Box&lt;dyn DoubleEndedIterator&lt;Item = Result&lt;types::Row, Error&gt;&gt; + Sync + Send + &#39;static&gt;;
</a><b>diff --git a/<a id="h21" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,264 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+use super::super::schema;
</a><a href="#h21-0-1" id="h21-0-1" class="i">+use super::super::types;
</a><a href="#h21-0-2" id="h21-0-2" class="i">+use super::Engine as _;
</a><a href="#h21-0-3" id="h21-0-3" class="i">+use super::Transaction as _;
</a><a href="#h21-0-4" id="h21-0-4" class="i">+use crate::kv;
</a><a href="#h21-0-5" id="h21-0-5" class="i">+use crate::raft;
</a><a href="#h21-0-6" id="h21-0-6" class="i">+use crate::utility::{deserialize, serialize};
</a><a href="#h21-0-7" id="h21-0-7" class="i">+use crate::Error;
</a><a href="#h21-0-8" id="h21-0-8" class="i">+use std::collections::HashMap;
</a><a href="#h21-0-9" id="h21-0-9" class="i">+
</a><a href="#h21-0-10" id="h21-0-10" class="i">+/// A state machine mutation
</a><a href="#h21-0-11" id="h21-0-11" class="i">+#[derive(Clone, Debug, Serialize, Deserialize)]
</a><a href="#h21-0-12" id="h21-0-12" class="i">+enum Mutation {
</a><a href="#h21-0-13" id="h21-0-13" class="i">+    Begin,
</a><a href="#h21-0-14" id="h21-0-14" class="i">+    Commit(u64),
</a><a href="#h21-0-15" id="h21-0-15" class="i">+    Rollback(u64),
</a><a href="#h21-0-16" id="h21-0-16" class="i">+
</a><a href="#h21-0-17" id="h21-0-17" class="i">+    Create { txn_id: u64, table: String, row: types::Row },
</a><a href="#h21-0-18" id="h21-0-18" class="i">+    Delete { txn_id: u64, table: String, id: types::Value },
</a><a href="#h21-0-19" id="h21-0-19" class="i">+    Update { txn_id: u64, table: String, id: types::Value, row: types::Row },
</a><a href="#h21-0-20" id="h21-0-20" class="i">+
</a><a href="#h21-0-21" id="h21-0-21" class="i">+    CreateTable { txn_id: u64, schema: schema::Table },
</a><a href="#h21-0-22" id="h21-0-22" class="i">+    DeleteTable { txn_id: u64, table: String },
</a><a href="#h21-0-23" id="h21-0-23" class="i">+}
</a><a href="#h21-0-24" id="h21-0-24" class="i">+
</a><a href="#h21-0-25" id="h21-0-25" class="i">+/// A state machine query
</a><a href="#h21-0-26" id="h21-0-26" class="i">+#[derive(Clone, Debug, Serialize, Deserialize)]
</a><a href="#h21-0-27" id="h21-0-27" class="i">+enum Query {
</a><a href="#h21-0-28" id="h21-0-28" class="i">+    Read { txn_id: u64, table: String, id: types::Value },
</a><a href="#h21-0-29" id="h21-0-29" class="i">+    Scan { txn_id: u64, table: String },
</a><a href="#h21-0-30" id="h21-0-30" class="i">+
</a><a href="#h21-0-31" id="h21-0-31" class="i">+    ListTables { txn_id: u64 },
</a><a href="#h21-0-32" id="h21-0-32" class="i">+    ReadTable { txn_id: u64, table: String },
</a><a href="#h21-0-33" id="h21-0-33" class="i">+}
</a><a href="#h21-0-34" id="h21-0-34" class="i">+
</a><a href="#h21-0-35" id="h21-0-35" class="i">+pub struct Raft {
</a><a href="#h21-0-36" id="h21-0-36" class="i">+    raft: raft::Raft,
</a><a href="#h21-0-37" id="h21-0-37" class="i">+}
</a><a href="#h21-0-38" id="h21-0-38" class="i">+
</a><a href="#h21-0-39" id="h21-0-39" class="i">+impl Raft {
</a><a href="#h21-0-40" id="h21-0-40" class="i">+    /// Creates a new SQL engine around a Raft cluster.
</a><a href="#h21-0-41" id="h21-0-41" class="i">+    pub fn new(raft: raft::Raft) -&gt; Self {
</a><a href="#h21-0-42" id="h21-0-42" class="i">+        Self { raft }
</a><a href="#h21-0-43" id="h21-0-43" class="i">+    }
</a><a href="#h21-0-44" id="h21-0-44" class="i">+
</a><a href="#h21-0-45" id="h21-0-45" class="i">+    /// Creates an underlying state machine for a Raft engine.
</a><a href="#h21-0-46" id="h21-0-46" class="i">+    pub fn new_state&lt;S: kv::storage::Storage&gt;(kv: kv::MVCC&lt;S&gt;) -&gt; State&lt;S&gt; {
</a><a href="#h21-0-47" id="h21-0-47" class="i">+        State::new(kv)
</a><a href="#h21-0-48" id="h21-0-48" class="i">+    }
</a><a href="#h21-0-49" id="h21-0-49" class="i">+}
</a><a href="#h21-0-50" id="h21-0-50" class="i">+
</a><a href="#h21-0-51" id="h21-0-51" class="i">+impl super::Engine for Raft {
</a><a href="#h21-0-52" id="h21-0-52" class="i">+    type Transaction = Transaction;
</a><a href="#h21-0-53" id="h21-0-53" class="i">+
</a><a href="#h21-0-54" id="h21-0-54" class="i">+    fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h21-0-55" id="h21-0-55" class="i">+        Transaction::new(self.raft.clone())
</a><a href="#h21-0-56" id="h21-0-56" class="i">+    }
</a><a href="#h21-0-57" id="h21-0-57" class="i">+}
</a><a href="#h21-0-58" id="h21-0-58" class="i">+
</a><a href="#h21-0-59" id="h21-0-59" class="i">+#[derive(Clone)]
</a><a href="#h21-0-60" id="h21-0-60" class="i">+pub struct Transaction {
</a><a href="#h21-0-61" id="h21-0-61" class="i">+    id: u64,
</a><a href="#h21-0-62" id="h21-0-62" class="i">+    raft: raft::Raft,
</a><a href="#h21-0-63" id="h21-0-63" class="i">+}
</a><a href="#h21-0-64" id="h21-0-64" class="i">+
</a><a href="#h21-0-65" id="h21-0-65" class="i">+impl Transaction {
</a><a href="#h21-0-66" id="h21-0-66" class="i">+    fn new(raft: raft::Raft) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h21-0-67" id="h21-0-67" class="i">+        let id = deserialize(raft.mutate(serialize(Mutation::Begin)?)?)?;
</a><a href="#h21-0-68" id="h21-0-68" class="i">+        Ok(Self { raft, id })
</a><a href="#h21-0-69" id="h21-0-69" class="i">+    }
</a><a href="#h21-0-70" id="h21-0-70" class="i">+}
</a><a href="#h21-0-71" id="h21-0-71" class="i">+
</a><a href="#h21-0-72" id="h21-0-72" class="i">+impl super::Transaction for Transaction {
</a><a href="#h21-0-73" id="h21-0-73" class="i">+    fn id(&amp;self) -&gt; u64 {
</a><a href="#h21-0-74" id="h21-0-74" class="i">+        self.id
</a><a href="#h21-0-75" id="h21-0-75" class="i">+    }
</a><a href="#h21-0-76" id="h21-0-76" class="i">+
</a><a href="#h21-0-77" id="h21-0-77" class="i">+    fn commit(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-78" id="h21-0-78" class="i">+        deserialize(self.raft.mutate(serialize(Mutation::Commit(self.id))?)?)
</a><a href="#h21-0-79" id="h21-0-79" class="i">+    }
</a><a href="#h21-0-80" id="h21-0-80" class="i">+
</a><a href="#h21-0-81" id="h21-0-81" class="i">+    fn rollback(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-82" id="h21-0-82" class="i">+        deserialize(self.raft.mutate(serialize(Mutation::Rollback(self.id))?)?)
</a><a href="#h21-0-83" id="h21-0-83" class="i">+    }
</a><a href="#h21-0-84" id="h21-0-84" class="i">+
</a><a href="#h21-0-85" id="h21-0-85" class="i">+    fn create(&amp;mut self, table: &amp;str, row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-86" id="h21-0-86" class="i">+        deserialize(self.raft.mutate(serialize(Mutation::Create {
</a><a href="#h21-0-87" id="h21-0-87" class="i">+            txn_id: self.id,
</a><a href="#h21-0-88" id="h21-0-88" class="i">+            table: table.into(),
</a><a href="#h21-0-89" id="h21-0-89" class="i">+            row,
</a><a href="#h21-0-90" id="h21-0-90" class="i">+        })?)?)
</a><a href="#h21-0-91" id="h21-0-91" class="i">+    }
</a><a href="#h21-0-92" id="h21-0-92" class="i">+
</a><a href="#h21-0-93" id="h21-0-93" class="i">+    fn delete(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-94" id="h21-0-94" class="i">+        deserialize(self.raft.mutate(serialize(Mutation::Delete {
</a><a href="#h21-0-95" id="h21-0-95" class="i">+            txn_id: self.id,
</a><a href="#h21-0-96" id="h21-0-96" class="i">+            table: table.into(),
</a><a href="#h21-0-97" id="h21-0-97" class="i">+            id: id.clone(),
</a><a href="#h21-0-98" id="h21-0-98" class="i">+        })?)?)
</a><a href="#h21-0-99" id="h21-0-99" class="i">+    }
</a><a href="#h21-0-100" id="h21-0-100" class="i">+
</a><a href="#h21-0-101" id="h21-0-101" class="i">+    fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
</a><a href="#h21-0-102" id="h21-0-102" class="i">+        deserialize(self.raft.read(serialize(Query::Read {
</a><a href="#h21-0-103" id="h21-0-103" class="i">+            txn_id: self.id,
</a><a href="#h21-0-104" id="h21-0-104" class="i">+            table: table.into(),
</a><a href="#h21-0-105" id="h21-0-105" class="i">+            id: id.clone(),
</a><a href="#h21-0-106" id="h21-0-106" class="i">+        })?)?)
</a><a href="#h21-0-107" id="h21-0-107" class="i">+    }
</a><a href="#h21-0-108" id="h21-0-108" class="i">+
</a><a href="#h21-0-109" id="h21-0-109" class="i">+    fn scan(&amp;self, table: &amp;str) -&gt; Result&lt;super::Scan, Error&gt; {
</a><a href="#h21-0-110" id="h21-0-110" class="i">+        Ok(Box::new(
</a><a href="#h21-0-111" id="h21-0-111" class="i">+            deserialize::&lt;Vec&lt;types::Row&gt;&gt;(
</a><a href="#h21-0-112" id="h21-0-112" class="i">+                self.raft.read(serialize(Query::Scan { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h21-0-113" id="h21-0-113" class="i">+            )?
</a><a href="#h21-0-114" id="h21-0-114" class="i">+            .into_iter()
</a><a href="#h21-0-115" id="h21-0-115" class="i">+            .map(Ok),
</a><a href="#h21-0-116" id="h21-0-116" class="i">+        ))
</a><a href="#h21-0-117" id="h21-0-117" class="i">+    }
</a><a href="#h21-0-118" id="h21-0-118" class="i">+
</a><a href="#h21-0-119" id="h21-0-119" class="i">+    fn update(&amp;mut self, table: &amp;str, id: &amp;types::Value, row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-120" id="h21-0-120" class="i">+        deserialize(self.raft.mutate(serialize(Mutation::Update {
</a><a href="#h21-0-121" id="h21-0-121" class="i">+            txn_id: self.id,
</a><a href="#h21-0-122" id="h21-0-122" class="i">+            table: table.into(),
</a><a href="#h21-0-123" id="h21-0-123" class="i">+            id: id.clone(),
</a><a href="#h21-0-124" id="h21-0-124" class="i">+            row,
</a><a href="#h21-0-125" id="h21-0-125" class="i">+        })?)?)
</a><a href="#h21-0-126" id="h21-0-126" class="i">+    }
</a><a href="#h21-0-127" id="h21-0-127" class="i">+
</a><a href="#h21-0-128" id="h21-0-128" class="i">+    fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-129" id="h21-0-129" class="i">+        deserialize(
</a><a href="#h21-0-130" id="h21-0-130" class="i">+            self.raft.mutate(serialize(Mutation::CreateTable {
</a><a href="#h21-0-131" id="h21-0-131" class="i">+                txn_id: self.id,
</a><a href="#h21-0-132" id="h21-0-132" class="i">+                schema: table.clone(),
</a><a href="#h21-0-133" id="h21-0-133" class="i">+            })?)?,
</a><a href="#h21-0-134" id="h21-0-134" class="i">+        )
</a><a href="#h21-0-135" id="h21-0-135" class="i">+    }
</a><a href="#h21-0-136" id="h21-0-136" class="i">+
</a><a href="#h21-0-137" id="h21-0-137" class="i">+    fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-138" id="h21-0-138" class="i">+        deserialize(
</a><a href="#h21-0-139" id="h21-0-139" class="i">+            self.raft.mutate(serialize(Mutation::DeleteTable {
</a><a href="#h21-0-140" id="h21-0-140" class="i">+                txn_id: self.id,
</a><a href="#h21-0-141" id="h21-0-141" class="i">+                table: table.into(),
</a><a href="#h21-0-142" id="h21-0-142" class="i">+            })?)?,
</a><a href="#h21-0-143" id="h21-0-143" class="i">+        )
</a><a href="#h21-0-144" id="h21-0-144" class="i">+    }
</a><a href="#h21-0-145" id="h21-0-145" class="i">+
</a><a href="#h21-0-146" id="h21-0-146" class="i">+    fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h21-0-147" id="h21-0-147" class="i">+        deserialize(self.raft.read(serialize(Query::ListTables { txn_id: self.id })?)?)
</a><a href="#h21-0-148" id="h21-0-148" class="i">+    }
</a><a href="#h21-0-149" id="h21-0-149" class="i">+
</a><a href="#h21-0-150" id="h21-0-150" class="i">+    fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h21-0-151" id="h21-0-151" class="i">+        deserialize(
</a><a href="#h21-0-152" id="h21-0-152" class="i">+            self.raft
</a><a href="#h21-0-153" id="h21-0-153" class="i">+                .read(serialize(Query::ReadTable { txn_id: self.id, table: table.into() })?)?,
</a><a href="#h21-0-154" id="h21-0-154" class="i">+        )
</a><a href="#h21-0-155" id="h21-0-155" class="i">+    }
</a><a href="#h21-0-156" id="h21-0-156" class="i">+}
</a><a href="#h21-0-157" id="h21-0-157" class="i">+
</a><a href="#h21-0-158" id="h21-0-158" class="i">+/// The underlying state machine for the Raft-based engine
</a><a href="#h21-0-159" id="h21-0-159" class="i">+pub struct State&lt;S: kv::storage::Storage&gt; {
</a><a href="#h21-0-160" id="h21-0-160" class="i">+    engine: super::KV&lt;S&gt;,
</a><a href="#h21-0-161" id="h21-0-161" class="i">+    txns: HashMap&lt;u64, &lt;super::KV&lt;S&gt; as super::Engine&gt;::Transaction&gt;,
</a><a href="#h21-0-162" id="h21-0-162" class="i">+}
</a><a href="#h21-0-163" id="h21-0-163" class="i">+
</a><a href="#h21-0-164" id="h21-0-164" class="i">+impl&lt;S: kv::storage::Storage&gt; std::fmt::Debug for State&lt;S&gt; {
</a><a href="#h21-0-165" id="h21-0-165" class="i">+    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h21-0-166" id="h21-0-166" class="i">+        write!(f, &quot;State&quot;)
</a><a href="#h21-0-167" id="h21-0-167" class="i">+    }
</a><a href="#h21-0-168" id="h21-0-168" class="i">+}
</a><a href="#h21-0-169" id="h21-0-169" class="i">+
</a><a href="#h21-0-170" id="h21-0-170" class="i">+impl&lt;S: kv::storage::Storage&gt; State&lt;S&gt; {
</a><a href="#h21-0-171" id="h21-0-171" class="i">+    pub fn new(store: kv::MVCC&lt;S&gt;) -&gt; Self {
</a><a href="#h21-0-172" id="h21-0-172" class="i">+        State { engine: super::KV::new(store), txns: HashMap::new() }
</a><a href="#h21-0-173" id="h21-0-173" class="i">+    }
</a><a href="#h21-0-174" id="h21-0-174" class="i">+}
</a><a href="#h21-0-175" id="h21-0-175" class="i">+
</a><a href="#h21-0-176" id="h21-0-176" class="i">+impl&lt;S: kv::storage::Storage&gt; raft::State for State&lt;S&gt; {
</a><a href="#h21-0-177" id="h21-0-177" class="i">+    fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h21-0-178" id="h21-0-178" class="i">+        match deserialize(command)? {
</a><a href="#h21-0-179" id="h21-0-179" class="i">+            Mutation::Begin =&gt; {
</a><a href="#h21-0-180" id="h21-0-180" class="i">+                let txn = self.engine.begin()?;
</a><a href="#h21-0-181" id="h21-0-181" class="i">+                let txn_id = txn.id();
</a><a href="#h21-0-182" id="h21-0-182" class="i">+                self.txns.insert(txn_id, txn);
</a><a href="#h21-0-183" id="h21-0-183" class="i">+                serialize(txn_id)
</a><a href="#h21-0-184" id="h21-0-184" class="i">+            }
</a><a href="#h21-0-185" id="h21-0-185" class="i">+            Mutation::Commit(txn_id) =&gt; serialize(
</a><a href="#h21-0-186" id="h21-0-186" class="i">+                self.txns
</a><a href="#h21-0-187" id="h21-0-187" class="i">+                    .remove(&amp;txn_id)
</a><a href="#h21-0-188" id="h21-0-188" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-189" id="h21-0-189" class="i">+                    .commit()?,
</a><a href="#h21-0-190" id="h21-0-190" class="i">+            ),
</a><a href="#h21-0-191" id="h21-0-191" class="i">+            Mutation::Rollback(txn_id) =&gt; serialize(
</a><a href="#h21-0-192" id="h21-0-192" class="i">+                self.txns
</a><a href="#h21-0-193" id="h21-0-193" class="i">+                    .remove(&amp;txn_id)
</a><a href="#h21-0-194" id="h21-0-194" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-195" id="h21-0-195" class="i">+                    .rollback()?,
</a><a href="#h21-0-196" id="h21-0-196" class="i">+            ),
</a><a href="#h21-0-197" id="h21-0-197" class="i">+
</a><a href="#h21-0-198" id="h21-0-198" class="i">+            Mutation::Create { txn_id, table, row } =&gt; serialize(
</a><a href="#h21-0-199" id="h21-0-199" class="i">+                self.txns
</a><a href="#h21-0-200" id="h21-0-200" class="i">+                    .get_mut(&amp;txn_id)
</a><a href="#h21-0-201" id="h21-0-201" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-202" id="h21-0-202" class="i">+                    .create(&amp;table, row)?,
</a><a href="#h21-0-203" id="h21-0-203" class="i">+            ),
</a><a href="#h21-0-204" id="h21-0-204" class="i">+            Mutation::Delete { txn_id, table, id } =&gt; serialize(
</a><a href="#h21-0-205" id="h21-0-205" class="i">+                self.txns
</a><a href="#h21-0-206" id="h21-0-206" class="i">+                    .get_mut(&amp;txn_id)
</a><a href="#h21-0-207" id="h21-0-207" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-208" id="h21-0-208" class="i">+                    .delete(&amp;table, &amp;id)?,
</a><a href="#h21-0-209" id="h21-0-209" class="i">+            ),
</a><a href="#h21-0-210" id="h21-0-210" class="i">+            Mutation::Update { txn_id, table, id, row } =&gt; serialize(
</a><a href="#h21-0-211" id="h21-0-211" class="i">+                self.txns
</a><a href="#h21-0-212" id="h21-0-212" class="i">+                    .get_mut(&amp;txn_id)
</a><a href="#h21-0-213" id="h21-0-213" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-214" id="h21-0-214" class="i">+                    .update(&amp;table, &amp;id, row)?,
</a><a href="#h21-0-215" id="h21-0-215" class="i">+            ),
</a><a href="#h21-0-216" id="h21-0-216" class="i">+
</a><a href="#h21-0-217" id="h21-0-217" class="i">+            Mutation::CreateTable { txn_id, schema } =&gt; serialize(
</a><a href="#h21-0-218" id="h21-0-218" class="i">+                self.txns
</a><a href="#h21-0-219" id="h21-0-219" class="i">+                    .get_mut(&amp;txn_id)
</a><a href="#h21-0-220" id="h21-0-220" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-221" id="h21-0-221" class="i">+                    .create_table(&amp;schema)?,
</a><a href="#h21-0-222" id="h21-0-222" class="i">+            ),
</a><a href="#h21-0-223" id="h21-0-223" class="i">+            Mutation::DeleteTable { txn_id, table } =&gt; serialize(
</a><a href="#h21-0-224" id="h21-0-224" class="i">+                self.txns
</a><a href="#h21-0-225" id="h21-0-225" class="i">+                    .get_mut(&amp;txn_id)
</a><a href="#h21-0-226" id="h21-0-226" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-227" id="h21-0-227" class="i">+                    .delete_table(&amp;table)?,
</a><a href="#h21-0-228" id="h21-0-228" class="i">+            ),
</a><a href="#h21-0-229" id="h21-0-229" class="i">+        }
</a><a href="#h21-0-230" id="h21-0-230" class="i">+    }
</a><a href="#h21-0-231" id="h21-0-231" class="i">+
</a><a href="#h21-0-232" id="h21-0-232" class="i">+    fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h21-0-233" id="h21-0-233" class="i">+        match deserialize(command)? {
</a><a href="#h21-0-234" id="h21-0-234" class="i">+            Query::Read { txn_id, table, id } =&gt; serialize(
</a><a href="#h21-0-235" id="h21-0-235" class="i">+                self.txns
</a><a href="#h21-0-236" id="h21-0-236" class="i">+                    .get(&amp;txn_id)
</a><a href="#h21-0-237" id="h21-0-237" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-238" id="h21-0-238" class="i">+                    .read(&amp;table, &amp;id)?,
</a><a href="#h21-0-239" id="h21-0-239" class="i">+            ),
</a><a href="#h21-0-240" id="h21-0-240" class="i">+            Query::Scan { txn_id, table } =&gt; serialize(
</a><a href="#h21-0-241" id="h21-0-241" class="i">+                // FIXME This needs to stream rows
</a><a href="#h21-0-242" id="h21-0-242" class="i">+                self.txns
</a><a href="#h21-0-243" id="h21-0-243" class="i">+                    .get(&amp;txn_id)
</a><a href="#h21-0-244" id="h21-0-244" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-245" id="h21-0-245" class="i">+                    .scan(&amp;table)?
</a><a href="#h21-0-246" id="h21-0-246" class="i">+                    .collect::&lt;Result&lt;Vec&lt;types::Row&gt;, Error&gt;&gt;()?,
</a><a href="#h21-0-247" id="h21-0-247" class="i">+            ),
</a><a href="#h21-0-248" id="h21-0-248" class="i">+
</a><a href="#h21-0-249" id="h21-0-249" class="i">+            Query::ListTables { txn_id } =&gt; serialize(
</a><a href="#h21-0-250" id="h21-0-250" class="i">+                self.txns
</a><a href="#h21-0-251" id="h21-0-251" class="i">+                    .get(&amp;txn_id)
</a><a href="#h21-0-252" id="h21-0-252" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-253" id="h21-0-253" class="i">+                    .list_tables()?,
</a><a href="#h21-0-254" id="h21-0-254" class="i">+            ),
</a><a href="#h21-0-255" id="h21-0-255" class="i">+            Query::ReadTable { txn_id, table } =&gt; serialize(
</a><a href="#h21-0-256" id="h21-0-256" class="i">+                self.txns
</a><a href="#h21-0-257" id="h21-0-257" class="i">+                    .get(&amp;txn_id)
</a><a href="#h21-0-258" id="h21-0-258" class="i">+                    .ok_or_else(|| Error::Internal(&quot;Unknown transaction&quot;.into()))?
</a><a href="#h21-0-259" id="h21-0-259" class="i">+                    .read_table(&amp;table)?,
</a><a href="#h21-0-260" id="h21-0-260" class="i">+            ),
</a><a href="#h21-0-261" id="h21-0-261" class="i">+        }
</a><a href="#h21-0-262" id="h21-0-262" class="i">+    }
</a><a href="#h21-0-263" id="h21-0-263" class="i">+}
</a><b>diff --git a/<a id="h22" href="../file/src/sql/executor/create_table.rs.html">src/sql/executor/create_table.rs</a> b/<a href="../file/src/sql/executor/create_table.rs.html">src/sql/executor/create_table.rs</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::schema;
 use super::super::types::Row;
 use super::{Context, Executor};
<a href="#h22-1" id="h22-1" class="h">@@ -7,8 +8,11 @@ use crate::Error;
</a> pub struct CreateTable;
 
 impl CreateTable {
<a href="#h22-1-3" id="h22-1-3" class="d">-    pub fn execute(ctx: &amp;mut Context, schema: schema::Table) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h22-1-4" id="h22-1-4" class="d">-        ctx.storage.create_table(&amp;schema)?;
</a><a href="#h22-1-5" id="h22-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h22-1-6" id="h22-1-6" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a><a href="#h22-1-7" id="h22-1-7" class="i">+        schema: schema::Table,
</a><a href="#h22-1-8" id="h22-1-8" class="i">+    ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h22-1-9" id="h22-1-9" class="i">+        ctx.txn.create_table(&amp;schema)?;
</a>         Ok(Box::new(Self))
     }
 }
<b>diff --git a/<a id="h23" href="../file/src/sql/executor/delete.rs.html">src/sql/executor/delete.rs</a> b/<a href="../file/src/sql/executor/delete.rs.html">src/sql/executor/delete.rs</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h23-1" id="h23-1" class="h">@@ -6,18 +7,18 @@ use crate::Error;
</a> pub struct Delete;
 
 impl Delete {
<a href="#h23-1-3" id="h23-1-3" class="d">-    pub fn execute(
</a><a href="#h23-1-4" id="h23-1-4" class="d">-        ctx: &amp;mut Context,
</a><a href="#h23-1-5" id="h23-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h23-1-6" id="h23-1-6" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a>         mut source: Box&lt;dyn Executor&gt;,
         table: String,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
         let pk = ctx
<a href="#h23-1-11" id="h23-1-11" class="d">-            .storage
</a><a href="#h23-1-12" id="h23-1-12" class="d">-            .get_table(&amp;table)?
</a><a href="#h23-1-13" id="h23-1-13" class="i">+            .txn
</a><a href="#h23-1-14" id="h23-1-14" class="i">+            .read_table(&amp;table)?
</a>             .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?
             .primary_key;
         while let Some(row) = source.fetch()? {
<a href="#h23-1-18" id="h23-1-18" class="d">-            ctx.storage.delete_row(&amp;table, row.get(pk).unwrap())?
</a><a href="#h23-1-19" id="h23-1-19" class="i">+            ctx.txn.delete(&amp;table, row.get(pk).unwrap())?
</a>         }
         Ok(Box::new(Self))
     }
<b>diff --git a/<a id="h24" href="../file/src/sql/executor/drop_table.rs.html">src/sql/executor/drop_table.rs</a> b/<a href="../file/src/sql/executor/drop_table.rs.html">src/sql/executor/drop_table.rs</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h24-1" id="h24-1" class="h">@@ -6,8 +7,11 @@ use crate::Error;
</a> pub struct DropTable;
 
 impl DropTable {
<a href="#h24-1-3" id="h24-1-3" class="d">-    pub fn execute(ctx: &amp;mut Context, name: String) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h24-1-4" id="h24-1-4" class="d">-        ctx.storage.delete_table(&amp;name)?;
</a><a href="#h24-1-5" id="h24-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h24-1-6" id="h24-1-6" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a><a href="#h24-1-7" id="h24-1-7" class="i">+        name: String,
</a><a href="#h24-1-8" id="h24-1-8" class="i">+    ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h24-1-9" id="h24-1-9" class="i">+        ctx.txn.delete_table(&amp;name)?;
</a>         Ok(Box::new(Self))
     }
 }
<b>diff --git a/<a id="h25" href="../file/src/sql/executor/filter.rs.html">src/sql/executor/filter.rs</a> b/<a href="../file/src/sql/executor/filter.rs.html">src/sql/executor/filter.rs</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::expression::{Environment, Expression};
 use super::super::types::{Row, Value};
 use super::{Context, Executor};
<a href="#h25-1" id="h25-1" class="h">@@ -11,8 +12,8 @@ pub struct Filter {
</a> }
 
 impl Filter {
<a href="#h25-1-3" id="h25-1-3" class="d">-    pub fn execute(
</a><a href="#h25-1-4" id="h25-1-4" class="d">-        _: &amp;mut Context,
</a><a href="#h25-1-5" id="h25-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h25-1-6" id="h25-1-6" class="i">+        _: &amp;mut Context&lt;T&gt;,
</a>         source: Box&lt;dyn Executor&gt;,
         predicate: Expression,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
<b>diff --git a/<a id="h26" href="../file/src/sql/executor/insert.rs.html">src/sql/executor/insert.rs</a> b/<a href="../file/src/sql/executor/insert.rs.html">src/sql/executor/insert.rs</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::expression::{Environment, Expressions};
 use super::super::types::Row;
 use super::{Context, Executor};
<a href="#h26-1" id="h26-1" class="h">@@ -6,15 +7,15 @@ use crate::Error;
</a> pub struct Insert;
 
 impl Insert {
<a href="#h26-1-3" id="h26-1-3" class="d">-    pub fn execute(
</a><a href="#h26-1-4" id="h26-1-4" class="d">-        ctx: &amp;mut Context,
</a><a href="#h26-1-5" id="h26-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h26-1-6" id="h26-1-6" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a>         table: &amp;str,
         columns: Vec&lt;String&gt;,
         expressions: Vec&lt;Expressions&gt;,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
         let table = ctx
<a href="#h26-1-12" id="h26-1-12" class="d">-            .storage
</a><a href="#h26-1-13" id="h26-1-13" class="d">-            .get_table(table)?
</a><a href="#h26-1-14" id="h26-1-14" class="i">+            .txn
</a><a href="#h26-1-15" id="h26-1-15" class="i">+            .read_table(table)?
</a>             .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
         for exprs in expressions {
             let mut row = Row::new();
<a href="#h26-2" id="h26-2" class="h">@@ -25,7 +26,7 @@ impl Insert {
</a>                 row,
                 if !columns.is_empty() { Some(columns.clone()) } else { None },
             )?;
<a href="#h26-2-3" id="h26-2-3" class="d">-            ctx.storage.create_row(&amp;table.name, row)?;
</a><a href="#h26-2-4" id="h26-2-4" class="i">+            ctx.txn.create(&amp;table.name, row)?;
</a>         }
         Ok(Box::new(Self))
     }
<b>diff --git a/<a id="h27" href="../file/src/sql/executor/limit.rs.html">src/sql/executor/limit.rs</a> b/<a href="../file/src/sql/executor/limit.rs.html">src/sql/executor/limit.rs</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h27-1" id="h27-1" class="h">@@ -10,8 +11,8 @@ pub struct Limit {
</a> }
 
 impl Limit {
<a href="#h27-1-3" id="h27-1-3" class="d">-    pub fn execute(
</a><a href="#h27-1-4" id="h27-1-4" class="d">-        _: &amp;mut Context,
</a><a href="#h27-1-5" id="h27-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h27-1-6" id="h27-1-6" class="i">+        _: &amp;mut Context&lt;T&gt;,
</a>         source: Box&lt;dyn Executor&gt;,
         limit: u64,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
<b>diff --git a/<a id="h28" href="../file/src/sql/executor/mod.rs.html">src/sql/executor/mod.rs</a> b/<a href="../file/src/sql/executor/mod.rs.html">src/sql/executor/mod.rs</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -24,13 +24,13 @@ use projection::Projection;
</a> use scan::Scan;
 use update::Update;
 
<a href="#h28-0-3" id="h28-0-3" class="i">+use super::engine::Transaction;
</a> use super::planner::Node;
 use super::types::Row;
<a href="#h28-0-6" id="h28-0-6" class="d">-use super::Storage;
</a> use crate::Error;
 
 /// A plan executor
<a href="#h28-0-10" id="h28-0-10" class="d">-pub trait Executor: Sync + Send + &#39;static {
</a><a href="#h28-0-11" id="h28-0-11" class="i">+pub trait Executor: &#39;static + Sync + Send {
</a>     //fn affected(&amp;self) -&gt; Option&lt;u64&gt;;
     fn columns(&amp;self) -&gt; Vec&lt;String&gt;;
     fn fetch(&amp;mut self) -&gt; Result&lt;Option&lt;Row&gt;, Error&gt;;
<a href="#h28-1" id="h28-1" class="h">@@ -38,7 +38,7 @@ pub trait Executor: Sync + Send + &#39;static {
</a> 
 impl dyn Executor {
     /// Executes a plan node, consuming it
<a href="#h28-1-3" id="h28-1-3" class="d">-    pub fn execute(ctx: &amp;mut Context, node: Node) -&gt; Result&lt;Box&lt;Self&gt;, Error&gt; {
</a><a href="#h28-1-4" id="h28-1-4" class="i">+    pub fn execute&lt;T: Transaction&gt;(ctx: &amp;mut Context&lt;T&gt;, node: Node) -&gt; Result&lt;Box&lt;Self&gt;, Error&gt; {
</a>         Ok(match node {
             Node::CreateTable { schema } =&gt; CreateTable::execute(ctx, schema)?,
             Node::Delete { table, source } =&gt; {
<a href="#h28-2" id="h28-2" class="h">@@ -62,7 +62,7 @@ impl dyn Executor {
</a>                 let source = Self::execute(ctx, *source)?;
                 Offset::execute(ctx, source, offset)?
             }
<a href="#h28-2-3" id="h28-2-3" class="d">-            Node::Order{source, orders} =&gt; {
</a><a href="#h28-2-4" id="h28-2-4" class="i">+            Node::Order { source, orders } =&gt; {
</a>                 let source = Self::execute(ctx, *source)?;
                 Order::execute(ctx, source, orders)?
             }
<a href="#h28-3" id="h28-3" class="h">@@ -88,7 +88,7 @@ impl Iterator for dyn Executor {
</a> }
 
 /// A plan execution context
<a href="#h28-3-3" id="h28-3-3" class="d">-pub struct Context {
</a><a href="#h28-3-4" id="h28-3-4" class="d">-    /// The underlying storage
</a><a href="#h28-3-5" id="h28-3-5" class="d">-    pub storage: Box&lt;Storage&gt;,
</a><a href="#h28-3-6" id="h28-3-6" class="i">+pub struct Context&lt;&#39;a, T: Transaction&gt; {
</a><a href="#h28-3-7" id="h28-3-7" class="i">+    /// The underlying storage engine
</a><a href="#h28-3-8" id="h28-3-8" class="i">+    pub txn: &amp;&#39;a mut T,
</a> }
<b>diff --git a/<a id="h29" href="../file/src/sql/executor/nothing.rs.html">src/sql/executor/nothing.rs</a> b/<a href="../file/src/sql/executor/nothing.rs.html">src/sql/executor/nothing.rs</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h29-1" id="h29-1" class="h">@@ -8,7 +9,7 @@ pub struct Nothing {
</a> }
 
 impl Nothing {
<a href="#h29-1-3" id="h29-1-3" class="d">-    pub fn execute(_: &amp;mut Context) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h29-1-4" id="h29-1-4" class="i">+    pub fn execute&lt;T: Transaction&gt;(_: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a>         Ok(Box::new(Self { done: false }))
     }
 }
<b>diff --git a/<a id="h30" href="../file/src/sql/executor/offset.rs.html">src/sql/executor/offset.rs</a> b/<a href="../file/src/sql/executor/offset.rs.html">src/sql/executor/offset.rs</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h30-1" id="h30-1" class="h">@@ -8,8 +9,8 @@ pub struct Offset {
</a> }
 
 impl Offset {
<a href="#h30-1-3" id="h30-1-3" class="d">-    pub fn execute(
</a><a href="#h30-1-4" id="h30-1-4" class="d">-        _: &amp;mut Context,
</a><a href="#h30-1-5" id="h30-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h30-1-6" id="h30-1-6" class="i">+        _: &amp;mut Context&lt;T&gt;,
</a>         mut source: Box&lt;dyn Executor&gt;,
         offset: u64,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
<b>diff --git a/<a id="h31" href="../file/src/sql/executor/order.rs.html">src/sql/executor/order.rs</a> b/<a href="../file/src/sql/executor/order.rs.html">src/sql/executor/order.rs</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::expression::{Environment, Expression};
 use super::super::planner;
 use super::super::types::{Row, Value};
<a href="#h31-1" id="h31-1" class="h">@@ -11,8 +12,8 @@ pub struct Order {
</a> }
 
 impl Order {
<a href="#h31-1-3" id="h31-1-3" class="d">-    pub fn execute(
</a><a href="#h31-1-4" id="h31-1-4" class="d">-        _: &amp;mut Context,
</a><a href="#h31-1-5" id="h31-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h31-1-6" id="h31-1-6" class="i">+        _: &amp;mut Context&lt;T&gt;,
</a>         mut source: Box&lt;dyn Executor&gt;,
         orders: Vec&lt;(Expression, planner::Order)&gt;,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
<b>diff --git a/<a id="h32" href="../file/src/sql/executor/projection.rs.html">src/sql/executor/projection.rs</a> b/<a href="../file/src/sql/executor/projection.rs.html">src/sql/executor/projection.rs</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::expression::{Environment, Expression, Expressions};
 use super::super::types::Row;
 use super::{Context, Executor};
<a href="#h32-1" id="h32-1" class="h">@@ -11,8 +12,8 @@ pub struct Projection {
</a> }
 
 impl Projection {
<a href="#h32-1-3" id="h32-1-3" class="d">-    pub fn execute(
</a><a href="#h32-1-4" id="h32-1-4" class="d">-        _: &amp;mut Context,
</a><a href="#h32-1-5" id="h32-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h32-1-6" id="h32-1-6" class="i">+        _: &amp;mut Context&lt;T&gt;,
</a>         source: Box&lt;dyn Executor&gt;,
         labels: Vec&lt;Option&lt;String&gt;&gt;,
         expressions: Expressions,
<b>diff --git a/<a id="h33" href="../file/src/sql/executor/scan.rs.html">src/sql/executor/scan.rs</a> b/<a href="../file/src/sql/executor/scan.rs.html">src/sql/executor/scan.rs</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::{Context, Executor};
 use crate::Error;
<a href="#h33-1" id="h33-1" class="h">@@ -5,18 +6,21 @@ use crate::Error;
</a> /// A table scan node
 pub struct Scan {
     columns: Vec&lt;String&gt;,
<a href="#h33-1-3" id="h33-1-3" class="d">-    range: Box&lt;dyn Iterator&lt;Item = Result&lt;Row, Error&gt;&gt; + Sync + Send + &#39;static&gt;,
</a><a href="#h33-1-4" id="h33-1-4" class="i">+    range: super::super::engine::Scan,
</a> }
 
 impl Scan {
<a href="#h33-1-8" id="h33-1-8" class="d">-    pub fn execute(ctx: &amp;mut Context, table: String) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a><a href="#h33-1-9" id="h33-1-9" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h33-1-10" id="h33-1-10" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a><a href="#h33-1-11" id="h33-1-11" class="i">+        table: String,
</a><a href="#h33-1-12" id="h33-1-12" class="i">+    ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
</a>         let schema = ctx
<a href="#h33-1-14" id="h33-1-14" class="d">-            .storage
</a><a href="#h33-1-15" id="h33-1-15" class="d">-            .get_table(&amp;table)?
</a><a href="#h33-1-16" id="h33-1-16" class="i">+            .txn
</a><a href="#h33-1-17" id="h33-1-17" class="i">+            .read_table(&amp;table)?
</a>             .ok_or_else(|| Error::Value(format!(&quot;Table {} not found&quot;, table)))?;
         Ok(Box::new(Self {
             columns: schema.columns.iter().map(|c| c.name.clone()).collect(),
<a href="#h33-1-21" id="h33-1-21" class="d">-            range: ctx.storage.scan_rows(&amp;table),
</a><a href="#h33-1-22" id="h33-1-22" class="i">+            range: ctx.txn.scan(&amp;table)?,
</a>         }))
     }
 }
<b>diff --git a/<a id="h34" href="../file/src/sql/executor/update.rs.html">src/sql/executor/update.rs</a> b/<a href="../file/src/sql/executor/update.rs.html">src/sql/executor/update.rs</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::types::Row;
 use super::super::{Environment, Expression};
 use super::{Context, Executor};
<a href="#h34-1" id="h34-1" class="h">@@ -8,15 +9,15 @@ use std::collections::BTreeMap;
</a> pub struct Update;
 
 impl Update {
<a href="#h34-1-3" id="h34-1-3" class="d">-    pub fn execute(
</a><a href="#h34-1-4" id="h34-1-4" class="d">-        ctx: &amp;mut Context,
</a><a href="#h34-1-5" id="h34-1-5" class="i">+    pub fn execute&lt;T: Transaction&gt;(
</a><a href="#h34-1-6" id="h34-1-6" class="i">+        ctx: &amp;mut Context&lt;T&gt;,
</a>         table: String,
         mut source: Box&lt;dyn Executor&gt;,
         expressions: BTreeMap&lt;String, Expression&gt;,
     ) -&gt; Result&lt;Box&lt;dyn Executor&gt;, Error&gt; {
         let schema = ctx
<a href="#h34-1-12" id="h34-1-12" class="d">-            .storage
</a><a href="#h34-1-13" id="h34-1-13" class="d">-            .get_table(&amp;table)?
</a><a href="#h34-1-14" id="h34-1-14" class="i">+            .txn
</a><a href="#h34-1-15" id="h34-1-15" class="i">+            .read_table(&amp;table)?
</a>             .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
         let pk_index = schema.primary_key;
         let columns: Vec&lt;String&gt; = schema.columns.iter().map(|c| c.name.clone()).collect();
<a href="#h34-2" id="h34-2" class="h">@@ -26,7 +27,7 @@ impl Update {
</a>             for (c, expr) in &amp;expressions {
                 row[schema.column_index(&amp;c).unwrap()] = expr.evaluate(&amp;env)?;
             }
<a href="#h34-2-3" id="h34-2-3" class="d">-            ctx.storage.update_row(&amp;table, &amp;pk, row)?
</a><a href="#h34-2-4" id="h34-2-4" class="i">+            ctx.txn.update(&amp;table, &amp;pk, row)?
</a>         }
         Ok(Box::new(Self))
     }
<b>diff --git a/<a id="h35" href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a> b/<a href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -1,16 +1,16 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+pub mod engine;
</a> mod executor;
 mod expression;
 mod optimizer;
 mod parser;
 mod planner;
 mod schema;
<a href="#h35-0-7" id="h35-0-7" class="d">-mod storage;
</a> #[cfg(test)]
 mod tests;
 pub mod types;
 
<a href="#h35-0-12" id="h35-0-12" class="i">+pub use engine::{Engine, Transaction};
</a> pub use executor::Context;
 pub use expression::{Environment, Expression};
 pub use parser::{ast, lexer, Parser};
 pub use planner::Plan;
<a href="#h35-0-17" id="h35-0-17" class="d">-pub use storage::Storage;
</a><b>diff --git a/<a id="h36" href="../file/src/sql/parser/ast.rs.html">src/sql/parser/ast.rs</a> b/<a href="../file/src/sql/parser/ast.rs.html">src/sql/parser/ast.rs</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -3,13 +3,22 @@ use std::collections::BTreeMap;
</a> 
 /// Statements
 #[derive(Clone, Debug, PartialEq)]
<a href="#h36-0-3" id="h36-0-3" class="i">+#[allow(clippy::large_enum_variant)]
</a> pub enum Statement {
<a href="#h36-0-5" id="h36-0-5" class="i">+    /// A BEGIN statement
</a><a href="#h36-0-6" id="h36-0-6" class="i">+    Begin,
</a><a href="#h36-0-7" id="h36-0-7" class="i">+    /// A COMMIT statement
</a><a href="#h36-0-8" id="h36-0-8" class="i">+    Commit,
</a><a href="#h36-0-9" id="h36-0-9" class="i">+    /// A ROLLBACK statement
</a><a href="#h36-0-10" id="h36-0-10" class="i">+    Rollback,
</a><a href="#h36-0-11" id="h36-0-11" class="i">+
</a>     /// A CREATE TABLE statement
     CreateTable { name: String, columns: Vec&lt;ColumnSpec&gt; },
<a href="#h36-0-14" id="h36-0-14" class="d">-    /// A DELETE statement
</a><a href="#h36-0-15" id="h36-0-15" class="d">-    Delete { table: String, r#where: Option&lt;WhereClause&gt; },
</a>     /// A DROP TABLE statement
     DropTable(String),
<a href="#h36-0-18" id="h36-0-18" class="i">+
</a><a href="#h36-0-19" id="h36-0-19" class="i">+    /// A DELETE statement
</a><a href="#h36-0-20" id="h36-0-20" class="i">+    Delete { table: String, r#where: Option&lt;WhereClause&gt; },
</a>     /// An INSERT statement
     Insert { table: String, columns: Option&lt;Vec&lt;String&gt;&gt;, values: Vec&lt;Expressions&gt; },
     /// A SELECT statement
<a href="#h36-1" id="h36-1" class="h">@@ -25,6 +34,35 @@ pub enum Statement {
</a>     Update { table: String, set: BTreeMap&lt;String, Expression&gt;, r#where: Option&lt;WhereClause&gt; },
 }
 
<a href="#h36-1-3" id="h36-1-3" class="i">+#[allow(dead_code)]
</a><a href="#h36-1-4" id="h36-1-4" class="i">+impl Statement {
</a><a href="#h36-1-5" id="h36-1-5" class="i">+    pub fn r#type(&amp;self) -&gt; StatementType {
</a><a href="#h36-1-6" id="h36-1-6" class="i">+        match self {
</a><a href="#h36-1-7" id="h36-1-7" class="i">+            Statement::Begin =&gt; StatementType::TCS,
</a><a href="#h36-1-8" id="h36-1-8" class="i">+            Statement::Commit =&gt; StatementType::TCS,
</a><a href="#h36-1-9" id="h36-1-9" class="i">+            Statement::Rollback =&gt; StatementType::TCS,
</a><a href="#h36-1-10" id="h36-1-10" class="i">+
</a><a href="#h36-1-11" id="h36-1-11" class="i">+            Statement::CreateTable { .. } =&gt; StatementType::DDL,
</a><a href="#h36-1-12" id="h36-1-12" class="i">+            Statement::DropTable(_) =&gt; StatementType::DDL,
</a><a href="#h36-1-13" id="h36-1-13" class="i">+
</a><a href="#h36-1-14" id="h36-1-14" class="i">+            Statement::Delete { .. } =&gt; StatementType::DML,
</a><a href="#h36-1-15" id="h36-1-15" class="i">+            Statement::Insert { .. } =&gt; StatementType::DML,
</a><a href="#h36-1-16" id="h36-1-16" class="i">+            Statement::Select { .. } =&gt; StatementType::DML,
</a><a href="#h36-1-17" id="h36-1-17" class="i">+            Statement::Update { .. } =&gt; StatementType::DML,
</a><a href="#h36-1-18" id="h36-1-18" class="i">+        }
</a><a href="#h36-1-19" id="h36-1-19" class="i">+    }
</a><a href="#h36-1-20" id="h36-1-20" class="i">+}
</a><a href="#h36-1-21" id="h36-1-21" class="i">+
</a><a href="#h36-1-22" id="h36-1-22" class="i">+//// Statement types
</a><a href="#h36-1-23" id="h36-1-23" class="i">+pub enum StatementType {
</a><a href="#h36-1-24" id="h36-1-24" class="i">+    /// Data definition language
</a><a href="#h36-1-25" id="h36-1-25" class="i">+    DDL,
</a><a href="#h36-1-26" id="h36-1-26" class="i">+    /// Data manipulation language
</a><a href="#h36-1-27" id="h36-1-27" class="i">+    DML,
</a><a href="#h36-1-28" id="h36-1-28" class="i">+    /// Transaction control statement
</a><a href="#h36-1-29" id="h36-1-29" class="i">+    TCS,
</a><a href="#h36-1-30" id="h36-1-30" class="i">+}
</a><a href="#h36-1-31" id="h36-1-31" class="i">+
</a> /// A column specification
 #[derive(Clone, Debug, PartialEq)]
 pub struct ColumnSpec {
<b>diff --git a/<a id="h37" href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a> b/<a href="../file/src/sql/parser/lexer.rs.html">src/sql/parser/lexer.rs</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -72,8 +72,10 @@ pub enum Keyword {
</a>     And,
     As,
     Asc,
<a href="#h37-0-3" id="h37-0-3" class="i">+    Begin,
</a>     Boolean,
     By,
<a href="#h37-0-6" id="h37-0-6" class="i">+    Commit,
</a>     Create,
     Delete,
     Desc,
<a href="#h37-1" id="h37-1" class="h">@@ -92,6 +94,7 @@ pub enum Keyword {
</a>     Or,
     Order,
     Primary,
<a href="#h37-1-3" id="h37-1-3" class="i">+    Rollback,
</a>     Select,
     Set,
     Table,
<a href="#h37-2" id="h37-2" class="h">@@ -108,8 +111,10 @@ impl Keyword {
</a>             &quot;AS&quot; =&gt; Self::As,
             &quot;ASC&quot; =&gt; Self::Asc,
             &quot;AND&quot; =&gt; Self::And,
<a href="#h37-2-3" id="h37-2-3" class="i">+            &quot;BEGIN&quot; =&gt; Self::Begin,
</a>             &quot;BOOLEAN&quot; =&gt; Self::Boolean,
             &quot;BY&quot; =&gt; Self::By,
<a href="#h37-2-6" id="h37-2-6" class="i">+            &quot;COMMIT&quot; =&gt; Self::Commit,
</a>             &quot;CREATE&quot; =&gt; Self::Create,
             &quot;DELETE&quot; =&gt; Self::Delete,
             &quot;DESC&quot; =&gt; Self::Desc,
<a href="#h37-3" id="h37-3" class="h">@@ -128,6 +133,7 @@ impl Keyword {
</a>             &quot;OR&quot; =&gt; Self::Or,
             &quot;ORDER&quot; =&gt; Self::Order,
             &quot;PRIMARY&quot; =&gt; Self::Primary,
<a href="#h37-3-3" id="h37-3-3" class="i">+            &quot;ROLLBACK&quot; =&gt; Self::Rollback,
</a>             &quot;SELECT&quot; =&gt; Self::Select,
             &quot;SET&quot; =&gt; Self::Set,
             &quot;TABLE&quot; =&gt; Self::Table,
<a href="#h37-4" id="h37-4" class="h">@@ -145,8 +151,10 @@ impl Keyword {
</a>             Self::As =&gt; &quot;AS&quot;,
             Self::Asc =&gt; &quot;ASC&quot;,
             Self::And =&gt; &quot;AND&quot;,
<a href="#h37-4-3" id="h37-4-3" class="i">+            Self::Begin =&gt; &quot;BEGIN&quot;,
</a>             Self::Boolean =&gt; &quot;BOOLEAN&quot;,
             Self::By =&gt; &quot;BY&quot;,
<a href="#h37-4-6" id="h37-4-6" class="i">+            Self::Commit =&gt; &quot;COMMIT&quot;,
</a>             Self::Create =&gt; &quot;CREATE&quot;,
             Self::Delete =&gt; &quot;DELETE&quot;,
             Self::Desc =&gt; &quot;DESC&quot;,
<a href="#h37-5" id="h37-5" class="h">@@ -165,6 +173,7 @@ impl Keyword {
</a>             Self::Or =&gt; &quot;OR&quot;,
             Self::Order =&gt; &quot;ORDER&quot;,
             Self::Primary =&gt; &quot;PRIMARY&quot;,
<a href="#h37-5-3" id="h37-5-3" class="i">+            Self::Rollback =&gt; &quot;ROLLBACK&quot;,
</a>             Self::Select =&gt; &quot;SELECT&quot;,
             Self::Set =&gt; &quot;SET&quot;,
             Self::Table =&gt; &quot;TABLE&quot;,
<b>diff --git a/<a id="h38" href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a> b/<a href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -94,12 +94,18 @@ impl&lt;&#39;a&gt; Parser&lt;&#39;a&gt; {
</a>     /// Parses an SQL statement
     fn parse_statement(&amp;mut self) -&gt; Result&lt;ast::Statement, Error&gt; {
         match self.peek()? {
<a href="#h38-0-3" id="h38-0-3" class="i">+            Some(Token::Keyword(Keyword::Begin)) =&gt; self.parse_transaction(),
</a><a href="#h38-0-4" id="h38-0-4" class="i">+            Some(Token::Keyword(Keyword::Commit)) =&gt; self.parse_transaction(),
</a><a href="#h38-0-5" id="h38-0-5" class="i">+            Some(Token::Keyword(Keyword::Rollback)) =&gt; self.parse_transaction(),
</a><a href="#h38-0-6" id="h38-0-6" class="i">+
</a>             Some(Token::Keyword(Keyword::Create)) =&gt; self.parse_ddl(),
<a href="#h38-0-8" id="h38-0-8" class="d">-            Some(Token::Keyword(Keyword::Delete)) =&gt; self.parse_statement_delete(),
</a>             Some(Token::Keyword(Keyword::Drop)) =&gt; self.parse_ddl(),
<a href="#h38-0-10" id="h38-0-10" class="i">+
</a><a href="#h38-0-11" id="h38-0-11" class="i">+            Some(Token::Keyword(Keyword::Delete)) =&gt; self.parse_statement_delete(),
</a>             Some(Token::Keyword(Keyword::Insert)) =&gt; self.parse_statement_insert(),
             Some(Token::Keyword(Keyword::Select)) =&gt; self.parse_statement_select(),
             Some(Token::Keyword(Keyword::Update)) =&gt; self.parse_statement_update(),
<a href="#h38-0-15" id="h38-0-15" class="i">+
</a>             Some(token) =&gt; Err(Error::Parse(format!(&quot;Unexpected token {}&quot;, token))),
             None =&gt; Err(Error::Parse(&quot;Unexpected end of input&quot;.into())),
         }
<a href="#h38-1" id="h38-1" class="h">@@ -282,6 +288,16 @@ impl&lt;&#39;a&gt; Parser&lt;&#39;a&gt; {
</a>         Ok(ast::Statement::Update { table, set, r#where: self.parse_clause_where()? })
     }
 
<a href="#h38-1-3" id="h38-1-3" class="i">+    /// Parses a transaction statement
</a><a href="#h38-1-4" id="h38-1-4" class="i">+    fn parse_transaction(&amp;mut self) -&gt; Result&lt;ast::Statement, Error&gt; {
</a><a href="#h38-1-5" id="h38-1-5" class="i">+        match self.next()? {
</a><a href="#h38-1-6" id="h38-1-6" class="i">+            Token::Keyword(Keyword::Begin) =&gt; Ok(ast::Statement::Begin),
</a><a href="#h38-1-7" id="h38-1-7" class="i">+            Token::Keyword(Keyword::Commit) =&gt; Ok(ast::Statement::Commit),
</a><a href="#h38-1-8" id="h38-1-8" class="i">+            Token::Keyword(Keyword::Rollback) =&gt; Ok(ast::Statement::Rollback),
</a><a href="#h38-1-9" id="h38-1-9" class="i">+            token =&gt; Err(Error::Parse(format!(&quot;Unexpected token {}&quot;, token))),
</a><a href="#h38-1-10" id="h38-1-10" class="i">+        }
</a><a href="#h38-1-11" id="h38-1-11" class="i">+    }
</a><a href="#h38-1-12" id="h38-1-12" class="i">+
</a>     /// Parses a from clause
     fn parse_clause_from(&amp;mut self) -&gt; Result&lt;Option&lt;ast::FromClause&gt;, Error&gt; {
         if self.next_if_token(Keyword::From.into()).is_none() {
<b>diff --git a/<a id="h39" href="../file/src/sql/planner/mod.rs.html">src/sql/planner/mod.rs</a> b/<a href="../file/src/sql/planner/mod.rs.html">src/sql/planner/mod.rs</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -1,6 +1,6 @@
</a> mod plan;
 
<a href="#h39-0-2" id="h39-0-2" class="d">-pub use plan::{Node, Plan, Order};
</a><a href="#h39-0-3" id="h39-0-3" class="i">+pub use plan::{Node, Order, Plan};
</a> 
 use super::expression::{Environment, Expression};
 use super::parser::ast;
<a href="#h39-1" id="h39-1" class="h">@@ -25,6 +25,12 @@ impl Planner {
</a>     /// Builds a plan node for a statement
     fn build_statement(&amp;self, statement: ast::Statement) -&gt; Result&lt;Node, Error&gt; {
         Ok(match statement {
<a href="#h39-1-3" id="h39-1-3" class="i">+            ast::Statement::Begin | ast::Statement::Commit | ast::Statement::Rollback =&gt; {
</a><a href="#h39-1-4" id="h39-1-4" class="i">+                return Err(Error::Internal(format!(
</a><a href="#h39-1-5" id="h39-1-5" class="i">+                    &quot;Unexpected transaction statement {:?}&quot;,
</a><a href="#h39-1-6" id="h39-1-6" class="i">+                    statement
</a><a href="#h39-1-7" id="h39-1-7" class="i">+                )))
</a><a href="#h39-1-8" id="h39-1-8" class="i">+            }
</a>             ast::Statement::CreateTable { name, columns } =&gt; {
                 Node::CreateTable { schema: self.build_schema_table(name, columns)? }
             }
<b>diff --git a/<a id="h40" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -1,3 +1,4 @@
</a><a href="#h40-0-0" id="h40-0-0" class="i">+use super::super::engine::Transaction;
</a> use super::super::executor::{Context, Executor};
 use super::super::expression::{Expression, Expressions};
 use super::super::optimizer;
<a href="#h40-1" id="h40-1" class="h">@@ -22,7 +23,7 @@ impl Plan {
</a>     }
 
     /// Executes the plan, consuming it
<a href="#h40-1-3" id="h40-1-3" class="d">-    pub fn execute(self, mut ctx: Context) -&gt; Result&lt;ResultSet, Error&gt; {
</a><a href="#h40-1-4" id="h40-1-4" class="i">+    pub fn execute&lt;T: Transaction&gt;(self, mut ctx: Context&lt;T&gt;) -&gt; Result&lt;ResultSet, Error&gt; {
</a>         Ok(ResultSet::from_executor(Executor::execute(&amp;mut ctx, self.root)?))
     }
 
<b>diff --git a/<a id="h41" href="../file/src/sql/storage.rs.html">src/sql/storage.rs</a> b/<a href="../file/src/sql/storage.rs.html">src/sql/storage.rs</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -1,111 +0,0 @@
</a><a href="#h41-0-0" id="h41-0-0" class="d">-use super::schema;
</a><a href="#h41-0-1" id="h41-0-1" class="d">-use super::types;
</a><a href="#h41-0-2" id="h41-0-2" class="d">-use crate::kv;
</a><a href="#h41-0-3" id="h41-0-3" class="d">-use crate::utility::{deserialize, serialize};
</a><a href="#h41-0-4" id="h41-0-4" class="d">-use crate::Error;
</a><a href="#h41-0-5" id="h41-0-5" class="d">-use std::sync::{Arc, RwLock};
</a><a href="#h41-0-6" id="h41-0-6" class="d">-
</a><a href="#h41-0-7" id="h41-0-7" class="d">-#[derive(Clone)]
</a><a href="#h41-0-8" id="h41-0-8" class="d">-pub struct Storage {
</a><a href="#h41-0-9" id="h41-0-9" class="d">-    kv: Arc&lt;RwLock&lt;Box&lt;dyn kv::Store&gt;&gt;&gt;,
</a><a href="#h41-0-10" id="h41-0-10" class="d">-}
</a><a href="#h41-0-11" id="h41-0-11" class="d">-
</a><a href="#h41-0-12" id="h41-0-12" class="d">-impl Storage {
</a><a href="#h41-0-13" id="h41-0-13" class="d">-    /// Creates a new Storage
</a><a href="#h41-0-14" id="h41-0-14" class="d">-    pub fn new&lt;S: kv::Store&gt;(store: S) -&gt; Self {
</a><a href="#h41-0-15" id="h41-0-15" class="d">-        Storage { kv: Arc::new(RwLock::new(Box::new(store))) }
</a><a href="#h41-0-16" id="h41-0-16" class="d">-    }
</a><a href="#h41-0-17" id="h41-0-17" class="d">-
</a><a href="#h41-0-18" id="h41-0-18" class="d">-    /// Creates a row
</a><a href="#h41-0-19" id="h41-0-19" class="d">-    pub fn create_row(&amp;mut self, table: &amp;str, row: types::Row) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-20" id="h41-0-20" class="d">-        let table = self
</a><a href="#h41-0-21" id="h41-0-21" class="d">-            .get_table(&amp;table)?
</a><a href="#h41-0-22" id="h41-0-22" class="d">-            .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
</a><a href="#h41-0-23" id="h41-0-23" class="d">-        table.validate_row(&amp;row)?;
</a><a href="#h41-0-24" id="h41-0-24" class="d">-        let pk = row.get(table.primary_key).unwrap();
</a><a href="#h41-0-25" id="h41-0-25" class="d">-        if self.get_row(&amp;table.name, &amp;pk)?.is_some() {
</a><a href="#h41-0-26" id="h41-0-26" class="d">-            return Err(Error::Value(format!(
</a><a href="#h41-0-27" id="h41-0-27" class="d">-                &quot;Primary key {} already exists for table {}&quot;,
</a><a href="#h41-0-28" id="h41-0-28" class="d">-                pk, table.name
</a><a href="#h41-0-29" id="h41-0-29" class="d">-            )));
</a><a href="#h41-0-30" id="h41-0-30" class="d">-        }
</a><a href="#h41-0-31" id="h41-0-31" class="d">-        self.kv.write()?.set(&amp;Self::key_row(&amp;table.name, &amp;pk.to_string()), serialize(row)?)?;
</a><a href="#h41-0-32" id="h41-0-32" class="d">-        Ok(())
</a><a href="#h41-0-33" id="h41-0-33" class="d">-    }
</a><a href="#h41-0-34" id="h41-0-34" class="d">-
</a><a href="#h41-0-35" id="h41-0-35" class="d">-    /// Creates a table
</a><a href="#h41-0-36" id="h41-0-36" class="d">-    pub fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-37" id="h41-0-37" class="d">-        if self.get_table(&amp;table.name)?.is_some() {
</a><a href="#h41-0-38" id="h41-0-38" class="d">-            return Err(Error::Value(format!(&quot;Table {} already exists&quot;, table.name)));
</a><a href="#h41-0-39" id="h41-0-39" class="d">-        }
</a><a href="#h41-0-40" id="h41-0-40" class="d">-        self.kv.write()?.set(&amp;Self::key_table(&amp;table.name), serialize(table)?)
</a><a href="#h41-0-41" id="h41-0-41" class="d">-    }
</a><a href="#h41-0-42" id="h41-0-42" class="d">-
</a><a href="#h41-0-43" id="h41-0-43" class="d">-    /// Deletes a row
</a><a href="#h41-0-44" id="h41-0-44" class="d">-    pub fn delete_row(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-45" id="h41-0-45" class="d">-        self.kv.write()?.delete(&amp;Self::key_row(table, &amp;id.to_string()))
</a><a href="#h41-0-46" id="h41-0-46" class="d">-    }
</a><a href="#h41-0-47" id="h41-0-47" class="d">-
</a><a href="#h41-0-48" id="h41-0-48" class="d">-    /// Deletes a table
</a><a href="#h41-0-49" id="h41-0-49" class="d">-    pub fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-50" id="h41-0-50" class="d">-        if self.get_table(table)?.is_none() {
</a><a href="#h41-0-51" id="h41-0-51" class="d">-            return Err(Error::Value(format!(&quot;Table {} does not exist&quot;, table)));
</a><a href="#h41-0-52" id="h41-0-52" class="d">-        }
</a><a href="#h41-0-53" id="h41-0-53" class="d">-        self.kv.write()?.delete(&amp;Self::key_table(table))
</a><a href="#h41-0-54" id="h41-0-54" class="d">-    }
</a><a href="#h41-0-55" id="h41-0-55" class="d">-
</a><a href="#h41-0-56" id="h41-0-56" class="d">-    /// Fetches a row
</a><a href="#h41-0-57" id="h41-0-57" class="d">-    pub fn get_row(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
</a><a href="#h41-0-58" id="h41-0-58" class="d">-        self.kv.read()?.get(&amp;Self::key_row(table, &amp;id.to_string()))?.map(deserialize).transpose()
</a><a href="#h41-0-59" id="h41-0-59" class="d">-    }
</a><a href="#h41-0-60" id="h41-0-60" class="d">-
</a><a href="#h41-0-61" id="h41-0-61" class="d">-    /// Fetches a table schema
</a><a href="#h41-0-62" id="h41-0-62" class="d">-    pub fn get_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;schema::Table&gt;, Error&gt; {
</a><a href="#h41-0-63" id="h41-0-63" class="d">-        self.kv.read()?.get(&amp;Self::key_table(table))?.map(deserialize).transpose()
</a><a href="#h41-0-64" id="h41-0-64" class="d">-    }
</a><a href="#h41-0-65" id="h41-0-65" class="d">-
</a><a href="#h41-0-66" id="h41-0-66" class="d">-    /// Lists tables
</a><a href="#h41-0-67" id="h41-0-67" class="d">-    pub fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h41-0-68" id="h41-0-68" class="d">-        let mut iter = self.kv.read()?.iter_prefix(b&quot;schema.table&quot;);
</a><a href="#h41-0-69" id="h41-0-69" class="d">-        let mut tables = Vec::new();
</a><a href="#h41-0-70" id="h41-0-70" class="d">-        while let Some((_, value)) = iter.next().transpose()? {
</a><a href="#h41-0-71" id="h41-0-71" class="d">-            let schema: schema::Table = deserialize(value)?;
</a><a href="#h41-0-72" id="h41-0-72" class="d">-            tables.push(schema.name)
</a><a href="#h41-0-73" id="h41-0-73" class="d">-        }
</a><a href="#h41-0-74" id="h41-0-74" class="d">-        Ok(tables)
</a><a href="#h41-0-75" id="h41-0-75" class="d">-    }
</a><a href="#h41-0-76" id="h41-0-76" class="d">-
</a><a href="#h41-0-77" id="h41-0-77" class="d">-    /// Creates an iterator over the rows of a table
</a><a href="#h41-0-78" id="h41-0-78" class="d">-    pub fn scan_rows(
</a><a href="#h41-0-79" id="h41-0-79" class="d">-        &amp;self,
</a><a href="#h41-0-80" id="h41-0-80" class="d">-        table: &amp;str,
</a><a href="#h41-0-81" id="h41-0-81" class="d">-    ) -&gt; Box&lt;dyn Iterator&lt;Item = Result&lt;types::Row, Error&gt;&gt; + Sync + Send&gt; {
</a><a href="#h41-0-82" id="h41-0-82" class="d">-        let key = table.to_string() + &quot;.&quot;;
</a><a href="#h41-0-83" id="h41-0-83" class="d">-        Box::new(self.kv.read().unwrap().iter_prefix(&amp;key.as_bytes()).map(|res| match res {
</a><a href="#h41-0-84" id="h41-0-84" class="d">-            Ok((_, v)) =&gt; deserialize(v),
</a><a href="#h41-0-85" id="h41-0-85" class="d">-            Err(err) =&gt; Err(err),
</a><a href="#h41-0-86" id="h41-0-86" class="d">-        }))
</a><a href="#h41-0-87" id="h41-0-87" class="d">-    }
</a><a href="#h41-0-88" id="h41-0-88" class="d">-
</a><a href="#h41-0-89" id="h41-0-89" class="d">-    /// Updates a row
</a><a href="#h41-0-90" id="h41-0-90" class="d">-    pub fn update_row(
</a><a href="#h41-0-91" id="h41-0-91" class="d">-        &amp;mut self,
</a><a href="#h41-0-92" id="h41-0-92" class="d">-        table: &amp;str,
</a><a href="#h41-0-93" id="h41-0-93" class="d">-        id: &amp;types::Value,
</a><a href="#h41-0-94" id="h41-0-94" class="d">-        row: types::Row,
</a><a href="#h41-0-95" id="h41-0-95" class="d">-    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-96" id="h41-0-96" class="d">-        // FIXME For now, we&#39;re lazy and just do a delete + create
</a><a href="#h41-0-97" id="h41-0-97" class="d">-        self.delete_row(table, id)?;
</a><a href="#h41-0-98" id="h41-0-98" class="d">-        self.create_row(table, row)
</a><a href="#h41-0-99" id="h41-0-99" class="d">-    }
</a><a href="#h41-0-100" id="h41-0-100" class="d">-
</a><a href="#h41-0-101" id="h41-0-101" class="d">-    /// Generates a key for a row
</a><a href="#h41-0-102" id="h41-0-102" class="d">-    fn key_row(table: &amp;str, id: &amp;str) -&gt; Vec&lt;u8&gt; {
</a><a href="#h41-0-103" id="h41-0-103" class="d">-        format!(&quot;{}.{}&quot;, table, id).as_bytes().to_vec()
</a><a href="#h41-0-104" id="h41-0-104" class="d">-    }
</a><a href="#h41-0-105" id="h41-0-105" class="d">-
</a><a href="#h41-0-106" id="h41-0-106" class="d">-    /// Generates a key for a table
</a><a href="#h41-0-107" id="h41-0-107" class="d">-    fn key_table(table: &amp;str) -&gt; Vec&lt;u8&gt; {
</a><a href="#h41-0-108" id="h41-0-108" class="d">-        format!(&quot;schema.table.{}&quot;, table).as_bytes().to_vec()
</a><a href="#h41-0-109" id="h41-0-109" class="d">-    }
</a><a href="#h41-0-110" id="h41-0-110" class="d">-}
</a><b>diff --git a/<a id="h42" href="../file/src/sql/tests.rs.html">src/sql/tests.rs</a> b/<a href="../file/src/sql/tests.rs.html">src/sql/tests.rs</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -5,7 +5,7 @@
</a> use super::lexer::{Lexer, Token};
 use super::schema;
 use super::types::{DataType, Row, Value};
<a href="#h42-0-3" id="h42-0-3" class="d">-use super::{Context, Parser, Plan, Storage};
</a><a href="#h42-0-4" id="h42-0-4" class="i">+use super::{Context, Engine, Parser, Plan, Transaction};
</a> use crate::kv;
 use crate::Error;
 use goldenfile::Mint;
<a href="#h42-1" id="h42-1" class="h">@@ -16,9 +16,12 @@ macro_rules! test_expr {
</a>     $(
         #[test]
         fn $name() {
<a href="#h42-1-3" id="h42-1-3" class="d">-            let ctx = Context{storage: Box::new(Storage::new(kv::Memory::new()))};
</a><a href="#h42-1-4" id="h42-1-4" class="i">+            let engine = super::engine::KV::new(kv::MVCC::new(kv::storage::Memory::new()));
</a><a href="#h42-1-5" id="h42-1-5" class="i">+            let mut txn = engine.begin().unwrap();
</a><a href="#h42-1-6" id="h42-1-6" class="i">+            let ctx = Context{txn: &amp;mut txn};
</a>             let ast = Parser::new(&amp;format!(&quot;SELECT {}&quot;, $expr)).parse().unwrap();
             let mut result = Plan::build(ast).unwrap().optimize().unwrap().execute(ctx).unwrap();
<a href="#h42-1-9" id="h42-1-9" class="i">+            txn.rollback().unwrap();
</a>             assert_eq!($value, *result.next().unwrap().unwrap().get(0).unwrap())
         }
     )*
<a href="#h42-2" id="h42-2" class="h">@@ -30,8 +33,9 @@ macro_rules! test_sql {
</a>     $(
         #[test]
         fn $name() {
<a href="#h42-2-3" id="h42-2-3" class="d">-            let mut storage = Storage::new(kv::Memory::new());
</a><a href="#h42-2-4" id="h42-2-4" class="d">-            storage.create_table(&amp;schema::Table{
</a><a href="#h42-2-5" id="h42-2-5" class="i">+            let engine = super::engine::KV::new(kv::MVCC::new(kv::storage::Memory::new()));
</a><a href="#h42-2-6" id="h42-2-6" class="i">+            let mut txn = engine.begin().unwrap();
</a><a href="#h42-2-7" id="h42-2-7" class="i">+            txn.create_table(&amp;schema::Table{
</a>                 name: &quot;genres&quot;.into(),
                 columns: vec![
                     schema::Column{
<a href="#h42-3" id="h42-3" class="h">@@ -47,7 +51,7 @@ macro_rules! test_sql {
</a>                 ],
                 primary_key: 0,
             }).unwrap();
<a href="#h42-3-3" id="h42-3-3" class="d">-            storage.create_table(&amp;schema::Table{
</a><a href="#h42-3-4" id="h42-3-4" class="i">+            txn.create_table(&amp;schema::Table{
</a>                 name: &quot;movies&quot;.into(),
                 columns: vec![
                     schema::Column{
<a href="#h42-4" id="h42-4" class="h">@@ -83,15 +87,15 @@ macro_rules! test_sql {
</a>                 ],
                 primary_key: 0,
             }).unwrap();
<a href="#h42-4-3" id="h42-4-3" class="d">-            storage.create_row(&quot;genres&quot;, vec![
</a><a href="#h42-4-4" id="h42-4-4" class="i">+            txn.create(&quot;genres&quot;, vec![
</a>                 Value::Integer(1),
                 Value::String(&quot;Science Fiction&quot;.into()),
             ]).unwrap();
<a href="#h42-4-8" id="h42-4-8" class="d">-            storage.create_row(&quot;genres&quot;, vec![
</a><a href="#h42-4-9" id="h42-4-9" class="i">+            txn.create(&quot;genres&quot;, vec![
</a>                 Value::Integer(2),
                 Value::String(&quot;Action&quot;.into()),
             ]).unwrap();
<a href="#h42-4-13" id="h42-4-13" class="d">-            storage.create_row(&quot;movies&quot;, vec![
</a><a href="#h42-4-14" id="h42-4-14" class="i">+            txn.create(&quot;movies&quot;, vec![
</a>                 Value::Integer(1),
                 Value::String(&quot;Stalker&quot;.into()),
                 Value::Integer(1),
<a href="#h42-5" id="h42-5" class="h">@@ -99,7 +103,7 @@ macro_rules! test_sql {
</a>                 Value::Float(8.2),
                 Value::Boolean(false),
             ]).unwrap();
<a href="#h42-5-3" id="h42-5-3" class="d">-            storage.create_row(&quot;movies&quot;, vec![
</a><a href="#h42-5-4" id="h42-5-4" class="i">+            txn.create(&quot;movies&quot;, vec![
</a>                 Value::Integer(2),
                 Value::String(&quot;Sicario&quot;.into()),
                 Value::Integer(2),
<a href="#h42-6" id="h42-6" class="h">@@ -107,7 +111,7 @@ macro_rules! test_sql {
</a>                 Value::Float(7.6),
                 Value::Boolean(true),
             ]).unwrap();
<a href="#h42-6-3" id="h42-6-3" class="d">-            storage.create_row(&quot;movies&quot;, vec![
</a><a href="#h42-6-4" id="h42-6-4" class="i">+            txn.create(&quot;movies&quot;, vec![
</a>                 Value::Integer(3),
                 Value::String(&quot;Primer&quot;.into()),
                 Value::Integer(1),
<a href="#h42-7" id="h42-7" class="h">@@ -115,7 +119,7 @@ macro_rules! test_sql {
</a>                 Value::Float(6.9),
                 Value::Null,
             ]).unwrap();
<a href="#h42-7-3" id="h42-7-3" class="d">-            storage.create_row(&quot;movies&quot;, vec![
</a><a href="#h42-7-4" id="h42-7-4" class="i">+            txn.create(&quot;movies&quot;, vec![
</a>                 Value::Integer(4),
                 Value::String(&quot;Heat&quot;.into()),
                 Value::Integer(2),
<a href="#h42-8" id="h42-8" class="h">@@ -123,7 +127,7 @@ macro_rules! test_sql {
</a>                 Value::Float(8.2),
                 Value::Boolean(true),
             ]).unwrap();
<a href="#h42-8-3" id="h42-8-3" class="d">-            storage.create_row(&quot;movies&quot;, vec![
</a><a href="#h42-8-4" id="h42-8-4" class="i">+            txn.create(&quot;movies&quot;, vec![
</a>                 Value::Integer(5),
                 Value::String(&quot;The Fountain&quot;.into()),
                 Value::Integer(1),
<a href="#h42-9" id="h42-9" class="h">@@ -131,6 +135,7 @@ macro_rules! test_sql {
</a>                 Value::Float(7.2),
                 Value::Boolean(true),
             ]).unwrap();
<a href="#h42-9-3" id="h42-9-3" class="i">+            txn.commit().unwrap();
</a> 
             let mut mint = Mint::new(&quot;src/sql/testdata&quot;);
             let mut f = mint.new_goldenfile(format!(&quot;{}&quot;, stringify!($name))).unwrap();
<a href="#h42-10" id="h42-10" class="h">@@ -183,13 +188,16 @@ macro_rules! test_sql {
</a>             write!(f, &quot;Query: {}\n\n&quot;, $sql).unwrap();
 
             write!(f, &quot;Result:&quot;).unwrap();
<a href="#h42-10-3" id="h42-10-3" class="d">-            let result = match plan.execute(Context{storage: Box::new(storage.clone())}) {
</a><a href="#h42-10-4" id="h42-10-4" class="i">+            let mut txn = engine.begin().unwrap();
</a><a href="#h42-10-5" id="h42-10-5" class="i">+            let ctx = Context{txn: &amp;mut txn};
</a><a href="#h42-10-6" id="h42-10-6" class="i">+            let result = match plan.execute(ctx) {
</a>                 Ok(result) =&gt; result,
                 Err(err) =&gt; {
                     write!(f, &quot; {:?}&quot;, err).unwrap();
                     return
                 }
             };
<a href="#h42-10-13" id="h42-10-13" class="i">+            txn.commit().unwrap();
</a>             let columns = result.columns();
             let rows: Vec&lt;Row&gt; = match result.collect() {
                 Ok(rows) =&gt; rows,
<a href="#h42-11" id="h42-11" class="h">@@ -208,13 +216,15 @@ macro_rules! test_sql {
</a>             }
 
             write!(f, &quot;\nStorage:&quot;).unwrap();
<a href="#h42-11-3" id="h42-11-3" class="d">-            for table in &amp;storage.list_tables().unwrap() {
</a><a href="#h42-11-4" id="h42-11-4" class="d">-                let schema = &amp;storage.get_table(&amp;table).unwrap().unwrap();
</a><a href="#h42-11-5" id="h42-11-5" class="i">+            let txn = engine.begin().unwrap();
</a><a href="#h42-11-6" id="h42-11-6" class="i">+            for table in &amp;txn.list_tables().unwrap() {
</a><a href="#h42-11-7" id="h42-11-7" class="i">+                let schema = &amp;txn.read_table(&amp;table.name).unwrap().unwrap();
</a>                 write!(f, &quot;\n{}\n&quot;, schema.to_query()).unwrap();
<a href="#h42-11-9" id="h42-11-9" class="d">-                for row in storage.scan_rows(&amp;table) {
</a><a href="#h42-11-10" id="h42-11-10" class="i">+                for row in txn.scan(&amp;table.name).unwrap() {
</a>                     write!(f, &quot;{:?}\n&quot;, row.unwrap()).unwrap();
                 }
             }
<a href="#h42-11-14" id="h42-11-14" class="i">+            txn.rollback().unwrap();
</a>         }
     )*
     }
</pre>
</div>
</body>
</html>
