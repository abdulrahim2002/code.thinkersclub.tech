<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Don&#39;t use `lazy_static` - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/7cca62e9110233904a67094eeb65d602a812ce14.html">7cca62e9110233904a67094eeb65d602a812ce14</a>
<b>parent</b> <a href="../commit/71e1b8a938056d0c1de5aa1a5bbaed0676e0b7a6.html">71e1b8a938056d0c1de5aa1a5bbaed0676e0b7a6</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue,  9 Apr 2024 19:31:37 +0200

Don&#39;t use `lazy_static`

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/encoding/bincode.rs</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/parser/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">+++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">tests/e2e/client.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">tests/e2e/dataset.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">tests/e2e/isolation.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">tests/e2e/recovery.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
</table></pre><pre>8 files changed, 29 insertions(+), 35 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1856,7 +1856,6 @@ dependencies = [
</a>  &quot;hdrhistogram&quot;,
  &quot;hex&quot;,
  &quot;itertools 0.12.1&quot;,
<a href="#h0-0-3" id="h0-0-3" class="d">- &quot;lazy_static&quot;,
</a>  &quot;log&quot;,
  &quot;paste&quot;,
  &quot;petname&quot;,
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -21,7 +21,6 @@ futures-util = &quot;~0.3.15&quot;
</a> hdrhistogram = &quot;~7.5.4&quot;
 hex = &quot;~0.4.3&quot;
 itertools = &quot;0.12.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-lazy_static = &quot;~1.4.0&quot;
</a> log = &quot;~0.4.14&quot;
 petname = &quot;1.1.3&quot;
 rand = &quot;~0.8.3&quot;
<b>diff --git a/<a id="h2" href="../file/src/encoding/bincode.rs.html">src/encoding/bincode.rs</a> b/<a href="../file/src/encoding/bincode.rs.html">src/encoding/bincode.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -3,25 +3,27 @@
</a> //! internal data structures being stable, but it&#39;s sufficient for toyDB. See:
 //! https://github.com/bincode-org/bincode
 //!
<a href="#h2-0-3" id="h2-0-3" class="d">-//! This module wraps the standard bincode crate to change the default settings.
</a><a href="#h2-0-4" id="h2-0-4" class="d">-//! In particular, to use variable-length integers rather than fixed-length.
</a><a href="#h2-0-5" id="h2-0-5" class="i">+//! This module wraps the standard bincode crate to change the default options,
</a><a href="#h2-0-6" id="h2-0-6" class="i">+//! in particular to use variable-length rather than fixed-length integers.
</a><a href="#h2-0-7" id="h2-0-7" class="i">+//! Confusingly, upstream bincode::(de)serialize uses different options (fixed)
</a><a href="#h2-0-8" id="h2-0-8" class="i">+//! than DefaultOptions (variable) -- this module always uses DefaultOptions.
</a> 
 use crate::error::Result;
 
 use bincode::Options;
<a href="#h2-0-13" id="h2-0-13" class="d">-use lazy_static::lazy_static;
</a> 
<a href="#h2-0-15" id="h2-0-15" class="d">-lazy_static! {
</a><a href="#h2-0-16" id="h2-0-16" class="d">-    /// Create a static binding for the default Bincode options.
</a><a href="#h2-0-17" id="h2-0-17" class="d">-    static ref BINCODE: bincode::DefaultOptions = bincode::DefaultOptions::new();
</a><a href="#h2-0-18" id="h2-0-18" class="i">+/// Returns the default Bincode options, initialized on first use.
</a><a href="#h2-0-19" id="h2-0-19" class="i">+fn bincode() -&gt; &amp;&#39;static bincode::DefaultOptions {
</a><a href="#h2-0-20" id="h2-0-20" class="i">+    static BINCODE: std::sync::OnceLock&lt;bincode::DefaultOptions&gt; = std::sync::OnceLock::new();
</a><a href="#h2-0-21" id="h2-0-21" class="i">+    BINCODE.get_or_init(bincode::DefaultOptions::new)
</a> }
 
 /// Deserializes a value using Bincode.
 pub fn deserialize&lt;&#39;de, T: serde::Deserialize&lt;&#39;de&gt;&gt;(bytes: &amp;&#39;de [u8]) -&gt; Result&lt;T&gt; {
<a href="#h2-0-26" id="h2-0-26" class="d">-    Ok(BINCODE.deserialize(bytes)?)
</a><a href="#h2-0-27" id="h2-0-27" class="i">+    Ok(bincode().deserialize(bytes)?)
</a> }
 
 /// Serializes a value using Bincode.
 pub fn serialize&lt;T: serde::Serialize&gt;(value: &amp;T) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
<a href="#h2-0-32" id="h2-0-32" class="d">-    Ok(BINCODE.serialize(value)?)
</a><a href="#h2-0-33" id="h2-0-33" class="i">+    Ok(bincode().serialize(value)?)
</a> }
<b>diff --git a/<a id="h3" href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a> b/<a href="../file/src/sql/parser/mod.rs.html">src/sql/parser/mod.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -5,7 +5,6 @@ pub use lexer::{Keyword, Lexer, Token};
</a> use super::types::DataType;
 use crate::error::{Error, Result};
 
<a href="#h3-0-3" id="h3-0-3" class="d">-use lazy_static::lazy_static;
</a> use regex::Regex;
 use std::collections::BTreeMap;
 
<a href="#h3-1" id="h3-1" class="h">@@ -788,11 +787,10 @@ impl Operator for PostfixOperator {
</a> 
 // Formats an identifier by quoting it as appropriate
 pub(super) fn format_ident(ident: &amp;str) -&gt; String {
<a href="#h3-1-3" id="h3-1-3" class="d">-    lazy_static! {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-        static ref RE_IDENT: Regex = Regex::new(r#&quot;^\w[\w_]*$&quot;#).unwrap();
</a><a href="#h3-1-5" id="h3-1-5" class="d">-    }
</a><a href="#h3-1-6" id="h3-1-6" class="i">+    static RE_IDENT: std::sync::OnceLock&lt;Regex&gt; = std::sync::OnceLock::new();
</a><a href="#h3-1-7" id="h3-1-7" class="i">+    let re_ident = RE_IDENT.get_or_init(|| Regex::new(r#&quot;^\w[\w_]*$&quot;#).unwrap());
</a> 
<a href="#h3-1-9" id="h3-1-9" class="d">-    if RE_IDENT.is_match(ident) &amp;&amp; Keyword::from_str(ident).is_none() {
</a><a href="#h3-1-10" id="h3-1-10" class="i">+    if re_ident.is_match(ident) &amp;&amp; Keyword::from_str(ident).is_none() {
</a>         ident.to_string()
     } else {
         format!(&quot;\&quot;{}\&quot;&quot;, ident.replace(&#39;\&quot;&#39;, &quot;\&quot;\&quot;&quot;))
<b>diff --git a/<a id="h4" href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a> b/<a href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -15,7 +15,7 @@ use serial_test::serial;
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn get_table() -&gt; Result&lt;()&gt; {
<a href="#h4-0-3" id="h4-0-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::MOVIES).await?;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+    let tc = TestCluster::run_with(5, dataset::MOVIES).await?;
</a>     let mut c = tc.connect_any().await?;
 
     assert_eq!(
<a href="#h4-1" id="h4-1" class="h">@@ -106,7 +106,7 @@ async fn get_table() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn list_tables() -&gt; Result&lt;()&gt; {
<a href="#h4-1-3" id="h4-1-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::MOVIES).await?;
</a><a href="#h4-1-4" id="h4-1-4" class="i">+    let tc = TestCluster::run_with(5, dataset::MOVIES).await?;
</a>     let mut c = tc.connect_any().await?;
 
     assert_eq!(c.list_tables().await?, vec![&quot;countries&quot;, &quot;genres&quot;, &quot;movies&quot;, &quot;studios&quot;]);
<a href="#h4-2" id="h4-2" class="h">@@ -116,7 +116,7 @@ async fn list_tables() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn status() -&gt; Result&lt;()&gt; {
<a href="#h4-2-3" id="h4-2-3" class="d">-    let tc = TestCluster::run_with(1, &amp;dataset::MOVIES).await?;
</a><a href="#h4-2-4" id="h4-2-4" class="i">+    let tc = TestCluster::run_with(1, dataset::MOVIES).await?;
</a>     let mut c = tc.connect_any().await?;
 
     assert_eq!(
<a href="#h4-3" id="h4-3" class="h">@@ -158,7 +158,7 @@ async fn status() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn execute() -&gt; Result&lt;()&gt; {
<a href="#h4-3-3" id="h4-3-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::MOVIES).await?;
</a><a href="#h4-3-4" id="h4-3-4" class="i">+    let tc = TestCluster::run_with(5, dataset::MOVIES).await?;
</a>     let mut c = tc.connect_any().await?;
 
     // SELECT
<a href="#h4-4" id="h4-4" class="h">@@ -242,7 +242,7 @@ async fn execute() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn execute_txn() -&gt; Result&lt;()&gt; {
<a href="#h4-4-3" id="h4-4-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::MOVIES).await?;
</a><a href="#h4-4-4" id="h4-4-4" class="i">+    let tc = TestCluster::run_with(5, dataset::MOVIES).await?;
</a>     let mut c = tc.connect_any().await?;
 
     assert_eq!(c.txn(), None);
<a href="#h4-5" id="h4-5" class="h">@@ -334,7 +334,7 @@ async fn execute_txn() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn execute_txn_concurrent() -&gt; Result&lt;()&gt; {
<a href="#h4-5-3" id="h4-5-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::MOVIES).await?;
</a><a href="#h4-5-4" id="h4-5-4" class="i">+    let tc = TestCluster::run_with(5, dataset::MOVIES).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
 
<b>diff --git a/<a id="h5" href="../file/tests/e2e/dataset.rs.html">tests/e2e/dataset.rs</a> b/<a href="../file/tests/e2e/dataset.rs.html">tests/e2e/dataset.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,11 +1,8 @@
</a> //! Pre-defined datasets.
 
<a href="#h5-0-2" id="h5-0-2" class="d">-use lazy_static::lazy_static;
</a><a href="#h5-0-3" id="h5-0-3" class="i">+pub static TEST_TABLE: &amp;str = &quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;;
</a> 
<a href="#h5-0-5" id="h5-0-5" class="d">-lazy_static! {
</a><a href="#h5-0-6" id="h5-0-6" class="d">-    pub static ref TEST_TABLE: &amp;&#39;static str =
</a><a href="#h5-0-7" id="h5-0-7" class="d">-        &quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;;
</a><a href="#h5-0-8" id="h5-0-8" class="d">-    pub static ref MOVIES: &amp;&#39;static str = &quot;
</a><a href="#h5-0-9" id="h5-0-9" class="i">+pub static MOVIES: &amp;str = &quot;
</a>         CREATE TABLE countries (
             id STRING PRIMARY KEY,
             name STRING NOT NULL
<a href="#h5-1" id="h5-1" class="h">@@ -52,4 +49,3 @@ lazy_static! {
</a>             (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE),
             (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE),
             (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)&quot;;
<a href="#h5-1-3" id="h5-1-3" class="d">-}
</a><b>diff --git a/<a id="h6" href="../file/tests/e2e/isolation.rs.html">tests/e2e/isolation.rs</a> b/<a href="../file/tests/e2e/isolation.rs.html">tests/e2e/isolation.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -8,7 +8,7 @@ use toydb::sql::types::Value;
</a> #[serial]
 // A dirty write is when b overwrites an uncommitted value written by a.
 async fn dirty_write() -&gt; Result&lt;()&gt; {
<a href="#h6-0-3" id="h6-0-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
 
<a href="#h6-1" id="h6-1" class="h">@@ -30,7 +30,7 @@ async fn dirty_write() -&gt; Result&lt;()&gt; {
</a> #[serial]
 // A dirty read is when b can read an uncommitted value set by a.
 async fn anomaly_dirty_read() -&gt; Result&lt;()&gt; {
<a href="#h6-1-3" id="h6-1-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-1-4" id="h6-1-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
 
<a href="#h6-2" id="h6-2" class="h">@@ -46,7 +46,7 @@ async fn anomaly_dirty_read() -&gt; Result&lt;()&gt; {
</a> #[serial]
 // A lost update is when a and b both read a value and update it, where b&#39;s update replaces a.
 async fn anomaly_lost_update() -&gt; Result&lt;()&gt; {
<a href="#h6-2-3" id="h6-2-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-2-4" id="h6-2-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
     let mut c = tc.connect_any().await?;
<a href="#h6-3" id="h6-3" class="h">@@ -75,7 +75,7 @@ async fn anomaly_lost_update() -&gt; Result&lt;()&gt; {
</a> #[serial]
 // A fuzzy (or unrepeatable) read is when b sees a value change after a updates it.
 async fn anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
<a href="#h6-3-3" id="h6-3-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-3-4" id="h6-3-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
     let mut c = tc.connect_any().await?;
<a href="#h6-4" id="h6-4" class="h">@@ -103,7 +103,7 @@ async fn anomaly_fuzzy_read() -&gt; Result&lt;()&gt; {
</a> #[serial]
 // Read skew is when a reads 1 and 2, but b modifies 2 in between the reads.
 async fn anomaly_read_skew() -&gt; Result&lt;()&gt; {
<a href="#h6-4-3" id="h6-4-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-4-4" id="h6-4-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
     let mut c = tc.connect_any().await?;
<a href="#h6-5" id="h6-5" class="h">@@ -132,7 +132,7 @@ async fn anomaly_read_skew() -&gt; Result&lt;()&gt; {
</a> // A phantom read is when a reads entries matching some predicate, but a modification by
 // b changes the entries that match the predicate such that a later read by a returns them.
 async fn anomaly_phantom_read() -&gt; Result&lt;()&gt; {
<a href="#h6-5-3" id="h6-5-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h6-5-4" id="h6-5-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
     let mut c = tc.connect_any().await?;
<b>diff --git a/<a id="h7" href="../file/tests/e2e/recovery.rs.html">tests/e2e/recovery.rs</a> b/<a href="../file/tests/e2e/recovery.rs.html">tests/e2e/recovery.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -8,7 +8,7 @@ use toydb::sql::types::Value;
</a> #[serial]
 // A client disconnect or termination should roll back its transaction.
 async fn client_disconnect_rollback() -&gt; Result&lt;()&gt; {
<a href="#h7-0-3" id="h7-0-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
 
<a href="#h7-1" id="h7-1" class="h">@@ -29,7 +29,7 @@ async fn client_disconnect_rollback() -&gt; Result&lt;()&gt; {
</a> #[tokio::test(flavor = &quot;multi_thread&quot;, worker_threads = 2)]
 #[serial]
 async fn client_commit_error() -&gt; Result&lt;()&gt; {
<a href="#h7-1-3" id="h7-1-3" class="d">-    let tc = TestCluster::run_with(5, &amp;dataset::TEST_TABLE).await?;
</a><a href="#h7-1-4" id="h7-1-4" class="i">+    let tc = TestCluster::run_with(5, dataset::TEST_TABLE).await?;
</a>     let mut a = tc.connect_any().await?;
     let mut b = tc.connect_any().await?;
 
</pre>
</div>
</body>
</html>
