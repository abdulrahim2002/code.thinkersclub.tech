<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>docs: add SQL usage examples. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/27f410edfddbd57e363bcc9a86ea2b1676e218f4.html">27f410edfddbd57e363bcc9a86ea2b1676e218f4</a>
<b>parent</b> <a href="../commit/fa33e0554cd8152fd76989b0b7c9cb6c22c6fd63.html">fa33e0554cd8152fd76989b0b7c9cb6c22c6fd63</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 13 Jun 2020 17:45:33 +0200

docs: add SQL usage examples.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.dockerignore</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">README.md</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++</span><span class="d">------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">docs/README.md</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">docs/examples.md</a></td><td> | </td><td class="num">561</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>4 files changed, 590 insertions(+), 58 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.dockerignore.html">.dockerignore</a> b/<a href="../file/.dockerignore.html">.dockerignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,2 +1,4 @@
</a> clusters
<a href="#h0-0-1" id="h0-0-1" class="d">-target
</a><a href="#h0-0-2" id="h0-0-2" class="d">-\ No newline at end of file
</a><a href="#h0-0-3" id="h0-0-3" class="i">+docs
</a><a href="#h0-0-4" id="h0-0-4" class="i">+target
</a><a href="#h0-0-5" id="h0-0-5" class="i">+tests
</a><a href="#h0-0-6" id="h0-0-6" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h1" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -18,28 +18,18 @@ For details, see the [documentation](docs/).
</a> 
 ## Usage
 
<a href="#h1-0-3" id="h1-0-3" class="d">-A local five-node cluster can be started on `localhost` ports `9601` to `9605` by running:
</a><a href="#h1-0-4" id="h1-0-4" class="i">+With a [Rust compiler](https://www.rust-lang.org/tools/install) installed, a local five-node 
</a><a href="#h1-0-5" id="h1-0-5" class="i">+cluster can be started on `localhost` ports `9601` to `9605`:
</a> 
 ```
<a href="#h1-0-8" id="h1-0-8" class="d">-# Local processes
</a> $ (cd clusters/local &amp;&amp; ./run.sh)
<a href="#h1-0-10" id="h1-0-10" class="d">-
</a><a href="#h1-0-11" id="h1-0-11" class="d">-# Docker containers 
</a><a href="#h1-0-12" id="h1-0-12" class="d">-$ (cd clusters/docker &amp;&amp; docker-compose up --build)
</a> ```
 
<a href="#h1-0-15" id="h1-0-15" class="d">-A command-line REPL client can be built and used with the node on `localhost` port `9605`
</a><a href="#h1-0-16" id="h1-0-16" class="d">-by running:
</a><a href="#h1-0-17" id="h1-0-17" class="i">+A command-line REPL client can be built and used with the node on `localhost` port `9605`:
</a> 
 ```
<a href="#h1-0-20" id="h1-0-20" class="d">-$ cargo run --bin toysql
</a><a href="#h1-0-21" id="h1-0-21" class="i">+$ cargo run --release --bin toysql
</a> Connected to node &quot;toydb-e&quot; (version 0.1.0). Enter !help for instructions.
<a href="#h1-0-23" id="h1-0-23" class="d">-toydb&gt;
</a><a href="#h1-0-24" id="h1-0-24" class="d">-```
</a><a href="#h1-0-25" id="h1-0-25" class="d">-
</a><a href="#h1-0-26" id="h1-0-26" class="d">-A basic subset of SQL has been partially implemented, e.g.:
</a><a href="#h1-0-27" id="h1-0-27" class="d">-
</a><a href="#h1-0-28" id="h1-0-28" class="d">-```
</a> toydb&gt; CREATE TABLE movies (id INTEGER PRIMARY KEY, title VARCHAR NOT NULL);
 toydb&gt; INSERT INTO movies VALUES (1, &#39;Sicario&#39;), (2, &#39;Stalker&#39;), (3, &#39;Her&#39;);
 toydb&gt; SELECT * FROM movies;
<a href="#h1-1" id="h1-1" class="h">@@ -48,49 +38,27 @@ toydb&gt; SELECT * FROM movies;
</a> 3|Her
 ```
 
<a href="#h1-1-3" id="h1-1-3" class="d">-ACID transactions are supported via snapshot isolation:
</a><a href="#h1-1-4" id="h1-1-4" class="i">+toyDB supports most common SQL features, including joins, aggregates, and ACID transactions.
</a><a href="#h1-1-5" id="h1-1-5" class="i">+For more information, see the [SQL usage examples](docs/examples.md) or the
</a><a href="#h1-1-6" id="h1-1-6" class="i">+[SQL reference](docs/sql.md).
</a> 
<a href="#h1-1-8" id="h1-1-8" class="d">-```
</a><a href="#h1-1-9" id="h1-1-9" class="d">-toydb&gt; BEGIN;
</a><a href="#h1-1-10" id="h1-1-10" class="d">-Began transaction 3
</a><a href="#h1-1-11" id="h1-1-11" class="d">-toydb:3&gt; INSERT INTO movies VALUES (4, &#39;Alien vs. Predator&#39;);
</a><a href="#h1-1-12" id="h1-1-12" class="d">-toydb:3&gt; ROLLBACK;
</a><a href="#h1-1-13" id="h1-1-13" class="d">-Rolled back transaction 3
</a><a href="#h1-1-14" id="h1-1-14" class="d">-
</a><a href="#h1-1-15" id="h1-1-15" class="d">-toydb&gt; BEGIN;
</a><a href="#h1-1-16" id="h1-1-16" class="d">-Began transaction 4
</a><a href="#h1-1-17" id="h1-1-17" class="d">-toydb:4&gt; INSERT INTO movies VALUES (4, &#39;Alien&#39;), (5, &#39;Predator&#39;);
</a><a href="#h1-1-18" id="h1-1-18" class="d">-toydb:4&gt; COMMIT;
</a><a href="#h1-1-19" id="h1-1-19" class="d">-Committed transaction 4
</a><a href="#h1-1-20" id="h1-1-20" class="d">-
</a><a href="#h1-1-21" id="h1-1-21" class="d">-toydb&gt; SELECT * FROM movies;
</a><a href="#h1-1-22" id="h1-1-22" class="d">-1|Sicario
</a><a href="#h1-1-23" id="h1-1-23" class="d">-2|Stalker
</a><a href="#h1-1-24" id="h1-1-24" class="d">-3|Her
</a><a href="#h1-1-25" id="h1-1-25" class="d">-4|Alien
</a><a href="#h1-1-26" id="h1-1-26" class="d">-5|Predator
</a><a href="#h1-1-27" id="h1-1-27" class="d">-```
</a><a href="#h1-1-28" id="h1-1-28" class="i">+## Tests
</a> 
<a href="#h1-1-30" id="h1-1-30" class="d">-Time-travel queries are also supported:
</a><a href="#h1-1-31" id="h1-1-31" class="i">+toyDB has decent test coverage, with about a thousand tests of core functionality. These are
</a><a href="#h1-1-32" id="h1-1-32" class="i">+comprised of in-code unit-tests for many low-level components (e.g. Raft protocol, B+tree
</a><a href="#h1-1-33" id="h1-1-33" class="i">+storage, and MVCC engine), golden master integration tests of the SQL engine under `tests/sql`,
</a><a href="#h1-1-34" id="h1-1-34" class="i">+and a basic set of end-to-end cluster tests under `tests/`. Jepsen tests, or similar
</a><a href="#h1-1-35" id="h1-1-35" class="i">+system-wide correctness and reliability tests, are desirable but not yet implemented.
</a> 
<a href="#h1-1-37" id="h1-1-37" class="d">-```
</a><a href="#h1-1-38" id="h1-1-38" class="d">-toydb&gt; BEGIN TRANSACTION READ ONLY AS OF SYSTEM TIME 2;
</a><a href="#h1-1-39" id="h1-1-39" class="d">-Began read-only transaction in snapshot of version 2
</a><a href="#h1-1-40" id="h1-1-40" class="d">-toydb@1&gt; SELECT * FROM movies;
</a><a href="#h1-1-41" id="h1-1-41" class="d">-1|Sicario
</a><a href="#h1-1-42" id="h1-1-42" class="d">-2|Stalker
</a><a href="#h1-1-43" id="h1-1-43" class="d">-3|Her
</a><a href="#h1-1-44" id="h1-1-44" class="d">-```
</a><a href="#h1-1-45" id="h1-1-45" class="i">+To run all tests, execute `cargo test`, or check out the latest
</a><a href="#h1-1-46" id="h1-1-46" class="i">+[CI run](https://cloud.drone.io/erikgrinaker/toydb).
</a> 
 ## Performance
 
<a href="#h1-1-50" id="h1-1-50" class="d">-Performance is not a primary goal of toyDB, but it uses a bank simulation as a basic gauge of
</a><a href="#h1-1-51" id="h1-1-51" class="i">+Performance is not a primary goal of toyDB, but it has a bank simulation as a basic gauge of
</a> throughput and correctness. This creates a set of customers and accounts, then spawns several
 concurrent workers that make random transfers between them, retrying serialization failures and
<a href="#h1-1-54" id="h1-1-54" class="d">-verifying invariants.
</a><a href="#h1-1-55" id="h1-1-55" class="d">-
</a><a href="#h1-1-56" id="h1-1-56" class="d">-A simulation with 8 workers, 100 customers, 10 accounts each, and 1000 transactions can be run
</a><a href="#h1-1-57" id="h1-1-57" class="d">-against a toyDB server on `localhost:9605` as:
</a><a href="#h1-1-58" id="h1-1-58" class="i">+verifying invariants:
</a> 
 ```sh
 $ cargo run --release --bin bank -- -c 8 -C 100 -t 1000
<a href="#h1-2" id="h1-2" class="h">@@ -109,13 +77,13 @@ Ran 1000 transactions in 0.937s (1067.691/s)
</a> Verified that total balance is 100000 with no negative balances
 ```
 
<a href="#h1-2-3" id="h1-2-3" class="d">-The informal target was 100 transactions per second, but the above results beat that by an order
</a><a href="#h1-2-4" id="h1-2-4" class="d">-of magnitude. For an unoptimized implementation, this is certainly &quot;good enough&quot;. However,
</a><a href="#h1-2-5" id="h1-2-5" class="d">-these results are for a single node with fsync disabled - the below table shows results for other
</a><a href="#h1-2-6" id="h1-2-6" class="d">-configurations, revealing clear potential for improvements:
</a><a href="#h1-2-7" id="h1-2-7" class="i">+The informal target was 100 transactions per second, but these results exceed that by an order
</a><a href="#h1-2-8" id="h1-2-8" class="i">+of magnitude. For an unoptimized implementation, this is certainly &quot;good enough&quot;. However, this
</a><a href="#h1-2-9" id="h1-2-9" class="i">+used a single node with fsync disabled - the below table shows results for other configurations,
</a><a href="#h1-2-10" id="h1-2-10" class="i">+revealing clear potential for improvement:
</a> 
 |             | `sync: false` | `sync: true` |
<a href="#h1-2-13" id="h1-2-13" class="d">-| ----------- | ------------- | ------------ |
</a><a href="#h1-2-14" id="h1-2-14" class="i">+|-------------|---------------|--------------|
</a> | **1 node**  | 1067 txn/s    | 38 txn/s     |
 | **5 nodes** | 417 txn/s     | 19 txn/s     |
 
<b>diff --git a/<a id="h2" href="../file/docs/README.md.html">docs/README.md</a> b/<a href="../file/docs/README.md.html">docs/README.md</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,3 +1,5 @@
</a> # toyDB Documentation
 
<a href="#h2-0-2" id="h2-0-2" class="d">-* [SQL reference](sql.md)
</a><a href="#h2-0-3" id="h2-0-3" class="d">-\ No newline at end of file
</a><a href="#h2-0-4" id="h2-0-4" class="i">+* [SQL Usage Examples](examples.md)
</a><a href="#h2-0-5" id="h2-0-5" class="i">+* 
</a><a href="#h2-0-6" id="h2-0-6" class="i">+* [SQL Reference](sql.md)
</a><b>diff --git a/<a id="h3" href="../file/docs/examples.md.html">docs/examples.md</a> b/<a href="../file/docs/examples.md.html">docs/examples.md</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,560 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+# SQL Usage Examples
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+The following examples demonstrate some of toyDB&#39;s SQL features. For more details, see the
</a><a href="#h3-0-3" id="h3-0-3" class="i">+[SQL reference](sql.md).
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+- [Setup](#setup)
</a><a href="#h3-0-6" id="h3-0-6" class="i">+- [Creating Tables and Data](#creating-tables-and-data)
</a><a href="#h3-0-7" id="h3-0-7" class="i">+- [Constraints and Referential Integrity](#constraints-and-referential-integrity)
</a><a href="#h3-0-8" id="h3-0-8" class="i">+- [Basic SQL Queries](#basic-sql-queries)
</a><a href="#h3-0-9" id="h3-0-9" class="i">+- [Expressions](#expressions)
</a><a href="#h3-0-10" id="h3-0-10" class="i">+- [Joins](#joins)
</a><a href="#h3-0-11" id="h3-0-11" class="i">+- [Explain](#explain)
</a><a href="#h3-0-12" id="h3-0-12" class="i">+- [Aggregates](#aggregates)
</a><a href="#h3-0-13" id="h3-0-13" class="i">+- [Transactions](#transactions)
</a><a href="#h3-0-14" id="h3-0-14" class="i">+- [Time-Travel Queries](#time-travel-queries)
</a><a href="#h3-0-15" id="h3-0-15" class="i">+
</a><a href="#h3-0-16" id="h3-0-16" class="i">+## Setup
</a><a href="#h3-0-17" id="h3-0-17" class="i">+
</a><a href="#h3-0-18" id="h3-0-18" class="i">+To start a five-node cluster on the local machine (requires a working
</a><a href="#h3-0-19" id="h3-0-19" class="i">+[Rust compiler](https://www.rust-lang.org/tools/install)), run:
</a><a href="#h3-0-20" id="h3-0-20" class="i">+
</a><a href="#h3-0-21" id="h3-0-21" class="i">+```
</a><a href="#h3-0-22" id="h3-0-22" class="i">+$ (cd clusters/local &amp;&amp; ./run.sh)
</a><a href="#h3-0-23" id="h3-0-23" class="i">+toydb-b 19:06:28 [ INFO] Listening on 0.0.0.0:9602 (SQL) and 0.0.0.0:9702 (Raft)
</a><a href="#h3-0-24" id="h3-0-24" class="i">+toydb-b 19:06:28 [ERROR] Failed connecting to Raft peer 127.0.0.1:9705: Connection refused
</a><a href="#h3-0-25" id="h3-0-25" class="i">+toydb-e 19:06:28 [ INFO] Listening on 0.0.0.0:9605 (SQL) and 0.0.0.0:9705 (Raft)
</a><a href="#h3-0-26" id="h3-0-26" class="i">+[...]
</a><a href="#h3-0-27" id="h3-0-27" class="i">+toydb-e 19:06:29 [ INFO] Voting for toydb-d in term 1 election
</a><a href="#h3-0-28" id="h3-0-28" class="i">+toydb-c 19:06:29 [ INFO] Voting for toydb-d in term 1 election
</a><a href="#h3-0-29" id="h3-0-29" class="i">+toydb-d 19:06:29 [ INFO] Won election for term 1, becoming leader
</a><a href="#h3-0-30" id="h3-0-30" class="i">+```
</a><a href="#h3-0-31" id="h3-0-31" class="i">+
</a><a href="#h3-0-32" id="h3-0-32" class="i">+In a separate terminal, start a `toysql` client and check the server status:
</a><a href="#h3-0-33" id="h3-0-33" class="i">+
</a><a href="#h3-0-34" id="h3-0-34" class="i">+```
</a><a href="#h3-0-35" id="h3-0-35" class="i">+$ cargo run --release --bin toysql
</a><a href="#h3-0-36" id="h3-0-36" class="i">+Connected to toyDB node &quot;toydb-e&quot;. Enter !help for instructions.
</a><a href="#h3-0-37" id="h3-0-37" class="i">+toydb&gt; !status
</a><a href="#h3-0-38" id="h3-0-38" class="i">+
</a><a href="#h3-0-39" id="h3-0-39" class="i">+Server:    toydb-e (leader toydb-d in term 1 with 5 nodes)
</a><a href="#h3-0-40" id="h3-0-40" class="i">+Raft log:  1 committed, 0 applied, 0.000 MB (hybrid storage)
</a><a href="#h3-0-41" id="h3-0-41" class="i">+Node logs: toydb-a:1 toydb-b:1 toydb-c:1 toydb-d:1 toydb-e:1
</a><a href="#h3-0-42" id="h3-0-42" class="i">+SQL txns:  0 active, 0 total (memory storage)
</a><a href="#h3-0-43" id="h3-0-43" class="i">+```
</a><a href="#h3-0-44" id="h3-0-44" class="i">+
</a><a href="#h3-0-45" id="h3-0-45" class="i">+The cluster is shut down by pressing Ctrl-C. Data is saved under `clusters/local/toydb-?/data/`,
</a><a href="#h3-0-46" id="h3-0-46" class="i">+delete the contents to start over.
</a><a href="#h3-0-47" id="h3-0-47" class="i">+
</a><a href="#h3-0-48" id="h3-0-48" class="i">+## Creating Tables and Data
</a><a href="#h3-0-49" id="h3-0-49" class="i">+
</a><a href="#h3-0-50" id="h3-0-50" class="i">+As a basis for later examples, we&#39;ll create a small movie database. The following SQL statements
</a><a href="#h3-0-51" id="h3-0-51" class="i">+can be pasted into `toysql`:
</a><a href="#h3-0-52" id="h3-0-52" class="i">+
</a><a href="#h3-0-53" id="h3-0-53" class="i">+```sql
</a><a href="#h3-0-54" id="h3-0-54" class="i">+CREATE TABLE genres (
</a><a href="#h3-0-55" id="h3-0-55" class="i">+    id INTEGER PRIMARY KEY,
</a><a href="#h3-0-56" id="h3-0-56" class="i">+    name STRING NOT NULL
</a><a href="#h3-0-57" id="h3-0-57" class="i">+);
</a><a href="#h3-0-58" id="h3-0-58" class="i">+INSERT INTO genres VALUES
</a><a href="#h3-0-59" id="h3-0-59" class="i">+    (1, &#39;Science Fiction&#39;),
</a><a href="#h3-0-60" id="h3-0-60" class="i">+    (2, &#39;Action&#39;),
</a><a href="#h3-0-61" id="h3-0-61" class="i">+    (3, &#39;Drama&#39;),
</a><a href="#h3-0-62" id="h3-0-62" class="i">+    (4, &#39;Comedy&#39;);
</a><a href="#h3-0-63" id="h3-0-63" class="i">+
</a><a href="#h3-0-64" id="h3-0-64" class="i">+CREATE TABLE studios (
</a><a href="#h3-0-65" id="h3-0-65" class="i">+    id INTEGER PRIMARY KEY,
</a><a href="#h3-0-66" id="h3-0-66" class="i">+    name STRING NOT NULL
</a><a href="#h3-0-67" id="h3-0-67" class="i">+);
</a><a href="#h3-0-68" id="h3-0-68" class="i">+INSERT INTO studios VALUES
</a><a href="#h3-0-69" id="h3-0-69" class="i">+    (1, &#39;Mosfilm&#39;),
</a><a href="#h3-0-70" id="h3-0-70" class="i">+    (2, &#39;Lionsgate&#39;),
</a><a href="#h3-0-71" id="h3-0-71" class="i">+    (3, &#39;StudioCanal&#39;),
</a><a href="#h3-0-72" id="h3-0-72" class="i">+    (4, &#39;Warner Bros&#39;),
</a><a href="#h3-0-73" id="h3-0-73" class="i">+    (5, &#39;Focus Features&#39;);
</a><a href="#h3-0-74" id="h3-0-74" class="i">+
</a><a href="#h3-0-75" id="h3-0-75" class="i">+CREATE TABLE movies (
</a><a href="#h3-0-76" id="h3-0-76" class="i">+    id INTEGER PRIMARY KEY,
</a><a href="#h3-0-77" id="h3-0-77" class="i">+    title STRING NOT NULL,
</a><a href="#h3-0-78" id="h3-0-78" class="i">+    studio_id INTEGER NOT NULL INDEX REFERENCES studios,
</a><a href="#h3-0-79" id="h3-0-79" class="i">+    genre_id INTEGER NOT NULL INDEX REFERENCES genres,
</a><a href="#h3-0-80" id="h3-0-80" class="i">+    released INTEGER NOT NULL,
</a><a href="#h3-0-81" id="h3-0-81" class="i">+    rating FLOAT
</a><a href="#h3-0-82" id="h3-0-82" class="i">+);
</a><a href="#h3-0-83" id="h3-0-83" class="i">+INSERT INTO movies VALUES
</a><a href="#h3-0-84" id="h3-0-84" class="i">+    (1,  &#39;Stalker&#39;,             1, 1, 1979, 8.2),
</a><a href="#h3-0-85" id="h3-0-85" class="i">+    (2,  &#39;Sicario&#39;,             2, 2, 2015, 7.6),
</a><a href="#h3-0-86" id="h3-0-86" class="i">+    (3,  &#39;Primer&#39;,              3, 1, 2004, 6.9),
</a><a href="#h3-0-87" id="h3-0-87" class="i">+    (4,  &#39;Heat&#39;,                4, 2, 1995, 8.2),
</a><a href="#h3-0-88" id="h3-0-88" class="i">+    (5,  &#39;The Fountain&#39;,        4, 1, 2006, 7.2),
</a><a href="#h3-0-89" id="h3-0-89" class="i">+    (6,  &#39;Solaris&#39;,             1, 1, 1972, 8.1),
</a><a href="#h3-0-90" id="h3-0-90" class="i">+    (7,  &#39;Gravity&#39;,             4, 1, 2013, 7.7),
</a><a href="#h3-0-91" id="h3-0-91" class="i">+    (8,  &#39;21 Grams&#39;,            5, 3, 2003, 7.7),
</a><a href="#h3-0-92" id="h3-0-92" class="i">+    (9,  &#39;Birdman&#39;,             4, 4, 2014, 7.7),
</a><a href="#h3-0-93" id="h3-0-93" class="i">+    (10, &#39;Inception&#39;,           4, 1, 2010, 8.8),
</a><a href="#h3-0-94" id="h3-0-94" class="i">+    (11, &#39;Lost in Translation&#39;, 5, 4, 2003, 7.7),
</a><a href="#h3-0-95" id="h3-0-95" class="i">+    (12, &#39;Eternal Sunshine of the Spotless Mind&#39;, 5, 3, 2004, 8.3);
</a><a href="#h3-0-96" id="h3-0-96" class="i">+```
</a><a href="#h3-0-97" id="h3-0-97" class="i">+
</a><a href="#h3-0-98" id="h3-0-98" class="i">+toyDB supports some basic datatypes, as well as primary keys, foreign keys, and column indexes.
</a><a href="#h3-0-99" id="h3-0-99" class="i">+For more information on these, see the [SQL reference](sql.md). Schema changes such as
</a><a href="#h3-0-100" id="h3-0-100" class="i">+`ALTER TABLE` are not supported, only `CREATE TABLE` and `DROP TABLE`.
</a><a href="#h3-0-101" id="h3-0-101" class="i">+
</a><a href="#h3-0-102" id="h3-0-102" class="i">+The tables can be inspected via the `!tables` and `!table` commands:
</a><a href="#h3-0-103" id="h3-0-103" class="i">+
</a><a href="#h3-0-104" id="h3-0-104" class="i">+```sql
</a><a href="#h3-0-105" id="h3-0-105" class="i">+toydb&gt; !tables
</a><a href="#h3-0-106" id="h3-0-106" class="i">+genres
</a><a href="#h3-0-107" id="h3-0-107" class="i">+movies
</a><a href="#h3-0-108" id="h3-0-108" class="i">+studios
</a><a href="#h3-0-109" id="h3-0-109" class="i">+
</a><a href="#h3-0-110" id="h3-0-110" class="i">+toydb&gt; !table genres
</a><a href="#h3-0-111" id="h3-0-111" class="i">+CREATE TABLE genres (
</a><a href="#h3-0-112" id="h3-0-112" class="i">+  id INTEGER PRIMARY KEY,
</a><a href="#h3-0-113" id="h3-0-113" class="i">+  name STRING NOT NULL
</a><a href="#h3-0-114" id="h3-0-114" class="i">+)
</a><a href="#h3-0-115" id="h3-0-115" class="i">+```
</a><a href="#h3-0-116" id="h3-0-116" class="i">+
</a><a href="#h3-0-117" id="h3-0-117" class="i">+## Constraints and Referential Integrity
</a><a href="#h3-0-118" id="h3-0-118" class="i">+
</a><a href="#h3-0-119" id="h3-0-119" class="i">+Schemas enforce referential integrity and other constraints:
</a><a href="#h3-0-120" id="h3-0-120" class="i">+
</a><a href="#h3-0-121" id="h3-0-121" class="i">+```sql
</a><a href="#h3-0-122" id="h3-0-122" class="i">+toydb&gt; DROP TABLE studios;
</a><a href="#h3-0-123" id="h3-0-123" class="i">+Error: Table studios is referenced by table movies column studio_id
</a><a href="#h3-0-124" id="h3-0-124" class="i">+
</a><a href="#h3-0-125" id="h3-0-125" class="i">+toydb&gt; DELETE FROM studios WHERE id = 1;
</a><a href="#h3-0-126" id="h3-0-126" class="i">+Error: Primary key 1 is referenced by table movies column studio_id
</a><a href="#h3-0-127" id="h3-0-127" class="i">+
</a><a href="#h3-0-128" id="h3-0-128" class="i">+toydb&gt; UPDATE movies SET id = 1;
</a><a href="#h3-0-129" id="h3-0-129" class="i">+Error: Primary key 1 already exists for table movies
</a><a href="#h3-0-130" id="h3-0-130" class="i">+
</a><a href="#h3-0-131" id="h3-0-131" class="i">+toydb&gt; INSERT INTO movies VALUES (13, &#39;Nebraska&#39;, 6, 3, 2013, 7.7);
</a><a href="#h3-0-132" id="h3-0-132" class="i">+Error: Referenced primary key 6 in table studios does not exist
</a><a href="#h3-0-133" id="h3-0-133" class="i">+
</a><a href="#h3-0-134" id="h3-0-134" class="i">+toydb&gt; INSERT INTO movies VALUES (13, &#39;Nebraska&#39;, NULL, 3, 2013, 7.7);
</a><a href="#h3-0-135" id="h3-0-135" class="i">+Error: NULL value not allowed for column studio_id
</a><a href="#h3-0-136" id="h3-0-136" class="i">+
</a><a href="#h3-0-137" id="h3-0-137" class="i">+toydb&gt; INSERT INTO movies VALUES (13, &#39;Nebraska&#39;, &#39;Unknown&#39;, 3, 2013, 7.7);
</a><a href="#h3-0-138" id="h3-0-138" class="i">+Error: Invalid datatype STRING for INTEGER column studio_id
</a><a href="#h3-0-139" id="h3-0-139" class="i">+```
</a><a href="#h3-0-140" id="h3-0-140" class="i">+
</a><a href="#h3-0-141" id="h3-0-141" class="i">+## Basic SQL Queries
</a><a href="#h3-0-142" id="h3-0-142" class="i">+
</a><a href="#h3-0-143" id="h3-0-143" class="i">+Most basic SQL query functionality is supported:
</a><a href="#h3-0-144" id="h3-0-144" class="i">+
</a><a href="#h3-0-145" id="h3-0-145" class="i">+```sql
</a><a href="#h3-0-146" id="h3-0-146" class="i">+toydb&gt; SELECT * FROM studios;
</a><a href="#h3-0-147" id="h3-0-147" class="i">+1|Mosfilm
</a><a href="#h3-0-148" id="h3-0-148" class="i">+2|Lionsgate
</a><a href="#h3-0-149" id="h3-0-149" class="i">+3|StudioCanal
</a><a href="#h3-0-150" id="h3-0-150" class="i">+4|Warner Bros
</a><a href="#h3-0-151" id="h3-0-151" class="i">+5|Focus Features
</a><a href="#h3-0-152" id="h3-0-152" class="i">+
</a><a href="#h3-0-153" id="h3-0-153" class="i">+toydb&gt; SELECT title, rating FROM movies WHERE released &gt;= 2000 ORDER BY rating DESC LIMIT 3;
</a><a href="#h3-0-154" id="h3-0-154" class="i">+Inception|8.8
</a><a href="#h3-0-155" id="h3-0-155" class="i">+Eternal Sunshine of the Spotless Mind|8.3
</a><a href="#h3-0-156" id="h3-0-156" class="i">+Gravity|7.7
</a><a href="#h3-0-157" id="h3-0-157" class="i">+```
</a><a href="#h3-0-158" id="h3-0-158" class="i">+
</a><a href="#h3-0-159" id="h3-0-159" class="i">+Column headers can be enabled with `!headers on`:
</a><a href="#h3-0-160" id="h3-0-160" class="i">+
</a><a href="#h3-0-161" id="h3-0-161" class="i">+```sql
</a><a href="#h3-0-162" id="h3-0-162" class="i">+toydb&gt; !headers on
</a><a href="#h3-0-163" id="h3-0-163" class="i">+Headers enabled
</a><a href="#h3-0-164" id="h3-0-164" class="i">+
</a><a href="#h3-0-165" id="h3-0-165" class="i">+toydb&gt; SELECT id, name AS genre FROM genres;
</a><a href="#h3-0-166" id="h3-0-166" class="i">+id|genre
</a><a href="#h3-0-167" id="h3-0-167" class="i">+1|Science Fiction
</a><a href="#h3-0-168" id="h3-0-168" class="i">+2|Action
</a><a href="#h3-0-169" id="h3-0-169" class="i">+3|Drama
</a><a href="#h3-0-170" id="h3-0-170" class="i">+4|Comedy
</a><a href="#h3-0-171" id="h3-0-171" class="i">+```
</a><a href="#h3-0-172" id="h3-0-172" class="i">+
</a><a href="#h3-0-173" id="h3-0-173" class="i">+## Expressions
</a><a href="#h3-0-174" id="h3-0-174" class="i">+
</a><a href="#h3-0-175" id="h3-0-175" class="i">+All common mathematical operators are implemented:
</a><a href="#h3-0-176" id="h3-0-176" class="i">+
</a><a href="#h3-0-177" id="h3-0-177" class="i">+```sql
</a><a href="#h3-0-178" id="h3-0-178" class="i">+toydb&gt; SELECT 1 + 2 * 3;
</a><a href="#h3-0-179" id="h3-0-179" class="i">+7
</a><a href="#h3-0-180" id="h3-0-180" class="i">+
</a><a href="#h3-0-181" id="h3-0-181" class="i">+toydb&gt; SELECT (1 + 2) * 4 / -3;
</a><a href="#h3-0-182" id="h3-0-182" class="i">+-4
</a><a href="#h3-0-183" id="h3-0-183" class="i">+
</a><a href="#h3-0-184" id="h3-0-184" class="i">+SELECT 3! + 7 % 4 - 2 ^ 3;
</a><a href="#h3-0-185" id="h3-0-185" class="i">+1
</a><a href="#h3-0-186" id="h3-0-186" class="i">+```
</a><a href="#h3-0-187" id="h3-0-187" class="i">+
</a><a href="#h3-0-188" id="h3-0-188" class="i">+Complete 64-bit floating point support is also provided, included handling of infinity and NaN:
</a><a href="#h3-0-189" id="h3-0-189" class="i">+
</a><a href="#h3-0-190" id="h3-0-190" class="i">+```sql
</a><a href="#h3-0-191" id="h3-0-191" class="i">+toydb&gt; SELECT 3.14 * 2.718;
</a><a href="#h3-0-192" id="h3-0-192" class="i">+8.53452
</a><a href="#h3-0-193" id="h3-0-193" class="i">+
</a><a href="#h3-0-194" id="h3-0-194" class="i">+toydb&gt; SELECT 1.0 / 0.0;
</a><a href="#h3-0-195" id="h3-0-195" class="i">+inf
</a><a href="#h3-0-196" id="h3-0-196" class="i">+
</a><a href="#h3-0-197" id="h3-0-197" class="i">+toydb&gt; SELECT 1e10 ^ 8;
</a><a href="#h3-0-198" id="h3-0-198" class="i">+100000000000000000000000000000000000000000000000000000000000000000000000000000000
</a><a href="#h3-0-199" id="h3-0-199" class="i">+
</a><a href="#h3-0-200" id="h3-0-200" class="i">+toydb&gt; SELECT 1e10 ^ 8 / INFINITY, 1e10 ^ 1e10, INFINITY / INFINITY;
</a><a href="#h3-0-201" id="h3-0-201" class="i">+0|inf|NaN
</a><a href="#h3-0-202" id="h3-0-202" class="i">+```
</a><a href="#h3-0-203" id="h3-0-203" class="i">+
</a><a href="#h3-0-204" id="h3-0-204" class="i">+And of course three-valued logic:
</a><a href="#h3-0-205" id="h3-0-205" class="i">+
</a><a href="#h3-0-206" id="h3-0-206" class="i">+```sql
</a><a href="#h3-0-207" id="h3-0-207" class="i">+toydb&gt; SELECT TRUE AND TRUE, TRUE AND FALSE, TRUE AND NULL, FALSE AND NULL;
</a><a href="#h3-0-208" id="h3-0-208" class="i">+TRUE|FALSE|NULL|FALSE
</a><a href="#h3-0-209" id="h3-0-209" class="i">+
</a><a href="#h3-0-210" id="h3-0-210" class="i">+toydb&gt; SELECT TRUE OR FALSE, FALSE OR FALSE, TRUE OR NULL, FALSE OR NULL;
</a><a href="#h3-0-211" id="h3-0-211" class="i">+TRUE|FALSE|TRUE|NULL
</a><a href="#h3-0-212" id="h3-0-212" class="i">+
</a><a href="#h3-0-213" id="h3-0-213" class="i">+toydb&gt; SELECT NOT TRUE, NOT FALSE, NOT NULL;
</a><a href="#h3-0-214" id="h3-0-214" class="i">+FALSE|TRUE|NULL
</a><a href="#h3-0-215" id="h3-0-215" class="i">+```
</a><a href="#h3-0-216" id="h3-0-216" class="i">+
</a><a href="#h3-0-217" id="h3-0-217" class="i">+Which would be useless without comparison operators for all types:
</a><a href="#h3-0-218" id="h3-0-218" class="i">+
</a><a href="#h3-0-219" id="h3-0-219" class="i">+```sql
</a><a href="#h3-0-220" id="h3-0-220" class="i">+toydb&gt; SELECT 3 &gt; 1, 3 &lt;= 1, 3 = 3.0;
</a><a href="#h3-0-221" id="h3-0-221" class="i">+TRUE|FALSE|TRUE
</a><a href="#h3-0-222" id="h3-0-222" class="i">+
</a><a href="#h3-0-223" id="h3-0-223" class="i">+toydb&gt; SELECT &#39;a&#39; = &#39;A&#39;, &#39;foo&#39; &gt; &#39;bar&#39;, &#39;👍&#39; != &#39;👎&#39;;
</a><a href="#h3-0-224" id="h3-0-224" class="i">+FALSE|TRUE|TRUE
</a><a href="#h3-0-225" id="h3-0-225" class="i">+
</a><a href="#h3-0-226" id="h3-0-226" class="i">+toydb&gt; SELECT INFINITY &gt; -INFINITY, NULL = NULL;
</a><a href="#h3-0-227" id="h3-0-227" class="i">+TRUE|NULL
</a><a href="#h3-0-228" id="h3-0-228" class="i">+```
</a><a href="#h3-0-229" id="h3-0-229" class="i">+
</a><a href="#h3-0-230" id="h3-0-230" class="i">+## Joins
</a><a href="#h3-0-231" id="h3-0-231" class="i">+
</a><a href="#h3-0-232" id="h3-0-232" class="i">+No SQL database would be complete without joins, and toyDB supports most join types such as
</a><a href="#h3-0-233" id="h3-0-233" class="i">+inner joins (both implicit and explicit):
</a><a href="#h3-0-234" id="h3-0-234" class="i">+
</a><a href="#h3-0-235" id="h3-0-235" class="i">+```sql
</a><a href="#h3-0-236" id="h3-0-236" class="i">+toydb&gt; SELECT m.id, m.title, g.name FROM movies m JOIN genres g ON m.genre_id = g.id LIMIT 4;
</a><a href="#h3-0-237" id="h3-0-237" class="i">+1|Stalker|Science Fiction
</a><a href="#h3-0-238" id="h3-0-238" class="i">+2|Sicario|Action
</a><a href="#h3-0-239" id="h3-0-239" class="i">+3|Primer|Science Fiction
</a><a href="#h3-0-240" id="h3-0-240" class="i">+4|Heat|Action
</a><a href="#h3-0-241" id="h3-0-241" class="i">+
</a><a href="#h3-0-242" id="h3-0-242" class="i">+toydb&gt; SELECT m.id, m.title, g.name FROM movies m, genres g WHERE m.genre_id = g.id LIMIT 4;
</a><a href="#h3-0-243" id="h3-0-243" class="i">+1|Stalker|Science Fiction
</a><a href="#h3-0-244" id="h3-0-244" class="i">+2|Sicario|Action
</a><a href="#h3-0-245" id="h3-0-245" class="i">+3|Primer|Science Fiction
</a><a href="#h3-0-246" id="h3-0-246" class="i">+4|Heat|Action
</a><a href="#h3-0-247" id="h3-0-247" class="i">+```
</a><a href="#h3-0-248" id="h3-0-248" class="i">+
</a><a href="#h3-0-249" id="h3-0-249" class="i">+Left and right outer joins:
</a><a href="#h3-0-250" id="h3-0-250" class="i">+
</a><a href="#h3-0-251" id="h3-0-251" class="i">+```sql
</a><a href="#h3-0-252" id="h3-0-252" class="i">+toydb&gt; SELECT s.id, s.name, g.name FROM studios s LEFT JOIN genres g ON s.id = g.id;
</a><a href="#h3-0-253" id="h3-0-253" class="i">+1|Mosfilm|Science Fiction
</a><a href="#h3-0-254" id="h3-0-254" class="i">+2|Lionsgate|Action
</a><a href="#h3-0-255" id="h3-0-255" class="i">+3|StudioCanal|Drama
</a><a href="#h3-0-256" id="h3-0-256" class="i">+4|Warner Bros|Comedy
</a><a href="#h3-0-257" id="h3-0-257" class="i">+5|Focus Features|NULL
</a><a href="#h3-0-258" id="h3-0-258" class="i">+
</a><a href="#h3-0-259" id="h3-0-259" class="i">+toydb&gt; SELECT g.id, g.name, s.name FROM genres g RIGHT JOIN studios s ON g.id = s.id;
</a><a href="#h3-0-260" id="h3-0-260" class="i">+1|Science Fiction|Mosfilm
</a><a href="#h3-0-261" id="h3-0-261" class="i">+2|Action|Lionsgate
</a><a href="#h3-0-262" id="h3-0-262" class="i">+3|Drama|StudioCanal
</a><a href="#h3-0-263" id="h3-0-263" class="i">+4|Comedy|Warner Bros
</a><a href="#h3-0-264" id="h3-0-264" class="i">+NULL|NULL|Focus Features
</a><a href="#h3-0-265" id="h3-0-265" class="i">+```
</a><a href="#h3-0-266" id="h3-0-266" class="i">+
</a><a href="#h3-0-267" id="h3-0-267" class="i">+As well as cross joins (both implicit and explicit):
</a><a href="#h3-0-268" id="h3-0-268" class="i">+
</a><a href="#h3-0-269" id="h3-0-269" class="i">+```sql
</a><a href="#h3-0-270" id="h3-0-270" class="i">+toydb&gt; SELECT g.name, s.name FROM genres g, studios s WHERE s.name &lt; &#39;S&#39;;
</a><a href="#h3-0-271" id="h3-0-271" class="i">+Science Fiction|Mosfilm
</a><a href="#h3-0-272" id="h3-0-272" class="i">+Science Fiction|Lionsgate
</a><a href="#h3-0-273" id="h3-0-273" class="i">+Science Fiction|Focus Features
</a><a href="#h3-0-274" id="h3-0-274" class="i">+Action|Mosfilm
</a><a href="#h3-0-275" id="h3-0-275" class="i">+Action|Lionsgate
</a><a href="#h3-0-276" id="h3-0-276" class="i">+Action|Focus Features
</a><a href="#h3-0-277" id="h3-0-277" class="i">+Drama|Mosfilm
</a><a href="#h3-0-278" id="h3-0-278" class="i">+Drama|Lionsgate
</a><a href="#h3-0-279" id="h3-0-279" class="i">+Drama|Focus Features
</a><a href="#h3-0-280" id="h3-0-280" class="i">+Comedy|Mosfilm
</a><a href="#h3-0-281" id="h3-0-281" class="i">+Comedy|Lionsgate
</a><a href="#h3-0-282" id="h3-0-282" class="i">+Comedy|Focus Features
</a><a href="#h3-0-283" id="h3-0-283" class="i">+```
</a><a href="#h3-0-284" id="h3-0-284" class="i">+
</a><a href="#h3-0-285" id="h3-0-285" class="i">+We can join on arbitrary predicates, such as joining movies with any genres whose name is
</a><a href="#h3-0-286" id="h3-0-286" class="i">+ordered after the movie&#39;s title:
</a><a href="#h3-0-287" id="h3-0-287" class="i">+
</a><a href="#h3-0-288" id="h3-0-288" class="i">+```sql
</a><a href="#h3-0-289" id="h3-0-289" class="i">+toydb&gt;  SELECT   m.title, g.name
</a><a href="#h3-0-290" id="h3-0-290" class="i">+        FROM     movies m JOIN genres g ON g.name &gt; m.title
</a><a href="#h3-0-291" id="h3-0-291" class="i">+        ORDER BY m.title, g.name;
</a><a href="#h3-0-292" id="h3-0-292" class="i">+
</a><a href="#h3-0-293" id="h3-0-293" class="i">+21 Grams|Action
</a><a href="#h3-0-294" id="h3-0-294" class="i">+21 Grams|Comedy
</a><a href="#h3-0-295" id="h3-0-295" class="i">+21 Grams|Drama
</a><a href="#h3-0-296" id="h3-0-296" class="i">+21 Grams|Science Fiction
</a><a href="#h3-0-297" id="h3-0-297" class="i">+Birdman|Comedy
</a><a href="#h3-0-298" id="h3-0-298" class="i">+Birdman|Drama
</a><a href="#h3-0-299" id="h3-0-299" class="i">+Birdman|Science Fiction
</a><a href="#h3-0-300" id="h3-0-300" class="i">+Eternal Sunshine of the Spotless Mind|Science Fiction
</a><a href="#h3-0-301" id="h3-0-301" class="i">+Gravity|Science Fiction
</a><a href="#h3-0-302" id="h3-0-302" class="i">+Heat|Science Fiction
</a><a href="#h3-0-303" id="h3-0-303" class="i">+Inception|Science Fiction
</a><a href="#h3-0-304" id="h3-0-304" class="i">+Lost in Translation|Science Fiction
</a><a href="#h3-0-305" id="h3-0-305" class="i">+Primer|Science Fiction
</a><a href="#h3-0-306" id="h3-0-306" class="i">+```
</a><a href="#h3-0-307" id="h3-0-307" class="i">+
</a><a href="#h3-0-308" id="h3-0-308" class="i">+And we can join multiple tables, even using the same table multiple times - like in this example
</a><a href="#h3-0-309" id="h3-0-309" class="i">+where we find all science fiction movies released since 2000 by studios that have released any 
</a><a href="#h3-0-310" id="h3-0-310" class="i">+movie rated 8 or higher:
</a><a href="#h3-0-311" id="h3-0-311" class="i">+
</a><a href="#h3-0-312" id="h3-0-312" class="i">+```sql
</a><a href="#h3-0-313" id="h3-0-313" class="i">+toydb&gt; SELECT   m.id, m.title, g.name AS genre, m.released, s.name AS studio
</a><a href="#h3-0-314" id="h3-0-314" class="i">+       FROM     movies m JOIN genres g ON m.genre_id = g.id,
</a><a href="#h3-0-315" id="h3-0-315" class="i">+                studios s JOIN movies good ON good.studio_id = s.id AND good.rating &gt;= 8
</a><a href="#h3-0-316" id="h3-0-316" class="i">+       WHERE    m.studio_id = s.id AND m.released &gt;= 2000 AND g.id = 1
</a><a href="#h3-0-317" id="h3-0-317" class="i">+       ORDER BY m.title ASC;
</a><a href="#h3-0-318" id="h3-0-318" class="i">+
</a><a href="#h3-0-319" id="h3-0-319" class="i">+7|Gravity|Science Fiction|2013|Warner Bros
</a><a href="#h3-0-320" id="h3-0-320" class="i">+10|Inception|Science Fiction|2010|Warner Bros
</a><a href="#h3-0-321" id="h3-0-321" class="i">+5|The Fountain|Science Fiction|2006|Warner Bros
</a><a href="#h3-0-322" id="h3-0-322" class="i">+```
</a><a href="#h3-0-323" id="h3-0-323" class="i">+
</a><a href="#h3-0-324" id="h3-0-324" class="i">+## Explain
</a><a href="#h3-0-325" id="h3-0-325" class="i">+
</a><a href="#h3-0-326" id="h3-0-326" class="i">+When optimizing complex queries with several joins, it can often be useful to inspect the query
</a><a href="#h3-0-327" id="h3-0-327" class="i">+plan via an `EXPLAIN` query, as with the previous join example:
</a><a href="#h3-0-328" id="h3-0-328" class="i">+
</a><a href="#h3-0-329" id="h3-0-329" class="i">+```sql
</a><a href="#h3-0-330" id="h3-0-330" class="i">+toydb&gt; EXPLAIN
</a><a href="#h3-0-331" id="h3-0-331" class="i">+       SELECT   m.id, m.title, g.name AS genre, m.released, s.name AS studio
</a><a href="#h3-0-332" id="h3-0-332" class="i">+       FROM     movies m JOIN genres g ON m.genre_id = g.id,
</a><a href="#h3-0-333" id="h3-0-333" class="i">+                studios s JOIN movies good ON good.studio_id = s.id AND good.rating &gt;= 8
</a><a href="#h3-0-334" id="h3-0-334" class="i">+       WHERE    m.studio_id = s.id AND m.released &gt;= 2000 AND g.id = 1
</a><a href="#h3-0-335" id="h3-0-335" class="i">+       ORDER BY m.title ASC;
</a><a href="#h3-0-336" id="h3-0-336" class="i">+
</a><a href="#h3-0-337" id="h3-0-337" class="i">+Order: m.title asc
</a><a href="#h3-0-338" id="h3-0-338" class="i">+└─ Projection: m.id, m.title, g.name, m.released, s.name
</a><a href="#h3-0-339" id="h3-0-339" class="i">+   └─ HashJoin: inner on m.studio_id = s.id
</a><a href="#h3-0-340" id="h3-0-340" class="i">+      ├─ HashJoin: inner on m.genre_id = g.id
</a><a href="#h3-0-341" id="h3-0-341" class="i">+      │  ├─ Filter: m.released &gt; 2000 OR m.released = 2000
</a><a href="#h3-0-342" id="h3-0-342" class="i">+      │  │  └─ IndexLookup: movies as m column genre_id (1)
</a><a href="#h3-0-343" id="h3-0-343" class="i">+      │  └─ KeyLookup: genres as g (1)
</a><a href="#h3-0-344" id="h3-0-344" class="i">+      └─ HashJoin: inner on s.id = good.studio_id
</a><a href="#h3-0-345" id="h3-0-345" class="i">+         ├─ Scan: studios as s
</a><a href="#h3-0-346" id="h3-0-346" class="i">+         └─ Scan: movies as good (good.rating &gt; 8 OR good.rating = 8)
</a><a href="#h3-0-347" id="h3-0-347" class="i">+```
</a><a href="#h3-0-348" id="h3-0-348" class="i">+
</a><a href="#h3-0-349" id="h3-0-349" class="i">+Here, we can see that the planner does a primary key lookup on `genres` and an index lookup on
</a><a href="#h3-0-350" id="h3-0-350" class="i">+`movies.genre_id`, filtering the resulting movies by release year and joining them. It also
</a><a href="#h3-0-351" id="h3-0-351" class="i">+does full table scans of `studios` and `movies` (to find the good movies) and joins them, pusing
</a><a href="#h3-0-352" id="h3-0-352" class="i">+the `rating &gt;= 8` filter down to the `movies` table scan. The results of these two joins are also
</a><a href="#h3-0-353" id="h3-0-353" class="i">+joined to produce the final result, which is then formatted and sorted.
</a><a href="#h3-0-354" id="h3-0-354" class="i">+
</a><a href="#h3-0-355" id="h3-0-355" class="i">+## Aggregates
</a><a href="#h3-0-356" id="h3-0-356" class="i">+
</a><a href="#h3-0-357" id="h3-0-357" class="i">+Most basic aggregate functions are supported:
</a><a href="#h3-0-358" id="h3-0-358" class="i">+
</a><a href="#h3-0-359" id="h3-0-359" class="i">+```sql
</a><a href="#h3-0-360" id="h3-0-360" class="i">+toydb&gt; SELECT COUNT(*), MIN(rating), MAX(rating), AVG(rating), SUM(rating) FROM movies;
</a><a href="#h3-0-361" id="h3-0-361" class="i">+12|6.9|8.8|7.841666666666668|94.10000000000001
</a><a href="#h3-0-362" id="h3-0-362" class="i">+```
</a><a href="#h3-0-363" id="h3-0-363" class="i">+
</a><a href="#h3-0-364" id="h3-0-364" class="i">+We can group by values and filter the aggregate results:
</a><a href="#h3-0-365" id="h3-0-365" class="i">+
</a><a href="#h3-0-366" id="h3-0-366" class="i">+```sql
</a><a href="#h3-0-367" id="h3-0-367" class="i">+toydb&gt; SELECT s.id, s.name, AVG(m.rating) AS average
</a><a href="#h3-0-368" id="h3-0-368" class="i">+       FROM movies m JOIN studios s ON m.studio_id = s.id
</a><a href="#h3-0-369" id="h3-0-369" class="i">+       GROUP BY s.id, s.name
</a><a href="#h3-0-370" id="h3-0-370" class="i">+       HAVING average &gt; 7.8
</a><a href="#h3-0-371" id="h3-0-371" class="i">+       ORDER BY average DESC, s.name ASC;
</a><a href="#h3-0-372" id="h3-0-372" class="i">+1|Mosfilm|8.149999999999999
</a><a href="#h3-0-373" id="h3-0-373" class="i">+4|Warner Bros|7.919999999999999
</a><a href="#h3-0-374" id="h3-0-374" class="i">+5|Focus Features|7.900000000000001
</a><a href="#h3-0-375" id="h3-0-375" class="i">+```
</a><a href="#h3-0-376" id="h3-0-376" class="i">+
</a><a href="#h3-0-377" id="h3-0-377" class="i">+And we can combine aggregate functions with arbitrary expressions, both inside and outside:
</a><a href="#h3-0-378" id="h3-0-378" class="i">+
</a><a href="#h3-0-379" id="h3-0-379" class="i">+```sql
</a><a href="#h3-0-380" id="h3-0-380" class="i">+toydb&gt; SELECT s.id, s.name, ((MAX(rating^2) - MIN(rating^2)) / AVG(rating^2)) ^ (0.5) AS spread
</a><a href="#h3-0-381" id="h3-0-381" class="i">+       FROM movies m JOIN studios s ON m.studio_id = s.id
</a><a href="#h3-0-382" id="h3-0-382" class="i">+       GROUP BY s.id, s.name
</a><a href="#h3-0-383" id="h3-0-383" class="i">+       HAVING MAX(rating) - MIN(rating) &gt; 0.5
</a><a href="#h3-0-384" id="h3-0-384" class="i">+       ORDER BY spread DESC;
</a><a href="#h3-0-385" id="h3-0-385" class="i">+4|Warner Bros|0.6373540990222496
</a><a href="#h3-0-386" id="h3-0-386" class="i">+5|Focus Features|0.39194971607693424
</a><a href="#h3-0-387" id="h3-0-387" class="i">+```
</a><a href="#h3-0-388" id="h3-0-388" class="i">+
</a><a href="#h3-0-389" id="h3-0-389" class="i">+## Transactions
</a><a href="#h3-0-390" id="h3-0-390" class="i">+
</a><a href="#h3-0-391" id="h3-0-391" class="i">+toyDB supports ACID transactions via MVCC-based snapshot isolation. This provides atomic
</a><a href="#h3-0-392" id="h3-0-392" class="i">+transactions with good isolation without taking out locks or writes blocking reads. As a
</a><a href="#h3-0-393" id="h3-0-393" class="i">+basic example, the below transaction is rolled back without taking effect:
</a><a href="#h3-0-394" id="h3-0-394" class="i">+
</a><a href="#h3-0-395" id="h3-0-395" class="i">+```sql
</a><a href="#h3-0-396" id="h3-0-396" class="i">+toydb&gt; BEGIN;
</a><a href="#h3-0-397" id="h3-0-397" class="i">+Began transaction 131
</a><a href="#h3-0-398" id="h3-0-398" class="i">+
</a><a href="#h3-0-399" id="h3-0-399" class="i">+toydb:131&gt; INSERT INTO genres VALUES (5, &#39;Western&#39;);
</a><a href="#h3-0-400" id="h3-0-400" class="i">+toydb:131&gt; SELECT * FROM genres;
</a><a href="#h3-0-401" id="h3-0-401" class="i">+1|Science Fiction
</a><a href="#h3-0-402" id="h3-0-402" class="i">+2|Action
</a><a href="#h3-0-403" id="h3-0-403" class="i">+3|Drama
</a><a href="#h3-0-404" id="h3-0-404" class="i">+4|Comedy
</a><a href="#h3-0-405" id="h3-0-405" class="i">+5|Western
</a><a href="#h3-0-406" id="h3-0-406" class="i">+toydb:131&gt; ROLLBACK;
</a><a href="#h3-0-407" id="h3-0-407" class="i">+Rolled back transaction 131
</a><a href="#h3-0-408" id="h3-0-408" class="i">+
</a><a href="#h3-0-409" id="h3-0-409" class="i">+toydb&gt; SELECT * FROM genres;
</a><a href="#h3-0-410" id="h3-0-410" class="i">+1|Science Fiction
</a><a href="#h3-0-411" id="h3-0-411" class="i">+2|Action
</a><a href="#h3-0-412" id="h3-0-412" class="i">+3|Drama
</a><a href="#h3-0-413" id="h3-0-413" class="i">+4|Comedy
</a><a href="#h3-0-414" id="h3-0-414" class="i">+```
</a><a href="#h3-0-415" id="h3-0-415" class="i">+
</a><a href="#h3-0-416" id="h3-0-416" class="i">+We&#39;ll demonstrate transactions by covering most common transaction anomalies given two
</a><a href="#h3-0-417" id="h3-0-417" class="i">+concurrent sessions, and show how toyDB prevents these anomalies in all cases but one. In these
</a><a href="#h3-0-418" id="h3-0-418" class="i">+examples, the left half is user A and the right is user B, and time flows downwards, such that 
</a><a href="#h3-0-419" id="h3-0-419" class="i">+commands on the same line happen at the same time.
</a><a href="#h3-0-420" id="h3-0-420" class="i">+
</a><a href="#h3-0-421" id="h3-0-421" class="i">+**Dirty write:** an uncommitted write by A should not be affected by a concurrent B write.
</a><a href="#h3-0-422" id="h3-0-422" class="i">+
</a><a href="#h3-0-423" id="h3-0-423" class="i">+```sql
</a><a href="#h3-0-424" id="h3-0-424" class="i">+a&gt; BEGIN;
</a><a href="#h3-0-425" id="h3-0-425" class="i">+a&gt; INSERT INTO genres VALUES (5, &#39;Western&#39;);
</a><a href="#h3-0-426" id="h3-0-426" class="i">+                                                 b&gt; INSERT INTO genres VALUES (5, &#39;Romance&#39;);
</a><a href="#h3-0-427" id="h3-0-427" class="i">+                                                 Error: Serialization failure, retry transaction
</a><a href="#h3-0-428" id="h3-0-428" class="i">+a&gt; SELECT * FROM genres WHERE id = 5;
</a><a href="#h3-0-429" id="h3-0-429" class="i">+5|Western
</a><a href="#h3-0-430" id="h3-0-430" class="i">+```
</a><a href="#h3-0-431" id="h3-0-431" class="i">+
</a><a href="#h3-0-432" id="h3-0-432" class="i">+The serialization failure here occurs because the first write always wins. This may not be an
</a><a href="#h3-0-433" id="h3-0-433" class="i">+optimal strategy, but it is correct in terms of preventing serialization anomalies.
</a><a href="#h3-0-434" id="h3-0-434" class="i">+
</a><a href="#h3-0-435" id="h3-0-435" class="i">+**Dirty read:** an uncommitted write by A should not be visible to B until committed.
</a><a href="#h3-0-436" id="h3-0-436" class="i">+
</a><a href="#h3-0-437" id="h3-0-437" class="i">+```sql
</a><a href="#h3-0-438" id="h3-0-438" class="i">+a&gt; BEGIN;
</a><a href="#h3-0-439" id="h3-0-439" class="i">+a&gt; INSERT INTO genres VALUES (5, &#39;Western&#39;);
</a><a href="#h3-0-440" id="h3-0-440" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 5;
</a><a href="#h3-0-441" id="h3-0-441" class="i">+                                                 No rows returned
</a><a href="#h3-0-442" id="h3-0-442" class="i">+a&gt; COMMIT;
</a><a href="#h3-0-443" id="h3-0-443" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 5;
</a><a href="#h3-0-444" id="h3-0-444" class="i">+                                                 5|Western
</a><a href="#h3-0-445" id="h3-0-445" class="i">+```
</a><a href="#h3-0-446" id="h3-0-446" class="i">+
</a><a href="#h3-0-447" id="h3-0-447" class="i">+**Lost update:** when A and B both read a value, before updating it in turn, the first write should
</a><a href="#h3-0-448" id="h3-0-448" class="i">+not be overwritten by the second.
</a><a href="#h3-0-449" id="h3-0-449" class="i">+
</a><a href="#h3-0-450" id="h3-0-450" class="i">+```sql
</a><a href="#h3-0-451" id="h3-0-451" class="i">+a&gt; BEGIN;                                          b&gt; BEGIN;
</a><a href="#h3-0-452" id="h3-0-452" class="i">+a&gt; SELECT title, rating FROM movies WHERE id = 2;  b&gt; SELECT title, rating FROM movies WHERE id = 2;
</a><a href="#h3-0-453" id="h3-0-453" class="i">+Sicario|7.6                                        Sicario|7.6
</a><a href="#h3-0-454" id="h3-0-454" class="i">+a&gt; UPDATE movies SET rating = 7.8 WHERE id = 2;
</a><a href="#h3-0-455" id="h3-0-455" class="i">+                                                   b&gt; UPDATE movies SET rating = 7.7 WHERE id = 2;
</a><a href="#h3-0-456" id="h3-0-456" class="i">+                                                   Error: Serialization failure, retry transaction
</a><a href="#h3-0-457" id="h3-0-457" class="i">+a&gt; COMMIT;
</a><a href="#h3-0-458" id="h3-0-458" class="i">+```
</a><a href="#h3-0-459" id="h3-0-459" class="i">+
</a><a href="#h3-0-460" id="h3-0-460" class="i">+**Fuzzy read:** B should not see a value suddenly change in its transaction, even if A commits a 
</a><a href="#h3-0-461" id="h3-0-461" class="i">+new value.
</a><a href="#h3-0-462" id="h3-0-462" class="i">+
</a><a href="#h3-0-463" id="h3-0-463" class="i">+```sql
</a><a href="#h3-0-464" id="h3-0-464" class="i">+a&gt; BEGIN;                                        b&gt; BEGIN;
</a><a href="#h3-0-465" id="h3-0-465" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 1;
</a><a href="#h3-0-466" id="h3-0-466" class="i">+                                                 1|Science Fiction
</a><a href="#h3-0-467" id="h3-0-467" class="i">+a&gt; UPDATE genres SET name = &#39;Scifi&#39; WHERE id = 1;
</a><a href="#h3-0-468" id="h3-0-468" class="i">+a&gt; COMMIT;
</a><a href="#h3-0-469" id="h3-0-469" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 1;
</a><a href="#h3-0-470" id="h3-0-470" class="i">+                                                 1|Science Fiction
</a><a href="#h3-0-471" id="h3-0-471" class="i">+                                                 b&gt; COMMIT;
</a><a href="#h3-0-472" id="h3-0-472" class="i">+
</a><a href="#h3-0-473" id="h3-0-473" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 1;
</a><a href="#h3-0-474" id="h3-0-474" class="i">+                                                 1|Scifi
</a><a href="#h3-0-475" id="h3-0-475" class="i">+```
</a><a href="#h3-0-476" id="h3-0-476" class="i">+
</a><a href="#h3-0-477" id="h3-0-477" class="i">+**Read skew:** if A reads two values, and B modifies the second value in between the reads, A 
</a><a href="#h3-0-478" id="h3-0-478" class="i">+should see the old second value.
</a><a href="#h3-0-479" id="h3-0-479" class="i">+
</a><a href="#h3-0-480" id="h3-0-480" class="i">+```sql
</a><a href="#h3-0-481" id="h3-0-481" class="i">+a&gt; BEGIN;
</a><a href="#h3-0-482" id="h3-0-482" class="i">+a&gt; SELECT * FROM genres WHERE id = 2;
</a><a href="#h3-0-483" id="h3-0-483" class="i">+2|Action
</a><a href="#h3-0-484" id="h3-0-484" class="i">+                                                 b&gt; BEGIN;
</a><a href="#h3-0-485" id="h3-0-485" class="i">+                                                 b&gt; UPDATE genres SET name = &#39;Drama&#39; WHERE id = 2;
</a><a href="#h3-0-486" id="h3-0-486" class="i">+                                                 b&gt; UPDATE genres SET name = &#39;Action&#39; WHERE id = 3;
</a><a href="#h3-0-487" id="h3-0-487" class="i">+                                                 b&gt; COMMIT;
</a><a href="#h3-0-488" id="h3-0-488" class="i">+a&gt; SELECT * FROM genres WHERE id = 3;
</a><a href="#h3-0-489" id="h3-0-489" class="i">+3|Drama
</a><a href="#h3-0-490" id="h3-0-490" class="i">+```
</a><a href="#h3-0-491" id="h3-0-491" class="i">+
</a><a href="#h3-0-492" id="h3-0-492" class="i">+**Phantom read:** when A runs a query with some predicate, and B commits a matching write, A should
</a><a href="#h3-0-493" id="h3-0-493" class="i">+not see the write when rerunning the query.
</a><a href="#h3-0-494" id="h3-0-494" class="i">+
</a><a href="#h3-0-495" id="h3-0-495" class="i">+```sql
</a><a href="#h3-0-496" id="h3-0-496" class="i">+a&gt; BEGIN;
</a><a href="#h3-0-497" id="h3-0-497" class="i">+a&gt; SELECT * FROM genres WHERE id &gt; 2;
</a><a href="#h3-0-498" id="h3-0-498" class="i">+3|Drama
</a><a href="#h3-0-499" id="h3-0-499" class="i">+4|Comedy
</a><a href="#h3-0-500" id="h3-0-500" class="i">+                                                 b&gt; INSERT INTO genres VALUES (5, &#39;Western&#39;);
</a><a href="#h3-0-501" id="h3-0-501" class="i">+a&gt; SELECT * FROM genres WHERE id &gt; 2;
</a><a href="#h3-0-502" id="h3-0-502" class="i">+3|Drama
</a><a href="#h3-0-503" id="h3-0-503" class="i">+4|Comedy
</a><a href="#h3-0-504" id="h3-0-504" class="i">+```
</a><a href="#h3-0-505" id="h3-0-505" class="i">+
</a><a href="#h3-0-506" id="h3-0-506" class="i">+**Write skew:**  when A reads row X and writes it to row Y, B should not concurrently be able to
</a><a href="#h3-0-507" id="h3-0-507" class="i">+read row Y and write it to row X.
</a><a href="#h3-0-508" id="h3-0-508" class="i">+
</a><a href="#h3-0-509" id="h3-0-509" class="i">+```sql
</a><a href="#h3-0-510" id="h3-0-510" class="i">+a&gt; BEGIN;                                        b&gt; BEGIN;
</a><a href="#h3-0-511" id="h3-0-511" class="i">+a&gt; SELECT * FROM genres WHERE id = 2;
</a><a href="#h3-0-512" id="h3-0-512" class="i">+2|Action
</a><a href="#h3-0-513" id="h3-0-513" class="i">+                                                 b&gt; SELECT * FROM genres WHERE id = 3;
</a><a href="#h3-0-514" id="h3-0-514" class="i">+                                                 3|Drama
</a><a href="#h3-0-515" id="h3-0-515" class="i">+                                                 b&gt; UPDATE genres SET name = &#39;Drama&#39; WHERE id = 2;
</a><a href="#h3-0-516" id="h3-0-516" class="i">+a&gt; UPDATE genres SET name = &#39;Action&#39; WHERE id = 3;
</a><a href="#h3-0-517" id="h3-0-517" class="i">+a&gt; COMMIT;                                       b&gt; COMMIT;
</a><a href="#h3-0-518" id="h3-0-518" class="i">+```
</a><a href="#h3-0-519" id="h3-0-519" class="i">+
</a><a href="#h3-0-520" id="h3-0-520" class="i">+Here, the writes actually go through. This anomaly is not protected against by snapshot isolation, 
</a><a href="#h3-0-521" id="h3-0-521" class="i">+and thus not by toyDB either. Doing so would require implementing serializable snapshot isolation. 
</a><a href="#h3-0-522" id="h3-0-522" class="i">+However, this is the only common serialization anomaly not handled by toyDB, and is not among the
</a><a href="#h3-0-523" id="h3-0-523" class="i">+most serious.
</a><a href="#h3-0-524" id="h3-0-524" class="i">+
</a><a href="#h3-0-525" id="h3-0-525" class="i">+## Time-Travel Queries
</a><a href="#h3-0-526" id="h3-0-526" class="i">+
</a><a href="#h3-0-527" id="h3-0-527" class="i">+Since toyDB uses MVCC for transactions and keeps all historical versions, the state of the database
</a><a href="#h3-0-528" id="h3-0-528" class="i">+can be queried at any arbitrary point in the past. toyDB uses incremental transaction IDs as
</a><a href="#h3-0-529" id="h3-0-529" class="i">+logical timestamps:
</a><a href="#h3-0-530" id="h3-0-530" class="i">+
</a><a href="#h3-0-531" id="h3-0-531" class="i">+```sql
</a><a href="#h3-0-532" id="h3-0-532" class="i">+toydb&gt; SELECT * FROM genres;
</a><a href="#h3-0-533" id="h3-0-533" class="i">+1|Science Fiction
</a><a href="#h3-0-534" id="h3-0-534" class="i">+2|Drama
</a><a href="#h3-0-535" id="h3-0-535" class="i">+3|Action
</a><a href="#h3-0-536" id="h3-0-536" class="i">+4|Comedy
</a><a href="#h3-0-537" id="h3-0-537" class="i">+
</a><a href="#h3-0-538" id="h3-0-538" class="i">+toydb&gt; BEGIN;
</a><a href="#h3-0-539" id="h3-0-539" class="i">+Began transaction 173
</a><a href="#h3-0-540" id="h3-0-540" class="i">+toydb:173&gt; UPDATE genres SET name = &#39;Scifi&#39; WHERE id = 1;
</a><a href="#h3-0-541" id="h3-0-541" class="i">+toydb:173&gt; INSERT INTO genres VALUES (5, &#39;Western&#39;);
</a><a href="#h3-0-542" id="h3-0-542" class="i">+toydb:173&gt; COMMIT;
</a><a href="#h3-0-543" id="h3-0-543" class="i">+Committed transaction 173
</a><a href="#h3-0-544" id="h3-0-544" class="i">+
</a><a href="#h3-0-545" id="h3-0-545" class="i">+toydb&gt; SELECT * FROM genres;
</a><a href="#h3-0-546" id="h3-0-546" class="i">+1|Scifi
</a><a href="#h3-0-547" id="h3-0-547" class="i">+2|Drama
</a><a href="#h3-0-548" id="h3-0-548" class="i">+3|Action
</a><a href="#h3-0-549" id="h3-0-549" class="i">+4|Comedy
</a><a href="#h3-0-550" id="h3-0-550" class="i">+5|Western
</a><a href="#h3-0-551" id="h3-0-551" class="i">+
</a><a href="#h3-0-552" id="h3-0-552" class="i">+toydb&gt; BEGIN READ ONLY AS OF SYSTEM TIME 172;
</a><a href="#h3-0-553" id="h3-0-553" class="i">+Began read-only transaction 175 in snapshot at version 172
</a><a href="#h3-0-554" id="h3-0-554" class="i">+toydb@172&gt; SELECT * FROM genres;
</a><a href="#h3-0-555" id="h3-0-555" class="i">+1|Science Fiction
</a><a href="#h3-0-556" id="h3-0-556" class="i">+2|Drama
</a><a href="#h3-0-557" id="h3-0-557" class="i">+3|Action
</a><a href="#h3-0-558" id="h3-0-558" class="i">+4|Comedy
</a><a href="#h3-0-559" id="h3-0-559" class="i">+```
</a><a href="#h3-0-560" id="h3-0-560" class="i">+\ No newline at end of file
</a></pre>
</div>
</body>
</html>
