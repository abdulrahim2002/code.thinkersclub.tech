<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: made expression::Environment a trait - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/6706494cc31ddfb849744f95a150562bc07e084d.html">6706494cc31ddfb849744f95a150562bc07e084d</a>
<b>parent</b> <a href="../commit/6fe1e7785ef3e27d3f65586051b2fda8d1fae05d.html">6fe1e7785ef3e27d3f65586051b2fda8d1fae05d</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat,  1 Feb 2020 20:38:32 +0100

sql: made expression::Environment a trait

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/executor/filter.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/executor/insert.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/executor/order.rs</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/executor/projection.rs</a></td><td> | </td><td class="num">7</td><td><span class="i">++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/executor/update.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/optimizer/constant_folder.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/sql/planner/mod.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/sql/types/expression.rs</a></td><td> | </td><td class="num">37</td><td><span class="i">++++++++++++++++</span><span class="d">---------------------</span></td></tr>
</table></pre><pre>8 files changed, 47 insertions(+), 42 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/executor/filter.rs.html">src/sql/executor/filter.rs</a> b/<a href="../file/src/sql/executor/filter.rs.html">src/sql/executor/filter.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,9 +1,11 @@
</a> use super::super::engine::Transaction;
<a href="#h0-0-1" id="h0-0-1" class="d">-use super::super::types::expression::{Environment, Expression};
</a><a href="#h0-0-2" id="h0-0-2" class="i">+use super::super::types::expression::Expression;
</a> use super::super::types::Value;
 use super::{Context, Executor, ResultSet};
 use crate::Error;
 
<a href="#h0-0-7" id="h0-0-7" class="i">+use std::collections::HashMap;
</a><a href="#h0-0-8" id="h0-0-8" class="i">+
</a> /// A filter executor
 pub struct Filter&lt;T: Transaction&gt; {
     /// The source of rows to filter
<a href="#h0-1" id="h0-1" class="h">@@ -26,9 +28,8 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Filter&lt;T&gt; {
</a>             let predicate = self.predicate;
             result.rows = Some(Box::new(rows.filter_map(move |r| {
                 r.and_then(|row| {
<a href="#h0-1-3" id="h0-1-3" class="d">-                    let env = Environment::new(
</a><a href="#h0-1-4" id="h0-1-4" class="d">-                        columns.iter().cloned().zip(row.iter().cloned()).collect(),
</a><a href="#h0-1-5" id="h0-1-5" class="d">-                    );
</a><a href="#h0-1-6" id="h0-1-6" class="i">+                    let env: HashMap&lt;_, _&gt; =
</a><a href="#h0-1-7" id="h0-1-7" class="i">+                        columns.iter().cloned().zip(row.iter().cloned()).collect();
</a>                     match predicate.evaluate(&amp;env)? {
                         Value::Boolean(true) =&gt; Ok(Some(row)),
                         Value::Boolean(false) =&gt; Ok(None),
<b>diff --git a/<a id="h1" href="../file/src/sql/executor/insert.rs.html">src/sql/executor/insert.rs</a> b/<a href="../file/src/sql/executor/insert.rs.html">src/sql/executor/insert.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,8 +1,10 @@
</a> use super::super::engine::Transaction;
<a href="#h1-0-1" id="h1-0-1" class="d">-use super::super::types::expression::{Environment, Expressions};
</a><a href="#h1-0-2" id="h1-0-2" class="i">+use super::super::types::expression::Expressions;
</a> use super::{Context, Effect, Executor, ResultSet};
 use crate::Error;
 
<a href="#h1-0-6" id="h1-0-6" class="i">+use std::collections::HashMap;
</a><a href="#h1-0-7" id="h1-0-7" class="i">+
</a> /// An INSERT executor
 pub struct Insert {
     /// The table to insert into
<a href="#h1-1" id="h1-1" class="h">@@ -22,7 +24,7 @@ impl Insert {
</a> impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Insert {
     fn execute(self: Box&lt;Self&gt;, ctx: &amp;mut Context&lt;T&gt;) -&gt; Result&lt;ResultSet, Error&gt; {
         let table = ctx.txn.must_read_table(&amp;self.table)?;
<a href="#h1-1-3" id="h1-1-3" class="d">-        let env = Environment::empty();
</a><a href="#h1-1-4" id="h1-1-4" class="i">+        let env = HashMap::new();
</a>         let mut count = 0;
         for expressions in self.rows {
             let mut row = expressions
<b>diff --git a/<a id="h2" href="../file/src/sql/executor/order.rs.html">src/sql/executor/order.rs</a> b/<a href="../file/src/sql/executor/order.rs.html">src/sql/executor/order.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,10 +1,12 @@
</a> use super::super::engine::Transaction;
 use super::super::planner::Direction;
<a href="#h2-0-2" id="h2-0-2" class="d">-use super::super::types::expression::{Environment, Expression};
</a><a href="#h2-0-3" id="h2-0-3" class="i">+use super::super::types::expression::Expression;
</a> use super::super::types::{Row, Value};
 use super::{Context, Executor, ResultSet};
 use crate::Error;
 
<a href="#h2-0-8" id="h2-0-8" class="i">+use std::collections::HashMap;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a> /// An order executor
 pub struct Order&lt;T: Transaction&gt; {
     /// The source of rows to filter
<a href="#h2-1" id="h2-1" class="h">@@ -34,9 +36,8 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Order&lt;T&gt; {
</a>             };
             let mut items = Vec::new();
             while let Some(row) = rows.next().transpose()? {
<a href="#h2-1-3" id="h2-1-3" class="d">-                let env = Environment::new(
</a><a href="#h2-1-4" id="h2-1-4" class="d">-                    result.columns.iter().cloned().zip(row.iter().cloned()).collect(),
</a><a href="#h2-1-5" id="h2-1-5" class="d">-                );
</a><a href="#h2-1-6" id="h2-1-6" class="i">+                let env: HashMap&lt;_, _&gt; =
</a><a href="#h2-1-7" id="h2-1-7" class="i">+                    result.columns.iter().cloned().zip(row.iter().cloned()).collect();
</a>                 let mut values = Vec::new();
                 for (expr, _) in self.order.iter() {
                     values.push(expr.evaluate(&amp;env)?);
<b>diff --git a/<a id="h3" href="../file/src/sql/executor/projection.rs.html">src/sql/executor/projection.rs</a> b/<a href="../file/src/sql/executor/projection.rs.html">src/sql/executor/projection.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,8 +1,10 @@
</a> use super::super::engine::Transaction;
<a href="#h3-0-1" id="h3-0-1" class="d">-use super::super::types::expression::{Environment, Expression, Expressions};
</a><a href="#h3-0-2" id="h3-0-2" class="i">+use super::super::types::expression::{Expression, Expressions};
</a> use super::{Context, Executor, ResultSet};
 use crate::Error;
 
<a href="#h3-0-6" id="h3-0-6" class="i">+use std::collections::HashMap;
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a> /// A filter executor
 pub struct Projection&lt;T: Transaction&gt; {
     /// The source of rows to project
<a href="#h3-1" id="h3-1" class="h">@@ -46,8 +48,7 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Projection&lt;T&gt; {
</a>             let expressions = self.expressions;
             result.rows = Some(Box::new(rows.map(move |r| {
                 r.and_then(|row| {
<a href="#h3-1-3" id="h3-1-3" class="d">-                    let env =
</a><a href="#h3-1-4" id="h3-1-4" class="d">-                        Environment::new(columns.iter().cloned().zip(row.into_iter()).collect());
</a><a href="#h3-1-5" id="h3-1-5" class="i">+                    let env: HashMap&lt;_, _&gt; = columns.iter().cloned().zip(row.into_iter()).collect();
</a>                     Ok(expressions
                         .iter()
                         .map(|e| e.evaluate(&amp;env))
<b>diff --git a/<a id="h4" href="../file/src/sql/executor/update.rs.html">src/sql/executor/update.rs</a> b/<a href="../file/src/sql/executor/update.rs.html">src/sql/executor/update.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,7 +1,8 @@
</a> use super::super::engine::Transaction;
<a href="#h4-0-1" id="h4-0-1" class="d">-use super::super::types::expression::{Environment, Expression};
</a><a href="#h4-0-2" id="h4-0-2" class="i">+use super::super::types::expression::Expression;
</a> use super::{Context, Effect, Executor, ResultSet};
 use crate::Error;
<a href="#h4-0-5" id="h4-0-5" class="i">+
</a> use std::collections::BTreeMap;
 
 /// An UPDATE executor
<a href="#h4-1" id="h4-1" class="h">@@ -32,7 +33,7 @@ impl&lt;T: Transaction&gt; Executor&lt;T&gt; for Update&lt;T&gt; {
</a>         let mut count = 0;
         while let Some(mut row) = source.next().transpose()? {
             let id = table.get_row_key(&amp;row)?;
<a href="#h4-1-3" id="h4-1-3" class="d">-            let env = Environment::new(table.make_row_hashmap(row.clone()));
</a><a href="#h4-1-4" id="h4-1-4" class="i">+            let env = table.make_row_hashmap(row.clone());
</a>             for (field, expr) in &amp;self.expressions {
                 table.set_row_field(&amp;mut row, field, expr.evaluate(&amp;env)?)?;
             }
<b>diff --git a/<a id="h5" href="../file/src/sql/optimizer/constant_folder.rs.html">src/sql/optimizer/constant_folder.rs</a> b/<a href="../file/src/sql/optimizer/constant_folder.rs.html">src/sql/optimizer/constant_folder.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,8 +1,10 @@
</a> use super::super::planner::Node;
<a href="#h5-0-1" id="h5-0-1" class="d">-use super::super::types::expression::{Environment, Expression};
</a><a href="#h5-0-2" id="h5-0-2" class="i">+use super::super::types::expression::Expression;
</a> use super::Optimizer;
 use crate::Error;
 
<a href="#h5-0-6" id="h5-0-6" class="i">+use std::collections::HashMap;
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a> /// A constant folding optimizer, which replaces constant expressions
 /// with their evaluated value, to prevent it from being re-evaluated
 /// over and over again during plan execution.
<a href="#h5-1" id="h5-1" class="h">@@ -10,7 +12,7 @@ pub struct ConstantFolder;
</a> 
 impl Optimizer for ConstantFolder {
     fn optimize(&amp;mut self, node: Node) -&gt; Result&lt;Node, Error&gt; {
<a href="#h5-1-3" id="h5-1-3" class="d">-        let env = &amp;Environment::empty();
</a><a href="#h5-1-4" id="h5-1-4" class="i">+        let env = HashMap::new();
</a>         node.transform(&amp;|n| Ok(n), &amp;|n| {
             n.transform_expressions(&amp;|e| Ok(e), &amp;|e| {
                 Ok(if e.is_constant() { Expression::Constant(e.evaluate(&amp;env)?) } else { e })
<b>diff --git a/<a id="h6" href="../file/src/sql/planner/mod.rs.html">src/sql/planner/mod.rs</a> b/<a href="../file/src/sql/planner/mod.rs.html">src/sql/planner/mod.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -3,11 +3,13 @@ mod plan;
</a> pub use plan::{Direction, Node, Plan};
 
 use super::parser::ast;
<a href="#h6-0-3" id="h6-0-3" class="d">-use super::types::expression::{Environment, Expression};
</a><a href="#h6-0-4" id="h6-0-4" class="i">+use super::types::expression::Expression;
</a> use super::types::schema;
 use super::types::Value;
 use crate::Error;
 
<a href="#h6-0-9" id="h6-0-9" class="i">+use std::collections::HashMap;
</a><a href="#h6-0-10" id="h6-0-10" class="i">+
</a> /// The plan builder
 struct Planner {}
 
<a href="#h6-1" id="h6-1" class="h">@@ -97,7 +99,7 @@ impl Planner {
</a>                     }
                     n = Node::Offset {
                         source: Box::new(n),
<a href="#h6-1-3" id="h6-1-3" class="d">-                        offset: match expr.evaluate(&amp;Environment::empty())? {
</a><a href="#h6-1-4" id="h6-1-4" class="i">+                        offset: match expr.evaluate(&amp;HashMap::new())? {
</a>                             Value::Integer(i) if i &gt;= 0 =&gt; i as u64,
                             v =&gt; {
                                 return Err(Error::Value(format!(&quot;Invalid value {} for offset&quot;, v)))
<a href="#h6-2" id="h6-2" class="h">@@ -112,7 +114,7 @@ impl Planner {
</a>                     }
                     n = Node::Limit {
                         source: Box::new(n),
<a href="#h6-2-3" id="h6-2-3" class="d">-                        limit: match expr.evaluate(&amp;Environment::empty())? {
</a><a href="#h6-2-4" id="h6-2-4" class="i">+                        limit: match expr.evaluate(&amp;HashMap::new())? {
</a>                             Value::Integer(i) if i &gt;= 0 =&gt; i as u64,
                             v =&gt; {
                                 return Err(Error::Value(format!(&quot;Invalid value {} for limit&quot;, v)))
<a href="#h6-3" id="h6-3" class="h">@@ -180,7 +182,7 @@ impl Planner {
</a>                                 c.name
                             )));
                         }
<a href="#h6-3-3" id="h6-3-3" class="d">-                        Some(expr.evaluate(&amp;Environment::empty())?)
</a><a href="#h6-3-4" id="h6-3-4" class="i">+                        Some(expr.evaluate(&amp;HashMap::new())?)
</a>                     } else if nullable {
                         Some(Value::Null)
                     } else {
<b>diff --git a/<a id="h7" href="../file/src/sql/types/expression.rs.html">src/sql/types/expression.rs</a> b/<a href="../file/src/sql/types/expression.rs.html">src/sql/types/expression.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -42,12 +42,12 @@ pub type Expressions = Vec&lt;Expression&gt;;
</a> 
 impl Expression {
     /// Evaluates an expression to a value, given an environment
<a href="#h7-0-3" id="h7-0-3" class="d">-    pub fn evaluate(&amp;self, e: &amp;Environment) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h7-0-4" id="h7-0-4" class="i">+    pub fn evaluate&lt;E: Environment&gt;(&amp;self, e: &amp;E) -&gt; Result&lt;Value, Error&gt; {
</a>         use Value::*;
         Ok(match self {
             // Constant values
             Self::Constant(c) =&gt; c.clone(),
<a href="#h7-0-9" id="h7-0-9" class="d">-            Self::Field(f) =&gt; e.get_field(f)?,
</a><a href="#h7-0-10" id="h7-0-10" class="i">+            Self::Field(f) =&gt; e.lookup(f)?,
</a> 
             // Logical operations
             Self::And(lhs, rhs) =&gt; match (lhs.evaluate(e)?, rhs.evaluate(e)?) {
<a href="#h7-1" id="h7-1" class="h">@@ -369,27 +369,22 @@ impl Expression {
</a>     }
 }
 
<a href="#h7-1-3" id="h7-1-3" class="d">-/// An expression evaluation environment, containing field values
</a><a href="#h7-1-4" id="h7-1-4" class="d">-pub struct Environment {
</a><a href="#h7-1-5" id="h7-1-5" class="d">-    fields: HashMap&lt;String, Value&gt;,
</a><a href="#h7-1-6" id="h7-1-6" class="d">-}
</a><a href="#h7-1-7" id="h7-1-7" class="d">-
</a><a href="#h7-1-8" id="h7-1-8" class="d">-impl Environment {
</a><a href="#h7-1-9" id="h7-1-9" class="d">-    /// Creates a new environment from a field map
</a><a href="#h7-1-10" id="h7-1-10" class="d">-    pub fn new(fields: HashMap&lt;String, Value&gt;) -&gt; Self {
</a><a href="#h7-1-11" id="h7-1-11" class="d">-        Self { fields }
</a><a href="#h7-1-12" id="h7-1-12" class="d">-    }
</a><a href="#h7-1-13" id="h7-1-13" class="d">-
</a><a href="#h7-1-14" id="h7-1-14" class="d">-    /// Creates an empty environment
</a><a href="#h7-1-15" id="h7-1-15" class="d">-    pub fn empty() -&gt; Self {
</a><a href="#h7-1-16" id="h7-1-16" class="d">-        Self::new(HashMap::new())
</a><a href="#h7-1-17" id="h7-1-17" class="d">-    }
</a><a href="#h7-1-18" id="h7-1-18" class="i">+/// An expression evaluation environment
</a><a href="#h7-1-19" id="h7-1-19" class="i">+pub trait Environment {
</a><a href="#h7-1-20" id="h7-1-20" class="i">+    /// Attempts to fetch a field value from the environment
</a><a href="#h7-1-21" id="h7-1-21" class="i">+    fn get(&amp;self, field: &amp;str) -&gt; Option&lt;Value&gt;;
</a> 
<a href="#h7-1-23" id="h7-1-23" class="d">-    /// Fetches a field value, or throws Error::Value if missing
</a><a href="#h7-1-24" id="h7-1-24" class="d">-    pub fn get_field(&amp;self, field: &amp;str) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h7-1-25" id="h7-1-25" class="d">-        match self.fields.get(field) {
</a><a href="#h7-1-26" id="h7-1-26" class="d">-            Some(v) =&gt; Ok(v.clone()),
</a><a href="#h7-1-27" id="h7-1-27" class="i">+    /// Fetches a field value from the environment, otherwise errors
</a><a href="#h7-1-28" id="h7-1-28" class="i">+    fn lookup(&amp;self, field: &amp;str) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h7-1-29" id="h7-1-29" class="i">+        match self.get(field) {
</a><a href="#h7-1-30" id="h7-1-30" class="i">+            Some(value) =&gt; Ok(value),
</a>             None =&gt; Err(Error::Value(format!(&quot;Unknown field {}&quot;, field))),
         }
     }
 }
<a href="#h7-1-35" id="h7-1-35" class="i">+
</a><a href="#h7-1-36" id="h7-1-36" class="i">+impl Environment for HashMap&lt;String, Value&gt; {
</a><a href="#h7-1-37" id="h7-1-37" class="i">+    fn get(&amp;self, field: &amp;str) -&gt; Option&lt;Value&gt; {
</a><a href="#h7-1-38" id="h7-1-38" class="i">+        self.get(field).cloned()
</a><a href="#h7-1-39" id="h7-1-39" class="i">+    }
</a><a href="#h7-1-40" id="h7-1-40" class="i">+}
</a></pre>
</div>
</body>
</html>
