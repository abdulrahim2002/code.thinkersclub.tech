<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: return `mvcc::TransactionState` in `StatementResult::Begin` - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/df8cabb55133ed4245cea0053f17d9931ca57a35.html">df8cabb55133ed4245cea0053f17d9931ca57a35</a>
<b>parent</b> <a href="../commit/a1d54aa0a09e15a54878a8992914b9e540116008.html">a1d54aa0a09e15a54878a8992914b9e540116008</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 21 Jul 2024 20:22:27 +0200

sql: return `mvcc::TransactionState` in `StatementResult::Begin`

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toysql.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/client.rs</a></td><td> | </td><td class="num">13</td><td><span class="i">++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/engine/engine.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/engine/local.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/sql/engine/session.rs</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">tests/e2e/client.rs</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------</span></td></tr>
</table></pre><pre>7 files changed, 100 insertions(+), 59 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -184,9 +184,9 @@ Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk,
</a>     /// Runs a query and displays the results
     fn execute_query(&amp;mut self, query: &amp;str) -&gt; Result&lt;()&gt; {
         match self.client.execute(query)? {
<a href="#h0-0-3" id="h0-0-3" class="d">-            StatementResult::Begin { version, read_only } =&gt; match read_only {
</a><a href="#h0-0-4" id="h0-0-4" class="d">-                false =&gt; println!(&quot;Began transaction at new version {}&quot;, version),
</a><a href="#h0-0-5" id="h0-0-5" class="d">-                true =&gt; println!(&quot;Began read-only transaction at version {}&quot;, version),
</a><a href="#h0-0-6" id="h0-0-6" class="i">+            StatementResult::Begin { state } =&gt; match state.read_only {
</a><a href="#h0-0-7" id="h0-0-7" class="i">+                false =&gt; println!(&quot;Began transaction at new version {}&quot;, state.version),
</a><a href="#h0-0-8" id="h0-0-8" class="i">+                true =&gt; println!(&quot;Began read-only transaction at version {}&quot;, state.version),
</a>             },
             StatementResult::Commit { version: id } =&gt; println!(&quot;Committed transaction {}&quot;, id),
             StatementResult::Rollback { version: id } =&gt; println!(&quot;Rolled back transaction {}&quot;, id),
<a href="#h0-1" id="h0-1" class="h">@@ -214,8 +214,8 @@ Storage:   {keys} keys, {logical_size} MB logical, {nodes}x {disk_size} MB disk,
</a>     /// Prompts the user for input
     fn prompt(&amp;mut self) -&gt; Result&lt;Option&lt;String&gt;&gt; {
         let prompt = match self.client.txn() {
<a href="#h0-1-3" id="h0-1-3" class="d">-            Some((version, false)) =&gt; format!(&quot;toydb:{}&gt; &quot;, version),
</a><a href="#h0-1-4" id="h0-1-4" class="d">-            Some((version, true)) =&gt; format!(&quot;toydb@{}&gt; &quot;, version),
</a><a href="#h0-1-5" id="h0-1-5" class="i">+            Some(txn) if txn.read_only =&gt; format!(&quot;toydb@{}&gt; &quot;, txn.version),
</a><a href="#h0-1-6" id="h0-1-6" class="i">+            Some(txn) =&gt; format!(&quot;toydb:{}&gt; &quot;, txn.version),
</a>             None =&gt; &quot;toydb&gt; &quot;.into(),
         };
         match self.editor.readline(&amp;prompt) {
<b>diff --git a/<a id="h1" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -6,6 +6,7 @@ use crate::error::{Error, Result};
</a> use crate::server::{Request, Response, Status};
 use crate::sql::engine::StatementResult;
 use crate::sql::types::Table;
<a href="#h1-0-3" id="h1-0-3" class="i">+use crate::storage::mvcc;
</a> 
 use rand::Rng;
 
<a href="#h1-1" id="h1-1" class="h">@@ -13,7 +14,7 @@ use rand::Rng;
</a> pub struct Client {
     reader: std::io::BufReader&lt;std::net::TcpStream&gt;,
     writer: std::io::BufWriter&lt;std::net::TcpStream&gt;,
<a href="#h1-1-3" id="h1-1-3" class="d">-    txn: Option&lt;(u64, bool)&gt;,
</a><a href="#h1-1-4" id="h1-1-4" class="i">+    txn: Option&lt;mvcc::TransactionState&gt;,
</a> }
 
 impl Client {
<a href="#h1-2" id="h1-2" class="h">@@ -39,9 +40,7 @@ impl Client {
</a>             response =&gt; return errdata!(&quot;unexpected response {response:?}&quot;),
         };
         match &amp;resultset {
<a href="#h1-2-3" id="h1-2-3" class="d">-            StatementResult::Begin { version, read_only } =&gt; {
</a><a href="#h1-2-4" id="h1-2-4" class="d">-                self.txn = Some((*version, *read_only))
</a><a href="#h1-2-5" id="h1-2-5" class="d">-            }
</a><a href="#h1-2-6" id="h1-2-6" class="i">+            StatementResult::Begin { state } =&gt; self.txn = Some(state.clone()),
</a>             StatementResult::Commit { .. } =&gt; self.txn = None,
             StatementResult::Rollback { .. } =&gt; self.txn = None,
             _ =&gt; {}
<a href="#h1-3" id="h1-3" class="h">@@ -73,9 +72,9 @@ impl Client {
</a>         }
     }
 
<a href="#h1-3-3" id="h1-3-3" class="d">-    /// Returns the version and read-only state of the txn
</a><a href="#h1-3-4" id="h1-3-4" class="d">-    pub fn txn(&amp;self) -&gt; Option&lt;(u64, bool)&gt; {
</a><a href="#h1-3-5" id="h1-3-5" class="d">-        self.txn
</a><a href="#h1-3-6" id="h1-3-6" class="i">+    /// Returns the transaction state.
</a><a href="#h1-3-7" id="h1-3-7" class="i">+    pub fn txn(&amp;self) -&gt; Option&lt;&amp;mvcc::TransactionState&gt; {
</a><a href="#h1-3-8" id="h1-3-8" class="i">+        self.txn.as_ref()
</a>     }
 
     /// Runs the given closure, automatically retrying serialization and abort
<b>diff --git a/<a id="h2" href="../file/src/sql/engine/engine.rs.html">src/sql/engine/engine.rs</a> b/<a href="../file/src/sql/engine/engine.rs.html">src/sql/engine/engine.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -38,10 +38,16 @@ pub trait Engine&lt;&#39;a&gt;: Sized {
</a> /// cost. With the Raft engine, each call results in a Raft roundtrip, and we&#39;d
 /// rather not have to do that for every single row that&#39;s modified.
 pub trait Transaction {
<a href="#h2-0-3" id="h2-0-3" class="i">+    /// The transaction&#39;s internal MVCC state.
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    fn state(&amp;self) -&gt; &amp;mvcc::TransactionState;
</a>     /// The transaction&#39;s MVCC version. Unique for read/write transactions.
<a href="#h2-0-6" id="h2-0-6" class="d">-    fn version(&amp;self) -&gt; mvcc::Version;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+    fn version(&amp;self) -&gt; mvcc::Version {
</a><a href="#h2-0-8" id="h2-0-8" class="i">+        self.state().version
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    }
</a>     /// Whether the transaction is read-only.
<a href="#h2-0-11" id="h2-0-11" class="d">-    fn read_only(&amp;self) -&gt; bool;
</a><a href="#h2-0-12" id="h2-0-12" class="i">+    fn read_only(&amp;self) -&gt; bool {
</a><a href="#h2-0-13" id="h2-0-13" class="i">+        self.state().read_only
</a><a href="#h2-0-14" id="h2-0-14" class="i">+    }
</a> 
     /// Commits the transaction.
     fn commit(self) -&gt; Result&lt;()&gt;;
<b>diff --git a/<a id="h3" href="../file/src/sql/engine/local.rs.html">src/sql/engine/local.rs</a> b/<a href="../file/src/sql/engine/local.rs.html">src/sql/engine/local.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -145,12 +145,8 @@ impl&lt;E: storage::Engine&gt; Transaction&lt;E&gt; {
</a> }
 
 impl&lt;E: storage::Engine&gt; super::Transaction for Transaction&lt;E&gt; {
<a href="#h3-0-3" id="h3-0-3" class="d">-    fn version(&amp;self) -&gt; u64 {
</a><a href="#h3-0-4" id="h3-0-4" class="d">-        self.txn.version()
</a><a href="#h3-0-5" id="h3-0-5" class="d">-    }
</a><a href="#h3-0-6" id="h3-0-6" class="d">-
</a><a href="#h3-0-7" id="h3-0-7" class="d">-    fn read_only(&amp;self) -&gt; bool {
</a><a href="#h3-0-8" id="h3-0-8" class="d">-        self.txn.read_only()
</a><a href="#h3-0-9" id="h3-0-9" class="i">+    fn state(&amp;self) -&gt; &amp;mvcc::TransactionState {
</a><a href="#h3-0-10" id="h3-0-10" class="i">+        self.txn.state()
</a>     }
 
     fn commit(self) -&gt; Result&lt;()&gt; {
<b>diff --git a/<a id="h4" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -127,12 +127,8 @@ impl&lt;&#39;a&gt; Transaction&lt;&#39;a&gt; {
</a> }
 
 impl&lt;&#39;a&gt; super::Transaction for Transaction&lt;&#39;a&gt; {
<a href="#h4-0-3" id="h4-0-3" class="d">-    fn version(&amp;self) -&gt; mvcc::Version {
</a><a href="#h4-0-4" id="h4-0-4" class="d">-        self.state.version
</a><a href="#h4-0-5" id="h4-0-5" class="d">-    }
</a><a href="#h4-0-6" id="h4-0-6" class="d">-
</a><a href="#h4-0-7" id="h4-0-7" class="d">-    fn read_only(&amp;self) -&gt; bool {
</a><a href="#h4-0-8" id="h4-0-8" class="d">-        self.state.read_only
</a><a href="#h4-0-9" id="h4-0-9" class="i">+    fn state(&amp;self) -&gt; &amp;mvcc::TransactionState {
</a><a href="#h4-0-10" id="h4-0-10" class="i">+        &amp;self.state
</a>     }
 
     fn commit(self) -&gt; Result&lt;()&gt; {
<b>diff --git a/<a id="h5" href="../file/src/sql/engine/session.rs.html">src/sql/engine/session.rs</a> b/<a href="../file/src/sql/engine/session.rs.html">src/sql/engine/session.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -32,27 +32,21 @@ impl&lt;&#39;a, E: Engine&lt;&#39;a&gt;&gt; Session&lt;&#39;a, E&gt; {
</a>         // Parse and execute the statement. Transaction control is done here,
         // other statements are executed by the SQL engine.
         Ok(match Parser::new(statement).parse()? {
<a href="#h5-0-3" id="h5-0-3" class="d">-            ast::Statement::Begin { .. } if self.txn.is_some() =&gt; {
</a><a href="#h5-0-4" id="h5-0-4" class="d">-                return errinput!(&quot;already in a transaction&quot;)
</a><a href="#h5-0-5" id="h5-0-5" class="d">-            }
</a><a href="#h5-0-6" id="h5-0-6" class="d">-            ast::Statement::Begin { read_only: false, as_of: Some(_) } =&gt; {
</a><a href="#h5-0-7" id="h5-0-7" class="d">-                return errinput!(&quot;can&#39;t start read-write transaction in a given version&quot;)
</a><a href="#h5-0-8" id="h5-0-8" class="d">-            }
</a><a href="#h5-0-9" id="h5-0-9" class="d">-            ast::Statement::Begin { read_only: false, as_of: None } =&gt; {
</a><a href="#h5-0-10" id="h5-0-10" class="d">-                let txn = self.engine.begin()?;
</a><a href="#h5-0-11" id="h5-0-11" class="d">-                let version = txn.version();
</a><a href="#h5-0-12" id="h5-0-12" class="d">-                self.txn = Some(txn);
</a><a href="#h5-0-13" id="h5-0-13" class="d">-                StatementResult::Begin { version, read_only: false }
</a><a href="#h5-0-14" id="h5-0-14" class="d">-            }
</a><a href="#h5-0-15" id="h5-0-15" class="d">-            ast::Statement::Begin { read_only: true, as_of: None } =&gt; {
</a><a href="#h5-0-16" id="h5-0-16" class="d">-                let txn = self.engine.begin_read_only()?;
</a><a href="#h5-0-17" id="h5-0-17" class="d">-                let version = txn.version();
</a><a href="#h5-0-18" id="h5-0-18" class="i">+            ast::Statement::Begin { read_only, as_of } =&gt; {
</a><a href="#h5-0-19" id="h5-0-19" class="i">+                if self.txn.is_some() {
</a><a href="#h5-0-20" id="h5-0-20" class="i">+                    return errinput!(&quot;already in a transaction&quot;);
</a><a href="#h5-0-21" id="h5-0-21" class="i">+                }
</a><a href="#h5-0-22" id="h5-0-22" class="i">+                let txn = match (read_only, as_of) {
</a><a href="#h5-0-23" id="h5-0-23" class="i">+                    (false, None) =&gt; self.engine.begin()?,
</a><a href="#h5-0-24" id="h5-0-24" class="i">+                    (true, None) =&gt; self.engine.begin_read_only()?,
</a><a href="#h5-0-25" id="h5-0-25" class="i">+                    (true, Some(as_of)) =&gt; self.engine.begin_as_of(as_of)?,
</a><a href="#h5-0-26" id="h5-0-26" class="i">+                    (false, Some(_)) =&gt; {
</a><a href="#h5-0-27" id="h5-0-27" class="i">+                        return errinput!(&quot;can&#39;t start read-write transaction in a given version&quot;)
</a><a href="#h5-0-28" id="h5-0-28" class="i">+                    }
</a><a href="#h5-0-29" id="h5-0-29" class="i">+                };
</a><a href="#h5-0-30" id="h5-0-30" class="i">+                let state = txn.state().clone();
</a>                 self.txn = Some(txn);
<a href="#h5-0-32" id="h5-0-32" class="d">-                StatementResult::Begin { version, read_only: true }
</a><a href="#h5-0-33" id="h5-0-33" class="d">-            }
</a><a href="#h5-0-34" id="h5-0-34" class="d">-            ast::Statement::Begin { read_only: true, as_of: Some(version) } =&gt; {
</a><a href="#h5-0-35" id="h5-0-35" class="d">-                self.txn = Some(self.engine.begin_as_of(version)?);
</a><a href="#h5-0-36" id="h5-0-36" class="d">-                StatementResult::Begin { version, read_only: true }
</a><a href="#h5-0-37" id="h5-0-37" class="i">+                StatementResult::Begin { state }
</a>             }
             ast::Statement::Commit =&gt; {
                 let Some(txn) = self.txn.take() else {
<a href="#h5-1" id="h5-1" class="h">@@ -131,7 +125,7 @@ impl&lt;&#39;a, E: Engine&lt;&#39;a&gt;&gt; Drop for Session&lt;&#39;a, E&gt; {
</a> /// A session statement result. Sent across the wire to SQL clients.
 #[derive(Debug, PartialEq, Serialize, Deserialize)]
 pub enum StatementResult {
<a href="#h5-1-3" id="h5-1-3" class="d">-    Begin { version: mvcc::Version, read_only: bool },
</a><a href="#h5-1-4" id="h5-1-4" class="i">+    Begin { state: mvcc::TransactionState },
</a>     Commit { version: mvcc::Version },
     Rollback { version: mvcc::Version },
     Explain(Plan),
<b>diff --git a/<a id="h6" href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a> b/<a href="../file/tests/e2e/client.rs.html">tests/e2e/client.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,3 +1,5 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+use std::collections::BTreeSet;
</a><a href="#h6-0-1" id="h6-0-1" class="i">+
</a> use super::{assert_row, assert_rows, dataset, TestCluster};
 
 use toydb::error::{Error, Result};
<a href="#h6-1" id="h6-1" class="h">@@ -240,8 +242,16 @@ fn execute_txn() -&gt; Result&lt;()&gt; {
</a>     assert_eq!(c.txn(), None);
 
     // Committing a change in a txn should work
<a href="#h6-1-3" id="h6-1-3" class="d">-    assert_eq!(c.execute(&quot;BEGIN&quot;)?, StatementResult::Begin { version: 2, read_only: false });
</a><a href="#h6-1-4" id="h6-1-4" class="d">-    assert_eq!(c.txn(), Some((2, false)));
</a><a href="#h6-1-5" id="h6-1-5" class="i">+    assert_eq!(
</a><a href="#h6-1-6" id="h6-1-6" class="i">+        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h6-1-7" id="h6-1-7" class="i">+        StatementResult::Begin {
</a><a href="#h6-1-8" id="h6-1-8" class="i">+            state: mvcc::TransactionState { version: 2, read_only: false, active: BTreeSet::new() }
</a><a href="#h6-1-9" id="h6-1-9" class="i">+        }
</a><a href="#h6-1-10" id="h6-1-10" class="i">+    );
</a><a href="#h6-1-11" id="h6-1-11" class="i">+    assert_eq!(
</a><a href="#h6-1-12" id="h6-1-12" class="i">+        c.txn(),
</a><a href="#h6-1-13" id="h6-1-13" class="i">+        Some(&amp;mvcc::TransactionState { version: 2, read_only: false, active: BTreeSet::new() })
</a><a href="#h6-1-14" id="h6-1-14" class="i">+    );
</a>     c.execute(&quot;INSERT INTO genres VALUES (4, &#39;Drama&#39;)&quot;)?;
     assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 2 });
     assert_eq!(c.txn(), None);
<a href="#h6-2" id="h6-2" class="h">@@ -252,8 +262,16 @@ fn execute_txn() -&gt; Result&lt;()&gt; {
</a>     assert_eq!(c.txn(), None);
 
     // Rolling back a change in a txn should also work
<a href="#h6-2-3" id="h6-2-3" class="d">-    assert_eq!(c.execute(&quot;BEGIN&quot;)?, StatementResult::Begin { version: 3, read_only: false });
</a><a href="#h6-2-4" id="h6-2-4" class="d">-    assert_eq!(c.txn(), Some((3, false)));
</a><a href="#h6-2-5" id="h6-2-5" class="i">+    assert_eq!(
</a><a href="#h6-2-6" id="h6-2-6" class="i">+        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h6-2-7" id="h6-2-7" class="i">+        StatementResult::Begin {
</a><a href="#h6-2-8" id="h6-2-8" class="i">+            state: mvcc::TransactionState { version: 3, read_only: false, active: BTreeSet::new() }
</a><a href="#h6-2-9" id="h6-2-9" class="i">+        }
</a><a href="#h6-2-10" id="h6-2-10" class="i">+    );
</a><a href="#h6-2-11" id="h6-2-11" class="i">+    assert_eq!(
</a><a href="#h6-2-12" id="h6-2-12" class="i">+        c.txn(),
</a><a href="#h6-2-13" id="h6-2-13" class="i">+        Some(&amp;mvcc::TransactionState { version: 3, read_only: false, active: BTreeSet::new() })
</a><a href="#h6-2-14" id="h6-2-14" class="i">+    );
</a>     c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;)?;
     assert_row(
         c.execute(&quot;SELECT * FROM genres WHERE id = 5&quot;)?,
<a href="#h6-3" id="h6-3" class="h">@@ -266,9 +284,14 @@ fn execute_txn() -&gt; Result&lt;()&gt; {
</a>     // Starting a read-only txn should block writes
     assert_eq!(
         c.execute(&quot;BEGIN READ ONLY&quot;)?,
<a href="#h6-3-3" id="h6-3-3" class="d">-        StatementResult::Begin { version: 4, read_only: true }
</a><a href="#h6-3-4" id="h6-3-4" class="i">+        StatementResult::Begin {
</a><a href="#h6-3-5" id="h6-3-5" class="i">+            state: mvcc::TransactionState { version: 4, read_only: true, active: BTreeSet::new() }
</a><a href="#h6-3-6" id="h6-3-6" class="i">+        }
</a><a href="#h6-3-7" id="h6-3-7" class="i">+    );
</a><a href="#h6-3-8" id="h6-3-8" class="i">+    assert_eq!(
</a><a href="#h6-3-9" id="h6-3-9" class="i">+        c.txn(),
</a><a href="#h6-3-10" id="h6-3-10" class="i">+        Some(&amp;mvcc::TransactionState { version: 4, read_only: true, active: BTreeSet::new() })
</a>     );
<a href="#h6-3-12" id="h6-3-12" class="d">-    assert_eq!(c.txn(), Some((4, true)));
</a>     assert_row(
         c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
         vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
<a href="#h6-4" id="h6-4" class="h">@@ -284,9 +307,14 @@ fn execute_txn() -&gt; Result&lt;()&gt; {
</a>     // block writes
     assert_eq!(
         c.execute(&quot;BEGIN READ ONLY AS OF SYSTEM TIME 2&quot;)?,
<a href="#h6-4-3" id="h6-4-3" class="d">-        StatementResult::Begin { version: 2, read_only: true },
</a><a href="#h6-4-4" id="h6-4-4" class="i">+        StatementResult::Begin {
</a><a href="#h6-4-5" id="h6-4-5" class="i">+            state: mvcc::TransactionState { version: 2, read_only: true, active: BTreeSet::new() }
</a><a href="#h6-4-6" id="h6-4-6" class="i">+        },
</a><a href="#h6-4-7" id="h6-4-7" class="i">+    );
</a><a href="#h6-4-8" id="h6-4-8" class="i">+    assert_eq!(
</a><a href="#h6-4-9" id="h6-4-9" class="i">+        c.txn(),
</a><a href="#h6-4-10" id="h6-4-10" class="i">+        Some(&amp;mvcc::TransactionState { version: 2, read_only: true, active: BTreeSet::new() })
</a>     );
<a href="#h6-4-12" id="h6-4-12" class="d">-    assert_eq!(c.txn(), Some((2, true)));
</a>     assert_rows(
         c.execute(&quot;SELECT * FROM genres&quot;)?,
         vec![
<a href="#h6-5" id="h6-5" class="h">@@ -299,13 +327,21 @@ fn execute_txn() -&gt; Result&lt;()&gt; {
</a>     assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 2 });
 
     // A txn should still be usable after an error occurs
<a href="#h6-5-3" id="h6-5-3" class="d">-    assert_eq!(c.execute(&quot;BEGIN&quot;)?, StatementResult::Begin { version: 4, read_only: false });
</a><a href="#h6-5-4" id="h6-5-4" class="i">+    assert_eq!(
</a><a href="#h6-5-5" id="h6-5-5" class="i">+        c.execute(&quot;BEGIN&quot;)?,
</a><a href="#h6-5-6" id="h6-5-6" class="i">+        StatementResult::Begin {
</a><a href="#h6-5-7" id="h6-5-7" class="i">+            state: mvcc::TransactionState { version: 4, read_only: false, active: BTreeSet::new() }
</a><a href="#h6-5-8" id="h6-5-8" class="i">+        },
</a><a href="#h6-5-9" id="h6-5-9" class="i">+    );
</a>     c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Horror&#39;)&quot;)?;
     assert_eq!(
         c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;),
         Err(Error::InvalidInput(&quot;primary key 5 already exists&quot;.into()))
     );
<a href="#h6-5-15" id="h6-5-15" class="d">-    assert_eq!(c.txn(), Some((4, false)));
</a><a href="#h6-5-16" id="h6-5-16" class="i">+    assert_eq!(
</a><a href="#h6-5-17" id="h6-5-17" class="i">+        c.txn(),
</a><a href="#h6-5-18" id="h6-5-18" class="i">+        Some(&amp;mvcc::TransactionState { version: 4, read_only: false, active: BTreeSet::new() })
</a><a href="#h6-5-19" id="h6-5-19" class="i">+    );
</a>     c.execute(&quot;INSERT INTO genres VALUES (6, &#39;Western&#39;)&quot;)?;
     assert_eq!(c.execute(&quot;COMMIT&quot;)?, StatementResult::Commit { version: 4 });
     assert_rows(
<a href="#h6-6" id="h6-6" class="h">@@ -331,8 +367,22 @@ fn execute_txn_concurrent() -&gt; Result&lt;()&gt; {
</a>     let mut b = tc.connect_any()?;
 
     // Concurrent updates should throw a serialization failure on conflict.
<a href="#h6-6-3" id="h6-6-3" class="d">-    assert_eq!(a.execute(&quot;BEGIN&quot;)?, StatementResult::Begin { version: 2, read_only: false });
</a><a href="#h6-6-4" id="h6-6-4" class="d">-    assert_eq!(b.execute(&quot;BEGIN&quot;)?, StatementResult::Begin { version: 3, read_only: false });
</a><a href="#h6-6-5" id="h6-6-5" class="i">+    assert_eq!(
</a><a href="#h6-6-6" id="h6-6-6" class="i">+        a.execute(&quot;BEGIN&quot;)?,
</a><a href="#h6-6-7" id="h6-6-7" class="i">+        StatementResult::Begin {
</a><a href="#h6-6-8" id="h6-6-8" class="i">+            state: mvcc::TransactionState { version: 2, read_only: false, active: BTreeSet::new() }
</a><a href="#h6-6-9" id="h6-6-9" class="i">+        },
</a><a href="#h6-6-10" id="h6-6-10" class="i">+    );
</a><a href="#h6-6-11" id="h6-6-11" class="i">+    assert_eq!(
</a><a href="#h6-6-12" id="h6-6-12" class="i">+        b.execute(&quot;BEGIN&quot;)?,
</a><a href="#h6-6-13" id="h6-6-13" class="i">+        StatementResult::Begin {
</a><a href="#h6-6-14" id="h6-6-14" class="i">+            state: mvcc::TransactionState {
</a><a href="#h6-6-15" id="h6-6-15" class="i">+                version: 3,
</a><a href="#h6-6-16" id="h6-6-16" class="i">+                read_only: false,
</a><a href="#h6-6-17" id="h6-6-17" class="i">+                active: BTreeSet::from([2])
</a><a href="#h6-6-18" id="h6-6-18" class="i">+            }
</a><a href="#h6-6-19" id="h6-6-19" class="i">+        },
</a><a href="#h6-6-20" id="h6-6-20" class="i">+    );
</a> 
     assert_row(
         a.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</pre>
</div>
</body>
</html>
