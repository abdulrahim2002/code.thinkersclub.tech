<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: add `Values` plan node for emitting constant values - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/dc10f61a57cab5e55c1846555d4df601aeea5725.html">dc10f61a57cab5e55c1846555d4df601aeea5725</a>
<b>parent</b> <a href="../commit/770d283aca0a90abd029e151728e36f1307877af.html">770d283aca0a90abd029e151728e36f1307877af</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Thu, 20 Jun 2024 20:25:49 +0200

sql: add `Values` plan node for emitting constant values

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/sql/execution/execute.rs</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/execution/source.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/execution/write.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">37</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/planner/planner.rs</a></td><td> | </td><td class="num">21</td><td><span class="i">++++++++++++</span><span class="d">---------</span></td></tr>
</table></pre><pre>5 files changed, 59 insertions(+), 30 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a> b/<a href="../file/src/sql/execution/execute.rs.html">src/sql/execution/execute.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -34,8 +34,9 @@ pub fn execute_plan(
</a>             ExecutionResult::Delete { count }
         }
 
<a href="#h0-0-3" id="h0-0-3" class="d">-        Plan::Insert { table, columns, expressions } =&gt; {
</a><a href="#h0-0-4" id="h0-0-4" class="d">-            let count = write::insert(txn, table, columns, expressions)?;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+        Plan::Insert { table, columns, source } =&gt; {
</a><a href="#h0-0-6" id="h0-0-6" class="i">+            let source = execute(source, txn)?;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+            let count = write::insert(txn, table, columns, source)?;
</a>             ExecutionResult::Insert { count }
         }
 
<a href="#h0-1" id="h0-1" class="h">@@ -106,6 +107,8 @@ pub fn execute(node: Node, txn: &amp;impl Transaction) -&gt; Result&lt;QueryIterator&gt; {
</a>         }
 
         Node::Scan { table, alias: _, filter } =&gt; source::scan(txn, table, filter),
<a href="#h0-1-3" id="h0-1-3" class="i">+
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        Node::Values { labels, rows } =&gt; Ok(source::values(labels, rows)),
</a>     }
 }
 
<b>diff --git a/<a id="h1" href="../file/src/sql/execution/source.rs.html">src/sql/execution/source.rs</a> b/<a href="../file/src/sql/execution/source.rs.html">src/sql/execution/source.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,7 +1,7 @@
</a> use super::QueryIterator;
 use crate::error::Result;
 use crate::sql::engine::Transaction;
<a href="#h1-0-3" id="h1-0-3" class="d">-use crate::sql::types::{Expression, Row, Table, Value};
</a><a href="#h1-0-4" id="h1-0-4" class="i">+use crate::sql::types::{Expression, Label, Row, Table, Value};
</a> 
 /// A table scan source.
 pub(super) fn scan(
<a href="#h1-1" id="h1-1" class="h">@@ -48,3 +48,13 @@ pub(super) fn lookup_index(
</a> pub(super) fn nothing() -&gt; QueryIterator {
     QueryIterator { columns: Vec::new(), rows: Box::new(std::iter::once(Ok(Row::new()))) }
 }
<a href="#h1-1-3" id="h1-1-3" class="i">+
</a><a href="#h1-1-4" id="h1-1-4" class="i">+/// Emits predefined constant values.
</a><a href="#h1-1-5" id="h1-1-5" class="i">+pub(super) fn values(labels: Vec&lt;Option&lt;Label&gt;&gt;, rows: Vec&lt;Vec&lt;Expression&gt;&gt;) -&gt; QueryIterator {
</a><a href="#h1-1-6" id="h1-1-6" class="i">+    QueryIterator {
</a><a href="#h1-1-7" id="h1-1-7" class="i">+        columns: labels,
</a><a href="#h1-1-8" id="h1-1-8" class="i">+        rows: Box::new(
</a><a href="#h1-1-9" id="h1-1-9" class="i">+            rows.into_iter().map(|row| row.into_iter().map(|expr| expr.evaluate(None)).collect()),
</a><a href="#h1-1-10" id="h1-1-10" class="i">+        ),
</a><a href="#h1-1-11" id="h1-1-11" class="i">+    }
</a><a href="#h1-1-12" id="h1-1-12" class="i">+}
</a><b>diff --git a/<a id="h2" href="../file/src/sql/execution/write.rs.html">src/sql/execution/write.rs</a> b/<a href="../file/src/sql/execution/write.rs.html">src/sql/execution/write.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -19,18 +19,16 @@ pub(super) fn delete(
</a> }
 
 /// Inserts rows into a table (i.e. INSERT).
<a href="#h2-0-3" id="h2-0-3" class="d">-///
</a><a href="#h2-0-4" id="h2-0-4" class="d">-/// TODO: this should take rows from a values source.
</a> pub(super) fn insert(
     txn: &amp;impl Transaction,
     table: Table,
     columns: Vec&lt;String&gt;,
<a href="#h2-0-9" id="h2-0-9" class="d">-    values: Vec&lt;Vec&lt;Expression&gt;&gt;,
</a><a href="#h2-0-10" id="h2-0-10" class="i">+    mut source: QueryIterator,
</a> ) -&gt; Result&lt;u64&gt; {
<a href="#h2-0-12" id="h2-0-12" class="d">-    let mut rows = Vec::with_capacity(values.len());
</a><a href="#h2-0-13" id="h2-0-13" class="d">-    for expressions in values {
</a><a href="#h2-0-14" id="h2-0-14" class="d">-        let mut row =
</a><a href="#h2-0-15" id="h2-0-15" class="d">-            expressions.into_iter().map(|expr| expr.evaluate(None)).collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h2-0-16" id="h2-0-16" class="i">+    let mut rows = Vec::new();
</a><a href="#h2-0-17" id="h2-0-17" class="i">+    while let Some(mut row) = source.next().transpose()? {
</a><a href="#h2-0-18" id="h2-0-18" class="i">+        // TODO: the pad/make row logic should probably be moved to the Values
</a><a href="#h2-0-19" id="h2-0-19" class="i">+        // source, or otherwise have a better mapping from the source.
</a>         if columns.is_empty() {
             row = pad_row(&amp;table, row)?;
         } else {
<b>diff --git a/<a id="h3" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -4,7 +4,7 @@ use crate::error::Result;
</a> use crate::sql::engine::{Catalog, Transaction};
 use crate::sql::execution::{self, ExecutionResult};
 use crate::sql::parser::ast;
<a href="#h3-0-3" id="h3-0-3" class="d">-use crate::sql::types::{Expression, Table, Value};
</a><a href="#h3-0-4" id="h3-0-4" class="i">+use crate::sql::types::{Expression, Label, Table, Value};
</a> 
 use serde::{Deserialize, Serialize};
 
<a href="#h3-1" id="h3-1" class="h">@@ -20,8 +20,7 @@ pub enum Plan {
</a>     /// A DELETE plan.
     Delete { table: String, key_index: usize, source: Node },
     /// An INSERT plan.
<a href="#h3-1-3" id="h3-1-3" class="d">-    /// TODO: consider using a source which generates expression rows.
</a><a href="#h3-1-4" id="h3-1-4" class="d">-    Insert { table: Table, columns: Vec&lt;String&gt;, expressions: Vec&lt;Vec&lt;Expression&gt;&gt; },
</a><a href="#h3-1-5" id="h3-1-5" class="i">+    Insert { table: Table, columns: Vec&lt;String&gt;, source: Node },
</a>     /// An UPDATE plan.
     Update {
         table: String,
<a href="#h3-2" id="h3-2" class="h">@@ -80,8 +79,8 @@ impl std::fmt::Display for Plan {
</a>                     source.format(String::new(), false, true).trim_end()
                 )
             }
<a href="#h3-2-3" id="h3-2-3" class="d">-            Self::Insert { table, columns: _, expressions } =&gt; {
</a><a href="#h3-2-4" id="h3-2-4" class="d">-                write!(f, &quot;Insert: {} ({} rows)&quot;, table.name, expressions.len())
</a><a href="#h3-2-5" id="h3-2-5" class="i">+            Self::Insert { table, columns: _, source: _ } =&gt; {
</a><a href="#h3-2-6" id="h3-2-6" class="i">+                write!(f, &quot;Insert: {}&quot;, table.name)
</a>             }
             Self::Select(root) =&gt; root.fmt(f),
             Self::Update { table, key_index: _, source, expressions } =&gt; {
<a href="#h3-3" id="h3-3" class="h">@@ -117,9 +116,9 @@ pub enum Node {
</a>     },
     HashJoin {
         left: Box&lt;Node&gt;,
<a href="#h3-3-3" id="h3-3-3" class="d">-        left_field: (usize, Option&lt;(Option&lt;String&gt;, String)&gt;),
</a><a href="#h3-3-4" id="h3-3-4" class="i">+        left_field: (usize, Option&lt;Label&gt;),
</a>         right: Box&lt;Node&gt;,
<a href="#h3-3-6" id="h3-3-6" class="d">-        right_field: (usize, Option&lt;(Option&lt;String&gt;, String)&gt;),
</a><a href="#h3-3-7" id="h3-3-7" class="i">+        right_field: (usize, Option&lt;Label&gt;),
</a>         outer: bool,
     },
     IndexLookup {
<a href="#h3-4" id="h3-4" class="h">@@ -144,6 +143,7 @@ pub enum Node {
</a>         predicate: Option&lt;Expression&gt;,
         outer: bool,
     },
<a href="#h3-4-3" id="h3-4-3" class="i">+    // TODO: replace with Values, but requires changes to aggregate planning.
</a>     Nothing,
     Offset {
         source: Box&lt;Node&gt;,
<a href="#h3-5" id="h3-5" class="h">@@ -162,6 +162,10 @@ pub enum Node {
</a>         alias: Option&lt;String&gt;,
         filter: Option&lt;Expression&gt;,
     },
<a href="#h3-5-3" id="h3-5-3" class="i">+    Values {
</a><a href="#h3-5-4" id="h3-5-4" class="i">+        labels: Vec&lt;Option&lt;Label&gt;&gt;,
</a><a href="#h3-5-5" id="h3-5-5" class="i">+        rows: Vec&lt;Vec&lt;Expression&gt;&gt;,
</a><a href="#h3-5-6" id="h3-5-6" class="i">+    },
</a> }
 
 impl Node {
<a href="#h3-6" id="h3-6" class="h">@@ -174,10 +178,11 @@ impl Node {
</a>     {
         self = before(self)?;
         self = match self {
<a href="#h3-6-3" id="h3-6-3" class="d">-            node @ Self::IndexLookup { .. }
</a><a href="#h3-6-4" id="h3-6-4" class="d">-            | node @ Self::KeyLookup { .. }
</a><a href="#h3-6-5" id="h3-6-5" class="d">-            | node @ Self::Nothing
</a><a href="#h3-6-6" id="h3-6-6" class="d">-            | node @ Self::Scan { .. } =&gt; node,
</a><a href="#h3-6-7" id="h3-6-7" class="i">+            node @ (Self::IndexLookup { .. }
</a><a href="#h3-6-8" id="h3-6-8" class="i">+            | Self::KeyLookup { .. }
</a><a href="#h3-6-9" id="h3-6-9" class="i">+            | Self::Nothing
</a><a href="#h3-6-10" id="h3-6-10" class="i">+            | Self::Scan { .. }
</a><a href="#h3-6-11" id="h3-6-11" class="i">+            | Self::Values { .. }) =&gt; node,
</a> 
             Self::Aggregation { source, aggregates } =&gt; {
                 Self::Aggregation { source: source.transform(before, after)?.into(), aggregates }
<a href="#h3-7" id="h3-7" class="h">@@ -264,6 +269,13 @@ impl Node {
</a>             Self::Scan { table, alias, filter: Some(filter) } =&gt; {
                 Self::Scan { table, alias, filter: Some(filter.transform(before, after)?) }
             }
<a href="#h3-7-3" id="h3-7-3" class="i">+            Self::Values { labels, rows } =&gt; Self::Values {
</a><a href="#h3-7-4" id="h3-7-4" class="i">+                labels,
</a><a href="#h3-7-5" id="h3-7-5" class="i">+                rows: rows
</a><a href="#h3-7-6" id="h3-7-6" class="i">+                    .into_iter()
</a><a href="#h3-7-7" id="h3-7-7" class="i">+                    .map(|row| row.into_iter().map(|e| e.transform(before, after)).collect())
</a><a href="#h3-7-8" id="h3-7-8" class="i">+                    .collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h3-7-9" id="h3-7-9" class="i">+            },
</a>         })
     }
 
<a href="#h3-8" id="h3-8" class="h">@@ -391,6 +403,9 @@ impl Node {
</a>                 }
                 s += &quot;\n&quot;;
             }
<a href="#h3-8-3" id="h3-8-3" class="i">+            Self::Values { labels: _, rows } =&gt; {
</a><a href="#h3-8-4" id="h3-8-4" class="i">+                s += &amp;format!(&quot;Values: {} rows\n&quot;, rows.len());
</a><a href="#h3-8-5" id="h3-8-5" class="i">+            }
</a>         };
         if root {
             s = s.trim_end().to_string()
<b>diff --git a/<a id="h4" href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a> b/<a href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -91,15 +91,18 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>                 Plan::Insert {
                     table,
                     columns: columns.unwrap_or_default(),
<a href="#h4-0-3" id="h4-0-3" class="d">-                    expressions: values
</a><a href="#h4-0-4" id="h4-0-4" class="d">-                        .into_iter()
</a><a href="#h4-0-5" id="h4-0-5" class="d">-                        .map(|exprs| {
</a><a href="#h4-0-6" id="h4-0-6" class="d">-                            exprs
</a><a href="#h4-0-7" id="h4-0-7" class="d">-                                .into_iter()
</a><a href="#h4-0-8" id="h4-0-8" class="d">-                                .map(|expr| self.build_expression(&amp;mut Scope::constant(), expr))
</a><a href="#h4-0-9" id="h4-0-9" class="d">-                                .collect::&lt;Result&lt;_&gt;&gt;()
</a><a href="#h4-0-10" id="h4-0-10" class="d">-                        })
</a><a href="#h4-0-11" id="h4-0-11" class="d">-                        .collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h4-0-12" id="h4-0-12" class="i">+                    source: Node::Values {
</a><a href="#h4-0-13" id="h4-0-13" class="i">+                        labels: vec![None; values.len()],
</a><a href="#h4-0-14" id="h4-0-14" class="i">+                        rows: values
</a><a href="#h4-0-15" id="h4-0-15" class="i">+                            .into_iter()
</a><a href="#h4-0-16" id="h4-0-16" class="i">+                            .map(|exprs| {
</a><a href="#h4-0-17" id="h4-0-17" class="i">+                                exprs
</a><a href="#h4-0-18" id="h4-0-18" class="i">+                                    .into_iter()
</a><a href="#h4-0-19" id="h4-0-19" class="i">+                                    .map(|expr| self.build_expression(&amp;mut Scope::constant(), expr))
</a><a href="#h4-0-20" id="h4-0-20" class="i">+                                    .collect::&lt;Result&lt;_&gt;&gt;()
</a><a href="#h4-0-21" id="h4-0-21" class="i">+                            })
</a><a href="#h4-0-22" id="h4-0-22" class="i">+                            .collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h4-0-23" id="h4-0-23" class="i">+                    },
</a>                 }
             }
 
</pre>
</div>
</body>
</html>
