<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>rewrote SQL client/server with Tokio (fixes #14) - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/feff035f0ac5ef69da2526c352b9571d93d35df4.html">feff035f0ac5ef69da2526c352b9571d93d35df4</a>
<b>parent</b> <a href="../commit/3ff36bd4754197e1bfdc720bf56c16d14ab2d565.html">3ff36bd4754197e1bfdc720bf56c16d14ab2d565</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 19 Apr 2020 18:43:51 +0200

rewrote SQL client/server with Tokio (fixes #14)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">233</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">5</td><td><span class="i">+++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">build.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">clusters/local/toydb-a/toydb.yaml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">clusters/local/toydb-b/toydb.yaml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">clusters/local/toydb-c/toydb.yaml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">clusters/local/toydb-d/toydb.yaml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">clusters/local/toydb-e/toydb.yaml</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">config/toydb.yaml</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h9">protobuf/toydb.proto</a></td><td> | </td><td class="num">22</td><td><span class="i"></span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">src/bin/bank.rs</a></td><td> | </td><td class="num">401</td><td><span class="i">++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/bin/toydb.rs</a></td><td> | </td><td class="num">16</td><td><span class="i">+++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">src/bin/toysql.rs</a></td><td> | </td><td class="num">107</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/client.rs</a></td><td> | </td><td class="num">207</td><td><span class="i">+++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/error.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/kv/mvcc.rs</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/raft/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/server/mod.rs</a></td><td> | </td><td class="num">32</td><td><span class="i">+++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">src/server/toydb.rs</a></td><td> | </td><td class="num">170</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h19">src/service/mod.rs</a></td><td> | </td><td class="num">8</td><td><span class="i"></span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h21">src/sql/engine/mod.rs</a></td><td> | </td><td class="num">56</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h23">src/sql/execution/mod.rs</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">src/sql/types/mod.rs</a></td><td> | </td><td class="num">44</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">tests/client/mod.rs</a></td><td> | </td><td class="num">292</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">--------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">tests/cluster/isolation.rs</a></td><td> | </td><td class="num">111</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">tests/setup.rs</a></td><td> | </td><td class="num">84</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">tests/sql/dml.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">tests/sql/expression.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">tests/sql/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">tests/sql/query.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">tests/sql/schema.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h33">tests/tests.rs</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
</table></pre><pre>34 files changed, 1093 insertions(+), 837 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -61,6 +61,15 @@ version = &quot;0.11.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-0-3" id="h0-0-3" class="i">+name = &quot;bincode&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+version = &quot;1.2.1&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-6" id="h0-0-6" class="i">+dependencies = [
</a><a href="#h0-0-7" id="h0-0-7" class="i">+ &quot;byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-8" id="h0-0-8" class="i">+ &quot;serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-9" id="h0-0-9" class="i">+]
</a><a href="#h0-0-10" id="h0-0-10" class="i">+
</a><a href="#h0-0-11" id="h0-0-11" class="i">+[[package]]
</a> name = &quot;bitflags&quot;
 version = &quot;1.2.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-1" id="h0-1" class="h">@@ -90,6 +99,11 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-1-3" id="h0-1-3" class="i">+name = &quot;bytes&quot;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+version = &quot;0.5.4&quot;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+
</a><a href="#h0-1-7" id="h0-1-7" class="i">+[[package]]
</a> name = &quot;cc&quot;
 version = &quot;1.0.50&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-2" id="h0-2" class="h">@@ -290,6 +304,34 @@ version = &quot;0.1.29&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-2-3" id="h0-2-3" class="i">+name = &quot;futures&quot;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-2-5" id="h0-2-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-6" id="h0-2-6" class="i">+dependencies = [
</a><a href="#h0-2-7" id="h0-2-7" class="i">+ &quot;futures-channel 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-8" id="h0-2-8" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+ &quot;futures-executor 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-10" id="h0-2-10" class="i">+ &quot;futures-io 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-11" id="h0-2-11" class="i">+ &quot;futures-sink 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-12" id="h0-2-12" class="i">+ &quot;futures-task 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-13" id="h0-2-13" class="i">+ &quot;futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-14" id="h0-2-14" class="i">+]
</a><a href="#h0-2-15" id="h0-2-15" class="i">+
</a><a href="#h0-2-16" id="h0-2-16" class="i">+[[package]]
</a><a href="#h0-2-17" id="h0-2-17" class="i">+name = &quot;futures-channel&quot;
</a><a href="#h0-2-18" id="h0-2-18" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-2-19" id="h0-2-19" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-20" id="h0-2-20" class="i">+dependencies = [
</a><a href="#h0-2-21" id="h0-2-21" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-22" id="h0-2-22" class="i">+ &quot;futures-sink 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-23" id="h0-2-23" class="i">+]
</a><a href="#h0-2-24" id="h0-2-24" class="i">+
</a><a href="#h0-2-25" id="h0-2-25" class="i">+[[package]]
</a><a href="#h0-2-26" id="h0-2-26" class="i">+name = &quot;futures-core&quot;
</a><a href="#h0-2-27" id="h0-2-27" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-2-28" id="h0-2-28" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-29" id="h0-2-29" class="i">+
</a><a href="#h0-2-30" id="h0-2-30" class="i">+[[package]]
</a> name = &quot;futures-cpupool&quot;
 version = &quot;0.1.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-3" id="h0-3" class="h">@@ -299,6 +341,60 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-3-3" id="h0-3-3" class="i">+name = &quot;futures-executor&quot;
</a><a href="#h0-3-4" id="h0-3-4" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-5" id="h0-3-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-6" id="h0-3-6" class="i">+dependencies = [
</a><a href="#h0-3-7" id="h0-3-7" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-8" id="h0-3-8" class="i">+ &quot;futures-task 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-9" id="h0-3-9" class="i">+ &quot;futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-10" id="h0-3-10" class="i">+]
</a><a href="#h0-3-11" id="h0-3-11" class="i">+
</a><a href="#h0-3-12" id="h0-3-12" class="i">+[[package]]
</a><a href="#h0-3-13" id="h0-3-13" class="i">+name = &quot;futures-io&quot;
</a><a href="#h0-3-14" id="h0-3-14" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-15" id="h0-3-15" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-16" id="h0-3-16" class="i">+
</a><a href="#h0-3-17" id="h0-3-17" class="i">+[[package]]
</a><a href="#h0-3-18" id="h0-3-18" class="i">+name = &quot;futures-macro&quot;
</a><a href="#h0-3-19" id="h0-3-19" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-20" id="h0-3-20" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-21" id="h0-3-21" class="i">+dependencies = [
</a><a href="#h0-3-22" id="h0-3-22" class="i">+ &quot;proc-macro-hack 0.5.15 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-23" id="h0-3-23" class="i">+ &quot;proc-macro2 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-24" id="h0-3-24" class="i">+ &quot;quote 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-25" id="h0-3-25" class="i">+ &quot;syn 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-26" id="h0-3-26" class="i">+]
</a><a href="#h0-3-27" id="h0-3-27" class="i">+
</a><a href="#h0-3-28" id="h0-3-28" class="i">+[[package]]
</a><a href="#h0-3-29" id="h0-3-29" class="i">+name = &quot;futures-sink&quot;
</a><a href="#h0-3-30" id="h0-3-30" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-31" id="h0-3-31" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-32" id="h0-3-32" class="i">+
</a><a href="#h0-3-33" id="h0-3-33" class="i">+[[package]]
</a><a href="#h0-3-34" id="h0-3-34" class="i">+name = &quot;futures-task&quot;
</a><a href="#h0-3-35" id="h0-3-35" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-36" id="h0-3-36" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-37" id="h0-3-37" class="i">+
</a><a href="#h0-3-38" id="h0-3-38" class="i">+[[package]]
</a><a href="#h0-3-39" id="h0-3-39" class="i">+name = &quot;futures-util&quot;
</a><a href="#h0-3-40" id="h0-3-40" class="i">+version = &quot;0.3.4&quot;
</a><a href="#h0-3-41" id="h0-3-41" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-42" id="h0-3-42" class="i">+dependencies = [
</a><a href="#h0-3-43" id="h0-3-43" class="i">+ &quot;futures-channel 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-44" id="h0-3-44" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-45" id="h0-3-45" class="i">+ &quot;futures-io 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-46" id="h0-3-46" class="i">+ &quot;futures-macro 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-47" id="h0-3-47" class="i">+ &quot;futures-sink 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-48" id="h0-3-48" class="i">+ &quot;futures-task 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-49" id="h0-3-49" class="i">+ &quot;memchr 2.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-50" id="h0-3-50" class="i">+ &quot;pin-utils 0.1.0-alpha.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-51" id="h0-3-51" class="i">+ &quot;proc-macro-hack 0.5.15 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-52" id="h0-3-52" class="i">+ &quot;proc-macro-nested 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-53" id="h0-3-53" class="i">+ &quot;slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-3-54" id="h0-3-54" class="i">+]
</a><a href="#h0-3-55" id="h0-3-55" class="i">+
</a><a href="#h0-3-56" id="h0-3-56" class="i">+[[package]]
</a> name = &quot;getrandom&quot;
 version = &quot;0.1.14&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-4" id="h0-4" class="h">@@ -346,6 +442,11 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-4-3" id="h0-4-3" class="i">+name = &quot;half&quot;
</a><a href="#h0-4-4" id="h0-4-4" class="i">+version = &quot;1.5.0&quot;
</a><a href="#h0-4-5" id="h0-4-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-4-6" id="h0-4-6" class="i">+
</a><a href="#h0-4-7" id="h0-4-7" class="i">+[[package]]
</a> name = &quot;hermit-abi&quot;
 version = &quot;0.1.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-5" id="h0-5" class="h">@@ -634,6 +735,34 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-5-3" id="h0-5-3" class="i">+name = &quot;pin-project&quot;
</a><a href="#h0-5-4" id="h0-5-4" class="i">+version = &quot;0.4.9&quot;
</a><a href="#h0-5-5" id="h0-5-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-6" id="h0-5-6" class="i">+dependencies = [
</a><a href="#h0-5-7" id="h0-5-7" class="i">+ &quot;pin-project-internal 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-8" id="h0-5-8" class="i">+]
</a><a href="#h0-5-9" id="h0-5-9" class="i">+
</a><a href="#h0-5-10" id="h0-5-10" class="i">+[[package]]
</a><a href="#h0-5-11" id="h0-5-11" class="i">+name = &quot;pin-project-internal&quot;
</a><a href="#h0-5-12" id="h0-5-12" class="i">+version = &quot;0.4.9&quot;
</a><a href="#h0-5-13" id="h0-5-13" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-14" id="h0-5-14" class="i">+dependencies = [
</a><a href="#h0-5-15" id="h0-5-15" class="i">+ &quot;proc-macro2 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-16" id="h0-5-16" class="i">+ &quot;quote 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-17" id="h0-5-17" class="i">+ &quot;syn 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-18" id="h0-5-18" class="i">+]
</a><a href="#h0-5-19" id="h0-5-19" class="i">+
</a><a href="#h0-5-20" id="h0-5-20" class="i">+[[package]]
</a><a href="#h0-5-21" id="h0-5-21" class="i">+name = &quot;pin-project-lite&quot;
</a><a href="#h0-5-22" id="h0-5-22" class="i">+version = &quot;0.1.4&quot;
</a><a href="#h0-5-23" id="h0-5-23" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-24" id="h0-5-24" class="i">+
</a><a href="#h0-5-25" id="h0-5-25" class="i">+[[package]]
</a><a href="#h0-5-26" id="h0-5-26" class="i">+name = &quot;pin-utils&quot;
</a><a href="#h0-5-27" id="h0-5-27" class="i">+version = &quot;0.1.0-alpha.4&quot;
</a><a href="#h0-5-28" id="h0-5-28" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-29" id="h0-5-29" class="i">+
</a><a href="#h0-5-30" id="h0-5-30" class="i">+[[package]]
</a> name = &quot;ppv-lite86&quot;
 version = &quot;0.2.6&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-6" id="h0-6" class="h">@@ -650,6 +779,16 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-6-3" id="h0-6-3" class="i">+name = &quot;proc-macro-hack&quot;
</a><a href="#h0-6-4" id="h0-6-4" class="i">+version = &quot;0.5.15&quot;
</a><a href="#h0-6-5" id="h0-6-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-6-6" id="h0-6-6" class="i">+
</a><a href="#h0-6-7" id="h0-6-7" class="i">+[[package]]
</a><a href="#h0-6-8" id="h0-6-8" class="i">+name = &quot;proc-macro-nested&quot;
</a><a href="#h0-6-9" id="h0-6-9" class="i">+version = &quot;0.1.4&quot;
</a><a href="#h0-6-10" id="h0-6-10" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-6-11" id="h0-6-11" class="i">+
</a><a href="#h0-6-12" id="h0-6-12" class="i">+[[package]]
</a> name = &quot;proc-macro2&quot;
 version = &quot;1.0.9&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-7" id="h0-7" class="h">@@ -946,6 +1085,15 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-7-3" id="h0-7-3" class="i">+name = &quot;serde_cbor&quot;
</a><a href="#h0-7-4" id="h0-7-4" class="i">+version = &quot;0.11.1&quot;
</a><a href="#h0-7-5" id="h0-7-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-7-6" id="h0-7-6" class="i">+dependencies = [
</a><a href="#h0-7-7" id="h0-7-7" class="i">+ &quot;half 1.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-7-8" id="h0-7-8" class="i">+ &quot;serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-7-9" id="h0-7-9" class="i">+]
</a><a href="#h0-7-10" id="h0-7-10" class="i">+
</a><a href="#h0-7-11" id="h0-7-11" class="i">+[[package]]
</a> name = &quot;serde_derive&quot;
 version = &quot;1.0.105&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-8" id="h0-8" class="h">@@ -1139,6 +1287,26 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-8-3" id="h0-8-3" class="i">+name = &quot;tokio&quot;
</a><a href="#h0-8-4" id="h0-8-4" class="i">+version = &quot;0.2.18&quot;
</a><a href="#h0-8-5" id="h0-8-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-8-6" id="h0-8-6" class="i">+dependencies = [
</a><a href="#h0-8-7" id="h0-8-7" class="i">+ &quot;bytes 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-8" id="h0-8-8" class="i">+ &quot;fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-9" id="h0-8-9" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-10" id="h0-8-10" class="i">+ &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-11" id="h0-8-11" class="i">+ &quot;lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-12" id="h0-8-12" class="i">+ &quot;libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-13" id="h0-8-13" class="i">+ &quot;memchr 2.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-14" id="h0-8-14" class="i">+ &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-15" id="h0-8-15" class="i">+ &quot;mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-16" id="h0-8-16" class="i">+ &quot;num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-17" id="h0-8-17" class="i">+ &quot;pin-project-lite 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-18" id="h0-8-18" class="i">+ &quot;slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-19" id="h0-8-19" class="i">+ &quot;tokio-macros 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-20" id="h0-8-20" class="i">+]
</a><a href="#h0-8-21" id="h0-8-21" class="i">+
</a><a href="#h0-8-22" id="h0-8-22" class="i">+[[package]]
</a> name = &quot;tokio-codec&quot;
 version = &quot;0.1.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-9" id="h0-9" class="h">@@ -1205,6 +1373,16 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-9-3" id="h0-9-3" class="i">+name = &quot;tokio-macros&quot;
</a><a href="#h0-9-4" id="h0-9-4" class="i">+version = &quot;0.2.5&quot;
</a><a href="#h0-9-5" id="h0-9-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-9-6" id="h0-9-6" class="i">+dependencies = [
</a><a href="#h0-9-7" id="h0-9-7" class="i">+ &quot;proc-macro2 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-8" id="h0-9-8" class="i">+ &quot;quote 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-9" id="h0-9-9" class="i">+ &quot;syn 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-10" id="h0-9-10" class="i">+]
</a><a href="#h0-9-11" id="h0-9-11" class="i">+
</a><a href="#h0-9-12" id="h0-9-12" class="i">+[[package]]
</a> name = &quot;tokio-reactor&quot;
 version = &quot;0.1.12&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-10" id="h0-10" class="h">@@ -1223,6 +1401,20 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-10-3" id="h0-10-3" class="i">+name = &quot;tokio-serde&quot;
</a><a href="#h0-10-4" id="h0-10-4" class="i">+version = &quot;0.6.1&quot;
</a><a href="#h0-10-5" id="h0-10-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-10-6" id="h0-10-6" class="i">+dependencies = [
</a><a href="#h0-10-7" id="h0-10-7" class="i">+ &quot;bincode 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-8" id="h0-10-8" class="i">+ &quot;bytes 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-9" id="h0-10-9" class="i">+ &quot;derivative 2.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-10" id="h0-10-10" class="i">+ &quot;futures 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-11" id="h0-10-11" class="i">+ &quot;pin-project 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-12" id="h0-10-12" class="i">+ &quot;serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-13" id="h0-10-13" class="i">+ &quot;serde_cbor 0.11.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-14" id="h0-10-14" class="i">+]
</a><a href="#h0-10-15" id="h0-10-15" class="i">+
</a><a href="#h0-10-16" id="h0-10-16" class="i">+[[package]]
</a> name = &quot;tokio-sync&quot;
 version = &quot;0.1.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-11" id="h0-11" class="h">@@ -1338,6 +1530,19 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-11-3" id="h0-11-3" class="i">+name = &quot;tokio-util&quot;
</a><a href="#h0-11-4" id="h0-11-4" class="i">+version = &quot;0.3.1&quot;
</a><a href="#h0-11-5" id="h0-11-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-6" id="h0-11-6" class="i">+dependencies = [
</a><a href="#h0-11-7" id="h0-11-7" class="i">+ &quot;bytes 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-8" id="h0-11-8" class="i">+ &quot;futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-9" id="h0-11-9" class="i">+ &quot;futures-sink 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-10" id="h0-11-10" class="i">+ &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-11" id="h0-11-11" class="i">+ &quot;pin-project-lite 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-12" id="h0-11-12" class="i">+ &quot;tokio 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-13" id="h0-11-13" class="i">+]
</a><a href="#h0-11-14" id="h0-11-14" class="i">+
</a><a href="#h0-11-15" id="h0-11-15" class="i">+[[package]]
</a> name = &quot;toml&quot;
 version = &quot;0.4.10&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-12" id="h0-12" class="h">@@ -1354,6 +1559,8 @@ dependencies = [
</a>  &quot;config 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;crossbeam 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;derivative 2.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-12-3" id="h0-12-3" class="i">+ &quot;futures 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-12-4" id="h0-12-4" class="i">+ &quot;futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;goldenfile 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-13" id="h0-13" class="h">@@ -1374,6 +1581,9 @@ dependencies = [
</a>  &quot;simplelog 0.7.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;tempfile 3.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-13-3" id="h0-13-3" class="i">+ &quot;tokio 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-13-4" id="h0-13-4" class="i">+ &quot;tokio-serde 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-13-5" id="h0-13-5" class="i">+ &quot;tokio-util 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;uuid 0.8.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
 
<a href="#h0-14" id="h0-14" class="h">@@ -1490,10 +1700,12 @@ dependencies = [
</a> &quot;checksum autocfg 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f8aac770f1885fd7e387acedd76065302551364496e46b3dd00860b2f8359b9d&quot;
 &quot;checksum base64 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b41b7ea54a0c9d92199de89e20e58d49f02f8e699814ef3fdf266f6f748d15c7&quot;
 &quot;checksum base64 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;489d6c0ed21b11d038c31b6ceccca973e65d73ba3bd8ecb9a2babf5546164643&quot;
<a href="#h0-14-3" id="h0-14-3" class="i">+&quot;checksum bincode 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5753e2a71534719bf3f4e57006c3a4f0d2c672a4b676eec84161f763eca87dbf&quot;
</a> &quot;checksum bitflags 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;cf1de2fe8c75bc145a2f577add951f8134889b4795d47466a54a5c846d691693&quot;
 &quot;checksum blake2b_simd 0.5.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d8fb2d74254a3a0b5cac33ac9f8ed0e44aa50378d9dbb2e5d83bd21ed1dc2c8a&quot;
 &quot;checksum byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;08c48aae112d48ed9f069b33538ea9e3e90aa263cfa3d1c24309612b1f7472de&quot;
 &quot;checksum bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;206fdffcfa2df7cbe15601ef46c813fce0965eb3286db6b56c583b814b51c81c&quot;
<a href="#h0-14-8" id="h0-14-8" class="i">+&quot;checksum bytes 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;130aac562c0dd69c56b3b1cc8ffd2e17be31d0b6c25b61c96b76231aa23e39e1&quot;
</a> &quot;checksum cc 1.0.50 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;95e28fa049fda1c330bcf9d723be7663a899c4679724b34c81e9f5a326aab8cd&quot;
 &quot;checksum cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;4785bdd1c96b2a846b2bd7cc02e86b6b3dbf14e7e53446c4f54c92a361040822&quot;
 &quot;checksum chrono 0.4.11 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;80094f509cf8b5ae86a4966a39b3ff66cd7e2a3e594accec3743ff3fabeab5b2&quot;
<a href="#h0-15" id="h0-15" class="h">@@ -1517,11 +1729,21 @@ dependencies = [
</a> &quot;checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82&quot;
 &quot;checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7&quot;
 &quot;checksum futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1b980f2816d6ee8673b6517b52cb0e808a180efc92e5c19d02cdda79066703ef&quot;
<a href="#h0-15-3" id="h0-15-3" class="i">+&quot;checksum futures 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5c329ae8753502fb44ae4fc2b622fa2a94652c41e795143765ba0927f92ab780&quot;
</a><a href="#h0-15-4" id="h0-15-4" class="i">+&quot;checksum futures-channel 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f0c77d04ce8edd9cb903932b608268b3fffec4163dc053b3b402bf47eac1f1a8&quot;
</a><a href="#h0-15-5" id="h0-15-5" class="i">+&quot;checksum futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f25592f769825e89b92358db00d26f965761e094951ac44d3663ef25b7ac464a&quot;
</a> &quot;checksum futures-cpupool 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ab90cde24b3319636588d0c35fe03b1333857621051837ed769faefb4c2162e4&quot;
<a href="#h0-15-7" id="h0-15-7" class="i">+&quot;checksum futures-executor 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f674f3e1bcb15b37284a90cedf55afdba482ab061c407a9c0ebbd0f3109741ba&quot;
</a><a href="#h0-15-8" id="h0-15-8" class="i">+&quot;checksum futures-io 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a638959aa96152c7a4cddf50fcb1e3fede0583b27157c26e67d6f99904090dc6&quot;
</a><a href="#h0-15-9" id="h0-15-9" class="i">+&quot;checksum futures-macro 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9a5081aa3de1f7542a794a397cde100ed903b0630152d0973479018fd85423a7&quot;
</a><a href="#h0-15-10" id="h0-15-10" class="i">+&quot;checksum futures-sink 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3466821b4bc114d95b087b850a724c6f83115e929bc88f1fa98a3304a944c8a6&quot;
</a><a href="#h0-15-11" id="h0-15-11" class="i">+&quot;checksum futures-task 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7b0a34e53cf6cdcd0178aa573aed466b646eb3db769570841fda0c7ede375a27&quot;
</a><a href="#h0-15-12" id="h0-15-12" class="i">+&quot;checksum futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;22766cf25d64306bedf0384da004d05c9974ab104fcc4528f1236181c18004c5&quot;
</a> &quot;checksum getrandom 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7abc8dd8451921606d809ba32e95b6111925cd2906060d2dcc29c070220503eb&quot;
 &quot;checksum goldenfile 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3f46e6a4d70c06f0b9a70d36dd8eef4fdeaa1ab657e4f1eaff290f69e48145f2&quot;
 &quot;checksum grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2aaf1d741fe6f3413f1f9f71b99f5e4e26776d563475a8a53ce53a73a8534c1d&quot;
 &quot;checksum grpc-compiler 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;907274ce8ee7b40a0d0b0db09022ea22846a47cfb1fc8ad2c983c70001b4ffb1&quot;
<a href="#h0-15-17" id="h0-15-17" class="i">+&quot;checksum half 1.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f36b5f248235f45773d4944f555f83ea61fe07b18b561ccf99d7483d7381e54d&quot;
</a> &quot;checksum hermit-abi 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1010591b26bbfe835e9faeabeb11866061cc7dcebffd56ad7d0942d0e61aefd8&quot;
 &quot;checksum httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7689cfa896b2a71da4f16206af167542b75d242b6906313e53857972a92d5614&quot;
 &quot;checksum iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b2b3ea6ff95e175473f8ffe6a7eb7c00d054240321b84c57051175fe3c1e075e&quot;
<a href="#h0-16" id="h0-16" class="h">@@ -1554,8 +1776,14 @@ dependencies = [
</a> &quot;checksum parking_lot 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f842b1982eb6c2fe34036a4fbfb06dd185a3f5c8edfaacdf7d1ea10b07de6252&quot;
 &quot;checksum parking_lot_core 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b876b1b9e7ac6e1a74a6da34d25c42e17e8862aa409cbbbdcfc8d86c6f3bc62b&quot;
 &quot;checksum parking_lot_core 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7582838484df45743c8434fbff785e8edf260c28748353d44bc0da32e0ceabf1&quot;
<a href="#h0-16-3" id="h0-16-3" class="i">+&quot;checksum pin-project 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6f6a7f5eee6292c559c793430c55c00aea9d3b3d1905e855806ca4d7253426a2&quot;
</a><a href="#h0-16-4" id="h0-16-4" class="i">+&quot;checksum pin-project-internal 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8988430ce790d8682672117bc06dda364c0be32d3abd738234f19f3240bad99a&quot;
</a><a href="#h0-16-5" id="h0-16-5" class="i">+&quot;checksum pin-project-lite 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;237844750cfbb86f67afe27eee600dfbbcb6188d734139b534cbfbf4f96792ae&quot;
</a><a href="#h0-16-6" id="h0-16-6" class="i">+&quot;checksum pin-utils 0.1.0-alpha.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5894c618ce612a3fa23881b152b608bafb8c56cfc22f434a3ba3120b40f7b587&quot;
</a> &quot;checksum ppv-lite86 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;74490b50b9fbe561ac330df47c08f3f33073d2d00c150f719147d7c54522fa1b&quot;
 &quot;checksum pretty_assertions 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3f81e1644e1b54f5a68959a29aa86cde704219254669da328ecfdf6a1f09d427&quot;
<a href="#h0-16-9" id="h0-16-9" class="i">+&quot;checksum proc-macro-hack 0.5.15 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0d659fe7c6d27f25e9d80a1a094c223f5246f6a6596453e09d7229bf42750b63&quot;
</a><a href="#h0-16-10" id="h0-16-10" class="i">+&quot;checksum proc-macro-nested 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8e946095f9d3ed29ec38de908c22f95d9ac008e424c7bcae54c75a79c527c694&quot;
</a> &quot;checksum proc-macro2 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6c09721c6781493a2a492a96b5a5bf19b65917fe6728884e7c44dd0c60ca3435&quot;
 &quot;checksum protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;70731852eec72c56d11226c8a5f96ad5058a3dab73647ca5f7ee351e464f2571&quot;
 &quot;checksum protobuf-codegen 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3d74b9cbbf2ac9a7169c85a3714ec16c51ee9ec7cfd511549527e9a7df720795&quot;
<a href="#h0-17" id="h0-17" class="h">@@ -1592,6 +1820,7 @@ dependencies = [
</a> &quot;checksum serde 0.8.23 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9dad3f759919b92c3068c696c15c3d17238234498bbdcc80f2c469606f948ac8&quot;
 &quot;checksum serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e707fbbf255b8fc8c3b99abb91e7257a622caeb20a9818cbadbeeede4e0932ff&quot;
 &quot;checksum serde-hjson 0.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0b833c5ad67d52ced5f5938b2980f32a9c1c5ef047f0b4fb3127e7a423c76153&quot;
<a href="#h0-17-3" id="h0-17-3" class="i">+&quot;checksum serde_cbor 0.11.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1e18acfa2f90e8b735b2836ab8d538de304cbb6729a7360729ea5a895d15a622&quot;
</a> &quot;checksum serde_derive 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ac5d00fc561ba2724df6758a17de23df5914f20e41cb00f94d5b7ae42fffaff8&quot;
 &quot;checksum serde_json 1.0.48 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9371ade75d4c2d6cb154141b9752cf3781ec9c05e0e5cf35060e1e70ee7b9c25&quot;
 &quot;checksum serde_test 0.8.23 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;110b3dbdf8607ec493c22d5d947753282f3bae73c0f56d322af1e8c78e4c23d5&quot;
<a href="#h0-18" id="h0-18" class="h">@@ -1613,13 +1842,16 @@ dependencies = [
</a> &quot;checksum tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;049c03787a0595182357fbd487577947f4351b78ce20c3668f6d49f17feb13d1&quot;
 &quot;checksum tls-api-stub 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c9a0cc8c149724db9de7d73a0e1bc80b1a74f5394f08c6f301e11f9c35fa061e&quot;
 &quot;checksum tokio 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5a09c0b5bb588872ab2f09afa13ee6e9dac11e10a0ec9e8e3ba39a5a5d530af6&quot;
<a href="#h0-18-3" id="h0-18-3" class="i">+&quot;checksum tokio 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;34ef16d072d2b6dc8b4a56c70f5c5ced1a37752116f8e7c1e80c659aa7cb6713&quot;
</a> &quot;checksum tokio-codec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;25b2998660ba0e70d18684de5d06b70b70a3a747469af9dea7618cc59e75976b&quot;
 &quot;checksum tokio-core 0.1.17 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;aeeffbbb94209023feaef3c196a41cbcdafa06b4a6f893f68779bb5e53796f71&quot;
 &quot;checksum tokio-current-thread 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b1de0e32a83f131e002238d7ccde18211c0a5397f60cbfffcb112868c2e0e20e&quot;
 &quot;checksum tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;fb2d1b8f4548dbf5e1f7818512e9c406860678f29c300cdf0ebac72d1a3a1671&quot;
 &quot;checksum tokio-fs 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;297a1206e0ca6302a0eed35b700d292b275256f596e2f3fea7729d5e629b6ff4&quot;
 &quot;checksum tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;57fc868aae093479e3131e3d165c93b1c7474109d13c90ec0dda2a1bbfff0674&quot;
<a href="#h0-18-10" id="h0-18-10" class="i">+&quot;checksum tokio-macros 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f0c3acc6aa564495a0f2e1d59fab677cd7f81a19994cfc7f3ad0e64301560389&quot;
</a> &quot;checksum tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;09bc590ec4ba8ba87652da2068d150dcada2cfa2e07faae270a5e0409aa51351&quot;
<a href="#h0-18-12" id="h0-18-12" class="i">+&quot;checksum tokio-serde 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ebdd897b01021779294eb09bb3b52b6e11b0747f9f7e333a84bef532b656de99&quot;
</a> &quot;checksum tokio-sync 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;edfe50152bc8164fcc456dab7891fa9bf8beaf01c5ee7e1dd43a397c3cf87dee&quot;
 &quot;checksum tokio-tcp 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;98df18ed66e3b72e742f185882a9e201892407957e45fbff8da17ae7a7c51f72&quot;
 &quot;checksum tokio-threadpool 0.1.18 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;df720b6581784c118f0eb4310796b12b1d242a7eb95f716a8367855325c25f89&quot;
<a href="#h0-19" id="h0-19" class="h">@@ -1629,6 +1861,7 @@ dependencies = [
</a> &quot;checksum tokio-udp 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e2a0b10e610b39c38b031a2fcab08e4b82f16ece36504988dcbd81dbba650d82&quot;
 &quot;checksum tokio-uds 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;65ae5d255ce739e8537221ed2942e0445f4b3b813daebac1c0050ddaaa3587f9&quot;
 &quot;checksum tokio-uds 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5076db410d6fdc6523df7595447629099a1fdc47b3d9f896220780fa48faf798&quot;
<a href="#h0-19-3" id="h0-19-3" class="i">+&quot;checksum tokio-util 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;be8242891f2b6cbef26a2d7e8605133c2c554cd35b3e4948ea892d6d68436499&quot;
</a> &quot;checksum toml 0.4.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;758664fc71a3a69038656bee8b6be6477d2a6c315a6b81f7081f591bffa4111f&quot;
 &quot;checksum unicode-segmentation 1.6.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e83e153d1053cbb5a118eeff7fd5be06ed99153f00dbcd8ae310c5fb2b22edc0&quot;
 &quot;checksum unicode-width 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;caaa9d531767d1ff2150b9332433f32a24622147e5ebb1f26409d5da67afd479&quot;
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -11,6 +11,8 @@ clap = &quot;~2.33.0&quot;
</a> config = &quot;~0.9.3&quot;
 crossbeam = &quot;~0.7.3&quot;
 derivative = &quot;~2.1.0&quot;
<a href="#h1-0-3" id="h1-0-3" class="i">+futures = &quot;0.3.4&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+futures-util = &quot;0.3.4&quot;
</a> grpc = &quot;~0.6.1&quot;
 lazy_static = &quot;~1.4.0&quot;
 log = &quot;~0.4.6&quot;
<a href="#h1-1" id="h1-1" class="h">@@ -23,6 +25,9 @@ rustyline = &quot;~5.0.0&quot;
</a> serde = &quot;~1.0.91&quot;
 serde_derive = &quot;~1.0.91&quot;
 simplelog = &quot;~0.7.4&quot;
<a href="#h1-1-3" id="h1-1-3" class="i">+tokio = { version = &quot;0.2.18&quot;, features = [&quot;macros&quot;, &quot;rt-core&quot;, &quot;rt-threaded&quot;, &quot;net&quot;, &quot;tcp&quot;, &quot;stream&quot;, &quot;io-util&quot;, &quot;time&quot;, &quot;blocking&quot;, &quot;sync&quot;] }
</a><a href="#h1-1-4" id="h1-1-4" class="i">+tokio-serde = { version = &quot;0.6.1&quot;, features = [&quot;bincode&quot;, &quot;cbor&quot;] }
</a><a href="#h1-1-5" id="h1-1-5" class="i">+tokio-util = { version = &quot;0.3.1&quot;, features = [&quot;codec&quot;] }
</a> uuid = { version = &quot;~0.8.1&quot;, features = [&quot;v4&quot;] }
 
 # The following are sub-dependencies that we need for error handling
<b>diff --git a/<a id="h2" href="../file/build.rs.html">build.rs</a> b/<a href="../file/build.rs.html">build.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -2,7 +2,7 @@ extern crate protoc_rust_grpc;
</a> 
 fn main() {
     // Generate Protobuf shims
<a href="#h2-0-3" id="h2-0-3" class="d">-    let protobuf_sources = &amp;[&quot;protobuf/raft.proto&quot;, &quot;protobuf/toydb.proto&quot;];
</a><a href="#h2-0-4" id="h2-0-4" class="i">+    let protobuf_sources = &amp;[&quot;protobuf/raft.proto&quot;];
</a> 
     protoc_rust_grpc::run(protoc_rust_grpc::Args {
         input: protobuf_sources,
<b>diff --git a/<a id="h3" href="../file/clusters/local/toydb-a/toydb.yaml.html">clusters/local/toydb-a/toydb.yaml</a> b/<a href="../file/clusters/local/toydb-a/toydb.yaml.html">clusters/local/toydb-a/toydb.yaml</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,8 +1,9 @@
</a> id: toydb-a
 data_dir: toydb-a/data
<a href="#h3-0-2" id="h3-0-2" class="d">-listen: 127.0.0.1:9601
</a><a href="#h3-0-3" id="h3-0-3" class="i">+listen_sql: 0.0.0.0:9601
</a><a href="#h3-0-4" id="h3-0-4" class="i">+listen_raft: 0.0.0.0:9701
</a> peers:
<a href="#h3-0-6" id="h3-0-6" class="d">-  toydb-b: 127.0.0.1:9602
</a><a href="#h3-0-7" id="h3-0-7" class="d">-  toydb-c: 127.0.0.1:9603
</a><a href="#h3-0-8" id="h3-0-8" class="d">-  toydb-d: 127.0.0.1:9604
</a><a href="#h3-0-9" id="h3-0-9" class="d">-  toydb-e: 127.0.0.1:9605
</a><a href="#h3-0-10" id="h3-0-10" class="d">-\ No newline at end of file
</a><a href="#h3-0-11" id="h3-0-11" class="i">+  toydb-b: 127.0.0.1:9702
</a><a href="#h3-0-12" id="h3-0-12" class="i">+  toydb-c: 127.0.0.1:9703
</a><a href="#h3-0-13" id="h3-0-13" class="i">+  toydb-d: 127.0.0.1:9704
</a><a href="#h3-0-14" id="h3-0-14" class="i">+  toydb-e: 127.0.0.1:9705
</a><a href="#h3-0-15" id="h3-0-15" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/clusters/local/toydb-b/toydb.yaml.html">clusters/local/toydb-b/toydb.yaml</a> b/<a href="../file/clusters/local/toydb-b/toydb.yaml.html">clusters/local/toydb-b/toydb.yaml</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,8 +1,9 @@
</a> id: toydb-b
 data_dir: toydb-b/data
<a href="#h4-0-2" id="h4-0-2" class="d">-listen: 127.0.0.1:9602
</a><a href="#h4-0-3" id="h4-0-3" class="i">+listen_sql: 0.0.0.0:9602
</a><a href="#h4-0-4" id="h4-0-4" class="i">+listen_raft: 0.0.0.0:9702
</a> peers:
<a href="#h4-0-6" id="h4-0-6" class="d">-  toydb-a: 127.0.0.1:9601
</a><a href="#h4-0-7" id="h4-0-7" class="d">-  toydb-c: 127.0.0.1:9603
</a><a href="#h4-0-8" id="h4-0-8" class="d">-  toydb-d: 127.0.0.1:9604
</a><a href="#h4-0-9" id="h4-0-9" class="d">-  toydb-e: 127.0.0.1:9605
</a><a href="#h4-0-10" id="h4-0-10" class="d">-\ No newline at end of file
</a><a href="#h4-0-11" id="h4-0-11" class="i">+  toydb-a: 127.0.0.1:9701
</a><a href="#h4-0-12" id="h4-0-12" class="i">+  toydb-c: 127.0.0.1:9703
</a><a href="#h4-0-13" id="h4-0-13" class="i">+  toydb-d: 127.0.0.1:9704
</a><a href="#h4-0-14" id="h4-0-14" class="i">+  toydb-e: 127.0.0.1:9705
</a><a href="#h4-0-15" id="h4-0-15" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/clusters/local/toydb-c/toydb.yaml.html">clusters/local/toydb-c/toydb.yaml</a> b/<a href="../file/clusters/local/toydb-c/toydb.yaml.html">clusters/local/toydb-c/toydb.yaml</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,8 +1,9 @@
</a> id: toydb-c
 data_dir: toydb-c/data
<a href="#h5-0-2" id="h5-0-2" class="d">-listen: 127.0.0.1:9603
</a><a href="#h5-0-3" id="h5-0-3" class="i">+listen_sql: 0.0.0.0:9603
</a><a href="#h5-0-4" id="h5-0-4" class="i">+listen_raft: 0.0.0.0:9703
</a> peers:
<a href="#h5-0-6" id="h5-0-6" class="d">-  toydb-a: 127.0.0.1:9601
</a><a href="#h5-0-7" id="h5-0-7" class="d">-  toydb-b: 127.0.0.1:9602
</a><a href="#h5-0-8" id="h5-0-8" class="d">-  toydb-d: 127.0.0.1:9604
</a><a href="#h5-0-9" id="h5-0-9" class="d">-  toydb-e: 127.0.0.1:9605
</a><a href="#h5-0-10" id="h5-0-10" class="d">-\ No newline at end of file
</a><a href="#h5-0-11" id="h5-0-11" class="i">+  toydb-a: 127.0.0.1:9701
</a><a href="#h5-0-12" id="h5-0-12" class="i">+  toydb-b: 127.0.0.1:9702
</a><a href="#h5-0-13" id="h5-0-13" class="i">+  toydb-d: 127.0.0.1:9704
</a><a href="#h5-0-14" id="h5-0-14" class="i">+  toydb-e: 127.0.0.1:9705
</a><a href="#h5-0-15" id="h5-0-15" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h6" href="../file/clusters/local/toydb-d/toydb.yaml.html">clusters/local/toydb-d/toydb.yaml</a> b/<a href="../file/clusters/local/toydb-d/toydb.yaml.html">clusters/local/toydb-d/toydb.yaml</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,8 +1,9 @@
</a> id: toydb-d
 data_dir: toydb-d/data
<a href="#h6-0-2" id="h6-0-2" class="d">-listen: 127.0.0.1:9604
</a><a href="#h6-0-3" id="h6-0-3" class="i">+listen_sql: 0.0.0.0:9604
</a><a href="#h6-0-4" id="h6-0-4" class="i">+listen_raft: 0.0.0.0:9704
</a> peers:
<a href="#h6-0-6" id="h6-0-6" class="d">-  toydb-a: 127.0.0.1:9601
</a><a href="#h6-0-7" id="h6-0-7" class="d">-  toydb-b: 127.0.0.1:9602
</a><a href="#h6-0-8" id="h6-0-8" class="d">-  toydb-c: 127.0.0.1:9603
</a><a href="#h6-0-9" id="h6-0-9" class="d">-  toydb-e: 127.0.0.1:9605
</a><a href="#h6-0-10" id="h6-0-10" class="d">-\ No newline at end of file
</a><a href="#h6-0-11" id="h6-0-11" class="i">+  toydb-a: 127.0.0.1:9701
</a><a href="#h6-0-12" id="h6-0-12" class="i">+  toydb-b: 127.0.0.1:9702
</a><a href="#h6-0-13" id="h6-0-13" class="i">+  toydb-c: 127.0.0.1:9703
</a><a href="#h6-0-14" id="h6-0-14" class="i">+  toydb-e: 127.0.0.1:9705
</a><a href="#h6-0-15" id="h6-0-15" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h7" href="../file/clusters/local/toydb-e/toydb.yaml.html">clusters/local/toydb-e/toydb.yaml</a> b/<a href="../file/clusters/local/toydb-e/toydb.yaml.html">clusters/local/toydb-e/toydb.yaml</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,8 +1,9 @@
</a> id: toydb-e
 data_dir: toydb-e/data
<a href="#h7-0-2" id="h7-0-2" class="d">-listen: 127.0.0.1:9605
</a><a href="#h7-0-3" id="h7-0-3" class="i">+listen_sql: 0.0.0.0:9605
</a><a href="#h7-0-4" id="h7-0-4" class="i">+listen_raft: 0.0.0.0:9705
</a> peers:
<a href="#h7-0-6" id="h7-0-6" class="d">-  toydb-a: 127.0.0.1:9601
</a><a href="#h7-0-7" id="h7-0-7" class="d">-  toydb-b: 127.0.0.1:9602
</a><a href="#h7-0-8" id="h7-0-8" class="d">-  toydb-c: 127.0.0.1:9603
</a><a href="#h7-0-9" id="h7-0-9" class="d">-  toydb-d: 127.0.0.1:9604
</a><a href="#h7-0-10" id="h7-0-10" class="d">-\ No newline at end of file
</a><a href="#h7-0-11" id="h7-0-11" class="i">+  toydb-a: 127.0.0.1:9701
</a><a href="#h7-0-12" id="h7-0-12" class="i">+  toydb-b: 127.0.0.1:9702
</a><a href="#h7-0-13" id="h7-0-13" class="i">+  toydb-c: 127.0.0.1:9703
</a><a href="#h7-0-14" id="h7-0-14" class="i">+  toydb-d: 127.0.0.1:9704
</a><a href="#h7-0-15" id="h7-0-15" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/config/toydb.yaml.html">config/toydb.yaml</a> b/<a href="../file/config/toydb.yaml.html">config/toydb.yaml</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,5 +1,6 @@
</a> id: toydb
<a href="#h8-0-1" id="h8-0-1" class="d">-listen: 0.0.0.0:9605
</a><a href="#h8-0-2" id="h8-0-2" class="i">+listen_sql: 0.0.0.0:9605
</a><a href="#h8-0-3" id="h8-0-3" class="i">+listen_raft: 0.0.0.0:9705
</a> log_level: INFO
 data_dir: /var/lib/toydb
 peers: {}
<b>diff --git a/<a id="h9" href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a> b/<a href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,22 +0,0 @@
</a><a href="#h9-0-0" id="h9-0-0" class="d">-syntax = &quot;proto3&quot;;
</a><a href="#h9-0-1" id="h9-0-1" class="d">-
</a><a href="#h9-0-2" id="h9-0-2" class="d">-// The main ToyDB service used by ToyDB clients. Passes byte buffers since we&#39;ll be
</a><a href="#h9-0-3" id="h9-0-3" class="d">-// transitioning away from Protobuf and gRPC for client/server communication.
</a><a href="#h9-0-4" id="h9-0-4" class="d">-service ToyDB {
</a><a href="#h9-0-5" id="h9-0-5" class="d">-  rpc Call(Request) returns (Result) {};
</a><a href="#h9-0-6" id="h9-0-6" class="d">-  rpc Execute(Query) returns (stream Result) {};
</a><a href="#h9-0-7" id="h9-0-7" class="d">-};
</a><a href="#h9-0-8" id="h9-0-8" class="d">-
</a><a href="#h9-0-9" id="h9-0-9" class="d">-message Request {
</a><a href="#h9-0-10" id="h9-0-10" class="d">-  bytes body = 1;
</a><a href="#h9-0-11" id="h9-0-11" class="d">-}
</a><a href="#h9-0-12" id="h9-0-12" class="d">-
</a><a href="#h9-0-13" id="h9-0-13" class="d">-message Query {
</a><a href="#h9-0-14" id="h9-0-14" class="d">-  uint64 txn_id = 1;
</a><a href="#h9-0-15" id="h9-0-15" class="d">-  string query = 2;
</a><a href="#h9-0-16" id="h9-0-16" class="d">-};
</a><a href="#h9-0-17" id="h9-0-17" class="d">-
</a><a href="#h9-0-18" id="h9-0-18" class="d">-message Result {
</a><a href="#h9-0-19" id="h9-0-19" class="d">-  bytes ok = 1;
</a><a href="#h9-0-20" id="h9-0-20" class="d">-  bytes err = 2;
</a><a href="#h9-0-21" id="h9-0-21" class="d">-}
</a><b>diff --git a/<a id="h10" href="../file/src/bin/bank.rs.html">src/bin/bank.rs</a> b/<a href="../file/src/bin/bank.rs.html">src/bin/bank.rs</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -5,24 +5,18 @@
</a> 
 #![warn(clippy::all)]
 
<a href="#h10-0-3" id="h10-0-3" class="d">-#[macro_use]
</a><a href="#h10-0-4" id="h10-0-4" class="d">-extern crate clap;
</a><a href="#h10-0-5" id="h10-0-5" class="d">-extern crate crossbeam;
</a><a href="#h10-0-6" id="h10-0-6" class="d">-extern crate names;
</a><a href="#h10-0-7" id="h10-0-7" class="d">-extern crate rand;
</a><a href="#h10-0-8" id="h10-0-8" class="d">-extern crate toydb;
</a><a href="#h10-0-9" id="h10-0-9" class="d">-
</a><a href="#h10-0-10" id="h10-0-10" class="i">+use clap::{app_from_crate, crate_authors, crate_description, crate_name, crate_version};
</a><a href="#h10-0-11" id="h10-0-11" class="i">+use futures::stream::TryStreamExt as _;
</a> use rand::distributions::Distribution;
<a href="#h10-0-13" id="h10-0-13" class="d">-use rand::prelude::*;
</a><a href="#h10-0-14" id="h10-0-14" class="d">-use toydb::client::Client;
</a><a href="#h10-0-15" id="h10-0-15" class="d">-use toydb::sql::execution::ResultSet;
</a><a href="#h10-0-16" id="h10-0-16" class="d">-use toydb::sql::types::Value;
</a><a href="#h10-0-17" id="h10-0-17" class="i">+use rand::Rng as _;
</a><a href="#h10-0-18" id="h10-0-18" class="i">+use tokio::net::ToSocketAddrs;
</a><a href="#h10-0-19" id="h10-0-19" class="i">+use tokio::sync::MutexGuard;
</a><a href="#h10-0-20" id="h10-0-20" class="i">+use toydb::client::{Client, Pool};
</a> use toydb::Error;
 
<a href="#h10-0-23" id="h10-0-23" class="d">-fn main() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-0-24" id="h10-0-24" class="i">+#[tokio::main]
</a><a href="#h10-0-25" id="h10-0-25" class="i">+async fn main() -&gt; Result&lt;(), Error&gt; {
</a>     let opts = app_from_crate!()
<a href="#h10-0-27" id="h10-0-27" class="d">-        .arg(clap::Arg::with_name(&quot;command&quot;))
</a><a href="#h10-0-28" id="h10-0-28" class="d">-        .arg(clap::Arg::with_name(&quot;headers&quot;).short(&quot;H&quot;).long(&quot;headers&quot;).help(&quot;Show column headers&quot;))
</a>         .arg(
             clap::Arg::with_name(&quot;host&quot;)
                 .short(&quot;h&quot;)
<a href="#h10-1" id="h10-1" class="h">@@ -74,83 +68,60 @@ fn main() -&gt; Result&lt;(), Error&gt; {
</a> 
     Bank::new(
         opts.values_of(&quot;host&quot;).unwrap().map(String::from).collect(),
<a href="#h10-1-3" id="h10-1-3" class="i">+        opts.value_of(&quot;concurrency&quot;).unwrap().parse()?,
</a>         opts.value_of(&quot;customers&quot;).unwrap().parse()?,
         opts.value_of(&quot;accounts&quot;).unwrap().parse()?,
<a href="#h10-1-6" id="h10-1-6" class="d">-    )?
</a><a href="#h10-1-7" id="h10-1-7" class="d">-    .run(
</a><a href="#h10-1-8" id="h10-1-8" class="d">-        opts.value_of(&quot;concurrency&quot;).unwrap().parse()?,
</a><a href="#h10-1-9" id="h10-1-9" class="d">-        opts.value_of(&quot;transactions&quot;).unwrap().parse()?,
</a>     )
<a href="#h10-1-11" id="h10-1-11" class="i">+    .await?
</a><a href="#h10-1-12" id="h10-1-12" class="i">+    .run(opts.value_of(&quot;transactions&quot;).unwrap().parse()?)
</a><a href="#h10-1-13" id="h10-1-13" class="i">+    .await
</a> }
 
 struct Bank {
<a href="#h10-1-17" id="h10-1-17" class="d">-    hosts: Vec&lt;(String, u16)&gt;,
</a><a href="#h10-1-18" id="h10-1-18" class="i">+    clients: Pool,
</a>     customers: i64,
     customer_accounts: i64,
<a href="#h10-1-21" id="h10-1-21" class="d">-    initial_balance: i64,
</a> }
 
 impl Bank {
<a href="#h10-1-25" id="h10-1-25" class="i">+    const INITIAL_BALANCE: u64 = 100;
</a><a href="#h10-1-26" id="h10-1-26" class="i">+    const TXN_RETRIES: u64 = 8;
</a><a href="#h10-1-27" id="h10-1-27" class="i">+
</a>     // Creates a new bank simulation
<a href="#h10-1-29" id="h10-1-29" class="d">-    fn new(hosts: Vec&lt;String&gt;, customers: i64, accounts: i64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h10-1-30" id="h10-1-30" class="d">-        let mut h = Vec::new();
</a><a href="#h10-1-31" id="h10-1-31" class="d">-        for host in hosts {
</a><a href="#h10-1-32" id="h10-1-32" class="d">-            let parts: Vec&lt;&amp;str&gt; = host.split(&#39;:&#39;).collect();
</a><a href="#h10-1-33" id="h10-1-33" class="d">-            h.push((parts[0].to_string(), if parts.len() &gt;= 2 { parts[1].parse()? } else { 9605 }));
</a><a href="#h10-1-34" id="h10-1-34" class="d">-        }
</a><a href="#h10-1-35" id="h10-1-35" class="d">-        Ok(Self { hosts: h, customers, customer_accounts: accounts, initial_balance: 100 })
</a><a href="#h10-1-36" id="h10-1-36" class="i">+    async fn new&lt;A: ToSocketAddrs + Clone&gt;(
</a><a href="#h10-1-37" id="h10-1-37" class="i">+        addrs: Vec&lt;A&gt;,
</a><a href="#h10-1-38" id="h10-1-38" class="i">+        concurrency: u64,
</a><a href="#h10-1-39" id="h10-1-39" class="i">+        customers: i64,
</a><a href="#h10-1-40" id="h10-1-40" class="i">+        accounts: i64,
</a><a href="#h10-1-41" id="h10-1-41" class="i">+    ) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h10-1-42" id="h10-1-42" class="i">+        Ok(Self {
</a><a href="#h10-1-43" id="h10-1-43" class="i">+            clients: Pool::new(addrs, concurrency).await?,
</a><a href="#h10-1-44" id="h10-1-44" class="i">+            customers,
</a><a href="#h10-1-45" id="h10-1-45" class="i">+            customer_accounts: accounts,
</a><a href="#h10-1-46" id="h10-1-46" class="i">+        })
</a>     }
 
     // Runs the bank simulation
<a href="#h10-1-50" id="h10-1-50" class="d">-    fn run(&amp;self, concurrency: i64, transactions: i64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-1-51" id="h10-1-51" class="d">-        println!(
</a><a href="#h10-1-52" id="h10-1-52" class="d">-            &quot;Using {} threads with {}&quot;,
</a><a href="#h10-1-53" id="h10-1-53" class="d">-            concurrency,
</a><a href="#h10-1-54" id="h10-1-54" class="d">-            self.hosts
</a><a href="#h10-1-55" id="h10-1-55" class="d">-                .iter()
</a><a href="#h10-1-56" id="h10-1-56" class="d">-                .map(|(h, p)| format!(&quot;{}:{}&quot;, h, p))
</a><a href="#h10-1-57" id="h10-1-57" class="d">-                .collect::&lt;Vec&lt;String&gt;&gt;()
</a><a href="#h10-1-58" id="h10-1-58" class="d">-                .join(&quot;,&quot;),
</a><a href="#h10-1-59" id="h10-1-59" class="d">-        );
</a><a href="#h10-1-60" id="h10-1-60" class="d">-
</a><a href="#h10-1-61" id="h10-1-61" class="d">-        let mut hosts = self.hosts.iter().cycle();
</a><a href="#h10-1-62" id="h10-1-62" class="d">-        let client = &amp;mut {
</a><a href="#h10-1-63" id="h10-1-63" class="d">-            let (host, port) = hosts.next().unwrap();
</a><a href="#h10-1-64" id="h10-1-64" class="d">-            Client::new(host, *port)?
</a><a href="#h10-1-65" id="h10-1-65" class="d">-        };
</a><a href="#h10-1-66" id="h10-1-66" class="i">+    async fn run(&amp;self, transactions: u64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-1-67" id="h10-1-67" class="i">+        self.setup().await?;
</a><a href="#h10-1-68" id="h10-1-68" class="i">+        self.verify().await?;
</a><a href="#h10-1-69" id="h10-1-69" class="i">+        println!();
</a> 
<a href="#h10-1-71" id="h10-1-71" class="d">-        self.setup(client)?;
</a><a href="#h10-1-72" id="h10-1-72" class="d">-        self.check(client)?;
</a><a href="#h10-1-73" id="h10-1-73" class="i">+        let mut rng = rand::thread_rng();
</a><a href="#h10-1-74" id="h10-1-74" class="i">+        let custs = rand::distributions::Uniform::from(1..=self.customers as i64);
</a><a href="#h10-1-75" id="h10-1-75" class="i">+        let transfers = futures::stream::iter(
</a><a href="#h10-1-76" id="h10-1-76" class="i">+            std::iter::from_fn(|| Some((custs.sample(&amp;mut rng), custs.sample(&amp;mut rng))))
</a><a href="#h10-1-77" id="h10-1-77" class="i">+                .filter(|(from, to)| from != to)
</a><a href="#h10-1-78" id="h10-1-78" class="i">+                .map(Ok)
</a><a href="#h10-1-79" id="h10-1-79" class="i">+                .take(transactions as usize),
</a><a href="#h10-1-80" id="h10-1-80" class="i">+        );
</a> 
         let start = std::time::Instant::now();
<a href="#h10-1-83" id="h10-1-83" class="d">-
</a><a href="#h10-1-84" id="h10-1-84" class="d">-        crossbeam::thread::scope(|scope| {
</a><a href="#h10-1-85" id="h10-1-85" class="d">-            let (tx, rx) = crossbeam::channel::unbounded();
</a><a href="#h10-1-86" id="h10-1-86" class="d">-            scope.spawn(move |_| {
</a><a href="#h10-1-87" id="h10-1-87" class="d">-                let dist = rand::distributions::Uniform::from(0..self.customers);
</a><a href="#h10-1-88" id="h10-1-88" class="d">-                let mut rng = rand::thread_rng();
</a><a href="#h10-1-89" id="h10-1-89" class="d">-                for _ in 0..transactions {
</a><a href="#h10-1-90" id="h10-1-90" class="d">-                    let from = dist.sample(&amp;mut rng);
</a><a href="#h10-1-91" id="h10-1-91" class="d">-                    let mut to = dist.sample(&amp;mut rng);
</a><a href="#h10-1-92" id="h10-1-92" class="d">-                    while from == to {
</a><a href="#h10-1-93" id="h10-1-93" class="d">-                        to = dist.sample(&amp;mut rng)
</a><a href="#h10-1-94" id="h10-1-94" class="d">-                    }
</a><a href="#h10-1-95" id="h10-1-95" class="d">-                    tx.send((from, to)).unwrap();
</a><a href="#h10-1-96" id="h10-1-96" class="d">-                }
</a><a href="#h10-1-97" id="h10-1-97" class="d">-                std::mem::drop(tx)
</a><a href="#h10-1-98" id="h10-1-98" class="d">-            });
</a><a href="#h10-1-99" id="h10-1-99" class="d">-
</a><a href="#h10-1-100" id="h10-1-100" class="d">-            println!();
</a><a href="#h10-1-101" id="h10-1-101" class="d">-            for i in 0..concurrency {
</a><a href="#h10-1-102" id="h10-1-102" class="d">-                let r = rx.clone();
</a><a href="#h10-1-103" id="h10-1-103" class="d">-                let (host, port) = hosts.next().unwrap();
</a><a href="#h10-1-104" id="h10-1-104" class="d">-                let mut client = Client::new(host, *port).unwrap();
</a><a href="#h10-1-105" id="h10-1-105" class="d">-                scope.spawn(move |_| self.process(&amp;mut client, i, r).unwrap());
</a><a href="#h10-1-106" id="h10-1-106" class="d">-            }
</a><a href="#h10-1-107" id="h10-1-107" class="d">-        })
</a><a href="#h10-1-108" id="h10-1-108" class="d">-        .unwrap();
</a><a href="#h10-1-109" id="h10-1-109" class="d">-
</a><a href="#h10-1-110" id="h10-1-110" class="i">+        transfers
</a><a href="#h10-1-111" id="h10-1-111" class="i">+            .try_for_each_concurrent(self.clients.size(), |(from, to)| self.transfer(from, to))
</a><a href="#h10-1-112" id="h10-1-112" class="i">+            .await?;
</a>         let elapsed = start.elapsed().as_secs_f64();
<a href="#h10-1-114" id="h10-1-114" class="i">+
</a>         println!();
         println!(
             &quot;Ran {} transactions in {:.3}s ({:.3}/s)&quot;,
<a href="#h10-2" id="h10-2" class="h">@@ -159,164 +130,180 @@ impl Bank {
</a>             transactions as f64 / elapsed
         );
 
<a href="#h10-2-3" id="h10-2-3" class="d">-        self.check(client)?;
</a><a href="#h10-2-4" id="h10-2-4" class="d">-        Ok(())
</a><a href="#h10-2-5" id="h10-2-5" class="d">-    }
</a><a href="#h10-2-6" id="h10-2-6" class="d">-
</a><a href="#h10-2-7" id="h10-2-7" class="d">-    // Processes transactions for a customer
</a><a href="#h10-2-8" id="h10-2-8" class="d">-    fn process(
</a><a href="#h10-2-9" id="h10-2-9" class="d">-        &amp;self,
</a><a href="#h10-2-10" id="h10-2-10" class="d">-        client: &amp;mut Client,
</a><a href="#h10-2-11" id="h10-2-11" class="d">-        tid: i64,
</a><a href="#h10-2-12" id="h10-2-12" class="d">-        rx: crossbeam::channel::Receiver&lt;(i64, i64)&gt;,
</a><a href="#h10-2-13" id="h10-2-13" class="d">-    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-14" id="h10-2-14" class="d">-        let mut rng = rand::thread_rng();
</a><a href="#h10-2-15" id="h10-2-15" class="d">-        for (from, to) in rx {
</a><a href="#h10-2-16" id="h10-2-16" class="d">-            let mut amount = 0;
</a><a href="#h10-2-17" id="h10-2-17" class="d">-            let mut from_account = 0;
</a><a href="#h10-2-18" id="h10-2-18" class="d">-            let mut to_account = 0;
</a><a href="#h10-2-19" id="h10-2-19" class="d">-            let mut attempts = 0;
</a><a href="#h10-2-20" id="h10-2-20" class="d">-            let start = std::time::Instant::now();
</a><a href="#h10-2-21" id="h10-2-21" class="d">-
</a><a href="#h10-2-22" id="h10-2-22" class="d">-            let result = client.with_txn(|t| {
</a><a href="#h10-2-23" id="h10-2-23" class="d">-                attempts += 1;
</a><a href="#h10-2-24" id="h10-2-24" class="d">-                let f = get_integers(t.query(&amp;format!(
</a><a href="#h10-2-25" id="h10-2-25" class="d">-                    &quot;SELECT a.id, a.balance
</a><a href="#h10-2-26" id="h10-2-26" class="d">-                    FROM account a JOIN customer c ON a.customer_id = c.id
</a><a href="#h10-2-27" id="h10-2-27" class="d">-                    WHERE c.id = {}
</a><a href="#h10-2-28" id="h10-2-28" class="d">-                    ORDER BY a.balance DESC
</a><a href="#h10-2-29" id="h10-2-29" class="d">-                    LIMIT 1&quot;,
</a><a href="#h10-2-30" id="h10-2-30" class="d">-                    from
</a><a href="#h10-2-31" id="h10-2-31" class="d">-                ))?)?;
</a><a href="#h10-2-32" id="h10-2-32" class="d">-                from_account = f[0];
</a><a href="#h10-2-33" id="h10-2-33" class="d">-                let from_balance = f[1];
</a><a href="#h10-2-34" id="h10-2-34" class="d">-                to_account = get_integers(t.query(&amp;format!(
</a><a href="#h10-2-35" id="h10-2-35" class="d">-                    &quot;SELECT a.id, a.balance
</a><a href="#h10-2-36" id="h10-2-36" class="d">-                    FROM account a JOIN customer c ON a.customer_id = c.id
</a><a href="#h10-2-37" id="h10-2-37" class="d">-                    WHERE c.id = {}
</a><a href="#h10-2-38" id="h10-2-38" class="d">-                    ORDER BY a.balance ASC
</a><a href="#h10-2-39" id="h10-2-39" class="d">-                    LIMIT 1&quot;,
</a><a href="#h10-2-40" id="h10-2-40" class="d">-                    to
</a><a href="#h10-2-41" id="h10-2-41" class="d">-                ))?)?[0];
</a><a href="#h10-2-42" id="h10-2-42" class="d">-
</a><a href="#h10-2-43" id="h10-2-43" class="d">-                amount = rng.gen_range(0, from_balance);
</a><a href="#h10-2-44" id="h10-2-44" class="d">-
</a><a href="#h10-2-45" id="h10-2-45" class="d">-                t.query(&amp;format!(
</a><a href="#h10-2-46" id="h10-2-46" class="d">-                    &quot;UPDATE account SET balance = balance - {} WHERE id = {}&quot;,
</a><a href="#h10-2-47" id="h10-2-47" class="d">-                    amount, from_account,
</a><a href="#h10-2-48" id="h10-2-48" class="d">-                ))?;
</a><a href="#h10-2-49" id="h10-2-49" class="d">-                t.query(&amp;format!(
</a><a href="#h10-2-50" id="h10-2-50" class="d">-                    &quot;UPDATE account SET balance = balance + {} WHERE id = {}&quot;,
</a><a href="#h10-2-51" id="h10-2-51" class="d">-                    amount, to_account,
</a><a href="#h10-2-52" id="h10-2-52" class="d">-                ))?;
</a><a href="#h10-2-53" id="h10-2-53" class="d">-                Ok(())
</a><a href="#h10-2-54" id="h10-2-54" class="d">-            });
</a><a href="#h10-2-55" id="h10-2-55" class="d">-            match result {
</a><a href="#h10-2-56" id="h10-2-56" class="d">-                Err(Error::Serialization) =&gt; println!(
</a><a href="#h10-2-57" id="h10-2-57" class="d">-                    &quot;Thread {} serialization failure for {} to {}, giving up after {:.3}s ({} attempts)&quot;,
</a><a href="#h10-2-58" id="h10-2-58" class="d">-                    tid,
</a><a href="#h10-2-59" id="h10-2-59" class="d">-                    from,
</a><a href="#h10-2-60" id="h10-2-60" class="d">-                    to,
</a><a href="#h10-2-61" id="h10-2-61" class="d">-                    start.elapsed().as_secs_f64(),
</a><a href="#h10-2-62" id="h10-2-62" class="d">-                    attempts
</a><a href="#h10-2-63" id="h10-2-63" class="d">-                ),
</a><a href="#h10-2-64" id="h10-2-64" class="d">-                Ok(_) =&gt; println!(
</a><a href="#h10-2-65" id="h10-2-65" class="d">-                    &quot;Thread {} transferred {: &gt;4} from {: &gt;3} ({:0&gt;4}) to {: &gt;3} ({:0&gt;4}) in {:.3}s ({} attempts)&quot;,
</a><a href="#h10-2-66" id="h10-2-66" class="d">-                    tid,
</a><a href="#h10-2-67" id="h10-2-67" class="d">-                    amount,
</a><a href="#h10-2-68" id="h10-2-68" class="d">-                    from,
</a><a href="#h10-2-69" id="h10-2-69" class="d">-                    from_account,
</a><a href="#h10-2-70" id="h10-2-70" class="d">-                    to,
</a><a href="#h10-2-71" id="h10-2-71" class="d">-                    to_account,
</a><a href="#h10-2-72" id="h10-2-72" class="d">-                    start.elapsed().as_secs_f64(),
</a><a href="#h10-2-73" id="h10-2-73" class="d">-                    attempts
</a><a href="#h10-2-74" id="h10-2-74" class="d">-                ),
</a><a href="#h10-2-75" id="h10-2-75" class="d">-                Err(err) =&gt; return Err(err),
</a><a href="#h10-2-76" id="h10-2-76" class="d">-            }
</a><a href="#h10-2-77" id="h10-2-77" class="d">-        }
</a><a href="#h10-2-78" id="h10-2-78" class="i">+        self.verify().await?;
</a>         Ok(())
     }
 
     // Sets up the database
<a href="#h10-2-83" id="h10-2-83" class="d">-    fn setup(&amp;self, client: &amp;mut Client) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-84" id="h10-2-84" class="d">-        let mut namegen = names::Generator::default(names::Name::Plain);
</a><a href="#h10-2-85" id="h10-2-85" class="d">-        let now = std::time::Instant::now();
</a><a href="#h10-2-86" id="h10-2-86" class="d">-
</a><a href="#h10-2-87" id="h10-2-87" class="d">-        client.query(&quot;BEGIN&quot;)?;
</a><a href="#h10-2-88" id="h10-2-88" class="d">-        client.query(
</a><a href="#h10-2-89" id="h10-2-89" class="d">-            &quot;CREATE TABLE customer (
</a><a href="#h10-2-90" id="h10-2-90" class="d">-                id INTEGER PRIMARY KEY,
</a><a href="#h10-2-91" id="h10-2-91" class="d">-                name STRING NOT NULL
</a><a href="#h10-2-92" id="h10-2-92" class="d">-            )&quot;,
</a><a href="#h10-2-93" id="h10-2-93" class="d">-        )?;
</a><a href="#h10-2-94" id="h10-2-94" class="d">-        client.query(
</a><a href="#h10-2-95" id="h10-2-95" class="d">-            &quot;CREATE TABLE account (
</a><a href="#h10-2-96" id="h10-2-96" class="d">-                id INTEGER PRIMARY KEY,
</a><a href="#h10-2-97" id="h10-2-97" class="d">-                customer_id INTEGER NOT NULL INDEX REFERENCES customer,
</a><a href="#h10-2-98" id="h10-2-98" class="d">-                balance INTEGER NOT NULL
</a><a href="#h10-2-99" id="h10-2-99" class="d">-           )&quot;,
</a><a href="#h10-2-100" id="h10-2-100" class="d">-        )?;
</a><a href="#h10-2-101" id="h10-2-101" class="d">-
</a><a href="#h10-2-102" id="h10-2-102" class="d">-        for i in 0..self.customers {
</a><a href="#h10-2-103" id="h10-2-103" class="d">-            client.query(&amp;format!(
</a><a href="#h10-2-104" id="h10-2-104" class="d">-                &quot;INSERT INTO customer VALUES ({}, &#39;{}&#39;)&quot;,
</a><a href="#h10-2-105" id="h10-2-105" class="d">-                i,
</a><a href="#h10-2-106" id="h10-2-106" class="d">-                namegen.next().unwrap()
</a><a href="#h10-2-107" id="h10-2-107" class="d">-            ))?;
</a><a href="#h10-2-108" id="h10-2-108" class="d">-            client.query(&amp;format!(
</a><a href="#h10-2-109" id="h10-2-109" class="i">+    async fn setup(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-110" id="h10-2-110" class="i">+        let (_, client) = self.clients.get().await;
</a><a href="#h10-2-111" id="h10-2-111" class="i">+        let start = std::time::Instant::now();
</a><a href="#h10-2-112" id="h10-2-112" class="i">+        client.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h10-2-113" id="h10-2-113" class="i">+        client
</a><a href="#h10-2-114" id="h10-2-114" class="i">+            .execute(
</a><a href="#h10-2-115" id="h10-2-115" class="i">+                &quot;CREATE TABLE customer (
</a><a href="#h10-2-116" id="h10-2-116" class="i">+                    id INTEGER PRIMARY KEY,
</a><a href="#h10-2-117" id="h10-2-117" class="i">+                    name STRING NOT NULL
</a><a href="#h10-2-118" id="h10-2-118" class="i">+                )&quot;,
</a><a href="#h10-2-119" id="h10-2-119" class="i">+            )
</a><a href="#h10-2-120" id="h10-2-120" class="i">+            .await?;
</a><a href="#h10-2-121" id="h10-2-121" class="i">+        client
</a><a href="#h10-2-122" id="h10-2-122" class="i">+            .execute(
</a><a href="#h10-2-123" id="h10-2-123" class="i">+                &quot;CREATE TABLE account (
</a><a href="#h10-2-124" id="h10-2-124" class="i">+                    id INTEGER PRIMARY KEY,
</a><a href="#h10-2-125" id="h10-2-125" class="i">+                    customer_id INTEGER NOT NULL INDEX REFERENCES customer,
</a><a href="#h10-2-126" id="h10-2-126" class="i">+                    balance INTEGER NOT NULL
</a><a href="#h10-2-127" id="h10-2-127" class="i">+                )&quot;,
</a><a href="#h10-2-128" id="h10-2-128" class="i">+            )
</a><a href="#h10-2-129" id="h10-2-129" class="i">+            .await?;
</a><a href="#h10-2-130" id="h10-2-130" class="i">+        client
</a><a href="#h10-2-131" id="h10-2-131" class="i">+            .execute(&amp;format!(
</a><a href="#h10-2-132" id="h10-2-132" class="i">+                &quot;INSERT INTO customer VALUES {}&quot;,
</a><a href="#h10-2-133" id="h10-2-133" class="i">+                (1..=self.customers)
</a><a href="#h10-2-134" id="h10-2-134" class="i">+                    .zip(names::Generator::default(names::Name::Plain))
</a><a href="#h10-2-135" id="h10-2-135" class="i">+                    .map(|(id, name)| format!(&quot;({}, &#39;{}&#39;)&quot;, id, name))
</a><a href="#h10-2-136" id="h10-2-136" class="i">+                    .collect::&lt;Vec&lt;String&gt;&gt;()
</a><a href="#h10-2-137" id="h10-2-137" class="i">+                    .join(&quot;, &quot;)
</a><a href="#h10-2-138" id="h10-2-138" class="i">+            ))
</a><a href="#h10-2-139" id="h10-2-139" class="i">+            .await?;
</a><a href="#h10-2-140" id="h10-2-140" class="i">+        client
</a><a href="#h10-2-141" id="h10-2-141" class="i">+            .execute(&amp;format!(
</a>                 &quot;INSERT INTO account VALUES {}&quot;,
<a href="#h10-2-143" id="h10-2-143" class="d">-                (0..self.customer_accounts)
</a><a href="#h10-2-144" id="h10-2-144" class="d">-                    .map(|j| i * self.customer_accounts + j)
</a><a href="#h10-2-145" id="h10-2-145" class="d">-                    .map(|id| (format!(&quot;({}, {}, {})&quot;, id, i, self.initial_balance)))
</a><a href="#h10-2-146" id="h10-2-146" class="i">+                (1..=self.customers)
</a><a href="#h10-2-147" id="h10-2-147" class="i">+                    .flat_map(|c| (1..=self.customer_accounts).map(move |a| (c, a)))
</a><a href="#h10-2-148" id="h10-2-148" class="i">+                    .map(|(c, a)| (c, (c - 1) * self.customer_accounts + a))
</a><a href="#h10-2-149" id="h10-2-149" class="i">+                    .map(|(c, a)| (format!(&quot;({}, {}, {})&quot;, a, c, Self::INITIAL_BALANCE)))
</a>                     .collect::&lt;Vec&lt;String&gt;&gt;()
                     .join(&quot;, &quot;)
<a href="#h10-2-152" id="h10-2-152" class="d">-            ))?;
</a><a href="#h10-2-153" id="h10-2-153" class="d">-        }
</a><a href="#h10-2-154" id="h10-2-154" class="d">-        client.query(&quot;COMMIT&quot;)?;
</a><a href="#h10-2-155" id="h10-2-155" class="i">+            ))
</a><a href="#h10-2-156" id="h10-2-156" class="i">+            .await?;
</a><a href="#h10-2-157" id="h10-2-157" class="i">+        client.execute(&quot;COMMIT&quot;).await?;
</a> 
         println!(
             &quot;Created {} customers ({} accounts) in {:.3}s&quot;,
             self.customers,
             self.customers * self.customer_accounts,
<a href="#h10-2-163" id="h10-2-163" class="d">-            now.elapsed().as_secs_f64()
</a><a href="#h10-2-164" id="h10-2-164" class="i">+            start.elapsed().as_secs_f64()
</a>         );
         Ok(())
     }
 
<a href="#h10-2-169" id="h10-2-169" class="d">-    /// Checks that all invariants hold
</a><a href="#h10-2-170" id="h10-2-170" class="d">-    fn check(&amp;self, client: &amp;mut Client) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-171" id="h10-2-171" class="d">-        let expect_balance = self.customers * self.customer_accounts * self.initial_balance;
</a><a href="#h10-2-172" id="h10-2-172" class="d">-        let balance = get_integers(client.query(&quot;SELECT SUM(balance) FROM account&quot;)?)?[0];
</a><a href="#h10-2-173" id="h10-2-173" class="d">-        if balance != expect_balance {
</a><a href="#h10-2-174" id="h10-2-174" class="i">+    /// Verifies that all invariants hold
</a><a href="#h10-2-175" id="h10-2-175" class="i">+    async fn verify(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-176" id="h10-2-176" class="i">+        let (_, client) = self.clients.get().await;
</a><a href="#h10-2-177" id="h10-2-177" class="i">+        let expect = self.customers * self.customer_accounts * Self::INITIAL_BALANCE as i64;
</a><a href="#h10-2-178" id="h10-2-178" class="i">+        let balance =
</a><a href="#h10-2-179" id="h10-2-179" class="i">+            client.execute(&quot;SELECT SUM(balance) FROM account&quot;).await?.into_value()?.integer()?;
</a><a href="#h10-2-180" id="h10-2-180" class="i">+        if balance != expect {
</a>             return Err(Error::Value(format!(
<a href="#h10-2-182" id="h10-2-182" class="d">-                &quot;Invariant violation: expected total balance {}, found {}&quot;,
</a><a href="#h10-2-183" id="h10-2-183" class="d">-                expect_balance, balance
</a><a href="#h10-2-184" id="h10-2-184" class="i">+                &quot;Expected total balance {}, found {}&quot;,
</a><a href="#h10-2-185" id="h10-2-185" class="i">+                expect, balance
</a>             )));
         }
<a href="#h10-2-188" id="h10-2-188" class="d">-        let neg = get_integers(client.query(&quot;SELECT COUNT(*) FROM account WHERE balance &lt; 0&quot;)?)?[0];
</a><a href="#h10-2-189" id="h10-2-189" class="d">-        if neg &gt; 0 {
</a><a href="#h10-2-190" id="h10-2-190" class="d">-            return Err(Error::Value(format!(
</a><a href="#h10-2-191" id="h10-2-191" class="d">-                &quot;Invariant violation: expected 0 accounts with negative balance, got {}&quot;,
</a><a href="#h10-2-192" id="h10-2-192" class="d">-                neg
</a><a href="#h10-2-193" id="h10-2-193" class="d">-            )));
</a><a href="#h10-2-194" id="h10-2-194" class="i">+        let negative = client
</a><a href="#h10-2-195" id="h10-2-195" class="i">+            .execute(&quot;SELECT COUNT(*) FROM account WHERE balance &lt; 0&quot;)
</a><a href="#h10-2-196" id="h10-2-196" class="i">+            .await?
</a><a href="#h10-2-197" id="h10-2-197" class="i">+            .into_value()?
</a><a href="#h10-2-198" id="h10-2-198" class="i">+            .integer()?;
</a><a href="#h10-2-199" id="h10-2-199" class="i">+        if negative &gt; 0 {
</a><a href="#h10-2-200" id="h10-2-200" class="i">+            return Err(Error::Value(format!(&quot;Found {} accounts with negative balance&quot;, negative)));
</a>         }
<a href="#h10-2-202" id="h10-2-202" class="d">-        println!(&quot;Checked that total balance is {} with no negative balances&quot;, balance);
</a><a href="#h10-2-203" id="h10-2-203" class="i">+        println!(&quot;Verified that total balance is {} with no negative balances&quot;, balance);
</a>         Ok(())
     }
<a href="#h10-2-206" id="h10-2-206" class="d">-}
</a> 
<a href="#h10-2-208" id="h10-2-208" class="d">-// FIXME This should be a row or result method
</a><a href="#h10-2-209" id="h10-2-209" class="d">-fn get_integers(result: ResultSet) -&gt; Result&lt;Vec&lt;i64&gt;, Error&gt; {
</a><a href="#h10-2-210" id="h10-2-210" class="d">-    if let ResultSet::Query { mut relation } = result {
</a><a href="#h10-2-211" id="h10-2-211" class="d">-        if let Some(row) = relation.next().transpose()? {
</a><a href="#h10-2-212" id="h10-2-212" class="d">-            return row
</a><a href="#h10-2-213" id="h10-2-213" class="d">-                .into_iter()
</a><a href="#h10-2-214" id="h10-2-214" class="d">-                .map(|f| match f {
</a><a href="#h10-2-215" id="h10-2-215" class="d">-                    Value::Integer(i) =&gt; Ok(i),
</a><a href="#h10-2-216" id="h10-2-216" class="d">-                    _ =&gt; Err(Error::Internal(&quot;no value received&quot;.into())),
</a><a href="#h10-2-217" id="h10-2-217" class="d">-                })
</a><a href="#h10-2-218" id="h10-2-218" class="d">-                .collect();
</a><a href="#h10-2-219" id="h10-2-219" class="i">+    /// Transfers a random amount between two customers, retrying serialization failures
</a><a href="#h10-2-220" id="h10-2-220" class="i">+    /// FIXME The serialization rety with exponential backoff should be a helper on Client
</a><a href="#h10-2-221" id="h10-2-221" class="i">+    async fn transfer(&amp;self, from: i64, to: i64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h10-2-222" id="h10-2-222" class="i">+        let (client_id, client) = self.clients.get().await;
</a><a href="#h10-2-223" id="h10-2-223" class="i">+        let mut attempts = 0;
</a><a href="#h10-2-224" id="h10-2-224" class="i">+        let start = std::time::Instant::now();
</a><a href="#h10-2-225" id="h10-2-225" class="i">+
</a><a href="#h10-2-226" id="h10-2-226" class="i">+        for i in 0..Self::TXN_RETRIES {
</a><a href="#h10-2-227" id="h10-2-227" class="i">+            attempts += 1;
</a><a href="#h10-2-228" id="h10-2-228" class="i">+            if i &gt; 0 {
</a><a href="#h10-2-229" id="h10-2-229" class="i">+                tokio::time::delay_for(std::time::Duration::from_millis(
</a><a href="#h10-2-230" id="h10-2-230" class="i">+                    2_u64.pow(i as u32 - 1) * rand::thread_rng().gen_range(75, 125),
</a><a href="#h10-2-231" id="h10-2-231" class="i">+                ))
</a><a href="#h10-2-232" id="h10-2-232" class="i">+                .await;
</a><a href="#h10-2-233" id="h10-2-233" class="i">+            }
</a><a href="#h10-2-234" id="h10-2-234" class="i">+            let result = async {
</a><a href="#h10-2-235" id="h10-2-235" class="i">+                client.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h10-2-236" id="h10-2-236" class="i">+                let result = self.try_transfer(&amp;client, from, to).await?;
</a><a href="#h10-2-237" id="h10-2-237" class="i">+                client.execute(&quot;COMMIT&quot;).await?;
</a><a href="#h10-2-238" id="h10-2-238" class="i">+                Ok(result)
</a><a href="#h10-2-239" id="h10-2-239" class="i">+            }
</a><a href="#h10-2-240" id="h10-2-240" class="i">+            .await;
</a><a href="#h10-2-241" id="h10-2-241" class="i">+            if result.is_err() {
</a><a href="#h10-2-242" id="h10-2-242" class="i">+                client.execute(&quot;ROLLBACK&quot;).await?;
</a><a href="#h10-2-243" id="h10-2-243" class="i">+                if let Err(Error::Serialization) = result {
</a><a href="#h10-2-244" id="h10-2-244" class="i">+                    continue;
</a><a href="#h10-2-245" id="h10-2-245" class="i">+                }
</a><a href="#h10-2-246" id="h10-2-246" class="i">+            }
</a><a href="#h10-2-247" id="h10-2-247" class="i">+            let (from_account, to_account, amount) = result?;
</a><a href="#h10-2-248" id="h10-2-248" class="i">+            println!(
</a><a href="#h10-2-249" id="h10-2-249" class="i">+                &quot;Thread {} transferred {: &gt;4} from {: &gt;3} ({:0&gt;4}) to {: &gt;3} ({:0&gt;4}) in {:.3}s ({} attempts)&quot;,
</a><a href="#h10-2-250" id="h10-2-250" class="i">+                client_id,
</a><a href="#h10-2-251" id="h10-2-251" class="i">+                amount,
</a><a href="#h10-2-252" id="h10-2-252" class="i">+                from,
</a><a href="#h10-2-253" id="h10-2-253" class="i">+                from_account,
</a><a href="#h10-2-254" id="h10-2-254" class="i">+                to,
</a><a href="#h10-2-255" id="h10-2-255" class="i">+                to_account,
</a><a href="#h10-2-256" id="h10-2-256" class="i">+                start.elapsed().as_secs_f64(),
</a><a href="#h10-2-257" id="h10-2-257" class="i">+                attempts
</a><a href="#h10-2-258" id="h10-2-258" class="i">+            );
</a><a href="#h10-2-259" id="h10-2-259" class="i">+            return Ok(());
</a>         }
<a href="#h10-2-261" id="h10-2-261" class="i">+        Err(Error::Serialization)
</a><a href="#h10-2-262" id="h10-2-262" class="i">+    }
</a><a href="#h10-2-263" id="h10-2-263" class="i">+
</a><a href="#h10-2-264" id="h10-2-264" class="i">+    /// Attempts to transfer a random amount
</a><a href="#h10-2-265" id="h10-2-265" class="i">+    async fn try_transfer(
</a><a href="#h10-2-266" id="h10-2-266" class="i">+        &amp;self,
</a><a href="#h10-2-267" id="h10-2-267" class="i">+        client: &amp;MutexGuard&lt;&#39;_, Client&gt;,
</a><a href="#h10-2-268" id="h10-2-268" class="i">+        from: i64,
</a><a href="#h10-2-269" id="h10-2-269" class="i">+        to: i64,
</a><a href="#h10-2-270" id="h10-2-270" class="i">+    ) -&gt; Result&lt;(i64, i64, i64), Error&gt; {
</a><a href="#h10-2-271" id="h10-2-271" class="i">+        let mut row = client
</a><a href="#h10-2-272" id="h10-2-272" class="i">+            .execute(&amp;format!(
</a><a href="#h10-2-273" id="h10-2-273" class="i">+                &quot;SELECT a.id, a.balance
</a><a href="#h10-2-274" id="h10-2-274" class="i">+                 FROM account a JOIN customer c ON a.customer_id = c.id
</a><a href="#h10-2-275" id="h10-2-275" class="i">+                 WHERE c.id = {}
</a><a href="#h10-2-276" id="h10-2-276" class="i">+                 ORDER BY a.balance DESC
</a><a href="#h10-2-277" id="h10-2-277" class="i">+                 LIMIT 1&quot;,
</a><a href="#h10-2-278" id="h10-2-278" class="i">+                from
</a><a href="#h10-2-279" id="h10-2-279" class="i">+            ))
</a><a href="#h10-2-280" id="h10-2-280" class="i">+            .await?
</a><a href="#h10-2-281" id="h10-2-281" class="i">+            .into_row()?;
</a><a href="#h10-2-282" id="h10-2-282" class="i">+        let from_account = row.remove(0).integer()?;
</a><a href="#h10-2-283" id="h10-2-283" class="i">+        let from_balance = row.remove(0).integer()?;
</a><a href="#h10-2-284" id="h10-2-284" class="i">+
</a><a href="#h10-2-285" id="h10-2-285" class="i">+        let to_account = client
</a><a href="#h10-2-286" id="h10-2-286" class="i">+            .execute(&amp;format!(
</a><a href="#h10-2-287" id="h10-2-287" class="i">+                &quot;SELECT a.id, a.balance
</a><a href="#h10-2-288" id="h10-2-288" class="i">+                 FROM account a JOIN customer c ON a.customer_id = c.id
</a><a href="#h10-2-289" id="h10-2-289" class="i">+                 WHERE c.id = {}
</a><a href="#h10-2-290" id="h10-2-290" class="i">+                 ORDER BY a.balance ASC
</a><a href="#h10-2-291" id="h10-2-291" class="i">+                 LIMIT 1&quot;,
</a><a href="#h10-2-292" id="h10-2-292" class="i">+                to
</a><a href="#h10-2-293" id="h10-2-293" class="i">+            ))
</a><a href="#h10-2-294" id="h10-2-294" class="i">+            .await?
</a><a href="#h10-2-295" id="h10-2-295" class="i">+            .into_value()?
</a><a href="#h10-2-296" id="h10-2-296" class="i">+            .integer()?;
</a><a href="#h10-2-297" id="h10-2-297" class="i">+
</a><a href="#h10-2-298" id="h10-2-298" class="i">+        let amount = rand::thread_rng().gen_range(0, from_balance);
</a><a href="#h10-2-299" id="h10-2-299" class="i">+        client
</a><a href="#h10-2-300" id="h10-2-300" class="i">+            .execute(&amp;format!(
</a><a href="#h10-2-301" id="h10-2-301" class="i">+                &quot;UPDATE account SET balance = balance - {} WHERE id = {}&quot;,
</a><a href="#h10-2-302" id="h10-2-302" class="i">+                amount, from_account,
</a><a href="#h10-2-303" id="h10-2-303" class="i">+            ))
</a><a href="#h10-2-304" id="h10-2-304" class="i">+            .await?;
</a><a href="#h10-2-305" id="h10-2-305" class="i">+        client
</a><a href="#h10-2-306" id="h10-2-306" class="i">+            .execute(&amp;format!(
</a><a href="#h10-2-307" id="h10-2-307" class="i">+                &quot;UPDATE account SET balance = balance + {} WHERE id = {}&quot;,
</a><a href="#h10-2-308" id="h10-2-308" class="i">+                amount, to_account,
</a><a href="#h10-2-309" id="h10-2-309" class="i">+            ))
</a><a href="#h10-2-310" id="h10-2-310" class="i">+            .await?;
</a><a href="#h10-2-311" id="h10-2-311" class="i">+        Ok((from_account, to_account, amount))
</a>     }
<a href="#h10-2-313" id="h10-2-313" class="d">-    Err(Error::Internal(&quot;no row received&quot;.into()))
</a> }
<b>diff --git a/<a id="h11" href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a> b/<a href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -11,7 +11,8 @@ extern crate toydb;
</a> 
 use std::collections::HashMap;
 
<a href="#h11-0-3" id="h11-0-3" class="d">-fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a><a href="#h11-0-4" id="h11-0-4" class="i">+#[tokio::main]
</a><a href="#h11-0-5" id="h11-0-5" class="i">+async fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a>     let opts = app_from_crate!()
         .arg(
             clap::Arg::with_name(&quot;config&quot;)
<a href="#h11-1" id="h11-1" class="h">@@ -31,15 +32,15 @@ fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a>     }
     simplelog::SimpleLogger::init(loglevel, logconfig.build())?;
 
<a href="#h11-1-3" id="h11-1-3" class="d">-    let mut server = toydb::Server::new(&amp;cfg.id, cfg.parse_peers()?, &amp;cfg.data_dir)?;
</a><a href="#h11-1-4" id="h11-1-4" class="d">-    server.listen(&amp;cfg.listen, 8)?;
</a><a href="#h11-1-5" id="h11-1-5" class="d">-    server.join()
</a><a href="#h11-1-6" id="h11-1-6" class="i">+    let server = toydb::Server::new(&amp;cfg.id, cfg.parse_peers()?, &amp;cfg.data_dir)?;
</a><a href="#h11-1-7" id="h11-1-7" class="i">+    server.listen(cfg.listen_sql, cfg.listen_raft).await
</a> }
 
 #[derive(Debug, Deserialize)]
 struct Config {
     id: String,
<a href="#h11-1-13" id="h11-1-13" class="d">-    listen: String,
</a><a href="#h11-1-14" id="h11-1-14" class="i">+    listen_sql: String,
</a><a href="#h11-1-15" id="h11-1-15" class="i">+    listen_raft: String,
</a>     log_level: String,
     data_dir: String,
     peers: HashMap&lt;String, String&gt;,
<a href="#h11-2" id="h11-2" class="h">@@ -49,7 +50,8 @@ impl Config {
</a>     fn new(file: &amp;str) -&gt; Result&lt;Self, config::ConfigError&gt; {
         let mut c = config::Config::new();
         c.set_default(&quot;id&quot;, &quot;toydb&quot;)?;
<a href="#h11-2-3" id="h11-2-3" class="d">-        c.set_default(&quot;listen&quot;, &quot;0.0.0.0:9605&quot;)?;
</a><a href="#h11-2-4" id="h11-2-4" class="i">+        c.set_default(&quot;listen_sql&quot;, &quot;0.0.0.0:9605&quot;)?;
</a><a href="#h11-2-5" id="h11-2-5" class="i">+        c.set_default(&quot;listen_raft&quot;, &quot;0.0.0.0:9705&quot;)?;
</a>         c.set_default(&quot;log_level&quot;, &quot;info&quot;)?;
         c.set_default(&quot;data_dir&quot;, &quot;/var/lib/toydb&quot;)?;
 
<a href="#h11-3" id="h11-3" class="h">@@ -67,7 +69,7 @@ impl Config {
</a>                     sa
                 } else {
                     let ip = address.parse::&lt;std::net::IpAddr&gt;()?;
<a href="#h11-3-3" id="h11-3-3" class="d">-                    std::net::SocketAddr::new(ip, 9605)
</a><a href="#h11-3-4" id="h11-3-4" class="i">+                    std::net::SocketAddr::new(ip, 9705)
</a>                 },
             );
         }
<b>diff --git a/<a id="h12" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -5,17 +5,15 @@
</a> 
 #![warn(clippy::all)]
 
<a href="#h12-0-3" id="h12-0-3" class="d">-#[macro_use]
</a><a href="#h12-0-4" id="h12-0-4" class="d">-extern crate clap;
</a><a href="#h12-0-5" id="h12-0-5" class="d">-extern crate rustyline;
</a><a href="#h12-0-6" id="h12-0-6" class="d">-extern crate toydb;
</a><a href="#h12-0-7" id="h12-0-7" class="d">-
</a><a href="#h12-0-8" id="h12-0-8" class="d">-use rustyline::error::ReadlineError;
</a><a href="#h12-0-9" id="h12-0-9" class="i">+use clap::{app_from_crate, crate_authors, crate_description, crate_name, crate_version};
</a><a href="#h12-0-10" id="h12-0-10" class="i">+use rustyline::{error::ReadlineError, Editor};
</a> use toydb::sql::engine::Mode;
 use toydb::sql::execution::ResultSet;
<a href="#h12-0-13" id="h12-0-13" class="i">+use toydb::Client;
</a> use toydb::Error;
 
<a href="#h12-0-16" id="h12-0-16" class="d">-fn main() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-0-17" id="h12-0-17" class="i">+#[tokio::main]
</a><a href="#h12-0-18" id="h12-0-18" class="i">+async fn main() -&gt; Result&lt;(), Error&gt; {
</a>     let opts = app_from_crate!()
         .arg(clap::Arg::with_name(&quot;command&quot;))
         .arg(clap::Arg::with_name(&quot;headers&quot;).short(&quot;H&quot;).long(&quot;headers&quot;).help(&quot;Show column headers&quot;))
<a href="#h12-1" id="h12-1" class="h">@@ -40,54 +38,56 @@ fn main() -&gt; Result&lt;(), Error&gt; {
</a>         .get_matches();
 
     let mut toysql =
<a href="#h12-1-3" id="h12-1-3" class="d">-        ToySQL::new(opts.value_of(&quot;host&quot;).unwrap(), opts.value_of(&quot;port&quot;).unwrap().parse()?)?;
</a><a href="#h12-1-4" id="h12-1-4" class="i">+        ToySQL::new(opts.value_of(&quot;host&quot;).unwrap(), opts.value_of(&quot;port&quot;).unwrap().parse()?)
</a><a href="#h12-1-5" id="h12-1-5" class="i">+            .await?;
</a>     if opts.is_present(&quot;headers&quot;) {
         toysql.show_headers = true
     }
 
     if let Some(command) = opts.value_of(&quot;command&quot;) {
<a href="#h12-1-11" id="h12-1-11" class="d">-        toysql.execute(&amp;command)
</a><a href="#h12-1-12" id="h12-1-12" class="i">+        toysql.execute(&amp;command).await
</a>     } else {
<a href="#h12-1-14" id="h12-1-14" class="d">-        toysql.run()
</a><a href="#h12-1-15" id="h12-1-15" class="i">+        toysql.run().await
</a>     }
 }
 
 /// The ToySQL REPL
 struct ToySQL {
<a href="#h12-1-21" id="h12-1-21" class="d">-    client: toydb::Client,
</a><a href="#h12-1-22" id="h12-1-22" class="d">-    editor: rustyline::Editor&lt;()&gt;,
</a><a href="#h12-1-23" id="h12-1-23" class="i">+    client: Client,
</a><a href="#h12-1-24" id="h12-1-24" class="i">+    editor: Editor&lt;()&gt;,
</a>     history_path: Option&lt;std::path::PathBuf&gt;,
     show_headers: bool,
<a href="#h12-1-27" id="h12-1-27" class="i">+    txn: Option&lt;(u64, Mode)&gt;,
</a> }
 
 impl ToySQL {
     /// Creates a new ToySQL REPL for the given server host and port
<a href="#h12-1-32" id="h12-1-32" class="d">-    fn new(host: &amp;str, port: u16) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h12-1-33" id="h12-1-33" class="i">+    async fn new(host: &amp;str, port: u16) -&gt; Result&lt;Self, Error&gt; {
</a>         Ok(Self {
<a href="#h12-1-35" id="h12-1-35" class="d">-            client: toydb::Client::new(host, port)?,
</a><a href="#h12-1-36" id="h12-1-36" class="d">-            editor: rustyline::Editor::&lt;()&gt;::new(),
</a><a href="#h12-1-37" id="h12-1-37" class="i">+            client: Client::new((host, port)).await?,
</a><a href="#h12-1-38" id="h12-1-38" class="i">+            editor: Editor::&lt;()&gt;::new(),
</a>             history_path: std::env::var_os(&quot;HOME&quot;)
                 .map(|home| std::path::Path::new(&amp;home).join(&quot;.toysql.history&quot;)),
             show_headers: false,
<a href="#h12-1-42" id="h12-1-42" class="i">+            txn: None,
</a>         })
     }
 
     /// Executes a line of input
<a href="#h12-1-47" id="h12-1-47" class="d">-    fn execute(&amp;mut self, input: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-1-48" id="h12-1-48" class="i">+    async fn execute(&amp;mut self, input: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a>         if input.starts_with(&#39;!&#39;) {
<a href="#h12-1-50" id="h12-1-50" class="d">-            self.execute_command(&amp;input)
</a><a href="#h12-1-51" id="h12-1-51" class="i">+            self.execute_command(&amp;input).await
</a>         } else if !input.is_empty() {
<a href="#h12-1-53" id="h12-1-53" class="d">-            self.execute_query(&amp;input)
</a><a href="#h12-1-54" id="h12-1-54" class="i">+            self.execute_query(&amp;input).await
</a>         } else {
             Ok(())
         }
     }
 
     /// Handles a REPL command (prefixed by !, e.g. !help)
<a href="#h12-1-61" id="h12-1-61" class="d">-    fn execute_command(&amp;mut self, input: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-1-62" id="h12-1-62" class="i">+    async fn execute_command(&amp;mut self, input: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a>         let mut input = input.split_ascii_whitespace();
<a href="#h12-1-64" id="h12-1-64" class="d">-        let command =
</a><a href="#h12-1-65" id="h12-1-65" class="d">-            input.next().ok_or_else(|| toydb::Error::Parse(&quot;Expected command.&quot;.to_string()))?;
</a><a href="#h12-1-66" id="h12-1-66" class="i">+        let command = input.next().ok_or_else(|| Error::Parse(&quot;Expected command.&quot;.to_string()))?;
</a> 
         let getargs = |n| {
             let args: Vec&lt;&amp;str&gt; = input.collect();
<a href="#h12-2" id="h12-2" class="h">@@ -112,22 +112,22 @@ impl ToySQL {
</a>             },
             &quot;!help&quot; =&gt; println!(
                 r#&quot;
<a href="#h12-2-3" id="h12-2-3" class="d">-Enter an SQL statement on a single line to execute it and display the result.
</a><a href="#h12-2-4" id="h12-2-4" class="d">-Semicolons are not supported. The following !-commands are also available:
</a><a href="#h12-2-5" id="h12-2-5" class="d">-
</a><a href="#h12-2-6" id="h12-2-6" class="d">-  !headers &lt;on|off&gt;  Toggles/enables/disables column headers display
</a><a href="#h12-2-7" id="h12-2-7" class="d">-  !help              This help message
</a><a href="#h12-2-8" id="h12-2-8" class="d">-  !table [table]     Display table schema, if it exists
</a><a href="#h12-2-9" id="h12-2-9" class="d">-  !tables            List tables
</a><a href="#h12-2-10" id="h12-2-10" class="d">-&quot;#
</a><a href="#h12-2-11" id="h12-2-11" class="i">+    Enter an SQL statement on a single line to execute it and display the result.
</a><a href="#h12-2-12" id="h12-2-12" class="i">+    Semicolons are not supported. The following !-commands are also available:
</a><a href="#h12-2-13" id="h12-2-13" class="i">+
</a><a href="#h12-2-14" id="h12-2-14" class="i">+      !headers &lt;on|off&gt;  Toggles/enables/disables column headers display
</a><a href="#h12-2-15" id="h12-2-15" class="i">+      !help              This help message
</a><a href="#h12-2-16" id="h12-2-16" class="i">+      !table [table]     Display table schema, if it exists
</a><a href="#h12-2-17" id="h12-2-17" class="i">+      !tables            List tables
</a><a href="#h12-2-18" id="h12-2-18" class="i">+    &quot;#
</a>             ),
             &quot;!table&quot; =&gt; {
                 let args = getargs(1)?;
<a href="#h12-2-22" id="h12-2-22" class="d">-                println!(&quot;{}&quot;, self.client.get_table(args[0])?.as_sql());
</a><a href="#h12-2-23" id="h12-2-23" class="i">+                println!(&quot;{}&quot;, self.client.get_table(args[0]).await?.as_sql());
</a>             }
             &quot;!tables&quot; =&gt; {
                 getargs(0)?;
<a href="#h12-2-27" id="h12-2-27" class="d">-                for table in self.client.list_tables()? {
</a><a href="#h12-2-28" id="h12-2-28" class="i">+                for table in self.client.list_tables().await? {
</a>                     println!(&quot;{}&quot;, table)
                 }
             }
<a href="#h12-3" id="h12-3" class="h">@@ -137,17 +137,27 @@ Semicolons are not supported. The following !-commands are also available:
</a>     }
 
     /// Runs a query and displays the results
<a href="#h12-3-3" id="h12-3-3" class="d">-    fn execute_query(&amp;mut self, query: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-3-4" id="h12-3-4" class="d">-        match self.client.query(query)? {
</a><a href="#h12-3-5" id="h12-3-5" class="d">-            ResultSet::Begin { id, mode: Mode::ReadWrite } =&gt; println!(&quot;Began transaction {}&quot;, id),
</a><a href="#h12-3-6" id="h12-3-6" class="d">-            ResultSet::Begin { id, mode: Mode::ReadOnly } =&gt; {
</a><a href="#h12-3-7" id="h12-3-7" class="d">-                println!(&quot;Began read-only transaction {}&quot;, id)
</a><a href="#h12-3-8" id="h12-3-8" class="i">+    async fn execute_query(&amp;mut self, query: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-3-9" id="h12-3-9" class="i">+        match self.client.execute(query).await? {
</a><a href="#h12-3-10" id="h12-3-10" class="i">+            ResultSet::Begin { id, mode } =&gt; {
</a><a href="#h12-3-11" id="h12-3-11" class="i">+                self.txn = Some((id, mode.clone()));
</a><a href="#h12-3-12" id="h12-3-12" class="i">+                match mode {
</a><a href="#h12-3-13" id="h12-3-13" class="i">+                    Mode::ReadWrite =&gt; println!(&quot;Began transaction {}&quot;, id),
</a><a href="#h12-3-14" id="h12-3-14" class="i">+                    Mode::ReadOnly =&gt; println!(&quot;Began read-only transaction {}&quot;, id),
</a><a href="#h12-3-15" id="h12-3-15" class="i">+                    Mode::Snapshot { version, .. } =&gt; println!(
</a><a href="#h12-3-16" id="h12-3-16" class="i">+                        &quot;Began read-only transaction {} in snapshot at version {}&quot;,
</a><a href="#h12-3-17" id="h12-3-17" class="i">+                        id, version
</a><a href="#h12-3-18" id="h12-3-18" class="i">+                    ),
</a><a href="#h12-3-19" id="h12-3-19" class="i">+                };
</a><a href="#h12-3-20" id="h12-3-20" class="i">+            }
</a><a href="#h12-3-21" id="h12-3-21" class="i">+            ResultSet::Commit { id } =&gt; {
</a><a href="#h12-3-22" id="h12-3-22" class="i">+                self.txn = None;
</a><a href="#h12-3-23" id="h12-3-23" class="i">+                println!(&quot;Committed transaction {}&quot;, id);
</a>             }
<a href="#h12-3-25" id="h12-3-25" class="d">-            ResultSet::Begin { id, mode: Mode::Snapshot { version } } =&gt; {
</a><a href="#h12-3-26" id="h12-3-26" class="d">-                println!(&quot;Began read-only transaction {} in version {} snapshot&quot;, id, version)
</a><a href="#h12-3-27" id="h12-3-27" class="i">+            ResultSet::Rollback { id } =&gt; {
</a><a href="#h12-3-28" id="h12-3-28" class="i">+                self.txn = None;
</a><a href="#h12-3-29" id="h12-3-29" class="i">+                println!(&quot;Rolled back transaction {}&quot;, id);
</a>             }
<a href="#h12-3-31" id="h12-3-31" class="d">-            ResultSet::Commit { id } =&gt; println!(&quot;Committed transaction {}&quot;, id),
</a><a href="#h12-3-32" id="h12-3-32" class="d">-            ResultSet::Rollback { id } =&gt; println!(&quot;Rolled back transaction {}&quot;, id),
</a>             ResultSet::Create { count } =&gt; println!(&quot;Created {} rows&quot;, count),
             ResultSet::Delete { count } =&gt; println!(&quot;Deleted {} rows&quot;, count),
             ResultSet::Update { count } =&gt; println!(&quot;Updated {} rows&quot;, count),
<a href="#h12-4" id="h12-4" class="h">@@ -161,15 +171,16 @@ Semicolons are not supported. The following !-commands are also available:
</a>                         relation
                             .columns
                             .iter()
<a href="#h12-4-3" id="h12-4-3" class="d">-                            .map(|c| c.name.clone().unwrap_or_else(|| &quot;?&quot;.into()))
</a><a href="#h12-4-4" id="h12-4-4" class="i">+                            .map(|c| c.name.as_deref().unwrap_or(&quot;?&quot;))
</a>                             .collect::&lt;Vec&lt;_&gt;&gt;()
                             .join(&quot;|&quot;)
                     );
                 }
                 while let Some(row) = relation.next().transpose()? {
<a href="#h12-4-10" id="h12-4-10" class="d">-                    let formatted: Vec&lt;String&gt; =
</a><a href="#h12-4-11" id="h12-4-11" class="d">-                        row.into_iter().map(|v| format!(&quot;{}&quot;, v)).collect();
</a><a href="#h12-4-12" id="h12-4-12" class="d">-                    println!(&quot;{}&quot;, formatted.join(&quot;|&quot;));
</a><a href="#h12-4-13" id="h12-4-13" class="i">+                    println!(
</a><a href="#h12-4-14" id="h12-4-14" class="i">+                        &quot;{}&quot;,
</a><a href="#h12-4-15" id="h12-4-15" class="i">+                        row.into_iter().map(|v| format!(&quot;{}&quot;, v)).collect::&lt;Vec&lt;_&gt;&gt;().join(&quot;|&quot;)
</a><a href="#h12-4-16" id="h12-4-16" class="i">+                    );
</a>                 }
             }
         }
<a href="#h12-5" id="h12-5" class="h">@@ -178,7 +189,7 @@ Semicolons are not supported. The following !-commands are also available:
</a> 
     /// Prompts the user for input
     fn prompt(&amp;mut self) -&gt; Result&lt;Option&lt;String&gt;, Error&gt; {
<a href="#h12-5-3" id="h12-5-3" class="d">-        let prompt = match self.client.txn() {
</a><a href="#h12-5-4" id="h12-5-4" class="i">+        let prompt = match self.txn {
</a>             Some((id, Mode::ReadWrite)) =&gt; format!(&quot;toydb:{}&gt; &quot;, id),
             Some((id, Mode::ReadOnly)) =&gt; format!(&quot;toydb:{}&gt; &quot;, id),
             Some((_, Mode::Snapshot { version })) =&gt; format!(&quot;toydb@{}&gt; &quot;, version),
<a href="#h12-6" id="h12-6" class="h">@@ -195,7 +206,7 @@ Semicolons are not supported. The following !-commands are also available:
</a>     }
 
     /// Runs the ToySQL REPL
<a href="#h12-6-3" id="h12-6-3" class="d">-    fn run(&amp;mut self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-6-4" id="h12-6-4" class="i">+    async fn run(&amp;mut self) -&gt; Result&lt;(), Error&gt; {
</a>         if let Some(path) = &amp;self.history_path {
             match self.editor.load_history(path) {
                 Ok(_) =&gt; {}
<a href="#h12-7" id="h12-7" class="h">@@ -204,14 +215,14 @@ Semicolons are not supported. The following !-commands are also available:
</a>             };
         }
 
<a href="#h12-7-3" id="h12-7-3" class="d">-        let status = self.client.status()?;
</a><a href="#h12-7-4" id="h12-7-4" class="i">+        let status = self.client.status().await?;
</a>         println!(
             &quot;Connected to node \&quot;{}\&quot; (version {}). Enter !help for instructions.&quot;,
             status.id, status.version
         );
 
         while let Some(input) = self.prompt()? {
<a href="#h12-7-11" id="h12-7-11" class="d">-            if let Err(err) = self.execute(&amp;input) {
</a><a href="#h12-7-12" id="h12-7-12" class="i">+            if let Err(err) = self.execute(&amp;input).await {
</a>                 println!(&quot;Error: {}&quot;, err.to_string())
             }
         }
<b>diff --git a/<a id="h13" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,151 +1,138 @@
</a> use crate::server::{Request, Response, Status};
<a href="#h13-0-1" id="h13-0-1" class="d">-use crate::service;
</a><a href="#h13-0-2" id="h13-0-2" class="d">-use crate::service::ToyDB;
</a><a href="#h13-0-3" id="h13-0-3" class="d">-use crate::sql::engine::Mode;
</a> use crate::sql::execution::ResultSet;
 use crate::sql::schema::Table;
<a href="#h13-0-6" id="h13-0-6" class="d">-use crate::sql::types::Row;
</a><a href="#h13-0-7" id="h13-0-7" class="d">-use crate::utility::{deserialize, serialize};
</a> use crate::Error;
 
<a href="#h13-0-10" id="h13-0-10" class="d">-use grpc::ClientStubExt;
</a><a href="#h13-0-11" id="h13-0-11" class="d">-use rand::Rng as _;
</a><a href="#h13-0-12" id="h13-0-12" class="i">+use futures::future::FutureExt as _;
</a><a href="#h13-0-13" id="h13-0-13" class="i">+use futures::sink::SinkExt as _;
</a><a href="#h13-0-14" id="h13-0-14" class="i">+use futures::stream::TryStreamExt as _;
</a><a href="#h13-0-15" id="h13-0-15" class="i">+use tokio::net::{TcpStream, ToSocketAddrs};
</a><a href="#h13-0-16" id="h13-0-16" class="i">+use tokio::sync::{Mutex, MutexGuard};
</a><a href="#h13-0-17" id="h13-0-17" class="i">+use tokio_util::codec::{Framed, LengthDelimitedCodec};
</a><a href="#h13-0-18" id="h13-0-18" class="i">+
</a><a href="#h13-0-19" id="h13-0-19" class="i">+type Connection = tokio_serde::Framed&lt;
</a><a href="#h13-0-20" id="h13-0-20" class="i">+    Framed&lt;TcpStream, LengthDelimitedCodec&gt;,
</a><a href="#h13-0-21" id="h13-0-21" class="i">+    Response,
</a><a href="#h13-0-22" id="h13-0-22" class="i">+    Request,
</a><a href="#h13-0-23" id="h13-0-23" class="i">+    tokio_serde::formats::Cbor&lt;Response, Request&gt;,
</a><a href="#h13-0-24" id="h13-0-24" class="i">+&gt;;
</a> 
 /// A ToyDB client
 pub struct Client {
<a href="#h13-0-28" id="h13-0-28" class="d">-    client: service::ToyDBClient,
</a><a href="#h13-0-29" id="h13-0-29" class="d">-    txn: Option&lt;(u64, Mode)&gt;,
</a><a href="#h13-0-30" id="h13-0-30" class="d">-    pub txn_retries: u64,
</a><a href="#h13-0-31" id="h13-0-31" class="i">+    conn: Mutex&lt;Connection&gt;,
</a> }
 
 impl Client {
     /// Creates a new client
<a href="#h13-0-36" id="h13-0-36" class="d">-    pub fn new(host: &amp;str, port: u16) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h13-0-37" id="h13-0-37" class="i">+    pub async fn new&lt;A: ToSocketAddrs&gt;(addr: A) -&gt; Result&lt;Self, Error&gt; {
</a>         Ok(Self {
<a href="#h13-0-39" id="h13-0-39" class="d">-            client: service::ToyDBClient::new_plain(host, port, grpc::ClientConf::new())?,
</a><a href="#h13-0-40" id="h13-0-40" class="d">-            txn: None,
</a><a href="#h13-0-41" id="h13-0-41" class="d">-            txn_retries: 8,
</a><a href="#h13-0-42" id="h13-0-42" class="i">+            conn: Mutex::new(tokio_serde::Framed::new(
</a><a href="#h13-0-43" id="h13-0-43" class="i">+                Framed::new(TcpStream::connect(addr).await?, LengthDelimitedCodec::new()),
</a><a href="#h13-0-44" id="h13-0-44" class="i">+                tokio_serde::formats::Cbor::default(),
</a><a href="#h13-0-45" id="h13-0-45" class="i">+            )),
</a>         })
     }
 
     /// Call a server method
<a href="#h13-0-50" id="h13-0-50" class="d">-    fn call(&amp;self, req: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h13-0-51" id="h13-0-51" class="d">-        let (_, resp, _) = self
</a><a href="#h13-0-52" id="h13-0-52" class="d">-            .client
</a><a href="#h13-0-53" id="h13-0-53" class="d">-            .call(
</a><a href="#h13-0-54" id="h13-0-54" class="d">-                grpc::RequestOptions::new(),
</a><a href="#h13-0-55" id="h13-0-55" class="d">-                service::Request { body: serialize(&amp;req)?, ..Default::default() },
</a><a href="#h13-0-56" id="h13-0-56" class="d">-            )
</a><a href="#h13-0-57" id="h13-0-57" class="d">-            .wait()?;
</a><a href="#h13-0-58" id="h13-0-58" class="d">-        if !resp.err.is_empty() {
</a><a href="#h13-0-59" id="h13-0-59" class="d">-            Err(deserialize(&amp;resp.err)?)
</a><a href="#h13-0-60" id="h13-0-60" class="d">-        } else {
</a><a href="#h13-0-61" id="h13-0-61" class="d">-            Ok(deserialize(&amp;resp.ok)?)
</a><a href="#h13-0-62" id="h13-0-62" class="i">+    async fn call(&amp;self, request: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h13-0-63" id="h13-0-63" class="i">+        let mut conn = self.conn.lock().await;
</a><a href="#h13-0-64" id="h13-0-64" class="i">+        self.call_locked(&amp;mut conn, request).await
</a><a href="#h13-0-65" id="h13-0-65" class="i">+    }
</a><a href="#h13-0-66" id="h13-0-66" class="i">+
</a><a href="#h13-0-67" id="h13-0-67" class="i">+    /// Call a server method while holding the mutex lock
</a><a href="#h13-0-68" id="h13-0-68" class="i">+    async fn call_locked(
</a><a href="#h13-0-69" id="h13-0-69" class="i">+        &amp;self,
</a><a href="#h13-0-70" id="h13-0-70" class="i">+        conn: &amp;mut MutexGuard&lt;&#39;_, Connection&gt;,
</a><a href="#h13-0-71" id="h13-0-71" class="i">+        request: Request,
</a><a href="#h13-0-72" id="h13-0-72" class="i">+    ) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h13-0-73" id="h13-0-73" class="i">+        conn.send(request).await?;
</a><a href="#h13-0-74" id="h13-0-74" class="i">+        match conn.try_next().await? {
</a><a href="#h13-0-75" id="h13-0-75" class="i">+            Some(Response::Error(err)) =&gt; Err(err),
</a><a href="#h13-0-76" id="h13-0-76" class="i">+            Some(response) =&gt; Ok(response),
</a><a href="#h13-0-77" id="h13-0-77" class="i">+            None =&gt; Err(Error::Internal(&quot;Server disconnected&quot;.into())),
</a>         }
     }
 
<a href="#h13-0-81" id="h13-0-81" class="i">+    /// Executes a query
</a><a href="#h13-0-82" id="h13-0-82" class="i">+    pub async fn execute(&amp;self, query: &amp;str) -&gt; Result&lt;ResultSet, Error&gt; {
</a><a href="#h13-0-83" id="h13-0-83" class="i">+        let mut conn = self.conn.lock().await;
</a><a href="#h13-0-84" id="h13-0-84" class="i">+        let mut resultset =
</a><a href="#h13-0-85" id="h13-0-85" class="i">+            match self.call_locked(&amp;mut conn, Request::Execute(query.into())).await? {
</a><a href="#h13-0-86" id="h13-0-86" class="i">+                Response::Execute(rs) =&gt; rs,
</a><a href="#h13-0-87" id="h13-0-87" class="i">+                resp =&gt; return Err(Error::Internal(format!(&quot;Unexpected response {:?}&quot;, resp))),
</a><a href="#h13-0-88" id="h13-0-88" class="i">+            };
</a><a href="#h13-0-89" id="h13-0-89" class="i">+        if let ResultSet::Query { ref mut relation } = &amp;mut resultset {
</a><a href="#h13-0-90" id="h13-0-90" class="i">+            // FIXME We buffer rows for now to avoid lifetime hassles
</a><a href="#h13-0-91" id="h13-0-91" class="i">+            let mut rows = Vec::new();
</a><a href="#h13-0-92" id="h13-0-92" class="i">+            while let Some(response) = conn.try_next().await? {
</a><a href="#h13-0-93" id="h13-0-93" class="i">+                match response {
</a><a href="#h13-0-94" id="h13-0-94" class="i">+                    Response::Row(Some(row)) =&gt; rows.push(row),
</a><a href="#h13-0-95" id="h13-0-95" class="i">+                    Response::Row(None) =&gt; break,
</a><a href="#h13-0-96" id="h13-0-96" class="i">+                    Response::Error(error) =&gt; return Err(error),
</a><a href="#h13-0-97" id="h13-0-97" class="i">+                    response =&gt; {
</a><a href="#h13-0-98" id="h13-0-98" class="i">+                        return Err(Error::Internal(format!(&quot;Unexpected response {:?}&quot;, response)))
</a><a href="#h13-0-99" id="h13-0-99" class="i">+                    }
</a><a href="#h13-0-100" id="h13-0-100" class="i">+                }
</a><a href="#h13-0-101" id="h13-0-101" class="i">+            }
</a><a href="#h13-0-102" id="h13-0-102" class="i">+            relation.rows = Some(Box::new(rows.into_iter().map(Ok)));
</a><a href="#h13-0-103" id="h13-0-103" class="i">+        };
</a><a href="#h13-0-104" id="h13-0-104" class="i">+        Ok(resultset)
</a><a href="#h13-0-105" id="h13-0-105" class="i">+    }
</a><a href="#h13-0-106" id="h13-0-106" class="i">+
</a>     /// Fetches the table schema as SQL
<a href="#h13-0-108" id="h13-0-108" class="d">-    pub fn get_table(&amp;self, table: &amp;str) -&gt; Result&lt;Table, Error&gt; {
</a><a href="#h13-0-109" id="h13-0-109" class="d">-        match self.call(Request::GetTable(table.into()))? {
</a><a href="#h13-0-110" id="h13-0-110" class="i">+    pub async fn get_table(&amp;self, table: &amp;str) -&gt; Result&lt;Table, Error&gt; {
</a><a href="#h13-0-111" id="h13-0-111" class="i">+        match self.call(Request::GetTable(table.into())).await? {
</a>             Response::GetTable(t) =&gt; Ok(t),
             resp =&gt; Err(Error::Value(format!(&quot;Unexpected response: {:?}&quot;, resp))),
         }
     }
 
     /// Lists database tables
<a href="#h13-0-118" id="h13-0-118" class="d">-    pub fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h13-0-119" id="h13-0-119" class="d">-        match self.call(Request::ListTables)? {
</a><a href="#h13-0-120" id="h13-0-120" class="i">+    pub async fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h13-0-121" id="h13-0-121" class="i">+        match self.call(Request::ListTables).await? {
</a>             Response::ListTables(t) =&gt; Ok(t),
             resp =&gt; Err(Error::Value(format!(&quot;Unexpected response: {:?}&quot;, resp))),
         }
     }
 
<a href="#h13-0-127" id="h13-0-127" class="d">-    /// Returns the client transaction info, if any
</a><a href="#h13-0-128" id="h13-0-128" class="d">-    pub fn txn(&amp;self) -&gt; Option&lt;(u64, Mode)&gt; {
</a><a href="#h13-0-129" id="h13-0-129" class="d">-        self.txn.clone()
</a><a href="#h13-0-130" id="h13-0-130" class="d">-    }
</a><a href="#h13-0-131" id="h13-0-131" class="d">-
</a><a href="#h13-0-132" id="h13-0-132" class="d">-    /// Runs a query
</a><a href="#h13-0-133" id="h13-0-133" class="d">-    pub fn query(&amp;mut self, query: &amp;str) -&gt; Result&lt;ResultSet, Error&gt; {
</a><a href="#h13-0-134" id="h13-0-134" class="d">-        let (_, mut stream) = self
</a><a href="#h13-0-135" id="h13-0-135" class="d">-            .client
</a><a href="#h13-0-136" id="h13-0-136" class="d">-            .execute(
</a><a href="#h13-0-137" id="h13-0-137" class="d">-                grpc::RequestOptions::new(),
</a><a href="#h13-0-138" id="h13-0-138" class="d">-                service::Query {
</a><a href="#h13-0-139" id="h13-0-139" class="d">-                    txn_id: match self.txn {
</a><a href="#h13-0-140" id="h13-0-140" class="d">-                        Some((id, _)) =&gt; id,
</a><a href="#h13-0-141" id="h13-0-141" class="d">-                        None =&gt; 0,
</a><a href="#h13-0-142" id="h13-0-142" class="d">-                    },
</a><a href="#h13-0-143" id="h13-0-143" class="d">-                    query: query.to_owned(),
</a><a href="#h13-0-144" id="h13-0-144" class="d">-                    ..Default::default()
</a><a href="#h13-0-145" id="h13-0-145" class="d">-                },
</a><a href="#h13-0-146" id="h13-0-146" class="d">-            )
</a><a href="#h13-0-147" id="h13-0-147" class="d">-            .wait()?;
</a><a href="#h13-0-148" id="h13-0-148" class="d">-
</a><a href="#h13-0-149" id="h13-0-149" class="d">-        let resp =
</a><a href="#h13-0-150" id="h13-0-150" class="d">-            stream.next().ok_or_else(|| Error::Internal(&quot;Unexpected end of stream&quot;.into()))??;
</a><a href="#h13-0-151" id="h13-0-151" class="d">-        if !resp.err.is_empty() {
</a><a href="#h13-0-152" id="h13-0-152" class="d">-            return Err(deserialize(&amp;resp.err)?);
</a><a href="#h13-0-153" id="h13-0-153" class="i">+    /// Checks server status
</a><a href="#h13-0-154" id="h13-0-154" class="i">+    pub async fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h13-0-155" id="h13-0-155" class="i">+        match self.call(Request::Status).await? {
</a><a href="#h13-0-156" id="h13-0-156" class="i">+            Response::Status(s) =&gt; Ok(s),
</a><a href="#h13-0-157" id="h13-0-157" class="i">+            resp =&gt; Err(Error::Value(format!(&quot;Unexpected response: {:?}&quot;, resp))),
</a>         }
<a href="#h13-0-159" id="h13-0-159" class="d">-        let mut result = deserialize(&amp;resp.ok)?;
</a><a href="#h13-0-160" id="h13-0-160" class="d">-        match &amp;mut result {
</a><a href="#h13-0-161" id="h13-0-161" class="d">-            ResultSet::Query { relation } =&gt; {
</a><a href="#h13-0-162" id="h13-0-162" class="d">-                relation.rows = Some(Box::new(stream.map(Self::stream_to_row)))
</a><a href="#h13-0-163" id="h13-0-163" class="d">-            }
</a><a href="#h13-0-164" id="h13-0-164" class="d">-            ResultSet::Begin { id, mode } =&gt; self.txn = Some((*id, mode.clone())),
</a><a href="#h13-0-165" id="h13-0-165" class="d">-            ResultSet::Commit { .. } =&gt; self.txn = None,
</a><a href="#h13-0-166" id="h13-0-166" class="d">-            ResultSet::Rollback { .. } =&gt; self.txn = None,
</a><a href="#h13-0-167" id="h13-0-167" class="d">-            _ =&gt; {}
</a><a href="#h13-0-168" id="h13-0-168" class="d">-        };
</a><a href="#h13-0-169" id="h13-0-169" class="d">-        Ok(result)
</a>     }
<a href="#h13-0-171" id="h13-0-171" class="i">+}
</a> 
<a href="#h13-0-173" id="h13-0-173" class="d">-    /// Runs a transaction as a closure, automatically handling serialization failures by
</a><a href="#h13-0-174" id="h13-0-174" class="d">-    /// retrying the closure with exponential backoff. The returned result is from the final commit.
</a><a href="#h13-0-175" id="h13-0-175" class="d">-    pub fn with_txn&lt;F&gt;(&amp;mut self, mut f: F) -&gt; Result&lt;ResultSet, Error&gt;
</a><a href="#h13-0-176" id="h13-0-176" class="d">-    where
</a><a href="#h13-0-177" id="h13-0-177" class="d">-        F: FnMut(&amp;mut Self) -&gt; Result&lt;(), Error&gt;,
</a><a href="#h13-0-178" id="h13-0-178" class="d">-    {
</a><a href="#h13-0-179" id="h13-0-179" class="d">-        let mut rng = rand::thread_rng();
</a><a href="#h13-0-180" id="h13-0-180" class="d">-        for i in 0..self.txn_retries {
</a><a href="#h13-0-181" id="h13-0-181" class="d">-            if i &gt; 0 {
</a><a href="#h13-0-182" id="h13-0-182" class="d">-                std::thread::sleep(std::time::Duration::from_millis(
</a><a href="#h13-0-183" id="h13-0-183" class="d">-                    2_u64.pow(i as u32 - 1) * rng.gen_range(75, 125),
</a><a href="#h13-0-184" id="h13-0-184" class="d">-                ));
</a><a href="#h13-0-185" id="h13-0-185" class="d">-            }
</a><a href="#h13-0-186" id="h13-0-186" class="d">-            // Ugly workaround to use ?, while waiting for try_blocks:
</a><a href="#h13-0-187" id="h13-0-187" class="d">-            // https://doc.rust-lang.org/unstable-book/language-features/try-blocks.html
</a><a href="#h13-0-188" id="h13-0-188" class="d">-            let result = (|| {
</a><a href="#h13-0-189" id="h13-0-189" class="d">-                self.query(&quot;BEGIN&quot;)?;
</a><a href="#h13-0-190" id="h13-0-190" class="d">-                f(self)?;
</a><a href="#h13-0-191" id="h13-0-191" class="d">-                self.query(&quot;COMMIT&quot;)
</a><a href="#h13-0-192" id="h13-0-192" class="d">-            })();
</a><a href="#h13-0-193" id="h13-0-193" class="d">-            if self.txn().is_some() {
</a><a href="#h13-0-194" id="h13-0-194" class="d">-                self.query(&quot;ROLLBACK&quot;)?;
</a><a href="#h13-0-195" id="h13-0-195" class="d">-            }
</a><a href="#h13-0-196" id="h13-0-196" class="d">-            if let Err(Error::Serialization) = result {
</a><a href="#h13-0-197" id="h13-0-197" class="d">-                continue;
</a><a href="#h13-0-198" id="h13-0-198" class="d">-            }
</a><a href="#h13-0-199" id="h13-0-199" class="d">-            return result;
</a><a href="#h13-0-200" id="h13-0-200" class="d">-        }
</a><a href="#h13-0-201" id="h13-0-201" class="d">-        Err(Error::Serialization)
</a><a href="#h13-0-202" id="h13-0-202" class="i">+/// A ToyDB client pool
</a><a href="#h13-0-203" id="h13-0-203" class="i">+pub struct Pool {
</a><a href="#h13-0-204" id="h13-0-204" class="i">+    clients: Vec&lt;Mutex&lt;Client&gt;&gt;,
</a><a href="#h13-0-205" id="h13-0-205" class="i">+}
</a><a href="#h13-0-206" id="h13-0-206" class="i">+
</a><a href="#h13-0-207" id="h13-0-207" class="i">+impl Pool {
</a><a href="#h13-0-208" id="h13-0-208" class="i">+    /// Creates a new connection pool for the given servers, eagerly connecting clients.
</a><a href="#h13-0-209" id="h13-0-209" class="i">+    pub async fn new&lt;A: ToSocketAddrs + Clone&gt;(addrs: Vec&lt;A&gt;, size: u64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h13-0-210" id="h13-0-210" class="i">+        let mut addrs = addrs.into_iter().cycle();
</a><a href="#h13-0-211" id="h13-0-211" class="i">+        let clients = futures::future::try_join_all(
</a><a href="#h13-0-212" id="h13-0-212" class="i">+            std::iter::from_fn(|| {
</a><a href="#h13-0-213" id="h13-0-213" class="i">+                Some(Client::new(addrs.next().unwrap()).map(|r| r.map(Mutex::new)))
</a><a href="#h13-0-214" id="h13-0-214" class="i">+            })
</a><a href="#h13-0-215" id="h13-0-215" class="i">+            .take(size as usize),
</a><a href="#h13-0-216" id="h13-0-216" class="i">+        )
</a><a href="#h13-0-217" id="h13-0-217" class="i">+        .await?;
</a><a href="#h13-0-218" id="h13-0-218" class="i">+        Ok(Self { clients })
</a>     }
 
<a href="#h13-0-221" id="h13-0-221" class="d">-    /// Transform the gRPC result stream into a row iterator
</a><a href="#h13-0-222" id="h13-0-222" class="d">-    fn stream_to_row(item: Result&lt;service::Result, grpc::Error&gt;) -&gt; Result&lt;Row, Error&gt; {
</a><a href="#h13-0-223" id="h13-0-223" class="d">-        let item = item?;
</a><a href="#h13-0-224" id="h13-0-224" class="d">-        if !item.err.is_empty() {
</a><a href="#h13-0-225" id="h13-0-225" class="d">-            return Err(deserialize(&amp;item.err)?);
</a><a href="#h13-0-226" id="h13-0-226" class="d">-        }
</a><a href="#h13-0-227" id="h13-0-227" class="d">-        let row = deserialize(&amp;item.ok)?;
</a><a href="#h13-0-228" id="h13-0-228" class="d">-        Ok(row)
</a><a href="#h13-0-229" id="h13-0-229" class="i">+    /// Fetches a client from the pool, returning it when it goes out of scope.
</a><a href="#h13-0-230" id="h13-0-230" class="i">+    /// FIXME Should rollback txn (if any) when returning.
</a><a href="#h13-0-231" id="h13-0-231" class="i">+    pub async fn get(&amp;self) -&gt; (usize, MutexGuard&lt;&#39;_, Client&gt;) {
</a><a href="#h13-0-232" id="h13-0-232" class="i">+        let (client, index, _) =
</a><a href="#h13-0-233" id="h13-0-233" class="i">+            futures::future::select_all(self.clients.iter().map(|m| m.lock().boxed())).await;
</a><a href="#h13-0-234" id="h13-0-234" class="i">+        (index, client)
</a>     }
 
<a href="#h13-0-237" id="h13-0-237" class="d">-    /// Checks server status
</a><a href="#h13-0-238" id="h13-0-238" class="d">-    pub fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h13-0-239" id="h13-0-239" class="d">-        match self.call(Request::Status)? {
</a><a href="#h13-0-240" id="h13-0-240" class="d">-            Response::Status(s) =&gt; Ok(s),
</a><a href="#h13-0-241" id="h13-0-241" class="d">-            resp =&gt; Err(Error::Value(format!(&quot;Unexpected response: {:?}&quot;, resp))),
</a><a href="#h13-0-242" id="h13-0-242" class="d">-        }
</a><a href="#h13-0-243" id="h13-0-243" class="i">+    /// Returns the size of the pool
</a><a href="#h13-0-244" id="h13-0-244" class="i">+    pub fn size(&amp;self) -&gt; usize {
</a><a href="#h13-0-245" id="h13-0-245" class="i">+        self.clients.len()
</a>     }
 }
<b>diff --git a/<a id="h14" href="../file/src/error.rs.html">src/error.rs</a> b/<a href="../file/src/error.rs.html">src/error.rs</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -116,3 +116,9 @@ impl&lt;T&gt; From&lt;std::sync::PoisonError&lt;T&gt;&gt; for Error {
</a>         Error::Internal(err.to_string())
     }
 }
<a href="#h14-0-3" id="h14-0-3" class="i">+
</a><a href="#h14-0-4" id="h14-0-4" class="i">+impl From&lt;tokio::task::JoinError&gt; for Error {
</a><a href="#h14-0-5" id="h14-0-5" class="i">+    fn from(err: tokio::task::JoinError) -&gt; Self {
</a><a href="#h14-0-6" id="h14-0-6" class="i">+        Error::Internal(err.to_string())
</a><a href="#h14-0-7" id="h14-0-7" class="i">+    }
</a><a href="#h14-0-8" id="h14-0-8" class="i">+}
</a><b>diff --git a/<a id="h15" href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a> b/<a href="../file/src/kv/mvcc.rs.html">src/kv/mvcc.rs</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -224,13 +224,23 @@ pub enum Mode {
</a> 
 impl Mode {
     /// Checks whether the transaction mode can mutate data.
<a href="#h15-0-3" id="h15-0-3" class="d">-    fn mutable(&amp;self) -&gt; bool {
</a><a href="#h15-0-4" id="h15-0-4" class="i">+    pub fn mutable(&amp;self) -&gt; bool {
</a>         match self {
             Self::ReadWrite =&gt; true,
             Self::ReadOnly =&gt; false,
             Self::Snapshot { .. } =&gt; false,
         }
     }
<a href="#h15-0-11" id="h15-0-11" class="i">+
</a><a href="#h15-0-12" id="h15-0-12" class="i">+    /// Checks whether a mode satisfies a mode (i.e. ReadWrite satisfies ReadOnly).
</a><a href="#h15-0-13" id="h15-0-13" class="i">+    pub fn satisfies(&amp;self, other: &amp;Mode) -&gt; bool {
</a><a href="#h15-0-14" id="h15-0-14" class="i">+        match (self, other) {
</a><a href="#h15-0-15" id="h15-0-15" class="i">+            (Mode::ReadWrite, Mode::ReadOnly) =&gt; true,
</a><a href="#h15-0-16" id="h15-0-16" class="i">+            (Mode::Snapshot { .. }, Mode::ReadOnly) =&gt; true,
</a><a href="#h15-0-17" id="h15-0-17" class="i">+            (_, _) if self == other =&gt; true,
</a><a href="#h15-0-18" id="h15-0-18" class="i">+            (_, _) =&gt; false,
</a><a href="#h15-0-19" id="h15-0-19" class="i">+        }
</a><a href="#h15-0-20" id="h15-0-20" class="i">+    }
</a> }
 
 /// A versioned snapshot, containing visibility information about concurrent transactions.
<b>diff --git a/<a id="h16" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -98,7 +98,7 @@ impl Raft {
</a>                     },
                 }
             })();
<a href="#h16-0-3" id="h16-0-3" class="d">-            join_tx.send(result).unwrap()
</a><a href="#h16-0-4" id="h16-0-4" class="i">+            join_tx.send(result).ok()
</a>         });
 
         Ok(Raft { call_tx, join_rx, shutdown_tx })
<b>diff --git a/<a id="h17" href="../file/src/server/mod.rs.html">src/server/mod.rs</a> b/<a href="../file/src/server/mod.rs.html">src/server/mod.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -16,8 +16,6 @@ pub struct Server {
</a>     id: String,
     peers: HashMap&lt;String, std::net::SocketAddr&gt;,
     data_dir: String,
<a href="#h17-0-3" id="h17-0-3" class="d">-    grpc: Option&lt;grpc::Server&gt;,
</a><a href="#h17-0-4" id="h17-0-4" class="d">-    raft: Option&lt;Raft&gt;,
</a> }
 
 impl Server {
<a href="#h17-1" id="h17-1" class="h">@@ -26,14 +24,14 @@ impl Server {
</a>         peers: HashMap&lt;String, std::net::SocketAddr&gt;,
         data_dir: &amp;str,
     ) -&gt; Result&lt;Self, Error&gt; {
<a href="#h17-1-3" id="h17-1-3" class="d">-        Ok(Server { id: id.into(), peers, data_dir: data_dir.into(), grpc: None, raft: None })
</a><a href="#h17-1-4" id="h17-1-4" class="i">+        Ok(Server { id: id.into(), peers, data_dir: data_dir.into() })
</a>     }
 
<a href="#h17-1-7" id="h17-1-7" class="d">-    pub fn listen(&amp;mut self, addr: &amp;str, threads: usize) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h17-1-8" id="h17-1-8" class="d">-        info!(&quot;Starting ToyDB node with ID {} on {}&quot;, self.id, addr);
</a><a href="#h17-1-9" id="h17-1-9" class="i">+    pub async fn listen(self, sql_addr: String, raft_addr: String) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h17-1-10" id="h17-1-10" class="i">+        info!(&quot;Starting ToyDB node {} on {} (SQL) and {} (Raft)&quot;, self.id, sql_addr, raft_addr);
</a>         let mut server = grpc::ServerBuilder::new_plain();
<a href="#h17-1-12" id="h17-1-12" class="d">-        server.http.set_addr(addr)?;
</a><a href="#h17-1-13" id="h17-1-13" class="d">-        server.http.set_cpu_pool_threads(threads);
</a><a href="#h17-1-14" id="h17-1-14" class="i">+        server.http.set_addr(raft_addr)?;
</a><a href="#h17-1-15" id="h17-1-15" class="i">+        server.http.set_cpu_pool_threads(4);
</a>         let data_path = std::path::Path::new(&amp;self.data_dir);
         std::fs::create_dir_all(data_path)?;
 
<a href="#h17-2" id="h17-2" class="h">@@ -59,22 +57,14 @@ impl Server {
</a>             raft_transport,
         )?;
 
<a href="#h17-2-3" id="h17-2-3" class="d">-        server.add_service(service::ToyDBServer::new_service_def(ToyDB {
</a><a href="#h17-2-4" id="h17-2-4" class="d">-            id: self.id.clone(),
</a><a href="#h17-2-5" id="h17-2-5" class="d">-            raft: raft.clone(),
</a><a href="#h17-2-6" id="h17-2-6" class="d">-            engine: sql::engine::Raft::new(raft.clone()),
</a><a href="#h17-2-7" id="h17-2-7" class="d">-        }));
</a><a href="#h17-2-8" id="h17-2-8" class="i">+        let _s = server.build()?;
</a> 
<a href="#h17-2-10" id="h17-2-10" class="d">-        self.grpc = Some(server.build()?);
</a><a href="#h17-2-11" id="h17-2-11" class="d">-        self.raft = Some(raft);
</a><a href="#h17-2-12" id="h17-2-12" class="d">-        Ok(())
</a><a href="#h17-2-13" id="h17-2-13" class="d">-    }
</a><a href="#h17-2-14" id="h17-2-14" class="i">+        ToyDB { id: self.id.clone(), engine: sql::engine::Raft::new(raft.clone()) }
</a><a href="#h17-2-15" id="h17-2-15" class="i">+            .listen(&amp;sql_addr)
</a><a href="#h17-2-16" id="h17-2-16" class="i">+            .await?;
</a> 
<a href="#h17-2-18" id="h17-2-18" class="d">-    pub fn join(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h17-2-19" id="h17-2-19" class="d">-        self.raft.map(|r| r.join()).unwrap_or(Ok(()))
</a><a href="#h17-2-20" id="h17-2-20" class="d">-    }
</a><a href="#h17-2-21" id="h17-2-21" class="i">+        raft.shutdown()?;
</a> 
<a href="#h17-2-23" id="h17-2-23" class="d">-    pub fn shutdown(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h17-2-24" id="h17-2-24" class="d">-        self.raft.map(|r| r.shutdown()).unwrap_or(Ok(()))
</a><a href="#h17-2-25" id="h17-2-25" class="i">+        Ok(())
</a>     }
 }
<b>diff --git a/<a id="h18" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -1,120 +1,148 @@
</a><a href="#h18-0-0" id="h18-0-0" class="d">-use crate::raft::Raft;
</a><a href="#h18-0-1" id="h18-0-1" class="d">-use crate::service;
</a><a href="#h18-0-2" id="h18-0-2" class="d">-use crate::sql::engine::{Engine as _, Mode};
</a><a href="#h18-0-3" id="h18-0-3" class="i">+use crate::sql::engine::{Engine as _, Mode, Raft, Session as SQLSession};
</a> use crate::sql::execution::ResultSet;
 use crate::sql::schema::{Catalog as _, Table};
<a href="#h18-0-6" id="h18-0-6" class="d">-use crate::sql::types::{Relation, Row};
</a><a href="#h18-0-7" id="h18-0-7" class="d">-use crate::utility::{deserialize, serialize};
</a><a href="#h18-0-8" id="h18-0-8" class="i">+use crate::sql::types::Row;
</a> use crate::Error;
 
<a href="#h18-0-11" id="h18-0-11" class="d">-#[derive(Clone, Debug, Serialize, Deserialize)]
</a><a href="#h18-0-12" id="h18-0-12" class="i">+use futures_util::sink::{Sink, SinkExt as _};
</a><a href="#h18-0-13" id="h18-0-13" class="i">+use futures_util::stream::Stream;
</a><a href="#h18-0-14" id="h18-0-14" class="i">+use std::marker::Unpin;
</a><a href="#h18-0-15" id="h18-0-15" class="i">+use tokio::net::TcpListener;
</a><a href="#h18-0-16" id="h18-0-16" class="i">+use tokio::stream::StreamExt as _;
</a><a href="#h18-0-17" id="h18-0-17" class="i">+use tokio_util::codec::{Framed, LengthDelimitedCodec};
</a><a href="#h18-0-18" id="h18-0-18" class="i">+
</a><a href="#h18-0-19" id="h18-0-19" class="i">+/// A client request.
</a><a href="#h18-0-20" id="h18-0-20" class="i">+#[derive(Debug, Serialize, Deserialize)]
</a> pub enum Request {
<a href="#h18-0-22" id="h18-0-22" class="i">+    Execute(String),
</a>     GetTable(String),
     ListTables,
     Status,
 }
 
<a href="#h18-0-28" id="h18-0-28" class="d">-#[derive(Clone, Debug, Serialize, Deserialize)]
</a><a href="#h18-0-29" id="h18-0-29" class="i">+/// A server response.
</a><a href="#h18-0-30" id="h18-0-30" class="i">+#[derive(Debug, Serialize, Deserialize)]
</a> pub enum Response {
<a href="#h18-0-32" id="h18-0-32" class="i">+    Error(Error),
</a><a href="#h18-0-33" id="h18-0-33" class="i">+    Execute(ResultSet),
</a><a href="#h18-0-34" id="h18-0-34" class="i">+    Row(Option&lt;Row&gt;),
</a>     GetTable(Table),
     ListTables(Vec&lt;String&gt;),
     Status(Status),
 }
 
<a href="#h18-0-40" id="h18-0-40" class="i">+/// Server status, returned to clients.
</a> #[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
 pub struct Status {
     pub id: String,
     pub version: String,
 }
 
<a href="#h18-0-47" id="h18-0-47" class="i">+/// The ToyDB SQL server.
</a><a href="#h18-0-48" id="h18-0-48" class="i">+// FIXME This should be moved into main server struct
</a> pub struct ToyDB {
     pub id: String,
<a href="#h18-0-51" id="h18-0-51" class="d">-    pub raft: Raft,
</a><a href="#h18-0-52" id="h18-0-52" class="d">-    pub engine: crate::sql::engine::Raft,
</a><a href="#h18-0-53" id="h18-0-53" class="i">+    pub engine: Raft,
</a> }
 
<a href="#h18-0-56" id="h18-0-56" class="d">-impl service::ToyDB for ToyDB {
</a><a href="#h18-0-57" id="h18-0-57" class="d">-    fn call(
</a><a href="#h18-0-58" id="h18-0-58" class="d">-        &amp;self,
</a><a href="#h18-0-59" id="h18-0-59" class="d">-        _: grpc::RequestOptions,
</a><a href="#h18-0-60" id="h18-0-60" class="d">-        req: service::Request,
</a><a href="#h18-0-61" id="h18-0-61" class="d">-    ) -&gt; grpc::SingleResponse&lt;service::Result&gt; {
</a><a href="#h18-0-62" id="h18-0-62" class="d">-        let mut resp = service::Result::new();
</a><a href="#h18-0-63" id="h18-0-63" class="d">-        match deserialize(&amp;req.body) {
</a><a href="#h18-0-64" id="h18-0-64" class="d">-            Ok(req) =&gt; match self.call(req) {
</a><a href="#h18-0-65" id="h18-0-65" class="d">-                Ok(r) =&gt; resp.ok = serialize(&amp;r).unwrap(),
</a><a href="#h18-0-66" id="h18-0-66" class="d">-                Err(e) =&gt; resp.err = serialize(&amp;e).unwrap(),
</a><a href="#h18-0-67" id="h18-0-67" class="d">-            },
</a><a href="#h18-0-68" id="h18-0-68" class="d">-            Err(e) =&gt; {
</a><a href="#h18-0-69" id="h18-0-69" class="d">-                resp.err = serialize(&amp;Error::Value(format!(
</a><a href="#h18-0-70" id="h18-0-70" class="d">-                    &quot;Failed to deserialize request request: {}&quot;,
</a><a href="#h18-0-71" id="h18-0-71" class="d">-                    e
</a><a href="#h18-0-72" id="h18-0-72" class="d">-                )))
</a><a href="#h18-0-73" id="h18-0-73" class="d">-                .unwrap()
</a><a href="#h18-0-74" id="h18-0-74" class="d">-            }
</a><a href="#h18-0-75" id="h18-0-75" class="i">+impl ToyDB {
</a><a href="#h18-0-76" id="h18-0-76" class="i">+    /// Listens for connections from clients.
</a><a href="#h18-0-77" id="h18-0-77" class="i">+    pub async fn listen(&amp;self, addr: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-78" id="h18-0-78" class="i">+        let mut listener = TcpListener::bind(addr).await?;
</a><a href="#h18-0-79" id="h18-0-79" class="i">+        while let Some(socket) = listener.try_next().await? {
</a><a href="#h18-0-80" id="h18-0-80" class="i">+            let peer = socket.peer_addr()?;
</a><a href="#h18-0-81" id="h18-0-81" class="i">+            let stream = tokio_serde::Framed::new(
</a><a href="#h18-0-82" id="h18-0-82" class="i">+                Framed::new(socket, LengthDelimitedCodec::new()),
</a><a href="#h18-0-83" id="h18-0-83" class="i">+                tokio_serde::formats::Cbor::default(),
</a><a href="#h18-0-84" id="h18-0-84" class="i">+            );
</a><a href="#h18-0-85" id="h18-0-85" class="i">+            let session = Session::new(&amp;self.id, &amp;self.engine)?;
</a><a href="#h18-0-86" id="h18-0-86" class="i">+            tokio::spawn(async move {
</a><a href="#h18-0-87" id="h18-0-87" class="i">+                info!(&quot;Client {} connected&quot;, peer);
</a><a href="#h18-0-88" id="h18-0-88" class="i">+                match session.handle(stream).await {
</a><a href="#h18-0-89" id="h18-0-89" class="i">+                    Ok(()) =&gt; info!(&quot;Client {} disconnected&quot;, peer),
</a><a href="#h18-0-90" id="h18-0-90" class="i">+                    Err(err) =&gt; error!(&quot;Client {} error: {}&quot;, peer, err),
</a><a href="#h18-0-91" id="h18-0-91" class="i">+                }
</a><a href="#h18-0-92" id="h18-0-92" class="i">+            });
</a>         }
<a href="#h18-0-94" id="h18-0-94" class="d">-        grpc::SingleResponse::completed(resp)
</a><a href="#h18-0-95" id="h18-0-95" class="i">+        Ok(())
</a><a href="#h18-0-96" id="h18-0-96" class="i">+    }
</a><a href="#h18-0-97" id="h18-0-97" class="i">+}
</a><a href="#h18-0-98" id="h18-0-98" class="i">+
</a><a href="#h18-0-99" id="h18-0-99" class="i">+/// A client session coupled to a SQL session.
</a><a href="#h18-0-100" id="h18-0-100" class="i">+pub struct Session {
</a><a href="#h18-0-101" id="h18-0-101" class="i">+    server_id: String,
</a><a href="#h18-0-102" id="h18-0-102" class="i">+    sql: SQLSession&lt;Raft&gt;,
</a><a href="#h18-0-103" id="h18-0-103" class="i">+}
</a><a href="#h18-0-104" id="h18-0-104" class="i">+
</a><a href="#h18-0-105" id="h18-0-105" class="i">+impl Session {
</a><a href="#h18-0-106" id="h18-0-106" class="i">+    /// Creates a new client session.
</a><a href="#h18-0-107" id="h18-0-107" class="i">+    fn new(server_id: &amp;str, engine: &amp;Raft) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h18-0-108" id="h18-0-108" class="i">+        Ok(Self { server_id: server_id.into(), sql: engine.session()? })
</a>     }
 
<a href="#h18-0-111" id="h18-0-111" class="d">-    fn execute(
</a><a href="#h18-0-112" id="h18-0-112" class="d">-        &amp;self,
</a><a href="#h18-0-113" id="h18-0-113" class="d">-        _: grpc::RequestOptions,
</a><a href="#h18-0-114" id="h18-0-114" class="d">-        req: service::Query,
</a><a href="#h18-0-115" id="h18-0-115" class="d">-    ) -&gt; grpc::StreamingResponse&lt;service::Result&gt; {
</a><a href="#h18-0-116" id="h18-0-116" class="d">-        let iter: Box&lt;dyn Iterator&lt;Item = service::Result&gt; + Send&gt; = match self
</a><a href="#h18-0-117" id="h18-0-117" class="d">-            .execute(req.txn_id, &amp;req.query)
</a><a href="#h18-0-118" id="h18-0-118" class="d">-        {
</a><a href="#h18-0-119" id="h18-0-119" class="d">-            Ok(result) =&gt; {
</a><a href="#h18-0-120" id="h18-0-120" class="d">-                let mut iter: Box&lt;dyn Iterator&lt;Item = service::Result&gt; + Send&gt; = Box::new(
</a><a href="#h18-0-121" id="h18-0-121" class="d">-                    vec![service::Result { ok: serialize(&amp;result).unwrap(), ..Default::default() }]
</a><a href="#h18-0-122" id="h18-0-122" class="d">-                        .into_iter(),
</a><a href="#h18-0-123" id="h18-0-123" class="d">-                );
</a><a href="#h18-0-124" id="h18-0-124" class="d">-                if let ResultSet::Query { relation: Relation { rows: Some(rows), .. } } = result {
</a><a href="#h18-0-125" id="h18-0-125" class="d">-                    iter = Box::new(iter.chain(rows.map(Self::rows_to_stream)));
</a><a href="#h18-0-126" id="h18-0-126" class="i">+    /// Handles a client connection.
</a><a href="#h18-0-127" id="h18-0-127" class="i">+    async fn handle&lt;S&gt;(mut self, mut stream: S) -&gt; Result&lt;(), Error&gt;
</a><a href="#h18-0-128" id="h18-0-128" class="i">+    where
</a><a href="#h18-0-129" id="h18-0-129" class="i">+        S: Stream&lt;Item = std::io::Result&lt;Request&gt;&gt; + Sink&lt;Response, Error = std::io::Error&gt; + Unpin,
</a><a href="#h18-0-130" id="h18-0-130" class="i">+    {
</a><a href="#h18-0-131" id="h18-0-131" class="i">+        while let Some(request) = stream.try_next().await? {
</a><a href="#h18-0-132" id="h18-0-132" class="i">+            // FIXME call() blocks here, the SQL engine should (possibly) be async
</a><a href="#h18-0-133" id="h18-0-133" class="i">+            let mut response = match self.call(request) {
</a><a href="#h18-0-134" id="h18-0-134" class="i">+                Ok(response) =&gt; response,
</a><a href="#h18-0-135" id="h18-0-135" class="i">+                Err(err) =&gt; Response::Error(err),
</a><a href="#h18-0-136" id="h18-0-136" class="i">+            };
</a><a href="#h18-0-137" id="h18-0-137" class="i">+            let rows = match &amp;mut response {
</a><a href="#h18-0-138" id="h18-0-138" class="i">+                Response::Execute(ResultSet::Query { ref mut relation }) =&gt; relation.rows.take(),
</a><a href="#h18-0-139" id="h18-0-139" class="i">+                _ =&gt; None,
</a><a href="#h18-0-140" id="h18-0-140" class="i">+            };
</a><a href="#h18-0-141" id="h18-0-141" class="i">+            stream.send(response).await?;
</a><a href="#h18-0-142" id="h18-0-142" class="i">+            if let Some(rows) = rows {
</a><a href="#h18-0-143" id="h18-0-143" class="i">+                let mut errored = false;
</a><a href="#h18-0-144" id="h18-0-144" class="i">+                for r in rows {
</a><a href="#h18-0-145" id="h18-0-145" class="i">+                    stream
</a><a href="#h18-0-146" id="h18-0-146" class="i">+                        .send(match r {
</a><a href="#h18-0-147" id="h18-0-147" class="i">+                            Ok(row) =&gt; Response::Row(Some(row)),
</a><a href="#h18-0-148" id="h18-0-148" class="i">+                            Err(error) =&gt; {
</a><a href="#h18-0-149" id="h18-0-149" class="i">+                                errored = true;
</a><a href="#h18-0-150" id="h18-0-150" class="i">+                                Response::Error(error)
</a><a href="#h18-0-151" id="h18-0-151" class="i">+                            }
</a><a href="#h18-0-152" id="h18-0-152" class="i">+                        })
</a><a href="#h18-0-153" id="h18-0-153" class="i">+                        .await?;
</a><a href="#h18-0-154" id="h18-0-154" class="i">+                    if errored {
</a><a href="#h18-0-155" id="h18-0-155" class="i">+                        break;
</a><a href="#h18-0-156" id="h18-0-156" class="i">+                    }
</a><a href="#h18-0-157" id="h18-0-157" class="i">+                }
</a><a href="#h18-0-158" id="h18-0-158" class="i">+                if !errored {
</a><a href="#h18-0-159" id="h18-0-159" class="i">+                    stream.send(Response::Row(None)).await?;
</a>                 }
<a href="#h18-0-161" id="h18-0-161" class="d">-                iter
</a>             }
<a href="#h18-0-163" id="h18-0-163" class="d">-            Err(e) =&gt; Box::new(
</a><a href="#h18-0-164" id="h18-0-164" class="d">-                vec![service::Result { err: serialize(&amp;e).unwrap(), ..Default::default() }]
</a><a href="#h18-0-165" id="h18-0-165" class="d">-                    .into_iter(),
</a><a href="#h18-0-166" id="h18-0-166" class="d">-            ),
</a><a href="#h18-0-167" id="h18-0-167" class="d">-        };
</a><a href="#h18-0-168" id="h18-0-168" class="d">-        grpc::StreamingResponse::iter(iter)
</a><a href="#h18-0-169" id="h18-0-169" class="i">+        }
</a><a href="#h18-0-170" id="h18-0-170" class="i">+        Ok(())
</a>     }
<a href="#h18-0-172" id="h18-0-172" class="d">-}
</a> 
<a href="#h18-0-174" id="h18-0-174" class="d">-impl ToyDB {
</a><a href="#h18-0-175" id="h18-0-175" class="d">-    fn call(&amp;self, req: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h18-0-176" id="h18-0-176" class="i">+    /// Executes a simple request/response call.
</a><a href="#h18-0-177" id="h18-0-177" class="i">+    fn call(&amp;mut self, req: Request) -&gt; Result&lt;Response, Error&gt; {
</a>         Ok(match req {
<a href="#h18-0-179" id="h18-0-179" class="i">+            Request::Execute(query) =&gt; Response::Execute(self.sql.execute(&amp;query)?),
</a>             Request::GetTable(table) =&gt; Response::GetTable(self.get_table(&amp;table)?),
             Request::ListTables =&gt; Response::ListTables(self.list_tables()?),
             Request::Status =&gt; Response::Status(Status {
<a href="#h18-0-183" id="h18-0-183" class="d">-                id: self.id.clone(),
</a><a href="#h18-0-184" id="h18-0-184" class="i">+                id: self.server_id.clone(),
</a>                 version: env!(&quot;CARGO_PKG_VERSION&quot;).into(),
             }),
         })
     }
 
<a href="#h18-0-190" id="h18-0-190" class="d">-    fn execute(&amp;self, txn_id: u64, query: &amp;str) -&gt; Result&lt;ResultSet, Error&gt; {
</a><a href="#h18-0-191" id="h18-0-191" class="d">-        let txn_id = if txn_id &gt; 0 { Some(txn_id) } else { None };
</a><a href="#h18-0-192" id="h18-0-192" class="d">-        self.engine.session(txn_id)?.execute(query)
</a><a href="#h18-0-193" id="h18-0-193" class="d">-    }
</a><a href="#h18-0-194" id="h18-0-194" class="d">-
</a><a href="#h18-0-195" id="h18-0-195" class="d">-    fn rows_to_stream(item: Result&lt;Row, Error&gt;) -&gt; service::Result {
</a><a href="#h18-0-196" id="h18-0-196" class="d">-        match item {
</a><a href="#h18-0-197" id="h18-0-197" class="d">-            Ok(row) =&gt; service::Result { ok: serialize(&amp;row).unwrap(), ..Default::default() },
</a><a href="#h18-0-198" id="h18-0-198" class="d">-            Err(err) =&gt; service::Result { err: serialize(&amp;err).unwrap(), ..Default::default() },
</a><a href="#h18-0-199" id="h18-0-199" class="d">-        }
</a><a href="#h18-0-200" id="h18-0-200" class="d">-    }
</a><a href="#h18-0-201" id="h18-0-201" class="d">-
</a><a href="#h18-0-202" id="h18-0-202" class="d">-    fn get_table(&amp;self, name: &amp;str) -&gt; Result&lt;Table, Error&gt; {
</a><a href="#h18-0-203" id="h18-0-203" class="d">-        self.engine.with_txn(Mode::ReadOnly, |txn| match txn.read_table(name)? {
</a><a href="#h18-0-204" id="h18-0-204" class="i">+    /// Fetches a table.
</a><a href="#h18-0-205" id="h18-0-205" class="i">+    fn get_table(&amp;mut self, name: &amp;str) -&gt; Result&lt;Table, Error&gt; {
</a><a href="#h18-0-206" id="h18-0-206" class="i">+        self.sql.with_txn(Mode::ReadOnly, |txn| match txn.read_table(name)? {
</a>             Some(t) =&gt; Ok(t),
             None =&gt; Err(Error::Value(format!(&quot;Table {} does not exist&quot;, name))),
         })
     }
 
<a href="#h18-0-212" id="h18-0-212" class="d">-    fn list_tables(&amp;self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h18-0-213" id="h18-0-213" class="d">-        self.engine.with_txn(Mode::ReadOnly, |txn| Ok(txn.scan_tables()?.map(|t| t.name).collect()))
</a><a href="#h18-0-214" id="h18-0-214" class="i">+    /// Fetches a list of tables.
</a><a href="#h18-0-215" id="h18-0-215" class="i">+    fn list_tables(&amp;mut self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h18-0-216" id="h18-0-216" class="i">+        self.sql.with_txn(Mode::ReadOnly, |txn| Ok(txn.scan_tables()?.map(|t| t.name).collect()))
</a>     }
 }
<b>diff --git a/<a id="h19" href="../file/src/service/mod.rs.html">src/service/mod.rs</a> b/<a href="../file/src/service/mod.rs.html">src/service/mod.rs</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -9,14 +9,6 @@ mod raft;
</a> #[allow(bare_trait_objects)]
 #[allow(renamed_and_removed_lints)]
 mod raft_grpc;
<a href="#h19-0-3" id="h19-0-3" class="d">-#[allow(bare_trait_objects)]
</a><a href="#h19-0-4" id="h19-0-4" class="d">-#[allow(renamed_and_removed_lints)]
</a><a href="#h19-0-5" id="h19-0-5" class="d">-mod toydb;
</a><a href="#h19-0-6" id="h19-0-6" class="d">-#[allow(bare_trait_objects)]
</a><a href="#h19-0-7" id="h19-0-7" class="d">-#[allow(renamed_and_removed_lints)]
</a><a href="#h19-0-8" id="h19-0-8" class="d">-mod toydb_grpc;
</a> 
 pub use self::raft::*;
 pub use self::raft_grpc::*;
<a href="#h19-0-12" id="h19-0-12" class="d">-pub use self::toydb::*;
</a><a href="#h19-0-13" id="h19-0-13" class="d">-pub use self::toydb_grpc::*;
</a><b>diff --git a/<a id="h20" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -30,7 +30,7 @@ impl&lt;S: kv::storage::Storage&gt; KV&lt;S&gt; {
</a> impl&lt;S: kv::storage::Storage&gt; super::Engine for KV&lt;S&gt; {
     type Transaction = Transaction&lt;S&gt;;
 
<a href="#h20-0-3" id="h20-0-3" class="d">-    fn begin_with_mode(&amp;self, mode: super::Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h20-0-4" id="h20-0-4" class="i">+    fn begin(&amp;self, mode: super::Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a>         Ok(Self::Transaction::new(self.kv.begin_with_mode(mode)?))
     }
 
<b>diff --git a/<a id="h21" href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a> b/<a href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -18,33 +18,16 @@ pub trait Engine: Clone {
</a>     /// The transaction type
     type Transaction: Transaction;
 
<a href="#h21-0-3" id="h21-0-3" class="d">-    /// Begins a typical read-write transaction
</a><a href="#h21-0-4" id="h21-0-4" class="d">-    fn begin(&amp;self) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h21-0-5" id="h21-0-5" class="d">-        self.begin_with_mode(Mode::ReadWrite)
</a><a href="#h21-0-6" id="h21-0-6" class="d">-    }
</a><a href="#h21-0-7" id="h21-0-7" class="i">+    /// Begins a transaction in the given mode
</a><a href="#h21-0-8" id="h21-0-8" class="i">+    fn begin(&amp;self, mode: Mode) -&gt; Result&lt;Self::Transaction, Error&gt;;
</a> 
<a href="#h21-0-10" id="h21-0-10" class="d">-    /// Begins a session, optionally resuming an active transaction with the given ID
</a><a href="#h21-0-11" id="h21-0-11" class="d">-    fn session(&amp;self, id: Option&lt;u64&gt;) -&gt; Result&lt;Session&lt;Self&gt;, Error&gt; {
</a><a href="#h21-0-12" id="h21-0-12" class="d">-        let txn = if let Some(id) = id { Some(self.resume(id)?) } else { None };
</a><a href="#h21-0-13" id="h21-0-13" class="d">-        Ok(Session { engine: self.clone(), txn })
</a><a href="#h21-0-14" id="h21-0-14" class="i">+    /// Begins a session for executing individual statements
</a><a href="#h21-0-15" id="h21-0-15" class="i">+    fn session(&amp;self) -&gt; Result&lt;Session&lt;Self&gt;, Error&gt; {
</a><a href="#h21-0-16" id="h21-0-16" class="i">+        Ok(Session { engine: self.clone(), txn: None })
</a>     }
 
<a href="#h21-0-19" id="h21-0-19" class="d">-    /// Begins a transaction in the given mode
</a><a href="#h21-0-20" id="h21-0-20" class="d">-    fn begin_with_mode(&amp;self, mode: Mode) -&gt; Result&lt;Self::Transaction, Error&gt;;
</a><a href="#h21-0-21" id="h21-0-21" class="d">-
</a>     /// Resumes an active transaction with the given ID
     fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt;;
<a href="#h21-0-24" id="h21-0-24" class="d">-
</a><a href="#h21-0-25" id="h21-0-25" class="d">-    /// Runs a closure in a transaction
</a><a href="#h21-0-26" id="h21-0-26" class="d">-    fn with_txn&lt;R, F&gt;(&amp;self, mode: Mode, f: F) -&gt; Result&lt;R, Error&gt;
</a><a href="#h21-0-27" id="h21-0-27" class="d">-    where
</a><a href="#h21-0-28" id="h21-0-28" class="d">-        F: FnOnce(&amp;mut Self::Transaction) -&gt; Result&lt;R, Error&gt;,
</a><a href="#h21-0-29" id="h21-0-29" class="d">-    {
</a><a href="#h21-0-30" id="h21-0-30" class="d">-        let mut txn = self.begin_with_mode(mode)?;
</a><a href="#h21-0-31" id="h21-0-31" class="d">-        let res = f(&amp;mut txn);
</a><a href="#h21-0-32" id="h21-0-32" class="d">-        txn.rollback()?;
</a><a href="#h21-0-33" id="h21-0-33" class="d">-        res
</a><a href="#h21-0-34" id="h21-0-34" class="d">-    }
</a> }
 
 /// An SQL transaction
<a href="#h21-1" id="h21-1" class="h">@@ -94,13 +77,13 @@ impl&lt;E: Engine + &#39;static&gt; Session&lt;E&gt; {
</a>                 Err(Error::Value(&quot;Already in a transaction&quot;.into()))
             }
             ast::Statement::Begin { readonly: true, version: None } =&gt; {
<a href="#h21-1-3" id="h21-1-3" class="d">-                let txn = self.engine.begin_with_mode(Mode::ReadOnly)?;
</a><a href="#h21-1-4" id="h21-1-4" class="i">+                let txn = self.engine.begin(Mode::ReadOnly)?;
</a>                 let result = ResultSet::Begin { id: txn.id(), mode: txn.mode() };
                 self.txn = Some(txn);
                 Ok(result)
             }
             ast::Statement::Begin { readonly: true, version: Some(version) } =&gt; {
<a href="#h21-1-10" id="h21-1-10" class="d">-                let txn = self.engine.begin_with_mode(Mode::Snapshot { version })?;
</a><a href="#h21-1-11" id="h21-1-11" class="i">+                let txn = self.engine.begin(Mode::Snapshot { version })?;
</a>                 let result = ResultSet::Begin { id: txn.id(), mode: txn.mode() };
                 self.txn = Some(txn);
                 Ok(result)
<a href="#h21-2" id="h21-2" class="h">@@ -109,7 +92,7 @@ impl&lt;E: Engine + &#39;static&gt; Session&lt;E&gt; {
</a>                 Err(Error::Value(&quot;Can&#39;t start read-write transaction in a given version&quot;.into()))
             }
             ast::Statement::Begin { readonly: false, version: None } =&gt; {
<a href="#h21-2-3" id="h21-2-3" class="d">-                let txn = self.engine.begin_with_mode(Mode::ReadWrite)?;
</a><a href="#h21-2-4" id="h21-2-4" class="i">+                let txn = self.engine.begin(Mode::ReadWrite)?;
</a>                 let result = ResultSet::Begin { id: txn.id(), mode: txn.mode() };
                 self.txn = Some(txn);
                 Ok(result)
<a href="#h21-3" id="h21-3" class="h">@@ -133,14 +116,14 @@ impl&lt;E: Engine + &#39;static&gt; Session&lt;E&gt; {
</a>                 .optimize(self.txn.as_mut().unwrap())?
                 .execute(Context { txn: self.txn.as_mut().unwrap() }),
             statement @ ast::Statement::Select { .. } =&gt; {
<a href="#h21-3-3" id="h21-3-3" class="d">-                let mut txn = self.engine.begin_with_mode(Mode::ReadOnly)?;
</a><a href="#h21-3-4" id="h21-3-4" class="i">+                let mut txn = self.engine.begin(Mode::ReadOnly)?;
</a>                 let result =
                     Plan::build(statement)?.optimize(&amp;mut txn)?.execute(Context { txn: &amp;mut txn });
                 txn.rollback()?;
                 result
             }
             statement =&gt; {
<a href="#h21-3-11" id="h21-3-11" class="d">-                let mut txn = self.engine.begin_with_mode(Mode::ReadWrite)?;
</a><a href="#h21-3-12" id="h21-3-12" class="i">+                let mut txn = self.engine.begin(Mode::ReadWrite)?;
</a>                 match Plan::build(statement)?.optimize(&amp;mut txn)?.execute(Context { txn: &amp;mut txn })
                 {
                     Ok(result) =&gt; {
<a href="#h21-4" id="h21-4" class="h">@@ -155,6 +138,25 @@ impl&lt;E: Engine + &#39;static&gt; Session&lt;E&gt; {
</a>             }
         }
     }
<a href="#h21-4-3" id="h21-4-3" class="i">+
</a><a href="#h21-4-4" id="h21-4-4" class="i">+    /// Runs a closure in the session&#39;s transaction, or a new transaction if none is active.
</a><a href="#h21-4-5" id="h21-4-5" class="i">+    pub fn with_txn&lt;R, F&gt;(&amp;mut self, mode: Mode, f: F) -&gt; Result&lt;R, Error&gt;
</a><a href="#h21-4-6" id="h21-4-6" class="i">+    where
</a><a href="#h21-4-7" id="h21-4-7" class="i">+        F: FnOnce(&amp;mut E::Transaction) -&gt; Result&lt;R, Error&gt;,
</a><a href="#h21-4-8" id="h21-4-8" class="i">+    {
</a><a href="#h21-4-9" id="h21-4-9" class="i">+        if let Some(ref mut txn) = self.txn {
</a><a href="#h21-4-10" id="h21-4-10" class="i">+            if !txn.mode().satisfies(&amp;mode) {
</a><a href="#h21-4-11" id="h21-4-11" class="i">+                return Err(Error::Value(
</a><a href="#h21-4-12" id="h21-4-12" class="i">+                    &quot;The operation cannot run in the current transaction&quot;.into(),
</a><a href="#h21-4-13" id="h21-4-13" class="i">+                ));
</a><a href="#h21-4-14" id="h21-4-14" class="i">+            }
</a><a href="#h21-4-15" id="h21-4-15" class="i">+            return f(txn);
</a><a href="#h21-4-16" id="h21-4-16" class="i">+        }
</a><a href="#h21-4-17" id="h21-4-17" class="i">+        let mut txn = self.engine.begin(mode)?;
</a><a href="#h21-4-18" id="h21-4-18" class="i">+        let result = f(&amp;mut txn);
</a><a href="#h21-4-19" id="h21-4-19" class="i">+        txn.rollback()?;
</a><a href="#h21-4-20" id="h21-4-20" class="i">+        result
</a><a href="#h21-4-21" id="h21-4-21" class="i">+    }
</a> }
 
 /// The transaction mode
<b>diff --git a/<a id="h22" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -74,8 +74,8 @@ impl Raft {
</a> impl super::Engine for Raft {
     type Transaction = Transaction;
 
<a href="#h22-0-3" id="h22-0-3" class="d">-    fn begin_with_mode(&amp;self, mode: super::Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h22-0-4" id="h22-0-4" class="d">-        Transaction::begin_with_mode(self.raft.clone(), mode)
</a><a href="#h22-0-5" id="h22-0-5" class="i">+    fn begin(&amp;self, mode: super::Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h22-0-6" id="h22-0-6" class="i">+        Transaction::begin(self.raft.clone(), mode)
</a>     }
 
     fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt; {
<a href="#h22-1" id="h22-1" class="h">@@ -96,7 +96,7 @@ pub struct Transaction {
</a> 
 impl Transaction {
     /// Starts a transaction in the given mode
<a href="#h22-1-3" id="h22-1-3" class="d">-    fn begin_with_mode(raft: raft::Raft, mode: super::Mode) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h22-1-4" id="h22-1-4" class="i">+    fn begin(raft: raft::Raft, mode: super::Mode) -&gt; Result&lt;Self, Error&gt; {
</a>         let id = deserialize(&amp;raft.mutate(serialize(&amp;Mutation::Begin(mode.clone()))?)?)?;
         Ok(Self { raft, id, mode })
     }
<a href="#h22-2" id="h22-2" class="h">@@ -247,7 +247,7 @@ impl&lt;S: kv::storage::Storage&gt; State&lt;S&gt; {
</a> impl&lt;S: kv::storage::Storage&gt; raft::State for State&lt;S&gt; {
     fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
         match deserialize(&amp;command)? {
<a href="#h22-2-3" id="h22-2-3" class="d">-            Mutation::Begin(mode) =&gt; serialize(&amp;self.engine.begin_with_mode(mode)?.id()),
</a><a href="#h22-2-4" id="h22-2-4" class="i">+            Mutation::Begin(mode) =&gt; serialize(&amp;self.engine.begin(mode)?.id()),
</a>             Mutation::Commit(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.commit()?),
             Mutation::Rollback(txn_id) =&gt; serialize(&amp;self.engine.resume(txn_id)?.rollback()?),
 
<b>diff --git a/<a id="h23" href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a> b/<a href="../file/src/sql/execution/mod.rs.html">src/sql/execution/mod.rs</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -114,6 +114,26 @@ pub enum ResultSet {
</a>     Explain(Node),
 }
 
<a href="#h23-0-3" id="h23-0-3" class="i">+impl ResultSet {
</a><a href="#h23-0-4" id="h23-0-4" class="i">+    /// Converts the ResultSet into a Relation, or errors if not a query result.
</a><a href="#h23-0-5" id="h23-0-5" class="i">+    pub fn into_relation(self) -&gt; Result&lt;Relation, Error&gt; {
</a><a href="#h23-0-6" id="h23-0-6" class="i">+        match self {
</a><a href="#h23-0-7" id="h23-0-7" class="i">+            ResultSet::Query { relation } =&gt; Ok(relation),
</a><a href="#h23-0-8" id="h23-0-8" class="i">+            r =&gt; Err(Error::Value(format!(&quot;Not a query result: {:?}&quot;, r))),
</a><a href="#h23-0-9" id="h23-0-9" class="i">+        }
</a><a href="#h23-0-10" id="h23-0-10" class="i">+    }
</a><a href="#h23-0-11" id="h23-0-11" class="i">+
</a><a href="#h23-0-12" id="h23-0-12" class="i">+    /// Converts the ResultSet into a Row, or errors if not a query result with rows.
</a><a href="#h23-0-13" id="h23-0-13" class="i">+    pub fn into_row(self) -&gt; Result&lt;Row, Error&gt; {
</a><a href="#h23-0-14" id="h23-0-14" class="i">+        self.into_relation()?.into_row()?.ok_or_else(|| Error::Value(&quot;No rows returned&quot;.into()))
</a><a href="#h23-0-15" id="h23-0-15" class="i">+    }
</a><a href="#h23-0-16" id="h23-0-16" class="i">+
</a><a href="#h23-0-17" id="h23-0-17" class="i">+    /// Converts the ResultSet into a Value, if possible.
</a><a href="#h23-0-18" id="h23-0-18" class="i">+    pub fn into_value(self) -&gt; Result&lt;Value, Error&gt; {
</a><a href="#h23-0-19" id="h23-0-19" class="i">+        self.into_relation()?.into_value()?.ok_or_else(|| Error::Value(&quot;No value returned&quot;.into()))
</a><a href="#h23-0-20" id="h23-0-20" class="i">+    }
</a><a href="#h23-0-21" id="h23-0-21" class="i">+}
</a><a href="#h23-0-22" id="h23-0-22" class="i">+
</a> /// Column metadata for a result.
 /// FIXME This is outdated and should be removed.
 #[derive(Clone, Serialize, Deserialize)]
<b>diff --git a/<a id="h24" href="../file/src/sql/types/mod.rs.html">src/sql/types/mod.rs</a> b/<a href="../file/src/sql/types/mod.rs.html">src/sql/types/mod.rs</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -63,6 +63,38 @@ impl Value {
</a>             Self::String(_) =&gt; Some(DataType::String),
         }
     }
<a href="#h24-0-3" id="h24-0-3" class="i">+
</a><a href="#h24-0-4" id="h24-0-4" class="i">+    /// Returns the inner boolean, or an error if not a boolean
</a><a href="#h24-0-5" id="h24-0-5" class="i">+    pub fn boolean(self) -&gt; Result&lt;bool, Error&gt; {
</a><a href="#h24-0-6" id="h24-0-6" class="i">+        match self {
</a><a href="#h24-0-7" id="h24-0-7" class="i">+            Self::Boolean(b) =&gt; Ok(b),
</a><a href="#h24-0-8" id="h24-0-8" class="i">+            v =&gt; Err(Error::Value(format!(&quot;Not a boolean: {:?}&quot;, v))),
</a><a href="#h24-0-9" id="h24-0-9" class="i">+        }
</a><a href="#h24-0-10" id="h24-0-10" class="i">+    }
</a><a href="#h24-0-11" id="h24-0-11" class="i">+
</a><a href="#h24-0-12" id="h24-0-12" class="i">+    /// Returns the inner float, or an error if not a float
</a><a href="#h24-0-13" id="h24-0-13" class="i">+    pub fn float(self) -&gt; Result&lt;f64, Error&gt; {
</a><a href="#h24-0-14" id="h24-0-14" class="i">+        match self {
</a><a href="#h24-0-15" id="h24-0-15" class="i">+            Self::Float(f) =&gt; Ok(f),
</a><a href="#h24-0-16" id="h24-0-16" class="i">+            v =&gt; Err(Error::Value(format!(&quot;Not a float: {:?}&quot;, v))),
</a><a href="#h24-0-17" id="h24-0-17" class="i">+        }
</a><a href="#h24-0-18" id="h24-0-18" class="i">+    }
</a><a href="#h24-0-19" id="h24-0-19" class="i">+
</a><a href="#h24-0-20" id="h24-0-20" class="i">+    /// Returns the inner integer, or an error if not an integer
</a><a href="#h24-0-21" id="h24-0-21" class="i">+    pub fn integer(self) -&gt; Result&lt;i64, Error&gt; {
</a><a href="#h24-0-22" id="h24-0-22" class="i">+        match self {
</a><a href="#h24-0-23" id="h24-0-23" class="i">+            Self::Integer(i) =&gt; Ok(i),
</a><a href="#h24-0-24" id="h24-0-24" class="i">+            v =&gt; Err(Error::Value(format!(&quot;Not an integer: {:?}&quot;, v))),
</a><a href="#h24-0-25" id="h24-0-25" class="i">+        }
</a><a href="#h24-0-26" id="h24-0-26" class="i">+    }
</a><a href="#h24-0-27" id="h24-0-27" class="i">+
</a><a href="#h24-0-28" id="h24-0-28" class="i">+    /// Returns the inner string, or an error if not a string
</a><a href="#h24-0-29" id="h24-0-29" class="i">+    pub fn string(self) -&gt; Result&lt;String, Error&gt; {
</a><a href="#h24-0-30" id="h24-0-30" class="i">+        match self {
</a><a href="#h24-0-31" id="h24-0-31" class="i">+            Self::String(s) =&gt; Ok(s),
</a><a href="#h24-0-32" id="h24-0-32" class="i">+            v =&gt; Err(Error::Value(format!(&quot;Not a string: {:?}&quot;, v))),
</a><a href="#h24-0-33" id="h24-0-33" class="i">+        }
</a><a href="#h24-0-34" id="h24-0-34" class="i">+    }
</a> }
 
 impl std::fmt::Display for Value {
<a href="#h24-1" id="h24-1" class="h">@@ -156,6 +188,18 @@ pub struct Relation {
</a>     pub rows: Option&lt;Rows&gt;,
 }
 
<a href="#h24-1-3" id="h24-1-3" class="i">+impl Relation {
</a><a href="#h24-1-4" id="h24-1-4" class="i">+    /// Converts the relation into a single row, if any
</a><a href="#h24-1-5" id="h24-1-5" class="i">+    pub fn into_row(mut self) -&gt; Result&lt;Option&lt;Row&gt;, Error&gt; {
</a><a href="#h24-1-6" id="h24-1-6" class="i">+        self.next().transpose()
</a><a href="#h24-1-7" id="h24-1-7" class="i">+    }
</a><a href="#h24-1-8" id="h24-1-8" class="i">+
</a><a href="#h24-1-9" id="h24-1-9" class="i">+    /// Converts the relation into the first value of the first row, if any
</a><a href="#h24-1-10" id="h24-1-10" class="i">+    pub fn into_value(self) -&gt; Result&lt;Option&lt;Value&gt;, Error&gt; {
</a><a href="#h24-1-11" id="h24-1-11" class="i">+        Ok(self.into_row()?.filter(|row| !row.is_empty()).map(|mut row| row.remove(0)))
</a><a href="#h24-1-12" id="h24-1-12" class="i">+    }
</a><a href="#h24-1-13" id="h24-1-13" class="i">+}
</a><a href="#h24-1-14" id="h24-1-14" class="i">+
</a> impl Iterator for Relation {
     type Item = Result&lt;Row, Error&gt;;
 
<b>diff --git a/<a id="h25" href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a> b/<a href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,42 +1,20 @@
</a><a href="#h25-0-0" id="h25-0-0" class="d">-use toydb::client::Client;
</a><a href="#h25-0-1" id="h25-0-1" class="i">+use super::setup;
</a><a href="#h25-0-2" id="h25-0-2" class="i">+use super::util::{assert_row, assert_rows};
</a><a href="#h25-0-3" id="h25-0-3" class="i">+
</a> use toydb::server::Status;
 use toydb::sql::engine::Mode;
 use toydb::sql::execution::ResultSet;
 use toydb::sql::schema;
<a href="#h25-0-8" id="h25-0-8" class="d">-use toydb::sql::types::{Column, DataType, Relation, Row, Value};
</a><a href="#h25-0-9" id="h25-0-9" class="i">+use toydb::sql::types::{Column, DataType, Relation, Value};
</a><a href="#h25-0-10" id="h25-0-10" class="i">+use toydb::Client;
</a> use toydb::Error;
 
 use pretty_assertions::assert_eq;
 use serial_test::serial;
<a href="#h25-0-15" id="h25-0-15" class="d">-use std::collections::HashMap;
</a><a href="#h25-0-16" id="h25-0-16" class="d">-
</a><a href="#h25-0-17" id="h25-0-17" class="d">-#[allow(clippy::type_complexity)]
</a><a href="#h25-0-18" id="h25-0-18" class="d">-fn setup(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h25-0-19" id="h25-0-19" class="d">-    let data_dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h25-0-20" id="h25-0-20" class="d">-    let mut srv = toydb::Server::new(&quot;test&quot;, HashMap::new(), &amp;data_dir.path().to_string_lossy())?;
</a><a href="#h25-0-21" id="h25-0-21" class="d">-    srv.listen(&quot;127.0.0.1:9605&quot;, 4)?;
</a><a href="#h25-0-22" id="h25-0-22" class="d">-
</a><a href="#h25-0-23" id="h25-0-23" class="d">-    let mut client = toydb::Client::new(&quot;127.0.0.1&quot;, 9605)?;
</a><a href="#h25-0-24" id="h25-0-24" class="d">-    client.query(&quot;BEGIN&quot;)?;
</a><a href="#h25-0-25" id="h25-0-25" class="d">-    for query in queries {
</a><a href="#h25-0-26" id="h25-0-26" class="d">-        client.query(&amp;query)?;
</a><a href="#h25-0-27" id="h25-0-27" class="d">-    }
</a><a href="#h25-0-28" id="h25-0-28" class="d">-    client.query(&quot;COMMIT&quot;)?;
</a><a href="#h25-0-29" id="h25-0-29" class="d">-
</a><a href="#h25-0-30" id="h25-0-30" class="d">-    let client = toydb::Client::new(&quot;127.0.0.1&quot;, 9605)?;
</a><a href="#h25-0-31" id="h25-0-31" class="d">-
</a><a href="#h25-0-32" id="h25-0-32" class="d">-    Ok((
</a><a href="#h25-0-33" id="h25-0-33" class="d">-        client,
</a><a href="#h25-0-34" id="h25-0-34" class="d">-        Box::new(move || {
</a><a href="#h25-0-35" id="h25-0-35" class="d">-            srv.shutdown().unwrap();
</a><a href="#h25-0-36" id="h25-0-36" class="d">-            std::mem::drop(data_dir)
</a><a href="#h25-0-37" id="h25-0-37" class="d">-        }),
</a><a href="#h25-0-38" id="h25-0-38" class="d">-    ))
</a><a href="#h25-0-39" id="h25-0-39" class="d">-}
</a> 
 #[allow(clippy::type_complexity)]
<a href="#h25-0-42" id="h25-0-42" class="d">-fn setup_movies() -&gt; Result&lt;(toydb::Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h25-0-43" id="h25-0-43" class="d">-    setup(vec![
</a><a href="#h25-0-44" id="h25-0-44" class="i">+async fn setup_movies() -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h25-0-45" id="h25-0-45" class="i">+    setup::server_with_queries(vec![
</a>         &quot;CREATE TABLE countries (
             id STRING PRIMARY KEY,
             name STRING NOT NULL
<a href="#h25-1" id="h25-1" class="h">@@ -84,17 +62,21 @@ fn setup_movies() -&gt; Result&lt;(toydb::Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a>             (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE),
             (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)&quot;,
     ])
<a href="#h25-1-3" id="h25-1-3" class="i">+    .await
</a> }
 
<a href="#h25-1-6" id="h25-1-6" class="d">-#[test]
</a><a href="#h25-1-7" id="h25-1-7" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-1-9" id="h25-1-9" class="d">-fn get_table() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-1-10" id="h25-1-10" class="d">-    let (c, teardown) = setup_movies()?;
</a><a href="#h25-1-11" id="h25-1-11" class="i">+async fn get_table() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-1-12" id="h25-1-12" class="i">+    let (c, teardown) = setup_movies().await?;
</a>     defer!(teardown());
 
<a href="#h25-1-15" id="h25-1-15" class="d">-    assert_eq!(c.get_table(&quot;unknown&quot;), Err(Error::Value(&quot;Table unknown does not exist&quot;.into())));
</a>     assert_eq!(
<a href="#h25-1-17" id="h25-1-17" class="d">-        c.get_table(&quot;movies&quot;)?,
</a><a href="#h25-1-18" id="h25-1-18" class="i">+        c.get_table(&quot;unknown&quot;).await,
</a><a href="#h25-1-19" id="h25-1-19" class="i">+        Err(Error::Value(&quot;Table unknown does not exist&quot;.into()))
</a><a href="#h25-1-20" id="h25-1-20" class="i">+    );
</a><a href="#h25-1-21" id="h25-1-21" class="i">+    assert_eq!(
</a><a href="#h25-1-22" id="h25-1-22" class="i">+        c.get_table(&quot;movies&quot;).await?,
</a>         schema::Table {
             name: &quot;movies&quot;.into(),
             columns: vec![
<a href="#h25-2" id="h25-2" class="h">@@ -174,39 +156,39 @@ fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h25-2-3" id="h25-2-3" class="d">-#[test]
</a><a href="#h25-2-4" id="h25-2-4" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-2-6" id="h25-2-6" class="d">-fn list_tables() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-2-7" id="h25-2-7" class="d">-    let (c, teardown) = setup_movies()?;
</a><a href="#h25-2-8" id="h25-2-8" class="i">+async fn list_tables() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-2-9" id="h25-2-9" class="i">+    let (c, teardown) = setup_movies().await?;
</a>     defer!(teardown());
 
<a href="#h25-2-12" id="h25-2-12" class="d">-    assert_eq!(c.list_tables()?, vec![&quot;countries&quot;, &quot;genres&quot;, &quot;movies&quot;, &quot;studios&quot;]);
</a><a href="#h25-2-13" id="h25-2-13" class="i">+    assert_eq!(c.list_tables().await?, vec![&quot;countries&quot;, &quot;genres&quot;, &quot;movies&quot;, &quot;studios&quot;]);
</a>     Ok(())
 }
 
<a href="#h25-2-17" id="h25-2-17" class="d">-#[test]
</a><a href="#h25-2-18" id="h25-2-18" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-2-20" id="h25-2-20" class="d">-fn status() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-2-21" id="h25-2-21" class="d">-    let (c, teardown) = setup_movies()?;
</a><a href="#h25-2-22" id="h25-2-22" class="i">+async fn status() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-2-23" id="h25-2-23" class="i">+    let (c, teardown) = setup_movies().await?;
</a>     defer!(teardown());
 
     assert_eq!(
<a href="#h25-2-27" id="h25-2-27" class="d">-        c.status()?,
</a><a href="#h25-2-28" id="h25-2-28" class="i">+        c.status().await?,
</a>         Status { id: &quot;test&quot;.into(), version: env!(&quot;CARGO_PKG_VERSION&quot;).into() }
     );
     Ok(())
 }
 
<a href="#h25-2-34" id="h25-2-34" class="d">-#[test]
</a><a href="#h25-2-35" id="h25-2-35" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-2-37" id="h25-2-37" class="d">-fn query() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-2-38" id="h25-2-38" class="i">+async fn query() -&gt; Result&lt;(), Error&gt; {
</a>     // The SQL engine is thoroughly tested in a separate suite, this just exercises the
     // basic client/server integration.
<a href="#h25-2-41" id="h25-2-41" class="d">-    let (mut c, teardown) = setup_movies()?;
</a><a href="#h25-2-42" id="h25-2-42" class="i">+    let (c, teardown) = setup_movies().await?;
</a>     defer!(teardown());
 
     // SELECT
<a href="#h25-2-46" id="h25-2-46" class="d">-    let result = c.query(&quot;SELECT * FROM genres&quot;)?;
</a><a href="#h25-2-47" id="h25-2-47" class="i">+    let result = c.execute(&quot;SELECT * FROM genres&quot;).await?;
</a>     assert_eq!(
         result,
         ResultSet::Query {
<a href="#h25-3" id="h25-3" class="h">@@ -228,7 +210,7 @@ fn query() -&gt; Result&lt;(), Error&gt; {
</a>         ],
     );
 
<a href="#h25-3-3" id="h25-3-3" class="d">-    let result = c.query(&quot;SELECT * FROM genres WHERE FALSE&quot;)?;
</a><a href="#h25-3-4" id="h25-3-4" class="i">+    let result = c.execute(&quot;SELECT * FROM genres WHERE FALSE&quot;).await?;
</a>     assert_eq!(
         result,
         ResultSet::Query {
<a href="#h25-4" id="h25-4" class="h">@@ -243,128 +225,125 @@ fn query() -&gt; Result&lt;(), Error&gt; {
</a>     );
     assert_rows(result, Vec::new());
 
<a href="#h25-4-3" id="h25-4-3" class="d">-    assert_eq!(c.query(&quot;SELECT * FROM x&quot;), Err(Error::Value(&quot;Table x does not exist&quot;.into())));
</a><a href="#h25-4-4" id="h25-4-4" class="i">+    assert_eq!(
</a><a href="#h25-4-5" id="h25-4-5" class="i">+        c.execute(&quot;SELECT * FROM x&quot;).await,
</a><a href="#h25-4-6" id="h25-4-6" class="i">+        Err(Error::Value(&quot;Table x does not exist&quot;.into()))
</a><a href="#h25-4-7" id="h25-4-7" class="i">+    );
</a> 
     // INSERT
     assert_eq!(
<a href="#h25-4-11" id="h25-4-11" class="d">-        c.query(&quot;INSERT INTO genres VALUES (1, &#39;Western&#39;)&quot;),
</a><a href="#h25-4-12" id="h25-4-12" class="i">+        c.execute(&quot;INSERT INTO genres VALUES (1, &#39;Western&#39;)&quot;).await,
</a>         Err(Error::Value(&quot;Primary key 1 already exists for table genres&quot;.into())),
     );
     assert_eq!(
<a href="#h25-4-16" id="h25-4-16" class="d">-        c.query(&quot;INSERT INTO genres VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h25-4-17" id="h25-4-17" class="i">+        c.execute(&quot;INSERT INTO genres VALUES (9, &#39;Western&#39;)&quot;).await,
</a>         Ok(ResultSet::Create { count: 1 }),
     );
     assert_eq!(
<a href="#h25-4-21" id="h25-4-21" class="d">-        c.query(&quot;INSERT INTO x VALUES (9, &#39;Western&#39;)&quot;),
</a><a href="#h25-4-22" id="h25-4-22" class="i">+        c.execute(&quot;INSERT INTO x VALUES (9, &#39;Western&#39;)&quot;).await,
</a>         Err(Error::Value(&quot;Table x does not exist&quot;.into()))
     );
 
     // UPDATE
     assert_eq!(
<a href="#h25-4-28" id="h25-4-28" class="d">-        c.query(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE FALSE&quot;),
</a><a href="#h25-4-29" id="h25-4-29" class="i">+        c.execute(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE FALSE&quot;).await,
</a>         Ok(ResultSet::Update { count: 0 }),
     );
     assert_eq!(
<a href="#h25-4-33" id="h25-4-33" class="d">-        c.query(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE id = 9&quot;),
</a><a href="#h25-4-34" id="h25-4-34" class="i">+        c.execute(&quot;UPDATE genres SET name = &#39;Horror&#39; WHERE id = 9&quot;).await,
</a>         Ok(ResultSet::Update { count: 1 }),
     );
     assert_eq!(
<a href="#h25-4-38" id="h25-4-38" class="d">-        c.query(&quot;UPDATE genres SET id = 1 WHERE id = 9&quot;),
</a><a href="#h25-4-39" id="h25-4-39" class="i">+        c.execute(&quot;UPDATE genres SET id = 1 WHERE id = 9&quot;).await,
</a>         Err(Error::Value(&quot;Primary key 1 already exists for table genres&quot;.into()))
     );
 
     // DELETE
<a href="#h25-4-44" id="h25-4-44" class="d">-    assert_eq!(c.query(&quot;DELETE FROM genres WHERE FALSE&quot;), Ok(ResultSet::Delete { count: 0 }),);
</a><a href="#h25-4-45" id="h25-4-45" class="d">-    assert_eq!(c.query(&quot;DELETE FROM genres WHERE id = 9&quot;), Ok(ResultSet::Delete { count: 1 }),);
</a>     assert_eq!(
<a href="#h25-4-47" id="h25-4-47" class="d">-        c.query(&quot;DELETE FROM genres WHERE x = 1&quot;),
</a><a href="#h25-4-48" id="h25-4-48" class="i">+        c.execute(&quot;DELETE FROM genres WHERE FALSE&quot;).await,
</a><a href="#h25-4-49" id="h25-4-49" class="i">+        Ok(ResultSet::Delete { count: 0 }),
</a><a href="#h25-4-50" id="h25-4-50" class="i">+    );
</a><a href="#h25-4-51" id="h25-4-51" class="i">+    assert_eq!(
</a><a href="#h25-4-52" id="h25-4-52" class="i">+        c.execute(&quot;DELETE FROM genres WHERE id = 9&quot;).await,
</a><a href="#h25-4-53" id="h25-4-53" class="i">+        Ok(ResultSet::Delete { count: 1 }),
</a><a href="#h25-4-54" id="h25-4-54" class="i">+    );
</a><a href="#h25-4-55" id="h25-4-55" class="i">+    assert_eq!(
</a><a href="#h25-4-56" id="h25-4-56" class="i">+        c.execute(&quot;DELETE FROM genres WHERE x = 1&quot;).await,
</a>         Err(Error::Value(&quot;Unknown field x&quot;.into()))
     );
 
     Ok(())
 }
 
<a href="#h25-4-63" id="h25-4-63" class="d">-#[test]
</a><a href="#h25-4-64" id="h25-4-64" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-4-66" id="h25-4-66" class="d">-fn query_txn() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-4-67" id="h25-4-67" class="d">-    let (mut c, teardown) = setup_movies()?;
</a><a href="#h25-4-68" id="h25-4-68" class="i">+async fn query_txn() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-4-69" id="h25-4-69" class="i">+    let (c, teardown) = setup_movies().await?;
</a>     defer!(teardown());
 
     // Committing a change in a txn should work
<a href="#h25-4-73" id="h25-4-73" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-74" id="h25-4-74" class="d">-    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
</a><a href="#h25-4-75" id="h25-4-75" class="d">-    assert_eq!(c.txn(), Some((2, Mode::ReadWrite)));
</a><a href="#h25-4-76" id="h25-4-76" class="d">-
</a><a href="#h25-4-77" id="h25-4-77" class="d">-    c.query(&quot;INSERT INTO genres VALUES (4, &#39;Drama&#39;)&quot;)?;
</a><a href="#h25-4-78" id="h25-4-78" class="d">-    assert_eq!(c.txn(), Some((2, Mode::ReadWrite)));
</a><a href="#h25-4-79" id="h25-4-79" class="d">-
</a><a href="#h25-4-80" id="h25-4-80" class="d">-    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 2 });
</a><a href="#h25-4-81" id="h25-4-81" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-82" id="h25-4-82" class="d">-
</a><a href="#h25-4-83" id="h25-4-83" class="d">-    assert_rows(
</a><a href="#h25-4-84" id="h25-4-84" class="d">-        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h25-4-85" id="h25-4-85" class="d">-        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h25-4-86" id="h25-4-86" class="i">+    assert_eq!(c.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
</a><a href="#h25-4-87" id="h25-4-87" class="i">+    c.execute(&quot;INSERT INTO genres VALUES (4, &#39;Drama&#39;)&quot;).await?;
</a><a href="#h25-4-88" id="h25-4-88" class="i">+    assert_eq!(c.execute(&quot;COMMIT&quot;).await?, ResultSet::Commit { id: 2 });
</a><a href="#h25-4-89" id="h25-4-89" class="i">+    assert_row(
</a><a href="#h25-4-90" id="h25-4-90" class="i">+        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;).await?,
</a><a href="#h25-4-91" id="h25-4-91" class="i">+        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a>     );
 
     // Rolling back a change in a txn should also work
<a href="#h25-4-95" id="h25-4-95" class="d">-    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 4, mode: Mode::ReadWrite });
</a><a href="#h25-4-96" id="h25-4-96" class="d">-    c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;)?;
</a><a href="#h25-4-97" id="h25-4-97" class="d">-    assert_rows(
</a><a href="#h25-4-98" id="h25-4-98" class="d">-        c.query(&quot;SELECT * FROM genres WHERE id = 5&quot;)?,
</a><a href="#h25-4-99" id="h25-4-99" class="d">-        vec![vec![Value::Integer(5), Value::String(&quot;Musical&quot;.into())]],
</a><a href="#h25-4-100" id="h25-4-100" class="i">+    assert_eq!(c.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 4, mode: Mode::ReadWrite });
</a><a href="#h25-4-101" id="h25-4-101" class="i">+    c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;).await?;
</a><a href="#h25-4-102" id="h25-4-102" class="i">+    assert_row(
</a><a href="#h25-4-103" id="h25-4-103" class="i">+        c.execute(&quot;SELECT * FROM genres WHERE id = 5&quot;).await?,
</a><a href="#h25-4-104" id="h25-4-104" class="i">+        vec![Value::Integer(5), Value::String(&quot;Musical&quot;.into())],
</a>     );
<a href="#h25-4-106" id="h25-4-106" class="d">-    assert_eq!(c.query(&quot;ROLLBACK&quot;)?, ResultSet::Rollback { id: 4 });
</a><a href="#h25-4-107" id="h25-4-107" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-108" id="h25-4-108" class="d">-    assert_rows(c.query(&quot;SELECT * FROM genres WHERE id = 5&quot;)?, Vec::new());
</a><a href="#h25-4-109" id="h25-4-109" class="i">+    assert_eq!(c.execute(&quot;ROLLBACK&quot;).await?, ResultSet::Rollback { id: 4 });
</a><a href="#h25-4-110" id="h25-4-110" class="i">+    assert_rows(c.execute(&quot;SELECT * FROM genres WHERE id = 5&quot;).await?, Vec::new());
</a> 
     // Starting a read-only txn should block writes
<a href="#h25-4-113" id="h25-4-113" class="d">-    assert_eq!(c.query(&quot;BEGIN READ ONLY&quot;)?, ResultSet::Begin { id: 6, mode: Mode::ReadOnly });
</a><a href="#h25-4-114" id="h25-4-114" class="d">-    assert_eq!(c.txn(), Some((6, Mode::ReadOnly)));
</a><a href="#h25-4-115" id="h25-4-115" class="d">-    assert_rows(
</a><a href="#h25-4-116" id="h25-4-116" class="d">-        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h25-4-117" id="h25-4-117" class="d">-        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h25-4-118" id="h25-4-118" class="i">+    assert_eq!(
</a><a href="#h25-4-119" id="h25-4-119" class="i">+        c.execute(&quot;BEGIN READ ONLY&quot;).await?,
</a><a href="#h25-4-120" id="h25-4-120" class="i">+        ResultSet::Begin { id: 6, mode: Mode::ReadOnly }
</a>     );
<a href="#h25-4-122" id="h25-4-122" class="d">-    assert_eq!(c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h25-4-123" id="h25-4-123" class="d">-    assert_eq!(c.txn(), Some((6, Mode::ReadOnly)));
</a><a href="#h25-4-124" id="h25-4-124" class="d">-    assert_rows(
</a><a href="#h25-4-125" id="h25-4-125" class="d">-        c.query(&quot;SELECT * FROM genres WHERE id = 4&quot;)?,
</a><a href="#h25-4-126" id="h25-4-126" class="d">-        vec![vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())]],
</a><a href="#h25-4-127" id="h25-4-127" class="i">+    assert_row(
</a><a href="#h25-4-128" id="h25-4-128" class="i">+        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;).await?,
</a><a href="#h25-4-129" id="h25-4-129" class="i">+        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a>     );
<a href="#h25-4-131" id="h25-4-131" class="d">-    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 6 });
</a><a href="#h25-4-132" id="h25-4-132" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-133" id="h25-4-133" class="i">+    assert_eq!(c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;).await, Err(Error::ReadOnly));
</a><a href="#h25-4-134" id="h25-4-134" class="i">+    assert_row(
</a><a href="#h25-4-135" id="h25-4-135" class="i">+        c.execute(&quot;SELECT * FROM genres WHERE id = 4&quot;).await?,
</a><a href="#h25-4-136" id="h25-4-136" class="i">+        vec![Value::Integer(4), Value::String(&quot;Drama&quot;.into())],
</a><a href="#h25-4-137" id="h25-4-137" class="i">+    );
</a><a href="#h25-4-138" id="h25-4-138" class="i">+    assert_eq!(c.execute(&quot;COMMIT&quot;).await?, ResultSet::Commit { id: 6 });
</a> 
     // Starting a time-travel txn should work, it shouldn&#39;t see recent changes, and it should
     // block writes
     assert_eq!(
<a href="#h25-4-143" id="h25-4-143" class="d">-        c.query(&quot;BEGIN READ ONLY AS OF SYSTEM TIME 1&quot;)?,
</a><a href="#h25-4-144" id="h25-4-144" class="i">+        c.execute(&quot;BEGIN READ ONLY AS OF SYSTEM TIME 1&quot;).await?,
</a>         ResultSet::Begin { id: 7, mode: Mode::Snapshot { version: 1 } }
     );
<a href="#h25-4-147" id="h25-4-147" class="d">-    assert_eq!(c.txn(), Some((7, Mode::Snapshot { version: 1 })));
</a>     assert_rows(
<a href="#h25-4-149" id="h25-4-149" class="d">-        c.query(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h25-4-150" id="h25-4-150" class="i">+        c.execute(&quot;SELECT * FROM genres&quot;).await?,
</a>         vec![
             vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
             vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
             vec![Value::Integer(3), Value::String(&quot;Comedy&quot;.into())],
         ],
     );
<a href="#h25-4-157" id="h25-4-157" class="d">-    assert_eq!(c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;), Err(Error::ReadOnly));
</a><a href="#h25-4-158" id="h25-4-158" class="d">-    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 7 });
</a><a href="#h25-4-159" id="h25-4-159" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-160" id="h25-4-160" class="i">+    assert_eq!(c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;).await, Err(Error::ReadOnly));
</a><a href="#h25-4-161" id="h25-4-161" class="i">+    assert_eq!(c.execute(&quot;COMMIT&quot;).await?, ResultSet::Commit { id: 7 });
</a> 
     // A txn should still be usable after an error occurs
<a href="#h25-4-164" id="h25-4-164" class="d">-    assert_eq!(c.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 8, mode: Mode::ReadWrite });
</a><a href="#h25-4-165" id="h25-4-165" class="d">-    c.query(&quot;INSERT INTO genres VALUES (5, &#39;Horror&#39;)&quot;)?;
</a><a href="#h25-4-166" id="h25-4-166" class="i">+    assert_eq!(c.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 8, mode: Mode::ReadWrite });
</a><a href="#h25-4-167" id="h25-4-167" class="i">+    c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Horror&#39;)&quot;).await?;
</a>     assert_eq!(
<a href="#h25-4-169" id="h25-4-169" class="d">-        c.query(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;),
</a><a href="#h25-4-170" id="h25-4-170" class="i">+        c.execute(&quot;INSERT INTO genres VALUES (5, &#39;Musical&#39;)&quot;).await,
</a>         Err(Error::Value(&quot;Primary key 5 already exists for table genres&quot;.into()))
     );
<a href="#h25-4-173" id="h25-4-173" class="d">-    c.query(&quot;INSERT INTO genres VALUES (6, &#39;Western&#39;)&quot;)?;
</a><a href="#h25-4-174" id="h25-4-174" class="d">-    assert_eq!(c.txn(), Some((8, Mode::ReadWrite)));
</a><a href="#h25-4-175" id="h25-4-175" class="d">-    assert_eq!(c.query(&quot;COMMIT&quot;)?, ResultSet::Commit { id: 8 });
</a><a href="#h25-4-176" id="h25-4-176" class="d">-    assert_eq!(c.txn(), None);
</a><a href="#h25-4-177" id="h25-4-177" class="i">+    c.execute(&quot;INSERT INTO genres VALUES (6, &#39;Western&#39;)&quot;).await?;
</a><a href="#h25-4-178" id="h25-4-178" class="i">+    assert_eq!(c.execute(&quot;COMMIT&quot;).await?, ResultSet::Commit { id: 8 });
</a>     assert_rows(
<a href="#h25-4-180" id="h25-4-180" class="d">-        c.query(&quot;SELECT * FROM genres&quot;)?,
</a><a href="#h25-4-181" id="h25-4-181" class="i">+        c.execute(&quot;SELECT * FROM genres&quot;).await?,
</a>         vec![
             vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
             vec![Value::Integer(2), Value::String(&quot;Action&quot;.into())],
<a href="#h25-5" id="h25-5" class="h">@@ -378,103 +357,42 @@ fn query_txn() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h25-5-3" id="h25-5-3" class="d">-#[test]
</a><a href="#h25-5-4" id="h25-5-4" class="i">+#[tokio::test]
</a> #[serial]
<a href="#h25-5-6" id="h25-5-6" class="d">-fn query_txn_concurrent() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-5-7" id="h25-5-7" class="d">-    let (mut a, teardown) = setup_movies()?;
</a><a href="#h25-5-8" id="h25-5-8" class="d">-    let mut b = toydb::Client::new(&quot;127.0.0.1&quot;, 9605)?;
</a><a href="#h25-5-9" id="h25-5-9" class="i">+async fn query_txn_concurrent() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-5-10" id="h25-5-10" class="i">+    let (a, teardown) = setup_movies().await?;
</a><a href="#h25-5-11" id="h25-5-11" class="i">+    let b = Client::new(&quot;127.0.0.1:9605&quot;).await?;
</a>     defer!(teardown());
 
     // Concurrent updates should throw a serialization failure on conflict.
<a href="#h25-5-15" id="h25-5-15" class="d">-    assert_eq!(a.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
</a><a href="#h25-5-16" id="h25-5-16" class="d">-    assert_eq!(b.query(&quot;BEGIN&quot;)?, ResultSet::Begin { id: 3, mode: Mode::ReadWrite });
</a><a href="#h25-5-17" id="h25-5-17" class="i">+    assert_eq!(a.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
</a><a href="#h25-5-18" id="h25-5-18" class="i">+    assert_eq!(b.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 3, mode: Mode::ReadWrite });
</a> 
<a href="#h25-5-20" id="h25-5-20" class="d">-    assert_rows(
</a><a href="#h25-5-21" id="h25-5-21" class="d">-        a.query(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h25-5-22" id="h25-5-22" class="d">-        vec![vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())]],
</a><a href="#h25-5-23" id="h25-5-23" class="i">+    assert_row(
</a><a href="#h25-5-24" id="h25-5-24" class="i">+        a.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;).await?,
</a><a href="#h25-5-25" id="h25-5-25" class="i">+        vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a>     );
<a href="#h25-5-27" id="h25-5-27" class="d">-    assert_rows(
</a><a href="#h25-5-28" id="h25-5-28" class="d">-        b.query(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h25-5-29" id="h25-5-29" class="d">-        vec![vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())]],
</a><a href="#h25-5-30" id="h25-5-30" class="i">+    assert_row(
</a><a href="#h25-5-31" id="h25-5-31" class="i">+        b.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;).await?,
</a><a href="#h25-5-32" id="h25-5-32" class="i">+        vec![Value::Integer(1), Value::String(&quot;Science Fiction&quot;.into())],
</a>     );
 
     assert_eq!(
<a href="#h25-5-36" id="h25-5-36" class="d">-        a.query(&quot;UPDATE genres SET name = &#39;x&#39; WHERE id = 1&quot;),
</a><a href="#h25-5-37" id="h25-5-37" class="i">+        a.execute(&quot;UPDATE genres SET name = &#39;x&#39; WHERE id = 1&quot;).await,
</a>         Ok(ResultSet::Update { count: 1 })
     );
<a href="#h25-5-40" id="h25-5-40" class="d">-    assert_eq!(b.query(&quot;UPDATE genres SET name = &#39;y&#39; WHERE id = 1&quot;), Err(Error::Serialization));
</a><a href="#h25-5-41" id="h25-5-41" class="d">-
</a><a href="#h25-5-42" id="h25-5-42" class="d">-    assert_eq!(a.query(&quot;COMMIT&quot;), Ok(ResultSet::Commit { id: 2 }));
</a><a href="#h25-5-43" id="h25-5-43" class="d">-    assert_eq!(b.query(&quot;ROLLBACK&quot;), Ok(ResultSet::Rollback { id: 3 }));
</a><a href="#h25-5-44" id="h25-5-44" class="d">-
</a><a href="#h25-5-45" id="h25-5-45" class="d">-    assert_rows(
</a><a href="#h25-5-46" id="h25-5-46" class="d">-        a.query(&quot;SELECT * FROM genres WHERE id = 1&quot;)?,
</a><a href="#h25-5-47" id="h25-5-47" class="d">-        vec![vec![Value::Integer(1), Value::String(&quot;x&quot;.into())]],
</a><a href="#h25-5-48" id="h25-5-48" class="d">-    );
</a><a href="#h25-5-49" id="h25-5-49" class="d">-
</a><a href="#h25-5-50" id="h25-5-50" class="d">-    Ok(())
</a><a href="#h25-5-51" id="h25-5-51" class="d">-}
</a><a href="#h25-5-52" id="h25-5-52" class="d">-
</a><a href="#h25-5-53" id="h25-5-53" class="d">-#[test]
</a><a href="#h25-5-54" id="h25-5-54" class="d">-#[serial]
</a><a href="#h25-5-55" id="h25-5-55" class="d">-fn with_txn() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h25-5-56" id="h25-5-56" class="d">-    let (mut a, teardown) = setup_movies()?;
</a><a href="#h25-5-57" id="h25-5-57" class="d">-    let mut b = toydb::Client::new(&quot;127.0.0.1&quot;, 9605)?;
</a><a href="#h25-5-58" id="h25-5-58" class="d">-    b.txn_retries = 4;
</a><a href="#h25-5-59" id="h25-5-59" class="d">-    defer!(teardown());
</a><a href="#h25-5-60" id="h25-5-60" class="d">-
</a><a href="#h25-5-61" id="h25-5-61" class="d">-    // We first let with_txn() time out after retrying.
</a><a href="#h25-5-62" id="h25-5-62" class="d">-    let start = std::time::Instant::now();
</a><a href="#h25-5-63" id="h25-5-63" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h25-5-64" id="h25-5-64" class="d">-    a.query(&quot;UPDATE genres SET name = &#39;x&#39; WHERE id = 1&quot;)?;
</a><a href="#h25-5-65" id="h25-5-65" class="d">-
</a>     assert_eq!(
<a href="#h25-5-67" id="h25-5-67" class="d">-        b.with_txn(|t| {
</a><a href="#h25-5-68" id="h25-5-68" class="d">-            t.query(&quot;UPDATE genres SET name = &#39;y&#39; WHERE id = 1&quot;)?;
</a><a href="#h25-5-69" id="h25-5-69" class="d">-            Ok(())
</a><a href="#h25-5-70" id="h25-5-70" class="d">-        }),
</a><a href="#h25-5-71" id="h25-5-71" class="i">+        b.execute(&quot;UPDATE genres SET name = &#39;y&#39; WHERE id = 1&quot;).await,
</a>         Err(Error::Serialization)
     );
<a href="#h25-5-74" id="h25-5-74" class="d">-    assert_eq!(b.txn(), None);
</a><a href="#h25-5-75" id="h25-5-75" class="d">-    assert!(start.elapsed() &gt; std::time::Duration::from_millis(500));
</a><a href="#h25-5-76" id="h25-5-76" class="d">-    a.query(&quot;ROLLBACK&quot;)?;
</a><a href="#h25-5-77" id="h25-5-77" class="d">-
</a><a href="#h25-5-78" id="h25-5-78" class="d">-    // We then start two txns, and commit the first after 200 ms. Both should be committed, and we
</a><a href="#h25-5-79" id="h25-5-79" class="d">-    // should see both changes.
</a><a href="#h25-5-80" id="h25-5-80" class="d">-    assert_rows(
</a><a href="#h25-5-81" id="h25-5-81" class="d">-        a.query(&quot;SELECT id, released FROM movies WHERE id = 10&quot;)?,
</a><a href="#h25-5-82" id="h25-5-82" class="d">-        vec![vec![Value::Integer(10), Value::Integer(2010)]],
</a><a href="#h25-5-83" id="h25-5-83" class="d">-    );
</a> 
<a href="#h25-5-85" id="h25-5-85" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h25-5-86" id="h25-5-86" class="d">-    a.query(&quot;UPDATE movies SET released = released + 1 WHERE id = 10&quot;)?;
</a><a href="#h25-5-87" id="h25-5-87" class="d">-    std::thread::spawn(move || {
</a><a href="#h25-5-88" id="h25-5-88" class="d">-        std::thread::sleep(std::time::Duration::from_millis(200));
</a><a href="#h25-5-89" id="h25-5-89" class="d">-        a.query(&quot;COMMIT&quot;).unwrap()
</a><a href="#h25-5-90" id="h25-5-90" class="d">-    });
</a><a href="#h25-5-91" id="h25-5-91" class="i">+    assert_eq!(a.execute(&quot;COMMIT&quot;).await, Ok(ResultSet::Commit { id: 2 }));
</a><a href="#h25-5-92" id="h25-5-92" class="i">+    assert_eq!(b.execute(&quot;ROLLBACK&quot;).await, Ok(ResultSet::Rollback { id: 3 }));
</a> 
<a href="#h25-5-94" id="h25-5-94" class="d">-    assert_matches!(
</a><a href="#h25-5-95" id="h25-5-95" class="d">-        b.with_txn(|t| {
</a><a href="#h25-5-96" id="h25-5-96" class="d">-            t.query(&quot;UPDATE movies SET released = released + 1 WHERE id = 10&quot;)?;
</a><a href="#h25-5-97" id="h25-5-97" class="d">-            Ok(())
</a><a href="#h25-5-98" id="h25-5-98" class="d">-        }),
</a><a href="#h25-5-99" id="h25-5-99" class="d">-        Ok(ResultSet::Commit { .. })
</a><a href="#h25-5-100" id="h25-5-100" class="d">-    );
</a><a href="#h25-5-101" id="h25-5-101" class="d">-    assert_eq!(b.txn(), None);
</a><a href="#h25-5-102" id="h25-5-102" class="d">-
</a><a href="#h25-5-103" id="h25-5-103" class="d">-    assert_rows(
</a><a href="#h25-5-104" id="h25-5-104" class="d">-        b.query(&quot;SELECT id, released FROM movies WHERE id = 10&quot;)?,
</a><a href="#h25-5-105" id="h25-5-105" class="d">-        vec![vec![Value::Integer(10), Value::Integer(2012)]],
</a><a href="#h25-5-106" id="h25-5-106" class="i">+    assert_row(
</a><a href="#h25-5-107" id="h25-5-107" class="i">+        a.execute(&quot;SELECT * FROM genres WHERE id = 1&quot;).await?,
</a><a href="#h25-5-108" id="h25-5-108" class="i">+        vec![Value::Integer(1), Value::String(&quot;x&quot;.into())],
</a>     );
 
     Ok(())
 }
<a href="#h25-5-113" id="h25-5-113" class="d">-
</a><a href="#h25-5-114" id="h25-5-114" class="d">-fn assert_rows(result: ResultSet, expect: Vec&lt;Row&gt;) {
</a><a href="#h25-5-115" id="h25-5-115" class="d">-    match result {
</a><a href="#h25-5-116" id="h25-5-116" class="d">-        ResultSet::Query { relation: Relation { rows: Some(rows), .. } } =&gt; {
</a><a href="#h25-5-117" id="h25-5-117" class="d">-            assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap(), expect)
</a><a href="#h25-5-118" id="h25-5-118" class="d">-        }
</a><a href="#h25-5-119" id="h25-5-119" class="d">-        r =&gt; panic!(&quot;Unexpected result {:?}&quot;, r),
</a><a href="#h25-5-120" id="h25-5-120" class="d">-    }
</a><a href="#h25-5-121" id="h25-5-121" class="d">-}
</a><b>diff --git a/<a id="h26" href="../file/tests/cluster/isolation.rs.html">tests/cluster/isolation.rs</a> b/<a href="../file/tests/cluster/isolation.rs.html">tests/cluster/isolation.rs</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -7,139 +7,142 @@ use super::super::util::{assert_row, assert_rows};
</a> use pretty_assertions::assert_eq;
 use serial_test::serial;
 
<a href="#h26-0-3" id="h26-0-3" class="d">-#[test]
</a><a href="#h26-0-4" id="h26-0-4" class="i">+#[tokio::test]
</a> #[serial]
 // A dirty write is when b overwrites an uncommitted value written by a.
<a href="#h26-0-7" id="h26-0-7" class="d">-fn anomaly_dirty_write() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-8" id="h26-0-8" class="d">-    let (mut a, mut b, _, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-9" id="h26-0-9" class="i">+async fn anomaly_dirty_write() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-10" id="h26-0-10" class="i">+    let (a, b, _, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-13" id="h26-0-13" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-14" id="h26-0-14" class="d">-    a.query(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h26-0-15" id="h26-0-15" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-16" id="h26-0-16" class="i">+    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;).await?;
</a> 
<a href="#h26-0-18" id="h26-0-18" class="d">-    assert_eq!(b.query(&quot;INSERT INTO test VALUES (1, &#39;b&#39;)&quot;), Err(Error::Serialization));
</a><a href="#h26-0-19" id="h26-0-19" class="i">+    assert_eq!(b.execute(&quot;INSERT INTO test VALUES (1, &#39;b&#39;)&quot;).await, Err(Error::Serialization));
</a> 
<a href="#h26-0-21" id="h26-0-21" class="d">-    a.query(&quot;COMMIT&quot;)?;
</a><a href="#h26-0-22" id="h26-0-22" class="i">+    a.execute(&quot;COMMIT&quot;).await?;
</a>     assert_row(
<a href="#h26-0-24" id="h26-0-24" class="d">-        a.query(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h26-0-25" id="h26-0-25" class="i">+        a.execute(&quot;SELECT * FROM test WHERE id = 1&quot;).await?,
</a>         vec![Value::Integer(1), Value::String(&quot;a&quot;.into())],
     );
 
     Ok(())
 }
 
<a href="#h26-0-32" id="h26-0-32" class="d">-#[test]
</a><a href="#h26-0-33" id="h26-0-33" class="i">+#[tokio::test]
</a> #[serial]
 // A dirty read is when b can read an uncommitted value set by a.
<a href="#h26-0-36" id="h26-0-36" class="d">-fn anomaly_dirty_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-37" id="h26-0-37" class="d">-    let (mut a, mut b, _, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-38" id="h26-0-38" class="i">+async fn anomaly_dirty_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-39" id="h26-0-39" class="i">+    let (a, b, _, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-42" id="h26-0-42" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-43" id="h26-0-43" class="d">-    a.query(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;)?;
</a><a href="#h26-0-44" id="h26-0-44" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-45" id="h26-0-45" class="i">+    a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;).await?;
</a> 
<a href="#h26-0-47" id="h26-0-47" class="d">-    assert_rows(b.query(&quot;SELECT * FROM test&quot;)?, vec![]);
</a><a href="#h26-0-48" id="h26-0-48" class="i">+    assert_rows(b.execute(&quot;SELECT * FROM test&quot;).await?, vec![]);
</a> 
     Ok(())
 }
 
<a href="#h26-0-53" id="h26-0-53" class="d">-#[test]
</a><a href="#h26-0-54" id="h26-0-54" class="i">+#[tokio::test]
</a> #[serial]
 // A lost update is when a and b both read a value and update it, where b&#39;s update replaces a.
<a href="#h26-0-57" id="h26-0-57" class="d">-fn anomaly_lost_update() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-58" id="h26-0-58" class="d">-    let (mut a, mut b, mut c, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-59" id="h26-0-59" class="i">+async fn anomaly_lost_update() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-60" id="h26-0-60" class="i">+    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-63" id="h26-0-63" class="d">-    c.query(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;)?;
</a><a href="#h26-0-64" id="h26-0-64" class="i">+    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;).await?;
</a> 
<a href="#h26-0-66" id="h26-0-66" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-67" id="h26-0-67" class="d">-    b.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-68" id="h26-0-68" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-69" id="h26-0-69" class="i">+    b.execute(&quot;BEGIN&quot;).await?;
</a> 
<a href="#h26-0-71" id="h26-0-71" class="d">-    a.query(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;)?;
</a><a href="#h26-0-72" id="h26-0-72" class="d">-    assert_eq!(b.query(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 1&quot;), Err(Error::Serialization));
</a><a href="#h26-0-73" id="h26-0-73" class="d">-    a.query(&quot;COMMIT&quot;)?;
</a><a href="#h26-0-74" id="h26-0-74" class="i">+    a.execute(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;).await?;
</a><a href="#h26-0-75" id="h26-0-75" class="i">+    assert_eq!(
</a><a href="#h26-0-76" id="h26-0-76" class="i">+        b.execute(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 1&quot;).await,
</a><a href="#h26-0-77" id="h26-0-77" class="i">+        Err(Error::Serialization)
</a><a href="#h26-0-78" id="h26-0-78" class="i">+    );
</a><a href="#h26-0-79" id="h26-0-79" class="i">+    a.execute(&quot;COMMIT&quot;).await?;
</a> 
     assert_row(
<a href="#h26-0-82" id="h26-0-82" class="d">-        c.query(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h26-0-83" id="h26-0-83" class="i">+        c.execute(&quot;SELECT * FROM test WHERE id = 1&quot;).await?,
</a>         vec![Value::Integer(1), Value::String(&quot;a&quot;.into())],
     );
 
     Ok(())
 }
 
<a href="#h26-0-90" id="h26-0-90" class="d">-#[test]
</a><a href="#h26-0-91" id="h26-0-91" class="i">+#[tokio::test]
</a> #[serial]
 // A fuzzy (or unrepeatable) read is when b sees a value change after a updates it.
<a href="#h26-0-94" id="h26-0-94" class="d">-fn anomaly_fuzzy_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-95" id="h26-0-95" class="d">-    let (mut a, mut b, mut c, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-96" id="h26-0-96" class="i">+async fn anomaly_fuzzy_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-97" id="h26-0-97" class="i">+    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-100" id="h26-0-100" class="d">-    c.query(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;)?;
</a><a href="#h26-0-101" id="h26-0-101" class="i">+    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;).await?;
</a> 
<a href="#h26-0-103" id="h26-0-103" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-104" id="h26-0-104" class="d">-    b.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-105" id="h26-0-105" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-106" id="h26-0-106" class="i">+    b.execute(&quot;BEGIN&quot;).await?;
</a> 
     assert_row(
<a href="#h26-0-109" id="h26-0-109" class="d">-        b.query(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h26-0-110" id="h26-0-110" class="i">+        b.execute(&quot;SELECT * FROM test WHERE id = 1&quot;).await?,
</a>         vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
     );
<a href="#h26-0-113" id="h26-0-113" class="d">-    a.query(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;)?;
</a><a href="#h26-0-114" id="h26-0-114" class="d">-    a.query(&quot;COMMIT&quot;)?;
</a><a href="#h26-0-115" id="h26-0-115" class="i">+    a.execute(&quot;UPDATE test SET value = &#39;a&#39; WHERE id = 1&quot;).await?;
</a><a href="#h26-0-116" id="h26-0-116" class="i">+    a.execute(&quot;COMMIT&quot;).await?;
</a>     assert_row(
<a href="#h26-0-118" id="h26-0-118" class="d">-        b.query(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h26-0-119" id="h26-0-119" class="i">+        b.execute(&quot;SELECT * FROM test WHERE id = 1&quot;).await?,
</a>         vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
     );
 
     Ok(())
 }
 
<a href="#h26-0-126" id="h26-0-126" class="d">-#[test]
</a><a href="#h26-0-127" id="h26-0-127" class="i">+#[tokio::test]
</a> #[serial]
 // Read skew is when a reads 1 and 2, but b modifies 2 in between the reads.
<a href="#h26-0-130" id="h26-0-130" class="d">-fn anomaly_read_skew() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-131" id="h26-0-131" class="d">-    let (mut a, mut b, mut c, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-132" id="h26-0-132" class="i">+async fn anomaly_read_skew() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-133" id="h26-0-133" class="i">+    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-136" id="h26-0-136" class="d">-    c.query(&quot;INSERT INTO test VALUES (1, &#39;c&#39;), (2, &#39;c&#39;)&quot;)?;
</a><a href="#h26-0-137" id="h26-0-137" class="i">+    c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;), (2, &#39;c&#39;)&quot;).await?;
</a> 
<a href="#h26-0-139" id="h26-0-139" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-140" id="h26-0-140" class="d">-    b.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-141" id="h26-0-141" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-142" id="h26-0-142" class="i">+    b.execute(&quot;BEGIN&quot;).await?;
</a> 
     assert_row(
<a href="#h26-0-145" id="h26-0-145" class="d">-        a.query(&quot;SELECT * FROM test WHERE id = 1&quot;)?,
</a><a href="#h26-0-146" id="h26-0-146" class="i">+        a.execute(&quot;SELECT * FROM test WHERE id = 1&quot;).await?,
</a>         vec![Value::Integer(1), Value::String(&quot;c&quot;.into())],
     );
<a href="#h26-0-149" id="h26-0-149" class="d">-    b.query(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 2&quot;)?;
</a><a href="#h26-0-150" id="h26-0-150" class="d">-    b.query(&quot;COMMIT&quot;)?;
</a><a href="#h26-0-151" id="h26-0-151" class="i">+    b.execute(&quot;UPDATE test SET value = &#39;b&#39; WHERE id = 2&quot;).await?;
</a><a href="#h26-0-152" id="h26-0-152" class="i">+    b.execute(&quot;COMMIT&quot;).await?;
</a>     assert_row(
<a href="#h26-0-154" id="h26-0-154" class="d">-        a.query(&quot;SELECT * FROM test WHERE id = 2&quot;)?,
</a><a href="#h26-0-155" id="h26-0-155" class="i">+        a.execute(&quot;SELECT * FROM test WHERE id = 2&quot;).await?,
</a>         vec![Value::Integer(2), Value::String(&quot;c&quot;.into())],
     );
 
     Ok(())
 }
 
<a href="#h26-0-162" id="h26-0-162" class="d">-#[test]
</a><a href="#h26-0-163" id="h26-0-163" class="i">+#[tokio::test]
</a> #[serial]
 // A phantom read is when a reads entries matching some predicate, but a modification by
 // b changes the entries that match the predicate such that a later read by a returns them.
<a href="#h26-0-167" id="h26-0-167" class="d">-fn anomaly_phantom_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-168" id="h26-0-168" class="d">-    let (mut a, mut b, mut c, teardown) = setup::cluster_simple()?;
</a><a href="#h26-0-169" id="h26-0-169" class="i">+async fn anomaly_phantom_read() -&gt; Result&lt;(), Error&gt; {
</a><a href="#h26-0-170" id="h26-0-170" class="i">+    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a>     defer!(teardown());
 
<a href="#h26-0-173" id="h26-0-173" class="d">-    c.query(&quot;INSERT INTO test VALUES (1, &#39;true&#39;), (2, &#39;false&#39;)&quot;)?;
</a><a href="#h26-0-174" id="h26-0-174" class="i">+    c.execute(&quot;INSERT INTO test VALUES (1, &#39;true&#39;), (2, &#39;false&#39;)&quot;).await?;
</a> 
<a href="#h26-0-176" id="h26-0-176" class="d">-    a.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-177" id="h26-0-177" class="d">-    b.query(&quot;BEGIN&quot;)?;
</a><a href="#h26-0-178" id="h26-0-178" class="i">+    a.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h26-0-179" id="h26-0-179" class="i">+    b.execute(&quot;BEGIN&quot;).await?;
</a> 
     assert_rows(
<a href="#h26-0-182" id="h26-0-182" class="d">-        a.query(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;)?,
</a><a href="#h26-0-183" id="h26-0-183" class="i">+        a.execute(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;).await?,
</a>         vec![vec![Value::Integer(1), Value::String(&quot;true&quot;.into())]],
     );
<a href="#h26-0-186" id="h26-0-186" class="d">-    b.query(&quot;UPDATE test SET value = &#39;true&#39; WHERE id = 2&quot;)?;
</a><a href="#h26-0-187" id="h26-0-187" class="d">-    b.query(&quot;COMMIT&quot;)?;
</a><a href="#h26-0-188" id="h26-0-188" class="i">+    b.execute(&quot;UPDATE test SET value = &#39;true&#39; WHERE id = 2&quot;).await?;
</a><a href="#h26-0-189" id="h26-0-189" class="i">+    b.execute(&quot;COMMIT&quot;).await?;
</a>     assert_rows(
<a href="#h26-0-191" id="h26-0-191" class="d">-        a.query(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;)?,
</a><a href="#h26-0-192" id="h26-0-192" class="i">+        a.execute(&quot;SELECT * FROM test WHERE value = &#39;true&#39;&quot;).await?,
</a>         vec![vec![Value::Integer(1), Value::String(&quot;true&quot;.into())]],
     );
 
<b>diff --git a/<a id="h27" href="../file/tests/setup.rs.html">tests/setup.rs</a> b/<a href="../file/tests/setup.rs.html">tests/setup.rs</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -5,36 +5,66 @@ use toydb::client::Client;
</a> use toydb::server::Server;
 use toydb::Error;
 
<a href="#h27-0-3" id="h27-0-3" class="i">+use futures_util::future::FutureExt as _;
</a> use pretty_assertions::assert_eq;
 use std::collections::HashMap;
 
 /// Sets up a test server, returning a teardown closure
<a href="#h27-0-8" id="h27-0-8" class="d">-pub fn server(
</a><a href="#h27-0-9" id="h27-0-9" class="i">+pub async fn server(
</a>     id: &amp;str,
<a href="#h27-0-11" id="h27-0-11" class="d">-    addr: &amp;str,
</a><a href="#h27-0-12" id="h27-0-12" class="i">+    addr_sql: &amp;str,
</a><a href="#h27-0-13" id="h27-0-13" class="i">+    addr_raft: &amp;str,
</a>     peers: HashMap&lt;String, String&gt;,
 ) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Error&gt; {
<a href="#h27-0-16" id="h27-0-16" class="d">-    let data_dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h27-0-17" id="h27-0-17" class="d">-    let mut srv = Server::new(
</a><a href="#h27-0-18" id="h27-0-18" class="i">+    let addr_sql = addr_sql.to_string();
</a><a href="#h27-0-19" id="h27-0-19" class="i">+    let addr_raft = addr_raft.to_string();
</a><a href="#h27-0-20" id="h27-0-20" class="i">+
</a><a href="#h27-0-21" id="h27-0-21" class="i">+    let data_dir = tempdir::TempDir::new(&quot;toydb&quot;).unwrap();
</a><a href="#h27-0-22" id="h27-0-22" class="i">+    let srv = Server::new(
</a>         id,
         peers.into_iter().map(|(k, v)| (k, v.parse().unwrap())).collect(),
         &amp;data_dir.path().to_string_lossy(),
     )?;
<a href="#h27-0-27" id="h27-0-27" class="d">-    srv.listen(addr, 4)?;
</a><a href="#h27-0-28" id="h27-0-28" class="i">+
</a><a href="#h27-0-29" id="h27-0-29" class="i">+    let (f, abort) = srv.listen(addr_sql.to_string(), addr_raft.to_string()).remote_handle();
</a><a href="#h27-0-30" id="h27-0-30" class="i">+
</a><a href="#h27-0-31" id="h27-0-31" class="i">+    tokio::spawn(f);
</a> 
     Ok(Box::new(move || {
<a href="#h27-0-34" id="h27-0-34" class="d">-        srv.shutdown().unwrap();
</a><a href="#h27-0-35" id="h27-0-35" class="d">-        std::mem::drop(data_dir)
</a><a href="#h27-0-36" id="h27-0-36" class="i">+        std::mem::drop(addr_sql);
</a><a href="#h27-0-37" id="h27-0-37" class="i">+        std::mem::drop(abort);
</a>     }))
 }
 
<a href="#h27-0-41" id="h27-0-41" class="i">+/// Sets up a server with a client
</a><a href="#h27-0-42" id="h27-0-42" class="i">+pub async fn server_with_client() -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h27-0-43" id="h27-0-43" class="i">+    let teardown = server(&quot;test&quot;, &quot;127.0.0.1:9605&quot;, &quot;127.0.0.1:9705&quot;, HashMap::new()).await?;
</a><a href="#h27-0-44" id="h27-0-44" class="i">+    tokio::time::delay_for(std::time::Duration::from_millis(10)).await;
</a><a href="#h27-0-45" id="h27-0-45" class="i">+    let client = Client::new(&quot;127.0.0.1:9605&quot;).await?;
</a><a href="#h27-0-46" id="h27-0-46" class="i">+    Ok((client, teardown))
</a><a href="#h27-0-47" id="h27-0-47" class="i">+}
</a><a href="#h27-0-48" id="h27-0-48" class="i">+
</a><a href="#h27-0-49" id="h27-0-49" class="i">+/// Sets up a server with a client and a s
</a><a href="#h27-0-50" id="h27-0-50" class="i">+pub async fn server_with_queries(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h27-0-51" id="h27-0-51" class="i">+    let (client, teardown) = server_with_client().await?;
</a><a href="#h27-0-52" id="h27-0-52" class="i">+    client.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h27-0-53" id="h27-0-53" class="i">+    for query in queries {
</a><a href="#h27-0-54" id="h27-0-54" class="i">+        client.execute(query).await?;
</a><a href="#h27-0-55" id="h27-0-55" class="i">+    }
</a><a href="#h27-0-56" id="h27-0-56" class="i">+    client.execute(&quot;COMMIT&quot;).await?;
</a><a href="#h27-0-57" id="h27-0-57" class="i">+    Ok((client, teardown))
</a><a href="#h27-0-58" id="h27-0-58" class="i">+}
</a><a href="#h27-0-59" id="h27-0-59" class="i">+
</a> /// Sets up a server cluster, returning a teardown closure
<a href="#h27-0-61" id="h27-0-61" class="d">-pub fn cluster(nodes: HashMap&lt;String, String&gt;) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Error&gt; {
</a><a href="#h27-0-62" id="h27-0-62" class="i">+pub async fn cluster(nodes: HashMap&lt;String, (String, String)&gt;) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Error&gt; {
</a>     let mut teardowns = Vec::new();
<a href="#h27-0-64" id="h27-0-64" class="d">-    for (id, addr) in nodes.iter() {
</a><a href="#h27-0-65" id="h27-0-65" class="d">-        let mut peers = nodes.clone();
</a><a href="#h27-0-66" id="h27-0-66" class="d">-        peers.remove(id);
</a><a href="#h27-0-67" id="h27-0-67" class="d">-        let teardown = server(id, addr, peers)?;
</a><a href="#h27-0-68" id="h27-0-68" class="i">+    for (id, (addr_sql, addr_raft)) in nodes.iter() {
</a><a href="#h27-0-69" id="h27-0-69" class="i">+        let peers = nodes
</a><a href="#h27-0-70" id="h27-0-70" class="i">+            .iter()
</a><a href="#h27-0-71" id="h27-0-71" class="i">+            .filter(|(i, _)| i != &amp;id)
</a><a href="#h27-0-72" id="h27-0-72" class="i">+            .map(|(id, (_, raft))| (id.clone(), raft.clone()))
</a><a href="#h27-0-73" id="h27-0-73" class="i">+            .collect();
</a><a href="#h27-0-74" id="h27-0-74" class="i">+        let teardown = server(id, addr_sql, addr_raft, peers).await?;
</a>         teardowns.push(teardown);
     }
     Ok(Box::new(move || {
<a href="#h27-1" id="h27-1" class="h">@@ -45,34 +75,40 @@ pub fn cluster(nodes: HashMap&lt;String, String&gt;) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Erro
</a> }
 
 /// Sets up a server cluster with clients, returning the clients and a teardown closure
<a href="#h27-1-3" id="h27-1-3" class="d">-pub fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h27-1-4" id="h27-1-4" class="i">+pub async fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a>     let mut nodes = HashMap::new();
     for i in 0..size {
<a href="#h27-1-7" id="h27-1-7" class="d">-        nodes.insert(format!(&quot;toydb{}&quot;, i), format!(&quot;127.0.0.1:{}&quot;, 9605 + i));
</a><a href="#h27-1-8" id="h27-1-8" class="i">+        nodes.insert(
</a><a href="#h27-1-9" id="h27-1-9" class="i">+            format!(&quot;toydb{}&quot;, i),
</a><a href="#h27-1-10" id="h27-1-10" class="i">+            (format!(&quot;127.0.0.1:{}&quot;, 9605 + i), format!(&quot;127.0.0.1:{}&quot;, 9705 + i)),
</a><a href="#h27-1-11" id="h27-1-11" class="i">+        );
</a>     }
<a href="#h27-1-13" id="h27-1-13" class="d">-    let teardown = cluster(nodes.clone())?;
</a><a href="#h27-1-14" id="h27-1-14" class="i">+    let teardown = cluster(nodes.clone()).await?;
</a><a href="#h27-1-15" id="h27-1-15" class="i">+
</a><a href="#h27-1-16" id="h27-1-16" class="i">+    // FIXME Wait for cluster to start listening (should wait for listen future)
</a><a href="#h27-1-17" id="h27-1-17" class="i">+    tokio::time::delay_for(std::time::Duration::from_millis(20)).await;
</a><a href="#h27-1-18" id="h27-1-18" class="i">+
</a>     let mut clients = Vec::&lt;Client&gt;::new();
<a href="#h27-1-20" id="h27-1-20" class="d">-    for (id, addr) in nodes {
</a><a href="#h27-1-21" id="h27-1-21" class="d">-        let mut parts = addr.split(&#39;:&#39;);
</a><a href="#h27-1-22" id="h27-1-22" class="d">-        let client = Client::new(parts.next().unwrap(), parts.next().unwrap().parse()?)?;
</a><a href="#h27-1-23" id="h27-1-23" class="d">-        assert_eq!(id, client.status()?.id);
</a><a href="#h27-1-24" id="h27-1-24" class="i">+    for (id, (addr_sql, _)) in nodes {
</a><a href="#h27-1-25" id="h27-1-25" class="i">+        let client = Client::new(addr_sql).await?;
</a><a href="#h27-1-26" id="h27-1-26" class="i">+        assert_eq!(id, client.status().await?.id);
</a>         clients.push(client);
     }
     Ok((clients, teardown))
 }
 
 /// Sets up a simple cluster with 3 clients and a test table
<a href="#h27-1-33" id="h27-1-33" class="d">-pub fn cluster_simple() -&gt; Result&lt;(Client, Client, Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h27-1-34" id="h27-1-34" class="d">-    let (mut clients, teardown) = cluster_with_clients(3)?;
</a><a href="#h27-1-35" id="h27-1-35" class="d">-    let mut a = clients.remove(0);
</a><a href="#h27-1-36" id="h27-1-36" class="i">+pub async fn cluster_simple() -&gt; Result&lt;(Client, Client, Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h27-1-37" id="h27-1-37" class="i">+    let (mut clients, teardown) = cluster_with_clients(3).await?;
</a><a href="#h27-1-38" id="h27-1-38" class="i">+    let a = clients.remove(0);
</a>     let b = clients.remove(0);
     let c = clients.remove(0);
     assert!(clients.is_empty());
 
     // FIXME Wait for cluster to stabilize, see: https://github.com/erikgrinaker/toydb/issues/19
<a href="#h27-1-44" id="h27-1-44" class="d">-    std::thread::sleep(std::time::Duration::from_millis(2000));
</a><a href="#h27-1-45" id="h27-1-45" class="i">+    tokio::time::delay_for(std::time::Duration::from_millis(2000)).await;
</a> 
<a href="#h27-1-47" id="h27-1-47" class="d">-    a.query(&quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;)?;
</a><a href="#h27-1-48" id="h27-1-48" class="i">+    a.execute(&quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;).await?;
</a> 
     Ok((a, b, c, teardown))
 }
<b>diff --git a/<a id="h28" href="../file/tests/sql/dml.rs.html">tests/sql/dml.rs</a> b/<a href="../file/tests/sql/dml.rs.html">tests/sql/dml.rs</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,6 +1,6 @@
</a> ///! DML-related tests, using an in-memory database against golden files in tests/sql/dml/
 ///! Note that schema-related tests are in schema.rs, this is just for the basic DML functionality
<a href="#h28-0-2" id="h28-0-2" class="d">-use toydb::sql::engine::{Engine as _, Transaction as _};
</a><a href="#h28-0-3" id="h28-0-3" class="i">+use toydb::sql::engine::{Engine as _, Mode, Transaction as _};
</a> use toydb::sql::schema::Catalog as _;
 use toydb::Error;
 
<a href="#h28-1" id="h28-1" class="h">@@ -23,7 +23,7 @@ macro_rules! test_dml {
</a>                 let mut f = mint.new_goldenfile(stringify!($name))?;
 
                 write!(f, &quot;Query: {}\n&quot;, $query.trim())?;
<a href="#h28-1-3" id="h28-1-3" class="d">-                match engine.session(None)?.execute($query) {
</a><a href="#h28-1-4" id="h28-1-4" class="i">+                match engine.session()?.execute($query) {
</a>                     Ok(resultset) =&gt; {
                         write!(f, &quot;Result: {:?}\n\n&quot;, resultset)?;
                     },
<a href="#h28-2" id="h28-2" class="h">@@ -31,7 +31,7 @@ macro_rules! test_dml {
</a>                 };
 
                 write!(f, &quot;Storage:&quot;)?;
<a href="#h28-2-3" id="h28-2-3" class="d">-                let txn = engine.begin()?;
</a><a href="#h28-2-4" id="h28-2-4" class="i">+                let txn = engine.begin(Mode::ReadWrite)?;
</a>                 for table in txn.scan_tables()? {
                     write!(f, &quot;\n{}\n&quot;, table.as_sql())?;
                     for row in txn.scan(&amp;table.name, None)? {
<b>diff --git a/<a id="h29" href="../file/tests/sql/expression.rs.html">tests/sql/expression.rs</a> b/<a href="../file/tests/sql/expression.rs.html">tests/sql/expression.rs</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -6,7 +6,7 @@ use toydb::Error;
</a> 
 fn eval_expr(expr: &amp;str) -&gt; Result&lt;Value, Error&gt; {
     let engine = super::setup(Vec::new())?;
<a href="#h29-0-3" id="h29-0-3" class="d">-    match engine.session(None)?.execute(&amp;format!(&quot;SELECT {}&quot;, expr))? {
</a><a href="#h29-0-4" id="h29-0-4" class="i">+    match engine.session()?.execute(&amp;format!(&quot;SELECT {}&quot;, expr))? {
</a>         ResultSet::Query { mut relation } =&gt; {
             Ok(relation.next().unwrap().unwrap().get(0).unwrap().clone())
         }
<b>diff --git a/<a id="h30" href="../file/tests/sql/mod.rs.html">tests/sql/mod.rs</a> b/<a href="../file/tests/sql/mod.rs.html">tests/sql/mod.rs</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -9,7 +9,7 @@ use toydb::Error;
</a> 
 fn setup(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;KV&lt;kv::storage::Memory&gt;, Error&gt; {
     let engine = KV::new(kv::MVCC::new(kv::storage::Memory::new()));
<a href="#h30-0-3" id="h30-0-3" class="d">-    let mut session = engine.session(None)?;
</a><a href="#h30-0-4" id="h30-0-4" class="i">+    let mut session = engine.session()?;
</a>     session.execute(&quot;BEGIN&quot;)?;
     for query in queries {
         session.execute(query)?;
<b>diff --git a/<a id="h31" href="../file/tests/sql/query.rs.html">tests/sql/query.rs</a> b/<a href="../file/tests/sql/query.rs.html">tests/sql/query.rs</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,6 +1,6 @@
</a> ///! Tests for the SQL query engine. Runs SQL queries against an in-memory database,
 ///! and compares the results with golden files stored under tests/sql/query/
<a href="#h31-0-2" id="h31-0-2" class="d">-use toydb::sql::engine::{Engine, Transaction};
</a><a href="#h31-0-3" id="h31-0-3" class="i">+use toydb::sql::engine::{Engine, Mode, Transaction};
</a> use toydb::sql::execution::{Context, ResultSet};
 use toydb::sql::parser::Parser;
 use toydb::sql::plan::Plan;
<a href="#h31-1" id="h31-1" class="h">@@ -96,7 +96,7 @@ macro_rules! test_query {
</a>             };
             write!(f, &quot;{:#?}\n\n&quot;, plan)?;
 
<a href="#h31-1-3" id="h31-1-3" class="d">-            let mut txn = engine.begin()?;
</a><a href="#h31-1-4" id="h31-1-4" class="i">+            let mut txn = engine.begin(Mode::ReadWrite)?;
</a>             write!(f, &quot;Optimized plan: &quot;)?;
             let plan = match plan.optimize(&amp;mut txn) {
                 Ok(plan) =&gt; plan,
<b>diff --git a/<a id="h32" href="../file/tests/sql/schema.rs.html">tests/sql/schema.rs</a> b/<a href="../file/tests/sql/schema.rs.html">tests/sql/schema.rs</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,5 +1,5 @@
</a> ///! Schema-related tests, using an in-memory database against golden files in tests/sql/chema/
<a href="#h32-0-1" id="h32-0-1" class="d">-use toydb::sql::engine::{Engine as _, Transaction as _};
</a><a href="#h32-0-2" id="h32-0-2" class="i">+use toydb::sql::engine::{Engine as _, Mode, Transaction as _};
</a> use toydb::sql::schema::Catalog as _;
 use toydb::Error;
 
<a href="#h32-1" id="h32-1" class="h">@@ -22,13 +22,13 @@ macro_rules! test_schema {
</a>                 let mut f = mint.new_goldenfile(stringify!($name))?;
 
                 write!(f, &quot;Query: {}\n&quot;, $query.trim())?;
<a href="#h32-1-3" id="h32-1-3" class="d">-                match engine.session(None)?.execute($query) {
</a><a href="#h32-1-4" id="h32-1-4" class="i">+                match engine.session()?.execute($query) {
</a>                     Ok(result) =&gt; write!(f, &quot;Result: {:?}\n\n&quot;, result)?,
                     Err(err) =&gt; write!(f, &quot;Error: {:?}\n\n&quot;, err)?,
                 };
 
                 write!(f, &quot;Storage:&quot;)?;
<a href="#h32-1-10" id="h32-1-10" class="d">-                let txn = engine.begin()?;
</a><a href="#h32-1-11" id="h32-1-11" class="i">+                let txn = engine.begin(Mode::ReadWrite)?;
</a>                 for table in txn.scan_tables()? {
                     write!(f, &quot;\n{}\n&quot;, table.as_sql())?;
                     for row in txn.scan(&amp;table.name, None)? {
<b>diff --git a/<a id="h33" href="../file/tests/tests.rs.html">tests/tests.rs</a> b/<a href="../file/tests/tests.rs.html">tests/tests.rs</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -1,8 +1,6 @@
</a> #![warn(clippy::all)]
 
 #[macro_use]
<a href="#h33-0-3" id="h33-0-3" class="d">-extern crate assert_matches;
</a><a href="#h33-0-4" id="h33-0-4" class="d">-#[macro_use]
</a> extern crate scopeguard;
 extern crate serial_test;
 extern crate tempdir;
</pre>
</div>
</body>
</html>
