<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Initial Raft implementation. - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/dbbde02e3d9d811c3ec9d66dae2eb3b7a8944082.html">dbbde02e3d9d811c3ec9d66dae2eb3b7a8944082</a>
<b>parent</b> <a href="../commit/41d1312271c4d6daa0419803ebce0bcfc8c3b6c1.html">41d1312271c4d6daa0419803ebce0bcfc8c3b6c1</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 18 Aug 2019 21:01:32 +0200

Initial Raft implementation.

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.dockerignore</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">.gitignore</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">Cargo.lock</a></td><td> | </td><td class="num">161</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">Cargo.toml</a></td><td> | </td><td class="num">12</td><td><span class="i">+++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">README.md</a></td><td> | </td><td class="num">55</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">build.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">config/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">protobuf/raft.proto</a></td><td> | </td><td class="num">82</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">protobuf/toydb.proto</a></td><td> | </td><td class="num">29</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">sandbox/docker-compose.yml</a></td><td> | </td><td class="num">66</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h10">sandbox/toydb-a.yml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">sandbox/toydb-a/data/.gitkeep</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">sandbox/toydb-a/toydb.yaml</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h13">sandbox/toydb-b.yml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">sandbox/toydb-b/data/.gitkeep</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">sandbox/toydb-b/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h16">sandbox/toydb-c.yml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">sandbox/toydb-c/data/.gitkeep</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">sandbox/toydb-c/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h19">sandbox/toydb-d.yml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">sandbox/toydb-d/data/.gitkeep</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">sandbox/toydb-d/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">sandbox/toydb-e.yml</a></td><td> | </td><td class="num">2</td><td><span class="i"></span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">sandbox/toydb-e/data/.gitkeep</a></td><td> | </td><td class="num">0</td><td><span class="i"></span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h24">sandbox/toydb-e/toydb.yaml</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h25">src/bin/toydb.rs</a></td><td> | </td><td class="num">43</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/error.rs</a></td><td> | </td><td class="num">51</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="D">D</td><td><a href="#h27">src/kv.rs</a></td><td> | </td><td class="num">75</td><td><span class="i"></span><span class="d">---------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">src/kv/file.rs</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">src/kv/memory.rs</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">src/kv/mod.rs</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">src/lib.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">src/raft/log.rs</a></td><td> | </td><td class="num">678</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">src/raft/mod.rs</a></td><td> | </td><td class="num">186</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">283</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">src/raft/node/follower.rs</a></td><td> | </td><td class="num">865</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h36">src/raft/node/leader.rs</a></td><td> | </td><td class="num">877</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">src/raft/node/mod.rs</a></td><td> | </td><td class="num">470</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h38">src/raft/state.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h39">src/raft/transport.rs</a></td><td> | </td><td class="num">223</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h40">src/server.rs</a></td><td> | </td><td class="num">48</td><td><span class="i"></span><span class="d">------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h41">src/server/mod.rs</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h42">src/server/raft.rs</a></td><td> | </td><td class="num">221</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h43">src/server/toydb.rs</a></td><td> | </td><td class="num">60</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h44">src/service/mod.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h45">src/state.rs</a></td><td> | </td><td class="num">67</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h46">src/utility/deref.rs</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h47">src/utility/mod.rs</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
</table></pre><pre>48 files changed, 4689 insertions(+), 213 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.dockerignore.html">.dockerignore</a> b/<a href="../file/.dockerignore.html">.dockerignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1 +1,2 @@
</a><a href="#h0-0-0" id="h0-0-0" class="i">+sandbox
</a> target
 \ No newline at end of file
<b>diff --git a/<a id="h1" href="../file/.gitignore.html">.gitignore</a> b/<a href="../file/.gitignore.html">.gitignore</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,4 +1,4 @@
</a><a href="#h1-0-0" id="h1-0-0" class="i">+/sandbox/toydb-?/data
</a><a href="#h1-0-1" id="h1-0-1" class="i">+/src/service/*.rs
</a> /target
<a href="#h1-0-3" id="h1-0-3" class="d">-/src/service/toydb.rs
</a><a href="#h1-0-4" id="h1-0-4" class="d">-/src/service/toydb_grpc.rs
</a> **/*.rs.bk
 \ No newline at end of file
<b>diff --git a/<a id="h2" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -34,11 +34,16 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-0-3" id="h2-0-3" class="i">+name = &quot;assert_matches&quot;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+version = &quot;1.3.0&quot;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+
</a><a href="#h2-0-7" id="h2-0-7" class="i">+[[package]]
</a> name = &quot;atty&quot;
 version = &quot;0.2.11&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-0-12" id="h2-0-12" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-0-13" id="h2-0-13" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;termion 1.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
<a href="#h2-1" id="h2-1" class="h">@@ -56,7 +61,7 @@ dependencies = [
</a>  &quot;autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;backtrace-sys 0.1.28 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-1-3" id="h2-1-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-1-4" id="h2-1-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rustc-demangle 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
 
<a href="#h2-2" id="h2-2" class="h">@@ -66,7 +71,7 @@ version = &quot;0.1.28&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;cc 1.0.37 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-2-3" id="h2-2-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-2-4" id="h2-2-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a> ]
 
 [[package]]
<a href="#h2-3" id="h2-3" class="h">@@ -107,6 +112,15 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-3-3" id="h2-3-3" class="i">+name = &quot;c2-chacha&quot;
</a><a href="#h2-3-4" id="h2-3-4" class="i">+version = &quot;0.2.2&quot;
</a><a href="#h2-3-5" id="h2-3-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-3-6" id="h2-3-6" class="i">+dependencies = [
</a><a href="#h2-3-7" id="h2-3-7" class="i">+ &quot;lazy_static 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-3-8" id="h2-3-8" class="i">+ &quot;ppv-lite86 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-3-9" id="h2-3-9" class="i">+]
</a><a href="#h2-3-10" id="h2-3-10" class="i">+
</a><a href="#h2-3-11" id="h2-3-11" class="i">+[[package]]
</a> name = &quot;cc&quot;
 version = &quot;1.0.37&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-4" id="h2-4" class="h">@@ -169,6 +183,15 @@ version = &quot;0.1.3&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h2-4-3" id="h2-4-3" class="i">+name = &quot;crossbeam-channel&quot;
</a><a href="#h2-4-4" id="h2-4-4" class="i">+version = &quot;0.3.8&quot;
</a><a href="#h2-4-5" id="h2-4-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-4-6" id="h2-4-6" class="i">+dependencies = [
</a><a href="#h2-4-7" id="h2-4-7" class="i">+ &quot;crossbeam-utils 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-4-8" id="h2-4-8" class="i">+ &quot;smallvec 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-4-9" id="h2-4-9" class="i">+]
</a><a href="#h2-4-10" id="h2-4-10" class="i">+
</a><a href="#h2-4-11" id="h2-4-11" class="i">+[[package]]
</a> name = &quot;crossbeam-deque&quot;
 version = &quot;0.7.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-5" id="h2-5" class="h">@@ -212,7 +235,7 @@ name = &quot;dirs&quot;
</a> version = &quot;1.0.5&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-5-3" id="h2-5-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-5-4" id="h2-5-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;redox_users 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
<a href="#h2-6" id="h2-6" class="h">@@ -276,6 +299,16 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-6-3" id="h2-6-3" class="i">+name = &quot;getrandom&quot;
</a><a href="#h2-6-4" id="h2-6-4" class="i">+version = &quot;0.1.9&quot;
</a><a href="#h2-6-5" id="h2-6-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-6-6" id="h2-6-6" class="i">+dependencies = [
</a><a href="#h2-6-7" id="h2-6-7" class="i">+ &quot;cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-6-8" id="h2-6-8" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-6-9" id="h2-6-9" class="i">+ &quot;wasi 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-6-10" id="h2-6-10" class="i">+]
</a><a href="#h2-6-11" id="h2-6-11" class="i">+
</a><a href="#h2-6-12" id="h2-6-12" class="i">+[[package]]
</a> name = &quot;grpc&quot;
 version = &quot;0.6.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-7" id="h2-7" class="h">@@ -329,7 +362,7 @@ name = &quot;iovec&quot;
</a> version = &quot;0.1.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-7-3" id="h2-7-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-7-4" id="h2-7-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
 
<a href="#h2-8" id="h2-8" class="h">@@ -364,7 +397,7 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> 
 [[package]]
 name = &quot;libc&quot;
<a href="#h2-8-3" id="h2-8-3" class="d">-version = &quot;0.2.54&quot;
</a><a href="#h2-8-4" id="h2-8-4" class="i">+version = &quot;0.2.62&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h2-9" id="h2-9" class="h">@@ -426,7 +459,7 @@ dependencies = [
</a>  &quot;iovec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;lazycell 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-9-3" id="h2-9-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-9-4" id="h2-9-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;miow 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;net2 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-10" id="h2-10" class="h">@@ -440,7 +473,7 @@ version = &quot;0.6.7&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;iovec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-10-3" id="h2-10-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-10-4" id="h2-10-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;mio 0.6.16 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
 
<a href="#h2-11" id="h2-11" class="h">@@ -461,7 +494,7 @@ version = &quot;0.2.33&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-11-3" id="h2-11-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-11-4" id="h2-11-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
 
<a href="#h2-12" id="h2-12" class="h">@@ -505,7 +538,7 @@ name = &quot;num_cpus&quot;
</a> version = &quot;1.10.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-12-3" id="h2-12-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-12-4" id="h2-12-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a> ]
 
 [[package]]
<a href="#h2-13" id="h2-13" class="h">@@ -535,7 +568,7 @@ name = &quot;parking_lot_core&quot;
</a> version = &quot;0.4.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-13-3" id="h2-13-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-13-4" id="h2-13-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;smallvec 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-14" id="h2-14" class="h">@@ -543,6 +576,11 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-14-3" id="h2-14-3" class="i">+name = &quot;ppv-lite86&quot;
</a><a href="#h2-14-4" id="h2-14-4" class="i">+version = &quot;0.2.5&quot;
</a><a href="#h2-14-5" id="h2-14-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-14-6" id="h2-14-6" class="i">+
</a><a href="#h2-14-7" id="h2-14-7" class="i">+[[package]]
</a> name = &quot;proc-macro2&quot;
 version = &quot;0.4.30&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-15" id="h2-15" class="h">@@ -582,7 +620,7 @@ dependencies = [
</a>  &quot;protobuf 2.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;protobuf-codegen 2.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;protoc 2.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-15-3" id="h2-15-3" class="d">- &quot;tempfile 3.0.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-15-4" id="h2-15-4" class="i">+ &quot;tempfile 3.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a> ]
 
 [[package]]
<a href="#h2-16" id="h2-16" class="h">@@ -611,7 +649,7 @@ version = &quot;0.4.6&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;fuchsia-cprng 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-16-3" id="h2-16-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-16-4" id="h2-16-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-17" id="h2-17" class="h">@@ -623,7 +661,7 @@ version = &quot;0.6.5&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-17-3" id="h2-17-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-17-4" id="h2-17-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-18" id="h2-18" class="h">@@ -636,6 +674,18 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-18-3" id="h2-18-3" class="i">+name = &quot;rand&quot;
</a><a href="#h2-18-4" id="h2-18-4" class="i">+version = &quot;0.7.0&quot;
</a><a href="#h2-18-5" id="h2-18-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-18-6" id="h2-18-6" class="i">+dependencies = [
</a><a href="#h2-18-7" id="h2-18-7" class="i">+ &quot;getrandom 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-18-8" id="h2-18-8" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-18-9" id="h2-18-9" class="i">+ &quot;rand_chacha 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-18-10" id="h2-18-10" class="i">+ &quot;rand_core 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-18-11" id="h2-18-11" class="i">+ &quot;rand_hc 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-18-12" id="h2-18-12" class="i">+]
</a><a href="#h2-18-13" id="h2-18-13" class="i">+
</a><a href="#h2-18-14" id="h2-18-14" class="i">+[[package]]
</a> name = &quot;rand_chacha&quot;
 version = &quot;0.1.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-19" id="h2-19" class="h">@@ -645,6 +695,15 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-19-3" id="h2-19-3" class="i">+name = &quot;rand_chacha&quot;
</a><a href="#h2-19-4" id="h2-19-4" class="i">+version = &quot;0.2.1&quot;
</a><a href="#h2-19-5" id="h2-19-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-19-6" id="h2-19-6" class="i">+dependencies = [
</a><a href="#h2-19-7" id="h2-19-7" class="i">+ &quot;c2-chacha 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-19-8" id="h2-19-8" class="i">+ &quot;rand_core 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-19-9" id="h2-19-9" class="i">+]
</a><a href="#h2-19-10" id="h2-19-10" class="i">+
</a><a href="#h2-19-11" id="h2-19-11" class="i">+[[package]]
</a> name = &quot;rand_core&quot;
 version = &quot;0.3.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-20" id="h2-20" class="h">@@ -658,6 +717,14 @@ version = &quot;0.4.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h2-20-3" id="h2-20-3" class="i">+name = &quot;rand_core&quot;
</a><a href="#h2-20-4" id="h2-20-4" class="i">+version = &quot;0.5.0&quot;
</a><a href="#h2-20-5" id="h2-20-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-20-6" id="h2-20-6" class="i">+dependencies = [
</a><a href="#h2-20-7" id="h2-20-7" class="i">+ &quot;getrandom 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-20-8" id="h2-20-8" class="i">+]
</a><a href="#h2-20-9" id="h2-20-9" class="i">+
</a><a href="#h2-20-10" id="h2-20-10" class="i">+[[package]]
</a> name = &quot;rand_hc&quot;
 version = &quot;0.1.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-21" id="h2-21" class="h">@@ -666,6 +733,14 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h2-21-3" id="h2-21-3" class="i">+name = &quot;rand_hc&quot;
</a><a href="#h2-21-4" id="h2-21-4" class="i">+version = &quot;0.2.0&quot;
</a><a href="#h2-21-5" id="h2-21-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-21-6" id="h2-21-6" class="i">+dependencies = [
</a><a href="#h2-21-7" id="h2-21-7" class="i">+ &quot;rand_core 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-21-8" id="h2-21-8" class="i">+]
</a><a href="#h2-21-9" id="h2-21-9" class="i">+
</a><a href="#h2-21-10" id="h2-21-10" class="i">+[[package]]
</a> name = &quot;rand_isaac&quot;
 version = &quot;0.1.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-22" id="h2-22" class="h">@@ -678,7 +753,7 @@ name = &quot;rand_jitter&quot;
</a> version = &quot;0.1.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-22-3" id="h2-22-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-22-4" id="h2-22-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
<a href="#h2-23" id="h2-23" class="h">@@ -690,7 +765,7 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> dependencies = [
  &quot;cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;fuchsia-cprng 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-23-3" id="h2-23-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-23-4" id="h2-23-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-24" id="h2-24" class="h">@@ -900,7 +975,7 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;simplelog&quot;
<a href="#h2-24-3" id="h2-24-3" class="d">-version = &quot;0.5.3&quot;
</a><a href="#h2-24-4" id="h2-24-4" class="i">+version = &quot;0.6.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;chrono 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-25" id="h2-25" class="h">@@ -965,12 +1040,12 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;tempfile&quot;
<a href="#h2-25-3" id="h2-25-3" class="d">-version = &quot;3.0.7&quot;
</a><a href="#h2-25-4" id="h2-25-4" class="i">+version = &quot;3.1.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-25-8" id="h2-25-8" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-25-9" id="h2-25-9" class="d">- &quot;rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-25-10" id="h2-25-10" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-25-11" id="h2-25-11" class="i">+ &quot;rand 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;redox_syscall 0.1.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;remove_dir_all 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-26" id="h2-26" class="h">@@ -991,7 +1066,7 @@ name = &quot;termion&quot;
</a> version = &quot;1.5.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-26-3" id="h2-26-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-26-4" id="h2-26-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;numtoa 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;redox_syscall 0.1.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;redox_termios 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-27" id="h2-27" class="h">@@ -1018,7 +1093,7 @@ name = &quot;time&quot;
</a> version = &quot;0.1.42&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h2-27-3" id="h2-27-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-27-4" id="h2-27-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;redox_syscall 0.1.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
 ]
<a href="#h2-28" id="h2-28" class="h">@@ -1246,7 +1321,7 @@ dependencies = [
</a>  &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;futures 0.1.27 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;iovec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-28-3" id="h2-28-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-28-4" id="h2-28-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;log 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;mio 0.6.16 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-29" id="h2-29" class="h">@@ -1262,7 +1337,7 @@ dependencies = [
</a>  &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;futures 0.1.27 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;iovec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-29-3" id="h2-29-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-29-4" id="h2-29-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;mio 0.6.16 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-30" id="h2-30" class="h">@@ -1283,8 +1358,10 @@ dependencies = [
</a> name = &quot;toydb&quot;
 version = &quot;0.1.0&quot;
 dependencies = [
<a href="#h2-30-3" id="h2-30-3" class="i">+ &quot;assert_matches 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;clap 2.33.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;config 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-30-6" id="h2-30-6" class="i">+ &quot;crossbeam-channel 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;grpc 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-31" id="h2-31" class="h">@@ -1294,7 +1371,9 @@ dependencies = [
</a>  &quot;rmp-serde 0.13.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde 1.0.91 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde_derive 1.0.91 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-31-3" id="h2-31-3" class="d">- &quot;simplelog 0.5.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-31-4" id="h2-31-4" class="i">+ &quot;simplelog 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-31-5" id="h2-31-5" class="i">+ &quot;tempfile 3.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-31-6" id="h2-31-6" class="i">+ &quot;uuid 0.7.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a> ]
 
 [[package]]
<a href="#h2-32" id="h2-32" class="h">@@ -1318,7 +1397,7 @@ version = &quot;0.5.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
  &quot;cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h2-32-3" id="h2-32-3" class="d">- &quot;libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-32-4" id="h2-32-4" class="i">+ &quot;libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a> ]
 
 [[package]]
<a href="#h2-33" id="h2-33" class="h">@@ -1327,6 +1406,14 @@ version = &quot;1.0.2&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h2-33-3" id="h2-33-3" class="i">+name = &quot;uuid&quot;
</a><a href="#h2-33-4" id="h2-33-4" class="i">+version = &quot;0.7.4&quot;
</a><a href="#h2-33-5" id="h2-33-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-33-6" id="h2-33-6" class="i">+dependencies = [
</a><a href="#h2-33-7" id="h2-33-7" class="i">+ &quot;rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h2-33-8" id="h2-33-8" class="i">+]
</a><a href="#h2-33-9" id="h2-33-9" class="i">+
</a><a href="#h2-33-10" id="h2-33-10" class="i">+[[package]]
</a> name = &quot;vec_map&quot;
 version = &quot;0.8.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-34" id="h2-34" class="h">@@ -1342,6 +1429,11 @@ version = &quot;1.0.2&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h2-34-3" id="h2-34-3" class="i">+name = &quot;wasi&quot;
</a><a href="#h2-34-4" id="h2-34-4" class="i">+version = &quot;0.5.0&quot;
</a><a href="#h2-34-5" id="h2-34-5" class="i">+source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h2-34-6" id="h2-34-6" class="i">+
</a><a href="#h2-34-7" id="h2-34-7" class="i">+[[package]]
</a> name = &quot;winapi&quot;
 version = &quot;0.2.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h2-35" id="h2-35" class="h">@@ -1392,6 +1484,7 @@ dependencies = [
</a> &quot;checksum ansi_term 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ee49baf6cb617b853aa8d93bf420db2383fab46d314482ca2803b40d5fde979b&quot;
 &quot;checksum argon2rs 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3f67b0b6a86dae6e67ff4ca2b6201396074996379fba2b92ff649126f37cb392&quot;
 &quot;checksum arrayvec 0.4.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;92c7fb76bc8826a8b33b4ee5bb07a247a81e76764ab4d55e8f73e3a4d8808c71&quot;
<a href="#h2-35-3" id="h2-35-3" class="i">+&quot;checksum assert_matches 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7deb0a829ca7bcfaf5da70b073a8d128619259a7be8216a355e23f00763059e5&quot;
</a> &quot;checksum atty 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9a7d5b8723950951411ee34d271d99dddcc2035a16ab25310ea2c8cfd4369652&quot;
 &quot;checksum autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a6d640bee2da49f60a4068a7fae53acde8982514ab7bae8b8cea9e88cbcfd799&quot;
 &quot;checksum backtrace 0.3.17 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;70af6de4789ac39587f100176ac7f704531e9e534b0f8676f658b3d909ce9a94&quot;
<a href="#h2-36" id="h2-36" class="h">@@ -1401,6 +1494,7 @@ dependencies = [
</a> &quot;checksum blake2-rfc 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5d6d530bdd2d52966a6d03b7a964add7ae1a288d25214066fd4b600f0f796400&quot;
 &quot;checksum byteorder 1.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a019b10a2a7cdeb292db131fc8113e57ea2a908f6e7894b0c3c671893b65dbeb&quot;
 &quot;checksum bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;206fdffcfa2df7cbe15601ef46c813fce0965eb3286db6b56c583b814b51c81c&quot;
<a href="#h2-36-3" id="h2-36-3" class="i">+&quot;checksum c2-chacha 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7d64d04786e0f528460fc884753cf8dddcc466be308f6026f8e355c41a0e4101&quot;
</a> &quot;checksum cc 1.0.37 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;39f75544d7bbaf57560d2168f28fd649ff9c76153874db88bdbdfd839b1a7e7d&quot;
 &quot;checksum cfg-if 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;11d43355396e872eefb45ce6342e4374ed7bc2b3a502d1b28e36d6e23c05d1f4&quot;
 &quot;checksum chrono 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;45912881121cb26fad7c38c17ba7daa18764771836b34fab7d3fbd93ed633878&quot;
<a href="#h2-37" id="h2-37" class="h">@@ -1408,6 +1502,7 @@ dependencies = [
</a> &quot;checksum cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ddfc5b9aa5d4507acaf872de71051dfd0e309860e88966e1051e462a077aac4f&quot;
 &quot;checksum config 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f9107d78ed62b3fa5a86e7d18e647abed48cfd8f8fab6c72f4cdb982d196f7e6&quot;
 &quot;checksum constant_time_eq 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8ff012e225ce166d4422e0e78419d901719760f62ae2b7969ca6b564d1b54a9e&quot;
<a href="#h2-37-3" id="h2-37-3" class="i">+&quot;checksum crossbeam-channel 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0f0ed1a4de2235cabda8558ff5840bffb97fcb64c97827f354a451307df5f72b&quot;
</a> &quot;checksum crossbeam-deque 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b18cd2e169ad86297e6bc0ad9aa679aee9daa4f19e8163860faf7c164e4f5a71&quot;
 &quot;checksum crossbeam-epoch 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;04c9e3102cc2d69cd681412141b390abd55a362afc1540965dad0ad4d34280b4&quot;
 &quot;checksum crossbeam-queue 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7c979cd6cfe72335896575c6b5688da489e420d36a27a0b9eb0c73db574b4a4b&quot;
<a href="#h2-38" id="h2-38" class="h">@@ -1421,6 +1516,7 @@ dependencies = [
</a> &quot;checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7&quot;
 &quot;checksum futures 0.1.27 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a2037ec1c6c1c4f79557762eab1f7eae1f64f6cb418ace90fae88f0942b60139&quot;
 &quot;checksum futures-cpupool 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ab90cde24b3319636588d0c35fe03b1333857621051837ed769faefb4c2162e4&quot;
<a href="#h2-38-3" id="h2-38-3" class="i">+&quot;checksum getrandom 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2512b3191f22e2763a5db387f1c9409379772e2050841722eb4a8c4f497bf096&quot;
</a> &quot;checksum grpc 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8e530ef7894a104a1c8525ce68787b3491efa2098ce5e5454e8324ea78893548&quot;
 &quot;checksum grpc-compiler 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b07f140d998d8940880e464f3fd291052618199432e91e59ae5c5075c0c8a40c&quot;
 &quot;checksum httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7689cfa896b2a71da4f16206af167542b75d242b6906313e53857972a92d5614&quot;
<a href="#h2-39" id="h2-39" class="h">@@ -1430,7 +1526,7 @@ dependencies = [
</a> &quot;checksum lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;76f033c7ad61445c5b347c7382dd1237847eb1bce590fe50365dcb33d546be73&quot;
 &quot;checksum lazy_static 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;bc5729f27f159ddd61f4df6228e827e86643d4d3e7c32183cb30a1c08f604a14&quot;
 &quot;checksum lazycell 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b294d6fa9ee409a054354afc4352b0b9ef7ca222c69b8812cbea9e7d2bf3783f&quot;
<a href="#h2-39-3" id="h2-39-3" class="d">-&quot;checksum libc 0.2.54 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c6785aa7dd976f5fbf3b71cfd9cd49d7f783c1ff565a858d71031c6c313aa5c6&quot;
</a><a href="#h2-39-4" id="h2-39-4" class="i">+&quot;checksum libc 0.2.62 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;34fcd2c08d2f832f376f4173a231990fa5aef4e99fb569867318a227ef4c06ba&quot;
</a> &quot;checksum linked-hash-map 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6d262045c5b87c0861b3f004610afd0e2c851e2908d08b6c870cbb9d5f494ecd&quot;
 &quot;checksum linked-hash-map 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ae91b68aebc4ddb91978b11a1b02ddd8602a05ec19002801c5666000e05e0f83&quot;
 &quot;checksum lock_api 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;62ebf1391f6acad60e5c8b43706dde4582df75c06698ab44511d15016bc2442c&quot;
<a href="#h2-40" id="h2-40" class="h">@@ -1452,6 +1548,7 @@ dependencies = [
</a> &quot;checksum owning_ref 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;49a4b8ea2179e6a2e27411d3bca09ca6dd630821cf6894c6c7c8467a8ee7ef13&quot;
 &quot;checksum parking_lot 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ab41b4aed082705d1056416ae4468b6ea99d52599ecf3169b00088d43113e337&quot;
 &quot;checksum parking_lot_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;94c8c7923936b28d546dfd14d4472eaf34c99b14e1c973a32b3e6d4eb04298c9&quot;
<a href="#h2-40-3" id="h2-40-3" class="i">+&quot;checksum ppv-lite86 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e3cbf9f658cdb5000fcf6f362b8ea2ba154b9f146a61c7a20d647034c6b6561b&quot;
</a> &quot;checksum proc-macro2 0.4.30 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;cf3d2011ab5c909338f7887f4fc896d35932e29146c12c8d01da6b22a80ba759&quot;
 &quot;checksum protobuf 2.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;bc7badf647ae2fa27ba51c218e347386c88cc604fcfe71f2aba0ad017f3f2b75&quot;
 &quot;checksum protobuf-codegen 2.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1be75a48019eb5143bd971a904cd99e58ffd25042f36361460b5b21e1de80487&quot;
<a href="#h2-41" id="h2-41" class="h">@@ -1461,10 +1558,14 @@ dependencies = [
</a> &quot;checksum quote 0.6.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;faf4799c5d274f3868a4aae320a0a182cbd2baee377b378f080e16a23e9d80db&quot;
 &quot;checksum rand 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;552840b97013b1a26992c11eac34bdd778e464601a4c2054b5f0bff7c6761293&quot;
 &quot;checksum rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6d71dacdc3c88c1fde3885a3be3fbab9f35724e6ce99467f7d9c5026132184ca&quot;
<a href="#h2-41-3" id="h2-41-3" class="i">+&quot;checksum rand 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d47eab0e83d9693d40f825f86948aa16eff6750ead4bdffc4ab95b8b3a7f052c&quot;
</a> &quot;checksum rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;556d3a1ca6600bfcbab7c7c91ccb085ac7fbbcd70e008a98742e7847f4f7bcef&quot;
<a href="#h2-41-5" id="h2-41-5" class="i">+&quot;checksum rand_chacha 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;03a2a90da8c7523f554344f921aa97283eadf6ac484a6d2a7d0212fa7f8d6853&quot;
</a> &quot;checksum rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7a6fdeb83b075e8266dcc8762c22776f6877a63111121f5f8c7411e5be7eed4b&quot;
 &quot;checksum rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d0e7a549d590831370895ab7ba4ea0c1b6b011d106b5ff2da6eee112615e6dc0&quot;
<a href="#h2-41-8" id="h2-41-8" class="i">+&quot;checksum rand_core 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;615e683324e75af5d43d8f7a39ffe3ee4a9dc42c5c701167a71dc59c3a493aca&quot;
</a> &quot;checksum rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7b40677c7be09ae76218dc623efbf7b18e34bced3f38883af07bb75630a21bc4&quot;
<a href="#h2-41-10" id="h2-41-10" class="i">+&quot;checksum rand_hc 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ca3129af7b92a17112d59ad498c6f81eaf463253766b90396d39ea7a39d6613c&quot;
</a> &quot;checksum rand_isaac 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ded997c9d5f13925be2a6fd7e66bf1872597f759fd9dd93513dd7e92e5a5ee08&quot;
 &quot;checksum rand_jitter 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1166d5c91dc97b88d1decc3285bb0a99ed84b05cfd0bc2341bdf2d43fc41e39b&quot;
 &quot;checksum rand_os 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7b75f676a1e053fc562eafbb47838d67c84801e38fc1ba459e8f180deabd5071&quot;
<a href="#h2-42" id="h2-42" class="h">@@ -1495,7 +1596,7 @@ dependencies = [
</a> &quot;checksum serde_derive 1.0.91 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;101b495b109a3e3ca8c4cbe44cf62391527cdfb6ba15821c5ce80bcd5ea23f9f&quot;
 &quot;checksum serde_json 1.0.39 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5a23aa71d4a4d43fdbfaac00eff68ba8a06a51759a89ac3304323e800c4dd40d&quot;
 &quot;checksum serde_test 0.8.23 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;110b3dbdf8607ec493c22d5d947753282f3bae73c0f56d322af1e8c78e4c23d5&quot;
<a href="#h2-42-3" id="h2-42-3" class="d">-&quot;checksum simplelog 0.5.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2e95345f185d5adeb8ec93459d2dc99654e294cc6ccf5b75414d8ea262de9a13&quot;
</a><a href="#h2-42-4" id="h2-42-4" class="i">+&quot;checksum simplelog 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;aa9c948a5a26cd38340ddbeaa557a8c8a5ce4442408eb60453bee2bb3c84a3fb&quot;
</a> &quot;checksum slab 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;17b4fcaed89ab08ef143da37bc52adbcc04d4a69014f4c1208d6b51f0c47bc23&quot;
 &quot;checksum slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c111b5bd5695e56cffe5129854aa230b39c93a305372fdbb2668ca2394eea9f8&quot;
 &quot;checksum smallvec 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c4488ae950c49d403731982257768f48fada354a5203fe81f9bb6f43ca9002be&quot;
<a href="#h2-43" id="h2-43" class="h">@@ -1504,7 +1605,7 @@ dependencies = [
</a> &quot;checksum syn 0.15.34 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a1393e4a97a19c01e900df2aec855a29f71cf02c402e2f443b8d2747c25c5dbe&quot;
 &quot;checksum synstructure 0.10.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;02353edf96d6e4dc81aea2d8490a7e9db177bf8acb0e951c24940bf866cb313f&quot;
 &quot;checksum tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;15f2b5fb00ccdf689e0149d1b1b3c03fead81c2b37735d812fa8bddbbf41b6d8&quot;
<a href="#h2-43-3" id="h2-43-3" class="d">-&quot;checksum tempfile 3.0.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b86c784c88d98c801132806dadd3819ed29d8600836c4088e855cdf3e178ed8a&quot;
</a><a href="#h2-43-4" id="h2-43-4" class="i">+&quot;checksum tempfile 3.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7a6e24d9338a0a5be79593e2fa15a648add6138caa803e2d5bc782c371732ca9&quot;
</a> &quot;checksum term 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;edd106a334b7657c10b7c540a0106114feadeb4dc314513e97df481d5d966f42&quot;
 &quot;checksum termion 1.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;dde0593aeb8d47accea5392b39350015b5eccb12c0d98044d856983d89548dea&quot;
 &quot;checksum textwrap 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d326610f408c7a4eb6f51c37c330e496b08506c9457c9d34287ecc38809fb060&quot;
<a href="#h2-44" id="h2-44" class="h">@@ -1536,9 +1637,11 @@ dependencies = [
</a> &quot;checksum unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;fc72304796d0818e357ead4e000d19c9c174ab23dc11093ac919054d20a6a7fc&quot;
 &quot;checksum unix_socket 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6aa2700417c405c38f5e6902d699345241c28c0b7ade4abaad71e35a87eb1564&quot;
 &quot;checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737&quot;
<a href="#h2-44-3" id="h2-44-3" class="i">+&quot;checksum uuid 0.7.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;90dbc611eb48397705a6b0f6e917da23ae517e4d127123d2cf7674206627d32a&quot;
</a> &quot;checksum vec_map 0.8.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;05c78687fb1a80548ae3250346c3db86a80a7cdd77bda190189f2d0a0987c81a&quot;
 &quot;checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd&quot;
 &quot;checksum void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6a02e4885ed3bc0f2de90ea6dd45ebcbb66dacffe03547fadbb0eeae2770887d&quot;
<a href="#h2-44-7" id="h2-44-7" class="i">+&quot;checksum wasi 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;fd5442abcac6525a045cc8c795aedb60da7a2e5e89c7bf18a0d5357849bb23c7&quot;
</a> &quot;checksum winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;167dc9d6949a9b857f3451275e911c3f44255842c1f7a76f33c55103a909087a&quot;
 &quot;checksum winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f10e386af2b13e47c89e7236a7a14a086791a2b88ebad6df9bf42040195cf770&quot;
 &quot;checksum winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2d315eee3b34aca4797b2da6b13ed88266e6d612562a0c46390af8299fc699bc&quot;
<b>diff --git a/<a id="h3" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -8,6 +8,7 @@ edition = &quot;2018&quot;
</a> [dependencies]
 clap = &quot;~2.33.0&quot;
 config = &quot;~0.9.3&quot;
<a href="#h3-0-3" id="h3-0-3" class="i">+crossbeam-channel = &quot;~0.3.8&quot;
</a> grpc = &quot;~0.6.1&quot;
 log = &quot;~0.4.6&quot;
 protobuf = &quot;~2.5.0&quot;
<a href="#h3-1" id="h3-1" class="h">@@ -15,10 +16,15 @@ rand = &quot;~0.6.5&quot;
</a> rmp-serde = &quot;~0.13.7&quot;
 serde = &quot;~1.0.91&quot;
 serde_derive = &quot;~1.0.91&quot;
<a href="#h3-1-3" id="h3-1-3" class="d">-simplelog = &quot;~0.5.3&quot;
</a><a href="#h3-1-4" id="h3-1-4" class="i">+simplelog = &quot;~0.6.0&quot;
</a><a href="#h3-1-5" id="h3-1-5" class="i">+uuid = { version = &quot;~0.7.4&quot;, features = [&quot;v4&quot;] }
</a> 
 # The following are sub-dependencies that we need for error handling
 httpbis = &quot;~0.7.0&quot;
 
 [build-dependencies]
<a href="#h3-1-11" id="h3-1-11" class="d">-protoc-rust-grpc = &quot;~0.6.1&quot;
</a><a href="#h3-1-12" id="h3-1-12" class="d">-\ No newline at end of file
</a><a href="#h3-1-13" id="h3-1-13" class="i">+protoc-rust-grpc = &quot;~0.6.1&quot;
</a><a href="#h3-1-14" id="h3-1-14" class="i">+
</a><a href="#h3-1-15" id="h3-1-15" class="i">+[dev-dependencies]
</a><a href="#h3-1-16" id="h3-1-16" class="i">+assert_matches = &quot;~1.3.0&quot;
</a><a href="#h3-1-17" id="h3-1-17" class="i">+tempfile = &quot;~3.1.0&quot;
</a><a href="#h3-1-18" id="h3-1-18" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h4" href="../file/README.md.html">README.md</a> b/<a href="../file/README.md.html">README.md</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -2,30 +2,68 @@
</a> 
 Distributed SQL database in Rust, written as a learning project.
 
<a href="#h4-0-3" id="h4-0-3" class="i">+The primary goal is to build a minimally functional yet correct distributed database. Performance, security, reliability, and convenience are non-goals.
</a><a href="#h4-0-4" id="h4-0-4" class="i">+
</a><a href="#h4-0-5" id="h4-0-5" class="i">+## Usage
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a><a href="#h4-0-7" id="h4-0-7" class="i">+A local five-node cluster can be started by running:
</a><a href="#h4-0-8" id="h4-0-8" class="i">+
</a><a href="#h4-0-9" id="h4-0-9" class="i">+```sh
</a><a href="#h4-0-10" id="h4-0-10" class="i">+$ (cd sandbox &amp;&amp; docker-compose up --build)
</a><a href="#h4-0-11" id="h4-0-11" class="i">+```
</a><a href="#h4-0-12" id="h4-0-12" class="i">+
</a><a href="#h4-0-13" id="h4-0-13" class="i">+The nodes can be contacted on `localhost` ports `9601` to `9605`, e.g.:
</a><a href="#h4-0-14" id="h4-0-14" class="i">+
</a><a href="#h4-0-15" id="h4-0-15" class="i">+```sh
</a><a href="#h4-0-16" id="h4-0-16" class="i">+$ grpcurl -plaintext -proto protobuf/toydb.proto localhost:9605 ToyDB/Status
</a><a href="#h4-0-17" id="h4-0-17" class="i">+```
</a><a href="#h4-0-18" id="h4-0-18" class="i">+
</a> ## Project Outline
 
 - [x] **Networking:** gRPC, no security.
 
<a href="#h4-0-23" id="h4-0-23" class="d">-- [ ] **Storage:** Self-written key-value engine using LSM-trees and/or B+-trees, with secondary indexes. MessagePack for serialization. No log compaction or write-ahead log.
</a><a href="#h4-0-24" id="h4-0-24" class="i">+- [x] **Consensus:** Self-written Raft implementation with strictly serializable reads and writes.
</a> 
<a href="#h4-0-26" id="h4-0-26" class="d">-- [ ] **Consensus:** Self-written Raft implementation, handling all writes and reads. Node time is (naively) considered accurate.
</a><a href="#h4-0-27" id="h4-0-27" class="i">+- [ ] **Storage:** Self-written key-value engine using B+-trees (and possibly LSM-trees), with secondary indexes. MessagePack for serialization. No log compaction or write-ahead log.
</a> 
 - [ ] **Data Types:** Support for nulls, booleans, signed 64-bit doubles, and short UTF-8 strings.
 
<a href="#h4-0-31" id="h4-0-31" class="d">-- [ ] **Constraints:** Singular required primary keys, unique indexes, and foreign keys.
</a><a href="#h4-0-32" id="h4-0-32" class="i">+- [ ] **Constraints:** Compulsory singluar primary keys, unique indexes, and foreign keys.
</a> 
 - [ ] **Transactions:** MVCC-based serializable snapshot isolation.
 
 - [ ] **Query Engine:** Simple heuristic-based planner and optimizer supporting expressions, functions, and inner joins.
 
<a href="#h4-0-38" id="h4-0-38" class="d">-- [ ] **Language:** Basic SQL support
</a><a href="#h4-0-39" id="h4-0-39" class="i">+- [ ] **Language:** Basic SQL support:
</a> 
   * `[CREATE|DROP] TABLE ...` and `[CREATE|DROP] INDEX ...`
   * `BEGIN`, `COMMIT`, and `ROLLBACK`
<a href="#h4-0-43" id="h4-0-43" class="d">-  * `INSERT INTO [TABLE] (...) VALUES (...)`
</a><a href="#h4-0-44" id="h4-0-44" class="d">-  * `UPDATE [TABLE] SET ... WHERE ...`
</a><a href="#h4-0-45" id="h4-0-45" class="d">-  * `DELETE FROM [TABLE] WHERE ...`
</a><a href="#h4-0-46" id="h4-0-46" class="d">-  * `SELECT ... FROM ... WHERE ... ORDER BY ...`
</a><a href="#h4-0-47" id="h4-0-47" class="i">+  * `INSERT INTO ... (...) VALUES (...)`
</a><a href="#h4-0-48" id="h4-0-48" class="i">+  * `UPDATE ... SET ... WHERE ...`
</a><a href="#h4-0-49" id="h4-0-49" class="i">+  * `DELETE FROM ... WHERE ...`
</a><a href="#h4-0-50" id="h4-0-50" class="i">+  * `SELECT ... FROM ... WHERE ... GROUP BY ... HAVING ... ORDER BY ...`
</a>   * `EXPLAIN SELECT ...`
 
 - [ ] **Client:** Simple interactive REPL client over gRPC.
<a href="#h4-0-54" id="h4-0-54" class="i">+
</a><a href="#h4-0-55" id="h4-0-55" class="i">+- [ ] **Verification:** [Jepsen](https://github.com/jepsen-io/jepsen) test suite.
</a><a href="#h4-0-56" id="h4-0-56" class="i">+
</a><a href="#h4-0-57" id="h4-0-57" class="i">+## Known Issues
</a><a href="#h4-0-58" id="h4-0-58" class="i">+
</a><a href="#h4-0-59" id="h4-0-59" class="i">+Below is an incomplete list of known issues preventing this from being a &quot;real&quot; database.
</a><a href="#h4-0-60" id="h4-0-60" class="i">+
</a><a href="#h4-0-61" id="h4-0-61" class="i">+### Networking
</a><a href="#h4-0-62" id="h4-0-62" class="i">+
</a><a href="#h4-0-63" id="h4-0-63" class="i">+* **No security:** all network traffic is unauthenticated and in plaintext; any request from any source is accepted.
</a><a href="#h4-0-64" id="h4-0-64" class="i">+
</a><a href="#h4-0-65" id="h4-0-65" class="i">+### Raft
</a><a href="#h4-0-66" id="h4-0-66" class="i">+
</a><a href="#h4-0-67" id="h4-0-67" class="i">+* **Cluster reconfiguration:** the Raft cluster must consist of a static set of nodes available via static IP addresses. It is not possible to resize the cluster without a full cluster restart.
</a><a href="#h4-0-68" id="h4-0-68" class="i">+
</a><a href="#h4-0-69" id="h4-0-69" class="i">+* **Single node processing:** all operations (both reads and writes) are processed by a single Raft thread on a single node (the master), and the system consists of a single Raft cluster, preventing horizontal scalability and efficient resource utilization.
</a><a href="#h4-0-70" id="h4-0-70" class="i">+
</a><a href="#h4-0-71" id="h4-0-71" class="i">+* **Client call retries:** there is currently no retries of client-submitted operations, and if a node processing or proxying an operations changes role then the call is dropped.
</a><a href="#h4-0-72" id="h4-0-72" class="i">+
</a><a href="#h4-0-73" id="h4-0-73" class="i">+* **State machine errors:** errors during state machine mutations currently crash the node - it may be beneficial to support user errors which simply skip the erroring log entry.
</a><a href="#h4-0-74" id="h4-0-74" class="i">+
</a><a href="#h4-0-75" id="h4-0-75" class="i">+* **Log replication optimization:** currently only the simplest version of the Raft log replication protocol is implemented, without snapshots or rapid log replay (i.e. replication of old log entries is retried one by one until a common base entry is found).
</a><a href="#h4-0-76" id="h4-0-76" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h5" href="../file/build.rs.html">build.rs</a> b/<a href="../file/build.rs.html">build.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -2,17 +2,18 @@ extern crate protoc_rust_grpc;
</a> 
 fn main() {
     // Generate Protobuf shims
<a href="#h5-0-3" id="h5-0-3" class="d">-    let protobuf_sources = &amp;[&quot;protobuf/toydb.proto&quot;];
</a><a href="#h5-0-4" id="h5-0-4" class="i">+    let protobuf_sources = &amp;[&quot;protobuf/raft.proto&quot;, &quot;protobuf/toydb.proto&quot;];
</a> 
<a href="#h5-0-6" id="h5-0-6" class="d">-    protoc_rust_grpc::run(protoc_rust_grpc::Args{
</a><a href="#h5-0-7" id="h5-0-7" class="i">+    protoc_rust_grpc::run(protoc_rust_grpc::Args {
</a>         input: protobuf_sources,
         out_dir: &quot;src/service&quot;,
         includes: &amp;[],
         rust_protobuf: true,
         ..Default::default()
<a href="#h5-0-13" id="h5-0-13" class="d">-    }).expect(&quot;protoc-rust-grpc&quot;);
</a><a href="#h5-0-14" id="h5-0-14" class="i">+    })
</a><a href="#h5-0-15" id="h5-0-15" class="i">+    .expect(&quot;protoc-rust-grpc&quot;);
</a> 
     for src in protobuf_sources {
         println!(&quot;cargo:rerun-if-changed={}&quot;, src);
     }
<a href="#h5-0-20" id="h5-0-20" class="d">-}
</a><a href="#h5-0-21" id="h5-0-21" class="d">-\ No newline at end of file
</a><a href="#h5-0-22" id="h5-0-22" class="i">+}
</a><b>diff --git a/<a id="h6" href="../file/config/toydb.yaml.html">config/toydb.yaml</a> b/<a href="../file/config/toydb.yaml.html">config/toydb.yaml</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -1,3 +1,6 @@
</a> id: toydb
 listen: 0.0.0.0:9605
<a href="#h6-0-2" id="h6-0-2" class="d">-threads: 4
</a><a href="#h6-0-3" id="h6-0-3" class="d">-\ No newline at end of file
</a><a href="#h6-0-4" id="h6-0-4" class="i">+threads: 4
</a><a href="#h6-0-5" id="h6-0-5" class="i">+log_level: INFO
</a><a href="#h6-0-6" id="h6-0-6" class="i">+data_dir: /var/lib/toydb
</a><a href="#h6-0-7" id="h6-0-7" class="i">+peers: {}
</a><b>diff --git a/<a id="h7" href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a> b/<a href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,81 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+syntax = &quot;proto3&quot;;
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+// An asynchronous Raft service used for intra-cluster message passing.
</a><a href="#h7-0-3" id="h7-0-3" class="i">+// For details on messages, see toydb::raft::transport module.
</a><a href="#h7-0-4" id="h7-0-4" class="i">+
</a><a href="#h7-0-5" id="h7-0-5" class="i">+service Raft {
</a><a href="#h7-0-6" id="h7-0-6" class="i">+  rpc Step(Message) returns (Success) {};
</a><a href="#h7-0-7" id="h7-0-7" class="i">+};
</a><a href="#h7-0-8" id="h7-0-8" class="i">+
</a><a href="#h7-0-9" id="h7-0-9" class="i">+message Success {}
</a><a href="#h7-0-10" id="h7-0-10" class="i">+
</a><a href="#h7-0-11" id="h7-0-11" class="i">+message Message {
</a><a href="#h7-0-12" id="h7-0-12" class="i">+  uint64 term = 1;
</a><a href="#h7-0-13" id="h7-0-13" class="i">+  string from = 2;
</a><a href="#h7-0-14" id="h7-0-14" class="i">+  string to = 3;
</a><a href="#h7-0-15" id="h7-0-15" class="i">+  oneof event {
</a><a href="#h7-0-16" id="h7-0-16" class="i">+    Heartbeat heartbeat = 4;
</a><a href="#h7-0-17" id="h7-0-17" class="i">+    ConfirmLeader confirm_leader = 5;
</a><a href="#h7-0-18" id="h7-0-18" class="i">+    SolicitVote solicit_vote = 6;
</a><a href="#h7-0-19" id="h7-0-19" class="i">+    GrantVote grant_vote = 7;
</a><a href="#h7-0-20" id="h7-0-20" class="i">+    ReplicateEntries replicate_entries = 8;
</a><a href="#h7-0-21" id="h7-0-21" class="i">+    AcceptEntries accept_entries = 9;
</a><a href="#h7-0-22" id="h7-0-22" class="i">+    RejectEntries reject_entries = 10;
</a><a href="#h7-0-23" id="h7-0-23" class="i">+    ReadState read_state = 11;
</a><a href="#h7-0-24" id="h7-0-24" class="i">+    MutateState mutate_state = 12;
</a><a href="#h7-0-25" id="h7-0-25" class="i">+    RespondState respond_state = 13;
</a><a href="#h7-0-26" id="h7-0-26" class="i">+    RespondError respond_error = 14;
</a><a href="#h7-0-27" id="h7-0-27" class="i">+  }
</a><a href="#h7-0-28" id="h7-0-28" class="i">+}
</a><a href="#h7-0-29" id="h7-0-29" class="i">+
</a><a href="#h7-0-30" id="h7-0-30" class="i">+message Heartbeat {
</a><a href="#h7-0-31" id="h7-0-31" class="i">+  uint64 commit_index = 1;
</a><a href="#h7-0-32" id="h7-0-32" class="i">+  uint64 commit_term = 2;
</a><a href="#h7-0-33" id="h7-0-33" class="i">+}
</a><a href="#h7-0-34" id="h7-0-34" class="i">+
</a><a href="#h7-0-35" id="h7-0-35" class="i">+message ConfirmLeader {
</a><a href="#h7-0-36" id="h7-0-36" class="i">+  uint64 commit_index = 1;
</a><a href="#h7-0-37" id="h7-0-37" class="i">+  bool has_committed = 2;
</a><a href="#h7-0-38" id="h7-0-38" class="i">+}
</a><a href="#h7-0-39" id="h7-0-39" class="i">+
</a><a href="#h7-0-40" id="h7-0-40" class="i">+message SolicitVote {
</a><a href="#h7-0-41" id="h7-0-41" class="i">+  uint64 last_index = 1;
</a><a href="#h7-0-42" id="h7-0-42" class="i">+  uint64 last_term = 2;
</a><a href="#h7-0-43" id="h7-0-43" class="i">+}
</a><a href="#h7-0-44" id="h7-0-44" class="i">+
</a><a href="#h7-0-45" id="h7-0-45" class="i">+message GrantVote {}
</a><a href="#h7-0-46" id="h7-0-46" class="i">+
</a><a href="#h7-0-47" id="h7-0-47" class="i">+message Entry {
</a><a href="#h7-0-48" id="h7-0-48" class="i">+  uint64 term = 1;
</a><a href="#h7-0-49" id="h7-0-49" class="i">+  bytes command = 2;
</a><a href="#h7-0-50" id="h7-0-50" class="i">+}
</a><a href="#h7-0-51" id="h7-0-51" class="i">+
</a><a href="#h7-0-52" id="h7-0-52" class="i">+message ReplicateEntries {
</a><a href="#h7-0-53" id="h7-0-53" class="i">+  uint64 base_index = 1;
</a><a href="#h7-0-54" id="h7-0-54" class="i">+  uint64 base_term = 2;
</a><a href="#h7-0-55" id="h7-0-55" class="i">+  repeated Entry entries = 3;
</a><a href="#h7-0-56" id="h7-0-56" class="i">+}
</a><a href="#h7-0-57" id="h7-0-57" class="i">+
</a><a href="#h7-0-58" id="h7-0-58" class="i">+message AcceptEntries { uint64 last_index = 1; }
</a><a href="#h7-0-59" id="h7-0-59" class="i">+
</a><a href="#h7-0-60" id="h7-0-60" class="i">+message RejectEntries {}
</a><a href="#h7-0-61" id="h7-0-61" class="i">+
</a><a href="#h7-0-62" id="h7-0-62" class="i">+message ReadState {
</a><a href="#h7-0-63" id="h7-0-63" class="i">+  bytes call_id = 1;
</a><a href="#h7-0-64" id="h7-0-64" class="i">+  bytes command = 2;
</a><a href="#h7-0-65" id="h7-0-65" class="i">+}
</a><a href="#h7-0-66" id="h7-0-66" class="i">+
</a><a href="#h7-0-67" id="h7-0-67" class="i">+message MutateState {
</a><a href="#h7-0-68" id="h7-0-68" class="i">+  bytes call_id = 1;
</a><a href="#h7-0-69" id="h7-0-69" class="i">+  bytes command = 2;
</a><a href="#h7-0-70" id="h7-0-70" class="i">+}
</a><a href="#h7-0-71" id="h7-0-71" class="i">+
</a><a href="#h7-0-72" id="h7-0-72" class="i">+message RespondState {
</a><a href="#h7-0-73" id="h7-0-73" class="i">+  bytes call_id = 1;
</a><a href="#h7-0-74" id="h7-0-74" class="i">+  bytes response = 2;
</a><a href="#h7-0-75" id="h7-0-75" class="i">+}
</a><a href="#h7-0-76" id="h7-0-76" class="i">+
</a><a href="#h7-0-77" id="h7-0-77" class="i">+message RespondError {
</a><a href="#h7-0-78" id="h7-0-78" class="i">+  bytes call_id = 1;
</a><a href="#h7-0-79" id="h7-0-79" class="i">+  string error = 2;
</a><a href="#h7-0-80" id="h7-0-80" class="i">+}
</a><a href="#h7-0-81" id="h7-0-81" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h8" href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a> b/<a href="../file/protobuf/toydb.proto.html">protobuf/toydb.proto</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -4,6 +4,12 @@ syntax = &quot;proto3&quot;;
</a> service ToyDB {
   // Status asks the server for its status.
   rpc Status(StatusRequest) returns (StatusResponse) {};
<a href="#h8-0-3" id="h8-0-3" class="i">+
</a><a href="#h8-0-4" id="h8-0-4" class="i">+  // Get is a temporary key-value command.
</a><a href="#h8-0-5" id="h8-0-5" class="i">+  rpc Get(GetRequest) returns (GetResponse) {};
</a><a href="#h8-0-6" id="h8-0-6" class="i">+
</a><a href="#h8-0-7" id="h8-0-7" class="i">+  // Set is a temporary key-value command.
</a><a href="#h8-0-8" id="h8-0-8" class="i">+  rpc Set(SetRequest) returns (SetResponse) {};
</a> };
 
 message StatusRequest {};
<a href="#h8-1" id="h8-1" class="h">@@ -12,4 +18,23 @@ message StatusResponse {
</a>   string id = 1;
   string version = 2;
   int64 time = 3;
<a href="#h8-1-3" id="h8-1-3" class="d">-};
</a><a href="#h8-1-4" id="h8-1-4" class="d">-\ No newline at end of file
</a><a href="#h8-1-5" id="h8-1-5" class="i">+};
</a><a href="#h8-1-6" id="h8-1-6" class="i">+
</a><a href="#h8-1-7" id="h8-1-7" class="i">+message GetRequest {
</a><a href="#h8-1-8" id="h8-1-8" class="i">+  string key = 1;
</a><a href="#h8-1-9" id="h8-1-9" class="i">+}
</a><a href="#h8-1-10" id="h8-1-10" class="i">+
</a><a href="#h8-1-11" id="h8-1-11" class="i">+message GetResponse {
</a><a href="#h8-1-12" id="h8-1-12" class="i">+  string key = 1;
</a><a href="#h8-1-13" id="h8-1-13" class="i">+  string value = 2;
</a><a href="#h8-1-14" id="h8-1-14" class="i">+}
</a><a href="#h8-1-15" id="h8-1-15" class="i">+
</a><a href="#h8-1-16" id="h8-1-16" class="i">+message SetRequest {
</a><a href="#h8-1-17" id="h8-1-17" class="i">+  string key = 1;
</a><a href="#h8-1-18" id="h8-1-18" class="i">+  string value = 2;
</a><a href="#h8-1-19" id="h8-1-19" class="i">+}
</a><a href="#h8-1-20" id="h8-1-20" class="i">+
</a><a href="#h8-1-21" id="h8-1-21" class="i">+message SetResponse {
</a><a href="#h8-1-22" id="h8-1-22" class="i">+  string key = 1;
</a><a href="#h8-1-23" id="h8-1-23" class="i">+  string value = 2;
</a><a href="#h8-1-24" id="h8-1-24" class="i">+}
</a><a href="#h8-1-25" id="h8-1-25" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h9" href="../file/sandbox/docker-compose.yml.html">sandbox/docker-compose.yml</a> b/<a href="../file/sandbox/docker-compose.yml.html">sandbox/docker-compose.yml</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -1,42 +1,67 @@
</a> version: &quot;3.7&quot;
 
<a href="#h9-0-2" id="h9-0-2" class="i">+networks:
</a><a href="#h9-0-3" id="h9-0-3" class="i">+  toydb:
</a><a href="#h9-0-4" id="h9-0-4" class="i">+    name: toydb
</a><a href="#h9-0-5" id="h9-0-5" class="i">+    ipam:
</a><a href="#h9-0-6" id="h9-0-6" class="i">+      driver: default
</a><a href="#h9-0-7" id="h9-0-7" class="i">+      config:
</a><a href="#h9-0-8" id="h9-0-8" class="i">+      - subnet: 172.20.0.0/24
</a><a href="#h9-0-9" id="h9-0-9" class="i">+
</a> services:
<a href="#h9-0-11" id="h9-0-11" class="d">-  toydb-a:
</a><a href="#h9-0-12" id="h9-0-12" class="i">+  toydb-a: &amp;toydb
</a>     build: ..
<a href="#h9-0-14" id="h9-0-14" class="d">-    command: [&quot;toydb&quot;, &quot;-c&quot;, &quot;/etc/toydb/toydb-a.yml&quot;]
</a><a href="#h9-0-15" id="h9-0-15" class="i">+    environment:
</a><a href="#h9-0-16" id="h9-0-16" class="i">+    - TOYDB_LOG_LEVEL
</a>     volumes:
<a href="#h9-0-18" id="h9-0-18" class="d">-    - .:/etc/toydb
</a><a href="#h9-0-19" id="h9-0-19" class="i">+    - ./toydb-a/toydb.yaml:/etc/toydb.yaml
</a><a href="#h9-0-20" id="h9-0-20" class="i">+    - ./toydb-a/data:/var/lib/toydb
</a><a href="#h9-0-21" id="h9-0-21" class="i">+    networks:
</a><a href="#h9-0-22" id="h9-0-22" class="i">+      toydb:
</a><a href="#h9-0-23" id="h9-0-23" class="i">+        ipv4_address: 172.20.0.101
</a>     ports:
<a href="#h9-0-25" id="h9-0-25" class="d">-    - 9601:9601
</a><a href="#h9-0-26" id="h9-0-26" class="i">+    - 9601:9605
</a> 
   toydb-b:
<a href="#h9-0-29" id="h9-0-29" class="d">-    build: ..
</a><a href="#h9-0-30" id="h9-0-30" class="d">-    command: [&quot;toydb&quot;, &quot;-c&quot;, &quot;/etc/toydb/toydb-b.yml&quot;]
</a><a href="#h9-0-31" id="h9-0-31" class="i">+    &lt;&lt;: *toydb
</a>     volumes:
<a href="#h9-0-33" id="h9-0-33" class="d">-    - .:/etc/toydb
</a><a href="#h9-0-34" id="h9-0-34" class="i">+    - ./toydb-b/toydb.yaml:/etc/toydb.yaml
</a><a href="#h9-0-35" id="h9-0-35" class="i">+    - ./toydb-b/data:/var/lib/toydb
</a><a href="#h9-0-36" id="h9-0-36" class="i">+    networks:
</a><a href="#h9-0-37" id="h9-0-37" class="i">+      toydb:
</a><a href="#h9-0-38" id="h9-0-38" class="i">+        ipv4_address: 172.20.0.102
</a>     ports:
<a href="#h9-0-40" id="h9-0-40" class="d">-    - 9602:9602
</a><a href="#h9-0-41" id="h9-0-41" class="i">+    - 9602:9605
</a> 
   toydb-c:
<a href="#h9-0-44" id="h9-0-44" class="d">-    build: ..
</a><a href="#h9-0-45" id="h9-0-45" class="d">-    command: [&quot;toydb&quot;, &quot;-c&quot;, &quot;/etc/toydb/toydb-c.yml&quot;]
</a><a href="#h9-0-46" id="h9-0-46" class="i">+    &lt;&lt;: *toydb
</a>     volumes:
<a href="#h9-0-48" id="h9-0-48" class="d">-    - .:/etc/toydb
</a><a href="#h9-0-49" id="h9-0-49" class="i">+    - ./toydb-c/toydb.yaml:/etc/toydb.yaml
</a><a href="#h9-0-50" id="h9-0-50" class="i">+    - ./toydb-c/data:/var/lib/toydb
</a><a href="#h9-0-51" id="h9-0-51" class="i">+    networks:
</a><a href="#h9-0-52" id="h9-0-52" class="i">+      toydb:
</a><a href="#h9-0-53" id="h9-0-53" class="i">+        ipv4_address: 172.20.0.103
</a>     ports:
<a href="#h9-0-55" id="h9-0-55" class="d">-    - 9603:9603
</a><a href="#h9-0-56" id="h9-0-56" class="i">+    - 9603:9605
</a> 
   toydb-d:
<a href="#h9-0-59" id="h9-0-59" class="d">-    build: ..
</a><a href="#h9-0-60" id="h9-0-60" class="d">-    command: [&quot;toydb&quot;, &quot;-c&quot;, &quot;/etc/toydb/toydb-d.yml&quot;]
</a><a href="#h9-0-61" id="h9-0-61" class="i">+    &lt;&lt;: *toydb
</a>     volumes:
<a href="#h9-0-63" id="h9-0-63" class="d">-    - .:/etc/toydb
</a><a href="#h9-0-64" id="h9-0-64" class="i">+    - ./toydb-d/toydb.yaml:/etc/toydb.yaml
</a><a href="#h9-0-65" id="h9-0-65" class="i">+    - ./toydb-d/data:/var/lib/toydb
</a><a href="#h9-0-66" id="h9-0-66" class="i">+    networks:
</a><a href="#h9-0-67" id="h9-0-67" class="i">+      toydb:
</a><a href="#h9-0-68" id="h9-0-68" class="i">+        ipv4_address: 172.20.0.104
</a>     ports:
<a href="#h9-0-70" id="h9-0-70" class="d">-    - 9604:9604
</a><a href="#h9-0-71" id="h9-0-71" class="i">+    - 9604:9605
</a> 
   toydb-e:
<a href="#h9-0-74" id="h9-0-74" class="d">-    build: ..
</a><a href="#h9-0-75" id="h9-0-75" class="d">-    command: [&quot;toydb&quot;, &quot;-c&quot;, &quot;/etc/toydb/toydb-e.yml&quot;]
</a><a href="#h9-0-76" id="h9-0-76" class="i">+    &lt;&lt;: *toydb
</a>     volumes:
<a href="#h9-0-78" id="h9-0-78" class="d">-    - .:/etc/toydb
</a><a href="#h9-0-79" id="h9-0-79" class="i">+    - ./toydb-e/toydb.yaml:/etc/toydb.yaml
</a><a href="#h9-0-80" id="h9-0-80" class="i">+    - ./toydb-e/data:/var/lib/toydb
</a><a href="#h9-0-81" id="h9-0-81" class="i">+    networks:
</a><a href="#h9-0-82" id="h9-0-82" class="i">+      toydb:
</a><a href="#h9-0-83" id="h9-0-83" class="i">+        ipv4_address: 172.20.0.105
</a>     ports:
<a href="#h9-0-85" id="h9-0-85" class="d">-    - 9605:9605
</a><a href="#h9-0-86" id="h9-0-86" class="d">-\ No newline at end of file
</a><a href="#h9-0-87" id="h9-0-87" class="i">+    - 9605:9605
</a><b>diff --git a/<a id="h10" href="../file/sandbox/toydb-a.yml.html">sandbox/toydb-a.yml</a> b/<a href="../file/sandbox/toydb-a.yml.html">sandbox/toydb-a.yml</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h10-0-0" id="h10-0-0" class="d">-id: toydb-a
</a><a href="#h10-0-1" id="h10-0-1" class="d">-listen: 0.0.0.0:9601
</a><b>diff --git a/<a id="h11" href="../file/sandbox/toydb-a/data/.gitkeep.html">sandbox/toydb-a/data/.gitkeep</a> b/<a href="../file/sandbox/toydb-a/data/.gitkeep.html">sandbox/toydb-a/data/.gitkeep</a></b>
<b>diff --git a/<a id="h12" href="../file/sandbox/toydb-a/toydb.yaml.html">sandbox/toydb-a/toydb.yaml</a> b/<a href="../file/sandbox/toydb-a/toydb.yaml.html">sandbox/toydb-a/toydb.yaml</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+id: toydb-a
</a><a href="#h12-0-1" id="h12-0-1" class="i">+peers:
</a><a href="#h12-0-2" id="h12-0-2" class="i">+  toydb-b: 172.20.0.102
</a><a href="#h12-0-3" id="h12-0-3" class="i">+  toydb-c: 172.20.0.103
</a><a href="#h12-0-4" id="h12-0-4" class="i">+  toydb-d: 172.20.0.104
</a><a href="#h12-0-5" id="h12-0-5" class="i">+  toydb-e: 172.20.0.105
</a><a href="#h12-0-6" id="h12-0-6" class="i">+\ No newline at end of file
</a><b>diff --git a/<a id="h13" href="../file/sandbox/toydb-b.yml.html">sandbox/toydb-b.yml</a> b/<a href="../file/sandbox/toydb-b.yml.html">sandbox/toydb-b.yml</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h13-0-0" id="h13-0-0" class="d">-id: toydb-b
</a><a href="#h13-0-1" id="h13-0-1" class="d">-listen: 0.0.0.0:9602
</a><b>diff --git a/<a id="h14" href="../file/sandbox/toydb-b/data/.gitkeep.html">sandbox/toydb-b/data/.gitkeep</a> b/<a href="../file/sandbox/toydb-b/data/.gitkeep.html">sandbox/toydb-b/data/.gitkeep</a></b>
<b>diff --git a/<a id="h15" href="../file/sandbox/toydb-b/toydb.yaml.html">sandbox/toydb-b/toydb.yaml</a> b/<a href="../file/sandbox/toydb-b/toydb.yaml.html">sandbox/toydb-b/toydb.yaml</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+id: toydb-b
</a><a href="#h15-0-1" id="h15-0-1" class="i">+peers:
</a><a href="#h15-0-2" id="h15-0-2" class="i">+  toydb-a: 172.20.0.101
</a><a href="#h15-0-3" id="h15-0-3" class="i">+  toydb-c: 172.20.0.103
</a><a href="#h15-0-4" id="h15-0-4" class="i">+  toydb-d: 172.20.0.104
</a><a href="#h15-0-5" id="h15-0-5" class="i">+  toydb-e: 172.20.0.105
</a><b>diff --git a/<a id="h16" href="../file/sandbox/toydb-c.yml.html">sandbox/toydb-c.yml</a> b/<a href="../file/sandbox/toydb-c.yml.html">sandbox/toydb-c.yml</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-id: toydb-c
</a><a href="#h16-0-1" id="h16-0-1" class="d">-listen: 0.0.0.0:9603
</a><b>diff --git a/<a id="h17" href="../file/sandbox/toydb-c/data/.gitkeep.html">sandbox/toydb-c/data/.gitkeep</a> b/<a href="../file/sandbox/toydb-c/data/.gitkeep.html">sandbox/toydb-c/data/.gitkeep</a></b>
<b>diff --git a/<a id="h18" href="../file/sandbox/toydb-c/toydb.yaml.html">sandbox/toydb-c/toydb.yaml</a> b/<a href="../file/sandbox/toydb-c/toydb.yaml.html">sandbox/toydb-c/toydb.yaml</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+id: toydb-c
</a><a href="#h18-0-1" id="h18-0-1" class="i">+peers:
</a><a href="#h18-0-2" id="h18-0-2" class="i">+  toydb-a: 172.20.0.101
</a><a href="#h18-0-3" id="h18-0-3" class="i">+  toydb-b: 172.20.0.102
</a><a href="#h18-0-4" id="h18-0-4" class="i">+  toydb-d: 172.20.0.104
</a><a href="#h18-0-5" id="h18-0-5" class="i">+  toydb-e: 172.20.0.105
</a><b>diff --git a/<a id="h19" href="../file/sandbox/toydb-d.yml.html">sandbox/toydb-d.yml</a> b/<a href="../file/sandbox/toydb-d.yml.html">sandbox/toydb-d.yml</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h19-0-0" id="h19-0-0" class="d">-id: toydb-d
</a><a href="#h19-0-1" id="h19-0-1" class="d">-listen: 0.0.0.0:9604
</a><b>diff --git a/<a id="h20" href="../file/sandbox/toydb-d/data/.gitkeep.html">sandbox/toydb-d/data/.gitkeep</a> b/<a href="../file/sandbox/toydb-d/data/.gitkeep.html">sandbox/toydb-d/data/.gitkeep</a></b>
<b>diff --git a/<a id="h21" href="../file/sandbox/toydb-d/toydb.yaml.html">sandbox/toydb-d/toydb.yaml</a> b/<a href="../file/sandbox/toydb-d/toydb.yaml.html">sandbox/toydb-d/toydb.yaml</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+id: toydb-d
</a><a href="#h21-0-1" id="h21-0-1" class="i">+peers:
</a><a href="#h21-0-2" id="h21-0-2" class="i">+  toydb-a: 172.20.0.101
</a><a href="#h21-0-3" id="h21-0-3" class="i">+  toydb-b: 172.20.0.102
</a><a href="#h21-0-4" id="h21-0-4" class="i">+  toydb-c: 172.20.0.103
</a><a href="#h21-0-5" id="h21-0-5" class="i">+  toydb-e: 172.20.0.105
</a><b>diff --git a/<a id="h22" href="../file/sandbox/toydb-e.yml.html">sandbox/toydb-e.yml</a> b/<a href="../file/sandbox/toydb-e.yml.html">sandbox/toydb-e.yml</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,2 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-id: toydb-e
</a><a href="#h22-0-1" id="h22-0-1" class="d">-listen: 0.0.0.0:9605
</a><b>diff --git a/<a id="h23" href="../file/sandbox/toydb-e/data/.gitkeep.html">sandbox/toydb-e/data/.gitkeep</a> b/<a href="../file/sandbox/toydb-e/data/.gitkeep.html">sandbox/toydb-e/data/.gitkeep</a></b>
<b>diff --git a/<a id="h24" href="../file/sandbox/toydb-e/toydb.yaml.html">sandbox/toydb-e/toydb.yaml</a> b/<a href="../file/sandbox/toydb-e/toydb.yaml.html">sandbox/toydb-e/toydb.yaml</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+id: toydb-e
</a><a href="#h24-0-1" id="h24-0-1" class="i">+peers:
</a><a href="#h24-0-2" id="h24-0-2" class="i">+  toydb-a: 172.20.0.101
</a><a href="#h24-0-3" id="h24-0-3" class="i">+  toydb-b: 172.20.0.102
</a><a href="#h24-0-4" id="h24-0-4" class="i">+  toydb-c: 172.20.0.103
</a><a href="#h24-0-5" id="h24-0-5" class="i">+  toydb-d: 172.20.0.104
</a><b>diff --git a/<a id="h25" href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a> b/<a href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -9,6 +9,8 @@ extern crate serde_derive;
</a> extern crate simplelog;
 extern crate toydb;
 
<a href="#h25-0-3" id="h25-0-3" class="i">+use std::collections::HashMap;
</a><a href="#h25-0-4" id="h25-0-4" class="i">+
</a> fn main() -&gt; Result&lt;(), toydb::Error&gt; {
     let opts = app_from_crate!()
         .arg(
<a href="#h25-1" id="h25-1" class="h">@@ -21,11 +23,27 @@ fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a>         )
         .get_matches();
     let cfg = Config::new(opts.value_of(&quot;config&quot;).unwrap())?;
<a href="#h25-1-3" id="h25-1-3" class="i">+
</a><a href="#h25-1-4" id="h25-1-4" class="i">+    let loglevel = cfg.log_level.parse::&lt;simplelog::LevelFilter&gt;()?;
</a>     simplelog::SimpleLogger::init(
<a href="#h25-1-6" id="h25-1-6" class="d">-        cfg.log_level.parse::&lt;simplelog::LevelFilter&gt;()?,
</a><a href="#h25-1-7" id="h25-1-7" class="d">-        simplelog::Config::default(),
</a><a href="#h25-1-8" id="h25-1-8" class="i">+        loglevel,
</a><a href="#h25-1-9" id="h25-1-9" class="i">+        simplelog::Config {
</a><a href="#h25-1-10" id="h25-1-10" class="i">+            filter_allow: match loglevel {
</a><a href="#h25-1-11" id="h25-1-11" class="i">+                simplelog::LevelFilter::Debug =&gt; None,
</a><a href="#h25-1-12" id="h25-1-12" class="i">+                _ =&gt; Some(&amp;[&quot;toydb&quot;]),
</a><a href="#h25-1-13" id="h25-1-13" class="i">+            },
</a><a href="#h25-1-14" id="h25-1-14" class="i">+            ..Default::default()
</a><a href="#h25-1-15" id="h25-1-15" class="i">+        },
</a>     )?;
<a href="#h25-1-17" id="h25-1-17" class="d">-    toydb::Server { id: cfg.id, addr: cfg.listen, threads: cfg.threads }.listen()
</a><a href="#h25-1-18" id="h25-1-18" class="i">+
</a><a href="#h25-1-19" id="h25-1-19" class="i">+    toydb::Server {
</a><a href="#h25-1-20" id="h25-1-20" class="i">+        id: cfg.id.clone(),
</a><a href="#h25-1-21" id="h25-1-21" class="i">+        peers: cfg.parse_peers()?,
</a><a href="#h25-1-22" id="h25-1-22" class="i">+        addr: cfg.listen,
</a><a href="#h25-1-23" id="h25-1-23" class="i">+        threads: cfg.threads,
</a><a href="#h25-1-24" id="h25-1-24" class="i">+        data_dir: cfg.data_dir,
</a><a href="#h25-1-25" id="h25-1-25" class="i">+    }
</a><a href="#h25-1-26" id="h25-1-26" class="i">+    .listen()
</a> }
 
 #[derive(Debug, Deserialize)]
<a href="#h25-2" id="h25-2" class="h">@@ -34,6 +52,8 @@ struct Config {
</a>     listen: String,
     threads: usize,
     log_level: String,
<a href="#h25-2-3" id="h25-2-3" class="i">+    data_dir: String,
</a><a href="#h25-2-4" id="h25-2-4" class="i">+    peers: HashMap&lt;String, String&gt;,
</a> }
 
 impl Config {
<a href="#h25-3" id="h25-3" class="h">@@ -43,9 +63,26 @@ impl Config {
</a>         c.set_default(&quot;listen&quot;, &quot;0.0.0.0:9605&quot;)?;
         c.set_default(&quot;threads&quot;, 4)?;
         c.set_default(&quot;log_level&quot;, &quot;info&quot;)?;
<a href="#h25-3-3" id="h25-3-3" class="i">+        c.set_default(&quot;data_dir&quot;, &quot;/var/lib/toydb&quot;)?;
</a> 
         c.merge(config::File::with_name(file))?;
         c.merge(config::Environment::with_prefix(&quot;TOYDB&quot;))?;
         c.try_into()
     }
<a href="#h25-3-9" id="h25-3-9" class="i">+
</a><a href="#h25-3-10" id="h25-3-10" class="i">+    fn parse_peers(&amp;self) -&gt; Result&lt;HashMap&lt;String, std::net::SocketAddr&gt;, toydb::Error&gt; {
</a><a href="#h25-3-11" id="h25-3-11" class="i">+        let mut peers = HashMap::new();
</a><a href="#h25-3-12" id="h25-3-12" class="i">+        for (id, address) in self.peers.iter() {
</a><a href="#h25-3-13" id="h25-3-13" class="i">+            peers.insert(
</a><a href="#h25-3-14" id="h25-3-14" class="i">+                id.clone(),
</a><a href="#h25-3-15" id="h25-3-15" class="i">+                if let Ok(sa) = address.parse::&lt;std::net::SocketAddr&gt;() {
</a><a href="#h25-3-16" id="h25-3-16" class="i">+                    sa
</a><a href="#h25-3-17" id="h25-3-17" class="i">+                } else {
</a><a href="#h25-3-18" id="h25-3-18" class="i">+                    let ip = address.parse::&lt;std::net::IpAddr&gt;()?;
</a><a href="#h25-3-19" id="h25-3-19" class="i">+                    std::net::SocketAddr::new(ip, 9605)
</a><a href="#h25-3-20" id="h25-3-20" class="i">+                },
</a><a href="#h25-3-21" id="h25-3-21" class="i">+            );
</a><a href="#h25-3-22" id="h25-3-22" class="i">+        }
</a><a href="#h25-3-23" id="h25-3-23" class="i">+        Ok(peers)
</a><a href="#h25-3-24" id="h25-3-24" class="i">+    }
</a> }
<b>diff --git a/<a id="h26" href="../file/src/error.rs.html">src/error.rs</a> b/<a href="../file/src/error.rs.html">src/error.rs</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,6 +1,11 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+#[derive(Clone, PartialEq)]
</a> pub enum Error {
<a href="#h26-0-2" id="h26-0-2" class="i">+    RaftBaseNotFound { index: u64, term: u64 },
</a>     Config(String),
     IO(String),
<a href="#h26-0-5" id="h26-0-5" class="i">+    Internal(String),
</a><a href="#h26-0-6" id="h26-0-6" class="i">+    Network(String),
</a><a href="#h26-0-7" id="h26-0-7" class="i">+    Value(String),
</a> }
 
 impl std::fmt::Debug for Error {
<a href="#h26-1" id="h26-1" class="h">@@ -12,7 +17,14 @@ impl std::fmt::Debug for Error {
</a> impl std::fmt::Display for Error {
     fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter) -&gt; std::fmt::Result {
         match self {
<a href="#h26-1-3" id="h26-1-3" class="d">-            Error::Config(s) | Error::IO(s) =&gt; write!(f, &quot;{}&quot;, s),
</a><a href="#h26-1-4" id="h26-1-4" class="i">+            Error::Config(s)
</a><a href="#h26-1-5" id="h26-1-5" class="i">+            | Error::IO(s)
</a><a href="#h26-1-6" id="h26-1-6" class="i">+            | Error::Internal(s)
</a><a href="#h26-1-7" id="h26-1-7" class="i">+            | Error::Network(s)
</a><a href="#h26-1-8" id="h26-1-8" class="i">+            | Error::Value(s) =&gt; write!(f, &quot;{}&quot;, s),
</a><a href="#h26-1-9" id="h26-1-9" class="i">+            Error::RaftBaseNotFound { index, term } =&gt; {
</a><a href="#h26-1-10" id="h26-1-10" class="i">+                write!(f, &quot;Base entry at index {} with term {} not found&quot;, index, term)
</a><a href="#h26-1-11" id="h26-1-11" class="i">+            }
</a>         }
     }
 }
<a href="#h26-2" id="h26-2" class="h">@@ -23,15 +35,27 @@ impl From&lt;config::ConfigError&gt; for Error {
</a>     }
 }
 
<a href="#h26-2-3" id="h26-2-3" class="i">+impl From&lt;crossbeam_channel::RecvError&gt; for Error {
</a><a href="#h26-2-4" id="h26-2-4" class="i">+    fn from(err: crossbeam_channel::RecvError) -&gt; Self {
</a><a href="#h26-2-5" id="h26-2-5" class="i">+        Error::Network(err.to_string())
</a><a href="#h26-2-6" id="h26-2-6" class="i">+    }
</a><a href="#h26-2-7" id="h26-2-7" class="i">+}
</a><a href="#h26-2-8" id="h26-2-8" class="i">+
</a><a href="#h26-2-9" id="h26-2-9" class="i">+impl&lt;T&gt; From&lt;crossbeam_channel::SendError&lt;T&gt;&gt; for Error {
</a><a href="#h26-2-10" id="h26-2-10" class="i">+    fn from(err: crossbeam_channel::SendError&lt;T&gt;) -&gt; Self {
</a><a href="#h26-2-11" id="h26-2-11" class="i">+        Error::Network(err.to_string())
</a><a href="#h26-2-12" id="h26-2-12" class="i">+    }
</a><a href="#h26-2-13" id="h26-2-13" class="i">+}
</a><a href="#h26-2-14" id="h26-2-14" class="i">+
</a> impl From&lt;grpc::Error&gt; for Error {
     fn from(err: grpc::Error) -&gt; Self {
<a href="#h26-2-17" id="h26-2-17" class="d">-        Error::IO(err.to_string())
</a><a href="#h26-2-18" id="h26-2-18" class="i">+        Error::Network(err.to_string())
</a>     }
 }
 
 impl From&lt;httpbis::Error&gt; for Error {
     fn from(err: httpbis::Error) -&gt; Self {
<a href="#h26-2-24" id="h26-2-24" class="d">-        Error::IO(err.to_string())
</a><a href="#h26-2-25" id="h26-2-25" class="i">+        Error::Network(err.to_string())
</a>     }
 }
 
<a href="#h26-3" id="h26-3" class="h">@@ -57,4 +81,22 @@ impl From&lt;rmps::encode::Error&gt; for Error {
</a>     fn from(err: rmps::encode::Error) -&gt; Self {
         Error::IO(err.to_string())
     }
<a href="#h26-3-3" id="h26-3-3" class="d">-}
</a><a href="#h26-3-4" id="h26-3-4" class="d">-\ No newline at end of file
</a><a href="#h26-3-5" id="h26-3-5" class="i">+}
</a><a href="#h26-3-6" id="h26-3-6" class="i">+
</a><a href="#h26-3-7" id="h26-3-7" class="i">+impl From&lt;std::io::Error&gt; for Error {
</a><a href="#h26-3-8" id="h26-3-8" class="i">+    fn from(err: std::io::Error) -&gt; Self {
</a><a href="#h26-3-9" id="h26-3-9" class="i">+        Error::IO(err.to_string())
</a><a href="#h26-3-10" id="h26-3-10" class="i">+    }
</a><a href="#h26-3-11" id="h26-3-11" class="i">+}
</a><a href="#h26-3-12" id="h26-3-12" class="i">+
</a><a href="#h26-3-13" id="h26-3-13" class="i">+impl From&lt;std::net::AddrParseError&gt; for Error {
</a><a href="#h26-3-14" id="h26-3-14" class="i">+    fn from(err: std::net::AddrParseError) -&gt; Self {
</a><a href="#h26-3-15" id="h26-3-15" class="i">+        Error::Network(err.to_string())
</a><a href="#h26-3-16" id="h26-3-16" class="i">+    }
</a><a href="#h26-3-17" id="h26-3-17" class="i">+}
</a><a href="#h26-3-18" id="h26-3-18" class="i">+
</a><a href="#h26-3-19" id="h26-3-19" class="i">+impl&lt;T&gt; From&lt;std::sync::PoisonError&lt;T&gt;&gt; for Error {
</a><a href="#h26-3-20" id="h26-3-20" class="i">+    fn from(err: std::sync::PoisonError&lt;T&gt;) -&gt; Self {
</a><a href="#h26-3-21" id="h26-3-21" class="i">+        Error::Internal(err.to_string())
</a><a href="#h26-3-22" id="h26-3-22" class="i">+    }
</a><a href="#h26-3-23" id="h26-3-23" class="i">+}
</a><b>diff --git a/<a id="h27" href="../file/src/kv.rs.html">src/kv.rs</a> b/<a href="../file/src/kv.rs.html">src/kv.rs</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,74 +0,0 @@
</a><a href="#h27-0-0" id="h27-0-0" class="d">-use super::Error;
</a><a href="#h27-0-1" id="h27-0-1" class="d">-use std::collections::BTreeMap;
</a><a href="#h27-0-2" id="h27-0-2" class="d">-
</a><a href="#h27-0-3" id="h27-0-3" class="d">-/// A Store is a persistent key-value store for values of type V, serialized as
</a><a href="#h27-0-4" id="h27-0-4" class="d">-/// MessagePack. It&#39;s currently implemented as a transient in-memory store while
</a><a href="#h27-0-5" id="h27-0-5" class="d">-/// prototyping the interface.
</a><a href="#h27-0-6" id="h27-0-6" class="d">-pub struct Store {
</a><a href="#h27-0-7" id="h27-0-7" class="d">-    data: BTreeMap&lt;String, Vec&lt;u8&gt;&gt;,
</a><a href="#h27-0-8" id="h27-0-8" class="d">-}
</a><a href="#h27-0-9" id="h27-0-9" class="d">-
</a><a href="#h27-0-10" id="h27-0-10" class="d">-impl Store {
</a><a href="#h27-0-11" id="h27-0-11" class="d">-    /// Creates a new Store
</a><a href="#h27-0-12" id="h27-0-12" class="d">-    pub fn new() -&gt; Self {
</a><a href="#h27-0-13" id="h27-0-13" class="d">-        Store { data: BTreeMap::new() }
</a><a href="#h27-0-14" id="h27-0-14" class="d">-    }
</a><a href="#h27-0-15" id="h27-0-15" class="d">-
</a><a href="#h27-0-16" id="h27-0-16" class="d">-    /// Deletes a value from the store
</a><a href="#h27-0-17" id="h27-0-17" class="d">-    pub fn delete(&amp;mut self, key: &amp;str) -&gt; Result&lt;bool, Error&gt; {
</a><a href="#h27-0-18" id="h27-0-18" class="d">-        Ok(self.data.remove(key).is_some())
</a><a href="#h27-0-19" id="h27-0-19" class="d">-    }
</a><a href="#h27-0-20" id="h27-0-20" class="d">-
</a><a href="#h27-0-21" id="h27-0-21" class="d">-    /// Gets a value from the store
</a><a href="#h27-0-22" id="h27-0-22" class="d">-    pub fn get&lt;&#39;de, V: serde::Deserialize&lt;&#39;de&gt;&gt;(&amp;mut self, key: &amp;str) -&gt; Result&lt;Option&lt;V&gt;, Error&gt; {
</a><a href="#h27-0-23" id="h27-0-23" class="d">-        Ok(match self.data.get(key) {
</a><a href="#h27-0-24" id="h27-0-24" class="d">-            Some(v) =&gt; Some(serde::Deserialize::deserialize(&amp;mut rmps::Deserializer::new(&amp;v[..]))?),
</a><a href="#h27-0-25" id="h27-0-25" class="d">-            None =&gt; None,
</a><a href="#h27-0-26" id="h27-0-26" class="d">-        })
</a><a href="#h27-0-27" id="h27-0-27" class="d">-    }
</a><a href="#h27-0-28" id="h27-0-28" class="d">-
</a><a href="#h27-0-29" id="h27-0-29" class="d">-    /// Sets a value in the store
</a><a href="#h27-0-30" id="h27-0-30" class="d">-    pub fn set&lt;V: serde::Serialize&gt;(&amp;mut self, key: &amp;str, value: V) -&gt; Result&lt;String, Error&gt; {
</a><a href="#h27-0-31" id="h27-0-31" class="d">-        let mut buffer = Vec::new();
</a><a href="#h27-0-32" id="h27-0-32" class="d">-        value.serialize(&amp;mut rmps::Serializer::new(&amp;mut buffer))?;
</a><a href="#h27-0-33" id="h27-0-33" class="d">-        self.data.insert(key.to_owned(), buffer);
</a><a href="#h27-0-34" id="h27-0-34" class="d">-        Ok(key.into())
</a><a href="#h27-0-35" id="h27-0-35" class="d">-    }
</a><a href="#h27-0-36" id="h27-0-36" class="d">-}
</a><a href="#h27-0-37" id="h27-0-37" class="d">-
</a><a href="#h27-0-38" id="h27-0-38" class="d">-#[cfg(test)]
</a><a href="#h27-0-39" id="h27-0-39" class="d">-mod tests {
</a><a href="#h27-0-40" id="h27-0-40" class="d">-    use super::*;
</a><a href="#h27-0-41" id="h27-0-41" class="d">-
</a><a href="#h27-0-42" id="h27-0-42" class="d">-    #[test]
</a><a href="#h27-0-43" id="h27-0-43" class="d">-    fn test_delete() {
</a><a href="#h27-0-44" id="h27-0-44" class="d">-        let mut s = Store::new();
</a><a href="#h27-0-45" id="h27-0-45" class="d">-
</a><a href="#h27-0-46" id="h27-0-46" class="d">-        s.set(&quot;a&quot;, &quot;1&quot;).unwrap();
</a><a href="#h27-0-47" id="h27-0-47" class="d">-        assert_eq!(&quot;1&quot;, s.get::&lt;String&gt;(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h27-0-48" id="h27-0-48" class="d">-
</a><a href="#h27-0-49" id="h27-0-49" class="d">-        assert_eq!(true, s.delete(&quot;a&quot;).unwrap());
</a><a href="#h27-0-50" id="h27-0-50" class="d">-        assert_eq!(None, s.get::&lt;String&gt;(&quot;a&quot;).unwrap());
</a><a href="#h27-0-51" id="h27-0-51" class="d">-
</a><a href="#h27-0-52" id="h27-0-52" class="d">-        assert_eq!(false, s.delete(&quot;b&quot;).unwrap());
</a><a href="#h27-0-53" id="h27-0-53" class="d">-    }
</a><a href="#h27-0-54" id="h27-0-54" class="d">-
</a><a href="#h27-0-55" id="h27-0-55" class="d">-    #[test]
</a><a href="#h27-0-56" id="h27-0-56" class="d">-    fn test_get() {
</a><a href="#h27-0-57" id="h27-0-57" class="d">-        let mut s = Store::new();
</a><a href="#h27-0-58" id="h27-0-58" class="d">-        s.set(&quot;a&quot;, &quot;1&quot;).unwrap();
</a><a href="#h27-0-59" id="h27-0-59" class="d">-        assert_eq!(&quot;1&quot;, s.get::&lt;String&gt;(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h27-0-60" id="h27-0-60" class="d">-        assert_eq!(None, s.get::&lt;String&gt;(&quot;b&quot;).unwrap());
</a><a href="#h27-0-61" id="h27-0-61" class="d">-    }
</a><a href="#h27-0-62" id="h27-0-62" class="d">-
</a><a href="#h27-0-63" id="h27-0-63" class="d">-    #[test]
</a><a href="#h27-0-64" id="h27-0-64" class="d">-    fn test_set() {
</a><a href="#h27-0-65" id="h27-0-65" class="d">-        let mut s = Store::new();
</a><a href="#h27-0-66" id="h27-0-66" class="d">-        s.set(&quot;a&quot;, &quot;1&quot;).unwrap();
</a><a href="#h27-0-67" id="h27-0-67" class="d">-        assert_eq!(&quot;1&quot;, s.get::&lt;String&gt;(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h27-0-68" id="h27-0-68" class="d">-        s.set(&quot;a&quot;, &quot;2&quot;).unwrap();
</a><a href="#h27-0-69" id="h27-0-69" class="d">-        assert_eq!(&quot;2&quot;, s.get::&lt;String&gt;(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h27-0-70" id="h27-0-70" class="d">-        s.set(&quot;a&quot;, 3).unwrap();
</a><a href="#h27-0-71" id="h27-0-71" class="d">-        assert_eq!(3, s.get::&lt;u64&gt;(&quot;a&quot;).unwrap().unwrap())
</a><a href="#h27-0-72" id="h27-0-72" class="d">-    }
</a><a href="#h27-0-73" id="h27-0-73" class="d">-}
</a><a href="#h27-0-74" id="h27-0-74" class="d">-\ No newline at end of file
</a><b>diff --git a/<a id="h28" href="../file/src/kv/file.rs.html">src/kv/file.rs</a> b/<a href="../file/src/kv/file.rs.html">src/kv/file.rs</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,63 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+use super::Store;
</a><a href="#h28-0-1" id="h28-0-1" class="i">+use crate::Error;
</a><a href="#h28-0-2" id="h28-0-2" class="i">+use std::collections::BTreeMap;
</a><a href="#h28-0-3" id="h28-0-3" class="i">+use std::io::Seek;
</a><a href="#h28-0-4" id="h28-0-4" class="i">+
</a><a href="#h28-0-5" id="h28-0-5" class="i">+/// A prototype on-disk key-value store. The current version keeps all data in
</a><a href="#h28-0-6" id="h28-0-6" class="i">+/// memory and writes out the entire dataset to disk on every write. It is a
</a><a href="#h28-0-7" id="h28-0-7" class="i">+/// stop-gap solution until a proper store can be written.
</a><a href="#h28-0-8" id="h28-0-8" class="i">+#[derive(Debug)]
</a><a href="#h28-0-9" id="h28-0-9" class="i">+pub struct File {
</a><a href="#h28-0-10" id="h28-0-10" class="i">+    file: std::fs::File,
</a><a href="#h28-0-11" id="h28-0-11" class="i">+    data: BTreeMap&lt;String, Vec&lt;u8&gt;&gt;,
</a><a href="#h28-0-12" id="h28-0-12" class="i">+}
</a><a href="#h28-0-13" id="h28-0-13" class="i">+
</a><a href="#h28-0-14" id="h28-0-14" class="i">+impl File {
</a><a href="#h28-0-15" id="h28-0-15" class="i">+    /// Creates a new file-backed key-value store.
</a><a href="#h28-0-16" id="h28-0-16" class="i">+    pub fn new(file: std::fs::File) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h28-0-17" id="h28-0-17" class="i">+        let data = if file.metadata()?.len() &gt; 0 {
</a><a href="#h28-0-18" id="h28-0-18" class="i">+            rmp_serde::decode::from_read(file.try_clone()?)?
</a><a href="#h28-0-19" id="h28-0-19" class="i">+        } else {
</a><a href="#h28-0-20" id="h28-0-20" class="i">+            BTreeMap::new()
</a><a href="#h28-0-21" id="h28-0-21" class="i">+        };
</a><a href="#h28-0-22" id="h28-0-22" class="i">+        Ok(Self { file, data })
</a><a href="#h28-0-23" id="h28-0-23" class="i">+    }
</a><a href="#h28-0-24" id="h28-0-24" class="i">+
</a><a href="#h28-0-25" id="h28-0-25" class="i">+    /// Writes out the entire dataset to the file.
</a><a href="#h28-0-26" id="h28-0-26" class="i">+    fn flush(&amp;mut self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h28-0-27" id="h28-0-27" class="i">+        self.file.seek(std::io::SeekFrom::Start(0))?;
</a><a href="#h28-0-28" id="h28-0-28" class="i">+        rmp_serde::encode::write(&amp;mut self.file, &amp;self.data)?;
</a><a href="#h28-0-29" id="h28-0-29" class="i">+        Ok(())
</a><a href="#h28-0-30" id="h28-0-30" class="i">+    }
</a><a href="#h28-0-31" id="h28-0-31" class="i">+}
</a><a href="#h28-0-32" id="h28-0-32" class="i">+
</a><a href="#h28-0-33" id="h28-0-33" class="i">+impl Store for File {
</a><a href="#h28-0-34" id="h28-0-34" class="i">+    fn delete(&amp;mut self, key: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h28-0-35" id="h28-0-35" class="i">+        self.data.remove(key);
</a><a href="#h28-0-36" id="h28-0-36" class="i">+        self.flush()?;
</a><a href="#h28-0-37" id="h28-0-37" class="i">+        Ok(())
</a><a href="#h28-0-38" id="h28-0-38" class="i">+    }
</a><a href="#h28-0-39" id="h28-0-39" class="i">+
</a><a href="#h28-0-40" id="h28-0-40" class="i">+    fn get(&amp;self, key: &amp;str) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h28-0-41" id="h28-0-41" class="i">+        Ok(self.data.get(key).cloned())
</a><a href="#h28-0-42" id="h28-0-42" class="i">+    }
</a><a href="#h28-0-43" id="h28-0-43" class="i">+
</a><a href="#h28-0-44" id="h28-0-44" class="i">+    fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h28-0-45" id="h28-0-45" class="i">+        self.data.insert(key.to_string(), value);
</a><a href="#h28-0-46" id="h28-0-46" class="i">+        self.flush()?;
</a><a href="#h28-0-47" id="h28-0-47" class="i">+        Ok(())
</a><a href="#h28-0-48" id="h28-0-48" class="i">+    }
</a><a href="#h28-0-49" id="h28-0-49" class="i">+}
</a><a href="#h28-0-50" id="h28-0-50" class="i">+
</a><a href="#h28-0-51" id="h28-0-51" class="i">+#[cfg(test)]
</a><a href="#h28-0-52" id="h28-0-52" class="i">+mod tests {
</a><a href="#h28-0-53" id="h28-0-53" class="i">+    extern crate tempfile;
</a><a href="#h28-0-54" id="h28-0-54" class="i">+    use super::super::tests::Suite;
</a><a href="#h28-0-55" id="h28-0-55" class="i">+    use super::*;
</a><a href="#h28-0-56" id="h28-0-56" class="i">+    use tempfile::tempfile;
</a><a href="#h28-0-57" id="h28-0-57" class="i">+
</a><a href="#h28-0-58" id="h28-0-58" class="i">+    #[test]
</a><a href="#h28-0-59" id="h28-0-59" class="i">+    fn suite() {
</a><a href="#h28-0-60" id="h28-0-60" class="i">+        Suite::new(|| Box::new(File::new(tempfile().unwrap()).unwrap())).test()
</a><a href="#h28-0-61" id="h28-0-61" class="i">+    }
</a><a href="#h28-0-62" id="h28-0-62" class="i">+}
</a><b>diff --git a/<a id="h29" href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a> b/<a href="../file/src/kv/memory.rs.html">src/kv/memory.rs</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,46 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+use super::Store;
</a><a href="#h29-0-1" id="h29-0-1" class="i">+use crate::Error;
</a><a href="#h29-0-2" id="h29-0-2" class="i">+use std::collections::BTreeMap;
</a><a href="#h29-0-3" id="h29-0-3" class="i">+use std::sync::{Arc, RwLock};
</a><a href="#h29-0-4" id="h29-0-4" class="i">+
</a><a href="#h29-0-5" id="h29-0-5" class="i">+/// An in-memory key-value store. It is primarily used for
</a><a href="#h29-0-6" id="h29-0-6" class="i">+/// prototyping and testing, and protects its internal state
</a><a href="#h29-0-7" id="h29-0-7" class="i">+/// using a arc-mutex so it can be shared between threads.
</a><a href="#h29-0-8" id="h29-0-8" class="i">+#[derive(Clone, Debug)]
</a><a href="#h29-0-9" id="h29-0-9" class="i">+pub struct Memory {
</a><a href="#h29-0-10" id="h29-0-10" class="i">+    data: Arc&lt;RwLock&lt;BTreeMap&lt;String, Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h29-0-11" id="h29-0-11" class="i">+}
</a><a href="#h29-0-12" id="h29-0-12" class="i">+
</a><a href="#h29-0-13" id="h29-0-13" class="i">+impl Memory {
</a><a href="#h29-0-14" id="h29-0-14" class="i">+    /// Creates a new Memory key-value store
</a><a href="#h29-0-15" id="h29-0-15" class="i">+    pub fn new() -&gt; Self {
</a><a href="#h29-0-16" id="h29-0-16" class="i">+        Self { data: Arc::new(RwLock::new(BTreeMap::new())) }
</a><a href="#h29-0-17" id="h29-0-17" class="i">+    }
</a><a href="#h29-0-18" id="h29-0-18" class="i">+}
</a><a href="#h29-0-19" id="h29-0-19" class="i">+
</a><a href="#h29-0-20" id="h29-0-20" class="i">+impl Store for Memory {
</a><a href="#h29-0-21" id="h29-0-21" class="i">+    fn delete(&amp;mut self, key: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h29-0-22" id="h29-0-22" class="i">+        self.data.clone().write()?.remove(key);
</a><a href="#h29-0-23" id="h29-0-23" class="i">+        Ok(())
</a><a href="#h29-0-24" id="h29-0-24" class="i">+    }
</a><a href="#h29-0-25" id="h29-0-25" class="i">+
</a><a href="#h29-0-26" id="h29-0-26" class="i">+    fn get(&amp;self, key: &amp;str) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt; {
</a><a href="#h29-0-27" id="h29-0-27" class="i">+        Ok(self.data.clone().read()?.get(key).cloned())
</a><a href="#h29-0-28" id="h29-0-28" class="i">+    }
</a><a href="#h29-0-29" id="h29-0-29" class="i">+
</a><a href="#h29-0-30" id="h29-0-30" class="i">+    fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h29-0-31" id="h29-0-31" class="i">+        self.data.clone().write()?.insert(key.to_string(), value);
</a><a href="#h29-0-32" id="h29-0-32" class="i">+        Ok(())
</a><a href="#h29-0-33" id="h29-0-33" class="i">+    }
</a><a href="#h29-0-34" id="h29-0-34" class="i">+}
</a><a href="#h29-0-35" id="h29-0-35" class="i">+
</a><a href="#h29-0-36" id="h29-0-36" class="i">+#[cfg(test)]
</a><a href="#h29-0-37" id="h29-0-37" class="i">+mod tests {
</a><a href="#h29-0-38" id="h29-0-38" class="i">+    use super::super::tests::Suite;
</a><a href="#h29-0-39" id="h29-0-39" class="i">+    use super::*;
</a><a href="#h29-0-40" id="h29-0-40" class="i">+
</a><a href="#h29-0-41" id="h29-0-41" class="i">+    #[test]
</a><a href="#h29-0-42" id="h29-0-42" class="i">+    fn suite() {
</a><a href="#h29-0-43" id="h29-0-43" class="i">+        Suite::new(|| Box::new(Memory::new())).test()
</a><a href="#h29-0-44" id="h29-0-44" class="i">+    }
</a><a href="#h29-0-45" id="h29-0-45" class="i">+}
</a><b>diff --git a/<a id="h30" href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a> b/<a href="../file/src/kv/mod.rs.html">src/kv/mod.rs</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,72 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+mod file;
</a><a href="#h30-0-1" id="h30-0-1" class="i">+#[cfg(test)]
</a><a href="#h30-0-2" id="h30-0-2" class="i">+mod memory;
</a><a href="#h30-0-3" id="h30-0-3" class="i">+
</a><a href="#h30-0-4" id="h30-0-4" class="i">+use crate::Error;
</a><a href="#h30-0-5" id="h30-0-5" class="i">+pub use file::File;
</a><a href="#h30-0-6" id="h30-0-6" class="i">+#[cfg(test)]
</a><a href="#h30-0-7" id="h30-0-7" class="i">+pub use memory::Memory;
</a><a href="#h30-0-8" id="h30-0-8" class="i">+
</a><a href="#h30-0-9" id="h30-0-9" class="i">+/// A key-value store
</a><a href="#h30-0-10" id="h30-0-10" class="i">+pub trait Store: &#39;static + Sync + Send + std::fmt::Debug {
</a><a href="#h30-0-11" id="h30-0-11" class="i">+    /// Deletes a value in the store, regardless of whether it existed before.
</a><a href="#h30-0-12" id="h30-0-12" class="i">+    fn delete(&amp;mut self, key: &amp;str) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h30-0-13" id="h30-0-13" class="i">+
</a><a href="#h30-0-14" id="h30-0-14" class="i">+    /// Gets a value from the store
</a><a href="#h30-0-15" id="h30-0-15" class="i">+    fn get(&amp;self, key: &amp;str) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;, Error&gt;;
</a><a href="#h30-0-16" id="h30-0-16" class="i">+
</a><a href="#h30-0-17" id="h30-0-17" class="i">+    /// Sets a value in the store
</a><a href="#h30-0-18" id="h30-0-18" class="i">+    fn set(&amp;mut self, key: &amp;str, value: Vec&lt;u8&gt;) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h30-0-19" id="h30-0-19" class="i">+}
</a><a href="#h30-0-20" id="h30-0-20" class="i">+
</a><a href="#h30-0-21" id="h30-0-21" class="i">+#[cfg(test)]
</a><a href="#h30-0-22" id="h30-0-22" class="i">+pub mod tests {
</a><a href="#h30-0-23" id="h30-0-23" class="i">+    use super::*;
</a><a href="#h30-0-24" id="h30-0-24" class="i">+
</a><a href="#h30-0-25" id="h30-0-25" class="i">+    pub struct Suite {
</a><a href="#h30-0-26" id="h30-0-26" class="i">+        factory: Box&lt;Fn() -&gt; Box&lt;Store&gt;&gt;,
</a><a href="#h30-0-27" id="h30-0-27" class="i">+    }
</a><a href="#h30-0-28" id="h30-0-28" class="i">+
</a><a href="#h30-0-29" id="h30-0-29" class="i">+    impl Suite {
</a><a href="#h30-0-30" id="h30-0-30" class="i">+        pub fn new&lt;F&gt;(setup: F) -&gt; Self
</a><a href="#h30-0-31" id="h30-0-31" class="i">+        where
</a><a href="#h30-0-32" id="h30-0-32" class="i">+            F: &#39;static + Fn() -&gt; Box&lt;Store&gt;,
</a><a href="#h30-0-33" id="h30-0-33" class="i">+        {
</a><a href="#h30-0-34" id="h30-0-34" class="i">+            Self { factory: Box::new(setup) }
</a><a href="#h30-0-35" id="h30-0-35" class="i">+        }
</a><a href="#h30-0-36" id="h30-0-36" class="i">+
</a><a href="#h30-0-37" id="h30-0-37" class="i">+        fn setup(&amp;self) -&gt; Box&lt;Store&gt; {
</a><a href="#h30-0-38" id="h30-0-38" class="i">+            (&amp;self.factory)()
</a><a href="#h30-0-39" id="h30-0-39" class="i">+        }
</a><a href="#h30-0-40" id="h30-0-40" class="i">+
</a><a href="#h30-0-41" id="h30-0-41" class="i">+        pub fn test(&amp;self) {
</a><a href="#h30-0-42" id="h30-0-42" class="i">+            self.test_delete();
</a><a href="#h30-0-43" id="h30-0-43" class="i">+            self.test_get();
</a><a href="#h30-0-44" id="h30-0-44" class="i">+            self.test_set();
</a><a href="#h30-0-45" id="h30-0-45" class="i">+        }
</a><a href="#h30-0-46" id="h30-0-46" class="i">+
</a><a href="#h30-0-47" id="h30-0-47" class="i">+        pub fn test_delete(&amp;self) {
</a><a href="#h30-0-48" id="h30-0-48" class="i">+            let mut s = self.setup();
</a><a href="#h30-0-49" id="h30-0-49" class="i">+            s.set(&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h30-0-50" id="h30-0-50" class="i">+            assert_eq!(vec![0x01], s.get(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h30-0-51" id="h30-0-51" class="i">+            s.delete(&quot;a&quot;).unwrap();
</a><a href="#h30-0-52" id="h30-0-52" class="i">+            assert_eq!(None, s.get(&quot;a&quot;).unwrap());
</a><a href="#h30-0-53" id="h30-0-53" class="i">+            s.delete(&quot;b&quot;).unwrap();
</a><a href="#h30-0-54" id="h30-0-54" class="i">+        }
</a><a href="#h30-0-55" id="h30-0-55" class="i">+
</a><a href="#h30-0-56" id="h30-0-56" class="i">+        pub fn test_get(&amp;self) {
</a><a href="#h30-0-57" id="h30-0-57" class="i">+            let mut s = self.setup();
</a><a href="#h30-0-58" id="h30-0-58" class="i">+            s.set(&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h30-0-59" id="h30-0-59" class="i">+            assert_eq!(vec![0x01], s.get(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h30-0-60" id="h30-0-60" class="i">+            assert_eq!(None, s.get(&quot;b&quot;).unwrap());
</a><a href="#h30-0-61" id="h30-0-61" class="i">+        }
</a><a href="#h30-0-62" id="h30-0-62" class="i">+
</a><a href="#h30-0-63" id="h30-0-63" class="i">+        pub fn test_set(&amp;self) {
</a><a href="#h30-0-64" id="h30-0-64" class="i">+            let mut s = self.setup();
</a><a href="#h30-0-65" id="h30-0-65" class="i">+            s.set(&quot;a&quot;, vec![0x01]).unwrap();
</a><a href="#h30-0-66" id="h30-0-66" class="i">+            assert_eq!(vec![0x01], s.get(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h30-0-67" id="h30-0-67" class="i">+            s.set(&quot;a&quot;, vec![0x02]).unwrap();
</a><a href="#h30-0-68" id="h30-0-68" class="i">+            assert_eq!(vec![0x02], s.get(&quot;a&quot;).unwrap().unwrap());
</a><a href="#h30-0-69" id="h30-0-69" class="i">+        }
</a><a href="#h30-0-70" id="h30-0-70" class="i">+    }
</a><a href="#h30-0-71" id="h30-0-71" class="i">+}
</a><b>diff --git a/<a id="h31" href="../file/src/lib.rs.html">src/lib.rs</a> b/<a href="../file/src/lib.rs.html">src/lib.rs</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,16 +1,26 @@
</a> #![warn(clippy::all)]
 
<a href="#h31-0-2" id="h31-0-2" class="i">+#[cfg(test)]
</a><a href="#h31-0-3" id="h31-0-3" class="i">+#[macro_use]
</a><a href="#h31-0-4" id="h31-0-4" class="i">+extern crate assert_matches;
</a> extern crate config;
<a href="#h31-0-6" id="h31-0-6" class="i">+#[macro_use(select)]
</a><a href="#h31-0-7" id="h31-0-7" class="i">+extern crate crossbeam_channel;
</a> extern crate httpbis;
 #[macro_use]
 extern crate log;
<a href="#h31-0-11" id="h31-0-11" class="i">+extern crate rand;
</a> extern crate rmp_serde as rmps;
 extern crate serde;
<a href="#h31-0-14" id="h31-0-14" class="i">+extern crate uuid;
</a> 
 mod error;
 mod kv;
<a href="#h31-0-18" id="h31-0-18" class="i">+mod raft;
</a> mod server;
 mod service;
<a href="#h31-0-21" id="h31-0-21" class="i">+mod state;
</a><a href="#h31-0-22" id="h31-0-22" class="i">+mod utility;
</a> 
 pub use error::Error;
 pub use server::Server;
<b>diff --git a/<a id="h32" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,678 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+use super::state::State;
</a><a href="#h32-0-1" id="h32-0-1" class="i">+use crate::kv;
</a><a href="#h32-0-2" id="h32-0-2" class="i">+use crate::Error;
</a><a href="#h32-0-3" id="h32-0-3" class="i">+use serde_derive::{Deserialize, Serialize};
</a><a href="#h32-0-4" id="h32-0-4" class="i">+
</a><a href="#h32-0-5" id="h32-0-5" class="i">+/// A replicated log entry
</a><a href="#h32-0-6" id="h32-0-6" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h32-0-7" id="h32-0-7" class="i">+pub struct Entry {
</a><a href="#h32-0-8" id="h32-0-8" class="i">+    /// The term in which the entry was added
</a><a href="#h32-0-9" id="h32-0-9" class="i">+    pub term: u64,
</a><a href="#h32-0-10" id="h32-0-10" class="i">+    /// The state machine command. None is used to commit noops during leader election.
</a><a href="#h32-0-11" id="h32-0-11" class="i">+    pub command: Option&lt;Vec&lt;u8&gt;&gt;,
</a><a href="#h32-0-12" id="h32-0-12" class="i">+}
</a><a href="#h32-0-13" id="h32-0-13" class="i">+
</a><a href="#h32-0-14" id="h32-0-14" class="i">+/// The replicated Raft log
</a><a href="#h32-0-15" id="h32-0-15" class="i">+#[derive(Debug)]
</a><a href="#h32-0-16" id="h32-0-16" class="i">+pub struct Log {
</a><a href="#h32-0-17" id="h32-0-17" class="i">+    /// The underlying key-value store
</a><a href="#h32-0-18" id="h32-0-18" class="i">+    kv: Box&lt;kv::Store&gt;,
</a><a href="#h32-0-19" id="h32-0-19" class="i">+    /// The index of the last stored entry.
</a><a href="#h32-0-20" id="h32-0-20" class="i">+    last_index: u64,
</a><a href="#h32-0-21" id="h32-0-21" class="i">+    /// The term of the last stored entry.
</a><a href="#h32-0-22" id="h32-0-22" class="i">+    last_term: u64,
</a><a href="#h32-0-23" id="h32-0-23" class="i">+    /// The last entry known to be committed. Not persisted,
</a><a href="#h32-0-24" id="h32-0-24" class="i">+    /// since leaders will determine this when they&#39;re elected.
</a><a href="#h32-0-25" id="h32-0-25" class="i">+    commit_index: u64,
</a><a href="#h32-0-26" id="h32-0-26" class="i">+    /// The term of the last committed entry.
</a><a href="#h32-0-27" id="h32-0-27" class="i">+    commit_term: u64,
</a><a href="#h32-0-28" id="h32-0-28" class="i">+    /// The last entry applied to the state machine. This is
</a><a href="#h32-0-29" id="h32-0-29" class="i">+    /// persisted, since the state machine is also persisted.
</a><a href="#h32-0-30" id="h32-0-30" class="i">+    apply_index: u64,
</a><a href="#h32-0-31" id="h32-0-31" class="i">+    /// The term of the last applied entry.
</a><a href="#h32-0-32" id="h32-0-32" class="i">+    apply_term: u64,
</a><a href="#h32-0-33" id="h32-0-33" class="i">+}
</a><a href="#h32-0-34" id="h32-0-34" class="i">+
</a><a href="#h32-0-35" id="h32-0-35" class="i">+impl Log {
</a><a href="#h32-0-36" id="h32-0-36" class="i">+    /// Creates a new log, using a kv::Store for storage.
</a><a href="#h32-0-37" id="h32-0-37" class="i">+    pub fn new&lt;S: kv::Store&gt;(store: S) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h32-0-38" id="h32-0-38" class="i">+        let apply_index = match store.get(&quot;apply_index&quot;)? {
</a><a href="#h32-0-39" id="h32-0-39" class="i">+            Some(v) =&gt; Self::deserialize(v)?,
</a><a href="#h32-0-40" id="h32-0-40" class="i">+            None =&gt; 0,
</a><a href="#h32-0-41" id="h32-0-41" class="i">+        };
</a><a href="#h32-0-42" id="h32-0-42" class="i">+        let (commit_index, commit_term) = match store.get(&amp;apply_index.to_string())? {
</a><a href="#h32-0-43" id="h32-0-43" class="i">+            Some(raw_entry) =&gt; (apply_index, Self::deserialize::&lt;Entry&gt;(raw_entry)?.term),
</a><a href="#h32-0-44" id="h32-0-44" class="i">+            None if apply_index == 0 =&gt; (0, 0),
</a><a href="#h32-0-45" id="h32-0-45" class="i">+            None =&gt; {
</a><a href="#h32-0-46" id="h32-0-46" class="i">+                return Err(Error::Internal(format!(&quot;Applied entry {} not found&quot;, apply_index)))
</a><a href="#h32-0-47" id="h32-0-47" class="i">+            }
</a><a href="#h32-0-48" id="h32-0-48" class="i">+        };
</a><a href="#h32-0-49" id="h32-0-49" class="i">+        let apply_term = commit_term;
</a><a href="#h32-0-50" id="h32-0-50" class="i">+        // FIXME This really needs to be done in a better way.
</a><a href="#h32-0-51" id="h32-0-51" class="i">+        let (mut last_index, mut last_term) = (0, 0);
</a><a href="#h32-0-52" id="h32-0-52" class="i">+        for i in 1..std::u64::MAX {
</a><a href="#h32-0-53" id="h32-0-53" class="i">+            if let Some(e) = store.get(&amp;i.to_string())? {
</a><a href="#h32-0-54" id="h32-0-54" class="i">+                let entry: Entry = Self::deserialize(e)?;
</a><a href="#h32-0-55" id="h32-0-55" class="i">+                last_index = i;
</a><a href="#h32-0-56" id="h32-0-56" class="i">+                last_term = entry.term;
</a><a href="#h32-0-57" id="h32-0-57" class="i">+            } else {
</a><a href="#h32-0-58" id="h32-0-58" class="i">+                break;
</a><a href="#h32-0-59" id="h32-0-59" class="i">+            }
</a><a href="#h32-0-60" id="h32-0-60" class="i">+        }
</a><a href="#h32-0-61" id="h32-0-61" class="i">+        Ok(Self {
</a><a href="#h32-0-62" id="h32-0-62" class="i">+            kv: Box::new(store),
</a><a href="#h32-0-63" id="h32-0-63" class="i">+            last_index,
</a><a href="#h32-0-64" id="h32-0-64" class="i">+            last_term,
</a><a href="#h32-0-65" id="h32-0-65" class="i">+            commit_index,
</a><a href="#h32-0-66" id="h32-0-66" class="i">+            commit_term,
</a><a href="#h32-0-67" id="h32-0-67" class="i">+            apply_index,
</a><a href="#h32-0-68" id="h32-0-68" class="i">+            apply_term,
</a><a href="#h32-0-69" id="h32-0-69" class="i">+        })
</a><a href="#h32-0-70" id="h32-0-70" class="i">+    }
</a><a href="#h32-0-71" id="h32-0-71" class="i">+
</a><a href="#h32-0-72" id="h32-0-72" class="i">+    /// Appends an entry to the log
</a><a href="#h32-0-73" id="h32-0-73" class="i">+    pub fn append(&amp;mut self, entry: Entry) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h32-0-74" id="h32-0-74" class="i">+        debug!(&quot;Appending log entry {}: {:?}&quot;, self.last_index + 1, entry);
</a><a href="#h32-0-75" id="h32-0-75" class="i">+        let index = self.last_index + 1;
</a><a href="#h32-0-76" id="h32-0-76" class="i">+        self.last_index = index;
</a><a href="#h32-0-77" id="h32-0-77" class="i">+        self.last_term = entry.term;
</a><a href="#h32-0-78" id="h32-0-78" class="i">+        self.kv.set(&amp;index.to_string(), Self::serialize(entry)?)?;
</a><a href="#h32-0-79" id="h32-0-79" class="i">+        Ok(index)
</a><a href="#h32-0-80" id="h32-0-80" class="i">+    }
</a><a href="#h32-0-81" id="h32-0-81" class="i">+
</a><a href="#h32-0-82" id="h32-0-82" class="i">+    /// Applies the next committed entry to the state machine, if any.
</a><a href="#h32-0-83" id="h32-0-83" class="i">+    /// Returns the applied entry index and output, or None if no entry.
</a><a href="#h32-0-84" id="h32-0-84" class="i">+    #[allow(clippy::borrowed_box)] // Currently this is correct
</a><a href="#h32-0-85" id="h32-0-85" class="i">+    pub fn apply(&amp;mut self, state: &amp;mut Box&lt;State&gt;) -&gt; Result&lt;Option&lt;(u64, Vec&lt;u8&gt;)&gt;, Error&gt; {
</a><a href="#h32-0-86" id="h32-0-86" class="i">+        if self.apply_index &gt;= self.commit_index {
</a><a href="#h32-0-87" id="h32-0-87" class="i">+            return Ok(None);
</a><a href="#h32-0-88" id="h32-0-88" class="i">+        }
</a><a href="#h32-0-89" id="h32-0-89" class="i">+
</a><a href="#h32-0-90" id="h32-0-90" class="i">+        let mut output = vec![];
</a><a href="#h32-0-91" id="h32-0-91" class="i">+        if let Some(entry) = self.get(self.apply_index + 1)? {
</a><a href="#h32-0-92" id="h32-0-92" class="i">+            debug!(&quot;Applying log entry {}: {:?}&quot;, self.apply_index + 1, entry);
</a><a href="#h32-0-93" id="h32-0-93" class="i">+            if let Some(command) = entry.command {
</a><a href="#h32-0-94" id="h32-0-94" class="i">+                output = state.mutate(command)?;
</a><a href="#h32-0-95" id="h32-0-95" class="i">+            }
</a><a href="#h32-0-96" id="h32-0-96" class="i">+            self.apply_index += 1;
</a><a href="#h32-0-97" id="h32-0-97" class="i">+            self.apply_term = entry.term;
</a><a href="#h32-0-98" id="h32-0-98" class="i">+        }
</a><a href="#h32-0-99" id="h32-0-99" class="i">+        self.kv.set(&quot;apply_index&quot;, Self::serialize(self.apply_index)?)?;
</a><a href="#h32-0-100" id="h32-0-100" class="i">+        Ok(Some((self.apply_index, output)))
</a><a href="#h32-0-101" id="h32-0-101" class="i">+    }
</a><a href="#h32-0-102" id="h32-0-102" class="i">+
</a><a href="#h32-0-103" id="h32-0-103" class="i">+    /// Commits entries up to and including an index
</a><a href="#h32-0-104" id="h32-0-104" class="i">+    pub fn commit(&amp;mut self, mut index: u64) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h32-0-105" id="h32-0-105" class="i">+        index = std::cmp::min(index, self.last_index);
</a><a href="#h32-0-106" id="h32-0-106" class="i">+        index = std::cmp::max(index, self.commit_index);
</a><a href="#h32-0-107" id="h32-0-107" class="i">+        if index != self.commit_index {
</a><a href="#h32-0-108" id="h32-0-108" class="i">+            if let Some(entry) = self.get(index)? {
</a><a href="#h32-0-109" id="h32-0-109" class="i">+                debug!(&quot;Committing log entry {}&quot;, index);
</a><a href="#h32-0-110" id="h32-0-110" class="i">+                self.commit_index = index;
</a><a href="#h32-0-111" id="h32-0-111" class="i">+                self.commit_term = entry.term;
</a><a href="#h32-0-112" id="h32-0-112" class="i">+            } else {
</a><a href="#h32-0-113" id="h32-0-113" class="i">+                return Err(Error::Internal(format!(
</a><a href="#h32-0-114" id="h32-0-114" class="i">+                    &quot;Entry at commit index {} does not exist&quot;,
</a><a href="#h32-0-115" id="h32-0-115" class="i">+                    index
</a><a href="#h32-0-116" id="h32-0-116" class="i">+                )));
</a><a href="#h32-0-117" id="h32-0-117" class="i">+            }
</a><a href="#h32-0-118" id="h32-0-118" class="i">+        }
</a><a href="#h32-0-119" id="h32-0-119" class="i">+        Ok(index)
</a><a href="#h32-0-120" id="h32-0-120" class="i">+    }
</a><a href="#h32-0-121" id="h32-0-121" class="i">+
</a><a href="#h32-0-122" id="h32-0-122" class="i">+    /// Fetches an entry at an index
</a><a href="#h32-0-123" id="h32-0-123" class="i">+    pub fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Entry&gt;, Error&gt; {
</a><a href="#h32-0-124" id="h32-0-124" class="i">+        if let Some(value) = self.kv.get(&amp;index.to_string())? {
</a><a href="#h32-0-125" id="h32-0-125" class="i">+            Ok(Some(Self::deserialize(value)?))
</a><a href="#h32-0-126" id="h32-0-126" class="i">+        } else {
</a><a href="#h32-0-127" id="h32-0-127" class="i">+            Ok(None)
</a><a href="#h32-0-128" id="h32-0-128" class="i">+        }
</a><a href="#h32-0-129" id="h32-0-129" class="i">+    }
</a><a href="#h32-0-130" id="h32-0-130" class="i">+
</a><a href="#h32-0-131" id="h32-0-131" class="i">+    /// Fetches the last applied index and term
</a><a href="#h32-0-132" id="h32-0-132" class="i">+    pub fn get_applied(&amp;self) -&gt; (u64, u64) {
</a><a href="#h32-0-133" id="h32-0-133" class="i">+        (self.apply_index, self.apply_term)
</a><a href="#h32-0-134" id="h32-0-134" class="i">+    }
</a><a href="#h32-0-135" id="h32-0-135" class="i">+
</a><a href="#h32-0-136" id="h32-0-136" class="i">+    /// Fetches the last committed index and term
</a><a href="#h32-0-137" id="h32-0-137" class="i">+    pub fn get_committed(&amp;self) -&gt; (u64, u64) {
</a><a href="#h32-0-138" id="h32-0-138" class="i">+        (self.commit_index, self.commit_term)
</a><a href="#h32-0-139" id="h32-0-139" class="i">+    }
</a><a href="#h32-0-140" id="h32-0-140" class="i">+
</a><a href="#h32-0-141" id="h32-0-141" class="i">+    /// Fetches the last stored index and term
</a><a href="#h32-0-142" id="h32-0-142" class="i">+    pub fn get_last(&amp;self) -&gt; (u64, u64) {
</a><a href="#h32-0-143" id="h32-0-143" class="i">+        (self.last_index, self.last_term)
</a><a href="#h32-0-144" id="h32-0-144" class="i">+    }
</a><a href="#h32-0-145" id="h32-0-145" class="i">+
</a><a href="#h32-0-146" id="h32-0-146" class="i">+    /// Checks if the log contains an entry
</a><a href="#h32-0-147" id="h32-0-147" class="i">+    pub fn has(&amp;self, index: u64, term: u64) -&gt; Result&lt;bool, Error&gt; {
</a><a href="#h32-0-148" id="h32-0-148" class="i">+        if index == 0 &amp;&amp; term == 0 {
</a><a href="#h32-0-149" id="h32-0-149" class="i">+            return Ok(true);
</a><a href="#h32-0-150" id="h32-0-150" class="i">+        }
</a><a href="#h32-0-151" id="h32-0-151" class="i">+        match self.get(index)? {
</a><a href="#h32-0-152" id="h32-0-152" class="i">+            Some(ref entry) =&gt; Ok(entry.term == term),
</a><a href="#h32-0-153" id="h32-0-153" class="i">+            None =&gt; Ok(false),
</a><a href="#h32-0-154" id="h32-0-154" class="i">+        }
</a><a href="#h32-0-155" id="h32-0-155" class="i">+    }
</a><a href="#h32-0-156" id="h32-0-156" class="i">+
</a><a href="#h32-0-157" id="h32-0-157" class="i">+    /// Fetches a range of entries
</a><a href="#h32-0-158" id="h32-0-158" class="i">+    // FIXME Should take all kinds of ranges (generic over std::ops::RangeBounds),
</a><a href="#h32-0-159" id="h32-0-159" class="i">+    // and use kv::Store.range() once implemented.
</a><a href="#h32-0-160" id="h32-0-160" class="i">+    pub fn range(&amp;self, range: std::ops::RangeFrom&lt;u64&gt;) -&gt; Result&lt;Vec&lt;Entry&gt;, Error&gt; {
</a><a href="#h32-0-161" id="h32-0-161" class="i">+        let mut entries = Vec::new();
</a><a href="#h32-0-162" id="h32-0-162" class="i">+        for i in range.start..=self.last_index {
</a><a href="#h32-0-163" id="h32-0-163" class="i">+            if let Some(entry) = self.get(i)? {
</a><a href="#h32-0-164" id="h32-0-164" class="i">+                entries.push(entry)
</a><a href="#h32-0-165" id="h32-0-165" class="i">+            }
</a><a href="#h32-0-166" id="h32-0-166" class="i">+        }
</a><a href="#h32-0-167" id="h32-0-167" class="i">+        Ok(entries)
</a><a href="#h32-0-168" id="h32-0-168" class="i">+    }
</a><a href="#h32-0-169" id="h32-0-169" class="i">+
</a><a href="#h32-0-170" id="h32-0-170" class="i">+    /// Splices a set of entries onto an offset. The semantics are a bit unusual,
</a><a href="#h32-0-171" id="h32-0-171" class="i">+    /// since this is primarily used when replicating Raft entries:
</a><a href="#h32-0-172" id="h32-0-172" class="i">+    ///
</a><a href="#h32-0-173" id="h32-0-173" class="i">+    /// * If the base and base term does not match an existing entry, raise Error::RaftBaseNotFound
</a><a href="#h32-0-174" id="h32-0-174" class="i">+    /// * If no existing entry exists at an index, append it
</a><a href="#h32-0-175" id="h32-0-175" class="i">+    /// * If the existing entry has a different term, replace it and following entries
</a><a href="#h32-0-176" id="h32-0-176" class="i">+    /// * If the existing entry has the same term, assume entry is equal and skip it
</a><a href="#h32-0-177" id="h32-0-177" class="i">+    //
</a><a href="#h32-0-178" id="h32-0-178" class="i">+    // FIXME Needs to be transactional
</a><a href="#h32-0-179" id="h32-0-179" class="i">+    pub fn splice(&amp;mut self, base: u64, base_term: u64, entries: Vec&lt;Entry&gt;) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h32-0-180" id="h32-0-180" class="i">+        if base &gt; 0 &amp;&amp; !self.has(base, base_term)? {
</a><a href="#h32-0-181" id="h32-0-181" class="i">+            return Err(Error::RaftBaseNotFound { index: base, term: base_term });
</a><a href="#h32-0-182" id="h32-0-182" class="i">+        }
</a><a href="#h32-0-183" id="h32-0-183" class="i">+
</a><a href="#h32-0-184" id="h32-0-184" class="i">+        for (i, entry) in entries.into_iter().enumerate() {
</a><a href="#h32-0-185" id="h32-0-185" class="i">+            if let Some(ref current) = self.get(base + i as u64 + 1)? {
</a><a href="#h32-0-186" id="h32-0-186" class="i">+                if current.term == entry.term {
</a><a href="#h32-0-187" id="h32-0-187" class="i">+                    continue;
</a><a href="#h32-0-188" id="h32-0-188" class="i">+                }
</a><a href="#h32-0-189" id="h32-0-189" class="i">+                self.truncate(base + i as u64)?;
</a><a href="#h32-0-190" id="h32-0-190" class="i">+            }
</a><a href="#h32-0-191" id="h32-0-191" class="i">+            self.append(entry)?;
</a><a href="#h32-0-192" id="h32-0-192" class="i">+        }
</a><a href="#h32-0-193" id="h32-0-193" class="i">+        Ok(self.last_index)
</a><a href="#h32-0-194" id="h32-0-194" class="i">+    }
</a><a href="#h32-0-195" id="h32-0-195" class="i">+
</a><a href="#h32-0-196" id="h32-0-196" class="i">+    /// Truncates the log such that its last item is at most index.
</a><a href="#h32-0-197" id="h32-0-197" class="i">+    /// Refuses to remove entries that have been applied or committed.
</a><a href="#h32-0-198" id="h32-0-198" class="i">+    pub fn truncate(&amp;mut self, index: u64) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h32-0-199" id="h32-0-199" class="i">+        debug!(&quot;Truncating log from entry {}&quot;, index);
</a><a href="#h32-0-200" id="h32-0-200" class="i">+        if index &lt; self.apply_index {
</a><a href="#h32-0-201" id="h32-0-201" class="i">+            return Err(Error::Value(&quot;Cannot remove applied log entry&quot;.into()));
</a><a href="#h32-0-202" id="h32-0-202" class="i">+        } else if index &lt; self.commit_index {
</a><a href="#h32-0-203" id="h32-0-203" class="i">+            return Err(Error::Value(&quot;Cannot remove committed log entry&quot;.into()));
</a><a href="#h32-0-204" id="h32-0-204" class="i">+        }
</a><a href="#h32-0-205" id="h32-0-205" class="i">+
</a><a href="#h32-0-206" id="h32-0-206" class="i">+        // FIXME This shouldn&#39;t rely on last_index
</a><a href="#h32-0-207" id="h32-0-207" class="i">+        for i in (index + 1)..=self.last_index {
</a><a href="#h32-0-208" id="h32-0-208" class="i">+            self.kv.delete(&amp;i.to_string())?
</a><a href="#h32-0-209" id="h32-0-209" class="i">+        }
</a><a href="#h32-0-210" id="h32-0-210" class="i">+        self.last_index = std::cmp::min(index, self.last_index);
</a><a href="#h32-0-211" id="h32-0-211" class="i">+        self.last_term = self.get(self.last_index)?.map(|e| e.term).unwrap_or(0);
</a><a href="#h32-0-212" id="h32-0-212" class="i">+        Ok(self.last_index)
</a><a href="#h32-0-213" id="h32-0-213" class="i">+    }
</a><a href="#h32-0-214" id="h32-0-214" class="i">+
</a><a href="#h32-0-215" id="h32-0-215" class="i">+    /// Loads information about the most recent term known by the log,
</a><a href="#h32-0-216" id="h32-0-216" class="i">+    /// containing the term number (0 if none) and candidate voted for
</a><a href="#h32-0-217" id="h32-0-217" class="i">+    /// in current term (if any).
</a><a href="#h32-0-218" id="h32-0-218" class="i">+    pub fn load_term(&amp;self) -&gt; Result&lt;(u64, Option&lt;String&gt;), Error&gt; {
</a><a href="#h32-0-219" id="h32-0-219" class="i">+        let term =
</a><a href="#h32-0-220" id="h32-0-220" class="i">+            if let Some(value) = self.kv.get(&quot;term&quot;)? { Self::deserialize(value)? } else { 0 };
</a><a href="#h32-0-221" id="h32-0-221" class="i">+        let voted_for = if let Some(value) = self.kv.get(&quot;voted_for&quot;)? {
</a><a href="#h32-0-222" id="h32-0-222" class="i">+            Some(Self::deserialize(value)?)
</a><a href="#h32-0-223" id="h32-0-223" class="i">+        } else {
</a><a href="#h32-0-224" id="h32-0-224" class="i">+            None
</a><a href="#h32-0-225" id="h32-0-225" class="i">+        };
</a><a href="#h32-0-226" id="h32-0-226" class="i">+        debug!(&quot;Loaded term {} and voted_for {:?} from log&quot;, term, voted_for);
</a><a href="#h32-0-227" id="h32-0-227" class="i">+        Ok((term, voted_for))
</a><a href="#h32-0-228" id="h32-0-228" class="i">+    }
</a><a href="#h32-0-229" id="h32-0-229" class="i">+
</a><a href="#h32-0-230" id="h32-0-230" class="i">+    /// Saves information about the most recent term.
</a><a href="#h32-0-231" id="h32-0-231" class="i">+    // FIXME Should be transactional.
</a><a href="#h32-0-232" id="h32-0-232" class="i">+    pub fn save_term(&amp;mut self, term: u64, voted_for: Option&lt;&amp;str&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h32-0-233" id="h32-0-233" class="i">+        if term &gt; 0 {
</a><a href="#h32-0-234" id="h32-0-234" class="i">+            self.kv.set(&quot;term&quot;, Self::serialize(term)?)?
</a><a href="#h32-0-235" id="h32-0-235" class="i">+        } else {
</a><a href="#h32-0-236" id="h32-0-236" class="i">+            self.kv.delete(&quot;term&quot;)?
</a><a href="#h32-0-237" id="h32-0-237" class="i">+        }
</a><a href="#h32-0-238" id="h32-0-238" class="i">+        if let Some(v) = voted_for {
</a><a href="#h32-0-239" id="h32-0-239" class="i">+            self.kv.set(&quot;voted_for&quot;, Self::serialize(v)?)?
</a><a href="#h32-0-240" id="h32-0-240" class="i">+        } else {
</a><a href="#h32-0-241" id="h32-0-241" class="i">+            self.kv.delete(&quot;voted_for&quot;)?
</a><a href="#h32-0-242" id="h32-0-242" class="i">+        }
</a><a href="#h32-0-243" id="h32-0-243" class="i">+        debug!(&quot;Saved term={} and voted_for={:?}&quot;, term, voted_for);
</a><a href="#h32-0-244" id="h32-0-244" class="i">+        Ok(())
</a><a href="#h32-0-245" id="h32-0-245" class="i">+    }
</a><a href="#h32-0-246" id="h32-0-246" class="i">+
</a><a href="#h32-0-247" id="h32-0-247" class="i">+    /// Deserializes a value from a byte buffer
</a><a href="#h32-0-248" id="h32-0-248" class="i">+    fn deserialize&lt;&#39;de, V: serde::Deserialize&lt;&#39;de&gt;&gt;(bytes: Vec&lt;u8&gt;) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h32-0-249" id="h32-0-249" class="i">+        Ok(serde::Deserialize::deserialize(&amp;mut rmps::Deserializer::new(&amp;bytes[..]))?)
</a><a href="#h32-0-250" id="h32-0-250" class="i">+    }
</a><a href="#h32-0-251" id="h32-0-251" class="i">+
</a><a href="#h32-0-252" id="h32-0-252" class="i">+    /// Serializes a value into a byte buffer
</a><a href="#h32-0-253" id="h32-0-253" class="i">+    fn serialize&lt;V: serde::Serialize&gt;(value: V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h32-0-254" id="h32-0-254" class="i">+        let mut bytes = Vec::new();
</a><a href="#h32-0-255" id="h32-0-255" class="i">+        value.serialize(&amp;mut rmps::Serializer::new(&amp;mut bytes))?;
</a><a href="#h32-0-256" id="h32-0-256" class="i">+        Ok(bytes)
</a><a href="#h32-0-257" id="h32-0-257" class="i">+    }
</a><a href="#h32-0-258" id="h32-0-258" class="i">+}
</a><a href="#h32-0-259" id="h32-0-259" class="i">+
</a><a href="#h32-0-260" id="h32-0-260" class="i">+#[cfg(test)]
</a><a href="#h32-0-261" id="h32-0-261" class="i">+mod tests {
</a><a href="#h32-0-262" id="h32-0-262" class="i">+    use super::super::tests::TestState;
</a><a href="#h32-0-263" id="h32-0-263" class="i">+    use super::*;
</a><a href="#h32-0-264" id="h32-0-264" class="i">+
</a><a href="#h32-0-265" id="h32-0-265" class="i">+    fn setup() -&gt; (Log, kv::Memory) {
</a><a href="#h32-0-266" id="h32-0-266" class="i">+        let store = kv::Memory::new();
</a><a href="#h32-0-267" id="h32-0-267" class="i">+        let log = Log::new(store.clone()).unwrap();
</a><a href="#h32-0-268" id="h32-0-268" class="i">+        (log, store)
</a><a href="#h32-0-269" id="h32-0-269" class="i">+    }
</a><a href="#h32-0-270" id="h32-0-270" class="i">+
</a><a href="#h32-0-271" id="h32-0-271" class="i">+    #[test]
</a><a href="#h32-0-272" id="h32-0-272" class="i">+    fn new() {
</a><a href="#h32-0-273" id="h32-0-273" class="i">+        let (l, _) = setup();
</a><a href="#h32-0-274" id="h32-0-274" class="i">+        assert_eq!((0, 0), l.get_last());
</a><a href="#h32-0-275" id="h32-0-275" class="i">+        assert_eq!((0, 0), l.get_committed());
</a><a href="#h32-0-276" id="h32-0-276" class="i">+        assert_eq!((0, 0), l.get_applied());
</a><a href="#h32-0-277" id="h32-0-277" class="i">+        assert_eq!(None, l.get(1).unwrap());
</a><a href="#h32-0-278" id="h32-0-278" class="i">+    }
</a><a href="#h32-0-279" id="h32-0-279" class="i">+
</a><a href="#h32-0-280" id="h32-0-280" class="i">+    #[test]
</a><a href="#h32-0-281" id="h32-0-281" class="i">+    fn append() {
</a><a href="#h32-0-282" id="h32-0-282" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-283" id="h32-0-283" class="i">+        assert_eq!(Ok(None), l.get(1));
</a><a href="#h32-0-284" id="h32-0-284" class="i">+
</a><a href="#h32-0-285" id="h32-0-285" class="i">+        assert_eq!(Ok(1), l.append(Entry { term: 3, command: Some(vec![0x01]) }));
</a><a href="#h32-0-286" id="h32-0-286" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-287" id="h32-0-287" class="i">+        assert_eq!(Ok(None), l.get(2));
</a><a href="#h32-0-288" id="h32-0-288" class="i">+
</a><a href="#h32-0-289" id="h32-0-289" class="i">+        assert_eq!((1, 3), l.get_last());
</a><a href="#h32-0-290" id="h32-0-290" class="i">+        assert_eq!((0, 0), l.get_committed());
</a><a href="#h32-0-291" id="h32-0-291" class="i">+        assert_eq!((0, 0), l.get_applied());
</a><a href="#h32-0-292" id="h32-0-292" class="i">+    }
</a><a href="#h32-0-293" id="h32-0-293" class="i">+
</a><a href="#h32-0-294" id="h32-0-294" class="i">+    #[test]
</a><a href="#h32-0-295" id="h32-0-295" class="i">+    fn append_none_command() {
</a><a href="#h32-0-296" id="h32-0-296" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-297" id="h32-0-297" class="i">+        assert_eq!(Ok(1), l.append(Entry { term: 3, command: None }));
</a><a href="#h32-0-298" id="h32-0-298" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: None })), l.get(1));
</a><a href="#h32-0-299" id="h32-0-299" class="i">+    }
</a><a href="#h32-0-300" id="h32-0-300" class="i">+
</a><a href="#h32-0-301" id="h32-0-301" class="i">+    #[test]
</a><a href="#h32-0-302" id="h32-0-302" class="i">+    fn append_persistence() {
</a><a href="#h32-0-303" id="h32-0-303" class="i">+        let (mut l, store) = setup();
</a><a href="#h32-0-304" id="h32-0-304" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-305" id="h32-0-305" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-306" id="h32-0-306" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-307" id="h32-0-307" class="i">+
</a><a href="#h32-0-308" id="h32-0-308" class="i">+        let l = Log::new(store).unwrap();
</a><a href="#h32-0-309" id="h32-0-309" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-310" id="h32-0-310" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: None })), l.get(2));
</a><a href="#h32-0-311" id="h32-0-311" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h32-0-312" id="h32-0-312" class="i">+    }
</a><a href="#h32-0-313" id="h32-0-313" class="i">+
</a><a href="#h32-0-314" id="h32-0-314" class="i">+    #[test]
</a><a href="#h32-0-315" id="h32-0-315" class="i">+    fn apply() {
</a><a href="#h32-0-316" id="h32-0-316" class="i">+        let (mut l, store) = setup();
</a><a href="#h32-0-317" id="h32-0-317" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-318" id="h32-0-318" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-319" id="h32-0-319" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-320" id="h32-0-320" class="i">+        l.commit(3).unwrap();
</a><a href="#h32-0-321" id="h32-0-321" class="i">+
</a><a href="#h32-0-322" id="h32-0-322" class="i">+        let state = TestState::new();
</a><a href="#h32-0-323" id="h32-0-323" class="i">+        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-324" id="h32-0-324" class="i">+        assert_eq!((1, 1), l.get_applied());
</a><a href="#h32-0-325" id="h32-0-325" class="i">+        assert_eq!(vec![vec![0x01],], state.list());
</a><a href="#h32-0-326" id="h32-0-326" class="i">+
</a><a href="#h32-0-327" id="h32-0-327" class="i">+        assert_eq!(Ok(Some((2, vec![]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-328" id="h32-0-328" class="i">+        assert_eq!((2, 2), l.get_applied());
</a><a href="#h32-0-329" id="h32-0-329" class="i">+        assert_eq!(vec![vec![0x01],], state.list());
</a><a href="#h32-0-330" id="h32-0-330" class="i">+
</a><a href="#h32-0-331" id="h32-0-331" class="i">+        assert_eq!(Ok(Some((3, vec![0xff, 0x03]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-332" id="h32-0-332" class="i">+        assert_eq!((3, 2), l.get_applied());
</a><a href="#h32-0-333" id="h32-0-333" class="i">+        assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
</a><a href="#h32-0-334" id="h32-0-334" class="i">+
</a><a href="#h32-0-335" id="h32-0-335" class="i">+        assert_eq!(Ok(None), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-336" id="h32-0-336" class="i">+        assert_eq!((3, 2), l.get_applied());
</a><a href="#h32-0-337" id="h32-0-337" class="i">+        assert_eq!(vec![vec![0x01], vec![0x03]], state.list());
</a><a href="#h32-0-338" id="h32-0-338" class="i">+
</a><a href="#h32-0-339" id="h32-0-339" class="i">+        // The last applied entry should be persisted, and also used for last committed
</a><a href="#h32-0-340" id="h32-0-340" class="i">+        let l = Log::new(store).unwrap();
</a><a href="#h32-0-341" id="h32-0-341" class="i">+        assert_eq!((3, 2), l.get_last());
</a><a href="#h32-0-342" id="h32-0-342" class="i">+        assert_eq!((3, 2), l.get_committed());
</a><a href="#h32-0-343" id="h32-0-343" class="i">+        assert_eq!((3, 2), l.get_applied());
</a><a href="#h32-0-344" id="h32-0-344" class="i">+    }
</a><a href="#h32-0-345" id="h32-0-345" class="i">+
</a><a href="#h32-0-346" id="h32-0-346" class="i">+    #[test]
</a><a href="#h32-0-347" id="h32-0-347" class="i">+    fn apply_committed_only() {
</a><a href="#h32-0-348" id="h32-0-348" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-349" id="h32-0-349" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-350" id="h32-0-350" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-351" id="h32-0-351" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-352" id="h32-0-352" class="i">+        l.commit(1).unwrap();
</a><a href="#h32-0-353" id="h32-0-353" class="i">+
</a><a href="#h32-0-354" id="h32-0-354" class="i">+        let state = TestState::new();
</a><a href="#h32-0-355" id="h32-0-355" class="i">+        assert_eq!(Ok(Some((1, vec![0xff, 0x01]))), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-356" id="h32-0-356" class="i">+        assert_eq!((1, 1), l.get_applied());
</a><a href="#h32-0-357" id="h32-0-357" class="i">+        assert_eq!(vec![vec![0x01],], state.list());
</a><a href="#h32-0-358" id="h32-0-358" class="i">+
</a><a href="#h32-0-359" id="h32-0-359" class="i">+        assert_eq!(Ok(None), l.apply(&amp;mut state.boxed()));
</a><a href="#h32-0-360" id="h32-0-360" class="i">+        assert_eq!((1, 1), l.get_applied());
</a><a href="#h32-0-361" id="h32-0-361" class="i">+        assert_eq!(vec![vec![0x01],], state.list());
</a><a href="#h32-0-362" id="h32-0-362" class="i">+    }
</a><a href="#h32-0-363" id="h32-0-363" class="i">+
</a><a href="#h32-0-364" id="h32-0-364" class="i">+    #[test]
</a><a href="#h32-0-365" id="h32-0-365" class="i">+    fn commit() {
</a><a href="#h32-0-366" id="h32-0-366" class="i">+        let (mut l, store) = setup();
</a><a href="#h32-0-367" id="h32-0-367" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-368" id="h32-0-368" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-369" id="h32-0-369" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-370" id="h32-0-370" class="i">+        assert_eq!(Ok(3), l.commit(3));
</a><a href="#h32-0-371" id="h32-0-371" class="i">+        assert_eq!((3, 2), l.get_committed());
</a><a href="#h32-0-372" id="h32-0-372" class="i">+
</a><a href="#h32-0-373" id="h32-0-373" class="i">+        // The last committed entry should not be persisted
</a><a href="#h32-0-374" id="h32-0-374" class="i">+        let l = Log::new(store).unwrap();
</a><a href="#h32-0-375" id="h32-0-375" class="i">+        assert_eq!((0, 0), l.get_committed());
</a><a href="#h32-0-376" id="h32-0-376" class="i">+    }
</a><a href="#h32-0-377" id="h32-0-377" class="i">+
</a><a href="#h32-0-378" id="h32-0-378" class="i">+    #[test]
</a><a href="#h32-0-379" id="h32-0-379" class="i">+    fn commit_beyond() {
</a><a href="#h32-0-380" id="h32-0-380" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-381" id="h32-0-381" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-382" id="h32-0-382" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-383" id="h32-0-383" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-384" id="h32-0-384" class="i">+        assert_eq!(Ok(3), l.commit(4));
</a><a href="#h32-0-385" id="h32-0-385" class="i">+        assert_eq!((3, 2), l.get_committed());
</a><a href="#h32-0-386" id="h32-0-386" class="i">+    }
</a><a href="#h32-0-387" id="h32-0-387" class="i">+
</a><a href="#h32-0-388" id="h32-0-388" class="i">+    #[test]
</a><a href="#h32-0-389" id="h32-0-389" class="i">+    fn commit_partial() {
</a><a href="#h32-0-390" id="h32-0-390" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-391" id="h32-0-391" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-392" id="h32-0-392" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-393" id="h32-0-393" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-394" id="h32-0-394" class="i">+        assert_eq!(Ok(2), l.commit(2));
</a><a href="#h32-0-395" id="h32-0-395" class="i">+        assert_eq!((2, 2), l.get_committed());
</a><a href="#h32-0-396" id="h32-0-396" class="i">+    }
</a><a href="#h32-0-397" id="h32-0-397" class="i">+
</a><a href="#h32-0-398" id="h32-0-398" class="i">+    #[test]
</a><a href="#h32-0-399" id="h32-0-399" class="i">+    fn commit_reduce() {
</a><a href="#h32-0-400" id="h32-0-400" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-401" id="h32-0-401" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-402" id="h32-0-402" class="i">+        l.append(Entry { term: 2, command: None }).unwrap();
</a><a href="#h32-0-403" id="h32-0-403" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-404" id="h32-0-404" class="i">+        assert_eq!(Ok(2), l.commit(2));
</a><a href="#h32-0-405" id="h32-0-405" class="i">+        assert_eq!((2, 2), l.get_committed());
</a><a href="#h32-0-406" id="h32-0-406" class="i">+
</a><a href="#h32-0-407" id="h32-0-407" class="i">+        assert_eq!(Ok(2), l.commit(1));
</a><a href="#h32-0-408" id="h32-0-408" class="i">+        assert_eq!((2, 2), l.get_committed());
</a><a href="#h32-0-409" id="h32-0-409" class="i">+    }
</a><a href="#h32-0-410" id="h32-0-410" class="i">+
</a><a href="#h32-0-411" id="h32-0-411" class="i">+    #[test]
</a><a href="#h32-0-412" id="h32-0-412" class="i">+    fn get() {
</a><a href="#h32-0-413" id="h32-0-413" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-414" id="h32-0-414" class="i">+        assert_eq!(Ok(None), l.get(1));
</a><a href="#h32-0-415" id="h32-0-415" class="i">+
</a><a href="#h32-0-416" id="h32-0-416" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-417" id="h32-0-417" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-418" id="h32-0-418" class="i">+        assert_eq!(Ok(None), l.get(2));
</a><a href="#h32-0-419" id="h32-0-419" class="i">+    }
</a><a href="#h32-0-420" id="h32-0-420" class="i">+
</a><a href="#h32-0-421" id="h32-0-421" class="i">+    #[test]
</a><a href="#h32-0-422" id="h32-0-422" class="i">+    fn has() {
</a><a href="#h32-0-423" id="h32-0-423" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-424" id="h32-0-424" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-425" id="h32-0-425" class="i">+
</a><a href="#h32-0-426" id="h32-0-426" class="i">+        assert_eq!(true, l.has(1, 2).unwrap());
</a><a href="#h32-0-427" id="h32-0-427" class="i">+        assert_eq!(true, l.has(0, 0).unwrap());
</a><a href="#h32-0-428" id="h32-0-428" class="i">+        assert_eq!(false, l.has(0, 1).unwrap());
</a><a href="#h32-0-429" id="h32-0-429" class="i">+        assert_eq!(false, l.has(1, 0).unwrap());
</a><a href="#h32-0-430" id="h32-0-430" class="i">+        assert_eq!(false, l.has(1, 3).unwrap());
</a><a href="#h32-0-431" id="h32-0-431" class="i">+        assert_eq!(false, l.has(2, 0).unwrap());
</a><a href="#h32-0-432" id="h32-0-432" class="i">+        assert_eq!(false, l.has(2, 1).unwrap());
</a><a href="#h32-0-433" id="h32-0-433" class="i">+    }
</a><a href="#h32-0-434" id="h32-0-434" class="i">+
</a><a href="#h32-0-435" id="h32-0-435" class="i">+    #[test]
</a><a href="#h32-0-436" id="h32-0-436" class="i">+    fn range() {
</a><a href="#h32-0-437" id="h32-0-437" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-438" id="h32-0-438" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-439" id="h32-0-439" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-440" id="h32-0-440" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-441" id="h32-0-441" class="i">+
</a><a href="#h32-0-442" id="h32-0-442" class="i">+        assert_eq!(
</a><a href="#h32-0-443" id="h32-0-443" class="i">+            Ok(vec![
</a><a href="#h32-0-444" id="h32-0-444" class="i">+                Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h32-0-445" id="h32-0-445" class="i">+                Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h32-0-446" id="h32-0-446" class="i">+                Entry { term: 1, command: Some(vec![0x03]) },
</a><a href="#h32-0-447" id="h32-0-447" class="i">+            ]),
</a><a href="#h32-0-448" id="h32-0-448" class="i">+            l.range(0..)
</a><a href="#h32-0-449" id="h32-0-449" class="i">+        );
</a><a href="#h32-0-450" id="h32-0-450" class="i">+        assert_eq!(
</a><a href="#h32-0-451" id="h32-0-451" class="i">+            Ok(vec![
</a><a href="#h32-0-452" id="h32-0-452" class="i">+                Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h32-0-453" id="h32-0-453" class="i">+                Entry { term: 1, command: Some(vec![0x03]) },
</a><a href="#h32-0-454" id="h32-0-454" class="i">+            ]),
</a><a href="#h32-0-455" id="h32-0-455" class="i">+            l.range(2..)
</a><a href="#h32-0-456" id="h32-0-456" class="i">+        );
</a><a href="#h32-0-457" id="h32-0-457" class="i">+        assert_eq!(Ok(vec![]), l.range(4..));
</a><a href="#h32-0-458" id="h32-0-458" class="i">+    }
</a><a href="#h32-0-459" id="h32-0-459" class="i">+
</a><a href="#h32-0-460" id="h32-0-460" class="i">+    #[test]
</a><a href="#h32-0-461" id="h32-0-461" class="i">+    fn load_save_term() {
</a><a href="#h32-0-462" id="h32-0-462" class="i">+        let (mut l, store) = setup();
</a><a href="#h32-0-463" id="h32-0-463" class="i">+        assert_eq!(Ok((0, None)), l.load_term());
</a><a href="#h32-0-464" id="h32-0-464" class="i">+        assert_eq!(Ok(()), l.save_term(1, Some(&quot;a&quot;)));
</a><a href="#h32-0-465" id="h32-0-465" class="i">+
</a><a href="#h32-0-466" id="h32-0-466" class="i">+        let mut l = Log::new(store.clone()).unwrap();
</a><a href="#h32-0-467" id="h32-0-467" class="i">+        assert_eq!(Ok((1, Some(&quot;a&quot;.into()))), l.load_term());
</a><a href="#h32-0-468" id="h32-0-468" class="i">+        assert_eq!(Ok(()), l.save_term(3, Some(&quot;c&quot;)));
</a><a href="#h32-0-469" id="h32-0-469" class="i">+
</a><a href="#h32-0-470" id="h32-0-470" class="i">+        let mut l = Log::new(store.clone()).unwrap();
</a><a href="#h32-0-471" id="h32-0-471" class="i">+        assert_eq!(Ok((3, Some(&quot;c&quot;.into()))), l.load_term());
</a><a href="#h32-0-472" id="h32-0-472" class="i">+        assert_eq!(Ok(()), l.save_term(0, None));
</a><a href="#h32-0-473" id="h32-0-473" class="i">+
</a><a href="#h32-0-474" id="h32-0-474" class="i">+        let l = Log::new(store.clone()).unwrap();
</a><a href="#h32-0-475" id="h32-0-475" class="i">+        assert_eq!(Ok((0, None)), l.load_term());
</a><a href="#h32-0-476" id="h32-0-476" class="i">+    }
</a><a href="#h32-0-477" id="h32-0-477" class="i">+
</a><a href="#h32-0-478" id="h32-0-478" class="i">+    #[test]
</a><a href="#h32-0-479" id="h32-0-479" class="i">+    fn splice() {
</a><a href="#h32-0-480" id="h32-0-480" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-481" id="h32-0-481" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-482" id="h32-0-482" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-483" id="h32-0-483" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-484" id="h32-0-484" class="i">+
</a><a href="#h32-0-485" id="h32-0-485" class="i">+        assert_eq!(
</a><a href="#h32-0-486" id="h32-0-486" class="i">+            Ok(4),
</a><a href="#h32-0-487" id="h32-0-487" class="i">+            l.splice(
</a><a href="#h32-0-488" id="h32-0-488" class="i">+                2,
</a><a href="#h32-0-489" id="h32-0-489" class="i">+                2,
</a><a href="#h32-0-490" id="h32-0-490" class="i">+                vec![
</a><a href="#h32-0-491" id="h32-0-491" class="i">+                    Entry { term: 3, command: Some(vec![0x03]) },
</a><a href="#h32-0-492" id="h32-0-492" class="i">+                    Entry { term: 4, command: Some(vec![0x04]) },
</a><a href="#h32-0-493" id="h32-0-493" class="i">+                ]
</a><a href="#h32-0-494" id="h32-0-494" class="i">+            )
</a><a href="#h32-0-495" id="h32-0-495" class="i">+        );
</a><a href="#h32-0-496" id="h32-0-496" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-497" id="h32-0-497" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-498" id="h32-0-498" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h32-0-499" id="h32-0-499" class="i">+        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x04]) })), l.get(4));
</a><a href="#h32-0-500" id="h32-0-500" class="i">+        assert_eq!((4, 4), l.get_last());
</a><a href="#h32-0-501" id="h32-0-501" class="i">+    }
</a><a href="#h32-0-502" id="h32-0-502" class="i">+
</a><a href="#h32-0-503" id="h32-0-503" class="i">+    #[test]
</a><a href="#h32-0-504" id="h32-0-504" class="i">+    fn splice_all() {
</a><a href="#h32-0-505" id="h32-0-505" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-506" id="h32-0-506" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-507" id="h32-0-507" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-508" id="h32-0-508" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-509" id="h32-0-509" class="i">+
</a><a href="#h32-0-510" id="h32-0-510" class="i">+        assert_eq!(
</a><a href="#h32-0-511" id="h32-0-511" class="i">+            Ok(2),
</a><a href="#h32-0-512" id="h32-0-512" class="i">+            l.splice(
</a><a href="#h32-0-513" id="h32-0-513" class="i">+                0,
</a><a href="#h32-0-514" id="h32-0-514" class="i">+                0,
</a><a href="#h32-0-515" id="h32-0-515" class="i">+                vec![
</a><a href="#h32-0-516" id="h32-0-516" class="i">+                    Entry { term: 4, command: Some(vec![0x0a]) },
</a><a href="#h32-0-517" id="h32-0-517" class="i">+                    Entry { term: 4, command: Some(vec![0x0b]) },
</a><a href="#h32-0-518" id="h32-0-518" class="i">+                ]
</a><a href="#h32-0-519" id="h32-0-519" class="i">+            )
</a><a href="#h32-0-520" id="h32-0-520" class="i">+        );
</a><a href="#h32-0-521" id="h32-0-521" class="i">+        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x0a]) })), l.get(1));
</a><a href="#h32-0-522" id="h32-0-522" class="i">+        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x0b]) })), l.get(2));
</a><a href="#h32-0-523" id="h32-0-523" class="i">+        assert_eq!((2, 4), l.get_last());
</a><a href="#h32-0-524" id="h32-0-524" class="i">+    }
</a><a href="#h32-0-525" id="h32-0-525" class="i">+
</a><a href="#h32-0-526" id="h32-0-526" class="i">+    #[test]
</a><a href="#h32-0-527" id="h32-0-527" class="i">+    fn splice_append() {
</a><a href="#h32-0-528" id="h32-0-528" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-529" id="h32-0-529" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-530" id="h32-0-530" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-531" id="h32-0-531" class="i">+
</a><a href="#h32-0-532" id="h32-0-532" class="i">+        assert_eq!(
</a><a href="#h32-0-533" id="h32-0-533" class="i">+            Ok(4),
</a><a href="#h32-0-534" id="h32-0-534" class="i">+            l.splice(
</a><a href="#h32-0-535" id="h32-0-535" class="i">+                2,
</a><a href="#h32-0-536" id="h32-0-536" class="i">+                2,
</a><a href="#h32-0-537" id="h32-0-537" class="i">+                vec![
</a><a href="#h32-0-538" id="h32-0-538" class="i">+                    Entry { term: 3, command: Some(vec![0x03]) },
</a><a href="#h32-0-539" id="h32-0-539" class="i">+                    Entry { term: 4, command: Some(vec![0x04]) },
</a><a href="#h32-0-540" id="h32-0-540" class="i">+                ]
</a><a href="#h32-0-541" id="h32-0-541" class="i">+            )
</a><a href="#h32-0-542" id="h32-0-542" class="i">+        );
</a><a href="#h32-0-543" id="h32-0-543" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-544" id="h32-0-544" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-545" id="h32-0-545" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h32-0-546" id="h32-0-546" class="i">+        assert_eq!(Ok(Some(Entry { term: 4, command: Some(vec![0x04]) })), l.get(4));
</a><a href="#h32-0-547" id="h32-0-547" class="i">+        assert_eq!((4, 4), l.get_last());
</a><a href="#h32-0-548" id="h32-0-548" class="i">+    }
</a><a href="#h32-0-549" id="h32-0-549" class="i">+
</a><a href="#h32-0-550" id="h32-0-550" class="i">+    #[test]
</a><a href="#h32-0-551" id="h32-0-551" class="i">+    fn splice_base_missing() {
</a><a href="#h32-0-552" id="h32-0-552" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-553" id="h32-0-553" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-554" id="h32-0-554" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-555" id="h32-0-555" class="i">+
</a><a href="#h32-0-556" id="h32-0-556" class="i">+        assert_matches!(
</a><a href="#h32-0-557" id="h32-0-557" class="i">+            l.splice(3, 3, vec![Entry { term: 4, command: Some(vec![0x04]) },]),
</a><a href="#h32-0-558" id="h32-0-558" class="i">+            Err(Error::RaftBaseNotFound { index, term }) if index == 3 &amp;&amp; term == 3
</a><a href="#h32-0-559" id="h32-0-559" class="i">+        );
</a><a href="#h32-0-560" id="h32-0-560" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-561" id="h32-0-561" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-562" id="h32-0-562" class="i">+        assert_eq!((2, 2), l.get_last());
</a><a href="#h32-0-563" id="h32-0-563" class="i">+    }
</a><a href="#h32-0-564" id="h32-0-564" class="i">+
</a><a href="#h32-0-565" id="h32-0-565" class="i">+    #[test]
</a><a href="#h32-0-566" id="h32-0-566" class="i">+    fn splice_base_term_conflict() {
</a><a href="#h32-0-567" id="h32-0-567" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-568" id="h32-0-568" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-569" id="h32-0-569" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-570" id="h32-0-570" class="i">+
</a><a href="#h32-0-571" id="h32-0-571" class="i">+        assert_matches!(
</a><a href="#h32-0-572" id="h32-0-572" class="i">+            l.splice(2, 3, vec![Entry { term: 4, command: Some(vec![0x04]) },]),
</a><a href="#h32-0-573" id="h32-0-573" class="i">+            Err(Error::RaftBaseNotFound { index, term }) if index == 2 &amp;&amp; term == 3
</a><a href="#h32-0-574" id="h32-0-574" class="i">+        );
</a><a href="#h32-0-575" id="h32-0-575" class="i">+        assert_matches!(
</a><a href="#h32-0-576" id="h32-0-576" class="i">+            l.splice(2, 0, vec![Entry { term: 4, command: Some(vec![0x04]) },]),
</a><a href="#h32-0-577" id="h32-0-577" class="i">+            Err(Error::RaftBaseNotFound { index, term }) if index == 2 &amp;&amp; term == 0
</a><a href="#h32-0-578" id="h32-0-578" class="i">+        );
</a><a href="#h32-0-579" id="h32-0-579" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-580" id="h32-0-580" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-581" id="h32-0-581" class="i">+        assert_eq!((2, 2), l.get_last());
</a><a href="#h32-0-582" id="h32-0-582" class="i">+    }
</a><a href="#h32-0-583" id="h32-0-583" class="i">+
</a><a href="#h32-0-584" id="h32-0-584" class="i">+    #[test]
</a><a href="#h32-0-585" id="h32-0-585" class="i">+    fn splice_conflict_term() {
</a><a href="#h32-0-586" id="h32-0-586" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-587" id="h32-0-587" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-588" id="h32-0-588" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-589" id="h32-0-589" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-590" id="h32-0-590" class="i">+        l.append(Entry { term: 4, command: Some(vec![0x04]) }).unwrap();
</a><a href="#h32-0-591" id="h32-0-591" class="i">+
</a><a href="#h32-0-592" id="h32-0-592" class="i">+        assert_eq!(
</a><a href="#h32-0-593" id="h32-0-593" class="i">+            Ok(3),
</a><a href="#h32-0-594" id="h32-0-594" class="i">+            l.splice(
</a><a href="#h32-0-595" id="h32-0-595" class="i">+                1,
</a><a href="#h32-0-596" id="h32-0-596" class="i">+                1,
</a><a href="#h32-0-597" id="h32-0-597" class="i">+                vec![
</a><a href="#h32-0-598" id="h32-0-598" class="i">+                    Entry { term: 3, command: Some(vec![0x0b]) },
</a><a href="#h32-0-599" id="h32-0-599" class="i">+                    Entry { term: 3, command: Some(vec![0x0c]) }
</a><a href="#h32-0-600" id="h32-0-600" class="i">+                ]
</a><a href="#h32-0-601" id="h32-0-601" class="i">+            )
</a><a href="#h32-0-602" id="h32-0-602" class="i">+        );
</a><a href="#h32-0-603" id="h32-0-603" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-604" id="h32-0-604" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x0b]) })), l.get(2));
</a><a href="#h32-0-605" id="h32-0-605" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x0c]) })), l.get(3));
</a><a href="#h32-0-606" id="h32-0-606" class="i">+        assert_eq!((3, 3), l.get_last());
</a><a href="#h32-0-607" id="h32-0-607" class="i">+    }
</a><a href="#h32-0-608" id="h32-0-608" class="i">+
</a><a href="#h32-0-609" id="h32-0-609" class="i">+    #[test]
</a><a href="#h32-0-610" id="h32-0-610" class="i">+    fn splice_overlap_inside() {
</a><a href="#h32-0-611" id="h32-0-611" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-612" id="h32-0-612" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-613" id="h32-0-613" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-614" id="h32-0-614" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-615" id="h32-0-615" class="i">+
</a><a href="#h32-0-616" id="h32-0-616" class="i">+        assert_eq!(Ok(3), l.splice(1, 1, vec![Entry { term: 2, command: Some(vec![0x02]) },]));
</a><a href="#h32-0-617" id="h32-0-617" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-618" id="h32-0-618" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-619" id="h32-0-619" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h32-0-620" id="h32-0-620" class="i">+        assert_eq!((3, 3), l.get_last());
</a><a href="#h32-0-621" id="h32-0-621" class="i">+    }
</a><a href="#h32-0-622" id="h32-0-622" class="i">+
</a><a href="#h32-0-623" id="h32-0-623" class="i">+    #[test]
</a><a href="#h32-0-624" id="h32-0-624" class="i">+    fn truncate() {
</a><a href="#h32-0-625" id="h32-0-625" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-626" id="h32-0-626" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-627" id="h32-0-627" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-628" id="h32-0-628" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-629" id="h32-0-629" class="i">+
</a><a href="#h32-0-630" id="h32-0-630" class="i">+        assert_eq!(Ok(2), l.truncate(2));
</a><a href="#h32-0-631" id="h32-0-631" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-632" id="h32-0-632" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-633" id="h32-0-633" class="i">+        assert_eq!(Ok(None), l.get(3));
</a><a href="#h32-0-634" id="h32-0-634" class="i">+        assert_eq!((2, 2), l.get_last());
</a><a href="#h32-0-635" id="h32-0-635" class="i">+    }
</a><a href="#h32-0-636" id="h32-0-636" class="i">+
</a><a href="#h32-0-637" id="h32-0-637" class="i">+    #[test]
</a><a href="#h32-0-638" id="h32-0-638" class="i">+    fn truncate_beyond() {
</a><a href="#h32-0-639" id="h32-0-639" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-640" id="h32-0-640" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-641" id="h32-0-641" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-642" id="h32-0-642" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-643" id="h32-0-643" class="i">+
</a><a href="#h32-0-644" id="h32-0-644" class="i">+        assert_eq!(Ok(3), l.truncate(4));
</a><a href="#h32-0-645" id="h32-0-645" class="i">+        assert_eq!(Ok(Some(Entry { term: 1, command: Some(vec![0x01]) })), l.get(1));
</a><a href="#h32-0-646" id="h32-0-646" class="i">+        assert_eq!(Ok(Some(Entry { term: 2, command: Some(vec![0x02]) })), l.get(2));
</a><a href="#h32-0-647" id="h32-0-647" class="i">+        assert_eq!(Ok(Some(Entry { term: 3, command: Some(vec![0x03]) })), l.get(3));
</a><a href="#h32-0-648" id="h32-0-648" class="i">+        assert_eq!(Ok(None), l.get(4));
</a><a href="#h32-0-649" id="h32-0-649" class="i">+        assert_eq!((3, 3), l.get_last());
</a><a href="#h32-0-650" id="h32-0-650" class="i">+    }
</a><a href="#h32-0-651" id="h32-0-651" class="i">+
</a><a href="#h32-0-652" id="h32-0-652" class="i">+    #[test]
</a><a href="#h32-0-653" id="h32-0-653" class="i">+    fn truncate_committed() {
</a><a href="#h32-0-654" id="h32-0-654" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-655" id="h32-0-655" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-656" id="h32-0-656" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-657" id="h32-0-657" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-658" id="h32-0-658" class="i">+        l.commit(2).unwrap();
</a><a href="#h32-0-659" id="h32-0-659" class="i">+
</a><a href="#h32-0-660" id="h32-0-660" class="i">+        assert_matches!(l.truncate(1), Err(Error::Value(_)));
</a><a href="#h32-0-661" id="h32-0-661" class="i">+        assert_eq!(l.truncate(2), Ok(2));
</a><a href="#h32-0-662" id="h32-0-662" class="i">+    }
</a><a href="#h32-0-663" id="h32-0-663" class="i">+
</a><a href="#h32-0-664" id="h32-0-664" class="i">+    #[test]
</a><a href="#h32-0-665" id="h32-0-665" class="i">+    fn truncate_zero() {
</a><a href="#h32-0-666" id="h32-0-666" class="i">+        let (mut l, _) = setup();
</a><a href="#h32-0-667" id="h32-0-667" class="i">+        l.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h32-0-668" id="h32-0-668" class="i">+        l.append(Entry { term: 2, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h32-0-669" id="h32-0-669" class="i">+        l.append(Entry { term: 3, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h32-0-670" id="h32-0-670" class="i">+
</a><a href="#h32-0-671" id="h32-0-671" class="i">+        assert_eq!(Ok(0), l.truncate(0));
</a><a href="#h32-0-672" id="h32-0-672" class="i">+        assert_eq!(Ok(None), l.get(1));
</a><a href="#h32-0-673" id="h32-0-673" class="i">+        assert_eq!(Ok(None), l.get(2));
</a><a href="#h32-0-674" id="h32-0-674" class="i">+        assert_eq!(Ok(None), l.get(3));
</a><a href="#h32-0-675" id="h32-0-675" class="i">+        assert_eq!((0, 0), l.get_last());
</a><a href="#h32-0-676" id="h32-0-676" class="i">+    }
</a><a href="#h32-0-677" id="h32-0-677" class="i">+}
</a><b>diff --git a/<a id="h33" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,186 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+mod log;
</a><a href="#h33-0-1" id="h33-0-1" class="i">+mod node;
</a><a href="#h33-0-2" id="h33-0-2" class="i">+mod state;
</a><a href="#h33-0-3" id="h33-0-3" class="i">+mod transport;
</a><a href="#h33-0-4" id="h33-0-4" class="i">+
</a><a href="#h33-0-5" id="h33-0-5" class="i">+pub use self::log::Entry;
</a><a href="#h33-0-6" id="h33-0-6" class="i">+pub use self::state::State;
</a><a href="#h33-0-7" id="h33-0-7" class="i">+pub use self::transport::{Event, Message, Transport};
</a><a href="#h33-0-8" id="h33-0-8" class="i">+
</a><a href="#h33-0-9" id="h33-0-9" class="i">+use crate::kv;
</a><a href="#h33-0-10" id="h33-0-10" class="i">+use crate::Error;
</a><a href="#h33-0-11" id="h33-0-11" class="i">+use crossbeam_channel::{Receiver, Sender};
</a><a href="#h33-0-12" id="h33-0-12" class="i">+use node::Node;
</a><a href="#h33-0-13" id="h33-0-13" class="i">+use std::collections::HashMap;
</a><a href="#h33-0-14" id="h33-0-14" class="i">+use uuid::Uuid;
</a><a href="#h33-0-15" id="h33-0-15" class="i">+
</a><a href="#h33-0-16" id="h33-0-16" class="i">+/// The duration of a Raft tick, which is the unit of time for e.g.
</a><a href="#h33-0-17" id="h33-0-17" class="i">+/// heartbeat intervals and election timeouts.
</a><a href="#h33-0-18" id="h33-0-18" class="i">+const TICK: std::time::Duration = std::time::Duration::from_millis(100);
</a><a href="#h33-0-19" id="h33-0-19" class="i">+
</a><a href="#h33-0-20" id="h33-0-20" class="i">+/// A Raft state machine representing an entire Raft cluster.
</a><a href="#h33-0-21" id="h33-0-21" class="i">+#[derive(Clone)]
</a><a href="#h33-0-22" id="h33-0-22" class="i">+pub struct Raft {
</a><a href="#h33-0-23" id="h33-0-23" class="i">+    call_tx: Sender&lt;(Event, Sender&lt;Event&gt;)&gt;,
</a><a href="#h33-0-24" id="h33-0-24" class="i">+    join_rx: Receiver&lt;Result&lt;(), Error&gt;&gt;,
</a><a href="#h33-0-25" id="h33-0-25" class="i">+}
</a><a href="#h33-0-26" id="h33-0-26" class="i">+
</a><a href="#h33-0-27" id="h33-0-27" class="i">+impl Raft {
</a><a href="#h33-0-28" id="h33-0-28" class="i">+    /// Starts a new Raft state machine in a separate thread.
</a><a href="#h33-0-29" id="h33-0-29" class="i">+    pub fn start&lt;S, L, T&gt;(
</a><a href="#h33-0-30" id="h33-0-30" class="i">+        id: &amp;str,
</a><a href="#h33-0-31" id="h33-0-31" class="i">+        peers: Vec&lt;String&gt;,
</a><a href="#h33-0-32" id="h33-0-32" class="i">+        state: S,
</a><a href="#h33-0-33" id="h33-0-33" class="i">+        store: L,
</a><a href="#h33-0-34" id="h33-0-34" class="i">+        transport: T,
</a><a href="#h33-0-35" id="h33-0-35" class="i">+    ) -&gt; Result&lt;Raft, Error&gt;
</a><a href="#h33-0-36" id="h33-0-36" class="i">+    where
</a><a href="#h33-0-37" id="h33-0-37" class="i">+        S: State,
</a><a href="#h33-0-38" id="h33-0-38" class="i">+        L: kv::Store,
</a><a href="#h33-0-39" id="h33-0-39" class="i">+        T: Transport,
</a><a href="#h33-0-40" id="h33-0-40" class="i">+    {
</a><a href="#h33-0-41" id="h33-0-41" class="i">+        let ticker = crossbeam_channel::tick(TICK);
</a><a href="#h33-0-42" id="h33-0-42" class="i">+        let inbound_rx = transport.receiver();
</a><a href="#h33-0-43" id="h33-0-43" class="i">+        let (outbound_tx, outbound_rx) = crossbeam_channel::unbounded();
</a><a href="#h33-0-44" id="h33-0-44" class="i">+        let (call_tx, call_rx) = crossbeam_channel::unbounded::&lt;(Event, Sender&lt;Event&gt;)&gt;();
</a><a href="#h33-0-45" id="h33-0-45" class="i">+        let (join_tx, join_rx) = crossbeam_channel::unbounded();
</a><a href="#h33-0-46" id="h33-0-46" class="i">+        let mut response_txs: HashMap&lt;Vec&lt;u8&gt;, Sender&lt;Event&gt;&gt; = HashMap::new();
</a><a href="#h33-0-47" id="h33-0-47" class="i">+        let mut node = Node::new(id, peers, store, state, outbound_tx)?;
</a><a href="#h33-0-48" id="h33-0-48" class="i">+
</a><a href="#h33-0-49" id="h33-0-49" class="i">+        std::thread::spawn(move || {
</a><a href="#h33-0-50" id="h33-0-50" class="i">+            // Ugly workaround to use ?, while waiting for try_blocks:
</a><a href="#h33-0-51" id="h33-0-51" class="i">+            // https://doc.rust-lang.org/unstable-book/language-features/try-blocks.html
</a><a href="#h33-0-52" id="h33-0-52" class="i">+            let result = (move || loop {
</a><a href="#h33-0-53" id="h33-0-53" class="i">+                select! {
</a><a href="#h33-0-54" id="h33-0-54" class="i">+                    // Handle ticks
</a><a href="#h33-0-55" id="h33-0-55" class="i">+                    recv(ticker) -&gt; _ =&gt; node = node.tick()?,
</a><a href="#h33-0-56" id="h33-0-56" class="i">+
</a><a href="#h33-0-57" id="h33-0-57" class="i">+                    // Handle local method calls
</a><a href="#h33-0-58" id="h33-0-58" class="i">+                    recv(call_rx) -&gt; recv =&gt; {
</a><a href="#h33-0-59" id="h33-0-59" class="i">+                        let (event, response_tx) = recv?;
</a><a href="#h33-0-60" id="h33-0-60" class="i">+                        if let Some(call_id) = event.call_id() {
</a><a href="#h33-0-61" id="h33-0-61" class="i">+                            response_txs.insert(call_id, response_tx);
</a><a href="#h33-0-62" id="h33-0-62" class="i">+                            node = node.step(Message{from: None, to: None, term: 0, event})?;
</a><a href="#h33-0-63" id="h33-0-63" class="i">+                        } else {
</a><a href="#h33-0-64" id="h33-0-64" class="i">+                            response_tx.send(Event::RespondError{
</a><a href="#h33-0-65" id="h33-0-65" class="i">+                                call_id: vec![],
</a><a href="#h33-0-66" id="h33-0-66" class="i">+                                error: format!(&quot;Call ID not found for event {:?}&quot;, event),
</a><a href="#h33-0-67" id="h33-0-67" class="i">+                            })?;
</a><a href="#h33-0-68" id="h33-0-68" class="i">+                        }
</a><a href="#h33-0-69" id="h33-0-69" class="i">+                    },
</a><a href="#h33-0-70" id="h33-0-70" class="i">+
</a><a href="#h33-0-71" id="h33-0-71" class="i">+                    // Handle inbound messages from peers
</a><a href="#h33-0-72" id="h33-0-72" class="i">+                    recv(inbound_rx) -&gt; recv =&gt; node = node.step(recv?)?,
</a><a href="#h33-0-73" id="h33-0-73" class="i">+
</a><a href="#h33-0-74" id="h33-0-74" class="i">+                    // Handle outbound messages from node, either to peers or a local method caller
</a><a href="#h33-0-75" id="h33-0-75" class="i">+                    recv(outbound_rx) -&gt; recv =&gt; {
</a><a href="#h33-0-76" id="h33-0-76" class="i">+                        let msg = recv?;
</a><a href="#h33-0-77" id="h33-0-77" class="i">+                        if msg.to.is_some() {
</a><a href="#h33-0-78" id="h33-0-78" class="i">+                            transport.send(msg)?
</a><a href="#h33-0-79" id="h33-0-79" class="i">+                        } else if let Some(call_id) = msg.event.call_id() {
</a><a href="#h33-0-80" id="h33-0-80" class="i">+                            if let Some(response_tx) = response_txs.get(&amp;call_id) {
</a><a href="#h33-0-81" id="h33-0-81" class="i">+                                response_tx.send(msg.event)?;
</a><a href="#h33-0-82" id="h33-0-82" class="i">+                            }
</a><a href="#h33-0-83" id="h33-0-83" class="i">+                        }
</a><a href="#h33-0-84" id="h33-0-84" class="i">+                    },
</a><a href="#h33-0-85" id="h33-0-85" class="i">+                }
</a><a href="#h33-0-86" id="h33-0-86" class="i">+            })();
</a><a href="#h33-0-87" id="h33-0-87" class="i">+            join_tx.send(result).unwrap()
</a><a href="#h33-0-88" id="h33-0-88" class="i">+        });
</a><a href="#h33-0-89" id="h33-0-89" class="i">+
</a><a href="#h33-0-90" id="h33-0-90" class="i">+        Ok(Raft { call_tx, join_rx })
</a><a href="#h33-0-91" id="h33-0-91" class="i">+    }
</a><a href="#h33-0-92" id="h33-0-92" class="i">+
</a><a href="#h33-0-93" id="h33-0-93" class="i">+    /// Waits for the Raft node to complete
</a><a href="#h33-0-94" id="h33-0-94" class="i">+    pub fn join(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h33-0-95" id="h33-0-95" class="i">+        self.join_rx.recv()?
</a><a href="#h33-0-96" id="h33-0-96" class="i">+    }
</a><a href="#h33-0-97" id="h33-0-97" class="i">+
</a><a href="#h33-0-98" id="h33-0-98" class="i">+    /// Runs a synchronous client call on the Raft cluster
</a><a href="#h33-0-99" id="h33-0-99" class="i">+    fn call(&amp;self, event: Event) -&gt; Result&lt;Event, Error&gt; {
</a><a href="#h33-0-100" id="h33-0-100" class="i">+        let (response_tx, response_rx) = crossbeam_channel::unbounded();
</a><a href="#h33-0-101" id="h33-0-101" class="i">+        self.call_tx.send((event, response_tx))?;
</a><a href="#h33-0-102" id="h33-0-102" class="i">+        match response_rx.recv()? {
</a><a href="#h33-0-103" id="h33-0-103" class="i">+            Event::RespondError { error, .. } =&gt; Err(Error::Network(error)),
</a><a href="#h33-0-104" id="h33-0-104" class="i">+            e =&gt; Ok(e),
</a><a href="#h33-0-105" id="h33-0-105" class="i">+        }
</a><a href="#h33-0-106" id="h33-0-106" class="i">+    }
</a><a href="#h33-0-107" id="h33-0-107" class="i">+
</a><a href="#h33-0-108" id="h33-0-108" class="i">+    /// Generates a call ID
</a><a href="#h33-0-109" id="h33-0-109" class="i">+    fn call_id() -&gt; Vec&lt;u8&gt; {
</a><a href="#h33-0-110" id="h33-0-110" class="i">+        Uuid::new_v4().as_bytes().to_vec()
</a><a href="#h33-0-111" id="h33-0-111" class="i">+    }
</a><a href="#h33-0-112" id="h33-0-112" class="i">+
</a><a href="#h33-0-113" id="h33-0-113" class="i">+    /// Mutates the Raft state machine.
</a><a href="#h33-0-114" id="h33-0-114" class="i">+    pub fn mutate(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h33-0-115" id="h33-0-115" class="i">+        match self.call(Event::MutateState { call_id: Self::call_id(), command })? {
</a><a href="#h33-0-116" id="h33-0-116" class="i">+            Event::RespondState { response, .. } =&gt; Ok(response),
</a><a href="#h33-0-117" id="h33-0-117" class="i">+            event =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft mutate response {:?}&quot;, event))),
</a><a href="#h33-0-118" id="h33-0-118" class="i">+        }
</a><a href="#h33-0-119" id="h33-0-119" class="i">+    }
</a><a href="#h33-0-120" id="h33-0-120" class="i">+
</a><a href="#h33-0-121" id="h33-0-121" class="i">+    /// Reads from the Raft state machine.
</a><a href="#h33-0-122" id="h33-0-122" class="i">+    pub fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h33-0-123" id="h33-0-123" class="i">+        match self.call(Event::ReadState { call_id: Self::call_id(), command })? {
</a><a href="#h33-0-124" id="h33-0-124" class="i">+            Event::RespondState { response, .. } =&gt; Ok(response),
</a><a href="#h33-0-125" id="h33-0-125" class="i">+            event =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft read response {:?}&quot;, event))),
</a><a href="#h33-0-126" id="h33-0-126" class="i">+        }
</a><a href="#h33-0-127" id="h33-0-127" class="i">+    }
</a><a href="#h33-0-128" id="h33-0-128" class="i">+}
</a><a href="#h33-0-129" id="h33-0-129" class="i">+
</a><a href="#h33-0-130" id="h33-0-130" class="i">+#[cfg(test)]
</a><a href="#h33-0-131" id="h33-0-131" class="i">+pub mod tests {
</a><a href="#h33-0-132" id="h33-0-132" class="i">+    use super::*;
</a><a href="#h33-0-133" id="h33-0-133" class="i">+    use crossbeam_channel::Receiver;
</a><a href="#h33-0-134" id="h33-0-134" class="i">+    use std::sync::{Arc, Mutex};
</a><a href="#h33-0-135" id="h33-0-135" class="i">+
</a><a href="#h33-0-136" id="h33-0-136" class="i">+    #[derive(Clone, Debug)]
</a><a href="#h33-0-137" id="h33-0-137" class="i">+    pub struct TestState {
</a><a href="#h33-0-138" id="h33-0-138" class="i">+        commands: Arc&lt;Mutex&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h33-0-139" id="h33-0-139" class="i">+    }
</a><a href="#h33-0-140" id="h33-0-140" class="i">+
</a><a href="#h33-0-141" id="h33-0-141" class="i">+    impl TestState {
</a><a href="#h33-0-142" id="h33-0-142" class="i">+        pub fn new() -&gt; Self {
</a><a href="#h33-0-143" id="h33-0-143" class="i">+            Self { commands: Arc::new(Mutex::new(Vec::new())) }
</a><a href="#h33-0-144" id="h33-0-144" class="i">+        }
</a><a href="#h33-0-145" id="h33-0-145" class="i">+
</a><a href="#h33-0-146" id="h33-0-146" class="i">+        pub fn boxed(&amp;self) -&gt; Box&lt;State&gt; {
</a><a href="#h33-0-147" id="h33-0-147" class="i">+            Box::new(self.clone())
</a><a href="#h33-0-148" id="h33-0-148" class="i">+        }
</a><a href="#h33-0-149" id="h33-0-149" class="i">+
</a><a href="#h33-0-150" id="h33-0-150" class="i">+        pub fn list(&amp;self) -&gt; Vec&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h33-0-151" id="h33-0-151" class="i">+            self.commands.lock().unwrap().clone()
</a><a href="#h33-0-152" id="h33-0-152" class="i">+        }
</a><a href="#h33-0-153" id="h33-0-153" class="i">+    }
</a><a href="#h33-0-154" id="h33-0-154" class="i">+
</a><a href="#h33-0-155" id="h33-0-155" class="i">+    impl State for TestState {
</a><a href="#h33-0-156" id="h33-0-156" class="i">+        // Appends the command to the internal commands list, and
</a><a href="#h33-0-157" id="h33-0-157" class="i">+        // returns the command prefixed with a 0xff byte.
</a><a href="#h33-0-158" id="h33-0-158" class="i">+        fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h33-0-159" id="h33-0-159" class="i">+            if command.len() != 1 {
</a><a href="#h33-0-160" id="h33-0-160" class="i">+                return Err(Error::Value(&quot;Mutation payload must be 1 byte&quot;.into()));
</a><a href="#h33-0-161" id="h33-0-161" class="i">+            }
</a><a href="#h33-0-162" id="h33-0-162" class="i">+            self.commands.lock()?.push(command.clone());
</a><a href="#h33-0-163" id="h33-0-163" class="i">+            Ok(vec![0xff, command[0]])
</a><a href="#h33-0-164" id="h33-0-164" class="i">+        }
</a><a href="#h33-0-165" id="h33-0-165" class="i">+
</a><a href="#h33-0-166" id="h33-0-166" class="i">+        // Reads the command in the internal commands list at the index
</a><a href="#h33-0-167" id="h33-0-167" class="i">+        // given by the read command (1-based). Returns the stored command prefixed by
</a><a href="#h33-0-168" id="h33-0-168" class="i">+        // 0xbb, or 0xbb 0x00 if not found.
</a><a href="#h33-0-169" id="h33-0-169" class="i">+        fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h33-0-170" id="h33-0-170" class="i">+            if command.len() != 1 {
</a><a href="#h33-0-171" id="h33-0-171" class="i">+                return Err(Error::Value(&quot;Read payload must be 1 byte&quot;.into()));
</a><a href="#h33-0-172" id="h33-0-172" class="i">+            }
</a><a href="#h33-0-173" id="h33-0-173" class="i">+            let index = command[0] as usize;
</a><a href="#h33-0-174" id="h33-0-174" class="i">+            Ok(vec![0xbb, self.commands.lock()?.get(index - 1).map(|c| c[0]).unwrap_or(0x00)])
</a><a href="#h33-0-175" id="h33-0-175" class="i">+        }
</a><a href="#h33-0-176" id="h33-0-176" class="i">+    }
</a><a href="#h33-0-177" id="h33-0-177" class="i">+
</a><a href="#h33-0-178" id="h33-0-178" class="i">+    pub fn assert_messages(rx: &amp;Receiver&lt;Message&gt;, msgs: Vec&lt;Message&gt;) {
</a><a href="#h33-0-179" id="h33-0-179" class="i">+        let mut actual = Vec::new();
</a><a href="#h33-0-180" id="h33-0-180" class="i">+        while !rx.is_empty() {
</a><a href="#h33-0-181" id="h33-0-181" class="i">+            actual.push(rx.recv().unwrap());
</a><a href="#h33-0-182" id="h33-0-182" class="i">+        }
</a><a href="#h33-0-183" id="h33-0-183" class="i">+        assert_eq!(msgs, actual);
</a><a href="#h33-0-184" id="h33-0-184" class="i">+    }
</a><a href="#h33-0-185" id="h33-0-185" class="i">+}
</a><b>diff --git a/<a id="h34" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,283 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+use super::*;
</a><a href="#h34-0-1" id="h34-0-1" class="i">+use rand::Rng;
</a><a href="#h34-0-2" id="h34-0-2" class="i">+
</a><a href="#h34-0-3" id="h34-0-3" class="i">+/// A candidate is campaigning to become a leader.
</a><a href="#h34-0-4" id="h34-0-4" class="i">+#[derive(Debug)]
</a><a href="#h34-0-5" id="h34-0-5" class="i">+pub struct Candidate {
</a><a href="#h34-0-6" id="h34-0-6" class="i">+    /// Ticks elapsed since election start.
</a><a href="#h34-0-7" id="h34-0-7" class="i">+    election_ticks: u64,
</a><a href="#h34-0-8" id="h34-0-8" class="i">+    /// Election timeout, in ticks.
</a><a href="#h34-0-9" id="h34-0-9" class="i">+    election_timeout: u64,
</a><a href="#h34-0-10" id="h34-0-10" class="i">+    /// Votes received (including ourself).
</a><a href="#h34-0-11" id="h34-0-11" class="i">+    votes: u64,
</a><a href="#h34-0-12" id="h34-0-12" class="i">+}
</a><a href="#h34-0-13" id="h34-0-13" class="i">+
</a><a href="#h34-0-14" id="h34-0-14" class="i">+impl Candidate {
</a><a href="#h34-0-15" id="h34-0-15" class="i">+    /// Creates a new candidate role.
</a><a href="#h34-0-16" id="h34-0-16" class="i">+    pub fn new() -&gt; Self {
</a><a href="#h34-0-17" id="h34-0-17" class="i">+        Self {
</a><a href="#h34-0-18" id="h34-0-18" class="i">+            election_ticks: 0,
</a><a href="#h34-0-19" id="h34-0-19" class="i">+            election_timeout: rand::thread_rng()
</a><a href="#h34-0-20" id="h34-0-20" class="i">+                .gen_range(ELECTION_TIMEOUT_MIN, ELECTION_TIMEOUT_MAX),
</a><a href="#h34-0-21" id="h34-0-21" class="i">+            // We always start with a vote for ourselves.
</a><a href="#h34-0-22" id="h34-0-22" class="i">+            votes: 1,
</a><a href="#h34-0-23" id="h34-0-23" class="i">+        }
</a><a href="#h34-0-24" id="h34-0-24" class="i">+    }
</a><a href="#h34-0-25" id="h34-0-25" class="i">+}
</a><a href="#h34-0-26" id="h34-0-26" class="i">+
</a><a href="#h34-0-27" id="h34-0-27" class="i">+impl RoleNode&lt;Candidate&gt; {
</a><a href="#h34-0-28" id="h34-0-28" class="i">+    /// Transition to follower role.
</a><a href="#h34-0-29" id="h34-0-29" class="i">+    fn become_follower(mut self, term: u64, leader: &amp;str) -&gt; Result&lt;RoleNode&lt;Follower&gt;, Error&gt; {
</a><a href="#h34-0-30" id="h34-0-30" class="i">+        info!(&quot;Discovered leader {} for term {}, following&quot;, leader, term);
</a><a href="#h34-0-31" id="h34-0-31" class="i">+        self.save_term(term, None)?;
</a><a href="#h34-0-32" id="h34-0-32" class="i">+        self.become_role(Follower::new(Some(leader), None))
</a><a href="#h34-0-33" id="h34-0-33" class="i">+    }
</a><a href="#h34-0-34" id="h34-0-34" class="i">+
</a><a href="#h34-0-35" id="h34-0-35" class="i">+    /// Transition to leader role.
</a><a href="#h34-0-36" id="h34-0-36" class="i">+    fn become_leader(self) -&gt; Result&lt;RoleNode&lt;Leader&gt;, Error&gt; {
</a><a href="#h34-0-37" id="h34-0-37" class="i">+        info!(&quot;Won election for term {}, becoming leader&quot;, self.term);
</a><a href="#h34-0-38" id="h34-0-38" class="i">+        let peers = self.peers.clone();
</a><a href="#h34-0-39" id="h34-0-39" class="i">+        let (last_index, _) = self.log.get_last();
</a><a href="#h34-0-40" id="h34-0-40" class="i">+        let (commit_index, commit_term) = self.log.get_committed();
</a><a href="#h34-0-41" id="h34-0-41" class="i">+        let mut node = self.become_role(Leader::new(peers, last_index))?;
</a><a href="#h34-0-42" id="h34-0-42" class="i">+        node.broadcast(Event::Heartbeat { commit_index, commit_term })?;
</a><a href="#h34-0-43" id="h34-0-43" class="i">+        node.append(None)?;
</a><a href="#h34-0-44" id="h34-0-44" class="i">+        Ok(node)
</a><a href="#h34-0-45" id="h34-0-45" class="i">+    }
</a><a href="#h34-0-46" id="h34-0-46" class="i">+
</a><a href="#h34-0-47" id="h34-0-47" class="i">+    /// Processes a message.
</a><a href="#h34-0-48" id="h34-0-48" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h34-0-49" id="h34-0-49" class="i">+        if !self.normalize_message(&amp;mut msg) {
</a><a href="#h34-0-50" id="h34-0-50" class="i">+            return Ok(self.into());
</a><a href="#h34-0-51" id="h34-0-51" class="i">+        }
</a><a href="#h34-0-52" id="h34-0-52" class="i">+        if msg.term &gt; self.term {
</a><a href="#h34-0-53" id="h34-0-53" class="i">+            if let Some(from) = &amp;msg.from {
</a><a href="#h34-0-54" id="h34-0-54" class="i">+                return self.become_follower(msg.term, from)?.step(msg);
</a><a href="#h34-0-55" id="h34-0-55" class="i">+            }
</a><a href="#h34-0-56" id="h34-0-56" class="i">+        }
</a><a href="#h34-0-57" id="h34-0-57" class="i">+
</a><a href="#h34-0-58" id="h34-0-58" class="i">+        match msg.event {
</a><a href="#h34-0-59" id="h34-0-59" class="i">+            Event::Heartbeat { .. } =&gt; {
</a><a href="#h34-0-60" id="h34-0-60" class="i">+                if let Some(from) = &amp;msg.from {
</a><a href="#h34-0-61" id="h34-0-61" class="i">+                    return self.become_follower(msg.term, from)?.step(msg);
</a><a href="#h34-0-62" id="h34-0-62" class="i">+                }
</a><a href="#h34-0-63" id="h34-0-63" class="i">+            }
</a><a href="#h34-0-64" id="h34-0-64" class="i">+            Event::GrantVote =&gt; {
</a><a href="#h34-0-65" id="h34-0-65" class="i">+                debug!(&quot;Received term {} vote from {:?}&quot;, self.term, msg.from);
</a><a href="#h34-0-66" id="h34-0-66" class="i">+                self.role.votes += 1;
</a><a href="#h34-0-67" id="h34-0-67" class="i">+                if self.role.votes &gt;= self.quorum() {
</a><a href="#h34-0-68" id="h34-0-68" class="i">+                    return Ok(self.become_leader()?.into());
</a><a href="#h34-0-69" id="h34-0-69" class="i">+                }
</a><a href="#h34-0-70" id="h34-0-70" class="i">+            }
</a><a href="#h34-0-71" id="h34-0-71" class="i">+            Event::ConfirmLeader { .. } =&gt; {}
</a><a href="#h34-0-72" id="h34-0-72" class="i">+            Event::SolicitVote { .. } =&gt; {}
</a><a href="#h34-0-73" id="h34-0-73" class="i">+            Event::ReplicateEntries { .. } =&gt; {}
</a><a href="#h34-0-74" id="h34-0-74" class="i">+            Event::AcceptEntries { .. } =&gt; {}
</a><a href="#h34-0-75" id="h34-0-75" class="i">+            Event::RejectEntries { .. } =&gt; {}
</a><a href="#h34-0-76" id="h34-0-76" class="i">+            // FIXME These should be queued or something
</a><a href="#h34-0-77" id="h34-0-77" class="i">+            Event::ReadState { .. } =&gt; {}
</a><a href="#h34-0-78" id="h34-0-78" class="i">+            Event::MutateState { .. } =&gt; {}
</a><a href="#h34-0-79" id="h34-0-79" class="i">+            Event::RespondState { .. } =&gt; {}
</a><a href="#h34-0-80" id="h34-0-80" class="i">+            Event::RespondError { .. } =&gt; {}
</a><a href="#h34-0-81" id="h34-0-81" class="i">+        }
</a><a href="#h34-0-82" id="h34-0-82" class="i">+        Ok(self.into())
</a><a href="#h34-0-83" id="h34-0-83" class="i">+    }
</a><a href="#h34-0-84" id="h34-0-84" class="i">+
</a><a href="#h34-0-85" id="h34-0-85" class="i">+    /// Processes a logical clock tick.
</a><a href="#h34-0-86" id="h34-0-86" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h34-0-87" id="h34-0-87" class="i">+        // If the election times out, start a new one for the next term.
</a><a href="#h34-0-88" id="h34-0-88" class="i">+        self.role.election_ticks += 1;
</a><a href="#h34-0-89" id="h34-0-89" class="i">+        if self.role.election_ticks &gt;= self.role.election_timeout {
</a><a href="#h34-0-90" id="h34-0-90" class="i">+            info!(&quot;Election timed out, starting new election for term {}&quot;, self.term + 1);
</a><a href="#h34-0-91" id="h34-0-91" class="i">+            self.save_term(self.term + 1, None)?;
</a><a href="#h34-0-92" id="h34-0-92" class="i">+            self.role = Candidate::new();
</a><a href="#h34-0-93" id="h34-0-93" class="i">+            let (last_index, last_term) = self.log.get_last();
</a><a href="#h34-0-94" id="h34-0-94" class="i">+            self.broadcast(Event::SolicitVote { last_index, last_term })?;
</a><a href="#h34-0-95" id="h34-0-95" class="i">+        }
</a><a href="#h34-0-96" id="h34-0-96" class="i">+        Ok(self.into())
</a><a href="#h34-0-97" id="h34-0-97" class="i">+    }
</a><a href="#h34-0-98" id="h34-0-98" class="i">+}
</a><a href="#h34-0-99" id="h34-0-99" class="i">+
</a><a href="#h34-0-100" id="h34-0-100" class="i">+#[cfg(test)]
</a><a href="#h34-0-101" id="h34-0-101" class="i">+mod tests {
</a><a href="#h34-0-102" id="h34-0-102" class="i">+    use super::super::tests::{assert_messages, assert_node, TestState};
</a><a href="#h34-0-103" id="h34-0-103" class="i">+    use super::*;
</a><a href="#h34-0-104" id="h34-0-104" class="i">+    use crossbeam_channel::Receiver;
</a><a href="#h34-0-105" id="h34-0-105" class="i">+
</a><a href="#h34-0-106" id="h34-0-106" class="i">+    fn setup() -&gt; (RoleNode&lt;Candidate&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h34-0-107" id="h34-0-107" class="i">+        let (sender, receiver) = crossbeam_channel::unbounded();
</a><a href="#h34-0-108" id="h34-0-108" class="i">+        let mut state = TestState::new().boxed();
</a><a href="#h34-0-109" id="h34-0-109" class="i">+        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h34-0-110" id="h34-0-110" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h34-0-111" id="h34-0-111" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h34-0-112" id="h34-0-112" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h34-0-113" id="h34-0-113" class="i">+        log.commit(2).unwrap();
</a><a href="#h34-0-114" id="h34-0-114" class="i">+        log.apply(&amp;mut state).unwrap();
</a><a href="#h34-0-115" id="h34-0-115" class="i">+
</a><a href="#h34-0-116" id="h34-0-116" class="i">+        let mut node = RoleNode {
</a><a href="#h34-0-117" id="h34-0-117" class="i">+            id: &quot;a&quot;.into(),
</a><a href="#h34-0-118" id="h34-0-118" class="i">+            peers: vec![&quot;b&quot;.into(), &quot;c&quot;.into(), &quot;d&quot;.into(), &quot;e&quot;.into()],
</a><a href="#h34-0-119" id="h34-0-119" class="i">+            term: 3,
</a><a href="#h34-0-120" id="h34-0-120" class="i">+            log,
</a><a href="#h34-0-121" id="h34-0-121" class="i">+            state,
</a><a href="#h34-0-122" id="h34-0-122" class="i">+            sender,
</a><a href="#h34-0-123" id="h34-0-123" class="i">+            role: Candidate::new(),
</a><a href="#h34-0-124" id="h34-0-124" class="i">+        };
</a><a href="#h34-0-125" id="h34-0-125" class="i">+        node.save_term(3, None).unwrap();
</a><a href="#h34-0-126" id="h34-0-126" class="i">+        (node, receiver)
</a><a href="#h34-0-127" id="h34-0-127" class="i">+    }
</a><a href="#h34-0-128" id="h34-0-128" class="i">+
</a><a href="#h34-0-129" id="h34-0-129" class="i">+    #[test]
</a><a href="#h34-0-130" id="h34-0-130" class="i">+    // Heartbeat for current term converts to follower and emits ConfirmLeader event
</a><a href="#h34-0-131" id="h34-0-131" class="i">+    fn step_heartbeat_current_term() {
</a><a href="#h34-0-132" id="h34-0-132" class="i">+        let (candidate, rx) = setup();
</a><a href="#h34-0-133" id="h34-0-133" class="i">+        let node = candidate
</a><a href="#h34-0-134" id="h34-0-134" class="i">+            .step(Message {
</a><a href="#h34-0-135" id="h34-0-135" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h34-0-136" id="h34-0-136" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-137" id="h34-0-137" class="i">+                term: 3,
</a><a href="#h34-0-138" id="h34-0-138" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h34-0-139" id="h34-0-139" class="i">+            })
</a><a href="#h34-0-140" id="h34-0-140" class="i">+            .unwrap();
</a><a href="#h34-0-141" id="h34-0-141" class="i">+        assert_node(&amp;node).is_follower().term(3);
</a><a href="#h34-0-142" id="h34-0-142" class="i">+        assert_messages(
</a><a href="#h34-0-143" id="h34-0-143" class="i">+            &amp;rx,
</a><a href="#h34-0-144" id="h34-0-144" class="i">+            vec![Message {
</a><a href="#h34-0-145" id="h34-0-145" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-146" id="h34-0-146" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h34-0-147" id="h34-0-147" class="i">+                term: 3,
</a><a href="#h34-0-148" id="h34-0-148" class="i">+                event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
</a><a href="#h34-0-149" id="h34-0-149" class="i">+            }],
</a><a href="#h34-0-150" id="h34-0-150" class="i">+        );
</a><a href="#h34-0-151" id="h34-0-151" class="i">+    }
</a><a href="#h34-0-152" id="h34-0-152" class="i">+
</a><a href="#h34-0-153" id="h34-0-153" class="i">+    #[test]
</a><a href="#h34-0-154" id="h34-0-154" class="i">+    // Heartbeat for future term converts to follower and emits ConfirmLeader event
</a><a href="#h34-0-155" id="h34-0-155" class="i">+    fn step_heartbeat_future_term() {
</a><a href="#h34-0-156" id="h34-0-156" class="i">+        let (candidate, rx) = setup();
</a><a href="#h34-0-157" id="h34-0-157" class="i">+        let node = candidate
</a><a href="#h34-0-158" id="h34-0-158" class="i">+            .step(Message {
</a><a href="#h34-0-159" id="h34-0-159" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h34-0-160" id="h34-0-160" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-161" id="h34-0-161" class="i">+                term: 4,
</a><a href="#h34-0-162" id="h34-0-162" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h34-0-163" id="h34-0-163" class="i">+            })
</a><a href="#h34-0-164" id="h34-0-164" class="i">+            .unwrap();
</a><a href="#h34-0-165" id="h34-0-165" class="i">+        assert_node(&amp;node).is_follower().term(4);
</a><a href="#h34-0-166" id="h34-0-166" class="i">+        assert_messages(
</a><a href="#h34-0-167" id="h34-0-167" class="i">+            &amp;rx,
</a><a href="#h34-0-168" id="h34-0-168" class="i">+            vec![Message {
</a><a href="#h34-0-169" id="h34-0-169" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-170" id="h34-0-170" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h34-0-171" id="h34-0-171" class="i">+                term: 4,
</a><a href="#h34-0-172" id="h34-0-172" class="i">+                event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
</a><a href="#h34-0-173" id="h34-0-173" class="i">+            }],
</a><a href="#h34-0-174" id="h34-0-174" class="i">+        );
</a><a href="#h34-0-175" id="h34-0-175" class="i">+    }
</a><a href="#h34-0-176" id="h34-0-176" class="i">+
</a><a href="#h34-0-177" id="h34-0-177" class="i">+    #[test]
</a><a href="#h34-0-178" id="h34-0-178" class="i">+    // Heartbeat for past term is ignored
</a><a href="#h34-0-179" id="h34-0-179" class="i">+    fn step_heartbeat_past_term() {
</a><a href="#h34-0-180" id="h34-0-180" class="i">+        let (candidate, rx) = setup();
</a><a href="#h34-0-181" id="h34-0-181" class="i">+        let node = candidate
</a><a href="#h34-0-182" id="h34-0-182" class="i">+            .step(Message {
</a><a href="#h34-0-183" id="h34-0-183" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h34-0-184" id="h34-0-184" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-185" id="h34-0-185" class="i">+                term: 2,
</a><a href="#h34-0-186" id="h34-0-186" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h34-0-187" id="h34-0-187" class="i">+            })
</a><a href="#h34-0-188" id="h34-0-188" class="i">+            .unwrap();
</a><a href="#h34-0-189" id="h34-0-189" class="i">+        assert_node(&amp;node).is_candidate().term(3);
</a><a href="#h34-0-190" id="h34-0-190" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h34-0-191" id="h34-0-191" class="i">+    }
</a><a href="#h34-0-192" id="h34-0-192" class="i">+
</a><a href="#h34-0-193" id="h34-0-193" class="i">+    #[test]
</a><a href="#h34-0-194" id="h34-0-194" class="i">+    fn step_grantvote() {
</a><a href="#h34-0-195" id="h34-0-195" class="i">+        let (candidate, rx) = setup();
</a><a href="#h34-0-196" id="h34-0-196" class="i">+        let peers = candidate.peers.clone();
</a><a href="#h34-0-197" id="h34-0-197" class="i">+        let mut node = Node::Candidate(candidate);
</a><a href="#h34-0-198" id="h34-0-198" class="i">+
</a><a href="#h34-0-199" id="h34-0-199" class="i">+        // The first vote is not sufficient for a quorum (3 votes including self)
</a><a href="#h34-0-200" id="h34-0-200" class="i">+        node = node
</a><a href="#h34-0-201" id="h34-0-201" class="i">+            .step(Message {
</a><a href="#h34-0-202" id="h34-0-202" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h34-0-203" id="h34-0-203" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-204" id="h34-0-204" class="i">+                term: 3,
</a><a href="#h34-0-205" id="h34-0-205" class="i">+                event: Event::GrantVote,
</a><a href="#h34-0-206" id="h34-0-206" class="i">+            })
</a><a href="#h34-0-207" id="h34-0-207" class="i">+            .unwrap();
</a><a href="#h34-0-208" id="h34-0-208" class="i">+        assert_node(&amp;node).is_candidate().term(3);
</a><a href="#h34-0-209" id="h34-0-209" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h34-0-210" id="h34-0-210" class="i">+
</a><a href="#h34-0-211" id="h34-0-211" class="i">+        // However, the second external vote makes us leader
</a><a href="#h34-0-212" id="h34-0-212" class="i">+        node = node
</a><a href="#h34-0-213" id="h34-0-213" class="i">+            .step(Message {
</a><a href="#h34-0-214" id="h34-0-214" class="i">+                from: Some(&quot;e&quot;.into()),
</a><a href="#h34-0-215" id="h34-0-215" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-216" id="h34-0-216" class="i">+                term: 3,
</a><a href="#h34-0-217" id="h34-0-217" class="i">+                event: Event::GrantVote,
</a><a href="#h34-0-218" id="h34-0-218" class="i">+            })
</a><a href="#h34-0-219" id="h34-0-219" class="i">+            .unwrap();
</a><a href="#h34-0-220" id="h34-0-220" class="i">+        assert_node(&amp;node).is_leader().term(3);
</a><a href="#h34-0-221" id="h34-0-221" class="i">+
</a><a href="#h34-0-222" id="h34-0-222" class="i">+        for to in peers.iter().cloned() {
</a><a href="#h34-0-223" id="h34-0-223" class="i">+            assert!(!rx.is_empty());
</a><a href="#h34-0-224" id="h34-0-224" class="i">+            assert_eq!(
</a><a href="#h34-0-225" id="h34-0-225" class="i">+                rx.recv().unwrap(),
</a><a href="#h34-0-226" id="h34-0-226" class="i">+                Message {
</a><a href="#h34-0-227" id="h34-0-227" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-228" id="h34-0-228" class="i">+                    to: Some(to),
</a><a href="#h34-0-229" id="h34-0-229" class="i">+                    term: 3,
</a><a href="#h34-0-230" id="h34-0-230" class="i">+                    event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
</a><a href="#h34-0-231" id="h34-0-231" class="i">+                }
</a><a href="#h34-0-232" id="h34-0-232" class="i">+            )
</a><a href="#h34-0-233" id="h34-0-233" class="i">+        }
</a><a href="#h34-0-234" id="h34-0-234" class="i">+
</a><a href="#h34-0-235" id="h34-0-235" class="i">+        for to in peers.iter().cloned() {
</a><a href="#h34-0-236" id="h34-0-236" class="i">+            assert!(!rx.is_empty());
</a><a href="#h34-0-237" id="h34-0-237" class="i">+            assert_eq!(
</a><a href="#h34-0-238" id="h34-0-238" class="i">+                rx.recv().unwrap(),
</a><a href="#h34-0-239" id="h34-0-239" class="i">+                Message {
</a><a href="#h34-0-240" id="h34-0-240" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-241" id="h34-0-241" class="i">+                    to: Some(to),
</a><a href="#h34-0-242" id="h34-0-242" class="i">+                    term: 3,
</a><a href="#h34-0-243" id="h34-0-243" class="i">+                    event: Event::ReplicateEntries {
</a><a href="#h34-0-244" id="h34-0-244" class="i">+                        base_index: 3,
</a><a href="#h34-0-245" id="h34-0-245" class="i">+                        base_term: 2,
</a><a href="#h34-0-246" id="h34-0-246" class="i">+                        entries: vec![Entry { term: 3, command: None }],
</a><a href="#h34-0-247" id="h34-0-247" class="i">+                    },
</a><a href="#h34-0-248" id="h34-0-248" class="i">+                }
</a><a href="#h34-0-249" id="h34-0-249" class="i">+            )
</a><a href="#h34-0-250" id="h34-0-250" class="i">+        }
</a><a href="#h34-0-251" id="h34-0-251" class="i">+
</a><a href="#h34-0-252" id="h34-0-252" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h34-0-253" id="h34-0-253" class="i">+    }
</a><a href="#h34-0-254" id="h34-0-254" class="i">+
</a><a href="#h34-0-255" id="h34-0-255" class="i">+    #[test]
</a><a href="#h34-0-256" id="h34-0-256" class="i">+    fn tick() {
</a><a href="#h34-0-257" id="h34-0-257" class="i">+        let (candidate, rx) = setup();
</a><a href="#h34-0-258" id="h34-0-258" class="i">+        let timeout = candidate.role.election_timeout;
</a><a href="#h34-0-259" id="h34-0-259" class="i">+        let peers = candidate.peers.clone();
</a><a href="#h34-0-260" id="h34-0-260" class="i">+        let mut node = Node::Candidate(candidate);
</a><a href="#h34-0-261" id="h34-0-261" class="i">+
</a><a href="#h34-0-262" id="h34-0-262" class="i">+        assert!(timeout &gt; 0);
</a><a href="#h34-0-263" id="h34-0-263" class="i">+        for i in 0..timeout {
</a><a href="#h34-0-264" id="h34-0-264" class="i">+            assert_node(&amp;node).is_candidate().term(3).applied(if i &gt; 0 { 2 } else { 1 });
</a><a href="#h34-0-265" id="h34-0-265" class="i">+            node = node.tick().unwrap();
</a><a href="#h34-0-266" id="h34-0-266" class="i">+        }
</a><a href="#h34-0-267" id="h34-0-267" class="i">+        assert_node(&amp;node).is_candidate().term(4);
</a><a href="#h34-0-268" id="h34-0-268" class="i">+
</a><a href="#h34-0-269" id="h34-0-269" class="i">+        for to in peers.into_iter() {
</a><a href="#h34-0-270" id="h34-0-270" class="i">+            assert!(!rx.is_empty());
</a><a href="#h34-0-271" id="h34-0-271" class="i">+            assert_eq!(
</a><a href="#h34-0-272" id="h34-0-272" class="i">+                rx.recv().unwrap(),
</a><a href="#h34-0-273" id="h34-0-273" class="i">+                Message {
</a><a href="#h34-0-274" id="h34-0-274" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h34-0-275" id="h34-0-275" class="i">+                    to: Some(to),
</a><a href="#h34-0-276" id="h34-0-276" class="i">+                    term: 4,
</a><a href="#h34-0-277" id="h34-0-277" class="i">+                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h34-0-278" id="h34-0-278" class="i">+                }
</a><a href="#h34-0-279" id="h34-0-279" class="i">+            )
</a><a href="#h34-0-280" id="h34-0-280" class="i">+        }
</a><a href="#h34-0-281" id="h34-0-281" class="i">+    }
</a><a href="#h34-0-282" id="h34-0-282" class="i">+}
</a><b>diff --git a/<a id="h35" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,865 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+use super::*;
</a><a href="#h35-0-1" id="h35-0-1" class="i">+use rand::Rng;
</a><a href="#h35-0-2" id="h35-0-2" class="i">+use std::collections::HashMap;
</a><a href="#h35-0-3" id="h35-0-3" class="i">+
</a><a href="#h35-0-4" id="h35-0-4" class="i">+// A follower replicates state from a leader.
</a><a href="#h35-0-5" id="h35-0-5" class="i">+#[derive(Debug)]
</a><a href="#h35-0-6" id="h35-0-6" class="i">+pub struct Follower {
</a><a href="#h35-0-7" id="h35-0-7" class="i">+    /// The leader, or None if just initialized.
</a><a href="#h35-0-8" id="h35-0-8" class="i">+    leader: Option&lt;String&gt;,
</a><a href="#h35-0-9" id="h35-0-9" class="i">+    /// The number of ticks since the last message from the leader.
</a><a href="#h35-0-10" id="h35-0-10" class="i">+    leader_seen_ticks: u64,
</a><a href="#h35-0-11" id="h35-0-11" class="i">+    /// The timeout before triggering an election.
</a><a href="#h35-0-12" id="h35-0-12" class="i">+    leader_seen_timeout: u64,
</a><a href="#h35-0-13" id="h35-0-13" class="i">+    /// The node we voted for in the current term, if any.
</a><a href="#h35-0-14" id="h35-0-14" class="i">+    voted_for: Option&lt;String&gt;,
</a><a href="#h35-0-15" id="h35-0-15" class="i">+    /// Keeps track of any proxied calls to the leader (call ID to message sender).
</a><a href="#h35-0-16" id="h35-0-16" class="i">+    proxy_calls: HashMap&lt;Vec&lt;u8&gt;, Option&lt;String&gt;&gt;,
</a><a href="#h35-0-17" id="h35-0-17" class="i">+}
</a><a href="#h35-0-18" id="h35-0-18" class="i">+
</a><a href="#h35-0-19" id="h35-0-19" class="i">+impl Follower {
</a><a href="#h35-0-20" id="h35-0-20" class="i">+    /// Creates a new follower role.
</a><a href="#h35-0-21" id="h35-0-21" class="i">+    pub fn new(leader: Option&lt;&amp;str&gt;, voted_for: Option&lt;&amp;str&gt;) -&gt; Self {
</a><a href="#h35-0-22" id="h35-0-22" class="i">+        Self {
</a><a href="#h35-0-23" id="h35-0-23" class="i">+            leader: leader.map(str::to_owned),
</a><a href="#h35-0-24" id="h35-0-24" class="i">+            voted_for: voted_for.map(str::to_owned),
</a><a href="#h35-0-25" id="h35-0-25" class="i">+            leader_seen_ticks: 0,
</a><a href="#h35-0-26" id="h35-0-26" class="i">+            leader_seen_timeout: rand::thread_rng()
</a><a href="#h35-0-27" id="h35-0-27" class="i">+                .gen_range(ELECTION_TIMEOUT_MIN, ELECTION_TIMEOUT_MAX),
</a><a href="#h35-0-28" id="h35-0-28" class="i">+            proxy_calls: HashMap::new(),
</a><a href="#h35-0-29" id="h35-0-29" class="i">+        }
</a><a href="#h35-0-30" id="h35-0-30" class="i">+    }
</a><a href="#h35-0-31" id="h35-0-31" class="i">+}
</a><a href="#h35-0-32" id="h35-0-32" class="i">+
</a><a href="#h35-0-33" id="h35-0-33" class="i">+impl RoleNode&lt;Follower&gt; {
</a><a href="#h35-0-34" id="h35-0-34" class="i">+    /// Transforms the node into a candidate.
</a><a href="#h35-0-35" id="h35-0-35" class="i">+    fn become_candidate(self) -&gt; Result&lt;RoleNode&lt;Candidate&gt;, Error&gt; {
</a><a href="#h35-0-36" id="h35-0-36" class="i">+        info!(&quot;Starting election for term {}&quot;, self.term + 1);
</a><a href="#h35-0-37" id="h35-0-37" class="i">+        let mut node = self.become_role(Candidate::new())?;
</a><a href="#h35-0-38" id="h35-0-38" class="i">+        node.save_term(node.term + 1, None)?;
</a><a href="#h35-0-39" id="h35-0-39" class="i">+        let (last_index, last_term) = node.log.get_last();
</a><a href="#h35-0-40" id="h35-0-40" class="i">+        node.broadcast(Event::SolicitVote { last_index, last_term })?;
</a><a href="#h35-0-41" id="h35-0-41" class="i">+        Ok(node)
</a><a href="#h35-0-42" id="h35-0-42" class="i">+    }
</a><a href="#h35-0-43" id="h35-0-43" class="i">+
</a><a href="#h35-0-44" id="h35-0-44" class="i">+    /// Checks if the message sender is the current leader
</a><a href="#h35-0-45" id="h35-0-45" class="i">+    fn is_leader(&amp;self, from: Option&lt;&amp;str&gt;) -&gt; bool {
</a><a href="#h35-0-46" id="h35-0-46" class="i">+        if let Some(leader) = self.role.leader.as_deref() {
</a><a href="#h35-0-47" id="h35-0-47" class="i">+            if let Some(claimant) = from {
</a><a href="#h35-0-48" id="h35-0-48" class="i">+                return claimant == leader;
</a><a href="#h35-0-49" id="h35-0-49" class="i">+            }
</a><a href="#h35-0-50" id="h35-0-50" class="i">+        };
</a><a href="#h35-0-51" id="h35-0-51" class="i">+        false
</a><a href="#h35-0-52" id="h35-0-52" class="i">+    }
</a><a href="#h35-0-53" id="h35-0-53" class="i">+
</a><a href="#h35-0-54" id="h35-0-54" class="i">+    /// Processes a message.
</a><a href="#h35-0-55" id="h35-0-55" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h35-0-56" id="h35-0-56" class="i">+        if !self.normalize_message(&amp;mut msg) {
</a><a href="#h35-0-57" id="h35-0-57" class="i">+            return Ok(self.into());
</a><a href="#h35-0-58" id="h35-0-58" class="i">+        }
</a><a href="#h35-0-59" id="h35-0-59" class="i">+        if let Some(from) = &amp;msg.from {
</a><a href="#h35-0-60" id="h35-0-60" class="i">+            if msg.term &gt; self.term {
</a><a href="#h35-0-61" id="h35-0-61" class="i">+                info!(&quot;Discovered new term {}, following leader {}&quot;, msg.term, from);
</a><a href="#h35-0-62" id="h35-0-62" class="i">+                self.save_term(msg.term, None)?;
</a><a href="#h35-0-63" id="h35-0-63" class="i">+                self.role = Follower::new(Some(from), None);
</a><a href="#h35-0-64" id="h35-0-64" class="i">+            }
</a><a href="#h35-0-65" id="h35-0-65" class="i">+            if self.role.leader.is_none() {
</a><a href="#h35-0-66" id="h35-0-66" class="i">+                info!(&quot;Discovered leader {} in current term {}, following&quot;, from, self.term);
</a><a href="#h35-0-67" id="h35-0-67" class="i">+                self.role = Follower::new(Some(from), self.role.voted_for.as_deref());
</a><a href="#h35-0-68" id="h35-0-68" class="i">+            }
</a><a href="#h35-0-69" id="h35-0-69" class="i">+        }
</a><a href="#h35-0-70" id="h35-0-70" class="i">+        if self.is_leader(msg.from.as_deref()) {
</a><a href="#h35-0-71" id="h35-0-71" class="i">+            self.role.leader_seen_ticks = 0
</a><a href="#h35-0-72" id="h35-0-72" class="i">+        }
</a><a href="#h35-0-73" id="h35-0-73" class="i">+
</a><a href="#h35-0-74" id="h35-0-74" class="i">+        match msg.event {
</a><a href="#h35-0-75" id="h35-0-75" class="i">+            Event::Heartbeat { commit_index, commit_term } =&gt; {
</a><a href="#h35-0-76" id="h35-0-76" class="i">+                if self.is_leader(msg.from.as_deref()) {
</a><a href="#h35-0-77" id="h35-0-77" class="i">+                    let has_committed = self.log.has(commit_index, commit_term)?;
</a><a href="#h35-0-78" id="h35-0-78" class="i">+                    self.send(
</a><a href="#h35-0-79" id="h35-0-79" class="i">+                        msg.from.as_deref(),
</a><a href="#h35-0-80" id="h35-0-80" class="i">+                        Event::ConfirmLeader { commit_index, has_committed },
</a><a href="#h35-0-81" id="h35-0-81" class="i">+                    )?;
</a><a href="#h35-0-82" id="h35-0-82" class="i">+                    if has_committed {
</a><a href="#h35-0-83" id="h35-0-83" class="i">+                        self.log.commit(commit_index)?;
</a><a href="#h35-0-84" id="h35-0-84" class="i">+                    }
</a><a href="#h35-0-85" id="h35-0-85" class="i">+                }
</a><a href="#h35-0-86" id="h35-0-86" class="i">+            }
</a><a href="#h35-0-87" id="h35-0-87" class="i">+            Event::SolicitVote { last_index, last_term } =&gt; {
</a><a href="#h35-0-88" id="h35-0-88" class="i">+                if let Some(voted_for) = &amp;self.role.voted_for {
</a><a href="#h35-0-89" id="h35-0-89" class="i">+                    if let Some(from) = &amp;msg.from {
</a><a href="#h35-0-90" id="h35-0-90" class="i">+                        if voted_for != from {
</a><a href="#h35-0-91" id="h35-0-91" class="i">+                            return Ok(self.into());
</a><a href="#h35-0-92" id="h35-0-92" class="i">+                        }
</a><a href="#h35-0-93" id="h35-0-93" class="i">+                    }
</a><a href="#h35-0-94" id="h35-0-94" class="i">+                }
</a><a href="#h35-0-95" id="h35-0-95" class="i">+                let (local_last_index, local_last_term) = self.log.get_last();
</a><a href="#h35-0-96" id="h35-0-96" class="i">+                if last_term &lt; local_last_term {
</a><a href="#h35-0-97" id="h35-0-97" class="i">+                    return Ok(self.into());
</a><a href="#h35-0-98" id="h35-0-98" class="i">+                }
</a><a href="#h35-0-99" id="h35-0-99" class="i">+                if last_term == local_last_term &amp;&amp; last_index &lt; local_last_index {
</a><a href="#h35-0-100" id="h35-0-100" class="i">+                    return Ok(self.into());
</a><a href="#h35-0-101" id="h35-0-101" class="i">+                }
</a><a href="#h35-0-102" id="h35-0-102" class="i">+                if let Some(from) = msg.from {
</a><a href="#h35-0-103" id="h35-0-103" class="i">+                    info!(&quot;Voting for {} in term {} election&quot;, &amp;from, self.term);
</a><a href="#h35-0-104" id="h35-0-104" class="i">+                    self.send(Some(&amp;from), Event::GrantVote)?;
</a><a href="#h35-0-105" id="h35-0-105" class="i">+                    self.save_term(self.term, Some(&amp;from))?;
</a><a href="#h35-0-106" id="h35-0-106" class="i">+                    self.role.voted_for = Some(from);
</a><a href="#h35-0-107" id="h35-0-107" class="i">+                }
</a><a href="#h35-0-108" id="h35-0-108" class="i">+            }
</a><a href="#h35-0-109" id="h35-0-109" class="i">+            Event::ReplicateEntries { base_index, base_term, entries } =&gt; {
</a><a href="#h35-0-110" id="h35-0-110" class="i">+                if self.is_leader(msg.from.as_deref()) {
</a><a href="#h35-0-111" id="h35-0-111" class="i">+                    match self.log.splice(base_index, base_term, entries) {
</a><a href="#h35-0-112" id="h35-0-112" class="i">+                        Ok(last_index) =&gt; {
</a><a href="#h35-0-113" id="h35-0-113" class="i">+                            self.send(msg.from.as_deref(), Event::AcceptEntries { last_index })?
</a><a href="#h35-0-114" id="h35-0-114" class="i">+                        }
</a><a href="#h35-0-115" id="h35-0-115" class="i">+                        Err(Error::RaftBaseNotFound { .. }) =&gt; {
</a><a href="#h35-0-116" id="h35-0-116" class="i">+                            debug!(&quot;Rejecting log entries at base {}&quot;, base_index);
</a><a href="#h35-0-117" id="h35-0-117" class="i">+                            self.send(msg.from.as_deref(), Event::RejectEntries)?
</a><a href="#h35-0-118" id="h35-0-118" class="i">+                        }
</a><a href="#h35-0-119" id="h35-0-119" class="i">+                        Err(err) =&gt; return Err(err),
</a><a href="#h35-0-120" id="h35-0-120" class="i">+                    }
</a><a href="#h35-0-121" id="h35-0-121" class="i">+                }
</a><a href="#h35-0-122" id="h35-0-122" class="i">+            }
</a><a href="#h35-0-123" id="h35-0-123" class="i">+            Event::ReadState { ref call_id, .. } | Event::MutateState { ref call_id, .. } =&gt; {
</a><a href="#h35-0-124" id="h35-0-124" class="i">+                self.role.proxy_calls.insert(call_id.clone(), msg.from);
</a><a href="#h35-0-125" id="h35-0-125" class="i">+                self.send(self.role.leader.as_deref(), msg.event)?;
</a><a href="#h35-0-126" id="h35-0-126" class="i">+            }
</a><a href="#h35-0-127" id="h35-0-127" class="i">+            Event::RespondState { ref call_id, .. } | Event::RespondError { ref call_id, .. } =&gt; {
</a><a href="#h35-0-128" id="h35-0-128" class="i">+                if let Some(to) = self.role.proxy_calls.remove(call_id) {
</a><a href="#h35-0-129" id="h35-0-129" class="i">+                    self.send(to.as_deref(), msg.event)?
</a><a href="#h35-0-130" id="h35-0-130" class="i">+                }
</a><a href="#h35-0-131" id="h35-0-131" class="i">+            }
</a><a href="#h35-0-132" id="h35-0-132" class="i">+            Event::ConfirmLeader { .. } =&gt; {}
</a><a href="#h35-0-133" id="h35-0-133" class="i">+            Event::GrantVote =&gt; {}
</a><a href="#h35-0-134" id="h35-0-134" class="i">+            Event::AcceptEntries { .. } =&gt; {}
</a><a href="#h35-0-135" id="h35-0-135" class="i">+            Event::RejectEntries { .. } =&gt; {}
</a><a href="#h35-0-136" id="h35-0-136" class="i">+        };
</a><a href="#h35-0-137" id="h35-0-137" class="i">+        Ok(self.into())
</a><a href="#h35-0-138" id="h35-0-138" class="i">+    }
</a><a href="#h35-0-139" id="h35-0-139" class="i">+
</a><a href="#h35-0-140" id="h35-0-140" class="i">+    /// Processes a logical clock tick.
</a><a href="#h35-0-141" id="h35-0-141" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h35-0-142" id="h35-0-142" class="i">+        while let Some(_) = self.log.apply(&amp;mut self.state)? {}
</a><a href="#h35-0-143" id="h35-0-143" class="i">+        self.role.leader_seen_ticks += 1;
</a><a href="#h35-0-144" id="h35-0-144" class="i">+        if self.role.leader_seen_ticks &gt;= self.role.leader_seen_timeout {
</a><a href="#h35-0-145" id="h35-0-145" class="i">+            Ok(self.become_candidate()?.into())
</a><a href="#h35-0-146" id="h35-0-146" class="i">+        } else {
</a><a href="#h35-0-147" id="h35-0-147" class="i">+            Ok(self.into())
</a><a href="#h35-0-148" id="h35-0-148" class="i">+        }
</a><a href="#h35-0-149" id="h35-0-149" class="i">+    }
</a><a href="#h35-0-150" id="h35-0-150" class="i">+}
</a><a href="#h35-0-151" id="h35-0-151" class="i">+
</a><a href="#h35-0-152" id="h35-0-152" class="i">+#[cfg(test)]
</a><a href="#h35-0-153" id="h35-0-153" class="i">+pub mod tests {
</a><a href="#h35-0-154" id="h35-0-154" class="i">+    use super::super::tests::{assert_messages, assert_node, TestState};
</a><a href="#h35-0-155" id="h35-0-155" class="i">+    use super::*;
</a><a href="#h35-0-156" id="h35-0-156" class="i">+    use crossbeam_channel::Receiver;
</a><a href="#h35-0-157" id="h35-0-157" class="i">+
</a><a href="#h35-0-158" id="h35-0-158" class="i">+    pub fn follower_leader(node: &amp;RoleNode&lt;Follower&gt;) -&gt; Option&lt;String&gt; {
</a><a href="#h35-0-159" id="h35-0-159" class="i">+        node.role.leader.clone()
</a><a href="#h35-0-160" id="h35-0-160" class="i">+    }
</a><a href="#h35-0-161" id="h35-0-161" class="i">+
</a><a href="#h35-0-162" id="h35-0-162" class="i">+    pub fn follower_voted_for(node: &amp;RoleNode&lt;Follower&gt;) -&gt; Option&lt;String&gt; {
</a><a href="#h35-0-163" id="h35-0-163" class="i">+        node.role.voted_for.clone()
</a><a href="#h35-0-164" id="h35-0-164" class="i">+    }
</a><a href="#h35-0-165" id="h35-0-165" class="i">+
</a><a href="#h35-0-166" id="h35-0-166" class="i">+    fn setup() -&gt; (RoleNode&lt;Follower&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h35-0-167" id="h35-0-167" class="i">+        let (sender, receiver) = crossbeam_channel::unbounded();
</a><a href="#h35-0-168" id="h35-0-168" class="i">+        let mut state = TestState::new().boxed();
</a><a href="#h35-0-169" id="h35-0-169" class="i">+        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h35-0-170" id="h35-0-170" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h35-0-171" id="h35-0-171" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h35-0-172" id="h35-0-172" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h35-0-173" id="h35-0-173" class="i">+        log.commit(2).unwrap();
</a><a href="#h35-0-174" id="h35-0-174" class="i">+        log.apply(&amp;mut state).unwrap();
</a><a href="#h35-0-175" id="h35-0-175" class="i">+
</a><a href="#h35-0-176" id="h35-0-176" class="i">+        let mut node = RoleNode {
</a><a href="#h35-0-177" id="h35-0-177" class="i">+            id: &quot;a&quot;.into(),
</a><a href="#h35-0-178" id="h35-0-178" class="i">+            peers: vec![&quot;b&quot;.into(), &quot;c&quot;.into(), &quot;d&quot;.into(), &quot;e&quot;.into()],
</a><a href="#h35-0-179" id="h35-0-179" class="i">+            term: 3,
</a><a href="#h35-0-180" id="h35-0-180" class="i">+            log,
</a><a href="#h35-0-181" id="h35-0-181" class="i">+            state,
</a><a href="#h35-0-182" id="h35-0-182" class="i">+            sender,
</a><a href="#h35-0-183" id="h35-0-183" class="i">+            role: Follower::new(Some(&quot;b&quot;), None),
</a><a href="#h35-0-184" id="h35-0-184" class="i">+        };
</a><a href="#h35-0-185" id="h35-0-185" class="i">+        node.save_term(3, None).unwrap();
</a><a href="#h35-0-186" id="h35-0-186" class="i">+        (node, receiver)
</a><a href="#h35-0-187" id="h35-0-187" class="i">+    }
</a><a href="#h35-0-188" id="h35-0-188" class="i">+
</a><a href="#h35-0-189" id="h35-0-189" class="i">+    #[test]
</a><a href="#h35-0-190" id="h35-0-190" class="i">+    // Heartbeat from current leader
</a><a href="#h35-0-191" id="h35-0-191" class="i">+    fn step_heartbeat() {
</a><a href="#h35-0-192" id="h35-0-192" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-193" id="h35-0-193" class="i">+        let node = follower
</a><a href="#h35-0-194" id="h35-0-194" class="i">+            .step(Message {
</a><a href="#h35-0-195" id="h35-0-195" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-196" id="h35-0-196" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-197" id="h35-0-197" class="i">+                term: 3,
</a><a href="#h35-0-198" id="h35-0-198" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h35-0-199" id="h35-0-199" class="i">+            })
</a><a href="#h35-0-200" id="h35-0-200" class="i">+            .unwrap();
</a><a href="#h35-0-201" id="h35-0-201" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-202" id="h35-0-202" class="i">+            .is_follower()
</a><a href="#h35-0-203" id="h35-0-203" class="i">+            .term(3)
</a><a href="#h35-0-204" id="h35-0-204" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-205" id="h35-0-205" class="i">+            .voted_for(None)
</a><a href="#h35-0-206" id="h35-0-206" class="i">+            .committed(3)
</a><a href="#h35-0-207" id="h35-0-207" class="i">+            .applied(1);
</a><a href="#h35-0-208" id="h35-0-208" class="i">+        assert_messages(
</a><a href="#h35-0-209" id="h35-0-209" class="i">+            &amp;rx,
</a><a href="#h35-0-210" id="h35-0-210" class="i">+            vec![Message {
</a><a href="#h35-0-211" id="h35-0-211" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-212" id="h35-0-212" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-213" id="h35-0-213" class="i">+                term: 3,
</a><a href="#h35-0-214" id="h35-0-214" class="i">+                event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
</a><a href="#h35-0-215" id="h35-0-215" class="i">+            }],
</a><a href="#h35-0-216" id="h35-0-216" class="i">+        );
</a><a href="#h35-0-217" id="h35-0-217" class="i">+    }
</a><a href="#h35-0-218" id="h35-0-218" class="i">+
</a><a href="#h35-0-219" id="h35-0-219" class="i">+    #[test]
</a><a href="#h35-0-220" id="h35-0-220" class="i">+    // Heartbeat from current leader with conflicting commit_term
</a><a href="#h35-0-221" id="h35-0-221" class="i">+    fn step_heartbeat_conflict_commit_term() {
</a><a href="#h35-0-222" id="h35-0-222" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-223" id="h35-0-223" class="i">+        let node = follower
</a><a href="#h35-0-224" id="h35-0-224" class="i">+            .step(Message {
</a><a href="#h35-0-225" id="h35-0-225" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-226" id="h35-0-226" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-227" id="h35-0-227" class="i">+                term: 3,
</a><a href="#h35-0-228" id="h35-0-228" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 3 },
</a><a href="#h35-0-229" id="h35-0-229" class="i">+            })
</a><a href="#h35-0-230" id="h35-0-230" class="i">+            .unwrap();
</a><a href="#h35-0-231" id="h35-0-231" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-232" id="h35-0-232" class="i">+            .is_follower()
</a><a href="#h35-0-233" id="h35-0-233" class="i">+            .term(3)
</a><a href="#h35-0-234" id="h35-0-234" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-235" id="h35-0-235" class="i">+            .voted_for(None)
</a><a href="#h35-0-236" id="h35-0-236" class="i">+            .committed(2)
</a><a href="#h35-0-237" id="h35-0-237" class="i">+            .applied(1);
</a><a href="#h35-0-238" id="h35-0-238" class="i">+        assert_messages(
</a><a href="#h35-0-239" id="h35-0-239" class="i">+            &amp;rx,
</a><a href="#h35-0-240" id="h35-0-240" class="i">+            vec![Message {
</a><a href="#h35-0-241" id="h35-0-241" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-242" id="h35-0-242" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-243" id="h35-0-243" class="i">+                term: 3,
</a><a href="#h35-0-244" id="h35-0-244" class="i">+                event: Event::ConfirmLeader { commit_index: 3, has_committed: false },
</a><a href="#h35-0-245" id="h35-0-245" class="i">+            }],
</a><a href="#h35-0-246" id="h35-0-246" class="i">+        );
</a><a href="#h35-0-247" id="h35-0-247" class="i">+    }
</a><a href="#h35-0-248" id="h35-0-248" class="i">+
</a><a href="#h35-0-249" id="h35-0-249" class="i">+    #[test]
</a><a href="#h35-0-250" id="h35-0-250" class="i">+    // Heartbeat from current leader with a missing commit_index
</a><a href="#h35-0-251" id="h35-0-251" class="i">+    fn step_heartbeat_missing_commit_entry() {
</a><a href="#h35-0-252" id="h35-0-252" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-253" id="h35-0-253" class="i">+        let node = follower
</a><a href="#h35-0-254" id="h35-0-254" class="i">+            .step(Message {
</a><a href="#h35-0-255" id="h35-0-255" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-256" id="h35-0-256" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-257" id="h35-0-257" class="i">+                term: 3,
</a><a href="#h35-0-258" id="h35-0-258" class="i">+                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h35-0-259" id="h35-0-259" class="i">+            })
</a><a href="#h35-0-260" id="h35-0-260" class="i">+            .unwrap();
</a><a href="#h35-0-261" id="h35-0-261" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-262" id="h35-0-262" class="i">+            .is_follower()
</a><a href="#h35-0-263" id="h35-0-263" class="i">+            .term(3)
</a><a href="#h35-0-264" id="h35-0-264" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-265" id="h35-0-265" class="i">+            .voted_for(None)
</a><a href="#h35-0-266" id="h35-0-266" class="i">+            .committed(2)
</a><a href="#h35-0-267" id="h35-0-267" class="i">+            .applied(1);
</a><a href="#h35-0-268" id="h35-0-268" class="i">+        assert_messages(
</a><a href="#h35-0-269" id="h35-0-269" class="i">+            &amp;rx,
</a><a href="#h35-0-270" id="h35-0-270" class="i">+            vec![Message {
</a><a href="#h35-0-271" id="h35-0-271" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-272" id="h35-0-272" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-273" id="h35-0-273" class="i">+                term: 3,
</a><a href="#h35-0-274" id="h35-0-274" class="i">+                event: Event::ConfirmLeader { commit_index: 5, has_committed: false },
</a><a href="#h35-0-275" id="h35-0-275" class="i">+            }],
</a><a href="#h35-0-276" id="h35-0-276" class="i">+        );
</a><a href="#h35-0-277" id="h35-0-277" class="i">+    }
</a><a href="#h35-0-278" id="h35-0-278" class="i">+
</a><a href="#h35-0-279" id="h35-0-279" class="i">+    #[test]
</a><a href="#h35-0-280" id="h35-0-280" class="i">+    // Heartbeat from fake leader
</a><a href="#h35-0-281" id="h35-0-281" class="i">+    fn step_heartbeat_fake_leader() {
</a><a href="#h35-0-282" id="h35-0-282" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-283" id="h35-0-283" class="i">+        let node = follower
</a><a href="#h35-0-284" id="h35-0-284" class="i">+            .step(Message {
</a><a href="#h35-0-285" id="h35-0-285" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-286" id="h35-0-286" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-287" id="h35-0-287" class="i">+                term: 3,
</a><a href="#h35-0-288" id="h35-0-288" class="i">+                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h35-0-289" id="h35-0-289" class="i">+            })
</a><a href="#h35-0-290" id="h35-0-290" class="i">+            .unwrap();
</a><a href="#h35-0-291" id="h35-0-291" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-292" id="h35-0-292" class="i">+            .is_follower()
</a><a href="#h35-0-293" id="h35-0-293" class="i">+            .term(3)
</a><a href="#h35-0-294" id="h35-0-294" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-295" id="h35-0-295" class="i">+            .voted_for(None)
</a><a href="#h35-0-296" id="h35-0-296" class="i">+            .committed(2)
</a><a href="#h35-0-297" id="h35-0-297" class="i">+            .applied(1);
</a><a href="#h35-0-298" id="h35-0-298" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-299" id="h35-0-299" class="i">+    }
</a><a href="#h35-0-300" id="h35-0-300" class="i">+
</a><a href="#h35-0-301" id="h35-0-301" class="i">+    #[test]
</a><a href="#h35-0-302" id="h35-0-302" class="i">+    // Heartbeat when no current leader
</a><a href="#h35-0-303" id="h35-0-303" class="i">+    fn step_heartbeat_no_leader() {
</a><a href="#h35-0-304" id="h35-0-304" class="i">+        let (mut follower, rx) = setup();
</a><a href="#h35-0-305" id="h35-0-305" class="i">+        follower.role = Follower::new(None, None);
</a><a href="#h35-0-306" id="h35-0-306" class="i">+        let node = follower
</a><a href="#h35-0-307" id="h35-0-307" class="i">+            .step(Message {
</a><a href="#h35-0-308" id="h35-0-308" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-309" id="h35-0-309" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-310" id="h35-0-310" class="i">+                term: 3,
</a><a href="#h35-0-311" id="h35-0-311" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h35-0-312" id="h35-0-312" class="i">+            })
</a><a href="#h35-0-313" id="h35-0-313" class="i">+            .unwrap();
</a><a href="#h35-0-314" id="h35-0-314" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-315" id="h35-0-315" class="i">+            .is_follower()
</a><a href="#h35-0-316" id="h35-0-316" class="i">+            .term(3)
</a><a href="#h35-0-317" id="h35-0-317" class="i">+            .leader(Some(&quot;c&quot;))
</a><a href="#h35-0-318" id="h35-0-318" class="i">+            .voted_for(None)
</a><a href="#h35-0-319" id="h35-0-319" class="i">+            .committed(3)
</a><a href="#h35-0-320" id="h35-0-320" class="i">+            .applied(1);
</a><a href="#h35-0-321" id="h35-0-321" class="i">+        assert_messages(
</a><a href="#h35-0-322" id="h35-0-322" class="i">+            &amp;rx,
</a><a href="#h35-0-323" id="h35-0-323" class="i">+            vec![Message {
</a><a href="#h35-0-324" id="h35-0-324" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-325" id="h35-0-325" class="i">+                to: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-326" id="h35-0-326" class="i">+                term: 3,
</a><a href="#h35-0-327" id="h35-0-327" class="i">+                event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
</a><a href="#h35-0-328" id="h35-0-328" class="i">+            }],
</a><a href="#h35-0-329" id="h35-0-329" class="i">+        );
</a><a href="#h35-0-330" id="h35-0-330" class="i">+    }
</a><a href="#h35-0-331" id="h35-0-331" class="i">+
</a><a href="#h35-0-332" id="h35-0-332" class="i">+    #[test]
</a><a href="#h35-0-333" id="h35-0-333" class="i">+    // Heartbeat from current leader with old commit_index
</a><a href="#h35-0-334" id="h35-0-334" class="i">+    fn step_heartbeat_old_commit_index() {
</a><a href="#h35-0-335" id="h35-0-335" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-336" id="h35-0-336" class="i">+        let node = follower
</a><a href="#h35-0-337" id="h35-0-337" class="i">+            .step(Message {
</a><a href="#h35-0-338" id="h35-0-338" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-339" id="h35-0-339" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-340" id="h35-0-340" class="i">+                term: 3,
</a><a href="#h35-0-341" id="h35-0-341" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h35-0-342" id="h35-0-342" class="i">+            })
</a><a href="#h35-0-343" id="h35-0-343" class="i">+            .unwrap();
</a><a href="#h35-0-344" id="h35-0-344" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-345" id="h35-0-345" class="i">+            .is_follower()
</a><a href="#h35-0-346" id="h35-0-346" class="i">+            .term(3)
</a><a href="#h35-0-347" id="h35-0-347" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-348" id="h35-0-348" class="i">+            .voted_for(None)
</a><a href="#h35-0-349" id="h35-0-349" class="i">+            .committed(2)
</a><a href="#h35-0-350" id="h35-0-350" class="i">+            .applied(1);
</a><a href="#h35-0-351" id="h35-0-351" class="i">+        assert_messages(
</a><a href="#h35-0-352" id="h35-0-352" class="i">+            &amp;rx,
</a><a href="#h35-0-353" id="h35-0-353" class="i">+            vec![Message {
</a><a href="#h35-0-354" id="h35-0-354" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-355" id="h35-0-355" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-356" id="h35-0-356" class="i">+                term: 3,
</a><a href="#h35-0-357" id="h35-0-357" class="i">+                event: Event::ConfirmLeader { commit_index: 1, has_committed: true },
</a><a href="#h35-0-358" id="h35-0-358" class="i">+            }],
</a><a href="#h35-0-359" id="h35-0-359" class="i">+        );
</a><a href="#h35-0-360" id="h35-0-360" class="i">+    }
</a><a href="#h35-0-361" id="h35-0-361" class="i">+
</a><a href="#h35-0-362" id="h35-0-362" class="i">+    #[test]
</a><a href="#h35-0-363" id="h35-0-363" class="i">+    // Heartbeat for future term with other leader changes leader
</a><a href="#h35-0-364" id="h35-0-364" class="i">+    fn step_heartbeat_future_term() {
</a><a href="#h35-0-365" id="h35-0-365" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-366" id="h35-0-366" class="i">+        let node = follower
</a><a href="#h35-0-367" id="h35-0-367" class="i">+            .step(Message {
</a><a href="#h35-0-368" id="h35-0-368" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-369" id="h35-0-369" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-370" id="h35-0-370" class="i">+                term: 4,
</a><a href="#h35-0-371" id="h35-0-371" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h35-0-372" id="h35-0-372" class="i">+            })
</a><a href="#h35-0-373" id="h35-0-373" class="i">+            .unwrap();
</a><a href="#h35-0-374" id="h35-0-374" class="i">+        assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;c&quot;)).voted_for(None);
</a><a href="#h35-0-375" id="h35-0-375" class="i">+        assert_messages(
</a><a href="#h35-0-376" id="h35-0-376" class="i">+            &amp;rx,
</a><a href="#h35-0-377" id="h35-0-377" class="i">+            vec![Message {
</a><a href="#h35-0-378" id="h35-0-378" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-379" id="h35-0-379" class="i">+                to: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-380" id="h35-0-380" class="i">+                term: 4,
</a><a href="#h35-0-381" id="h35-0-381" class="i">+                event: Event::ConfirmLeader { commit_index: 3, has_committed: true },
</a><a href="#h35-0-382" id="h35-0-382" class="i">+            }],
</a><a href="#h35-0-383" id="h35-0-383" class="i">+        );
</a><a href="#h35-0-384" id="h35-0-384" class="i">+    }
</a><a href="#h35-0-385" id="h35-0-385" class="i">+
</a><a href="#h35-0-386" id="h35-0-386" class="i">+    #[test]
</a><a href="#h35-0-387" id="h35-0-387" class="i">+    // Heartbeat from past term
</a><a href="#h35-0-388" id="h35-0-388" class="i">+    fn step_heartbeat_past_term() {
</a><a href="#h35-0-389" id="h35-0-389" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-390" id="h35-0-390" class="i">+        let node = follower
</a><a href="#h35-0-391" id="h35-0-391" class="i">+            .step(Message {
</a><a href="#h35-0-392" id="h35-0-392" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-393" id="h35-0-393" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-394" id="h35-0-394" class="i">+                term: 2,
</a><a href="#h35-0-395" id="h35-0-395" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h35-0-396" id="h35-0-396" class="i">+            })
</a><a href="#h35-0-397" id="h35-0-397" class="i">+            .unwrap();
</a><a href="#h35-0-398" id="h35-0-398" class="i">+        assert_node(&amp;node)
</a><a href="#h35-0-399" id="h35-0-399" class="i">+            .is_follower()
</a><a href="#h35-0-400" id="h35-0-400" class="i">+            .term(3)
</a><a href="#h35-0-401" id="h35-0-401" class="i">+            .leader(Some(&quot;b&quot;))
</a><a href="#h35-0-402" id="h35-0-402" class="i">+            .voted_for(None)
</a><a href="#h35-0-403" id="h35-0-403" class="i">+            .committed(2)
</a><a href="#h35-0-404" id="h35-0-404" class="i">+            .applied(1);
</a><a href="#h35-0-405" id="h35-0-405" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-406" id="h35-0-406" class="i">+    }
</a><a href="#h35-0-407" id="h35-0-407" class="i">+
</a><a href="#h35-0-408" id="h35-0-408" class="i">+    #[test]
</a><a href="#h35-0-409" id="h35-0-409" class="i">+    // SolicitVote is granted for the first solicitor, otherwise ignored.
</a><a href="#h35-0-410" id="h35-0-410" class="i">+    fn step_solicitvote() {
</a><a href="#h35-0-411" id="h35-0-411" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-412" id="h35-0-412" class="i">+
</a><a href="#h35-0-413" id="h35-0-413" class="i">+        // The first vote request in this term yields a vote response.
</a><a href="#h35-0-414" id="h35-0-414" class="i">+        let mut node = follower
</a><a href="#h35-0-415" id="h35-0-415" class="i">+            .step(Message {
</a><a href="#h35-0-416" id="h35-0-416" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-417" id="h35-0-417" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-418" id="h35-0-418" class="i">+                term: 3,
</a><a href="#h35-0-419" id="h35-0-419" class="i">+                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h35-0-420" id="h35-0-420" class="i">+            })
</a><a href="#h35-0-421" id="h35-0-421" class="i">+            .unwrap();
</a><a href="#h35-0-422" id="h35-0-422" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
</a><a href="#h35-0-423" id="h35-0-423" class="i">+        assert_messages(
</a><a href="#h35-0-424" id="h35-0-424" class="i">+            &amp;rx,
</a><a href="#h35-0-425" id="h35-0-425" class="i">+            vec![Message {
</a><a href="#h35-0-426" id="h35-0-426" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-427" id="h35-0-427" class="i">+                to: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-428" id="h35-0-428" class="i">+                term: 3,
</a><a href="#h35-0-429" id="h35-0-429" class="i">+                event: Event::GrantVote,
</a><a href="#h35-0-430" id="h35-0-430" class="i">+            }],
</a><a href="#h35-0-431" id="h35-0-431" class="i">+        );
</a><a href="#h35-0-432" id="h35-0-432" class="i">+
</a><a href="#h35-0-433" id="h35-0-433" class="i">+        // Another vote request from the same sender is granted.
</a><a href="#h35-0-434" id="h35-0-434" class="i">+        node = node
</a><a href="#h35-0-435" id="h35-0-435" class="i">+            .step(Message {
</a><a href="#h35-0-436" id="h35-0-436" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-437" id="h35-0-437" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-438" id="h35-0-438" class="i">+                term: 3,
</a><a href="#h35-0-439" id="h35-0-439" class="i">+                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h35-0-440" id="h35-0-440" class="i">+            })
</a><a href="#h35-0-441" id="h35-0-441" class="i">+            .unwrap();
</a><a href="#h35-0-442" id="h35-0-442" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
</a><a href="#h35-0-443" id="h35-0-443" class="i">+        assert_messages(
</a><a href="#h35-0-444" id="h35-0-444" class="i">+            &amp;rx,
</a><a href="#h35-0-445" id="h35-0-445" class="i">+            vec![Message {
</a><a href="#h35-0-446" id="h35-0-446" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-447" id="h35-0-447" class="i">+                to: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-448" id="h35-0-448" class="i">+                term: 3,
</a><a href="#h35-0-449" id="h35-0-449" class="i">+                event: Event::GrantVote,
</a><a href="#h35-0-450" id="h35-0-450" class="i">+            }],
</a><a href="#h35-0-451" id="h35-0-451" class="i">+        );
</a><a href="#h35-0-452" id="h35-0-452" class="i">+
</a><a href="#h35-0-453" id="h35-0-453" class="i">+        // But a vote request from a different node is ignored.
</a><a href="#h35-0-454" id="h35-0-454" class="i">+        node = node
</a><a href="#h35-0-455" id="h35-0-455" class="i">+            .step(Message {
</a><a href="#h35-0-456" id="h35-0-456" class="i">+                from: Some(&quot;d&quot;.into()),
</a><a href="#h35-0-457" id="h35-0-457" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-458" id="h35-0-458" class="i">+                term: 3,
</a><a href="#h35-0-459" id="h35-0-459" class="i">+                event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h35-0-460" id="h35-0-460" class="i">+            })
</a><a href="#h35-0-461" id="h35-0-461" class="i">+            .unwrap();
</a><a href="#h35-0-462" id="h35-0-462" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
</a><a href="#h35-0-463" id="h35-0-463" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-464" id="h35-0-464" class="i">+    }
</a><a href="#h35-0-465" id="h35-0-465" class="i">+
</a><a href="#h35-0-466" id="h35-0-466" class="i">+    #[test]
</a><a href="#h35-0-467" id="h35-0-467" class="i">+    // GrantVote messages are ignored
</a><a href="#h35-0-468" id="h35-0-468" class="i">+    fn step_grantvote_noop() {
</a><a href="#h35-0-469" id="h35-0-469" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-470" id="h35-0-470" class="i">+        let node = follower
</a><a href="#h35-0-471" id="h35-0-471" class="i">+            .step(Message {
</a><a href="#h35-0-472" id="h35-0-472" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-473" id="h35-0-473" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-474" id="h35-0-474" class="i">+                term: 3,
</a><a href="#h35-0-475" id="h35-0-475" class="i">+                event: Event::GrantVote,
</a><a href="#h35-0-476" id="h35-0-476" class="i">+            })
</a><a href="#h35-0-477" id="h35-0-477" class="i">+            .unwrap();
</a><a href="#h35-0-478" id="h35-0-478" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
</a><a href="#h35-0-479" id="h35-0-479" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-480" id="h35-0-480" class="i">+    }
</a><a href="#h35-0-481" id="h35-0-481" class="i">+
</a><a href="#h35-0-482" id="h35-0-482" class="i">+    #[test]
</a><a href="#h35-0-483" id="h35-0-483" class="i">+    // SolicitVote is rejected if last_term is outdated.
</a><a href="#h35-0-484" id="h35-0-484" class="i">+    fn step_solicitvote_last_index_outdated() {
</a><a href="#h35-0-485" id="h35-0-485" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-486" id="h35-0-486" class="i">+        let node = follower
</a><a href="#h35-0-487" id="h35-0-487" class="i">+            .step(Message {
</a><a href="#h35-0-488" id="h35-0-488" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-489" id="h35-0-489" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-490" id="h35-0-490" class="i">+                term: 3,
</a><a href="#h35-0-491" id="h35-0-491" class="i">+                event: Event::SolicitVote { last_index: 2, last_term: 2 },
</a><a href="#h35-0-492" id="h35-0-492" class="i">+            })
</a><a href="#h35-0-493" id="h35-0-493" class="i">+            .unwrap();
</a><a href="#h35-0-494" id="h35-0-494" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
</a><a href="#h35-0-495" id="h35-0-495" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-496" id="h35-0-496" class="i">+    }
</a><a href="#h35-0-497" id="h35-0-497" class="i">+
</a><a href="#h35-0-498" id="h35-0-498" class="i">+    #[test]
</a><a href="#h35-0-499" id="h35-0-499" class="i">+    // SolicitVote is rejected if last_term is outdated.
</a><a href="#h35-0-500" id="h35-0-500" class="i">+    fn step_solicitvote_last_term_outdated() {
</a><a href="#h35-0-501" id="h35-0-501" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-502" id="h35-0-502" class="i">+        let node = follower
</a><a href="#h35-0-503" id="h35-0-503" class="i">+            .step(Message {
</a><a href="#h35-0-504" id="h35-0-504" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h35-0-505" id="h35-0-505" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-506" id="h35-0-506" class="i">+                term: 3,
</a><a href="#h35-0-507" id="h35-0-507" class="i">+                event: Event::SolicitVote { last_index: 3, last_term: 1 },
</a><a href="#h35-0-508" id="h35-0-508" class="i">+            })
</a><a href="#h35-0-509" id="h35-0-509" class="i">+            .unwrap();
</a><a href="#h35-0-510" id="h35-0-510" class="i">+        assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
</a><a href="#h35-0-511" id="h35-0-511" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h35-0-512" id="h35-0-512" class="i">+    }
</a><a href="#h35-0-513" id="h35-0-513" class="i">+
</a><a href="#h35-0-514" id="h35-0-514" class="i">+    #[test]
</a><a href="#h35-0-515" id="h35-0-515" class="i">+    // ReplicateEntries accepts some entries at base 0 without changes
</a><a href="#h35-0-516" id="h35-0-516" class="i">+    fn step_replicateentries_base0() {
</a><a href="#h35-0-517" id="h35-0-517" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-518" id="h35-0-518" class="i">+        let node = follower
</a><a href="#h35-0-519" id="h35-0-519" class="i">+            .step(Message {
</a><a href="#h35-0-520" id="h35-0-520" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-521" id="h35-0-521" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-522" id="h35-0-522" class="i">+                term: 3,
</a><a href="#h35-0-523" id="h35-0-523" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-524" id="h35-0-524" class="i">+                    base_index: 0,
</a><a href="#h35-0-525" id="h35-0-525" class="i">+                    base_term: 0,
</a><a href="#h35-0-526" id="h35-0-526" class="i">+                    entries: vec![
</a><a href="#h35-0-527" id="h35-0-527" class="i">+                        Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-528" id="h35-0-528" class="i">+                        Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-529" id="h35-0-529" class="i">+                    ],
</a><a href="#h35-0-530" id="h35-0-530" class="i">+                },
</a><a href="#h35-0-531" id="h35-0-531" class="i">+            })
</a><a href="#h35-0-532" id="h35-0-532" class="i">+            .unwrap();
</a><a href="#h35-0-533" id="h35-0-533" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-534" id="h35-0-534" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-535" id="h35-0-535" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-536" id="h35-0-536" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-537" id="h35-0-537" class="i">+        ]);
</a><a href="#h35-0-538" id="h35-0-538" class="i">+        assert_messages(
</a><a href="#h35-0-539" id="h35-0-539" class="i">+            &amp;rx,
</a><a href="#h35-0-540" id="h35-0-540" class="i">+            vec![Message {
</a><a href="#h35-0-541" id="h35-0-541" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-542" id="h35-0-542" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-543" id="h35-0-543" class="i">+                term: 3,
</a><a href="#h35-0-544" id="h35-0-544" class="i">+                event: Event::AcceptEntries { last_index: 3 },
</a><a href="#h35-0-545" id="h35-0-545" class="i">+            }],
</a><a href="#h35-0-546" id="h35-0-546" class="i">+        );
</a><a href="#h35-0-547" id="h35-0-547" class="i">+    }
</a><a href="#h35-0-548" id="h35-0-548" class="i">+
</a><a href="#h35-0-549" id="h35-0-549" class="i">+    #[test]
</a><a href="#h35-0-550" id="h35-0-550" class="i">+    // ReplicateEntries appends entries
</a><a href="#h35-0-551" id="h35-0-551" class="i">+    fn step_replicateentries_append() {
</a><a href="#h35-0-552" id="h35-0-552" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-553" id="h35-0-553" class="i">+        let node = follower
</a><a href="#h35-0-554" id="h35-0-554" class="i">+            .step(Message {
</a><a href="#h35-0-555" id="h35-0-555" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-556" id="h35-0-556" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-557" id="h35-0-557" class="i">+                term: 3,
</a><a href="#h35-0-558" id="h35-0-558" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-559" id="h35-0-559" class="i">+                    base_index: 3,
</a><a href="#h35-0-560" id="h35-0-560" class="i">+                    base_term: 2,
</a><a href="#h35-0-561" id="h35-0-561" class="i">+                    entries: vec![
</a><a href="#h35-0-562" id="h35-0-562" class="i">+                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-563" id="h35-0-563" class="i">+                        Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h35-0-564" id="h35-0-564" class="i">+                    ],
</a><a href="#h35-0-565" id="h35-0-565" class="i">+                },
</a><a href="#h35-0-566" id="h35-0-566" class="i">+            })
</a><a href="#h35-0-567" id="h35-0-567" class="i">+            .unwrap();
</a><a href="#h35-0-568" id="h35-0-568" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-569" id="h35-0-569" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-570" id="h35-0-570" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-571" id="h35-0-571" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-572" id="h35-0-572" class="i">+            Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-573" id="h35-0-573" class="i">+            Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h35-0-574" id="h35-0-574" class="i">+        ]);
</a><a href="#h35-0-575" id="h35-0-575" class="i">+        assert_messages(
</a><a href="#h35-0-576" id="h35-0-576" class="i">+            &amp;rx,
</a><a href="#h35-0-577" id="h35-0-577" class="i">+            vec![Message {
</a><a href="#h35-0-578" id="h35-0-578" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-579" id="h35-0-579" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-580" id="h35-0-580" class="i">+                term: 3,
</a><a href="#h35-0-581" id="h35-0-581" class="i">+                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h35-0-582" id="h35-0-582" class="i">+            }],
</a><a href="#h35-0-583" id="h35-0-583" class="i">+        );
</a><a href="#h35-0-584" id="h35-0-584" class="i">+    }
</a><a href="#h35-0-585" id="h35-0-585" class="i">+
</a><a href="#h35-0-586" id="h35-0-586" class="i">+    #[test]
</a><a href="#h35-0-587" id="h35-0-587" class="i">+    // ReplicateEntries accepts partially overlapping entries
</a><a href="#h35-0-588" id="h35-0-588" class="i">+    fn step_replicateentries_partial_overlap() {
</a><a href="#h35-0-589" id="h35-0-589" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-590" id="h35-0-590" class="i">+        let node = follower
</a><a href="#h35-0-591" id="h35-0-591" class="i">+            .step(Message {
</a><a href="#h35-0-592" id="h35-0-592" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-593" id="h35-0-593" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-594" id="h35-0-594" class="i">+                term: 3,
</a><a href="#h35-0-595" id="h35-0-595" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-596" id="h35-0-596" class="i">+                    base_index: 1,
</a><a href="#h35-0-597" id="h35-0-597" class="i">+                    base_term: 1,
</a><a href="#h35-0-598" id="h35-0-598" class="i">+                    entries: vec![
</a><a href="#h35-0-599" id="h35-0-599" class="i">+                        Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-600" id="h35-0-600" class="i">+                        Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-601" id="h35-0-601" class="i">+                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-602" id="h35-0-602" class="i">+                    ],
</a><a href="#h35-0-603" id="h35-0-603" class="i">+                },
</a><a href="#h35-0-604" id="h35-0-604" class="i">+            })
</a><a href="#h35-0-605" id="h35-0-605" class="i">+            .unwrap();
</a><a href="#h35-0-606" id="h35-0-606" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-607" id="h35-0-607" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-608" id="h35-0-608" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-609" id="h35-0-609" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-610" id="h35-0-610" class="i">+            Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-611" id="h35-0-611" class="i">+        ]);
</a><a href="#h35-0-612" id="h35-0-612" class="i">+        assert_messages(
</a><a href="#h35-0-613" id="h35-0-613" class="i">+            &amp;rx,
</a><a href="#h35-0-614" id="h35-0-614" class="i">+            vec![Message {
</a><a href="#h35-0-615" id="h35-0-615" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-616" id="h35-0-616" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-617" id="h35-0-617" class="i">+                term: 3,
</a><a href="#h35-0-618" id="h35-0-618" class="i">+                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h35-0-619" id="h35-0-619" class="i">+            }],
</a><a href="#h35-0-620" id="h35-0-620" class="i">+        );
</a><a href="#h35-0-621" id="h35-0-621" class="i">+    }
</a><a href="#h35-0-622" id="h35-0-622" class="i">+
</a><a href="#h35-0-623" id="h35-0-623" class="i">+    #[test]
</a><a href="#h35-0-624" id="h35-0-624" class="i">+    // ReplicateEntries replaces conflicting entries
</a><a href="#h35-0-625" id="h35-0-625" class="i">+    fn step_replicateentries_replace() {
</a><a href="#h35-0-626" id="h35-0-626" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-627" id="h35-0-627" class="i">+        let node = follower
</a><a href="#h35-0-628" id="h35-0-628" class="i">+            .step(Message {
</a><a href="#h35-0-629" id="h35-0-629" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-630" id="h35-0-630" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-631" id="h35-0-631" class="i">+                term: 3,
</a><a href="#h35-0-632" id="h35-0-632" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-633" id="h35-0-633" class="i">+                    base_index: 2,
</a><a href="#h35-0-634" id="h35-0-634" class="i">+                    base_term: 1,
</a><a href="#h35-0-635" id="h35-0-635" class="i">+                    entries: vec![
</a><a href="#h35-0-636" id="h35-0-636" class="i">+                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-637" id="h35-0-637" class="i">+                        Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h35-0-638" id="h35-0-638" class="i">+                    ],
</a><a href="#h35-0-639" id="h35-0-639" class="i">+                },
</a><a href="#h35-0-640" id="h35-0-640" class="i">+            })
</a><a href="#h35-0-641" id="h35-0-641" class="i">+            .unwrap();
</a><a href="#h35-0-642" id="h35-0-642" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-643" id="h35-0-643" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-644" id="h35-0-644" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-645" id="h35-0-645" class="i">+            Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-646" id="h35-0-646" class="i">+            Entry { term: 3, command: Some(vec![0x05]) },
</a><a href="#h35-0-647" id="h35-0-647" class="i">+        ]);
</a><a href="#h35-0-648" id="h35-0-648" class="i">+        assert_messages(
</a><a href="#h35-0-649" id="h35-0-649" class="i">+            &amp;rx,
</a><a href="#h35-0-650" id="h35-0-650" class="i">+            vec![Message {
</a><a href="#h35-0-651" id="h35-0-651" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-652" id="h35-0-652" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-653" id="h35-0-653" class="i">+                term: 3,
</a><a href="#h35-0-654" id="h35-0-654" class="i">+                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h35-0-655" id="h35-0-655" class="i">+            }],
</a><a href="#h35-0-656" id="h35-0-656" class="i">+        );
</a><a href="#h35-0-657" id="h35-0-657" class="i">+    }
</a><a href="#h35-0-658" id="h35-0-658" class="i">+
</a><a href="#h35-0-659" id="h35-0-659" class="i">+    #[test]
</a><a href="#h35-0-660" id="h35-0-660" class="i">+    // ReplicateEntries replaces partially conflicting entries
</a><a href="#h35-0-661" id="h35-0-661" class="i">+    fn step_replicateentries_replace_partial() {
</a><a href="#h35-0-662" id="h35-0-662" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-663" id="h35-0-663" class="i">+        let node = follower
</a><a href="#h35-0-664" id="h35-0-664" class="i">+            .step(Message {
</a><a href="#h35-0-665" id="h35-0-665" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-666" id="h35-0-666" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-667" id="h35-0-667" class="i">+                term: 3,
</a><a href="#h35-0-668" id="h35-0-668" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-669" id="h35-0-669" class="i">+                    base_index: 2,
</a><a href="#h35-0-670" id="h35-0-670" class="i">+                    base_term: 1,
</a><a href="#h35-0-671" id="h35-0-671" class="i">+                    entries: vec![
</a><a href="#h35-0-672" id="h35-0-672" class="i">+                        Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-673" id="h35-0-673" class="i">+                        Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-674" id="h35-0-674" class="i">+                    ],
</a><a href="#h35-0-675" id="h35-0-675" class="i">+                },
</a><a href="#h35-0-676" id="h35-0-676" class="i">+            })
</a><a href="#h35-0-677" id="h35-0-677" class="i">+            .unwrap();
</a><a href="#h35-0-678" id="h35-0-678" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-679" id="h35-0-679" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-680" id="h35-0-680" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-681" id="h35-0-681" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-682" id="h35-0-682" class="i">+            Entry { term: 3, command: Some(vec![0x04]) },
</a><a href="#h35-0-683" id="h35-0-683" class="i">+        ]);
</a><a href="#h35-0-684" id="h35-0-684" class="i">+        assert_messages(
</a><a href="#h35-0-685" id="h35-0-685" class="i">+            &amp;rx,
</a><a href="#h35-0-686" id="h35-0-686" class="i">+            vec![Message {
</a><a href="#h35-0-687" id="h35-0-687" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-688" id="h35-0-688" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-689" id="h35-0-689" class="i">+                term: 3,
</a><a href="#h35-0-690" id="h35-0-690" class="i">+                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h35-0-691" id="h35-0-691" class="i">+            }],
</a><a href="#h35-0-692" id="h35-0-692" class="i">+        );
</a><a href="#h35-0-693" id="h35-0-693" class="i">+    }
</a><a href="#h35-0-694" id="h35-0-694" class="i">+
</a><a href="#h35-0-695" id="h35-0-695" class="i">+    #[test]
</a><a href="#h35-0-696" id="h35-0-696" class="i">+    // ReplicateEntries rejects missing base index
</a><a href="#h35-0-697" id="h35-0-697" class="i">+    fn step_replicateentries_reject_missing_base_index() {
</a><a href="#h35-0-698" id="h35-0-698" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-699" id="h35-0-699" class="i">+        let node = follower
</a><a href="#h35-0-700" id="h35-0-700" class="i">+            .step(Message {
</a><a href="#h35-0-701" id="h35-0-701" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-702" id="h35-0-702" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-703" id="h35-0-703" class="i">+                term: 3,
</a><a href="#h35-0-704" id="h35-0-704" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-705" id="h35-0-705" class="i">+                    base_index: 5,
</a><a href="#h35-0-706" id="h35-0-706" class="i">+                    base_term: 2,
</a><a href="#h35-0-707" id="h35-0-707" class="i">+                    entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h35-0-708" id="h35-0-708" class="i">+                },
</a><a href="#h35-0-709" id="h35-0-709" class="i">+            })
</a><a href="#h35-0-710" id="h35-0-710" class="i">+            .unwrap();
</a><a href="#h35-0-711" id="h35-0-711" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-712" id="h35-0-712" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-713" id="h35-0-713" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-714" id="h35-0-714" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-715" id="h35-0-715" class="i">+        ]);
</a><a href="#h35-0-716" id="h35-0-716" class="i">+        assert_messages(
</a><a href="#h35-0-717" id="h35-0-717" class="i">+            &amp;rx,
</a><a href="#h35-0-718" id="h35-0-718" class="i">+            vec![Message {
</a><a href="#h35-0-719" id="h35-0-719" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-720" id="h35-0-720" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-721" id="h35-0-721" class="i">+                term: 3,
</a><a href="#h35-0-722" id="h35-0-722" class="i">+                event: Event::RejectEntries,
</a><a href="#h35-0-723" id="h35-0-723" class="i">+            }],
</a><a href="#h35-0-724" id="h35-0-724" class="i">+        );
</a><a href="#h35-0-725" id="h35-0-725" class="i">+    }
</a><a href="#h35-0-726" id="h35-0-726" class="i">+
</a><a href="#h35-0-727" id="h35-0-727" class="i">+    #[test]
</a><a href="#h35-0-728" id="h35-0-728" class="i">+    // ReplicateEntries rejects conflicting base term
</a><a href="#h35-0-729" id="h35-0-729" class="i">+    fn step_replicateentries_reject_missing_base_term() {
</a><a href="#h35-0-730" id="h35-0-730" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-731" id="h35-0-731" class="i">+        let node = follower
</a><a href="#h35-0-732" id="h35-0-732" class="i">+            .step(Message {
</a><a href="#h35-0-733" id="h35-0-733" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-734" id="h35-0-734" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-735" id="h35-0-735" class="i">+                term: 3,
</a><a href="#h35-0-736" id="h35-0-736" class="i">+                event: Event::ReplicateEntries {
</a><a href="#h35-0-737" id="h35-0-737" class="i">+                    base_index: 1,
</a><a href="#h35-0-738" id="h35-0-738" class="i">+                    base_term: 2,
</a><a href="#h35-0-739" id="h35-0-739" class="i">+                    entries: vec![Entry { term: 3, command: Some(vec![0x04]) }],
</a><a href="#h35-0-740" id="h35-0-740" class="i">+                },
</a><a href="#h35-0-741" id="h35-0-741" class="i">+            })
</a><a href="#h35-0-742" id="h35-0-742" class="i">+            .unwrap();
</a><a href="#h35-0-743" id="h35-0-743" class="i">+        assert_node(&amp;node).is_follower().term(3).entries(vec![
</a><a href="#h35-0-744" id="h35-0-744" class="i">+            Entry { term: 1, command: Some(vec![0x01]) },
</a><a href="#h35-0-745" id="h35-0-745" class="i">+            Entry { term: 1, command: Some(vec![0x02]) },
</a><a href="#h35-0-746" id="h35-0-746" class="i">+            Entry { term: 2, command: Some(vec![0x03]) },
</a><a href="#h35-0-747" id="h35-0-747" class="i">+        ]);
</a><a href="#h35-0-748" id="h35-0-748" class="i">+        assert_messages(
</a><a href="#h35-0-749" id="h35-0-749" class="i">+            &amp;rx,
</a><a href="#h35-0-750" id="h35-0-750" class="i">+            vec![Message {
</a><a href="#h35-0-751" id="h35-0-751" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-752" id="h35-0-752" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-753" id="h35-0-753" class="i">+                term: 3,
</a><a href="#h35-0-754" id="h35-0-754" class="i">+                event: Event::RejectEntries,
</a><a href="#h35-0-755" id="h35-0-755" class="i">+            }],
</a><a href="#h35-0-756" id="h35-0-756" class="i">+        );
</a><a href="#h35-0-757" id="h35-0-757" class="i">+    }
</a><a href="#h35-0-758" id="h35-0-758" class="i">+
</a><a href="#h35-0-759" id="h35-0-759" class="i">+    #[test]
</a><a href="#h35-0-760" id="h35-0-760" class="i">+    // ReadState and MutateState are proxied, as are the responses
</a><a href="#h35-0-761" id="h35-0-761" class="i">+    fn step_readstate_mutatestate_respond() {
</a><a href="#h35-0-762" id="h35-0-762" class="i">+        let calls = vec![
</a><a href="#h35-0-763" id="h35-0-763" class="i">+            Event::MutateState { call_id: vec![0x02], command: vec![0x02] },
</a><a href="#h35-0-764" id="h35-0-764" class="i">+            Event::ReadState { call_id: vec![0x01], command: vec![0x01] },
</a><a href="#h35-0-765" id="h35-0-765" class="i">+        ];
</a><a href="#h35-0-766" id="h35-0-766" class="i">+        let responses = vec![
</a><a href="#h35-0-767" id="h35-0-767" class="i">+            Event::RespondError { call_id: vec![], error: &quot;b00m&quot;.into() },
</a><a href="#h35-0-768" id="h35-0-768" class="i">+            Event::RespondState { call_id: vec![], response: vec![0xaf] },
</a><a href="#h35-0-769" id="h35-0-769" class="i">+        ];
</a><a href="#h35-0-770" id="h35-0-770" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-771" id="h35-0-771" class="i">+        let mut node = Node::Follower(follower);
</a><a href="#h35-0-772" id="h35-0-772" class="i">+        for call in calls.into_iter() {
</a><a href="#h35-0-773" id="h35-0-773" class="i">+            for mut response in responses.clone().into_iter() {
</a><a href="#h35-0-774" id="h35-0-774" class="i">+                node = node
</a><a href="#h35-0-775" id="h35-0-775" class="i">+                    .step(Message { from: None, to: None, term: 0, event: call.clone() })
</a><a href="#h35-0-776" id="h35-0-776" class="i">+                    .unwrap();
</a><a href="#h35-0-777" id="h35-0-777" class="i">+                assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
</a><a href="#h35-0-778" id="h35-0-778" class="i">+                assert_messages(
</a><a href="#h35-0-779" id="h35-0-779" class="i">+                    &amp;rx,
</a><a href="#h35-0-780" id="h35-0-780" class="i">+                    vec![Message {
</a><a href="#h35-0-781" id="h35-0-781" class="i">+                        from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-782" id="h35-0-782" class="i">+                        to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-783" id="h35-0-783" class="i">+                        term: 3,
</a><a href="#h35-0-784" id="h35-0-784" class="i">+                        event: call.clone(),
</a><a href="#h35-0-785" id="h35-0-785" class="i">+                    }],
</a><a href="#h35-0-786" id="h35-0-786" class="i">+                );
</a><a href="#h35-0-787" id="h35-0-787" class="i">+                match response {
</a><a href="#h35-0-788" id="h35-0-788" class="i">+                    Event::RespondError { ref mut call_id, .. }
</a><a href="#h35-0-789" id="h35-0-789" class="i">+                    | Event::RespondState { ref mut call_id, .. } =&gt; {
</a><a href="#h35-0-790" id="h35-0-790" class="i">+                        *call_id = call.call_id().unwrap()
</a><a href="#h35-0-791" id="h35-0-791" class="i">+                    }
</a><a href="#h35-0-792" id="h35-0-792" class="i">+                    _ =&gt; {}
</a><a href="#h35-0-793" id="h35-0-793" class="i">+                }
</a><a href="#h35-0-794" id="h35-0-794" class="i">+                // Multiple responses should only be proxied once.
</a><a href="#h35-0-795" id="h35-0-795" class="i">+                for _ in 0..3 {
</a><a href="#h35-0-796" id="h35-0-796" class="i">+                    node = node
</a><a href="#h35-0-797" id="h35-0-797" class="i">+                        .step(Message {
</a><a href="#h35-0-798" id="h35-0-798" class="i">+                            from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-799" id="h35-0-799" class="i">+                            to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-800" id="h35-0-800" class="i">+                            term: 3,
</a><a href="#h35-0-801" id="h35-0-801" class="i">+                            event: response.clone(),
</a><a href="#h35-0-802" id="h35-0-802" class="i">+                        })
</a><a href="#h35-0-803" id="h35-0-803" class="i">+                        .unwrap();
</a><a href="#h35-0-804" id="h35-0-804" class="i">+                }
</a><a href="#h35-0-805" id="h35-0-805" class="i">+                assert_messages(
</a><a href="#h35-0-806" id="h35-0-806" class="i">+                    &amp;rx,
</a><a href="#h35-0-807" id="h35-0-807" class="i">+                    vec![Message { from: Some(&quot;a&quot;.into()), to: None, term: 3, event: response }],
</a><a href="#h35-0-808" id="h35-0-808" class="i">+                );
</a><a href="#h35-0-809" id="h35-0-809" class="i">+            }
</a><a href="#h35-0-810" id="h35-0-810" class="i">+        }
</a><a href="#h35-0-811" id="h35-0-811" class="i">+    }
</a><a href="#h35-0-812" id="h35-0-812" class="i">+
</a><a href="#h35-0-813" id="h35-0-813" class="i">+    #[test]
</a><a href="#h35-0-814" id="h35-0-814" class="i">+    fn tick() {
</a><a href="#h35-0-815" id="h35-0-815" class="i">+        let (follower, rx) = setup();
</a><a href="#h35-0-816" id="h35-0-816" class="i">+        let timeout = follower.role.leader_seen_timeout;
</a><a href="#h35-0-817" id="h35-0-817" class="i">+        let peers = follower.peers.clone();
</a><a href="#h35-0-818" id="h35-0-818" class="i">+        let mut node = Node::Follower(follower);
</a><a href="#h35-0-819" id="h35-0-819" class="i">+
</a><a href="#h35-0-820" id="h35-0-820" class="i">+        // Make sure heartbeats reset election timeout
</a><a href="#h35-0-821" id="h35-0-821" class="i">+        assert!(timeout &gt; 0);
</a><a href="#h35-0-822" id="h35-0-822" class="i">+        for i in 0..(3 * timeout) {
</a><a href="#h35-0-823" id="h35-0-823" class="i">+            let applied = if i &gt; 0 { 2 } else { 1 };
</a><a href="#h35-0-824" id="h35-0-824" class="i">+            assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).applied(applied);
</a><a href="#h35-0-825" id="h35-0-825" class="i">+            node = node.tick().unwrap();
</a><a href="#h35-0-826" id="h35-0-826" class="i">+            node = node
</a><a href="#h35-0-827" id="h35-0-827" class="i">+                .step(Message {
</a><a href="#h35-0-828" id="h35-0-828" class="i">+                    from: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-829" id="h35-0-829" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-830" id="h35-0-830" class="i">+                    term: 3,
</a><a href="#h35-0-831" id="h35-0-831" class="i">+                    event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
</a><a href="#h35-0-832" id="h35-0-832" class="i">+                })
</a><a href="#h35-0-833" id="h35-0-833" class="i">+                .unwrap();
</a><a href="#h35-0-834" id="h35-0-834" class="i">+            assert_messages(
</a><a href="#h35-0-835" id="h35-0-835" class="i">+                &amp;rx,
</a><a href="#h35-0-836" id="h35-0-836" class="i">+                vec![Message {
</a><a href="#h35-0-837" id="h35-0-837" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-838" id="h35-0-838" class="i">+                    to: Some(&quot;b&quot;.into()),
</a><a href="#h35-0-839" id="h35-0-839" class="i">+                    term: 3,
</a><a href="#h35-0-840" id="h35-0-840" class="i">+                    event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
</a><a href="#h35-0-841" id="h35-0-841" class="i">+                }],
</a><a href="#h35-0-842" id="h35-0-842" class="i">+            )
</a><a href="#h35-0-843" id="h35-0-843" class="i">+        }
</a><a href="#h35-0-844" id="h35-0-844" class="i">+
</a><a href="#h35-0-845" id="h35-0-845" class="i">+        for _ in 0..timeout {
</a><a href="#h35-0-846" id="h35-0-846" class="i">+            assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
</a><a href="#h35-0-847" id="h35-0-847" class="i">+            node = node.tick().unwrap();
</a><a href="#h35-0-848" id="h35-0-848" class="i">+        }
</a><a href="#h35-0-849" id="h35-0-849" class="i">+        assert_node(&amp;node).is_candidate().term(4);
</a><a href="#h35-0-850" id="h35-0-850" class="i">+
</a><a href="#h35-0-851" id="h35-0-851" class="i">+        for to in peers.into_iter() {
</a><a href="#h35-0-852" id="h35-0-852" class="i">+            assert!(!rx.is_empty());
</a><a href="#h35-0-853" id="h35-0-853" class="i">+            assert_eq!(
</a><a href="#h35-0-854" id="h35-0-854" class="i">+                rx.recv().unwrap(),
</a><a href="#h35-0-855" id="h35-0-855" class="i">+                Message {
</a><a href="#h35-0-856" id="h35-0-856" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h35-0-857" id="h35-0-857" class="i">+                    to: Some(to),
</a><a href="#h35-0-858" id="h35-0-858" class="i">+                    term: 4,
</a><a href="#h35-0-859" id="h35-0-859" class="i">+                    event: Event::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h35-0-860" id="h35-0-860" class="i">+                }
</a><a href="#h35-0-861" id="h35-0-861" class="i">+            )
</a><a href="#h35-0-862" id="h35-0-862" class="i">+        }
</a><a href="#h35-0-863" id="h35-0-863" class="i">+    }
</a><a href="#h35-0-864" id="h35-0-864" class="i">+}
</a><b>diff --git a/<a id="h36" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -0,0 +1,877 @@
</a><a href="#h36-0-0" id="h36-0-0" class="i">+use super::*;
</a><a href="#h36-0-1" id="h36-0-1" class="i">+use std::collections::{HashMap, HashSet};
</a><a href="#h36-0-2" id="h36-0-2" class="i">+
</a><a href="#h36-0-3" id="h36-0-3" class="i">+// A leader serves requests and replicates the log to followers.
</a><a href="#h36-0-4" id="h36-0-4" class="i">+#[derive(Debug)]
</a><a href="#h36-0-5" id="h36-0-5" class="i">+pub struct Leader {
</a><a href="#h36-0-6" id="h36-0-6" class="i">+    /// Number of ticks since last heartbeat.
</a><a href="#h36-0-7" id="h36-0-7" class="i">+    heartbeat_ticks: u64,
</a><a href="#h36-0-8" id="h36-0-8" class="i">+    /// The next index to replicate to a peer.
</a><a href="#h36-0-9" id="h36-0-9" class="i">+    peer_next_index: HashMap&lt;String, u64&gt;,
</a><a href="#h36-0-10" id="h36-0-10" class="i">+    /// The last index known to be replicated on a peer.
</a><a href="#h36-0-11" id="h36-0-11" class="i">+    peer_last_index: HashMap&lt;String, u64&gt;,
</a><a href="#h36-0-12" id="h36-0-12" class="i">+    /// Any client calls being processed.
</a><a href="#h36-0-13" id="h36-0-13" class="i">+    calls: Calls,
</a><a href="#h36-0-14" id="h36-0-14" class="i">+}
</a><a href="#h36-0-15" id="h36-0-15" class="i">+
</a><a href="#h36-0-16" id="h36-0-16" class="i">+impl Leader {
</a><a href="#h36-0-17" id="h36-0-17" class="i">+    /// Creates a new leader role.
</a><a href="#h36-0-18" id="h36-0-18" class="i">+    pub fn new(peers: Vec&lt;String&gt;, last_index: u64) -&gt; Self {
</a><a href="#h36-0-19" id="h36-0-19" class="i">+        let mut leader = Self {
</a><a href="#h36-0-20" id="h36-0-20" class="i">+            heartbeat_ticks: 0,
</a><a href="#h36-0-21" id="h36-0-21" class="i">+            peer_next_index: HashMap::new(),
</a><a href="#h36-0-22" id="h36-0-22" class="i">+            peer_last_index: HashMap::new(),
</a><a href="#h36-0-23" id="h36-0-23" class="i">+            calls: Calls::new(),
</a><a href="#h36-0-24" id="h36-0-24" class="i">+        };
</a><a href="#h36-0-25" id="h36-0-25" class="i">+        for peer in peers {
</a><a href="#h36-0-26" id="h36-0-26" class="i">+            leader.peer_next_index.insert(peer.clone(), last_index + 1);
</a><a href="#h36-0-27" id="h36-0-27" class="i">+            leader.peer_last_index.insert(peer.clone(), 0);
</a><a href="#h36-0-28" id="h36-0-28" class="i">+        }
</a><a href="#h36-0-29" id="h36-0-29" class="i">+        leader
</a><a href="#h36-0-30" id="h36-0-30" class="i">+    }
</a><a href="#h36-0-31" id="h36-0-31" class="i">+}
</a><a href="#h36-0-32" id="h36-0-32" class="i">+
</a><a href="#h36-0-33" id="h36-0-33" class="i">+impl RoleNode&lt;Leader&gt; {
</a><a href="#h36-0-34" id="h36-0-34" class="i">+    /// Transforms the leader into a follower
</a><a href="#h36-0-35" id="h36-0-35" class="i">+    fn become_follower(mut self, term: u64, leader: &amp;str) -&gt; Result&lt;RoleNode&lt;Follower&gt;, Error&gt; {
</a><a href="#h36-0-36" id="h36-0-36" class="i">+        info!(&quot;Discovered new leader {} for term {}, following&quot;, leader, term);
</a><a href="#h36-0-37" id="h36-0-37" class="i">+        self.save_term(term, None)?;
</a><a href="#h36-0-38" id="h36-0-38" class="i">+        self.become_role(Follower::new(Some(leader), None))
</a><a href="#h36-0-39" id="h36-0-39" class="i">+    }
</a><a href="#h36-0-40" id="h36-0-40" class="i">+
</a><a href="#h36-0-41" id="h36-0-41" class="i">+    /// Appends an entry to the log and replicates it to peers.
</a><a href="#h36-0-42" id="h36-0-42" class="i">+    pub fn append(&amp;mut self, command: Option&lt;Vec&lt;u8&gt;&gt;) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h36-0-43" id="h36-0-43" class="i">+        let index = self.log.append(Entry { term: self.term, command })?;
</a><a href="#h36-0-44" id="h36-0-44" class="i">+        for peer in self.peers.iter() {
</a><a href="#h36-0-45" id="h36-0-45" class="i">+            self.replicate(peer)?;
</a><a href="#h36-0-46" id="h36-0-46" class="i">+        }
</a><a href="#h36-0-47" id="h36-0-47" class="i">+        Ok(index)
</a><a href="#h36-0-48" id="h36-0-48" class="i">+    }
</a><a href="#h36-0-49" id="h36-0-49" class="i">+
</a><a href="#h36-0-50" id="h36-0-50" class="i">+    /// Applies any pending log entries.
</a><a href="#h36-0-51" id="h36-0-51" class="i">+    fn apply(&amp;mut self) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h36-0-52" id="h36-0-52" class="i">+        let (mut index, _) = self.log.get_applied();
</a><a href="#h36-0-53" id="h36-0-53" class="i">+        while let Some((i, output)) = self.log.apply(&amp;mut self.state)? {
</a><a href="#h36-0-54" id="h36-0-54" class="i">+            index = i;
</a><a href="#h36-0-55" id="h36-0-55" class="i">+            if let Some(call) = self.role.calls.log_applied(index) {
</a><a href="#h36-0-56" id="h36-0-56" class="i">+                self.send(
</a><a href="#h36-0-57" id="h36-0-57" class="i">+                    call.from.as_deref(),
</a><a href="#h36-0-58" id="h36-0-58" class="i">+                    Event::RespondState { call_id: call.id, response: output },
</a><a href="#h36-0-59" id="h36-0-59" class="i">+                )?
</a><a href="#h36-0-60" id="h36-0-60" class="i">+            }
</a><a href="#h36-0-61" id="h36-0-61" class="i">+        }
</a><a href="#h36-0-62" id="h36-0-62" class="i">+        Ok(index)
</a><a href="#h36-0-63" id="h36-0-63" class="i">+    }
</a><a href="#h36-0-64" id="h36-0-64" class="i">+
</a><a href="#h36-0-65" id="h36-0-65" class="i">+    /// Commits any pending log entries.
</a><a href="#h36-0-66" id="h36-0-66" class="i">+    fn commit(&amp;mut self) -&gt; Result&lt;u64, Error&gt; {
</a><a href="#h36-0-67" id="h36-0-67" class="i">+        let (last_index, _) = self.log.get_last();
</a><a href="#h36-0-68" id="h36-0-68" class="i">+        let (commit_index, _) = self.log.get_committed();
</a><a href="#h36-0-69" id="h36-0-69" class="i">+        let mut last_indexes = vec![last_index];
</a><a href="#h36-0-70" id="h36-0-70" class="i">+        last_indexes.extend(self.role.peer_last_index.values());
</a><a href="#h36-0-71" id="h36-0-71" class="i">+        last_indexes.sort();
</a><a href="#h36-0-72" id="h36-0-72" class="i">+        last_indexes.reverse();
</a><a href="#h36-0-73" id="h36-0-73" class="i">+        let quorum_index = last_indexes[self.quorum() as usize - 1];
</a><a href="#h36-0-74" id="h36-0-74" class="i">+        if quorum_index &lt; commit_index {
</a><a href="#h36-0-75" id="h36-0-75" class="i">+            return Ok(commit_index);
</a><a href="#h36-0-76" id="h36-0-76" class="i">+        }
</a><a href="#h36-0-77" id="h36-0-77" class="i">+        // We can only safely commit up to an entry from our own term, see
</a><a href="#h36-0-78" id="h36-0-78" class="i">+        // figure 8 in Raft paper for background.
</a><a href="#h36-0-79" id="h36-0-79" class="i">+        match self.log.get(quorum_index)? {
</a><a href="#h36-0-80" id="h36-0-80" class="i">+            Some(ref entry) if entry.term == self.term =&gt; self.log.commit(quorum_index),
</a><a href="#h36-0-81" id="h36-0-81" class="i">+            _ =&gt; Ok(commit_index),
</a><a href="#h36-0-82" id="h36-0-82" class="i">+        }
</a><a href="#h36-0-83" id="h36-0-83" class="i">+    }
</a><a href="#h36-0-84" id="h36-0-84" class="i">+
</a><a href="#h36-0-85" id="h36-0-85" class="i">+    /// Replicates the log to a peer.
</a><a href="#h36-0-86" id="h36-0-86" class="i">+    fn replicate(&amp;self, peer: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h36-0-87" id="h36-0-87" class="i">+        let peer_next = self
</a><a href="#h36-0-88" id="h36-0-88" class="i">+            .role
</a><a href="#h36-0-89" id="h36-0-89" class="i">+            .peer_next_index
</a><a href="#h36-0-90" id="h36-0-90" class="i">+            .get(peer)
</a><a href="#h36-0-91" id="h36-0-91" class="i">+            .cloned()
</a><a href="#h36-0-92" id="h36-0-92" class="i">+            .ok_or_else(|| Error::Internal(format!(&quot;Unknown peer {}&quot;, peer)))?;
</a><a href="#h36-0-93" id="h36-0-93" class="i">+        let base_index = if peer_next &gt; 0 { peer_next - 1 } else { 0 };
</a><a href="#h36-0-94" id="h36-0-94" class="i">+        let base_term = match self.log.get(base_index)? {
</a><a href="#h36-0-95" id="h36-0-95" class="i">+            Some(base) =&gt; base.term,
</a><a href="#h36-0-96" id="h36-0-96" class="i">+            None if base_index == 0 =&gt; 0,
</a><a href="#h36-0-97" id="h36-0-97" class="i">+            None =&gt; return Err(Error::Internal(format!(&quot;Missing base entry {}&quot;, base_index))),
</a><a href="#h36-0-98" id="h36-0-98" class="i">+        };
</a><a href="#h36-0-99" id="h36-0-99" class="i">+        let entries = self.log.range(peer_next..)?;
</a><a href="#h36-0-100" id="h36-0-100" class="i">+        debug!(&quot;Replicating {} entries at base {} to {}&quot;, entries.len(), base_index, peer);
</a><a href="#h36-0-101" id="h36-0-101" class="i">+        self.send(Some(peer), Event::ReplicateEntries { base_index, base_term, entries })?;
</a><a href="#h36-0-102" id="h36-0-102" class="i">+        Ok(())
</a><a href="#h36-0-103" id="h36-0-103" class="i">+    }
</a><a href="#h36-0-104" id="h36-0-104" class="i">+
</a><a href="#h36-0-105" id="h36-0-105" class="i">+    /// Registers a vote for quorum-based client calls.
</a><a href="#h36-0-106" id="h36-0-106" class="i">+    fn vote_call(&amp;mut self, from: &amp;str, commit_index: u64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h36-0-107" id="h36-0-107" class="i">+        for call in self.role.calls.quorum_vote(from, commit_index) {
</a><a href="#h36-0-108" id="h36-0-108" class="i">+            match call.operation {
</a><a href="#h36-0-109" id="h36-0-109" class="i">+                Operation::ReadState { command, .. } =&gt; self.send(
</a><a href="#h36-0-110" id="h36-0-110" class="i">+                    call.from.as_deref(),
</a><a href="#h36-0-111" id="h36-0-111" class="i">+                    Event::RespondState { call_id: call.id, response: self.state.read(command)? },
</a><a href="#h36-0-112" id="h36-0-112" class="i">+                )?,
</a><a href="#h36-0-113" id="h36-0-113" class="i">+                _ =&gt; return Err(Error::Network(format!(&quot;Unsupported call {:?}&quot;, call))),
</a><a href="#h36-0-114" id="h36-0-114" class="i">+            }
</a><a href="#h36-0-115" id="h36-0-115" class="i">+        }
</a><a href="#h36-0-116" id="h36-0-116" class="i">+        Ok(())
</a><a href="#h36-0-117" id="h36-0-117" class="i">+    }
</a><a href="#h36-0-118" id="h36-0-118" class="i">+
</a><a href="#h36-0-119" id="h36-0-119" class="i">+    /// Processes a message.
</a><a href="#h36-0-120" id="h36-0-120" class="i">+    pub fn step(mut self, mut msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h36-0-121" id="h36-0-121" class="i">+        if !self.normalize_message(&amp;mut msg) {
</a><a href="#h36-0-122" id="h36-0-122" class="i">+            return Ok(self.into());
</a><a href="#h36-0-123" id="h36-0-123" class="i">+        }
</a><a href="#h36-0-124" id="h36-0-124" class="i">+        if msg.term &gt; self.term {
</a><a href="#h36-0-125" id="h36-0-125" class="i">+            if let Some(from) = &amp;msg.from {
</a><a href="#h36-0-126" id="h36-0-126" class="i">+                return self.become_follower(msg.term, from)?.step(msg);
</a><a href="#h36-0-127" id="h36-0-127" class="i">+            }
</a><a href="#h36-0-128" id="h36-0-128" class="i">+        }
</a><a href="#h36-0-129" id="h36-0-129" class="i">+
</a><a href="#h36-0-130" id="h36-0-130" class="i">+        match msg.event {
</a><a href="#h36-0-131" id="h36-0-131" class="i">+            Event::ConfirmLeader { commit_index, has_committed } =&gt; {
</a><a href="#h36-0-132" id="h36-0-132" class="i">+                if let Some(from) = &amp;msg.from {
</a><a href="#h36-0-133" id="h36-0-133" class="i">+                    self.vote_call(from, commit_index)?;
</a><a href="#h36-0-134" id="h36-0-134" class="i">+                    if !has_committed {
</a><a href="#h36-0-135" id="h36-0-135" class="i">+                        self.replicate(from)?;
</a><a href="#h36-0-136" id="h36-0-136" class="i">+                    }
</a><a href="#h36-0-137" id="h36-0-137" class="i">+                }
</a><a href="#h36-0-138" id="h36-0-138" class="i">+            }
</a><a href="#h36-0-139" id="h36-0-139" class="i">+            Event::AcceptEntries { last_index } =&gt; {
</a><a href="#h36-0-140" id="h36-0-140" class="i">+                if let Some(from) = msg.from {
</a><a href="#h36-0-141" id="h36-0-141" class="i">+                    self.role.peer_last_index.insert(from.clone(), last_index);
</a><a href="#h36-0-142" id="h36-0-142" class="i">+                    self.role.peer_next_index.insert(from.clone(), last_index + 1);
</a><a href="#h36-0-143" id="h36-0-143" class="i">+                }
</a><a href="#h36-0-144" id="h36-0-144" class="i">+                self.commit()?;
</a><a href="#h36-0-145" id="h36-0-145" class="i">+                self.apply()?;
</a><a href="#h36-0-146" id="h36-0-146" class="i">+            }
</a><a href="#h36-0-147" id="h36-0-147" class="i">+            Event::RejectEntries =&gt; {
</a><a href="#h36-0-148" id="h36-0-148" class="i">+                if let Some(from) = msg.from {
</a><a href="#h36-0-149" id="h36-0-149" class="i">+                    self.role.peer_next_index.entry(from.clone()).and_modify(|i| {
</a><a href="#h36-0-150" id="h36-0-150" class="i">+                        if *i &gt; 1 {
</a><a href="#h36-0-151" id="h36-0-151" class="i">+                            *i -= 1
</a><a href="#h36-0-152" id="h36-0-152" class="i">+                        }
</a><a href="#h36-0-153" id="h36-0-153" class="i">+                    });
</a><a href="#h36-0-154" id="h36-0-154" class="i">+                    self.replicate(&amp;from)?;
</a><a href="#h36-0-155" id="h36-0-155" class="i">+                }
</a><a href="#h36-0-156" id="h36-0-156" class="i">+            }
</a><a href="#h36-0-157" id="h36-0-157" class="i">+            Event::ReadState { call_id, command } =&gt; {
</a><a href="#h36-0-158" id="h36-0-158" class="i">+                let (commit_index, commit_term) = self.log.get_committed();
</a><a href="#h36-0-159" id="h36-0-159" class="i">+                self.role.calls.register(Call {
</a><a href="#h36-0-160" id="h36-0-160" class="i">+                    id: call_id,
</a><a href="#h36-0-161" id="h36-0-161" class="i">+                    from: msg.from,
</a><a href="#h36-0-162" id="h36-0-162" class="i">+                    operation: Operation::ReadState {
</a><a href="#h36-0-163" id="h36-0-163" class="i">+                        command,
</a><a href="#h36-0-164" id="h36-0-164" class="i">+                        commit_index,
</a><a href="#h36-0-165" id="h36-0-165" class="i">+                        quorum: self.quorum(),
</a><a href="#h36-0-166" id="h36-0-166" class="i">+                        votes: HashSet::new(),
</a><a href="#h36-0-167" id="h36-0-167" class="i">+                    },
</a><a href="#h36-0-168" id="h36-0-168" class="i">+                });
</a><a href="#h36-0-169" id="h36-0-169" class="i">+                self.vote_call(self.id.clone().as_ref(), commit_index)?;
</a><a href="#h36-0-170" id="h36-0-170" class="i">+                // Send heartbeats immediately, so we don&#39;t have to wait for the next tick
</a><a href="#h36-0-171" id="h36-0-171" class="i">+                self.broadcast(Event::Heartbeat { commit_index, commit_term })?;
</a><a href="#h36-0-172" id="h36-0-172" class="i">+            }
</a><a href="#h36-0-173" id="h36-0-173" class="i">+            Event::MutateState { call_id, command } =&gt; {
</a><a href="#h36-0-174" id="h36-0-174" class="i">+                let index = self.append(Some(command))?;
</a><a href="#h36-0-175" id="h36-0-175" class="i">+                self.role.calls.register(Call {
</a><a href="#h36-0-176" id="h36-0-176" class="i">+                    id: call_id,
</a><a href="#h36-0-177" id="h36-0-177" class="i">+                    from: msg.from,
</a><a href="#h36-0-178" id="h36-0-178" class="i">+                    operation: Operation::MutateState { log_index: index },
</a><a href="#h36-0-179" id="h36-0-179" class="i">+                });
</a><a href="#h36-0-180" id="h36-0-180" class="i">+                if self.peers.is_empty() {
</a><a href="#h36-0-181" id="h36-0-181" class="i">+                    self.commit()?;
</a><a href="#h36-0-182" id="h36-0-182" class="i">+                    self.apply()?;
</a><a href="#h36-0-183" id="h36-0-183" class="i">+                }
</a><a href="#h36-0-184" id="h36-0-184" class="i">+            }
</a><a href="#h36-0-185" id="h36-0-185" class="i">+            Event::Heartbeat { .. } =&gt; {}
</a><a href="#h36-0-186" id="h36-0-186" class="i">+            Event::SolicitVote { .. } =&gt; {}
</a><a href="#h36-0-187" id="h36-0-187" class="i">+            Event::GrantVote =&gt; {}
</a><a href="#h36-0-188" id="h36-0-188" class="i">+            Event::ReplicateEntries { .. } =&gt; {}
</a><a href="#h36-0-189" id="h36-0-189" class="i">+            // FIXME We may want to handle these
</a><a href="#h36-0-190" id="h36-0-190" class="i">+            Event::RespondState { .. } =&gt; {}
</a><a href="#h36-0-191" id="h36-0-191" class="i">+            Event::RespondError { .. } =&gt; {}
</a><a href="#h36-0-192" id="h36-0-192" class="i">+        }
</a><a href="#h36-0-193" id="h36-0-193" class="i">+
</a><a href="#h36-0-194" id="h36-0-194" class="i">+        Ok(self.into())
</a><a href="#h36-0-195" id="h36-0-195" class="i">+    }
</a><a href="#h36-0-196" id="h36-0-196" class="i">+
</a><a href="#h36-0-197" id="h36-0-197" class="i">+    /// Processes a logical clock tick.
</a><a href="#h36-0-198" id="h36-0-198" class="i">+    pub fn tick(mut self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h36-0-199" id="h36-0-199" class="i">+        self.apply()?;
</a><a href="#h36-0-200" id="h36-0-200" class="i">+        self.role.heartbeat_ticks += 1;
</a><a href="#h36-0-201" id="h36-0-201" class="i">+        if self.role.heartbeat_ticks &gt;= HEARTBEAT_INTERVAL {
</a><a href="#h36-0-202" id="h36-0-202" class="i">+            self.role.heartbeat_ticks = 0;
</a><a href="#h36-0-203" id="h36-0-203" class="i">+            let (commit_index, commit_term) = self.log.get_committed();
</a><a href="#h36-0-204" id="h36-0-204" class="i">+            self.broadcast(Event::Heartbeat { commit_index, commit_term })?;
</a><a href="#h36-0-205" id="h36-0-205" class="i">+        }
</a><a href="#h36-0-206" id="h36-0-206" class="i">+        Ok(self.into())
</a><a href="#h36-0-207" id="h36-0-207" class="i">+    }
</a><a href="#h36-0-208" id="h36-0-208" class="i">+}
</a><a href="#h36-0-209" id="h36-0-209" class="i">+
</a><a href="#h36-0-210" id="h36-0-210" class="i">+/// A client call processed by the leader.
</a><a href="#h36-0-211" id="h36-0-211" class="i">+#[derive(Clone, Debug, PartialEq)]
</a><a href="#h36-0-212" id="h36-0-212" class="i">+struct Call {
</a><a href="#h36-0-213" id="h36-0-213" class="i">+    id: Vec&lt;u8&gt;,
</a><a href="#h36-0-214" id="h36-0-214" class="i">+    from: Option&lt;String&gt;,
</a><a href="#h36-0-215" id="h36-0-215" class="i">+    operation: Operation,
</a><a href="#h36-0-216" id="h36-0-216" class="i">+}
</a><a href="#h36-0-217" id="h36-0-217" class="i">+
</a><a href="#h36-0-218" id="h36-0-218" class="i">+/// An operation performed by a call.
</a><a href="#h36-0-219" id="h36-0-219" class="i">+#[derive(Clone, Debug, PartialEq)]
</a><a href="#h36-0-220" id="h36-0-220" class="i">+enum Operation {
</a><a href="#h36-0-221" id="h36-0-221" class="i">+    /// A mutation submitted to the Raft log.
</a><a href="#h36-0-222" id="h36-0-222" class="i">+    MutateState { log_index: u64 },
</a><a href="#h36-0-223" id="h36-0-223" class="i">+    /// A state machine read requiring a quorum.
</a><a href="#h36-0-224" id="h36-0-224" class="i">+    ReadState { command: Vec&lt;u8&gt;, commit_index: u64, quorum: u64, votes: HashSet&lt;String&gt; },
</a><a href="#h36-0-225" id="h36-0-225" class="i">+}
</a><a href="#h36-0-226" id="h36-0-226" class="i">+
</a><a href="#h36-0-227" id="h36-0-227" class="i">+/// A set of calls
</a><a href="#h36-0-228" id="h36-0-228" class="i">+#[derive(Clone, Debug)]
</a><a href="#h36-0-229" id="h36-0-229" class="i">+struct Calls {
</a><a href="#h36-0-230" id="h36-0-230" class="i">+    calls: Vec&lt;Call&gt;,
</a><a href="#h36-0-231" id="h36-0-231" class="i">+}
</a><a href="#h36-0-232" id="h36-0-232" class="i">+
</a><a href="#h36-0-233" id="h36-0-233" class="i">+impl Calls {
</a><a href="#h36-0-234" id="h36-0-234" class="i">+    /// Creates a new Calls
</a><a href="#h36-0-235" id="h36-0-235" class="i">+    fn new() -&gt; Self {
</a><a href="#h36-0-236" id="h36-0-236" class="i">+        Self { calls: Vec::new() }
</a><a href="#h36-0-237" id="h36-0-237" class="i">+    }
</a><a href="#h36-0-238" id="h36-0-238" class="i">+
</a><a href="#h36-0-239" id="h36-0-239" class="i">+    /// Registers a call
</a><a href="#h36-0-240" id="h36-0-240" class="i">+    fn register(&amp;mut self, call: Call) {
</a><a href="#h36-0-241" id="h36-0-241" class="i">+        self.calls.push(call);
</a><a href="#h36-0-242" id="h36-0-242" class="i">+    }
</a><a href="#h36-0-243" id="h36-0-243" class="i">+
</a><a href="#h36-0-244" id="h36-0-244" class="i">+    /// Signals application of the log entry with the given index, removes and
</a><a href="#h36-0-245" id="h36-0-245" class="i">+    /// returns the call tracking the entry (if any).
</a><a href="#h36-0-246" id="h36-0-246" class="i">+    fn log_applied(&amp;mut self, index: u64) -&gt; Option&lt;Call&gt; {
</a><a href="#h36-0-247" id="h36-0-247" class="i">+        self.calls
</a><a href="#h36-0-248" id="h36-0-248" class="i">+            .iter()
</a><a href="#h36-0-249" id="h36-0-249" class="i">+            .position(|call| match call.operation {
</a><a href="#h36-0-250" id="h36-0-250" class="i">+                Operation::MutateState { log_index } =&gt; log_index == index,
</a><a href="#h36-0-251" id="h36-0-251" class="i">+                Operation::ReadState { .. } =&gt; false,
</a><a href="#h36-0-252" id="h36-0-252" class="i">+            })
</a><a href="#h36-0-253" id="h36-0-253" class="i">+            .map(|i| self.calls.remove(i))
</a><a href="#h36-0-254" id="h36-0-254" class="i">+    }
</a><a href="#h36-0-255" id="h36-0-255" class="i">+
</a><a href="#h36-0-256" id="h36-0-256" class="i">+    /// Signals a leadership vote by a peer for a given commit index, removes and
</a><a href="#h36-0-257" id="h36-0-257" class="i">+    /// returns any calls which have received votes from a quorum.
</a><a href="#h36-0-258" id="h36-0-258" class="i">+    fn quorum_vote(&amp;mut self, voter: &amp;str, index: u64) -&gt; Vec&lt;Call&gt; {
</a><a href="#h36-0-259" id="h36-0-259" class="i">+        let mut indexes = Vec::new();
</a><a href="#h36-0-260" id="h36-0-260" class="i">+        for (i, call) in self.calls.iter_mut().enumerate() {
</a><a href="#h36-0-261" id="h36-0-261" class="i">+            match call.operation {
</a><a href="#h36-0-262" id="h36-0-262" class="i">+                Operation::MutateState { .. } =&gt; {}
</a><a href="#h36-0-263" id="h36-0-263" class="i">+                Operation::ReadState { commit_index, ref mut votes, quorum, .. } =&gt; {
</a><a href="#h36-0-264" id="h36-0-264" class="i">+                    if index &gt;= commit_index {
</a><a href="#h36-0-265" id="h36-0-265" class="i">+                        votes.insert(voter.to_owned());
</a><a href="#h36-0-266" id="h36-0-266" class="i">+                        if votes.len() as u64 &gt;= quorum {
</a><a href="#h36-0-267" id="h36-0-267" class="i">+                            indexes.push(i)
</a><a href="#h36-0-268" id="h36-0-268" class="i">+                        }
</a><a href="#h36-0-269" id="h36-0-269" class="i">+                    }
</a><a href="#h36-0-270" id="h36-0-270" class="i">+                }
</a><a href="#h36-0-271" id="h36-0-271" class="i">+            }
</a><a href="#h36-0-272" id="h36-0-272" class="i">+        }
</a><a href="#h36-0-273" id="h36-0-273" class="i">+        indexes.into_iter().enumerate().map(|(j, i)| self.calls.remove(i - j)).collect()
</a><a href="#h36-0-274" id="h36-0-274" class="i">+    }
</a><a href="#h36-0-275" id="h36-0-275" class="i">+}
</a><a href="#h36-0-276" id="h36-0-276" class="i">+
</a><a href="#h36-0-277" id="h36-0-277" class="i">+#[cfg(test)]
</a><a href="#h36-0-278" id="h36-0-278" class="i">+mod tests {
</a><a href="#h36-0-279" id="h36-0-279" class="i">+    use super::super::tests::{assert_messages, assert_node, TestState};
</a><a href="#h36-0-280" id="h36-0-280" class="i">+    use super::*;
</a><a href="#h36-0-281" id="h36-0-281" class="i">+    use crossbeam_channel::Receiver;
</a><a href="#h36-0-282" id="h36-0-282" class="i">+
</a><a href="#h36-0-283" id="h36-0-283" class="i">+    fn setup() -&gt; (RoleNode&lt;Leader&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h36-0-284" id="h36-0-284" class="i">+        let (sender, receiver) = crossbeam_channel::unbounded();
</a><a href="#h36-0-285" id="h36-0-285" class="i">+        let mut state = TestState::new().boxed();
</a><a href="#h36-0-286" id="h36-0-286" class="i">+        let mut log = Log::new(kv::Memory::new()).unwrap();
</a><a href="#h36-0-287" id="h36-0-287" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x01]) }).unwrap();
</a><a href="#h36-0-288" id="h36-0-288" class="i">+        log.append(Entry { term: 1, command: Some(vec![0x02]) }).unwrap();
</a><a href="#h36-0-289" id="h36-0-289" class="i">+        log.append(Entry { term: 2, command: Some(vec![0x03]) }).unwrap();
</a><a href="#h36-0-290" id="h36-0-290" class="i">+        log.append(Entry { term: 3, command: Some(vec![0x04]) }).unwrap();
</a><a href="#h36-0-291" id="h36-0-291" class="i">+        log.append(Entry { term: 3, command: Some(vec![0x05]) }).unwrap();
</a><a href="#h36-0-292" id="h36-0-292" class="i">+        log.commit(2).unwrap();
</a><a href="#h36-0-293" id="h36-0-293" class="i">+        log.apply(&amp;mut state).unwrap();
</a><a href="#h36-0-294" id="h36-0-294" class="i">+
</a><a href="#h36-0-295" id="h36-0-295" class="i">+        let peers = vec![&quot;b&quot;.into(), &quot;c&quot;.into(), &quot;d&quot;.into(), &quot;e&quot;.into()];
</a><a href="#h36-0-296" id="h36-0-296" class="i">+        let (last_index, _) = log.get_last();
</a><a href="#h36-0-297" id="h36-0-297" class="i">+
</a><a href="#h36-0-298" id="h36-0-298" class="i">+        let mut node = RoleNode {
</a><a href="#h36-0-299" id="h36-0-299" class="i">+            id: &quot;a&quot;.into(),
</a><a href="#h36-0-300" id="h36-0-300" class="i">+            peers: peers.clone(),
</a><a href="#h36-0-301" id="h36-0-301" class="i">+            term: 3,
</a><a href="#h36-0-302" id="h36-0-302" class="i">+            log,
</a><a href="#h36-0-303" id="h36-0-303" class="i">+            state,
</a><a href="#h36-0-304" id="h36-0-304" class="i">+            sender,
</a><a href="#h36-0-305" id="h36-0-305" class="i">+            role: Leader::new(peers.clone(), last_index),
</a><a href="#h36-0-306" id="h36-0-306" class="i">+        };
</a><a href="#h36-0-307" id="h36-0-307" class="i">+        node.save_term(3, None).unwrap();
</a><a href="#h36-0-308" id="h36-0-308" class="i">+        (node, receiver)
</a><a href="#h36-0-309" id="h36-0-309" class="i">+    }
</a><a href="#h36-0-310" id="h36-0-310" class="i">+
</a><a href="#h36-0-311" id="h36-0-311" class="i">+    #[test]
</a><a href="#h36-0-312" id="h36-0-312" class="i">+    // ConfirmLeader with has_committed has no effect without any calls
</a><a href="#h36-0-313" id="h36-0-313" class="i">+    fn step_confirmleader() {
</a><a href="#h36-0-314" id="h36-0-314" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-315" id="h36-0-315" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-316" id="h36-0-316" class="i">+
</a><a href="#h36-0-317" id="h36-0-317" class="i">+        node = node
</a><a href="#h36-0-318" id="h36-0-318" class="i">+            .step(Message {
</a><a href="#h36-0-319" id="h36-0-319" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-320" id="h36-0-320" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-321" id="h36-0-321" class="i">+                term: 3,
</a><a href="#h36-0-322" id="h36-0-322" class="i">+                event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
</a><a href="#h36-0-323" id="h36-0-323" class="i">+            })
</a><a href="#h36-0-324" id="h36-0-324" class="i">+            .unwrap();
</a><a href="#h36-0-325" id="h36-0-325" class="i">+        assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
</a><a href="#h36-0-326" id="h36-0-326" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-327" id="h36-0-327" class="i">+    }
</a><a href="#h36-0-328" id="h36-0-328" class="i">+
</a><a href="#h36-0-329" id="h36-0-329" class="i">+    #[test]
</a><a href="#h36-0-330" id="h36-0-330" class="i">+    // ConfirmLeader without has_committed triggers replication
</a><a href="#h36-0-331" id="h36-0-331" class="i">+    fn step_confirmleader_without_has_committed() {
</a><a href="#h36-0-332" id="h36-0-332" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-333" id="h36-0-333" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-334" id="h36-0-334" class="i">+
</a><a href="#h36-0-335" id="h36-0-335" class="i">+        node = node
</a><a href="#h36-0-336" id="h36-0-336" class="i">+            .step(Message {
</a><a href="#h36-0-337" id="h36-0-337" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-338" id="h36-0-338" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-339" id="h36-0-339" class="i">+                term: 3,
</a><a href="#h36-0-340" id="h36-0-340" class="i">+                event: Event::ConfirmLeader { commit_index: 2, has_committed: false },
</a><a href="#h36-0-341" id="h36-0-341" class="i">+            })
</a><a href="#h36-0-342" id="h36-0-342" class="i">+            .unwrap();
</a><a href="#h36-0-343" id="h36-0-343" class="i">+        assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
</a><a href="#h36-0-344" id="h36-0-344" class="i">+        assert_messages(
</a><a href="#h36-0-345" id="h36-0-345" class="i">+            &amp;rx,
</a><a href="#h36-0-346" id="h36-0-346" class="i">+            vec![Message {
</a><a href="#h36-0-347" id="h36-0-347" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-348" id="h36-0-348" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-349" id="h36-0-349" class="i">+                term: 3,
</a><a href="#h36-0-350" id="h36-0-350" class="i">+                event: Event::ReplicateEntries { base_index: 5, base_term: 3, entries: vec![] },
</a><a href="#h36-0-351" id="h36-0-351" class="i">+            }],
</a><a href="#h36-0-352" id="h36-0-352" class="i">+        );
</a><a href="#h36-0-353" id="h36-0-353" class="i">+    }
</a><a href="#h36-0-354" id="h36-0-354" class="i">+
</a><a href="#h36-0-355" id="h36-0-355" class="i">+    #[test]
</a><a href="#h36-0-356" id="h36-0-356" class="i">+    // Heartbeats from other leaders in current term are ignored.
</a><a href="#h36-0-357" id="h36-0-357" class="i">+    fn step_heartbeat_current_term() {
</a><a href="#h36-0-358" id="h36-0-358" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-359" id="h36-0-359" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-360" id="h36-0-360" class="i">+
</a><a href="#h36-0-361" id="h36-0-361" class="i">+        node = node
</a><a href="#h36-0-362" id="h36-0-362" class="i">+            .step(Message {
</a><a href="#h36-0-363" id="h36-0-363" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-364" id="h36-0-364" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-365" id="h36-0-365" class="i">+                term: 3,
</a><a href="#h36-0-366" id="h36-0-366" class="i">+                event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
</a><a href="#h36-0-367" id="h36-0-367" class="i">+            })
</a><a href="#h36-0-368" id="h36-0-368" class="i">+            .unwrap();
</a><a href="#h36-0-369" id="h36-0-369" class="i">+        assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
</a><a href="#h36-0-370" id="h36-0-370" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-371" id="h36-0-371" class="i">+    }
</a><a href="#h36-0-372" id="h36-0-372" class="i">+
</a><a href="#h36-0-373" id="h36-0-373" class="i">+    #[test]
</a><a href="#h36-0-374" id="h36-0-374" class="i">+    // Heartbeats from other leaders in future term converts to follower and steps.
</a><a href="#h36-0-375" id="h36-0-375" class="i">+    fn step_heartbeat_future_term() {
</a><a href="#h36-0-376" id="h36-0-376" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-377" id="h36-0-377" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-378" id="h36-0-378" class="i">+
</a><a href="#h36-0-379" id="h36-0-379" class="i">+        node = node
</a><a href="#h36-0-380" id="h36-0-380" class="i">+            .step(Message {
</a><a href="#h36-0-381" id="h36-0-381" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-382" id="h36-0-382" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-383" id="h36-0-383" class="i">+                term: 4,
</a><a href="#h36-0-384" id="h36-0-384" class="i">+                event: Event::Heartbeat { commit_index: 7, commit_term: 4 },
</a><a href="#h36-0-385" id="h36-0-385" class="i">+            })
</a><a href="#h36-0-386" id="h36-0-386" class="i">+            .unwrap();
</a><a href="#h36-0-387" id="h36-0-387" class="i">+        assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;b&quot;)).committed(2).applied(1);
</a><a href="#h36-0-388" id="h36-0-388" class="i">+        assert_messages(
</a><a href="#h36-0-389" id="h36-0-389" class="i">+            &amp;rx,
</a><a href="#h36-0-390" id="h36-0-390" class="i">+            vec![Message {
</a><a href="#h36-0-391" id="h36-0-391" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-392" id="h36-0-392" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-393" id="h36-0-393" class="i">+                term: 4,
</a><a href="#h36-0-394" id="h36-0-394" class="i">+                event: Event::ConfirmLeader { commit_index: 7, has_committed: false },
</a><a href="#h36-0-395" id="h36-0-395" class="i">+            }],
</a><a href="#h36-0-396" id="h36-0-396" class="i">+        );
</a><a href="#h36-0-397" id="h36-0-397" class="i">+    }
</a><a href="#h36-0-398" id="h36-0-398" class="i">+
</a><a href="#h36-0-399" id="h36-0-399" class="i">+    #[test]
</a><a href="#h36-0-400" id="h36-0-400" class="i">+    // Heartbeats from other leaders in past terms are ignored.
</a><a href="#h36-0-401" id="h36-0-401" class="i">+    fn step_heartbeat_past_term() {
</a><a href="#h36-0-402" id="h36-0-402" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-403" id="h36-0-403" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-404" id="h36-0-404" class="i">+
</a><a href="#h36-0-405" id="h36-0-405" class="i">+        node = node
</a><a href="#h36-0-406" id="h36-0-406" class="i">+            .step(Message {
</a><a href="#h36-0-407" id="h36-0-407" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-408" id="h36-0-408" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-409" id="h36-0-409" class="i">+                term: 2,
</a><a href="#h36-0-410" id="h36-0-410" class="i">+                event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
</a><a href="#h36-0-411" id="h36-0-411" class="i">+            })
</a><a href="#h36-0-412" id="h36-0-412" class="i">+            .unwrap();
</a><a href="#h36-0-413" id="h36-0-413" class="i">+        assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
</a><a href="#h36-0-414" id="h36-0-414" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-415" id="h36-0-415" class="i">+    }
</a><a href="#h36-0-416" id="h36-0-416" class="i">+
</a><a href="#h36-0-417" id="h36-0-417" class="i">+    #[test]
</a><a href="#h36-0-418" id="h36-0-418" class="i">+    fn step_acceptentries() {
</a><a href="#h36-0-419" id="h36-0-419" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-420" id="h36-0-420" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-421" id="h36-0-421" class="i">+
</a><a href="#h36-0-422" id="h36-0-422" class="i">+        node = node
</a><a href="#h36-0-423" id="h36-0-423" class="i">+            .step(Message {
</a><a href="#h36-0-424" id="h36-0-424" class="i">+                from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-425" id="h36-0-425" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-426" id="h36-0-426" class="i">+                term: 3,
</a><a href="#h36-0-427" id="h36-0-427" class="i">+                event: Event::AcceptEntries { last_index: 4 },
</a><a href="#h36-0-428" id="h36-0-428" class="i">+            })
</a><a href="#h36-0-429" id="h36-0-429" class="i">+            .unwrap();
</a><a href="#h36-0-430" id="h36-0-430" class="i">+        assert_node(&amp;node).committed(2).applied(2);
</a><a href="#h36-0-431" id="h36-0-431" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-432" id="h36-0-432" class="i">+
</a><a href="#h36-0-433" id="h36-0-433" class="i">+        node = node
</a><a href="#h36-0-434" id="h36-0-434" class="i">+            .step(Message {
</a><a href="#h36-0-435" id="h36-0-435" class="i">+                from: Some(&quot;c&quot;.into()),
</a><a href="#h36-0-436" id="h36-0-436" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-437" id="h36-0-437" class="i">+                term: 3,
</a><a href="#h36-0-438" id="h36-0-438" class="i">+                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h36-0-439" id="h36-0-439" class="i">+            })
</a><a href="#h36-0-440" id="h36-0-440" class="i">+            .unwrap();
</a><a href="#h36-0-441" id="h36-0-441" class="i">+        assert_node(&amp;node).committed(4).applied(4);
</a><a href="#h36-0-442" id="h36-0-442" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-443" id="h36-0-443" class="i">+
</a><a href="#h36-0-444" id="h36-0-444" class="i">+        node = node
</a><a href="#h36-0-445" id="h36-0-445" class="i">+            .step(Message {
</a><a href="#h36-0-446" id="h36-0-446" class="i">+                from: Some(&quot;d&quot;.into()),
</a><a href="#h36-0-447" id="h36-0-447" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-448" id="h36-0-448" class="i">+                term: 3,
</a><a href="#h36-0-449" id="h36-0-449" class="i">+                event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h36-0-450" id="h36-0-450" class="i">+            })
</a><a href="#h36-0-451" id="h36-0-451" class="i">+            .unwrap();
</a><a href="#h36-0-452" id="h36-0-452" class="i">+        assert_node(&amp;node).committed(5).applied(5);
</a><a href="#h36-0-453" id="h36-0-453" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-454" id="h36-0-454" class="i">+
</a><a href="#h36-0-455" id="h36-0-455" class="i">+        assert_node(&amp;node).is_leader().term(3);
</a><a href="#h36-0-456" id="h36-0-456" class="i">+    }
</a><a href="#h36-0-457" id="h36-0-457" class="i">+
</a><a href="#h36-0-458" id="h36-0-458" class="i">+    #[test]
</a><a href="#h36-0-459" id="h36-0-459" class="i">+    // Duplicate AcceptEntries from single node should not trigger commit.
</a><a href="#h36-0-460" id="h36-0-460" class="i">+    fn step_acceptentries_duplicate() {
</a><a href="#h36-0-461" id="h36-0-461" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-462" id="h36-0-462" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-463" id="h36-0-463" class="i">+
</a><a href="#h36-0-464" id="h36-0-464" class="i">+        for _ in 0..5 {
</a><a href="#h36-0-465" id="h36-0-465" class="i">+            node = node
</a><a href="#h36-0-466" id="h36-0-466" class="i">+                .step(Message {
</a><a href="#h36-0-467" id="h36-0-467" class="i">+                    from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-468" id="h36-0-468" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-469" id="h36-0-469" class="i">+                    term: 3,
</a><a href="#h36-0-470" id="h36-0-470" class="i">+                    event: Event::AcceptEntries { last_index: 5 },
</a><a href="#h36-0-471" id="h36-0-471" class="i">+                })
</a><a href="#h36-0-472" id="h36-0-472" class="i">+                .unwrap();
</a><a href="#h36-0-473" id="h36-0-473" class="i">+            assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
</a><a href="#h36-0-474" id="h36-0-474" class="i">+            assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-475" id="h36-0-475" class="i">+        }
</a><a href="#h36-0-476" id="h36-0-476" class="i">+    }
</a><a href="#h36-0-477" id="h36-0-477" class="i">+
</a><a href="#h36-0-478" id="h36-0-478" class="i">+    #[test]
</a><a href="#h36-0-479" id="h36-0-479" class="i">+    // AcceptEntries quorum for entry in past term should not trigger commit
</a><a href="#h36-0-480" id="h36-0-480" class="i">+    fn step_acceptentries_past_term() {
</a><a href="#h36-0-481" id="h36-0-481" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-482" id="h36-0-482" class="i">+        let peers = leader.peers.clone();
</a><a href="#h36-0-483" id="h36-0-483" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-484" id="h36-0-484" class="i">+
</a><a href="#h36-0-485" id="h36-0-485" class="i">+        for peer in peers.into_iter() {
</a><a href="#h36-0-486" id="h36-0-486" class="i">+            node = node
</a><a href="#h36-0-487" id="h36-0-487" class="i">+                .step(Message {
</a><a href="#h36-0-488" id="h36-0-488" class="i">+                    from: Some(peer),
</a><a href="#h36-0-489" id="h36-0-489" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-490" id="h36-0-490" class="i">+                    term: 3,
</a><a href="#h36-0-491" id="h36-0-491" class="i">+                    event: Event::AcceptEntries { last_index: 3 },
</a><a href="#h36-0-492" id="h36-0-492" class="i">+                })
</a><a href="#h36-0-493" id="h36-0-493" class="i">+                .unwrap();
</a><a href="#h36-0-494" id="h36-0-494" class="i">+            assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
</a><a href="#h36-0-495" id="h36-0-495" class="i">+            assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-496" id="h36-0-496" class="i">+        }
</a><a href="#h36-0-497" id="h36-0-497" class="i">+    }
</a><a href="#h36-0-498" id="h36-0-498" class="i">+
</a><a href="#h36-0-499" id="h36-0-499" class="i">+    #[test]
</a><a href="#h36-0-500" id="h36-0-500" class="i">+    // AcceptEntries quorum for missing future entry
</a><a href="#h36-0-501" id="h36-0-501" class="i">+    fn step_acceptentries_future_index() {
</a><a href="#h36-0-502" id="h36-0-502" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-503" id="h36-0-503" class="i">+        let peers = leader.peers.clone();
</a><a href="#h36-0-504" id="h36-0-504" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-505" id="h36-0-505" class="i">+
</a><a href="#h36-0-506" id="h36-0-506" class="i">+        for (i, peer) in peers.into_iter().enumerate() {
</a><a href="#h36-0-507" id="h36-0-507" class="i">+            node = node
</a><a href="#h36-0-508" id="h36-0-508" class="i">+                .step(Message {
</a><a href="#h36-0-509" id="h36-0-509" class="i">+                    from: Some(peer),
</a><a href="#h36-0-510" id="h36-0-510" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-511" id="h36-0-511" class="i">+                    term: 3,
</a><a href="#h36-0-512" id="h36-0-512" class="i">+                    event: Event::AcceptEntries { last_index: 7 },
</a><a href="#h36-0-513" id="h36-0-513" class="i">+                })
</a><a href="#h36-0-514" id="h36-0-514" class="i">+                .unwrap();
</a><a href="#h36-0-515" id="h36-0-515" class="i">+            // The local leader will cast a vote to commit 5, thus
</a><a href="#h36-0-516" id="h36-0-516" class="i">+            // when we have votes 2x7, 1x5, 2x0 we will commit index 5.
</a><a href="#h36-0-517" id="h36-0-517" class="i">+            // However, we will correctly ignore the following votes for 7.
</a><a href="#h36-0-518" id="h36-0-518" class="i">+            let c = if i == 0 { 2 } else { 5 };
</a><a href="#h36-0-519" id="h36-0-519" class="i">+            assert_node(&amp;node).is_leader().term(3).committed(c).applied(c).last(5);
</a><a href="#h36-0-520" id="h36-0-520" class="i">+            assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-521" id="h36-0-521" class="i">+        }
</a><a href="#h36-0-522" id="h36-0-522" class="i">+    }
</a><a href="#h36-0-523" id="h36-0-523" class="i">+
</a><a href="#h36-0-524" id="h36-0-524" class="i">+    #[test]
</a><a href="#h36-0-525" id="h36-0-525" class="i">+    fn step_rejectentries() {
</a><a href="#h36-0-526" id="h36-0-526" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-527" id="h36-0-527" class="i">+        let entries = leader.log.range(0..).unwrap();
</a><a href="#h36-0-528" id="h36-0-528" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-529" id="h36-0-529" class="i">+
</a><a href="#h36-0-530" id="h36-0-530" class="i">+        for i in 0..(entries.len() + 3) {
</a><a href="#h36-0-531" id="h36-0-531" class="i">+            node = node
</a><a href="#h36-0-532" id="h36-0-532" class="i">+                .step(Message {
</a><a href="#h36-0-533" id="h36-0-533" class="i">+                    from: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-534" id="h36-0-534" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-535" id="h36-0-535" class="i">+                    term: 3,
</a><a href="#h36-0-536" id="h36-0-536" class="i">+                    event: Event::RejectEntries,
</a><a href="#h36-0-537" id="h36-0-537" class="i">+                })
</a><a href="#h36-0-538" id="h36-0-538" class="i">+                .unwrap();
</a><a href="#h36-0-539" id="h36-0-539" class="i">+            assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
</a><a href="#h36-0-540" id="h36-0-540" class="i">+            let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
</a><a href="#h36-0-541" id="h36-0-541" class="i">+            let replicate = entries.get(index..).unwrap().to_vec();
</a><a href="#h36-0-542" id="h36-0-542" class="i">+            assert_messages(
</a><a href="#h36-0-543" id="h36-0-543" class="i">+                &amp;rx,
</a><a href="#h36-0-544" id="h36-0-544" class="i">+                vec![Message {
</a><a href="#h36-0-545" id="h36-0-545" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-546" id="h36-0-546" class="i">+                    to: Some(&quot;b&quot;.into()),
</a><a href="#h36-0-547" id="h36-0-547" class="i">+                    term: 3,
</a><a href="#h36-0-548" id="h36-0-548" class="i">+                    event: Event::ReplicateEntries {
</a><a href="#h36-0-549" id="h36-0-549" class="i">+                        base_index: index as u64,
</a><a href="#h36-0-550" id="h36-0-550" class="i">+                        base_term: if index &gt; 0 {
</a><a href="#h36-0-551" id="h36-0-551" class="i">+                            entries.get(index - 1).map(|e| e.term).unwrap()
</a><a href="#h36-0-552" id="h36-0-552" class="i">+                        } else {
</a><a href="#h36-0-553" id="h36-0-553" class="i">+                            0
</a><a href="#h36-0-554" id="h36-0-554" class="i">+                        },
</a><a href="#h36-0-555" id="h36-0-555" class="i">+                        entries: replicate,
</a><a href="#h36-0-556" id="h36-0-556" class="i">+                    },
</a><a href="#h36-0-557" id="h36-0-557" class="i">+                }],
</a><a href="#h36-0-558" id="h36-0-558" class="i">+            );
</a><a href="#h36-0-559" id="h36-0-559" class="i">+        }
</a><a href="#h36-0-560" id="h36-0-560" class="i">+    }
</a><a href="#h36-0-561" id="h36-0-561" class="i">+
</a><a href="#h36-0-562" id="h36-0-562" class="i">+    #[test]
</a><a href="#h36-0-563" id="h36-0-563" class="i">+    fn step_mutatestate_readstate() {
</a><a href="#h36-0-564" id="h36-0-564" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-565" id="h36-0-565" class="i">+        let peers = leader.peers.clone();
</a><a href="#h36-0-566" id="h36-0-566" class="i">+        let quorum = leader.quorum();
</a><a href="#h36-0-567" id="h36-0-567" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-568" id="h36-0-568" class="i">+
</a><a href="#h36-0-569" id="h36-0-569" class="i">+        // Submit the mutate call from local sender, and observe it being
</a><a href="#h36-0-570" id="h36-0-570" class="i">+        // appended to log and replicated to peers. The mutate command will be
</a><a href="#h36-0-571" id="h36-0-571" class="i">+        // appended to the internal commands list of TestState and returned with
</a><a href="#h36-0-572" id="h36-0-572" class="i">+        // a 0xff prefix, and a subsequent read command can read back the
</a><a href="#h36-0-573" id="h36-0-573" class="i">+        // command at the index given by the command with the result prefixed
</a><a href="#h36-0-574" id="h36-0-574" class="i">+        // with 0xbb.
</a><a href="#h36-0-575" id="h36-0-575" class="i">+        node = node
</a><a href="#h36-0-576" id="h36-0-576" class="i">+            .step(Message {
</a><a href="#h36-0-577" id="h36-0-577" class="i">+                from: None,
</a><a href="#h36-0-578" id="h36-0-578" class="i">+                to: None,
</a><a href="#h36-0-579" id="h36-0-579" class="i">+                term: 0,
</a><a href="#h36-0-580" id="h36-0-580" class="i">+                event: Event::MutateState { call_id: vec![0x01], command: vec![0xaf] },
</a><a href="#h36-0-581" id="h36-0-581" class="i">+            })
</a><a href="#h36-0-582" id="h36-0-582" class="i">+            .unwrap();
</a><a href="#h36-0-583" id="h36-0-583" class="i">+        assert_node(&amp;node)
</a><a href="#h36-0-584" id="h36-0-584" class="i">+            .is_leader()
</a><a href="#h36-0-585" id="h36-0-585" class="i">+            .term(3)
</a><a href="#h36-0-586" id="h36-0-586" class="i">+            .committed(2)
</a><a href="#h36-0-587" id="h36-0-587" class="i">+            .applied(1)
</a><a href="#h36-0-588" id="h36-0-588" class="i">+            .last(6)
</a><a href="#h36-0-589" id="h36-0-589" class="i">+            .entry(6, Entry { term: 3, command: Some(vec![0xaf]) });
</a><a href="#h36-0-590" id="h36-0-590" class="i">+        for peer in peers.iter().cloned() {
</a><a href="#h36-0-591" id="h36-0-591" class="i">+            assert!(!rx.is_empty());
</a><a href="#h36-0-592" id="h36-0-592" class="i">+            assert_eq!(
</a><a href="#h36-0-593" id="h36-0-593" class="i">+                rx.recv().unwrap(),
</a><a href="#h36-0-594" id="h36-0-594" class="i">+                Message {
</a><a href="#h36-0-595" id="h36-0-595" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-596" id="h36-0-596" class="i">+                    to: Some(peer),
</a><a href="#h36-0-597" id="h36-0-597" class="i">+                    term: 3,
</a><a href="#h36-0-598" id="h36-0-598" class="i">+                    event: Event::ReplicateEntries {
</a><a href="#h36-0-599" id="h36-0-599" class="i">+                        base_index: 5,
</a><a href="#h36-0-600" id="h36-0-600" class="i">+                        base_term: 3,
</a><a href="#h36-0-601" id="h36-0-601" class="i">+                        entries: vec![Entry { term: 3, command: Some(vec![0xaf]) },]
</a><a href="#h36-0-602" id="h36-0-602" class="i">+                    },
</a><a href="#h36-0-603" id="h36-0-603" class="i">+                }
</a><a href="#h36-0-604" id="h36-0-604" class="i">+            )
</a><a href="#h36-0-605" id="h36-0-605" class="i">+        }
</a><a href="#h36-0-606" id="h36-0-606" class="i">+
</a><a href="#h36-0-607" id="h36-0-607" class="i">+        // Receive some ConfirmLeader messages from peers, to make sure
</a><a href="#h36-0-608" id="h36-0-608" class="i">+        // they do not affect mutation calls at all.
</a><a href="#h36-0-609" id="h36-0-609" class="i">+        for peer in peers.iter().cloned() {
</a><a href="#h36-0-610" id="h36-0-610" class="i">+            node = node
</a><a href="#h36-0-611" id="h36-0-611" class="i">+                .step(Message {
</a><a href="#h36-0-612" id="h36-0-612" class="i">+                    from: Some(peer),
</a><a href="#h36-0-613" id="h36-0-613" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-614" id="h36-0-614" class="i">+                    term: 3,
</a><a href="#h36-0-615" id="h36-0-615" class="i">+                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h36-0-616" id="h36-0-616" class="i">+                })
</a><a href="#h36-0-617" id="h36-0-617" class="i">+                .unwrap();
</a><a href="#h36-0-618" id="h36-0-618" class="i">+            assert_node(&amp;node).committed(2).applied(1).last(6);
</a><a href="#h36-0-619" id="h36-0-619" class="i">+        }
</a><a href="#h36-0-620" id="h36-0-620" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-621" id="h36-0-621" class="i">+
</a><a href="#h36-0-622" id="h36-0-622" class="i">+        // Receive AcceptEntries calls from peers, which after a quorum
</a><a href="#h36-0-623" id="h36-0-623" class="i">+        // will commit and apply the entries and return a call response.
</a><a href="#h36-0-624" id="h36-0-624" class="i">+        for (i, peer) in peers.iter().cloned().enumerate() {
</a><a href="#h36-0-625" id="h36-0-625" class="i">+            node = node
</a><a href="#h36-0-626" id="h36-0-626" class="i">+                .step(Message {
</a><a href="#h36-0-627" id="h36-0-627" class="i">+                    from: Some(peer),
</a><a href="#h36-0-628" id="h36-0-628" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-629" id="h36-0-629" class="i">+                    term: 3,
</a><a href="#h36-0-630" id="h36-0-630" class="i">+                    event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h36-0-631" id="h36-0-631" class="i">+                })
</a><a href="#h36-0-632" id="h36-0-632" class="i">+                .unwrap();
</a><a href="#h36-0-633" id="h36-0-633" class="i">+            if (i as u64 + 2) &lt; quorum {
</a><a href="#h36-0-634" id="h36-0-634" class="i">+                assert_node(&amp;node).committed(2).applied(2).last(6);
</a><a href="#h36-0-635" id="h36-0-635" class="i">+                assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-636" id="h36-0-636" class="i">+            } else {
</a><a href="#h36-0-637" id="h36-0-637" class="i">+                assert_node(&amp;node).committed(6).applied(6).last(6);
</a><a href="#h36-0-638" id="h36-0-638" class="i">+                assert!(!rx.is_empty());
</a><a href="#h36-0-639" id="h36-0-639" class="i">+            }
</a><a href="#h36-0-640" id="h36-0-640" class="i">+        }
</a><a href="#h36-0-641" id="h36-0-641" class="i">+        assert_messages(
</a><a href="#h36-0-642" id="h36-0-642" class="i">+            &amp;rx,
</a><a href="#h36-0-643" id="h36-0-643" class="i">+            vec![Message {
</a><a href="#h36-0-644" id="h36-0-644" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-645" id="h36-0-645" class="i">+                to: None,
</a><a href="#h36-0-646" id="h36-0-646" class="i">+                term: 3,
</a><a href="#h36-0-647" id="h36-0-647" class="i">+                event: Event::RespondState { call_id: vec![0x01], response: vec![0xff, 0xaf] },
</a><a href="#h36-0-648" id="h36-0-648" class="i">+            }],
</a><a href="#h36-0-649" id="h36-0-649" class="i">+        );
</a><a href="#h36-0-650" id="h36-0-650" class="i">+
</a><a href="#h36-0-651" id="h36-0-651" class="i">+        // Submit a read call to read back our entry, which will immediately
</a><a href="#h36-0-652" id="h36-0-652" class="i">+        // send heartbeats to all peers to confirm that we&#39;re still the leader.
</a><a href="#h36-0-653" id="h36-0-653" class="i">+        node = node
</a><a href="#h36-0-654" id="h36-0-654" class="i">+            .step(Message {
</a><a href="#h36-0-655" id="h36-0-655" class="i">+                from: None,
</a><a href="#h36-0-656" id="h36-0-656" class="i">+                to: None,
</a><a href="#h36-0-657" id="h36-0-657" class="i">+                term: 0,
</a><a href="#h36-0-658" id="h36-0-658" class="i">+                event: Event::ReadState { call_id: vec![0x02], command: vec![0x06] },
</a><a href="#h36-0-659" id="h36-0-659" class="i">+            })
</a><a href="#h36-0-660" id="h36-0-660" class="i">+            .unwrap();
</a><a href="#h36-0-661" id="h36-0-661" class="i">+        assert_node(&amp;node).is_leader().term(3);
</a><a href="#h36-0-662" id="h36-0-662" class="i">+        for peer in peers.iter().cloned() {
</a><a href="#h36-0-663" id="h36-0-663" class="i">+            assert!(!rx.is_empty());
</a><a href="#h36-0-664" id="h36-0-664" class="i">+            assert_eq!(
</a><a href="#h36-0-665" id="h36-0-665" class="i">+                rx.recv().unwrap(),
</a><a href="#h36-0-666" id="h36-0-666" class="i">+                Message {
</a><a href="#h36-0-667" id="h36-0-667" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-668" id="h36-0-668" class="i">+                    to: Some(peer),
</a><a href="#h36-0-669" id="h36-0-669" class="i">+                    term: 3,
</a><a href="#h36-0-670" id="h36-0-670" class="i">+                    event: Event::Heartbeat { commit_index: 6, commit_term: 3 },
</a><a href="#h36-0-671" id="h36-0-671" class="i">+                }
</a><a href="#h36-0-672" id="h36-0-672" class="i">+            )
</a><a href="#h36-0-673" id="h36-0-673" class="i">+        }
</a><a href="#h36-0-674" id="h36-0-674" class="i">+        assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-675" id="h36-0-675" class="i">+
</a><a href="#h36-0-676" id="h36-0-676" class="i">+        // Check that ConfirmLeader calls for an old commit_index as well as
</a><a href="#h36-0-677" id="h36-0-677" class="i">+        // AcceptEntries calls for the current last_index do not trigger a
</a><a href="#h36-0-678" id="h36-0-678" class="i">+        // read response.
</a><a href="#h36-0-679" id="h36-0-679" class="i">+        for peer in peers.iter().cloned() {
</a><a href="#h36-0-680" id="h36-0-680" class="i">+            node = node
</a><a href="#h36-0-681" id="h36-0-681" class="i">+                .step(Message {
</a><a href="#h36-0-682" id="h36-0-682" class="i">+                    from: Some(peer.clone()),
</a><a href="#h36-0-683" id="h36-0-683" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-684" id="h36-0-684" class="i">+                    term: 3,
</a><a href="#h36-0-685" id="h36-0-685" class="i">+                    event: Event::ConfirmLeader { commit_index: 5, has_committed: true },
</a><a href="#h36-0-686" id="h36-0-686" class="i">+                })
</a><a href="#h36-0-687" id="h36-0-687" class="i">+                .unwrap();
</a><a href="#h36-0-688" id="h36-0-688" class="i">+            node = node
</a><a href="#h36-0-689" id="h36-0-689" class="i">+                .step(Message {
</a><a href="#h36-0-690" id="h36-0-690" class="i">+                    from: Some(peer),
</a><a href="#h36-0-691" id="h36-0-691" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-692" id="h36-0-692" class="i">+                    term: 3,
</a><a href="#h36-0-693" id="h36-0-693" class="i">+                    event: Event::AcceptEntries { last_index: 6 },
</a><a href="#h36-0-694" id="h36-0-694" class="i">+                })
</a><a href="#h36-0-695" id="h36-0-695" class="i">+                .unwrap();
</a><a href="#h36-0-696" id="h36-0-696" class="i">+            assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-697" id="h36-0-697" class="i">+        }
</a><a href="#h36-0-698" id="h36-0-698" class="i">+
</a><a href="#h36-0-699" id="h36-0-699" class="i">+        // After we receive leadership confirmation from a quorum of
</a><a href="#h36-0-700" id="h36-0-700" class="i">+        // votes, the read response is returned.
</a><a href="#h36-0-701" id="h36-0-701" class="i">+        for (i, peer) in peers.iter().cloned().enumerate() {
</a><a href="#h36-0-702" id="h36-0-702" class="i">+            node = node
</a><a href="#h36-0-703" id="h36-0-703" class="i">+                .step(Message {
</a><a href="#h36-0-704" id="h36-0-704" class="i">+                    from: Some(peer.clone()),
</a><a href="#h36-0-705" id="h36-0-705" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-706" id="h36-0-706" class="i">+                    term: 3,
</a><a href="#h36-0-707" id="h36-0-707" class="i">+                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h36-0-708" id="h36-0-708" class="i">+                })
</a><a href="#h36-0-709" id="h36-0-709" class="i">+                .unwrap();
</a><a href="#h36-0-710" id="h36-0-710" class="i">+            assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
</a><a href="#h36-0-711" id="h36-0-711" class="i">+            if (i as u64 + 2) &lt; quorum {
</a><a href="#h36-0-712" id="h36-0-712" class="i">+                assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-713" id="h36-0-713" class="i">+            } else {
</a><a href="#h36-0-714" id="h36-0-714" class="i">+                assert!(!rx.is_empty());
</a><a href="#h36-0-715" id="h36-0-715" class="i">+            }
</a><a href="#h36-0-716" id="h36-0-716" class="i">+        }
</a><a href="#h36-0-717" id="h36-0-717" class="i">+        assert_messages(
</a><a href="#h36-0-718" id="h36-0-718" class="i">+            &amp;rx,
</a><a href="#h36-0-719" id="h36-0-719" class="i">+            vec![Message {
</a><a href="#h36-0-720" id="h36-0-720" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-721" id="h36-0-721" class="i">+                to: None,
</a><a href="#h36-0-722" id="h36-0-722" class="i">+                term: 3,
</a><a href="#h36-0-723" id="h36-0-723" class="i">+                event: Event::RespondState { call_id: vec![0x02], response: vec![0xbb, 0xaf] },
</a><a href="#h36-0-724" id="h36-0-724" class="i">+            }],
</a><a href="#h36-0-725" id="h36-0-725" class="i">+        );
</a><a href="#h36-0-726" id="h36-0-726" class="i">+
</a><a href="#h36-0-727" id="h36-0-727" class="i">+        // Further leadership confirmation messages should not trigger messages.
</a><a href="#h36-0-728" id="h36-0-728" class="i">+        for peer in peers.iter().cloned() {
</a><a href="#h36-0-729" id="h36-0-729" class="i">+            node = node
</a><a href="#h36-0-730" id="h36-0-730" class="i">+                .step(Message {
</a><a href="#h36-0-731" id="h36-0-731" class="i">+                    from: Some(peer.clone()),
</a><a href="#h36-0-732" id="h36-0-732" class="i">+                    to: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-733" id="h36-0-733" class="i">+                    term: 3,
</a><a href="#h36-0-734" id="h36-0-734" class="i">+                    event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
</a><a href="#h36-0-735" id="h36-0-735" class="i">+                })
</a><a href="#h36-0-736" id="h36-0-736" class="i">+                .unwrap();
</a><a href="#h36-0-737" id="h36-0-737" class="i">+            assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-738" id="h36-0-738" class="i">+        }
</a><a href="#h36-0-739" id="h36-0-739" class="i">+        assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
</a><a href="#h36-0-740" id="h36-0-740" class="i">+    }
</a><a href="#h36-0-741" id="h36-0-741" class="i">+
</a><a href="#h36-0-742" id="h36-0-742" class="i">+    #[test]
</a><a href="#h36-0-743" id="h36-0-743" class="i">+    fn tick() {
</a><a href="#h36-0-744" id="h36-0-744" class="i">+        let (leader, rx) = setup();
</a><a href="#h36-0-745" id="h36-0-745" class="i">+        let peers = leader.peers.clone();
</a><a href="#h36-0-746" id="h36-0-746" class="i">+        let mut node: Node = leader.into();
</a><a href="#h36-0-747" id="h36-0-747" class="i">+        for _ in 0..5 {
</a><a href="#h36-0-748" id="h36-0-748" class="i">+            for _ in 0..HEARTBEAT_INTERVAL {
</a><a href="#h36-0-749" id="h36-0-749" class="i">+                assert_messages(&amp;rx, vec![]);
</a><a href="#h36-0-750" id="h36-0-750" class="i">+                node = node.tick().unwrap();
</a><a href="#h36-0-751" id="h36-0-751" class="i">+                assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
</a><a href="#h36-0-752" id="h36-0-752" class="i">+            }
</a><a href="#h36-0-753" id="h36-0-753" class="i">+            for peer in peers.iter() {
</a><a href="#h36-0-754" id="h36-0-754" class="i">+                assert!(!rx.is_empty());
</a><a href="#h36-0-755" id="h36-0-755" class="i">+                assert_eq!(
</a><a href="#h36-0-756" id="h36-0-756" class="i">+                    rx.recv().unwrap(),
</a><a href="#h36-0-757" id="h36-0-757" class="i">+                    Message {
</a><a href="#h36-0-758" id="h36-0-758" class="i">+                        from: Some(&quot;a&quot;.into()),
</a><a href="#h36-0-759" id="h36-0-759" class="i">+                        to: Some(peer.into()),
</a><a href="#h36-0-760" id="h36-0-760" class="i">+                        term: 3,
</a><a href="#h36-0-761" id="h36-0-761" class="i">+                        event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
</a><a href="#h36-0-762" id="h36-0-762" class="i">+                    }
</a><a href="#h36-0-763" id="h36-0-763" class="i">+                );
</a><a href="#h36-0-764" id="h36-0-764" class="i">+            }
</a><a href="#h36-0-765" id="h36-0-765" class="i">+        }
</a><a href="#h36-0-766" id="h36-0-766" class="i">+    }
</a><a href="#h36-0-767" id="h36-0-767" class="i">+
</a><a href="#h36-0-768" id="h36-0-768" class="i">+    fn setup_calls() -&gt; Calls {
</a><a href="#h36-0-769" id="h36-0-769" class="i">+        let mut calls = Calls::new();
</a><a href="#h36-0-770" id="h36-0-770" class="i">+        calls.register(Call {
</a><a href="#h36-0-771" id="h36-0-771" class="i">+            id: vec![0xa0],
</a><a href="#h36-0-772" id="h36-0-772" class="i">+            from: None,
</a><a href="#h36-0-773" id="h36-0-773" class="i">+            operation: Operation::MutateState { log_index: 1 },
</a><a href="#h36-0-774" id="h36-0-774" class="i">+        });
</a><a href="#h36-0-775" id="h36-0-775" class="i">+        calls.register(Call {
</a><a href="#h36-0-776" id="h36-0-776" class="i">+            id: vec![0xa2],
</a><a href="#h36-0-777" id="h36-0-777" class="i">+            from: None,
</a><a href="#h36-0-778" id="h36-0-778" class="i">+            operation: Operation::MutateState { log_index: 2 },
</a><a href="#h36-0-779" id="h36-0-779" class="i">+        });
</a><a href="#h36-0-780" id="h36-0-780" class="i">+        calls.register(Call {
</a><a href="#h36-0-781" id="h36-0-781" class="i">+            id: vec![0xa3],
</a><a href="#h36-0-782" id="h36-0-782" class="i">+            from: None,
</a><a href="#h36-0-783" id="h36-0-783" class="i">+            operation: Operation::MutateState { log_index: 3 },
</a><a href="#h36-0-784" id="h36-0-784" class="i">+        });
</a><a href="#h36-0-785" id="h36-0-785" class="i">+
</a><a href="#h36-0-786" id="h36-0-786" class="i">+        calls.register(Call {
</a><a href="#h36-0-787" id="h36-0-787" class="i">+            id: vec![0xb0],
</a><a href="#h36-0-788" id="h36-0-788" class="i">+            from: None,
</a><a href="#h36-0-789" id="h36-0-789" class="i">+            operation: Operation::ReadState {
</a><a href="#h36-0-790" id="h36-0-790" class="i">+                command: vec![0x01],
</a><a href="#h36-0-791" id="h36-0-791" class="i">+                commit_index: 1,
</a><a href="#h36-0-792" id="h36-0-792" class="i">+                quorum: 3,
</a><a href="#h36-0-793" id="h36-0-793" class="i">+                votes: HashSet::new(),
</a><a href="#h36-0-794" id="h36-0-794" class="i">+            },
</a><a href="#h36-0-795" id="h36-0-795" class="i">+        });
</a><a href="#h36-0-796" id="h36-0-796" class="i">+        calls.register(Call {
</a><a href="#h36-0-797" id="h36-0-797" class="i">+            id: vec![0xb1],
</a><a href="#h36-0-798" id="h36-0-798" class="i">+            from: None,
</a><a href="#h36-0-799" id="h36-0-799" class="i">+            operation: Operation::ReadState {
</a><a href="#h36-0-800" id="h36-0-800" class="i">+                command: vec![0x02],
</a><a href="#h36-0-801" id="h36-0-801" class="i">+                commit_index: 2,
</a><a href="#h36-0-802" id="h36-0-802" class="i">+                quorum: 3,
</a><a href="#h36-0-803" id="h36-0-803" class="i">+                votes: HashSet::new(),
</a><a href="#h36-0-804" id="h36-0-804" class="i">+            },
</a><a href="#h36-0-805" id="h36-0-805" class="i">+        });
</a><a href="#h36-0-806" id="h36-0-806" class="i">+        calls.register(Call {
</a><a href="#h36-0-807" id="h36-0-807" class="i">+            id: vec![0xb2],
</a><a href="#h36-0-808" id="h36-0-808" class="i">+            from: None,
</a><a href="#h36-0-809" id="h36-0-809" class="i">+            operation: Operation::ReadState {
</a><a href="#h36-0-810" id="h36-0-810" class="i">+                command: vec![0x02],
</a><a href="#h36-0-811" id="h36-0-811" class="i">+                commit_index: 3,
</a><a href="#h36-0-812" id="h36-0-812" class="i">+                quorum: 3,
</a><a href="#h36-0-813" id="h36-0-813" class="i">+                votes: HashSet::new(),
</a><a href="#h36-0-814" id="h36-0-814" class="i">+            },
</a><a href="#h36-0-815" id="h36-0-815" class="i">+        });
</a><a href="#h36-0-816" id="h36-0-816" class="i">+        calls
</a><a href="#h36-0-817" id="h36-0-817" class="i">+    }
</a><a href="#h36-0-818" id="h36-0-818" class="i">+
</a><a href="#h36-0-819" id="h36-0-819" class="i">+    #[test]
</a><a href="#h36-0-820" id="h36-0-820" class="i">+    fn calls_log_applied() {
</a><a href="#h36-0-821" id="h36-0-821" class="i">+        let mut calls = setup_calls();
</a><a href="#h36-0-822" id="h36-0-822" class="i">+        assert_eq!(calls.log_applied(2).unwrap().id, vec![0xa2]);
</a><a href="#h36-0-823" id="h36-0-823" class="i">+        assert_eq!(calls.log_applied(2), None);
</a><a href="#h36-0-824" id="h36-0-824" class="i">+        assert_eq!(calls.log_applied(9), None);
</a><a href="#h36-0-825" id="h36-0-825" class="i">+    }
</a><a href="#h36-0-826" id="h36-0-826" class="i">+
</a><a href="#h36-0-827" id="h36-0-827" class="i">+    #[test]
</a><a href="#h36-0-828" id="h36-0-828" class="i">+    fn calls_quorum_vote() {
</a><a href="#h36-0-829" id="h36-0-829" class="i">+        let mut calls = setup_calls();
</a><a href="#h36-0-830" id="h36-0-830" class="i">+        // 0xb0=1 0xb1=1 0xb2=1
</a><a href="#h36-0-831" id="h36-0-831" class="i">+        assert_eq!(calls.quorum_vote(&quot;a&quot;, 3), vec![]);
</a><a href="#h36-0-832" id="h36-0-832" class="i">+        // 0xb0=2 0xb1=1 0xb2=1
</a><a href="#h36-0-833" id="h36-0-833" class="i">+        assert_eq!(calls.quorum_vote(&quot;b&quot;, 1), vec![]);
</a><a href="#h36-0-834" id="h36-0-834" class="i">+        // 0xb0=3 0xb1=2 0xb2=1
</a><a href="#h36-0-835" id="h36-0-835" class="i">+        assert_eq!(
</a><a href="#h36-0-836" id="h36-0-836" class="i">+            calls.quorum_vote(&quot;c&quot;, 2).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
</a><a href="#h36-0-837" id="h36-0-837" class="i">+            vec![vec![0xb0_u8]]
</a><a href="#h36-0-838" id="h36-0-838" class="i">+        );
</a><a href="#h36-0-839" id="h36-0-839" class="i">+        // 0xb1=3 0xb2=2
</a><a href="#h36-0-840" id="h36-0-840" class="i">+        assert_eq!(
</a><a href="#h36-0-841" id="h36-0-841" class="i">+            calls.quorum_vote(&quot;d&quot;, 4).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
</a><a href="#h36-0-842" id="h36-0-842" class="i">+            vec![vec![0xb1_u8]]
</a><a href="#h36-0-843" id="h36-0-843" class="i">+        );
</a><a href="#h36-0-844" id="h36-0-844" class="i">+        // 0xb2=3
</a><a href="#h36-0-845" id="h36-0-845" class="i">+        assert_eq!(
</a><a href="#h36-0-846" id="h36-0-846" class="i">+            calls.quorum_vote(&quot;e&quot;, 3).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
</a><a href="#h36-0-847" id="h36-0-847" class="i">+            vec![vec![0xb2_u8]]
</a><a href="#h36-0-848" id="h36-0-848" class="i">+        );
</a><a href="#h36-0-849" id="h36-0-849" class="i">+    }
</a><a href="#h36-0-850" id="h36-0-850" class="i">+
</a><a href="#h36-0-851" id="h36-0-851" class="i">+    #[test]
</a><a href="#h36-0-852" id="h36-0-852" class="i">+    fn calls_quorum_vote_multiple() {
</a><a href="#h36-0-853" id="h36-0-853" class="i">+        let mut calls = setup_calls();
</a><a href="#h36-0-854" id="h36-0-854" class="i">+        assert_eq!(calls.quorum_vote(&quot;a&quot;, 3), vec![]);
</a><a href="#h36-0-855" id="h36-0-855" class="i">+        assert_eq!(calls.quorum_vote(&quot;b&quot;, 3), vec![]);
</a><a href="#h36-0-856" id="h36-0-856" class="i">+        assert_eq!(
</a><a href="#h36-0-857" id="h36-0-857" class="i">+            calls.quorum_vote(&quot;c&quot;, 3).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
</a><a href="#h36-0-858" id="h36-0-858" class="i">+            vec![vec![0xb0_u8], vec![0xb1_u8], vec![0xb2_u8]]
</a><a href="#h36-0-859" id="h36-0-859" class="i">+        );
</a><a href="#h36-0-860" id="h36-0-860" class="i">+    }
</a><a href="#h36-0-861" id="h36-0-861" class="i">+
</a><a href="#h36-0-862" id="h36-0-862" class="i">+    #[test]
</a><a href="#h36-0-863" id="h36-0-863" class="i">+    fn calls_quorum_vote_same_voter_ignored() {
</a><a href="#h36-0-864" id="h36-0-864" class="i">+        let mut calls = setup_calls();
</a><a href="#h36-0-865" id="h36-0-865" class="i">+        assert_eq!(calls.quorum_vote(&quot;a&quot;, 1), vec![]);
</a><a href="#h36-0-866" id="h36-0-866" class="i">+        assert_eq!(calls.quorum_vote(&quot;a&quot;, 1), vec![]);
</a><a href="#h36-0-867" id="h36-0-867" class="i">+        assert_eq!(calls.quorum_vote(&quot;a&quot;, 1), vec![]);
</a><a href="#h36-0-868" id="h36-0-868" class="i">+        assert_eq!(calls.quorum_vote(&quot;b&quot;, 1), vec![]);
</a><a href="#h36-0-869" id="h36-0-869" class="i">+        assert_eq!(calls.quorum_vote(&quot;b&quot;, 1), vec![]);
</a><a href="#h36-0-870" id="h36-0-870" class="i">+        assert_eq!(calls.quorum_vote(&quot;b&quot;, 1), vec![]);
</a><a href="#h36-0-871" id="h36-0-871" class="i">+        assert_eq!(
</a><a href="#h36-0-872" id="h36-0-872" class="i">+            calls.quorum_vote(&quot;c&quot;, 1).into_iter().map(|c| c.id).collect::&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;(),
</a><a href="#h36-0-873" id="h36-0-873" class="i">+            vec![vec![0xb0_u8]]
</a><a href="#h36-0-874" id="h36-0-874" class="i">+        );
</a><a href="#h36-0-875" id="h36-0-875" class="i">+    }
</a><a href="#h36-0-876" id="h36-0-876" class="i">+}
</a><b>diff --git a/<a id="h37" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,470 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+mod candidate;
</a><a href="#h37-0-1" id="h37-0-1" class="i">+mod follower;
</a><a href="#h37-0-2" id="h37-0-2" class="i">+mod leader;
</a><a href="#h37-0-3" id="h37-0-3" class="i">+
</a><a href="#h37-0-4" id="h37-0-4" class="i">+use self::candidate::Candidate;
</a><a href="#h37-0-5" id="h37-0-5" class="i">+use self::follower::Follower;
</a><a href="#h37-0-6" id="h37-0-6" class="i">+use self::leader::Leader;
</a><a href="#h37-0-7" id="h37-0-7" class="i">+use super::log::{Entry, Log};
</a><a href="#h37-0-8" id="h37-0-8" class="i">+use super::state::State;
</a><a href="#h37-0-9" id="h37-0-9" class="i">+use super::transport::{Event, Message};
</a><a href="#h37-0-10" id="h37-0-10" class="i">+use crate::kv;
</a><a href="#h37-0-11" id="h37-0-11" class="i">+use crate::utility::OptionDeref;
</a><a href="#h37-0-12" id="h37-0-12" class="i">+use crate::Error;
</a><a href="#h37-0-13" id="h37-0-13" class="i">+use crossbeam_channel::Sender;
</a><a href="#h37-0-14" id="h37-0-14" class="i">+
</a><a href="#h37-0-15" id="h37-0-15" class="i">+/// The interval between leader heartbeats, in ticks.
</a><a href="#h37-0-16" id="h37-0-16" class="i">+const HEARTBEAT_INTERVAL: u64 = 1;
</a><a href="#h37-0-17" id="h37-0-17" class="i">+
</a><a href="#h37-0-18" id="h37-0-18" class="i">+/// The minimum election timeout, in ticks.
</a><a href="#h37-0-19" id="h37-0-19" class="i">+const ELECTION_TIMEOUT_MIN: u64 = 8 * HEARTBEAT_INTERVAL;
</a><a href="#h37-0-20" id="h37-0-20" class="i">+
</a><a href="#h37-0-21" id="h37-0-21" class="i">+/// The maximum election timeout, in ticks.
</a><a href="#h37-0-22" id="h37-0-22" class="i">+const ELECTION_TIMEOUT_MAX: u64 = 15 * HEARTBEAT_INTERVAL;
</a><a href="#h37-0-23" id="h37-0-23" class="i">+
</a><a href="#h37-0-24" id="h37-0-24" class="i">+/// The local Raft node state machine.
</a><a href="#h37-0-25" id="h37-0-25" class="i">+#[derive(Debug)]
</a><a href="#h37-0-26" id="h37-0-26" class="i">+pub enum Node {
</a><a href="#h37-0-27" id="h37-0-27" class="i">+    Candidate(RoleNode&lt;Candidate&gt;),
</a><a href="#h37-0-28" id="h37-0-28" class="i">+    Follower(RoleNode&lt;Follower&gt;),
</a><a href="#h37-0-29" id="h37-0-29" class="i">+    Leader(RoleNode&lt;Leader&gt;),
</a><a href="#h37-0-30" id="h37-0-30" class="i">+}
</a><a href="#h37-0-31" id="h37-0-31" class="i">+
</a><a href="#h37-0-32" id="h37-0-32" class="i">+impl Node {
</a><a href="#h37-0-33" id="h37-0-33" class="i">+    /// Creates a new Raft node, starting as a follower, or leader if no peers.
</a><a href="#h37-0-34" id="h37-0-34" class="i">+    pub fn new&lt;L: kv::Store, S: State&gt;(
</a><a href="#h37-0-35" id="h37-0-35" class="i">+        id: &amp;str,
</a><a href="#h37-0-36" id="h37-0-36" class="i">+        peers: Vec&lt;String&gt;,
</a><a href="#h37-0-37" id="h37-0-37" class="i">+        logstore: L,
</a><a href="#h37-0-38" id="h37-0-38" class="i">+        state: S,
</a><a href="#h37-0-39" id="h37-0-39" class="i">+        sender: Sender&lt;Message&gt;,
</a><a href="#h37-0-40" id="h37-0-40" class="i">+    ) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h37-0-41" id="h37-0-41" class="i">+        let log = Log::new(logstore)?;
</a><a href="#h37-0-42" id="h37-0-42" class="i">+        let (term, voted_for) = log.load_term()?;
</a><a href="#h37-0-43" id="h37-0-43" class="i">+        let node = RoleNode {
</a><a href="#h37-0-44" id="h37-0-44" class="i">+            id: id.to_owned(),
</a><a href="#h37-0-45" id="h37-0-45" class="i">+            peers,
</a><a href="#h37-0-46" id="h37-0-46" class="i">+            term,
</a><a href="#h37-0-47" id="h37-0-47" class="i">+            log,
</a><a href="#h37-0-48" id="h37-0-48" class="i">+            state: Box::new(state),
</a><a href="#h37-0-49" id="h37-0-49" class="i">+            sender,
</a><a href="#h37-0-50" id="h37-0-50" class="i">+            role: Follower::new(None, voted_for.as_deref()),
</a><a href="#h37-0-51" id="h37-0-51" class="i">+        };
</a><a href="#h37-0-52" id="h37-0-52" class="i">+        if node.peers.is_empty() {
</a><a href="#h37-0-53" id="h37-0-53" class="i">+            info!(&quot;No peers specified, starting as leader&quot;);
</a><a href="#h37-0-54" id="h37-0-54" class="i">+            let (last_index, _) = node.log.get_last();
</a><a href="#h37-0-55" id="h37-0-55" class="i">+            Ok(node.become_role(Leader::new(vec![], last_index))?.into())
</a><a href="#h37-0-56" id="h37-0-56" class="i">+        } else {
</a><a href="#h37-0-57" id="h37-0-57" class="i">+            Ok(node.into())
</a><a href="#h37-0-58" id="h37-0-58" class="i">+        }
</a><a href="#h37-0-59" id="h37-0-59" class="i">+    }
</a><a href="#h37-0-60" id="h37-0-60" class="i">+
</a><a href="#h37-0-61" id="h37-0-61" class="i">+    /// Processes a message.
</a><a href="#h37-0-62" id="h37-0-62" class="i">+    pub fn step(self, msg: Message) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h37-0-63" id="h37-0-63" class="i">+        debug!(&quot;Stepping {:?}&quot;, msg);
</a><a href="#h37-0-64" id="h37-0-64" class="i">+        match self {
</a><a href="#h37-0-65" id="h37-0-65" class="i">+            Node::Candidate(n) =&gt; n.step(msg),
</a><a href="#h37-0-66" id="h37-0-66" class="i">+            Node::Follower(n) =&gt; n.step(msg),
</a><a href="#h37-0-67" id="h37-0-67" class="i">+            Node::Leader(n) =&gt; n.step(msg),
</a><a href="#h37-0-68" id="h37-0-68" class="i">+        }
</a><a href="#h37-0-69" id="h37-0-69" class="i">+    }
</a><a href="#h37-0-70" id="h37-0-70" class="i">+
</a><a href="#h37-0-71" id="h37-0-71" class="i">+    /// Moves time forward by a tick.
</a><a href="#h37-0-72" id="h37-0-72" class="i">+    pub fn tick(self) -&gt; Result&lt;Node, Error&gt; {
</a><a href="#h37-0-73" id="h37-0-73" class="i">+        match self {
</a><a href="#h37-0-74" id="h37-0-74" class="i">+            Node::Candidate(n) =&gt; n.tick(),
</a><a href="#h37-0-75" id="h37-0-75" class="i">+            Node::Follower(n) =&gt; n.tick(),
</a><a href="#h37-0-76" id="h37-0-76" class="i">+            Node::Leader(n) =&gt; n.tick(),
</a><a href="#h37-0-77" id="h37-0-77" class="i">+        }
</a><a href="#h37-0-78" id="h37-0-78" class="i">+    }
</a><a href="#h37-0-79" id="h37-0-79" class="i">+}
</a><a href="#h37-0-80" id="h37-0-80" class="i">+
</a><a href="#h37-0-81" id="h37-0-81" class="i">+impl From&lt;RoleNode&lt;Candidate&gt;&gt; for Node {
</a><a href="#h37-0-82" id="h37-0-82" class="i">+    fn from(rn: RoleNode&lt;Candidate&gt;) -&gt; Self {
</a><a href="#h37-0-83" id="h37-0-83" class="i">+        Node::Candidate(rn)
</a><a href="#h37-0-84" id="h37-0-84" class="i">+    }
</a><a href="#h37-0-85" id="h37-0-85" class="i">+}
</a><a href="#h37-0-86" id="h37-0-86" class="i">+
</a><a href="#h37-0-87" id="h37-0-87" class="i">+impl From&lt;RoleNode&lt;Follower&gt;&gt; for Node {
</a><a href="#h37-0-88" id="h37-0-88" class="i">+    fn from(rn: RoleNode&lt;Follower&gt;) -&gt; Self {
</a><a href="#h37-0-89" id="h37-0-89" class="i">+        Node::Follower(rn)
</a><a href="#h37-0-90" id="h37-0-90" class="i">+    }
</a><a href="#h37-0-91" id="h37-0-91" class="i">+}
</a><a href="#h37-0-92" id="h37-0-92" class="i">+
</a><a href="#h37-0-93" id="h37-0-93" class="i">+impl From&lt;RoleNode&lt;Leader&gt;&gt; for Node {
</a><a href="#h37-0-94" id="h37-0-94" class="i">+    fn from(rn: RoleNode&lt;Leader&gt;) -&gt; Self {
</a><a href="#h37-0-95" id="h37-0-95" class="i">+        Node::Leader(rn)
</a><a href="#h37-0-96" id="h37-0-96" class="i">+    }
</a><a href="#h37-0-97" id="h37-0-97" class="i">+}
</a><a href="#h37-0-98" id="h37-0-98" class="i">+
</a><a href="#h37-0-99" id="h37-0-99" class="i">+// A Raft node with role R
</a><a href="#h37-0-100" id="h37-0-100" class="i">+#[derive(Debug)]
</a><a href="#h37-0-101" id="h37-0-101" class="i">+pub struct RoleNode&lt;R&gt; {
</a><a href="#h37-0-102" id="h37-0-102" class="i">+    id: String,
</a><a href="#h37-0-103" id="h37-0-103" class="i">+    peers: Vec&lt;String&gt;,
</a><a href="#h37-0-104" id="h37-0-104" class="i">+    term: u64,
</a><a href="#h37-0-105" id="h37-0-105" class="i">+    log: Log,
</a><a href="#h37-0-106" id="h37-0-106" class="i">+    state: Box&lt;State&gt;,
</a><a href="#h37-0-107" id="h37-0-107" class="i">+    sender: Sender&lt;Message&gt;,
</a><a href="#h37-0-108" id="h37-0-108" class="i">+    role: R,
</a><a href="#h37-0-109" id="h37-0-109" class="i">+}
</a><a href="#h37-0-110" id="h37-0-110" class="i">+
</a><a href="#h37-0-111" id="h37-0-111" class="i">+impl&lt;R&gt; RoleNode&lt;R&gt; {
</a><a href="#h37-0-112" id="h37-0-112" class="i">+    /// Transforms the node into another role.
</a><a href="#h37-0-113" id="h37-0-113" class="i">+    fn become_role&lt;T&gt;(self, role: T) -&gt; Result&lt;RoleNode&lt;T&gt;, Error&gt; {
</a><a href="#h37-0-114" id="h37-0-114" class="i">+        Ok(RoleNode {
</a><a href="#h37-0-115" id="h37-0-115" class="i">+            id: self.id,
</a><a href="#h37-0-116" id="h37-0-116" class="i">+            peers: self.peers,
</a><a href="#h37-0-117" id="h37-0-117" class="i">+            term: self.term,
</a><a href="#h37-0-118" id="h37-0-118" class="i">+            log: self.log,
</a><a href="#h37-0-119" id="h37-0-119" class="i">+            state: self.state,
</a><a href="#h37-0-120" id="h37-0-120" class="i">+            sender: self.sender,
</a><a href="#h37-0-121" id="h37-0-121" class="i">+            role,
</a><a href="#h37-0-122" id="h37-0-122" class="i">+        })
</a><a href="#h37-0-123" id="h37-0-123" class="i">+    }
</a><a href="#h37-0-124" id="h37-0-124" class="i">+
</a><a href="#h37-0-125" id="h37-0-125" class="i">+    /// Broadcasts an event to all peers.
</a><a href="#h37-0-126" id="h37-0-126" class="i">+    fn broadcast(&amp;self, event: Event) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h37-0-127" id="h37-0-127" class="i">+        for peer in self.peers.iter() {
</a><a href="#h37-0-128" id="h37-0-128" class="i">+            self.send(Some(peer), event.clone())?
</a><a href="#h37-0-129" id="h37-0-129" class="i">+        }
</a><a href="#h37-0-130" id="h37-0-130" class="i">+        Ok(())
</a><a href="#h37-0-131" id="h37-0-131" class="i">+    }
</a><a href="#h37-0-132" id="h37-0-132" class="i">+
</a><a href="#h37-0-133" id="h37-0-133" class="i">+    /// Normalizes and validates a message, ensuring it is addressed
</a><a href="#h37-0-134" id="h37-0-134" class="i">+    /// to the local node and term. On any errors it emits a warning and
</a><a href="#h37-0-135" id="h37-0-135" class="i">+    /// returns false.
</a><a href="#h37-0-136" id="h37-0-136" class="i">+    fn normalize_message(&amp;self, msg: &amp;mut Message) -&gt; bool {
</a><a href="#h37-0-137" id="h37-0-137" class="i">+        msg.normalize(&amp;self.id, self.term);
</a><a href="#h37-0-138" id="h37-0-138" class="i">+        if let Err(err) = msg.validate(&amp;self.id, self.term) {
</a><a href="#h37-0-139" id="h37-0-139" class="i">+            warn!(&quot;{}&quot;, err);
</a><a href="#h37-0-140" id="h37-0-140" class="i">+            false
</a><a href="#h37-0-141" id="h37-0-141" class="i">+        } else {
</a><a href="#h37-0-142" id="h37-0-142" class="i">+            true
</a><a href="#h37-0-143" id="h37-0-143" class="i">+        }
</a><a href="#h37-0-144" id="h37-0-144" class="i">+    }
</a><a href="#h37-0-145" id="h37-0-145" class="i">+
</a><a href="#h37-0-146" id="h37-0-146" class="i">+    /// Returns the quorum size of the cluster.
</a><a href="#h37-0-147" id="h37-0-147" class="i">+    fn quorum(&amp;self) -&gt; u64 {
</a><a href="#h37-0-148" id="h37-0-148" class="i">+        (self.peers.len() as u64 + 1) / 2 + 1
</a><a href="#h37-0-149" id="h37-0-149" class="i">+    }
</a><a href="#h37-0-150" id="h37-0-150" class="i">+
</a><a href="#h37-0-151" id="h37-0-151" class="i">+    /// Updates the current term and stores it in the log
</a><a href="#h37-0-152" id="h37-0-152" class="i">+    fn save_term(&amp;mut self, term: u64, voted_for: Option&lt;&amp;str&gt;) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h37-0-153" id="h37-0-153" class="i">+        self.log.save_term(term, voted_for)?;
</a><a href="#h37-0-154" id="h37-0-154" class="i">+        self.term = term;
</a><a href="#h37-0-155" id="h37-0-155" class="i">+        Ok(())
</a><a href="#h37-0-156" id="h37-0-156" class="i">+    }
</a><a href="#h37-0-157" id="h37-0-157" class="i">+
</a><a href="#h37-0-158" id="h37-0-158" class="i">+    /// Sends an event to a peer, or local caller if None
</a><a href="#h37-0-159" id="h37-0-159" class="i">+    fn send(&amp;self, to: Option&lt;&amp;str&gt;, event: Event) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h37-0-160" id="h37-0-160" class="i">+        let msg = Message {
</a><a href="#h37-0-161" id="h37-0-161" class="i">+            term: self.term,
</a><a href="#h37-0-162" id="h37-0-162" class="i">+            from: Some(self.id.clone()),
</a><a href="#h37-0-163" id="h37-0-163" class="i">+            to: to.map(str::to_owned),
</a><a href="#h37-0-164" id="h37-0-164" class="i">+            event,
</a><a href="#h37-0-165" id="h37-0-165" class="i">+        };
</a><a href="#h37-0-166" id="h37-0-166" class="i">+        debug!(&quot;Sending {:?}&quot;, msg);
</a><a href="#h37-0-167" id="h37-0-167" class="i">+        Ok(self.sender.send(msg)?)
</a><a href="#h37-0-168" id="h37-0-168" class="i">+    }
</a><a href="#h37-0-169" id="h37-0-169" class="i">+}
</a><a href="#h37-0-170" id="h37-0-170" class="i">+
</a><a href="#h37-0-171" id="h37-0-171" class="i">+#[cfg(test)]
</a><a href="#h37-0-172" id="h37-0-172" class="i">+mod tests {
</a><a href="#h37-0-173" id="h37-0-173" class="i">+    pub use super::super::tests::*;
</a><a href="#h37-0-174" id="h37-0-174" class="i">+    use super::follower::tests::{follower_leader, follower_voted_for};
</a><a href="#h37-0-175" id="h37-0-175" class="i">+    use super::*;
</a><a href="#h37-0-176" id="h37-0-176" class="i">+    use crossbeam_channel::Receiver;
</a><a href="#h37-0-177" id="h37-0-177" class="i">+
</a><a href="#h37-0-178" id="h37-0-178" class="i">+    pub struct NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h37-0-179" id="h37-0-179" class="i">+        node: &amp;&#39;a Node,
</a><a href="#h37-0-180" id="h37-0-180" class="i">+    }
</a><a href="#h37-0-181" id="h37-0-181" class="i">+
</a><a href="#h37-0-182" id="h37-0-182" class="i">+    impl&lt;&#39;a&gt; NodeAsserter&lt;&#39;a&gt; {
</a><a href="#h37-0-183" id="h37-0-183" class="i">+        pub fn new(node: &amp;&#39;a Node) -&gt; Self {
</a><a href="#h37-0-184" id="h37-0-184" class="i">+            Self { node }
</a><a href="#h37-0-185" id="h37-0-185" class="i">+        }
</a><a href="#h37-0-186" id="h37-0-186" class="i">+
</a><a href="#h37-0-187" id="h37-0-187" class="i">+        fn log(&amp;self) -&gt; &amp;&#39;a Log {
</a><a href="#h37-0-188" id="h37-0-188" class="i">+            match self.node {
</a><a href="#h37-0-189" id="h37-0-189" class="i">+                Node::Candidate(n) =&gt; &amp;n.log,
</a><a href="#h37-0-190" id="h37-0-190" class="i">+                Node::Follower(n) =&gt; &amp;n.log,
</a><a href="#h37-0-191" id="h37-0-191" class="i">+                Node::Leader(n) =&gt; &amp;n.log,
</a><a href="#h37-0-192" id="h37-0-192" class="i">+            }
</a><a href="#h37-0-193" id="h37-0-193" class="i">+        }
</a><a href="#h37-0-194" id="h37-0-194" class="i">+
</a><a href="#h37-0-195" id="h37-0-195" class="i">+        pub fn applied(self, index: u64) -&gt; Self {
</a><a href="#h37-0-196" id="h37-0-196" class="i">+            let (apply_index, _) = self.log().get_applied();
</a><a href="#h37-0-197" id="h37-0-197" class="i">+            assert_eq!(index, apply_index, &quot;Unexpected applied index&quot;);
</a><a href="#h37-0-198" id="h37-0-198" class="i">+            self
</a><a href="#h37-0-199" id="h37-0-199" class="i">+        }
</a><a href="#h37-0-200" id="h37-0-200" class="i">+
</a><a href="#h37-0-201" id="h37-0-201" class="i">+        pub fn committed(self, index: u64) -&gt; Self {
</a><a href="#h37-0-202" id="h37-0-202" class="i">+            let (commit_index, _) = self.log().get_committed();
</a><a href="#h37-0-203" id="h37-0-203" class="i">+            assert_eq!(index, commit_index, &quot;Unexpected committed index&quot;);
</a><a href="#h37-0-204" id="h37-0-204" class="i">+            self
</a><a href="#h37-0-205" id="h37-0-205" class="i">+        }
</a><a href="#h37-0-206" id="h37-0-206" class="i">+
</a><a href="#h37-0-207" id="h37-0-207" class="i">+        pub fn last(self, index: u64) -&gt; Self {
</a><a href="#h37-0-208" id="h37-0-208" class="i">+            let (last_index, _) = self.log().get_last();
</a><a href="#h37-0-209" id="h37-0-209" class="i">+            assert_eq!(index, last_index, &quot;Unexpected last index&quot;);
</a><a href="#h37-0-210" id="h37-0-210" class="i">+            self
</a><a href="#h37-0-211" id="h37-0-211" class="i">+        }
</a><a href="#h37-0-212" id="h37-0-212" class="i">+
</a><a href="#h37-0-213" id="h37-0-213" class="i">+        pub fn entry(self, index: u64, entry: Entry) -&gt; Self {
</a><a href="#h37-0-214" id="h37-0-214" class="i">+            let (last_index, _) = self.log().get_last();
</a><a href="#h37-0-215" id="h37-0-215" class="i">+            assert!(index &lt;= last_index, &quot;Index beyond last entry&quot;);
</a><a href="#h37-0-216" id="h37-0-216" class="i">+            assert_eq!(entry, self.log().get(index).unwrap().unwrap());
</a><a href="#h37-0-217" id="h37-0-217" class="i">+            self
</a><a href="#h37-0-218" id="h37-0-218" class="i">+        }
</a><a href="#h37-0-219" id="h37-0-219" class="i">+
</a><a href="#h37-0-220" id="h37-0-220" class="i">+        pub fn entries(self, entries: Vec&lt;Entry&gt;) -&gt; Self {
</a><a href="#h37-0-221" id="h37-0-221" class="i">+            assert_eq!(entries, self.log().range(0..).unwrap());
</a><a href="#h37-0-222" id="h37-0-222" class="i">+            self
</a><a href="#h37-0-223" id="h37-0-223" class="i">+        }
</a><a href="#h37-0-224" id="h37-0-224" class="i">+
</a><a href="#h37-0-225" id="h37-0-225" class="i">+        #[allow(clippy::wrong_self_convention)]
</a><a href="#h37-0-226" id="h37-0-226" class="i">+        pub fn is_candidate(self) -&gt; Self {
</a><a href="#h37-0-227" id="h37-0-227" class="i">+            match self.node {
</a><a href="#h37-0-228" id="h37-0-228" class="i">+                Node::Candidate(_) =&gt; self,
</a><a href="#h37-0-229" id="h37-0-229" class="i">+                Node::Follower(_) =&gt; panic!(&quot;Expected candidate, got follower&quot;),
</a><a href="#h37-0-230" id="h37-0-230" class="i">+                Node::Leader(_) =&gt; panic!(&quot;Expected candidate, got leader&quot;),
</a><a href="#h37-0-231" id="h37-0-231" class="i">+            }
</a><a href="#h37-0-232" id="h37-0-232" class="i">+        }
</a><a href="#h37-0-233" id="h37-0-233" class="i">+
</a><a href="#h37-0-234" id="h37-0-234" class="i">+        #[allow(clippy::wrong_self_convention)]
</a><a href="#h37-0-235" id="h37-0-235" class="i">+        pub fn is_follower(self) -&gt; Self {
</a><a href="#h37-0-236" id="h37-0-236" class="i">+            match self.node {
</a><a href="#h37-0-237" id="h37-0-237" class="i">+                Node::Candidate(_) =&gt; panic!(&quot;Expected follower, got candidate&quot;),
</a><a href="#h37-0-238" id="h37-0-238" class="i">+                Node::Follower(_) =&gt; self,
</a><a href="#h37-0-239" id="h37-0-239" class="i">+                Node::Leader(_) =&gt; panic!(&quot;Expected follower, got leader&quot;),
</a><a href="#h37-0-240" id="h37-0-240" class="i">+            }
</a><a href="#h37-0-241" id="h37-0-241" class="i">+        }
</a><a href="#h37-0-242" id="h37-0-242" class="i">+
</a><a href="#h37-0-243" id="h37-0-243" class="i">+        #[allow(clippy::wrong_self_convention)]
</a><a href="#h37-0-244" id="h37-0-244" class="i">+        pub fn is_leader(self) -&gt; Self {
</a><a href="#h37-0-245" id="h37-0-245" class="i">+            match self.node {
</a><a href="#h37-0-246" id="h37-0-246" class="i">+                Node::Candidate(_) =&gt; panic!(&quot;Expected leader, got candidate&quot;),
</a><a href="#h37-0-247" id="h37-0-247" class="i">+                Node::Follower(_) =&gt; panic!(&quot;Expected leader, got follower&quot;),
</a><a href="#h37-0-248" id="h37-0-248" class="i">+                Node::Leader(_) =&gt; self,
</a><a href="#h37-0-249" id="h37-0-249" class="i">+            }
</a><a href="#h37-0-250" id="h37-0-250" class="i">+        }
</a><a href="#h37-0-251" id="h37-0-251" class="i">+
</a><a href="#h37-0-252" id="h37-0-252" class="i">+        pub fn leader(self, leader: Option&lt;&amp;str&gt;) -&gt; Self {
</a><a href="#h37-0-253" id="h37-0-253" class="i">+            assert_eq!(
</a><a href="#h37-0-254" id="h37-0-254" class="i">+                leader.map(str::to_owned),
</a><a href="#h37-0-255" id="h37-0-255" class="i">+                match self.node {
</a><a href="#h37-0-256" id="h37-0-256" class="i">+                    Node::Candidate(_) =&gt; None,
</a><a href="#h37-0-257" id="h37-0-257" class="i">+                    Node::Follower(n) =&gt; follower_leader(n),
</a><a href="#h37-0-258" id="h37-0-258" class="i">+                    Node::Leader(_) =&gt; None,
</a><a href="#h37-0-259" id="h37-0-259" class="i">+                },
</a><a href="#h37-0-260" id="h37-0-260" class="i">+                &quot;Unexpected leader&quot;,
</a><a href="#h37-0-261" id="h37-0-261" class="i">+            );
</a><a href="#h37-0-262" id="h37-0-262" class="i">+            self
</a><a href="#h37-0-263" id="h37-0-263" class="i">+        }
</a><a href="#h37-0-264" id="h37-0-264" class="i">+
</a><a href="#h37-0-265" id="h37-0-265" class="i">+        pub fn term(self, term: u64) -&gt; Self {
</a><a href="#h37-0-266" id="h37-0-266" class="i">+            assert_eq!(
</a><a href="#h37-0-267" id="h37-0-267" class="i">+                term,
</a><a href="#h37-0-268" id="h37-0-268" class="i">+                match self.node {
</a><a href="#h37-0-269" id="h37-0-269" class="i">+                    Node::Candidate(n) =&gt; n.term,
</a><a href="#h37-0-270" id="h37-0-270" class="i">+                    Node::Follower(n) =&gt; n.term,
</a><a href="#h37-0-271" id="h37-0-271" class="i">+                    Node::Leader(n) =&gt; n.term,
</a><a href="#h37-0-272" id="h37-0-272" class="i">+                },
</a><a href="#h37-0-273" id="h37-0-273" class="i">+                &quot;Unexpected node term&quot;,
</a><a href="#h37-0-274" id="h37-0-274" class="i">+            );
</a><a href="#h37-0-275" id="h37-0-275" class="i">+            let (saved_term, saved_voted_for) = self.log().load_term().unwrap();
</a><a href="#h37-0-276" id="h37-0-276" class="i">+            assert_eq!(saved_term, term, &quot;Incorrect term stored in log&quot;);
</a><a href="#h37-0-277" id="h37-0-277" class="i">+            assert_eq!(
</a><a href="#h37-0-278" id="h37-0-278" class="i">+                saved_voted_for,
</a><a href="#h37-0-279" id="h37-0-279" class="i">+                match self.node {
</a><a href="#h37-0-280" id="h37-0-280" class="i">+                    Node::Candidate(_) =&gt; None,
</a><a href="#h37-0-281" id="h37-0-281" class="i">+                    Node::Follower(n) =&gt; follower_voted_for(n),
</a><a href="#h37-0-282" id="h37-0-282" class="i">+                    Node::Leader(_) =&gt; None,
</a><a href="#h37-0-283" id="h37-0-283" class="i">+                },
</a><a href="#h37-0-284" id="h37-0-284" class="i">+                &quot;Incorrect voted_for stored in log&quot;
</a><a href="#h37-0-285" id="h37-0-285" class="i">+            );
</a><a href="#h37-0-286" id="h37-0-286" class="i">+            self
</a><a href="#h37-0-287" id="h37-0-287" class="i">+        }
</a><a href="#h37-0-288" id="h37-0-288" class="i">+
</a><a href="#h37-0-289" id="h37-0-289" class="i">+        pub fn voted_for(self, voted_for: Option&lt;&amp;str&gt;) -&gt; Self {
</a><a href="#h37-0-290" id="h37-0-290" class="i">+            assert_eq!(
</a><a href="#h37-0-291" id="h37-0-291" class="i">+                voted_for.map(str::to_owned),
</a><a href="#h37-0-292" id="h37-0-292" class="i">+                match self.node {
</a><a href="#h37-0-293" id="h37-0-293" class="i">+                    Node::Candidate(_) =&gt; None,
</a><a href="#h37-0-294" id="h37-0-294" class="i">+                    Node::Follower(n) =&gt; follower_voted_for(n),
</a><a href="#h37-0-295" id="h37-0-295" class="i">+                    Node::Leader(_) =&gt; None,
</a><a href="#h37-0-296" id="h37-0-296" class="i">+                },
</a><a href="#h37-0-297" id="h37-0-297" class="i">+                &quot;Unexpected voted_for&quot;
</a><a href="#h37-0-298" id="h37-0-298" class="i">+            );
</a><a href="#h37-0-299" id="h37-0-299" class="i">+            let (_, saved_voted_for) = self.log().load_term().unwrap();
</a><a href="#h37-0-300" id="h37-0-300" class="i">+            assert_eq!(saved_voted_for.as_deref(), voted_for, &quot;Unexpected voted_for saved in log&quot;);
</a><a href="#h37-0-301" id="h37-0-301" class="i">+            self
</a><a href="#h37-0-302" id="h37-0-302" class="i">+        }
</a><a href="#h37-0-303" id="h37-0-303" class="i">+    }
</a><a href="#h37-0-304" id="h37-0-304" class="i">+
</a><a href="#h37-0-305" id="h37-0-305" class="i">+    pub fn assert_node(node: &amp;Node) -&gt; NodeAsserter {
</a><a href="#h37-0-306" id="h37-0-306" class="i">+        NodeAsserter::new(node)
</a><a href="#h37-0-307" id="h37-0-307" class="i">+    }
</a><a href="#h37-0-308" id="h37-0-308" class="i">+
</a><a href="#h37-0-309" id="h37-0-309" class="i">+    fn setup_rolenode() -&gt; (RoleNode&lt;()&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h37-0-310" id="h37-0-310" class="i">+        setup_rolenode_peers(vec![&quot;b&quot;.into(), &quot;c&quot;.into()])
</a><a href="#h37-0-311" id="h37-0-311" class="i">+    }
</a><a href="#h37-0-312" id="h37-0-312" class="i">+
</a><a href="#h37-0-313" id="h37-0-313" class="i">+    fn setup_rolenode_peers(peers: Vec&lt;String&gt;) -&gt; (RoleNode&lt;()&gt;, Receiver&lt;Message&gt;) {
</a><a href="#h37-0-314" id="h37-0-314" class="i">+        let (sender, receiver) = crossbeam_channel::unbounded();
</a><a href="#h37-0-315" id="h37-0-315" class="i">+        let node = RoleNode {
</a><a href="#h37-0-316" id="h37-0-316" class="i">+            role: (),
</a><a href="#h37-0-317" id="h37-0-317" class="i">+            id: &quot;a&quot;.into(),
</a><a href="#h37-0-318" id="h37-0-318" class="i">+            peers,
</a><a href="#h37-0-319" id="h37-0-319" class="i">+            term: 1,
</a><a href="#h37-0-320" id="h37-0-320" class="i">+            log: Log::new(kv::Memory::new()).unwrap(),
</a><a href="#h37-0-321" id="h37-0-321" class="i">+            state: TestState::new().boxed(),
</a><a href="#h37-0-322" id="h37-0-322" class="i">+            sender,
</a><a href="#h37-0-323" id="h37-0-323" class="i">+        };
</a><a href="#h37-0-324" id="h37-0-324" class="i">+        (node, receiver)
</a><a href="#h37-0-325" id="h37-0-325" class="i">+    }
</a><a href="#h37-0-326" id="h37-0-326" class="i">+
</a><a href="#h37-0-327" id="h37-0-327" class="i">+    #[test]
</a><a href="#h37-0-328" id="h37-0-328" class="i">+    fn new() {
</a><a href="#h37-0-329" id="h37-0-329" class="i">+        let (sender, _) = crossbeam_channel::unbounded();
</a><a href="#h37-0-330" id="h37-0-330" class="i">+        let node = Node::new(
</a><a href="#h37-0-331" id="h37-0-331" class="i">+            &quot;a&quot;,
</a><a href="#h37-0-332" id="h37-0-332" class="i">+            vec![&quot;b&quot;.into(), &quot;c&quot;.into()],
</a><a href="#h37-0-333" id="h37-0-333" class="i">+            kv::Memory::new(),
</a><a href="#h37-0-334" id="h37-0-334" class="i">+            TestState::new(),
</a><a href="#h37-0-335" id="h37-0-335" class="i">+            sender,
</a><a href="#h37-0-336" id="h37-0-336" class="i">+        )
</a><a href="#h37-0-337" id="h37-0-337" class="i">+        .unwrap();
</a><a href="#h37-0-338" id="h37-0-338" class="i">+        match node {
</a><a href="#h37-0-339" id="h37-0-339" class="i">+            Node::Follower(rolenode) =&gt; {
</a><a href="#h37-0-340" id="h37-0-340" class="i">+                assert_eq!(rolenode.id, &quot;a&quot;.to_owned());
</a><a href="#h37-0-341" id="h37-0-341" class="i">+                assert_eq!(rolenode.term, 0);
</a><a href="#h37-0-342" id="h37-0-342" class="i">+                assert_eq!(rolenode.peers, vec![&quot;b&quot;.to_owned(), &quot;c&quot;.to_owned()]);
</a><a href="#h37-0-343" id="h37-0-343" class="i">+            }
</a><a href="#h37-0-344" id="h37-0-344" class="i">+            _ =&gt; panic!(&quot;Expected node to start as follower&quot;),
</a><a href="#h37-0-345" id="h37-0-345" class="i">+        }
</a><a href="#h37-0-346" id="h37-0-346" class="i">+    }
</a><a href="#h37-0-347" id="h37-0-347" class="i">+
</a><a href="#h37-0-348" id="h37-0-348" class="i">+    #[test]
</a><a href="#h37-0-349" id="h37-0-349" class="i">+    fn new_loads_term() {
</a><a href="#h37-0-350" id="h37-0-350" class="i">+        let (sender, _) = crossbeam_channel::unbounded();
</a><a href="#h37-0-351" id="h37-0-351" class="i">+        let store = kv::Memory::new();
</a><a href="#h37-0-352" id="h37-0-352" class="i">+        Log::new(store.clone()).unwrap().save_term(3, Some(&quot;c&quot;)).unwrap();
</a><a href="#h37-0-353" id="h37-0-353" class="i">+        let node =
</a><a href="#h37-0-354" id="h37-0-354" class="i">+            Node::new(&quot;a&quot;, vec![&quot;b&quot;.into(), &quot;c&quot;.into()], store, TestState::new(), sender).unwrap();
</a><a href="#h37-0-355" id="h37-0-355" class="i">+        match node {
</a><a href="#h37-0-356" id="h37-0-356" class="i">+            Node::Follower(rolenode) =&gt; assert_eq!(rolenode.term, 3),
</a><a href="#h37-0-357" id="h37-0-357" class="i">+            _ =&gt; panic!(&quot;Expected node to start as follower&quot;),
</a><a href="#h37-0-358" id="h37-0-358" class="i">+        }
</a><a href="#h37-0-359" id="h37-0-359" class="i">+    }
</a><a href="#h37-0-360" id="h37-0-360" class="i">+
</a><a href="#h37-0-361" id="h37-0-361" class="i">+    #[test]
</a><a href="#h37-0-362" id="h37-0-362" class="i">+    fn new_single() {
</a><a href="#h37-0-363" id="h37-0-363" class="i">+        let (sender, _) = crossbeam_channel::unbounded();
</a><a href="#h37-0-364" id="h37-0-364" class="i">+        let node = Node::new(
</a><a href="#h37-0-365" id="h37-0-365" class="i">+            &quot;a&quot;,
</a><a href="#h37-0-366" id="h37-0-366" class="i">+            vec![],
</a><a href="#h37-0-367" id="h37-0-367" class="i">+            kv::Memory::new(),
</a><a href="#h37-0-368" id="h37-0-368" class="i">+            crate::state::State::new(kv::Memory::new()),
</a><a href="#h37-0-369" id="h37-0-369" class="i">+            sender,
</a><a href="#h37-0-370" id="h37-0-370" class="i">+        )
</a><a href="#h37-0-371" id="h37-0-371" class="i">+        .unwrap();
</a><a href="#h37-0-372" id="h37-0-372" class="i">+        match node {
</a><a href="#h37-0-373" id="h37-0-373" class="i">+            Node::Leader(rolenode) =&gt; {
</a><a href="#h37-0-374" id="h37-0-374" class="i">+                assert_eq!(rolenode.id, &quot;a&quot;.to_owned());
</a><a href="#h37-0-375" id="h37-0-375" class="i">+                assert_eq!(rolenode.term, 0);
</a><a href="#h37-0-376" id="h37-0-376" class="i">+                assert!(rolenode.peers.is_empty());
</a><a href="#h37-0-377" id="h37-0-377" class="i">+            }
</a><a href="#h37-0-378" id="h37-0-378" class="i">+            _ =&gt; panic!(&quot;Expected leader&quot;),
</a><a href="#h37-0-379" id="h37-0-379" class="i">+        }
</a><a href="#h37-0-380" id="h37-0-380" class="i">+    }
</a><a href="#h37-0-381" id="h37-0-381" class="i">+
</a><a href="#h37-0-382" id="h37-0-382" class="i">+    #[test]
</a><a href="#h37-0-383" id="h37-0-383" class="i">+    fn become_role() {
</a><a href="#h37-0-384" id="h37-0-384" class="i">+        let (node, _) = setup_rolenode();
</a><a href="#h37-0-385" id="h37-0-385" class="i">+        let new = node.become_role(&quot;role&quot;).unwrap();
</a><a href="#h37-0-386" id="h37-0-386" class="i">+        assert_eq!(new.id, &quot;a&quot;.to_owned());
</a><a href="#h37-0-387" id="h37-0-387" class="i">+        assert_eq!(new.term, 1);
</a><a href="#h37-0-388" id="h37-0-388" class="i">+        assert_eq!(new.peers, vec![&quot;b&quot;.to_owned(), &quot;c&quot;.to_owned()]);
</a><a href="#h37-0-389" id="h37-0-389" class="i">+        assert_eq!(new.role, &quot;role&quot;);
</a><a href="#h37-0-390" id="h37-0-390" class="i">+    }
</a><a href="#h37-0-391" id="h37-0-391" class="i">+
</a><a href="#h37-0-392" id="h37-0-392" class="i">+    #[test]
</a><a href="#h37-0-393" id="h37-0-393" class="i">+    fn broadcast() {
</a><a href="#h37-0-394" id="h37-0-394" class="i">+        let (node, rx) = setup_rolenode();
</a><a href="#h37-0-395" id="h37-0-395" class="i">+        node.broadcast(Event::Heartbeat { commit_index: 1, commit_term: 1 }).unwrap();
</a><a href="#h37-0-396" id="h37-0-396" class="i">+
</a><a href="#h37-0-397" id="h37-0-397" class="i">+        for to in [&quot;b&quot;, &quot;c&quot;].iter().cloned() {
</a><a href="#h37-0-398" id="h37-0-398" class="i">+            assert!(!rx.is_empty());
</a><a href="#h37-0-399" id="h37-0-399" class="i">+            assert_eq!(
</a><a href="#h37-0-400" id="h37-0-400" class="i">+                rx.recv().unwrap(),
</a><a href="#h37-0-401" id="h37-0-401" class="i">+                Message {
</a><a href="#h37-0-402" id="h37-0-402" class="i">+                    from: Some(&quot;a&quot;.into()),
</a><a href="#h37-0-403" id="h37-0-403" class="i">+                    to: Some(to.into()),
</a><a href="#h37-0-404" id="h37-0-404" class="i">+                    term: 1,
</a><a href="#h37-0-405" id="h37-0-405" class="i">+                    event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h37-0-406" id="h37-0-406" class="i">+                },
</a><a href="#h37-0-407" id="h37-0-407" class="i">+            )
</a><a href="#h37-0-408" id="h37-0-408" class="i">+        }
</a><a href="#h37-0-409" id="h37-0-409" class="i">+        assert!(rx.is_empty());
</a><a href="#h37-0-410" id="h37-0-410" class="i">+    }
</a><a href="#h37-0-411" id="h37-0-411" class="i">+
</a><a href="#h37-0-412" id="h37-0-412" class="i">+    #[test]
</a><a href="#h37-0-413" id="h37-0-413" class="i">+    fn normalize_message() {
</a><a href="#h37-0-414" id="h37-0-414" class="i">+        let (node, _) = setup_rolenode();
</a><a href="#h37-0-415" id="h37-0-415" class="i">+        let mut msg = Message {
</a><a href="#h37-0-416" id="h37-0-416" class="i">+            from: None,
</a><a href="#h37-0-417" id="h37-0-417" class="i">+            to: None,
</a><a href="#h37-0-418" id="h37-0-418" class="i">+            term: 0,
</a><a href="#h37-0-419" id="h37-0-419" class="i">+            event: Event::ReadState { call_id: vec![], command: vec![] },
</a><a href="#h37-0-420" id="h37-0-420" class="i">+        };
</a><a href="#h37-0-421" id="h37-0-421" class="i">+        assert!(node.normalize_message(&amp;mut msg));
</a><a href="#h37-0-422" id="h37-0-422" class="i">+        assert_eq!(
</a><a href="#h37-0-423" id="h37-0-423" class="i">+            msg,
</a><a href="#h37-0-424" id="h37-0-424" class="i">+            Message {
</a><a href="#h37-0-425" id="h37-0-425" class="i">+                from: None,
</a><a href="#h37-0-426" id="h37-0-426" class="i">+                to: Some(&quot;a&quot;.into()),
</a><a href="#h37-0-427" id="h37-0-427" class="i">+                term: 1,
</a><a href="#h37-0-428" id="h37-0-428" class="i">+                event: Event::ReadState { call_id: vec![], command: vec![] },
</a><a href="#h37-0-429" id="h37-0-429" class="i">+            }
</a><a href="#h37-0-430" id="h37-0-430" class="i">+        );
</a><a href="#h37-0-431" id="h37-0-431" class="i">+
</a><a href="#h37-0-432" id="h37-0-432" class="i">+        msg.to = Some(&quot;c&quot;.into());
</a><a href="#h37-0-433" id="h37-0-433" class="i">+        assert!(!node.normalize_message(&amp;mut msg));
</a><a href="#h37-0-434" id="h37-0-434" class="i">+    }
</a><a href="#h37-0-435" id="h37-0-435" class="i">+
</a><a href="#h37-0-436" id="h37-0-436" class="i">+    #[test]
</a><a href="#h37-0-437" id="h37-0-437" class="i">+    fn quorum() {
</a><a href="#h37-0-438" id="h37-0-438" class="i">+        let quorums = vec![(1, 1), (2, 2), (3, 2), (4, 3), (5, 3), (6, 4), (7, 4), (8, 5)];
</a><a href="#h37-0-439" id="h37-0-439" class="i">+        for (size, quorum) in quorums.into_iter() {
</a><a href="#h37-0-440" id="h37-0-440" class="i">+            let peers: Vec&lt;String&gt; =
</a><a href="#h37-0-441" id="h37-0-441" class="i">+                (0..(size as u8 - 1)).map(|i| (i as char).to_string()).collect();
</a><a href="#h37-0-442" id="h37-0-442" class="i">+            assert_eq!(peers.len(), size as usize - 1);
</a><a href="#h37-0-443" id="h37-0-443" class="i">+            let (node, _) = setup_rolenode_peers(peers);
</a><a href="#h37-0-444" id="h37-0-444" class="i">+            assert_eq!(node.quorum(), quorum);
</a><a href="#h37-0-445" id="h37-0-445" class="i">+        }
</a><a href="#h37-0-446" id="h37-0-446" class="i">+    }
</a><a href="#h37-0-447" id="h37-0-447" class="i">+
</a><a href="#h37-0-448" id="h37-0-448" class="i">+    #[test]
</a><a href="#h37-0-449" id="h37-0-449" class="i">+    fn send() {
</a><a href="#h37-0-450" id="h37-0-450" class="i">+        let (node, rx) = setup_rolenode();
</a><a href="#h37-0-451" id="h37-0-451" class="i">+        node.send(Some(&quot;b&quot;), Event::Heartbeat { commit_index: 1, commit_term: 1 }).unwrap();
</a><a href="#h37-0-452" id="h37-0-452" class="i">+        assert_messages(
</a><a href="#h37-0-453" id="h37-0-453" class="i">+            &amp;rx,
</a><a href="#h37-0-454" id="h37-0-454" class="i">+            vec![Message {
</a><a href="#h37-0-455" id="h37-0-455" class="i">+                from: Some(&quot;a&quot;.into()),
</a><a href="#h37-0-456" id="h37-0-456" class="i">+                to: Some(&quot;b&quot;.into()),
</a><a href="#h37-0-457" id="h37-0-457" class="i">+                term: 1,
</a><a href="#h37-0-458" id="h37-0-458" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h37-0-459" id="h37-0-459" class="i">+            }],
</a><a href="#h37-0-460" id="h37-0-460" class="i">+        );
</a><a href="#h37-0-461" id="h37-0-461" class="i">+    }
</a><a href="#h37-0-462" id="h37-0-462" class="i">+
</a><a href="#h37-0-463" id="h37-0-463" class="i">+    #[test]
</a><a href="#h37-0-464" id="h37-0-464" class="i">+    fn save_term() {
</a><a href="#h37-0-465" id="h37-0-465" class="i">+        let (mut node, _) = setup_rolenode();
</a><a href="#h37-0-466" id="h37-0-466" class="i">+        node.save_term(4, Some(&quot;b&quot;)).unwrap();
</a><a href="#h37-0-467" id="h37-0-467" class="i">+        assert_eq!(node.log.load_term().unwrap(), (4, Some(&quot;b&quot;.into())));
</a><a href="#h37-0-468" id="h37-0-468" class="i">+    }
</a><a href="#h37-0-469" id="h37-0-469" class="i">+}
</a><b>diff --git a/<a id="h38" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h38-0" id="h38-0" class="h">@@ -0,0 +1,10 @@
</a><a href="#h38-0-0" id="h38-0-0" class="i">+use crate::Error;
</a><a href="#h38-0-1" id="h38-0-1" class="i">+
</a><a href="#h38-0-2" id="h38-0-2" class="i">+/// A Raft-managed state machine.
</a><a href="#h38-0-3" id="h38-0-3" class="i">+pub trait State: &#39;static + Sync + Send + std::fmt::Debug {
</a><a href="#h38-0-4" id="h38-0-4" class="i">+    /// Reads from the state machine.
</a><a href="#h38-0-5" id="h38-0-5" class="i">+    fn read(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h38-0-6" id="h38-0-6" class="i">+
</a><a href="#h38-0-7" id="h38-0-7" class="i">+    /// Mutates the state machine.
</a><a href="#h38-0-8" id="h38-0-8" class="i">+    fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h38-0-9" id="h38-0-9" class="i">+}
</a><b>diff --git a/<a id="h39" href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a> b/<a href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a></b>
<a href="#h39-0" id="h39-0" class="h">@@ -0,0 +1,223 @@
</a><a href="#h39-0-0" id="h39-0-0" class="i">+use super::log::Entry;
</a><a href="#h39-0-1" id="h39-0-1" class="i">+use crate::Error;
</a><a href="#h39-0-2" id="h39-0-2" class="i">+use crossbeam_channel::Receiver;
</a><a href="#h39-0-3" id="h39-0-3" class="i">+
</a><a href="#h39-0-4" id="h39-0-4" class="i">+/// A transport for communication between a Raft node and its peers.
</a><a href="#h39-0-5" id="h39-0-5" class="i">+pub trait Transport: &#39;static + Sync + Send {
</a><a href="#h39-0-6" id="h39-0-6" class="i">+    /// Returns a channel for receiving inbound messages.
</a><a href="#h39-0-7" id="h39-0-7" class="i">+    fn receiver(&amp;self) -&gt; Receiver&lt;Message&gt;;
</a><a href="#h39-0-8" id="h39-0-8" class="i">+
</a><a href="#h39-0-9" id="h39-0-9" class="i">+    /// Sends a message to a peer.
</a><a href="#h39-0-10" id="h39-0-10" class="i">+    fn send(&amp;self, msg: Message) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h39-0-11" id="h39-0-11" class="i">+}
</a><a href="#h39-0-12" id="h39-0-12" class="i">+
</a><a href="#h39-0-13" id="h39-0-13" class="i">+/// A message passed between Raft nodes.
</a><a href="#h39-0-14" id="h39-0-14" class="i">+#[derive(Debug, PartialEq)]
</a><a href="#h39-0-15" id="h39-0-15" class="i">+pub struct Message {
</a><a href="#h39-0-16" id="h39-0-16" class="i">+    /// The current term of the sender.
</a><a href="#h39-0-17" id="h39-0-17" class="i">+    pub term: u64,
</a><a href="#h39-0-18" id="h39-0-18" class="i">+    /// The ID of the sending node, or None if local sender.
</a><a href="#h39-0-19" id="h39-0-19" class="i">+    pub from: Option&lt;String&gt;,
</a><a href="#h39-0-20" id="h39-0-20" class="i">+    /// The ID of the receiving node, or None if local receiver.
</a><a href="#h39-0-21" id="h39-0-21" class="i">+    pub to: Option&lt;String&gt;,
</a><a href="#h39-0-22" id="h39-0-22" class="i">+    /// The message event.
</a><a href="#h39-0-23" id="h39-0-23" class="i">+    pub event: Event,
</a><a href="#h39-0-24" id="h39-0-24" class="i">+}
</a><a href="#h39-0-25" id="h39-0-25" class="i">+
</a><a href="#h39-0-26" id="h39-0-26" class="i">+impl Message {
</a><a href="#h39-0-27" id="h39-0-27" class="i">+    /// Normalizes a message by setting to and term for local messages.
</a><a href="#h39-0-28" id="h39-0-28" class="i">+    pub fn normalize(&amp;mut self, node_id: &amp;str, term: u64) {
</a><a href="#h39-0-29" id="h39-0-29" class="i">+        if self.from.is_none() &amp;&amp; self.to.is_none() {
</a><a href="#h39-0-30" id="h39-0-30" class="i">+            self.to = Some(node_id.to_owned());
</a><a href="#h39-0-31" id="h39-0-31" class="i">+            if self.term == 0 {
</a><a href="#h39-0-32" id="h39-0-32" class="i">+                self.term = term;
</a><a href="#h39-0-33" id="h39-0-33" class="i">+            }
</a><a href="#h39-0-34" id="h39-0-34" class="i">+        }
</a><a href="#h39-0-35" id="h39-0-35" class="i">+    }
</a><a href="#h39-0-36" id="h39-0-36" class="i">+
</a><a href="#h39-0-37" id="h39-0-37" class="i">+    /// Validates a message against the receiving node.
</a><a href="#h39-0-38" id="h39-0-38" class="i">+    pub fn validate(&amp;self, node_id: &amp;str, term: u64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h39-0-39" id="h39-0-39" class="i">+        // Don&#39;t allow local messages without call ID
</a><a href="#h39-0-40" id="h39-0-40" class="i">+        if self.from.is_none() &amp;&amp; self.event.call_id().is_none() {
</a><a href="#h39-0-41" id="h39-0-41" class="i">+            return Err(Error::Network(format!(&quot;Received local non-call event: {:?}&quot;, self.event)));
</a><a href="#h39-0-42" id="h39-0-42" class="i">+        }
</a><a href="#h39-0-43" id="h39-0-43" class="i">+
</a><a href="#h39-0-44" id="h39-0-44" class="i">+        // Ignore messages from past term
</a><a href="#h39-0-45" id="h39-0-45" class="i">+        if self.term &lt; term {
</a><a href="#h39-0-46" id="h39-0-46" class="i">+            return Err(Error::Network(format!(&quot;Ignoring message from stale term {}&quot;, self.term)));
</a><a href="#h39-0-47" id="h39-0-47" class="i">+        }
</a><a href="#h39-0-48" id="h39-0-48" class="i">+
</a><a href="#h39-0-49" id="h39-0-49" class="i">+        // Ignore messages addressed to peers or local client
</a><a href="#h39-0-50" id="h39-0-50" class="i">+        if let Some(to) = &amp;self.to {
</a><a href="#h39-0-51" id="h39-0-51" class="i">+            if to != node_id {
</a><a href="#h39-0-52" id="h39-0-52" class="i">+                return Err(Error::Network(format!(&quot;Ignoring message for other node {}&quot;, to)));
</a><a href="#h39-0-53" id="h39-0-53" class="i">+            }
</a><a href="#h39-0-54" id="h39-0-54" class="i">+        } else {
</a><a href="#h39-0-55" id="h39-0-55" class="i">+            return Err(Error::Network(&quot;Ignoring message for local client&quot;.into()));
</a><a href="#h39-0-56" id="h39-0-56" class="i">+        }
</a><a href="#h39-0-57" id="h39-0-57" class="i">+        Ok(())
</a><a href="#h39-0-58" id="h39-0-58" class="i">+    }
</a><a href="#h39-0-59" id="h39-0-59" class="i">+}
</a><a href="#h39-0-60" id="h39-0-60" class="i">+
</a><a href="#h39-0-61" id="h39-0-61" class="i">+/// An event contained within messages.
</a><a href="#h39-0-62" id="h39-0-62" class="i">+#[derive(Clone, Debug, PartialEq)]
</a><a href="#h39-0-63" id="h39-0-63" class="i">+pub enum Event {
</a><a href="#h39-0-64" id="h39-0-64" class="i">+    /// Leaders send periodic heartbeats to its followers.
</a><a href="#h39-0-65" id="h39-0-65" class="i">+    Heartbeat {
</a><a href="#h39-0-66" id="h39-0-66" class="i">+        /// The index of the leader&#39;s last committed log entry.
</a><a href="#h39-0-67" id="h39-0-67" class="i">+        commit_index: u64,
</a><a href="#h39-0-68" id="h39-0-68" class="i">+        /// The term of the leader&#39;s last committed log entry.
</a><a href="#h39-0-69" id="h39-0-69" class="i">+        commit_term: u64,
</a><a href="#h39-0-70" id="h39-0-70" class="i">+    },
</a><a href="#h39-0-71" id="h39-0-71" class="i">+    /// Followers confirm loyalty to leader after heartbeats.
</a><a href="#h39-0-72" id="h39-0-72" class="i">+    ConfirmLeader {
</a><a href="#h39-0-73" id="h39-0-73" class="i">+        /// The commit_index of the original leader heartbeat, to confirm
</a><a href="#h39-0-74" id="h39-0-74" class="i">+        /// read requests.
</a><a href="#h39-0-75" id="h39-0-75" class="i">+        commit_index: u64,
</a><a href="#h39-0-76" id="h39-0-76" class="i">+        /// If false, the follower does not have the entry at commit_index
</a><a href="#h39-0-77" id="h39-0-77" class="i">+        /// and would like the leader to replicate it.
</a><a href="#h39-0-78" id="h39-0-78" class="i">+        has_committed: bool,
</a><a href="#h39-0-79" id="h39-0-79" class="i">+    },
</a><a href="#h39-0-80" id="h39-0-80" class="i">+    /// Candidates solicit votes from all peers.
</a><a href="#h39-0-81" id="h39-0-81" class="i">+    SolicitVote {
</a><a href="#h39-0-82" id="h39-0-82" class="i">+        // The index of the candidate&#39;s last stored log entry
</a><a href="#h39-0-83" id="h39-0-83" class="i">+        last_index: u64,
</a><a href="#h39-0-84" id="h39-0-84" class="i">+        // The term of the candidate&#39;s last stored log entry
</a><a href="#h39-0-85" id="h39-0-85" class="i">+        last_term: u64,
</a><a href="#h39-0-86" id="h39-0-86" class="i">+    },
</a><a href="#h39-0-87" id="h39-0-87" class="i">+    /// Followers may grant votes to candidates.
</a><a href="#h39-0-88" id="h39-0-88" class="i">+    GrantVote,
</a><a href="#h39-0-89" id="h39-0-89" class="i">+    /// Leaders replicate a set of log entries to followers.
</a><a href="#h39-0-90" id="h39-0-90" class="i">+    ReplicateEntries {
</a><a href="#h39-0-91" id="h39-0-91" class="i">+        /// The index of the log entry immediately preceding the submitted commands.
</a><a href="#h39-0-92" id="h39-0-92" class="i">+        base_index: u64,
</a><a href="#h39-0-93" id="h39-0-93" class="i">+        /// The term of the log entry immediately preceding the submitted commands.
</a><a href="#h39-0-94" id="h39-0-94" class="i">+        base_term: u64,
</a><a href="#h39-0-95" id="h39-0-95" class="i">+        /// Commands to replicate.
</a><a href="#h39-0-96" id="h39-0-96" class="i">+        entries: Vec&lt;Entry&gt;,
</a><a href="#h39-0-97" id="h39-0-97" class="i">+    },
</a><a href="#h39-0-98" id="h39-0-98" class="i">+    /// Followers may accept a set of log entries from a leader.
</a><a href="#h39-0-99" id="h39-0-99" class="i">+    AcceptEntries {
</a><a href="#h39-0-100" id="h39-0-100" class="i">+        /// The index of the last log entry.
</a><a href="#h39-0-101" id="h39-0-101" class="i">+        last_index: u64,
</a><a href="#h39-0-102" id="h39-0-102" class="i">+    },
</a><a href="#h39-0-103" id="h39-0-103" class="i">+    /// Followers may also reject a set of log entries from a leader.
</a><a href="#h39-0-104" id="h39-0-104" class="i">+    RejectEntries,
</a><a href="#h39-0-105" id="h39-0-105" class="i">+    /// Reads from the state machine.
</a><a href="#h39-0-106" id="h39-0-106" class="i">+    ReadState {
</a><a href="#h39-0-107" id="h39-0-107" class="i">+        /// The call ID.
</a><a href="#h39-0-108" id="h39-0-108" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h39-0-109" id="h39-0-109" class="i">+        /// The state machine command.
</a><a href="#h39-0-110" id="h39-0-110" class="i">+        command: Vec&lt;u8&gt;,
</a><a href="#h39-0-111" id="h39-0-111" class="i">+    },
</a><a href="#h39-0-112" id="h39-0-112" class="i">+    /// Mutates the state machine.
</a><a href="#h39-0-113" id="h39-0-113" class="i">+    MutateState {
</a><a href="#h39-0-114" id="h39-0-114" class="i">+        /// The call ID.
</a><a href="#h39-0-115" id="h39-0-115" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h39-0-116" id="h39-0-116" class="i">+        /// The state machine command.
</a><a href="#h39-0-117" id="h39-0-117" class="i">+        command: Vec&lt;u8&gt;,
</a><a href="#h39-0-118" id="h39-0-118" class="i">+    },
</a><a href="#h39-0-119" id="h39-0-119" class="i">+    /// The response of a state machine command.
</a><a href="#h39-0-120" id="h39-0-120" class="i">+    RespondState {
</a><a href="#h39-0-121" id="h39-0-121" class="i">+        /// The call ID.
</a><a href="#h39-0-122" id="h39-0-122" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h39-0-123" id="h39-0-123" class="i">+        /// The command output.
</a><a href="#h39-0-124" id="h39-0-124" class="i">+        response: Vec&lt;u8&gt;,
</a><a href="#h39-0-125" id="h39-0-125" class="i">+    },
</a><a href="#h39-0-126" id="h39-0-126" class="i">+    /// An error response
</a><a href="#h39-0-127" id="h39-0-127" class="i">+    RespondError {
</a><a href="#h39-0-128" id="h39-0-128" class="i">+        /// The call ID.
</a><a href="#h39-0-129" id="h39-0-129" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h39-0-130" id="h39-0-130" class="i">+        /// The error.
</a><a href="#h39-0-131" id="h39-0-131" class="i">+        error: String,
</a><a href="#h39-0-132" id="h39-0-132" class="i">+    },
</a><a href="#h39-0-133" id="h39-0-133" class="i">+}
</a><a href="#h39-0-134" id="h39-0-134" class="i">+
</a><a href="#h39-0-135" id="h39-0-135" class="i">+impl Event {
</a><a href="#h39-0-136" id="h39-0-136" class="i">+    /// Returns the call ID for the event, if any
</a><a href="#h39-0-137" id="h39-0-137" class="i">+    pub fn call_id(&amp;self) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h39-0-138" id="h39-0-138" class="i">+        match self {
</a><a href="#h39-0-139" id="h39-0-139" class="i">+            Event::ReadState { call_id, .. }
</a><a href="#h39-0-140" id="h39-0-140" class="i">+            | Event::MutateState { call_id, .. }
</a><a href="#h39-0-141" id="h39-0-141" class="i">+            | Event::RespondState { call_id, .. }
</a><a href="#h39-0-142" id="h39-0-142" class="i">+            | Event::RespondError { call_id, .. } =&gt; Some(call_id.clone()),
</a><a href="#h39-0-143" id="h39-0-143" class="i">+            _ =&gt; None,
</a><a href="#h39-0-144" id="h39-0-144" class="i">+        }
</a><a href="#h39-0-145" id="h39-0-145" class="i">+    }
</a><a href="#h39-0-146" id="h39-0-146" class="i">+}
</a><a href="#h39-0-147" id="h39-0-147" class="i">+
</a><a href="#h39-0-148" id="h39-0-148" class="i">+#[cfg(test)]
</a><a href="#h39-0-149" id="h39-0-149" class="i">+mod tests {
</a><a href="#h39-0-150" id="h39-0-150" class="i">+    use super::*;
</a><a href="#h39-0-151" id="h39-0-151" class="i">+
</a><a href="#h39-0-152" id="h39-0-152" class="i">+    #[test]
</a><a href="#h39-0-153" id="h39-0-153" class="i">+    fn normalize() {
</a><a href="#h39-0-154" id="h39-0-154" class="i">+        let mut msg = Message {
</a><a href="#h39-0-155" id="h39-0-155" class="i">+            from: None,
</a><a href="#h39-0-156" id="h39-0-156" class="i">+            to: None,
</a><a href="#h39-0-157" id="h39-0-157" class="i">+            term: 0,
</a><a href="#h39-0-158" id="h39-0-158" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h39-0-159" id="h39-0-159" class="i">+        };
</a><a href="#h39-0-160" id="h39-0-160" class="i">+        msg.normalize(&quot;to&quot;, 3);
</a><a href="#h39-0-161" id="h39-0-161" class="i">+        assert_eq!(
</a><a href="#h39-0-162" id="h39-0-162" class="i">+            msg,
</a><a href="#h39-0-163" id="h39-0-163" class="i">+            Message {
</a><a href="#h39-0-164" id="h39-0-164" class="i">+                from: None,
</a><a href="#h39-0-165" id="h39-0-165" class="i">+                to: Some(&quot;to&quot;.into()),
</a><a href="#h39-0-166" id="h39-0-166" class="i">+                term: 3,
</a><a href="#h39-0-167" id="h39-0-167" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h39-0-168" id="h39-0-168" class="i">+            }
</a><a href="#h39-0-169" id="h39-0-169" class="i">+        )
</a><a href="#h39-0-170" id="h39-0-170" class="i">+    }
</a><a href="#h39-0-171" id="h39-0-171" class="i">+
</a><a href="#h39-0-172" id="h39-0-172" class="i">+    #[test]
</a><a href="#h39-0-173" id="h39-0-173" class="i">+    fn normalize_peer() {
</a><a href="#h39-0-174" id="h39-0-174" class="i">+        let mut msg = Message {
</a><a href="#h39-0-175" id="h39-0-175" class="i">+            from: Some(&quot;from&quot;.into()),
</a><a href="#h39-0-176" id="h39-0-176" class="i">+            to: Some(&quot;to&quot;.into()),
</a><a href="#h39-0-177" id="h39-0-177" class="i">+            term: 3,
</a><a href="#h39-0-178" id="h39-0-178" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h39-0-179" id="h39-0-179" class="i">+        };
</a><a href="#h39-0-180" id="h39-0-180" class="i">+        msg.normalize(&quot;other&quot;, 7);
</a><a href="#h39-0-181" id="h39-0-181" class="i">+        assert_eq!(
</a><a href="#h39-0-182" id="h39-0-182" class="i">+            msg,
</a><a href="#h39-0-183" id="h39-0-183" class="i">+            Message {
</a><a href="#h39-0-184" id="h39-0-184" class="i">+                from: Some(&quot;from&quot;.into()),
</a><a href="#h39-0-185" id="h39-0-185" class="i">+                to: Some(&quot;to&quot;.into()),
</a><a href="#h39-0-186" id="h39-0-186" class="i">+                term: 3,
</a><a href="#h39-0-187" id="h39-0-187" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h39-0-188" id="h39-0-188" class="i">+            }
</a><a href="#h39-0-189" id="h39-0-189" class="i">+        )
</a><a href="#h39-0-190" id="h39-0-190" class="i">+    }
</a><a href="#h39-0-191" id="h39-0-191" class="i">+
</a><a href="#h39-0-192" id="h39-0-192" class="i">+    #[test]
</a><a href="#h39-0-193" id="h39-0-193" class="i">+    fn validate() {
</a><a href="#h39-0-194" id="h39-0-194" class="i">+        let event = Event::Heartbeat { commit_index: 1, commit_term: 1 };
</a><a href="#h39-0-195" id="h39-0-195" class="i">+
</a><a href="#h39-0-196" id="h39-0-196" class="i">+        // Errors on stale term
</a><a href="#h39-0-197" id="h39-0-197" class="i">+        assert!(Message {
</a><a href="#h39-0-198" id="h39-0-198" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h39-0-199" id="h39-0-199" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h39-0-200" id="h39-0-200" class="i">+            term: 2,
</a><a href="#h39-0-201" id="h39-0-201" class="i">+            event: event.clone(),
</a><a href="#h39-0-202" id="h39-0-202" class="i">+        }
</a><a href="#h39-0-203" id="h39-0-203" class="i">+        .validate(&quot;a&quot;, 3)
</a><a href="#h39-0-204" id="h39-0-204" class="i">+        .is_err());
</a><a href="#h39-0-205" id="h39-0-205" class="i">+
</a><a href="#h39-0-206" id="h39-0-206" class="i">+        // Errors on no receiver
</a><a href="#h39-0-207" id="h39-0-207" class="i">+        assert!(Message { from: Some(&quot;b&quot;.into()), to: None, term: 3, event: event.clone() }
</a><a href="#h39-0-208" id="h39-0-208" class="i">+            .validate(&quot;a&quot;, 3)
</a><a href="#h39-0-209" id="h39-0-209" class="i">+            .is_err());
</a><a href="#h39-0-210" id="h39-0-210" class="i">+
</a><a href="#h39-0-211" id="h39-0-211" class="i">+        // Errors on other receiver
</a><a href="#h39-0-212" id="h39-0-212" class="i">+        assert!(Message {
</a><a href="#h39-0-213" id="h39-0-213" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h39-0-214" id="h39-0-214" class="i">+            to: Some(&quot;c&quot;.into()),
</a><a href="#h39-0-215" id="h39-0-215" class="i">+            term: 3,
</a><a href="#h39-0-216" id="h39-0-216" class="i">+            event: event.clone(),
</a><a href="#h39-0-217" id="h39-0-217" class="i">+        }
</a><a href="#h39-0-218" id="h39-0-218" class="i">+        .validate(&quot;a&quot;, 3)
</a><a href="#h39-0-219" id="h39-0-219" class="i">+        .is_err());
</a><a href="#h39-0-220" id="h39-0-220" class="i">+    }
</a><a href="#h39-0-221" id="h39-0-221" class="i">+
</a><a href="#h39-0-222" id="h39-0-222" class="i">+}
</a><b>diff --git a/<a id="h40" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h40-0" id="h40-0" class="h">@@ -1,48 +0,0 @@
</a><a href="#h40-0-0" id="h40-0-0" class="d">-use crate::error::Error;
</a><a href="#h40-0-1" id="h40-0-1" class="d">-use crate::service;
</a><a href="#h40-0-2" id="h40-0-2" class="d">-
</a><a href="#h40-0-3" id="h40-0-3" class="d">-pub struct Server {
</a><a href="#h40-0-4" id="h40-0-4" class="d">-    pub id: String,
</a><a href="#h40-0-5" id="h40-0-5" class="d">-    pub addr: String,
</a><a href="#h40-0-6" id="h40-0-6" class="d">-    pub threads: usize,
</a><a href="#h40-0-7" id="h40-0-7" class="d">-}
</a><a href="#h40-0-8" id="h40-0-8" class="d">-
</a><a href="#h40-0-9" id="h40-0-9" class="d">-impl Server {
</a><a href="#h40-0-10" id="h40-0-10" class="d">-    pub fn listen(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h40-0-11" id="h40-0-11" class="d">-        info!(&quot;Starting ToyDB node with ID {}&quot;, self.id);
</a><a href="#h40-0-12" id="h40-0-12" class="d">-        let mut server = grpc::ServerBuilder::new_plain();
</a><a href="#h40-0-13" id="h40-0-13" class="d">-        server.http.set_addr(&amp;self.addr)?;
</a><a href="#h40-0-14" id="h40-0-14" class="d">-        server.http.set_cpu_pool_threads(self.threads);
</a><a href="#h40-0-15" id="h40-0-15" class="d">-        server.add_service(service::ToyDBServer::new_service_def(ToyDB { id: self.id.clone() }));
</a><a href="#h40-0-16" id="h40-0-16" class="d">-        let _s = server.build()?;
</a><a href="#h40-0-17" id="h40-0-17" class="d">-
</a><a href="#h40-0-18" id="h40-0-18" class="d">-        loop {
</a><a href="#h40-0-19" id="h40-0-19" class="d">-            std::thread::park();
</a><a href="#h40-0-20" id="h40-0-20" class="d">-        }
</a><a href="#h40-0-21" id="h40-0-21" class="d">-    }
</a><a href="#h40-0-22" id="h40-0-22" class="d">-}
</a><a href="#h40-0-23" id="h40-0-23" class="d">-
</a><a href="#h40-0-24" id="h40-0-24" class="d">-struct ToyDB {
</a><a href="#h40-0-25" id="h40-0-25" class="d">-    id: String,
</a><a href="#h40-0-26" id="h40-0-26" class="d">-}
</a><a href="#h40-0-27" id="h40-0-27" class="d">-
</a><a href="#h40-0-28" id="h40-0-28" class="d">-impl service::ToyDB for ToyDB {
</a><a href="#h40-0-29" id="h40-0-29" class="d">-    fn status(
</a><a href="#h40-0-30" id="h40-0-30" class="d">-        &amp;self,
</a><a href="#h40-0-31" id="h40-0-31" class="d">-        _: grpc::RequestOptions,
</a><a href="#h40-0-32" id="h40-0-32" class="d">-        _: service::StatusRequest,
</a><a href="#h40-0-33" id="h40-0-33" class="d">-    ) -&gt; grpc::SingleResponse&lt;service::StatusResponse&gt; {
</a><a href="#h40-0-34" id="h40-0-34" class="d">-        grpc::SingleResponse::completed(service::StatusResponse {
</a><a href="#h40-0-35" id="h40-0-35" class="d">-            id: self.id.clone(),
</a><a href="#h40-0-36" id="h40-0-36" class="d">-            version: env!(&quot;CARGO_PKG_VERSION&quot;).into(),
</a><a href="#h40-0-37" id="h40-0-37" class="d">-            time: match std::time::SystemTime::now()
</a><a href="#h40-0-38" id="h40-0-38" class="d">-                .duration_since(std::time::UNIX_EPOCH)
</a><a href="#h40-0-39" id="h40-0-39" class="d">-                .map(|t| t.as_secs())
</a><a href="#h40-0-40" id="h40-0-40" class="d">-            {
</a><a href="#h40-0-41" id="h40-0-41" class="d">-                Ok(t) =&gt; t as i64,
</a><a href="#h40-0-42" id="h40-0-42" class="d">-                Err(e) =&gt; return grpc::SingleResponse::err(grpc::Error::Panic(format!(&quot;{}&quot;, e))),
</a><a href="#h40-0-43" id="h40-0-43" class="d">-            },
</a><a href="#h40-0-44" id="h40-0-44" class="d">-            ..Default::default()
</a><a href="#h40-0-45" id="h40-0-45" class="d">-        })
</a><a href="#h40-0-46" id="h40-0-46" class="d">-    }
</a><a href="#h40-0-47" id="h40-0-47" class="d">-}
</a><b>diff --git a/<a id="h41" href="../file/src/server/mod.rs.html">src/server/mod.rs</a> b/<a href="../file/src/server/mod.rs.html">src/server/mod.rs</a></b>
<a href="#h41-0" id="h41-0" class="h">@@ -0,0 +1,60 @@
</a><a href="#h41-0-0" id="h41-0-0" class="i">+mod raft;
</a><a href="#h41-0-1" id="h41-0-1" class="i">+mod toydb;
</a><a href="#h41-0-2" id="h41-0-2" class="i">+
</a><a href="#h41-0-3" id="h41-0-3" class="i">+use self::toydb::ToyDB;
</a><a href="#h41-0-4" id="h41-0-4" class="i">+use crate::error::Error;
</a><a href="#h41-0-5" id="h41-0-5" class="i">+use crate::kv;
</a><a href="#h41-0-6" id="h41-0-6" class="i">+use crate::raft::Raft;
</a><a href="#h41-0-7" id="h41-0-7" class="i">+use crate::service;
</a><a href="#h41-0-8" id="h41-0-8" class="i">+use crate::state;
</a><a href="#h41-0-9" id="h41-0-9" class="i">+
</a><a href="#h41-0-10" id="h41-0-10" class="i">+use std::collections::HashMap;
</a><a href="#h41-0-11" id="h41-0-11" class="i">+
</a><a href="#h41-0-12" id="h41-0-12" class="i">+pub struct Server {
</a><a href="#h41-0-13" id="h41-0-13" class="i">+    pub id: String,
</a><a href="#h41-0-14" id="h41-0-14" class="i">+    pub addr: String,
</a><a href="#h41-0-15" id="h41-0-15" class="i">+    pub threads: usize,
</a><a href="#h41-0-16" id="h41-0-16" class="i">+    pub peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h41-0-17" id="h41-0-17" class="i">+    pub data_dir: String,
</a><a href="#h41-0-18" id="h41-0-18" class="i">+}
</a><a href="#h41-0-19" id="h41-0-19" class="i">+
</a><a href="#h41-0-20" id="h41-0-20" class="i">+impl Server {
</a><a href="#h41-0-21" id="h41-0-21" class="i">+    pub fn listen(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h41-0-22" id="h41-0-22" class="i">+        info!(&quot;Starting ToyDB node with ID {} on {}&quot;, self.id, self.addr);
</a><a href="#h41-0-23" id="h41-0-23" class="i">+        let mut server = grpc::ServerBuilder::new_plain();
</a><a href="#h41-0-24" id="h41-0-24" class="i">+        server.http.set_addr(&amp;self.addr)?;
</a><a href="#h41-0-25" id="h41-0-25" class="i">+        server.http.set_cpu_pool_threads(self.threads);
</a><a href="#h41-0-26" id="h41-0-26" class="i">+        let data_path = std::path::Path::new(&amp;self.data_dir);
</a><a href="#h41-0-27" id="h41-0-27" class="i">+        std::fs::create_dir_all(data_path)?;
</a><a href="#h41-0-28" id="h41-0-28" class="i">+
</a><a href="#h41-0-29" id="h41-0-29" class="i">+        let raft_transport = raft::GRPC::new(self.peers.clone())?;
</a><a href="#h41-0-30" id="h41-0-30" class="i">+        server.add_service(service::RaftServer::new_service_def(raft_transport.build_service()?));
</a><a href="#h41-0-31" id="h41-0-31" class="i">+        let raft = Raft::start(
</a><a href="#h41-0-32" id="h41-0-32" class="i">+            &amp;self.id,
</a><a href="#h41-0-33" id="h41-0-33" class="i">+            self.peers.keys().cloned().collect(),
</a><a href="#h41-0-34" id="h41-0-34" class="i">+            state::State::new(kv::File::new(
</a><a href="#h41-0-35" id="h41-0-35" class="i">+                std::fs::OpenOptions::new()
</a><a href="#h41-0-36" id="h41-0-36" class="i">+                    .read(true)
</a><a href="#h41-0-37" id="h41-0-37" class="i">+                    .write(true)
</a><a href="#h41-0-38" id="h41-0-38" class="i">+                    .create(true)
</a><a href="#h41-0-39" id="h41-0-39" class="i">+                    .open(data_path.join(&quot;state&quot;))?,
</a><a href="#h41-0-40" id="h41-0-40" class="i">+            )?),
</a><a href="#h41-0-41" id="h41-0-41" class="i">+            kv::File::new(
</a><a href="#h41-0-42" id="h41-0-42" class="i">+                std::fs::OpenOptions::new()
</a><a href="#h41-0-43" id="h41-0-43" class="i">+                    .read(true)
</a><a href="#h41-0-44" id="h41-0-44" class="i">+                    .write(true)
</a><a href="#h41-0-45" id="h41-0-45" class="i">+                    .create(true)
</a><a href="#h41-0-46" id="h41-0-46" class="i">+                    .open(data_path.join(&quot;raft&quot;))?,
</a><a href="#h41-0-47" id="h41-0-47" class="i">+            )?,
</a><a href="#h41-0-48" id="h41-0-48" class="i">+            raft_transport,
</a><a href="#h41-0-49" id="h41-0-49" class="i">+        )?;
</a><a href="#h41-0-50" id="h41-0-50" class="i">+
</a><a href="#h41-0-51" id="h41-0-51" class="i">+        server.add_service(service::ToyDBServer::new_service_def(ToyDB {
</a><a href="#h41-0-52" id="h41-0-52" class="i">+            id: self.id.clone(),
</a><a href="#h41-0-53" id="h41-0-53" class="i">+            raft: raft.clone(),
</a><a href="#h41-0-54" id="h41-0-54" class="i">+        }));
</a><a href="#h41-0-55" id="h41-0-55" class="i">+        let _s = server.build()?;
</a><a href="#h41-0-56" id="h41-0-56" class="i">+
</a><a href="#h41-0-57" id="h41-0-57" class="i">+        raft.join()
</a><a href="#h41-0-58" id="h41-0-58" class="i">+    }
</a><a href="#h41-0-59" id="h41-0-59" class="i">+}
</a><b>diff --git a/<a id="h42" href="../file/src/server/raft.rs.html">src/server/raft.rs</a> b/<a href="../file/src/server/raft.rs.html">src/server/raft.rs</a></b>
<a href="#h42-0" id="h42-0" class="h">@@ -0,0 +1,221 @@
</a><a href="#h42-0-0" id="h42-0-0" class="i">+use crate::raft::{Entry, Event, Message, Transport};
</a><a href="#h42-0-1" id="h42-0-1" class="i">+use crate::service;
</a><a href="#h42-0-2" id="h42-0-2" class="i">+use crate::service::Raft;
</a><a href="#h42-0-3" id="h42-0-3" class="i">+use crate::Error;
</a><a href="#h42-0-4" id="h42-0-4" class="i">+use crossbeam_channel::{Receiver, Sender};
</a><a href="#h42-0-5" id="h42-0-5" class="i">+use grpc::ClientStubExt;
</a><a href="#h42-0-6" id="h42-0-6" class="i">+use std::collections::HashMap;
</a><a href="#h42-0-7" id="h42-0-7" class="i">+
</a><a href="#h42-0-8" id="h42-0-8" class="i">+/// A gRPC transport.
</a><a href="#h42-0-9" id="h42-0-9" class="i">+pub struct GRPC {
</a><a href="#h42-0-10" id="h42-0-10" class="i">+    /// The node channel receiver
</a><a href="#h42-0-11" id="h42-0-11" class="i">+    node_rx: Receiver&lt;Message&gt;,
</a><a href="#h42-0-12" id="h42-0-12" class="i">+    /// The node channel sender
</a><a href="#h42-0-13" id="h42-0-13" class="i">+    node_tx: Sender&lt;Message&gt;,
</a><a href="#h42-0-14" id="h42-0-14" class="i">+    /// A hash map of peer IDs and gRPC clients.
</a><a href="#h42-0-15" id="h42-0-15" class="i">+    peers: HashMap&lt;String, service::RaftClient&gt;,
</a><a href="#h42-0-16" id="h42-0-16" class="i">+}
</a><a href="#h42-0-17" id="h42-0-17" class="i">+
</a><a href="#h42-0-18" id="h42-0-18" class="i">+impl Transport for GRPC {
</a><a href="#h42-0-19" id="h42-0-19" class="i">+    fn receiver(&amp;self) -&gt; Receiver&lt;Message&gt; {
</a><a href="#h42-0-20" id="h42-0-20" class="i">+        self.node_rx.clone()
</a><a href="#h42-0-21" id="h42-0-21" class="i">+    }
</a><a href="#h42-0-22" id="h42-0-22" class="i">+
</a><a href="#h42-0-23" id="h42-0-23" class="i">+    fn send(&amp;self, msg: Message) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h42-0-24" id="h42-0-24" class="i">+        if let Some(to) = &amp;msg.to {
</a><a href="#h42-0-25" id="h42-0-25" class="i">+            if let Some(client) = self.peers.get(to) {
</a><a href="#h42-0-26" id="h42-0-26" class="i">+                client.step(grpc::RequestOptions::new(), message_to_protobuf(msg));
</a><a href="#h42-0-27" id="h42-0-27" class="i">+                Ok(())
</a><a href="#h42-0-28" id="h42-0-28" class="i">+            } else {
</a><a href="#h42-0-29" id="h42-0-29" class="i">+                Err(Error::Network(format!(&quot;Unknown Raft peer {}&quot;, to)))
</a><a href="#h42-0-30" id="h42-0-30" class="i">+            }
</a><a href="#h42-0-31" id="h42-0-31" class="i">+        } else {
</a><a href="#h42-0-32" id="h42-0-32" class="i">+            Err(Error::Network(&quot;No receiver&quot;.into()))
</a><a href="#h42-0-33" id="h42-0-33" class="i">+        }
</a><a href="#h42-0-34" id="h42-0-34" class="i">+    }
</a><a href="#h42-0-35" id="h42-0-35" class="i">+}
</a><a href="#h42-0-36" id="h42-0-36" class="i">+
</a><a href="#h42-0-37" id="h42-0-37" class="i">+impl GRPC {
</a><a href="#h42-0-38" id="h42-0-38" class="i">+    /// Creates a new GRPC transport
</a><a href="#h42-0-39" id="h42-0-39" class="i">+    pub fn new(peers: HashMap&lt;String, std::net::SocketAddr&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h42-0-40" id="h42-0-40" class="i">+        let (node_tx, node_rx) = crossbeam_channel::unbounded();
</a><a href="#h42-0-41" id="h42-0-41" class="i">+        let mut t = GRPC { peers: HashMap::new(), node_tx, node_rx };
</a><a href="#h42-0-42" id="h42-0-42" class="i">+        for (id, addr) in peers.into_iter() {
</a><a href="#h42-0-43" id="h42-0-43" class="i">+            t.peers.insert(id, t.build_client(addr)?);
</a><a href="#h42-0-44" id="h42-0-44" class="i">+        }
</a><a href="#h42-0-45" id="h42-0-45" class="i">+        Ok(t)
</a><a href="#h42-0-46" id="h42-0-46" class="i">+    }
</a><a href="#h42-0-47" id="h42-0-47" class="i">+
</a><a href="#h42-0-48" id="h42-0-48" class="i">+    /// Builds a gRPC client for a peer.
</a><a href="#h42-0-49" id="h42-0-49" class="i">+    pub fn build_client(&amp;self, addr: std::net::SocketAddr) -&gt; Result&lt;service::RaftClient, Error&gt; {
</a><a href="#h42-0-50" id="h42-0-50" class="i">+        Ok(service::RaftClient::new_plain(
</a><a href="#h42-0-51" id="h42-0-51" class="i">+            &amp;addr.ip().to_string(),
</a><a href="#h42-0-52" id="h42-0-52" class="i">+            addr.port(),
</a><a href="#h42-0-53" id="h42-0-53" class="i">+            grpc::ClientConf::new(),
</a><a href="#h42-0-54" id="h42-0-54" class="i">+        )?)
</a><a href="#h42-0-55" id="h42-0-55" class="i">+    }
</a><a href="#h42-0-56" id="h42-0-56" class="i">+
</a><a href="#h42-0-57" id="h42-0-57" class="i">+    /// Builds a gRPC service for a local server.
</a><a href="#h42-0-58" id="h42-0-58" class="i">+    pub fn build_service(&amp;self) -&gt; Result&lt;impl service::Raft, Error&gt; {
</a><a href="#h42-0-59" id="h42-0-59" class="i">+        Ok(GRPCService { local: self.node_tx.clone() })
</a><a href="#h42-0-60" id="h42-0-60" class="i">+    }
</a><a href="#h42-0-61" id="h42-0-61" class="i">+}
</a><a href="#h42-0-62" id="h42-0-62" class="i">+
</a><a href="#h42-0-63" id="h42-0-63" class="i">+/// A gRPC service for a local server.
</a><a href="#h42-0-64" id="h42-0-64" class="i">+struct GRPCService {
</a><a href="#h42-0-65" id="h42-0-65" class="i">+    local: Sender&lt;Message&gt;,
</a><a href="#h42-0-66" id="h42-0-66" class="i">+}
</a><a href="#h42-0-67" id="h42-0-67" class="i">+
</a><a href="#h42-0-68" id="h42-0-68" class="i">+impl service::Raft for GRPCService {
</a><a href="#h42-0-69" id="h42-0-69" class="i">+    fn step(
</a><a href="#h42-0-70" id="h42-0-70" class="i">+        &amp;self,
</a><a href="#h42-0-71" id="h42-0-71" class="i">+        _: grpc::RequestOptions,
</a><a href="#h42-0-72" id="h42-0-72" class="i">+        pb: service::Message,
</a><a href="#h42-0-73" id="h42-0-73" class="i">+    ) -&gt; grpc::SingleResponse&lt;service::Success&gt; {
</a><a href="#h42-0-74" id="h42-0-74" class="i">+        self.local.send(message_from_protobuf(pb).unwrap()).unwrap();
</a><a href="#h42-0-75" id="h42-0-75" class="i">+        grpc::SingleResponse::completed(service::Success::new())
</a><a href="#h42-0-76" id="h42-0-76" class="i">+    }
</a><a href="#h42-0-77" id="h42-0-77" class="i">+}
</a><a href="#h42-0-78" id="h42-0-78" class="i">+
</a><a href="#h42-0-79" id="h42-0-79" class="i">+/// Converts a Protobuf message to a `Message`.
</a><a href="#h42-0-80" id="h42-0-80" class="i">+fn message_from_protobuf(pb: service::Message) -&gt; Result&lt;Message, Error&gt; {
</a><a href="#h42-0-81" id="h42-0-81" class="i">+    Ok(Message {
</a><a href="#h42-0-82" id="h42-0-82" class="i">+        term: pb.term,
</a><a href="#h42-0-83" id="h42-0-83" class="i">+        from: Some(pb.from),
</a><a href="#h42-0-84" id="h42-0-84" class="i">+        to: Some(pb.to),
</a><a href="#h42-0-85" id="h42-0-85" class="i">+        event: match pb.event {
</a><a href="#h42-0-86" id="h42-0-86" class="i">+            Some(service::Message_oneof_event::heartbeat(e)) =&gt; {
</a><a href="#h42-0-87" id="h42-0-87" class="i">+                Event::Heartbeat { commit_index: e.commit_index, commit_term: e.commit_term }
</a><a href="#h42-0-88" id="h42-0-88" class="i">+            }
</a><a href="#h42-0-89" id="h42-0-89" class="i">+            Some(service::Message_oneof_event::confirm_leader(e)) =&gt; {
</a><a href="#h42-0-90" id="h42-0-90" class="i">+                Event::ConfirmLeader { commit_index: e.commit_index, has_committed: e.has_committed }
</a><a href="#h42-0-91" id="h42-0-91" class="i">+            }
</a><a href="#h42-0-92" id="h42-0-92" class="i">+            Some(service::Message_oneof_event::solicit_vote(e)) =&gt; {
</a><a href="#h42-0-93" id="h42-0-93" class="i">+                Event::SolicitVote { last_index: e.last_index, last_term: e.last_term }
</a><a href="#h42-0-94" id="h42-0-94" class="i">+            }
</a><a href="#h42-0-95" id="h42-0-95" class="i">+            Some(service::Message_oneof_event::grant_vote(_)) =&gt; Event::GrantVote,
</a><a href="#h42-0-96" id="h42-0-96" class="i">+            Some(service::Message_oneof_event::read_state(e)) =&gt; {
</a><a href="#h42-0-97" id="h42-0-97" class="i">+                Event::ReadState { call_id: e.call_id, command: e.command }
</a><a href="#h42-0-98" id="h42-0-98" class="i">+            }
</a><a href="#h42-0-99" id="h42-0-99" class="i">+            Some(service::Message_oneof_event::mutate_state(e)) =&gt; {
</a><a href="#h42-0-100" id="h42-0-100" class="i">+                Event::MutateState { call_id: e.call_id, command: e.command }
</a><a href="#h42-0-101" id="h42-0-101" class="i">+            }
</a><a href="#h42-0-102" id="h42-0-102" class="i">+            Some(service::Message_oneof_event::respond_state(e)) =&gt; {
</a><a href="#h42-0-103" id="h42-0-103" class="i">+                Event::RespondState { call_id: e.call_id, response: e.response }
</a><a href="#h42-0-104" id="h42-0-104" class="i">+            }
</a><a href="#h42-0-105" id="h42-0-105" class="i">+            Some(service::Message_oneof_event::respond_error(e)) =&gt; {
</a><a href="#h42-0-106" id="h42-0-106" class="i">+                Event::RespondError { call_id: e.call_id, error: e.error }
</a><a href="#h42-0-107" id="h42-0-107" class="i">+            }
</a><a href="#h42-0-108" id="h42-0-108" class="i">+            Some(service::Message_oneof_event::replicate_entries(e)) =&gt; Event::ReplicateEntries {
</a><a href="#h42-0-109" id="h42-0-109" class="i">+                base_index: e.base_index,
</a><a href="#h42-0-110" id="h42-0-110" class="i">+                base_term: e.base_term,
</a><a href="#h42-0-111" id="h42-0-111" class="i">+                entries: e
</a><a href="#h42-0-112" id="h42-0-112" class="i">+                    .entries
</a><a href="#h42-0-113" id="h42-0-113" class="i">+                    .to_vec()
</a><a href="#h42-0-114" id="h42-0-114" class="i">+                    .into_iter()
</a><a href="#h42-0-115" id="h42-0-115" class="i">+                    .map(|entry| Entry {
</a><a href="#h42-0-116" id="h42-0-116" class="i">+                        term: entry.term,
</a><a href="#h42-0-117" id="h42-0-117" class="i">+                        command: if entry.command.is_empty() { None } else { Some(entry.command) },
</a><a href="#h42-0-118" id="h42-0-118" class="i">+                    })
</a><a href="#h42-0-119" id="h42-0-119" class="i">+                    .collect(),
</a><a href="#h42-0-120" id="h42-0-120" class="i">+            },
</a><a href="#h42-0-121" id="h42-0-121" class="i">+            Some(service::Message_oneof_event::accept_entries(e)) =&gt; {
</a><a href="#h42-0-122" id="h42-0-122" class="i">+                Event::AcceptEntries { last_index: e.last_index }
</a><a href="#h42-0-123" id="h42-0-123" class="i">+            }
</a><a href="#h42-0-124" id="h42-0-124" class="i">+            Some(service::Message_oneof_event::reject_entries(_)) =&gt; Event::RejectEntries,
</a><a href="#h42-0-125" id="h42-0-125" class="i">+            None =&gt; return Err(Error::Network(&quot;No event found in protobuf message&quot;.into())),
</a><a href="#h42-0-126" id="h42-0-126" class="i">+        },
</a><a href="#h42-0-127" id="h42-0-127" class="i">+    })
</a><a href="#h42-0-128" id="h42-0-128" class="i">+}
</a><a href="#h42-0-129" id="h42-0-129" class="i">+
</a><a href="#h42-0-130" id="h42-0-130" class="i">+/// Converts a `Message` to its Protobuf representation.
</a><a href="#h42-0-131" id="h42-0-131" class="i">+fn message_to_protobuf(msg: Message) -&gt; service::Message {
</a><a href="#h42-0-132" id="h42-0-132" class="i">+    service::Message {
</a><a href="#h42-0-133" id="h42-0-133" class="i">+        term: msg.term,
</a><a href="#h42-0-134" id="h42-0-134" class="i">+        from: msg.from.unwrap(),
</a><a href="#h42-0-135" id="h42-0-135" class="i">+        to: msg.to.unwrap(),
</a><a href="#h42-0-136" id="h42-0-136" class="i">+        event: Some(match msg.event {
</a><a href="#h42-0-137" id="h42-0-137" class="i">+            Event::Heartbeat { commit_index, commit_term } =&gt; {
</a><a href="#h42-0-138" id="h42-0-138" class="i">+                service::Message_oneof_event::heartbeat(service::Heartbeat {
</a><a href="#h42-0-139" id="h42-0-139" class="i">+                    commit_index,
</a><a href="#h42-0-140" id="h42-0-140" class="i">+                    commit_term,
</a><a href="#h42-0-141" id="h42-0-141" class="i">+                    ..Default::default()
</a><a href="#h42-0-142" id="h42-0-142" class="i">+                })
</a><a href="#h42-0-143" id="h42-0-143" class="i">+            }
</a><a href="#h42-0-144" id="h42-0-144" class="i">+            Event::ConfirmLeader { commit_index, has_committed } =&gt; {
</a><a href="#h42-0-145" id="h42-0-145" class="i">+                service::Message_oneof_event::confirm_leader(service::ConfirmLeader {
</a><a href="#h42-0-146" id="h42-0-146" class="i">+                    commit_index,
</a><a href="#h42-0-147" id="h42-0-147" class="i">+                    has_committed,
</a><a href="#h42-0-148" id="h42-0-148" class="i">+                    ..Default::default()
</a><a href="#h42-0-149" id="h42-0-149" class="i">+                })
</a><a href="#h42-0-150" id="h42-0-150" class="i">+            }
</a><a href="#h42-0-151" id="h42-0-151" class="i">+            Event::SolicitVote { last_index, last_term } =&gt; {
</a><a href="#h42-0-152" id="h42-0-152" class="i">+                service::Message_oneof_event::solicit_vote(service::SolicitVote {
</a><a href="#h42-0-153" id="h42-0-153" class="i">+                    last_index,
</a><a href="#h42-0-154" id="h42-0-154" class="i">+                    last_term,
</a><a href="#h42-0-155" id="h42-0-155" class="i">+                    ..Default::default()
</a><a href="#h42-0-156" id="h42-0-156" class="i">+                })
</a><a href="#h42-0-157" id="h42-0-157" class="i">+            }
</a><a href="#h42-0-158" id="h42-0-158" class="i">+            Event::GrantVote =&gt; service::Message_oneof_event::grant_vote(service::GrantVote::new()),
</a><a href="#h42-0-159" id="h42-0-159" class="i">+            Event::ReadState { call_id, command } =&gt; {
</a><a href="#h42-0-160" id="h42-0-160" class="i">+                service::Message_oneof_event::read_state(service::ReadState {
</a><a href="#h42-0-161" id="h42-0-161" class="i">+                    call_id,
</a><a href="#h42-0-162" id="h42-0-162" class="i">+                    command,
</a><a href="#h42-0-163" id="h42-0-163" class="i">+                    ..Default::default()
</a><a href="#h42-0-164" id="h42-0-164" class="i">+                })
</a><a href="#h42-0-165" id="h42-0-165" class="i">+            }
</a><a href="#h42-0-166" id="h42-0-166" class="i">+            Event::MutateState { call_id, command } =&gt; {
</a><a href="#h42-0-167" id="h42-0-167" class="i">+                service::Message_oneof_event::mutate_state(service::MutateState {
</a><a href="#h42-0-168" id="h42-0-168" class="i">+                    call_id,
</a><a href="#h42-0-169" id="h42-0-169" class="i">+                    command,
</a><a href="#h42-0-170" id="h42-0-170" class="i">+                    ..Default::default()
</a><a href="#h42-0-171" id="h42-0-171" class="i">+                })
</a><a href="#h42-0-172" id="h42-0-172" class="i">+            }
</a><a href="#h42-0-173" id="h42-0-173" class="i">+            Event::RespondState { call_id, response } =&gt; {
</a><a href="#h42-0-174" id="h42-0-174" class="i">+                service::Message_oneof_event::respond_state(service::RespondState {
</a><a href="#h42-0-175" id="h42-0-175" class="i">+                    call_id,
</a><a href="#h42-0-176" id="h42-0-176" class="i">+                    response,
</a><a href="#h42-0-177" id="h42-0-177" class="i">+                    ..Default::default()
</a><a href="#h42-0-178" id="h42-0-178" class="i">+                })
</a><a href="#h42-0-179" id="h42-0-179" class="i">+            }
</a><a href="#h42-0-180" id="h42-0-180" class="i">+            Event::RespondError { call_id, error } =&gt; {
</a><a href="#h42-0-181" id="h42-0-181" class="i">+                service::Message_oneof_event::respond_error(service::RespondError {
</a><a href="#h42-0-182" id="h42-0-182" class="i">+                    call_id,
</a><a href="#h42-0-183" id="h42-0-183" class="i">+                    error,
</a><a href="#h42-0-184" id="h42-0-184" class="i">+                    ..Default::default()
</a><a href="#h42-0-185" id="h42-0-185" class="i">+                })
</a><a href="#h42-0-186" id="h42-0-186" class="i">+            }
</a><a href="#h42-0-187" id="h42-0-187" class="i">+            Event::ReplicateEntries { base_index, base_term, entries } =&gt; {
</a><a href="#h42-0-188" id="h42-0-188" class="i">+                service::Message_oneof_event::replicate_entries(service::ReplicateEntries {
</a><a href="#h42-0-189" id="h42-0-189" class="i">+                    base_index,
</a><a href="#h42-0-190" id="h42-0-190" class="i">+                    base_term,
</a><a href="#h42-0-191" id="h42-0-191" class="i">+                    entries: protobuf::RepeatedField::from_vec(
</a><a href="#h42-0-192" id="h42-0-192" class="i">+                        entries
</a><a href="#h42-0-193" id="h42-0-193" class="i">+                            .into_iter()
</a><a href="#h42-0-194" id="h42-0-194" class="i">+                            .map(|entry| service::Entry {
</a><a href="#h42-0-195" id="h42-0-195" class="i">+                                term: entry.term,
</a><a href="#h42-0-196" id="h42-0-196" class="i">+                                command: if let Some(bytes) = entry.command {
</a><a href="#h42-0-197" id="h42-0-197" class="i">+                                    bytes
</a><a href="#h42-0-198" id="h42-0-198" class="i">+                                } else {
</a><a href="#h42-0-199" id="h42-0-199" class="i">+                                    vec![]
</a><a href="#h42-0-200" id="h42-0-200" class="i">+                                },
</a><a href="#h42-0-201" id="h42-0-201" class="i">+                                ..Default::default()
</a><a href="#h42-0-202" id="h42-0-202" class="i">+                            })
</a><a href="#h42-0-203" id="h42-0-203" class="i">+                            .collect(),
</a><a href="#h42-0-204" id="h42-0-204" class="i">+                    ),
</a><a href="#h42-0-205" id="h42-0-205" class="i">+                    ..Default::default()
</a><a href="#h42-0-206" id="h42-0-206" class="i">+                })
</a><a href="#h42-0-207" id="h42-0-207" class="i">+            }
</a><a href="#h42-0-208" id="h42-0-208" class="i">+            Event::AcceptEntries { last_index } =&gt; {
</a><a href="#h42-0-209" id="h42-0-209" class="i">+                service::Message_oneof_event::accept_entries(service::AcceptEntries {
</a><a href="#h42-0-210" id="h42-0-210" class="i">+                    last_index,
</a><a href="#h42-0-211" id="h42-0-211" class="i">+                    ..Default::default()
</a><a href="#h42-0-212" id="h42-0-212" class="i">+                })
</a><a href="#h42-0-213" id="h42-0-213" class="i">+            }
</a><a href="#h42-0-214" id="h42-0-214" class="i">+            Event::RejectEntries =&gt; {
</a><a href="#h42-0-215" id="h42-0-215" class="i">+                service::Message_oneof_event::reject_entries(service::RejectEntries::new())
</a><a href="#h42-0-216" id="h42-0-216" class="i">+            }
</a><a href="#h42-0-217" id="h42-0-217" class="i">+        }),
</a><a href="#h42-0-218" id="h42-0-218" class="i">+        ..Default::default()
</a><a href="#h42-0-219" id="h42-0-219" class="i">+    }
</a><a href="#h42-0-220" id="h42-0-220" class="i">+}
</a><b>diff --git a/<a id="h43" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h43-0" id="h43-0" class="h">@@ -0,0 +1,60 @@
</a><a href="#h43-0-0" id="h43-0-0" class="i">+use crate::service;
</a><a href="#h43-0-1" id="h43-0-1" class="i">+use crate::raft::Raft;
</a><a href="#h43-0-2" id="h43-0-2" class="i">+use crate::state;
</a><a href="#h43-0-3" id="h43-0-3" class="i">+
</a><a href="#h43-0-4" id="h43-0-4" class="i">+pub struct ToyDB {
</a><a href="#h43-0-5" id="h43-0-5" class="i">+    pub id: String,
</a><a href="#h43-0-6" id="h43-0-6" class="i">+    pub raft: Raft,
</a><a href="#h43-0-7" id="h43-0-7" class="i">+}
</a><a href="#h43-0-8" id="h43-0-8" class="i">+
</a><a href="#h43-0-9" id="h43-0-9" class="i">+impl service::ToyDB for ToyDB {
</a><a href="#h43-0-10" id="h43-0-10" class="i">+    fn get(
</a><a href="#h43-0-11" id="h43-0-11" class="i">+        &amp;self,
</a><a href="#h43-0-12" id="h43-0-12" class="i">+        _: grpc::RequestOptions,
</a><a href="#h43-0-13" id="h43-0-13" class="i">+        req: service::GetRequest,
</a><a href="#h43-0-14" id="h43-0-14" class="i">+    ) -&gt; grpc::SingleResponse&lt;service::GetResponse&gt; {
</a><a href="#h43-0-15" id="h43-0-15" class="i">+        let value =
</a><a href="#h43-0-16" id="h43-0-16" class="i">+            self.raft.read(state::serialize(state::Read::Get(req.key.clone())).unwrap()).unwrap();
</a><a href="#h43-0-17" id="h43-0-17" class="i">+        grpc::SingleResponse::completed(service::GetResponse {
</a><a href="#h43-0-18" id="h43-0-18" class="i">+            key: req.key,
</a><a href="#h43-0-19" id="h43-0-19" class="i">+            value: state::deserialize(value).unwrap(),
</a><a href="#h43-0-20" id="h43-0-20" class="i">+            ..Default::default()
</a><a href="#h43-0-21" id="h43-0-21" class="i">+        })
</a><a href="#h43-0-22" id="h43-0-22" class="i">+    }
</a><a href="#h43-0-23" id="h43-0-23" class="i">+
</a><a href="#h43-0-24" id="h43-0-24" class="i">+    fn set(
</a><a href="#h43-0-25" id="h43-0-25" class="i">+        &amp;self,
</a><a href="#h43-0-26" id="h43-0-26" class="i">+        _: grpc::RequestOptions,
</a><a href="#h43-0-27" id="h43-0-27" class="i">+        req: service::SetRequest,
</a><a href="#h43-0-28" id="h43-0-28" class="i">+    ) -&gt; grpc::SingleResponse&lt;service::SetResponse&gt; {
</a><a href="#h43-0-29" id="h43-0-29" class="i">+        self.raft
</a><a href="#h43-0-30" id="h43-0-30" class="i">+            .mutate(
</a><a href="#h43-0-31" id="h43-0-31" class="i">+                state::serialize(state::Mutation::Set {
</a><a href="#h43-0-32" id="h43-0-32" class="i">+                    key: req.key,
</a><a href="#h43-0-33" id="h43-0-33" class="i">+                    value: state::serialize(req.value).unwrap(),
</a><a href="#h43-0-34" id="h43-0-34" class="i">+                })
</a><a href="#h43-0-35" id="h43-0-35" class="i">+                .unwrap(),
</a><a href="#h43-0-36" id="h43-0-36" class="i">+            )
</a><a href="#h43-0-37" id="h43-0-37" class="i">+            .unwrap();
</a><a href="#h43-0-38" id="h43-0-38" class="i">+        grpc::SingleResponse::completed(service::SetResponse { ..Default::default() })
</a><a href="#h43-0-39" id="h43-0-39" class="i">+    }
</a><a href="#h43-0-40" id="h43-0-40" class="i">+
</a><a href="#h43-0-41" id="h43-0-41" class="i">+    fn status(
</a><a href="#h43-0-42" id="h43-0-42" class="i">+        &amp;self,
</a><a href="#h43-0-43" id="h43-0-43" class="i">+        _: grpc::RequestOptions,
</a><a href="#h43-0-44" id="h43-0-44" class="i">+        _: service::StatusRequest,
</a><a href="#h43-0-45" id="h43-0-45" class="i">+    ) -&gt; grpc::SingleResponse&lt;service::StatusResponse&gt; {
</a><a href="#h43-0-46" id="h43-0-46" class="i">+        grpc::SingleResponse::completed(service::StatusResponse {
</a><a href="#h43-0-47" id="h43-0-47" class="i">+            id: self.id.clone(),
</a><a href="#h43-0-48" id="h43-0-48" class="i">+            version: env!(&quot;CARGO_PKG_VERSION&quot;).into(),
</a><a href="#h43-0-49" id="h43-0-49" class="i">+            time: match std::time::SystemTime::now()
</a><a href="#h43-0-50" id="h43-0-50" class="i">+                .duration_since(std::time::UNIX_EPOCH)
</a><a href="#h43-0-51" id="h43-0-51" class="i">+                .map(|t| t.as_secs())
</a><a href="#h43-0-52" id="h43-0-52" class="i">+            {
</a><a href="#h43-0-53" id="h43-0-53" class="i">+                Ok(t) =&gt; t as i64,
</a><a href="#h43-0-54" id="h43-0-54" class="i">+                Err(e) =&gt; return grpc::SingleResponse::err(grpc::Error::Panic(format!(&quot;{}&quot;, e))),
</a><a href="#h43-0-55" id="h43-0-55" class="i">+            },
</a><a href="#h43-0-56" id="h43-0-56" class="i">+            ..Default::default()
</a><a href="#h43-0-57" id="h43-0-57" class="i">+        })
</a><a href="#h43-0-58" id="h43-0-58" class="i">+    }
</a><a href="#h43-0-59" id="h43-0-59" class="i">+}
</a><b>diff --git a/<a id="h44" href="../file/src/service/mod.rs.html">src/service/mod.rs</a> b/<a href="../file/src/service/mod.rs.html">src/service/mod.rs</a></b>
<a href="#h44-0" id="h44-0" class="h">@@ -1,8 +1,18 @@
</a> // These imported modules are generated by build.rs from protobuf
 // definitions in /protobuf/
 
<a href="#h44-0-3" id="h44-0-3" class="i">+// The allows are to avoid clippy warnings in the generated code, see:
</a><a href="#h44-0-4" id="h44-0-4" class="i">+// https://github.com/stepancheg/rust-protobuf/pull/332
</a><a href="#h44-0-5" id="h44-0-5" class="i">+#[allow(renamed_and_removed_lints)]
</a><a href="#h44-0-6" id="h44-0-6" class="i">+mod raft;
</a><a href="#h44-0-7" id="h44-0-7" class="i">+#[allow(renamed_and_removed_lints)]
</a><a href="#h44-0-8" id="h44-0-8" class="i">+mod raft_grpc;
</a><a href="#h44-0-9" id="h44-0-9" class="i">+#[allow(renamed_and_removed_lints)]
</a> mod toydb;
<a href="#h44-0-11" id="h44-0-11" class="i">+#[allow(renamed_and_removed_lints)]
</a> mod toydb_grpc;
 
<a href="#h44-0-14" id="h44-0-14" class="i">+pub use self::raft::*;
</a><a href="#h44-0-15" id="h44-0-15" class="i">+pub use self::raft_grpc::*;
</a> pub use self::toydb::*;
 pub use self::toydb_grpc::*;
<b>diff --git a/<a id="h45" href="../file/src/state.rs.html">src/state.rs</a> b/<a href="../file/src/state.rs.html">src/state.rs</a></b>
<a href="#h45-0" id="h45-0" class="h">@@ -0,0 +1,67 @@
</a><a href="#h45-0-0" id="h45-0-0" class="i">+use crate::kv;
</a><a href="#h45-0-1" id="h45-0-1" class="i">+use crate::raft;
</a><a href="#h45-0-2" id="h45-0-2" class="i">+use crate::Error;
</a><a href="#h45-0-3" id="h45-0-3" class="i">+use serde_derive::{Deserialize, Serialize};
</a><a href="#h45-0-4" id="h45-0-4" class="i">+
</a><a href="#h45-0-5" id="h45-0-5" class="i">+/// A state machine mutation.
</a><a href="#h45-0-6" id="h45-0-6" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h45-0-7" id="h45-0-7" class="i">+pub enum Mutation {
</a><a href="#h45-0-8" id="h45-0-8" class="i">+    /// Sets a key to a value.
</a><a href="#h45-0-9" id="h45-0-9" class="i">+    Set { key: String, value: Vec&lt;u8&gt; },
</a><a href="#h45-0-10" id="h45-0-10" class="i">+}
</a><a href="#h45-0-11" id="h45-0-11" class="i">+
</a><a href="#h45-0-12" id="h45-0-12" class="i">+/// A state machine read.
</a><a href="#h45-0-13" id="h45-0-13" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h45-0-14" id="h45-0-14" class="i">+pub enum Read {
</a><a href="#h45-0-15" id="h45-0-15" class="i">+    /// Fethes a value.
</a><a href="#h45-0-16" id="h45-0-16" class="i">+    Get(String),
</a><a href="#h45-0-17" id="h45-0-17" class="i">+}
</a><a href="#h45-0-18" id="h45-0-18" class="i">+
</a><a href="#h45-0-19" id="h45-0-19" class="i">+/// A basic key/value state machine.
</a><a href="#h45-0-20" id="h45-0-20" class="i">+#[derive(Debug)]
</a><a href="#h45-0-21" id="h45-0-21" class="i">+pub struct State {
</a><a href="#h45-0-22" id="h45-0-22" class="i">+    // The backing store.
</a><a href="#h45-0-23" id="h45-0-23" class="i">+    kv: Box&lt;kv::Store&gt;,
</a><a href="#h45-0-24" id="h45-0-24" class="i">+}
</a><a href="#h45-0-25" id="h45-0-25" class="i">+
</a><a href="#h45-0-26" id="h45-0-26" class="i">+impl State {
</a><a href="#h45-0-27" id="h45-0-27" class="i">+    /// Creates a new kv state machine.
</a><a href="#h45-0-28" id="h45-0-28" class="i">+    pub fn new&lt;K: kv::Store&gt;(kv: K) -&gt; Self {
</a><a href="#h45-0-29" id="h45-0-29" class="i">+        State { kv: Box::new(kv) }
</a><a href="#h45-0-30" id="h45-0-30" class="i">+    }
</a><a href="#h45-0-31" id="h45-0-31" class="i">+}
</a><a href="#h45-0-32" id="h45-0-32" class="i">+
</a><a href="#h45-0-33" id="h45-0-33" class="i">+impl raft::State for State {
</a><a href="#h45-0-34" id="h45-0-34" class="i">+    fn mutate(&amp;mut self, bytes: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h45-0-35" id="h45-0-35" class="i">+        let mutation: Mutation = deserialize(bytes)?;
</a><a href="#h45-0-36" id="h45-0-36" class="i">+        match mutation {
</a><a href="#h45-0-37" id="h45-0-37" class="i">+            Mutation::Set { key, value } =&gt; {
</a><a href="#h45-0-38" id="h45-0-38" class="i">+                info!(&quot;Setting {} to {:?}&quot;, key, value);
</a><a href="#h45-0-39" id="h45-0-39" class="i">+                self.kv.set(&amp;key, value)?;
</a><a href="#h45-0-40" id="h45-0-40" class="i">+                Ok(vec![])
</a><a href="#h45-0-41" id="h45-0-41" class="i">+            }
</a><a href="#h45-0-42" id="h45-0-42" class="i">+        }
</a><a href="#h45-0-43" id="h45-0-43" class="i">+    }
</a><a href="#h45-0-44" id="h45-0-44" class="i">+
</a><a href="#h45-0-45" id="h45-0-45" class="i">+    fn read(&amp;self, bytes: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h45-0-46" id="h45-0-46" class="i">+        let read: Read = deserialize(bytes)?;
</a><a href="#h45-0-47" id="h45-0-47" class="i">+        match read {
</a><a href="#h45-0-48" id="h45-0-48" class="i">+            Read::Get(key) =&gt; {
</a><a href="#h45-0-49" id="h45-0-49" class="i">+                info!(&quot;Getting {}&quot;, key);
</a><a href="#h45-0-50" id="h45-0-50" class="i">+                Ok(self.kv.get(&amp;key)?.unwrap_or(serialize(&quot;&quot;)?))
</a><a href="#h45-0-51" id="h45-0-51" class="i">+            }
</a><a href="#h45-0-52" id="h45-0-52" class="i">+        }
</a><a href="#h45-0-53" id="h45-0-53" class="i">+    }
</a><a href="#h45-0-54" id="h45-0-54" class="i">+}
</a><a href="#h45-0-55" id="h45-0-55" class="i">+
</a><a href="#h45-0-56" id="h45-0-56" class="i">+/// Deserializes a value from a byte buffer
</a><a href="#h45-0-57" id="h45-0-57" class="i">+pub fn deserialize&lt;&#39;de, V: serde::Deserialize&lt;&#39;de&gt;&gt;(bytes: Vec&lt;u8&gt;) -&gt; Result&lt;V, Error&gt; {
</a><a href="#h45-0-58" id="h45-0-58" class="i">+    Ok(serde::Deserialize::deserialize(&amp;mut rmps::Deserializer::new(&amp;bytes[..]))?)
</a><a href="#h45-0-59" id="h45-0-59" class="i">+}
</a><a href="#h45-0-60" id="h45-0-60" class="i">+
</a><a href="#h45-0-61" id="h45-0-61" class="i">+/// Serializes a value into a byte buffer
</a><a href="#h45-0-62" id="h45-0-62" class="i">+pub fn serialize&lt;V: serde::Serialize&gt;(value: V) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h45-0-63" id="h45-0-63" class="i">+    let mut bytes = Vec::new();
</a><a href="#h45-0-64" id="h45-0-64" class="i">+    value.serialize(&amp;mut rmps::Serializer::new(&amp;mut bytes))?;
</a><a href="#h45-0-65" id="h45-0-65" class="i">+    Ok(bytes)
</a><a href="#h45-0-66" id="h45-0-66" class="i">+}
</a><b>diff --git a/<a id="h46" href="../file/src/utility/deref.rs.html">src/utility/deref.rs</a> b/<a href="../file/src/utility/deref.rs.html">src/utility/deref.rs</a></b>
<a href="#h46-0" id="h46-0" class="h">@@ -0,0 +1,14 @@
</a><a href="#h46-0-0" id="h46-0-0" class="i">+use std::ops::Deref;
</a><a href="#h46-0-1" id="h46-0-1" class="i">+
</a><a href="#h46-0-2" id="h46-0-2" class="i">+/// This implements as_deref() for Option, to e.g. convert
</a><a href="#h46-0-3" id="h46-0-3" class="i">+/// Option&lt;String&gt; to Option&lt;&amp;str&gt;. There is a similar method in nightly:
</a><a href="#h46-0-4" id="h46-0-4" class="i">+/// https://doc.rust-lang.org/std/option/enum.Option.html#method.deref
</a><a href="#h46-0-5" id="h46-0-5" class="i">+pub trait OptionDeref&lt;T: Deref&gt; {
</a><a href="#h46-0-6" id="h46-0-6" class="i">+    fn as_deref(&amp;self) -&gt; Option&lt;&amp;T::Target&gt;;
</a><a href="#h46-0-7" id="h46-0-7" class="i">+}
</a><a href="#h46-0-8" id="h46-0-8" class="i">+
</a><a href="#h46-0-9" id="h46-0-9" class="i">+impl&lt;T: Deref&gt; OptionDeref&lt;T&gt; for Option&lt;T&gt; {
</a><a href="#h46-0-10" id="h46-0-10" class="i">+    fn as_deref(&amp;self) -&gt; Option&lt;&amp;T::Target&gt; {
</a><a href="#h46-0-11" id="h46-0-11" class="i">+        self.as_ref().map(Deref::deref)
</a><a href="#h46-0-12" id="h46-0-12" class="i">+    }
</a><a href="#h46-0-13" id="h46-0-13" class="i">+}
</a><b>diff --git a/<a id="h47" href="../file/src/utility/mod.rs.html">src/utility/mod.rs</a> b/<a href="../file/src/utility/mod.rs.html">src/utility/mod.rs</a></b>
<a href="#h47-0" id="h47-0" class="h">@@ -0,0 +1,3 @@
</a><a href="#h47-0-0" id="h47-0-0" class="i">+mod deref;
</a><a href="#h47-0-1" id="h47-0-1" class="i">+
</a><a href="#h47-0-2" id="h47-0-2" class="i">+pub use deref::OptionDeref;
</a></pre>
</div>
</body>
</html>
