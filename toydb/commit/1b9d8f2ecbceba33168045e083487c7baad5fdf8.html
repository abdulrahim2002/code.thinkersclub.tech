<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: use request/response nomenclature for messages - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/1b9d8f2ecbceba33168045e083487c7baad5fdf8.html">1b9d8f2ecbceba33168045e083487c7baad5fdf8</a>
<b>parent</b> <a href="../commit/285aa3211ff7d8b7730daeadefd8b3216905f242.html">285aa3211ff7d8b7730daeadefd8b3216905f242</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 13 Apr 2024 11:25:41 +0200

raft: use request/response nomenclature for messages

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/message.rs</a></td><td> | </td><td class="num">41</td><td><span class="i">+++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">42</td><td><span class="i">+++++++++++++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/node/follower.rs</a></td><td> | </td><td class="num">163</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/node/leader.rs</a></td><td> | </td><td class="num">46</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">--------------------</span></td></tr>
</table></pre><pre>4 files changed, 185 insertions(+), 107 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -30,29 +30,35 @@ pub enum Message {
</a>         /// The latest read sequence number of the leader.
         read_seq: ReadSequence,
     },
<a href="#h0-0-3" id="h0-0-3" class="d">-    /// Followers confirm loyalty to leader after heartbeats.
</a><a href="#h0-0-4" id="h0-0-4" class="d">-    ConfirmLeader {
</a><a href="#h0-0-5" id="h0-0-5" class="i">+
</a><a href="#h0-0-6" id="h0-0-6" class="i">+    /// Followers confirm leader heartbeats.
</a><a href="#h0-0-7" id="h0-0-7" class="i">+    HeartbeatResponse {
</a>         /// If false, the follower does not have the entry at commit_index
         /// and would like the leader to replicate it.
<a href="#h0-0-10" id="h0-0-10" class="i">+        ///
</a><a href="#h0-0-11" id="h0-0-11" class="i">+        /// TODO: consider responding with last_index/term instead.
</a>         has_committed: bool,
         /// The read sequence number of the heartbeat we&#39;re responding to.
         read_seq: ReadSequence,
     },
 
<a href="#h0-0-17" id="h0-0-17" class="d">-    /// Candidates solicit votes from all peers when campaigning for leadership.
</a><a href="#h0-0-18" id="h0-0-18" class="d">-    SolicitVote {
</a><a href="#h0-0-19" id="h0-0-19" class="d">-        // The index of the candidate&#39;s last stored log entry
</a><a href="#h0-0-20" id="h0-0-20" class="i">+    /// Candidates campaign for leadership by soliciting votes from peers.
</a><a href="#h0-0-21" id="h0-0-21" class="i">+    Campaign {
</a><a href="#h0-0-22" id="h0-0-22" class="i">+        /// The index of the candidate&#39;s last stored log entry
</a>         last_index: Index,
<a href="#h0-0-24" id="h0-0-24" class="d">-        // The term of the candidate&#39;s last stored log entry
</a><a href="#h0-0-25" id="h0-0-25" class="i">+        /// The term of the candidate&#39;s last stored log entry
</a>         last_term: Term,
     },
 
<a href="#h0-0-29" id="h0-0-29" class="d">-    /// Followers may grant a single vote to a candidate per term, on a
</a><a href="#h0-0-30" id="h0-0-30" class="d">-    /// first-come basis. Candidates implicitly vote for themselves.
</a><a href="#h0-0-31" id="h0-0-31" class="d">-    GrantVote,
</a><a href="#h0-0-32" id="h0-0-32" class="i">+    /// Followers may vote for a single candidate per term, on a first-come
</a><a href="#h0-0-33" id="h0-0-33" class="i">+    /// first-serve basis. Candidates implicitly vote for themselves.
</a><a href="#h0-0-34" id="h0-0-34" class="i">+    CampaignResponse {
</a><a href="#h0-0-35" id="h0-0-35" class="i">+        /// If true, the sender granted a vote for the candidate.
</a><a href="#h0-0-36" id="h0-0-36" class="i">+        vote: bool,
</a><a href="#h0-0-37" id="h0-0-37" class="i">+    },
</a> 
<a href="#h0-0-39" id="h0-0-39" class="d">-    /// Leaders replicate log entries to followers by appending it to their log.
</a><a href="#h0-0-40" id="h0-0-40" class="d">-    AppendEntries {
</a><a href="#h0-0-41" id="h0-0-41" class="i">+    /// Leaders replicate log entries to followers by appending to their logs.
</a><a href="#h0-0-42" id="h0-0-42" class="i">+    Append {
</a>         /// The index of the log entry immediately preceding the submitted commands.
         base_index: Index,
         /// The term of the log entry immediately preceding the submitted commands.
<a href="#h0-1" id="h0-1" class="h">@@ -60,13 +66,16 @@ pub enum Message {
</a>         /// Commands to replicate.
         entries: Vec&lt;Entry&gt;,
     },
<a href="#h0-1-3" id="h0-1-3" class="d">-    /// Followers may accept a set of log entries from a leader.
</a><a href="#h0-1-4" id="h0-1-4" class="d">-    AcceptEntries {
</a><a href="#h0-1-5" id="h0-1-5" class="d">-        /// The index of the last log entry.
</a><a href="#h0-1-6" id="h0-1-6" class="i">+
</a><a href="#h0-1-7" id="h0-1-7" class="i">+    /// Followers may accept or reject appending entries from the leader.
</a><a href="#h0-1-8" id="h0-1-8" class="i">+    AppendResponse {
</a><a href="#h0-1-9" id="h0-1-9" class="i">+        /// If true, the follower rejected the leader&#39;s entries.
</a><a href="#h0-1-10" id="h0-1-10" class="i">+        reject: bool,
</a><a href="#h0-1-11" id="h0-1-11" class="i">+        /// The index of the follower&#39;s last log entry.
</a><a href="#h0-1-12" id="h0-1-12" class="i">+        ///
</a><a href="#h0-1-13" id="h0-1-13" class="i">+        /// TODO: should this include last_term as well?
</a>         last_index: Index,
     },
<a href="#h0-1-16" id="h0-1-16" class="d">-    /// Followers may also reject a set of log entries from a leader.
</a><a href="#h0-1-17" id="h0-1-17" class="d">-    RejectEntries,
</a> 
     /// A client request. This can be submitted to the leader, or to a follower
     /// which will forward it to its leader. If there is no leader, or the
<b>diff --git a/<a id="h1" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -107,20 +107,23 @@ impl RawNode&lt;Candidate&gt; {
</a> 
         match msg.message {
             // Ignore other candidates when we&#39;re also campaigning.
<a href="#h1-0-3" id="h1-0-3" class="d">-            Message::SolicitVote { .. } =&gt; {}
</a><a href="#h1-0-4" id="h1-0-4" class="i">+            Message::Campaign { .. } =&gt; {}
</a> 
<a href="#h1-0-6" id="h1-0-6" class="d">-            // We received a vote. Record it, and if we have quorum, assume
</a><a href="#h1-0-7" id="h1-0-7" class="d">-            // leadership.
</a><a href="#h1-0-8" id="h1-0-8" class="d">-            Message::GrantVote =&gt; {
</a><a href="#h1-0-9" id="h1-0-9" class="i">+            // If we received a vote, record it. If the vote gives us quorum,
</a><a href="#h1-0-10" id="h1-0-10" class="i">+            // assume leadership.
</a><a href="#h1-0-11" id="h1-0-11" class="i">+            Message::CampaignResponse { vote: true } =&gt; {
</a>                 self.role.votes.insert(msg.from);
                 if self.role.votes.len() as u8 &gt;= self.quorum_size() {
                     return Ok(self.into_leader()?.into());
                 }
             }
 
<a href="#h1-0-18" id="h1-0-18" class="i">+            // We didn&#39;t get a vote. :(
</a><a href="#h1-0-19" id="h1-0-19" class="i">+            Message::CampaignResponse { vote: false } =&gt; {}
</a><a href="#h1-0-20" id="h1-0-20" class="i">+
</a>             // If we receive a heartbeat or entries in this term, we lost the
             // election and have a new leader. Follow it and step the message.
<a href="#h1-0-23" id="h1-0-23" class="d">-            Message::Heartbeat { .. } | Message::AppendEntries { .. } =&gt; {
</a><a href="#h1-0-24" id="h1-0-24" class="i">+            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a>                 return self.into_follower(msg.term, Some(msg.from))?.step(msg);
             }
 
<a href="#h1-1" id="h1-1" class="h">@@ -131,9 +134,8 @@ impl RawNode&lt;Candidate&gt; {
</a> 
             // We&#39;re not a leader in this term, nor are we forwarding requests,
             // so we shouldn&#39;t see these.
<a href="#h1-1-3" id="h1-1-3" class="d">-            Message::ConfirmLeader { .. }
</a><a href="#h1-1-4" id="h1-1-4" class="d">-            | Message::AcceptEntries { .. }
</a><a href="#h1-1-5" id="h1-1-5" class="d">-            | Message::RejectEntries { .. }
</a><a href="#h1-1-6" id="h1-1-6" class="i">+            Message::HeartbeatResponse { .. }
</a><a href="#h1-1-7" id="h1-1-7" class="i">+            | Message::AppendResponse { .. }
</a>             | Message::ClientResponse { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
         }
         Ok(self.into())
<a href="#h1-2" id="h1-2" class="h">@@ -161,7 +163,7 @@ impl RawNode&lt;Candidate&gt; {
</a>         self.log.set_term(term, Some(self.id))?;
 
         let (last_index, last_term) = self.log.get_last_index();
<a href="#h1-2-3" id="h1-2-3" class="d">-        self.broadcast(Message::SolicitVote { last_index, last_term })?;
</a><a href="#h1-2-4" id="h1-2-4" class="i">+        self.broadcast(Message::Campaign { last_index, last_term })?;
</a>         Ok(())
     }
 }
<a href="#h1-3" id="h1-3" class="h">@@ -217,7 +219,7 @@ mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h1-3-3" id="h1-3-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h1-3-4" id="h1-3-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h1-4" id="h1-4" class="h">@@ -240,7 +242,7 @@ mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 4,
<a href="#h1-4-3" id="h1-4-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h1-4-4" id="h1-4-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h1-5" id="h1-5" class="h">@@ -268,12 +270,22 @@ mod tests {
</a>         let mut node = Node::Candidate(candidate);
 
         // The first vote is not sufficient for a quorum (3 votes including self)
<a href="#h1-5-3" id="h1-5-3" class="d">-        node = node.step(Envelope { from: 3, to: 1, term: 3, message: Message::GrantVote })?;
</a><a href="#h1-5-4" id="h1-5-4" class="i">+        node = node.step(Envelope {
</a><a href="#h1-5-5" id="h1-5-5" class="i">+            from: 3,
</a><a href="#h1-5-6" id="h1-5-6" class="i">+            to: 1,
</a><a href="#h1-5-7" id="h1-5-7" class="i">+            term: 3,
</a><a href="#h1-5-8" id="h1-5-8" class="i">+            message: Message::CampaignResponse { vote: true },
</a><a href="#h1-5-9" id="h1-5-9" class="i">+        })?;
</a>         assert_node(&amp;mut node).is_candidate().term(3);
         assert_messages(&amp;mut node_rx, vec![]);
 
         // However, the second external vote makes us leader
<a href="#h1-5-14" id="h1-5-14" class="d">-        node = node.step(Envelope { from: 5, to: 1, term: 3, message: Message::GrantVote })?;
</a><a href="#h1-5-15" id="h1-5-15" class="i">+        node = node.step(Envelope {
</a><a href="#h1-5-16" id="h1-5-16" class="i">+            from: 5,
</a><a href="#h1-5-17" id="h1-5-17" class="i">+            to: 1,
</a><a href="#h1-5-18" id="h1-5-18" class="i">+            term: 3,
</a><a href="#h1-5-19" id="h1-5-19" class="i">+            message: Message::CampaignResponse { vote: true },
</a><a href="#h1-5-20" id="h1-5-20" class="i">+        })?;
</a>         assert_node(&amp;mut node).is_leader().term(3);
 
         for to in peers.iter().copied().sorted() {
<a href="#h1-6" id="h1-6" class="h">@@ -295,7 +307,7 @@ mod tests {
</a>                     from: 1,
                     to,
                     term: 3,
<a href="#h1-6-3" id="h1-6-3" class="d">-                    message: Message::AppendEntries {
</a><a href="#h1-6-4" id="h1-6-4" class="i">+                    message: Message::Append {
</a>                         base_index: 3,
                         base_term: 2,
                         entries: vec![Entry { index: 4, term: 3, command: None }],
<a href="#h1-7" id="h1-7" class="h">@@ -357,7 +369,7 @@ mod tests {
</a>                     from: 1,
                     to,
                     term: 4,
<a href="#h1-7-3" id="h1-7-3" class="d">-                    message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h1-7-4" id="h1-7-4" class="i">+                    message: Message::Campaign { last_index: 3, last_term: 2 },
</a>                 },
             );
         }
<b>diff --git a/<a id="h2" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -156,7 +156,7 @@ impl RawNode&lt;Follower&gt; {
</a>                 //
                 // TODO: this should return the last index and term.
                 let has_committed = self.log.has(commit_index, commit_term)?;
<a href="#h2-0-3" id="h2-0-3" class="d">-                self.send(msg.from, Message::ConfirmLeader { has_committed, read_seq })?;
</a><a href="#h2-0-4" id="h2-0-4" class="i">+                self.send(msg.from, Message::HeartbeatResponse { has_committed, read_seq })?;
</a> 
                 // Advance commit index and apply entries.
                 if has_committed &amp;&amp; commit_index &gt; self.log.get_commit_index().0 {
<a href="#h2-1" id="h2-1" class="h">@@ -167,7 +167,7 @@ impl RawNode&lt;Follower&gt; {
</a> 
             // Replicate entries from the leader. If we don&#39;t have a leader in
             // this term yet, follow it.
<a href="#h2-1-3" id="h2-1-3" class="d">-            Message::AppendEntries { base_index, base_term, entries } =&gt; {
</a><a href="#h2-1-4" id="h2-1-4" class="i">+            Message::Append { base_index, base_term, entries } =&gt; {
</a>                 // Check that the entries are from our leader.
                 let from = msg.from;
                 match self.role.leader {
<a href="#h2-2" id="h2-2" class="h">@@ -178,38 +178,41 @@ impl RawNode&lt;Follower&gt; {
</a>                 // Append the entries, if possible.
                 if base_index &gt; 0 &amp;&amp; !self.log.has(base_index, base_term)? {
                     debug!(&quot;Rejecting log entries at base {}&quot;, base_index);
<a href="#h2-2-3" id="h2-2-3" class="d">-                    self.send(msg.from, Message::RejectEntries)?
</a><a href="#h2-2-4" id="h2-2-4" class="i">+                    let (last_index, _) = self.log.get_last_index();
</a><a href="#h2-2-5" id="h2-2-5" class="i">+                    self.send(msg.from, Message::AppendResponse { reject: true, last_index })?
</a>                 } else {
                     let last_index = self.log.splice(entries)?;
<a href="#h2-2-8" id="h2-2-8" class="d">-                    self.send(msg.from, Message::AcceptEntries { last_index })?
</a><a href="#h2-2-9" id="h2-2-9" class="i">+                    self.send(msg.from, Message::AppendResponse { reject: false, last_index })?
</a>                 }
             }
 
             // A candidate in this term is requesting our vote.
<a href="#h2-2-14" id="h2-2-14" class="d">-            Message::SolicitVote { last_index, last_term } =&gt; {
</a><a href="#h2-2-15" id="h2-2-15" class="d">-                let from = msg.from;
</a><a href="#h2-2-16" id="h2-2-16" class="d">-
</a><a href="#h2-2-17" id="h2-2-17" class="d">-                // If we already voted for someone else in this term, ignore it.
</a><a href="#h2-2-18" id="h2-2-18" class="i">+            Message::Campaign { last_index, last_term } =&gt; {
</a><a href="#h2-2-19" id="h2-2-19" class="i">+                // Don&#39;t vote if we already voted for someone else in this term.
</a>                 if let Some(voted_for) = self.role.voted_for {
<a href="#h2-2-21" id="h2-2-21" class="d">-                    if from != voted_for {
</a><a href="#h2-2-22" id="h2-2-22" class="i">+                    if msg.from != voted_for {
</a><a href="#h2-2-23" id="h2-2-23" class="i">+                        self.send(msg.from, Message::CampaignResponse { vote: false })?;
</a>                         return Ok(self.into());
                     }
                 }
 
<a href="#h2-2-28" id="h2-2-28" class="d">-                // Only vote if the candidate&#39;s log is at least as up-to-date as
</a><a href="#h2-2-29" id="h2-2-29" class="d">-                // our log.
</a><a href="#h2-2-30" id="h2-2-30" class="i">+                // Don&#39;t vote if our log is newer than the candidate&#39;s log.
</a>                 let (log_index, log_term) = self.log.get_last_index();
<a href="#h2-2-32" id="h2-2-32" class="d">-                if last_term &gt; log_term || last_term == log_term &amp;&amp; last_index &gt;= log_index {
</a><a href="#h2-2-33" id="h2-2-33" class="d">-                    info!(&quot;Voting for {} in term {} election&quot;, from, self.term);
</a><a href="#h2-2-34" id="h2-2-34" class="d">-                    self.send(from, Message::GrantVote)?;
</a><a href="#h2-2-35" id="h2-2-35" class="d">-                    self.log.set_term(self.term, Some(from))?;
</a><a href="#h2-2-36" id="h2-2-36" class="d">-                    self.role.voted_for = Some(from);
</a><a href="#h2-2-37" id="h2-2-37" class="i">+                if log_term &gt; last_term || log_term == last_term &amp;&amp; log_index &gt; last_index {
</a><a href="#h2-2-38" id="h2-2-38" class="i">+                    self.send(msg.from, Message::CampaignResponse { vote: false })?;
</a><a href="#h2-2-39" id="h2-2-39" class="i">+                    return Ok(self.into());
</a>                 }
<a href="#h2-2-41" id="h2-2-41" class="i">+
</a><a href="#h2-2-42" id="h2-2-42" class="i">+                // Grant the vote.
</a><a href="#h2-2-43" id="h2-2-43" class="i">+                info!(&quot;Voting for {} in term {} election&quot;, msg.from, self.term);
</a><a href="#h2-2-44" id="h2-2-44" class="i">+                self.send(msg.from, Message::CampaignResponse { vote: true })?;
</a><a href="#h2-2-45" id="h2-2-45" class="i">+                self.log.set_term(self.term, Some(msg.from))?;
</a><a href="#h2-2-46" id="h2-2-46" class="i">+                self.role.voted_for = Some(msg.from);
</a>             }
 
             // We may receive a vote after we lost an election and followed a
             // different leader. Ignore it.
<a href="#h2-2-51" id="h2-2-51" class="d">-            Message::GrantVote =&gt; {}
</a><a href="#h2-2-52" id="h2-2-52" class="i">+            Message::CampaignResponse { .. } =&gt; {}
</a> 
             // Forward client requests to the leader, or abort them if there is
             // none (the client must retry).
<a href="#h2-3" id="h2-3" class="h">@@ -239,9 +242,9 @@ impl RawNode&lt;Follower&gt; {
</a>             }
 
             // We&#39;re not a leader nor candidate in this term, so we shoudn&#39;t see these.
<a href="#h2-3-3" id="h2-3-3" class="d">-            Message::ConfirmLeader { .. }
</a><a href="#h2-3-4" id="h2-3-4" class="d">-            | Message::AcceptEntries { .. }
</a><a href="#h2-3-5" id="h2-3-5" class="d">-            | Message::RejectEntries { .. } =&gt; panic!(&quot;Received unexpected message {:?}&quot;, msg),
</a><a href="#h2-3-6" id="h2-3-6" class="i">+            Message::HeartbeatResponse { .. } | Message::AppendResponse { .. } =&gt; {
</a><a href="#h2-3-7" id="h2-3-7" class="i">+                panic!(&quot;Received unexpected message {msg:?}&quot;)
</a><a href="#h2-3-8" id="h2-3-8" class="i">+            }
</a>         };
         Ok(self.into())
     }
<a href="#h2-4" id="h2-4" class="h">@@ -328,7 +331,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-4-3" id="h2-4-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-4-4" id="h2-4-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-5" id="h2-5" class="h">@@ -351,7 +354,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-5-3" id="h2-5-3" class="d">-                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h2-5-4" id="h2-5-4" class="i">+                message: Message::HeartbeatResponse { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-6" id="h2-6" class="h">@@ -374,7 +377,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-6-3" id="h2-6-3" class="d">-                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h2-6-4" id="h2-6-4" class="i">+                message: Message::HeartbeatResponse { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-7" id="h2-7" class="h">@@ -413,7 +416,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 3,
                 term: 3,
<a href="#h2-7-3" id="h2-7-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-7-4" id="h2-7-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-8" id="h2-8" class="h">@@ -436,7 +439,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-8-3" id="h2-8-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-8-4" id="h2-8-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-9" id="h2-9" class="h">@@ -459,7 +462,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 3,
                 term: 4,
<a href="#h2-9-3" id="h2-9-3" class="d">-                message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-9-4" id="h2-9-4" class="i">+                message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h2-10" id="h2-10" class="h">@@ -490,12 +493,17 @@ pub mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h2-10-3" id="h2-10-3" class="d">-            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-10-4" id="h2-10-4" class="i">+            message: Message::Campaign { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-10-9" id="h2-10-9" class="d">-            vec![Envelope { from: 1, to: 3, term: 3, message: Message::GrantVote }],
</a><a href="#h2-10-10" id="h2-10-10" class="i">+            vec![Envelope {
</a><a href="#h2-10-11" id="h2-10-11" class="i">+                from: 1,
</a><a href="#h2-10-12" id="h2-10-12" class="i">+                to: 3,
</a><a href="#h2-10-13" id="h2-10-13" class="i">+                term: 3,
</a><a href="#h2-10-14" id="h2-10-14" class="i">+                message: Message::CampaignResponse { vote: true },
</a><a href="#h2-10-15" id="h2-10-15" class="i">+            }],
</a>         );
 
         // Another vote request from the same sender is granted.
<a href="#h2-11" id="h2-11" class="h">@@ -503,12 +511,17 @@ pub mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h2-11-3" id="h2-11-3" class="d">-            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-11-4" id="h2-11-4" class="i">+            message: Message::Campaign { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-11-9" id="h2-11-9" class="d">-            vec![Envelope { from: 1, to: 3, term: 3, message: Message::GrantVote }],
</a><a href="#h2-11-10" id="h2-11-10" class="i">+            vec![Envelope {
</a><a href="#h2-11-11" id="h2-11-11" class="i">+                from: 1,
</a><a href="#h2-11-12" id="h2-11-12" class="i">+                to: 3,
</a><a href="#h2-11-13" id="h2-11-13" class="i">+                term: 3,
</a><a href="#h2-11-14" id="h2-11-14" class="i">+                message: Message::CampaignResponse { vote: true },
</a><a href="#h2-11-15" id="h2-11-15" class="i">+            }],
</a>         );
 
         // But a vote request from a different node is ignored.
<a href="#h2-12" id="h2-12" class="h">@@ -516,19 +529,31 @@ pub mod tests {
</a>             from: 4,
             to: 1,
             term: 3,
<a href="#h2-12-3" id="h2-12-3" class="d">-            message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-12-4" id="h2-12-4" class="i">+            message: Message::Campaign { last_index: 3, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(Some(3));
<a href="#h2-12-7" id="h2-12-7" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h2-12-8" id="h2-12-8" class="i">+        assert_messages(
</a><a href="#h2-12-9" id="h2-12-9" class="i">+            &amp;mut node_rx,
</a><a href="#h2-12-10" id="h2-12-10" class="i">+            vec![Envelope {
</a><a href="#h2-12-11" id="h2-12-11" class="i">+                from: 1,
</a><a href="#h2-12-12" id="h2-12-12" class="i">+                to: 4,
</a><a href="#h2-12-13" id="h2-12-13" class="i">+                term: 3,
</a><a href="#h2-12-14" id="h2-12-14" class="i">+                message: Message::CampaignResponse { vote: false },
</a><a href="#h2-12-15" id="h2-12-15" class="i">+            }],
</a><a href="#h2-12-16" id="h2-12-16" class="i">+        );
</a>         Ok(())
     }
 
     #[test]
<a href="#h2-12-21" id="h2-12-21" class="d">-    // GrantVote messages are ignored
</a><a href="#h2-12-22" id="h2-12-22" class="i">+    // Vote messages are ignored.
</a>     fn step_grantvote_noop() -&gt; Result&lt;()&gt; {
         let (follower, mut node_rx) = setup()?;
<a href="#h2-12-25" id="h2-12-25" class="d">-        let mut node =
</a><a href="#h2-12-26" id="h2-12-26" class="d">-            follower.step(Envelope { from: 2, to: 1, term: 3, message: Message::GrantVote })?;
</a><a href="#h2-12-27" id="h2-12-27" class="i">+        let mut node = follower.step(Envelope {
</a><a href="#h2-12-28" id="h2-12-28" class="i">+            from: 2,
</a><a href="#h2-12-29" id="h2-12-29" class="i">+            to: 1,
</a><a href="#h2-12-30" id="h2-12-30" class="i">+            term: 3,
</a><a href="#h2-12-31" id="h2-12-31" class="i">+            message: Message::CampaignResponse { vote: true },
</a><a href="#h2-12-32" id="h2-12-32" class="i">+        })?;
</a>         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2));
         assert_messages(&amp;mut node_rx, vec![]);
         Ok(())
<a href="#h2-13" id="h2-13" class="h">@@ -542,10 +567,18 @@ pub mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h2-13-3" id="h2-13-3" class="d">-            message: Message::SolicitVote { last_index: 2, last_term: 2 },
</a><a href="#h2-13-4" id="h2-13-4" class="i">+            message: Message::Campaign { last_index: 2, last_term: 2 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
<a href="#h2-13-7" id="h2-13-7" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h2-13-8" id="h2-13-8" class="i">+        assert_messages(
</a><a href="#h2-13-9" id="h2-13-9" class="i">+            &amp;mut node_rx,
</a><a href="#h2-13-10" id="h2-13-10" class="i">+            vec![Envelope {
</a><a href="#h2-13-11" id="h2-13-11" class="i">+                from: 1,
</a><a href="#h2-13-12" id="h2-13-12" class="i">+                to: 3,
</a><a href="#h2-13-13" id="h2-13-13" class="i">+                term: 3,
</a><a href="#h2-13-14" id="h2-13-14" class="i">+                message: Message::CampaignResponse { vote: false },
</a><a href="#h2-13-15" id="h2-13-15" class="i">+            }],
</a><a href="#h2-13-16" id="h2-13-16" class="i">+        );
</a>         Ok(())
     }
 
<a href="#h2-14" id="h2-14" class="h">@@ -557,10 +590,18 @@ pub mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h2-14-3" id="h2-14-3" class="d">-            message: Message::SolicitVote { last_index: 3, last_term: 1 },
</a><a href="#h2-14-4" id="h2-14-4" class="i">+            message: Message::Campaign { last_index: 3, last_term: 1 },
</a>         })?;
         assert_node(&amp;mut node).is_follower().term(3).leader(Some(2)).voted_for(None);
<a href="#h2-14-7" id="h2-14-7" class="d">-        assert_messages(&amp;mut node_rx, vec![]);
</a><a href="#h2-14-8" id="h2-14-8" class="i">+        assert_messages(
</a><a href="#h2-14-9" id="h2-14-9" class="i">+            &amp;mut node_rx,
</a><a href="#h2-14-10" id="h2-14-10" class="i">+            vec![Envelope {
</a><a href="#h2-14-11" id="h2-14-11" class="i">+                from: 1,
</a><a href="#h2-14-12" id="h2-14-12" class="i">+                to: 3,
</a><a href="#h2-14-13" id="h2-14-13" class="i">+                term: 3,
</a><a href="#h2-14-14" id="h2-14-14" class="i">+                message: Message::CampaignResponse { vote: false },
</a><a href="#h2-14-15" id="h2-14-15" class="i">+            }],
</a><a href="#h2-14-16" id="h2-14-16" class="i">+        );
</a>         Ok(())
     }
 
<a href="#h2-15" id="h2-15" class="h">@@ -589,7 +630,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-15-3" id="h2-15-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-15-4" id="h2-15-4" class="i">+            message: Message::Append {
</a>                 base_index: 0,
                 base_term: 0,
                 entries: vec![
<a href="#h2-16" id="h2-16" class="h">@@ -608,7 +649,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-16-3" id="h2-16-3" class="d">-                message: Message::AcceptEntries { last_index: 2 },
</a><a href="#h2-16-4" id="h2-16-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 2 },
</a>             }],
         );
         Ok(())
<a href="#h2-17" id="h2-17" class="h">@@ -622,7 +663,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-17-3" id="h2-17-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-17-4" id="h2-17-4" class="i">+            message: Message::Append {
</a>                 base_index: 3,
                 base_term: 2,
                 entries: vec![
<a href="#h2-18" id="h2-18" class="h">@@ -644,7 +685,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-18-3" id="h2-18-3" class="d">-                message: Message::AcceptEntries { last_index: 5 },
</a><a href="#h2-18-4" id="h2-18-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 5 },
</a>             }],
         );
         Ok(())
<a href="#h2-19" id="h2-19" class="h">@@ -658,7 +699,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-19-3" id="h2-19-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-19-4" id="h2-19-4" class="i">+            message: Message::Append {
</a>                 base_index: 1,
                 base_term: 1,
                 entries: vec![
<a href="#h2-20" id="h2-20" class="h">@@ -679,7 +720,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-20-3" id="h2-20-3" class="d">-                message: Message::AcceptEntries { last_index: 4 },
</a><a href="#h2-20-4" id="h2-20-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h2-21" id="h2-21" class="h">@@ -693,7 +734,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-21-3" id="h2-21-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-21-4" id="h2-21-4" class="i">+            message: Message::Append {
</a>                 base_index: 2,
                 base_term: 1,
                 entries: vec![
<a href="#h2-22" id="h2-22" class="h">@@ -714,7 +755,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-22-3" id="h2-22-3" class="d">-                message: Message::AcceptEntries { last_index: 4 },
</a><a href="#h2-22-4" id="h2-22-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h2-23" id="h2-23" class="h">@@ -728,7 +769,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-23-3" id="h2-23-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-23-4" id="h2-23-4" class="i">+            message: Message::Append {
</a>                 base_index: 2,
                 base_term: 1,
                 entries: vec![
<a href="#h2-24" id="h2-24" class="h">@@ -749,7 +790,7 @@ pub mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h2-24-3" id="h2-24-3" class="d">-                message: Message::AcceptEntries { last_index: 4 },
</a><a href="#h2-24-4" id="h2-24-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 4 },
</a>             }],
         );
         Ok(())
<a href="#h2-25" id="h2-25" class="h">@@ -763,7 +804,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-25-3" id="h2-25-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-25-4" id="h2-25-4" class="i">+            message: Message::Append {
</a>                 base_index: 5,
                 base_term: 2,
                 entries: vec![Entry { index: 6, term: 3, command: Some(vec![0x04]) }],
<a href="#h2-26" id="h2-26" class="h">@@ -776,7 +817,12 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-26-3" id="h2-26-3" class="d">-            vec![Envelope { from: 1, to: 2, term: 3, message: Message::RejectEntries }],
</a><a href="#h2-26-4" id="h2-26-4" class="i">+            vec![Envelope {
</a><a href="#h2-26-5" id="h2-26-5" class="i">+                from: 1,
</a><a href="#h2-26-6" id="h2-26-6" class="i">+                to: 2,
</a><a href="#h2-26-7" id="h2-26-7" class="i">+                term: 3,
</a><a href="#h2-26-8" id="h2-26-8" class="i">+                message: Message::AppendResponse { reject: true, last_index: 3 },
</a><a href="#h2-26-9" id="h2-26-9" class="i">+            }],
</a>         );
         Ok(())
     }
<a href="#h2-27" id="h2-27" class="h">@@ -789,7 +835,7 @@ pub mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h2-27-3" id="h2-27-3" class="d">-            message: Message::AppendEntries {
</a><a href="#h2-27-4" id="h2-27-4" class="i">+            message: Message::Append {
</a>                 base_index: 1,
                 base_term: 2,
                 entries: vec![Entry { index: 2, term: 3, command: Some(vec![0x04]) }],
<a href="#h2-28" id="h2-28" class="h">@@ -802,7 +848,12 @@ pub mod tests {
</a>         ]);
         assert_messages(
             &amp;mut node_rx,
<a href="#h2-28-3" id="h2-28-3" class="d">-            vec![Envelope { from: 1, to: 2, term: 3, message: Message::RejectEntries }],
</a><a href="#h2-28-4" id="h2-28-4" class="i">+            vec![Envelope {
</a><a href="#h2-28-5" id="h2-28-5" class="i">+                from: 1,
</a><a href="#h2-28-6" id="h2-28-6" class="i">+                to: 2,
</a><a href="#h2-28-7" id="h2-28-7" class="i">+                term: 3,
</a><a href="#h2-28-8" id="h2-28-8" class="i">+                message: Message::AppendResponse { reject: true, last_index: 3 },
</a><a href="#h2-28-9" id="h2-28-9" class="i">+            }],
</a>         );
         Ok(())
     }
<a href="#h2-29" id="h2-29" class="h">@@ -943,7 +994,7 @@ pub mod tests {
</a>                     from: 1,
                     to: 3,
                     term: 4,
<a href="#h2-29-3" id="h2-29-3" class="d">-                    message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-29-4" id="h2-29-4" class="i">+                    message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>                 },
             ],
         );
<a href="#h2-30" id="h2-30" class="h">@@ -974,7 +1025,7 @@ pub mod tests {
</a>                     from: 1,
                     to: 2,
                     term: 3,
<a href="#h2-30-3" id="h2-30-3" class="d">-                    message: Message::ConfirmLeader { has_committed: true, read_seq: 7 },
</a><a href="#h2-30-4" id="h2-30-4" class="i">+                    message: Message::HeartbeatResponse { has_committed: true, read_seq: 7 },
</a>                 }],
             )
         }
<a href="#h2-31" id="h2-31" class="h">@@ -992,7 +1043,7 @@ pub mod tests {
</a>                     from: 1,
                     to,
                     term: 4,
<a href="#h2-31-3" id="h2-31-3" class="d">-                    message: Message::SolicitVote { last_index: 3, last_term: 2 },
</a><a href="#h2-31-4" id="h2-31-4" class="i">+                    message: Message::Campaign { last_index: 3, last_term: 2 },
</a>                 },
             );
         }
<b>diff --git a/<a id="h3" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -147,7 +147,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
         match msg.message {
             // There can&#39;t be two leaders in the same term.
<a href="#h3-0-3" id="h3-0-3" class="d">-            Message::Heartbeat { .. } | Message::AppendEntries { .. } =&gt; {
</a><a href="#h3-0-4" id="h3-0-4" class="i">+            Message::Heartbeat { .. } | Message::Append { .. } =&gt; {
</a>                 panic!(&quot;Saw other leader {} in term {}&quot;, msg.from, msg.term);
             }
 
<a href="#h3-1" id="h3-1" class="h">@@ -155,7 +155,7 @@ impl RawNode&lt;Leader&gt; {
</a>             // are its leader. If it doesn&#39;t have the commit index in its local
             // log, replicate the log to it. If the peer&#39;s read sequence number
             // increased, process any pending reads.
<a href="#h3-1-3" id="h3-1-3" class="d">-            Message::ConfirmLeader { has_committed, read_seq } =&gt; {
</a><a href="#h3-1-4" id="h3-1-4" class="i">+            Message::HeartbeatResponse { has_committed, read_seq } =&gt; {
</a>                 assert!(read_seq &lt;= self.role.read_seq, &quot;Future read sequence number&quot;);
 
                 let from = msg.from;
<a href="#h3-2" id="h3-2" class="h">@@ -172,7 +172,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
             // A follower appended log entries we sent it. Record its progress
             // and attempt to commit new entries.
<a href="#h3-2-3" id="h3-2-3" class="d">-            Message::AcceptEntries { last_index } =&gt; {
</a><a href="#h3-2-4" id="h3-2-4" class="i">+            Message::AppendResponse { reject: false, last_index } =&gt; {
</a>                 assert!(
                     last_index &lt;= self.log.get_last_index().0,
                     &quot;Follower accepted entries after last index&quot;
<a href="#h3-3" id="h3-3" class="h">@@ -193,7 +193,9 @@ impl RawNode&lt;Leader&gt; {
</a>             //
             // This linear probing, as described in the Raft paper, can be very
             // slow with long divergent logs, but we keep it simple.
<a href="#h3-3-3" id="h3-3-3" class="d">-            Message::RejectEntries =&gt; {
</a><a href="#h3-3-4" id="h3-3-4" class="i">+            //
</a><a href="#h3-3-5" id="h3-3-5" class="i">+            // TODO: make use of last_index and last_term here.
</a><a href="#h3-3-6" id="h3-3-6" class="i">+            Message::AppendResponse { reject: true, last_index: _ } =&gt; {
</a>                 let from = msg.from;
                 self.role.progress.entry(from).and_modify(|p| {
                     if p.next &gt; 1 {
<a href="#h3-4" id="h3-4" class="h">@@ -253,7 +255,7 @@ impl RawNode&lt;Leader&gt; {
</a>             }
 
             // Votes can come in after we won the election, ignore them.
<a href="#h3-4-3" id="h3-4-3" class="d">-            Message::SolicitVote { .. } | Message::GrantVote =&gt; {}
</a><a href="#h3-4-4" id="h3-4-4" class="i">+            Message::Campaign { .. } | Message::CampaignResponse { .. } =&gt; {}
</a> 
             // Leaders never proxy client requests, so we don&#39;t expect to see
             // responses from other nodes.
<a href="#h3-5" id="h3-5" class="h">@@ -394,7 +396,7 @@ impl RawNode&lt;Leader&gt; {
</a> 
         let entries = self.log.scan((base_index + 1)..)?.collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
         debug!(&quot;Replicating {} entries at base {} to {}&quot;, entries.len(), base_index, peer);
<a href="#h3-5-3" id="h3-5-3" class="d">-        self.send(peer, Message::AppendEntries { base_index, base_term, entries })?;
</a><a href="#h3-5-4" id="h3-5-4" class="i">+        self.send(peer, Message::Append { base_index, base_term, entries })?;
</a>         Ok(())
     }
 }
<a href="#h3-6" id="h3-6" class="h">@@ -445,7 +447,7 @@ mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-6-3" id="h3-6-3" class="d">-            message: Message::ConfirmLeader { has_committed: true, read_seq: 0 },
</a><a href="#h3-6-4" id="h3-6-4" class="i">+            message: Message::HeartbeatResponse { has_committed: true, read_seq: 0 },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-7" id="h3-7" class="h">@@ -462,7 +464,7 @@ mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-7-3" id="h3-7-3" class="d">-            message: Message::ConfirmLeader { has_committed: false, read_seq: 0 },
</a><a href="#h3-7-4" id="h3-7-4" class="i">+            message: Message::HeartbeatResponse { has_committed: false, read_seq: 0 },
</a>         })?;
         assert_node(&amp;mut node).is_leader().term(3).committed(2);
         assert_messages(
<a href="#h3-8" id="h3-8" class="h">@@ -471,7 +473,7 @@ mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 3,
<a href="#h3-8-3" id="h3-8-3" class="d">-                message: Message::AppendEntries { base_index: 5, base_term: 3, entries: vec![] },
</a><a href="#h3-8-4" id="h3-8-4" class="i">+                message: Message::Append { base_index: 5, base_term: 3, entries: vec![] },
</a>             }],
         );
         Ok(())
<a href="#h3-9" id="h3-9" class="h">@@ -511,7 +513,7 @@ mod tests {
</a>                 from: 1,
                 to: 2,
                 term: 4,
<a href="#h3-9-3" id="h3-9-3" class="d">-                message: Message::ConfirmLeader { has_committed: false, read_seq: 7 },
</a><a href="#h3-9-4" id="h3-9-4" class="i">+                message: Message::HeartbeatResponse { has_committed: false, read_seq: 7 },
</a>             }],
         );
         Ok(())
<a href="#h3-10" id="h3-10" class="h">@@ -543,7 +545,7 @@ mod tests {
</a>             from: 2,
             to: 1,
             term: 3,
<a href="#h3-10-3" id="h3-10-3" class="d">-            message: Message::AcceptEntries { last_index: 4 },
</a><a href="#h3-10-4" id="h3-10-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 4 },
</a>         })?;
         assert_node(&amp;mut node).committed(2);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-11" id="h3-11" class="h">@@ -552,7 +554,7 @@ mod tests {
</a>             from: 3,
             to: 1,
             term: 3,
<a href="#h3-11-3" id="h3-11-3" class="d">-            message: Message::AcceptEntries { last_index: 5 },
</a><a href="#h3-11-4" id="h3-11-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 5 },
</a>         })?;
         assert_node(&amp;mut node).committed(4).applied(4);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-12" id="h3-12" class="h">@@ -561,7 +563,7 @@ mod tests {
</a>             from: 4,
             to: 1,
             term: 3,
<a href="#h3-12-3" id="h3-12-3" class="d">-            message: Message::AcceptEntries { last_index: 5 },
</a><a href="#h3-12-4" id="h3-12-4" class="i">+            message: Message::AppendResponse { reject: false, last_index: 5 },
</a>         })?;
         assert_node(&amp;mut node).committed(5).applied(5);
         assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-13" id="h3-13" class="h">@@ -581,7 +583,7 @@ mod tests {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h3-13-3" id="h3-13-3" class="d">-                message: Message::AcceptEntries { last_index: 5 },
</a><a href="#h3-13-4" id="h3-13-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 5 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-14" id="h3-14" class="h">@@ -601,7 +603,7 @@ mod tests {
</a>                 from: peer,
                 to: 1,
                 term: 3,
<a href="#h3-14-3" id="h3-14-3" class="d">-                message: Message::AcceptEntries { last_index: 3 },
</a><a href="#h3-14-4" id="h3-14-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 3 },
</a>             })?;
             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             assert_messages(&amp;mut node_rx, vec![]);
<a href="#h3-15" id="h3-15" class="h">@@ -619,7 +621,7 @@ mod tests {
</a>                 from: 2,
                 to: 1,
                 term: 3,
<a href="#h3-15-3" id="h3-15-3" class="d">-                message: Message::AcceptEntries { last_index: 7 },
</a><a href="#h3-15-4" id="h3-15-4" class="i">+                message: Message::AppendResponse { reject: false, last_index: 7 },
</a>             })
             .unwrap();
     }
<a href="#h3-16" id="h3-16" class="h">@@ -631,8 +633,12 @@ mod tests {
</a>         let mut node: Node = leader.into();
 
         for i in 0..(entries.len() + 3) {
<a href="#h3-16-3" id="h3-16-3" class="d">-            node =
</a><a href="#h3-16-4" id="h3-16-4" class="d">-                node.step(Envelope { from: 2, to: 1, term: 3, message: Message::RejectEntries })?;
</a><a href="#h3-16-5" id="h3-16-5" class="i">+            node = node.step(Envelope {
</a><a href="#h3-16-6" id="h3-16-6" class="i">+                from: 2,
</a><a href="#h3-16-7" id="h3-16-7" class="i">+                to: 1,
</a><a href="#h3-16-8" id="h3-16-8" class="i">+                term: 3,
</a><a href="#h3-16-9" id="h3-16-9" class="i">+                message: Message::AppendResponse { reject: true, last_index: 0 },
</a><a href="#h3-16-10" id="h3-16-10" class="i">+            })?;
</a>             assert_node(&amp;mut node).is_leader().term(3).committed(2);
             let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
             let replicate = entries.get(index..).unwrap().to_vec();
<a href="#h3-17" id="h3-17" class="h">@@ -642,7 +648,7 @@ mod tests {
</a>                     from: 1,
                     to: 2,
                     term: 3,
<a href="#h3-17-3" id="h3-17-3" class="d">-                    message: Message::AppendEntries {
</a><a href="#h3-17-4" id="h3-17-4" class="i">+                    message: Message::Append {
</a>                         base_index: index as Index,
                         base_term: if index &gt; 0 {
                             entries.get(index - 1).map(|e| e.term).unwrap()
<a href="#h3-18" id="h3-18" class="h">@@ -713,7 +719,7 @@ mod tests {
</a>                     from: 1,
                     to: peer,
                     term: 3,
<a href="#h3-18-3" id="h3-18-3" class="d">-                    message: Message::AppendEntries {
</a><a href="#h3-18-4" id="h3-18-4" class="i">+                    message: Message::Append {
</a>                         base_index: 5,
                         base_term: 3,
                         entries: vec![Entry { index: 6, term: 3, command: Some(vec![0xaf]) },]
</pre>
</div>
</body>
</html>
