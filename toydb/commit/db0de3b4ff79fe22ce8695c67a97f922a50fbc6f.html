<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Remove old, unused log storage engines - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/db0de3b4ff79fe22ce8695c67a97f922a50fbc6f.html">db0de3b4ff79fe22ce8695c67a97f922a50fbc6f</a>
<b>parent</b> <a href="../commit/60567b54c45f6a568402bc7c288b0b5f06ad6b78.html">60567b54c45f6a568402bc7c288b0b5f06ad6b78</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue, 14 Nov 2023 21:53:46 +0100

Remove old, unused log storage engines

<b>Diffstat:</b>
<table><tr><td class="D">D</td><td><a href="#h0">src/storage/log/hybrid.rs</a></td><td> | </td><td class="num">308</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h1">src/storage/log/memory.rs</a></td><td> | </td><td class="num">120</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h2">src/storage/log/mod.rs</a></td><td> | </td><td class="num">200</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h3">src/storage/log/test.rs</a></td><td> | </td><td class="num">81</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/storage/mod.rs</a></td><td> | </td><td class="num">1</td><td><span class="i"></span><span class="d">-</span></td></tr>
</table></pre><pre>5 files changed, 0 insertions(+), 710 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/storage/log/hybrid.rs.html">src/storage/log/hybrid.rs</a> b/<a href="../file/src/storage/log/hybrid.rs.html">src/storage/log/hybrid.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,308 +0,0 @@
</a><a href="#h0-0-0" id="h0-0-0" class="d">-use super::{Range, Scan, Store};
</a><a href="#h0-0-1" id="h0-0-1" class="d">-use crate::error::{Error, Result};
</a><a href="#h0-0-2" id="h0-0-2" class="d">-
</a><a href="#h0-0-3" id="h0-0-3" class="d">-use std::cmp::{max, min};
</a><a href="#h0-0-4" id="h0-0-4" class="d">-use std::collections::{BTreeMap, HashMap, VecDeque};
</a><a href="#h0-0-5" id="h0-0-5" class="d">-use std::fmt::Display;
</a><a href="#h0-0-6" id="h0-0-6" class="d">-use std::fs::{create_dir_all, File, OpenOptions};
</a><a href="#h0-0-7" id="h0-0-7" class="d">-use std::io::{BufReader, BufWriter, Read, Seek as _, SeekFrom, Write};
</a><a href="#h0-0-8" id="h0-0-8" class="d">-use std::ops::Bound;
</a><a href="#h0-0-9" id="h0-0-9" class="d">-use std::path::Path;
</a><a href="#h0-0-10" id="h0-0-10" class="d">-use std::sync::{Mutex, MutexGuard};
</a><a href="#h0-0-11" id="h0-0-11" class="d">-
</a><a href="#h0-0-12" id="h0-0-12" class="d">-/// A hybrid log store, storing committed entries in an append-only file, uncommitted entries
</a><a href="#h0-0-13" id="h0-0-13" class="d">-/// in memory, and metadata in a separate file (should be an on-disk key-value store).
</a><a href="#h0-0-14" id="h0-0-14" class="d">-///
</a><a href="#h0-0-15" id="h0-0-15" class="d">-/// The log file contains sequential binary log entries, length-prefixed with a big-endian u32.
</a><a href="#h0-0-16" id="h0-0-16" class="d">-/// Entries are only flushed to disk when they are committed and permanent, thus the file is
</a><a href="#h0-0-17" id="h0-0-17" class="d">-/// written append-only.
</a><a href="#h0-0-18" id="h0-0-18" class="d">-///
</a><a href="#h0-0-19" id="h0-0-19" class="d">-/// An index of entry positions and sizes is maintained in memory. This is rebuilt on startup by
</a><a href="#h0-0-20" id="h0-0-20" class="d">-/// scanning the file, since maintaining the index in a separate file requires additional fsyncing
</a><a href="#h0-0-21" id="h0-0-21" class="d">-/// which is expensive. Since datasets are expected to be small, scanning the file on startup is
</a><a href="#h0-0-22" id="h0-0-22" class="d">-/// reasonably cheap.
</a><a href="#h0-0-23" id="h0-0-23" class="d">-///
</a><a href="#h0-0-24" id="h0-0-24" class="d">-/// TODO: Should use crate::storage::bincode instead of ::bincode.
</a><a href="#h0-0-25" id="h0-0-25" class="d">-pub struct Hybrid {
</a><a href="#h0-0-26" id="h0-0-26" class="d">-    /// The append-only log file. Protected by a mutex for interior mutability (i.e. read seeks).
</a><a href="#h0-0-27" id="h0-0-27" class="d">-    file: Mutex&lt;File&gt;,
</a><a href="#h0-0-28" id="h0-0-28" class="d">-    /// Index of entry locations and sizes in the log file.
</a><a href="#h0-0-29" id="h0-0-29" class="d">-    index: BTreeMap&lt;u64, (u64, u32)&gt;,
</a><a href="#h0-0-30" id="h0-0-30" class="d">-    /// Uncommitted log entries.
</a><a href="#h0-0-31" id="h0-0-31" class="d">-    uncommitted: VecDeque&lt;Vec&lt;u8&gt;&gt;,
</a><a href="#h0-0-32" id="h0-0-32" class="d">-    /// Metadata cache. Flushed to disk on changes.
</a><a href="#h0-0-33" id="h0-0-33" class="d">-    metadata: HashMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;,
</a><a href="#h0-0-34" id="h0-0-34" class="d">-    /// The file used to store metadata.
</a><a href="#h0-0-35" id="h0-0-35" class="d">-    /// FIXME Should be an on-disk B-tree key-value store.
</a><a href="#h0-0-36" id="h0-0-36" class="d">-    metadata_file: File,
</a><a href="#h0-0-37" id="h0-0-37" class="d">-    /// If true, fsync writes.
</a><a href="#h0-0-38" id="h0-0-38" class="d">-    sync: bool,
</a><a href="#h0-0-39" id="h0-0-39" class="d">-}
</a><a href="#h0-0-40" id="h0-0-40" class="d">-
</a><a href="#h0-0-41" id="h0-0-41" class="d">-impl Display for Hybrid {
</a><a href="#h0-0-42" id="h0-0-42" class="d">-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h0-0-43" id="h0-0-43" class="d">-        write!(f, &quot;hybrid&quot;)
</a><a href="#h0-0-44" id="h0-0-44" class="d">-    }
</a><a href="#h0-0-45" id="h0-0-45" class="d">-}
</a><a href="#h0-0-46" id="h0-0-46" class="d">-
</a><a href="#h0-0-47" id="h0-0-47" class="d">-impl Hybrid {
</a><a href="#h0-0-48" id="h0-0-48" class="d">-    /// Creates or opens a new hybrid log, with files in the given directory.
</a><a href="#h0-0-49" id="h0-0-49" class="d">-    pub fn new(dir: &amp;Path, sync: bool) -&gt; Result&lt;Self&gt; {
</a><a href="#h0-0-50" id="h0-0-50" class="d">-        create_dir_all(dir)?;
</a><a href="#h0-0-51" id="h0-0-51" class="d">-
</a><a href="#h0-0-52" id="h0-0-52" class="d">-        let file =
</a><a href="#h0-0-53" id="h0-0-53" class="d">-            OpenOptions::new().read(true).write(true).create(true).open(dir.join(&quot;raft-log&quot;))?;
</a><a href="#h0-0-54" id="h0-0-54" class="d">-
</a><a href="#h0-0-55" id="h0-0-55" class="d">-        let metadata_file = OpenOptions::new()
</a><a href="#h0-0-56" id="h0-0-56" class="d">-            .read(true)
</a><a href="#h0-0-57" id="h0-0-57" class="d">-            .write(true)
</a><a href="#h0-0-58" id="h0-0-58" class="d">-            .create(true)
</a><a href="#h0-0-59" id="h0-0-59" class="d">-            .open(dir.join(&quot;raft-metadata&quot;))?;
</a><a href="#h0-0-60" id="h0-0-60" class="d">-
</a><a href="#h0-0-61" id="h0-0-61" class="d">-        Ok(Self {
</a><a href="#h0-0-62" id="h0-0-62" class="d">-            index: Self::build_index(&amp;file)?,
</a><a href="#h0-0-63" id="h0-0-63" class="d">-            file: Mutex::new(file),
</a><a href="#h0-0-64" id="h0-0-64" class="d">-            uncommitted: VecDeque::new(),
</a><a href="#h0-0-65" id="h0-0-65" class="d">-            metadata: Self::load_metadata(&amp;metadata_file)?,
</a><a href="#h0-0-66" id="h0-0-66" class="d">-            metadata_file,
</a><a href="#h0-0-67" id="h0-0-67" class="d">-            sync,
</a><a href="#h0-0-68" id="h0-0-68" class="d">-        })
</a><a href="#h0-0-69" id="h0-0-69" class="d">-    }
</a><a href="#h0-0-70" id="h0-0-70" class="d">-
</a><a href="#h0-0-71" id="h0-0-71" class="d">-    /// Builds the index by scanning the log file.
</a><a href="#h0-0-72" id="h0-0-72" class="d">-    fn build_index(file: &amp;File) -&gt; Result&lt;BTreeMap&lt;u64, (u64, u32)&gt;&gt; {
</a><a href="#h0-0-73" id="h0-0-73" class="d">-        let filesize = file.metadata()?.len();
</a><a href="#h0-0-74" id="h0-0-74" class="d">-        let mut bufreader = BufReader::new(file);
</a><a href="#h0-0-75" id="h0-0-75" class="d">-        let mut index = BTreeMap::new();
</a><a href="#h0-0-76" id="h0-0-76" class="d">-        let mut sizebuf = [0; 4];
</a><a href="#h0-0-77" id="h0-0-77" class="d">-        let mut pos = 0;
</a><a href="#h0-0-78" id="h0-0-78" class="d">-        let mut i = 1;
</a><a href="#h0-0-79" id="h0-0-79" class="d">-        while pos &lt; filesize {
</a><a href="#h0-0-80" id="h0-0-80" class="d">-            bufreader.read_exact(&amp;mut sizebuf)?;
</a><a href="#h0-0-81" id="h0-0-81" class="d">-            pos += 4;
</a><a href="#h0-0-82" id="h0-0-82" class="d">-            let size = u32::from_be_bytes(sizebuf);
</a><a href="#h0-0-83" id="h0-0-83" class="d">-            index.insert(i, (pos, size));
</a><a href="#h0-0-84" id="h0-0-84" class="d">-            let mut buf = vec![0; size as usize];
</a><a href="#h0-0-85" id="h0-0-85" class="d">-            bufreader.read_exact(&amp;mut buf)?;
</a><a href="#h0-0-86" id="h0-0-86" class="d">-            pos += size as u64;
</a><a href="#h0-0-87" id="h0-0-87" class="d">-            i += 1;
</a><a href="#h0-0-88" id="h0-0-88" class="d">-        }
</a><a href="#h0-0-89" id="h0-0-89" class="d">-        Ok(index)
</a><a href="#h0-0-90" id="h0-0-90" class="d">-    }
</a><a href="#h0-0-91" id="h0-0-91" class="d">-
</a><a href="#h0-0-92" id="h0-0-92" class="d">-    /// Loads metadata from a file.
</a><a href="#h0-0-93" id="h0-0-93" class="d">-    fn load_metadata(file: &amp;File) -&gt; Result&lt;HashMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h0-0-94" id="h0-0-94" class="d">-        match bincode::deserialize_from(file) {
</a><a href="#h0-0-95" id="h0-0-95" class="d">-            Ok(metadata) =&gt; Ok(metadata),
</a><a href="#h0-0-96" id="h0-0-96" class="d">-            Err(err) =&gt; {
</a><a href="#h0-0-97" id="h0-0-97" class="d">-                if let bincode::ErrorKind::Io(err) = &amp;*err {
</a><a href="#h0-0-98" id="h0-0-98" class="d">-                    if err.kind() == std::io::ErrorKind::UnexpectedEof {
</a><a href="#h0-0-99" id="h0-0-99" class="d">-                        return Ok(HashMap::new());
</a><a href="#h0-0-100" id="h0-0-100" class="d">-                    }
</a><a href="#h0-0-101" id="h0-0-101" class="d">-                }
</a><a href="#h0-0-102" id="h0-0-102" class="d">-                Err(err.into())
</a><a href="#h0-0-103" id="h0-0-103" class="d">-            }
</a><a href="#h0-0-104" id="h0-0-104" class="d">-        }
</a><a href="#h0-0-105" id="h0-0-105" class="d">-    }
</a><a href="#h0-0-106" id="h0-0-106" class="d">-}
</a><a href="#h0-0-107" id="h0-0-107" class="d">-
</a><a href="#h0-0-108" id="h0-0-108" class="d">-impl Store for Hybrid {
</a><a href="#h0-0-109" id="h0-0-109" class="d">-    fn append(&amp;mut self, entry: Vec&lt;u8&gt;) -&gt; Result&lt;u64&gt; {
</a><a href="#h0-0-110" id="h0-0-110" class="d">-        self.uncommitted.push_back(entry);
</a><a href="#h0-0-111" id="h0-0-111" class="d">-        Ok(self.len())
</a><a href="#h0-0-112" id="h0-0-112" class="d">-    }
</a><a href="#h0-0-113" id="h0-0-113" class="d">-
</a><a href="#h0-0-114" id="h0-0-114" class="d">-    fn commit(&amp;mut self, index: u64) -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-115" id="h0-0-115" class="d">-        if index &gt; self.len() {
</a><a href="#h0-0-116" id="h0-0-116" class="d">-            return Err(Error::Internal(format!(&quot;Cannot commit non-existant index {}&quot;, index)));
</a><a href="#h0-0-117" id="h0-0-117" class="d">-        }
</a><a href="#h0-0-118" id="h0-0-118" class="d">-        if index &lt; self.index.len() as u64 {
</a><a href="#h0-0-119" id="h0-0-119" class="d">-            return Err(Error::Internal(format!(
</a><a href="#h0-0-120" id="h0-0-120" class="d">-                &quot;Cannot commit below current committed index {}&quot;,
</a><a href="#h0-0-121" id="h0-0-121" class="d">-                self.index.len() as u64
</a><a href="#h0-0-122" id="h0-0-122" class="d">-            )));
</a><a href="#h0-0-123" id="h0-0-123" class="d">-        }
</a><a href="#h0-0-124" id="h0-0-124" class="d">-        if index == self.index.len() as u64 {
</a><a href="#h0-0-125" id="h0-0-125" class="d">-            return Ok(());
</a><a href="#h0-0-126" id="h0-0-126" class="d">-        }
</a><a href="#h0-0-127" id="h0-0-127" class="d">-
</a><a href="#h0-0-128" id="h0-0-128" class="d">-        let mut file = self.file.lock()?;
</a><a href="#h0-0-129" id="h0-0-129" class="d">-        let mut pos = file.seek(SeekFrom::End(0))?;
</a><a href="#h0-0-130" id="h0-0-130" class="d">-        let mut bufwriter = BufWriter::new(&amp;mut *file);
</a><a href="#h0-0-131" id="h0-0-131" class="d">-        for i in (self.index.len() as u64 + 1)..=index {
</a><a href="#h0-0-132" id="h0-0-132" class="d">-            let entry = self
</a><a href="#h0-0-133" id="h0-0-133" class="d">-                .uncommitted
</a><a href="#h0-0-134" id="h0-0-134" class="d">-                .pop_front()
</a><a href="#h0-0-135" id="h0-0-135" class="d">-                .ok_or_else(|| Error::Internal(&quot;Unexpected end of uncommitted entries&quot;.into()))?;
</a><a href="#h0-0-136" id="h0-0-136" class="d">-            bufwriter.write_all(&amp;(entry.len() as u32).to_be_bytes())?;
</a><a href="#h0-0-137" id="h0-0-137" class="d">-            pos += 4;
</a><a href="#h0-0-138" id="h0-0-138" class="d">-            self.index.insert(i, (pos, entry.len() as u32));
</a><a href="#h0-0-139" id="h0-0-139" class="d">-            bufwriter.write_all(&amp;entry)?;
</a><a href="#h0-0-140" id="h0-0-140" class="d">-            pos += entry.len() as u64;
</a><a href="#h0-0-141" id="h0-0-141" class="d">-        }
</a><a href="#h0-0-142" id="h0-0-142" class="d">-        bufwriter.flush()?;
</a><a href="#h0-0-143" id="h0-0-143" class="d">-        drop(bufwriter);
</a><a href="#h0-0-144" id="h0-0-144" class="d">-        if self.sync {
</a><a href="#h0-0-145" id="h0-0-145" class="d">-            file.sync_data()?;
</a><a href="#h0-0-146" id="h0-0-146" class="d">-        }
</a><a href="#h0-0-147" id="h0-0-147" class="d">-        Ok(())
</a><a href="#h0-0-148" id="h0-0-148" class="d">-    }
</a><a href="#h0-0-149" id="h0-0-149" class="d">-
</a><a href="#h0-0-150" id="h0-0-150" class="d">-    fn committed(&amp;self) -&gt; u64 {
</a><a href="#h0-0-151" id="h0-0-151" class="d">-        self.index.len() as u64
</a><a href="#h0-0-152" id="h0-0-152" class="d">-    }
</a><a href="#h0-0-153" id="h0-0-153" class="d">-
</a><a href="#h0-0-154" id="h0-0-154" class="d">-    fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h0-0-155" id="h0-0-155" class="d">-        match index {
</a><a href="#h0-0-156" id="h0-0-156" class="d">-            0 =&gt; Ok(None),
</a><a href="#h0-0-157" id="h0-0-157" class="d">-            i if i &lt;= self.index.len() as u64 =&gt; {
</a><a href="#h0-0-158" id="h0-0-158" class="d">-                let (pos, size) = self.index.get(&amp;i).copied().ok_or_else(|| {
</a><a href="#h0-0-159" id="h0-0-159" class="d">-                    Error::Internal(format!(&quot;Indexed position not found for entry {}&quot;, i))
</a><a href="#h0-0-160" id="h0-0-160" class="d">-                })?;
</a><a href="#h0-0-161" id="h0-0-161" class="d">-                let mut entry = vec![0; size as usize];
</a><a href="#h0-0-162" id="h0-0-162" class="d">-                let mut file = self.file.lock()?;
</a><a href="#h0-0-163" id="h0-0-163" class="d">-                file.seek(SeekFrom::Start(pos))?;
</a><a href="#h0-0-164" id="h0-0-164" class="d">-                file.read_exact(&amp;mut entry)?;
</a><a href="#h0-0-165" id="h0-0-165" class="d">-                Ok(Some(entry))
</a><a href="#h0-0-166" id="h0-0-166" class="d">-            }
</a><a href="#h0-0-167" id="h0-0-167" class="d">-            i =&gt; Ok(self.uncommitted.get(i as usize - self.index.len() - 1).cloned()),
</a><a href="#h0-0-168" id="h0-0-168" class="d">-        }
</a><a href="#h0-0-169" id="h0-0-169" class="d">-    }
</a><a href="#h0-0-170" id="h0-0-170" class="d">-
</a><a href="#h0-0-171" id="h0-0-171" class="d">-    fn len(&amp;self) -&gt; u64 {
</a><a href="#h0-0-172" id="h0-0-172" class="d">-        self.index.len() as u64 + self.uncommitted.len() as u64
</a><a href="#h0-0-173" id="h0-0-173" class="d">-    }
</a><a href="#h0-0-174" id="h0-0-174" class="d">-
</a><a href="#h0-0-175" id="h0-0-175" class="d">-    fn scan(&amp;self, range: Range) -&gt; Scan {
</a><a href="#h0-0-176" id="h0-0-176" class="d">-        let start = match range.start {
</a><a href="#h0-0-177" id="h0-0-177" class="d">-            Bound::Included(0) =&gt; 1,
</a><a href="#h0-0-178" id="h0-0-178" class="d">-            Bound::Included(n) =&gt; n,
</a><a href="#h0-0-179" id="h0-0-179" class="d">-            Bound::Excluded(n) =&gt; n + 1,
</a><a href="#h0-0-180" id="h0-0-180" class="d">-            Bound::Unbounded =&gt; 1,
</a><a href="#h0-0-181" id="h0-0-181" class="d">-        };
</a><a href="#h0-0-182" id="h0-0-182" class="d">-        let end = match range.end {
</a><a href="#h0-0-183" id="h0-0-183" class="d">-            Bound::Included(n) =&gt; n,
</a><a href="#h0-0-184" id="h0-0-184" class="d">-            Bound::Excluded(0) =&gt; 0,
</a><a href="#h0-0-185" id="h0-0-185" class="d">-            Bound::Excluded(n) =&gt; n - 1,
</a><a href="#h0-0-186" id="h0-0-186" class="d">-            Bound::Unbounded =&gt; self.len(),
</a><a href="#h0-0-187" id="h0-0-187" class="d">-        };
</a><a href="#h0-0-188" id="h0-0-188" class="d">-
</a><a href="#h0-0-189" id="h0-0-189" class="d">-        let mut scan: Scan = Box::new(std::iter::empty());
</a><a href="#h0-0-190" id="h0-0-190" class="d">-        if start &gt; end {
</a><a href="#h0-0-191" id="h0-0-191" class="d">-            return scan;
</a><a href="#h0-0-192" id="h0-0-192" class="d">-        }
</a><a href="#h0-0-193" id="h0-0-193" class="d">-
</a><a href="#h0-0-194" id="h0-0-194" class="d">-        // Scan committed entries in file
</a><a href="#h0-0-195" id="h0-0-195" class="d">-        if let Some((offset, _)) = self.index.get(&amp;start) {
</a><a href="#h0-0-196" id="h0-0-196" class="d">-            let mut file = self.file.lock().unwrap();
</a><a href="#h0-0-197" id="h0-0-197" class="d">-            file.seek(SeekFrom::Start(*offset - 4)).unwrap(); // seek to length prefix
</a><a href="#h0-0-198" id="h0-0-198" class="d">-            let mut bufreader = BufReader::new(MutexReader(file)); // FIXME Avoid MutexReader
</a><a href="#h0-0-199" id="h0-0-199" class="d">-            scan =
</a><a href="#h0-0-200" id="h0-0-200" class="d">-                Box::new(scan.chain(self.index.range(start..=end).map(move |(_, (_, size))| {
</a><a href="#h0-0-201" id="h0-0-201" class="d">-                    let mut sizebuf = vec![0; 4];
</a><a href="#h0-0-202" id="h0-0-202" class="d">-                    bufreader.read_exact(&amp;mut sizebuf)?;
</a><a href="#h0-0-203" id="h0-0-203" class="d">-                    let mut entry = vec![0; *size as usize];
</a><a href="#h0-0-204" id="h0-0-204" class="d">-                    bufreader.read_exact(&amp;mut entry)?;
</a><a href="#h0-0-205" id="h0-0-205" class="d">-                    Ok(entry)
</a><a href="#h0-0-206" id="h0-0-206" class="d">-                })));
</a><a href="#h0-0-207" id="h0-0-207" class="d">-        }
</a><a href="#h0-0-208" id="h0-0-208" class="d">-
</a><a href="#h0-0-209" id="h0-0-209" class="d">-        // Scan uncommitted entries in memory
</a><a href="#h0-0-210" id="h0-0-210" class="d">-        if end &gt; self.index.len() as u64 {
</a><a href="#h0-0-211" id="h0-0-211" class="d">-            scan = Box::new(
</a><a href="#h0-0-212" id="h0-0-212" class="d">-                scan.chain(
</a><a href="#h0-0-213" id="h0-0-213" class="d">-                    self.uncommitted
</a><a href="#h0-0-214" id="h0-0-214" class="d">-                        .iter()
</a><a href="#h0-0-215" id="h0-0-215" class="d">-                        .skip(start as usize - min(start as usize, self.index.len() + 1))
</a><a href="#h0-0-216" id="h0-0-216" class="d">-                        .take(end as usize - max(start as usize, self.index.len()) + 1)
</a><a href="#h0-0-217" id="h0-0-217" class="d">-                        .cloned()
</a><a href="#h0-0-218" id="h0-0-218" class="d">-                        .map(Ok),
</a><a href="#h0-0-219" id="h0-0-219" class="d">-                ),
</a><a href="#h0-0-220" id="h0-0-220" class="d">-            )
</a><a href="#h0-0-221" id="h0-0-221" class="d">-        }
</a><a href="#h0-0-222" id="h0-0-222" class="d">-
</a><a href="#h0-0-223" id="h0-0-223" class="d">-        scan
</a><a href="#h0-0-224" id="h0-0-224" class="d">-    }
</a><a href="#h0-0-225" id="h0-0-225" class="d">-
</a><a href="#h0-0-226" id="h0-0-226" class="d">-    fn size(&amp;self) -&gt; u64 {
</a><a href="#h0-0-227" id="h0-0-227" class="d">-        self.index.iter().next_back().map(|(_, (pos, size))| *pos + *size as u64).unwrap_or(0)
</a><a href="#h0-0-228" id="h0-0-228" class="d">-    }
</a><a href="#h0-0-229" id="h0-0-229" class="d">-
</a><a href="#h0-0-230" id="h0-0-230" class="d">-    fn truncate(&amp;mut self, index: u64) -&gt; Result&lt;u64&gt; {
</a><a href="#h0-0-231" id="h0-0-231" class="d">-        if index &lt; self.index.len() as u64 {
</a><a href="#h0-0-232" id="h0-0-232" class="d">-            return Err(Error::Internal(format!(
</a><a href="#h0-0-233" id="h0-0-233" class="d">-                &quot;Cannot truncate below committed index {}&quot;,
</a><a href="#h0-0-234" id="h0-0-234" class="d">-                self.index.len() as u64
</a><a href="#h0-0-235" id="h0-0-235" class="d">-            )));
</a><a href="#h0-0-236" id="h0-0-236" class="d">-        }
</a><a href="#h0-0-237" id="h0-0-237" class="d">-        self.uncommitted.truncate(index as usize - self.index.len());
</a><a href="#h0-0-238" id="h0-0-238" class="d">-        Ok(self.len())
</a><a href="#h0-0-239" id="h0-0-239" class="d">-    }
</a><a href="#h0-0-240" id="h0-0-240" class="d">-
</a><a href="#h0-0-241" id="h0-0-241" class="d">-    fn get_metadata(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h0-0-242" id="h0-0-242" class="d">-        Ok(self.metadata.get(key).cloned())
</a><a href="#h0-0-243" id="h0-0-243" class="d">-    }
</a><a href="#h0-0-244" id="h0-0-244" class="d">-
</a><a href="#h0-0-245" id="h0-0-245" class="d">-    fn set_metadata(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-246" id="h0-0-246" class="d">-        self.metadata.insert(key.to_vec(), value);
</a><a href="#h0-0-247" id="h0-0-247" class="d">-        self.metadata_file.set_len(0)?;
</a><a href="#h0-0-248" id="h0-0-248" class="d">-        self.metadata_file.seek(SeekFrom::Start(0))?;
</a><a href="#h0-0-249" id="h0-0-249" class="d">-        bincode::serialize_into(&amp;mut self.metadata_file, &amp;self.metadata)?;
</a><a href="#h0-0-250" id="h0-0-250" class="d">-        if self.sync {
</a><a href="#h0-0-251" id="h0-0-251" class="d">-            self.metadata_file.sync_data()?;
</a><a href="#h0-0-252" id="h0-0-252" class="d">-        }
</a><a href="#h0-0-253" id="h0-0-253" class="d">-        Ok(())
</a><a href="#h0-0-254" id="h0-0-254" class="d">-    }
</a><a href="#h0-0-255" id="h0-0-255" class="d">-}
</a><a href="#h0-0-256" id="h0-0-256" class="d">-
</a><a href="#h0-0-257" id="h0-0-257" class="d">-impl Drop for Hybrid {
</a><a href="#h0-0-258" id="h0-0-258" class="d">-    /// Attempt to fsync data on drop, in case we&#39;re running without sync.
</a><a href="#h0-0-259" id="h0-0-259" class="d">-    fn drop(&amp;mut self) {
</a><a href="#h0-0-260" id="h0-0-260" class="d">-        self.metadata_file.sync_all().ok();
</a><a href="#h0-0-261" id="h0-0-261" class="d">-        self.file.lock().map(|f| f.sync_all()).ok();
</a><a href="#h0-0-262" id="h0-0-262" class="d">-    }
</a><a href="#h0-0-263" id="h0-0-263" class="d">-}
</a><a href="#h0-0-264" id="h0-0-264" class="d">-
</a><a href="#h0-0-265" id="h0-0-265" class="d">-struct MutexReader&lt;&#39;a&gt;(MutexGuard&lt;&#39;a, File&gt;);
</a><a href="#h0-0-266" id="h0-0-266" class="d">-
</a><a href="#h0-0-267" id="h0-0-267" class="d">-impl&lt;&#39;a&gt; Read for MutexReader&lt;&#39;a&gt; {
</a><a href="#h0-0-268" id="h0-0-268" class="d">-    fn read(&amp;mut self, buf: &amp;mut [u8]) -&gt; std::io::Result&lt;usize&gt; {
</a><a href="#h0-0-269" id="h0-0-269" class="d">-        self.0.read(buf)
</a><a href="#h0-0-270" id="h0-0-270" class="d">-    }
</a><a href="#h0-0-271" id="h0-0-271" class="d">-}
</a><a href="#h0-0-272" id="h0-0-272" class="d">-
</a><a href="#h0-0-273" id="h0-0-273" class="d">-#[cfg(test)]
</a><a href="#h0-0-274" id="h0-0-274" class="d">-impl super::TestSuite&lt;Hybrid&gt; for Hybrid {
</a><a href="#h0-0-275" id="h0-0-275" class="d">-    fn setup() -&gt; Result&lt;Self&gt; {
</a><a href="#h0-0-276" id="h0-0-276" class="d">-        let dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h0-0-277" id="h0-0-277" class="d">-        Hybrid::new(dir.as_ref(), false)
</a><a href="#h0-0-278" id="h0-0-278" class="d">-    }
</a><a href="#h0-0-279" id="h0-0-279" class="d">-}
</a><a href="#h0-0-280" id="h0-0-280" class="d">-
</a><a href="#h0-0-281" id="h0-0-281" class="d">-#[test]
</a><a href="#h0-0-282" id="h0-0-282" class="d">-fn tests() -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-283" id="h0-0-283" class="d">-    use super::TestSuite;
</a><a href="#h0-0-284" id="h0-0-284" class="d">-    Hybrid::test()
</a><a href="#h0-0-285" id="h0-0-285" class="d">-}
</a><a href="#h0-0-286" id="h0-0-286" class="d">-
</a><a href="#h0-0-287" id="h0-0-287" class="d">-#[test]
</a><a href="#h0-0-288" id="h0-0-288" class="d">-fn test_persistent() -&gt; Result&lt;()&gt; {
</a><a href="#h0-0-289" id="h0-0-289" class="d">-    let dir = tempdir::TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h0-0-290" id="h0-0-290" class="d">-    let mut l = Hybrid::new(dir.as_ref(), true)?;
</a><a href="#h0-0-291" id="h0-0-291" class="d">-
</a><a href="#h0-0-292" id="h0-0-292" class="d">-    l.append(vec![0x01])?;
</a><a href="#h0-0-293" id="h0-0-293" class="d">-    l.append(vec![0x02])?;
</a><a href="#h0-0-294" id="h0-0-294" class="d">-    l.append(vec![0x03])?;
</a><a href="#h0-0-295" id="h0-0-295" class="d">-    l.append(vec![0x04])?;
</a><a href="#h0-0-296" id="h0-0-296" class="d">-    l.append(vec![0x05])?;
</a><a href="#h0-0-297" id="h0-0-297" class="d">-    l.commit(3)?;
</a><a href="#h0-0-298" id="h0-0-298" class="d">-
</a><a href="#h0-0-299" id="h0-0-299" class="d">-    let l = Hybrid::new(dir.as_ref(), true)?;
</a><a href="#h0-0-300" id="h0-0-300" class="d">-
</a><a href="#h0-0-301" id="h0-0-301" class="d">-    assert_eq!(
</a><a href="#h0-0-302" id="h0-0-302" class="d">-        vec![vec![1], vec![2], vec![3]],
</a><a href="#h0-0-303" id="h0-0-303" class="d">-        l.scan(Range::from(..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h0-0-304" id="h0-0-304" class="d">-    );
</a><a href="#h0-0-305" id="h0-0-305" class="d">-
</a><a href="#h0-0-306" id="h0-0-306" class="d">-    Ok(())
</a><a href="#h0-0-307" id="h0-0-307" class="d">-}
</a><b>diff --git a/<a id="h1" href="../file/src/storage/log/memory.rs.html">src/storage/log/memory.rs</a> b/<a href="../file/src/storage/log/memory.rs.html">src/storage/log/memory.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1,120 +0,0 @@
</a><a href="#h1-0-0" id="h1-0-0" class="d">-use super::{Range, Store};
</a><a href="#h1-0-1" id="h1-0-1" class="d">-use crate::error::{Error, Result};
</a><a href="#h1-0-2" id="h1-0-2" class="d">-
</a><a href="#h1-0-3" id="h1-0-3" class="d">-use std::collections::HashMap;
</a><a href="#h1-0-4" id="h1-0-4" class="d">-use std::fmt::Display;
</a><a href="#h1-0-5" id="h1-0-5" class="d">-use std::ops::Bound;
</a><a href="#h1-0-6" id="h1-0-6" class="d">-
</a><a href="#h1-0-7" id="h1-0-7" class="d">-// An in-memory log store.
</a><a href="#h1-0-8" id="h1-0-8" class="d">-pub struct Memory {
</a><a href="#h1-0-9" id="h1-0-9" class="d">-    log: Vec&lt;Vec&lt;u8&gt;&gt;,
</a><a href="#h1-0-10" id="h1-0-10" class="d">-    committed: u64,
</a><a href="#h1-0-11" id="h1-0-11" class="d">-    metadata: HashMap&lt;Vec&lt;u8&gt;, Vec&lt;u8&gt;&gt;,
</a><a href="#h1-0-12" id="h1-0-12" class="d">-}
</a><a href="#h1-0-13" id="h1-0-13" class="d">-
</a><a href="#h1-0-14" id="h1-0-14" class="d">-impl Memory {
</a><a href="#h1-0-15" id="h1-0-15" class="d">-    /// Creates a new in-memory log.
</a><a href="#h1-0-16" id="h1-0-16" class="d">-    pub fn new() -&gt; Self {
</a><a href="#h1-0-17" id="h1-0-17" class="d">-        Self { log: Vec::new(), committed: 0, metadata: HashMap::new() }
</a><a href="#h1-0-18" id="h1-0-18" class="d">-    }
</a><a href="#h1-0-19" id="h1-0-19" class="d">-}
</a><a href="#h1-0-20" id="h1-0-20" class="d">-
</a><a href="#h1-0-21" id="h1-0-21" class="d">-impl Display for Memory {
</a><a href="#h1-0-22" id="h1-0-22" class="d">-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h1-0-23" id="h1-0-23" class="d">-        write!(f, &quot;memory&quot;)
</a><a href="#h1-0-24" id="h1-0-24" class="d">-    }
</a><a href="#h1-0-25" id="h1-0-25" class="d">-}
</a><a href="#h1-0-26" id="h1-0-26" class="d">-
</a><a href="#h1-0-27" id="h1-0-27" class="d">-impl Store for Memory {
</a><a href="#h1-0-28" id="h1-0-28" class="d">-    fn append(&amp;mut self, entry: Vec&lt;u8&gt;) -&gt; Result&lt;u64&gt; {
</a><a href="#h1-0-29" id="h1-0-29" class="d">-        self.log.push(entry);
</a><a href="#h1-0-30" id="h1-0-30" class="d">-        Ok(self.log.len() as u64)
</a><a href="#h1-0-31" id="h1-0-31" class="d">-    }
</a><a href="#h1-0-32" id="h1-0-32" class="d">-
</a><a href="#h1-0-33" id="h1-0-33" class="d">-    fn commit(&amp;mut self, index: u64) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-34" id="h1-0-34" class="d">-        if index &gt; self.len() {
</a><a href="#h1-0-35" id="h1-0-35" class="d">-            return Err(Error::Internal(format!(&quot;Cannot commit non-existant index {}&quot;, index)));
</a><a href="#h1-0-36" id="h1-0-36" class="d">-        }
</a><a href="#h1-0-37" id="h1-0-37" class="d">-        if index &lt; self.committed {
</a><a href="#h1-0-38" id="h1-0-38" class="d">-            return Err(Error::Internal(format!(
</a><a href="#h1-0-39" id="h1-0-39" class="d">-                &quot;Cannot commit below current index {}&quot;,
</a><a href="#h1-0-40" id="h1-0-40" class="d">-                self.committed
</a><a href="#h1-0-41" id="h1-0-41" class="d">-            )));
</a><a href="#h1-0-42" id="h1-0-42" class="d">-        }
</a><a href="#h1-0-43" id="h1-0-43" class="d">-        self.committed = index;
</a><a href="#h1-0-44" id="h1-0-44" class="d">-        Ok(())
</a><a href="#h1-0-45" id="h1-0-45" class="d">-    }
</a><a href="#h1-0-46" id="h1-0-46" class="d">-
</a><a href="#h1-0-47" id="h1-0-47" class="d">-    fn committed(&amp;self) -&gt; u64 {
</a><a href="#h1-0-48" id="h1-0-48" class="d">-        self.committed
</a><a href="#h1-0-49" id="h1-0-49" class="d">-    }
</a><a href="#h1-0-50" id="h1-0-50" class="d">-
</a><a href="#h1-0-51" id="h1-0-51" class="d">-    fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h1-0-52" id="h1-0-52" class="d">-        match index {
</a><a href="#h1-0-53" id="h1-0-53" class="d">-            0 =&gt; Ok(None),
</a><a href="#h1-0-54" id="h1-0-54" class="d">-            i =&gt; Ok(self.log.get(i as usize - 1).cloned()),
</a><a href="#h1-0-55" id="h1-0-55" class="d">-        }
</a><a href="#h1-0-56" id="h1-0-56" class="d">-    }
</a><a href="#h1-0-57" id="h1-0-57" class="d">-
</a><a href="#h1-0-58" id="h1-0-58" class="d">-    fn len(&amp;self) -&gt; u64 {
</a><a href="#h1-0-59" id="h1-0-59" class="d">-        self.log.len() as u64
</a><a href="#h1-0-60" id="h1-0-60" class="d">-    }
</a><a href="#h1-0-61" id="h1-0-61" class="d">-
</a><a href="#h1-0-62" id="h1-0-62" class="d">-    fn scan(&amp;self, range: Range) -&gt; super::Scan {
</a><a href="#h1-0-63" id="h1-0-63" class="d">-        Box::new(
</a><a href="#h1-0-64" id="h1-0-64" class="d">-            self.log
</a><a href="#h1-0-65" id="h1-0-65" class="d">-                .iter()
</a><a href="#h1-0-66" id="h1-0-66" class="d">-                .take(match range.end {
</a><a href="#h1-0-67" id="h1-0-67" class="d">-                    Bound::Included(n) =&gt; n as usize,
</a><a href="#h1-0-68" id="h1-0-68" class="d">-                    Bound::Excluded(0) =&gt; 0,
</a><a href="#h1-0-69" id="h1-0-69" class="d">-                    Bound::Excluded(n) =&gt; n as usize - 1,
</a><a href="#h1-0-70" id="h1-0-70" class="d">-                    Bound::Unbounded =&gt; std::usize::MAX,
</a><a href="#h1-0-71" id="h1-0-71" class="d">-                })
</a><a href="#h1-0-72" id="h1-0-72" class="d">-                .skip(match range.start {
</a><a href="#h1-0-73" id="h1-0-73" class="d">-                    Bound::Included(0) =&gt; 0,
</a><a href="#h1-0-74" id="h1-0-74" class="d">-                    Bound::Included(n) =&gt; n as usize - 1,
</a><a href="#h1-0-75" id="h1-0-75" class="d">-                    Bound::Excluded(n) =&gt; n as usize,
</a><a href="#h1-0-76" id="h1-0-76" class="d">-                    Bound::Unbounded =&gt; 0,
</a><a href="#h1-0-77" id="h1-0-77" class="d">-                })
</a><a href="#h1-0-78" id="h1-0-78" class="d">-                .cloned()
</a><a href="#h1-0-79" id="h1-0-79" class="d">-                .map(Ok),
</a><a href="#h1-0-80" id="h1-0-80" class="d">-        )
</a><a href="#h1-0-81" id="h1-0-81" class="d">-    }
</a><a href="#h1-0-82" id="h1-0-82" class="d">-
</a><a href="#h1-0-83" id="h1-0-83" class="d">-    fn size(&amp;self) -&gt; u64 {
</a><a href="#h1-0-84" id="h1-0-84" class="d">-        self.log.iter().map(|v| v.len() as u64).sum()
</a><a href="#h1-0-85" id="h1-0-85" class="d">-    }
</a><a href="#h1-0-86" id="h1-0-86" class="d">-
</a><a href="#h1-0-87" id="h1-0-87" class="d">-    fn truncate(&amp;mut self, index: u64) -&gt; Result&lt;u64&gt; {
</a><a href="#h1-0-88" id="h1-0-88" class="d">-        if index &lt; self.committed {
</a><a href="#h1-0-89" id="h1-0-89" class="d">-            return Err(Error::Internal(format!(
</a><a href="#h1-0-90" id="h1-0-90" class="d">-                &quot;Cannot truncate below committed index {}&quot;,
</a><a href="#h1-0-91" id="h1-0-91" class="d">-                self.committed
</a><a href="#h1-0-92" id="h1-0-92" class="d">-            )));
</a><a href="#h1-0-93" id="h1-0-93" class="d">-        }
</a><a href="#h1-0-94" id="h1-0-94" class="d">-        self.log.truncate(index as usize);
</a><a href="#h1-0-95" id="h1-0-95" class="d">-        Ok(self.log.len() as u64)
</a><a href="#h1-0-96" id="h1-0-96" class="d">-    }
</a><a href="#h1-0-97" id="h1-0-97" class="d">-
</a><a href="#h1-0-98" id="h1-0-98" class="d">-    fn get_metadata(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h1-0-99" id="h1-0-99" class="d">-        Ok(self.metadata.get(key).cloned())
</a><a href="#h1-0-100" id="h1-0-100" class="d">-    }
</a><a href="#h1-0-101" id="h1-0-101" class="d">-
</a><a href="#h1-0-102" id="h1-0-102" class="d">-    fn set_metadata(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-103" id="h1-0-103" class="d">-        self.metadata.insert(key.to_vec(), value);
</a><a href="#h1-0-104" id="h1-0-104" class="d">-        Ok(())
</a><a href="#h1-0-105" id="h1-0-105" class="d">-    }
</a><a href="#h1-0-106" id="h1-0-106" class="d">-}
</a><a href="#h1-0-107" id="h1-0-107" class="d">-
</a><a href="#h1-0-108" id="h1-0-108" class="d">-#[cfg(test)]
</a><a href="#h1-0-109" id="h1-0-109" class="d">-impl super::TestSuite&lt;Memory&gt; for Memory {
</a><a href="#h1-0-110" id="h1-0-110" class="d">-    fn setup() -&gt; Result&lt;Self&gt; {
</a><a href="#h1-0-111" id="h1-0-111" class="d">-        Ok(Memory::new())
</a><a href="#h1-0-112" id="h1-0-112" class="d">-    }
</a><a href="#h1-0-113" id="h1-0-113" class="d">-}
</a><a href="#h1-0-114" id="h1-0-114" class="d">-
</a><a href="#h1-0-115" id="h1-0-115" class="d">-#[test]
</a><a href="#h1-0-116" id="h1-0-116" class="d">-fn tests() -&gt; Result&lt;()&gt; {
</a><a href="#h1-0-117" id="h1-0-117" class="d">-    use super::TestSuite;
</a><a href="#h1-0-118" id="h1-0-118" class="d">-    Memory::test()
</a><a href="#h1-0-119" id="h1-0-119" class="d">-}
</a><b>diff --git a/<a id="h2" href="../file/src/storage/log/mod.rs.html">src/storage/log/mod.rs</a> b/<a href="../file/src/storage/log/mod.rs.html">src/storage/log/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,200 +0,0 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-mod hybrid;
</a><a href="#h2-0-1" id="h2-0-1" class="d">-mod memory;
</a><a href="#h2-0-2" id="h2-0-2" class="d">-#[cfg(test)]
</a><a href="#h2-0-3" id="h2-0-3" class="d">-mod test;
</a><a href="#h2-0-4" id="h2-0-4" class="d">-
</a><a href="#h2-0-5" id="h2-0-5" class="d">-pub use hybrid::Hybrid;
</a><a href="#h2-0-6" id="h2-0-6" class="d">-pub use memory::Memory;
</a><a href="#h2-0-7" id="h2-0-7" class="d">-#[cfg(test)]
</a><a href="#h2-0-8" id="h2-0-8" class="d">-pub use test::Test;
</a><a href="#h2-0-9" id="h2-0-9" class="d">-
</a><a href="#h2-0-10" id="h2-0-10" class="d">-use crate::error::Result;
</a><a href="#h2-0-11" id="h2-0-11" class="d">-
</a><a href="#h2-0-12" id="h2-0-12" class="d">-use std::fmt::Display;
</a><a href="#h2-0-13" id="h2-0-13" class="d">-use std::ops::{Bound, RangeBounds};
</a><a href="#h2-0-14" id="h2-0-14" class="d">-
</a><a href="#h2-0-15" id="h2-0-15" class="d">-/// A log store. Entry indexes are 1-based, to match Raft semantics.
</a><a href="#h2-0-16" id="h2-0-16" class="d">-pub trait Store: Display + Sync + Send {
</a><a href="#h2-0-17" id="h2-0-17" class="d">-    /// Appends a log entry, returning its index.
</a><a href="#h2-0-18" id="h2-0-18" class="d">-    fn append(&amp;mut self, entry: Vec&lt;u8&gt;) -&gt; Result&lt;u64&gt;;
</a><a href="#h2-0-19" id="h2-0-19" class="d">-
</a><a href="#h2-0-20" id="h2-0-20" class="d">-    /// Commits log entries up to and including the given index, making them immutable.
</a><a href="#h2-0-21" id="h2-0-21" class="d">-    fn commit(&amp;mut self, index: u64) -&gt; Result&lt;()&gt;;
</a><a href="#h2-0-22" id="h2-0-22" class="d">-
</a><a href="#h2-0-23" id="h2-0-23" class="d">-    /// Returns the committed index, if any.
</a><a href="#h2-0-24" id="h2-0-24" class="d">-    fn committed(&amp;self) -&gt; u64;
</a><a href="#h2-0-25" id="h2-0-25" class="d">-
</a><a href="#h2-0-26" id="h2-0-26" class="d">-    /// Fetches a log entry, if it exists.
</a><a href="#h2-0-27" id="h2-0-27" class="d">-    fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt;;
</a><a href="#h2-0-28" id="h2-0-28" class="d">-
</a><a href="#h2-0-29" id="h2-0-29" class="d">-    /// Returns the number of entries in the log.
</a><a href="#h2-0-30" id="h2-0-30" class="d">-    fn len(&amp;self) -&gt; u64;
</a><a href="#h2-0-31" id="h2-0-31" class="d">-
</a><a href="#h2-0-32" id="h2-0-32" class="d">-    /// Scans the log between the given indexes.
</a><a href="#h2-0-33" id="h2-0-33" class="d">-    fn scan(&amp;self, range: Range) -&gt; Scan;
</a><a href="#h2-0-34" id="h2-0-34" class="d">-
</a><a href="#h2-0-35" id="h2-0-35" class="d">-    /// Returns the size of the log, in bytes.
</a><a href="#h2-0-36" id="h2-0-36" class="d">-    fn size(&amp;self) -&gt; u64;
</a><a href="#h2-0-37" id="h2-0-37" class="d">-
</a><a href="#h2-0-38" id="h2-0-38" class="d">-    /// Truncates the log be removing any entries above the given index, and returns the
</a><a href="#h2-0-39" id="h2-0-39" class="d">-    /// highest index. Errors if asked to truncate any committed entries.
</a><a href="#h2-0-40" id="h2-0-40" class="d">-    fn truncate(&amp;mut self, index: u64) -&gt; Result&lt;u64&gt;;
</a><a href="#h2-0-41" id="h2-0-41" class="d">-
</a><a href="#h2-0-42" id="h2-0-42" class="d">-    /// Gets a metadata value.
</a><a href="#h2-0-43" id="h2-0-43" class="d">-    fn get_metadata(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt;;
</a><a href="#h2-0-44" id="h2-0-44" class="d">-
</a><a href="#h2-0-45" id="h2-0-45" class="d">-    /// Sets a metadata value.
</a><a href="#h2-0-46" id="h2-0-46" class="d">-    fn set_metadata(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt;;
</a><a href="#h2-0-47" id="h2-0-47" class="d">-
</a><a href="#h2-0-48" id="h2-0-48" class="d">-    /// Returns true if the log has no entries.
</a><a href="#h2-0-49" id="h2-0-49" class="d">-    fn is_empty(&amp;self) -&gt; bool {
</a><a href="#h2-0-50" id="h2-0-50" class="d">-        self.len() == 0
</a><a href="#h2-0-51" id="h2-0-51" class="d">-    }
</a><a href="#h2-0-52" id="h2-0-52" class="d">-}
</a><a href="#h2-0-53" id="h2-0-53" class="d">-
</a><a href="#h2-0-54" id="h2-0-54" class="d">-/// A scan range.
</a><a href="#h2-0-55" id="h2-0-55" class="d">-pub struct Range {
</a><a href="#h2-0-56" id="h2-0-56" class="d">-    start: Bound&lt;u64&gt;,
</a><a href="#h2-0-57" id="h2-0-57" class="d">-    end: Bound&lt;u64&gt;,
</a><a href="#h2-0-58" id="h2-0-58" class="d">-}
</a><a href="#h2-0-59" id="h2-0-59" class="d">-
</a><a href="#h2-0-60" id="h2-0-60" class="d">-impl Range {
</a><a href="#h2-0-61" id="h2-0-61" class="d">-    /// Creates a new range from the given Rust range. We can&#39;t use the RangeBounds directly in
</a><a href="#h2-0-62" id="h2-0-62" class="d">-    /// scan() since that prevents us from Store into a trait object.
</a><a href="#h2-0-63" id="h2-0-63" class="d">-    pub fn from(range: impl RangeBounds&lt;u64&gt;) -&gt; Self {
</a><a href="#h2-0-64" id="h2-0-64" class="d">-        Self {
</a><a href="#h2-0-65" id="h2-0-65" class="d">-            start: match range.start_bound() {
</a><a href="#h2-0-66" id="h2-0-66" class="d">-                Bound::Included(v) =&gt; Bound::Included(*v),
</a><a href="#h2-0-67" id="h2-0-67" class="d">-                Bound::Excluded(v) =&gt; Bound::Excluded(*v),
</a><a href="#h2-0-68" id="h2-0-68" class="d">-                Bound::Unbounded =&gt; Bound::Unbounded,
</a><a href="#h2-0-69" id="h2-0-69" class="d">-            },
</a><a href="#h2-0-70" id="h2-0-70" class="d">-            end: match range.end_bound() {
</a><a href="#h2-0-71" id="h2-0-71" class="d">-                Bound::Included(v) =&gt; Bound::Included(*v),
</a><a href="#h2-0-72" id="h2-0-72" class="d">-                Bound::Excluded(v) =&gt; Bound::Excluded(*v),
</a><a href="#h2-0-73" id="h2-0-73" class="d">-                Bound::Unbounded =&gt; Bound::Unbounded,
</a><a href="#h2-0-74" id="h2-0-74" class="d">-            },
</a><a href="#h2-0-75" id="h2-0-75" class="d">-        }
</a><a href="#h2-0-76" id="h2-0-76" class="d">-    }
</a><a href="#h2-0-77" id="h2-0-77" class="d">-}
</a><a href="#h2-0-78" id="h2-0-78" class="d">-
</a><a href="#h2-0-79" id="h2-0-79" class="d">-/// Iterator over a log range.
</a><a href="#h2-0-80" id="h2-0-80" class="d">-pub type Scan&lt;&#39;a&gt; = Box&lt;dyn Iterator&lt;Item = Result&lt;Vec&lt;u8&gt;&gt;&gt; + &#39;a&gt;;
</a><a href="#h2-0-81" id="h2-0-81" class="d">-
</a><a href="#h2-0-82" id="h2-0-82" class="d">-#[cfg(test)]
</a><a href="#h2-0-83" id="h2-0-83" class="d">-use crate::error::Error;
</a><a href="#h2-0-84" id="h2-0-84" class="d">-
</a><a href="#h2-0-85" id="h2-0-85" class="d">-#[cfg(test)]
</a><a href="#h2-0-86" id="h2-0-86" class="d">-trait TestSuite&lt;S: Store&gt; {
</a><a href="#h2-0-87" id="h2-0-87" class="d">-    fn setup() -&gt; Result&lt;S&gt;;
</a><a href="#h2-0-88" id="h2-0-88" class="d">-
</a><a href="#h2-0-89" id="h2-0-89" class="d">-    fn test() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-90" id="h2-0-90" class="d">-        Self::test_append()?;
</a><a href="#h2-0-91" id="h2-0-91" class="d">-        Self::test_commit_truncate()?;
</a><a href="#h2-0-92" id="h2-0-92" class="d">-        Self::test_get()?;
</a><a href="#h2-0-93" id="h2-0-93" class="d">-        Self::test_metadata()?;
</a><a href="#h2-0-94" id="h2-0-94" class="d">-        Self::test_scan()?;
</a><a href="#h2-0-95" id="h2-0-95" class="d">-        Ok(())
</a><a href="#h2-0-96" id="h2-0-96" class="d">-    }
</a><a href="#h2-0-97" id="h2-0-97" class="d">-
</a><a href="#h2-0-98" id="h2-0-98" class="d">-    fn test_append() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-99" id="h2-0-99" class="d">-        let mut s = Self::setup()?;
</a><a href="#h2-0-100" id="h2-0-100" class="d">-        assert_eq!(0, s.len());
</a><a href="#h2-0-101" id="h2-0-101" class="d">-        assert_eq!(1, s.append(vec![0x01])?);
</a><a href="#h2-0-102" id="h2-0-102" class="d">-        assert_eq!(2, s.append(vec![0x02])?);
</a><a href="#h2-0-103" id="h2-0-103" class="d">-        assert_eq!(3, s.append(vec![0x03])?);
</a><a href="#h2-0-104" id="h2-0-104" class="d">-        assert_eq!(3, s.len());
</a><a href="#h2-0-105" id="h2-0-105" class="d">-        assert_eq!(
</a><a href="#h2-0-106" id="h2-0-106" class="d">-            vec![vec![1], vec![2], vec![3]],
</a><a href="#h2-0-107" id="h2-0-107" class="d">-            s.scan(Range::from(..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h2-0-108" id="h2-0-108" class="d">-        );
</a><a href="#h2-0-109" id="h2-0-109" class="d">-        Ok(())
</a><a href="#h2-0-110" id="h2-0-110" class="d">-    }
</a><a href="#h2-0-111" id="h2-0-111" class="d">-
</a><a href="#h2-0-112" id="h2-0-112" class="d">-    fn test_commit_truncate() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-113" id="h2-0-113" class="d">-        let mut s = Self::setup()?;
</a><a href="#h2-0-114" id="h2-0-114" class="d">-
</a><a href="#h2-0-115" id="h2-0-115" class="d">-        assert_eq!(0, s.committed());
</a><a href="#h2-0-116" id="h2-0-116" class="d">-
</a><a href="#h2-0-117" id="h2-0-117" class="d">-        // Truncating an empty store should be fine.
</a><a href="#h2-0-118" id="h2-0-118" class="d">-        assert_eq!(0, s.truncate(0)?);
</a><a href="#h2-0-119" id="h2-0-119" class="d">-
</a><a href="#h2-0-120" id="h2-0-120" class="d">-        s.append(vec![0x01])?;
</a><a href="#h2-0-121" id="h2-0-121" class="d">-        s.append(vec![0x02])?;
</a><a href="#h2-0-122" id="h2-0-122" class="d">-        s.append(vec![0x03])?;
</a><a href="#h2-0-123" id="h2-0-123" class="d">-        s.commit(1)?;
</a><a href="#h2-0-124" id="h2-0-124" class="d">-        assert_eq!(1, s.committed());
</a><a href="#h2-0-125" id="h2-0-125" class="d">-
</a><a href="#h2-0-126" id="h2-0-126" class="d">-        // Truncating beyond the end should be fine.
</a><a href="#h2-0-127" id="h2-0-127" class="d">-        assert_eq!(3, s.truncate(4)?);
</a><a href="#h2-0-128" id="h2-0-128" class="d">-        assert_eq!(
</a><a href="#h2-0-129" id="h2-0-129" class="d">-            vec![vec![1], vec![2], vec![3]],
</a><a href="#h2-0-130" id="h2-0-130" class="d">-            s.scan(Range::from(..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h2-0-131" id="h2-0-131" class="d">-        );
</a><a href="#h2-0-132" id="h2-0-132" class="d">-
</a><a href="#h2-0-133" id="h2-0-133" class="d">-        // Truncating a committed entry should error.
</a><a href="#h2-0-134" id="h2-0-134" class="d">-        assert_eq!(
</a><a href="#h2-0-135" id="h2-0-135" class="d">-            Err(Error::Internal(&quot;Cannot truncate below committed index 1&quot;.into())),
</a><a href="#h2-0-136" id="h2-0-136" class="d">-            s.truncate(0)
</a><a href="#h2-0-137" id="h2-0-137" class="d">-        );
</a><a href="#h2-0-138" id="h2-0-138" class="d">-
</a><a href="#h2-0-139" id="h2-0-139" class="d">-        // Truncating above should work.
</a><a href="#h2-0-140" id="h2-0-140" class="d">-        assert_eq!(1, s.truncate(1)?);
</a><a href="#h2-0-141" id="h2-0-141" class="d">-        assert_eq!(vec![vec![1]], s.scan(Range::from(..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-142" id="h2-0-142" class="d">-
</a><a href="#h2-0-143" id="h2-0-143" class="d">-        Ok(())
</a><a href="#h2-0-144" id="h2-0-144" class="d">-    }
</a><a href="#h2-0-145" id="h2-0-145" class="d">-
</a><a href="#h2-0-146" id="h2-0-146" class="d">-    fn test_get() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-147" id="h2-0-147" class="d">-        let mut s = Self::setup()?;
</a><a href="#h2-0-148" id="h2-0-148" class="d">-        s.append(vec![0x01])?;
</a><a href="#h2-0-149" id="h2-0-149" class="d">-        s.append(vec![0x02])?;
</a><a href="#h2-0-150" id="h2-0-150" class="d">-        s.append(vec![0x03])?;
</a><a href="#h2-0-151" id="h2-0-151" class="d">-        assert_eq!(None, s.get(0)?);
</a><a href="#h2-0-152" id="h2-0-152" class="d">-        assert_eq!(Some(vec![0x01]), s.get(1)?);
</a><a href="#h2-0-153" id="h2-0-153" class="d">-        assert_eq!(None, s.get(4)?);
</a><a href="#h2-0-154" id="h2-0-154" class="d">-        Ok(())
</a><a href="#h2-0-155" id="h2-0-155" class="d">-    }
</a><a href="#h2-0-156" id="h2-0-156" class="d">-
</a><a href="#h2-0-157" id="h2-0-157" class="d">-    fn test_metadata() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-158" id="h2-0-158" class="d">-        let mut s = Self::setup()?;
</a><a href="#h2-0-159" id="h2-0-159" class="d">-        s.set_metadata(b&quot;a&quot;, vec![0x01])?;
</a><a href="#h2-0-160" id="h2-0-160" class="d">-        assert_eq!(Some(vec![0x01]), s.get_metadata(b&quot;a&quot;)?);
</a><a href="#h2-0-161" id="h2-0-161" class="d">-        assert_eq!(None, s.get_metadata(b&quot;b&quot;)?);
</a><a href="#h2-0-162" id="h2-0-162" class="d">-        Ok(())
</a><a href="#h2-0-163" id="h2-0-163" class="d">-    }
</a><a href="#h2-0-164" id="h2-0-164" class="d">-
</a><a href="#h2-0-165" id="h2-0-165" class="d">-    #[allow(clippy::reversed_empty_ranges)]
</a><a href="#h2-0-166" id="h2-0-166" class="d">-    fn test_scan() -&gt; Result&lt;()&gt; {
</a><a href="#h2-0-167" id="h2-0-167" class="d">-        let mut s = Self::setup()?;
</a><a href="#h2-0-168" id="h2-0-168" class="d">-        s.append(vec![0x01])?;
</a><a href="#h2-0-169" id="h2-0-169" class="d">-        s.append(vec![0x02])?;
</a><a href="#h2-0-170" id="h2-0-170" class="d">-        s.append(vec![0x03])?;
</a><a href="#h2-0-171" id="h2-0-171" class="d">-        s.commit(2)?;
</a><a href="#h2-0-172" id="h2-0-172" class="d">-
</a><a href="#h2-0-173" id="h2-0-173" class="d">-        assert_eq!(
</a><a href="#h2-0-174" id="h2-0-174" class="d">-            vec![vec![1], vec![2], vec![3]],
</a><a href="#h2-0-175" id="h2-0-175" class="d">-            s.scan(Range::from(..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h2-0-176" id="h2-0-176" class="d">-        );
</a><a href="#h2-0-177" id="h2-0-177" class="d">-
</a><a href="#h2-0-178" id="h2-0-178" class="d">-        assert_eq!(vec![vec![1]], s.scan(Range::from(0..2)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-179" id="h2-0-179" class="d">-        assert_eq!(vec![vec![1], vec![2]], s.scan(Range::from(1..3)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-180" id="h2-0-180" class="d">-        assert_eq!(
</a><a href="#h2-0-181" id="h2-0-181" class="d">-            vec![vec![1], vec![2], vec![3]],
</a><a href="#h2-0-182" id="h2-0-182" class="d">-            s.scan(Range::from(1..=3)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?
</a><a href="#h2-0-183" id="h2-0-183" class="d">-        );
</a><a href="#h2-0-184" id="h2-0-184" class="d">-        assert!(s.scan(Range::from(3..1)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?.is_empty());
</a><a href="#h2-0-185" id="h2-0-185" class="d">-        assert!(s.scan(Range::from(1..1)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?.is_empty());
</a><a href="#h2-0-186" id="h2-0-186" class="d">-        assert_eq!(vec![vec![2]], s.scan(Range::from(2..=2)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-187" id="h2-0-187" class="d">-        assert_eq!(vec![vec![2], vec![3]], s.scan(Range::from(2..5)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-188" id="h2-0-188" class="d">-
</a><a href="#h2-0-189" id="h2-0-189" class="d">-        assert!(s.scan(Range::from(..0)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?.is_empty());
</a><a href="#h2-0-190" id="h2-0-190" class="d">-        assert_eq!(vec![vec![1]], s.scan(Range::from(..=1)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-191" id="h2-0-191" class="d">-        assert_eq!(vec![vec![1], vec![2]], s.scan(Range::from(..3)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-192" id="h2-0-192" class="d">-
</a><a href="#h2-0-193" id="h2-0-193" class="d">-        assert!(s.scan(Range::from(4..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?.is_empty());
</a><a href="#h2-0-194" id="h2-0-194" class="d">-        assert_eq!(vec![vec![3]], s.scan(Range::from(3..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-195" id="h2-0-195" class="d">-        assert_eq!(vec![vec![2], vec![3]], s.scan(Range::from(2..)).collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?);
</a><a href="#h2-0-196" id="h2-0-196" class="d">-
</a><a href="#h2-0-197" id="h2-0-197" class="d">-        Ok(())
</a><a href="#h2-0-198" id="h2-0-198" class="d">-    }
</a><a href="#h2-0-199" id="h2-0-199" class="d">-}
</a><b>diff --git a/<a id="h3" href="../file/src/storage/log/test.rs.html">src/storage/log/test.rs</a> b/<a href="../file/src/storage/log/test.rs.html">src/storage/log/test.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,81 +0,0 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-use super::{Memory, Range, Scan, Store};
</a><a href="#h3-0-1" id="h3-0-1" class="d">-use crate::error::Result;
</a><a href="#h3-0-2" id="h3-0-2" class="d">-
</a><a href="#h3-0-3" id="h3-0-3" class="d">-use std::fmt::Display;
</a><a href="#h3-0-4" id="h3-0-4" class="d">-use std::sync::{Arc, RwLock};
</a><a href="#h3-0-5" id="h3-0-5" class="d">-
</a><a href="#h3-0-6" id="h3-0-6" class="d">-/// Log storage backend for testing. Protects an inner Memory backend using a mutex, so it can
</a><a href="#h3-0-7" id="h3-0-7" class="d">-/// be cloned and inspected.
</a><a href="#h3-0-8" id="h3-0-8" class="d">-#[derive(Clone)]
</a><a href="#h3-0-9" id="h3-0-9" class="d">-pub struct Test {
</a><a href="#h3-0-10" id="h3-0-10" class="d">-    store: Arc&lt;RwLock&lt;Memory&gt;&gt;,
</a><a href="#h3-0-11" id="h3-0-11" class="d">-}
</a><a href="#h3-0-12" id="h3-0-12" class="d">-
</a><a href="#h3-0-13" id="h3-0-13" class="d">-impl Test {
</a><a href="#h3-0-14" id="h3-0-14" class="d">-    /// Creates a new Test key-value storage engine.
</a><a href="#h3-0-15" id="h3-0-15" class="d">-    pub fn new() -&gt; Self {
</a><a href="#h3-0-16" id="h3-0-16" class="d">-        Self { store: Arc::new(RwLock::new(Memory::new())) }
</a><a href="#h3-0-17" id="h3-0-17" class="d">-    }
</a><a href="#h3-0-18" id="h3-0-18" class="d">-}
</a><a href="#h3-0-19" id="h3-0-19" class="d">-
</a><a href="#h3-0-20" id="h3-0-20" class="d">-impl Display for Test {
</a><a href="#h3-0-21" id="h3-0-21" class="d">-    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;&#39;_&gt;) -&gt; std::fmt::Result {
</a><a href="#h3-0-22" id="h3-0-22" class="d">-        write!(f, &quot;test&quot;)
</a><a href="#h3-0-23" id="h3-0-23" class="d">-    }
</a><a href="#h3-0-24" id="h3-0-24" class="d">-}
</a><a href="#h3-0-25" id="h3-0-25" class="d">-
</a><a href="#h3-0-26" id="h3-0-26" class="d">-impl Store for Test {
</a><a href="#h3-0-27" id="h3-0-27" class="d">-    fn append(&amp;mut self, entry: Vec&lt;u8&gt;) -&gt; Result&lt;u64&gt; {
</a><a href="#h3-0-28" id="h3-0-28" class="d">-        self.store.write()?.append(entry)
</a><a href="#h3-0-29" id="h3-0-29" class="d">-    }
</a><a href="#h3-0-30" id="h3-0-30" class="d">-
</a><a href="#h3-0-31" id="h3-0-31" class="d">-    fn commit(&amp;mut self, index: u64) -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-32" id="h3-0-32" class="d">-        self.store.write()?.commit(index)
</a><a href="#h3-0-33" id="h3-0-33" class="d">-    }
</a><a href="#h3-0-34" id="h3-0-34" class="d">-
</a><a href="#h3-0-35" id="h3-0-35" class="d">-    fn committed(&amp;self) -&gt; u64 {
</a><a href="#h3-0-36" id="h3-0-36" class="d">-        self.store.read().unwrap().committed()
</a><a href="#h3-0-37" id="h3-0-37" class="d">-    }
</a><a href="#h3-0-38" id="h3-0-38" class="d">-
</a><a href="#h3-0-39" id="h3-0-39" class="d">-    fn get(&amp;self, index: u64) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h3-0-40" id="h3-0-40" class="d">-        self.store.read()?.get(index)
</a><a href="#h3-0-41" id="h3-0-41" class="d">-    }
</a><a href="#h3-0-42" id="h3-0-42" class="d">-
</a><a href="#h3-0-43" id="h3-0-43" class="d">-    fn len(&amp;self) -&gt; u64 {
</a><a href="#h3-0-44" id="h3-0-44" class="d">-        self.store.read().unwrap().len()
</a><a href="#h3-0-45" id="h3-0-45" class="d">-    }
</a><a href="#h3-0-46" id="h3-0-46" class="d">-
</a><a href="#h3-0-47" id="h3-0-47" class="d">-    fn scan(&amp;self, range: Range) -&gt; Scan {
</a><a href="#h3-0-48" id="h3-0-48" class="d">-        // Since the mutex guard is scoped to this method, we simply buffer the result.
</a><a href="#h3-0-49" id="h3-0-49" class="d">-        Box::new(self.store.read().unwrap().scan(range).collect::&lt;Vec&lt;Result&lt;_&gt;&gt;&gt;().into_iter())
</a><a href="#h3-0-50" id="h3-0-50" class="d">-    }
</a><a href="#h3-0-51" id="h3-0-51" class="d">-
</a><a href="#h3-0-52" id="h3-0-52" class="d">-    fn size(&amp;self) -&gt; u64 {
</a><a href="#h3-0-53" id="h3-0-53" class="d">-        self.store.read().unwrap().size()
</a><a href="#h3-0-54" id="h3-0-54" class="d">-    }
</a><a href="#h3-0-55" id="h3-0-55" class="d">-
</a><a href="#h3-0-56" id="h3-0-56" class="d">-    fn truncate(&amp;mut self, index: u64) -&gt; Result&lt;u64&gt; {
</a><a href="#h3-0-57" id="h3-0-57" class="d">-        self.store.write()?.truncate(index)
</a><a href="#h3-0-58" id="h3-0-58" class="d">-    }
</a><a href="#h3-0-59" id="h3-0-59" class="d">-
</a><a href="#h3-0-60" id="h3-0-60" class="d">-    fn get_metadata(&amp;self, key: &amp;[u8]) -&gt; Result&lt;Option&lt;Vec&lt;u8&gt;&gt;&gt; {
</a><a href="#h3-0-61" id="h3-0-61" class="d">-        self.store.read()?.get_metadata(key)
</a><a href="#h3-0-62" id="h3-0-62" class="d">-    }
</a><a href="#h3-0-63" id="h3-0-63" class="d">-
</a><a href="#h3-0-64" id="h3-0-64" class="d">-    fn set_metadata(&amp;mut self, key: &amp;[u8], value: Vec&lt;u8&gt;) -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-65" id="h3-0-65" class="d">-        self.store.write()?.set_metadata(key, value)
</a><a href="#h3-0-66" id="h3-0-66" class="d">-    }
</a><a href="#h3-0-67" id="h3-0-67" class="d">-}
</a><a href="#h3-0-68" id="h3-0-68" class="d">-
</a><a href="#h3-0-69" id="h3-0-69" class="d">-#[cfg(test)]
</a><a href="#h3-0-70" id="h3-0-70" class="d">-impl super::TestSuite&lt;Test&gt; for Test {
</a><a href="#h3-0-71" id="h3-0-71" class="d">-    fn setup() -&gt; Result&lt;Self&gt; {
</a><a href="#h3-0-72" id="h3-0-72" class="d">-        Ok(Test::new())
</a><a href="#h3-0-73" id="h3-0-73" class="d">-    }
</a><a href="#h3-0-74" id="h3-0-74" class="d">-}
</a><a href="#h3-0-75" id="h3-0-75" class="d">-
</a><a href="#h3-0-76" id="h3-0-76" class="d">-#[test]
</a><a href="#h3-0-77" id="h3-0-77" class="d">-fn tests() -&gt; Result&lt;()&gt; {
</a><a href="#h3-0-78" id="h3-0-78" class="d">-    use super::TestSuite;
</a><a href="#h3-0-79" id="h3-0-79" class="d">-    Test::test()
</a><a href="#h3-0-80" id="h3-0-80" class="d">-}
</a><b>diff --git a/<a id="h4" href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a> b/<a href="../file/src/storage/mod.rs.html">src/storage/mod.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -2,5 +2,4 @@ pub mod bincode;
</a> pub mod debug;
 pub mod engine;
 pub mod keycode;
<a href="#h4-0-3" id="h4-0-3" class="d">-pub mod log;
</a> pub mod mvcc;
</pre>
</div>
</body>
</html>
