<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: use `try_collect()` where appropriate - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/a1d54aa0a09e15a54878a8992914b9e540116008.html">a1d54aa0a09e15a54878a8992914b9e540116008</a>
<b>parent</b> <a href="../commit/ea1889a19ac5a1509e5c1013797c064195c970ce.html">ea1889a19ac5a1509e5c1013797c064195c970ce</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 21 Jul 2024 18:38:36 +0200

sql: use `try_collect()` where appropriate

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/log.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/node.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/mod.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/planner/plan.rs</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/sql/planner/planner.rs</a></td><td> | </td><td class="num">10</td><td><span class="i">++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/storage/engine.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/storage/mvcc.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
</table></pre><pre>7 files changed, 20 insertions(+), 18 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -343,6 +343,7 @@ mod tests {
</a>     use super::*;
     use crate::encoding::format::{self, Formatter as _};
     use crossbeam::channel::Receiver;
<a href="#h0-0-3" id="h0-0-3" class="i">+    use itertools::Itertools as _;
</a>     use regex::Regex;
     use std::fmt::Write as _;
     use std::{error::Error, result::Result};
<a href="#h0-1" id="h0-1" class="h">@@ -413,7 +414,7 @@ mod tests {
</a>                 &quot;get&quot; =&gt; {
                     let mut args = command.consume_args();
                     let indexes: Vec&lt;Index&gt; =
<a href="#h0-1-3" id="h0-1-3" class="d">-                        args.rest_pos().iter().map(|a| a.parse()).collect::&lt;Result&lt;_, _&gt;&gt;()?;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+                        args.rest_pos().iter().map(|a| a.parse()).try_collect()?;
</a>                     args.reject_rest()?;
                     for index in indexes {
                         let entry = self
<a href="#h0-2" id="h0-2" class="h">@@ -443,7 +444,7 @@ mod tests {
</a>                         .rest_pos()
                         .iter()
                         .map(|a| Self::parse_index_term(&amp;a.value))
<a href="#h0-2-3" id="h0-2-3" class="d">-                        .collect::&lt;Result&lt;_, _&gt;&gt;()?;
</a><a href="#h0-2-4" id="h0-2-4" class="i">+                        .try_collect()?;
</a>                     args.reject_rest()?;
                     for (index, term) in indexes {
                         let has = self.log.has(index, term)?;
<b>diff --git a/<a id="h1" href="../file/src/raft/node.rs.html">src/raft/node.rs</a> b/<a href="../file/src/raft/node.rs.html">src/raft/node.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -1114,7 +1114,7 @@ impl RawNode&lt;Leader&gt; {
</a>                 .log
                 .scan(progress.next_index..)
                 .take(self.opts.max_append_entries)
<a href="#h1-0-3" id="h1-0-3" class="d">-                .collect::&lt;Result&lt;_&gt;&gt;()?,
</a><a href="#h1-0-4" id="h1-0-4" class="i">+                .try_collect()?,
</a>             true =&gt; Vec::new(),
         };
 
<b>diff --git a/<a id="h2" href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a> b/<a href="../file/src/sql/mod.rs.html">src/sql/mod.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -63,6 +63,8 @@
</a> //!     and returns it to `Session::execute`. It in turns returns it to
 //!     `Server::sql_session`, which encodes it and sends it across the wire
 //!     to `toySQL`, which displays them to the user.
<a href="#h2-0-3" id="h2-0-3" class="i">+//!
</a><a href="#h2-0-4" id="h2-0-4" class="i">+//! TODO: expand this into a &quot;Life of a SQL statement&quot; document.
</a> 
 pub mod engine;
 pub mod execution;
<a href="#h2-1" id="h2-1" class="h">@@ -165,7 +167,7 @@ mod tests {
</a>                         tables
                             .into_iter()
                             .map(|t| self.session.with_txn(true, |txn| txn.must_get_table(&amp;t)))
<a href="#h2-1-3" id="h2-1-3" class="d">-                            .collect::&lt;Result&lt;_, _&gt;&gt;()?
</a><a href="#h2-1-4" id="h2-1-4" class="i">+                            .try_collect()?
</a>                     };
                     return Ok(schemas.into_iter().map(|s| s.to_string()).join(&quot;\n&quot;));
                 }
<b>diff --git a/<a id="h3" href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a> b/<a href="../file/src/sql/planner/plan.rs.html">src/sql/planner/plan.rs</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -314,7 +314,7 @@ impl Node {
</a>                 expressions = expressions
                     .into_iter()
                     .map(|expr| expr.transform(before, after))
<a href="#h3-0-3" id="h3-0-3" class="d">-                    .collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+                    .try_collect()?;
</a>                 Self::Projection { source, expressions, aliases }
             }
             Self::Scan { table, alias, filter: Some(filter) } =&gt; {
<a href="#h3-1" id="h3-1" class="h">@@ -325,7 +325,7 @@ impl Node {
</a>                 rows = rows
                     .into_iter()
                     .map(|row| row.into_iter().map(|expr| expr.transform(before, after)).collect())
<a href="#h3-1-3" id="h3-1-3" class="d">-                    .collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h3-1-4" id="h3-1-4" class="i">+                    .try_collect()?;
</a>                 Self::Values { rows }
             }
 
<b>diff --git a/<a id="h4" href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a> b/<a href="../file/src/sql/planner/planner.rs.html">src/sql/planner/planner.rs</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -113,7 +113,7 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>             .map(|exprs| {
                 exprs.into_iter().map(|expr| Self::build_expression(expr, &amp;scope)).collect()
             })
<a href="#h4-0-3" id="h4-0-3" class="d">-            .collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+            .try_collect()?;
</a>         Ok(Plan::Insert { table, column_map, source: Node::Values { rows } })
     }
 
<a href="#h4-1" id="h4-1" class="h">@@ -369,14 +369,12 @@ impl&lt;&#39;a, C: Catalog&gt; Planner&lt;&#39;a, C&gt; {
</a>         aggregates.retain(|expr| child_scope.add_aggregate(expr, scope).is_some());
 
         // Build the node from the remaining unique expressions.
<a href="#h4-1-3" id="h4-1-3" class="d">-        let group_by = group_by
</a><a href="#h4-1-4" id="h4-1-4" class="d">-            .into_iter()
</a><a href="#h4-1-5" id="h4-1-5" class="d">-            .map(|expr| Self::build_expression(expr, scope))
</a><a href="#h4-1-6" id="h4-1-6" class="d">-            .collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h4-1-7" id="h4-1-7" class="i">+        let group_by =
</a><a href="#h4-1-8" id="h4-1-8" class="i">+            group_by.into_iter().map(|expr| Self::build_expression(expr, scope)).try_collect()?;
</a>         let aggregates = aggregates
             .into_iter()
             .map(|expr| Self::build_aggregate_function(expr, scope))
<a href="#h4-1-12" id="h4-1-12" class="d">-            .collect::&lt;Result&lt;_&gt;&gt;()?;
</a><a href="#h4-1-13" id="h4-1-13" class="i">+            .try_collect()?;
</a> 
         *scope = child_scope;
         Ok(Node::Aggregate { source: Box::new(source), group_by, aggregates })
<b>diff --git a/<a id="h5" href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a> b/<a href="../file/src/storage/engine.rs.html">src/storage/engine.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -80,6 +80,7 @@ pub mod test {
</a>     use super::*;
     use crate::encoding::format::{self, Formatter as _};
     use crossbeam::channel::Sender;
<a href="#h5-0-3" id="h5-0-3" class="i">+    use itertools::Itertools as _;
</a>     use regex::Regex;
     use std::error::Error as StdError;
     use std::fmt::Write as _;
<a href="#h5-1" id="h5-1" class="h">@@ -127,9 +128,9 @@ pub mod test {
</a>                         parse_key_range(args.next_pos().map(|a| a.value.as_str()).unwrap_or(&quot;..&quot;))?;
                     args.reject_rest()?;
                     let items: Vec&lt;_&gt; = if reverse {
<a href="#h5-1-3" id="h5-1-3" class="d">-                        self.engine.scan(range).rev().collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h5-1-4" id="h5-1-4" class="i">+                        self.engine.scan(range).rev().try_collect()?
</a>                     } else {
<a href="#h5-1-6" id="h5-1-6" class="d">-                        self.engine.scan(range).collect::&lt;Result&lt;_&gt;&gt;()?
</a><a href="#h5-1-7" id="h5-1-7" class="i">+                        self.engine.scan(range).try_collect()?
</a>                     };
                     for (key, value) in items {
                         writeln!(output, &quot;{}&quot;, format::Raw::key_value(&amp;key, &amp;value))?;
<b>diff --git a/<a id="h6" href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a> b/<a href="../file/src/storage/mvcc.rs.html">src/storage/mvcc.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -144,6 +144,7 @@ use crate::encoding::{self, bincode, keycode, Key as _, Value as _};
</a> use crate::error::{Error, Result};
 use crate::{errdata, errinput};
 
<a href="#h6-0-3" id="h6-0-3" class="i">+use itertools::Itertools as _;
</a> use serde::{Deserialize, Serialize};
 use std::borrow::Cow;
 use std::collections::{BTreeSet, VecDeque};
<a href="#h6-1" id="h6-1" class="h">@@ -471,10 +472,10 @@ impl&lt;E: Engine&gt; Transaction&lt;E&gt; {
</a>             return Ok(());
         }
         let mut engine = self.engine.lock()?;
<a href="#h6-1-3" id="h6-1-3" class="d">-        let remove = engine
</a><a href="#h6-1-4" id="h6-1-4" class="i">+        let remove: Vec&lt;_&gt; = engine
</a>             .scan_prefix(&amp;KeyPrefix::TxnWrite(self.st.version).encode())
<a href="#h6-1-6" id="h6-1-6" class="d">-            .map(|r| r.map(|(k, _)| k))
</a><a href="#h6-1-7" id="h6-1-7" class="d">-            .collect::&lt;Result&lt;Vec&lt;_&gt;&gt;&gt;()?;
</a><a href="#h6-1-8" id="h6-1-8" class="i">+            .map_ok(|(k, _)| k)
</a><a href="#h6-1-9" id="h6-1-9" class="i">+            .try_collect()?;
</a>         for key in remove {
             engine.delete(&amp;key)?
         }
<a href="#h6-2" id="h6-2" class="h">@@ -749,7 +750,6 @@ pub mod tests {
</a>     use crate::storage::{BitCask, Memory};
 
     use crossbeam::channel::Receiver;
<a href="#h6-2-3" id="h6-2-3" class="d">-    use itertools::Itertools as _;
</a>     use std::collections::HashMap;
     use std::fmt::Write as _;
     use std::{error::Error, result::Result};
</pre>
</div>
</body>
</html>
