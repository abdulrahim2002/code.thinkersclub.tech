<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>sql: added support for foreign key constraints - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/41f661ba0ced921c3d4d0b8908028a098faa35aa.html">41f661ba0ced921c3d4d0b8908028a098faa35aa</a>
<b>parent</b> <a href="../commit/7c9122a5408a49af3c349d67206b0ca902b8065c.html">7c9122a5408a49af3c349d67206b0ca902b8065c</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Fri, 10 Jan 2020 16:51:21 +0100

sql: added support for foreign key constraints

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">docs/README.md</a></td><td> | </td><td class="num">4</td><td><span class="i">+++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/engine/kv.rs</a></td><td> | </td><td class="num">129</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/tests/schema.rs</a></td><td> | </td><td class="num">76</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/sql/tests/schema/create_table_exists</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">src/sql/tests/schema/create_table_ref</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h5">src/sql/tests/schema/create_table_ref_missing</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">src/sql/tests/schema/create_table_ref_multiple</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">src/sql/tests/schema/create_table_ref_self</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">src/sql/tests/schema/create_table_ref_self_type</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">src/sql/tests/schema/create_table_ref_type</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/sql/tests/schema/delete_ref_conflict</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">src/sql/tests/schema/delete_ref_noref</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/sql/tests/schema/delete_ref_self</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h13">src/sql/tests/schema/delete_ref_self_all</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h14">src/sql/tests/schema/delete_ref_self_conflict</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">src/sql/tests/schema/delete_ref_source</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h16">src/sql/tests/schema/drop_table_ref_self</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">src/sql/tests/schema/drop_table_ref_source</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">src/sql/tests/schema/drop_table_ref_target</a></td><td> | </td><td class="num">17</td><td><span class="i">+++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/sql/tests/schema/insert_ref_integer</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h20">src/sql/tests/schema/insert_ref_integer_missing</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">src/sql/tests/schema/insert_ref_integer_null</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h22">src/sql/tests/schema/insert_ref_self</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">src/sql/tests/schema/insert_ref_self_missing</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h24">src/sql/tests/schema/insert_ref_self_null</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h25">src/sql/tests/schema/insert_ref_self_self</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h26">src/sql/tests/schema/update_ref_pk</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">src/sql/tests/schema/update_ref_pk_noref</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h28">src/sql/tests/schema/update_ref_self_pk</a></td><td> | </td><td class="num">13</td><td><span class="i">+++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">src/sql/tests/schema/update_ref_self_pk_noref</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h30">src/sql/tests/schema/update_ref_self_self</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">src/sql/tests/schema/update_ref_self_value</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h32">src/sql/tests/schema/update_ref_source</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">src/sql/tests/schema/update_ref_source_missing</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h34">src/sql/tests/schema/update_ref_source_null</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">src/sql/tests/schema/update_ref_value</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">src/sql/types/schema.rs</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>37 files changed, 684 insertions(+), 12 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/docs/README.md.html">docs/README.md</a> b/<a href="../file/docs/README.md.html">docs/README.md</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -165,7 +165,7 @@ CREATE TABLE &lt;b&gt;&lt;i&gt;table_name&lt;/i&gt;&lt;/b&gt; (
</a> 
 where &lt;b&gt;&lt;i&gt;column_constraint&lt;/i&gt;&lt;/b&gt; is:
 
<a href="#h0-0-3" id="h0-0-3" class="d">-{ NOT NULL | NULL | PRIMARY KEY | DEFAULT &lt;b&gt;&lt;i&gt;expr&lt;/i&gt;&lt;/b&gt; }
</a><a href="#h0-0-4" id="h0-0-4" class="i">+{ NOT NULL | NULL | PRIMARY KEY | DEFAULT &lt;b&gt;&lt;i&gt;expr&lt;/i&gt;&lt;/b&gt; | REFERENCES &lt;b&gt;&lt;i&gt;ref_table&lt;/i&gt;&lt;/b&gt; }
</a> &lt;/pre&gt;
 
 * ***`table_name`***: The name of the table. Must be a [valid identifier](#identifiers). Errors if a table with this name already exists.
<a href="#h0-1" id="h0-1" class="h">@@ -182,6 +182,8 @@ where &lt;b&gt;&lt;i&gt;column_constraint&lt;/i&gt;&lt;/b&gt; is:
</a> 
 * `DEFAULT`***`expr`***: Specifies a default value for the column when `INSERT` statements do not give a value. ***`expr`*** can be any constant expression of an appropriate data type, e.g. `&#39;abc&#39;` or `1 + 2 * 3`. For nullable columns, the default value is `NULL` unless specified otherwise.
 
<a href="#h0-1-3" id="h0-1-3" class="i">+* `REFERENCES`***`ref_table`***: The columns is a foreign key to ***`ref_table`***&#39;s primary key, enforcing referential integrity.
</a><a href="#h0-1-4" id="h0-1-4" class="i">+
</a> #### Example
 
 ```
<b>diff --git a/<a id="h1" href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a> b/<a href="../file/src/sql/engine/kv.rs.html">src/sql/engine/kv.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -58,7 +58,11 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>         let table = self
             .read_table(&amp;table)?
             .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
<a href="#h1-0-3" id="h1-0-3" class="i">+
</a><a href="#h1-0-4" id="h1-0-4" class="i">+        // Validate row
</a>         table.validate_row(&amp;row)?;
<a href="#h1-0-6" id="h1-0-6" class="i">+
</a><a href="#h1-0-7" id="h1-0-7" class="i">+        // Validate primary key conflicts
</a>         let id = table.row_key(&amp;row)?;
         if self.read(&amp;table.name, &amp;id)?.is_some() {
             return Err(Error::Value(format!(
<a href="#h1-1" id="h1-1" class="h">@@ -66,12 +70,60 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>                 id, table.name
             )));
         }
<a href="#h1-1-3" id="h1-1-3" class="d">-        self.txn.set(&amp;Key::Row(&amp;table.name, &amp;id).encode(), serialize(&amp;row)?)?;
</a><a href="#h1-1-4" id="h1-1-4" class="d">-        Ok(())
</a><a href="#h1-1-5" id="h1-1-5" class="i">+
</a><a href="#h1-1-6" id="h1-1-6" class="i">+        // Validate referential integrity
</a><a href="#h1-1-7" id="h1-1-7" class="i">+        for (target, pks) in table.row_references(&amp;row)?.into_iter() {
</a><a href="#h1-1-8" id="h1-1-8" class="i">+            for pk in pks.into_iter() {
</a><a href="#h1-1-9" id="h1-1-9" class="i">+                if target == table.name &amp;&amp; pk == table.row_key(&amp;row)? {
</a><a href="#h1-1-10" id="h1-1-10" class="i">+                    continue;
</a><a href="#h1-1-11" id="h1-1-11" class="i">+                }
</a><a href="#h1-1-12" id="h1-1-12" class="i">+                if self.read(&amp;target, &amp;pk)?.is_none() {
</a><a href="#h1-1-13" id="h1-1-13" class="i">+                    return Err(Error::Value(format!(
</a><a href="#h1-1-14" id="h1-1-14" class="i">+                        &quot;Referenced primary key {} in table {} does not exist&quot;,
</a><a href="#h1-1-15" id="h1-1-15" class="i">+                        pk, target,
</a><a href="#h1-1-16" id="h1-1-16" class="i">+                    )));
</a><a href="#h1-1-17" id="h1-1-17" class="i">+                }
</a><a href="#h1-1-18" id="h1-1-18" class="i">+            }
</a><a href="#h1-1-19" id="h1-1-19" class="i">+        }
</a><a href="#h1-1-20" id="h1-1-20" class="i">+
</a><a href="#h1-1-21" id="h1-1-21" class="i">+        self.txn.set(&amp;Key::Row(&amp;table.name, &amp;id).encode(), serialize(&amp;row)?)
</a>     }
 
     fn delete(&amp;mut self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;(), Error&gt; {
<a href="#h1-1-25" id="h1-1-25" class="d">-        self.txn.delete(&amp;Key::Row(table, id).encode())
</a><a href="#h1-1-26" id="h1-1-26" class="i">+        let table = self
</a><a href="#h1-1-27" id="h1-1-27" class="i">+            .read_table(&amp;table)?
</a><a href="#h1-1-28" id="h1-1-28" class="i">+            .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
</a><a href="#h1-1-29" id="h1-1-29" class="i">+
</a><a href="#h1-1-30" id="h1-1-30" class="i">+        // FIXME We should avoid full table scans here, but let&#39;s wait until we build the
</a><a href="#h1-1-31" id="h1-1-31" class="i">+        // predicate pushdown infrastructure which we can use for this as well.
</a><a href="#h1-1-32" id="h1-1-32" class="i">+        for source in self.list_tables()? {
</a><a href="#h1-1-33" id="h1-1-33" class="i">+            let refs: Vec&lt;_&gt; = source
</a><a href="#h1-1-34" id="h1-1-34" class="i">+                .references()
</a><a href="#h1-1-35" id="h1-1-35" class="i">+                .into_iter()
</a><a href="#h1-1-36" id="h1-1-36" class="i">+                .filter(|c| c.references == Some(table.name.clone()))
</a><a href="#h1-1-37" id="h1-1-37" class="i">+                .collect();
</a><a href="#h1-1-38" id="h1-1-38" class="i">+            if refs.is_empty() {
</a><a href="#h1-1-39" id="h1-1-39" class="i">+                continue;
</a><a href="#h1-1-40" id="h1-1-40" class="i">+            }
</a><a href="#h1-1-41" id="h1-1-41" class="i">+            let mut scan = self.scan(&amp;source.name)?;
</a><a href="#h1-1-42" id="h1-1-42" class="i">+            while let Some(row) = scan.next().transpose()? {
</a><a href="#h1-1-43" id="h1-1-43" class="i">+                let row = source.row_to_hashmap(row);
</a><a href="#h1-1-44" id="h1-1-44" class="i">+                for r in refs.iter() {
</a><a href="#h1-1-45" id="h1-1-45" class="i">+                    if row.get(&amp;r.name).unwrap_or(&amp;types::Value::Null) == id
</a><a href="#h1-1-46" id="h1-1-46" class="i">+                        &amp;&amp; (source.name != table.name
</a><a href="#h1-1-47" id="h1-1-47" class="i">+                            || row.get(&amp;table.primary_key()?.name).unwrap_or(&amp;types::Value::Null)
</a><a href="#h1-1-48" id="h1-1-48" class="i">+                                != id)
</a><a href="#h1-1-49" id="h1-1-49" class="i">+                    {
</a><a href="#h1-1-50" id="h1-1-50" class="i">+                        return Err(Error::Value(format!(
</a><a href="#h1-1-51" id="h1-1-51" class="i">+                            &quot;Primary key {} is referenced by table {} column {}&quot;,
</a><a href="#h1-1-52" id="h1-1-52" class="i">+                            id, source.name, r.name
</a><a href="#h1-1-53" id="h1-1-53" class="i">+                        )));
</a><a href="#h1-1-54" id="h1-1-54" class="i">+                    }
</a><a href="#h1-1-55" id="h1-1-55" class="i">+                }
</a><a href="#h1-1-56" id="h1-1-56" class="i">+            }
</a><a href="#h1-1-57" id="h1-1-57" class="i">+        }
</a><a href="#h1-1-58" id="h1-1-58" class="i">+
</a><a href="#h1-1-59" id="h1-1-59" class="i">+        self.txn.delete(&amp;Key::Row(&amp;table.name, id).encode())
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;types::Value) -&gt; Result&lt;Option&lt;types::Row&gt;, Error&gt; {
<a href="#h1-2" id="h1-2" class="h">@@ -96,15 +148,68 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>     }
 
     fn update(&amp;mut self, table: &amp;str, id: &amp;types::Value, row: types::Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h1-2-3" id="h1-2-3" class="d">-        // FIXME For now, we&#39;re lazy and just do a delete + create
</a><a href="#h1-2-4" id="h1-2-4" class="d">-        self.delete(table, id)?;
</a><a href="#h1-2-5" id="h1-2-5" class="d">-        self.create(table, row)
</a><a href="#h1-2-6" id="h1-2-6" class="i">+        let table = self
</a><a href="#h1-2-7" id="h1-2-7" class="i">+            .read_table(&amp;table)?
</a><a href="#h1-2-8" id="h1-2-8" class="i">+            .ok_or_else(|| Error::Value(format!(&quot;Table {} does not exist&quot;, table)))?;
</a><a href="#h1-2-9" id="h1-2-9" class="i">+
</a><a href="#h1-2-10" id="h1-2-10" class="i">+        // If the primary key changes, we do a delete and create
</a><a href="#h1-2-11" id="h1-2-11" class="i">+        if id != &amp;table.row_key(&amp;row)? {
</a><a href="#h1-2-12" id="h1-2-12" class="i">+            self.delete(&amp;table.name, id)?;
</a><a href="#h1-2-13" id="h1-2-13" class="i">+            self.create(&amp;table.name, row)
</a><a href="#h1-2-14" id="h1-2-14" class="i">+
</a><a href="#h1-2-15" id="h1-2-15" class="i">+        // Otherwise, we validate the new row and replace the existing one
</a><a href="#h1-2-16" id="h1-2-16" class="i">+        } else {
</a><a href="#h1-2-17" id="h1-2-17" class="i">+            // Validate row
</a><a href="#h1-2-18" id="h1-2-18" class="i">+            table.validate_row(&amp;row)?;
</a><a href="#h1-2-19" id="h1-2-19" class="i">+
</a><a href="#h1-2-20" id="h1-2-20" class="i">+            // Validate referential integrity
</a><a href="#h1-2-21" id="h1-2-21" class="i">+            for (target, pks) in table.row_references(&amp;row)?.into_iter() {
</a><a href="#h1-2-22" id="h1-2-22" class="i">+                for pk in pks.into_iter() {
</a><a href="#h1-2-23" id="h1-2-23" class="i">+                    if target == table.name &amp;&amp; &amp;pk == id {
</a><a href="#h1-2-24" id="h1-2-24" class="i">+                        continue;
</a><a href="#h1-2-25" id="h1-2-25" class="i">+                    }
</a><a href="#h1-2-26" id="h1-2-26" class="i">+                    if self.read(&amp;target, &amp;pk)?.is_none() {
</a><a href="#h1-2-27" id="h1-2-27" class="i">+                        return Err(Error::Value(format!(
</a><a href="#h1-2-28" id="h1-2-28" class="i">+                            &quot;Referenced primary key {} in table {} does not exist&quot;,
</a><a href="#h1-2-29" id="h1-2-29" class="i">+                            pk, target,
</a><a href="#h1-2-30" id="h1-2-30" class="i">+                        )));
</a><a href="#h1-2-31" id="h1-2-31" class="i">+                    }
</a><a href="#h1-2-32" id="h1-2-32" class="i">+                }
</a><a href="#h1-2-33" id="h1-2-33" class="i">+            }
</a><a href="#h1-2-34" id="h1-2-34" class="i">+
</a><a href="#h1-2-35" id="h1-2-35" class="i">+            self.txn.set(&amp;Key::Row(&amp;table.name, &amp;id).encode(), serialize(&amp;row)?)
</a><a href="#h1-2-36" id="h1-2-36" class="i">+        }
</a>     }
 
     fn create_table(&amp;mut self, table: &amp;schema::Table) -&gt; Result&lt;(), Error&gt; {
         if self.read_table(&amp;table.name)?.is_some() {
             return Err(Error::Value(format!(&quot;Table {} already exists&quot;, table.name)));
         }
<a href="#h1-2-43" id="h1-2-43" class="i">+        for column in table.references() {
</a><a href="#h1-2-44" id="h1-2-44" class="i">+            let target = match &amp;column.references {
</a><a href="#h1-2-45" id="h1-2-45" class="i">+                Some(target) if target == &amp;table.name =&gt; table.clone(),
</a><a href="#h1-2-46" id="h1-2-46" class="i">+                Some(target) =&gt; self.read_table(&amp;target)?.ok_or_else(|| {
</a><a href="#h1-2-47" id="h1-2-47" class="i">+                    Error::Value(format!(
</a><a href="#h1-2-48" id="h1-2-48" class="i">+                        &quot;Table {} referenced by column {} does not exist&quot;,
</a><a href="#h1-2-49" id="h1-2-49" class="i">+                        target, column.name
</a><a href="#h1-2-50" id="h1-2-50" class="i">+                    ))
</a><a href="#h1-2-51" id="h1-2-51" class="i">+                })?,
</a><a href="#h1-2-52" id="h1-2-52" class="i">+                None =&gt; {
</a><a href="#h1-2-53" id="h1-2-53" class="i">+                    return Err(Error::Internal(
</a><a href="#h1-2-54" id="h1-2-54" class="i">+                        &quot;Table.references() returned non-reference column&quot;.into(),
</a><a href="#h1-2-55" id="h1-2-55" class="i">+                    ))
</a><a href="#h1-2-56" id="h1-2-56" class="i">+                }
</a><a href="#h1-2-57" id="h1-2-57" class="i">+            };
</a><a href="#h1-2-58" id="h1-2-58" class="i">+            if column.datatype != target.primary_key()?.datatype {
</a><a href="#h1-2-59" id="h1-2-59" class="i">+                return Err(Error::Value(format!(
</a><a href="#h1-2-60" id="h1-2-60" class="i">+                    &quot;Can&#39;t reference {} primary key of table {} from {} column {}&quot;,
</a><a href="#h1-2-61" id="h1-2-61" class="i">+                    target.primary_key()?.datatype,
</a><a href="#h1-2-62" id="h1-2-62" class="i">+                    target.name,
</a><a href="#h1-2-63" id="h1-2-63" class="i">+                    column.datatype,
</a><a href="#h1-2-64" id="h1-2-64" class="i">+                    column.name
</a><a href="#h1-2-65" id="h1-2-65" class="i">+                )));
</a><a href="#h1-2-66" id="h1-2-66" class="i">+            }
</a><a href="#h1-2-67" id="h1-2-67" class="i">+        }
</a>         self.txn.set(&amp;Key::Table(&amp;table.name).encode(), serialize(table)?)
     }
 
<a href="#h1-3" id="h1-3" class="h">@@ -112,6 +217,18 @@ impl&lt;S: kv::storage::Storage&gt; super::Transaction for Transaction&lt;S&gt; {
</a>         if self.read_table(table)?.is_none() {
             return Err(Error::Value(format!(&quot;Table {} does not exist&quot;, table)));
         }
<a href="#h1-3-3" id="h1-3-3" class="i">+        // Check for incoming references
</a><a href="#h1-3-4" id="h1-3-4" class="i">+        // FIXME This needs to be indexed or cached
</a><a href="#h1-3-5" id="h1-3-5" class="i">+        for source in self.list_tables()? {
</a><a href="#h1-3-6" id="h1-3-6" class="i">+            for column in source.references() {
</a><a href="#h1-3-7" id="h1-3-7" class="i">+                if source.name != table &amp;&amp; column.references.as_ref() == Some(&amp;table.to_string()) {
</a><a href="#h1-3-8" id="h1-3-8" class="i">+                    return Err(Error::Value(format!(
</a><a href="#h1-3-9" id="h1-3-9" class="i">+                        &quot;Table {} is referenced by table {} column {}&quot;,
</a><a href="#h1-3-10" id="h1-3-10" class="i">+                        table, source.name, column.name
</a><a href="#h1-3-11" id="h1-3-11" class="i">+                    )));
</a><a href="#h1-3-12" id="h1-3-12" class="i">+                }
</a><a href="#h1-3-13" id="h1-3-13" class="i">+            }
</a><a href="#h1-3-14" id="h1-3-14" class="i">+        }
</a>         // FIXME Needs to delete all table data as well
         self.txn.delete(&amp;Key::Table(table).encode())
     }
<b>diff --git a/<a id="h2" href="../file/src/sql/tests/schema.rs.html">src/sql/tests/schema.rs</a> b/<a href="../file/src/sql/tests/schema.rs.html">src/sql/tests/schema.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -101,8 +101,20 @@ test_schema! {
</a>     create_table_default_conflict_float_integer: &quot;CREATE TABLE name (id INTEGER PRIMARY KEY, value FLOAT DEFAULT 7)&quot;,
     create_table_default_conflict_integer_float: &quot;CREATE TABLE name (id INTEGER PRIMARY KEY, value INTEGER DEFAULT 3.14)&quot;,
 }
<a href="#h2-0-3" id="h2-0-3" class="d">-test_schema! { with [&quot;CREATE TABLE name (id INTEGER PRIMARY KEY)&quot;];
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    create_table_exists: &quot;CREATE TABLE name (id INTEGER PRIMARY KEY)&quot;,
</a><a href="#h2-0-5" id="h2-0-5" class="i">+test_schema! { with [&quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;];
</a><a href="#h2-0-6" id="h2-0-6" class="i">+    create_table_exists: &quot;CREATE TABLE test (id INTEGER PRIMARY KEY)&quot;,
</a><a href="#h2-0-7" id="h2-0-7" class="i">+
</a><a href="#h2-0-8" id="h2-0-8" class="i">+    create_table_ref: &quot;CREATE TABLE other (id INTEGER PRIMARY KEY, test_id INTEGER REFERENCES test)&quot;,
</a><a href="#h2-0-9" id="h2-0-9" class="i">+    create_table_ref_multiple: &quot;CREATE TABLE other (
</a><a href="#h2-0-10" id="h2-0-10" class="i">+        id INTEGER PRIMARY KEY,
</a><a href="#h2-0-11" id="h2-0-11" class="i">+        test_id_a INTEGER REFERENCES test,
</a><a href="#h2-0-12" id="h2-0-12" class="i">+        test_id_b INTEGER REFERENCES test,
</a><a href="#h2-0-13" id="h2-0-13" class="i">+        test_id_c INTEGER REFERENCES test
</a><a href="#h2-0-14" id="h2-0-14" class="i">+    )&quot;,
</a><a href="#h2-0-15" id="h2-0-15" class="i">+    create_table_ref_missing: &quot;CREATE TABLE other (id INTEGER PRIMARY KEY, missing_id INTEGER REFERENCES missing)&quot;,
</a><a href="#h2-0-16" id="h2-0-16" class="i">+    create_table_ref_type: &quot;CREATE TABLE other (id INTEGER PRIMARY KEY, test_id STRING REFERENCES test)&quot;,
</a><a href="#h2-0-17" id="h2-0-17" class="i">+    create_table_ref_self: &quot;CREATE TABLE other (id INTEGER PRIMARY KEY, self_id INTEGER REFERENCES other)&quot;,
</a><a href="#h2-0-18" id="h2-0-18" class="i">+    create_table_ref_self_type: &quot;CREATE TABLE other (id INTEGER PRIMARY KEY, self_id STRING REFERENCES other)&quot;,
</a> }
 
 test_schema! { with [
<a href="#h2-1" id="h2-1" class="h">@@ -118,6 +130,15 @@ test_schema! { with [
</a>     drop_table_missing: &quot;DROP TABLE name&quot;,
     drop_table_multiple: &quot;DROP TABLE a, c&quot;,
 }
<a href="#h2-1-3" id="h2-1-3" class="i">+test_schema! { with [
</a><a href="#h2-1-4" id="h2-1-4" class="i">+        &quot;CREATE TABLE target (id INTEGER PRIMARY KEY)&quot;,
</a><a href="#h2-1-5" id="h2-1-5" class="i">+        &quot;CREATE TABLE source (id INTEGER PRIMARY KEY, target_id INTEGER REFERENCES target)&quot;,
</a><a href="#h2-1-6" id="h2-1-6" class="i">+        &quot;CREATE TABLE self (id INTEGER PRIMARY KEY, self_id INTEGER REFERENCES self)&quot;,
</a><a href="#h2-1-7" id="h2-1-7" class="i">+    ];
</a><a href="#h2-1-8" id="h2-1-8" class="i">+    drop_table_ref_source: &quot;DROP TABLE source&quot;,
</a><a href="#h2-1-9" id="h2-1-9" class="i">+    drop_table_ref_target: &quot;DROP TABLE target&quot;,
</a><a href="#h2-1-10" id="h2-1-10" class="i">+    drop_table_ref_self: &quot;DROP TABLE self&quot;,
</a><a href="#h2-1-11" id="h2-1-11" class="i">+}
</a> 
 test_schema! { with [
         r#&quot;CREATE TABLE types (
<a href="#h2-2" id="h2-2" class="h">@@ -235,3 +256,54 @@ test_schema! { with [
</a>     insert_default_override: &quot;INSERT INTO defaults VALUES (1, TRUE, TRUE, FALSE, 2.718, 3, &#39;bar&#39;)&quot;,
     insert_default_override_null: &quot;INSERT INTO defaults VALUES (1, TRUE, NULL, NULL, NULL, NULL, NULL)&quot;,
 }
<a href="#h2-2-3" id="h2-2-3" class="i">+
</a><a href="#h2-2-4" id="h2-2-4" class="i">+test_schema! { with [
</a><a href="#h2-2-5" id="h2-2-5" class="i">+        // FIXME Test non-integer references as well
</a><a href="#h2-2-6" id="h2-2-6" class="i">+        r#&quot;CREATE TABLE &quot;integer&quot; (id INTEGER PRIMARY KEY)&quot;#,
</a><a href="#h2-2-7" id="h2-2-7" class="i">+        r#&quot;INSERT INTO &quot;integer&quot; VALUES (1), (2), (3)&quot;#,
</a><a href="#h2-2-8" id="h2-2-8" class="i">+        r#&quot;CREATE TABLE source (
</a><a href="#h2-2-9" id="h2-2-9" class="i">+            id INTEGER PRIMARY KEY,
</a><a href="#h2-2-10" id="h2-2-10" class="i">+            integer_id INTEGER REFERENCES &quot;integer&quot;
</a><a href="#h2-2-11" id="h2-2-11" class="i">+        )&quot;#,
</a><a href="#h2-2-12" id="h2-2-12" class="i">+    ];
</a><a href="#h2-2-13" id="h2-2-13" class="i">+    insert_ref_integer: &quot;INSERT INTO source (id, integer_id) VALUES (1, 1)&quot;,
</a><a href="#h2-2-14" id="h2-2-14" class="i">+    insert_ref_integer_null: &quot;INSERT INTO source (id, integer_id) VALUES (1, NULL)&quot;,
</a><a href="#h2-2-15" id="h2-2-15" class="i">+    insert_ref_integer_missing: &quot;INSERT INTO source (id, integer_id) VALUES (1, 7)&quot;,
</a><a href="#h2-2-16" id="h2-2-16" class="i">+}
</a><a href="#h2-2-17" id="h2-2-17" class="i">+
</a><a href="#h2-2-18" id="h2-2-18" class="i">+test_schema! { with [
</a><a href="#h2-2-19" id="h2-2-19" class="i">+        &quot;CREATE TABLE target (id INTEGER PRIMARY KEY, value STRING)&quot;,
</a><a href="#h2-2-20" id="h2-2-20" class="i">+        &quot;INSERT INTO target VALUES (1, &#39;a&#39;), (2, &#39;b&#39;), (3, &#39;c&#39;)&quot;,
</a><a href="#h2-2-21" id="h2-2-21" class="i">+        &quot;CREATE TABLE source (id INTEGER PRIMARY KEY, target_id INTEGER REFERENCES target)&quot;,
</a><a href="#h2-2-22" id="h2-2-22" class="i">+        &quot;INSERT INTO source VALUES (1, 1), (2, 2), (4, NULL)&quot;,
</a><a href="#h2-2-23" id="h2-2-23" class="i">+    ];
</a><a href="#h2-2-24" id="h2-2-24" class="i">+    delete_ref_conflict: &quot;DELETE FROM target WHERE id = 1&quot;,
</a><a href="#h2-2-25" id="h2-2-25" class="i">+    delete_ref_noref: &quot;DELETE FROM target WHERE id = 3&quot;,
</a><a href="#h2-2-26" id="h2-2-26" class="i">+    delete_ref_source: &quot;DELETE FROM source WHERE id = 1&quot;,
</a><a href="#h2-2-27" id="h2-2-27" class="i">+
</a><a href="#h2-2-28" id="h2-2-28" class="i">+    update_ref_value: &quot;UPDATE target SET value = &#39;x&#39; WHERE id = 1&quot;,
</a><a href="#h2-2-29" id="h2-2-29" class="i">+    update_ref_pk: &quot;UPDATE target SET id = 9 WHERE id = 1&quot;,
</a><a href="#h2-2-30" id="h2-2-30" class="i">+    update_ref_pk_noref: &quot;UPDATE target SET id = 9 WHERE id = 3&quot;,
</a><a href="#h2-2-31" id="h2-2-31" class="i">+    update_ref_source: &quot;UPDATE source SET target_id = 1 WHERE id = 4&quot;,
</a><a href="#h2-2-32" id="h2-2-32" class="i">+    update_ref_source_missing: &quot;UPDATE source SET target_id = 9 WHERE id = 4&quot;,
</a><a href="#h2-2-33" id="h2-2-33" class="i">+    update_ref_source_null: &quot;UPDATE source SET target_id = NULL WHERE id = 2&quot;,
</a><a href="#h2-2-34" id="h2-2-34" class="i">+}
</a><a href="#h2-2-35" id="h2-2-35" class="i">+
</a><a href="#h2-2-36" id="h2-2-36" class="i">+test_schema! { with [
</a><a href="#h2-2-37" id="h2-2-37" class="i">+        &quot;CREATE TABLE self (id INTEGER PRIMARY KEY, self_id INTEGER REFERENCES self, value STRING)&quot;,
</a><a href="#h2-2-38" id="h2-2-38" class="i">+        &quot;INSERT INTO self VALUES (1, 1, &#39;a&#39;), (2, 1, &#39;b&#39;), (3, 3, &#39;c&#39;), (4, NULL, &#39;d&#39;)&quot;,
</a><a href="#h2-2-39" id="h2-2-39" class="i">+    ];
</a><a href="#h2-2-40" id="h2-2-40" class="i">+    delete_ref_self: &quot;DELETE FROM self WHERE id = 3&quot;,
</a><a href="#h2-2-41" id="h2-2-41" class="i">+    delete_ref_self_all: &quot;DELETE FROM self&quot;,
</a><a href="#h2-2-42" id="h2-2-42" class="i">+    delete_ref_self_conflict: &quot;DELETE FROM self WHERE id = 1&quot;,
</a><a href="#h2-2-43" id="h2-2-43" class="i">+
</a><a href="#h2-2-44" id="h2-2-44" class="i">+    insert_ref_self: &quot;INSERT INTO self VALUES (5, 1, &#39;e&#39;)&quot;,
</a><a href="#h2-2-45" id="h2-2-45" class="i">+    insert_ref_self_null: &quot;INSERT INTO self VALUES (5, NULL, &#39;e&#39;)&quot;,
</a><a href="#h2-2-46" id="h2-2-46" class="i">+    insert_ref_self_missing: &quot;INSERT INTO self VALUES (5, 9, &#39;e&#39;)&quot;,
</a><a href="#h2-2-47" id="h2-2-47" class="i">+    insert_ref_self_self: &quot;INSERT INTO self VALUES (5, 5, &#39;e&#39;)&quot;,
</a><a href="#h2-2-48" id="h2-2-48" class="i">+
</a><a href="#h2-2-49" id="h2-2-49" class="i">+    update_ref_self_value: &quot;UPDATE self SET value = &#39;x&#39; WHERE id = 1&quot;,
</a><a href="#h2-2-50" id="h2-2-50" class="i">+    update_ref_self_pk: &quot;UPDATE self SET id = 9 WHERE id = 1&quot;,
</a><a href="#h2-2-51" id="h2-2-51" class="i">+    update_ref_self_pk_noref: &quot;UPDATE self SET id = 9 WHERE id = 2&quot;,
</a><a href="#h2-2-52" id="h2-2-52" class="i">+    update_ref_self_self: &quot;UPDATE self SET self_id = 2 WHERE id = 2&quot;,
</a><a href="#h2-2-53" id="h2-2-53" class="i">+}
</a><b>diff --git a/<a id="h3" href="../file/src/sql/tests/schema/create_table_exists.html">src/sql/tests/schema/create_table_exists</a> b/<a href="../file/src/sql/tests/schema/create_table_exists.html">src/sql/tests/schema/create_table_exists</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,7 +1,7 @@
</a><a href="#h3-0-0" id="h3-0-0" class="d">-Query: CREATE TABLE name (id INTEGER PRIMARY KEY)
</a><a href="#h3-0-1" id="h3-0-1" class="d">-Error: Value(&quot;Table name already exists&quot;)
</a><a href="#h3-0-2" id="h3-0-2" class="i">+Query: CREATE TABLE test (id INTEGER PRIMARY KEY)
</a><a href="#h3-0-3" id="h3-0-3" class="i">+Error: Value(&quot;Table test already exists&quot;)
</a> 
 Storage:
<a href="#h3-0-6" id="h3-0-6" class="d">-CREATE TABLE name (
</a><a href="#h3-0-7" id="h3-0-7" class="i">+CREATE TABLE test (
</a>   id INTEGER PRIMARY KEY NOT NULL
 )
<b>diff --git a/<a id="h4" href="../file/src/sql/tests/schema/create_table_ref.html">src/sql/tests/schema/create_table_ref</a> b/<a href="../file/src/sql/tests/schema/create_table_ref.html">src/sql/tests/schema/create_table_ref</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+Query: CREATE TABLE other (id INTEGER PRIMARY KEY, test_id INTEGER REFERENCES test)
</a><a href="#h4-0-1" id="h4-0-1" class="i">+
</a><a href="#h4-0-2" id="h4-0-2" class="i">+Storage:
</a><a href="#h4-0-3" id="h4-0-3" class="i">+CREATE TABLE other (
</a><a href="#h4-0-4" id="h4-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h4-0-5" id="h4-0-5" class="i">+  test_id INTEGER DEFAULT NULL REFERENCES test
</a><a href="#h4-0-6" id="h4-0-6" class="i">+)
</a><a href="#h4-0-7" id="h4-0-7" class="i">+
</a><a href="#h4-0-8" id="h4-0-8" class="i">+CREATE TABLE test (
</a><a href="#h4-0-9" id="h4-0-9" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h4-0-10" id="h4-0-10" class="i">+)
</a><b>diff --git a/<a id="h5" href="../file/src/sql/tests/schema/create_table_ref_missing.html">src/sql/tests/schema/create_table_ref_missing</a> b/<a href="../file/src/sql/tests/schema/create_table_ref_missing.html">src/sql/tests/schema/create_table_ref_missing</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h5-0-0" id="h5-0-0" class="i">+Query: CREATE TABLE other (id INTEGER PRIMARY KEY, missing_id INTEGER REFERENCES missing)
</a><a href="#h5-0-1" id="h5-0-1" class="i">+Error: Value(&quot;Table missing referenced by column missing_id does not exist&quot;)
</a><a href="#h5-0-2" id="h5-0-2" class="i">+
</a><a href="#h5-0-3" id="h5-0-3" class="i">+Storage:
</a><a href="#h5-0-4" id="h5-0-4" class="i">+CREATE TABLE test (
</a><a href="#h5-0-5" id="h5-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h5-0-6" id="h5-0-6" class="i">+)
</a><b>diff --git a/<a id="h6" href="../file/src/sql/tests/schema/create_table_ref_multiple.html">src/sql/tests/schema/create_table_ref_multiple</a> b/<a href="../file/src/sql/tests/schema/create_table_ref_multiple.html">src/sql/tests/schema/create_table_ref_multiple</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+Query: CREATE TABLE other (
</a><a href="#h6-0-1" id="h6-0-1" class="i">+        id INTEGER PRIMARY KEY,
</a><a href="#h6-0-2" id="h6-0-2" class="i">+        test_id_a INTEGER REFERENCES test,
</a><a href="#h6-0-3" id="h6-0-3" class="i">+        test_id_b INTEGER REFERENCES test,
</a><a href="#h6-0-4" id="h6-0-4" class="i">+        test_id_c INTEGER REFERENCES test
</a><a href="#h6-0-5" id="h6-0-5" class="i">+    )
</a><a href="#h6-0-6" id="h6-0-6" class="i">+
</a><a href="#h6-0-7" id="h6-0-7" class="i">+Storage:
</a><a href="#h6-0-8" id="h6-0-8" class="i">+CREATE TABLE other (
</a><a href="#h6-0-9" id="h6-0-9" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h6-0-10" id="h6-0-10" class="i">+  test_id_a INTEGER DEFAULT NULL REFERENCES test,
</a><a href="#h6-0-11" id="h6-0-11" class="i">+  test_id_b INTEGER DEFAULT NULL REFERENCES test,
</a><a href="#h6-0-12" id="h6-0-12" class="i">+  test_id_c INTEGER DEFAULT NULL REFERENCES test
</a><a href="#h6-0-13" id="h6-0-13" class="i">+)
</a><a href="#h6-0-14" id="h6-0-14" class="i">+
</a><a href="#h6-0-15" id="h6-0-15" class="i">+CREATE TABLE test (
</a><a href="#h6-0-16" id="h6-0-16" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h6-0-17" id="h6-0-17" class="i">+)
</a><b>diff --git a/<a id="h7" href="../file/src/sql/tests/schema/create_table_ref_self.html">src/sql/tests/schema/create_table_ref_self</a> b/<a href="../file/src/sql/tests/schema/create_table_ref_self.html">src/sql/tests/schema/create_table_ref_self</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+Query: CREATE TABLE other (id INTEGER PRIMARY KEY, self_id INTEGER REFERENCES other)
</a><a href="#h7-0-1" id="h7-0-1" class="i">+
</a><a href="#h7-0-2" id="h7-0-2" class="i">+Storage:
</a><a href="#h7-0-3" id="h7-0-3" class="i">+CREATE TABLE other (
</a><a href="#h7-0-4" id="h7-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h7-0-5" id="h7-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES other
</a><a href="#h7-0-6" id="h7-0-6" class="i">+)
</a><a href="#h7-0-7" id="h7-0-7" class="i">+
</a><a href="#h7-0-8" id="h7-0-8" class="i">+CREATE TABLE test (
</a><a href="#h7-0-9" id="h7-0-9" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h7-0-10" id="h7-0-10" class="i">+)
</a><b>diff --git a/<a id="h8" href="../file/src/sql/tests/schema/create_table_ref_self_type.html">src/sql/tests/schema/create_table_ref_self_type</a> b/<a href="../file/src/sql/tests/schema/create_table_ref_self_type.html">src/sql/tests/schema/create_table_ref_self_type</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+Query: CREATE TABLE other (id INTEGER PRIMARY KEY, self_id STRING REFERENCES other)
</a><a href="#h8-0-1" id="h8-0-1" class="i">+Error: Value(&quot;Can\&#39;t reference INTEGER primary key of table other from STRING column self_id&quot;)
</a><a href="#h8-0-2" id="h8-0-2" class="i">+
</a><a href="#h8-0-3" id="h8-0-3" class="i">+Storage:
</a><a href="#h8-0-4" id="h8-0-4" class="i">+CREATE TABLE test (
</a><a href="#h8-0-5" id="h8-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h8-0-6" id="h8-0-6" class="i">+)
</a><b>diff --git a/<a id="h9" href="../file/src/sql/tests/schema/create_table_ref_type.html">src/sql/tests/schema/create_table_ref_type</a> b/<a href="../file/src/sql/tests/schema/create_table_ref_type.html">src/sql/tests/schema/create_table_ref_type</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+Query: CREATE TABLE other (id INTEGER PRIMARY KEY, test_id STRING REFERENCES test)
</a><a href="#h9-0-1" id="h9-0-1" class="i">+Error: Value(&quot;Can\&#39;t reference INTEGER primary key of table test from STRING column test_id&quot;)
</a><a href="#h9-0-2" id="h9-0-2" class="i">+
</a><a href="#h9-0-3" id="h9-0-3" class="i">+Storage:
</a><a href="#h9-0-4" id="h9-0-4" class="i">+CREATE TABLE test (
</a><a href="#h9-0-5" id="h9-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h9-0-6" id="h9-0-6" class="i">+)
</a><b>diff --git a/<a id="h10" href="../file/src/sql/tests/schema/delete_ref_conflict.html">src/sql/tests/schema/delete_ref_conflict</a> b/<a href="../file/src/sql/tests/schema/delete_ref_conflict.html">src/sql/tests/schema/delete_ref_conflict</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+Query: DELETE FROM target WHERE id = 1
</a><a href="#h10-0-1" id="h10-0-1" class="i">+Error: Value(&quot;Primary key 1 is referenced by table source column target_id&quot;)
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+Storage:
</a><a href="#h10-0-4" id="h10-0-4" class="i">+CREATE TABLE source (
</a><a href="#h10-0-5" id="h10-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h10-0-6" id="h10-0-6" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h10-0-7" id="h10-0-7" class="i">+)
</a><a href="#h10-0-8" id="h10-0-8" class="i">+[Integer(1), Integer(1)]
</a><a href="#h10-0-9" id="h10-0-9" class="i">+[Integer(2), Integer(2)]
</a><a href="#h10-0-10" id="h10-0-10" class="i">+[Integer(4), Null]
</a><a href="#h10-0-11" id="h10-0-11" class="i">+
</a><a href="#h10-0-12" id="h10-0-12" class="i">+CREATE TABLE target (
</a><a href="#h10-0-13" id="h10-0-13" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h10-0-14" id="h10-0-14" class="i">+  value STRING DEFAULT NULL
</a><a href="#h10-0-15" id="h10-0-15" class="i">+)
</a><a href="#h10-0-16" id="h10-0-16" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h10-0-17" id="h10-0-17" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h10-0-18" id="h10-0-18" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h11" href="../file/src/sql/tests/schema/delete_ref_noref.html">src/sql/tests/schema/delete_ref_noref</a> b/<a href="../file/src/sql/tests/schema/delete_ref_noref.html">src/sql/tests/schema/delete_ref_noref</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+Query: DELETE FROM target WHERE id = 3
</a><a href="#h11-0-1" id="h11-0-1" class="i">+
</a><a href="#h11-0-2" id="h11-0-2" class="i">+Storage:
</a><a href="#h11-0-3" id="h11-0-3" class="i">+CREATE TABLE source (
</a><a href="#h11-0-4" id="h11-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h11-0-5" id="h11-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h11-0-6" id="h11-0-6" class="i">+)
</a><a href="#h11-0-7" id="h11-0-7" class="i">+[Integer(1), Integer(1)]
</a><a href="#h11-0-8" id="h11-0-8" class="i">+[Integer(2), Integer(2)]
</a><a href="#h11-0-9" id="h11-0-9" class="i">+[Integer(4), Null]
</a><a href="#h11-0-10" id="h11-0-10" class="i">+
</a><a href="#h11-0-11" id="h11-0-11" class="i">+CREATE TABLE target (
</a><a href="#h11-0-12" id="h11-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h11-0-13" id="h11-0-13" class="i">+  value STRING DEFAULT NULL
</a><a href="#h11-0-14" id="h11-0-14" class="i">+)
</a><a href="#h11-0-15" id="h11-0-15" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h11-0-16" id="h11-0-16" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><b>diff --git a/<a id="h12" href="../file/src/sql/tests/schema/delete_ref_self.html">src/sql/tests/schema/delete_ref_self</a> b/<a href="../file/src/sql/tests/schema/delete_ref_self.html">src/sql/tests/schema/delete_ref_self</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+Query: DELETE FROM self WHERE id = 3
</a><a href="#h12-0-1" id="h12-0-1" class="i">+
</a><a href="#h12-0-2" id="h12-0-2" class="i">+Storage:
</a><a href="#h12-0-3" id="h12-0-3" class="i">+CREATE TABLE self (
</a><a href="#h12-0-4" id="h12-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h12-0-5" id="h12-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h12-0-6" id="h12-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h12-0-7" id="h12-0-7" class="i">+)
</a><a href="#h12-0-8" id="h12-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h12-0-9" id="h12-0-9" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h12-0-10" id="h12-0-10" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h13" href="../file/src/sql/tests/schema/delete_ref_self_all.html">src/sql/tests/schema/delete_ref_self_all</a> b/<a href="../file/src/sql/tests/schema/delete_ref_self_all.html">src/sql/tests/schema/delete_ref_self_all</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+Query: DELETE FROM self
</a><a href="#h13-0-1" id="h13-0-1" class="i">+Error: Value(&quot;Primary key 1 is referenced by table self column self_id&quot;)
</a><a href="#h13-0-2" id="h13-0-2" class="i">+
</a><a href="#h13-0-3" id="h13-0-3" class="i">+Storage:
</a><a href="#h13-0-4" id="h13-0-4" class="i">+CREATE TABLE self (
</a><a href="#h13-0-5" id="h13-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h13-0-6" id="h13-0-6" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h13-0-7" id="h13-0-7" class="i">+  value STRING DEFAULT NULL
</a><a href="#h13-0-8" id="h13-0-8" class="i">+)
</a><a href="#h13-0-9" id="h13-0-9" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h13-0-10" id="h13-0-10" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h13-0-11" id="h13-0-11" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h13-0-12" id="h13-0-12" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h14" href="../file/src/sql/tests/schema/delete_ref_self_conflict.html">src/sql/tests/schema/delete_ref_self_conflict</a> b/<a href="../file/src/sql/tests/schema/delete_ref_self_conflict.html">src/sql/tests/schema/delete_ref_self_conflict</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+Query: DELETE FROM self WHERE id = 1
</a><a href="#h14-0-1" id="h14-0-1" class="i">+Error: Value(&quot;Primary key 1 is referenced by table self column self_id&quot;)
</a><a href="#h14-0-2" id="h14-0-2" class="i">+
</a><a href="#h14-0-3" id="h14-0-3" class="i">+Storage:
</a><a href="#h14-0-4" id="h14-0-4" class="i">+CREATE TABLE self (
</a><a href="#h14-0-5" id="h14-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h14-0-6" id="h14-0-6" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h14-0-7" id="h14-0-7" class="i">+  value STRING DEFAULT NULL
</a><a href="#h14-0-8" id="h14-0-8" class="i">+)
</a><a href="#h14-0-9" id="h14-0-9" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h14-0-10" id="h14-0-10" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h14-0-11" id="h14-0-11" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h14-0-12" id="h14-0-12" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h15" href="../file/src/sql/tests/schema/delete_ref_source.html">src/sql/tests/schema/delete_ref_source</a> b/<a href="../file/src/sql/tests/schema/delete_ref_source.html">src/sql/tests/schema/delete_ref_source</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+Query: DELETE FROM source WHERE id = 1
</a><a href="#h15-0-1" id="h15-0-1" class="i">+
</a><a href="#h15-0-2" id="h15-0-2" class="i">+Storage:
</a><a href="#h15-0-3" id="h15-0-3" class="i">+CREATE TABLE source (
</a><a href="#h15-0-4" id="h15-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h15-0-5" id="h15-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h15-0-6" id="h15-0-6" class="i">+)
</a><a href="#h15-0-7" id="h15-0-7" class="i">+[Integer(2), Integer(2)]
</a><a href="#h15-0-8" id="h15-0-8" class="i">+[Integer(4), Null]
</a><a href="#h15-0-9" id="h15-0-9" class="i">+
</a><a href="#h15-0-10" id="h15-0-10" class="i">+CREATE TABLE target (
</a><a href="#h15-0-11" id="h15-0-11" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h15-0-12" id="h15-0-12" class="i">+  value STRING DEFAULT NULL
</a><a href="#h15-0-13" id="h15-0-13" class="i">+)
</a><a href="#h15-0-14" id="h15-0-14" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h15-0-15" id="h15-0-15" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h15-0-16" id="h15-0-16" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h16" href="../file/src/sql/tests/schema/drop_table_ref_self.html">src/sql/tests/schema/drop_table_ref_self</a> b/<a href="../file/src/sql/tests/schema/drop_table_ref_self.html">src/sql/tests/schema/drop_table_ref_self</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h16-0-0" id="h16-0-0" class="i">+Query: DROP TABLE self
</a><a href="#h16-0-1" id="h16-0-1" class="i">+
</a><a href="#h16-0-2" id="h16-0-2" class="i">+Storage:
</a><a href="#h16-0-3" id="h16-0-3" class="i">+CREATE TABLE source (
</a><a href="#h16-0-4" id="h16-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h16-0-5" id="h16-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h16-0-6" id="h16-0-6" class="i">+)
</a><a href="#h16-0-7" id="h16-0-7" class="i">+
</a><a href="#h16-0-8" id="h16-0-8" class="i">+CREATE TABLE target (
</a><a href="#h16-0-9" id="h16-0-9" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h16-0-10" id="h16-0-10" class="i">+)
</a><b>diff --git a/<a id="h17" href="../file/src/sql/tests/schema/drop_table_ref_source.html">src/sql/tests/schema/drop_table_ref_source</a> b/<a href="../file/src/sql/tests/schema/drop_table_ref_source.html">src/sql/tests/schema/drop_table_ref_source</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,11 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+Query: DROP TABLE source
</a><a href="#h17-0-1" id="h17-0-1" class="i">+
</a><a href="#h17-0-2" id="h17-0-2" class="i">+Storage:
</a><a href="#h17-0-3" id="h17-0-3" class="i">+CREATE TABLE self (
</a><a href="#h17-0-4" id="h17-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h17-0-5" id="h17-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self
</a><a href="#h17-0-6" id="h17-0-6" class="i">+)
</a><a href="#h17-0-7" id="h17-0-7" class="i">+
</a><a href="#h17-0-8" id="h17-0-8" class="i">+CREATE TABLE target (
</a><a href="#h17-0-9" id="h17-0-9" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h17-0-10" id="h17-0-10" class="i">+)
</a><b>diff --git a/<a id="h18" href="../file/src/sql/tests/schema/drop_table_ref_target.html">src/sql/tests/schema/drop_table_ref_target</a> b/<a href="../file/src/sql/tests/schema/drop_table_ref_target.html">src/sql/tests/schema/drop_table_ref_target</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,17 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+Query: DROP TABLE target
</a><a href="#h18-0-1" id="h18-0-1" class="i">+Error: Value(&quot;Table target is referenced by table source column target_id&quot;)
</a><a href="#h18-0-2" id="h18-0-2" class="i">+
</a><a href="#h18-0-3" id="h18-0-3" class="i">+Storage:
</a><a href="#h18-0-4" id="h18-0-4" class="i">+CREATE TABLE self (
</a><a href="#h18-0-5" id="h18-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h18-0-6" id="h18-0-6" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self
</a><a href="#h18-0-7" id="h18-0-7" class="i">+)
</a><a href="#h18-0-8" id="h18-0-8" class="i">+
</a><a href="#h18-0-9" id="h18-0-9" class="i">+CREATE TABLE source (
</a><a href="#h18-0-10" id="h18-0-10" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h18-0-11" id="h18-0-11" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h18-0-12" id="h18-0-12" class="i">+)
</a><a href="#h18-0-13" id="h18-0-13" class="i">+
</a><a href="#h18-0-14" id="h18-0-14" class="i">+CREATE TABLE target (
</a><a href="#h18-0-15" id="h18-0-15" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h18-0-16" id="h18-0-16" class="i">+)
</a><b>diff --git a/<a id="h19" href="../file/src/sql/tests/schema/insert_ref_integer.html">src/sql/tests/schema/insert_ref_integer</a> b/<a href="../file/src/sql/tests/schema/insert_ref_integer.html">src/sql/tests/schema/insert_ref_integer</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+Query: INSERT INTO source (id, integer_id) VALUES (1, 1)
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+Storage:
</a><a href="#h19-0-3" id="h19-0-3" class="i">+CREATE TABLE &quot;integer&quot; (
</a><a href="#h19-0-4" id="h19-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h19-0-5" id="h19-0-5" class="i">+)
</a><a href="#h19-0-6" id="h19-0-6" class="i">+[Integer(1)]
</a><a href="#h19-0-7" id="h19-0-7" class="i">+[Integer(2)]
</a><a href="#h19-0-8" id="h19-0-8" class="i">+[Integer(3)]
</a><a href="#h19-0-9" id="h19-0-9" class="i">+
</a><a href="#h19-0-10" id="h19-0-10" class="i">+CREATE TABLE source (
</a><a href="#h19-0-11" id="h19-0-11" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h19-0-12" id="h19-0-12" class="i">+  integer_id INTEGER DEFAULT NULL REFERENCES integer
</a><a href="#h19-0-13" id="h19-0-13" class="i">+)
</a><a href="#h19-0-14" id="h19-0-14" class="i">+[Integer(1), Integer(1)]
</a><b>diff --git a/<a id="h20" href="../file/src/sql/tests/schema/insert_ref_integer_missing.html">src/sql/tests/schema/insert_ref_integer_missing</a> b/<a href="../file/src/sql/tests/schema/insert_ref_integer_missing.html">src/sql/tests/schema/insert_ref_integer_missing</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h20-0-0" id="h20-0-0" class="i">+Query: INSERT INTO source (id, integer_id) VALUES (1, 7)
</a><a href="#h20-0-1" id="h20-0-1" class="i">+Error: Value(&quot;Referenced primary key 7 in table integer does not exist&quot;)
</a><a href="#h20-0-2" id="h20-0-2" class="i">+
</a><a href="#h20-0-3" id="h20-0-3" class="i">+Storage:
</a><a href="#h20-0-4" id="h20-0-4" class="i">+CREATE TABLE &quot;integer&quot; (
</a><a href="#h20-0-5" id="h20-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h20-0-6" id="h20-0-6" class="i">+)
</a><a href="#h20-0-7" id="h20-0-7" class="i">+[Integer(1)]
</a><a href="#h20-0-8" id="h20-0-8" class="i">+[Integer(2)]
</a><a href="#h20-0-9" id="h20-0-9" class="i">+[Integer(3)]
</a><a href="#h20-0-10" id="h20-0-10" class="i">+
</a><a href="#h20-0-11" id="h20-0-11" class="i">+CREATE TABLE source (
</a><a href="#h20-0-12" id="h20-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h20-0-13" id="h20-0-13" class="i">+  integer_id INTEGER DEFAULT NULL REFERENCES integer
</a><a href="#h20-0-14" id="h20-0-14" class="i">+)
</a><b>diff --git a/<a id="h21" href="../file/src/sql/tests/schema/insert_ref_integer_null.html">src/sql/tests/schema/insert_ref_integer_null</a> b/<a href="../file/src/sql/tests/schema/insert_ref_integer_null.html">src/sql/tests/schema/insert_ref_integer_null</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+Query: INSERT INTO source (id, integer_id) VALUES (1, NULL)
</a><a href="#h21-0-1" id="h21-0-1" class="i">+
</a><a href="#h21-0-2" id="h21-0-2" class="i">+Storage:
</a><a href="#h21-0-3" id="h21-0-3" class="i">+CREATE TABLE &quot;integer&quot; (
</a><a href="#h21-0-4" id="h21-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL
</a><a href="#h21-0-5" id="h21-0-5" class="i">+)
</a><a href="#h21-0-6" id="h21-0-6" class="i">+[Integer(1)]
</a><a href="#h21-0-7" id="h21-0-7" class="i">+[Integer(2)]
</a><a href="#h21-0-8" id="h21-0-8" class="i">+[Integer(3)]
</a><a href="#h21-0-9" id="h21-0-9" class="i">+
</a><a href="#h21-0-10" id="h21-0-10" class="i">+CREATE TABLE source (
</a><a href="#h21-0-11" id="h21-0-11" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h21-0-12" id="h21-0-12" class="i">+  integer_id INTEGER DEFAULT NULL REFERENCES integer
</a><a href="#h21-0-13" id="h21-0-13" class="i">+)
</a><a href="#h21-0-14" id="h21-0-14" class="i">+[Integer(1), Null]
</a><b>diff --git a/<a id="h22" href="../file/src/sql/tests/schema/insert_ref_self.html">src/sql/tests/schema/insert_ref_self</a> b/<a href="../file/src/sql/tests/schema/insert_ref_self.html">src/sql/tests/schema/insert_ref_self</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h22-0-0" id="h22-0-0" class="i">+Query: INSERT INTO self VALUES (5, 1, &#39;e&#39;)
</a><a href="#h22-0-1" id="h22-0-1" class="i">+
</a><a href="#h22-0-2" id="h22-0-2" class="i">+Storage:
</a><a href="#h22-0-3" id="h22-0-3" class="i">+CREATE TABLE self (
</a><a href="#h22-0-4" id="h22-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h22-0-5" id="h22-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h22-0-6" id="h22-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h22-0-7" id="h22-0-7" class="i">+)
</a><a href="#h22-0-8" id="h22-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h22-0-9" id="h22-0-9" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h22-0-10" id="h22-0-10" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h22-0-11" id="h22-0-11" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><a href="#h22-0-12" id="h22-0-12" class="i">+[Integer(5), Integer(1), String(&quot;e&quot;)]
</a><b>diff --git a/<a id="h23" href="../file/src/sql/tests/schema/insert_ref_self_missing.html">src/sql/tests/schema/insert_ref_self_missing</a> b/<a href="../file/src/sql/tests/schema/insert_ref_self_missing.html">src/sql/tests/schema/insert_ref_self_missing</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+Query: INSERT INTO self VALUES (5, 9, &#39;e&#39;)
</a><a href="#h23-0-1" id="h23-0-1" class="i">+Error: Value(&quot;Referenced primary key 9 in table self does not exist&quot;)
</a><a href="#h23-0-2" id="h23-0-2" class="i">+
</a><a href="#h23-0-3" id="h23-0-3" class="i">+Storage:
</a><a href="#h23-0-4" id="h23-0-4" class="i">+CREATE TABLE self (
</a><a href="#h23-0-5" id="h23-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h23-0-6" id="h23-0-6" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h23-0-7" id="h23-0-7" class="i">+  value STRING DEFAULT NULL
</a><a href="#h23-0-8" id="h23-0-8" class="i">+)
</a><a href="#h23-0-9" id="h23-0-9" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h23-0-10" id="h23-0-10" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h23-0-11" id="h23-0-11" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h23-0-12" id="h23-0-12" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h24" href="../file/src/sql/tests/schema/insert_ref_self_null.html">src/sql/tests/schema/insert_ref_self_null</a> b/<a href="../file/src/sql/tests/schema/insert_ref_self_null.html">src/sql/tests/schema/insert_ref_self_null</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h24-0-0" id="h24-0-0" class="i">+Query: INSERT INTO self VALUES (5, NULL, &#39;e&#39;)
</a><a href="#h24-0-1" id="h24-0-1" class="i">+
</a><a href="#h24-0-2" id="h24-0-2" class="i">+Storage:
</a><a href="#h24-0-3" id="h24-0-3" class="i">+CREATE TABLE self (
</a><a href="#h24-0-4" id="h24-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h24-0-5" id="h24-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h24-0-6" id="h24-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h24-0-7" id="h24-0-7" class="i">+)
</a><a href="#h24-0-8" id="h24-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h24-0-9" id="h24-0-9" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h24-0-10" id="h24-0-10" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h24-0-11" id="h24-0-11" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><a href="#h24-0-12" id="h24-0-12" class="i">+[Integer(5), Null, String(&quot;e&quot;)]
</a><b>diff --git a/<a id="h25" href="../file/src/sql/tests/schema/insert_ref_self_self.html">src/sql/tests/schema/insert_ref_self_self</a> b/<a href="../file/src/sql/tests/schema/insert_ref_self_self.html">src/sql/tests/schema/insert_ref_self_self</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+Query: INSERT INTO self VALUES (5, 5, &#39;e&#39;)
</a><a href="#h25-0-1" id="h25-0-1" class="i">+
</a><a href="#h25-0-2" id="h25-0-2" class="i">+Storage:
</a><a href="#h25-0-3" id="h25-0-3" class="i">+CREATE TABLE self (
</a><a href="#h25-0-4" id="h25-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h25-0-5" id="h25-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h25-0-6" id="h25-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h25-0-7" id="h25-0-7" class="i">+)
</a><a href="#h25-0-8" id="h25-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h25-0-9" id="h25-0-9" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h25-0-10" id="h25-0-10" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h25-0-11" id="h25-0-11" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><a href="#h25-0-12" id="h25-0-12" class="i">+[Integer(5), Integer(5), String(&quot;e&quot;)]
</a><b>diff --git a/<a id="h26" href="../file/src/sql/tests/schema/update_ref_pk.html">src/sql/tests/schema/update_ref_pk</a> b/<a href="../file/src/sql/tests/schema/update_ref_pk.html">src/sql/tests/schema/update_ref_pk</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h26-0-0" id="h26-0-0" class="i">+Query: UPDATE target SET id = 9 WHERE id = 1
</a><a href="#h26-0-1" id="h26-0-1" class="i">+Error: Value(&quot;Primary key 1 is referenced by table source column target_id&quot;)
</a><a href="#h26-0-2" id="h26-0-2" class="i">+
</a><a href="#h26-0-3" id="h26-0-3" class="i">+Storage:
</a><a href="#h26-0-4" id="h26-0-4" class="i">+CREATE TABLE source (
</a><a href="#h26-0-5" id="h26-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h26-0-6" id="h26-0-6" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h26-0-7" id="h26-0-7" class="i">+)
</a><a href="#h26-0-8" id="h26-0-8" class="i">+[Integer(1), Integer(1)]
</a><a href="#h26-0-9" id="h26-0-9" class="i">+[Integer(2), Integer(2)]
</a><a href="#h26-0-10" id="h26-0-10" class="i">+[Integer(4), Null]
</a><a href="#h26-0-11" id="h26-0-11" class="i">+
</a><a href="#h26-0-12" id="h26-0-12" class="i">+CREATE TABLE target (
</a><a href="#h26-0-13" id="h26-0-13" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h26-0-14" id="h26-0-14" class="i">+  value STRING DEFAULT NULL
</a><a href="#h26-0-15" id="h26-0-15" class="i">+)
</a><a href="#h26-0-16" id="h26-0-16" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h26-0-17" id="h26-0-17" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h26-0-18" id="h26-0-18" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h27" href="../file/src/sql/tests/schema/update_ref_pk_noref.html">src/sql/tests/schema/update_ref_pk_noref</a> b/<a href="../file/src/sql/tests/schema/update_ref_pk_noref.html">src/sql/tests/schema/update_ref_pk_noref</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+Query: UPDATE target SET id = 9 WHERE id = 3
</a><a href="#h27-0-1" id="h27-0-1" class="i">+
</a><a href="#h27-0-2" id="h27-0-2" class="i">+Storage:
</a><a href="#h27-0-3" id="h27-0-3" class="i">+CREATE TABLE source (
</a><a href="#h27-0-4" id="h27-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h27-0-5" id="h27-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h27-0-6" id="h27-0-6" class="i">+)
</a><a href="#h27-0-7" id="h27-0-7" class="i">+[Integer(1), Integer(1)]
</a><a href="#h27-0-8" id="h27-0-8" class="i">+[Integer(2), Integer(2)]
</a><a href="#h27-0-9" id="h27-0-9" class="i">+[Integer(4), Null]
</a><a href="#h27-0-10" id="h27-0-10" class="i">+
</a><a href="#h27-0-11" id="h27-0-11" class="i">+CREATE TABLE target (
</a><a href="#h27-0-12" id="h27-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h27-0-13" id="h27-0-13" class="i">+  value STRING DEFAULT NULL
</a><a href="#h27-0-14" id="h27-0-14" class="i">+)
</a><a href="#h27-0-15" id="h27-0-15" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h27-0-16" id="h27-0-16" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h27-0-17" id="h27-0-17" class="i">+[Integer(9), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h28" href="../file/src/sql/tests/schema/update_ref_self_pk.html">src/sql/tests/schema/update_ref_self_pk</a> b/<a href="../file/src/sql/tests/schema/update_ref_self_pk.html">src/sql/tests/schema/update_ref_self_pk</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -0,0 +1,13 @@
</a><a href="#h28-0-0" id="h28-0-0" class="i">+Query: UPDATE self SET id = 9 WHERE id = 1
</a><a href="#h28-0-1" id="h28-0-1" class="i">+Error: Value(&quot;Primary key 1 is referenced by table self column self_id&quot;)
</a><a href="#h28-0-2" id="h28-0-2" class="i">+
</a><a href="#h28-0-3" id="h28-0-3" class="i">+Storage:
</a><a href="#h28-0-4" id="h28-0-4" class="i">+CREATE TABLE self (
</a><a href="#h28-0-5" id="h28-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h28-0-6" id="h28-0-6" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h28-0-7" id="h28-0-7" class="i">+  value STRING DEFAULT NULL
</a><a href="#h28-0-8" id="h28-0-8" class="i">+)
</a><a href="#h28-0-9" id="h28-0-9" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h28-0-10" id="h28-0-10" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h28-0-11" id="h28-0-11" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h28-0-12" id="h28-0-12" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h29" href="../file/src/sql/tests/schema/update_ref_self_pk_noref.html">src/sql/tests/schema/update_ref_self_pk_noref</a> b/<a href="../file/src/sql/tests/schema/update_ref_self_pk_noref.html">src/sql/tests/schema/update_ref_self_pk_noref</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+Query: UPDATE self SET id = 9 WHERE id = 2
</a><a href="#h29-0-1" id="h29-0-1" class="i">+
</a><a href="#h29-0-2" id="h29-0-2" class="i">+Storage:
</a><a href="#h29-0-3" id="h29-0-3" class="i">+CREATE TABLE self (
</a><a href="#h29-0-4" id="h29-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h29-0-5" id="h29-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h29-0-6" id="h29-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h29-0-7" id="h29-0-7" class="i">+)
</a><a href="#h29-0-8" id="h29-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h29-0-9" id="h29-0-9" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h29-0-10" id="h29-0-10" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><a href="#h29-0-11" id="h29-0-11" class="i">+[Integer(9), Integer(1), String(&quot;b&quot;)]
</a><b>diff --git a/<a id="h30" href="../file/src/sql/tests/schema/update_ref_self_self.html">src/sql/tests/schema/update_ref_self_self</a> b/<a href="../file/src/sql/tests/schema/update_ref_self_self.html">src/sql/tests/schema/update_ref_self_self</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h30-0-0" id="h30-0-0" class="i">+Query: UPDATE self SET self_id = 2 WHERE id = 2
</a><a href="#h30-0-1" id="h30-0-1" class="i">+
</a><a href="#h30-0-2" id="h30-0-2" class="i">+Storage:
</a><a href="#h30-0-3" id="h30-0-3" class="i">+CREATE TABLE self (
</a><a href="#h30-0-4" id="h30-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h30-0-5" id="h30-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h30-0-6" id="h30-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h30-0-7" id="h30-0-7" class="i">+)
</a><a href="#h30-0-8" id="h30-0-8" class="i">+[Integer(1), Integer(1), String(&quot;a&quot;)]
</a><a href="#h30-0-9" id="h30-0-9" class="i">+[Integer(2), Integer(2), String(&quot;b&quot;)]
</a><a href="#h30-0-10" id="h30-0-10" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h30-0-11" id="h30-0-11" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h31" href="../file/src/sql/tests/schema/update_ref_self_value.html">src/sql/tests/schema/update_ref_self_value</a> b/<a href="../file/src/sql/tests/schema/update_ref_self_value.html">src/sql/tests/schema/update_ref_self_value</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,12 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+Query: UPDATE self SET value = &#39;x&#39; WHERE id = 1
</a><a href="#h31-0-1" id="h31-0-1" class="i">+
</a><a href="#h31-0-2" id="h31-0-2" class="i">+Storage:
</a><a href="#h31-0-3" id="h31-0-3" class="i">+CREATE TABLE self (
</a><a href="#h31-0-4" id="h31-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h31-0-5" id="h31-0-5" class="i">+  self_id INTEGER DEFAULT NULL REFERENCES self,
</a><a href="#h31-0-6" id="h31-0-6" class="i">+  value STRING DEFAULT NULL
</a><a href="#h31-0-7" id="h31-0-7" class="i">+)
</a><a href="#h31-0-8" id="h31-0-8" class="i">+[Integer(1), Integer(1), String(&quot;x&quot;)]
</a><a href="#h31-0-9" id="h31-0-9" class="i">+[Integer(2), Integer(1), String(&quot;b&quot;)]
</a><a href="#h31-0-10" id="h31-0-10" class="i">+[Integer(3), Integer(3), String(&quot;c&quot;)]
</a><a href="#h31-0-11" id="h31-0-11" class="i">+[Integer(4), Null, String(&quot;d&quot;)]
</a><b>diff --git a/<a id="h32" href="../file/src/sql/tests/schema/update_ref_source.html">src/sql/tests/schema/update_ref_source</a> b/<a href="../file/src/sql/tests/schema/update_ref_source.html">src/sql/tests/schema/update_ref_source</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h32-0-0" id="h32-0-0" class="i">+Query: UPDATE source SET target_id = 1 WHERE id = 4
</a><a href="#h32-0-1" id="h32-0-1" class="i">+
</a><a href="#h32-0-2" id="h32-0-2" class="i">+Storage:
</a><a href="#h32-0-3" id="h32-0-3" class="i">+CREATE TABLE source (
</a><a href="#h32-0-4" id="h32-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h32-0-5" id="h32-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h32-0-6" id="h32-0-6" class="i">+)
</a><a href="#h32-0-7" id="h32-0-7" class="i">+[Integer(1), Integer(1)]
</a><a href="#h32-0-8" id="h32-0-8" class="i">+[Integer(2), Integer(2)]
</a><a href="#h32-0-9" id="h32-0-9" class="i">+[Integer(4), Integer(1)]
</a><a href="#h32-0-10" id="h32-0-10" class="i">+
</a><a href="#h32-0-11" id="h32-0-11" class="i">+CREATE TABLE target (
</a><a href="#h32-0-12" id="h32-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h32-0-13" id="h32-0-13" class="i">+  value STRING DEFAULT NULL
</a><a href="#h32-0-14" id="h32-0-14" class="i">+)
</a><a href="#h32-0-15" id="h32-0-15" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h32-0-16" id="h32-0-16" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h32-0-17" id="h32-0-17" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h33" href="../file/src/sql/tests/schema/update_ref_source_missing.html">src/sql/tests/schema/update_ref_source_missing</a> b/<a href="../file/src/sql/tests/schema/update_ref_source_missing.html">src/sql/tests/schema/update_ref_source_missing</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,19 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+Query: UPDATE source SET target_id = 9 WHERE id = 4
</a><a href="#h33-0-1" id="h33-0-1" class="i">+Error: Value(&quot;Referenced primary key 9 in table target does not exist&quot;)
</a><a href="#h33-0-2" id="h33-0-2" class="i">+
</a><a href="#h33-0-3" id="h33-0-3" class="i">+Storage:
</a><a href="#h33-0-4" id="h33-0-4" class="i">+CREATE TABLE source (
</a><a href="#h33-0-5" id="h33-0-5" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h33-0-6" id="h33-0-6" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h33-0-7" id="h33-0-7" class="i">+)
</a><a href="#h33-0-8" id="h33-0-8" class="i">+[Integer(1), Integer(1)]
</a><a href="#h33-0-9" id="h33-0-9" class="i">+[Integer(2), Integer(2)]
</a><a href="#h33-0-10" id="h33-0-10" class="i">+[Integer(4), Null]
</a><a href="#h33-0-11" id="h33-0-11" class="i">+
</a><a href="#h33-0-12" id="h33-0-12" class="i">+CREATE TABLE target (
</a><a href="#h33-0-13" id="h33-0-13" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h33-0-14" id="h33-0-14" class="i">+  value STRING DEFAULT NULL
</a><a href="#h33-0-15" id="h33-0-15" class="i">+)
</a><a href="#h33-0-16" id="h33-0-16" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h33-0-17" id="h33-0-17" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h33-0-18" id="h33-0-18" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h34" href="../file/src/sql/tests/schema/update_ref_source_null.html">src/sql/tests/schema/update_ref_source_null</a> b/<a href="../file/src/sql/tests/schema/update_ref_source_null.html">src/sql/tests/schema/update_ref_source_null</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h34-0-0" id="h34-0-0" class="i">+Query: UPDATE source SET target_id = NULL WHERE id = 2
</a><a href="#h34-0-1" id="h34-0-1" class="i">+
</a><a href="#h34-0-2" id="h34-0-2" class="i">+Storage:
</a><a href="#h34-0-3" id="h34-0-3" class="i">+CREATE TABLE source (
</a><a href="#h34-0-4" id="h34-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h34-0-5" id="h34-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h34-0-6" id="h34-0-6" class="i">+)
</a><a href="#h34-0-7" id="h34-0-7" class="i">+[Integer(1), Integer(1)]
</a><a href="#h34-0-8" id="h34-0-8" class="i">+[Integer(2), Null]
</a><a href="#h34-0-9" id="h34-0-9" class="i">+[Integer(4), Null]
</a><a href="#h34-0-10" id="h34-0-10" class="i">+
</a><a href="#h34-0-11" id="h34-0-11" class="i">+CREATE TABLE target (
</a><a href="#h34-0-12" id="h34-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h34-0-13" id="h34-0-13" class="i">+  value STRING DEFAULT NULL
</a><a href="#h34-0-14" id="h34-0-14" class="i">+)
</a><a href="#h34-0-15" id="h34-0-15" class="i">+[Integer(1), String(&quot;a&quot;)]
</a><a href="#h34-0-16" id="h34-0-16" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h34-0-17" id="h34-0-17" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h35" href="../file/src/sql/tests/schema/update_ref_value.html">src/sql/tests/schema/update_ref_value</a> b/<a href="../file/src/sql/tests/schema/update_ref_value.html">src/sql/tests/schema/update_ref_value</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,18 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+Query: UPDATE target SET value = &#39;x&#39; WHERE id = 1
</a><a href="#h35-0-1" id="h35-0-1" class="i">+
</a><a href="#h35-0-2" id="h35-0-2" class="i">+Storage:
</a><a href="#h35-0-3" id="h35-0-3" class="i">+CREATE TABLE source (
</a><a href="#h35-0-4" id="h35-0-4" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h35-0-5" id="h35-0-5" class="i">+  target_id INTEGER DEFAULT NULL REFERENCES target
</a><a href="#h35-0-6" id="h35-0-6" class="i">+)
</a><a href="#h35-0-7" id="h35-0-7" class="i">+[Integer(1), Integer(1)]
</a><a href="#h35-0-8" id="h35-0-8" class="i">+[Integer(2), Integer(2)]
</a><a href="#h35-0-9" id="h35-0-9" class="i">+[Integer(4), Null]
</a><a href="#h35-0-10" id="h35-0-10" class="i">+
</a><a href="#h35-0-11" id="h35-0-11" class="i">+CREATE TABLE target (
</a><a href="#h35-0-12" id="h35-0-12" class="i">+  id INTEGER PRIMARY KEY NOT NULL,
</a><a href="#h35-0-13" id="h35-0-13" class="i">+  value STRING DEFAULT NULL
</a><a href="#h35-0-14" id="h35-0-14" class="i">+)
</a><a href="#h35-0-15" id="h35-0-15" class="i">+[Integer(1), String(&quot;x&quot;)]
</a><a href="#h35-0-16" id="h35-0-16" class="i">+[Integer(2), String(&quot;b&quot;)]
</a><a href="#h35-0-17" id="h35-0-17" class="i">+[Integer(3), String(&quot;c&quot;)]
</a><b>diff --git a/<a id="h36" href="../file/src/sql/types/schema.rs.html">src/sql/types/schema.rs</a> b/<a href="../file/src/sql/types/schema.rs.html">src/sql/types/schema.rs</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -96,6 +96,19 @@ impl Table {
</a>         }
     }
 
<a href="#h36-0-3" id="h36-0-3" class="i">+    /// Returns the primary key column of the table
</a><a href="#h36-0-4" id="h36-0-4" class="i">+    pub fn primary_key(&amp;self) -&gt; Result&lt;&amp;Column, Error&gt; {
</a><a href="#h36-0-5" id="h36-0-5" class="i">+        self.columns
</a><a href="#h36-0-6" id="h36-0-6" class="i">+            .iter()
</a><a href="#h36-0-7" id="h36-0-7" class="i">+            .find(|c| c.primary_key)
</a><a href="#h36-0-8" id="h36-0-8" class="i">+            .ok_or_else(|| Error::Value(&quot;Primary key not found&quot;.into()))
</a><a href="#h36-0-9" id="h36-0-9" class="i">+    }
</a><a href="#h36-0-10" id="h36-0-10" class="i">+
</a><a href="#h36-0-11" id="h36-0-11" class="i">+    /// Returns the set of tables references by this table
</a><a href="#h36-0-12" id="h36-0-12" class="i">+    pub fn references(&amp;self) -&gt; Vec&lt;Column&gt; {
</a><a href="#h36-0-13" id="h36-0-13" class="i">+        self.columns.iter().filter(|c| c.references.is_some()).cloned().collect()
</a><a href="#h36-0-14" id="h36-0-14" class="i">+    }
</a><a href="#h36-0-15" id="h36-0-15" class="i">+
</a>     /// Returns a row from a hashmap keyed by column name, padding it with nulls if needed
     pub fn row_from_hashmap(&amp;self, row: HashMap&lt;String, Value&gt;) -&gt; Row {
         self.columns.iter().map(|c| row.get(&amp;c.name).cloned().unwrap_or(Value::Null)).collect()
<a href="#h36-1" id="h36-1" class="h">@@ -123,6 +136,28 @@ impl Table {
</a>         .ok_or_else(|| Error::Value(&quot;Primary key value not found for row&quot;.into()))
     }
 
<a href="#h36-1-3" id="h36-1-3" class="i">+    /// Returns outbound references from a row as a table/pk hash map
</a><a href="#h36-1-4" id="h36-1-4" class="i">+    // FIXME Should remove duplicates, for performance
</a><a href="#h36-1-5" id="h36-1-5" class="i">+    pub fn row_references(&amp;self, row: &amp;[Value]) -&gt; Result&lt;HashMap&lt;String, Vec&lt;Value&gt;&gt;, Error&gt; {
</a><a href="#h36-1-6" id="h36-1-6" class="i">+        let mut refs = HashMap::new();
</a><a href="#h36-1-7" id="h36-1-7" class="i">+        for (i, column) in self.columns.iter().enumerate() {
</a><a href="#h36-1-8" id="h36-1-8" class="i">+            if let Some(target) = &amp;column.references {
</a><a href="#h36-1-9" id="h36-1-9" class="i">+                match row.get(i).cloned() {
</a><a href="#h36-1-10" id="h36-1-10" class="i">+                    Some(Value::Null) =&gt; {}
</a><a href="#h36-1-11" id="h36-1-11" class="i">+                    Some(Value::Float(f)) if f.is_nan() =&gt; {}
</a><a href="#h36-1-12" id="h36-1-12" class="i">+                    Some(v) =&gt; refs.entry(target.clone()).or_insert_with(Vec::new).push(v),
</a><a href="#h36-1-13" id="h36-1-13" class="i">+                    None =&gt; {
</a><a href="#h36-1-14" id="h36-1-14" class="i">+                        return Err(Error::Value(format!(
</a><a href="#h36-1-15" id="h36-1-15" class="i">+                            &quot;No value found for column {}&quot;,
</a><a href="#h36-1-16" id="h36-1-16" class="i">+                            column.name
</a><a href="#h36-1-17" id="h36-1-17" class="i">+                        )))
</a><a href="#h36-1-18" id="h36-1-18" class="i">+                    }
</a><a href="#h36-1-19" id="h36-1-19" class="i">+                }
</a><a href="#h36-1-20" id="h36-1-20" class="i">+            }
</a><a href="#h36-1-21" id="h36-1-21" class="i">+        }
</a><a href="#h36-1-22" id="h36-1-22" class="i">+        Ok(refs)
</a><a href="#h36-1-23" id="h36-1-23" class="i">+    }
</a><a href="#h36-1-24" id="h36-1-24" class="i">+
</a>     /// Validates the table schema
     pub fn validate(&amp;self) -&gt; Result&lt;(), Error&gt; {
         if self.columns.is_empty() {
</pre>
</div>
</body>
</html>
