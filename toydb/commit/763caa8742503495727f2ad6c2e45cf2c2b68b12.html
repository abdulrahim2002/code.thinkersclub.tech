<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: verify engine operations in log tests - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/763caa8742503495727f2ad6c2e45cf2c2b68b12.html">763caa8742503495727f2ad6c2e45cf2c2b68b12</a>
<b>parent</b> <a href="../commit/a79f9eb2cadb92b74cd90704e1ce16317154e638.html">a79f9eb2cadb92b74cd90704e1ce16317154e638</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Thu, 30 May 2024 22:25:25 +0200

raft: verify engine operations in log tests

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/raft/log.rs</a></td><td> | </td><td class="num">74</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">src/raft/testscripts/log/append</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">src/raft/testscripts/log/commit</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/raft/testscripts/log/splice</a></td><td> | </td><td class="num">50</td><td><span class="i">+++++++++++++++++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/raft/testscripts/log/term</a></td><td> | </td><td class="num">19</td><td><span class="i">++++++++++</span><span class="d">---------</span></td></tr>
</table></pre><pre>7 files changed, 133 insertions(+), 75 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -614,9 +614,9 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;goldenscript&quot;
<a href="#h0-0-3" id="h0-0-3" class="d">-version = &quot;0.4.0&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="i">+version = &quot;0.5.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-0-6" id="h0-0-6" class="d">-checksum = &quot;a26382869e4845509917e9412b56ccb1c8061bee0cd965710a73c071b6d567d6&quot;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+checksum = &quot;55ca7296b5d8221d19ba6c21483871e2c89fd198d4dd275d63cb36329c5219da&quot;
</a> dependencies = [
  &quot;goldenfile&quot;,
  &quot;nom&quot;,
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -34,7 +34,7 @@ uuid = { version = &quot;1.8.0&quot;, features = [&quot;v4&quot;] }
</a> [dev-dependencies]
 escargot = &quot;0.5.10&quot;
 goldenfile = &quot;1.7.1&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-goldenscript = &quot;0.4.0&quot;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+goldenscript = &quot;0.5.0&quot;
</a> paste = &quot;1.0.14&quot;
 pretty_assertions = &quot;1.4.0&quot;
 serde_json = &quot;1.0.117&quot;
<b>diff --git a/<a id="h2" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -139,6 +139,7 @@ impl Log {
</a>             (t, _) if term &lt; t =&gt; return errassert!(&quot;term regression {t} → {term}&quot;),
             (t, _) if term &gt; t =&gt; {} // below, term == t
             (0, _) =&gt; return errassert!(&quot;can&#39;t set term 0&quot;),
<a href="#h2-0-3" id="h2-0-3" class="i">+            (t, v) if t == term &amp;&amp; v == vote =&gt; return Ok(()),
</a>             (_, None) =&gt; {}
             (_, v) if vote != v =&gt; return errassert!(&quot;can&#39;t change vote {v:?} → {vote:?}&quot;),
             (_, _) =&gt; {}
<a href="#h2-1" id="h2-1" class="h">@@ -169,18 +170,18 @@ impl Log {
</a>     /// Commits entries up to and including the given index. The index must
     /// exist, be at or after the current commit index, and have the given term.
     pub fn commit(&amp;mut self, index: Index, term: Term) -&gt; Result&lt;Index&gt; {
<a href="#h2-1-3" id="h2-1-3" class="d">-        if index &lt; self.commit_index {
</a><a href="#h2-1-4" id="h2-1-4" class="d">-            return errassert!(&quot;commit index regression {} → {}&quot;, self.commit_index, index);
</a><a href="#h2-1-5" id="h2-1-5" class="d">-        }
</a>         match self.get(index)? {
<a href="#h2-1-7" id="h2-1-7" class="i">+            Some(e) if e.index &lt; self.commit_index =&gt; {
</a><a href="#h2-1-8" id="h2-1-8" class="i">+                return errassert!(&quot;commit index regression {} → {}&quot;, self.commit_index, e.index);
</a><a href="#h2-1-9" id="h2-1-9" class="i">+            }
</a>             Some(e) if e.term != term =&gt; return errassert!(&quot;commit term {term} != {}&quot;, e.term),
<a href="#h2-1-11" id="h2-1-11" class="i">+            Some(e) if e.index == self.commit_index =&gt; return Ok(index),
</a>             Some(_) =&gt; {}
             None =&gt; return errassert!(&quot;commit index {index} does not exist&quot;),
         };
         self.engine.set(&amp;Key::CommitIndex.encode()?, bincode::serialize(&amp;(index, term))?)?;
         // NB: the commit index doesn&#39;t need to be fsynced, since the entries
         // are fsynced and the commit index can be recovered from a log quorum.
<a href="#h2-1-18" id="h2-1-18" class="d">-        // TODO: add testing for this.
</a>         self.commit_index = index;
         self.commit_term = term;
         Ok(index)
<a href="#h2-2" id="h2-2" class="h">@@ -300,6 +301,7 @@ impl Log {
</a> #[cfg(test)]
 mod tests {
     use super::*;
<a href="#h2-2-3" id="h2-2-3" class="i">+    use crossbeam::channel::Receiver;
</a>     use std::{error::Error, result::Result};
     use test_each_file::test_each_path;
 
<a href="#h2-3" id="h2-3" class="h">@@ -313,32 +315,37 @@ mod tests {
</a>     /// Runs Raft log goldenscript tests. For available commands, see run().
     struct TestRunner {
         log: Log,
<a href="#h2-3-3" id="h2-3-3" class="i">+        op_rx: Receiver&lt;storage::debug::Operation&gt;,
</a>     }
 
     impl goldenscript::Runner for TestRunner {
         fn run(&amp;mut self, command: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
             let mut output = String::new();
             match command.name.as_str() {
<a href="#h2-3-10" id="h2-3-10" class="d">-                // append TERM [COMMAND]
</a><a href="#h2-3-11" id="h2-3-11" class="i">+                // append TERM [COMMAND] [oplog=BOOL]
</a>                 &quot;append&quot; =&gt; {
                     let mut args = command.consume_args();
                     let term = args.next_pos().ok_or(&quot;term not given&quot;)?.parse()?;
                     let command = args.next_pos().map(|a| a.value.as_bytes().to_vec());
<a href="#h2-3-16" id="h2-3-16" class="i">+                    let oplog = args.lookup_parse(&quot;oplog&quot;)?.unwrap_or(false);
</a>                     args.reject_rest()?;
                     let index = self.log.append(term, command)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h2-3-20" id="h2-3-20" class="i">+                    self.maybe_oplog(oplog, &amp;mut output);
</a>                     output.push_str(&amp;format!(&quot;append → {}\n&quot;, Self::format_entry(&amp;entry)));
                 }
 
<a href="#h2-3-24" id="h2-3-24" class="d">-                // commit INDEX@TERM
</a><a href="#h2-3-25" id="h2-3-25" class="i">+                // commit INDEX@TERM [oplog=BOOL]
</a>                 &quot;commit&quot; =&gt; {
                     let mut args = command.consume_args();
                     let (index, term) = Self::parse_index_term(
                         &amp;args.next_pos().ok_or(&quot;index/term not given&quot;)?.value,
                     )?;
<a href="#h2-3-31" id="h2-3-31" class="i">+                    let oplog = args.lookup_parse(&quot;oplog&quot;)?.unwrap_or(false);
</a>                     args.reject_rest()?;
                     let index = self.log.commit(index, term)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h2-3-35" id="h2-3-35" class="i">+                    self.maybe_oplog(oplog, &amp;mut output);
</a>                     output.push_str(&amp;format!(&quot;commit → {}\n&quot;, Self::format_entry(&amp;entry)));
                 }
 
<a href="#h2-4" id="h2-4" class="h">@@ -388,12 +395,8 @@ mod tests {
</a>                     let range = (std::ops::Bound::Unbounded, std::ops::Bound::Unbounded);
                     let mut scan = self.log.engine.scan_dyn(range);
                     while let Some((key, value)) = scan.next().transpose()? {
<a href="#h2-4-3" id="h2-4-3" class="d">-                        output.push_str(&amp;format!(
</a><a href="#h2-4-4" id="h2-4-4" class="d">-                            &quot;{:?} 0x{} = 0x{}\n&quot;,
</a><a href="#h2-4-5" id="h2-4-5" class="d">-                            Key::decode(&amp;key)?,
</a><a href="#h2-4-6" id="h2-4-6" class="d">-                            hex::encode(&amp;key),
</a><a href="#h2-4-7" id="h2-4-7" class="d">-                            hex::encode(&amp;value)
</a><a href="#h2-4-8" id="h2-4-8" class="d">-                        ));
</a><a href="#h2-4-9" id="h2-4-9" class="i">+                        output.push_str(&amp;Self::format_key_value(&amp;key, &amp;value));
</a><a href="#h2-4-10" id="h2-4-10" class="i">+                        output.push(&#39;\n&#39;);
</a>                     }
                 }
 
<a href="#h2-5" id="h2-5" class="h">@@ -413,18 +416,21 @@ mod tests {
</a>                     }
                 }
 
<a href="#h2-5-3" id="h2-5-3" class="d">-                // set_term TERM [VOTE]
</a><a href="#h2-5-4" id="h2-5-4" class="i">+                // set_term TERM [VOTE] [oplog=true]
</a>                 &quot;set_term&quot; =&gt; {
                     let mut args = command.consume_args();
                     let term = args.next_pos().ok_or(&quot;term not given&quot;)?.parse()?;
                     let vote = args.next_pos().map(|a| a.parse()).transpose()?;
<a href="#h2-5-9" id="h2-5-9" class="i">+                    let oplog = args.lookup_parse(&quot;oplog&quot;)?.unwrap_or(false);
</a>                     args.reject_rest()?;
                     self.log.set_term(term, vote)?;
<a href="#h2-5-12" id="h2-5-12" class="i">+                    self.maybe_oplog(oplog, &amp;mut output);
</a>                 }
 
<a href="#h2-5-15" id="h2-5-15" class="d">-                // splice [INDEX@TERM=COMMAND...]
</a><a href="#h2-5-16" id="h2-5-16" class="i">+                // splice [INDEX@TERM=COMMAND...] [oplog=BOOL]
</a>                 &quot;splice&quot; =&gt; {
                     let mut args = command.consume_args();
<a href="#h2-5-19" id="h2-5-19" class="i">+                    let oplog = args.lookup_parse(&quot;oplog&quot;)?.unwrap_or(false);
</a>                     let mut entries = Vec::new();
                     for arg in args.rest_key() {
                         let (index, term) = Self::parse_index_term(arg.key.as_deref().unwrap())?;
<a href="#h2-6" id="h2-6" class="h">@@ -437,6 +443,7 @@ mod tests {
</a>                     args.reject_rest()?;
                     let index = self.log.splice(entries)?;
                     let entry = self.log.get(index)?.expect(&quot;entry not found&quot;);
<a href="#h2-6-3" id="h2-6-3" class="i">+                    self.maybe_oplog(oplog, &amp;mut output);
</a>                     output.push_str(&amp;format!(&quot;splice → {}\n&quot;, Self::format_entry(&amp;entry)));
                 }
 
<a href="#h2-7" id="h2-7" class="h">@@ -460,12 +467,20 @@ mod tests {
</a>             }
             Ok(output)
         }
<a href="#h2-7-3" id="h2-7-3" class="i">+
</a><a href="#h2-7-4" id="h2-7-4" class="i">+        fn end_command(&amp;mut self, _: &amp;goldenscript::Command) -&gt; Result&lt;String, Box&lt;dyn Error&gt;&gt; {
</a><a href="#h2-7-5" id="h2-7-5" class="i">+            // Drain the oplog, to avoid it leaking to another command.
</a><a href="#h2-7-6" id="h2-7-6" class="i">+            while self.op_rx.try_recv().is_ok() {}
</a><a href="#h2-7-7" id="h2-7-7" class="i">+            Ok(String::new())
</a><a href="#h2-7-8" id="h2-7-8" class="i">+        }
</a>     }
 
     impl TestRunner {
         fn new() -&gt; Self {
<a href="#h2-7-13" id="h2-7-13" class="d">-            let log = Log::new(crate::storage::Memory::new()).expect(&quot;log failed&quot;);
</a><a href="#h2-7-14" id="h2-7-14" class="d">-            Self { log }
</a><a href="#h2-7-15" id="h2-7-15" class="i">+            let engine = storage::Debug::new(storage::Memory::new());
</a><a href="#h2-7-16" id="h2-7-16" class="i">+            let op_rx = engine.op_rx();
</a><a href="#h2-7-17" id="h2-7-17" class="i">+            let log = Log::new(engine).expect(&quot;log init failed&quot;);
</a><a href="#h2-7-18" id="h2-7-18" class="i">+            Self { log, op_rx }
</a>         }
 
         /// Formats a log entry.
<a href="#h2-8" id="h2-8" class="h">@@ -477,6 +492,33 @@ mod tests {
</a>             format!(&quot;{}@{} {command}&quot;, entry.index, entry.term)
         }
 
<a href="#h2-8-3" id="h2-8-3" class="i">+        /// Formats a raw key.
</a><a href="#h2-8-4" id="h2-8-4" class="i">+        fn format_key(key: &amp;[u8]) -&gt; String {
</a><a href="#h2-8-5" id="h2-8-5" class="i">+            format!(&quot;{:?} 0x{}&quot;, Key::decode(key).expect(&quot;invalid key&quot;), hex::encode(key))
</a><a href="#h2-8-6" id="h2-8-6" class="i">+        }
</a><a href="#h2-8-7" id="h2-8-7" class="i">+
</a><a href="#h2-8-8" id="h2-8-8" class="i">+        /// Formats a raw key/value pair.
</a><a href="#h2-8-9" id="h2-8-9" class="i">+        fn format_key_value(key: &amp;[u8], value: &amp;[u8]) -&gt; String {
</a><a href="#h2-8-10" id="h2-8-10" class="i">+            format!(&quot;{} = 0x{}&quot;, Self::format_key(key), hex::encode(value))
</a><a href="#h2-8-11" id="h2-8-11" class="i">+        }
</a><a href="#h2-8-12" id="h2-8-12" class="i">+
</a><a href="#h2-8-13" id="h2-8-13" class="i">+        /// Outputs the oplog if requested.
</a><a href="#h2-8-14" id="h2-8-14" class="i">+        fn maybe_oplog(&amp;self, maybe: bool, output: &amp;mut String) {
</a><a href="#h2-8-15" id="h2-8-15" class="i">+            if !maybe {
</a><a href="#h2-8-16" id="h2-8-16" class="i">+                return;
</a><a href="#h2-8-17" id="h2-8-17" class="i">+            }
</a><a href="#h2-8-18" id="h2-8-18" class="i">+            while let Ok(op) = self.op_rx.try_recv() {
</a><a href="#h2-8-19" id="h2-8-19" class="i">+                use storage::debug::Operation;
</a><a href="#h2-8-20" id="h2-8-20" class="i">+                let s = match op {
</a><a href="#h2-8-21" id="h2-8-21" class="i">+                    Operation::Delete(k) =&gt; format!(&quot;delete {}&quot;, Self::format_key(&amp;k)),
</a><a href="#h2-8-22" id="h2-8-22" class="i">+                    Operation::Flush =&gt; &quot;flush&quot;.to_string(),
</a><a href="#h2-8-23" id="h2-8-23" class="i">+                    Operation::Set(k, v) =&gt; format!(&quot;set {}&quot;, Self::format_key_value(&amp;k, &amp;v)),
</a><a href="#h2-8-24" id="h2-8-24" class="i">+                };
</a><a href="#h2-8-25" id="h2-8-25" class="i">+                output.push_str(&amp;s);
</a><a href="#h2-8-26" id="h2-8-26" class="i">+                output.push(&#39;\n&#39;);
</a><a href="#h2-8-27" id="h2-8-27" class="i">+            }
</a><a href="#h2-8-28" id="h2-8-28" class="i">+        }
</a><a href="#h2-8-29" id="h2-8-29" class="i">+
</a>         /// Parses an index@term pair.
         fn parse_index_term(s: &amp;str) -&gt; Result&lt;(Index, Term), Box&lt;dyn Error&gt;&gt; {
             let re = regex::Regex::new(r&quot;^(\d+)@(\d+)$&quot;).expect(&quot;invalid regex&quot;);
<b>diff --git a/<a id="h3" href="../file/src/raft/testscripts/log/append.html">src/raft/testscripts/log/append</a> b/<a href="../file/src/raft/testscripts/log/append.html">src/raft/testscripts/log/append</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -1,36 +1,33 @@
</a> # Appending an entry with term 0 fails, even on an empty log.
 !append 0 foo
<a href="#h3-0-2" id="h3-0-2" class="d">-status
</a> ---
 Error: assertion failed: can&#39;t append entry with term 0
<a href="#h3-0-5" id="h3-0-5" class="d">-last=0@0 commit=0@0
</a> 
 # Appending to an empty log works. The term doesn&#39;t have to be 1, and doesn&#39;t
<a href="#h3-0-8" id="h3-0-8" class="d">-# have to match get_term().
</a><a href="#h3-0-9" id="h3-0-9" class="d">-#
</a><a href="#h3-0-10" id="h3-0-10" class="d">-# TODO: test that append flushes to disk.
</a><a href="#h3-0-11" id="h3-0-11" class="d">-append 2 foo
</a><a href="#h3-0-12" id="h3-0-12" class="d">-scan
</a><a href="#h3-0-13" id="h3-0-13" class="i">+# have to match get_term(). The entry is written to the engine and flushed
</a><a href="#h3-0-14" id="h3-0-14" class="i">+# to durable storage.
</a><a href="#h3-0-15" id="h3-0-15" class="i">+append 2 foo oplog=true
</a> ---
<a href="#h3-0-17" id="h3-0-17" class="i">+set Entry(1) 0x000000000000000001 = 0x020103666f6f
</a><a href="#h3-0-18" id="h3-0-18" class="i">+flush
</a> append → 1@2 foo
<a href="#h3-0-20" id="h3-0-20" class="d">-1@2 foo
</a> 
<a href="#h3-0-22" id="h3-0-22" class="d">-# Appending a noop entry (no command) works.
</a><a href="#h3-0-23" id="h3-0-23" class="d">-append 2
</a><a href="#h3-0-24" id="h3-0-24" class="d">-scan
</a><a href="#h3-0-25" id="h3-0-25" class="i">+# Appending a noop entry (no command) also works.
</a><a href="#h3-0-26" id="h3-0-26" class="i">+append 2 oplog=true
</a> ---
<a href="#h3-0-28" id="h3-0-28" class="i">+set Entry(2) 0x000000000000000002 = 0x0200
</a><a href="#h3-0-29" id="h3-0-29" class="i">+flush
</a> append → 2@2 None
<a href="#h3-0-31" id="h3-0-31" class="d">-1@2 foo
</a><a href="#h3-0-32" id="h3-0-32" class="d">-2@2 None
</a> 
<a href="#h3-0-34" id="h3-0-34" class="d">-# The last index/term should be updated, the commit index shouldn&#39;t.
</a><a href="#h3-0-35" id="h3-0-35" class="i">+# Check that the last index/term is updated (commit index isn&#39;t), and that
</a><a href="#h3-0-36" id="h3-0-36" class="i">+# the engine contains the expected data, both in logical and raw form.
</a> status
<a href="#h3-0-38" id="h3-0-38" class="d">----
</a><a href="#h3-0-39" id="h3-0-39" class="d">-last=2@2 commit=0@0
</a><a href="#h3-0-40" id="h3-0-40" class="d">-
</a><a href="#h3-0-41" id="h3-0-41" class="d">-# Check the raw encoding.
</a><a href="#h3-0-42" id="h3-0-42" class="i">+scan
</a> raw
 ---
<a href="#h3-0-45" id="h3-0-45" class="i">+last=2@2 commit=0@0
</a><a href="#h3-0-46" id="h3-0-46" class="i">+1@2 foo
</a><a href="#h3-0-47" id="h3-0-47" class="i">+2@2 None
</a> Entry(1) 0x000000000000000001 = 0x020103666f6f
 Entry(2) 0x000000000000000002 = 0x0200
 
<b>diff --git a/<a id="h4" href="../file/src/raft/testscripts/log/commit.html">src/raft/testscripts/log/commit</a> b/<a href="../file/src/raft/testscripts/log/commit.html">src/raft/testscripts/log/commit</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -4,34 +4,36 @@
</a> Error: assertion failed: commit index 1 does not exist
 
 # Add some entries.
<a href="#h4-0-3" id="h4-0-3" class="d">-append 1
</a><a href="#h4-0-4" id="h4-0-4" class="d">-append 1 foo
</a><a href="#h4-0-5" id="h4-0-5" class="d">-append 2 bar
</a><a href="#h4-0-6" id="h4-0-6" class="i">+splice 1@1= 2@1=foo 3@2=bar
</a> ---
<a href="#h4-0-8" id="h4-0-8" class="d">-append → 1@1 None
</a><a href="#h4-0-9" id="h4-0-9" class="d">-append → 2@1 foo
</a><a href="#h4-0-10" id="h4-0-10" class="d">-append → 3@2 bar
</a><a href="#h4-0-11" id="h4-0-11" class="i">+splice → 3@2 bar
</a> 
 # Committing entry 0 fails.
 !commit 0@0
 ---
 Error: assertion failed: commit index 0 does not exist
 
<a href="#h4-0-18" id="h4-0-18" class="d">-# Committing entry 1 works, and updates the commit index. Dump the
</a><a href="#h4-0-19" id="h4-0-19" class="d">-# raw value too.
</a><a href="#h4-0-20" id="h4-0-20" class="d">-commit 1@1
</a><a href="#h4-0-21" id="h4-0-21" class="i">+# Committing entry 1 works, and updates the commit index.
</a><a href="#h4-0-22" id="h4-0-22" class="i">+#
</a><a href="#h4-0-23" id="h4-0-23" class="i">+# Show the engine operations too, and notice that the commit index isn&#39;t flushed
</a><a href="#h4-0-24" id="h4-0-24" class="i">+# to durable storage (it can be recovered from the durable quorum logs).
</a><a href="#h4-0-25" id="h4-0-25" class="i">+commit 1@1 oplog=true
</a> status
<a href="#h4-0-27" id="h4-0-27" class="d">-raw
</a> ---
<a href="#h4-0-29" id="h4-0-29" class="i">+set CommitIndex 0x02 = 0x0101
</a> commit → 1@1 None
 last=3@2 commit=1@1
<a href="#h4-0-32" id="h4-0-32" class="i">+
</a><a href="#h4-0-33" id="h4-0-33" class="i">+# Dump the raw engine contents too.
</a><a href="#h4-0-34" id="h4-0-34" class="i">+raw
</a><a href="#h4-0-35" id="h4-0-35" class="i">+---
</a> Entry(1) 0x000000000000000001 = 0x0100
 Entry(2) 0x000000000000000002 = 0x010103666f6f
 Entry(3) 0x000000000000000003 = 0x020103626172
 CommitIndex 0x02 = 0x0101
 
<a href="#h4-0-41" id="h4-0-41" class="d">-# Commits are idempotent.
</a><a href="#h4-0-42" id="h4-0-42" class="d">-commit 1@1
</a><a href="#h4-0-43" id="h4-0-43" class="i">+# Commits are idempotent, which doesn&#39;t incur an engine set.
</a><a href="#h4-0-44" id="h4-0-44" class="i">+commit 1@1 oplog=true
</a> status
 ---
 commit → 1@1 None
<b>diff --git a/<a id="h5" href="../file/src/raft/testscripts/log/splice.html">src/raft/testscripts/log/splice</a> b/<a href="../file/src/raft/testscripts/log/splice.html">src/raft/testscripts/log/splice</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -8,21 +8,23 @@ Error: assertion failed: spliced entry has index or term 0
</a> ---
 Error: assertion failed: first index 2 must touch existing log
 
<a href="#h5-0-3" id="h5-0-3" class="d">-# Splicing entries at start should work, both with and without
</a><a href="#h5-0-4" id="h5-0-4" class="d">-# commands, and starting at a term after 1. It should also update
</a><a href="#h5-0-5" id="h5-0-5" class="d">-# the state.
</a><a href="#h5-0-6" id="h5-0-6" class="d">-# TODO: test that this flushes.
</a><a href="#h5-0-7" id="h5-0-7" class="d">-splice 1@2= 2@2=command
</a><a href="#h5-0-8" id="h5-0-8" class="i">+# Splicing entries at start should work, both with and without commands, and
</a><a href="#h5-0-9" id="h5-0-9" class="i">+# starting at a term after 1. They should be written to the engine and flushed
</a><a href="#h5-0-10" id="h5-0-10" class="i">+# to durable storage. It should also update the state.
</a><a href="#h5-0-11" id="h5-0-11" class="i">+splice 1@2= 2@2=command oplog=true
</a> status
 scan
 ---
<a href="#h5-0-15" id="h5-0-15" class="i">+set Entry(1) 0x000000000000000001 = 0x0200
</a><a href="#h5-0-16" id="h5-0-16" class="i">+set Entry(2) 0x000000000000000002 = 0x020107636f6d6d616e64
</a><a href="#h5-0-17" id="h5-0-17" class="i">+flush
</a> splice → 2@2 command
 last=2@2 commit=0@0
 1@2 None
 2@2 command
 
 # Splicing an empty list should work and be a noop.
<a href="#h5-0-24" id="h5-0-24" class="d">-splice
</a><a href="#h5-0-25" id="h5-0-25" class="i">+splice oplog=true
</a> status
 scan
 ---
<a href="#h5-1" id="h5-1" class="h">@@ -57,7 +59,7 @@ Error: assertion failed: first index 4 must touch existing log
</a> Error: assertion failed: splice term regression 2 → 1
 
 # Fully overlapping entries is a noop.
<a href="#h5-1-3" id="h5-1-3" class="d">-splice 1@2= 2@2=command
</a><a href="#h5-1-4" id="h5-1-4" class="i">+splice 1@2= 2@2=command oplog=true
</a> scan
 ---
 splice → 2@2 command
<a href="#h5-2" id="h5-2" class="h">@@ -65,7 +67,7 @@ splice → 2@2 command
</a> 2@2 command
 
 # An overlapping prefix is a noop.
<a href="#h5-2-3" id="h5-2-3" class="d">-splice 1@2=
</a><a href="#h5-2-4" id="h5-2-4" class="i">+splice 1@2= oplog=true
</a> scan
 ---
 splice → 2@2 command
<a href="#h5-3" id="h5-3" class="h">@@ -73,7 +75,7 @@ splice → 2@2 command
</a> 2@2 command
 
 # An overlapping suffix is a noop.
<a href="#h5-3-3" id="h5-3-3" class="d">-splice 2@2=command
</a><a href="#h5-3-4" id="h5-3-4" class="i">+splice 2@2=command oplog=true
</a> scan
 ---
 splice → 2@2 command
<a href="#h5-4" id="h5-4" class="h">@@ -101,33 +103,47 @@ splice → 4@3 None
</a> 3@2 bar
 4@3 None
 
<a href="#h5-4-3" id="h5-4-3" class="d">-# Splicing with suffix overlap should work.
</a><a href="#h5-4-4" id="h5-4-4" class="d">-splice 3@2=bar 4@3= 5@3=foo
</a><a href="#h5-4-5" id="h5-4-5" class="i">+# Splicing with suffix overlap should work, and only write the new entries.
</a><a href="#h5-4-6" id="h5-4-6" class="i">+splice 3@2=bar 4@3= 5@3=foo 6@3=bar oplog=true
</a> scan
 ---
<a href="#h5-4-9" id="h5-4-9" class="d">-splice → 5@3 foo
</a><a href="#h5-4-10" id="h5-4-10" class="i">+set Entry(5) 0x000000000000000005 = 0x030103666f6f
</a><a href="#h5-4-11" id="h5-4-11" class="i">+set Entry(6) 0x000000000000000006 = 0x030103626172
</a><a href="#h5-4-12" id="h5-4-12" class="i">+flush
</a><a href="#h5-4-13" id="h5-4-13" class="i">+splice → 6@3 bar
</a> 1@2 None
 2@2 command
 3@2 bar
 4@3 None
 5@3 foo
<a href="#h5-4-19" id="h5-4-19" class="i">+6@3 bar
</a> 
 # Splicing at an existing index with a new term should replace the tail.
<a href="#h5-4-22" id="h5-4-22" class="d">-splice 3@4=
</a><a href="#h5-4-23" id="h5-4-23" class="i">+splice 4@4= oplog=true
</a> status
 scan
 ---
<a href="#h5-4-27" id="h5-4-27" class="d">-splice → 3@4 None
</a><a href="#h5-4-28" id="h5-4-28" class="d">-last=3@4 commit=0@0
</a><a href="#h5-4-29" id="h5-4-29" class="i">+set Entry(4) 0x000000000000000004 = 0x0400
</a><a href="#h5-4-30" id="h5-4-30" class="i">+delete Entry(5) 0x000000000000000005
</a><a href="#h5-4-31" id="h5-4-31" class="i">+delete Entry(6) 0x000000000000000006
</a><a href="#h5-4-32" id="h5-4-32" class="i">+flush
</a><a href="#h5-4-33" id="h5-4-33" class="i">+splice → 4@4 None
</a><a href="#h5-4-34" id="h5-4-34" class="i">+last=4@4 commit=0@0
</a> 1@2 None
 2@2 command
<a href="#h5-4-37" id="h5-4-37" class="d">-3@4 None
</a><a href="#h5-4-38" id="h5-4-38" class="i">+3@2 bar
</a><a href="#h5-4-39" id="h5-4-39" class="i">+4@4 None
</a> 
 # This also holds at the start of the log.
<a href="#h5-4-42" id="h5-4-42" class="d">-splice 1@5= 2@5=foo 3@5=bar
</a><a href="#h5-4-43" id="h5-4-43" class="i">+splice 1@5= 2@5=foo 3@5=bar oplog=true
</a> status
 scan
 ---
<a href="#h5-4-47" id="h5-4-47" class="i">+set Entry(1) 0x000000000000000001 = 0x0500
</a><a href="#h5-4-48" id="h5-4-48" class="i">+set Entry(2) 0x000000000000000002 = 0x050103666f6f
</a><a href="#h5-4-49" id="h5-4-49" class="i">+set Entry(3) 0x000000000000000003 = 0x050103626172
</a><a href="#h5-4-50" id="h5-4-50" class="i">+delete Entry(4) 0x000000000000000004
</a><a href="#h5-4-51" id="h5-4-51" class="i">+flush
</a> splice → 3@5 bar
 last=3@5 commit=0@0
 1@5 None
<b>diff --git a/<a id="h6" href="../file/src/raft/testscripts/log/term.html">src/raft/testscripts/log/term</a> b/<a href="../file/src/raft/testscripts/log/term.html">src/raft/testscripts/log/term</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -8,24 +8,25 @@ term=0 vote=None
</a> ---
 Error: assertion failed: can&#39;t set term 0
 
<a href="#h6-0-3" id="h6-0-3" class="d">-# set_term stores a term and empty vote.
</a><a href="#h6-0-4" id="h6-0-4" class="d">-set_term 3
</a><a href="#h6-0-5" id="h6-0-5" class="i">+# set_term stores a term and empty vote, writing it to the engine
</a><a href="#h6-0-6" id="h6-0-6" class="i">+# and flushing it to durable storage.
</a><a href="#h6-0-7" id="h6-0-7" class="i">+set_term 3 oplog=true
</a> get_term
<a href="#h6-0-9" id="h6-0-9" class="d">-raw
</a> ---
<a href="#h6-0-11" id="h6-0-11" class="i">+set TermVote 0x01 = 0x0300
</a><a href="#h6-0-12" id="h6-0-12" class="i">+flush
</a> term=3 vote=None
<a href="#h6-0-14" id="h6-0-14" class="d">-TermVote 0x01 = 0x0300
</a> 
 # set_term stores a term and vote.
<a href="#h6-0-17" id="h6-0-17" class="d">-set_term 3 7
</a><a href="#h6-0-18" id="h6-0-18" class="i">+set_term 3 7 oplog=true
</a> get_term
<a href="#h6-0-20" id="h6-0-20" class="d">-raw
</a> ---
<a href="#h6-0-22" id="h6-0-22" class="i">+set TermVote 0x01 = 0x030107
</a><a href="#h6-0-23" id="h6-0-23" class="i">+flush
</a> term=3 vote=7
<a href="#h6-0-25" id="h6-0-25" class="d">-TermVote 0x01 = 0x030107
</a> 
<a href="#h6-0-27" id="h6-0-27" class="d">-# set_term is idempotent.
</a><a href="#h6-0-28" id="h6-0-28" class="d">-set_term 3 7
</a><a href="#h6-0-29" id="h6-0-29" class="i">+# set_term is idempotent, which doesn&#39;t incur an engine write.
</a><a href="#h6-0-30" id="h6-0-30" class="i">+set_term 3 7 oplog=true
</a> get_term
 ---
 term=3 vote=7
</pre>
</div>
</body>
</html>
