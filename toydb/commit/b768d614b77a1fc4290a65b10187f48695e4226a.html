<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Avoid eager `ok_or()` arguments - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/b768d614b77a1fc4290a65b10187f48695e4226a.html">b768d614b77a1fc4290a65b10187f48695e4226a</a>
<b>parent</b> <a href="../commit/2bafbd817bba30e4e8fbd91f420fa3a679526398.html">2bafbd817bba30e4e8fbd91f420fa3a679526398</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sat, 20 Jul 2024 11:27:41 +0200

Avoid eager `ok_or()` arguments

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/bin/toysql.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/sql/engine/engine.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">src/sql/types/value.rs</a></td><td> | </td><td class="num">28</td><td><span class="i">+++++++++++++++++</span><span class="d">-----------</span></td></tr>
</table></pre><pre>3 files changed, 22 insertions(+), 14 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -11,7 +11,7 @@ use rustyline::validate::{ValidationContext, ValidationResult, Validator};
</a> use rustyline::{error::ReadlineError, Editor, Modifiers};
 use rustyline_derive::{Completer, Helper, Highlighter, Hinter};
 use toydb::errinput;
<a href="#h0-0-3" id="h0-0-3" class="d">-use toydb::error::{Error, Result};
</a><a href="#h0-0-4" id="h0-0-4" class="i">+use toydb::error::Result;
</a> use toydb::sql::engine::StatementResult;
 use toydb::sql::parser::{Lexer, Token};
 use toydb::Client;
<a href="#h0-1" id="h0-1" class="h">@@ -80,7 +80,9 @@ impl ToySQL {
</a>     /// Handles a REPL command (prefixed by !, e.g. !help)
     fn execute_command(&amp;mut self, input: &amp;str) -&gt; Result&lt;()&gt; {
         let mut input = input.split_ascii_whitespace();
<a href="#h0-1-3" id="h0-1-3" class="d">-        let command = input.next().ok_or::&lt;Error&gt;(errinput!(&quot;expected command&quot;))?;
</a><a href="#h0-1-4" id="h0-1-4" class="i">+        let Some(command) = input.next() else {
</a><a href="#h0-1-5" id="h0-1-5" class="i">+            return errinput!(&quot;expected command&quot;);
</a><a href="#h0-1-6" id="h0-1-6" class="i">+        };
</a> 
         let getargs = |n| {
             let args: Vec&lt;&amp;str&gt; = input.collect();
<b>diff --git a/<a id="h1" href="../file/src/sql/engine/engine.rs.html">src/sql/engine/engine.rs</a> b/<a href="../file/src/sql/engine/engine.rs.html">src/sql/engine/engine.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -85,6 +85,6 @@ pub trait Catalog {
</a> 
     /// Fetches a table schema, or errors if it does not exist.
     fn must_get_table(&amp;self, table: &amp;str) -&gt; Result&lt;Table&gt; {
<a href="#h1-0-3" id="h1-0-3" class="d">-        self.get_table(table)?.ok_or(errinput!(&quot;table {table} does not exist&quot;))
</a><a href="#h1-0-4" id="h1-0-4" class="i">+        self.get_table(table)?.ok_or_else(|| errinput!(&quot;table {table} does not exist&quot;))
</a>     }
 }
<b>diff --git a/<a id="h2" href="../file/src/sql/types/value.rs.html">src/sql/types/value.rs</a> b/<a href="../file/src/sql/types/value.rs.html">src/sql/types/value.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -130,9 +130,10 @@ impl Value {
</a>     pub fn checked_add(&amp;self, other: &amp;Self) -&gt; Result&lt;Self&gt; {
         use Value::*;
         Ok(match (self, other) {
<a href="#h2-0-3" id="h2-0-3" class="d">-            (Integer(lhs), Integer(rhs)) =&gt; {
</a><a href="#h2-0-4" id="h2-0-4" class="d">-                Integer(lhs.checked_add(*rhs).ok_or::&lt;Error&gt;(errinput!(&quot;integer overflow&quot;))?)
</a><a href="#h2-0-5" id="h2-0-5" class="d">-            }
</a><a href="#h2-0-6" id="h2-0-6" class="i">+            (Integer(lhs), Integer(rhs)) =&gt; match lhs.checked_add(*rhs) {
</a><a href="#h2-0-7" id="h2-0-7" class="i">+                Some(i) =&gt; Integer(i),
</a><a href="#h2-0-8" id="h2-0-8" class="i">+                None =&gt; return errinput!(&quot;integer overflow&quot;),
</a><a href="#h2-0-9" id="h2-0-9" class="i">+            },
</a>             (Integer(lhs), Float(rhs)) =&gt; Float(*lhs as f64 + rhs),
             (Float(lhs), Integer(rhs)) =&gt; Float(lhs + *rhs as f64),
             (Float(lhs), Float(rhs)) =&gt; Float(lhs + rhs),
<a href="#h2-1" id="h2-1" class="h">@@ -162,8 +163,11 @@ impl Value {
</a>         use Value::*;
         Ok(match (self, other) {
             (Integer(lhs), Integer(rhs)) if *rhs &gt;= 0 =&gt; {
<a href="#h2-1-3" id="h2-1-3" class="d">-                let rhs: u32 = (*rhs).try_into().or(errinput!(&quot;integer overflow&quot;))?;
</a><a href="#h2-1-4" id="h2-1-4" class="d">-                Integer(lhs.checked_pow(rhs).ok_or::&lt;Error&gt;(errinput!(&quot;integer overflow&quot;))?)
</a><a href="#h2-1-5" id="h2-1-5" class="i">+                let rhs = (*rhs).try_into().or_else(|_| errinput!(&quot;integer overflow&quot;))?;
</a><a href="#h2-1-6" id="h2-1-6" class="i">+                match lhs.checked_pow(rhs) {
</a><a href="#h2-1-7" id="h2-1-7" class="i">+                    Some(i) =&gt; Integer(i),
</a><a href="#h2-1-8" id="h2-1-8" class="i">+                    None =&gt; return errinput!(&quot;integer overflow&quot;),
</a><a href="#h2-1-9" id="h2-1-9" class="i">+                }
</a>             }
             (Integer(lhs), Integer(rhs)) =&gt; Float((*lhs as f64).powf(*rhs as f64)),
             (Integer(lhs), Float(rhs)) =&gt; Float((*lhs as f64).powf(*rhs)),
<a href="#h2-2" id="h2-2" class="h">@@ -179,9 +183,10 @@ impl Value {
</a>     pub fn checked_mul(&amp;self, other: &amp;Self) -&gt; Result&lt;Self&gt; {
         use Value::*;
         Ok(match (self, other) {
<a href="#h2-2-3" id="h2-2-3" class="d">-            (Integer(lhs), Integer(rhs)) =&gt; {
</a><a href="#h2-2-4" id="h2-2-4" class="d">-                Integer(lhs.checked_mul(*rhs).ok_or::&lt;Error&gt;(errinput!(&quot;integer overflow&quot;))?)
</a><a href="#h2-2-5" id="h2-2-5" class="d">-            }
</a><a href="#h2-2-6" id="h2-2-6" class="i">+            (Integer(lhs), Integer(rhs)) =&gt; match lhs.checked_mul(*rhs) {
</a><a href="#h2-2-7" id="h2-2-7" class="i">+                Some(i) =&gt; Integer(i),
</a><a href="#h2-2-8" id="h2-2-8" class="i">+                None =&gt; return errinput!(&quot;integer overflow&quot;),
</a><a href="#h2-2-9" id="h2-2-9" class="i">+            },
</a>             (Integer(lhs), Float(rhs)) =&gt; Float(*lhs as f64 * rhs),
             (Float(lhs), Integer(rhs)) =&gt; Float(lhs * *rhs as f64),
             (Float(lhs), Float(rhs)) =&gt; Float(lhs * rhs),
<a href="#h2-3" id="h2-3" class="h">@@ -214,9 +219,10 @@ impl Value {
</a>     pub fn checked_sub(&amp;self, other: &amp;Self) -&gt; Result&lt;Self&gt; {
         use Value::*;
         Ok(match (self, other) {
<a href="#h2-3-3" id="h2-3-3" class="d">-            (Integer(lhs), Integer(rhs)) =&gt; {
</a><a href="#h2-3-4" id="h2-3-4" class="d">-                Integer(lhs.checked_sub(*rhs).ok_or::&lt;Error&gt;(errinput!(&quot;integer overflow&quot;))?)
</a><a href="#h2-3-5" id="h2-3-5" class="d">-            }
</a><a href="#h2-3-6" id="h2-3-6" class="i">+            (Integer(lhs), Integer(rhs)) =&gt; match lhs.checked_sub(*rhs) {
</a><a href="#h2-3-7" id="h2-3-7" class="i">+                Some(i) =&gt; Integer(i),
</a><a href="#h2-3-8" id="h2-3-8" class="i">+                None =&gt; return errinput!(&quot;integer overflow&quot;),
</a><a href="#h2-3-9" id="h2-3-9" class="i">+            },
</a>             (Integer(lhs), Float(rhs)) =&gt; Float(*lhs as f64 - rhs),
             (Float(lhs), Integer(rhs)) =&gt; Float(lhs - *rhs as f64),
             (Float(lhs), Float(rhs)) =&gt; Float(lhs - rhs),
</pre>
</div>
</body>
</html>
