<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rewrite Raft network server with Tokio (fixes #25) - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/2cc693821ce1c15b0b5c88d3ddd3e881a7b747c7.html">2cc693821ce1c15b0b5c88d3ddd3e881a7b747c7</a>
<b>parent</b> <a href="../commit/1399c4f9a56f4ffb8713f8838d8f4e6c03803b8f.html">1399c4f9a56f4ffb8713f8838d8f4e6c03803b8f</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Sun, 26 Apr 2020 16:47:30 +0200

Rewrite Raft network server with Tokio (fixes #25)

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Cargo.lock</a></td><td> | </td><td class="num">575</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Cargo.toml</a></td><td> | </td><td class="num">13</td><td><span class="i">+</span><span class="d">------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h2">build.rs</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">clusters/local/run.sh</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="D">D</td><td><a href="#h4">protobuf/raft.proto</a></td><td> | </td><td class="num">18</td><td><span class="i"></span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">src/bin/toydb.rs</a></td><td> | </td><td class="num">35</td><td><span class="i">++++++++</span><span class="d">---------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">src/bin/toysql.rs</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">src/client.rs</a></td><td> | </td><td class="num">5</td><td><span class="i">+++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">src/error.rs</a></td><td> | </td><td class="num">42</td><td><span class="i">++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">src/lib.rs</a></td><td> | </td><td class="num">6</td><td><span class="i">+</span><span class="d">-----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h10">src/raft/client.rs</a></td><td> | </td><td class="num">86</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">src/raft/log.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h12">src/raft/message.rs</a></td><td> | </td><td class="num">210</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">src/raft/mod.rs</a></td><td> | </td><td class="num">214</td><td><span class="i">+++++</span><span class="d">--------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">src/raft/node/candidate.rs</a></td><td> | </td><td class="num">54</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">src/raft/node/follower.rs</a></td><td> | </td><td class="num">125</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">src/raft/node/leader.rs</a></td><td> | </td><td class="num">100</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">src/raft/node/mod.rs</a></td><td> | </td><td class="num">140</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h18">src/raft/server.rs</a></td><td> | </td><td class="num">220</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">src/raft/state.rs</a></td><td> | </td><td class="num">59</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h20">src/raft/transport.rs</a></td><td> | </td><td class="num">220</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">src/server.rs</a></td><td> | </td><td class="num">191</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="D">D</td><td><a href="#h22">src/server/mod.rs</a></td><td> | </td><td class="num">70</td><td><span class="i"></span><span class="d">----------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h23">src/server/raft.rs</a></td><td> | </td><td class="num">101</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h24">src/server/toydb.rs</a></td><td> | </td><td class="num">148</td><td><span class="i"></span><span class="d">-------------------------------------------------------------------------------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h25">src/service/mod.rs</a></td><td> | </td><td class="num">14</td><td><span class="i"></span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">src/sql/engine/mod.rs</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h27">src/sql/engine/raft.rs</a></td><td> | </td><td class="num">78</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">--------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">tests/client/mod.rs</a></td><td> | </td><td class="num">104</td><td><span class="i">+++++++++++++++++++</span><span class="d">------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h29">tests/cluster/isolation.rs</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++</span><span class="d">----------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">tests/setup.rs</a></td><td> | </td><td class="num">168</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h31">tests/tests.rs</a></td><td> | </td><td class="num">27</td><td><span class="i">++++++++++++++++++++</span><span class="d">-------</span></td></tr>
<tr><td class="D">D</td><td><a href="#h32">tests/util.rs</a></td><td> | </td><td class="num">19</td><td><span class="i"></span><span class="d">-------------------</span></td></tr>
</table></pre><pre>33 files changed, 1290 insertions(+), 1820 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Cargo.lock.html">Cargo.lock</a> b/<a href="../file/Cargo.lock.html">Cargo.lock</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -48,15 +48,6 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> 
 [[package]]
 name = &quot;base64&quot;
<a href="#h0-0-3" id="h0-0-3" class="d">-version = &quot;0.9.3&quot;
</a><a href="#h0-0-4" id="h0-0-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-0-5" id="h0-0-5" class="d">-dependencies = [
</a><a href="#h0-0-6" id="h0-0-6" class="d">- &quot;byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-7" id="h0-0-7" class="d">- &quot;safemem 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-0-8" id="h0-0-8" class="d">-]
</a><a href="#h0-0-9" id="h0-0-9" class="d">-
</a><a href="#h0-0-10" id="h0-0-10" class="d">-[[package]]
</a><a href="#h0-0-11" id="h0-0-11" class="d">-name = &quot;base64&quot;
</a> version = &quot;0.11.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
<a href="#h0-1" id="h0-1" class="h">@@ -91,15 +82,6 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> 
 [[package]]
 name = &quot;bytes&quot;
<a href="#h0-1-3" id="h0-1-3" class="d">-version = &quot;0.4.12&quot;
</a><a href="#h0-1-4" id="h0-1-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-1-5" id="h0-1-5" class="d">-dependencies = [
</a><a href="#h0-1-6" id="h0-1-6" class="d">- &quot;byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-1-7" id="h0-1-7" class="d">- &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-1-8" id="h0-1-8" class="d">-]
</a><a href="#h0-1-9" id="h0-1-9" class="d">-
</a><a href="#h0-1-10" id="h0-1-10" class="d">-[[package]]
</a><a href="#h0-1-11" id="h0-1-11" class="d">-name = &quot;bytes&quot;
</a> version = &quot;0.5.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
<a href="#h0-2" id="h0-2" class="h">@@ -166,61 +148,6 @@ version = &quot;0.1.5&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-2-3" id="h0-2-3" class="d">-name = &quot;crossbeam&quot;
</a><a href="#h0-2-4" id="h0-2-4" class="d">-version = &quot;0.7.3&quot;
</a><a href="#h0-2-5" id="h0-2-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-6" id="h0-2-6" class="d">-dependencies = [
</a><a href="#h0-2-7" id="h0-2-7" class="d">- &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-8" id="h0-2-8" class="d">- &quot;crossbeam-channel 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="d">- &quot;crossbeam-deque 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-10" id="h0-2-10" class="d">- &quot;crossbeam-epoch 0.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-11" id="h0-2-11" class="d">- &quot;crossbeam-queue 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-12" id="h0-2-12" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-13" id="h0-2-13" class="d">-]
</a><a href="#h0-2-14" id="h0-2-14" class="d">-
</a><a href="#h0-2-15" id="h0-2-15" class="d">-[[package]]
</a><a href="#h0-2-16" id="h0-2-16" class="d">-name = &quot;crossbeam-channel&quot;
</a><a href="#h0-2-17" id="h0-2-17" class="d">-version = &quot;0.4.2&quot;
</a><a href="#h0-2-18" id="h0-2-18" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-19" id="h0-2-19" class="d">-dependencies = [
</a><a href="#h0-2-20" id="h0-2-20" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-21" id="h0-2-21" class="d">- &quot;maybe-uninit 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-22" id="h0-2-22" class="d">-]
</a><a href="#h0-2-23" id="h0-2-23" class="d">-
</a><a href="#h0-2-24" id="h0-2-24" class="d">-[[package]]
</a><a href="#h0-2-25" id="h0-2-25" class="d">-name = &quot;crossbeam-deque&quot;
</a><a href="#h0-2-26" id="h0-2-26" class="d">-version = &quot;0.7.3&quot;
</a><a href="#h0-2-27" id="h0-2-27" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-28" id="h0-2-28" class="d">-dependencies = [
</a><a href="#h0-2-29" id="h0-2-29" class="d">- &quot;crossbeam-epoch 0.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-30" id="h0-2-30" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-31" id="h0-2-31" class="d">- &quot;maybe-uninit 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-32" id="h0-2-32" class="d">-]
</a><a href="#h0-2-33" id="h0-2-33" class="d">-
</a><a href="#h0-2-34" id="h0-2-34" class="d">-[[package]]
</a><a href="#h0-2-35" id="h0-2-35" class="d">-name = &quot;crossbeam-epoch&quot;
</a><a href="#h0-2-36" id="h0-2-36" class="d">-version = &quot;0.8.2&quot;
</a><a href="#h0-2-37" id="h0-2-37" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-38" id="h0-2-38" class="d">-dependencies = [
</a><a href="#h0-2-39" id="h0-2-39" class="d">- &quot;autocfg 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-40" id="h0-2-40" class="d">- &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-41" id="h0-2-41" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-42" id="h0-2-42" class="d">- &quot;lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-43" id="h0-2-43" class="d">- &quot;maybe-uninit 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-44" id="h0-2-44" class="d">- &quot;memoffset 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-45" id="h0-2-45" class="d">- &quot;scopeguard 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-46" id="h0-2-46" class="d">-]
</a><a href="#h0-2-47" id="h0-2-47" class="d">-
</a><a href="#h0-2-48" id="h0-2-48" class="d">-[[package]]
</a><a href="#h0-2-49" id="h0-2-49" class="d">-name = &quot;crossbeam-queue&quot;
</a><a href="#h0-2-50" id="h0-2-50" class="d">-version = &quot;0.2.1&quot;
</a><a href="#h0-2-51" id="h0-2-51" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-2-52" id="h0-2-52" class="d">-dependencies = [
</a><a href="#h0-2-53" id="h0-2-53" class="d">- &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-54" id="h0-2-54" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-2-55" id="h0-2-55" class="d">-]
</a><a href="#h0-2-56" id="h0-2-56" class="d">-
</a><a href="#h0-2-57" id="h0-2-57" class="d">-[[package]]
</a> name = &quot;crossbeam-utils&quot;
 version = &quot;0.7.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-3" id="h0-3" class="h">@@ -300,11 +227,6 @@ source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a> 
 [[package]]
 name = &quot;futures&quot;
<a href="#h0-3-3" id="h0-3-3" class="d">-version = &quot;0.1.29&quot;
</a><a href="#h0-3-4" id="h0-3-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-3-5" id="h0-3-5" class="d">-
</a><a href="#h0-3-6" id="h0-3-6" class="d">-[[package]]
</a><a href="#h0-3-7" id="h0-3-7" class="d">-name = &quot;futures&quot;
</a> version = &quot;0.3.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h0-4" id="h0-4" class="h">@@ -332,15 +254,6 @@ version = &quot;0.3.4&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-4-3" id="h0-4-3" class="d">-name = &quot;futures-cpupool&quot;
</a><a href="#h0-4-4" id="h0-4-4" class="d">-version = &quot;0.1.8&quot;
</a><a href="#h0-4-5" id="h0-4-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-4-6" id="h0-4-6" class="d">-dependencies = [
</a><a href="#h0-4-7" id="h0-4-7" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-4-8" id="h0-4-8" class="d">- &quot;num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-4-9" id="h0-4-9" class="d">-]
</a><a href="#h0-4-10" id="h0-4-10" class="d">-
</a><a href="#h0-4-11" id="h0-4-11" class="d">-[[package]]
</a> name = &quot;futures-executor&quot;
 version = &quot;0.3.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-5" id="h0-5" class="h">@@ -414,34 +327,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-5-3" id="h0-5-3" class="d">-name = &quot;grpc&quot;
</a><a href="#h0-5-4" id="h0-5-4" class="d">-version = &quot;0.6.2&quot;
</a><a href="#h0-5-5" id="h0-5-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-6" id="h0-5-6" class="d">-dependencies = [
</a><a href="#h0-5-7" id="h0-5-7" class="d">- &quot;base64 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-8" id="h0-5-8" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-9" id="h0-5-9" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-10" id="h0-5-10" class="d">- &quot;futures-cpupool 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-11" id="h0-5-11" class="d">- &quot;httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-12" id="h0-5-12" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-13" id="h0-5-13" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-14" id="h0-5-14" class="d">- &quot;tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-15" id="h0-5-15" class="d">- &quot;tls-api-stub 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-16" id="h0-5-16" class="d">- &quot;tokio-core 0.1.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-17" id="h0-5-17" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-18" id="h0-5-18" class="d">- &quot;tokio-tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-19" id="h0-5-19" class="d">-]
</a><a href="#h0-5-20" id="h0-5-20" class="d">-
</a><a href="#h0-5-21" id="h0-5-21" class="d">-[[package]]
</a><a href="#h0-5-22" id="h0-5-22" class="d">-name = &quot;grpc-compiler&quot;
</a><a href="#h0-5-23" id="h0-5-23" class="d">-version = &quot;0.6.2&quot;
</a><a href="#h0-5-24" id="h0-5-24" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-5-25" id="h0-5-25" class="d">-dependencies = [
</a><a href="#h0-5-26" id="h0-5-26" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-27" id="h0-5-27" class="d">- &quot;protobuf-codegen 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-5-28" id="h0-5-28" class="d">-]
</a><a href="#h0-5-29" id="h0-5-29" class="d">-
</a><a href="#h0-5-30" id="h0-5-30" class="d">-[[package]]
</a> name = &quot;half&quot;
 version = &quot;1.5.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-6" id="h0-6" class="h">@@ -455,27 +340,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-6-3" id="h0-6-3" class="d">-name = &quot;httpbis&quot;
</a><a href="#h0-6-4" id="h0-6-4" class="d">-version = &quot;0.7.0&quot;
</a><a href="#h0-6-5" id="h0-6-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-6-6" id="h0-6-6" class="d">-dependencies = [
</a><a href="#h0-6-7" id="h0-6-7" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-8" id="h0-6-8" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-9" id="h0-6-9" class="d">- &quot;futures-cpupool 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-10" id="h0-6-10" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-11" id="h0-6-11" class="d">- &quot;net2 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-12" id="h0-6-12" class="d">- &quot;tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-13" id="h0-6-13" class="d">- &quot;tls-api-stub 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-14" id="h0-6-14" class="d">- &quot;tokio-core 0.1.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-15" id="h0-6-15" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-16" id="h0-6-16" class="d">- &quot;tokio-timer 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-17" id="h0-6-17" class="d">- &quot;tokio-tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-18" id="h0-6-18" class="d">- &quot;tokio-uds 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-19" id="h0-6-19" class="d">- &quot;unix_socket 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-20" id="h0-6-20" class="d">- &quot;void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-6-21" id="h0-6-21" class="d">-]
</a><a href="#h0-6-22" id="h0-6-22" class="d">-
</a><a href="#h0-6-23" id="h0-6-23" class="d">-[[package]]
</a> name = &quot;iovec&quot;
 version = &quot;0.1.4&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-7" id="h0-7" class="h">@@ -536,14 +400,6 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;log&quot;
<a href="#h0-7-3" id="h0-7-3" class="d">-version = &quot;0.3.9&quot;
</a><a href="#h0-7-4" id="h0-7-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-7-5" id="h0-7-5" class="d">-dependencies = [
</a><a href="#h0-7-6" id="h0-7-6" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-7-7" id="h0-7-7" class="d">-]
</a><a href="#h0-7-8" id="h0-7-8" class="d">-
</a><a href="#h0-7-9" id="h0-7-9" class="d">-[[package]]
</a><a href="#h0-7-10" id="h0-7-10" class="d">-name = &quot;log&quot;
</a> version = &quot;0.4.8&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h0-8" id="h0-8" class="h">@@ -551,24 +407,11 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-8-3" id="h0-8-3" class="d">-name = &quot;maybe-uninit&quot;
</a><a href="#h0-8-4" id="h0-8-4" class="d">-version = &quot;2.0.0&quot;
</a><a href="#h0-8-5" id="h0-8-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-8-6" id="h0-8-6" class="d">-
</a><a href="#h0-8-7" id="h0-8-7" class="d">-[[package]]
</a> name = &quot;memchr&quot;
 version = &quot;2.3.3&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-8-13" id="h0-8-13" class="d">-name = &quot;memoffset&quot;
</a><a href="#h0-8-14" id="h0-8-14" class="d">-version = &quot;0.5.4&quot;
</a><a href="#h0-8-15" id="h0-8-15" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-8-16" id="h0-8-16" class="d">-dependencies = [
</a><a href="#h0-8-17" id="h0-8-17" class="d">- &quot;autocfg 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-8-18" id="h0-8-18" class="d">-]
</a><a href="#h0-8-19" id="h0-8-19" class="d">-
</a><a href="#h0-8-20" id="h0-8-20" class="d">-[[package]]
</a> name = &quot;mio&quot;
 version = &quot;0.6.21&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-9" id="h0-9" class="h">@@ -690,16 +533,6 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;parking_lot&quot;
<a href="#h0-9-3" id="h0-9-3" class="d">-version = &quot;0.9.0&quot;
</a><a href="#h0-9-4" id="h0-9-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-9-5" id="h0-9-5" class="d">-dependencies = [
</a><a href="#h0-9-6" id="h0-9-6" class="d">- &quot;lock_api 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-7" id="h0-9-7" class="d">- &quot;parking_lot_core 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-8" id="h0-9-8" class="d">- &quot;rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-9-9" id="h0-9-9" class="d">-]
</a><a href="#h0-9-10" id="h0-9-10" class="d">-
</a><a href="#h0-9-11" id="h0-9-11" class="d">-[[package]]
</a><a href="#h0-9-12" id="h0-9-12" class="d">-name = &quot;parking_lot&quot;
</a> version = &quot;0.10.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h0-10" id="h0-10" class="h">@@ -709,20 +542,6 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;parking_lot_core&quot;
<a href="#h0-10-3" id="h0-10-3" class="d">-version = &quot;0.6.2&quot;
</a><a href="#h0-10-4" id="h0-10-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-10-5" id="h0-10-5" class="d">-dependencies = [
</a><a href="#h0-10-6" id="h0-10-6" class="d">- &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-7" id="h0-10-7" class="d">- &quot;cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-8" id="h0-10-8" class="d">- &quot;libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-9" id="h0-10-9" class="d">- &quot;redox_syscall 0.1.56 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-10" id="h0-10-10" class="d">- &quot;rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-11" id="h0-10-11" class="d">- &quot;smallvec 0.6.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-12" id="h0-10-12" class="d">- &quot;winapi 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-10-13" id="h0-10-13" class="d">-]
</a><a href="#h0-10-14" id="h0-10-14" class="d">-
</a><a href="#h0-10-15" id="h0-10-15" class="d">-[[package]]
</a><a href="#h0-10-16" id="h0-10-16" class="d">-name = &quot;parking_lot_core&quot;
</a> version = &quot;0.7.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 dependencies = [
<a href="#h0-11" id="h0-11" class="h">@@ -797,53 +616,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-11-3" id="h0-11-3" class="d">-name = &quot;protobuf&quot;
</a><a href="#h0-11-4" id="h0-11-4" class="d">-version = &quot;2.8.2&quot;
</a><a href="#h0-11-5" id="h0-11-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-6" id="h0-11-6" class="d">-dependencies = [
</a><a href="#h0-11-7" id="h0-11-7" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-8" id="h0-11-8" class="d">-]
</a><a href="#h0-11-9" id="h0-11-9" class="d">-
</a><a href="#h0-11-10" id="h0-11-10" class="d">-[[package]]
</a><a href="#h0-11-11" id="h0-11-11" class="d">-name = &quot;protobuf-codegen&quot;
</a><a href="#h0-11-12" id="h0-11-12" class="d">-version = &quot;2.8.2&quot;
</a><a href="#h0-11-13" id="h0-11-13" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-14" id="h0-11-14" class="d">-dependencies = [
</a><a href="#h0-11-15" id="h0-11-15" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-16" id="h0-11-16" class="d">-]
</a><a href="#h0-11-17" id="h0-11-17" class="d">-
</a><a href="#h0-11-18" id="h0-11-18" class="d">-[[package]]
</a><a href="#h0-11-19" id="h0-11-19" class="d">-name = &quot;protoc&quot;
</a><a href="#h0-11-20" id="h0-11-20" class="d">-version = &quot;2.8.2&quot;
</a><a href="#h0-11-21" id="h0-11-21" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-22" id="h0-11-22" class="d">-dependencies = [
</a><a href="#h0-11-23" id="h0-11-23" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-24" id="h0-11-24" class="d">-]
</a><a href="#h0-11-25" id="h0-11-25" class="d">-
</a><a href="#h0-11-26" id="h0-11-26" class="d">-[[package]]
</a><a href="#h0-11-27" id="h0-11-27" class="d">-name = &quot;protoc-rust&quot;
</a><a href="#h0-11-28" id="h0-11-28" class="d">-version = &quot;2.8.2&quot;
</a><a href="#h0-11-29" id="h0-11-29" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-30" id="h0-11-30" class="d">-dependencies = [
</a><a href="#h0-11-31" id="h0-11-31" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-32" id="h0-11-32" class="d">- &quot;protobuf-codegen 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-33" id="h0-11-33" class="d">- &quot;protoc 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-34" id="h0-11-34" class="d">- &quot;tempfile 3.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-35" id="h0-11-35" class="d">-]
</a><a href="#h0-11-36" id="h0-11-36" class="d">-
</a><a href="#h0-11-37" id="h0-11-37" class="d">-[[package]]
</a><a href="#h0-11-38" id="h0-11-38" class="d">-name = &quot;protoc-rust-grpc&quot;
</a><a href="#h0-11-39" id="h0-11-39" class="d">-version = &quot;0.6.2&quot;
</a><a href="#h0-11-40" id="h0-11-40" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-11-41" id="h0-11-41" class="d">-dependencies = [
</a><a href="#h0-11-42" id="h0-11-42" class="d">- &quot;grpc-compiler 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-43" id="h0-11-43" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-44" id="h0-11-44" class="d">- &quot;protoc 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-45" id="h0-11-45" class="d">- &quot;protoc-rust 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-46" id="h0-11-46" class="d">- &quot;tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-11-47" id="h0-11-47" class="d">-]
</a><a href="#h0-11-48" id="h0-11-48" class="d">-
</a><a href="#h0-11-49" id="h0-11-49" class="d">-[[package]]
</a> name = &quot;quote&quot;
 version = &quot;1.0.3&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-12" id="h0-12" class="h">@@ -1005,14 +777,6 @@ version = &quot;0.13.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-12-3" id="h0-12-3" class="d">-name = &quot;rustc_version&quot;
</a><a href="#h0-12-4" id="h0-12-4" class="d">-version = &quot;0.2.3&quot;
</a><a href="#h0-12-5" id="h0-12-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-12-6" id="h0-12-6" class="d">-dependencies = [
</a><a href="#h0-12-7" id="h0-12-7" class="d">- &quot;semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-12-8" id="h0-12-8" class="d">-]
</a><a href="#h0-12-9" id="h0-12-9" class="d">-
</a><a href="#h0-12-10" id="h0-12-10" class="d">-[[package]]
</a> name = &quot;rustyline&quot;
 version = &quot;5.0.6&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-13" id="h0-13" class="h">@@ -1035,34 +799,11 @@ version = &quot;1.0.3&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-13-3" id="h0-13-3" class="d">-name = &quot;safemem&quot;
</a><a href="#h0-13-4" id="h0-13-4" class="d">-version = &quot;0.3.3&quot;
</a><a href="#h0-13-5" id="h0-13-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-13-6" id="h0-13-6" class="d">-
</a><a href="#h0-13-7" id="h0-13-7" class="d">-[[package]]
</a><a href="#h0-13-8" id="h0-13-8" class="d">-name = &quot;scoped-tls&quot;
</a><a href="#h0-13-9" id="h0-13-9" class="d">-version = &quot;0.1.2&quot;
</a><a href="#h0-13-10" id="h0-13-10" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-13-11" id="h0-13-11" class="d">-
</a><a href="#h0-13-12" id="h0-13-12" class="d">-[[package]]
</a> name = &quot;scopeguard&quot;
 version = &quot;1.1.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-13-18" id="h0-13-18" class="d">-name = &quot;semver&quot;
</a><a href="#h0-13-19" id="h0-13-19" class="d">-version = &quot;0.9.0&quot;
</a><a href="#h0-13-20" id="h0-13-20" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-13-21" id="h0-13-21" class="d">-dependencies = [
</a><a href="#h0-13-22" id="h0-13-22" class="d">- &quot;semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-13-23" id="h0-13-23" class="d">-]
</a><a href="#h0-13-24" id="h0-13-24" class="d">-
</a><a href="#h0-13-25" id="h0-13-25" class="d">-[[package]]
</a><a href="#h0-13-26" id="h0-13-26" class="d">-name = &quot;semver-parser&quot;
</a><a href="#h0-13-27" id="h0-13-27" class="d">-version = &quot;0.7.0&quot;
</a><a href="#h0-13-28" id="h0-13-28" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-13-29" id="h0-13-29" class="d">-
</a><a href="#h0-13-30" id="h0-13-30" class="d">-[[package]]
</a> name = &quot;serde&quot;
 version = &quot;0.8.23&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-14" id="h0-14" class="h">@@ -1153,24 +894,11 @@ dependencies = [
</a> 
 [[package]]
 name = &quot;slab&quot;
<a href="#h0-14-3" id="h0-14-3" class="d">-version = &quot;0.3.0&quot;
</a><a href="#h0-14-4" id="h0-14-4" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-14-5" id="h0-14-5" class="d">-
</a><a href="#h0-14-6" id="h0-14-6" class="d">-[[package]]
</a><a href="#h0-14-7" id="h0-14-7" class="d">-name = &quot;slab&quot;
</a> version = &quot;0.4.2&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
 name = &quot;smallvec&quot;
<a href="#h0-14-13" id="h0-14-13" class="d">-version = &quot;0.6.13&quot;
</a><a href="#h0-14-14" id="h0-14-14" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-14-15" id="h0-14-15" class="d">-dependencies = [
</a><a href="#h0-14-16" id="h0-14-16" class="d">- &quot;maybe-uninit 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-14-17" id="h0-14-17" class="d">-]
</a><a href="#h0-14-18" id="h0-14-18" class="d">-
</a><a href="#h0-14-19" id="h0-14-19" class="d">-[[package]]
</a><a href="#h0-14-20" id="h0-14-20" class="d">-name = &quot;smallvec&quot;
</a> version = &quot;1.3.0&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
<a href="#h0-15" id="h0-15" class="h">@@ -1247,46 +975,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-15-3" id="h0-15-3" class="d">-name = &quot;tls-api&quot;
</a><a href="#h0-15-4" id="h0-15-4" class="d">-version = &quot;0.1.22&quot;
</a><a href="#h0-15-5" id="h0-15-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-15-6" id="h0-15-6" class="d">-dependencies = [
</a><a href="#h0-15-7" id="h0-15-7" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-8" id="h0-15-8" class="d">-]
</a><a href="#h0-15-9" id="h0-15-9" class="d">-
</a><a href="#h0-15-10" id="h0-15-10" class="d">-[[package]]
</a><a href="#h0-15-11" id="h0-15-11" class="d">-name = &quot;tls-api-stub&quot;
</a><a href="#h0-15-12" id="h0-15-12" class="d">-version = &quot;0.1.22&quot;
</a><a href="#h0-15-13" id="h0-15-13" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-15-14" id="h0-15-14" class="d">-dependencies = [
</a><a href="#h0-15-15" id="h0-15-15" class="d">- &quot;tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-16" id="h0-15-16" class="d">- &quot;void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-17" id="h0-15-17" class="d">-]
</a><a href="#h0-15-18" id="h0-15-18" class="d">-
</a><a href="#h0-15-19" id="h0-15-19" class="d">-[[package]]
</a><a href="#h0-15-20" id="h0-15-20" class="d">-name = &quot;tokio&quot;
</a><a href="#h0-15-21" id="h0-15-21" class="d">-version = &quot;0.1.22&quot;
</a><a href="#h0-15-22" id="h0-15-22" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-15-23" id="h0-15-23" class="d">-dependencies = [
</a><a href="#h0-15-24" id="h0-15-24" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-25" id="h0-15-25" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-26" id="h0-15-26" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-27" id="h0-15-27" class="d">- &quot;num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-28" id="h0-15-28" class="d">- &quot;tokio-codec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-29" id="h0-15-29" class="d">- &quot;tokio-current-thread 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-30" id="h0-15-30" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-31" id="h0-15-31" class="d">- &quot;tokio-fs 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-32" id="h0-15-32" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-33" id="h0-15-33" class="d">- &quot;tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-34" id="h0-15-34" class="d">- &quot;tokio-sync 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-35" id="h0-15-35" class="d">- &quot;tokio-tcp 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-36" id="h0-15-36" class="d">- &quot;tokio-threadpool 0.1.18 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-37" id="h0-15-37" class="d">- &quot;tokio-timer 0.2.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-38" id="h0-15-38" class="d">- &quot;tokio-udp 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-39" id="h0-15-39" class="d">- &quot;tokio-uds 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-15-40" id="h0-15-40" class="d">-]
</a><a href="#h0-15-41" id="h0-15-41" class="d">-
</a><a href="#h0-15-42" id="h0-15-42" class="d">-[[package]]
</a> name = &quot;tokio&quot;
 version = &quot;0.2.18&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-16" id="h0-16" class="h">@@ -1307,72 +995,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-16-3" id="h0-16-3" class="d">-name = &quot;tokio-codec&quot;
</a><a href="#h0-16-4" id="h0-16-4" class="d">-version = &quot;0.1.2&quot;
</a><a href="#h0-16-5" id="h0-16-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-6" id="h0-16-6" class="d">-dependencies = [
</a><a href="#h0-16-7" id="h0-16-7" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-8" id="h0-16-8" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-9" id="h0-16-9" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-10" id="h0-16-10" class="d">-]
</a><a href="#h0-16-11" id="h0-16-11" class="d">-
</a><a href="#h0-16-12" id="h0-16-12" class="d">-[[package]]
</a><a href="#h0-16-13" id="h0-16-13" class="d">-name = &quot;tokio-core&quot;
</a><a href="#h0-16-14" id="h0-16-14" class="d">-version = &quot;0.1.17&quot;
</a><a href="#h0-16-15" id="h0-16-15" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-16" id="h0-16-16" class="d">-dependencies = [
</a><a href="#h0-16-17" id="h0-16-17" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-18" id="h0-16-18" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-19" id="h0-16-19" class="d">- &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-20" id="h0-16-20" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-21" id="h0-16-21" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-22" id="h0-16-22" class="d">- &quot;scoped-tls 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-23" id="h0-16-23" class="d">- &quot;tokio 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-24" id="h0-16-24" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-25" id="h0-16-25" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-26" id="h0-16-26" class="d">- &quot;tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-27" id="h0-16-27" class="d">- &quot;tokio-timer 0.2.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-28" id="h0-16-28" class="d">-]
</a><a href="#h0-16-29" id="h0-16-29" class="d">-
</a><a href="#h0-16-30" id="h0-16-30" class="d">-[[package]]
</a><a href="#h0-16-31" id="h0-16-31" class="d">-name = &quot;tokio-current-thread&quot;
</a><a href="#h0-16-32" id="h0-16-32" class="d">-version = &quot;0.1.7&quot;
</a><a href="#h0-16-33" id="h0-16-33" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-34" id="h0-16-34" class="d">-dependencies = [
</a><a href="#h0-16-35" id="h0-16-35" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-36" id="h0-16-36" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-37" id="h0-16-37" class="d">-]
</a><a href="#h0-16-38" id="h0-16-38" class="d">-
</a><a href="#h0-16-39" id="h0-16-39" class="d">-[[package]]
</a><a href="#h0-16-40" id="h0-16-40" class="d">-name = &quot;tokio-executor&quot;
</a><a href="#h0-16-41" id="h0-16-41" class="d">-version = &quot;0.1.10&quot;
</a><a href="#h0-16-42" id="h0-16-42" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-43" id="h0-16-43" class="d">-dependencies = [
</a><a href="#h0-16-44" id="h0-16-44" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-45" id="h0-16-45" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-46" id="h0-16-46" class="d">-]
</a><a href="#h0-16-47" id="h0-16-47" class="d">-
</a><a href="#h0-16-48" id="h0-16-48" class="d">-[[package]]
</a><a href="#h0-16-49" id="h0-16-49" class="d">-name = &quot;tokio-fs&quot;
</a><a href="#h0-16-50" id="h0-16-50" class="d">-version = &quot;0.1.7&quot;
</a><a href="#h0-16-51" id="h0-16-51" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-52" id="h0-16-52" class="d">-dependencies = [
</a><a href="#h0-16-53" id="h0-16-53" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-54" id="h0-16-54" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-55" id="h0-16-55" class="d">- &quot;tokio-threadpool 0.1.18 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-56" id="h0-16-56" class="d">-]
</a><a href="#h0-16-57" id="h0-16-57" class="d">-
</a><a href="#h0-16-58" id="h0-16-58" class="d">-[[package]]
</a><a href="#h0-16-59" id="h0-16-59" class="d">-name = &quot;tokio-io&quot;
</a><a href="#h0-16-60" id="h0-16-60" class="d">-version = &quot;0.1.13&quot;
</a><a href="#h0-16-61" id="h0-16-61" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-16-62" id="h0-16-62" class="d">-dependencies = [
</a><a href="#h0-16-63" id="h0-16-63" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-64" id="h0-16-64" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-65" id="h0-16-65" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-16-66" id="h0-16-66" class="d">-]
</a><a href="#h0-16-67" id="h0-16-67" class="d">-
</a><a href="#h0-16-68" id="h0-16-68" class="d">-[[package]]
</a> name = &quot;tokio-macros&quot;
 version = &quot;0.2.5&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-17" id="h0-17" class="h">@@ -1383,24 +1005,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-17-3" id="h0-17-3" class="d">-name = &quot;tokio-reactor&quot;
</a><a href="#h0-17-4" id="h0-17-4" class="d">-version = &quot;0.1.12&quot;
</a><a href="#h0-17-5" id="h0-17-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-17-6" id="h0-17-6" class="d">-dependencies = [
</a><a href="#h0-17-7" id="h0-17-7" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-8" id="h0-17-8" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-9" id="h0-17-9" class="d">- &quot;lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-10" id="h0-17-10" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-11" id="h0-17-11" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-12" id="h0-17-12" class="d">- &quot;num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-13" id="h0-17-13" class="d">- &quot;parking_lot 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-14" id="h0-17-14" class="d">- &quot;slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-15" id="h0-17-15" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-16" id="h0-17-16" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-17" id="h0-17-17" class="d">- &quot;tokio-sync 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-17-18" id="h0-17-18" class="d">-]
</a><a href="#h0-17-19" id="h0-17-19" class="d">-
</a><a href="#h0-17-20" id="h0-17-20" class="d">-[[package]]
</a> name = &quot;tokio-serde&quot;
 version = &quot;0.6.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-18" id="h0-18" class="h">@@ -1415,121 +1019,6 @@ dependencies = [
</a> ]
 
 [[package]]
<a href="#h0-18-3" id="h0-18-3" class="d">-name = &quot;tokio-sync&quot;
</a><a href="#h0-18-4" id="h0-18-4" class="d">-version = &quot;0.1.8&quot;
</a><a href="#h0-18-5" id="h0-18-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-6" id="h0-18-6" class="d">-dependencies = [
</a><a href="#h0-18-7" id="h0-18-7" class="d">- &quot;fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-8" id="h0-18-8" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-9" id="h0-18-9" class="d">-]
</a><a href="#h0-18-10" id="h0-18-10" class="d">-
</a><a href="#h0-18-11" id="h0-18-11" class="d">-[[package]]
</a><a href="#h0-18-12" id="h0-18-12" class="d">-name = &quot;tokio-tcp&quot;
</a><a href="#h0-18-13" id="h0-18-13" class="d">-version = &quot;0.1.4&quot;
</a><a href="#h0-18-14" id="h0-18-14" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-15" id="h0-18-15" class="d">-dependencies = [
</a><a href="#h0-18-16" id="h0-18-16" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-17" id="h0-18-17" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-18" id="h0-18-18" class="d">- &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-19" id="h0-18-19" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-20" id="h0-18-20" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-21" id="h0-18-21" class="d">- &quot;tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-22" id="h0-18-22" class="d">-]
</a><a href="#h0-18-23" id="h0-18-23" class="d">-
</a><a href="#h0-18-24" id="h0-18-24" class="d">-[[package]]
</a><a href="#h0-18-25" id="h0-18-25" class="d">-name = &quot;tokio-threadpool&quot;
</a><a href="#h0-18-26" id="h0-18-26" class="d">-version = &quot;0.1.18&quot;
</a><a href="#h0-18-27" id="h0-18-27" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-28" id="h0-18-28" class="d">-dependencies = [
</a><a href="#h0-18-29" id="h0-18-29" class="d">- &quot;crossbeam-deque 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-30" id="h0-18-30" class="d">- &quot;crossbeam-queue 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-31" id="h0-18-31" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-32" id="h0-18-32" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-33" id="h0-18-33" class="d">- &quot;lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-34" id="h0-18-34" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-35" id="h0-18-35" class="d">- &quot;num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-36" id="h0-18-36" class="d">- &quot;slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-37" id="h0-18-37" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-38" id="h0-18-38" class="d">-]
</a><a href="#h0-18-39" id="h0-18-39" class="d">-
</a><a href="#h0-18-40" id="h0-18-40" class="d">-[[package]]
</a><a href="#h0-18-41" id="h0-18-41" class="d">-name = &quot;tokio-timer&quot;
</a><a href="#h0-18-42" id="h0-18-42" class="d">-version = &quot;0.1.2&quot;
</a><a href="#h0-18-43" id="h0-18-43" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-44" id="h0-18-44" class="d">-dependencies = [
</a><a href="#h0-18-45" id="h0-18-45" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-46" id="h0-18-46" class="d">- &quot;slab 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-47" id="h0-18-47" class="d">-]
</a><a href="#h0-18-48" id="h0-18-48" class="d">-
</a><a href="#h0-18-49" id="h0-18-49" class="d">-[[package]]
</a><a href="#h0-18-50" id="h0-18-50" class="d">-name = &quot;tokio-timer&quot;
</a><a href="#h0-18-51" id="h0-18-51" class="d">-version = &quot;0.2.13&quot;
</a><a href="#h0-18-52" id="h0-18-52" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-53" id="h0-18-53" class="d">-dependencies = [
</a><a href="#h0-18-54" id="h0-18-54" class="d">- &quot;crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-55" id="h0-18-55" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-56" id="h0-18-56" class="d">- &quot;slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-57" id="h0-18-57" class="d">- &quot;tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-58" id="h0-18-58" class="d">-]
</a><a href="#h0-18-59" id="h0-18-59" class="d">-
</a><a href="#h0-18-60" id="h0-18-60" class="d">-[[package]]
</a><a href="#h0-18-61" id="h0-18-61" class="d">-name = &quot;tokio-tls-api&quot;
</a><a href="#h0-18-62" id="h0-18-62" class="d">-version = &quot;0.1.22&quot;
</a><a href="#h0-18-63" id="h0-18-63" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-64" id="h0-18-64" class="d">-dependencies = [
</a><a href="#h0-18-65" id="h0-18-65" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-66" id="h0-18-66" class="d">- &quot;tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-67" id="h0-18-67" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-68" id="h0-18-68" class="d">-]
</a><a href="#h0-18-69" id="h0-18-69" class="d">-
</a><a href="#h0-18-70" id="h0-18-70" class="d">-[[package]]
</a><a href="#h0-18-71" id="h0-18-71" class="d">-name = &quot;tokio-udp&quot;
</a><a href="#h0-18-72" id="h0-18-72" class="d">-version = &quot;0.1.6&quot;
</a><a href="#h0-18-73" id="h0-18-73" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-74" id="h0-18-74" class="d">-dependencies = [
</a><a href="#h0-18-75" id="h0-18-75" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-76" id="h0-18-76" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-77" id="h0-18-77" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-78" id="h0-18-78" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-79" id="h0-18-79" class="d">- &quot;tokio-codec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-80" id="h0-18-80" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-81" id="h0-18-81" class="d">- &quot;tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-82" id="h0-18-82" class="d">-]
</a><a href="#h0-18-83" id="h0-18-83" class="d">-
</a><a href="#h0-18-84" id="h0-18-84" class="d">-[[package]]
</a><a href="#h0-18-85" id="h0-18-85" class="d">-name = &quot;tokio-uds&quot;
</a><a href="#h0-18-86" id="h0-18-86" class="d">-version = &quot;0.1.7&quot;
</a><a href="#h0-18-87" id="h0-18-87" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-88" id="h0-18-88" class="d">-dependencies = [
</a><a href="#h0-18-89" id="h0-18-89" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-90" id="h0-18-90" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-91" id="h0-18-91" class="d">- &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-92" id="h0-18-92" class="d">- &quot;libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-93" id="h0-18-93" class="d">- &quot;log 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-94" id="h0-18-94" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-95" id="h0-18-95" class="d">- &quot;mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-96" id="h0-18-96" class="d">- &quot;tokio-core 0.1.17 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-97" id="h0-18-97" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-98" id="h0-18-98" class="d">-]
</a><a href="#h0-18-99" id="h0-18-99" class="d">-
</a><a href="#h0-18-100" id="h0-18-100" class="d">-[[package]]
</a><a href="#h0-18-101" id="h0-18-101" class="d">-name = &quot;tokio-uds&quot;
</a><a href="#h0-18-102" id="h0-18-102" class="d">-version = &quot;0.2.6&quot;
</a><a href="#h0-18-103" id="h0-18-103" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-18-104" id="h0-18-104" class="d">-dependencies = [
</a><a href="#h0-18-105" id="h0-18-105" class="d">- &quot;bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-106" id="h0-18-106" class="d">- &quot;futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-107" id="h0-18-107" class="d">- &quot;iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-108" id="h0-18-108" class="d">- &quot;libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-109" id="h0-18-109" class="d">- &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-110" id="h0-18-110" class="d">- &quot;mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-111" id="h0-18-111" class="d">- &quot;mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-112" id="h0-18-112" class="d">- &quot;tokio-codec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-113" id="h0-18-113" class="d">- &quot;tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-114" id="h0-18-114" class="d">- &quot;tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-18-115" id="h0-18-115" class="d">-]
</a><a href="#h0-18-116" id="h0-18-116" class="d">-
</a><a href="#h0-18-117" id="h0-18-117" class="d">-[[package]]
</a> name = &quot;tokio-util&quot;
 version = &quot;0.3.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-19" id="h0-19" class="h">@@ -1557,24 +1046,18 @@ dependencies = [
</a>  &quot;assert_matches 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;clap 2.33.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;config 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-19-3" id="h0-19-3" class="d">- &quot;crossbeam 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;derivative 2.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;futures 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;goldenfile 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-19-8" id="h0-19-8" class="d">- &quot;grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-19-9" id="h0-19-9" class="d">- &quot;httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;names 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;pretty_assertions 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-19-14" id="h0-19-14" class="d">- &quot;protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-19-15" id="h0-19-15" class="d">- &quot;protoc-rust-grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;rand 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;regex 1.3.5 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rmp-serde 0.14.3 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;rustyline 5.0.6 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-19-20" id="h0-19-20" class="d">- &quot;scopeguard 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a>  &quot;serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serde_derive 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
  &quot;serial_test 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
<a href="#h0-20" id="h0-20" class="h">@@ -1603,15 +1086,6 @@ version = &quot;0.2.0&quot;
</a> source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
 
 [[package]]
<a href="#h0-20-3" id="h0-20-3" class="d">-name = &quot;unix_socket&quot;
</a><a href="#h0-20-4" id="h0-20-4" class="d">-version = &quot;0.5.0&quot;
</a><a href="#h0-20-5" id="h0-20-5" class="d">-source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
</a><a href="#h0-20-6" id="h0-20-6" class="d">-dependencies = [
</a><a href="#h0-20-7" id="h0-20-7" class="d">- &quot;cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-20-8" id="h0-20-8" class="d">- &quot;libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)&quot;,
</a><a href="#h0-20-9" id="h0-20-9" class="d">-]
</a><a href="#h0-20-10" id="h0-20-10" class="d">-
</a><a href="#h0-20-11" id="h0-20-11" class="d">-[[package]]
</a> name = &quot;utf8parse&quot;
 version = &quot;0.1.1&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
<a href="#h0-21" id="h0-21" class="h">@@ -1699,12 +1173,10 @@ dependencies = [
</a> &quot;checksum atty 0.2.14 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d9b39be18770d11421cdb1b9947a45dd3f37e93092cbf377614828a319d5fee8&quot;
 &quot;checksum autocfg 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f8aac770f1885fd7e387acedd76065302551364496e46b3dd00860b2f8359b9d&quot;
 &quot;checksum base64 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b41b7ea54a0c9d92199de89e20e58d49f02f8e699814ef3fdf266f6f748d15c7&quot;
<a href="#h0-21-3" id="h0-21-3" class="d">-&quot;checksum base64 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;489d6c0ed21b11d038c31b6ceccca973e65d73ba3bd8ecb9a2babf5546164643&quot;
</a> &quot;checksum bincode 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5753e2a71534719bf3f4e57006c3a4f0d2c672a4b676eec84161f763eca87dbf&quot;
 &quot;checksum bitflags 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;cf1de2fe8c75bc145a2f577add951f8134889b4795d47466a54a5c846d691693&quot;
 &quot;checksum blake2b_simd 0.5.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d8fb2d74254a3a0b5cac33ac9f8ed0e44aa50378d9dbb2e5d83bd21ed1dc2c8a&quot;
 &quot;checksum byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;08c48aae112d48ed9f069b33538ea9e3e90aa263cfa3d1c24309612b1f7472de&quot;
<a href="#h0-21-8" id="h0-21-8" class="d">-&quot;checksum bytes 0.4.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;206fdffcfa2df7cbe15601ef46c813fce0965eb3286db6b56c583b814b51c81c&quot;
</a> &quot;checksum bytes 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;130aac562c0dd69c56b3b1cc8ffd2e17be31d0b6c25b61c96b76231aa23e39e1&quot;
 &quot;checksum cc 1.0.50 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;95e28fa049fda1c330bcf9d723be7663a899c4679724b34c81e9f5a326aab8cd&quot;
 &quot;checksum cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;4785bdd1c96b2a846b2bd7cc02e86b6b3dbf14e7e53446c4f54c92a361040822&quot;
<a href="#h0-22" id="h0-22" class="h">@@ -1713,11 +1185,6 @@ dependencies = [
</a> &quot;checksum cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ddfc5b9aa5d4507acaf872de71051dfd0e309860e88966e1051e462a077aac4f&quot;
 &quot;checksum config 0.9.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f9107d78ed62b3fa5a86e7d18e647abed48cfd8f8fab6c72f4cdb982d196f7e6&quot;
 &quot;checksum constant_time_eq 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;245097e9a4535ee1e3e3931fcfcd55a796a44c643e8596ff6566d68f09b87bbc&quot;
<a href="#h0-22-3" id="h0-22-3" class="d">-&quot;checksum crossbeam 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;69323bff1fb41c635347b8ead484a5ca6c3f11914d784170b158d8449ab07f8e&quot;
</a><a href="#h0-22-4" id="h0-22-4" class="d">-&quot;checksum crossbeam-channel 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;cced8691919c02aac3cb0a1bc2e9b73d89e832bf9a06fc579d4e71b68a2da061&quot;
</a><a href="#h0-22-5" id="h0-22-5" class="d">-&quot;checksum crossbeam-deque 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9f02af974daeee82218205558e51ec8768b48cf524bd01d550abe5573a608285&quot;
</a><a href="#h0-22-6" id="h0-22-6" class="d">-&quot;checksum crossbeam-epoch 0.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;058ed274caafc1f60c4997b5fc07bf7dc7cca454af7c6e81edffe5f33f70dace&quot;
</a><a href="#h0-22-7" id="h0-22-7" class="d">-&quot;checksum crossbeam-queue 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c695eeca1e7173472a32221542ae469b3e9aac3a4fc81f7696bcad82029493db&quot;
</a> &quot;checksum crossbeam-utils 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c3c7c73a2d1e9fc0886a08b93e98eb643461230d5f1925e4036204d5f2e261a8&quot;
 &quot;checksum ctor 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;47c5e5ac752e18207b12e16b10631ae5f7f68f8805f335f9b817ead83d9ffce1&quot;
 &quot;checksum derivative 2.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1eae4d76b7cefedd1b4f8cc24378b2fbd1ac1b66e3bbebe8e2192d3be81cb355&quot;
<a href="#h0-23" id="h0-23" class="h">@@ -1728,11 +1195,9 @@ dependencies = [
</a> &quot;checksum fuchsia-cprng 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a06f77d526c1a601b7c4cdd98f54b5eaabffc14d5f2f0296febdc7f357c6d3ba&quot;
 &quot;checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82&quot;
 &quot;checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7&quot;
<a href="#h0-23-3" id="h0-23-3" class="d">-&quot;checksum futures 0.1.29 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1b980f2816d6ee8673b6517b52cb0e808a180efc92e5c19d02cdda79066703ef&quot;
</a> &quot;checksum futures 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5c329ae8753502fb44ae4fc2b622fa2a94652c41e795143765ba0927f92ab780&quot;
 &quot;checksum futures-channel 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f0c77d04ce8edd9cb903932b608268b3fffec4163dc053b3b402bf47eac1f1a8&quot;
 &quot;checksum futures-core 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f25592f769825e89b92358db00d26f965761e094951ac44d3663ef25b7ac464a&quot;
<a href="#h0-23-7" id="h0-23-7" class="d">-&quot;checksum futures-cpupool 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ab90cde24b3319636588d0c35fe03b1333857621051837ed769faefb4c2162e4&quot;
</a> &quot;checksum futures-executor 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f674f3e1bcb15b37284a90cedf55afdba482ab061c407a9c0ebbd0f3109741ba&quot;
 &quot;checksum futures-io 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a638959aa96152c7a4cddf50fcb1e3fede0583b27157c26e67d6f99904090dc6&quot;
 &quot;checksum futures-macro 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9a5081aa3de1f7542a794a397cde100ed903b0630152d0973479018fd85423a7&quot;
<a href="#h0-24" id="h0-24" class="h">@@ -1741,11 +1206,8 @@ dependencies = [
</a> &quot;checksum futures-util 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;22766cf25d64306bedf0384da004d05c9974ab104fcc4528f1236181c18004c5&quot;
 &quot;checksum getrandom 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7abc8dd8451921606d809ba32e95b6111925cd2906060d2dcc29c070220503eb&quot;
 &quot;checksum goldenfile 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3f46e6a4d70c06f0b9a70d36dd8eef4fdeaa1ab657e4f1eaff290f69e48145f2&quot;
<a href="#h0-24-3" id="h0-24-3" class="d">-&quot;checksum grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2aaf1d741fe6f3413f1f9f71b99f5e4e26776d563475a8a53ce53a73a8534c1d&quot;
</a><a href="#h0-24-4" id="h0-24-4" class="d">-&quot;checksum grpc-compiler 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;907274ce8ee7b40a0d0b0db09022ea22846a47cfb1fc8ad2c983c70001b4ffb1&quot;
</a> &quot;checksum half 1.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f36b5f248235f45773d4944f555f83ea61fe07b18b561ccf99d7483d7381e54d&quot;
 &quot;checksum hermit-abi 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1010591b26bbfe835e9faeabeb11866061cc7dcebffd56ad7d0942d0e61aefd8&quot;
<a href="#h0-24-7" id="h0-24-7" class="d">-&quot;checksum httpbis 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7689cfa896b2a71da4f16206af167542b75d242b6906313e53857972a92d5614&quot;
</a> &quot;checksum iovec 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b2b3ea6ff95e175473f8ffe6a7eb7c00d054240321b84c57051175fe3c1e075e&quot;
 &quot;checksum itoa 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b8b7a7c0c47db5545ed3fef7468ee7bb5b74691498139e4b3f6a20685dc6dd8e&quot;
 &quot;checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d&quot;
<a href="#h0-25" id="h0-25" class="h">@@ -1755,11 +1217,8 @@ dependencies = [
</a> &quot;checksum linked-hash-map 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6d262045c5b87c0861b3f004610afd0e2c851e2908d08b6c870cbb9d5f494ecd&quot;
 &quot;checksum linked-hash-map 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ae91b68aebc4ddb91978b11a1b02ddd8602a05ec19002801c5666000e05e0f83&quot;
 &quot;checksum lock_api 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;79b2de95ecb4691949fea4716ca53cdbcfccb2c612e19644a8bad05edcf9f47b&quot;
<a href="#h0-25-3" id="h0-25-3" class="d">-&quot;checksum log 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e19e8d5c34a3e0e2223db8e060f9e8264aeeb5c5fc64a4ee9965c062211c024b&quot;
</a> &quot;checksum log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;14b6052be84e6b71ab17edffc2eeabf5c2c3ae1fdb464aae35ac50c67a44e1f7&quot;
<a href="#h0-25-5" id="h0-25-5" class="d">-&quot;checksum maybe-uninit 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;60302e4db3a61da70c0cb7991976248362f30319e88850c487b9b95bbf059e00&quot;
</a> &quot;checksum memchr 2.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3728d817d99e5ac407411fa471ff9800a778d88a24685968b36824eaf4bee400&quot;
<a href="#h0-25-7" id="h0-25-7" class="d">-&quot;checksum memoffset 0.5.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b4fc2c02a7e374099d4ee95a193111f72d2110197fe200272371758f6c3643d8&quot;
</a> &quot;checksum mio 0.6.21 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;302dec22bcf6bae6dfb69c647187f4b4d0fb6f535521f7bc022430ce8e12008f&quot;
 &quot;checksum mio-uds 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;966257a94e196b11bb43aca423754d87429960a768de9414f3691d6957abf125&quot;
 &quot;checksum miow 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8c1f2f3b1cf331de6896aabf6e9d55dca90356cc9960cca7eaaf408a355ae919&quot;
<a href="#h0-26" id="h0-26" class="h">@@ -1773,8 +1232,6 @@ dependencies = [
</a> &quot;checksum num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;46203554f085ff89c235cd12f7075f3233af9b11ed7c9e16dfe2560d03313ce6&quot;
 &quot;checksum output_vt100 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;53cdc5b785b7a58c5aad8216b3dfa114df64b0b06ae6e1501cef91df2fbdf8f9&quot;
 &quot;checksum parking_lot 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;92e98c49ab0b7ce5b222f2cc9193fc4efe11c6d0bd4f648e374684a6857b1cfc&quot;
<a href="#h0-26-3" id="h0-26-3" class="d">-&quot;checksum parking_lot 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f842b1982eb6c2fe34036a4fbfb06dd185a3f5c8edfaacdf7d1ea10b07de6252&quot;
</a><a href="#h0-26-4" id="h0-26-4" class="d">-&quot;checksum parking_lot_core 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b876b1b9e7ac6e1a74a6da34d25c42e17e8862aa409cbbbdcfc8d86c6f3bc62b&quot;
</a> &quot;checksum parking_lot_core 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;7582838484df45743c8434fbff785e8edf260c28748353d44bc0da32e0ceabf1&quot;
 &quot;checksum pin-project 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6f6a7f5eee6292c559c793430c55c00aea9d3b3d1905e855806ca4d7253426a2&quot;
 &quot;checksum pin-project-internal 0.4.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8988430ce790d8682672117bc06dda364c0be32d3abd738234f19f3240bad99a&quot;
<a href="#h0-27" id="h0-27" class="h">@@ -1785,11 +1242,6 @@ dependencies = [
</a> &quot;checksum proc-macro-hack 0.5.15 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0d659fe7c6d27f25e9d80a1a094c223f5246f6a6596453e09d7229bf42750b63&quot;
 &quot;checksum proc-macro-nested 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8e946095f9d3ed29ec38de908c22f95d9ac008e424c7bcae54c75a79c527c694&quot;
 &quot;checksum proc-macro2 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6c09721c6781493a2a492a96b5a5bf19b65917fe6728884e7c44dd0c60ca3435&quot;
<a href="#h0-27-3" id="h0-27-3" class="d">-&quot;checksum protobuf 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;70731852eec72c56d11226c8a5f96ad5058a3dab73647ca5f7ee351e464f2571&quot;
</a><a href="#h0-27-4" id="h0-27-4" class="d">-&quot;checksum protobuf-codegen 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3d74b9cbbf2ac9a7169c85a3714ec16c51ee9ec7cfd511549527e9a7df720795&quot;
</a><a href="#h0-27-5" id="h0-27-5" class="d">-&quot;checksum protoc 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;50d9500ea1488a61aa96da139039b78a92eef64a0f3c82d38173729f0ad73cf8&quot;
</a><a href="#h0-27-6" id="h0-27-6" class="d">-&quot;checksum protoc-rust 2.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;bea851ddc77c57935a586099f6e1f8bd7b4d366379498f25b8882ed02e0222bf&quot;
</a><a href="#h0-27-7" id="h0-27-7" class="d">-&quot;checksum protoc-rust-grpc 0.6.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6b959e379834057693e0e5a228bc3939aa8e4fee895da1531f69b6e7e74c80d6&quot;
</a> &quot;checksum quote 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2bdc6c187c65bca4260c9011c9e3132efe4909da44726bad24cf7572ae338d7f&quot;
 &quot;checksum rand 0.3.23 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;64ac302d8f83c0c1974bf758f6b041c6c8ada916fbb44a609158ca8b064cc76c&quot;
 &quot;checksum rand 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;552840b97013b1a26992c11eac34bdd778e464601a4c2054b5f0bff7c6761293&quot;
<a href="#h0-28" id="h0-28" class="h">@@ -1809,14 +1261,9 @@ dependencies = [
</a> &quot;checksum rmp-serde 0.14.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;4c1ee98f14fe8b8e9c5ea13d25da7b2a1796169202c57a09d7288de90d56222b&quot;
 &quot;checksum rust-argon2 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;2bc8af4bda8e1ff4932523b94d3dd20ee30a87232323eda55903ffd71d2fb017&quot;
 &quot;checksum rust-ini 0.13.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;3e52c148ef37f8c375d49d5a73aa70713125b7f19095948a923f80afdeb22ec2&quot;
<a href="#h0-28-3" id="h0-28-3" class="d">-&quot;checksum rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;138e3e0acb6c9fb258b19b67cb8abd63c00679d2851805ea151465464fe9030a&quot;
</a> &quot;checksum rustyline 5.0.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;a23cb19702a8d6afb6edb3c842386e680d4883760e0df74e6848e23c2a87a635&quot;
 &quot;checksum ryu 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;535622e6be132bccd223f4bb2b8ac8d53cda3c7a6394944d3b2b33fb974f9d76&quot;
<a href="#h0-28-6" id="h0-28-6" class="d">-&quot;checksum safemem 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ef703b7cb59335eae2eb93ceb664c0eb7ea6bf567079d843e09420219668e072&quot;
</a><a href="#h0-28-7" id="h0-28-7" class="d">-&quot;checksum scoped-tls 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;332ffa32bf586782a3efaeb58f127980944bbc8c4d6913a86107ac2a5ab24b28&quot;
</a> &quot;checksum scopeguard 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d29ab0c6d3fc0ee92fe66e2d99f700eab17a8d57d1c1d3b748380fb20baa78cd&quot;
<a href="#h0-28-9" id="h0-28-9" class="d">-&quot;checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403&quot;
</a><a href="#h0-28-10" id="h0-28-10" class="d">-&quot;checksum semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;388a1df253eca08550bef6c72392cfe7c30914bf41df5269b68cbd6ff8f570a3&quot;
</a> &quot;checksum serde 0.8.23 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9dad3f759919b92c3068c696c15c3d17238234498bbdcc80f2c469606f948ac8&quot;
 &quot;checksum serde 1.0.105 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e707fbbf255b8fc8c3b99abb91e7257a622caeb20a9818cbadbeeede4e0932ff&quot;
 &quot;checksum serde-hjson 0.8.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0b833c5ad67d52ced5f5938b2980f32a9c1c5ef047f0b4fb3127e7a423c76153&quot;
<a href="#h0-29" id="h0-29" class="h">@@ -1827,9 +1274,7 @@ dependencies = [
</a> &quot;checksum serial_test 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;fef5f7c7434b2f2c598adc6f9494648a1e41274a75c0ba4056f680ae0c117fd6&quot;
 &quot;checksum serial_test_derive 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d08338d8024b227c62bd68a12c7c9883f5c66780abaef15c550dc56f46ee6515&quot;
 &quot;checksum simplelog 0.7.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;05a3e303ace6adb0a60a9e9e2fbc6a33e1749d1e43587e2125f7efa9c5e107c5&quot;
<a href="#h0-29-3" id="h0-29-3" class="d">-&quot;checksum slab 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;17b4fcaed89ab08ef143da37bc52adbcc04d4a69014f4c1208d6b51f0c47bc23&quot;
</a> &quot;checksum slab 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c111b5bd5695e56cffe5129854aa230b39c93a305372fdbb2668ca2394eea9f8&quot;
<a href="#h0-29-5" id="h0-29-5" class="d">-&quot;checksum smallvec 0.6.13 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f7b0758c52e15a8b5e3691eae6cc559f08eee9406e548a4477ba4e67770a82b6&quot;
</a> &quot;checksum smallvec 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;05720e22615919e4734f6a99ceae50d00226c3c5aca406e102ebc33298214e0a&quot;
 &quot;checksum strsim 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8ea5119cdb4c55b55d432abb513a0429384878c15dde60cc77b1c99de1a95a6a&quot;
 &quot;checksum syn 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;0df0eb663f387145cab623dea85b09c2c5b4b0aef44e945d928e682fce71bb03&quot;
<a href="#h0-30" id="h0-30" class="h">@@ -1839,34 +1284,14 @@ dependencies = [
</a> &quot;checksum textwrap 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d326610f408c7a4eb6f51c37c330e496b08506c9457c9d34287ecc38809fb060&quot;
 &quot;checksum thread_local 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;d40c6d1b69745a6ec6fb1ca717914848da4b44ae29d9b3080cbee91d72a69b14&quot;
 &quot;checksum time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;db8dcfca086c1143c9270ac42a2bbd8a7ee477b78ac8e45b19abfb0cbede4b6f&quot;
<a href="#h0-30-3" id="h0-30-3" class="d">-&quot;checksum tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;049c03787a0595182357fbd487577947f4351b78ce20c3668f6d49f17feb13d1&quot;
</a><a href="#h0-30-4" id="h0-30-4" class="d">-&quot;checksum tls-api-stub 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;c9a0cc8c149724db9de7d73a0e1bc80b1a74f5394f08c6f301e11f9c35fa061e&quot;
</a><a href="#h0-30-5" id="h0-30-5" class="d">-&quot;checksum tokio 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5a09c0b5bb588872ab2f09afa13ee6e9dac11e10a0ec9e8e3ba39a5a5d530af6&quot;
</a> &quot;checksum tokio 0.2.18 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;34ef16d072d2b6dc8b4a56c70f5c5ced1a37752116f8e7c1e80c659aa7cb6713&quot;
<a href="#h0-30-7" id="h0-30-7" class="d">-&quot;checksum tokio-codec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;25b2998660ba0e70d18684de5d06b70b70a3a747469af9dea7618cc59e75976b&quot;
</a><a href="#h0-30-8" id="h0-30-8" class="d">-&quot;checksum tokio-core 0.1.17 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;aeeffbbb94209023feaef3c196a41cbcdafa06b4a6f893f68779bb5e53796f71&quot;
</a><a href="#h0-30-9" id="h0-30-9" class="d">-&quot;checksum tokio-current-thread 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;b1de0e32a83f131e002238d7ccde18211c0a5397f60cbfffcb112868c2e0e20e&quot;
</a><a href="#h0-30-10" id="h0-30-10" class="d">-&quot;checksum tokio-executor 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;fb2d1b8f4548dbf5e1f7818512e9c406860678f29c300cdf0ebac72d1a3a1671&quot;
</a><a href="#h0-30-11" id="h0-30-11" class="d">-&quot;checksum tokio-fs 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;297a1206e0ca6302a0eed35b700d292b275256f596e2f3fea7729d5e629b6ff4&quot;
</a><a href="#h0-30-12" id="h0-30-12" class="d">-&quot;checksum tokio-io 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;57fc868aae093479e3131e3d165c93b1c7474109d13c90ec0dda2a1bbfff0674&quot;
</a> &quot;checksum tokio-macros 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;f0c3acc6aa564495a0f2e1d59fab677cd7f81a19994cfc7f3ad0e64301560389&quot;
<a href="#h0-30-14" id="h0-30-14" class="d">-&quot;checksum tokio-reactor 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;09bc590ec4ba8ba87652da2068d150dcada2cfa2e07faae270a5e0409aa51351&quot;
</a> &quot;checksum tokio-serde 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;ebdd897b01021779294eb09bb3b52b6e11b0747f9f7e333a84bef532b656de99&quot;
<a href="#h0-30-16" id="h0-30-16" class="d">-&quot;checksum tokio-sync 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;edfe50152bc8164fcc456dab7891fa9bf8beaf01c5ee7e1dd43a397c3cf87dee&quot;
</a><a href="#h0-30-17" id="h0-30-17" class="d">-&quot;checksum tokio-tcp 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;98df18ed66e3b72e742f185882a9e201892407957e45fbff8da17ae7a7c51f72&quot;
</a><a href="#h0-30-18" id="h0-30-18" class="d">-&quot;checksum tokio-threadpool 0.1.18 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;df720b6581784c118f0eb4310796b12b1d242a7eb95f716a8367855325c25f89&quot;
</a><a href="#h0-30-19" id="h0-30-19" class="d">-&quot;checksum tokio-timer 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6131e780037787ff1b3f8aad9da83bca02438b72277850dd6ad0d455e0e20efc&quot;
</a><a href="#h0-30-20" id="h0-30-20" class="d">-&quot;checksum tokio-timer 0.2.13 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;93044f2d313c95ff1cb7809ce9a7a05735b012288a888b62d4434fd58c94f296&quot;
</a><a href="#h0-30-21" id="h0-30-21" class="d">-&quot;checksum tokio-tls-api 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;68d0e040d5b1f4cfca70ec4f371229886a5de5bb554d272a4a8da73004a7b2c9&quot;
</a><a href="#h0-30-22" id="h0-30-22" class="d">-&quot;checksum tokio-udp 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e2a0b10e610b39c38b031a2fcab08e4b82f16ece36504988dcbd81dbba650d82&quot;
</a><a href="#h0-30-23" id="h0-30-23" class="d">-&quot;checksum tokio-uds 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;65ae5d255ce739e8537221ed2942e0445f4b3b813daebac1c0050ddaaa3587f9&quot;
</a><a href="#h0-30-24" id="h0-30-24" class="d">-&quot;checksum tokio-uds 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;5076db410d6fdc6523df7595447629099a1fdc47b3d9f896220780fa48faf798&quot;
</a> &quot;checksum tokio-util 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;be8242891f2b6cbef26a2d7e8605133c2c554cd35b3e4948ea892d6d68436499&quot;
 &quot;checksum toml 0.4.10 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;758664fc71a3a69038656bee8b6be6477d2a6c315a6b81f7081f591bffa4111f&quot;
 &quot;checksum unicode-segmentation 1.6.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;e83e153d1053cbb5a118eeff7fd5be06ed99153f00dbcd8ae310c5fb2b22edc0&quot;
 &quot;checksum unicode-width 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;caaa9d531767d1ff2150b9332433f32a24622147e5ebb1f26409d5da67afd479&quot;
 &quot;checksum unicode-xid 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;826e7639553986605ec5979c7dd957c7895e93eabed50ab2ffa7f6128a75097c&quot;
<a href="#h0-30-30" id="h0-30-30" class="d">-&quot;checksum unix_socket 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;6aa2700417c405c38f5e6902d699345241c28c0b7ade4abaad71e35a87eb1564&quot;
</a> &quot;checksum utf8parse 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;8772a4ccbb4e89959023bc5b7cb8623a795caa7092d99f3aa9501b9484d4557d&quot;
 &quot;checksum uuid 0.8.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;9fde2f6a4bea1d6e007c4ad38c6839fa71cbb63b6dbf5b595aa38dc9b1093c11&quot;
 &quot;checksum vec_map 0.8.1 (registry+https://github.com/rust-lang/crates.io-index)&quot; = &quot;05c78687fb1a80548ae3250346c3db86a80a7cdd77bda190189f2d0a0987c81a&quot;
<b>diff --git a/<a id="h1" href="../file/Cargo.toml.html">Cargo.toml</a> b/<a href="../file/Cargo.toml.html">Cargo.toml</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -9,15 +9,12 @@ default-run = &quot;toydb&quot;
</a> [dependencies]
 clap = &quot;~2.33.0&quot;
 config = &quot;~0.9.3&quot;
<a href="#h1-0-3" id="h1-0-3" class="d">-crossbeam = &quot;~0.7.3&quot;
</a> derivative = &quot;~2.1.0&quot;
 futures = &quot;0.3.4&quot;
 futures-util = &quot;0.3.4&quot;
<a href="#h1-0-7" id="h1-0-7" class="d">-grpc = &quot;~0.6.1&quot;
</a> lazy_static = &quot;~1.4.0&quot;
 log = &quot;~0.4.6&quot;
 names = &quot;0.9.0&quot;
<a href="#h1-0-11" id="h1-0-11" class="d">-protobuf = &quot;~2.8.1&quot;
</a> rand = &quot;~0.7.2&quot;
 regex = &quot;~1.3.1&quot;
 rmp-serde = &quot;~0.14.0&quot;
<a href="#h1-1" id="h1-1" class="h">@@ -30,17 +27,10 @@ tokio-serde = { version = &quot;0.6.1&quot;, features = [&quot;bincode&quot;, &quot;cbor&quot;] }
</a> tokio-util = { version = &quot;0.3.1&quot;, features = [&quot;codec&quot;] }
 uuid = { version = &quot;~0.8.1&quot;, features = [&quot;v4&quot;] }
 
<a href="#h1-1-3" id="h1-1-3" class="d">-# The following are sub-dependencies that we need for error handling
</a><a href="#h1-1-4" id="h1-1-4" class="d">-httpbis = &quot;~0.7.0&quot;
</a><a href="#h1-1-5" id="h1-1-5" class="d">-
</a><a href="#h1-1-6" id="h1-1-6" class="d">-[build-dependencies]
</a><a href="#h1-1-7" id="h1-1-7" class="d">-protoc-rust-grpc = &quot;~0.6.1&quot;
</a><a href="#h1-1-8" id="h1-1-8" class="d">-
</a> [dev-dependencies]
 assert_matches = &quot;~1.3.0&quot;
 goldenfile = &quot;~1.1.0&quot;
 pretty_assertions = &quot;0.6.1&quot;
<a href="#h1-1-13" id="h1-1-13" class="i">+serial_test = &quot;~0.4.0&quot;
</a> tempdir = &quot;~0.3.7&quot;
 tempfile = &quot;~3.1.0&quot;
<a href="#h1-1-16" id="h1-1-16" class="d">-scopeguard = &quot;~1.1.0&quot;
</a><a href="#h1-1-17" id="h1-1-17" class="d">-serial_test = &quot;~0.4.0&quot;
</a><a href="#h1-1-18" id="h1-1-18" class="d">-\ No newline at end of file
</a><b>diff --git a/<a id="h2" href="../file/build.rs.html">build.rs</a> b/<a href="../file/build.rs.html">build.rs</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h2-0-0" id="h2-0-0" class="d">-extern crate protoc_rust_grpc;
</a><a href="#h2-0-1" id="h2-0-1" class="d">-
</a><a href="#h2-0-2" id="h2-0-2" class="d">-fn main() {
</a><a href="#h2-0-3" id="h2-0-3" class="d">-    // Generate Protobuf shims
</a><a href="#h2-0-4" id="h2-0-4" class="d">-    let protobuf_sources = &amp;[&quot;protobuf/raft.proto&quot;];
</a><a href="#h2-0-5" id="h2-0-5" class="d">-
</a><a href="#h2-0-6" id="h2-0-6" class="d">-    protoc_rust_grpc::run(protoc_rust_grpc::Args {
</a><a href="#h2-0-7" id="h2-0-7" class="d">-        input: protobuf_sources,
</a><a href="#h2-0-8" id="h2-0-8" class="d">-        out_dir: &quot;src/service&quot;,
</a><a href="#h2-0-9" id="h2-0-9" class="d">-        includes: &amp;[],
</a><a href="#h2-0-10" id="h2-0-10" class="d">-        rust_protobuf: true,
</a><a href="#h2-0-11" id="h2-0-11" class="d">-    })
</a><a href="#h2-0-12" id="h2-0-12" class="d">-    .expect(&quot;protoc-rust-grpc&quot;);
</a><a href="#h2-0-13" id="h2-0-13" class="d">-
</a><a href="#h2-0-14" id="h2-0-14" class="d">-    for src in protobuf_sources {
</a><a href="#h2-0-15" id="h2-0-15" class="d">-        println!(&quot;cargo:rerun-if-changed={}&quot;, src);
</a><a href="#h2-0-16" id="h2-0-16" class="d">-    }
</a><a href="#h2-0-17" id="h2-0-17" class="d">-}
</a><b>diff --git a/<a id="h3" href="../file/clusters/local/run.sh.html">clusters/local/run.sh</a> b/<a href="../file/clusters/local/run.sh.html">clusters/local/run.sh</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -5,7 +5,7 @@ set -euo pipefail
</a> cargo build --bin toydb
 
 for ID in a b c d e; do
<a href="#h3-0-3" id="h3-0-3" class="d">-    (cargo run -q -- -c toydb-$ID/toydb.yaml | sed -e &quot;s/\\(.*\\)/toydb-$ID \\1/g&quot;) &amp;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+    (cargo run -q -- -c toydb-$ID/toydb.yaml 2&gt;&amp;1 | sed -e &quot;s/\\(.*\\)/toydb-$ID \\1/g&quot;) &amp;
</a> done
 
 trap &#39;kill $(jobs -p)&#39; EXIT
<b>diff --git a/<a id="h4" href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a> b/<a href="../file/protobuf/raft.proto.html">protobuf/raft.proto</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,18 +0,0 @@
</a><a href="#h4-0-0" id="h4-0-0" class="d">-syntax = &quot;proto3&quot;;
</a><a href="#h4-0-1" id="h4-0-1" class="d">-
</a><a href="#h4-0-2" id="h4-0-2" class="d">-// An asynchronous Raft service used for intra-cluster message passing. For details on messages,
</a><a href="#h4-0-3" id="h4-0-3" class="d">-// see toydb::raft::transport module. Simply passes serialized bytes, since we&#39;ll be transitioning
</a><a href="#h4-0-4" id="h4-0-4" class="d">-// away from gRPC/Protobuf.
</a><a href="#h4-0-5" id="h4-0-5" class="d">-
</a><a href="#h4-0-6" id="h4-0-6" class="d">-service Raft {
</a><a href="#h4-0-7" id="h4-0-7" class="d">-  rpc Step(Message) returns (Empty) {};
</a><a href="#h4-0-8" id="h4-0-8" class="d">-};
</a><a href="#h4-0-9" id="h4-0-9" class="d">-
</a><a href="#h4-0-10" id="h4-0-10" class="d">-message Message {
</a><a href="#h4-0-11" id="h4-0-11" class="d">-  uint64 term = 1;
</a><a href="#h4-0-12" id="h4-0-12" class="d">-  string from = 2;
</a><a href="#h4-0-13" id="h4-0-13" class="d">-  string to = 3;
</a><a href="#h4-0-14" id="h4-0-14" class="d">-  bytes event = 4;
</a><a href="#h4-0-15" id="h4-0-15" class="d">-}
</a><a href="#h4-0-16" id="h4-0-16" class="d">-
</a><a href="#h4-0-17" id="h4-0-17" class="d">-message Empty {}
</a><b>diff --git a/<a id="h5" href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a> b/<a href="../file/src/bin/toydb.rs.html">src/bin/toydb.rs</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -1,15 +1,9 @@
</a> #![warn(clippy::all)]
 
<a href="#h5-0-2" id="h5-0-2" class="d">-#[macro_use]
</a><a href="#h5-0-3" id="h5-0-3" class="d">-extern crate clap;
</a><a href="#h5-0-4" id="h5-0-4" class="d">-extern crate config;
</a><a href="#h5-0-5" id="h5-0-5" class="d">-extern crate serde;
</a><a href="#h5-0-6" id="h5-0-6" class="d">-#[macro_use]
</a><a href="#h5-0-7" id="h5-0-7" class="d">-extern crate serde_derive;
</a><a href="#h5-0-8" id="h5-0-8" class="d">-extern crate simplelog;
</a><a href="#h5-0-9" id="h5-0-9" class="d">-extern crate toydb;
</a><a href="#h5-0-10" id="h5-0-10" class="d">-
</a><a href="#h5-0-11" id="h5-0-11" class="i">+use clap::{app_from_crate, crate_authors, crate_description, crate_name, crate_version};
</a><a href="#h5-0-12" id="h5-0-12" class="i">+use serde_derive::Deserialize;
</a> use std::collections::HashMap;
<a href="#h5-0-14" id="h5-0-14" class="i">+use toydb::Server;
</a> 
 #[tokio::main]
 async fn main() -&gt; Result&lt;(), toydb::Error&gt; {
<a href="#h5-1" id="h5-1" class="h">@@ -32,8 +26,11 @@ async fn main() -&gt; Result&lt;(), toydb::Error&gt; {
</a>     }
     simplelog::SimpleLogger::init(loglevel, logconfig.build())?;
 
<a href="#h5-1-3" id="h5-1-3" class="d">-    let server = toydb::Server::new(&amp;cfg.id, cfg.parse_peers()?, &amp;cfg.data_dir)?;
</a><a href="#h5-1-4" id="h5-1-4" class="d">-    server.listen(cfg.listen_sql, cfg.listen_raft).await
</a><a href="#h5-1-5" id="h5-1-5" class="i">+    Server::new(&amp;cfg.id, cfg.peers, &amp;cfg.data_dir)?
</a><a href="#h5-1-6" id="h5-1-6" class="i">+        .listen(&amp;cfg.listen_sql, &amp;cfg.listen_raft)
</a><a href="#h5-1-7" id="h5-1-7" class="i">+        .await?
</a><a href="#h5-1-8" id="h5-1-8" class="i">+        .serve()
</a><a href="#h5-1-9" id="h5-1-9" class="i">+        .await
</a> }
 
 #[derive(Debug, Deserialize)]
<a href="#h5-2" id="h5-2" class="h">@@ -59,20 +56,4 @@ impl Config {
</a>         c.merge(config::Environment::with_prefix(&quot;TOYDB&quot;))?;
         c.try_into()
     }
<a href="#h5-2-3" id="h5-2-3" class="d">-
</a><a href="#h5-2-4" id="h5-2-4" class="d">-    fn parse_peers(&amp;self) -&gt; Result&lt;HashMap&lt;String, std::net::SocketAddr&gt;, toydb::Error&gt; {
</a><a href="#h5-2-5" id="h5-2-5" class="d">-        let mut peers = HashMap::new();
</a><a href="#h5-2-6" id="h5-2-6" class="d">-        for (id, address) in self.peers.iter() {
</a><a href="#h5-2-7" id="h5-2-7" class="d">-            peers.insert(
</a><a href="#h5-2-8" id="h5-2-8" class="d">-                id.clone(),
</a><a href="#h5-2-9" id="h5-2-9" class="d">-                if let Ok(sa) = address.parse::&lt;std::net::SocketAddr&gt;() {
</a><a href="#h5-2-10" id="h5-2-10" class="d">-                    sa
</a><a href="#h5-2-11" id="h5-2-11" class="d">-                } else {
</a><a href="#h5-2-12" id="h5-2-12" class="d">-                    let ip = address.parse::&lt;std::net::IpAddr&gt;()?;
</a><a href="#h5-2-13" id="h5-2-13" class="d">-                    std::net::SocketAddr::new(ip, 9705)
</a><a href="#h5-2-14" id="h5-2-14" class="d">-                },
</a><a href="#h5-2-15" id="h5-2-15" class="d">-            );
</a><a href="#h5-2-16" id="h5-2-16" class="d">-        }
</a><a href="#h5-2-17" id="h5-2-17" class="d">-        Ok(peers)
</a><a href="#h5-2-18" id="h5-2-18" class="d">-    }
</a> }
<b>diff --git a/<a id="h6" href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a> b/<a href="../file/src/bin/toysql.rs.html">src/bin/toysql.rs</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -117,10 +117,13 @@ impl ToySQL {
</a> 
       !headers &lt;on|off&gt;  Toggles/enables/disables column headers display
       !help              This help message
<a href="#h6-0-3" id="h6-0-3" class="i">+      !status            Display server status
</a>       !table [table]     Display table schema, if it exists
       !tables            List tables
     &quot;#
             ),
<a href="#h6-0-8" id="h6-0-8" class="i">+            // FIXME This should have better formatting
</a><a href="#h6-0-9" id="h6-0-9" class="i">+            &quot;!status&quot; =&gt; println!(&quot;{:?}&quot;, self.client.status().await?),
</a>             &quot;!table&quot; =&gt; {
                 let args = getargs(1)?;
                 println!(&quot;{}&quot;, self.client.get_table(args[0]).await?.as_sql());
<a href="#h6-1" id="h6-1" class="h">@@ -216,10 +219,7 @@ impl ToySQL {
</a>         }
 
         let status = self.client.status().await?;
<a href="#h6-1-3" id="h6-1-3" class="d">-        println!(
</a><a href="#h6-1-4" id="h6-1-4" class="d">-            &quot;Connected to node \&quot;{}\&quot; (version {}). Enter !help for instructions.&quot;,
</a><a href="#h6-1-5" id="h6-1-5" class="d">-            status.id, status.version
</a><a href="#h6-1-6" id="h6-1-6" class="d">-        );
</a><a href="#h6-1-7" id="h6-1-7" class="i">+        println!(&quot;Connected to ToyDB node \&quot;{}\&quot;. Enter !help for instructions.&quot;, status.id);
</a> 
         while let Some(input) = self.prompt()? {
             if let Err(err) = self.execute(&amp;input).await {
<b>diff --git a/<a id="h7" href="../file/src/client.rs.html">src/client.rs</a> b/<a href="../file/src/client.rs.html">src/client.rs</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -1,4 +1,5 @@
</a><a href="#h7-0-0" id="h7-0-0" class="d">-use crate::server::{Request, Response, Status};
</a><a href="#h7-0-1" id="h7-0-1" class="i">+use crate::raft;
</a><a href="#h7-0-2" id="h7-0-2" class="i">+use crate::server::{Request, Response};
</a> use crate::sql::execution::ResultSet;
 use crate::sql::schema::Table;
 use crate::Error;
<a href="#h7-1" id="h7-1" class="h">@@ -96,7 +97,7 @@ impl Client {
</a>     }
 
     /// Checks server status
<a href="#h7-1-3" id="h7-1-3" class="d">-    pub async fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h7-1-4" id="h7-1-4" class="i">+    pub async fn status(&amp;self) -&gt; Result&lt;raft::Status, Error&gt; {
</a>         match self.call(Request::Status).await? {
             Response::Status(s) =&gt; Ok(s),
             resp =&gt; Err(Error::Value(format!(&quot;Unexpected response: {:?}&quot;, resp))),
<b>diff --git a/<a id="h8" href="../file/src/error.rs.html">src/error.rs</a> b/<a href="../file/src/error.rs.html">src/error.rs</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -27,30 +27,6 @@ impl From&lt;config::ConfigError&gt; for Error {
</a>     }
 }
 
<a href="#h8-0-3" id="h8-0-3" class="d">-impl From&lt;crossbeam::channel::RecvError&gt; for Error {
</a><a href="#h8-0-4" id="h8-0-4" class="d">-    fn from(err: crossbeam::channel::RecvError) -&gt; Self {
</a><a href="#h8-0-5" id="h8-0-5" class="d">-        Error::Internal(err.to_string())
</a><a href="#h8-0-6" id="h8-0-6" class="d">-    }
</a><a href="#h8-0-7" id="h8-0-7" class="d">-}
</a><a href="#h8-0-8" id="h8-0-8" class="d">-
</a><a href="#h8-0-9" id="h8-0-9" class="d">-impl&lt;T&gt; From&lt;crossbeam::channel::SendError&lt;T&gt;&gt; for Error {
</a><a href="#h8-0-10" id="h8-0-10" class="d">-    fn from(err: crossbeam::channel::SendError&lt;T&gt;) -&gt; Self {
</a><a href="#h8-0-11" id="h8-0-11" class="d">-        Error::Internal(err.to_string())
</a><a href="#h8-0-12" id="h8-0-12" class="d">-    }
</a><a href="#h8-0-13" id="h8-0-13" class="d">-}
</a><a href="#h8-0-14" id="h8-0-14" class="d">-
</a><a href="#h8-0-15" id="h8-0-15" class="d">-impl From&lt;grpc::Error&gt; for Error {
</a><a href="#h8-0-16" id="h8-0-16" class="d">-    fn from(err: grpc::Error) -&gt; Self {
</a><a href="#h8-0-17" id="h8-0-17" class="d">-        Error::Internal(err.to_string())
</a><a href="#h8-0-18" id="h8-0-18" class="d">-    }
</a><a href="#h8-0-19" id="h8-0-19" class="d">-}
</a><a href="#h8-0-20" id="h8-0-20" class="d">-
</a><a href="#h8-0-21" id="h8-0-21" class="d">-impl From&lt;httpbis::Error&gt; for Error {
</a><a href="#h8-0-22" id="h8-0-22" class="d">-    fn from(err: httpbis::Error) -&gt; Self {
</a><a href="#h8-0-23" id="h8-0-23" class="d">-        Error::Internal(err.to_string())
</a><a href="#h8-0-24" id="h8-0-24" class="d">-    }
</a><a href="#h8-0-25" id="h8-0-25" class="d">-}
</a><a href="#h8-0-26" id="h8-0-26" class="d">-
</a> impl From&lt;log::ParseLevelError&gt; for Error {
     fn from(err: log::ParseLevelError) -&gt; Self {
         Error::Config(err.to_string())
<a href="#h8-1" id="h8-1" class="h">@@ -122,3 +98,21 @@ impl From&lt;tokio::task::JoinError&gt; for Error {
</a>         Error::Internal(err.to_string())
     }
 }
<a href="#h8-1-3" id="h8-1-3" class="i">+
</a><a href="#h8-1-4" id="h8-1-4" class="i">+impl From&lt;tokio::sync::mpsc::error::TryRecvError&gt; for Error {
</a><a href="#h8-1-5" id="h8-1-5" class="i">+    fn from(err: tokio::sync::mpsc::error::TryRecvError) -&gt; Self {
</a><a href="#h8-1-6" id="h8-1-6" class="i">+        Error::Internal(err.to_string())
</a><a href="#h8-1-7" id="h8-1-7" class="i">+    }
</a><a href="#h8-1-8" id="h8-1-8" class="i">+}
</a><a href="#h8-1-9" id="h8-1-9" class="i">+
</a><a href="#h8-1-10" id="h8-1-10" class="i">+impl From&lt;tokio::sync::oneshot::error::RecvError&gt; for Error {
</a><a href="#h8-1-11" id="h8-1-11" class="i">+    fn from(err: tokio::sync::oneshot::error::RecvError) -&gt; Self {
</a><a href="#h8-1-12" id="h8-1-12" class="i">+        Error::Internal(err.to_string())
</a><a href="#h8-1-13" id="h8-1-13" class="i">+    }
</a><a href="#h8-1-14" id="h8-1-14" class="i">+}
</a><a href="#h8-1-15" id="h8-1-15" class="i">+
</a><a href="#h8-1-16" id="h8-1-16" class="i">+impl&lt;T&gt; From&lt;tokio::sync::mpsc::error::SendError&lt;T&gt;&gt; for Error {
</a><a href="#h8-1-17" id="h8-1-17" class="i">+    fn from(err: tokio::sync::mpsc::error::SendError&lt;T&gt;) -&gt; Self {
</a><a href="#h8-1-18" id="h8-1-18" class="i">+        Error::Internal(err.to_string())
</a><a href="#h8-1-19" id="h8-1-19" class="i">+    }
</a><a href="#h8-1-20" id="h8-1-20" class="i">+}
</a><b>diff --git a/<a id="h9" href="../file/src/lib.rs.html">src/lib.rs</a> b/<a href="../file/src/lib.rs.html">src/lib.rs</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -5,13 +5,10 @@
</a> #[macro_use]
 extern crate assert_matches;
 extern crate config;
<a href="#h9-0-3" id="h9-0-3" class="d">-#[macro_use(select)]
</a><a href="#h9-0-4" id="h9-0-4" class="d">-extern crate crossbeam;
</a> #[macro_use]
 extern crate derivative;
 #[cfg(test)]
 extern crate goldenfile;
<a href="#h9-0-9" id="h9-0-9" class="d">-extern crate httpbis;
</a> #[macro_use]
 extern crate lazy_static;
 #[macro_use]
<a href="#h9-1" id="h9-1" class="h">@@ -28,9 +25,8 @@ extern crate uuid;
</a> pub mod client;
 mod error;
 pub mod kv;
<a href="#h9-1-3" id="h9-1-3" class="d">-mod raft;
</a><a href="#h9-1-4" id="h9-1-4" class="i">+pub mod raft;
</a> pub mod server;
<a href="#h9-1-6" id="h9-1-6" class="d">-mod service;
</a> pub mod sql;
 mod utility;
 
<b>diff --git a/<a id="h10" href="../file/src/raft/client.rs.html">src/raft/client.rs</a> b/<a href="../file/src/raft/client.rs.html">src/raft/client.rs</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -0,0 +1,86 @@
</a><a href="#h10-0-0" id="h10-0-0" class="i">+use super::Status;
</a><a href="#h10-0-1" id="h10-0-1" class="i">+use crate::Error;
</a><a href="#h10-0-2" id="h10-0-2" class="i">+
</a><a href="#h10-0-3" id="h10-0-3" class="i">+use tokio::runtime;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+use tokio::sync::{mpsc, oneshot};
</a><a href="#h10-0-5" id="h10-0-5" class="i">+
</a><a href="#h10-0-6" id="h10-0-6" class="i">+/// A client request.
</a><a href="#h10-0-7" id="h10-0-7" class="i">+#[derive(Debug)]
</a><a href="#h10-0-8" id="h10-0-8" class="i">+pub enum Request {
</a><a href="#h10-0-9" id="h10-0-9" class="i">+    Query(Vec&lt;u8&gt;),
</a><a href="#h10-0-10" id="h10-0-10" class="i">+    Mutate(Vec&lt;u8&gt;),
</a><a href="#h10-0-11" id="h10-0-11" class="i">+    Status,
</a><a href="#h10-0-12" id="h10-0-12" class="i">+}
</a><a href="#h10-0-13" id="h10-0-13" class="i">+
</a><a href="#h10-0-14" id="h10-0-14" class="i">+/// A client response.
</a><a href="#h10-0-15" id="h10-0-15" class="i">+#[derive(Debug)]
</a><a href="#h10-0-16" id="h10-0-16" class="i">+pub enum Response {
</a><a href="#h10-0-17" id="h10-0-17" class="i">+    State(Vec&lt;u8&gt;),
</a><a href="#h10-0-18" id="h10-0-18" class="i">+    Status(Status),
</a><a href="#h10-0-19" id="h10-0-19" class="i">+    Error(Error),
</a><a href="#h10-0-20" id="h10-0-20" class="i">+}
</a><a href="#h10-0-21" id="h10-0-21" class="i">+
</a><a href="#h10-0-22" id="h10-0-22" class="i">+/// A client for a local Raft server.
</a><a href="#h10-0-23" id="h10-0-23" class="i">+#[derive(Clone)]
</a><a href="#h10-0-24" id="h10-0-24" class="i">+pub struct Client {
</a><a href="#h10-0-25" id="h10-0-25" class="i">+    request_tx: mpsc::UnboundedSender&lt;(Request, oneshot::Sender&lt;Response&gt;)&gt;,
</a><a href="#h10-0-26" id="h10-0-26" class="i">+    runtime: runtime::Handle,
</a><a href="#h10-0-27" id="h10-0-27" class="i">+}
</a><a href="#h10-0-28" id="h10-0-28" class="i">+
</a><a href="#h10-0-29" id="h10-0-29" class="i">+impl Client {
</a><a href="#h10-0-30" id="h10-0-30" class="i">+    /// Creates a new Raft client.
</a><a href="#h10-0-31" id="h10-0-31" class="i">+    pub async fn new(
</a><a href="#h10-0-32" id="h10-0-32" class="i">+        request_tx: mpsc::UnboundedSender&lt;(Request, oneshot::Sender&lt;Response&gt;)&gt;,
</a><a href="#h10-0-33" id="h10-0-33" class="i">+    ) -&gt; Self {
</a><a href="#h10-0-34" id="h10-0-34" class="i">+        Self { request_tx, runtime: runtime::Handle::current() }
</a><a href="#h10-0-35" id="h10-0-35" class="i">+    }
</a><a href="#h10-0-36" id="h10-0-36" class="i">+
</a><a href="#h10-0-37" id="h10-0-37" class="i">+    /// Executes a request against the Raft cluster.
</a><a href="#h10-0-38" id="h10-0-38" class="i">+    async fn request(&amp;self, request: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h10-0-39" id="h10-0-39" class="i">+        let (response_tx, response_rx) = oneshot::channel();
</a><a href="#h10-0-40" id="h10-0-40" class="i">+        self.request_tx.send((request, response_tx))?;
</a><a href="#h10-0-41" id="h10-0-41" class="i">+        match response_rx.await? {
</a><a href="#h10-0-42" id="h10-0-42" class="i">+            Response::Error(error) =&gt; Err(error),
</a><a href="#h10-0-43" id="h10-0-43" class="i">+            response =&gt; Ok(response),
</a><a href="#h10-0-44" id="h10-0-44" class="i">+        }
</a><a href="#h10-0-45" id="h10-0-45" class="i">+    }
</a><a href="#h10-0-46" id="h10-0-46" class="i">+
</a><a href="#h10-0-47" id="h10-0-47" class="i">+    /// Mutates the Raft state machine.
</a><a href="#h10-0-48" id="h10-0-48" class="i">+    pub async fn mutate(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h10-0-49" id="h10-0-49" class="i">+        match self.request(Request::Mutate(command)).await? {
</a><a href="#h10-0-50" id="h10-0-50" class="i">+            Response::State(response) =&gt; Ok(response),
</a><a href="#h10-0-51" id="h10-0-51" class="i">+            resp =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft mutate response {:?}&quot;, resp))),
</a><a href="#h10-0-52" id="h10-0-52" class="i">+        }
</a><a href="#h10-0-53" id="h10-0-53" class="i">+    }
</a><a href="#h10-0-54" id="h10-0-54" class="i">+
</a><a href="#h10-0-55" id="h10-0-55" class="i">+    /// Mutates the Raft machine synchronously.
</a><a href="#h10-0-56" id="h10-0-56" class="i">+    pub fn mutate_sync(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h10-0-57" id="h10-0-57" class="i">+        self.runtime.enter(|| futures::executor::block_on(self.mutate(command)))
</a><a href="#h10-0-58" id="h10-0-58" class="i">+    }
</a><a href="#h10-0-59" id="h10-0-59" class="i">+
</a><a href="#h10-0-60" id="h10-0-60" class="i">+    /// Queries the Raft state machine.
</a><a href="#h10-0-61" id="h10-0-61" class="i">+    pub async fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h10-0-62" id="h10-0-62" class="i">+        match self.request(Request::Query(command)).await? {
</a><a href="#h10-0-63" id="h10-0-63" class="i">+            Response::State(response) =&gt; Ok(response),
</a><a href="#h10-0-64" id="h10-0-64" class="i">+            resp =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft query response {:?}&quot;, resp))),
</a><a href="#h10-0-65" id="h10-0-65" class="i">+        }
</a><a href="#h10-0-66" id="h10-0-66" class="i">+    }
</a><a href="#h10-0-67" id="h10-0-67" class="i">+
</a><a href="#h10-0-68" id="h10-0-68" class="i">+    /// Queries the Raft state machine synchronously.
</a><a href="#h10-0-69" id="h10-0-69" class="i">+    pub fn query_sync(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h10-0-70" id="h10-0-70" class="i">+        self.runtime.enter(|| futures::executor::block_on(self.query(command)))
</a><a href="#h10-0-71" id="h10-0-71" class="i">+    }
</a><a href="#h10-0-72" id="h10-0-72" class="i">+
</a><a href="#h10-0-73" id="h10-0-73" class="i">+    /// Fetches Raft node status.
</a><a href="#h10-0-74" id="h10-0-74" class="i">+    pub async fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h10-0-75" id="h10-0-75" class="i">+        match self.request(Request::Status).await? {
</a><a href="#h10-0-76" id="h10-0-76" class="i">+            Response::Status(status) =&gt; Ok(status),
</a><a href="#h10-0-77" id="h10-0-77" class="i">+            resp =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft status response {:?}&quot;, resp))),
</a><a href="#h10-0-78" id="h10-0-78" class="i">+        }
</a><a href="#h10-0-79" id="h10-0-79" class="i">+    }
</a><a href="#h10-0-80" id="h10-0-80" class="i">+
</a><a href="#h10-0-81" id="h10-0-81" class="i">+    /// Fetches Raft node status synchronously.
</a><a href="#h10-0-82" id="h10-0-82" class="i">+    pub fn status_sync(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h10-0-83" id="h10-0-83" class="i">+        self.runtime.enter(|| futures::executor::block_on(self.status()))
</a><a href="#h10-0-84" id="h10-0-84" class="i">+    }
</a><a href="#h10-0-85" id="h10-0-85" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/src/raft/log.rs.html">src/raft/log.rs</a> b/<a href="../file/src/raft/log.rs.html">src/raft/log.rs</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -255,7 +255,7 @@ impl&lt;S: kv::storage::Storage&gt; Log&lt;S&gt; {
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h11-0-3" id="h11-0-3" class="d">-    use super::super::tests::TestState;
</a><a href="#h11-0-4" id="h11-0-4" class="i">+    use super::super::state::tests::TestState;
</a>     use super::*;
 
     fn setup() -&gt; Result&lt;(Log&lt;kv::storage::Test&gt;, kv::Simple&lt;kv::storage::Test&gt;), Error&gt; {
<b>diff --git a/<a id="h12" href="../file/src/raft/message.rs.html">src/raft/message.rs</a> b/<a href="../file/src/raft/message.rs.html">src/raft/message.rs</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -0,0 +1,210 @@
</a><a href="#h12-0-0" id="h12-0-0" class="i">+use super::Entry;
</a><a href="#h12-0-1" id="h12-0-1" class="i">+use crate::Error;
</a><a href="#h12-0-2" id="h12-0-2" class="i">+
</a><a href="#h12-0-3" id="h12-0-3" class="i">+/// A message passed between Raft nodes.
</a><a href="#h12-0-4" id="h12-0-4" class="i">+#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h12-0-5" id="h12-0-5" class="i">+pub struct Message {
</a><a href="#h12-0-6" id="h12-0-6" class="i">+    /// The current term of the sender.
</a><a href="#h12-0-7" id="h12-0-7" class="i">+    pub term: u64,
</a><a href="#h12-0-8" id="h12-0-8" class="i">+    /// The ID of the sending node, or None if local sender.
</a><a href="#h12-0-9" id="h12-0-9" class="i">+    pub from: Option&lt;String&gt;,
</a><a href="#h12-0-10" id="h12-0-10" class="i">+    /// The ID of the receiving node, or None if local receiver.
</a><a href="#h12-0-11" id="h12-0-11" class="i">+    pub to: Option&lt;String&gt;,
</a><a href="#h12-0-12" id="h12-0-12" class="i">+    /// The message event.
</a><a href="#h12-0-13" id="h12-0-13" class="i">+    pub event: Event,
</a><a href="#h12-0-14" id="h12-0-14" class="i">+}
</a><a href="#h12-0-15" id="h12-0-15" class="i">+
</a><a href="#h12-0-16" id="h12-0-16" class="i">+impl Message {
</a><a href="#h12-0-17" id="h12-0-17" class="i">+    /// Normalizes a message by setting to and term for local messages.
</a><a href="#h12-0-18" id="h12-0-18" class="i">+    pub fn normalize(&amp;mut self, node_id: &amp;str, term: u64) {
</a><a href="#h12-0-19" id="h12-0-19" class="i">+        if self.from.is_none() &amp;&amp; self.to.is_none() {
</a><a href="#h12-0-20" id="h12-0-20" class="i">+            self.to = Some(node_id.to_owned());
</a><a href="#h12-0-21" id="h12-0-21" class="i">+            if self.term == 0 {
</a><a href="#h12-0-22" id="h12-0-22" class="i">+                self.term = term;
</a><a href="#h12-0-23" id="h12-0-23" class="i">+            }
</a><a href="#h12-0-24" id="h12-0-24" class="i">+        }
</a><a href="#h12-0-25" id="h12-0-25" class="i">+    }
</a><a href="#h12-0-26" id="h12-0-26" class="i">+
</a><a href="#h12-0-27" id="h12-0-27" class="i">+    /// Validates a message against the receiving node.
</a><a href="#h12-0-28" id="h12-0-28" class="i">+    pub fn validate(&amp;self, node_id: &amp;str, term: u64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h12-0-29" id="h12-0-29" class="i">+        // Don&#39;t allow local messages without call ID
</a><a href="#h12-0-30" id="h12-0-30" class="i">+        if self.from.is_none() &amp;&amp; self.event.call_id().is_none() {
</a><a href="#h12-0-31" id="h12-0-31" class="i">+            return Err(Error::Internal(format!(
</a><a href="#h12-0-32" id="h12-0-32" class="i">+                &quot;Received local non-call event: {:?}&quot;,
</a><a href="#h12-0-33" id="h12-0-33" class="i">+                self.event
</a><a href="#h12-0-34" id="h12-0-34" class="i">+            )));
</a><a href="#h12-0-35" id="h12-0-35" class="i">+        }
</a><a href="#h12-0-36" id="h12-0-36" class="i">+
</a><a href="#h12-0-37" id="h12-0-37" class="i">+        // Ignore messages from past term
</a><a href="#h12-0-38" id="h12-0-38" class="i">+        if self.term &lt; term {
</a><a href="#h12-0-39" id="h12-0-39" class="i">+            return Err(Error::Internal(format!(&quot;Ignoring message from stale term {}&quot;, self.term)));
</a><a href="#h12-0-40" id="h12-0-40" class="i">+        }
</a><a href="#h12-0-41" id="h12-0-41" class="i">+
</a><a href="#h12-0-42" id="h12-0-42" class="i">+        // Ignore messages addressed to peers or local client
</a><a href="#h12-0-43" id="h12-0-43" class="i">+        if let Some(to) = &amp;self.to {
</a><a href="#h12-0-44" id="h12-0-44" class="i">+            if to != node_id {
</a><a href="#h12-0-45" id="h12-0-45" class="i">+                return Err(Error::Internal(format!(&quot;Ignoring message for other node {}&quot;, to)));
</a><a href="#h12-0-46" id="h12-0-46" class="i">+            }
</a><a href="#h12-0-47" id="h12-0-47" class="i">+        } else {
</a><a href="#h12-0-48" id="h12-0-48" class="i">+            return Err(Error::Internal(&quot;Ignoring message for local client&quot;.into()));
</a><a href="#h12-0-49" id="h12-0-49" class="i">+        }
</a><a href="#h12-0-50" id="h12-0-50" class="i">+        Ok(())
</a><a href="#h12-0-51" id="h12-0-51" class="i">+    }
</a><a href="#h12-0-52" id="h12-0-52" class="i">+}
</a><a href="#h12-0-53" id="h12-0-53" class="i">+
</a><a href="#h12-0-54" id="h12-0-54" class="i">+/// An event contained within messages.
</a><a href="#h12-0-55" id="h12-0-55" class="i">+#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h12-0-56" id="h12-0-56" class="i">+pub enum Event {
</a><a href="#h12-0-57" id="h12-0-57" class="i">+    /// Leaders send periodic heartbeats to its followers.
</a><a href="#h12-0-58" id="h12-0-58" class="i">+    Heartbeat {
</a><a href="#h12-0-59" id="h12-0-59" class="i">+        /// The index of the leader&#39;s last committed log entry.
</a><a href="#h12-0-60" id="h12-0-60" class="i">+        commit_index: u64,
</a><a href="#h12-0-61" id="h12-0-61" class="i">+        /// The term of the leader&#39;s last committed log entry.
</a><a href="#h12-0-62" id="h12-0-62" class="i">+        commit_term: u64,
</a><a href="#h12-0-63" id="h12-0-63" class="i">+    },
</a><a href="#h12-0-64" id="h12-0-64" class="i">+    /// Followers confirm loyalty to leader after heartbeats.
</a><a href="#h12-0-65" id="h12-0-65" class="i">+    ConfirmLeader {
</a><a href="#h12-0-66" id="h12-0-66" class="i">+        /// The commit_index of the original leader heartbeat, to confirm
</a><a href="#h12-0-67" id="h12-0-67" class="i">+        /// read requests.
</a><a href="#h12-0-68" id="h12-0-68" class="i">+        commit_index: u64,
</a><a href="#h12-0-69" id="h12-0-69" class="i">+        /// If false, the follower does not have the entry at commit_index
</a><a href="#h12-0-70" id="h12-0-70" class="i">+        /// and would like the leader to replicate it.
</a><a href="#h12-0-71" id="h12-0-71" class="i">+        has_committed: bool,
</a><a href="#h12-0-72" id="h12-0-72" class="i">+    },
</a><a href="#h12-0-73" id="h12-0-73" class="i">+    /// Candidates solicit votes from all peers.
</a><a href="#h12-0-74" id="h12-0-74" class="i">+    SolicitVote {
</a><a href="#h12-0-75" id="h12-0-75" class="i">+        // The index of the candidate&#39;s last stored log entry
</a><a href="#h12-0-76" id="h12-0-76" class="i">+        last_index: u64,
</a><a href="#h12-0-77" id="h12-0-77" class="i">+        // The term of the candidate&#39;s last stored log entry
</a><a href="#h12-0-78" id="h12-0-78" class="i">+        last_term: u64,
</a><a href="#h12-0-79" id="h12-0-79" class="i">+    },
</a><a href="#h12-0-80" id="h12-0-80" class="i">+    /// Followers may grant votes to candidates.
</a><a href="#h12-0-81" id="h12-0-81" class="i">+    GrantVote,
</a><a href="#h12-0-82" id="h12-0-82" class="i">+    /// Leaders replicate a set of log entries to followers.
</a><a href="#h12-0-83" id="h12-0-83" class="i">+    ReplicateEntries {
</a><a href="#h12-0-84" id="h12-0-84" class="i">+        /// The index of the log entry immediately preceding the submitted commands.
</a><a href="#h12-0-85" id="h12-0-85" class="i">+        base_index: u64,
</a><a href="#h12-0-86" id="h12-0-86" class="i">+        /// The term of the log entry immediately preceding the submitted commands.
</a><a href="#h12-0-87" id="h12-0-87" class="i">+        base_term: u64,
</a><a href="#h12-0-88" id="h12-0-88" class="i">+        /// Commands to replicate.
</a><a href="#h12-0-89" id="h12-0-89" class="i">+        entries: Vec&lt;Entry&gt;,
</a><a href="#h12-0-90" id="h12-0-90" class="i">+    },
</a><a href="#h12-0-91" id="h12-0-91" class="i">+    /// Followers may accept a set of log entries from a leader.
</a><a href="#h12-0-92" id="h12-0-92" class="i">+    AcceptEntries {
</a><a href="#h12-0-93" id="h12-0-93" class="i">+        /// The index of the last log entry.
</a><a href="#h12-0-94" id="h12-0-94" class="i">+        last_index: u64,
</a><a href="#h12-0-95" id="h12-0-95" class="i">+    },
</a><a href="#h12-0-96" id="h12-0-96" class="i">+    /// Followers may also reject a set of log entries from a leader.
</a><a href="#h12-0-97" id="h12-0-97" class="i">+    RejectEntries,
</a><a href="#h12-0-98" id="h12-0-98" class="i">+    /// Queries the state machine.
</a><a href="#h12-0-99" id="h12-0-99" class="i">+    QueryState {
</a><a href="#h12-0-100" id="h12-0-100" class="i">+        /// The call ID.
</a><a href="#h12-0-101" id="h12-0-101" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h12-0-102" id="h12-0-102" class="i">+        /// The state machine command.
</a><a href="#h12-0-103" id="h12-0-103" class="i">+        command: Vec&lt;u8&gt;,
</a><a href="#h12-0-104" id="h12-0-104" class="i">+    },
</a><a href="#h12-0-105" id="h12-0-105" class="i">+    /// Mutates the state machine.
</a><a href="#h12-0-106" id="h12-0-106" class="i">+    MutateState {
</a><a href="#h12-0-107" id="h12-0-107" class="i">+        /// The call ID.
</a><a href="#h12-0-108" id="h12-0-108" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h12-0-109" id="h12-0-109" class="i">+        /// The state machine command.
</a><a href="#h12-0-110" id="h12-0-110" class="i">+        command: Vec&lt;u8&gt;,
</a><a href="#h12-0-111" id="h12-0-111" class="i">+    },
</a><a href="#h12-0-112" id="h12-0-112" class="i">+    /// The response of a state machine command.
</a><a href="#h12-0-113" id="h12-0-113" class="i">+    RespondState {
</a><a href="#h12-0-114" id="h12-0-114" class="i">+        /// The call ID.
</a><a href="#h12-0-115" id="h12-0-115" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h12-0-116" id="h12-0-116" class="i">+        /// The command output.
</a><a href="#h12-0-117" id="h12-0-117" class="i">+        response: Vec&lt;u8&gt;,
</a><a href="#h12-0-118" id="h12-0-118" class="i">+    },
</a><a href="#h12-0-119" id="h12-0-119" class="i">+    /// An error response
</a><a href="#h12-0-120" id="h12-0-120" class="i">+    RespondError {
</a><a href="#h12-0-121" id="h12-0-121" class="i">+        /// The call ID.
</a><a href="#h12-0-122" id="h12-0-122" class="i">+        call_id: Vec&lt;u8&gt;,
</a><a href="#h12-0-123" id="h12-0-123" class="i">+        /// The error.
</a><a href="#h12-0-124" id="h12-0-124" class="i">+        error: Error,
</a><a href="#h12-0-125" id="h12-0-125" class="i">+    },
</a><a href="#h12-0-126" id="h12-0-126" class="i">+}
</a><a href="#h12-0-127" id="h12-0-127" class="i">+
</a><a href="#h12-0-128" id="h12-0-128" class="i">+impl Event {
</a><a href="#h12-0-129" id="h12-0-129" class="i">+    /// Returns the call ID for the event, if any
</a><a href="#h12-0-130" id="h12-0-130" class="i">+    pub fn call_id(&amp;self) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h12-0-131" id="h12-0-131" class="i">+        match self {
</a><a href="#h12-0-132" id="h12-0-132" class="i">+            Event::QueryState { call_id, .. }
</a><a href="#h12-0-133" id="h12-0-133" class="i">+            | Event::MutateState { call_id, .. }
</a><a href="#h12-0-134" id="h12-0-134" class="i">+            | Event::RespondState { call_id, .. }
</a><a href="#h12-0-135" id="h12-0-135" class="i">+            | Event::RespondError { call_id, .. } =&gt; Some(call_id.clone()),
</a><a href="#h12-0-136" id="h12-0-136" class="i">+            _ =&gt; None,
</a><a href="#h12-0-137" id="h12-0-137" class="i">+        }
</a><a href="#h12-0-138" id="h12-0-138" class="i">+    }
</a><a href="#h12-0-139" id="h12-0-139" class="i">+}
</a><a href="#h12-0-140" id="h12-0-140" class="i">+
</a><a href="#h12-0-141" id="h12-0-141" class="i">+#[cfg(test)]
</a><a href="#h12-0-142" id="h12-0-142" class="i">+mod tests {
</a><a href="#h12-0-143" id="h12-0-143" class="i">+    use super::*;
</a><a href="#h12-0-144" id="h12-0-144" class="i">+
</a><a href="#h12-0-145" id="h12-0-145" class="i">+    #[test]
</a><a href="#h12-0-146" id="h12-0-146" class="i">+    fn normalize() {
</a><a href="#h12-0-147" id="h12-0-147" class="i">+        let mut msg = Message {
</a><a href="#h12-0-148" id="h12-0-148" class="i">+            from: None,
</a><a href="#h12-0-149" id="h12-0-149" class="i">+            to: None,
</a><a href="#h12-0-150" id="h12-0-150" class="i">+            term: 0,
</a><a href="#h12-0-151" id="h12-0-151" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h12-0-152" id="h12-0-152" class="i">+        };
</a><a href="#h12-0-153" id="h12-0-153" class="i">+        msg.normalize(&quot;to&quot;, 3);
</a><a href="#h12-0-154" id="h12-0-154" class="i">+        assert_eq!(
</a><a href="#h12-0-155" id="h12-0-155" class="i">+            msg,
</a><a href="#h12-0-156" id="h12-0-156" class="i">+            Message {
</a><a href="#h12-0-157" id="h12-0-157" class="i">+                from: None,
</a><a href="#h12-0-158" id="h12-0-158" class="i">+                to: Some(&quot;to&quot;.into()),
</a><a href="#h12-0-159" id="h12-0-159" class="i">+                term: 3,
</a><a href="#h12-0-160" id="h12-0-160" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h12-0-161" id="h12-0-161" class="i">+            }
</a><a href="#h12-0-162" id="h12-0-162" class="i">+        )
</a><a href="#h12-0-163" id="h12-0-163" class="i">+    }
</a><a href="#h12-0-164" id="h12-0-164" class="i">+
</a><a href="#h12-0-165" id="h12-0-165" class="i">+    #[test]
</a><a href="#h12-0-166" id="h12-0-166" class="i">+    fn normalize_peer() {
</a><a href="#h12-0-167" id="h12-0-167" class="i">+        let mut msg = Message {
</a><a href="#h12-0-168" id="h12-0-168" class="i">+            from: Some(&quot;from&quot;.into()),
</a><a href="#h12-0-169" id="h12-0-169" class="i">+            to: Some(&quot;to&quot;.into()),
</a><a href="#h12-0-170" id="h12-0-170" class="i">+            term: 3,
</a><a href="#h12-0-171" id="h12-0-171" class="i">+            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h12-0-172" id="h12-0-172" class="i">+        };
</a><a href="#h12-0-173" id="h12-0-173" class="i">+        msg.normalize(&quot;other&quot;, 7);
</a><a href="#h12-0-174" id="h12-0-174" class="i">+        assert_eq!(
</a><a href="#h12-0-175" id="h12-0-175" class="i">+            msg,
</a><a href="#h12-0-176" id="h12-0-176" class="i">+            Message {
</a><a href="#h12-0-177" id="h12-0-177" class="i">+                from: Some(&quot;from&quot;.into()),
</a><a href="#h12-0-178" id="h12-0-178" class="i">+                to: Some(&quot;to&quot;.into()),
</a><a href="#h12-0-179" id="h12-0-179" class="i">+                term: 3,
</a><a href="#h12-0-180" id="h12-0-180" class="i">+                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h12-0-181" id="h12-0-181" class="i">+            }
</a><a href="#h12-0-182" id="h12-0-182" class="i">+        )
</a><a href="#h12-0-183" id="h12-0-183" class="i">+    }
</a><a href="#h12-0-184" id="h12-0-184" class="i">+
</a><a href="#h12-0-185" id="h12-0-185" class="i">+    #[test]
</a><a href="#h12-0-186" id="h12-0-186" class="i">+    fn validate() {
</a><a href="#h12-0-187" id="h12-0-187" class="i">+        let event = Event::Heartbeat { commit_index: 1, commit_term: 1 };
</a><a href="#h12-0-188" id="h12-0-188" class="i">+
</a><a href="#h12-0-189" id="h12-0-189" class="i">+        // Errors on stale term
</a><a href="#h12-0-190" id="h12-0-190" class="i">+        assert!(Message {
</a><a href="#h12-0-191" id="h12-0-191" class="i">+            from: Some(&quot;b&quot;.into()),
</a><a href="#h12-0-192" id="h12-0-192" class="i">+            to: Some(&quot;a&quot;.into()),
</a><a href="#h12-0-193" id="h12-0-193" class="i">+            term: 2,
</a><a href="#h12-0-194" id="h12-0-194" class="i">+            event: event.clone(),
</a><a href="#h12-0-195" id="h12-0-195" class="i">+        }
</a><a href="#h12-0-196" id="h12-0-196" class="i">+        .validate(&quot;a&quot;, 3)
</a><a href="#h12-0-197" id="h12-0-197" class="i">+        .is_err());
</a><a href="#h12-0-198" id="h12-0-198" class="i">+
</a><a href="#h12-0-199" id="h12-0-199" class="i">+        // Errors on no receiver
</a><a href="#h12-0-200" id="h12-0-200" class="i">+        assert!(Message { from: Some(&quot;b&quot;.into()), to: None, term: 3, event: event.clone() }
</a><a href="#h12-0-201" id="h12-0-201" class="i">+            .validate(&quot;a&quot;, 3)
</a><a href="#h12-0-202" id="h12-0-202" class="i">+            .is_err());
</a><a href="#h12-0-203" id="h12-0-203" class="i">+
</a><a href="#h12-0-204" id="h12-0-204" class="i">+        // Errors on other receiver
</a><a href="#h12-0-205" id="h12-0-205" class="i">+        assert!(Message { from: Some(&quot;b&quot;.into()), to: Some(&quot;c&quot;.into()), term: 3, event: event }
</a><a href="#h12-0-206" id="h12-0-206" class="i">+            .validate(&quot;a&quot;, 3)
</a><a href="#h12-0-207" id="h12-0-207" class="i">+            .is_err());
</a><a href="#h12-0-208" id="h12-0-208" class="i">+    }
</a><a href="#h12-0-209" id="h12-0-209" class="i">+}
</a><b>diff --git a/<a id="h13" href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a> b/<a href="../file/src/raft/mod.rs.html">src/raft/mod.rs</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -1,205 +1,13 @@
</a><a href="#h13-0-0" id="h13-0-0" class="i">+mod client;
</a> mod log;
<a href="#h13-0-2" id="h13-0-2" class="i">+mod message;
</a> mod node;
<a href="#h13-0-4" id="h13-0-4" class="d">-mod transport;
</a><a href="#h13-0-5" id="h13-0-5" class="d">-
</a><a href="#h13-0-6" id="h13-0-6" class="d">-pub use self::log::Entry;
</a><a href="#h13-0-7" id="h13-0-7" class="d">-pub use self::transport::{Event, Message, Transport};
</a><a href="#h13-0-8" id="h13-0-8" class="d">-
</a><a href="#h13-0-9" id="h13-0-9" class="d">-use crate::kv;
</a><a href="#h13-0-10" id="h13-0-10" class="d">-use crate::Error;
</a><a href="#h13-0-11" id="h13-0-11" class="d">-use crossbeam::channel::{Receiver, Sender};
</a><a href="#h13-0-12" id="h13-0-12" class="d">-use node::Node;
</a><a href="#h13-0-13" id="h13-0-13" class="d">-use std::collections::HashMap;
</a><a href="#h13-0-14" id="h13-0-14" class="d">-use uuid::Uuid;
</a><a href="#h13-0-15" id="h13-0-15" class="d">-
</a><a href="#h13-0-16" id="h13-0-16" class="d">-/// The duration of a Raft tick, which is the unit of time for e.g.
</a><a href="#h13-0-17" id="h13-0-17" class="d">-/// heartbeat intervals and election timeouts.
</a><a href="#h13-0-18" id="h13-0-18" class="d">-const TICK: std::time::Duration = std::time::Duration::from_millis(100);
</a><a href="#h13-0-19" id="h13-0-19" class="d">-
</a><a href="#h13-0-20" id="h13-0-20" class="d">-/// A Raft-managed state machine.
</a><a href="#h13-0-21" id="h13-0-21" class="d">-pub trait State {
</a><a href="#h13-0-22" id="h13-0-22" class="d">-    /// Mutates the state machine. If the state machine returns Error::Internal, the Raft node
</a><a href="#h13-0-23" id="h13-0-23" class="d">-    /// halts. For any other error, the state is applied and the error propagated to the caller.
</a><a href="#h13-0-24" id="h13-0-24" class="d">-    fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h13-0-25" id="h13-0-25" class="d">-
</a><a href="#h13-0-26" id="h13-0-26" class="d">-    /// Queries the state machine. All errors are propagated to the caller.
</a><a href="#h13-0-27" id="h13-0-27" class="d">-    fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h13-0-28" id="h13-0-28" class="d">-}
</a><a href="#h13-0-29" id="h13-0-29" class="d">-
</a><a href="#h13-0-30" id="h13-0-30" class="d">-/// A Raft state machine representing an entire Raft cluster.
</a><a href="#h13-0-31" id="h13-0-31" class="d">-#[derive(Clone)]
</a><a href="#h13-0-32" id="h13-0-32" class="d">-pub struct Raft {
</a><a href="#h13-0-33" id="h13-0-33" class="d">-    call_tx: Sender&lt;(Event, Sender&lt;Event&gt;)&gt;,
</a><a href="#h13-0-34" id="h13-0-34" class="d">-    join_rx: Receiver&lt;Result&lt;(), Error&gt;&gt;,
</a><a href="#h13-0-35" id="h13-0-35" class="d">-    shutdown_tx: Sender&lt;()&gt;,
</a><a href="#h13-0-36" id="h13-0-36" class="d">-}
</a><a href="#h13-0-37" id="h13-0-37" class="d">-
</a><a href="#h13-0-38" id="h13-0-38" class="d">-impl Raft {
</a><a href="#h13-0-39" id="h13-0-39" class="d">-    /// Starts a new Raft state machine in a separate thread.
</a><a href="#h13-0-40" id="h13-0-40" class="d">-    pub fn start&lt;S, L, T&gt;(
</a><a href="#h13-0-41" id="h13-0-41" class="d">-        id: &amp;str,
</a><a href="#h13-0-42" id="h13-0-42" class="d">-        peers: Vec&lt;String&gt;,
</a><a href="#h13-0-43" id="h13-0-43" class="d">-        state: S,
</a><a href="#h13-0-44" id="h13-0-44" class="d">-        store: kv::Simple&lt;L&gt;,
</a><a href="#h13-0-45" id="h13-0-45" class="d">-        transport: T,
</a><a href="#h13-0-46" id="h13-0-46" class="d">-    ) -&gt; Result&lt;Raft, Error&gt;
</a><a href="#h13-0-47" id="h13-0-47" class="d">-    where
</a><a href="#h13-0-48" id="h13-0-48" class="d">-        S: State + &#39;static + Send,
</a><a href="#h13-0-49" id="h13-0-49" class="d">-        L: kv::storage::Storage + &#39;static + Send,
</a><a href="#h13-0-50" id="h13-0-50" class="d">-        T: Transport + &#39;static + Send,
</a><a href="#h13-0-51" id="h13-0-51" class="d">-    {
</a><a href="#h13-0-52" id="h13-0-52" class="d">-        let ticker = crossbeam::channel::tick(TICK);
</a><a href="#h13-0-53" id="h13-0-53" class="d">-        let inbound_rx = transport.receiver();
</a><a href="#h13-0-54" id="h13-0-54" class="d">-        let (outbound_tx, outbound_rx) = crossbeam::channel::unbounded();
</a><a href="#h13-0-55" id="h13-0-55" class="d">-        let (call_tx, call_rx) = crossbeam::channel::unbounded::&lt;(Event, Sender&lt;Event&gt;)&gt;();
</a><a href="#h13-0-56" id="h13-0-56" class="d">-        let (join_tx, join_rx) = crossbeam::channel::unbounded();
</a><a href="#h13-0-57" id="h13-0-57" class="d">-        let (shutdown_tx, shutdown_rx) = crossbeam::channel::unbounded();
</a><a href="#h13-0-58" id="h13-0-58" class="d">-        let mut response_txs: HashMap&lt;Vec&lt;u8&gt;, Sender&lt;Event&gt;&gt; = HashMap::new();
</a><a href="#h13-0-59" id="h13-0-59" class="d">-        let mut node = Node::new(id, peers, store, state, outbound_tx)?;
</a><a href="#h13-0-60" id="h13-0-60" class="d">-
</a><a href="#h13-0-61" id="h13-0-61" class="d">-        std::thread::spawn(move || {
</a><a href="#h13-0-62" id="h13-0-62" class="d">-            // Ugly workaround to use ?, while waiting for try_blocks:
</a><a href="#h13-0-63" id="h13-0-63" class="d">-            // https://doc.rust-lang.org/unstable-book/language-features/try-blocks.html
</a><a href="#h13-0-64" id="h13-0-64" class="d">-            let result = (move || loop {
</a><a href="#h13-0-65" id="h13-0-65" class="d">-                select! {
</a><a href="#h13-0-66" id="h13-0-66" class="d">-                    // Handle ticks
</a><a href="#h13-0-67" id="h13-0-67" class="d">-                    recv(ticker) -&gt; _ =&gt; node = node.tick()?,
</a><a href="#h13-0-68" id="h13-0-68" class="d">-
</a><a href="#h13-0-69" id="h13-0-69" class="d">-                    // Handle shutdown
</a><a href="#h13-0-70" id="h13-0-70" class="d">-                    recv(shutdown_rx) -&gt; _ =&gt; return Ok(()),
</a><a href="#h13-0-71" id="h13-0-71" class="d">-
</a><a href="#h13-0-72" id="h13-0-72" class="d">-                    // Handle local method calls
</a><a href="#h13-0-73" id="h13-0-73" class="d">-                    recv(call_rx) -&gt; recv =&gt; {
</a><a href="#h13-0-74" id="h13-0-74" class="d">-                        let (event, response_tx) = recv?;
</a><a href="#h13-0-75" id="h13-0-75" class="d">-                        if let Some(call_id) = event.call_id() {
</a><a href="#h13-0-76" id="h13-0-76" class="d">-                            response_txs.insert(call_id, response_tx);
</a><a href="#h13-0-77" id="h13-0-77" class="d">-                            node = node.step(Message{from: None, to: None, term: 0, event})?;
</a><a href="#h13-0-78" id="h13-0-78" class="d">-                        } else {
</a><a href="#h13-0-79" id="h13-0-79" class="d">-                            response_tx.send(Event::RespondError{
</a><a href="#h13-0-80" id="h13-0-80" class="d">-                                call_id: vec![],
</a><a href="#h13-0-81" id="h13-0-81" class="d">-                                error: Error::Internal(format!(&quot;Call ID not found for event {:?}&quot;, event)),
</a><a href="#h13-0-82" id="h13-0-82" class="d">-                            })?;
</a><a href="#h13-0-83" id="h13-0-83" class="d">-                        }
</a><a href="#h13-0-84" id="h13-0-84" class="d">-                    },
</a><a href="#h13-0-85" id="h13-0-85" class="d">-
</a><a href="#h13-0-86" id="h13-0-86" class="d">-                    // Handle inbound messages from peers
</a><a href="#h13-0-87" id="h13-0-87" class="d">-                    recv(inbound_rx) -&gt; recv =&gt; node = node.step(recv?)?,
</a><a href="#h13-0-88" id="h13-0-88" class="d">-
</a><a href="#h13-0-89" id="h13-0-89" class="d">-                    // Handle outbound messages from node, either to peers or a local method caller
</a><a href="#h13-0-90" id="h13-0-90" class="d">-                    recv(outbound_rx) -&gt; recv =&gt; {
</a><a href="#h13-0-91" id="h13-0-91" class="d">-                        let msg = recv?;
</a><a href="#h13-0-92" id="h13-0-92" class="d">-                        if msg.to.is_some() {
</a><a href="#h13-0-93" id="h13-0-93" class="d">-                            transport.send(msg)?
</a><a href="#h13-0-94" id="h13-0-94" class="d">-                        } else if let Some(call_id) = msg.event.call_id() {
</a><a href="#h13-0-95" id="h13-0-95" class="d">-                            if let Some(response_tx) = response_txs.get(&amp;call_id) {
</a><a href="#h13-0-96" id="h13-0-96" class="d">-                                response_tx.send(msg.event)?;
</a><a href="#h13-0-97" id="h13-0-97" class="d">-                            }
</a><a href="#h13-0-98" id="h13-0-98" class="d">-                        }
</a><a href="#h13-0-99" id="h13-0-99" class="d">-                    },
</a><a href="#h13-0-100" id="h13-0-100" class="d">-                }
</a><a href="#h13-0-101" id="h13-0-101" class="d">-            })();
</a><a href="#h13-0-102" id="h13-0-102" class="d">-            join_tx.send(result).ok()
</a><a href="#h13-0-103" id="h13-0-103" class="d">-        });
</a><a href="#h13-0-104" id="h13-0-104" class="d">-
</a><a href="#h13-0-105" id="h13-0-105" class="d">-        Ok(Raft { call_tx, join_rx, shutdown_tx })
</a><a href="#h13-0-106" id="h13-0-106" class="d">-    }
</a><a href="#h13-0-107" id="h13-0-107" class="d">-
</a><a href="#h13-0-108" id="h13-0-108" class="d">-    /// Waits for the Raft node to complete
</a><a href="#h13-0-109" id="h13-0-109" class="d">-    pub fn join(&amp;self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h13-0-110" id="h13-0-110" class="d">-        self.join_rx.recv()?
</a><a href="#h13-0-111" id="h13-0-111" class="d">-    }
</a><a href="#h13-0-112" id="h13-0-112" class="d">-
</a><a href="#h13-0-113" id="h13-0-113" class="d">-    /// Shuts down the server.
</a><a href="#h13-0-114" id="h13-0-114" class="d">-    pub fn shutdown(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h13-0-115" id="h13-0-115" class="d">-        self.shutdown_tx.send(())?;
</a><a href="#h13-0-116" id="h13-0-116" class="d">-        self.join()
</a><a href="#h13-0-117" id="h13-0-117" class="d">-    }
</a><a href="#h13-0-118" id="h13-0-118" class="d">-
</a><a href="#h13-0-119" id="h13-0-119" class="d">-    /// Runs a synchronous client call on the Raft cluster
</a><a href="#h13-0-120" id="h13-0-120" class="d">-    fn call(&amp;self, event: Event) -&gt; Result&lt;Event, Error&gt; {
</a><a href="#h13-0-121" id="h13-0-121" class="d">-        let (response_tx, response_rx) = crossbeam::channel::unbounded();
</a><a href="#h13-0-122" id="h13-0-122" class="d">-        self.call_tx.send((event, response_tx))?;
</a><a href="#h13-0-123" id="h13-0-123" class="d">-        match response_rx.recv()? {
</a><a href="#h13-0-124" id="h13-0-124" class="d">-            Event::RespondError { error, .. } =&gt; Err(error),
</a><a href="#h13-0-125" id="h13-0-125" class="d">-            e =&gt; Ok(e),
</a><a href="#h13-0-126" id="h13-0-126" class="d">-        }
</a><a href="#h13-0-127" id="h13-0-127" class="d">-    }
</a><a href="#h13-0-128" id="h13-0-128" class="d">-
</a><a href="#h13-0-129" id="h13-0-129" class="d">-    /// Generates a call ID
</a><a href="#h13-0-130" id="h13-0-130" class="d">-    fn call_id() -&gt; Vec&lt;u8&gt; {
</a><a href="#h13-0-131" id="h13-0-131" class="d">-        Uuid::new_v4().as_bytes().to_vec()
</a><a href="#h13-0-132" id="h13-0-132" class="d">-    }
</a><a href="#h13-0-133" id="h13-0-133" class="d">-
</a><a href="#h13-0-134" id="h13-0-134" class="d">-    /// Mutates the Raft state machine.
</a><a href="#h13-0-135" id="h13-0-135" class="d">-    pub fn mutate(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h13-0-136" id="h13-0-136" class="d">-        match self.call(Event::MutateState { call_id: Self::call_id(), command })? {
</a><a href="#h13-0-137" id="h13-0-137" class="d">-            Event::RespondState { response, .. } =&gt; Ok(response),
</a><a href="#h13-0-138" id="h13-0-138" class="d">-            event =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft mutate response {:?}&quot;, event))),
</a><a href="#h13-0-139" id="h13-0-139" class="d">-        }
</a><a href="#h13-0-140" id="h13-0-140" class="d">-    }
</a><a href="#h13-0-141" id="h13-0-141" class="d">-
</a><a href="#h13-0-142" id="h13-0-142" class="d">-    /// Queries the Raft state machine.
</a><a href="#h13-0-143" id="h13-0-143" class="d">-    pub fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h13-0-144" id="h13-0-144" class="d">-        match self.call(Event::QueryState { call_id: Self::call_id(), command })? {
</a><a href="#h13-0-145" id="h13-0-145" class="d">-            Event::RespondState { response, .. } =&gt; Ok(response),
</a><a href="#h13-0-146" id="h13-0-146" class="d">-            event =&gt; Err(Error::Internal(format!(&quot;Unexpected Raft read response {:?}&quot;, event))),
</a><a href="#h13-0-147" id="h13-0-147" class="d">-        }
</a><a href="#h13-0-148" id="h13-0-148" class="d">-    }
</a><a href="#h13-0-149" id="h13-0-149" class="d">-}
</a><a href="#h13-0-150" id="h13-0-150" class="d">-
</a><a href="#h13-0-151" id="h13-0-151" class="d">-#[cfg(test)]
</a><a href="#h13-0-152" id="h13-0-152" class="d">-pub mod tests {
</a><a href="#h13-0-153" id="h13-0-153" class="d">-    use super::*;
</a><a href="#h13-0-154" id="h13-0-154" class="d">-    use crossbeam::channel::Receiver;
</a><a href="#h13-0-155" id="h13-0-155" class="d">-    use std::sync::{Arc, Mutex};
</a><a href="#h13-0-156" id="h13-0-156" class="d">-
</a><a href="#h13-0-157" id="h13-0-157" class="d">-    #[derive(Clone, Debug)]
</a><a href="#h13-0-158" id="h13-0-158" class="d">-    pub struct TestState {
</a><a href="#h13-0-159" id="h13-0-159" class="d">-        commands: Arc&lt;Mutex&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h13-0-160" id="h13-0-160" class="d">-    }
</a><a href="#h13-0-161" id="h13-0-161" class="d">-
</a><a href="#h13-0-162" id="h13-0-162" class="d">-    impl TestState {
</a><a href="#h13-0-163" id="h13-0-163" class="d">-        pub fn new() -&gt; Self {
</a><a href="#h13-0-164" id="h13-0-164" class="d">-            Self { commands: Arc::new(Mutex::new(Vec::new())) }
</a><a href="#h13-0-165" id="h13-0-165" class="d">-        }
</a><a href="#h13-0-166" id="h13-0-166" class="d">-
</a><a href="#h13-0-167" id="h13-0-167" class="d">-        pub fn list(&amp;self) -&gt; Vec&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h13-0-168" id="h13-0-168" class="d">-            self.commands.lock().unwrap().clone()
</a><a href="#h13-0-169" id="h13-0-169" class="d">-        }
</a><a href="#h13-0-170" id="h13-0-170" class="d">-    }
</a><a href="#h13-0-171" id="h13-0-171" class="d">-
</a><a href="#h13-0-172" id="h13-0-172" class="d">-    impl State for TestState {
</a><a href="#h13-0-173" id="h13-0-173" class="d">-        // Appends the command to the internal commands list, and returns the command prefixed with
</a><a href="#h13-0-174" id="h13-0-174" class="d">-        // a 0xff byte. Returns Error::Internal if the payload is != 1 byte, and Error::Value if
</a><a href="#h13-0-175" id="h13-0-175" class="d">-        // the value is 0xff.
</a><a href="#h13-0-176" id="h13-0-176" class="d">-        fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h13-0-177" id="h13-0-177" class="d">-            if command.len() != 1 {
</a><a href="#h13-0-178" id="h13-0-178" class="d">-                return Err(Error::Internal(&quot;Command must be 1 byte&quot;.into()));
</a><a href="#h13-0-179" id="h13-0-179" class="d">-            }
</a><a href="#h13-0-180" id="h13-0-180" class="d">-            if command[0] == 0xff {
</a><a href="#h13-0-181" id="h13-0-181" class="d">-                return Err(Error::Value(&quot;Command cannot be 0xff&quot;.into()));
</a><a href="#h13-0-182" id="h13-0-182" class="d">-            }
</a><a href="#h13-0-183" id="h13-0-183" class="d">-            self.commands.lock()?.push(command.clone());
</a><a href="#h13-0-184" id="h13-0-184" class="d">-            Ok(vec![0xff, command[0]])
</a><a href="#h13-0-185" id="h13-0-185" class="d">-        }
</a><a href="#h13-0-186" id="h13-0-186" class="d">-
</a><a href="#h13-0-187" id="h13-0-187" class="d">-        // Reads the command in the internal commands list at the index
</a><a href="#h13-0-188" id="h13-0-188" class="d">-        // given by the query command (1-based). Returns the stored command prefixed by
</a><a href="#h13-0-189" id="h13-0-189" class="d">-        // 0xbb, or 0xbb 0x00 if not found.
</a><a href="#h13-0-190" id="h13-0-190" class="d">-        fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h13-0-191" id="h13-0-191" class="d">-            if command.len() != 1 {
</a><a href="#h13-0-192" id="h13-0-192" class="d">-                return Err(Error::Value(&quot;Query payload must be 1 byte&quot;.into()));
</a><a href="#h13-0-193" id="h13-0-193" class="d">-            }
</a><a href="#h13-0-194" id="h13-0-194" class="d">-            let index = command[0] as usize;
</a><a href="#h13-0-195" id="h13-0-195" class="d">-            Ok(vec![0xbb, self.commands.lock()?.get(index - 1).map(|c| c[0]).unwrap_or(0x00)])
</a><a href="#h13-0-196" id="h13-0-196" class="d">-        }
</a><a href="#h13-0-197" id="h13-0-197" class="d">-    }
</a><a href="#h13-0-198" id="h13-0-198" class="d">-
</a><a href="#h13-0-199" id="h13-0-199" class="d">-    pub fn assert_messages(rx: &amp;Receiver&lt;Message&gt;, msgs: Vec&lt;Message&gt;) {
</a><a href="#h13-0-200" id="h13-0-200" class="d">-        let mut actual = Vec::new();
</a><a href="#h13-0-201" id="h13-0-201" class="d">-        while !rx.is_empty() {
</a><a href="#h13-0-202" id="h13-0-202" class="d">-            actual.push(rx.recv().unwrap());
</a><a href="#h13-0-203" id="h13-0-203" class="d">-        }
</a><a href="#h13-0-204" id="h13-0-204" class="d">-        assert_eq!(msgs, actual);
</a><a href="#h13-0-205" id="h13-0-205" class="d">-    }
</a><a href="#h13-0-206" id="h13-0-206" class="d">-}
</a><a href="#h13-0-207" id="h13-0-207" class="i">+mod server;
</a><a href="#h13-0-208" id="h13-0-208" class="i">+mod state;
</a><a href="#h13-0-209" id="h13-0-209" class="i">+
</a><a href="#h13-0-210" id="h13-0-210" class="i">+pub use self::log::{Entry, Log};
</a><a href="#h13-0-211" id="h13-0-211" class="i">+pub use client::{Client, Request, Response};
</a><a href="#h13-0-212" id="h13-0-212" class="i">+pub use message::{Event, Message};
</a><a href="#h13-0-213" id="h13-0-213" class="i">+pub use node::{Node, Status};
</a><a href="#h13-0-214" id="h13-0-214" class="i">+pub use server::Server;
</a><a href="#h13-0-215" id="h13-0-215" class="i">+pub use state::State;
</a><b>diff --git a/<a id="h14" href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a> b/<a href="../file/src/raft/node/candidate.rs.html">src/raft/node/candidate.rs</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,5 +1,9 @@
</a><a href="#h14-0-0" id="h14-0-0" class="d">-use super::*;
</a><a href="#h14-0-1" id="h14-0-1" class="d">-use rand::Rng;
</a><a href="#h14-0-2" id="h14-0-2" class="i">+use super::super::{Event, Message, State};
</a><a href="#h14-0-3" id="h14-0-3" class="i">+use super::{Follower, Leader, Node, RoleNode, ELECTION_TIMEOUT_MAX, ELECTION_TIMEOUT_MIN};
</a><a href="#h14-0-4" id="h14-0-4" class="i">+use crate::kv::storage::Storage;
</a><a href="#h14-0-5" id="h14-0-5" class="i">+use crate::Error;
</a><a href="#h14-0-6" id="h14-0-6" class="i">+
</a><a href="#h14-0-7" id="h14-0-7" class="i">+use rand::Rng as _;
</a> 
 /// A candidate is campaigning to become a leader.
 #[derive(Debug)]
<a href="#h14-1" id="h14-1" class="h">@@ -25,7 +29,7 @@ impl Candidate {
</a>     }
 }
 
<a href="#h14-1-3" id="h14-1-3" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Candidate, L, S&gt; {
</a><a href="#h14-1-4" id="h14-1-4" class="i">+impl&lt;L: Storage, S: State&gt; RoleNode&lt;Candidate, L, S&gt; {
</a>     /// Transition to follower role.
     fn become_follower(
         mut self,
<a href="#h14-2" id="h14-2" class="h">@@ -105,17 +109,20 @@ impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Candidate, L, S&gt; {
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h14-2-3" id="h14-2-3" class="i">+    use super::super::super::{Entry, Log};
</a>     use super::super::tests::{assert_messages, assert_node, TestState};
     use super::*;
<a href="#h14-2-6" id="h14-2-6" class="d">-    use crossbeam::channel::Receiver;
</a><a href="#h14-2-7" id="h14-2-7" class="i">+    use crate::kv;
</a><a href="#h14-2-8" id="h14-2-8" class="i">+    use tokio::sync::mpsc;
</a> 
     #[allow(clippy::type_complexity)]
<a href="#h14-2-11" id="h14-2-11" class="d">-    fn setup(
</a><a href="#h14-2-12" id="h14-2-12" class="d">-    ) -&gt; Result&lt;(RoleNode&lt;Candidate, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt;
</a><a href="#h14-2-13" id="h14-2-13" class="d">-    {
</a><a href="#h14-2-14" id="h14-2-14" class="d">-        let (sender, receiver) = crossbeam::channel::unbounded();
</a><a href="#h14-2-15" id="h14-2-15" class="i">+    fn setup() -&gt; Result&lt;
</a><a href="#h14-2-16" id="h14-2-16" class="i">+        (RoleNode&lt;Candidate, kv::storage::Test, TestState&gt;, mpsc::UnboundedReceiver&lt;Message&gt;),
</a><a href="#h14-2-17" id="h14-2-17" class="i">+        Error,
</a><a href="#h14-2-18" id="h14-2-18" class="i">+    &gt; {
</a><a href="#h14-2-19" id="h14-2-19" class="i">+        let (sender, receiver) = mpsc::unbounded_channel();
</a>         let mut state = TestState::new();
<a href="#h14-2-21" id="h14-2-21" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h14-2-22" id="h14-2-22" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Test::new()))?;
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
         log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
         log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
<a href="#h14-3" id="h14-3" class="h">@@ -138,7 +145,7 @@ mod tests {
</a>     #[test]
     // Heartbeat for current term converts to follower and emits ConfirmLeader event
     fn step_heartbeat_current_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h14-3-3" id="h14-3-3" class="d">-        let (candidate, rx) = setup()?;
</a><a href="#h14-3-4" id="h14-3-4" class="i">+        let (candidate, mut rx) = setup()?;
</a>         let node = candidate.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h14-4" id="h14-4" class="h">@@ -147,7 +154,7 @@ mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(3);
         assert_messages(
<a href="#h14-4-3" id="h14-4-3" class="d">-            &amp;rx,
</a><a href="#h14-4-4" id="h14-4-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h14-5" id="h14-5" class="h">@@ -161,7 +168,7 @@ mod tests {
</a>     #[test]
     // Heartbeat for future term converts to follower and emits ConfirmLeader event
     fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h14-5-3" id="h14-5-3" class="d">-        let (candidate, rx) = setup()?;
</a><a href="#h14-5-4" id="h14-5-4" class="i">+        let (candidate, mut rx) = setup()?;
</a>         let node = candidate.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h14-6" id="h14-6" class="h">@@ -170,7 +177,7 @@ mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(4);
         assert_messages(
<a href="#h14-6-3" id="h14-6-3" class="d">-            &amp;rx,
</a><a href="#h14-6-4" id="h14-6-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h14-7" id="h14-7" class="h">@@ -184,7 +191,7 @@ mod tests {
</a>     #[test]
     // Heartbeat for past term is ignored
     fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h14-7-3" id="h14-7-3" class="d">-        let (candidate, rx) = setup()?;
</a><a href="#h14-7-4" id="h14-7-4" class="i">+        let (candidate, mut rx) = setup()?;
</a>         let node = candidate.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h14-8" id="h14-8" class="h">@@ -192,13 +199,13 @@ mod tests {
</a>             event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
         })?;
         assert_node(&amp;node).is_candidate().term(3);
<a href="#h14-8-3" id="h14-8-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h14-8-4" id="h14-8-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     fn step_grantvote() -&gt; Result&lt;(), Error&gt; {
<a href="#h14-8-10" id="h14-8-10" class="d">-        let (candidate, rx) = setup()?;
</a><a href="#h14-8-11" id="h14-8-11" class="i">+        let (candidate, mut rx) = setup()?;
</a>         let peers = candidate.peers.clone();
         let mut node = Node::Candidate(candidate);
 
<a href="#h14-9" id="h14-9" class="h">@@ -210,7 +217,7 @@ mod tests {
</a>             event: Event::GrantVote,
         })?;
         assert_node(&amp;node).is_candidate().term(3);
<a href="#h14-9-3" id="h14-9-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h14-9-4" id="h14-9-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         // However, the second external vote makes us leader
         node = node.step(Message {
<a href="#h14-10" id="h14-10" class="h">@@ -222,9 +229,8 @@ mod tests {
</a>         assert_node(&amp;node).is_leader().term(3);
 
         for to in peers.iter().cloned() {
<a href="#h14-10-3" id="h14-10-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h14-10-5" id="h14-10-5" class="d">-                rx.recv()?,
</a><a href="#h14-10-6" id="h14-10-6" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h14-11" id="h14-11" class="h">@@ -235,9 +241,8 @@ mod tests {
</a>         }
 
         for to in peers.iter().cloned() {
<a href="#h14-11-3" id="h14-11-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h14-11-5" id="h14-11-5" class="d">-                rx.recv()?,
</a><a href="#h14-11-6" id="h14-11-6" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<a href="#h14-12" id="h14-12" class="h">@@ -251,13 +256,13 @@ mod tests {
</a>             )
         }
 
<a href="#h14-12-3" id="h14-12-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h14-12-4" id="h14-12-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     fn tick() -&gt; Result&lt;(), Error&gt; {
<a href="#h14-12-10" id="h14-12-10" class="d">-        let (candidate, rx) = setup()?;
</a><a href="#h14-12-11" id="h14-12-11" class="i">+        let (candidate, mut rx) = setup()?;
</a>         let timeout = candidate.role.election_timeout;
         let peers = candidate.peers.clone();
         let mut node = Node::Candidate(candidate);
<a href="#h14-13" id="h14-13" class="h">@@ -270,9 +275,8 @@ mod tests {
</a>         assert_node(&amp;node).is_candidate().term(4);
 
         for to in peers.into_iter() {
<a href="#h14-13-3" id="h14-13-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h14-13-5" id="h14-13-5" class="d">-                rx.recv()?,
</a><a href="#h14-13-6" id="h14-13-6" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
<b>diff --git a/<a id="h15" href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a> b/<a href="../file/src/raft/node/follower.rs.html">src/raft/node/follower.rs</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -1,12 +1,16 @@
</a><a href="#h15-0-0" id="h15-0-0" class="d">-use super::*;
</a><a href="#h15-0-1" id="h15-0-1" class="d">-use rand::Rng;
</a><a href="#h15-0-2" id="h15-0-2" class="i">+use super::super::{Event, Message, State};
</a><a href="#h15-0-3" id="h15-0-3" class="i">+use super::{Candidate, Node, RoleNode, ELECTION_TIMEOUT_MAX, ELECTION_TIMEOUT_MIN};
</a><a href="#h15-0-4" id="h15-0-4" class="i">+use crate::kv::storage::Storage;
</a><a href="#h15-0-5" id="h15-0-5" class="i">+use crate::Error;
</a><a href="#h15-0-6" id="h15-0-6" class="i">+
</a><a href="#h15-0-7" id="h15-0-7" class="i">+use rand::Rng as _;
</a> use std::collections::HashMap;
 
 // A follower replicates state from a leader.
 #[derive(Debug)]
 pub struct Follower {
     /// The leader, or None if just initialized.
<a href="#h15-0-14" id="h15-0-14" class="d">-    leader: Option&lt;String&gt;,
</a><a href="#h15-0-15" id="h15-0-15" class="i">+    pub leader: Option&lt;String&gt;,
</a>     /// The number of ticks since the last message from the leader.
     leader_seen_ticks: u64,
     /// The timeout before triggering an election.
<a href="#h15-1" id="h15-1" class="h">@@ -31,7 +35,7 @@ impl Follower {
</a>     }
 }
 
<a href="#h15-1-3" id="h15-1-3" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Follower, L, S&gt; {
</a><a href="#h15-1-4" id="h15-1-4" class="i">+impl&lt;L: Storage, S: State&gt; RoleNode&lt;Follower, L, S&gt; {
</a>     /// Transforms the node into a candidate.
     fn become_candidate(self) -&gt; Result&lt;RoleNode&lt;Candidate, L, S&gt;, Error&gt; {
         info!(&quot;Starting election for term {}&quot;, self.term + 1);
<a href="#h15-2" id="h15-2" class="h">@@ -149,17 +153,20 @@ impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Follower, L, S&gt; {
</a> 
 #[cfg(test)]
 pub mod tests {
<a href="#h15-2-3" id="h15-2-3" class="i">+    use super::super::super::{Entry, Log};
</a>     use super::super::tests::{assert_messages, assert_node, TestState};
     use super::*;
<a href="#h15-2-6" id="h15-2-6" class="d">-    use crossbeam::channel::Receiver;
</a><a href="#h15-2-7" id="h15-2-7" class="i">+    use crate::kv;
</a><a href="#h15-2-8" id="h15-2-8" class="i">+    use tokio::stream::StreamExt as _;
</a><a href="#h15-2-9" id="h15-2-9" class="i">+    use tokio::sync::mpsc::UnboundedReceiver;
</a> 
<a href="#h15-2-11" id="h15-2-11" class="d">-    pub fn follower_leader&lt;L: kv::storage::Storage, S: State&gt;(
</a><a href="#h15-2-12" id="h15-2-12" class="i">+    pub fn follower_leader&lt;L: Storage, S: State&gt;(
</a>         node: &amp;RoleNode&lt;Follower, L, S&gt;,
     ) -&gt; Option&lt;String&gt; {
         node.role.leader.clone()
     }
 
<a href="#h15-2-18" id="h15-2-18" class="d">-    pub fn follower_voted_for&lt;L: kv::storage::Storage, S: State&gt;(
</a><a href="#h15-2-19" id="h15-2-19" class="i">+    pub fn follower_voted_for&lt;L: Storage, S: State&gt;(
</a>         node: &amp;RoleNode&lt;Follower, L, S&gt;,
     ) -&gt; Option&lt;String&gt; {
         node.role.voted_for.clone()
<a href="#h15-3" id="h15-3" class="h">@@ -167,11 +174,11 @@ pub mod tests {
</a> 
     #[allow(clippy::type_complexity)]
     fn setup(
<a href="#h15-3-3" id="h15-3-3" class="d">-    ) -&gt; Result&lt;(RoleNode&lt;Follower, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt;
</a><a href="#h15-3-4" id="h15-3-4" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;Follower, kv::storage::Test, TestState&gt;, UnboundedReceiver&lt;Message&gt;), Error&gt;
</a>     {
<a href="#h15-3-6" id="h15-3-6" class="d">-        let (sender, receiver) = crossbeam::channel::unbounded();
</a><a href="#h15-3-7" id="h15-3-7" class="i">+        let (sender, receiver) = tokio::sync::mpsc::unbounded_channel();
</a>         let mut state = TestState::new();
<a href="#h15-3-9" id="h15-3-9" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h15-3-10" id="h15-3-10" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Test::new()))?;
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
         log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
         log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
<a href="#h15-4" id="h15-4" class="h">@@ -194,7 +201,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from current leader
     fn step_heartbeat() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-4-3" id="h15-4-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-4-4" id="h15-4-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-5" id="h15-5" class="h">@@ -209,7 +216,7 @@ pub mod tests {
</a>             .committed(3)
             .applied(1);
         assert_messages(
<a href="#h15-5-3" id="h15-5-3" class="d">-            &amp;rx,
</a><a href="#h15-5-4" id="h15-5-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-6" id="h15-6" class="h">@@ -223,7 +230,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from current leader with conflicting commit_term
     fn step_heartbeat_conflict_commit_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-6-3" id="h15-6-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-6-4" id="h15-6-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-7" id="h15-7" class="h">@@ -238,7 +245,7 @@ pub mod tests {
</a>             .committed(2)
             .applied(1);
         assert_messages(
<a href="#h15-7-3" id="h15-7-3" class="d">-            &amp;rx,
</a><a href="#h15-7-4" id="h15-7-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-8" id="h15-8" class="h">@@ -252,7 +259,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from current leader with a missing commit_index
     fn step_heartbeat_missing_commit_entry() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-8-3" id="h15-8-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-8-4" id="h15-8-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-9" id="h15-9" class="h">@@ -267,7 +274,7 @@ pub mod tests {
</a>             .committed(2)
             .applied(1);
         assert_messages(
<a href="#h15-9-3" id="h15-9-3" class="d">-            &amp;rx,
</a><a href="#h15-9-4" id="h15-9-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-10" id="h15-10" class="h">@@ -281,7 +288,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from fake leader
     fn step_heartbeat_fake_leader() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-10-3" id="h15-10-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-10-4" id="h15-10-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;c&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-11" id="h15-11" class="h">@@ -295,14 +302,14 @@ pub mod tests {
</a>             .voted_for(None)
             .committed(2)
             .applied(1);
<a href="#h15-11-3" id="h15-11-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-11-4" id="h15-11-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // Heartbeat when no current leader
     fn step_heartbeat_no_leader() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-11-11" id="h15-11-11" class="d">-        let (mut follower, rx) = setup()?;
</a><a href="#h15-11-12" id="h15-11-12" class="i">+        let (mut follower, mut rx) = setup()?;
</a>         follower.role = Follower::new(None, None);
         let node = follower.step(Message {
             from: Some(&quot;c&quot;.into()),
<a href="#h15-12" id="h15-12" class="h">@@ -318,7 +325,7 @@ pub mod tests {
</a>             .committed(3)
             .applied(1);
         assert_messages(
<a href="#h15-12-3" id="h15-12-3" class="d">-            &amp;rx,
</a><a href="#h15-12-4" id="h15-12-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;c&quot;.into()),
<a href="#h15-13" id="h15-13" class="h">@@ -332,7 +339,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from current leader with old commit_index
     fn step_heartbeat_old_commit_index() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-13-3" id="h15-13-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-13-4" id="h15-13-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-14" id="h15-14" class="h">@@ -347,7 +354,7 @@ pub mod tests {
</a>             .committed(2)
             .applied(1);
         assert_messages(
<a href="#h15-14-3" id="h15-14-3" class="d">-            &amp;rx,
</a><a href="#h15-14-4" id="h15-14-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-15" id="h15-15" class="h">@@ -361,7 +368,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat for future term with other leader changes leader
     fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-15-3" id="h15-15-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-15-4" id="h15-15-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;c&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-16" id="h15-16" class="h">@@ -370,7 +377,7 @@ pub mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;c&quot;)).voted_for(None);
         assert_messages(
<a href="#h15-16-3" id="h15-16-3" class="d">-            &amp;rx,
</a><a href="#h15-16-4" id="h15-16-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;c&quot;.into()),
<a href="#h15-17" id="h15-17" class="h">@@ -384,7 +391,7 @@ pub mod tests {
</a>     #[test]
     // Heartbeat from past term
     fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-17-3" id="h15-17-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-17-4" id="h15-17-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-18" id="h15-18" class="h">@@ -398,14 +405,15 @@ pub mod tests {
</a>             .voted_for(None)
             .committed(2)
             .applied(1);
<a href="#h15-18-3" id="h15-18-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-18-4" id="h15-18-4" class="i">+        std::mem::drop(node);
</a><a href="#h15-18-5" id="h15-18-5" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // SolicitVote is granted for the first solicitor, otherwise ignored.
     fn step_solicitvote() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-18-12" id="h15-18-12" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-18-13" id="h15-18-13" class="i">+        let (follower, mut rx) = setup()?;
</a> 
         // The first vote request in this term yields a vote response.
         let mut node = follower.step(Message {
<a href="#h15-19" id="h15-19" class="h">@@ -416,7 +424,7 @@ pub mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
         assert_messages(
<a href="#h15-19-3" id="h15-19-3" class="d">-            &amp;rx,
</a><a href="#h15-19-4" id="h15-19-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;c&quot;.into()),
<a href="#h15-20" id="h15-20" class="h">@@ -434,7 +442,7 @@ pub mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
         assert_messages(
<a href="#h15-20-3" id="h15-20-3" class="d">-            &amp;rx,
</a><a href="#h15-20-4" id="h15-20-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;c&quot;.into()),
<a href="#h15-21" id="h15-21" class="h">@@ -451,14 +459,14 @@ pub mod tests {
</a>             event: Event::SolicitVote { last_index: 3, last_term: 2 },
         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(Some(&quot;c&quot;));
<a href="#h15-21-3" id="h15-21-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-21-4" id="h15-21-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // GrantVote messages are ignored
     fn step_grantvote_noop() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-21-11" id="h15-21-11" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-21-12" id="h15-21-12" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-22" id="h15-22" class="h">@@ -466,14 +474,14 @@ pub mod tests {
</a>             event: Event::GrantVote,
         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
<a href="#h15-22-3" id="h15-22-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-22-4" id="h15-22-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // SolicitVote is rejected if last_term is outdated.
     fn step_solicitvote_last_index_outdated() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-22-11" id="h15-22-11" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-22-12" id="h15-22-12" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;c&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-23" id="h15-23" class="h">@@ -481,14 +489,14 @@ pub mod tests {
</a>             event: Event::SolicitVote { last_index: 2, last_term: 2 },
         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
<a href="#h15-23-3" id="h15-23-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-23-4" id="h15-23-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // SolicitVote is rejected if last_term is outdated.
     fn step_solicitvote_last_term_outdated() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-23-11" id="h15-23-11" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-23-12" id="h15-23-12" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;c&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-24" id="h15-24" class="h">@@ -496,14 +504,14 @@ pub mod tests {
</a>             event: Event::SolicitVote { last_index: 3, last_term: 1 },
         })?;
         assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;)).voted_for(None);
<a href="#h15-24-3" id="h15-24-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h15-24-4" id="h15-24-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // ReplicateEntries accepts some entries at base 0 without changes
     fn step_replicateentries_base0() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-24-11" id="h15-24-11" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-24-12" id="h15-24-12" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-25" id="h15-25" class="h">@@ -523,7 +531,7 @@ pub mod tests {
</a>             Entry { term: 2, command: Some(vec![0x03]) },
         ]);
         assert_messages(
<a href="#h15-25-3" id="h15-25-3" class="d">-            &amp;rx,
</a><a href="#h15-25-4" id="h15-25-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-26" id="h15-26" class="h">@@ -537,7 +545,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries appends entries
     fn step_replicateentries_append() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-26-3" id="h15-26-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-26-4" id="h15-26-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-27" id="h15-27" class="h">@@ -559,7 +567,7 @@ pub mod tests {
</a>             Entry { term: 3, command: Some(vec![0x05]) },
         ]);
         assert_messages(
<a href="#h15-27-3" id="h15-27-3" class="d">-            &amp;rx,
</a><a href="#h15-27-4" id="h15-27-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-28" id="h15-28" class="h">@@ -573,7 +581,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries accepts partially overlapping entries
     fn step_replicateentries_partial_overlap() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-28-3" id="h15-28-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-28-4" id="h15-28-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-29" id="h15-29" class="h">@@ -595,7 +603,7 @@ pub mod tests {
</a>             Entry { term: 3, command: Some(vec![0x04]) },
         ]);
         assert_messages(
<a href="#h15-29-3" id="h15-29-3" class="d">-            &amp;rx,
</a><a href="#h15-29-4" id="h15-29-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-30" id="h15-30" class="h">@@ -609,7 +617,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries replaces conflicting entries
     fn step_replicateentries_replace() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-30-3" id="h15-30-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-30-4" id="h15-30-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-31" id="h15-31" class="h">@@ -630,7 +638,7 @@ pub mod tests {
</a>             Entry { term: 3, command: Some(vec![0x05]) },
         ]);
         assert_messages(
<a href="#h15-31-3" id="h15-31-3" class="d">-            &amp;rx,
</a><a href="#h15-31-4" id="h15-31-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-32" id="h15-32" class="h">@@ -644,7 +652,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries replaces partially conflicting entries
     fn step_replicateentries_replace_partial() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-32-3" id="h15-32-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-32-4" id="h15-32-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-33" id="h15-33" class="h">@@ -665,7 +673,7 @@ pub mod tests {
</a>             Entry { term: 3, command: Some(vec![0x04]) },
         ]);
         assert_messages(
<a href="#h15-33-3" id="h15-33-3" class="d">-            &amp;rx,
</a><a href="#h15-33-4" id="h15-33-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-34" id="h15-34" class="h">@@ -679,7 +687,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries rejects missing base index
     fn step_replicateentries_reject_missing_base_index() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-34-3" id="h15-34-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-34-4" id="h15-34-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-35" id="h15-35" class="h">@@ -696,7 +704,7 @@ pub mod tests {
</a>             Entry { term: 2, command: Some(vec![0x03]) },
         ]);
         assert_messages(
<a href="#h15-35-3" id="h15-35-3" class="d">-            &amp;rx,
</a><a href="#h15-35-4" id="h15-35-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-36" id="h15-36" class="h">@@ -710,7 +718,7 @@ pub mod tests {
</a>     #[test]
     // ReplicateEntries rejects conflicting base term
     fn step_replicateentries_reject_missing_base_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-36-3" id="h15-36-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-36-4" id="h15-36-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let node = follower.step(Message {
             from: Some(&quot;b&quot;.into()),
             to: Some(&quot;a&quot;.into()),
<a href="#h15-37" id="h15-37" class="h">@@ -727,7 +735,7 @@ pub mod tests {
</a>             Entry { term: 2, command: Some(vec![0x03]) },
         ]);
         assert_messages(
<a href="#h15-37-3" id="h15-37-3" class="d">-            &amp;rx,
</a><a href="#h15-37-4" id="h15-37-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h15-38" id="h15-38" class="h">@@ -749,14 +757,14 @@ pub mod tests {
</a>             Event::RespondError { call_id: vec![], error: Error::Internal(&quot;b00m&quot;.into()) },
             Event::RespondState { call_id: vec![], response: vec![0xaf] },
         ];
<a href="#h15-38-3" id="h15-38-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-38-4" id="h15-38-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let mut node = Node::Follower(follower);
         for call in calls.into_iter() {
             for mut response in responses.clone().into_iter() {
                 node = node.step(Message { from: None, to: None, term: 0, event: call.clone() })?;
                 assert_node(&amp;node).is_follower().term(3).leader(Some(&quot;b&quot;));
                 assert_messages(
<a href="#h15-38-11" id="h15-38-11" class="d">-                    &amp;rx,
</a><a href="#h15-38-12" id="h15-38-12" class="i">+                    &amp;mut rx,
</a>                     vec![Message {
                         from: Some(&quot;a&quot;.into()),
                         to: Some(&quot;b&quot;.into()),
<a href="#h15-39" id="h15-39" class="h">@@ -781,7 +789,7 @@ pub mod tests {
</a>                     })?;
                 }
                 assert_messages(
<a href="#h15-39-3" id="h15-39-3" class="d">-                    &amp;rx,
</a><a href="#h15-39-4" id="h15-39-4" class="i">+                    &amp;mut rx,
</a>                     vec![Message { from: Some(&quot;a&quot;.into()), to: None, term: 3, event: response }],
                 );
             }
<a href="#h15-40" id="h15-40" class="h">@@ -791,7 +799,7 @@ pub mod tests {
</a> 
     #[test]
     fn tick() -&gt; Result&lt;(), Error&gt; {
<a href="#h15-40-3" id="h15-40-3" class="d">-        let (follower, rx) = setup()?;
</a><a href="#h15-40-4" id="h15-40-4" class="i">+        let (follower, mut rx) = setup()?;
</a>         let timeout = follower.role.leader_seen_timeout;
         let peers = follower.peers.clone();
         let mut node = Node::Follower(follower);
<a href="#h15-41" id="h15-41" class="h">@@ -809,7 +817,7 @@ pub mod tests {
</a>                 event: Event::Heartbeat { commit_index: 2, commit_term: 1 },
             })?;
             assert_messages(
<a href="#h15-41-3" id="h15-41-3" class="d">-                &amp;rx,
</a><a href="#h15-41-4" id="h15-41-4" class="i">+                &amp;mut rx,
</a>                 vec![Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(&quot;b&quot;.into()),
<a href="#h15-42" id="h15-42" class="h">@@ -826,15 +834,14 @@ pub mod tests {
</a>         assert_node(&amp;node).is_candidate().term(4);
 
         for to in peers.into_iter() {
<a href="#h15-42-3" id="h15-42-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h15-42-5" id="h15-42-5" class="d">-                rx.recv()?,
</a><a href="#h15-42-6" id="h15-42-6" class="d">-                Message {
</a><a href="#h15-42-7" id="h15-42-7" class="i">+                futures::executor::block_on(rx.next()),
</a><a href="#h15-42-8" id="h15-42-8" class="i">+                Some(Message {
</a>                     from: Some(&quot;a&quot;.into()),
                     to: Some(to),
                     term: 4,
                     event: Event::SolicitVote { last_index: 3, last_term: 2 },
<a href="#h15-42-13" id="h15-42-13" class="d">-                }
</a><a href="#h15-42-14" id="h15-42-14" class="i">+                })
</a>             )
         }
         Ok(())
<b>diff --git a/<a id="h16" href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a> b/<a href="../file/src/raft/node/leader.rs.html">src/raft/node/leader.rs</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -1,4 +1,8 @@
</a><a href="#h16-0-0" id="h16-0-0" class="d">-use super::*;
</a><a href="#h16-0-1" id="h16-0-1" class="i">+use super::super::{Entry, Event, Message, State};
</a><a href="#h16-0-2" id="h16-0-2" class="i">+use super::{Follower, Node, RoleNode, HEARTBEAT_INTERVAL};
</a><a href="#h16-0-3" id="h16-0-3" class="i">+use crate::kv::storage::Storage;
</a><a href="#h16-0-4" id="h16-0-4" class="i">+use crate::Error;
</a><a href="#h16-0-5" id="h16-0-5" class="i">+
</a> use std::collections::{HashMap, HashSet};
 
 // A leader serves requests and replicates the log to followers.
<a href="#h16-1" id="h16-1" class="h">@@ -31,7 +35,7 @@ impl Leader {
</a>     }
 }
 
<a href="#h16-1-3" id="h16-1-3" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; RoleNode&lt;Leader, L, S&gt; {
</a><a href="#h16-1-4" id="h16-1-4" class="i">+impl&lt;L: Storage, S: State&gt; RoleNode&lt;Leader, L, S&gt; {
</a>     /// Transforms the leader into a follower
     fn become_follower(
         mut self,
<a href="#h16-2" id="h16-2" class="h">@@ -287,16 +291,20 @@ impl Calls {
</a> 
 #[cfg(test)]
 mod tests {
<a href="#h16-2-3" id="h16-2-3" class="i">+    use super::super::super::{Entry, Log};
</a>     use super::super::tests::{assert_messages, assert_node, TestState};
     use super::*;
<a href="#h16-2-6" id="h16-2-6" class="d">-    use crossbeam::channel::Receiver;
</a><a href="#h16-2-7" id="h16-2-7" class="i">+    use crate::kv;
</a><a href="#h16-2-8" id="h16-2-8" class="i">+    use tokio::sync::mpsc;
</a> 
     #[allow(clippy::type_complexity)]
<a href="#h16-2-11" id="h16-2-11" class="d">-    fn setup(
</a><a href="#h16-2-12" id="h16-2-12" class="d">-    ) -&gt; Result&lt;(RoleNode&lt;Leader, kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a><a href="#h16-2-13" id="h16-2-13" class="d">-        let (sender, receiver) = crossbeam::channel::unbounded();
</a><a href="#h16-2-14" id="h16-2-14" class="i">+    fn setup() -&gt; Result&lt;
</a><a href="#h16-2-15" id="h16-2-15" class="i">+        (RoleNode&lt;Leader, kv::storage::Test, TestState&gt;, mpsc::UnboundedReceiver&lt;Message&gt;),
</a><a href="#h16-2-16" id="h16-2-16" class="i">+        Error,
</a><a href="#h16-2-17" id="h16-2-17" class="i">+    &gt; {
</a><a href="#h16-2-18" id="h16-2-18" class="i">+        let (sender, receiver) = mpsc::unbounded_channel();
</a>         let mut state = TestState::new();
<a href="#h16-2-20" id="h16-2-20" class="d">-        let mut log = Log::new(kv::Simple::new(kv::storage::Memory::new()))?;
</a><a href="#h16-2-21" id="h16-2-21" class="i">+        let mut log = Log::new(kv::Simple::new(kv::storage::Test::new()))?;
</a>         log.append(Entry { term: 1, command: Some(vec![0x01]) })?;
         log.append(Entry { term: 1, command: Some(vec![0x02]) })?;
         log.append(Entry { term: 2, command: Some(vec![0x03]) })?;
<a href="#h16-3" id="h16-3" class="h">@@ -324,7 +332,7 @@ mod tests {
</a>     #[test]
     // ConfirmLeader with has_committed has no effect without any calls
     fn step_confirmleader() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-3-3" id="h16-3-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-3-4" id="h16-3-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-4" id="h16-4" class="h">@@ -334,14 +342,14 @@ mod tests {
</a>             event: Event::ConfirmLeader { commit_index: 2, has_committed: true },
         })?;
         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
<a href="#h16-4-3" id="h16-4-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-4-4" id="h16-4-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // ConfirmLeader without has_committed triggers replication
     fn step_confirmleader_without_has_committed() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-4-11" id="h16-4-11" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-4-12" id="h16-4-12" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-5" id="h16-5" class="h">@@ -352,7 +360,7 @@ mod tests {
</a>         })?;
         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
         assert_messages(
<a href="#h16-5-3" id="h16-5-3" class="d">-            &amp;rx,
</a><a href="#h16-5-4" id="h16-5-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h16-6" id="h16-6" class="h">@@ -366,7 +374,7 @@ mod tests {
</a>     #[test]
     // Heartbeats from other leaders in current term are ignored.
     fn step_heartbeat_current_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-6-3" id="h16-6-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-6-4" id="h16-6-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-7" id="h16-7" class="h">@@ -376,14 +384,14 @@ mod tests {
</a>             event: Event::Heartbeat { commit_index: 5, commit_term: 3 },
         })?;
         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
<a href="#h16-7-3" id="h16-7-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-7-4" id="h16-7-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     // Heartbeats from other leaders in future term converts to follower and steps.
     fn step_heartbeat_future_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-7-11" id="h16-7-11" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-7-12" id="h16-7-12" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-8" id="h16-8" class="h">@@ -394,7 +402,7 @@ mod tests {
</a>         })?;
         assert_node(&amp;node).is_follower().term(4).leader(Some(&quot;b&quot;)).committed(2).applied(1);
         assert_messages(
<a href="#h16-8-3" id="h16-8-3" class="d">-            &amp;rx,
</a><a href="#h16-8-4" id="h16-8-4" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<a href="#h16-9" id="h16-9" class="h">@@ -408,7 +416,7 @@ mod tests {
</a>     #[test]
     // Heartbeats from other leaders in past terms are ignored.
     fn step_heartbeat_past_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-9-3" id="h16-9-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-9-4" id="h16-9-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-10" id="h16-10" class="h">@@ -418,13 +426,13 @@ mod tests {
</a>             event: Event::Heartbeat { commit_index: 3, commit_term: 2 },
         })?;
         assert_node(&amp;node).is_leader().term(3).committed(2).applied(1);
<a href="#h16-10-3" id="h16-10-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-10-4" id="h16-10-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
     #[test]
     fn step_acceptentries() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-10-10" id="h16-10-10" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-10-11" id="h16-10-11" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         node = node.step(Message {
<a href="#h16-11" id="h16-11" class="h">@@ -434,7 +442,7 @@ mod tests {
</a>             event: Event::AcceptEntries { last_index: 4 },
         })?;
         assert_node(&amp;node).committed(2).applied(2);
<a href="#h16-11-3" id="h16-11-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-11-4" id="h16-11-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         node = node.step(Message {
             from: Some(&quot;c&quot;.into()),
<a href="#h16-12" id="h16-12" class="h">@@ -443,7 +451,7 @@ mod tests {
</a>             event: Event::AcceptEntries { last_index: 5 },
         })?;
         assert_node(&amp;node).committed(4).applied(4);
<a href="#h16-12-3" id="h16-12-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-12-4" id="h16-12-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         node = node.step(Message {
             from: Some(&quot;d&quot;.into()),
<a href="#h16-13" id="h16-13" class="h">@@ -452,7 +460,7 @@ mod tests {
</a>             event: Event::AcceptEntries { last_index: 5 },
         })?;
         assert_node(&amp;node).committed(5).applied(5);
<a href="#h16-13-3" id="h16-13-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-13-4" id="h16-13-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         assert_node(&amp;node).is_leader().term(3);
         Ok(())
<a href="#h16-14" id="h16-14" class="h">@@ -461,7 +469,7 @@ mod tests {
</a>     #[test]
     // Duplicate AcceptEntries from single node should not trigger commit.
     fn step_acceptentries_duplicate() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-14-3" id="h16-14-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-14-4" id="h16-14-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let mut node: Node&lt;_, _&gt; = leader.into();
 
         for _ in 0..5 {
<a href="#h16-15" id="h16-15" class="h">@@ -472,7 +480,7 @@ mod tests {
</a>                 event: Event::AcceptEntries { last_index: 5 },
             })?;
             assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
<a href="#h16-15-3" id="h16-15-3" class="d">-            assert_messages(&amp;rx, vec![]);
</a><a href="#h16-15-4" id="h16-15-4" class="i">+            assert_messages(&amp;mut rx, vec![]);
</a>         }
         Ok(())
     }
<a href="#h16-16" id="h16-16" class="h">@@ -480,7 +488,7 @@ mod tests {
</a>     #[test]
     // AcceptEntries quorum for entry in past term should not trigger commit
     fn step_acceptentries_past_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-16-3" id="h16-16-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-16-4" id="h16-16-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h16-17" id="h16-17" class="h">@@ -492,7 +500,7 @@ mod tests {
</a>                 event: Event::AcceptEntries { last_index: 3 },
             })?;
             assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
<a href="#h16-17-3" id="h16-17-3" class="d">-            assert_messages(&amp;rx, vec![]);
</a><a href="#h16-17-4" id="h16-17-4" class="i">+            assert_messages(&amp;mut rx, vec![]);
</a>         }
         Ok(())
     }
<a href="#h16-18" id="h16-18" class="h">@@ -500,7 +508,7 @@ mod tests {
</a>     #[test]
     // AcceptEntries quorum for missing future entry
     fn step_acceptentries_future_index() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-18-3" id="h16-18-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-18-4" id="h16-18-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h16-19" id="h16-19" class="h">@@ -516,14 +524,14 @@ mod tests {
</a>             // However, we will correctly ignore the following votes for 7.
             let c = if i == 0 { 2 } else { 5 };
             assert_node(&amp;node).is_leader().term(3).committed(c).applied(c).last(5);
<a href="#h16-19-3" id="h16-19-3" class="d">-            assert_messages(&amp;rx, vec![]);
</a><a href="#h16-19-4" id="h16-19-4" class="i">+            assert_messages(&amp;mut rx, vec![]);
</a>         }
         Ok(())
     }
 
     #[test]
     fn step_rejectentries() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-19-11" id="h16-19-11" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-19-12" id="h16-19-12" class="i">+        let (leader, mut rx) = setup()?;
</a>         let entries = leader.log.range(0..)?;
         let mut node: Node&lt;_, _&gt; = leader.into();
 
<a href="#h16-20" id="h16-20" class="h">@@ -538,7 +546,7 @@ mod tests {
</a>             let index = if i &gt;= entries.len() { 0 } else { entries.len() - i - 1 };
             let replicate = entries.get(index..).unwrap().to_vec();
             assert_messages(
<a href="#h16-20-3" id="h16-20-3" class="d">-                &amp;rx,
</a><a href="#h16-20-4" id="h16-20-4" class="i">+                &amp;mut rx,
</a>                 vec![Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(&quot;b&quot;.into()),
<a href="#h16-21" id="h16-21" class="h">@@ -560,7 +568,7 @@ mod tests {
</a> 
     #[test]
     fn step_mutatestate_readstate() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-21-3" id="h16-21-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-21-4" id="h16-21-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let quorum = leader.quorum();
         let mut node: Node&lt;_, _&gt; = leader.into();
<a href="#h16-22" id="h16-22" class="h">@@ -585,9 +593,8 @@ mod tests {
</a>             .last(6)
             .entry(6, Entry { term: 3, command: Some(vec![0xaf]) });
         for peer in peers.iter().cloned() {
<a href="#h16-22-3" id="h16-22-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h16-22-5" id="h16-22-5" class="d">-                rx.recv()?,
</a><a href="#h16-22-6" id="h16-22-6" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(peer),
<a href="#h16-23" id="h16-23" class="h">@@ -612,7 +619,7 @@ mod tests {
</a>             })?;
             assert_node(&amp;node).committed(2).applied(1).last(6);
         }
<a href="#h16-23-3" id="h16-23-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-23-4" id="h16-23-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         // Receive AcceptEntries calls from peers, which after a quorum
         // will commit and apply the entries and return a call response.
<a href="#h16-24" id="h16-24" class="h">@@ -625,14 +632,13 @@ mod tests {
</a>             })?;
             if (i as u64 + 2) &lt; quorum {
                 assert_node(&amp;node).committed(2).applied(2).last(6);
<a href="#h16-24-3" id="h16-24-3" class="d">-                assert_messages(&amp;rx, vec![]);
</a><a href="#h16-24-4" id="h16-24-4" class="i">+                assert_messages(&amp;mut rx, vec![]);
</a>             } else {
                 assert_node(&amp;node).committed(6).applied(6).last(6);
<a href="#h16-24-7" id="h16-24-7" class="d">-                assert!(!rx.is_empty());
</a>             }
         }
         assert_messages(
<a href="#h16-24-11" id="h16-24-11" class="d">-            &amp;rx,
</a><a href="#h16-24-12" id="h16-24-12" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: None,
<a href="#h16-25" id="h16-25" class="h">@@ -651,9 +657,8 @@ mod tests {
</a>         })?;
         assert_node(&amp;node).is_leader().term(3);
         for peer in peers.iter().cloned() {
<a href="#h16-25-3" id="h16-25-3" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h16-25-5" id="h16-25-5" class="d">-                rx.recv()?,
</a><a href="#h16-25-6" id="h16-25-6" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(peer),
<a href="#h16-26" id="h16-26" class="h">@@ -662,7 +667,7 @@ mod tests {
</a>                 }
             )
         }
<a href="#h16-26-3" id="h16-26-3" class="d">-        assert_messages(&amp;rx, vec![]);
</a><a href="#h16-26-4" id="h16-26-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a> 
         // Check that ConfirmLeader calls for an old commit_index as well as
         // AcceptEntries calls for the current last_index do not trigger a
<a href="#h16-27" id="h16-27" class="h">@@ -680,7 +685,7 @@ mod tests {
</a>                 term: 3,
                 event: Event::AcceptEntries { last_index: 6 },
             })?;
<a href="#h16-27-3" id="h16-27-3" class="d">-            assert_messages(&amp;rx, vec![]);
</a><a href="#h16-27-4" id="h16-27-4" class="i">+            assert_messages(&amp;mut rx, vec![]);
</a>         }
 
         // After we receive leadership confirmation from a quorum of
<a href="#h16-28" id="h16-28" class="h">@@ -694,13 +699,11 @@ mod tests {
</a>             })?;
             assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
             if (i as u64 + 2) &lt; quorum {
<a href="#h16-28-3" id="h16-28-3" class="d">-                assert_messages(&amp;rx, vec![]);
</a><a href="#h16-28-4" id="h16-28-4" class="d">-            } else {
</a><a href="#h16-28-5" id="h16-28-5" class="d">-                assert!(!rx.is_empty());
</a><a href="#h16-28-6" id="h16-28-6" class="i">+                assert_messages(&amp;mut rx, vec![]);
</a>             }
         }
         assert_messages(
<a href="#h16-28-10" id="h16-28-10" class="d">-            &amp;rx,
</a><a href="#h16-28-11" id="h16-28-11" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: None,
<a href="#h16-29" id="h16-29" class="h">@@ -717,7 +720,7 @@ mod tests {
</a>                 term: 3,
                 event: Event::ConfirmLeader { commit_index: 6, has_committed: true },
             })?;
<a href="#h16-29-3" id="h16-29-3" class="d">-            assert_messages(&amp;rx, vec![]);
</a><a href="#h16-29-4" id="h16-29-4" class="i">+            assert_messages(&amp;mut rx, vec![]);
</a>         }
         assert_node(&amp;node).is_leader().term(3).committed(6).applied(6).last(6);
         Ok(())
<a href="#h16-30" id="h16-30" class="h">@@ -725,19 +728,18 @@ mod tests {
</a> 
     #[test]
     fn tick() -&gt; Result&lt;(), Error&gt; {
<a href="#h16-30-3" id="h16-30-3" class="d">-        let (leader, rx) = setup()?;
</a><a href="#h16-30-4" id="h16-30-4" class="i">+        let (leader, mut rx) = setup()?;
</a>         let peers = leader.peers.clone();
         let mut node: Node&lt;_, _&gt; = leader.into();
         for _ in 0..5 {
             for _ in 0..HEARTBEAT_INTERVAL {
<a href="#h16-30-9" id="h16-30-9" class="d">-                assert_messages(&amp;rx, vec![]);
</a><a href="#h16-30-10" id="h16-30-10" class="i">+                assert_messages(&amp;mut rx, vec![]);
</a>                 node = node.tick()?;
                 assert_node(&amp;node).is_leader().term(3).committed(2).applied(2);
             }
             for peer in peers.iter() {
<a href="#h16-30-15" id="h16-30-15" class="d">-                assert!(!rx.is_empty());
</a>                 assert_eq!(
<a href="#h16-30-17" id="h16-30-17" class="d">-                    rx.recv()?,
</a><a href="#h16-30-18" id="h16-30-18" class="i">+                    rx.try_recv()?,
</a>                     Message {
                         from: Some(&quot;a&quot;.into()),
                         to: Some(peer.into()),
<b>diff --git a/<a id="h17" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -2,15 +2,14 @@ mod candidate;
</a> mod follower;
 mod leader;
 
<a href="#h17-0-3" id="h17-0-3" class="d">-use self::candidate::Candidate;
</a><a href="#h17-0-4" id="h17-0-4" class="d">-use self::follower::Follower;
</a><a href="#h17-0-5" id="h17-0-5" class="d">-use self::leader::Leader;
</a><a href="#h17-0-6" id="h17-0-6" class="d">-use super::log::{Entry, Log};
</a><a href="#h17-0-7" id="h17-0-7" class="d">-use super::transport::{Event, Message};
</a><a href="#h17-0-8" id="h17-0-8" class="d">-use super::State;
</a><a href="#h17-0-9" id="h17-0-9" class="d">-use crate::kv;
</a><a href="#h17-0-10" id="h17-0-10" class="i">+use super::{Event, Log, Message, State};
</a><a href="#h17-0-11" id="h17-0-11" class="i">+use crate::kv::storage::Storage;
</a> use crate::Error;
<a href="#h17-0-13" id="h17-0-13" class="d">-use crossbeam::channel::Sender;
</a><a href="#h17-0-14" id="h17-0-14" class="i">+use candidate::Candidate;
</a><a href="#h17-0-15" id="h17-0-15" class="i">+use follower::Follower;
</a><a href="#h17-0-16" id="h17-0-16" class="i">+use leader::Leader;
</a><a href="#h17-0-17" id="h17-0-17" class="i">+
</a><a href="#h17-0-18" id="h17-0-18" class="i">+use tokio::sync::mpsc::UnboundedSender;
</a> 
 /// The interval between leader heartbeats, in ticks.
 const HEARTBEAT_INTERVAL: u64 = 1;
<a href="#h17-1" id="h17-1" class="h">@@ -21,23 +20,35 @@ const ELECTION_TIMEOUT_MIN: u64 = 8 * HEARTBEAT_INTERVAL;
</a> /// The maximum election timeout, in ticks.
 const ELECTION_TIMEOUT_MAX: u64 = 15 * HEARTBEAT_INTERVAL;
 
<a href="#h17-1-3" id="h17-1-3" class="i">+/// Node status
</a><a href="#h17-1-4" id="h17-1-4" class="i">+#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h17-1-5" id="h17-1-5" class="i">+pub struct Status {
</a><a href="#h17-1-6" id="h17-1-6" class="i">+    pub id: String,
</a><a href="#h17-1-7" id="h17-1-7" class="i">+    pub role: String,
</a><a href="#h17-1-8" id="h17-1-8" class="i">+    pub leader: Option&lt;String&gt;,
</a><a href="#h17-1-9" id="h17-1-9" class="i">+    pub nodes: u64,
</a><a href="#h17-1-10" id="h17-1-10" class="i">+    pub term: u64,
</a><a href="#h17-1-11" id="h17-1-11" class="i">+    pub entries: u64,
</a><a href="#h17-1-12" id="h17-1-12" class="i">+    pub committed: u64,
</a><a href="#h17-1-13" id="h17-1-13" class="i">+    pub applied: u64,
</a><a href="#h17-1-14" id="h17-1-14" class="i">+}
</a><a href="#h17-1-15" id="h17-1-15" class="i">+
</a> /// The local Raft node state machine.
<a href="#h17-1-17" id="h17-1-17" class="d">-pub enum Node&lt;L: kv::storage::Storage, S: State&gt; {
</a><a href="#h17-1-18" id="h17-1-18" class="i">+pub enum Node&lt;L: Storage, S: State&gt; {
</a>     Candidate(RoleNode&lt;Candidate, L, S&gt;),
     Follower(RoleNode&lt;Follower, L, S&gt;),
     Leader(RoleNode&lt;Leader, L, S&gt;),
 }
 
<a href="#h17-1-24" id="h17-1-24" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; Node&lt;L, S&gt; {
</a><a href="#h17-1-25" id="h17-1-25" class="i">+impl&lt;L: Storage, S: State&gt; Node&lt;L, S&gt; {
</a>     /// Creates a new Raft node, starting as a follower, or leader if no peers.
     pub fn new(
         id: &amp;str,
         peers: Vec&lt;String&gt;,
<a href="#h17-1-30" id="h17-1-30" class="d">-        logstore: kv::Simple&lt;L&gt;,
</a><a href="#h17-1-31" id="h17-1-31" class="i">+        log: Log&lt;L&gt;,
</a>         state: S,
<a href="#h17-1-33" id="h17-1-33" class="d">-        sender: Sender&lt;Message&gt;,
</a><a href="#h17-1-34" id="h17-1-34" class="i">+        sender: UnboundedSender&lt;Message&gt;,
</a>     ) -&gt; Result&lt;Self, Error&gt; {
<a href="#h17-1-36" id="h17-1-36" class="d">-        let log = Log::new(logstore)?;
</a>         let (term, voted_for) = log.load_term()?;
         let node = RoleNode {
             id: id.to_owned(),
<a href="#h17-2" id="h17-2" class="h">@@ -57,6 +68,26 @@ impl&lt;L: kv::storage::Storage, S: State&gt; Node&lt;L, S&gt; {
</a>         }
     }
 
<a href="#h17-2-3" id="h17-2-3" class="i">+    /// Returns node status.
</a><a href="#h17-2-4" id="h17-2-4" class="i">+    pub fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h17-2-5" id="h17-2-5" class="i">+        let mut status = match self {
</a><a href="#h17-2-6" id="h17-2-6" class="i">+            Node::Candidate(n) =&gt; n.status(),
</a><a href="#h17-2-7" id="h17-2-7" class="i">+            Node::Follower(n) =&gt; n.status(),
</a><a href="#h17-2-8" id="h17-2-8" class="i">+            Node::Leader(n) =&gt; n.status(),
</a><a href="#h17-2-9" id="h17-2-9" class="i">+        }?;
</a><a href="#h17-2-10" id="h17-2-10" class="i">+        status.role = match self {
</a><a href="#h17-2-11" id="h17-2-11" class="i">+            Node::Candidate(_) =&gt; &quot;candidate&quot;.into(),
</a><a href="#h17-2-12" id="h17-2-12" class="i">+            Node::Follower(_) =&gt; &quot;follower&quot;.into(),
</a><a href="#h17-2-13" id="h17-2-13" class="i">+            Node::Leader(_) =&gt; &quot;leader&quot;.into(),
</a><a href="#h17-2-14" id="h17-2-14" class="i">+        };
</a><a href="#h17-2-15" id="h17-2-15" class="i">+        status.leader = match self {
</a><a href="#h17-2-16" id="h17-2-16" class="i">+            Node::Candidate(_) =&gt; None,
</a><a href="#h17-2-17" id="h17-2-17" class="i">+            Node::Follower(n) =&gt; n.role.leader.clone(),
</a><a href="#h17-2-18" id="h17-2-18" class="i">+            Node::Leader(n) =&gt; Some(n.id.clone()),
</a><a href="#h17-2-19" id="h17-2-19" class="i">+        };
</a><a href="#h17-2-20" id="h17-2-20" class="i">+        Ok(status)
</a><a href="#h17-2-21" id="h17-2-21" class="i">+    }
</a><a href="#h17-2-22" id="h17-2-22" class="i">+
</a>     /// Processes a message.
     pub fn step(self, msg: Message) -&gt; Result&lt;Self, Error&gt; {
         debug!(&quot;Stepping {:?}&quot;, msg);
<a href="#h17-3" id="h17-3" class="h">@@ -77,36 +108,36 @@ impl&lt;L: kv::storage::Storage, S: State&gt; Node&lt;L, S&gt; {
</a>     }
 }
 
<a href="#h17-3-3" id="h17-3-3" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Candidate, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h17-3-4" id="h17-3-4" class="i">+impl&lt;L: Storage, S: State&gt; From&lt;RoleNode&lt;Candidate, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a>     fn from(rn: RoleNode&lt;Candidate, L, S&gt;) -&gt; Self {
         Node::Candidate(rn)
     }
 }
 
<a href="#h17-3-10" id="h17-3-10" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Follower, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h17-3-11" id="h17-3-11" class="i">+impl&lt;L: Storage, S: State&gt; From&lt;RoleNode&lt;Follower, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a>     fn from(rn: RoleNode&lt;Follower, L, S&gt;) -&gt; Self {
         Node::Follower(rn)
     }
 }
 
<a href="#h17-3-17" id="h17-3-17" class="d">-impl&lt;L: kv::storage::Storage, S: State&gt; From&lt;RoleNode&lt;Leader, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a><a href="#h17-3-18" id="h17-3-18" class="i">+impl&lt;L: Storage, S: State&gt; From&lt;RoleNode&lt;Leader, L, S&gt;&gt; for Node&lt;L, S&gt; {
</a>     fn from(rn: RoleNode&lt;Leader, L, S&gt;) -&gt; Self {
         Node::Leader(rn)
     }
 }
 
 // A Raft node with role R
<a href="#h17-3-25" id="h17-3-25" class="d">-pub struct RoleNode&lt;R, L: kv::storage::Storage, S: State&gt; {
</a><a href="#h17-3-26" id="h17-3-26" class="i">+pub struct RoleNode&lt;R, L: Storage, S: State&gt; {
</a>     id: String,
     peers: Vec&lt;String&gt;,
     term: u64,
     log: Log&lt;L&gt;,
     state: S,
<a href="#h17-3-32" id="h17-3-32" class="d">-    sender: Sender&lt;Message&gt;,
</a><a href="#h17-3-33" id="h17-3-33" class="i">+    sender: UnboundedSender&lt;Message&gt;,
</a>     role: R,
 }
 
<a href="#h17-3-37" id="h17-3-37" class="d">-impl&lt;R, L: kv::storage::Storage, S: State&gt; RoleNode&lt;R, L, S&gt; {
</a><a href="#h17-3-38" id="h17-3-38" class="i">+impl&lt;R, L: Storage, S: State&gt; RoleNode&lt;R, L, S&gt; {
</a>     /// Transforms the node into another role.
     fn become_role&lt;T&gt;(self, role: T) -&gt; Result&lt;RoleNode&lt;T, L, S&gt;, Error&gt; {
         Ok(RoleNode {
<a href="#h17-4" id="h17-4" class="h">@@ -164,20 +195,48 @@ impl&lt;R, L: kv::storage::Storage, S: State&gt; RoleNode&lt;R, L, S&gt; {
</a>         debug!(&quot;Sending {:?}&quot;, msg);
         Ok(self.sender.send(msg)?)
     }
<a href="#h17-4-3" id="h17-4-3" class="i">+
</a><a href="#h17-4-4" id="h17-4-4" class="i">+    /// Returns the node status.
</a><a href="#h17-4-5" id="h17-4-5" class="i">+    fn status(&amp;self) -&gt; Result&lt;Status, Error&gt; {
</a><a href="#h17-4-6" id="h17-4-6" class="i">+        let (entries, _) = self.log.get_last();
</a><a href="#h17-4-7" id="h17-4-7" class="i">+        let (committed, _) = self.log.get_committed();
</a><a href="#h17-4-8" id="h17-4-8" class="i">+        let (applied, _) = self.log.get_applied();
</a><a href="#h17-4-9" id="h17-4-9" class="i">+
</a><a href="#h17-4-10" id="h17-4-10" class="i">+        Ok(Status {
</a><a href="#h17-4-11" id="h17-4-11" class="i">+            id: self.id.clone(),
</a><a href="#h17-4-12" id="h17-4-12" class="i">+            role: &quot;&quot;.into(),
</a><a href="#h17-4-13" id="h17-4-13" class="i">+            leader: None,
</a><a href="#h17-4-14" id="h17-4-14" class="i">+            nodes: self.peers.len() as u64 + 1,
</a><a href="#h17-4-15" id="h17-4-15" class="i">+            term: self.term,
</a><a href="#h17-4-16" id="h17-4-16" class="i">+            entries,
</a><a href="#h17-4-17" id="h17-4-17" class="i">+            committed,
</a><a href="#h17-4-18" id="h17-4-18" class="i">+            applied,
</a><a href="#h17-4-19" id="h17-4-19" class="i">+        })
</a><a href="#h17-4-20" id="h17-4-20" class="i">+    }
</a> }
 
 #[cfg(test)]
 mod tests {
<a href="#h17-4-25" id="h17-4-25" class="d">-    pub use super::super::tests::*;
</a><a href="#h17-4-26" id="h17-4-26" class="i">+    pub use super::super::state::tests::TestState;
</a><a href="#h17-4-27" id="h17-4-27" class="i">+    use super::super::Entry;
</a>     use super::follower::tests::{follower_leader, follower_voted_for};
     use super::*;
<a href="#h17-4-30" id="h17-4-30" class="d">-    use crossbeam::channel::Receiver;
</a><a href="#h17-4-31" id="h17-4-31" class="i">+    use crate::kv;
</a><a href="#h17-4-32" id="h17-4-32" class="i">+    use tokio::sync::mpsc::UnboundedReceiver;
</a><a href="#h17-4-33" id="h17-4-33" class="i">+
</a><a href="#h17-4-34" id="h17-4-34" class="i">+    pub fn assert_messages(rx: &amp;mut UnboundedReceiver&lt;Message&gt;, msgs: Vec&lt;Message&gt;) {
</a><a href="#h17-4-35" id="h17-4-35" class="i">+        let mut actual = Vec::new();
</a><a href="#h17-4-36" id="h17-4-36" class="i">+        while let Ok(message) = rx.try_recv() {
</a><a href="#h17-4-37" id="h17-4-37" class="i">+            actual.push(message)
</a><a href="#h17-4-38" id="h17-4-38" class="i">+        }
</a><a href="#h17-4-39" id="h17-4-39" class="i">+        assert_eq!(msgs, actual);
</a><a href="#h17-4-40" id="h17-4-40" class="i">+    }
</a> 
<a href="#h17-4-42" id="h17-4-42" class="d">-    pub struct NodeAsserter&lt;&#39;a, L: kv::storage::Storage, S: State&gt; {
</a><a href="#h17-4-43" id="h17-4-43" class="i">+    pub struct NodeAsserter&lt;&#39;a, L: Storage, S: State&gt; {
</a>         node: &amp;&#39;a Node&lt;L, S&gt;,
     }
 
<a href="#h17-4-47" id="h17-4-47" class="d">-    impl&lt;&#39;a, L: kv::storage::Storage, S: State&gt; NodeAsserter&lt;&#39;a, L, S&gt; {
</a><a href="#h17-4-48" id="h17-4-48" class="i">+    impl&lt;&#39;a, L: Storage, S: State&gt; NodeAsserter&lt;&#39;a, L, S&gt; {
</a>         pub fn new(node: &amp;&#39;a Node&lt;L, S&gt;) -&gt; Self {
             Self { node }
         }
<a href="#h17-5" id="h17-5" class="h">@@ -300,27 +359,29 @@ mod tests {
</a>         }
     }
 
<a href="#h17-5-3" id="h17-5-3" class="d">-    pub fn assert_node&lt;L: kv::storage::Storage, S: State&gt;(node: &amp;Node&lt;L, S&gt;) -&gt; NodeAsserter&lt;L, S&gt; {
</a><a href="#h17-5-4" id="h17-5-4" class="i">+    pub fn assert_node&lt;L: Storage, S: State&gt;(node: &amp;Node&lt;L, S&gt;) -&gt; NodeAsserter&lt;L, S&gt; {
</a>         NodeAsserter::new(node)
     }
 
     #[allow(clippy::type_complexity)]
     fn setup_rolenode(
<a href="#h17-5-10" id="h17-5-10" class="d">-    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a><a href="#h17-5-11" id="h17-5-11" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Test, TestState&gt;, UnboundedReceiver&lt;Message&gt;), Error&gt;
</a><a href="#h17-5-12" id="h17-5-12" class="i">+    {
</a>         setup_rolenode_peers(vec![&quot;b&quot;.into(), &quot;c&quot;.into()])
     }
 
     #[allow(clippy::type_complexity)]
     fn setup_rolenode_peers(
         peers: Vec&lt;String&gt;,
<a href="#h17-5-19" id="h17-5-19" class="d">-    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Memory, TestState&gt;, Receiver&lt;Message&gt;), Error&gt; {
</a><a href="#h17-5-20" id="h17-5-20" class="d">-        let (sender, receiver) = crossbeam::channel::unbounded();
</a><a href="#h17-5-21" id="h17-5-21" class="i">+    ) -&gt; Result&lt;(RoleNode&lt;(), kv::storage::Test, TestState&gt;, UnboundedReceiver&lt;Message&gt;), Error&gt;
</a><a href="#h17-5-22" id="h17-5-22" class="i">+    {
</a><a href="#h17-5-23" id="h17-5-23" class="i">+        let (sender, receiver) = tokio::sync::mpsc::unbounded_channel();
</a>         let node = RoleNode {
             role: (),
             id: &quot;a&quot;.into(),
             peers,
             term: 1,
<a href="#h17-5-29" id="h17-5-29" class="d">-            log: Log::new(kv::Simple::new(kv::storage::Memory::new()))?,
</a><a href="#h17-5-30" id="h17-5-30" class="i">+            log: Log::new(kv::Simple::new(kv::storage::Test::new()))?,
</a>             state: TestState::new(),
             sender,
         };
<a href="#h17-6" id="h17-6" class="h">@@ -329,11 +390,11 @@ mod tests {
</a> 
     #[test]
     fn new() -&gt; Result&lt;(), Error&gt; {
<a href="#h17-6-3" id="h17-6-3" class="d">-        let (sender, _) = crossbeam::channel::unbounded();
</a><a href="#h17-6-4" id="h17-6-4" class="i">+        let (sender, _) = tokio::sync::mpsc::unbounded_channel();
</a>         let node = Node::new(
             &quot;a&quot;,
             vec![&quot;b&quot;.into(), &quot;c&quot;.into()],
<a href="#h17-6-8" id="h17-6-8" class="d">-            kv::Simple::new(kv::storage::Memory::new()),
</a><a href="#h17-6-9" id="h17-6-9" class="i">+            Log::new(kv::Simple::new(kv::storage::Test::new()))?,
</a>             TestState::new(),
             sender,
         )?;
<a href="#h17-7" id="h17-7" class="h">@@ -350,13 +411,13 @@ mod tests {
</a> 
     #[test]
     fn new_loads_term() -&gt; Result&lt;(), Error&gt; {
<a href="#h17-7-3" id="h17-7-3" class="d">-        let (sender, _) = crossbeam::channel::unbounded();
</a><a href="#h17-7-4" id="h17-7-4" class="i">+        let (sender, _) = tokio::sync::mpsc::unbounded_channel();
</a>         let storage = kv::storage::Test::new();
         Log::new(kv::Simple::new(storage.clone()))?.save_term(3, Some(&quot;c&quot;))?;
         let node = Node::new(
             &quot;a&quot;,
             vec![&quot;b&quot;.into(), &quot;c&quot;.into()],
<a href="#h17-7-10" id="h17-7-10" class="d">-            kv::Simple::new(storage),
</a><a href="#h17-7-11" id="h17-7-11" class="i">+            Log::new(kv::Simple::new(storage))?,
</a>             TestState::new(),
             sender,
         )?;
<a href="#h17-8" id="h17-8" class="h">@@ -369,11 +430,11 @@ mod tests {
</a> 
     #[test]
     fn new_single() -&gt; Result&lt;(), Error&gt; {
<a href="#h17-8-3" id="h17-8-3" class="d">-        let (sender, _) = crossbeam::channel::unbounded();
</a><a href="#h17-8-4" id="h17-8-4" class="i">+        let (sender, _) = tokio::sync::mpsc::unbounded_channel();
</a>         let node = Node::new(
             &quot;a&quot;,
             vec![],
<a href="#h17-8-8" id="h17-8-8" class="d">-            kv::Simple::new(kv::storage::Memory::new()),
</a><a href="#h17-8-9" id="h17-8-9" class="i">+            Log::new(kv::Simple::new(kv::storage::Test::new()))?,
</a>             TestState::new(),
             sender,
         )?;
<a href="#h17-9" id="h17-9" class="h">@@ -401,13 +462,12 @@ mod tests {
</a> 
     #[test]
     fn broadcast() -&gt; Result&lt;(), Error&gt; {
<a href="#h17-9-3" id="h17-9-3" class="d">-        let (node, rx) = setup_rolenode()?;
</a><a href="#h17-9-4" id="h17-9-4" class="i">+        let (node, mut rx) = setup_rolenode()?;
</a>         node.broadcast(Event::Heartbeat { commit_index: 1, commit_term: 1 })?;
 
         for to in [&quot;b&quot;, &quot;c&quot;].iter().cloned() {
<a href="#h17-9-8" id="h17-9-8" class="d">-            assert!(!rx.is_empty());
</a>             assert_eq!(
<a href="#h17-9-10" id="h17-9-10" class="d">-                rx.recv()?,
</a><a href="#h17-9-11" id="h17-9-11" class="i">+                rx.try_recv()?,
</a>                 Message {
                     from: Some(&quot;a&quot;.into()),
                     to: Some(to.into()),
<a href="#h17-10" id="h17-10" class="h">@@ -416,7 +476,7 @@ mod tests {
</a>                 },
             )
         }
<a href="#h17-10-3" id="h17-10-3" class="d">-        assert!(rx.is_empty());
</a><a href="#h17-10-4" id="h17-10-4" class="i">+        assert_messages(&amp;mut rx, vec![]);
</a>         Ok(())
     }
 
<a href="#h17-11" id="h17-11" class="h">@@ -460,10 +520,10 @@ mod tests {
</a> 
     #[test]
     fn send() -&gt; Result&lt;(), Error&gt; {
<a href="#h17-11-3" id="h17-11-3" class="d">-        let (node, rx) = setup_rolenode()?;
</a><a href="#h17-11-4" id="h17-11-4" class="i">+        let (node, mut rx) = setup_rolenode()?;
</a>         node.send(Some(&quot;b&quot;), Event::Heartbeat { commit_index: 1, commit_term: 1 })?;
         assert_messages(
<a href="#h17-11-7" id="h17-11-7" class="d">-            &amp;rx,
</a><a href="#h17-11-8" id="h17-11-8" class="i">+            &amp;mut rx,
</a>             vec![Message {
                 from: Some(&quot;a&quot;.into()),
                 to: Some(&quot;b&quot;.into()),
<b>diff --git a/<a id="h18" href="../file/src/raft/server.rs.html">src/raft/server.rs</a> b/<a href="../file/src/raft/server.rs.html">src/raft/server.rs</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -0,0 +1,220 @@
</a><a href="#h18-0-0" id="h18-0-0" class="i">+use super::{Client, Event, Log, Message, Node, Request, Response, State};
</a><a href="#h18-0-1" id="h18-0-1" class="i">+use crate::kv::storage::Storage;
</a><a href="#h18-0-2" id="h18-0-2" class="i">+use crate::Error;
</a><a href="#h18-0-3" id="h18-0-3" class="i">+
</a><a href="#h18-0-4" id="h18-0-4" class="i">+use futures::{sink::SinkExt as _, FutureExt as _};
</a><a href="#h18-0-5" id="h18-0-5" class="i">+use std::collections::HashMap;
</a><a href="#h18-0-6" id="h18-0-6" class="i">+use std::time::Duration;
</a><a href="#h18-0-7" id="h18-0-7" class="i">+use tokio::net::{TcpListener, TcpStream};
</a><a href="#h18-0-8" id="h18-0-8" class="i">+use tokio::stream::StreamExt as _;
</a><a href="#h18-0-9" id="h18-0-9" class="i">+use tokio::sync::{mpsc, oneshot};
</a><a href="#h18-0-10" id="h18-0-10" class="i">+use tokio_util::codec::{Framed, LengthDelimitedCodec};
</a><a href="#h18-0-11" id="h18-0-11" class="i">+use uuid::Uuid;
</a><a href="#h18-0-12" id="h18-0-12" class="i">+
</a><a href="#h18-0-13" id="h18-0-13" class="i">+/// The duration of a Raft tick, the unit of time for e.g. heartbeats and elections.
</a><a href="#h18-0-14" id="h18-0-14" class="i">+const TICK: Duration = Duration::from_millis(100);
</a><a href="#h18-0-15" id="h18-0-15" class="i">+
</a><a href="#h18-0-16" id="h18-0-16" class="i">+/// A Raft server.
</a><a href="#h18-0-17" id="h18-0-17" class="i">+pub struct Server&lt;L: Storage, S: State&gt; {
</a><a href="#h18-0-18" id="h18-0-18" class="i">+    /// The local Raft node.
</a><a href="#h18-0-19" id="h18-0-19" class="i">+    node: Node&lt;L, S&gt;,
</a><a href="#h18-0-20" id="h18-0-20" class="i">+    /// Raft peers (node ID and network address).
</a><a href="#h18-0-21" id="h18-0-21" class="i">+    peers: HashMap&lt;String, String&gt;,
</a><a href="#h18-0-22" id="h18-0-22" class="i">+    /// Outbound messages from local node.
</a><a href="#h18-0-23" id="h18-0-23" class="i">+    node_rx: mpsc::UnboundedReceiver&lt;Message&gt;,
</a><a href="#h18-0-24" id="h18-0-24" class="i">+    /// Clients send requests via this endpoint.
</a><a href="#h18-0-25" id="h18-0-25" class="i">+    client_tx: mpsc::UnboundedSender&lt;(Request, oneshot::Sender&lt;Response&gt;)&gt;,
</a><a href="#h18-0-26" id="h18-0-26" class="i">+    /// Cluster receives client requests via this endpoint.
</a><a href="#h18-0-27" id="h18-0-27" class="i">+    client_rx: mpsc::UnboundedReceiver&lt;(Request, oneshot::Sender&lt;Response&gt;)&gt;,
</a><a href="#h18-0-28" id="h18-0-28" class="i">+}
</a><a href="#h18-0-29" id="h18-0-29" class="i">+
</a><a href="#h18-0-30" id="h18-0-30" class="i">+impl&lt;L: Storage + Send + &#39;static, S: State + Send + &#39;static&gt; Server&lt;L, S&gt; {
</a><a href="#h18-0-31" id="h18-0-31" class="i">+    /// Creates a new Raft cluster
</a><a href="#h18-0-32" id="h18-0-32" class="i">+    pub fn new(
</a><a href="#h18-0-33" id="h18-0-33" class="i">+        id: &amp;str,
</a><a href="#h18-0-34" id="h18-0-34" class="i">+        peers: HashMap&lt;String, String&gt;,
</a><a href="#h18-0-35" id="h18-0-35" class="i">+        log: Log&lt;L&gt;,
</a><a href="#h18-0-36" id="h18-0-36" class="i">+        state: S,
</a><a href="#h18-0-37" id="h18-0-37" class="i">+    ) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h18-0-38" id="h18-0-38" class="i">+        let (node_tx, node_rx) = mpsc::unbounded_channel();
</a><a href="#h18-0-39" id="h18-0-39" class="i">+        let (client_tx, client_rx) = mpsc::unbounded_channel();
</a><a href="#h18-0-40" id="h18-0-40" class="i">+        Ok(Self {
</a><a href="#h18-0-41" id="h18-0-41" class="i">+            node: Node::new(
</a><a href="#h18-0-42" id="h18-0-42" class="i">+                id,
</a><a href="#h18-0-43" id="h18-0-43" class="i">+                peers.iter().map(|(k, _)| k.to_string()).collect(),
</a><a href="#h18-0-44" id="h18-0-44" class="i">+                log,
</a><a href="#h18-0-45" id="h18-0-45" class="i">+                state,
</a><a href="#h18-0-46" id="h18-0-46" class="i">+                node_tx,
</a><a href="#h18-0-47" id="h18-0-47" class="i">+            )?,
</a><a href="#h18-0-48" id="h18-0-48" class="i">+            peers,
</a><a href="#h18-0-49" id="h18-0-49" class="i">+            node_rx,
</a><a href="#h18-0-50" id="h18-0-50" class="i">+            client_tx,
</a><a href="#h18-0-51" id="h18-0-51" class="i">+            client_rx,
</a><a href="#h18-0-52" id="h18-0-52" class="i">+        })
</a><a href="#h18-0-53" id="h18-0-53" class="i">+    }
</a><a href="#h18-0-54" id="h18-0-54" class="i">+
</a><a href="#h18-0-55" id="h18-0-55" class="i">+    /// Returns a client for this Raft cluster.
</a><a href="#h18-0-56" id="h18-0-56" class="i">+    pub async fn client(&amp;self) -&gt; Client {
</a><a href="#h18-0-57" id="h18-0-57" class="i">+        Client::new(self.client_tx.clone()).await
</a><a href="#h18-0-58" id="h18-0-58" class="i">+    }
</a><a href="#h18-0-59" id="h18-0-59" class="i">+
</a><a href="#h18-0-60" id="h18-0-60" class="i">+    /// Connects to peers and serves requests.
</a><a href="#h18-0-61" id="h18-0-61" class="i">+    pub async fn serve(self, listener: TcpListener) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-62" id="h18-0-62" class="i">+        let (tcp_in_tx, tcp_in_rx) = mpsc::channel::&lt;Message&gt;(100);
</a><a href="#h18-0-63" id="h18-0-63" class="i">+        let (tcp_out_tx, tcp_out_rx) = mpsc::channel::&lt;Message&gt;(100);
</a><a href="#h18-0-64" id="h18-0-64" class="i">+        let (task, tcp_receiver) = Self::tcp_receive(listener, tcp_in_tx).remote_handle();
</a><a href="#h18-0-65" id="h18-0-65" class="i">+        tokio::spawn(task);
</a><a href="#h18-0-66" id="h18-0-66" class="i">+        let (task, tcp_sender) = Self::tcp_send(self.peers, tcp_out_rx).remote_handle();
</a><a href="#h18-0-67" id="h18-0-67" class="i">+        tokio::spawn(task);
</a><a href="#h18-0-68" id="h18-0-68" class="i">+        let (task, eventloop) =
</a><a href="#h18-0-69" id="h18-0-69" class="i">+            Self::eventloop(self.node, self.node_rx, self.client_rx, tcp_in_rx, tcp_out_tx)
</a><a href="#h18-0-70" id="h18-0-70" class="i">+                .remote_handle();
</a><a href="#h18-0-71" id="h18-0-71" class="i">+        tokio::spawn(task);
</a><a href="#h18-0-72" id="h18-0-72" class="i">+
</a><a href="#h18-0-73" id="h18-0-73" class="i">+        tokio::try_join!(tcp_receiver, tcp_sender, eventloop)?;
</a><a href="#h18-0-74" id="h18-0-74" class="i">+        Ok(())
</a><a href="#h18-0-75" id="h18-0-75" class="i">+    }
</a><a href="#h18-0-76" id="h18-0-76" class="i">+
</a><a href="#h18-0-77" id="h18-0-77" class="i">+    /// Runs the event loop.
</a><a href="#h18-0-78" id="h18-0-78" class="i">+    async fn eventloop(
</a><a href="#h18-0-79" id="h18-0-79" class="i">+        mut node: Node&lt;L, S&gt;,
</a><a href="#h18-0-80" id="h18-0-80" class="i">+        mut node_rx: mpsc::UnboundedReceiver&lt;Message&gt;,
</a><a href="#h18-0-81" id="h18-0-81" class="i">+        mut client_rx: mpsc::UnboundedReceiver&lt;(Request, oneshot::Sender&lt;Response&gt;)&gt;,
</a><a href="#h18-0-82" id="h18-0-82" class="i">+        mut tcp_rx: mpsc::Receiver&lt;Message&gt;,
</a><a href="#h18-0-83" id="h18-0-83" class="i">+        mut tcp_tx: mpsc::Sender&lt;Message&gt;,
</a><a href="#h18-0-84" id="h18-0-84" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-85" id="h18-0-85" class="i">+        let mut ticker = tokio::time::interval(TICK);
</a><a href="#h18-0-86" id="h18-0-86" class="i">+        let mut requests = HashMap::&lt;Vec&lt;u8&gt;, oneshot::Sender&lt;Response&gt;&gt;::new();
</a><a href="#h18-0-87" id="h18-0-87" class="i">+        loop {
</a><a href="#h18-0-88" id="h18-0-88" class="i">+            // FIXME Node.step() is blocking
</a><a href="#h18-0-89" id="h18-0-89" class="i">+            tokio::select! {
</a><a href="#h18-0-90" id="h18-0-90" class="i">+                _ = ticker.tick() =&gt; node = node.tick()?,
</a><a href="#h18-0-91" id="h18-0-91" class="i">+
</a><a href="#h18-0-92" id="h18-0-92" class="i">+                Some(msg) = tcp_rx.next() =&gt; node = node.step(msg)?,
</a><a href="#h18-0-93" id="h18-0-93" class="i">+
</a><a href="#h18-0-94" id="h18-0-94" class="i">+                Some(msg) = node_rx.next() =&gt; {
</a><a href="#h18-0-95" id="h18-0-95" class="i">+                    if msg.to.is_some() {
</a><a href="#h18-0-96" id="h18-0-96" class="i">+                        tcp_tx.send(msg).await?
</a><a href="#h18-0-97" id="h18-0-97" class="i">+                    } else if let Some(call_id) = msg.event.call_id() {
</a><a href="#h18-0-98" id="h18-0-98" class="i">+                        if let Some(response_tx) = requests.remove(&amp;call_id) {
</a><a href="#h18-0-99" id="h18-0-99" class="i">+                            let response = match msg.event {
</a><a href="#h18-0-100" id="h18-0-100" class="i">+                                Event::RespondState{response, ..} =&gt; Response::State(response),
</a><a href="#h18-0-101" id="h18-0-101" class="i">+                                Event::RespondError{error, ..} =&gt; Response::Error(error),
</a><a href="#h18-0-102" id="h18-0-102" class="i">+                                e =&gt; return Err(Error::Internal(format!(&quot;Unexpected Raft response {:?}&quot;, e))),
</a><a href="#h18-0-103" id="h18-0-103" class="i">+                            };
</a><a href="#h18-0-104" id="h18-0-104" class="i">+                            response_tx
</a><a href="#h18-0-105" id="h18-0-105" class="i">+                                .send(response)
</a><a href="#h18-0-106" id="h18-0-106" class="i">+                                .map_err(|e| Error::Internal(format!(&quot;Failed to send response {:?}&quot;, e)))?;
</a><a href="#h18-0-107" id="h18-0-107" class="i">+                        }
</a><a href="#h18-0-108" id="h18-0-108" class="i">+                    }
</a><a href="#h18-0-109" id="h18-0-109" class="i">+                }
</a><a href="#h18-0-110" id="h18-0-110" class="i">+
</a><a href="#h18-0-111" id="h18-0-111" class="i">+                Some((request, response_tx)) = client_rx.next() =&gt; {
</a><a href="#h18-0-112" id="h18-0-112" class="i">+                    if let Request::Status = request {
</a><a href="#h18-0-113" id="h18-0-113" class="i">+                        response_tx.send(Response::Status(node.status()?))
</a><a href="#h18-0-114" id="h18-0-114" class="i">+                            .map_err(|e| Error::Internal(format!(&quot;Failed to send response {:?}&quot;, e)))?;
</a><a href="#h18-0-115" id="h18-0-115" class="i">+                        continue
</a><a href="#h18-0-116" id="h18-0-116" class="i">+                    }
</a><a href="#h18-0-117" id="h18-0-117" class="i">+                    let call_id = Uuid::new_v4().as_bytes().to_vec();
</a><a href="#h18-0-118" id="h18-0-118" class="i">+                    requests.insert(call_id.clone(), response_tx);
</a><a href="#h18-0-119" id="h18-0-119" class="i">+                    let event = match request {
</a><a href="#h18-0-120" id="h18-0-120" class="i">+                        Request::Mutate(command) =&gt; Event::MutateState{call_id, command},
</a><a href="#h18-0-121" id="h18-0-121" class="i">+                        Request::Query(command) =&gt; Event::QueryState{call_id, command},
</a><a href="#h18-0-122" id="h18-0-122" class="i">+                        Request::Status =&gt; panic!(&quot;unexpected status request&quot;),
</a><a href="#h18-0-123" id="h18-0-123" class="i">+                    };
</a><a href="#h18-0-124" id="h18-0-124" class="i">+                    node = node.step(Message{from: None, to: None, term: 0, event})?;
</a><a href="#h18-0-125" id="h18-0-125" class="i">+                }
</a><a href="#h18-0-126" id="h18-0-126" class="i">+            }
</a><a href="#h18-0-127" id="h18-0-127" class="i">+        }
</a><a href="#h18-0-128" id="h18-0-128" class="i">+    }
</a><a href="#h18-0-129" id="h18-0-129" class="i">+
</a><a href="#h18-0-130" id="h18-0-130" class="i">+    /// Receives inbound messages from peers via TCP.
</a><a href="#h18-0-131" id="h18-0-131" class="i">+    async fn tcp_receive(
</a><a href="#h18-0-132" id="h18-0-132" class="i">+        mut listener: TcpListener,
</a><a href="#h18-0-133" id="h18-0-133" class="i">+        in_tx: mpsc::Sender&lt;Message&gt;,
</a><a href="#h18-0-134" id="h18-0-134" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-135" id="h18-0-135" class="i">+        while let Some(socket) = listener.try_next().await? {
</a><a href="#h18-0-136" id="h18-0-136" class="i">+            let peer = socket.peer_addr()?;
</a><a href="#h18-0-137" id="h18-0-137" class="i">+            let peer_in_tx = in_tx.clone();
</a><a href="#h18-0-138" id="h18-0-138" class="i">+            tokio::spawn(async move {
</a><a href="#h18-0-139" id="h18-0-139" class="i">+                debug!(&quot;Raft peer {} connected&quot;, peer);
</a><a href="#h18-0-140" id="h18-0-140" class="i">+                match Self::tcp_receive_peer(socket, peer_in_tx).await {
</a><a href="#h18-0-141" id="h18-0-141" class="i">+                    Ok(()) =&gt; debug!(&quot;Raft peer {} disconnected&quot;, peer),
</a><a href="#h18-0-142" id="h18-0-142" class="i">+                    Err(err) =&gt; error!(&quot;Raft peer {} error: {}&quot;, peer, err.to_string()),
</a><a href="#h18-0-143" id="h18-0-143" class="i">+                };
</a><a href="#h18-0-144" id="h18-0-144" class="i">+            });
</a><a href="#h18-0-145" id="h18-0-145" class="i">+        }
</a><a href="#h18-0-146" id="h18-0-146" class="i">+        Ok(())
</a><a href="#h18-0-147" id="h18-0-147" class="i">+    }
</a><a href="#h18-0-148" id="h18-0-148" class="i">+
</a><a href="#h18-0-149" id="h18-0-149" class="i">+    /// Receives inbound messages from a peer via TCP.
</a><a href="#h18-0-150" id="h18-0-150" class="i">+    async fn tcp_receive_peer(
</a><a href="#h18-0-151" id="h18-0-151" class="i">+        socket: TcpStream,
</a><a href="#h18-0-152" id="h18-0-152" class="i">+        mut in_tx: mpsc::Sender&lt;Message&gt;,
</a><a href="#h18-0-153" id="h18-0-153" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-154" id="h18-0-154" class="i">+        let mut stream = tokio_serde::SymmetricallyFramed::&lt;_, Message, _&gt;::new(
</a><a href="#h18-0-155" id="h18-0-155" class="i">+            Framed::new(socket, LengthDelimitedCodec::new()),
</a><a href="#h18-0-156" id="h18-0-156" class="i">+            tokio_serde::formats::SymmetricalCbor::&lt;Message&gt;::default(),
</a><a href="#h18-0-157" id="h18-0-157" class="i">+        );
</a><a href="#h18-0-158" id="h18-0-158" class="i">+        while let Some(message) = stream.try_next().await? {
</a><a href="#h18-0-159" id="h18-0-159" class="i">+            in_tx.send(message).await?;
</a><a href="#h18-0-160" id="h18-0-160" class="i">+        }
</a><a href="#h18-0-161" id="h18-0-161" class="i">+        Ok(())
</a><a href="#h18-0-162" id="h18-0-162" class="i">+    }
</a><a href="#h18-0-163" id="h18-0-163" class="i">+
</a><a href="#h18-0-164" id="h18-0-164" class="i">+    /// Sends outbound messages to peers via TCP.
</a><a href="#h18-0-165" id="h18-0-165" class="i">+    async fn tcp_send(
</a><a href="#h18-0-166" id="h18-0-166" class="i">+        peers: HashMap&lt;String, String&gt;,
</a><a href="#h18-0-167" id="h18-0-167" class="i">+        mut out_rx: mpsc::Receiver&lt;Message&gt;,
</a><a href="#h18-0-168" id="h18-0-168" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-169" id="h18-0-169" class="i">+        let mut peer_txs: HashMap&lt;String, mpsc::Sender&lt;Message&gt;&gt; = HashMap::new();
</a><a href="#h18-0-170" id="h18-0-170" class="i">+        for (id, addr) in peers.into_iter() {
</a><a href="#h18-0-171" id="h18-0-171" class="i">+            let (tx, rx) = mpsc::channel::&lt;Message&gt;(100);
</a><a href="#h18-0-172" id="h18-0-172" class="i">+            peer_txs.insert(id, tx);
</a><a href="#h18-0-173" id="h18-0-173" class="i">+            tokio::spawn(Self::tcp_send_peer(addr, rx));
</a><a href="#h18-0-174" id="h18-0-174" class="i">+        }
</a><a href="#h18-0-175" id="h18-0-175" class="i">+        while let Some(message) = out_rx.next().await {
</a><a href="#h18-0-176" id="h18-0-176" class="i">+            match message.to {
</a><a href="#h18-0-177" id="h18-0-177" class="i">+                None =&gt; error!(&quot;Received outbound message with no recipient&quot;),
</a><a href="#h18-0-178" id="h18-0-178" class="i">+                Some(ref to) =&gt; match peer_txs.get_mut(to) {
</a><a href="#h18-0-179" id="h18-0-179" class="i">+                    Some(ref mut tx) =&gt; tx.send(message).await?,
</a><a href="#h18-0-180" id="h18-0-180" class="i">+                    None =&gt; error!(&quot;Received outbound message for unknown peer {}&quot;, to),
</a><a href="#h18-0-181" id="h18-0-181" class="i">+                },
</a><a href="#h18-0-182" id="h18-0-182" class="i">+            }
</a><a href="#h18-0-183" id="h18-0-183" class="i">+        }
</a><a href="#h18-0-184" id="h18-0-184" class="i">+        Ok(())
</a><a href="#h18-0-185" id="h18-0-185" class="i">+    }
</a><a href="#h18-0-186" id="h18-0-186" class="i">+
</a><a href="#h18-0-187" id="h18-0-187" class="i">+    /// Sends outbound messages to a peer, continuously reconnecting.
</a><a href="#h18-0-188" id="h18-0-188" class="i">+    async fn tcp_send_peer(addr: String, mut out_rx: mpsc::Receiver&lt;Message&gt;) {
</a><a href="#h18-0-189" id="h18-0-189" class="i">+        loop {
</a><a href="#h18-0-190" id="h18-0-190" class="i">+            match TcpStream::connect(&amp;addr).await {
</a><a href="#h18-0-191" id="h18-0-191" class="i">+                Ok(socket) =&gt; {
</a><a href="#h18-0-192" id="h18-0-192" class="i">+                    debug!(&quot;Connected to Raft peer {}&quot;, addr);
</a><a href="#h18-0-193" id="h18-0-193" class="i">+                    match Self::tcp_send_peer_session(socket, &amp;mut out_rx).await {
</a><a href="#h18-0-194" id="h18-0-194" class="i">+                        Ok(()) =&gt; break,
</a><a href="#h18-0-195" id="h18-0-195" class="i">+                        Err(err) =&gt; error!(&quot;Failed sending to Raft peer {}: {}&quot;, addr, err),
</a><a href="#h18-0-196" id="h18-0-196" class="i">+                    }
</a><a href="#h18-0-197" id="h18-0-197" class="i">+                }
</a><a href="#h18-0-198" id="h18-0-198" class="i">+                Err(err) =&gt; error!(&quot;Failed to connect to Raft peer {}: {}&quot;, addr, err),
</a><a href="#h18-0-199" id="h18-0-199" class="i">+            }
</a><a href="#h18-0-200" id="h18-0-200" class="i">+            tokio::time::delay_for(Duration::from_millis(1000)).await;
</a><a href="#h18-0-201" id="h18-0-201" class="i">+        }
</a><a href="#h18-0-202" id="h18-0-202" class="i">+        debug!(&quot;Disconnected from Raft peer {}&quot;, addr);
</a><a href="#h18-0-203" id="h18-0-203" class="i">+    }
</a><a href="#h18-0-204" id="h18-0-204" class="i">+
</a><a href="#h18-0-205" id="h18-0-205" class="i">+    /// Sends outbound messages to a peer via a TCP session.
</a><a href="#h18-0-206" id="h18-0-206" class="i">+    async fn tcp_send_peer_session(
</a><a href="#h18-0-207" id="h18-0-207" class="i">+        socket: TcpStream,
</a><a href="#h18-0-208" id="h18-0-208" class="i">+        out_rx: &amp;mut mpsc::Receiver&lt;Message&gt;,
</a><a href="#h18-0-209" id="h18-0-209" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h18-0-210" id="h18-0-210" class="i">+        let mut stream = tokio_serde::SymmetricallyFramed::&lt;_, Message, _&gt;::new(
</a><a href="#h18-0-211" id="h18-0-211" class="i">+            Framed::new(socket, LengthDelimitedCodec::new()),
</a><a href="#h18-0-212" id="h18-0-212" class="i">+            tokio_serde::formats::SymmetricalCbor::&lt;Message&gt;::default(),
</a><a href="#h18-0-213" id="h18-0-213" class="i">+        );
</a><a href="#h18-0-214" id="h18-0-214" class="i">+        while let Some(message) = out_rx.next().await {
</a><a href="#h18-0-215" id="h18-0-215" class="i">+            stream.send(message).await?;
</a><a href="#h18-0-216" id="h18-0-216" class="i">+        }
</a><a href="#h18-0-217" id="h18-0-217" class="i">+        Ok(())
</a><a href="#h18-0-218" id="h18-0-218" class="i">+    }
</a><a href="#h18-0-219" id="h18-0-219" class="i">+}
</a><b>diff --git a/<a id="h19" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,59 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+use crate::Error;
</a><a href="#h19-0-1" id="h19-0-1" class="i">+
</a><a href="#h19-0-2" id="h19-0-2" class="i">+/// A Raft-managed state machine.
</a><a href="#h19-0-3" id="h19-0-3" class="i">+pub trait State {
</a><a href="#h19-0-4" id="h19-0-4" class="i">+    /// Mutates the state machine. If the state machine returns Error::Internal, the Raft node
</a><a href="#h19-0-5" id="h19-0-5" class="i">+    /// halts. For any other error, the state is applied and the error propagated to the caller.
</a><a href="#h19-0-6" id="h19-0-6" class="i">+    fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h19-0-7" id="h19-0-7" class="i">+
</a><a href="#h19-0-8" id="h19-0-8" class="i">+    /// Queries the state machine. All errors are propagated to the caller.
</a><a href="#h19-0-9" id="h19-0-9" class="i">+    fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt;;
</a><a href="#h19-0-10" id="h19-0-10" class="i">+}
</a><a href="#h19-0-11" id="h19-0-11" class="i">+
</a><a href="#h19-0-12" id="h19-0-12" class="i">+#[cfg(test)]
</a><a href="#h19-0-13" id="h19-0-13" class="i">+pub mod tests {
</a><a href="#h19-0-14" id="h19-0-14" class="i">+    use super::*;
</a><a href="#h19-0-15" id="h19-0-15" class="i">+    use std::sync::{Arc, Mutex};
</a><a href="#h19-0-16" id="h19-0-16" class="i">+
</a><a href="#h19-0-17" id="h19-0-17" class="i">+    #[derive(Clone, Debug)]
</a><a href="#h19-0-18" id="h19-0-18" class="i">+    pub struct TestState {
</a><a href="#h19-0-19" id="h19-0-19" class="i">+        commands: Arc&lt;Mutex&lt;Vec&lt;Vec&lt;u8&gt;&gt;&gt;&gt;,
</a><a href="#h19-0-20" id="h19-0-20" class="i">+    }
</a><a href="#h19-0-21" id="h19-0-21" class="i">+
</a><a href="#h19-0-22" id="h19-0-22" class="i">+    impl TestState {
</a><a href="#h19-0-23" id="h19-0-23" class="i">+        pub fn new() -&gt; Self {
</a><a href="#h19-0-24" id="h19-0-24" class="i">+            Self { commands: Arc::new(Mutex::new(Vec::new())) }
</a><a href="#h19-0-25" id="h19-0-25" class="i">+        }
</a><a href="#h19-0-26" id="h19-0-26" class="i">+
</a><a href="#h19-0-27" id="h19-0-27" class="i">+        pub fn list(&amp;self) -&gt; Vec&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h19-0-28" id="h19-0-28" class="i">+            self.commands.lock().unwrap().clone()
</a><a href="#h19-0-29" id="h19-0-29" class="i">+        }
</a><a href="#h19-0-30" id="h19-0-30" class="i">+    }
</a><a href="#h19-0-31" id="h19-0-31" class="i">+
</a><a href="#h19-0-32" id="h19-0-32" class="i">+    impl State for TestState {
</a><a href="#h19-0-33" id="h19-0-33" class="i">+        // Appends the command to the internal commands list, and returns the command prefixed with
</a><a href="#h19-0-34" id="h19-0-34" class="i">+        // a 0xff byte. Returns Error::Internal if the payload is != 1 byte, and Error::Value if
</a><a href="#h19-0-35" id="h19-0-35" class="i">+        // the value is 0xff.
</a><a href="#h19-0-36" id="h19-0-36" class="i">+        fn mutate(&amp;mut self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h19-0-37" id="h19-0-37" class="i">+            if command.len() != 1 {
</a><a href="#h19-0-38" id="h19-0-38" class="i">+                return Err(Error::Internal(&quot;Command must be 1 byte&quot;.into()));
</a><a href="#h19-0-39" id="h19-0-39" class="i">+            }
</a><a href="#h19-0-40" id="h19-0-40" class="i">+            if command[0] == 0xff {
</a><a href="#h19-0-41" id="h19-0-41" class="i">+                return Err(Error::Value(&quot;Command cannot be 0xff&quot;.into()));
</a><a href="#h19-0-42" id="h19-0-42" class="i">+            }
</a><a href="#h19-0-43" id="h19-0-43" class="i">+            self.commands.lock()?.push(command.clone());
</a><a href="#h19-0-44" id="h19-0-44" class="i">+            Ok(vec![0xff, command[0]])
</a><a href="#h19-0-45" id="h19-0-45" class="i">+        }
</a><a href="#h19-0-46" id="h19-0-46" class="i">+
</a><a href="#h19-0-47" id="h19-0-47" class="i">+        // Reads the command in the internal commands list at the index
</a><a href="#h19-0-48" id="h19-0-48" class="i">+        // given by the query command (1-based). Returns the stored command prefixed by
</a><a href="#h19-0-49" id="h19-0-49" class="i">+        // 0xbb, or 0xbb 0x00 if not found.
</a><a href="#h19-0-50" id="h19-0-50" class="i">+        fn query(&amp;self, command: Vec&lt;u8&gt;) -&gt; Result&lt;Vec&lt;u8&gt;, Error&gt; {
</a><a href="#h19-0-51" id="h19-0-51" class="i">+            if command.len() != 1 {
</a><a href="#h19-0-52" id="h19-0-52" class="i">+                return Err(Error::Value(&quot;Query payload must be 1 byte&quot;.into()));
</a><a href="#h19-0-53" id="h19-0-53" class="i">+            }
</a><a href="#h19-0-54" id="h19-0-54" class="i">+            let index = command[0] as usize;
</a><a href="#h19-0-55" id="h19-0-55" class="i">+            Ok(vec![0xbb, self.commands.lock()?.get(index - 1).map(|c| c[0]).unwrap_or(0x00)])
</a><a href="#h19-0-56" id="h19-0-56" class="i">+        }
</a><a href="#h19-0-57" id="h19-0-57" class="i">+    }
</a><a href="#h19-0-58" id="h19-0-58" class="i">+}
</a><b>diff --git a/<a id="h20" href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a> b/<a href="../file/src/raft/transport.rs.html">src/raft/transport.rs</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -1,220 +0,0 @@
</a><a href="#h20-0-0" id="h20-0-0" class="d">-use super::log::Entry;
</a><a href="#h20-0-1" id="h20-0-1" class="d">-use crate::Error;
</a><a href="#h20-0-2" id="h20-0-2" class="d">-use crossbeam::channel::Receiver;
</a><a href="#h20-0-3" id="h20-0-3" class="d">-
</a><a href="#h20-0-4" id="h20-0-4" class="d">-/// A transport for communication between a Raft node and its peers.
</a><a href="#h20-0-5" id="h20-0-5" class="d">-pub trait Transport {
</a><a href="#h20-0-6" id="h20-0-6" class="d">-    /// Returns a channel for receiving inbound messages.
</a><a href="#h20-0-7" id="h20-0-7" class="d">-    fn receiver(&amp;self) -&gt; Receiver&lt;Message&gt;;
</a><a href="#h20-0-8" id="h20-0-8" class="d">-
</a><a href="#h20-0-9" id="h20-0-9" class="d">-    /// Sends a message to a peer.
</a><a href="#h20-0-10" id="h20-0-10" class="d">-    fn send(&amp;self, msg: Message) -&gt; Result&lt;(), Error&gt;;
</a><a href="#h20-0-11" id="h20-0-11" class="d">-}
</a><a href="#h20-0-12" id="h20-0-12" class="d">-
</a><a href="#h20-0-13" id="h20-0-13" class="d">-/// A message passed between Raft nodes.
</a><a href="#h20-0-14" id="h20-0-14" class="d">-#[derive(Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h20-0-15" id="h20-0-15" class="d">-pub struct Message {
</a><a href="#h20-0-16" id="h20-0-16" class="d">-    /// The current term of the sender.
</a><a href="#h20-0-17" id="h20-0-17" class="d">-    pub term: u64,
</a><a href="#h20-0-18" id="h20-0-18" class="d">-    /// The ID of the sending node, or None if local sender.
</a><a href="#h20-0-19" id="h20-0-19" class="d">-    pub from: Option&lt;String&gt;,
</a><a href="#h20-0-20" id="h20-0-20" class="d">-    /// The ID of the receiving node, or None if local receiver.
</a><a href="#h20-0-21" id="h20-0-21" class="d">-    pub to: Option&lt;String&gt;,
</a><a href="#h20-0-22" id="h20-0-22" class="d">-    /// The message event.
</a><a href="#h20-0-23" id="h20-0-23" class="d">-    pub event: Event,
</a><a href="#h20-0-24" id="h20-0-24" class="d">-}
</a><a href="#h20-0-25" id="h20-0-25" class="d">-
</a><a href="#h20-0-26" id="h20-0-26" class="d">-impl Message {
</a><a href="#h20-0-27" id="h20-0-27" class="d">-    /// Normalizes a message by setting to and term for local messages.
</a><a href="#h20-0-28" id="h20-0-28" class="d">-    pub fn normalize(&amp;mut self, node_id: &amp;str, term: u64) {
</a><a href="#h20-0-29" id="h20-0-29" class="d">-        if self.from.is_none() &amp;&amp; self.to.is_none() {
</a><a href="#h20-0-30" id="h20-0-30" class="d">-            self.to = Some(node_id.to_owned());
</a><a href="#h20-0-31" id="h20-0-31" class="d">-            if self.term == 0 {
</a><a href="#h20-0-32" id="h20-0-32" class="d">-                self.term = term;
</a><a href="#h20-0-33" id="h20-0-33" class="d">-            }
</a><a href="#h20-0-34" id="h20-0-34" class="d">-        }
</a><a href="#h20-0-35" id="h20-0-35" class="d">-    }
</a><a href="#h20-0-36" id="h20-0-36" class="d">-
</a><a href="#h20-0-37" id="h20-0-37" class="d">-    /// Validates a message against the receiving node.
</a><a href="#h20-0-38" id="h20-0-38" class="d">-    pub fn validate(&amp;self, node_id: &amp;str, term: u64) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h20-0-39" id="h20-0-39" class="d">-        // Don&#39;t allow local messages without call ID
</a><a href="#h20-0-40" id="h20-0-40" class="d">-        if self.from.is_none() &amp;&amp; self.event.call_id().is_none() {
</a><a href="#h20-0-41" id="h20-0-41" class="d">-            return Err(Error::Internal(format!(
</a><a href="#h20-0-42" id="h20-0-42" class="d">-                &quot;Received local non-call event: {:?}&quot;,
</a><a href="#h20-0-43" id="h20-0-43" class="d">-                self.event
</a><a href="#h20-0-44" id="h20-0-44" class="d">-            )));
</a><a href="#h20-0-45" id="h20-0-45" class="d">-        }
</a><a href="#h20-0-46" id="h20-0-46" class="d">-
</a><a href="#h20-0-47" id="h20-0-47" class="d">-        // Ignore messages from past term
</a><a href="#h20-0-48" id="h20-0-48" class="d">-        if self.term &lt; term {
</a><a href="#h20-0-49" id="h20-0-49" class="d">-            return Err(Error::Internal(format!(&quot;Ignoring message from stale term {}&quot;, self.term)));
</a><a href="#h20-0-50" id="h20-0-50" class="d">-        }
</a><a href="#h20-0-51" id="h20-0-51" class="d">-
</a><a href="#h20-0-52" id="h20-0-52" class="d">-        // Ignore messages addressed to peers or local client
</a><a href="#h20-0-53" id="h20-0-53" class="d">-        if let Some(to) = &amp;self.to {
</a><a href="#h20-0-54" id="h20-0-54" class="d">-            if to != node_id {
</a><a href="#h20-0-55" id="h20-0-55" class="d">-                return Err(Error::Internal(format!(&quot;Ignoring message for other node {}&quot;, to)));
</a><a href="#h20-0-56" id="h20-0-56" class="d">-            }
</a><a href="#h20-0-57" id="h20-0-57" class="d">-        } else {
</a><a href="#h20-0-58" id="h20-0-58" class="d">-            return Err(Error::Internal(&quot;Ignoring message for local client&quot;.into()));
</a><a href="#h20-0-59" id="h20-0-59" class="d">-        }
</a><a href="#h20-0-60" id="h20-0-60" class="d">-        Ok(())
</a><a href="#h20-0-61" id="h20-0-61" class="d">-    }
</a><a href="#h20-0-62" id="h20-0-62" class="d">-}
</a><a href="#h20-0-63" id="h20-0-63" class="d">-
</a><a href="#h20-0-64" id="h20-0-64" class="d">-/// An event contained within messages.
</a><a href="#h20-0-65" id="h20-0-65" class="d">-#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h20-0-66" id="h20-0-66" class="d">-pub enum Event {
</a><a href="#h20-0-67" id="h20-0-67" class="d">-    /// Leaders send periodic heartbeats to its followers.
</a><a href="#h20-0-68" id="h20-0-68" class="d">-    Heartbeat {
</a><a href="#h20-0-69" id="h20-0-69" class="d">-        /// The index of the leader&#39;s last committed log entry.
</a><a href="#h20-0-70" id="h20-0-70" class="d">-        commit_index: u64,
</a><a href="#h20-0-71" id="h20-0-71" class="d">-        /// The term of the leader&#39;s last committed log entry.
</a><a href="#h20-0-72" id="h20-0-72" class="d">-        commit_term: u64,
</a><a href="#h20-0-73" id="h20-0-73" class="d">-    },
</a><a href="#h20-0-74" id="h20-0-74" class="d">-    /// Followers confirm loyalty to leader after heartbeats.
</a><a href="#h20-0-75" id="h20-0-75" class="d">-    ConfirmLeader {
</a><a href="#h20-0-76" id="h20-0-76" class="d">-        /// The commit_index of the original leader heartbeat, to confirm
</a><a href="#h20-0-77" id="h20-0-77" class="d">-        /// read requests.
</a><a href="#h20-0-78" id="h20-0-78" class="d">-        commit_index: u64,
</a><a href="#h20-0-79" id="h20-0-79" class="d">-        /// If false, the follower does not have the entry at commit_index
</a><a href="#h20-0-80" id="h20-0-80" class="d">-        /// and would like the leader to replicate it.
</a><a href="#h20-0-81" id="h20-0-81" class="d">-        has_committed: bool,
</a><a href="#h20-0-82" id="h20-0-82" class="d">-    },
</a><a href="#h20-0-83" id="h20-0-83" class="d">-    /// Candidates solicit votes from all peers.
</a><a href="#h20-0-84" id="h20-0-84" class="d">-    SolicitVote {
</a><a href="#h20-0-85" id="h20-0-85" class="d">-        // The index of the candidate&#39;s last stored log entry
</a><a href="#h20-0-86" id="h20-0-86" class="d">-        last_index: u64,
</a><a href="#h20-0-87" id="h20-0-87" class="d">-        // The term of the candidate&#39;s last stored log entry
</a><a href="#h20-0-88" id="h20-0-88" class="d">-        last_term: u64,
</a><a href="#h20-0-89" id="h20-0-89" class="d">-    },
</a><a href="#h20-0-90" id="h20-0-90" class="d">-    /// Followers may grant votes to candidates.
</a><a href="#h20-0-91" id="h20-0-91" class="d">-    GrantVote,
</a><a href="#h20-0-92" id="h20-0-92" class="d">-    /// Leaders replicate a set of log entries to followers.
</a><a href="#h20-0-93" id="h20-0-93" class="d">-    ReplicateEntries {
</a><a href="#h20-0-94" id="h20-0-94" class="d">-        /// The index of the log entry immediately preceding the submitted commands.
</a><a href="#h20-0-95" id="h20-0-95" class="d">-        base_index: u64,
</a><a href="#h20-0-96" id="h20-0-96" class="d">-        /// The term of the log entry immediately preceding the submitted commands.
</a><a href="#h20-0-97" id="h20-0-97" class="d">-        base_term: u64,
</a><a href="#h20-0-98" id="h20-0-98" class="d">-        /// Commands to replicate.
</a><a href="#h20-0-99" id="h20-0-99" class="d">-        entries: Vec&lt;Entry&gt;,
</a><a href="#h20-0-100" id="h20-0-100" class="d">-    },
</a><a href="#h20-0-101" id="h20-0-101" class="d">-    /// Followers may accept a set of log entries from a leader.
</a><a href="#h20-0-102" id="h20-0-102" class="d">-    AcceptEntries {
</a><a href="#h20-0-103" id="h20-0-103" class="d">-        /// The index of the last log entry.
</a><a href="#h20-0-104" id="h20-0-104" class="d">-        last_index: u64,
</a><a href="#h20-0-105" id="h20-0-105" class="d">-    },
</a><a href="#h20-0-106" id="h20-0-106" class="d">-    /// Followers may also reject a set of log entries from a leader.
</a><a href="#h20-0-107" id="h20-0-107" class="d">-    RejectEntries,
</a><a href="#h20-0-108" id="h20-0-108" class="d">-    /// Queries the state machine.
</a><a href="#h20-0-109" id="h20-0-109" class="d">-    QueryState {
</a><a href="#h20-0-110" id="h20-0-110" class="d">-        /// The call ID.
</a><a href="#h20-0-111" id="h20-0-111" class="d">-        call_id: Vec&lt;u8&gt;,
</a><a href="#h20-0-112" id="h20-0-112" class="d">-        /// The state machine command.
</a><a href="#h20-0-113" id="h20-0-113" class="d">-        command: Vec&lt;u8&gt;,
</a><a href="#h20-0-114" id="h20-0-114" class="d">-    },
</a><a href="#h20-0-115" id="h20-0-115" class="d">-    /// Mutates the state machine.
</a><a href="#h20-0-116" id="h20-0-116" class="d">-    MutateState {
</a><a href="#h20-0-117" id="h20-0-117" class="d">-        /// The call ID.
</a><a href="#h20-0-118" id="h20-0-118" class="d">-        call_id: Vec&lt;u8&gt;,
</a><a href="#h20-0-119" id="h20-0-119" class="d">-        /// The state machine command.
</a><a href="#h20-0-120" id="h20-0-120" class="d">-        command: Vec&lt;u8&gt;,
</a><a href="#h20-0-121" id="h20-0-121" class="d">-    },
</a><a href="#h20-0-122" id="h20-0-122" class="d">-    /// The response of a state machine command.
</a><a href="#h20-0-123" id="h20-0-123" class="d">-    RespondState {
</a><a href="#h20-0-124" id="h20-0-124" class="d">-        /// The call ID.
</a><a href="#h20-0-125" id="h20-0-125" class="d">-        call_id: Vec&lt;u8&gt;,
</a><a href="#h20-0-126" id="h20-0-126" class="d">-        /// The command output.
</a><a href="#h20-0-127" id="h20-0-127" class="d">-        response: Vec&lt;u8&gt;,
</a><a href="#h20-0-128" id="h20-0-128" class="d">-    },
</a><a href="#h20-0-129" id="h20-0-129" class="d">-    /// An error response
</a><a href="#h20-0-130" id="h20-0-130" class="d">-    RespondError {
</a><a href="#h20-0-131" id="h20-0-131" class="d">-        /// The call ID.
</a><a href="#h20-0-132" id="h20-0-132" class="d">-        call_id: Vec&lt;u8&gt;,
</a><a href="#h20-0-133" id="h20-0-133" class="d">-        /// The error.
</a><a href="#h20-0-134" id="h20-0-134" class="d">-        error: Error,
</a><a href="#h20-0-135" id="h20-0-135" class="d">-    },
</a><a href="#h20-0-136" id="h20-0-136" class="d">-}
</a><a href="#h20-0-137" id="h20-0-137" class="d">-
</a><a href="#h20-0-138" id="h20-0-138" class="d">-impl Event {
</a><a href="#h20-0-139" id="h20-0-139" class="d">-    /// Returns the call ID for the event, if any
</a><a href="#h20-0-140" id="h20-0-140" class="d">-    pub fn call_id(&amp;self) -&gt; Option&lt;Vec&lt;u8&gt;&gt; {
</a><a href="#h20-0-141" id="h20-0-141" class="d">-        match self {
</a><a href="#h20-0-142" id="h20-0-142" class="d">-            Event::QueryState { call_id, .. }
</a><a href="#h20-0-143" id="h20-0-143" class="d">-            | Event::MutateState { call_id, .. }
</a><a href="#h20-0-144" id="h20-0-144" class="d">-            | Event::RespondState { call_id, .. }
</a><a href="#h20-0-145" id="h20-0-145" class="d">-            | Event::RespondError { call_id, .. } =&gt; Some(call_id.clone()),
</a><a href="#h20-0-146" id="h20-0-146" class="d">-            _ =&gt; None,
</a><a href="#h20-0-147" id="h20-0-147" class="d">-        }
</a><a href="#h20-0-148" id="h20-0-148" class="d">-    }
</a><a href="#h20-0-149" id="h20-0-149" class="d">-}
</a><a href="#h20-0-150" id="h20-0-150" class="d">-
</a><a href="#h20-0-151" id="h20-0-151" class="d">-#[cfg(test)]
</a><a href="#h20-0-152" id="h20-0-152" class="d">-mod tests {
</a><a href="#h20-0-153" id="h20-0-153" class="d">-    use super::*;
</a><a href="#h20-0-154" id="h20-0-154" class="d">-
</a><a href="#h20-0-155" id="h20-0-155" class="d">-    #[test]
</a><a href="#h20-0-156" id="h20-0-156" class="d">-    fn normalize() {
</a><a href="#h20-0-157" id="h20-0-157" class="d">-        let mut msg = Message {
</a><a href="#h20-0-158" id="h20-0-158" class="d">-            from: None,
</a><a href="#h20-0-159" id="h20-0-159" class="d">-            to: None,
</a><a href="#h20-0-160" id="h20-0-160" class="d">-            term: 0,
</a><a href="#h20-0-161" id="h20-0-161" class="d">-            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h20-0-162" id="h20-0-162" class="d">-        };
</a><a href="#h20-0-163" id="h20-0-163" class="d">-        msg.normalize(&quot;to&quot;, 3);
</a><a href="#h20-0-164" id="h20-0-164" class="d">-        assert_eq!(
</a><a href="#h20-0-165" id="h20-0-165" class="d">-            msg,
</a><a href="#h20-0-166" id="h20-0-166" class="d">-            Message {
</a><a href="#h20-0-167" id="h20-0-167" class="d">-                from: None,
</a><a href="#h20-0-168" id="h20-0-168" class="d">-                to: Some(&quot;to&quot;.into()),
</a><a href="#h20-0-169" id="h20-0-169" class="d">-                term: 3,
</a><a href="#h20-0-170" id="h20-0-170" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h20-0-171" id="h20-0-171" class="d">-            }
</a><a href="#h20-0-172" id="h20-0-172" class="d">-        )
</a><a href="#h20-0-173" id="h20-0-173" class="d">-    }
</a><a href="#h20-0-174" id="h20-0-174" class="d">-
</a><a href="#h20-0-175" id="h20-0-175" class="d">-    #[test]
</a><a href="#h20-0-176" id="h20-0-176" class="d">-    fn normalize_peer() {
</a><a href="#h20-0-177" id="h20-0-177" class="d">-        let mut msg = Message {
</a><a href="#h20-0-178" id="h20-0-178" class="d">-            from: Some(&quot;from&quot;.into()),
</a><a href="#h20-0-179" id="h20-0-179" class="d">-            to: Some(&quot;to&quot;.into()),
</a><a href="#h20-0-180" id="h20-0-180" class="d">-            term: 3,
</a><a href="#h20-0-181" id="h20-0-181" class="d">-            event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h20-0-182" id="h20-0-182" class="d">-        };
</a><a href="#h20-0-183" id="h20-0-183" class="d">-        msg.normalize(&quot;other&quot;, 7);
</a><a href="#h20-0-184" id="h20-0-184" class="d">-        assert_eq!(
</a><a href="#h20-0-185" id="h20-0-185" class="d">-            msg,
</a><a href="#h20-0-186" id="h20-0-186" class="d">-            Message {
</a><a href="#h20-0-187" id="h20-0-187" class="d">-                from: Some(&quot;from&quot;.into()),
</a><a href="#h20-0-188" id="h20-0-188" class="d">-                to: Some(&quot;to&quot;.into()),
</a><a href="#h20-0-189" id="h20-0-189" class="d">-                term: 3,
</a><a href="#h20-0-190" id="h20-0-190" class="d">-                event: Event::Heartbeat { commit_index: 1, commit_term: 1 },
</a><a href="#h20-0-191" id="h20-0-191" class="d">-            }
</a><a href="#h20-0-192" id="h20-0-192" class="d">-        )
</a><a href="#h20-0-193" id="h20-0-193" class="d">-    }
</a><a href="#h20-0-194" id="h20-0-194" class="d">-
</a><a href="#h20-0-195" id="h20-0-195" class="d">-    #[test]
</a><a href="#h20-0-196" id="h20-0-196" class="d">-    fn validate() {
</a><a href="#h20-0-197" id="h20-0-197" class="d">-        let event = Event::Heartbeat { commit_index: 1, commit_term: 1 };
</a><a href="#h20-0-198" id="h20-0-198" class="d">-
</a><a href="#h20-0-199" id="h20-0-199" class="d">-        // Errors on stale term
</a><a href="#h20-0-200" id="h20-0-200" class="d">-        assert!(Message {
</a><a href="#h20-0-201" id="h20-0-201" class="d">-            from: Some(&quot;b&quot;.into()),
</a><a href="#h20-0-202" id="h20-0-202" class="d">-            to: Some(&quot;a&quot;.into()),
</a><a href="#h20-0-203" id="h20-0-203" class="d">-            term: 2,
</a><a href="#h20-0-204" id="h20-0-204" class="d">-            event: event.clone(),
</a><a href="#h20-0-205" id="h20-0-205" class="d">-        }
</a><a href="#h20-0-206" id="h20-0-206" class="d">-        .validate(&quot;a&quot;, 3)
</a><a href="#h20-0-207" id="h20-0-207" class="d">-        .is_err());
</a><a href="#h20-0-208" id="h20-0-208" class="d">-
</a><a href="#h20-0-209" id="h20-0-209" class="d">-        // Errors on no receiver
</a><a href="#h20-0-210" id="h20-0-210" class="d">-        assert!(Message { from: Some(&quot;b&quot;.into()), to: None, term: 3, event: event.clone() }
</a><a href="#h20-0-211" id="h20-0-211" class="d">-            .validate(&quot;a&quot;, 3)
</a><a href="#h20-0-212" id="h20-0-212" class="d">-            .is_err());
</a><a href="#h20-0-213" id="h20-0-213" class="d">-
</a><a href="#h20-0-214" id="h20-0-214" class="d">-        // Errors on other receiver
</a><a href="#h20-0-215" id="h20-0-215" class="d">-        assert!(Message { from: Some(&quot;b&quot;.into()), to: Some(&quot;c&quot;.into()), term: 3, event: event }
</a><a href="#h20-0-216" id="h20-0-216" class="d">-            .validate(&quot;a&quot;, 3)
</a><a href="#h20-0-217" id="h20-0-217" class="d">-            .is_err());
</a><a href="#h20-0-218" id="h20-0-218" class="d">-    }
</a><a href="#h20-0-219" id="h20-0-219" class="d">-}
</a><b>diff --git a/<a id="h21" href="../file/src/server.rs.html">src/server.rs</a> b/<a href="../file/src/server.rs.html">src/server.rs</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,191 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+use crate::kv;
</a><a href="#h21-0-1" id="h21-0-1" class="i">+use crate::raft;
</a><a href="#h21-0-2" id="h21-0-2" class="i">+use crate::sql;
</a><a href="#h21-0-3" id="h21-0-3" class="i">+use crate::sql::engine::{Engine as _, Mode};
</a><a href="#h21-0-4" id="h21-0-4" class="i">+use crate::sql::execution::ResultSet;
</a><a href="#h21-0-5" id="h21-0-5" class="i">+use crate::sql::schema::{Catalog as _, Table};
</a><a href="#h21-0-6" id="h21-0-6" class="i">+use crate::sql::types::Row;
</a><a href="#h21-0-7" id="h21-0-7" class="i">+use crate::Error;
</a><a href="#h21-0-8" id="h21-0-8" class="i">+
</a><a href="#h21-0-9" id="h21-0-9" class="i">+use futures::sink::SinkExt as _;
</a><a href="#h21-0-10" id="h21-0-10" class="i">+use std::collections::HashMap;
</a><a href="#h21-0-11" id="h21-0-11" class="i">+use std::fs;
</a><a href="#h21-0-12" id="h21-0-12" class="i">+use std::path::Path;
</a><a href="#h21-0-13" id="h21-0-13" class="i">+use tokio::net::{TcpListener, TcpStream};
</a><a href="#h21-0-14" id="h21-0-14" class="i">+use tokio::stream::StreamExt as _;
</a><a href="#h21-0-15" id="h21-0-15" class="i">+use tokio_util::codec::{Framed, LengthDelimitedCodec};
</a><a href="#h21-0-16" id="h21-0-16" class="i">+
</a><a href="#h21-0-17" id="h21-0-17" class="i">+/// A ToyDB server.
</a><a href="#h21-0-18" id="h21-0-18" class="i">+pub struct Server {
</a><a href="#h21-0-19" id="h21-0-19" class="i">+    raft: raft::Server&lt;kv::storage::BLog, sql::engine::raft::State&lt;kv::storage::File&gt;&gt;,
</a><a href="#h21-0-20" id="h21-0-20" class="i">+    raft_listener: Option&lt;TcpListener&gt;,
</a><a href="#h21-0-21" id="h21-0-21" class="i">+    sql_listener: Option&lt;TcpListener&gt;,
</a><a href="#h21-0-22" id="h21-0-22" class="i">+}
</a><a href="#h21-0-23" id="h21-0-23" class="i">+
</a><a href="#h21-0-24" id="h21-0-24" class="i">+impl Server {
</a><a href="#h21-0-25" id="h21-0-25" class="i">+    /// Creates a new ToyDB server.
</a><a href="#h21-0-26" id="h21-0-26" class="i">+    pub fn new(id: &amp;str, peers: HashMap&lt;String, String&gt;, dir: &amp;str) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h21-0-27" id="h21-0-27" class="i">+        let path = Path::new(dir);
</a><a href="#h21-0-28" id="h21-0-28" class="i">+        fs::create_dir_all(path)?;
</a><a href="#h21-0-29" id="h21-0-29" class="i">+        Ok(Server {
</a><a href="#h21-0-30" id="h21-0-30" class="i">+            raft: raft::Server::new(
</a><a href="#h21-0-31" id="h21-0-31" class="i">+                id,
</a><a href="#h21-0-32" id="h21-0-32" class="i">+                peers,
</a><a href="#h21-0-33" id="h21-0-33" class="i">+                raft::Log::new(kv::Simple::new(kv::storage::BLog::new(
</a><a href="#h21-0-34" id="h21-0-34" class="i">+                    fs::OpenOptions::new()
</a><a href="#h21-0-35" id="h21-0-35" class="i">+                        .read(true)
</a><a href="#h21-0-36" id="h21-0-36" class="i">+                        .write(true)
</a><a href="#h21-0-37" id="h21-0-37" class="i">+                        .create(true)
</a><a href="#h21-0-38" id="h21-0-38" class="i">+                        .open(path.join(&quot;raft&quot;))?,
</a><a href="#h21-0-39" id="h21-0-39" class="i">+                )?))?,
</a><a href="#h21-0-40" id="h21-0-40" class="i">+                sql::engine::Raft::new_state(kv::MVCC::new(kv::storage::File::new(
</a><a href="#h21-0-41" id="h21-0-41" class="i">+                    fs::OpenOptions::new()
</a><a href="#h21-0-42" id="h21-0-42" class="i">+                        .read(true)
</a><a href="#h21-0-43" id="h21-0-43" class="i">+                        .write(true)
</a><a href="#h21-0-44" id="h21-0-44" class="i">+                        .create(true)
</a><a href="#h21-0-45" id="h21-0-45" class="i">+                        .open(path.join(&quot;state&quot;))?,
</a><a href="#h21-0-46" id="h21-0-46" class="i">+                )?)),
</a><a href="#h21-0-47" id="h21-0-47" class="i">+            )?,
</a><a href="#h21-0-48" id="h21-0-48" class="i">+            raft_listener: None,
</a><a href="#h21-0-49" id="h21-0-49" class="i">+            sql_listener: None,
</a><a href="#h21-0-50" id="h21-0-50" class="i">+        })
</a><a href="#h21-0-51" id="h21-0-51" class="i">+    }
</a><a href="#h21-0-52" id="h21-0-52" class="i">+
</a><a href="#h21-0-53" id="h21-0-53" class="i">+    /// Starts listening on the given ports. Must be called before serve.
</a><a href="#h21-0-54" id="h21-0-54" class="i">+    pub async fn listen(mut self, sql_addr: &amp;str, raft_addr: &amp;str) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h21-0-55" id="h21-0-55" class="i">+        let (sql, raft) =
</a><a href="#h21-0-56" id="h21-0-56" class="i">+            tokio::try_join!(TcpListener::bind(sql_addr), TcpListener::bind(raft_addr),)?;
</a><a href="#h21-0-57" id="h21-0-57" class="i">+        info!(&quot;Listening on {} (SQL) and {} (Raft)&quot;, sql.local_addr()?, raft.local_addr()?);
</a><a href="#h21-0-58" id="h21-0-58" class="i">+        self.sql_listener = Some(sql);
</a><a href="#h21-0-59" id="h21-0-59" class="i">+        self.raft_listener = Some(raft);
</a><a href="#h21-0-60" id="h21-0-60" class="i">+        Ok(self)
</a><a href="#h21-0-61" id="h21-0-61" class="i">+    }
</a><a href="#h21-0-62" id="h21-0-62" class="i">+
</a><a href="#h21-0-63" id="h21-0-63" class="i">+    /// Serves Raft and SQL requests until the returned future is dropped. Consumes the server.
</a><a href="#h21-0-64" id="h21-0-64" class="i">+    pub async fn serve(self) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-65" id="h21-0-65" class="i">+        let sql_listener = self
</a><a href="#h21-0-66" id="h21-0-66" class="i">+            .sql_listener
</a><a href="#h21-0-67" id="h21-0-67" class="i">+            .ok_or_else(|| Error::Internal(&quot;Must listen before serving&quot;.into()))?;
</a><a href="#h21-0-68" id="h21-0-68" class="i">+        let raft_listener = self
</a><a href="#h21-0-69" id="h21-0-69" class="i">+            .raft_listener
</a><a href="#h21-0-70" id="h21-0-70" class="i">+            .ok_or_else(|| Error::Internal(&quot;Must listen before serving&quot;.into()))?;
</a><a href="#h21-0-71" id="h21-0-71" class="i">+        let sql_engine = sql::engine::Raft::new(self.raft.client().await);
</a><a href="#h21-0-72" id="h21-0-72" class="i">+
</a><a href="#h21-0-73" id="h21-0-73" class="i">+        tokio::try_join!(
</a><a href="#h21-0-74" id="h21-0-74" class="i">+            self.raft.serve(raft_listener),
</a><a href="#h21-0-75" id="h21-0-75" class="i">+            Self::serve_sql(sql_listener, sql_engine),
</a><a href="#h21-0-76" id="h21-0-76" class="i">+        )?;
</a><a href="#h21-0-77" id="h21-0-77" class="i">+        Ok(())
</a><a href="#h21-0-78" id="h21-0-78" class="i">+    }
</a><a href="#h21-0-79" id="h21-0-79" class="i">+
</a><a href="#h21-0-80" id="h21-0-80" class="i">+    /// Serves SQL clients.
</a><a href="#h21-0-81" id="h21-0-81" class="i">+    async fn serve_sql(mut listener: TcpListener, engine: sql::engine::Raft) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-82" id="h21-0-82" class="i">+        while let Some(socket) = listener.try_next().await? {
</a><a href="#h21-0-83" id="h21-0-83" class="i">+            let peer = socket.peer_addr()?;
</a><a href="#h21-0-84" id="h21-0-84" class="i">+            let session = Session::new(engine.clone())?;
</a><a href="#h21-0-85" id="h21-0-85" class="i">+            tokio::spawn(async move {
</a><a href="#h21-0-86" id="h21-0-86" class="i">+                info!(&quot;Client {} connected&quot;, peer);
</a><a href="#h21-0-87" id="h21-0-87" class="i">+                match session.handle(socket).await {
</a><a href="#h21-0-88" id="h21-0-88" class="i">+                    Ok(()) =&gt; info!(&quot;Client {} disconnected&quot;, peer),
</a><a href="#h21-0-89" id="h21-0-89" class="i">+                    Err(err) =&gt; error!(&quot;Client {} error: {}&quot;, peer, err),
</a><a href="#h21-0-90" id="h21-0-90" class="i">+                }
</a><a href="#h21-0-91" id="h21-0-91" class="i">+            });
</a><a href="#h21-0-92" id="h21-0-92" class="i">+        }
</a><a href="#h21-0-93" id="h21-0-93" class="i">+        Ok(())
</a><a href="#h21-0-94" id="h21-0-94" class="i">+    }
</a><a href="#h21-0-95" id="h21-0-95" class="i">+}
</a><a href="#h21-0-96" id="h21-0-96" class="i">+
</a><a href="#h21-0-97" id="h21-0-97" class="i">+/// A client request.
</a><a href="#h21-0-98" id="h21-0-98" class="i">+#[derive(Debug, Serialize, Deserialize)]
</a><a href="#h21-0-99" id="h21-0-99" class="i">+pub enum Request {
</a><a href="#h21-0-100" id="h21-0-100" class="i">+    Execute(String),
</a><a href="#h21-0-101" id="h21-0-101" class="i">+    GetTable(String),
</a><a href="#h21-0-102" id="h21-0-102" class="i">+    ListTables,
</a><a href="#h21-0-103" id="h21-0-103" class="i">+    Status,
</a><a href="#h21-0-104" id="h21-0-104" class="i">+}
</a><a href="#h21-0-105" id="h21-0-105" class="i">+
</a><a href="#h21-0-106" id="h21-0-106" class="i">+/// A server response.
</a><a href="#h21-0-107" id="h21-0-107" class="i">+#[derive(Debug, Serialize, Deserialize)]
</a><a href="#h21-0-108" id="h21-0-108" class="i">+pub enum Response {
</a><a href="#h21-0-109" id="h21-0-109" class="i">+    Error(Error),
</a><a href="#h21-0-110" id="h21-0-110" class="i">+    Execute(ResultSet),
</a><a href="#h21-0-111" id="h21-0-111" class="i">+    Row(Option&lt;Row&gt;),
</a><a href="#h21-0-112" id="h21-0-112" class="i">+    GetTable(Table),
</a><a href="#h21-0-113" id="h21-0-113" class="i">+    ListTables(Vec&lt;String&gt;),
</a><a href="#h21-0-114" id="h21-0-114" class="i">+    Status(raft::Status),
</a><a href="#h21-0-115" id="h21-0-115" class="i">+}
</a><a href="#h21-0-116" id="h21-0-116" class="i">+
</a><a href="#h21-0-117" id="h21-0-117" class="i">+/// A client session coupled to a SQL session.
</a><a href="#h21-0-118" id="h21-0-118" class="i">+pub struct Session {
</a><a href="#h21-0-119" id="h21-0-119" class="i">+    engine: sql::engine::Raft,
</a><a href="#h21-0-120" id="h21-0-120" class="i">+    sql: sql::engine::Session&lt;sql::engine::Raft&gt;,
</a><a href="#h21-0-121" id="h21-0-121" class="i">+}
</a><a href="#h21-0-122" id="h21-0-122" class="i">+
</a><a href="#h21-0-123" id="h21-0-123" class="i">+impl Session {
</a><a href="#h21-0-124" id="h21-0-124" class="i">+    /// Creates a new client session.
</a><a href="#h21-0-125" id="h21-0-125" class="i">+    fn new(engine: sql::engine::Raft) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h21-0-126" id="h21-0-126" class="i">+        Ok(Self { sql: engine.session()?, engine })
</a><a href="#h21-0-127" id="h21-0-127" class="i">+    }
</a><a href="#h21-0-128" id="h21-0-128" class="i">+
</a><a href="#h21-0-129" id="h21-0-129" class="i">+    /// Handles a client connection.
</a><a href="#h21-0-130" id="h21-0-130" class="i">+    async fn handle(mut self, socket: TcpStream) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h21-0-131" id="h21-0-131" class="i">+        let mut stream = tokio_serde::Framed::new(
</a><a href="#h21-0-132" id="h21-0-132" class="i">+            Framed::new(socket, LengthDelimitedCodec::new()),
</a><a href="#h21-0-133" id="h21-0-133" class="i">+            tokio_serde::formats::Cbor::default(),
</a><a href="#h21-0-134" id="h21-0-134" class="i">+        );
</a><a href="#h21-0-135" id="h21-0-135" class="i">+        while let Some(request) = stream.try_next().await? {
</a><a href="#h21-0-136" id="h21-0-136" class="i">+            let mut response = self.request(request).await;
</a><a href="#h21-0-137" id="h21-0-137" class="i">+            let mut rows: Box&lt;dyn Iterator&lt;Item = Response&gt; + Send&gt; = Box::new(std::iter::empty());
</a><a href="#h21-0-138" id="h21-0-138" class="i">+            if let Response::Execute(ResultSet::Query { ref mut relation }) = &amp;mut response {
</a><a href="#h21-0-139" id="h21-0-139" class="i">+                rows = Box::new(
</a><a href="#h21-0-140" id="h21-0-140" class="i">+                    relation
</a><a href="#h21-0-141" id="h21-0-141" class="i">+                        .rows
</a><a href="#h21-0-142" id="h21-0-142" class="i">+                        .take()
</a><a href="#h21-0-143" id="h21-0-143" class="i">+                        .unwrap_or_else(|| Box::new(std::iter::empty()))
</a><a href="#h21-0-144" id="h21-0-144" class="i">+                        .map(|result| match result {
</a><a href="#h21-0-145" id="h21-0-145" class="i">+                            Ok(row) =&gt; Response::Row(Some(row)),
</a><a href="#h21-0-146" id="h21-0-146" class="i">+                            Err(error) =&gt; Response::Error(error),
</a><a href="#h21-0-147" id="h21-0-147" class="i">+                        })
</a><a href="#h21-0-148" id="h21-0-148" class="i">+                        .chain(std::iter::once(Response::Row(None)))
</a><a href="#h21-0-149" id="h21-0-149" class="i">+                        .scan(false, |err_sent, response| match (&amp;err_sent, &amp;response) {
</a><a href="#h21-0-150" id="h21-0-150" class="i">+                            (true, _) =&gt; None,
</a><a href="#h21-0-151" id="h21-0-151" class="i">+                            (_, Response::Error(_)) =&gt; {
</a><a href="#h21-0-152" id="h21-0-152" class="i">+                                *err_sent = true;
</a><a href="#h21-0-153" id="h21-0-153" class="i">+                                Some(response)
</a><a href="#h21-0-154" id="h21-0-154" class="i">+                            }
</a><a href="#h21-0-155" id="h21-0-155" class="i">+                            _ =&gt; Some(response),
</a><a href="#h21-0-156" id="h21-0-156" class="i">+                        })
</a><a href="#h21-0-157" id="h21-0-157" class="i">+                        .fuse(),
</a><a href="#h21-0-158" id="h21-0-158" class="i">+                );
</a><a href="#h21-0-159" id="h21-0-159" class="i">+            }
</a><a href="#h21-0-160" id="h21-0-160" class="i">+            stream.send(response).await?;
</a><a href="#h21-0-161" id="h21-0-161" class="i">+            stream.send_all(&amp;mut tokio::stream::iter(rows.map(Ok))).await?;
</a><a href="#h21-0-162" id="h21-0-162" class="i">+        }
</a><a href="#h21-0-163" id="h21-0-163" class="i">+        Ok(())
</a><a href="#h21-0-164" id="h21-0-164" class="i">+    }
</a><a href="#h21-0-165" id="h21-0-165" class="i">+
</a><a href="#h21-0-166" id="h21-0-166" class="i">+    /// Runs a request, returning errors as Response::Error.
</a><a href="#h21-0-167" id="h21-0-167" class="i">+    /// FIXME Blocks the thread, since the SQL engine is not async.
</a><a href="#h21-0-168" id="h21-0-168" class="i">+    async fn request(&amp;mut self, request: Request) -&gt; Response {
</a><a href="#h21-0-169" id="h21-0-169" class="i">+        match tokio::task::block_in_place(|| self.call(request)) {
</a><a href="#h21-0-170" id="h21-0-170" class="i">+            Ok(response) =&gt; response,
</a><a href="#h21-0-171" id="h21-0-171" class="i">+            Err(error) =&gt; Response::Error(error),
</a><a href="#h21-0-172" id="h21-0-172" class="i">+        }
</a><a href="#h21-0-173" id="h21-0-173" class="i">+    }
</a><a href="#h21-0-174" id="h21-0-174" class="i">+
</a><a href="#h21-0-175" id="h21-0-175" class="i">+    /// Executes a simple request/response call, without error handling.
</a><a href="#h21-0-176" id="h21-0-176" class="i">+    fn call(&amp;mut self, request: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h21-0-177" id="h21-0-177" class="i">+        Ok(match request {
</a><a href="#h21-0-178" id="h21-0-178" class="i">+            Request::Execute(query) =&gt; Response::Execute(self.sql.execute(&amp;query)?),
</a><a href="#h21-0-179" id="h21-0-179" class="i">+            Request::GetTable(table) =&gt; Response::GetTable(
</a><a href="#h21-0-180" id="h21-0-180" class="i">+                self.sql.with_txn(Mode::ReadOnly, |txn| txn.must_read_table(&amp;table))?,
</a><a href="#h21-0-181" id="h21-0-181" class="i">+            ),
</a><a href="#h21-0-182" id="h21-0-182" class="i">+            Request::ListTables =&gt; {
</a><a href="#h21-0-183" id="h21-0-183" class="i">+                Response::ListTables(self.sql.with_txn(Mode::ReadOnly, |txn| {
</a><a href="#h21-0-184" id="h21-0-184" class="i">+                    Ok(txn.scan_tables()?.map(|t| t.name).collect())
</a><a href="#h21-0-185" id="h21-0-185" class="i">+                })?)
</a><a href="#h21-0-186" id="h21-0-186" class="i">+            }
</a><a href="#h21-0-187" id="h21-0-187" class="i">+            Request::Status =&gt; Response::Status(self.engine.status()?),
</a><a href="#h21-0-188" id="h21-0-188" class="i">+        })
</a><a href="#h21-0-189" id="h21-0-189" class="i">+    }
</a><a href="#h21-0-190" id="h21-0-190" class="i">+}
</a><b>diff --git a/<a id="h22" href="../file/src/server/mod.rs.html">src/server/mod.rs</a> b/<a href="../file/src/server/mod.rs.html">src/server/mod.rs</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -1,70 +0,0 @@
</a><a href="#h22-0-0" id="h22-0-0" class="d">-mod raft;
</a><a href="#h22-0-1" id="h22-0-1" class="d">-mod toydb;
</a><a href="#h22-0-2" id="h22-0-2" class="d">-
</a><a href="#h22-0-3" id="h22-0-3" class="d">-pub use self::toydb::{Request, Response, Status};
</a><a href="#h22-0-4" id="h22-0-4" class="d">-
</a><a href="#h22-0-5" id="h22-0-5" class="d">-use self::toydb::ToyDB;
</a><a href="#h22-0-6" id="h22-0-6" class="d">-use crate::error::Error;
</a><a href="#h22-0-7" id="h22-0-7" class="d">-use crate::kv;
</a><a href="#h22-0-8" id="h22-0-8" class="d">-use crate::raft::Raft;
</a><a href="#h22-0-9" id="h22-0-9" class="d">-use crate::service;
</a><a href="#h22-0-10" id="h22-0-10" class="d">-use crate::sql;
</a><a href="#h22-0-11" id="h22-0-11" class="d">-
</a><a href="#h22-0-12" id="h22-0-12" class="d">-use std::collections::HashMap;
</a><a href="#h22-0-13" id="h22-0-13" class="d">-
</a><a href="#h22-0-14" id="h22-0-14" class="d">-pub struct Server {
</a><a href="#h22-0-15" id="h22-0-15" class="d">-    id: String,
</a><a href="#h22-0-16" id="h22-0-16" class="d">-    peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h22-0-17" id="h22-0-17" class="d">-    data_dir: String,
</a><a href="#h22-0-18" id="h22-0-18" class="d">-}
</a><a href="#h22-0-19" id="h22-0-19" class="d">-
</a><a href="#h22-0-20" id="h22-0-20" class="d">-impl Server {
</a><a href="#h22-0-21" id="h22-0-21" class="d">-    pub fn new(
</a><a href="#h22-0-22" id="h22-0-22" class="d">-        id: &amp;str,
</a><a href="#h22-0-23" id="h22-0-23" class="d">-        peers: HashMap&lt;String, std::net::SocketAddr&gt;,
</a><a href="#h22-0-24" id="h22-0-24" class="d">-        data_dir: &amp;str,
</a><a href="#h22-0-25" id="h22-0-25" class="d">-    ) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h22-0-26" id="h22-0-26" class="d">-        Ok(Server { id: id.into(), peers, data_dir: data_dir.into() })
</a><a href="#h22-0-27" id="h22-0-27" class="d">-    }
</a><a href="#h22-0-28" id="h22-0-28" class="d">-
</a><a href="#h22-0-29" id="h22-0-29" class="d">-    pub async fn listen(self, sql_addr: String, raft_addr: String) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h22-0-30" id="h22-0-30" class="d">-        info!(&quot;Starting ToyDB node {} on {} (SQL) and {} (Raft)&quot;, self.id, sql_addr, raft_addr);
</a><a href="#h22-0-31" id="h22-0-31" class="d">-        let mut server = grpc::ServerBuilder::new_plain();
</a><a href="#h22-0-32" id="h22-0-32" class="d">-        server.http.set_addr(raft_addr)?;
</a><a href="#h22-0-33" id="h22-0-33" class="d">-        server.http.set_cpu_pool_threads(4);
</a><a href="#h22-0-34" id="h22-0-34" class="d">-        let data_path = std::path::Path::new(&amp;self.data_dir);
</a><a href="#h22-0-35" id="h22-0-35" class="d">-        std::fs::create_dir_all(data_path)?;
</a><a href="#h22-0-36" id="h22-0-36" class="d">-
</a><a href="#h22-0-37" id="h22-0-37" class="d">-        let raft_transport = raft::GRPC::new(self.peers.clone())?;
</a><a href="#h22-0-38" id="h22-0-38" class="d">-        server.add_service(service::RaftServer::new_service_def(raft_transport.build_service()?));
</a><a href="#h22-0-39" id="h22-0-39" class="d">-        let raft = Raft::start(
</a><a href="#h22-0-40" id="h22-0-40" class="d">-            &amp;self.id,
</a><a href="#h22-0-41" id="h22-0-41" class="d">-            self.peers.keys().cloned().collect(),
</a><a href="#h22-0-42" id="h22-0-42" class="d">-            sql::engine::Raft::new_state(kv::MVCC::new(kv::storage::File::new(
</a><a href="#h22-0-43" id="h22-0-43" class="d">-                std::fs::OpenOptions::new()
</a><a href="#h22-0-44" id="h22-0-44" class="d">-                    .read(true)
</a><a href="#h22-0-45" id="h22-0-45" class="d">-                    .write(true)
</a><a href="#h22-0-46" id="h22-0-46" class="d">-                    .create(true)
</a><a href="#h22-0-47" id="h22-0-47" class="d">-                    .open(data_path.join(&quot;state&quot;))?,
</a><a href="#h22-0-48" id="h22-0-48" class="d">-            )?)),
</a><a href="#h22-0-49" id="h22-0-49" class="d">-            kv::Simple::new(kv::storage::BLog::new(
</a><a href="#h22-0-50" id="h22-0-50" class="d">-                std::fs::OpenOptions::new()
</a><a href="#h22-0-51" id="h22-0-51" class="d">-                    .read(true)
</a><a href="#h22-0-52" id="h22-0-52" class="d">-                    .write(true)
</a><a href="#h22-0-53" id="h22-0-53" class="d">-                    .create(true)
</a><a href="#h22-0-54" id="h22-0-54" class="d">-                    .open(data_path.join(&quot;raft&quot;))?,
</a><a href="#h22-0-55" id="h22-0-55" class="d">-            )?),
</a><a href="#h22-0-56" id="h22-0-56" class="d">-            raft_transport,
</a><a href="#h22-0-57" id="h22-0-57" class="d">-        )?;
</a><a href="#h22-0-58" id="h22-0-58" class="d">-
</a><a href="#h22-0-59" id="h22-0-59" class="d">-        let _s = server.build()?;
</a><a href="#h22-0-60" id="h22-0-60" class="d">-
</a><a href="#h22-0-61" id="h22-0-61" class="d">-        ToyDB { id: self.id.clone(), engine: sql::engine::Raft::new(raft.clone()) }
</a><a href="#h22-0-62" id="h22-0-62" class="d">-            .listen(&amp;sql_addr)
</a><a href="#h22-0-63" id="h22-0-63" class="d">-            .await?;
</a><a href="#h22-0-64" id="h22-0-64" class="d">-
</a><a href="#h22-0-65" id="h22-0-65" class="d">-        raft.shutdown()?;
</a><a href="#h22-0-66" id="h22-0-66" class="d">-
</a><a href="#h22-0-67" id="h22-0-67" class="d">-        Ok(())
</a><a href="#h22-0-68" id="h22-0-68" class="d">-    }
</a><a href="#h22-0-69" id="h22-0-69" class="d">-}
</a><b>diff --git a/<a id="h23" href="../file/src/server/raft.rs.html">src/server/raft.rs</a> b/<a href="../file/src/server/raft.rs.html">src/server/raft.rs</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -1,101 +0,0 @@
</a><a href="#h23-0-0" id="h23-0-0" class="d">-use crate::raft::{Message, Transport};
</a><a href="#h23-0-1" id="h23-0-1" class="d">-use crate::service;
</a><a href="#h23-0-2" id="h23-0-2" class="d">-use crate::service::Raft;
</a><a href="#h23-0-3" id="h23-0-3" class="d">-use crate::utility::{deserialize, serialize};
</a><a href="#h23-0-4" id="h23-0-4" class="d">-use crate::Error;
</a><a href="#h23-0-5" id="h23-0-5" class="d">-use crossbeam::channel::{Receiver, Sender};
</a><a href="#h23-0-6" id="h23-0-6" class="d">-use grpc::ClientStubExt;
</a><a href="#h23-0-7" id="h23-0-7" class="d">-use std::collections::HashMap;
</a><a href="#h23-0-8" id="h23-0-8" class="d">-
</a><a href="#h23-0-9" id="h23-0-9" class="d">-/// A gRPC transport.
</a><a href="#h23-0-10" id="h23-0-10" class="d">-pub struct GRPC {
</a><a href="#h23-0-11" id="h23-0-11" class="d">-    /// The node channel receiver
</a><a href="#h23-0-12" id="h23-0-12" class="d">-    node_rx: Receiver&lt;Message&gt;,
</a><a href="#h23-0-13" id="h23-0-13" class="d">-    /// The node channel sender
</a><a href="#h23-0-14" id="h23-0-14" class="d">-    node_tx: Sender&lt;Message&gt;,
</a><a href="#h23-0-15" id="h23-0-15" class="d">-    /// A hash map of peer IDs and gRPC clients.
</a><a href="#h23-0-16" id="h23-0-16" class="d">-    peers: HashMap&lt;String, service::RaftClient&gt;,
</a><a href="#h23-0-17" id="h23-0-17" class="d">-}
</a><a href="#h23-0-18" id="h23-0-18" class="d">-
</a><a href="#h23-0-19" id="h23-0-19" class="d">-impl Transport for GRPC {
</a><a href="#h23-0-20" id="h23-0-20" class="d">-    fn receiver(&amp;self) -&gt; Receiver&lt;Message&gt; {
</a><a href="#h23-0-21" id="h23-0-21" class="d">-        self.node_rx.clone()
</a><a href="#h23-0-22" id="h23-0-22" class="d">-    }
</a><a href="#h23-0-23" id="h23-0-23" class="d">-
</a><a href="#h23-0-24" id="h23-0-24" class="d">-    fn send(&amp;self, msg: Message) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h23-0-25" id="h23-0-25" class="d">-        if let Some(to) = &amp;msg.to {
</a><a href="#h23-0-26" id="h23-0-26" class="d">-            if let Some(client) = self.peers.get(to) {
</a><a href="#h23-0-27" id="h23-0-27" class="d">-                // FIXME Needs to check the response.
</a><a href="#h23-0-28" id="h23-0-28" class="d">-                client.step(grpc::RequestOptions::new(), message_to_protobuf(msg));
</a><a href="#h23-0-29" id="h23-0-29" class="d">-                Ok(())
</a><a href="#h23-0-30" id="h23-0-30" class="d">-            } else {
</a><a href="#h23-0-31" id="h23-0-31" class="d">-                Err(Error::Internal(format!(&quot;Unknown Raft peer {}&quot;, to)))
</a><a href="#h23-0-32" id="h23-0-32" class="d">-            }
</a><a href="#h23-0-33" id="h23-0-33" class="d">-        } else {
</a><a href="#h23-0-34" id="h23-0-34" class="d">-            Err(Error::Internal(&quot;No receiver&quot;.into()))
</a><a href="#h23-0-35" id="h23-0-35" class="d">-        }
</a><a href="#h23-0-36" id="h23-0-36" class="d">-    }
</a><a href="#h23-0-37" id="h23-0-37" class="d">-}
</a><a href="#h23-0-38" id="h23-0-38" class="d">-
</a><a href="#h23-0-39" id="h23-0-39" class="d">-impl GRPC {
</a><a href="#h23-0-40" id="h23-0-40" class="d">-    /// Creates a new GRPC transport
</a><a href="#h23-0-41" id="h23-0-41" class="d">-    pub fn new(peers: HashMap&lt;String, std::net::SocketAddr&gt;) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h23-0-42" id="h23-0-42" class="d">-        let (node_tx, node_rx) = crossbeam::channel::unbounded();
</a><a href="#h23-0-43" id="h23-0-43" class="d">-        let mut t = GRPC { peers: HashMap::new(), node_tx, node_rx };
</a><a href="#h23-0-44" id="h23-0-44" class="d">-        for (id, addr) in peers.into_iter() {
</a><a href="#h23-0-45" id="h23-0-45" class="d">-            t.peers.insert(id, t.build_client(addr)?);
</a><a href="#h23-0-46" id="h23-0-46" class="d">-        }
</a><a href="#h23-0-47" id="h23-0-47" class="d">-        Ok(t)
</a><a href="#h23-0-48" id="h23-0-48" class="d">-    }
</a><a href="#h23-0-49" id="h23-0-49" class="d">-
</a><a href="#h23-0-50" id="h23-0-50" class="d">-    /// Builds a gRPC client for a peer.
</a><a href="#h23-0-51" id="h23-0-51" class="d">-    pub fn build_client(&amp;self, addr: std::net::SocketAddr) -&gt; Result&lt;service::RaftClient, Error&gt; {
</a><a href="#h23-0-52" id="h23-0-52" class="d">-        Ok(service::RaftClient::new_plain(
</a><a href="#h23-0-53" id="h23-0-53" class="d">-            &amp;addr.ip().to_string(),
</a><a href="#h23-0-54" id="h23-0-54" class="d">-            addr.port(),
</a><a href="#h23-0-55" id="h23-0-55" class="d">-            grpc::ClientConf::new(),
</a><a href="#h23-0-56" id="h23-0-56" class="d">-        )?)
</a><a href="#h23-0-57" id="h23-0-57" class="d">-    }
</a><a href="#h23-0-58" id="h23-0-58" class="d">-
</a><a href="#h23-0-59" id="h23-0-59" class="d">-    /// Builds a gRPC service for a local server.
</a><a href="#h23-0-60" id="h23-0-60" class="d">-    pub fn build_service(&amp;self) -&gt; Result&lt;impl service::Raft, Error&gt; {
</a><a href="#h23-0-61" id="h23-0-61" class="d">-        Ok(GRPCService { local: self.node_tx.clone() })
</a><a href="#h23-0-62" id="h23-0-62" class="d">-    }
</a><a href="#h23-0-63" id="h23-0-63" class="d">-}
</a><a href="#h23-0-64" id="h23-0-64" class="d">-
</a><a href="#h23-0-65" id="h23-0-65" class="d">-/// A gRPC service for a local server.
</a><a href="#h23-0-66" id="h23-0-66" class="d">-struct GRPCService {
</a><a href="#h23-0-67" id="h23-0-67" class="d">-    local: Sender&lt;Message&gt;,
</a><a href="#h23-0-68" id="h23-0-68" class="d">-}
</a><a href="#h23-0-69" id="h23-0-69" class="d">-
</a><a href="#h23-0-70" id="h23-0-70" class="d">-impl service::Raft for GRPCService {
</a><a href="#h23-0-71" id="h23-0-71" class="d">-    fn step(
</a><a href="#h23-0-72" id="h23-0-72" class="d">-        &amp;self,
</a><a href="#h23-0-73" id="h23-0-73" class="d">-        _: grpc::RequestOptions,
</a><a href="#h23-0-74" id="h23-0-74" class="d">-        pb: service::Message,
</a><a href="#h23-0-75" id="h23-0-75" class="d">-    ) -&gt; grpc::SingleResponse&lt;service::Empty&gt; {
</a><a href="#h23-0-76" id="h23-0-76" class="d">-        self.local.send(message_from_protobuf(pb).unwrap()).unwrap();
</a><a href="#h23-0-77" id="h23-0-77" class="d">-        grpc::SingleResponse::completed(service::Empty::new())
</a><a href="#h23-0-78" id="h23-0-78" class="d">-    }
</a><a href="#h23-0-79" id="h23-0-79" class="d">-}
</a><a href="#h23-0-80" id="h23-0-80" class="d">-
</a><a href="#h23-0-81" id="h23-0-81" class="d">-/// Converts a Protobuf message to a `Message`.
</a><a href="#h23-0-82" id="h23-0-82" class="d">-fn message_from_protobuf(pb: service::Message) -&gt; Result&lt;Message, Error&gt; {
</a><a href="#h23-0-83" id="h23-0-83" class="d">-    Ok(Message {
</a><a href="#h23-0-84" id="h23-0-84" class="d">-        term: pb.term,
</a><a href="#h23-0-85" id="h23-0-85" class="d">-        from: Some(pb.from),
</a><a href="#h23-0-86" id="h23-0-86" class="d">-        to: Some(pb.to),
</a><a href="#h23-0-87" id="h23-0-87" class="d">-        event: deserialize(&amp;pb.event)?,
</a><a href="#h23-0-88" id="h23-0-88" class="d">-    })
</a><a href="#h23-0-89" id="h23-0-89" class="d">-}
</a><a href="#h23-0-90" id="h23-0-90" class="d">-
</a><a href="#h23-0-91" id="h23-0-91" class="d">-/// Converts a `Message` to its Protobuf representation.
</a><a href="#h23-0-92" id="h23-0-92" class="d">-fn message_to_protobuf(msg: Message) -&gt; service::Message {
</a><a href="#h23-0-93" id="h23-0-93" class="d">-    service::Message {
</a><a href="#h23-0-94" id="h23-0-94" class="d">-        term: msg.term,
</a><a href="#h23-0-95" id="h23-0-95" class="d">-        from: msg.from.unwrap(),
</a><a href="#h23-0-96" id="h23-0-96" class="d">-        to: msg.to.unwrap(),
</a><a href="#h23-0-97" id="h23-0-97" class="d">-        event: serialize(&amp;msg.event).unwrap(),
</a><a href="#h23-0-98" id="h23-0-98" class="d">-        ..Default::default()
</a><a href="#h23-0-99" id="h23-0-99" class="d">-    }
</a><a href="#h23-0-100" id="h23-0-100" class="d">-}
</a><b>diff --git a/<a id="h24" href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a> b/<a href="../file/src/server/toydb.rs.html">src/server/toydb.rs</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -1,148 +0,0 @@
</a><a href="#h24-0-0" id="h24-0-0" class="d">-use crate::sql::engine::{Engine as _, Mode, Raft, Session as SQLSession};
</a><a href="#h24-0-1" id="h24-0-1" class="d">-use crate::sql::execution::ResultSet;
</a><a href="#h24-0-2" id="h24-0-2" class="d">-use crate::sql::schema::{Catalog as _, Table};
</a><a href="#h24-0-3" id="h24-0-3" class="d">-use crate::sql::types::Row;
</a><a href="#h24-0-4" id="h24-0-4" class="d">-use crate::Error;
</a><a href="#h24-0-5" id="h24-0-5" class="d">-
</a><a href="#h24-0-6" id="h24-0-6" class="d">-use futures_util::sink::{Sink, SinkExt as _};
</a><a href="#h24-0-7" id="h24-0-7" class="d">-use futures_util::stream::Stream;
</a><a href="#h24-0-8" id="h24-0-8" class="d">-use std::marker::Unpin;
</a><a href="#h24-0-9" id="h24-0-9" class="d">-use tokio::net::TcpListener;
</a><a href="#h24-0-10" id="h24-0-10" class="d">-use tokio::stream::StreamExt as _;
</a><a href="#h24-0-11" id="h24-0-11" class="d">-use tokio_util::codec::{Framed, LengthDelimitedCodec};
</a><a href="#h24-0-12" id="h24-0-12" class="d">-
</a><a href="#h24-0-13" id="h24-0-13" class="d">-/// A client request.
</a><a href="#h24-0-14" id="h24-0-14" class="d">-#[derive(Debug, Serialize, Deserialize)]
</a><a href="#h24-0-15" id="h24-0-15" class="d">-pub enum Request {
</a><a href="#h24-0-16" id="h24-0-16" class="d">-    Execute(String),
</a><a href="#h24-0-17" id="h24-0-17" class="d">-    GetTable(String),
</a><a href="#h24-0-18" id="h24-0-18" class="d">-    ListTables,
</a><a href="#h24-0-19" id="h24-0-19" class="d">-    Status,
</a><a href="#h24-0-20" id="h24-0-20" class="d">-}
</a><a href="#h24-0-21" id="h24-0-21" class="d">-
</a><a href="#h24-0-22" id="h24-0-22" class="d">-/// A server response.
</a><a href="#h24-0-23" id="h24-0-23" class="d">-#[derive(Debug, Serialize, Deserialize)]
</a><a href="#h24-0-24" id="h24-0-24" class="d">-pub enum Response {
</a><a href="#h24-0-25" id="h24-0-25" class="d">-    Error(Error),
</a><a href="#h24-0-26" id="h24-0-26" class="d">-    Execute(ResultSet),
</a><a href="#h24-0-27" id="h24-0-27" class="d">-    Row(Option&lt;Row&gt;),
</a><a href="#h24-0-28" id="h24-0-28" class="d">-    GetTable(Table),
</a><a href="#h24-0-29" id="h24-0-29" class="d">-    ListTables(Vec&lt;String&gt;),
</a><a href="#h24-0-30" id="h24-0-30" class="d">-    Status(Status),
</a><a href="#h24-0-31" id="h24-0-31" class="d">-}
</a><a href="#h24-0-32" id="h24-0-32" class="d">-
</a><a href="#h24-0-33" id="h24-0-33" class="d">-/// Server status, returned to clients.
</a><a href="#h24-0-34" id="h24-0-34" class="d">-#[derive(Clone, Debug, PartialEq, Serialize, Deserialize)]
</a><a href="#h24-0-35" id="h24-0-35" class="d">-pub struct Status {
</a><a href="#h24-0-36" id="h24-0-36" class="d">-    pub id: String,
</a><a href="#h24-0-37" id="h24-0-37" class="d">-    pub version: String,
</a><a href="#h24-0-38" id="h24-0-38" class="d">-}
</a><a href="#h24-0-39" id="h24-0-39" class="d">-
</a><a href="#h24-0-40" id="h24-0-40" class="d">-/// The ToyDB SQL server.
</a><a href="#h24-0-41" id="h24-0-41" class="d">-// FIXME This should be moved into main server struct
</a><a href="#h24-0-42" id="h24-0-42" class="d">-pub struct ToyDB {
</a><a href="#h24-0-43" id="h24-0-43" class="d">-    pub id: String,
</a><a href="#h24-0-44" id="h24-0-44" class="d">-    pub engine: Raft,
</a><a href="#h24-0-45" id="h24-0-45" class="d">-}
</a><a href="#h24-0-46" id="h24-0-46" class="d">-
</a><a href="#h24-0-47" id="h24-0-47" class="d">-impl ToyDB {
</a><a href="#h24-0-48" id="h24-0-48" class="d">-    /// Listens for connections from clients.
</a><a href="#h24-0-49" id="h24-0-49" class="d">-    pub async fn listen(&amp;self, addr: &amp;str) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h24-0-50" id="h24-0-50" class="d">-        let mut listener = TcpListener::bind(addr).await?;
</a><a href="#h24-0-51" id="h24-0-51" class="d">-        while let Some(socket) = listener.try_next().await? {
</a><a href="#h24-0-52" id="h24-0-52" class="d">-            let peer = socket.peer_addr()?;
</a><a href="#h24-0-53" id="h24-0-53" class="d">-            let stream = tokio_serde::Framed::new(
</a><a href="#h24-0-54" id="h24-0-54" class="d">-                Framed::new(socket, LengthDelimitedCodec::new()),
</a><a href="#h24-0-55" id="h24-0-55" class="d">-                tokio_serde::formats::Cbor::default(),
</a><a href="#h24-0-56" id="h24-0-56" class="d">-            );
</a><a href="#h24-0-57" id="h24-0-57" class="d">-            let session = Session::new(&amp;self.id, &amp;self.engine)?;
</a><a href="#h24-0-58" id="h24-0-58" class="d">-            tokio::spawn(async move {
</a><a href="#h24-0-59" id="h24-0-59" class="d">-                info!(&quot;Client {} connected&quot;, peer);
</a><a href="#h24-0-60" id="h24-0-60" class="d">-                match session.handle(stream).await {
</a><a href="#h24-0-61" id="h24-0-61" class="d">-                    Ok(()) =&gt; info!(&quot;Client {} disconnected&quot;, peer),
</a><a href="#h24-0-62" id="h24-0-62" class="d">-                    Err(err) =&gt; error!(&quot;Client {} error: {}&quot;, peer, err),
</a><a href="#h24-0-63" id="h24-0-63" class="d">-                }
</a><a href="#h24-0-64" id="h24-0-64" class="d">-            });
</a><a href="#h24-0-65" id="h24-0-65" class="d">-        }
</a><a href="#h24-0-66" id="h24-0-66" class="d">-        Ok(())
</a><a href="#h24-0-67" id="h24-0-67" class="d">-    }
</a><a href="#h24-0-68" id="h24-0-68" class="d">-}
</a><a href="#h24-0-69" id="h24-0-69" class="d">-
</a><a href="#h24-0-70" id="h24-0-70" class="d">-/// A client session coupled to a SQL session.
</a><a href="#h24-0-71" id="h24-0-71" class="d">-pub struct Session {
</a><a href="#h24-0-72" id="h24-0-72" class="d">-    server_id: String,
</a><a href="#h24-0-73" id="h24-0-73" class="d">-    sql: SQLSession&lt;Raft&gt;,
</a><a href="#h24-0-74" id="h24-0-74" class="d">-}
</a><a href="#h24-0-75" id="h24-0-75" class="d">-
</a><a href="#h24-0-76" id="h24-0-76" class="d">-impl Session {
</a><a href="#h24-0-77" id="h24-0-77" class="d">-    /// Creates a new client session.
</a><a href="#h24-0-78" id="h24-0-78" class="d">-    fn new(server_id: &amp;str, engine: &amp;Raft) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h24-0-79" id="h24-0-79" class="d">-        Ok(Self { server_id: server_id.into(), sql: engine.session()? })
</a><a href="#h24-0-80" id="h24-0-80" class="d">-    }
</a><a href="#h24-0-81" id="h24-0-81" class="d">-
</a><a href="#h24-0-82" id="h24-0-82" class="d">-    /// Handles a client connection.
</a><a href="#h24-0-83" id="h24-0-83" class="d">-    async fn handle&lt;S&gt;(mut self, mut stream: S) -&gt; Result&lt;(), Error&gt;
</a><a href="#h24-0-84" id="h24-0-84" class="d">-    where
</a><a href="#h24-0-85" id="h24-0-85" class="d">-        S: Stream&lt;Item = std::io::Result&lt;Request&gt;&gt; + Sink&lt;Response, Error = std::io::Error&gt; + Unpin,
</a><a href="#h24-0-86" id="h24-0-86" class="d">-    {
</a><a href="#h24-0-87" id="h24-0-87" class="d">-        while let Some(request) = stream.try_next().await? {
</a><a href="#h24-0-88" id="h24-0-88" class="d">-            // FIXME call() blocks here, the SQL engine should (possibly) be async
</a><a href="#h24-0-89" id="h24-0-89" class="d">-            let mut response = match self.call(request) {
</a><a href="#h24-0-90" id="h24-0-90" class="d">-                Ok(response) =&gt; response,
</a><a href="#h24-0-91" id="h24-0-91" class="d">-                Err(err) =&gt; Response::Error(err),
</a><a href="#h24-0-92" id="h24-0-92" class="d">-            };
</a><a href="#h24-0-93" id="h24-0-93" class="d">-            let rows = match &amp;mut response {
</a><a href="#h24-0-94" id="h24-0-94" class="d">-                Response::Execute(ResultSet::Query { ref mut relation }) =&gt; relation.rows.take(),
</a><a href="#h24-0-95" id="h24-0-95" class="d">-                _ =&gt; None,
</a><a href="#h24-0-96" id="h24-0-96" class="d">-            };
</a><a href="#h24-0-97" id="h24-0-97" class="d">-            stream.send(response).await?;
</a><a href="#h24-0-98" id="h24-0-98" class="d">-            if let Some(rows) = rows {
</a><a href="#h24-0-99" id="h24-0-99" class="d">-                let mut errored = false;
</a><a href="#h24-0-100" id="h24-0-100" class="d">-                for r in rows {
</a><a href="#h24-0-101" id="h24-0-101" class="d">-                    stream
</a><a href="#h24-0-102" id="h24-0-102" class="d">-                        .send(match r {
</a><a href="#h24-0-103" id="h24-0-103" class="d">-                            Ok(row) =&gt; Response::Row(Some(row)),
</a><a href="#h24-0-104" id="h24-0-104" class="d">-                            Err(error) =&gt; {
</a><a href="#h24-0-105" id="h24-0-105" class="d">-                                errored = true;
</a><a href="#h24-0-106" id="h24-0-106" class="d">-                                Response::Error(error)
</a><a href="#h24-0-107" id="h24-0-107" class="d">-                            }
</a><a href="#h24-0-108" id="h24-0-108" class="d">-                        })
</a><a href="#h24-0-109" id="h24-0-109" class="d">-                        .await?;
</a><a href="#h24-0-110" id="h24-0-110" class="d">-                    if errored {
</a><a href="#h24-0-111" id="h24-0-111" class="d">-                        break;
</a><a href="#h24-0-112" id="h24-0-112" class="d">-                    }
</a><a href="#h24-0-113" id="h24-0-113" class="d">-                }
</a><a href="#h24-0-114" id="h24-0-114" class="d">-                if !errored {
</a><a href="#h24-0-115" id="h24-0-115" class="d">-                    stream.send(Response::Row(None)).await?;
</a><a href="#h24-0-116" id="h24-0-116" class="d">-                }
</a><a href="#h24-0-117" id="h24-0-117" class="d">-            }
</a><a href="#h24-0-118" id="h24-0-118" class="d">-        }
</a><a href="#h24-0-119" id="h24-0-119" class="d">-        Ok(())
</a><a href="#h24-0-120" id="h24-0-120" class="d">-    }
</a><a href="#h24-0-121" id="h24-0-121" class="d">-
</a><a href="#h24-0-122" id="h24-0-122" class="d">-    /// Executes a simple request/response call.
</a><a href="#h24-0-123" id="h24-0-123" class="d">-    fn call(&amp;mut self, req: Request) -&gt; Result&lt;Response, Error&gt; {
</a><a href="#h24-0-124" id="h24-0-124" class="d">-        Ok(match req {
</a><a href="#h24-0-125" id="h24-0-125" class="d">-            Request::Execute(query) =&gt; Response::Execute(self.sql.execute(&amp;query)?),
</a><a href="#h24-0-126" id="h24-0-126" class="d">-            Request::GetTable(table) =&gt; Response::GetTable(self.get_table(&amp;table)?),
</a><a href="#h24-0-127" id="h24-0-127" class="d">-            Request::ListTables =&gt; Response::ListTables(self.list_tables()?),
</a><a href="#h24-0-128" id="h24-0-128" class="d">-            Request::Status =&gt; Response::Status(Status {
</a><a href="#h24-0-129" id="h24-0-129" class="d">-                id: self.server_id.clone(),
</a><a href="#h24-0-130" id="h24-0-130" class="d">-                version: env!(&quot;CARGO_PKG_VERSION&quot;).into(),
</a><a href="#h24-0-131" id="h24-0-131" class="d">-            }),
</a><a href="#h24-0-132" id="h24-0-132" class="d">-        })
</a><a href="#h24-0-133" id="h24-0-133" class="d">-    }
</a><a href="#h24-0-134" id="h24-0-134" class="d">-
</a><a href="#h24-0-135" id="h24-0-135" class="d">-    /// Fetches a table.
</a><a href="#h24-0-136" id="h24-0-136" class="d">-    fn get_table(&amp;mut self, name: &amp;str) -&gt; Result&lt;Table, Error&gt; {
</a><a href="#h24-0-137" id="h24-0-137" class="d">-        self.sql.with_txn(Mode::ReadOnly, |txn| match txn.read_table(name)? {
</a><a href="#h24-0-138" id="h24-0-138" class="d">-            Some(t) =&gt; Ok(t),
</a><a href="#h24-0-139" id="h24-0-139" class="d">-            None =&gt; Err(Error::Value(format!(&quot;Table {} does not exist&quot;, name))),
</a><a href="#h24-0-140" id="h24-0-140" class="d">-        })
</a><a href="#h24-0-141" id="h24-0-141" class="d">-    }
</a><a href="#h24-0-142" id="h24-0-142" class="d">-
</a><a href="#h24-0-143" id="h24-0-143" class="d">-    /// Fetches a list of tables.
</a><a href="#h24-0-144" id="h24-0-144" class="d">-    fn list_tables(&amp;mut self) -&gt; Result&lt;Vec&lt;String&gt;, Error&gt; {
</a><a href="#h24-0-145" id="h24-0-145" class="d">-        self.sql.with_txn(Mode::ReadOnly, |txn| Ok(txn.scan_tables()?.map(|t| t.name).collect()))
</a><a href="#h24-0-146" id="h24-0-146" class="d">-    }
</a><a href="#h24-0-147" id="h24-0-147" class="d">-}
</a><b>diff --git a/<a id="h25" href="../file/src/service/mod.rs.html">src/service/mod.rs</a> b/<a href="../file/src/service/mod.rs.html">src/service/mod.rs</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -1,14 +0,0 @@
</a><a href="#h25-0-0" id="h25-0-0" class="d">-// These imported modules are generated by build.rs from protobuf
</a><a href="#h25-0-1" id="h25-0-1" class="d">-// definitions in /protobuf/
</a><a href="#h25-0-2" id="h25-0-2" class="d">-
</a><a href="#h25-0-3" id="h25-0-3" class="d">-// The allows are to avoid clippy warnings in the generated code, see:
</a><a href="#h25-0-4" id="h25-0-4" class="d">-// https://github.com/stepancheg/rust-protobuf/pull/332
</a><a href="#h25-0-5" id="h25-0-5" class="d">-#[allow(bare_trait_objects)]
</a><a href="#h25-0-6" id="h25-0-6" class="d">-#[allow(renamed_and_removed_lints)]
</a><a href="#h25-0-7" id="h25-0-7" class="d">-mod raft;
</a><a href="#h25-0-8" id="h25-0-8" class="d">-#[allow(bare_trait_objects)]
</a><a href="#h25-0-9" id="h25-0-9" class="d">-#[allow(renamed_and_removed_lints)]
</a><a href="#h25-0-10" id="h25-0-10" class="d">-mod raft_grpc;
</a><a href="#h25-0-11" id="h25-0-11" class="d">-
</a><a href="#h25-0-12" id="h25-0-12" class="d">-pub use self::raft::*;
</a><a href="#h25-0-13" id="h25-0-13" class="d">-pub use self::raft_grpc::*;
</a><b>diff --git a/<a id="h26" href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a> b/<a href="../file/src/sql/engine/mod.rs.html">src/sql/engine/mod.rs</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -1,6 +1,6 @@
</a> //! The SQL engine provides fundamental CRUD storage operations.
 mod kv;
<a href="#h26-0-2" id="h26-0-2" class="d">-mod raft;
</a><a href="#h26-0-3" id="h26-0-3" class="i">+pub mod raft;
</a> pub use kv::KV;
 pub use raft::Raft;
 
<b>diff --git a/<a id="h27" href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a> b/<a href="../file/src/sql/engine/raft.rs.html">src/sql/engine/raft.rs</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -1,6 +1,6 @@
</a> use super::super::schema::{Catalog, Table, Tables};
 use super::super::types::{Expression, Row, Value};
<a href="#h27-0-2" id="h27-0-2" class="d">-use super::{Engine as _, Transaction as _};
</a><a href="#h27-0-3" id="h27-0-3" class="i">+use super::{Engine as _, IndexScan, Mode, Scan, Transaction as _};
</a> use crate::kv;
 use crate::raft;
 use crate::utility::{deserialize, serialize};
<a href="#h27-1" id="h27-1" class="h">@@ -12,7 +12,7 @@ use std::collections::HashSet;
</a> #[derive(Clone, Serialize, Deserialize)]
 enum Mutation {
     /// Begins a transaction in the given mode
<a href="#h27-1-3" id="h27-1-3" class="d">-    Begin(super::Mode),
</a><a href="#h27-1-4" id="h27-1-4" class="i">+    Begin(Mode),
</a>     /// Commits the transaction with the given ID
     Commit(u64),
     /// Rolls back the transaction with the given ID
<a href="#h27-2" id="h27-2" class="h">@@ -55,31 +55,35 @@ enum Query {
</a> /// An SQL engine that wraps a Raft cluster.
 #[derive(Clone)]
 pub struct Raft {
<a href="#h27-2-3" id="h27-2-3" class="d">-    /// The underlying Raft cluster.
</a><a href="#h27-2-4" id="h27-2-4" class="d">-    raft: raft::Raft,
</a><a href="#h27-2-5" id="h27-2-5" class="i">+    client: raft::Client,
</a> }
 
 impl Raft {
     /// Creates a new Raft SQL engine.
<a href="#h27-2-10" id="h27-2-10" class="d">-    pub fn new(raft: raft::Raft) -&gt; Self {
</a><a href="#h27-2-11" id="h27-2-11" class="d">-        Self { raft }
</a><a href="#h27-2-12" id="h27-2-12" class="i">+    pub fn new(client: raft::Client) -&gt; Self {
</a><a href="#h27-2-13" id="h27-2-13" class="i">+        Self { client }
</a>     }
 
     /// Creates an underlying state machine for a Raft engine.
     pub fn new_state&lt;S: kv::storage::Storage&gt;(kv: kv::MVCC&lt;S&gt;) -&gt; State&lt;S&gt; {
         State::new(kv)
     }
<a href="#h27-2-20" id="h27-2-20" class="i">+
</a><a href="#h27-2-21" id="h27-2-21" class="i">+    /// Returns engine status, for now just the Raft status.
</a><a href="#h27-2-22" id="h27-2-22" class="i">+    pub fn status(&amp;self) -&gt; Result&lt;raft::Status, Error&gt; {
</a><a href="#h27-2-23" id="h27-2-23" class="i">+        self.client.status_sync()
</a><a href="#h27-2-24" id="h27-2-24" class="i">+    }
</a> }
 
 impl super::Engine for Raft {
     type Transaction = Transaction;
 
<a href="#h27-2-30" id="h27-2-30" class="d">-    fn begin(&amp;self, mode: super::Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h27-2-31" id="h27-2-31" class="d">-        Transaction::begin(self.raft.clone(), mode)
</a><a href="#h27-2-32" id="h27-2-32" class="i">+    fn begin(&amp;self, mode: Mode) -&gt; Result&lt;Self::Transaction, Error&gt; {
</a><a href="#h27-2-33" id="h27-2-33" class="i">+        Transaction::begin(self.client.clone(), mode)
</a>     }
 
     fn resume(&amp;self, id: u64) -&gt; Result&lt;Self::Transaction, Error&gt; {
<a href="#h27-2-37" id="h27-2-37" class="d">-        Transaction::resume(self.raft.clone(), id)
</a><a href="#h27-2-38" id="h27-2-38" class="i">+        Transaction::resume(self.client.clone(), id)
</a>     }
 }
 
<a href="#h27-3" id="h27-3" class="h">@@ -87,24 +91,24 @@ impl super::Engine for Raft {
</a> #[derive(Clone)]
 pub struct Transaction {
     /// The underlying Raft cluster
<a href="#h27-3-3" id="h27-3-3" class="d">-    raft: raft::Raft,
</a><a href="#h27-3-4" id="h27-3-4" class="i">+    client: raft::Client,
</a>     /// The transaction ID
     id: u64,
     /// The transaction mode
<a href="#h27-3-8" id="h27-3-8" class="d">-    mode: super::Mode,
</a><a href="#h27-3-9" id="h27-3-9" class="i">+    mode: Mode,
</a> }
 
 impl Transaction {
     /// Starts a transaction in the given mode
<a href="#h27-3-14" id="h27-3-14" class="d">-    fn begin(raft: raft::Raft, mode: super::Mode) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h27-3-15" id="h27-3-15" class="d">-        let id = deserialize(&amp;raft.mutate(serialize(&amp;Mutation::Begin(mode.clone()))?)?)?;
</a><a href="#h27-3-16" id="h27-3-16" class="d">-        Ok(Self { raft, id, mode })
</a><a href="#h27-3-17" id="h27-3-17" class="i">+    fn begin(client: raft::Client, mode: Mode) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h27-3-18" id="h27-3-18" class="i">+        let id = deserialize(&amp;client.mutate_sync(serialize(&amp;Mutation::Begin(mode.clone()))?)?)?;
</a><a href="#h27-3-19" id="h27-3-19" class="i">+        Ok(Self { client, id, mode })
</a>     }
 
     /// Resumes an active transaction
<a href="#h27-3-23" id="h27-3-23" class="d">-    fn resume(raft: raft::Raft, id: u64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h27-3-24" id="h27-3-24" class="d">-        let (id, mode) = deserialize(&amp;raft.query(serialize(&amp;Query::Resume(id))?)?)?;
</a><a href="#h27-3-25" id="h27-3-25" class="d">-        Ok(Self { raft, id, mode })
</a><a href="#h27-3-26" id="h27-3-26" class="i">+    fn resume(client: raft::Client, id: u64) -&gt; Result&lt;Self, Error&gt; {
</a><a href="#h27-3-27" id="h27-3-27" class="i">+        let (id, mode) = deserialize(&amp;client.query_sync(serialize(&amp;Query::Resume(id))?)?)?;
</a><a href="#h27-3-28" id="h27-3-28" class="i">+        Ok(Self { client, id, mode })
</a>     }
 }
 
<a href="#h27-4" id="h27-4" class="h">@@ -113,20 +117,20 @@ impl super::Transaction for Transaction {
</a>         self.id
     }
 
<a href="#h27-4-3" id="h27-4-3" class="d">-    fn mode(&amp;self) -&gt; super::Mode {
</a><a href="#h27-4-4" id="h27-4-4" class="i">+    fn mode(&amp;self) -&gt; Mode {
</a>         self.mode.clone()
     }
 
     fn commit(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-4-9" id="h27-4-9" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Commit(self.id))?)?)
</a><a href="#h27-4-10" id="h27-4-10" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::Commit(self.id))?)?)
</a>     }
 
     fn rollback(self) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-4-14" id="h27-4-14" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Rollback(self.id))?)?)
</a><a href="#h27-4-15" id="h27-4-15" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::Rollback(self.id))?)?)
</a>     }
 
     fn create(&amp;mut self, table: &amp;str, row: Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-4-19" id="h27-4-19" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Create {
</a><a href="#h27-4-20" id="h27-4-20" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::Create {
</a>             txn_id: self.id,
             table: table.to_string(),
             row,
<a href="#h27-5" id="h27-5" class="h">@@ -134,7 +138,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn delete(&amp;mut self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-5-3" id="h27-5-3" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Delete {
</a><a href="#h27-5-4" id="h27-5-4" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::Delete {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h27-6" id="h27-6" class="h">@@ -142,7 +146,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn read(&amp;self, table: &amp;str, id: &amp;Value) -&gt; Result&lt;Option&lt;Row&gt;, Error&gt; {
<a href="#h27-6-3" id="h27-6-3" class="d">-        deserialize(&amp;self.raft.query(serialize(&amp;Query::Read {
</a><a href="#h27-6-4" id="h27-6-4" class="i">+        deserialize(&amp;self.client.query_sync(serialize(&amp;Query::Read {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h27-7" id="h27-7" class="h">@@ -155,7 +159,7 @@ impl super::Transaction for Transaction {
</a>         column: &amp;str,
         value: &amp;Value,
     ) -&gt; Result&lt;HashSet&lt;Value&gt;, Error&gt; {
<a href="#h27-7-3" id="h27-7-3" class="d">-        deserialize(&amp;self.raft.query(serialize(&amp;Query::ReadIndex {
</a><a href="#h27-7-4" id="h27-7-4" class="i">+        deserialize(&amp;self.client.query_sync(serialize(&amp;Query::ReadIndex {
</a>             txn_id: self.id,
             table: table.to_string(),
             column: column.to_string(),
<a href="#h27-8" id="h27-8" class="h">@@ -163,9 +167,9 @@ impl super::Transaction for Transaction {
</a>         })?)?)
     }
 
<a href="#h27-8-3" id="h27-8-3" class="d">-    fn scan(&amp;self, table: &amp;str, filter: Option&lt;Expression&gt;) -&gt; Result&lt;super::Scan, Error&gt; {
</a><a href="#h27-8-4" id="h27-8-4" class="i">+    fn scan(&amp;self, table: &amp;str, filter: Option&lt;Expression&gt;) -&gt; Result&lt;Scan, Error&gt; {
</a>         Ok(Box::new(
<a href="#h27-8-6" id="h27-8-6" class="d">-            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.raft.query(serialize(&amp;Query::Scan {
</a><a href="#h27-8-7" id="h27-8-7" class="i">+            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.client.query_sync(serialize(&amp;Query::Scan {
</a>                 txn_id: self.id,
                 table: table.to_string(),
                 filter,
<a href="#h27-9" id="h27-9" class="h">@@ -175,9 +179,9 @@ impl super::Transaction for Transaction {
</a>         ))
     }
 
<a href="#h27-9-3" id="h27-9-3" class="d">-    fn scan_index(&amp;self, table: &amp;str, column: &amp;str) -&gt; Result&lt;super::IndexScan, Error&gt; {
</a><a href="#h27-9-4" id="h27-9-4" class="i">+    fn scan_index(&amp;self, table: &amp;str, column: &amp;str) -&gt; Result&lt;IndexScan, Error&gt; {
</a>         Ok(Box::new(
<a href="#h27-9-6" id="h27-9-6" class="d">-            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.raft.query(serialize(&amp;Query::ScanIndex {
</a><a href="#h27-9-7" id="h27-9-7" class="i">+            deserialize::&lt;Vec&lt;_&gt;&gt;(&amp;self.client.query_sync(serialize(&amp;Query::ScanIndex {
</a>                 txn_id: self.id,
                 table: table.to_string(),
                 column: column.to_string(),
<a href="#h27-10" id="h27-10" class="h">@@ -188,7 +192,7 @@ impl super::Transaction for Transaction {
</a>     }
 
     fn update(&amp;mut self, table: &amp;str, id: &amp;Value, row: Row) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-10-3" id="h27-10-3" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::Update {
</a><a href="#h27-10-4" id="h27-10-4" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::Update {
</a>             txn_id: self.id,
             table: table.to_string(),
             id: id.clone(),
<a href="#h27-11" id="h27-11" class="h">@@ -199,32 +203,30 @@ impl super::Transaction for Transaction {
</a> 
 impl Catalog for Transaction {
     fn create_table(&amp;mut self, table: &amp;Table) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-11-3" id="h27-11-3" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::CreateTable {
</a><a href="#h27-11-4" id="h27-11-4" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::CreateTable {
</a>             txn_id: self.id,
             schema: table.clone(),
         })?)?)
     }
 
     fn delete_table(&amp;mut self, table: &amp;str) -&gt; Result&lt;(), Error&gt; {
<a href="#h27-11-11" id="h27-11-11" class="d">-        deserialize(&amp;self.raft.mutate(serialize(&amp;Mutation::DeleteTable {
</a><a href="#h27-11-12" id="h27-11-12" class="i">+        deserialize(&amp;self.client.mutate_sync(serialize(&amp;Mutation::DeleteTable {
</a>             txn_id: self.id,
             table: table.to_string(),
         })?)?)
     }
 
     fn read_table(&amp;self, table: &amp;str) -&gt; Result&lt;Option&lt;Table&gt;, Error&gt; {
<a href="#h27-11-19" id="h27-11-19" class="d">-        deserialize(
</a><a href="#h27-11-20" id="h27-11-20" class="d">-            &amp;self.raft.query(serialize(&amp;Query::ReadTable {
</a><a href="#h27-11-21" id="h27-11-21" class="d">-                txn_id: self.id,
</a><a href="#h27-11-22" id="h27-11-22" class="d">-                table: table.to_string(),
</a><a href="#h27-11-23" id="h27-11-23" class="d">-            })?)?,
</a><a href="#h27-11-24" id="h27-11-24" class="d">-        )
</a><a href="#h27-11-25" id="h27-11-25" class="i">+        deserialize(&amp;self.client.query_sync(serialize(&amp;Query::ReadTable {
</a><a href="#h27-11-26" id="h27-11-26" class="i">+            txn_id: self.id,
</a><a href="#h27-11-27" id="h27-11-27" class="i">+            table: table.to_string(),
</a><a href="#h27-11-28" id="h27-11-28" class="i">+        })?)?)
</a>     }
 
     fn scan_tables(&amp;self) -&gt; Result&lt;Tables, Error&gt; {
         Ok(Box::new(
             deserialize::&lt;Vec&lt;_&gt;&gt;(
<a href="#h27-11-34" id="h27-11-34" class="d">-                &amp;self.raft.query(serialize(&amp;Query::ScanTables { txn_id: self.id })?)?,
</a><a href="#h27-11-35" id="h27-11-35" class="i">+                &amp;self.client.query_sync(serialize(&amp;Query::ScanTables { txn_id: self.id })?)?,
</a>             )?
             .into_iter(),
         ))
<b>diff --git a/<a id="h28" href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a> b/<a href="../file/tests/client/mod.rs.html">tests/client/mod.rs</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -1,75 +1,19 @@
</a><a href="#h28-0-0" id="h28-0-0" class="d">-use super::setup;
</a><a href="#h28-0-1" id="h28-0-1" class="d">-use super::util::{assert_row, assert_rows};
</a><a href="#h28-0-2" id="h28-0-2" class="i">+use super::{assert_row, assert_rows, setup};
</a> 
<a href="#h28-0-4" id="h28-0-4" class="d">-use toydb::server::Status;
</a><a href="#h28-0-5" id="h28-0-5" class="i">+use toydb::raft::Status;
</a> use toydb::sql::engine::Mode;
 use toydb::sql::execution::ResultSet;
 use toydb::sql::schema;
 use toydb::sql::types::{Column, DataType, Relation, Value};
<a href="#h28-0-10" id="h28-0-10" class="d">-use toydb::Client;
</a><a href="#h28-0-11" id="h28-0-11" class="d">-use toydb::Error;
</a><a href="#h28-0-12" id="h28-0-12" class="i">+use toydb::{Client, Error};
</a> 
 use pretty_assertions::assert_eq;
 use serial_test::serial;
 
<a href="#h28-0-17" id="h28-0-17" class="d">-#[allow(clippy::type_complexity)]
</a><a href="#h28-0-18" id="h28-0-18" class="d">-async fn setup_movies() -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h28-0-19" id="h28-0-19" class="d">-    setup::server_with_queries(vec![
</a><a href="#h28-0-20" id="h28-0-20" class="d">-        &quot;CREATE TABLE countries (
</a><a href="#h28-0-21" id="h28-0-21" class="d">-            id STRING PRIMARY KEY,
</a><a href="#h28-0-22" id="h28-0-22" class="d">-            name STRING NOT NULL
</a><a href="#h28-0-23" id="h28-0-23" class="d">-        )&quot;,
</a><a href="#h28-0-24" id="h28-0-24" class="d">-        &quot;INSERT INTO countries VALUES
</a><a href="#h28-0-25" id="h28-0-25" class="d">-            (&#39;fr&#39;, &#39;France&#39;),
</a><a href="#h28-0-26" id="h28-0-26" class="d">-            (&#39;ru&#39;, &#39;Russia&#39;),
</a><a href="#h28-0-27" id="h28-0-27" class="d">-            (&#39;us&#39;, &#39;United States of America&#39;)&quot;,
</a><a href="#h28-0-28" id="h28-0-28" class="d">-        &quot;CREATE TABLE genres (
</a><a href="#h28-0-29" id="h28-0-29" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h28-0-30" id="h28-0-30" class="d">-            name STRING NOT NULL
</a><a href="#h28-0-31" id="h28-0-31" class="d">-        )&quot;,
</a><a href="#h28-0-32" id="h28-0-32" class="d">-        &quot;INSERT INTO genres VALUES
</a><a href="#h28-0-33" id="h28-0-33" class="d">-            (1, &#39;Science Fiction&#39;),
</a><a href="#h28-0-34" id="h28-0-34" class="d">-            (2, &#39;Action&#39;),
</a><a href="#h28-0-35" id="h28-0-35" class="d">-            (3, &#39;Comedy&#39;)&quot;,
</a><a href="#h28-0-36" id="h28-0-36" class="d">-        &quot;CREATE TABLE studios (
</a><a href="#h28-0-37" id="h28-0-37" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h28-0-38" id="h28-0-38" class="d">-            name STRING NOT NULL,
</a><a href="#h28-0-39" id="h28-0-39" class="d">-            country_id STRING REFERENCES countries
</a><a href="#h28-0-40" id="h28-0-40" class="d">-        )&quot;,
</a><a href="#h28-0-41" id="h28-0-41" class="d">-        &quot;INSERT INTO studios VALUES
</a><a href="#h28-0-42" id="h28-0-42" class="d">-            (1, &#39;Mosfilm&#39;, &#39;ru&#39;),
</a><a href="#h28-0-43" id="h28-0-43" class="d">-            (2, &#39;Lionsgate&#39;, &#39;us&#39;),
</a><a href="#h28-0-44" id="h28-0-44" class="d">-            (3, &#39;StudioCanal&#39;, &#39;fr&#39;),
</a><a href="#h28-0-45" id="h28-0-45" class="d">-            (4, &#39;Warner Bros&#39;, &#39;us&#39;)&quot;,
</a><a href="#h28-0-46" id="h28-0-46" class="d">-        &quot;CREATE TABLE movies (
</a><a href="#h28-0-47" id="h28-0-47" class="d">-            id INTEGER PRIMARY KEY,
</a><a href="#h28-0-48" id="h28-0-48" class="d">-            title STRING NOT NULL,
</a><a href="#h28-0-49" id="h28-0-49" class="d">-            studio_id INTEGER NOT NULL REFERENCES studios,
</a><a href="#h28-0-50" id="h28-0-50" class="d">-            genre_id INTEGER NOT NULL REFERENCES genres,
</a><a href="#h28-0-51" id="h28-0-51" class="d">-            released INTEGER NOT NULL,
</a><a href="#h28-0-52" id="h28-0-52" class="d">-            rating FLOAT,
</a><a href="#h28-0-53" id="h28-0-53" class="d">-            ultrahd BOOLEAN
</a><a href="#h28-0-54" id="h28-0-54" class="d">-        )&quot;,
</a><a href="#h28-0-55" id="h28-0-55" class="d">-        &quot;INSERT INTO movies VALUES
</a><a href="#h28-0-56" id="h28-0-56" class="d">-            (1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL),
</a><a href="#h28-0-57" id="h28-0-57" class="d">-            (2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE),
</a><a href="#h28-0-58" id="h28-0-58" class="d">-            (3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL),
</a><a href="#h28-0-59" id="h28-0-59" class="d">-            (4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE),
</a><a href="#h28-0-60" id="h28-0-60" class="d">-            (5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE),
</a><a href="#h28-0-61" id="h28-0-61" class="d">-            (6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL),
</a><a href="#h28-0-62" id="h28-0-62" class="d">-            (7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE),
</a><a href="#h28-0-63" id="h28-0-63" class="d">-            (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE),
</a><a href="#h28-0-64" id="h28-0-64" class="d">-            (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE),
</a><a href="#h28-0-65" id="h28-0-65" class="d">-            (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)&quot;,
</a><a href="#h28-0-66" id="h28-0-66" class="d">-    ])
</a><a href="#h28-0-67" id="h28-0-67" class="d">-    .await
</a><a href="#h28-0-68" id="h28-0-68" class="d">-}
</a><a href="#h28-0-69" id="h28-0-69" class="d">-
</a><a href="#h28-0-70" id="h28-0-70" class="d">-#[tokio::test]
</a><a href="#h28-0-71" id="h28-0-71" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn get_table() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-0-74" id="h28-0-74" class="d">-    let (c, teardown) = setup_movies().await?;
</a><a href="#h28-0-75" id="h28-0-75" class="d">-    defer!(teardown());
</a><a href="#h28-0-76" id="h28-0-76" class="i">+    let (c, _teardown) = setup::server_with_data(setup::movies()).await?;
</a> 
     assert_eq!(
         c.get_table(&quot;unknown&quot;).await,
<a href="#h28-1" id="h28-1" class="h">@@ -156,36 +100,40 @@ async fn get_table() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h28-1-3" id="h28-1-3" class="d">-#[tokio::test]
</a><a href="#h28-1-4" id="h28-1-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn list_tables() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-1-7" id="h28-1-7" class="d">-    let (c, teardown) = setup_movies().await?;
</a><a href="#h28-1-8" id="h28-1-8" class="d">-    defer!(teardown());
</a><a href="#h28-1-9" id="h28-1-9" class="i">+    let (c, _teardown) = setup::server_with_data(setup::movies()).await?;
</a> 
     assert_eq!(c.list_tables().await?, vec![&quot;countries&quot;, &quot;genres&quot;, &quot;movies&quot;, &quot;studios&quot;]);
     Ok(())
 }
 
<a href="#h28-1-15" id="h28-1-15" class="d">-#[tokio::test]
</a><a href="#h28-1-16" id="h28-1-16" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn status() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-1-19" id="h28-1-19" class="d">-    let (c, teardown) = setup_movies().await?;
</a><a href="#h28-1-20" id="h28-1-20" class="d">-    defer!(teardown());
</a><a href="#h28-1-21" id="h28-1-21" class="i">+    let (c, _teardown) = setup::server_with_data(setup::movies()).await?;
</a> 
     assert_eq!(
         c.status().await?,
<a href="#h28-1-25" id="h28-1-25" class="d">-        Status { id: &quot;test&quot;.into(), version: env!(&quot;CARGO_PKG_VERSION&quot;).into() }
</a><a href="#h28-1-26" id="h28-1-26" class="i">+        Status {
</a><a href="#h28-1-27" id="h28-1-27" class="i">+            id: &quot;test&quot;.into(),
</a><a href="#h28-1-28" id="h28-1-28" class="i">+            role: &quot;leader&quot;.into(),
</a><a href="#h28-1-29" id="h28-1-29" class="i">+            leader: Some(&quot;test&quot;.into()),
</a><a href="#h28-1-30" id="h28-1-30" class="i">+            nodes: 1,
</a><a href="#h28-1-31" id="h28-1-31" class="i">+            term: 0,
</a><a href="#h28-1-32" id="h28-1-32" class="i">+            entries: 26,
</a><a href="#h28-1-33" id="h28-1-33" class="i">+            committed: 26,
</a><a href="#h28-1-34" id="h28-1-34" class="i">+            applied: 26,
</a><a href="#h28-1-35" id="h28-1-35" class="i">+        }
</a>     );
     Ok(())
 }
 
<a href="#h28-1-40" id="h28-1-40" class="d">-#[tokio::test]
</a><a href="#h28-1-41" id="h28-1-41" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn query() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-1-44" id="h28-1-44" class="d">-    // The SQL engine is thoroughly tested in a separate suite, this just exercises the
</a><a href="#h28-1-45" id="h28-1-45" class="d">-    // basic client/server integration.
</a><a href="#h28-1-46" id="h28-1-46" class="d">-    let (c, teardown) = setup_movies().await?;
</a><a href="#h28-1-47" id="h28-1-47" class="d">-    defer!(teardown());
</a><a href="#h28-1-48" id="h28-1-48" class="i">+    let (c, _teardown) = setup::server_with_data(setup::movies()).await?;
</a> 
     // SELECT
     let result = c.execute(&quot;SELECT * FROM genres&quot;).await?;
<a href="#h28-2" id="h28-2" class="h">@@ -275,11 +223,10 @@ async fn query() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h28-2-3" id="h28-2-3" class="d">-#[tokio::test]
</a><a href="#h28-2-4" id="h28-2-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn query_txn() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-2-7" id="h28-2-7" class="d">-    let (c, teardown) = setup_movies().await?;
</a><a href="#h28-2-8" id="h28-2-8" class="d">-    defer!(teardown());
</a><a href="#h28-2-9" id="h28-2-9" class="i">+    let (c, _teardown) = setup::server_with_data(setup::movies()).await?;
</a> 
     // Committing a change in a txn should work
     assert_eq!(c.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
<a href="#h28-3" id="h28-3" class="h">@@ -357,12 +304,11 @@ async fn query_txn() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h28-3-3" id="h28-3-3" class="d">-#[tokio::test]
</a><a href="#h28-3-4" id="h28-3-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 async fn query_txn_concurrent() -&gt; Result&lt;(), Error&gt; {
<a href="#h28-3-7" id="h28-3-7" class="d">-    let (a, teardown) = setup_movies().await?;
</a><a href="#h28-3-8" id="h28-3-8" class="i">+    let (a, _teardown) = setup::server_with_data(setup::movies()).await?;
</a>     let b = Client::new(&quot;127.0.0.1:9605&quot;).await?;
<a href="#h28-3-10" id="h28-3-10" class="d">-    defer!(teardown());
</a> 
     // Concurrent updates should throw a serialization failure on conflict.
     assert_eq!(a.execute(&quot;BEGIN&quot;).await?, ResultSet::Begin { id: 2, mode: Mode::ReadWrite });
<b>diff --git a/<a id="h29" href="../file/tests/cluster/isolation.rs.html">tests/cluster/isolation.rs</a> b/<a href="../file/tests/cluster/isolation.rs.html">tests/cluster/isolation.rs</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -1,18 +1,15 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+use super::super::{assert_row, assert_rows, setup};
</a><a href="#h29-0-1" id="h29-0-1" class="i">+
</a> use toydb::sql::types::Value;
 use toydb::Error;
 
<a href="#h29-0-5" id="h29-0-5" class="d">-use super::super::setup;
</a><a href="#h29-0-6" id="h29-0-6" class="d">-use super::super::util::{assert_row, assert_rows};
</a><a href="#h29-0-7" id="h29-0-7" class="d">-
</a><a href="#h29-0-8" id="h29-0-8" class="d">-use pretty_assertions::assert_eq;
</a> use serial_test::serial;
 
<a href="#h29-0-11" id="h29-0-11" class="d">-#[tokio::test]
</a><a href="#h29-0-12" id="h29-0-12" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // A dirty write is when b overwrites an uncommitted value written by a.
 async fn anomaly_dirty_write() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-0-16" id="h29-0-16" class="d">-    let (a, b, _, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-0-17" id="h29-0-17" class="d">-    defer!(teardown());
</a><a href="#h29-0-18" id="h29-0-18" class="i">+    let (a, b, _, _teardown) = setup::cluster_simple().await?;
</a> 
     a.execute(&quot;BEGIN&quot;).await?;
     a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;).await?;
<a href="#h29-1" id="h29-1" class="h">@@ -28,12 +25,11 @@ async fn anomaly_dirty_write() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h29-1-3" id="h29-1-3" class="d">-#[tokio::test]
</a><a href="#h29-1-4" id="h29-1-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // A dirty read is when b can read an uncommitted value set by a.
 async fn anomaly_dirty_read() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-1-8" id="h29-1-8" class="d">-    let (a, b, _, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-1-9" id="h29-1-9" class="d">-    defer!(teardown());
</a><a href="#h29-1-10" id="h29-1-10" class="i">+    let (a, b, _, _teardown) = setup::cluster_simple().await?;
</a> 
     a.execute(&quot;BEGIN&quot;).await?;
     a.execute(&quot;INSERT INTO test VALUES (1, &#39;a&#39;)&quot;).await?;
<a href="#h29-2" id="h29-2" class="h">@@ -43,12 +39,11 @@ async fn anomaly_dirty_read() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h29-2-3" id="h29-2-3" class="d">-#[tokio::test]
</a><a href="#h29-2-4" id="h29-2-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // A lost update is when a and b both read a value and update it, where b&#39;s update replaces a.
 async fn anomaly_lost_update() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-2-8" id="h29-2-8" class="d">-    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-2-9" id="h29-2-9" class="d">-    defer!(teardown());
</a><a href="#h29-2-10" id="h29-2-10" class="i">+    let (a, b, c, _teardown) = setup::cluster_simple().await?;
</a> 
     c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;).await?;
 
<a href="#h29-3" id="h29-3" class="h">@@ -70,12 +65,11 @@ async fn anomaly_lost_update() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h29-3-3" id="h29-3-3" class="d">-#[tokio::test]
</a><a href="#h29-3-4" id="h29-3-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // A fuzzy (or unrepeatable) read is when b sees a value change after a updates it.
 async fn anomaly_fuzzy_read() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-3-8" id="h29-3-8" class="d">-    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-3-9" id="h29-3-9" class="d">-    defer!(teardown());
</a><a href="#h29-3-10" id="h29-3-10" class="i">+    let (a, b, c, _teardown) = setup::cluster_simple().await?;
</a> 
     c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;)&quot;).await?;
 
<a href="#h29-4" id="h29-4" class="h">@@ -96,12 +90,11 @@ async fn anomaly_fuzzy_read() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h29-4-3" id="h29-4-3" class="d">-#[tokio::test]
</a><a href="#h29-4-4" id="h29-4-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // Read skew is when a reads 1 and 2, but b modifies 2 in between the reads.
 async fn anomaly_read_skew() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-4-8" id="h29-4-8" class="d">-    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-4-9" id="h29-4-9" class="d">-    defer!(teardown());
</a><a href="#h29-4-10" id="h29-4-10" class="i">+    let (a, b, c, _teardown) = setup::cluster_simple().await?;
</a> 
     c.execute(&quot;INSERT INTO test VALUES (1, &#39;c&#39;), (2, &#39;c&#39;)&quot;).await?;
 
<a href="#h29-5" id="h29-5" class="h">@@ -122,13 +115,12 @@ async fn anomaly_read_skew() -&gt; Result&lt;(), Error&gt; {
</a>     Ok(())
 }
 
<a href="#h29-5-3" id="h29-5-3" class="d">-#[tokio::test]
</a><a href="#h29-5-4" id="h29-5-4" class="i">+#[tokio::test(core_threads = 2)]
</a> #[serial]
 // A phantom read is when a reads entries matching some predicate, but a modification by
 // b changes the entries that match the predicate such that a later read by a returns them.
 async fn anomaly_phantom_read() -&gt; Result&lt;(), Error&gt; {
<a href="#h29-5-9" id="h29-5-9" class="d">-    let (a, b, c, teardown) = setup::cluster_simple().await?;
</a><a href="#h29-5-10" id="h29-5-10" class="d">-    defer!(teardown());
</a><a href="#h29-5-11" id="h29-5-11" class="i">+    let (a, b, c, _teardown) = setup::cluster_simple().await?;
</a> 
     c.execute(&quot;INSERT INTO test VALUES (1, &#39;true&#39;), (2, &#39;false&#39;)&quot;).await?;
 
<b>diff --git a/<a id="h30" href="../file/tests/setup.rs.html">tests/setup.rs</a> b/<a href="../file/tests/setup.rs.html">tests/setup.rs</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -8,40 +8,89 @@ use toydb::Error;
</a> use futures_util::future::FutureExt as _;
 use pretty_assertions::assert_eq;
 use std::collections::HashMap;
<a href="#h30-0-3" id="h30-0-3" class="i">+use tempdir::TempDir;
</a><a href="#h30-0-4" id="h30-0-4" class="i">+
</a><a href="#h30-0-5" id="h30-0-5" class="i">+// Movie data
</a><a href="#h30-0-6" id="h30-0-6" class="i">+pub fn movies() -&gt; Vec&lt;&amp;&#39;static str&gt; {
</a><a href="#h30-0-7" id="h30-0-7" class="i">+    vec![
</a><a href="#h30-0-8" id="h30-0-8" class="i">+        &quot;CREATE TABLE countries (
</a><a href="#h30-0-9" id="h30-0-9" class="i">+            id STRING PRIMARY KEY,
</a><a href="#h30-0-10" id="h30-0-10" class="i">+            name STRING NOT NULL
</a><a href="#h30-0-11" id="h30-0-11" class="i">+        )&quot;,
</a><a href="#h30-0-12" id="h30-0-12" class="i">+        &quot;INSERT INTO countries VALUES
</a><a href="#h30-0-13" id="h30-0-13" class="i">+            (&#39;fr&#39;, &#39;France&#39;),
</a><a href="#h30-0-14" id="h30-0-14" class="i">+            (&#39;ru&#39;, &#39;Russia&#39;),
</a><a href="#h30-0-15" id="h30-0-15" class="i">+            (&#39;us&#39;, &#39;United States of America&#39;)&quot;,
</a><a href="#h30-0-16" id="h30-0-16" class="i">+        &quot;CREATE TABLE genres (
</a><a href="#h30-0-17" id="h30-0-17" class="i">+            id INTEGER PRIMARY KEY,
</a><a href="#h30-0-18" id="h30-0-18" class="i">+            name STRING NOT NULL
</a><a href="#h30-0-19" id="h30-0-19" class="i">+        )&quot;,
</a><a href="#h30-0-20" id="h30-0-20" class="i">+        &quot;INSERT INTO genres VALUES
</a><a href="#h30-0-21" id="h30-0-21" class="i">+            (1, &#39;Science Fiction&#39;),
</a><a href="#h30-0-22" id="h30-0-22" class="i">+            (2, &#39;Action&#39;),
</a><a href="#h30-0-23" id="h30-0-23" class="i">+            (3, &#39;Comedy&#39;)&quot;,
</a><a href="#h30-0-24" id="h30-0-24" class="i">+        &quot;CREATE TABLE studios (
</a><a href="#h30-0-25" id="h30-0-25" class="i">+            id INTEGER PRIMARY KEY,
</a><a href="#h30-0-26" id="h30-0-26" class="i">+            name STRING NOT NULL,
</a><a href="#h30-0-27" id="h30-0-27" class="i">+            country_id STRING REFERENCES countries
</a><a href="#h30-0-28" id="h30-0-28" class="i">+        )&quot;,
</a><a href="#h30-0-29" id="h30-0-29" class="i">+        &quot;INSERT INTO studios VALUES
</a><a href="#h30-0-30" id="h30-0-30" class="i">+            (1, &#39;Mosfilm&#39;, &#39;ru&#39;),
</a><a href="#h30-0-31" id="h30-0-31" class="i">+            (2, &#39;Lionsgate&#39;, &#39;us&#39;),
</a><a href="#h30-0-32" id="h30-0-32" class="i">+            (3, &#39;StudioCanal&#39;, &#39;fr&#39;),
</a><a href="#h30-0-33" id="h30-0-33" class="i">+            (4, &#39;Warner Bros&#39;, &#39;us&#39;)&quot;,
</a><a href="#h30-0-34" id="h30-0-34" class="i">+        &quot;CREATE TABLE movies (
</a><a href="#h30-0-35" id="h30-0-35" class="i">+            id INTEGER PRIMARY KEY,
</a><a href="#h30-0-36" id="h30-0-36" class="i">+            title STRING NOT NULL,
</a><a href="#h30-0-37" id="h30-0-37" class="i">+            studio_id INTEGER NOT NULL REFERENCES studios,
</a><a href="#h30-0-38" id="h30-0-38" class="i">+            genre_id INTEGER NOT NULL REFERENCES genres,
</a><a href="#h30-0-39" id="h30-0-39" class="i">+            released INTEGER NOT NULL,
</a><a href="#h30-0-40" id="h30-0-40" class="i">+            rating FLOAT,
</a><a href="#h30-0-41" id="h30-0-41" class="i">+            ultrahd BOOLEAN
</a><a href="#h30-0-42" id="h30-0-42" class="i">+        )&quot;,
</a><a href="#h30-0-43" id="h30-0-43" class="i">+        &quot;INSERT INTO movies VALUES
</a><a href="#h30-0-44" id="h30-0-44" class="i">+            (1, &#39;Stalker&#39;, 1, 1, 1979, 8.2, NULL),
</a><a href="#h30-0-45" id="h30-0-45" class="i">+            (2, &#39;Sicario&#39;, 2, 2, 2015, 7.6, TRUE),
</a><a href="#h30-0-46" id="h30-0-46" class="i">+            (3, &#39;Primer&#39;, 3, 1, 2004, 6.9, NULL),
</a><a href="#h30-0-47" id="h30-0-47" class="i">+            (4, &#39;Heat&#39;, 4, 2, 1995, 8.2, TRUE),
</a><a href="#h30-0-48" id="h30-0-48" class="i">+            (5, &#39;The Fountain&#39;, 4, 1, 2006, 7.2, FALSE),
</a><a href="#h30-0-49" id="h30-0-49" class="i">+            (6, &#39;Solaris&#39;, 1, 1, 1972, 8.1, NULL),
</a><a href="#h30-0-50" id="h30-0-50" class="i">+            (7, &#39;Gravity&#39;, 4, 1, 2013, 7.7, TRUE),
</a><a href="#h30-0-51" id="h30-0-51" class="i">+            (8, &#39;Blindspotting&#39;, 2, 3, 2018, 7.4, TRUE),
</a><a href="#h30-0-52" id="h30-0-52" class="i">+            (9, &#39;Birdman&#39;, 4, 3, 2014, 7.7, TRUE),
</a><a href="#h30-0-53" id="h30-0-53" class="i">+            (10, &#39;Inception&#39;, 4, 1, 2010, 8.8, TRUE)&quot;,
</a><a href="#h30-0-54" id="h30-0-54" class="i">+    ]
</a><a href="#h30-0-55" id="h30-0-55" class="i">+}
</a> 
<a href="#h30-0-57" id="h30-0-57" class="d">-/// Sets up a test server, returning a teardown closure
</a><a href="#h30-0-58" id="h30-0-58" class="i">+/// Sets up a test server
</a> pub async fn server(
     id: &amp;str,
     addr_sql: &amp;str,
     addr_raft: &amp;str,
     peers: HashMap&lt;String, String&gt;,
<a href="#h30-0-64" id="h30-0-64" class="d">-) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Error&gt; {
</a><a href="#h30-0-65" id="h30-0-65" class="d">-    let data_dir = tempdir::TempDir::new(&quot;toydb&quot;).unwrap();
</a><a href="#h30-0-66" id="h30-0-66" class="d">-    let srv = Server::new(
</a><a href="#h30-0-67" id="h30-0-67" class="d">-        id,
</a><a href="#h30-0-68" id="h30-0-68" class="d">-        peers.into_iter().map(|(k, v)| (k, v.parse().unwrap())).collect(),
</a><a href="#h30-0-69" id="h30-0-69" class="d">-        &amp;data_dir.path().to_string_lossy(),
</a><a href="#h30-0-70" id="h30-0-70" class="d">-    )?;
</a><a href="#h30-0-71" id="h30-0-71" class="d">-
</a><a href="#h30-0-72" id="h30-0-72" class="d">-    let (f, abort) = srv.listen(addr_sql.into(), addr_raft.into()).remote_handle();
</a><a href="#h30-0-73" id="h30-0-73" class="i">+) -&gt; Result&lt;Teardown, Error&gt; {
</a><a href="#h30-0-74" id="h30-0-74" class="i">+    let dir = TempDir::new(&quot;toydb&quot;)?;
</a><a href="#h30-0-75" id="h30-0-75" class="i">+    let mut srv = Server::new(id, peers, &amp;dir.path().to_string_lossy())?;
</a> 
<a href="#h30-0-77" id="h30-0-77" class="d">-    tokio::spawn(f);
</a><a href="#h30-0-78" id="h30-0-78" class="i">+    srv = srv.listen(addr_sql, addr_raft).await?;
</a><a href="#h30-0-79" id="h30-0-79" class="i">+    let (task, abort) = srv.serve().remote_handle();
</a><a href="#h30-0-80" id="h30-0-80" class="i">+    tokio::spawn(task);
</a> 
<a href="#h30-0-82" id="h30-0-82" class="d">-    Ok(Box::new(move || {
</a><a href="#h30-0-83" id="h30-0-83" class="i">+    Ok(Teardown::new(move || {
</a>         std::mem::drop(abort);
<a href="#h30-0-85" id="h30-0-85" class="i">+        std::mem::drop(dir);
</a>     }))
 }
 
 /// Sets up a server with a client
<a href="#h30-0-90" id="h30-0-90" class="d">-pub async fn server_with_client() -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h30-0-91" id="h30-0-91" class="i">+pub async fn server_with_client() -&gt; Result&lt;(Client, Teardown), Error&gt; {
</a>     let teardown = server(&quot;test&quot;, &quot;127.0.0.1:9605&quot;, &quot;127.0.0.1:9705&quot;, HashMap::new()).await?;
<a href="#h30-0-93" id="h30-0-93" class="d">-    tokio::time::delay_for(std::time::Duration::from_millis(10)).await;
</a>     let client = Client::new(&quot;127.0.0.1:9605&quot;).await?;
     Ok((client, teardown))
 }
 
<a href="#h30-0-98" id="h30-0-98" class="d">-/// Sets up a server with a client and a s
</a><a href="#h30-0-99" id="h30-0-99" class="d">-pub async fn server_with_queries(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h30-0-100" id="h30-0-100" class="i">+/// Sets up a server with a client and a set of queries
</a><a href="#h30-0-101" id="h30-0-101" class="i">+pub async fn server_with_data(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Teardown), Error&gt; {
</a>     let (client, teardown) = server_with_client().await?;
     client.execute(&quot;BEGIN&quot;).await?;
     for query in queries {
<a href="#h30-1" id="h30-1" class="h">@@ -51,27 +100,22 @@ pub async fn server_with_queries(queries: Vec&lt;&amp;str&gt;) -&gt; Result&lt;(Client, Box&lt;dyn 
</a>     Ok((client, teardown))
 }
 
<a href="#h30-1-3" id="h30-1-3" class="d">-/// Sets up a server cluster, returning a teardown closure
</a><a href="#h30-1-4" id="h30-1-4" class="d">-pub async fn cluster(nodes: HashMap&lt;String, (String, String)&gt;) -&gt; Result&lt;Box&lt;dyn FnOnce()&gt;, Error&gt; {
</a><a href="#h30-1-5" id="h30-1-5" class="d">-    let mut teardowns = Vec::new();
</a><a href="#h30-1-6" id="h30-1-6" class="i">+/// Sets up a server cluster
</a><a href="#h30-1-7" id="h30-1-7" class="i">+pub async fn cluster(nodes: HashMap&lt;String, (String, String)&gt;) -&gt; Result&lt;Teardown, Error&gt; {
</a><a href="#h30-1-8" id="h30-1-8" class="i">+    let mut teardown = Teardown::empty();
</a>     for (id, (addr_sql, addr_raft)) in nodes.iter() {
         let peers = nodes
             .iter()
             .filter(|(i, _)| i != &amp;id)
             .map(|(id, (_, raft))| (id.clone(), raft.clone()))
             .collect();
<a href="#h30-1-15" id="h30-1-15" class="d">-        let teardown = server(id, addr_sql, addr_raft, peers).await?;
</a><a href="#h30-1-16" id="h30-1-16" class="d">-        teardowns.push(teardown);
</a><a href="#h30-1-17" id="h30-1-17" class="i">+        teardown.merge(server(id, addr_sql, addr_raft, peers).await?);
</a>     }
<a href="#h30-1-19" id="h30-1-19" class="d">-    Ok(Box::new(move || {
</a><a href="#h30-1-20" id="h30-1-20" class="d">-        for teardown in teardowns {
</a><a href="#h30-1-21" id="h30-1-21" class="d">-            teardown()
</a><a href="#h30-1-22" id="h30-1-22" class="d">-        }
</a><a href="#h30-1-23" id="h30-1-23" class="d">-    }))
</a><a href="#h30-1-24" id="h30-1-24" class="i">+    Ok(teardown)
</a> }
 
<a href="#h30-1-27" id="h30-1-27" class="d">-/// Sets up a server cluster with clients, returning the clients and a teardown closure
</a><a href="#h30-1-28" id="h30-1-28" class="d">-pub async fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h30-1-29" id="h30-1-29" class="i">+/// Sets up a server cluster with clients
</a><a href="#h30-1-30" id="h30-1-30" class="i">+pub async fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Teardown), Error&gt; {
</a>     let mut nodes = HashMap::new();
     for i in 0..size {
         nodes.insert(
<a href="#h30-2" id="h30-2" class="h">@@ -81,9 +125,6 @@ pub async fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Box&lt;dyn FnO
</a>     }
     let teardown = cluster(nodes.clone()).await?;
 
<a href="#h30-2-3" id="h30-2-3" class="d">-    // FIXME Wait for cluster to start listening (should wait for listen future)
</a><a href="#h30-2-4" id="h30-2-4" class="d">-    tokio::time::delay_for(std::time::Duration::from_millis(20)).await;
</a><a href="#h30-2-5" id="h30-2-5" class="d">-
</a>     let mut clients = Vec::&lt;Client&gt;::new();
     for (id, (addr_sql, _)) in nodes {
         let client = Client::new(addr_sql).await?;
<a href="#h30-3" id="h30-3" class="h">@@ -93,18 +134,69 @@ pub async fn cluster_with_clients(size: u64) -&gt; Result&lt;(Vec&lt;Client&gt;, Box&lt;dyn FnO
</a>     Ok((clients, teardown))
 }
 
<a href="#h30-3-3" id="h30-3-3" class="i">+/// Sets up a server cluster with clients and queries
</a><a href="#h30-3-4" id="h30-3-4" class="i">+pub async fn cluster_with_data(
</a><a href="#h30-3-5" id="h30-3-5" class="i">+    size: u64,
</a><a href="#h30-3-6" id="h30-3-6" class="i">+    queries: Vec&lt;&amp;str&gt;,
</a><a href="#h30-3-7" id="h30-3-7" class="i">+) -&gt; Result&lt;(Vec&lt;Client&gt;, Teardown), Error&gt; {
</a><a href="#h30-3-8" id="h30-3-8" class="i">+    let (mut clients, teardown) = cluster_with_clients(size).await?;
</a><a href="#h30-3-9" id="h30-3-9" class="i">+
</a><a href="#h30-3-10" id="h30-3-10" class="i">+    // FIXME Wait for cluster to stabilize, see: https://github.com/erikgrinaker/toydb/issues/19
</a><a href="#h30-3-11" id="h30-3-11" class="i">+    tokio::time::delay_for(std::time::Duration::from_millis(2000)).await;
</a><a href="#h30-3-12" id="h30-3-12" class="i">+
</a><a href="#h30-3-13" id="h30-3-13" class="i">+    let c = clients.get_mut(0).unwrap();
</a><a href="#h30-3-14" id="h30-3-14" class="i">+    c.execute(&quot;BEGIN&quot;).await?;
</a><a href="#h30-3-15" id="h30-3-15" class="i">+    for query in queries {
</a><a href="#h30-3-16" id="h30-3-16" class="i">+        c.execute(query).await?;
</a><a href="#h30-3-17" id="h30-3-17" class="i">+    }
</a><a href="#h30-3-18" id="h30-3-18" class="i">+    c.execute(&quot;COMMIT&quot;).await?;
</a><a href="#h30-3-19" id="h30-3-19" class="i">+
</a><a href="#h30-3-20" id="h30-3-20" class="i">+    Ok((clients, teardown))
</a><a href="#h30-3-21" id="h30-3-21" class="i">+}
</a><a href="#h30-3-22" id="h30-3-22" class="i">+
</a> /// Sets up a simple cluster with 3 clients and a test table
<a href="#h30-3-24" id="h30-3-24" class="d">-pub async fn cluster_simple() -&gt; Result&lt;(Client, Client, Client, Box&lt;dyn FnOnce()&gt;), Error&gt; {
</a><a href="#h30-3-25" id="h30-3-25" class="d">-    let (mut clients, teardown) = cluster_with_clients(3).await?;
</a><a href="#h30-3-26" id="h30-3-26" class="i">+pub async fn cluster_simple() -&gt; Result&lt;(Client, Client, Client, Teardown), Error&gt; {
</a><a href="#h30-3-27" id="h30-3-27" class="i">+    let (mut clients, teardown) =
</a><a href="#h30-3-28" id="h30-3-28" class="i">+        cluster_with_data(3, vec![&quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;])
</a><a href="#h30-3-29" id="h30-3-29" class="i">+            .await?;
</a>     let a = clients.remove(0);
     let b = clients.remove(0);
     let c = clients.remove(0);
<a href="#h30-3-33" id="h30-3-33" class="d">-    assert!(clients.is_empty());
</a> 
<a href="#h30-3-35" id="h30-3-35" class="d">-    // FIXME Wait for cluster to stabilize, see: https://github.com/erikgrinaker/toydb/issues/19
</a><a href="#h30-3-36" id="h30-3-36" class="d">-    tokio::time::delay_for(std::time::Duration::from_millis(2000)).await;
</a><a href="#h30-3-37" id="h30-3-37" class="i">+    Ok((a, b, c, teardown))
</a><a href="#h30-3-38" id="h30-3-38" class="i">+}
</a> 
<a href="#h30-3-40" id="h30-3-40" class="d">-    a.execute(&quot;CREATE TABLE test (id INTEGER PRIMARY KEY, value STRING)&quot;).await?;
</a><a href="#h30-3-41" id="h30-3-41" class="i">+/// Tears down a test fixture when dropped.
</a><a href="#h30-3-42" id="h30-3-42" class="i">+pub struct Teardown {
</a><a href="#h30-3-43" id="h30-3-43" class="i">+    fns: Vec&lt;Box&lt;dyn FnOnce()&gt;&gt;,
</a><a href="#h30-3-44" id="h30-3-44" class="i">+}
</a> 
<a href="#h30-3-46" id="h30-3-46" class="d">-    Ok((a, b, c, teardown))
</a><a href="#h30-3-47" id="h30-3-47" class="i">+impl Teardown {
</a><a href="#h30-3-48" id="h30-3-48" class="i">+    fn new&lt;F: FnOnce() + &#39;static&gt;(f: F) -&gt; Self {
</a><a href="#h30-3-49" id="h30-3-49" class="i">+        let mut t = Self::empty();
</a><a href="#h30-3-50" id="h30-3-50" class="i">+        t.on_drop(f);
</a><a href="#h30-3-51" id="h30-3-51" class="i">+        t
</a><a href="#h30-3-52" id="h30-3-52" class="i">+    }
</a><a href="#h30-3-53" id="h30-3-53" class="i">+
</a><a href="#h30-3-54" id="h30-3-54" class="i">+    fn empty() -&gt; Self {
</a><a href="#h30-3-55" id="h30-3-55" class="i">+        Self { fns: Vec::new() }
</a><a href="#h30-3-56" id="h30-3-56" class="i">+    }
</a><a href="#h30-3-57" id="h30-3-57" class="i">+
</a><a href="#h30-3-58" id="h30-3-58" class="i">+    fn on_drop&lt;F: FnOnce() + &#39;static&gt;(&amp;mut self, f: F) {
</a><a href="#h30-3-59" id="h30-3-59" class="i">+        self.fns.push(Box::new(f))
</a><a href="#h30-3-60" id="h30-3-60" class="i">+    }
</a><a href="#h30-3-61" id="h30-3-61" class="i">+
</a><a href="#h30-3-62" id="h30-3-62" class="i">+    fn merge(&amp;mut self, mut other: Teardown) {
</a><a href="#h30-3-63" id="h30-3-63" class="i">+        while !other.fns.is_empty() {
</a><a href="#h30-3-64" id="h30-3-64" class="i">+            self.fns.push(other.fns.remove(0))
</a><a href="#h30-3-65" id="h30-3-65" class="i">+        }
</a><a href="#h30-3-66" id="h30-3-66" class="i">+    }
</a><a href="#h30-3-67" id="h30-3-67" class="i">+}
</a><a href="#h30-3-68" id="h30-3-68" class="i">+
</a><a href="#h30-3-69" id="h30-3-69" class="i">+impl Drop for Teardown {
</a><a href="#h30-3-70" id="h30-3-70" class="i">+    fn drop(&amp;mut self) {
</a><a href="#h30-3-71" id="h30-3-71" class="i">+        while !self.fns.is_empty() {
</a><a href="#h30-3-72" id="h30-3-72" class="i">+            self.fns.remove(0)()
</a><a href="#h30-3-73" id="h30-3-73" class="i">+        }
</a><a href="#h30-3-74" id="h30-3-74" class="i">+    }
</a> }
<b>diff --git a/<a id="h31" href="../file/tests/tests.rs.html">tests/tests.rs</a> b/<a href="../file/tests/tests.rs.html">tests/tests.rs</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -1,13 +1,26 @@
</a> #![warn(clippy::all)]
 
<a href="#h31-0-2" id="h31-0-2" class="d">-#[macro_use]
</a><a href="#h31-0-3" id="h31-0-3" class="d">-extern crate scopeguard;
</a><a href="#h31-0-4" id="h31-0-4" class="d">-extern crate serial_test;
</a><a href="#h31-0-5" id="h31-0-5" class="d">-extern crate tempdir;
</a><a href="#h31-0-6" id="h31-0-6" class="d">-extern crate toydb;
</a><a href="#h31-0-7" id="h31-0-7" class="d">-
</a> mod client;
 mod cluster;
 mod setup;
 mod sql;
<a href="#h31-0-12" id="h31-0-12" class="d">-mod util;
</a><a href="#h31-0-13" id="h31-0-13" class="i">+
</a><a href="#h31-0-14" id="h31-0-14" class="i">+use toydb::sql::execution::ResultSet;
</a><a href="#h31-0-15" id="h31-0-15" class="i">+use toydb::sql::types::{Relation, Row};
</a><a href="#h31-0-16" id="h31-0-16" class="i">+
</a><a href="#h31-0-17" id="h31-0-17" class="i">+use pretty_assertions::assert_eq;
</a><a href="#h31-0-18" id="h31-0-18" class="i">+
</a><a href="#h31-0-19" id="h31-0-19" class="i">+/// Asserts that a resultset contains the expected rows.
</a><a href="#h31-0-20" id="h31-0-20" class="i">+pub fn assert_rows(result: ResultSet, expect: Vec&lt;Row&gt;) {
</a><a href="#h31-0-21" id="h31-0-21" class="i">+    match result {
</a><a href="#h31-0-22" id="h31-0-22" class="i">+        ResultSet::Query { relation: Relation { rows: Some(rows), .. } } =&gt; {
</a><a href="#h31-0-23" id="h31-0-23" class="i">+            assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap(), expect)
</a><a href="#h31-0-24" id="h31-0-24" class="i">+        }
</a><a href="#h31-0-25" id="h31-0-25" class="i">+        r =&gt; panic!(&quot;Unexpected result {:?}&quot;, r),
</a><a href="#h31-0-26" id="h31-0-26" class="i">+    }
</a><a href="#h31-0-27" id="h31-0-27" class="i">+}
</a><a href="#h31-0-28" id="h31-0-28" class="i">+
</a><a href="#h31-0-29" id="h31-0-29" class="i">+/// Asserts that a resultset contains the single expected row.
</a><a href="#h31-0-30" id="h31-0-30" class="i">+pub fn assert_row(result: ResultSet, expect: Row) {
</a><a href="#h31-0-31" id="h31-0-31" class="i">+    assert_rows(result, vec![expect])
</a><a href="#h31-0-32" id="h31-0-32" class="i">+}
</a><b>diff --git a/<a id="h32" href="../file/tests/util.rs.html">tests/util.rs</a> b/<a href="../file/tests/util.rs.html">tests/util.rs</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -1,19 +0,0 @@
</a><a href="#h32-0-0" id="h32-0-0" class="d">-use toydb::sql::execution::ResultSet;
</a><a href="#h32-0-1" id="h32-0-1" class="d">-use toydb::sql::types::{Relation, Row};
</a><a href="#h32-0-2" id="h32-0-2" class="d">-
</a><a href="#h32-0-3" id="h32-0-3" class="d">-use pretty_assertions::assert_eq;
</a><a href="#h32-0-4" id="h32-0-4" class="d">-
</a><a href="#h32-0-5" id="h32-0-5" class="d">-/// Asserts that a resultset contains the expected rows.
</a><a href="#h32-0-6" id="h32-0-6" class="d">-pub fn assert_rows(result: ResultSet, expect: Vec&lt;Row&gt;) {
</a><a href="#h32-0-7" id="h32-0-7" class="d">-    match result {
</a><a href="#h32-0-8" id="h32-0-8" class="d">-        ResultSet::Query { relation: Relation { rows: Some(rows), .. } } =&gt; {
</a><a href="#h32-0-9" id="h32-0-9" class="d">-            assert_eq!(rows.collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;().unwrap(), expect)
</a><a href="#h32-0-10" id="h32-0-10" class="d">-        }
</a><a href="#h32-0-11" id="h32-0-11" class="d">-        r =&gt; panic!(&quot;Unexpected result {:?}&quot;, r),
</a><a href="#h32-0-12" id="h32-0-12" class="d">-    }
</a><a href="#h32-0-13" id="h32-0-13" class="d">-}
</a><a href="#h32-0-14" id="h32-0-14" class="d">-
</a><a href="#h32-0-15" id="h32-0-15" class="d">-/// Asserts that a resultset contains the single expected row.
</a><a href="#h32-0-16" id="h32-0-16" class="d">-pub fn assert_row(result: ResultSet, expect: Row) {
</a><a href="#h32-0-17" id="h32-0-17" class="d">-    assert_rows(result, vec![expect])
</a><a href="#h32-0-18" id="h32-0-18" class="d">-}
</a></pre>
</div>
</body>
</html>
