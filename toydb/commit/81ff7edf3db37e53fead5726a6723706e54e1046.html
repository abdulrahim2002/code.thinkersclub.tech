<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>raft: add log replay - toydb - An SQL engine written in Rust
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="toydb.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>toydb</h1><span class="desc">An SQL engine written in Rust
</span></td></tr><tr class="url"><td></td><td>git clone <a href="https://github.com/erikgrinaker/toydb">https://github.com/erikgrinaker/toydb</a></td></tr><tr><td></td><td>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/README.md.html">README</a> | <a href="../file/LICENSE.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/81ff7edf3db37e53fead5726a6723706e54e1046.html">81ff7edf3db37e53fead5726a6723706e54e1046</a>
<b>parent</b> <a href="../commit/5877485d54729d65f1ba4322401e7a894b694b66.html">5877485d54729d65f1ba4322401e7a894b694b66</a>
<b>Author:</b> Erik Grinaker &lt;<a href="mailto:erik@grinaker.org">erik@grinaker.org</a>&gt;
<b>Date:</b>   Tue,  5 May 2020 22:21:24 +0200

raft: add log replay

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">src/raft/node/mod.rs</a></td><td> | </td><td class="num">19</td><td><span class="i">+++++++++++++</span><span class="d">------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">src/raft/state.rs</a></td><td> | </td><td class="num">18</td><td><span class="i">++++++++++++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>2 files changed, 31 insertions(+), 6 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a> b/<a href="../file/src/raft/node/mod.rs.html">src/raft/node/mod.rs</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -47,7 +47,7 @@ impl&lt;L: Storage&gt; Node&lt;L&gt; {
</a>         id: &amp;str,
         peers: Vec&lt;String&gt;,
         log: Log&lt;L&gt;,
<a href="#h0-0-3" id="h0-0-3" class="d">-        state: S,
</a><a href="#h0-0-4" id="h0-0-4" class="i">+        mut state: S,
</a>         node_tx: mpsc::UnboundedSender&lt;Message&gt;,
     ) -&gt; Result&lt;Self, Error&gt; {
         let (state_tx, state_rx) = mpsc::unbounded_channel();
<a href="#h0-1" id="h0-1" class="h">@@ -59,12 +59,19 @@ impl&lt;L: Storage&gt; Node&lt;L&gt; {
</a>                 applied_index, committed_index
             )));
         }
<a href="#h0-1-3" id="h0-1-3" class="d">-        tokio::spawn(Driver::new(state_rx, node_tx.clone()).drive(state));
</a><a href="#h0-1-4" id="h0-1-4" class="d">-        for index in (applied_index+1)..=committed_index {
</a><a href="#h0-1-5" id="h0-1-5" class="d">-            if let Some(entry) = log.get(index)? {
</a><a href="#h0-1-6" id="h0-1-6" class="d">-                state_tx.send(Instruction::Apply { entry })?;
</a><a href="#h0-1-7" id="h0-1-7" class="i">+        let mut driver = Driver::new(state_rx, node_tx.clone());
</a><a href="#h0-1-8" id="h0-1-8" class="i">+        if committed_index &gt; applied_index {
</a><a href="#h0-1-9" id="h0-1-9" class="i">+            // FIXME Fix Log.range() and pass an iterator instead.
</a><a href="#h0-1-10" id="h0-1-10" class="i">+            let mut entries = Vec::new();
</a><a href="#h0-1-11" id="h0-1-11" class="i">+            for index in (applied_index + 1)..=committed_index {
</a><a href="#h0-1-12" id="h0-1-12" class="i">+                if let Some(entry) = log.get(index)? {
</a><a href="#h0-1-13" id="h0-1-13" class="i">+                    entries.push(entry);
</a><a href="#h0-1-14" id="h0-1-14" class="i">+                }
</a>             }
<a href="#h0-1-16" id="h0-1-16" class="d">-        }
</a><a href="#h0-1-17" id="h0-1-17" class="i">+            info!(&quot;Replaying log entries {} to {}&quot;, applied_index, committed_index);
</a><a href="#h0-1-18" id="h0-1-18" class="i">+            driver.replay(&amp;mut state, entries).await?;
</a><a href="#h0-1-19" id="h0-1-19" class="i">+        };
</a><a href="#h0-1-20" id="h0-1-20" class="i">+        tokio::spawn(driver.drive(state));
</a> 
         let (term, voted_for) = log.load_term()?;
         let node = RoleNode {
<b>diff --git a/<a id="h1" href="../file/src/raft/state.rs.html">src/raft/state.rs</a> b/<a href="../file/src/raft/state.rs.html">src/raft/state.rs</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -84,6 +84,24 @@ impl Driver {
</a>         Ok(())
     }
 
<a href="#h1-0-3" id="h1-0-3" class="i">+    /// Replays a set of log entries, for initial sync.
</a><a href="#h1-0-4" id="h1-0-4" class="i">+    /// FIXME Should take a log iterator when implemented.
</a><a href="#h1-0-5" id="h1-0-5" class="i">+    pub async fn replay&lt;S: State&gt;(
</a><a href="#h1-0-6" id="h1-0-6" class="i">+        &amp;mut self,
</a><a href="#h1-0-7" id="h1-0-7" class="i">+        state: &amp;mut S,
</a><a href="#h1-0-8" id="h1-0-8" class="i">+        entries: Vec&lt;Entry&gt;,
</a><a href="#h1-0-9" id="h1-0-9" class="i">+    ) -&gt; Result&lt;(), Error&gt; {
</a><a href="#h1-0-10" id="h1-0-10" class="i">+        for entry in entries.into_iter() {
</a><a href="#h1-0-11" id="h1-0-11" class="i">+            if let Some(command) = entry.command {
</a><a href="#h1-0-12" id="h1-0-12" class="i">+                match state.mutate(entry.index, command) {
</a><a href="#h1-0-13" id="h1-0-13" class="i">+                    Err(error @ Error::Internal(_)) =&gt; return Err(error),
</a><a href="#h1-0-14" id="h1-0-14" class="i">+                    _ =&gt; self.applied_index = entry.index,
</a><a href="#h1-0-15" id="h1-0-15" class="i">+                }
</a><a href="#h1-0-16" id="h1-0-16" class="i">+            }
</a><a href="#h1-0-17" id="h1-0-17" class="i">+        }
</a><a href="#h1-0-18" id="h1-0-18" class="i">+        Ok(())
</a><a href="#h1-0-19" id="h1-0-19" class="i">+    }
</a><a href="#h1-0-20" id="h1-0-20" class="i">+
</a>     /// Executes a state machine instruction.
     pub async fn execute&lt;S: State&gt;(&amp;mut self, i: Instruction, state: &amp;mut S) -&gt; Result&lt;(), Error&gt; {
         debug!(&quot;Executing {:?}&quot;, i);
</pre>
</div>
</body>
</html>
