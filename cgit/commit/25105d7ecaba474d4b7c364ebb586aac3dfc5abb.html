<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add caching infrastructure - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/25105d7ecaba474d4b7c364ebb586aac3dfc5abb.html">25105d7ecaba474d4b7c364ebb586aac3dfc5abb</a>
<b>parent</b> <a href="../commit/856c026e221d8ed82c5b75bc8da4bd65e89ea953.html">856c026e221d8ed82c5b75bc8da4bd65e89ea953</a>
<b>Author:</b> Lars Hjemli &lt;<a href="mailto:hjemli@gmail.com">hjemli@gmail.com</a>&gt;
<b>Date:</b>   Sun, 10 Dec 2006 22:31:36 +0100

Add caching infrastructure

This enables internal caching of page output.

Page requests are split into four groups:
  1) repo listing (front page)
  2) repo summary
  3) repo pages w/symbolic references in query string
  4) repo pages w/constant sha1&#39;s in query string

Each group has a TTL specified in minutes. When a page is requested, a cached
filename is stat(2)&#39;ed and st_mtime is compared to time(2). If TTL has expired
(or the file didn&#39;t exist), the cached file is regenerated.

When generating a cached file, locking is used to avoid parallell processing
of the request. If multiple processes tries to aquire the same lock, the ones
who fail to get the lock serves the (expired) cached file. If the cached file
don&#39;t exist, the process instead calls sched_yield(2) before restarting the
request processing.

Signed-off-by: Lars Hjemli &lt;hjemli@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.gitignore</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Makefile</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h2">README</a></td><td> | </td><td class="num">54</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">cache.c</a></td><td> | </td><td class="num">86</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">cgit.c</a></td><td> | </td><td class="num">117</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">cgit.h</a></td><td> | </td><td class="num">47</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">config.c</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">git.h</a></td><td> | </td><td class="num">60</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">html.c</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
</table></pre><pre>9 files changed, 353 insertions(+), 28 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.gitignore.html">.gitignore</a> b/<a href="../file/.gitignore.html">.gitignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -1,3 +1,4 @@
</a> # Files I don&#39;t care to see in git-status/commit
 cgit
 *.o
<a href="#h0-0-3" id="h0-0-3" class="i">+*~
</a><b>diff --git a/<a id="h1" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -3,7 +3,9 @@ INSTALL_BIN = /var/www/htdocs/cgit.cgi
</a> INSTALL_CSS = /var/www/htdocs/cgit.css
 
 EXTLIBS = ../git/libgit.a ../git/xdiff/lib.a -lz -lcrypto
<a href="#h1-0-3" id="h1-0-3" class="d">-OBJECTS = cgit.o config.o html.o
</a><a href="#h1-0-4" id="h1-0-4" class="i">+OBJECTS = cgit.o config.o html.o cache.o
</a><a href="#h1-0-5" id="h1-0-5" class="i">+
</a><a href="#h1-0-6" id="h1-0-6" class="i">+CFLAGS += -Wall
</a> 
 all: cgit
 
<a href="#h1-1" id="h1-1" class="h">@@ -15,6 +17,6 @@ clean:
</a> 	rm -f cgit *.o
 
 cgit: $(OBJECTS)
<a href="#h1-1-3" id="h1-1-3" class="d">-	$(CC) -o cgit $(OBJECTS) $(EXTLIBS)
</a><a href="#h1-1-4" id="h1-1-4" class="i">+	$(CC) $(CFLAGS) -o cgit $(OBJECTS) $(EXTLIBS)
</a> 
 $(OBJECTS): cgit.h git.h
<b>diff --git a/<a id="h2" href="../file/README.html">README</a> b/<a href="../file/README.html">README</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -0,0 +1,54 @@
</a><a href="#h2-0-0" id="h2-0-0" class="i">+Cache algorithm
</a><a href="#h2-0-1" id="h2-0-1" class="i">+===============
</a><a href="#h2-0-2" id="h2-0-2" class="i">+
</a><a href="#h2-0-3" id="h2-0-3" class="i">+Cgit normally returns cached pages when invoked. If there is no cache file, or
</a><a href="#h2-0-4" id="h2-0-4" class="i">+the cache file has expired, it is regenerated. Finally, the cache file is 
</a><a href="#h2-0-5" id="h2-0-5" class="i">+printed on stdout.
</a><a href="#h2-0-6" id="h2-0-6" class="i">+
</a><a href="#h2-0-7" id="h2-0-7" class="i">+When it is decided that a cache file needs to be regenerated, an attempt is 
</a><a href="#h2-0-8" id="h2-0-8" class="i">+made to create a corresponding lockfile. If this fails, the process gives up
</a><a href="#h2-0-9" id="h2-0-9" class="i">+and uses the expired cache file instead.
</a><a href="#h2-0-10" id="h2-0-10" class="i">+
</a><a href="#h2-0-11" id="h2-0-11" class="i">+When there is no cache file for a request, an attempt is made to create a 
</a><a href="#h2-0-12" id="h2-0-12" class="i">+corresponding lockfile. If this fails, the process calls sched_yield(2) before
</a><a href="#h2-0-13" id="h2-0-13" class="i">+restarting the request handling.
</a><a href="#h2-0-14" id="h2-0-14" class="i">+
</a><a href="#h2-0-15" id="h2-0-15" class="i">+In pseudocode:
</a><a href="#h2-0-16" id="h2-0-16" class="i">+
</a><a href="#h2-0-17" id="h2-0-17" class="i">+	name = generate_cache_name(request);
</a><a href="#h2-0-18" id="h2-0-18" class="i">+top:
</a><a href="#h2-0-19" id="h2-0-19" class="i">+	if (!exists(name)) {
</a><a href="#h2-0-20" id="h2-0-20" class="i">+		if (lock_cache(name)) {
</a><a href="#h2-0-21" id="h2-0-21" class="i">+			generate_cache(request, name);
</a><a href="#h2-0-22" id="h2-0-22" class="i">+			unlock_cache(name);
</a><a href="#h2-0-23" id="h2-0-23" class="i">+		} else {
</a><a href="#h2-0-24" id="h2-0-24" class="i">+			sched_yield();
</a><a href="#h2-0-25" id="h2-0-25" class="i">+			goto top;
</a><a href="#h2-0-26" id="h2-0-26" class="i">+		}
</a><a href="#h2-0-27" id="h2-0-27" class="i">+	} else if (expired(name)) {
</a><a href="#h2-0-28" id="h2-0-28" class="i">+		if (lock_cache(name)) {
</a><a href="#h2-0-29" id="h2-0-29" class="i">+			generate_cache(request, name);
</a><a href="#h2-0-30" id="h2-0-30" class="i">+			unlock_cache(name);
</a><a href="#h2-0-31" id="h2-0-31" class="i">+		}
</a><a href="#h2-0-32" id="h2-0-32" class="i">+	}
</a><a href="#h2-0-33" id="h2-0-33" class="i">+	print_file(name);
</a><a href="#h2-0-34" id="h2-0-34" class="i">+
</a><a href="#h2-0-35" id="h2-0-35" class="i">+
</a><a href="#h2-0-36" id="h2-0-36" class="i">+The following options can be set in /etc/cgitrc to control cache behaviour:
</a><a href="#h2-0-37" id="h2-0-37" class="i">+  cache-root:        root directory for cache files
</a><a href="#h2-0-38" id="h2-0-38" class="i">+  cache-root-ttl:    TTL for the repo listing page
</a><a href="#h2-0-39" id="h2-0-39" class="i">+  cache-repo-ttl:    TTL for any repos summary page
</a><a href="#h2-0-40" id="h2-0-40" class="i">+  cache-dynamic-ttl: TTL for pages with symbolic references (not SHA1)
</a><a href="#h2-0-41" id="h2-0-41" class="i">+  cache-static-ttl:  TTL for pages with sha1 references
</a><a href="#h2-0-42" id="h2-0-42" class="i">+
</a><a href="#h2-0-43" id="h2-0-43" class="i">+TTL is specified in minutes, -1 meaning &quot;infinite caching&quot;. 
</a><a href="#h2-0-44" id="h2-0-44" class="i">+
</a><a href="#h2-0-45" id="h2-0-45" class="i">+
</a><a href="#h2-0-46" id="h2-0-46" class="i">+Naming of cache files
</a><a href="#h2-0-47" id="h2-0-47" class="i">+---------------------
</a><a href="#h2-0-48" id="h2-0-48" class="i">+Repository listing:  &lt;cachedir&gt;/index.html
</a><a href="#h2-0-49" id="h2-0-49" class="i">+Repository summary:  &lt;cachedir&gt;/&lt;repo&gt;/index.html
</a><a href="#h2-0-50" id="h2-0-50" class="i">+Repository subpage:  &lt;cachedir&gt;/&lt;repo&gt;/&lt;page&gt;/&lt;querystring&gt;.html
</a><a href="#h2-0-51" id="h2-0-51" class="i">+
</a><a href="#h2-0-52" id="h2-0-52" class="i">+The corresponding lock files have a &quot;.lock&quot; suffix.
</a><a href="#h2-0-53" id="h2-0-53" class="i">+
</a><b>diff --git a/<a id="h3" href="../file/cache.c.html">cache.c</a> b/<a href="../file/cache.c.html">cache.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,86 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+#include &quot;cgit.h&quot;
</a><a href="#h3-0-1" id="h3-0-1" class="i">+
</a><a href="#h3-0-2" id="h3-0-2" class="i">+const int NOLOCK = -1;
</a><a href="#h3-0-3" id="h3-0-3" class="i">+
</a><a href="#h3-0-4" id="h3-0-4" class="i">+int cache_lookup(struct cacheitem *item)
</a><a href="#h3-0-5" id="h3-0-5" class="i">+{
</a><a href="#h3-0-6" id="h3-0-6" class="i">+	if (!cgit_query_repo) {
</a><a href="#h3-0-7" id="h3-0-7" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/index.html&quot;, cgit_cache_root));
</a><a href="#h3-0-8" id="h3-0-8" class="i">+		item-&gt;ttl = cgit_cache_root_ttl;
</a><a href="#h3-0-9" id="h3-0-9" class="i">+	} else if (!cgit_query_page) {
</a><a href="#h3-0-10" id="h3-0-10" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/%s/index.html&quot;, cgit_cache_root, 
</a><a href="#h3-0-11" id="h3-0-11" class="i">+			   cgit_query_repo));
</a><a href="#h3-0-12" id="h3-0-12" class="i">+		item-&gt;ttl = cgit_cache_repo_ttl;
</a><a href="#h3-0-13" id="h3-0-13" class="i">+	} else {
</a><a href="#h3-0-14" id="h3-0-14" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/%s/%s/%s.html&quot;, cgit_cache_root, 
</a><a href="#h3-0-15" id="h3-0-15" class="i">+			   cgit_query_repo, cgit_query_page, 
</a><a href="#h3-0-16" id="h3-0-16" class="i">+			   cgit_querystring));
</a><a href="#h3-0-17" id="h3-0-17" class="i">+		if (cgit_query_has_symref)
</a><a href="#h3-0-18" id="h3-0-18" class="i">+			item-&gt;ttl = cgit_cache_dynamic_ttl;
</a><a href="#h3-0-19" id="h3-0-19" class="i">+		else if (cgit_query_has_sha1)
</a><a href="#h3-0-20" id="h3-0-20" class="i">+			item-&gt;ttl = cgit_cache_static_ttl;
</a><a href="#h3-0-21" id="h3-0-21" class="i">+		else
</a><a href="#h3-0-22" id="h3-0-22" class="i">+			item-&gt;ttl = cgit_cache_repo_ttl;
</a><a href="#h3-0-23" id="h3-0-23" class="i">+	}
</a><a href="#h3-0-24" id="h3-0-24" class="i">+	if (stat(item-&gt;name, &amp;item-&gt;st)) {
</a><a href="#h3-0-25" id="h3-0-25" class="i">+		item-&gt;st.st_mtime = 0;
</a><a href="#h3-0-26" id="h3-0-26" class="i">+		return 0;
</a><a href="#h3-0-27" id="h3-0-27" class="i">+	}
</a><a href="#h3-0-28" id="h3-0-28" class="i">+	return 1;
</a><a href="#h3-0-29" id="h3-0-29" class="i">+}
</a><a href="#h3-0-30" id="h3-0-30" class="i">+
</a><a href="#h3-0-31" id="h3-0-31" class="i">+int cache_create_dirs()
</a><a href="#h3-0-32" id="h3-0-32" class="i">+{
</a><a href="#h3-0-33" id="h3-0-33" class="i">+	char *path;
</a><a href="#h3-0-34" id="h3-0-34" class="i">+
</a><a href="#h3-0-35" id="h3-0-35" class="i">+	if (!cgit_query_repo)
</a><a href="#h3-0-36" id="h3-0-36" class="i">+		return 0;
</a><a href="#h3-0-37" id="h3-0-37" class="i">+
</a><a href="#h3-0-38" id="h3-0-38" class="i">+	path = fmt(&quot;%s/%s&quot;, cgit_cache_root, cgit_query_repo);
</a><a href="#h3-0-39" id="h3-0-39" class="i">+	if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
</a><a href="#h3-0-40" id="h3-0-40" class="i">+		return 0;
</a><a href="#h3-0-41" id="h3-0-41" class="i">+
</a><a href="#h3-0-42" id="h3-0-42" class="i">+	if (cgit_query_page) {
</a><a href="#h3-0-43" id="h3-0-43" class="i">+		path = fmt(&quot;%s/%s/%s&quot;, cgit_cache_root, cgit_query_repo, 
</a><a href="#h3-0-44" id="h3-0-44" class="i">+			   cgit_query_page);
</a><a href="#h3-0-45" id="h3-0-45" class="i">+		if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
</a><a href="#h3-0-46" id="h3-0-46" class="i">+			return 0;
</a><a href="#h3-0-47" id="h3-0-47" class="i">+	}
</a><a href="#h3-0-48" id="h3-0-48" class="i">+	return 1;
</a><a href="#h3-0-49" id="h3-0-49" class="i">+}
</a><a href="#h3-0-50" id="h3-0-50" class="i">+
</a><a href="#h3-0-51" id="h3-0-51" class="i">+int cache_lock(struct cacheitem *item)
</a><a href="#h3-0-52" id="h3-0-52" class="i">+{
</a><a href="#h3-0-53" id="h3-0-53" class="i">+	int ret;
</a><a href="#h3-0-54" id="h3-0-54" class="i">+	char *lockfile = fmt(&quot;%s.lock&quot;, item-&gt;name);
</a><a href="#h3-0-55" id="h3-0-55" class="i">+
</a><a href="#h3-0-56" id="h3-0-56" class="i">+ top:  
</a><a href="#h3-0-57" id="h3-0-57" class="i">+       	item-&gt;fd = open(lockfile, O_WRONLY | O_CREAT | O_EXCL, S_IRUSR|S_IWUSR);
</a><a href="#h3-0-58" id="h3-0-58" class="i">+	if (item-&gt;fd == NOLOCK &amp;&amp; errno == ENOENT &amp;&amp; cache_create_dirs())
</a><a href="#h3-0-59" id="h3-0-59" class="i">+		goto top;
</a><a href="#h3-0-60" id="h3-0-60" class="i">+	if (item-&gt;fd == NOLOCK &amp;&amp; errno == EEXIST) {
</a><a href="#h3-0-61" id="h3-0-61" class="i">+		struct stat st;
</a><a href="#h3-0-62" id="h3-0-62" class="i">+		time_t t;
</a><a href="#h3-0-63" id="h3-0-63" class="i">+		if (stat(lockfile, &amp;st))
</a><a href="#h3-0-64" id="h3-0-64" class="i">+			return ret;
</a><a href="#h3-0-65" id="h3-0-65" class="i">+		t = time(NULL);
</a><a href="#h3-0-66" id="h3-0-66" class="i">+		if (t-st.st_mtime &gt; cgit_cache_max_create_time &amp;&amp; 
</a><a href="#h3-0-67" id="h3-0-67" class="i">+		    !unlink(lockfile))
</a><a href="#h3-0-68" id="h3-0-68" class="i">+			goto top;
</a><a href="#h3-0-69" id="h3-0-69" class="i">+		return 0;
</a><a href="#h3-0-70" id="h3-0-70" class="i">+	}
</a><a href="#h3-0-71" id="h3-0-71" class="i">+	return (item-&gt;fd &gt; 0);
</a><a href="#h3-0-72" id="h3-0-72" class="i">+}
</a><a href="#h3-0-73" id="h3-0-73" class="i">+
</a><a href="#h3-0-74" id="h3-0-74" class="i">+int cache_unlock(struct cacheitem *item)
</a><a href="#h3-0-75" id="h3-0-75" class="i">+{
</a><a href="#h3-0-76" id="h3-0-76" class="i">+	close(item-&gt;fd);
</a><a href="#h3-0-77" id="h3-0-77" class="i">+	return (rename(fmt(&quot;%s.lock&quot;, item-&gt;name), item-&gt;name) == 0);
</a><a href="#h3-0-78" id="h3-0-78" class="i">+}
</a><a href="#h3-0-79" id="h3-0-79" class="i">+
</a><a href="#h3-0-80" id="h3-0-80" class="i">+int cache_expired(struct cacheitem *item)
</a><a href="#h3-0-81" id="h3-0-81" class="i">+{
</a><a href="#h3-0-82" id="h3-0-82" class="i">+	if (item-&gt;ttl &lt; 0)
</a><a href="#h3-0-83" id="h3-0-83" class="i">+		return 0;
</a><a href="#h3-0-84" id="h3-0-84" class="i">+	return item-&gt;st.st_mtime + item-&gt;ttl * 60 &lt; time(NULL);
</a><a href="#h3-0-85" id="h3-0-85" class="i">+}
</a><b>diff --git a/<a id="h4" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -10,29 +10,47 @@ static const char cgit_error[] =
</a> static const char cgit_lib_error[] =
 &quot;&lt;div class=&#39;error&#39;&gt;%s: %s&lt;/div&gt;&quot;;
 
<a href="#h4-0-3" id="h4-0-3" class="i">+int htmlfd = 0;
</a> 
<a href="#h4-0-5" id="h4-0-5" class="d">-char *cgit_root         = &quot;/var/git&quot;;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+char *cgit_root         = &quot;/usr/src/git&quot;;
</a> char *cgit_root_title   = &quot;Git repository browser&quot;;
 char *cgit_css          = &quot;/cgit.css&quot;;
 char *cgit_logo         = &quot;/git-logo.png&quot;;
 char *cgit_logo_link    = &quot;http://www.kernel.org/pub/software/scm/git/docs/&quot;;
 char *cgit_virtual_root = NULL;
 
<a href="#h4-0-13" id="h4-0-13" class="i">+char *cgit_cache_root   = &quot;/var/cache/cgit&quot;;
</a><a href="#h4-0-14" id="h4-0-14" class="i">+
</a><a href="#h4-0-15" id="h4-0-15" class="i">+int cgit_cache_root_ttl        =  5;
</a><a href="#h4-0-16" id="h4-0-16" class="i">+int cgit_cache_repo_ttl        =  5;
</a><a href="#h4-0-17" id="h4-0-17" class="i">+int cgit_cache_dynamic_ttl     =  5;
</a><a href="#h4-0-18" id="h4-0-18" class="i">+int cgit_cache_static_ttl      = -1;
</a><a href="#h4-0-19" id="h4-0-19" class="i">+int cgit_cache_max_create_time =  5;
</a><a href="#h4-0-20" id="h4-0-20" class="i">+
</a> char *cgit_repo_name    = NULL;
 char *cgit_repo_desc    = NULL;
 char *cgit_repo_owner   = NULL;
 
<a href="#h4-0-25" id="h4-0-25" class="i">+int cgit_query_has_symref = 0;
</a><a href="#h4-0-26" id="h4-0-26" class="i">+int cgit_query_has_sha1   = 0;
</a><a href="#h4-0-27" id="h4-0-27" class="i">+
</a><a href="#h4-0-28" id="h4-0-28" class="i">+char *cgit_querystring  = NULL;
</a> char *cgit_query_repo   = NULL;
 char *cgit_query_page   = NULL;
 char *cgit_query_head   = NULL;
<a href="#h4-0-32" id="h4-0-32" class="i">+char *cgit_query_sha1   = NULL;
</a><a href="#h4-0-33" id="h4-0-33" class="i">+
</a><a href="#h4-0-34" id="h4-0-34" class="i">+struct cacheitem cacheitem;
</a> 
 int cgit_parse_query(char *txt, configfn fn)
 {
<a href="#h4-0-38" id="h4-0-38" class="d">-	char *t = txt, *value = NULL, c;
</a><a href="#h4-0-39" id="h4-0-39" class="i">+	char *t, *value = NULL, c;
</a> 
 	if (!txt)
 		return 0;
 
<a href="#h4-0-44" id="h4-0-44" class="i">+	t = txt = xstrdup(txt);
</a><a href="#h4-0-45" id="h4-0-45" class="i">+ 
</a> 	while((c=*t) != &#39;\0&#39;) {
 		if (c==&#39;=&#39;) {
 			*t = &#39;\0&#39;;
<a href="#h4-1" id="h4-1" class="h">@@ -82,8 +100,13 @@ void cgit_querystring_cb(const char *name, const char *value)
</a> 		cgit_query_repo = xstrdup(value);
 	else if (!strcmp(name, &quot;p&quot;))
 		cgit_query_page = xstrdup(value);
<a href="#h4-1-3" id="h4-1-3" class="d">-	else if (!strcmp(name, &quot;h&quot;))
</a><a href="#h4-1-4" id="h4-1-4" class="i">+	else if (!strcmp(name, &quot;h&quot;)) {
</a> 		cgit_query_head = xstrdup(value);
<a href="#h4-1-6" id="h4-1-6" class="i">+		cgit_query_has_symref = 1;
</a><a href="#h4-1-7" id="h4-1-7" class="i">+	} else if (!strcmp(name, &quot;id&quot;)) {
</a><a href="#h4-1-8" id="h4-1-8" class="i">+		cgit_query_sha1 = xstrdup(value);
</a><a href="#h4-1-9" id="h4-1-9" class="i">+		cgit_query_has_sha1 = 1;
</a><a href="#h4-1-10" id="h4-1-10" class="i">+	}
</a> }
 
 char *cgit_repourl(const char *reponame)
<a href="#h4-2" id="h4-2" class="h">@@ -136,9 +159,32 @@ static int cgit_print_branch_cb(const char *refname, const unsigned char *sha1,
</a> 	return 0;
 }
 
<a href="#h4-2-3" id="h4-2-3" class="i">+/* Sun, 06 Nov 1994 08:49:37 GMT */
</a><a href="#h4-2-4" id="h4-2-4" class="i">+static char *http_date(time_t t)
</a><a href="#h4-2-5" id="h4-2-5" class="i">+{
</a><a href="#h4-2-6" id="h4-2-6" class="i">+	static char day[][4] = {&quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;};
</a><a href="#h4-2-7" id="h4-2-7" class="i">+	static char month[][4] = {&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,
</a><a href="#h4-2-8" id="h4-2-8" class="i">+				  &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Now&quot;, &quot;Dec&quot;};
</a><a href="#h4-2-9" id="h4-2-9" class="i">+	struct tm *tm = gmtime(&amp;t);
</a><a href="#h4-2-10" id="h4-2-10" class="i">+	return fmt(&quot;%s, %02d %s %04d %02d:%02d:%02d GMT&quot;, day[tm-&gt;tm_wday],
</a><a href="#h4-2-11" id="h4-2-11" class="i">+		   tm-&gt;tm_mday, month[tm-&gt;tm_mon], 1900+tm-&gt;tm_year,
</a><a href="#h4-2-12" id="h4-2-12" class="i">+		   tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec);
</a><a href="#h4-2-13" id="h4-2-13" class="i">+}
</a><a href="#h4-2-14" id="h4-2-14" class="i">+
</a><a href="#h4-2-15" id="h4-2-15" class="i">+static int ttl_seconds(int ttl)
</a><a href="#h4-2-16" id="h4-2-16" class="i">+{
</a><a href="#h4-2-17" id="h4-2-17" class="i">+	if (ttl&lt;0)
</a><a href="#h4-2-18" id="h4-2-18" class="i">+		return 60 * 60 * 24 * 365;
</a><a href="#h4-2-19" id="h4-2-19" class="i">+	else 
</a><a href="#h4-2-20" id="h4-2-20" class="i">+		return ttl * 60;
</a><a href="#h4-2-21" id="h4-2-21" class="i">+}
</a><a href="#h4-2-22" id="h4-2-22" class="i">+
</a> static void cgit_print_docstart(char *title)
 {
 	html(&quot;Content-Type: text/html; charset=utf-8\n&quot;);
<a href="#h4-2-26" id="h4-2-26" class="i">+	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(cacheitem.st.st_mtime));
</a><a href="#h4-2-27" id="h4-2-27" class="i">+	htmlf(&quot;Expires: %s\n&quot;, http_date(cacheitem.st.st_mtime + 
</a><a href="#h4-2-28" id="h4-2-28" class="i">+					 ttl_seconds(cacheitem.ttl)));
</a> 	html(&quot;\n&quot;);
 	html(cgit_doctype);
 	html(&quot;&lt;html&gt;\n&quot;);
<a href="#h4-3" id="h4-3" class="h">@@ -175,6 +221,7 @@ static void cgit_print_repolist()
</a> 	struct stat st;
 	char *name;
 
<a href="#h4-3-3" id="h4-3-3" class="i">+	chdir(cgit_root);
</a> 	cgit_print_docstart(cgit_root_title);
 	cgit_print_pageheader(cgit_root_title);
 
<a href="#h4-4" id="h4-4" class="h">@@ -197,7 +244,7 @@ static void cgit_print_repolist()
</a> 			continue;
 
 		cgit_repo_name = cgit_repo_desc = cgit_repo_owner = NULL;
<a href="#h4-4-3" id="h4-4-3" class="d">-		name = fmt(&quot;%s/.git/info/cgit&quot;, de-&gt;d_name);
</a><a href="#h4-4-4" id="h4-4-4" class="i">+		name = fmt(&quot;%s/info/cgit&quot;, de-&gt;d_name);
</a> 		if (cgit_read_config(name, cgit_repo_config_cb))
 			continue;
 
<a href="#h4-5" id="h4-5" class="h">@@ -291,7 +338,7 @@ static void cgit_print_commit_shortlog(struct commit *commit)
</a> 	strftime(buf, sizeof(buf), &quot;%Y-%m-%d %H:%M:%S&quot;, time);
 	html_txt(buf);
 	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h4-5-3" id="h4-5-3" class="d">-	char *qry = fmt(&quot;h=%s&quot;, sha1_to_hex(commit-&gt;object.sha1));
</a><a href="#h4-5-4" id="h4-5-4" class="i">+	char *qry = fmt(&quot;id=%s&quot;, sha1_to_hex(commit-&gt;object.sha1));
</a> 	char *url = cgit_pageurl(cgit_query_repo, &quot;view&quot;, qry);
 	html_link_open(url, NULL, NULL);
 	html_txt(subject);
<a href="#h4-6" id="h4-6" class="h">@@ -371,8 +418,8 @@ static void cgit_print_object(char *hex)
</a> 
 static void cgit_print_repo_page()
 {
<a href="#h4-6-3" id="h4-6-3" class="d">-	if (chdir(cgit_query_repo) || 
</a><a href="#h4-6-4" id="h4-6-4" class="d">-	    cgit_read_config(&quot;.git/info/cgit&quot;, cgit_repo_config_cb)) {
</a><a href="#h4-6-5" id="h4-6-5" class="i">+	if (chdir(fmt(&quot;%s/%s&quot;, cgit_root, cgit_query_repo)) || 
</a><a href="#h4-6-6" id="h4-6-6" class="i">+	    cgit_read_config(&quot;info/cgit&quot;, cgit_repo_config_cb)) {
</a> 		char *title = fmt(&quot;%s - %s&quot;, cgit_root_title, &quot;Bad request&quot;);
 		cgit_print_docstart(title);
 		cgit_print_pageheader(title);
<a href="#h4-7" id="h4-7" class="h">@@ -381,7 +428,7 @@ static void cgit_print_repo_page()
</a> 		cgit_print_docend();
 		return;
 	}
<a href="#h4-7-3" id="h4-7-3" class="d">-	
</a><a href="#h4-7-4" id="h4-7-4" class="i">+	setenv(&quot;GIT_DIR&quot;, fmt(&quot;%s/%s&quot;, cgit_root, cgit_query_repo), 1);
</a> 	char *title = fmt(&quot;%s - %s&quot;, cgit_repo_name, cgit_repo_desc);
 	cgit_print_docstart(title);
 	cgit_print_pageheader(title);
<a href="#h4-8" id="h4-8" class="h">@@ -390,21 +437,61 @@ static void cgit_print_repo_page()
</a> 	else if (!strcmp(cgit_query_page, &quot;log&quot;)) {
 		cgit_print_log(cgit_query_head, 0, 100);
 	} else if (!strcmp(cgit_query_page, &quot;view&quot;)) {
<a href="#h4-8-3" id="h4-8-3" class="d">-		cgit_print_object(cgit_query_head);
</a><a href="#h4-8-4" id="h4-8-4" class="i">+		cgit_print_object(cgit_query_sha1);
</a> 	}
 	cgit_print_docend();
 }
 
<a href="#h4-8-9" id="h4-8-9" class="d">-int main(int argc, const char **argv)
</a><a href="#h4-8-10" id="h4-8-10" class="i">+static void cgit_fill_cache(struct cacheitem *item)
</a> {
<a href="#h4-8-12" id="h4-8-12" class="d">-	if (cgit_read_config(&quot;/etc/cgitrc&quot;, cgit_global_config_cb))
</a><a href="#h4-8-13" id="h4-8-13" class="d">-		die(&quot;Error reading config: %d %s&quot;, errno, strerror(errno));
</a><a href="#h4-8-14" id="h4-8-14" class="d">-
</a><a href="#h4-8-15" id="h4-8-15" class="d">-	chdir(cgit_root);
</a><a href="#h4-8-16" id="h4-8-16" class="d">-	cgit_parse_query(getenv(&quot;QUERY_STRING&quot;), cgit_querystring_cb);
</a><a href="#h4-8-17" id="h4-8-17" class="i">+	htmlfd = item-&gt;fd;
</a><a href="#h4-8-18" id="h4-8-18" class="i">+	item-&gt;st.st_mtime = time(NULL);
</a> 	if (cgit_query_repo)
 		cgit_print_repo_page();
 	else
 		cgit_print_repolist();
<a href="#h4-8-23" id="h4-8-23" class="i">+}
</a><a href="#h4-8-24" id="h4-8-24" class="i">+
</a><a href="#h4-8-25" id="h4-8-25" class="i">+static void cgit_refresh_cache(struct cacheitem *item)
</a><a href="#h4-8-26" id="h4-8-26" class="i">+{
</a><a href="#h4-8-27" id="h4-8-27" class="i">+ top:
</a><a href="#h4-8-28" id="h4-8-28" class="i">+	if (!cache_lookup(item)) {
</a><a href="#h4-8-29" id="h4-8-29" class="i">+		if (cache_lock(item)) {
</a><a href="#h4-8-30" id="h4-8-30" class="i">+			cgit_fill_cache(item);
</a><a href="#h4-8-31" id="h4-8-31" class="i">+			cache_unlock(item);
</a><a href="#h4-8-32" id="h4-8-32" class="i">+		} else {
</a><a href="#h4-8-33" id="h4-8-33" class="i">+			sched_yield();
</a><a href="#h4-8-34" id="h4-8-34" class="i">+			goto top;
</a><a href="#h4-8-35" id="h4-8-35" class="i">+		}
</a><a href="#h4-8-36" id="h4-8-36" class="i">+	} else if (cache_expired(item)) {
</a><a href="#h4-8-37" id="h4-8-37" class="i">+		if (cache_lock(item)) {
</a><a href="#h4-8-38" id="h4-8-38" class="i">+			cgit_fill_cache(item);
</a><a href="#h4-8-39" id="h4-8-39" class="i">+			cache_unlock(item);
</a><a href="#h4-8-40" id="h4-8-40" class="i">+		}
</a><a href="#h4-8-41" id="h4-8-41" class="i">+	}
</a><a href="#h4-8-42" id="h4-8-42" class="i">+}
</a><a href="#h4-8-43" id="h4-8-43" class="i">+
</a><a href="#h4-8-44" id="h4-8-44" class="i">+static void cgit_print_cache(struct cacheitem *item)
</a><a href="#h4-8-45" id="h4-8-45" class="i">+{
</a><a href="#h4-8-46" id="h4-8-46" class="i">+	static char buf[4096];
</a><a href="#h4-8-47" id="h4-8-47" class="i">+	ssize_t i;
</a><a href="#h4-8-48" id="h4-8-48" class="i">+
</a><a href="#h4-8-49" id="h4-8-49" class="i">+	int fd = open(item-&gt;name, O_RDONLY);
</a><a href="#h4-8-50" id="h4-8-50" class="i">+	if (fd&lt;0)
</a><a href="#h4-8-51" id="h4-8-51" class="i">+		die(&quot;Unable to open cached file %s&quot;, item-&gt;name);
</a><a href="#h4-8-52" id="h4-8-52" class="i">+
</a><a href="#h4-8-53" id="h4-8-53" class="i">+	while((i=read(fd, buf, sizeof(buf))) &gt; 0)
</a><a href="#h4-8-54" id="h4-8-54" class="i">+		write(STDOUT_FILENO, buf, i);
</a><a href="#h4-8-55" id="h4-8-55" class="i">+
</a><a href="#h4-8-56" id="h4-8-56" class="i">+	close(fd);
</a><a href="#h4-8-57" id="h4-8-57" class="i">+}
</a><a href="#h4-8-58" id="h4-8-58" class="i">+
</a><a href="#h4-8-59" id="h4-8-59" class="i">+int main(int argc, const char **argv)
</a><a href="#h4-8-60" id="h4-8-60" class="i">+{
</a><a href="#h4-8-61" id="h4-8-61" class="i">+	cgit_read_config(&quot;/etc/cgitrc&quot;, cgit_global_config_cb);
</a><a href="#h4-8-62" id="h4-8-62" class="i">+	cgit_querystring = xstrdup(getenv(&quot;QUERY_STRING&quot;));
</a><a href="#h4-8-63" id="h4-8-63" class="i">+	cgit_parse_query(cgit_querystring, cgit_querystring_cb);
</a><a href="#h4-8-64" id="h4-8-64" class="i">+	cgit_refresh_cache(&amp;cacheitem);
</a><a href="#h4-8-65" id="h4-8-65" class="i">+	cgit_print_cache(&amp;cacheitem);
</a> 	return 0;
 }
<b>diff --git a/<a id="h5" href="../file/cgit.h.html">cgit.h</a> b/<a href="../file/cgit.h.html">cgit.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -3,6 +3,46 @@
</a> 
 #include &quot;git.h&quot;
 #include &lt;openssl/sha.h&gt;
<a href="#h5-0-3" id="h5-0-3" class="i">+#include &lt;ctype.h&gt;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+#include &lt;sched.h&gt;
</a><a href="#h5-0-5" id="h5-0-5" class="i">+
</a><a href="#h5-0-6" id="h5-0-6" class="i">+typedef void (*configfn)(const char *name, const char *value);
</a><a href="#h5-0-7" id="h5-0-7" class="i">+
</a><a href="#h5-0-8" id="h5-0-8" class="i">+struct cacheitem {
</a><a href="#h5-0-9" id="h5-0-9" class="i">+	char *name;
</a><a href="#h5-0-10" id="h5-0-10" class="i">+	struct stat st;
</a><a href="#h5-0-11" id="h5-0-11" class="i">+	int ttl;
</a><a href="#h5-0-12" id="h5-0-12" class="i">+	int fd;
</a><a href="#h5-0-13" id="h5-0-13" class="i">+};
</a><a href="#h5-0-14" id="h5-0-14" class="i">+
</a><a href="#h5-0-15" id="h5-0-15" class="i">+extern char *cgit_root;
</a><a href="#h5-0-16" id="h5-0-16" class="i">+extern char *cgit_root_title;
</a><a href="#h5-0-17" id="h5-0-17" class="i">+extern char *cgit_css;
</a><a href="#h5-0-18" id="h5-0-18" class="i">+extern char *cgit_logo;
</a><a href="#h5-0-19" id="h5-0-19" class="i">+extern char *cgit_logo_link;
</a><a href="#h5-0-20" id="h5-0-20" class="i">+extern char *cgit_virtual_root;
</a><a href="#h5-0-21" id="h5-0-21" class="i">+extern char *cgit_cache_root;
</a><a href="#h5-0-22" id="h5-0-22" class="i">+
</a><a href="#h5-0-23" id="h5-0-23" class="i">+extern int cgit_cache_root_ttl;
</a><a href="#h5-0-24" id="h5-0-24" class="i">+extern int cgit_cache_repo_ttl;
</a><a href="#h5-0-25" id="h5-0-25" class="i">+extern int cgit_cache_dynamic_ttl;
</a><a href="#h5-0-26" id="h5-0-26" class="i">+extern int cgit_cache_static_ttl;
</a><a href="#h5-0-27" id="h5-0-27" class="i">+extern int cgit_cache_max_create_time;
</a><a href="#h5-0-28" id="h5-0-28" class="i">+
</a><a href="#h5-0-29" id="h5-0-29" class="i">+extern char *cgit_repo_name;
</a><a href="#h5-0-30" id="h5-0-30" class="i">+extern char *cgit_repo_desc;
</a><a href="#h5-0-31" id="h5-0-31" class="i">+extern char *cgit_repo_owner;
</a><a href="#h5-0-32" id="h5-0-32" class="i">+
</a><a href="#h5-0-33" id="h5-0-33" class="i">+extern int cgit_query_has_symref;
</a><a href="#h5-0-34" id="h5-0-34" class="i">+extern int cgit_query_has_sha1;
</a><a href="#h5-0-35" id="h5-0-35" class="i">+
</a><a href="#h5-0-36" id="h5-0-36" class="i">+extern char *cgit_querystring;
</a><a href="#h5-0-37" id="h5-0-37" class="i">+extern char *cgit_query_repo;
</a><a href="#h5-0-38" id="h5-0-38" class="i">+extern char *cgit_query_page;
</a><a href="#h5-0-39" id="h5-0-39" class="i">+extern char *cgit_query_head;
</a><a href="#h5-0-40" id="h5-0-40" class="i">+extern char *cgit_query_sha1;
</a><a href="#h5-0-41" id="h5-0-41" class="i">+
</a><a href="#h5-0-42" id="h5-0-42" class="i">+extern int htmlfd;
</a> 
 extern char *fmt(const char *format,...);
 
<a href="#h5-1" id="h5-1" class="h">@@ -10,12 +50,15 @@ extern void html(const char *txt);
</a> extern void htmlf(const char *format,...);
 extern void html_txt(char *txt);
 extern void html_attr(char *txt);
<a href="#h5-1-3" id="h5-1-3" class="d">-
</a> extern void html_link_open(char *url, char *title, char *class);
 extern void html_link_close(void);
 
<a href="#h5-1-7" id="h5-1-7" class="d">-typedef void (*configfn)(const char *name, const char *value);
</a> 
 extern int cgit_read_config(const char *filename, configfn fn);
 
<a href="#h5-1-11" id="h5-1-11" class="i">+extern int cache_lookup(struct cacheitem *item);
</a><a href="#h5-1-12" id="h5-1-12" class="i">+extern int cache_lock(struct cacheitem *item);
</a><a href="#h5-1-13" id="h5-1-13" class="i">+extern int cache_unlock(struct cacheitem *item);
</a><a href="#h5-1-14" id="h5-1-14" class="i">+extern int cache_expired(struct cacheitem *item);
</a><a href="#h5-1-15" id="h5-1-15" class="i">+
</a> #endif /* CGIT_H */
<b>diff --git a/<a id="h6" href="../file/config.c.html">config.c</a> b/<a href="../file/config.c.html">config.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -32,7 +32,7 @@ int read_config_line(FILE *f, char *line, const char **value, int bufsize)
</a> 			skip_line(f);
 			continue;
 		}
<a href="#h6-0-3" id="h6-0-3" class="d">-		if (!isname &amp;&amp; isblank(c))
</a><a href="#h6-0-4" id="h6-0-4" class="i">+		if (!isname &amp;&amp; isspace(c))
</a> 			continue;
 
 		if (c==&#39;=&#39; &amp;&amp; !*value) {
<a href="#h6-1" id="h6-1" class="h">@@ -64,7 +64,7 @@ int cgit_read_config(const char *filename, configfn fn)
</a> 	if (!f)
 		return -1;
 
<a href="#h6-1-3" id="h6-1-3" class="d">-	while(len = read_config_line(f, line, &amp;value, sizeof(line)))
</a><a href="#h6-1-4" id="h6-1-4" class="i">+	while((len = read_config_line(f, line, &amp;value, sizeof(line))) &gt; 0)
</a> 		(*fn)(line, value);
 
 	fclose(f);
<b>diff --git a/<a id="h7" href="../file/git.h.html">git.h</a> b/<a href="../file/git.h.html">git.h</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -33,6 +33,26 @@
</a> #include &lt;time.h&gt;
 
 
<a href="#h7-0-3" id="h7-0-3" class="i">+/* On most systems &lt;limits.h&gt; would have given us this, but
</a><a href="#h7-0-4" id="h7-0-4" class="i">+ * not on some systems (e.g. GNU/Hurd).
</a><a href="#h7-0-5" id="h7-0-5" class="i">+ */
</a><a href="#h7-0-6" id="h7-0-6" class="i">+#ifndef PATH_MAX
</a><a href="#h7-0-7" id="h7-0-7" class="i">+#define PATH_MAX 4096
</a><a href="#h7-0-8" id="h7-0-8" class="i">+#endif
</a><a href="#h7-0-9" id="h7-0-9" class="i">+
</a><a href="#h7-0-10" id="h7-0-10" class="i">+#ifdef __GNUC__
</a><a href="#h7-0-11" id="h7-0-11" class="i">+#define NORETURN __attribute__((__noreturn__))
</a><a href="#h7-0-12" id="h7-0-12" class="i">+#else
</a><a href="#h7-0-13" id="h7-0-13" class="i">+#define NORETURN
</a><a href="#h7-0-14" id="h7-0-14" class="i">+#ifndef __attribute__
</a><a href="#h7-0-15" id="h7-0-15" class="i">+#define __attribute__(x)
</a><a href="#h7-0-16" id="h7-0-16" class="i">+#endif
</a><a href="#h7-0-17" id="h7-0-17" class="i">+#endif
</a><a href="#h7-0-18" id="h7-0-18" class="i">+
</a><a href="#h7-0-19" id="h7-0-19" class="i">+
</a><a href="#h7-0-20" id="h7-0-20" class="i">+extern void die(const char *err, ...) NORETURN __attribute__((format (printf, 1, 2)));
</a><a href="#h7-0-21" id="h7-0-21" class="i">+
</a><a href="#h7-0-22" id="h7-0-22" class="i">+
</a> static inline char* xstrdup(const char *str)
 {
 	char *ret = strdup(str);
<a href="#h7-1" id="h7-1" class="h">@@ -108,9 +128,13 @@ static inline ssize_t xwrite(int fd, const void *buf, size_t len)
</a> #define MINIMUM_ABBREV 4
 #define DEFAULT_ABBREV 7
 
<a href="#h7-1-3" id="h7-1-3" class="i">+extern int sha1_object_info(const unsigned char *, char *, unsigned long *);
</a> 
 extern void * read_sha1_file(const unsigned char *sha1, char *type, unsigned long *size);
 
<a href="#h7-1-7" id="h7-1-7" class="i">+extern int get_sha1(const char *str, unsigned char *sha1);
</a><a href="#h7-1-8" id="h7-1-8" class="i">+extern int get_sha1_hex(const char *hex, unsigned char *sha1);
</a><a href="#h7-1-9" id="h7-1-9" class="i">+extern char *sha1_to_hex(const unsigned char *sha1);	/* static buffer result! */
</a> 
 
 
<a href="#h7-2" id="h7-2" class="h">@@ -183,6 +207,21 @@ struct commit {
</a> };
 
 
<a href="#h7-2-3" id="h7-2-3" class="i">+struct commit *lookup_commit(const unsigned char *sha1);
</a><a href="#h7-2-4" id="h7-2-4" class="i">+struct commit *lookup_commit_reference(const unsigned char *sha1);
</a><a href="#h7-2-5" id="h7-2-5" class="i">+struct commit *lookup_commit_reference_gently(const unsigned char *sha1,
</a><a href="#h7-2-6" id="h7-2-6" class="i">+					      int quiet);
</a><a href="#h7-2-7" id="h7-2-7" class="i">+
</a><a href="#h7-2-8" id="h7-2-8" class="i">+int parse_commit_buffer(struct commit *item, void *buffer, unsigned long size);
</a><a href="#h7-2-9" id="h7-2-9" class="i">+int parse_commit(struct commit *item);
</a><a href="#h7-2-10" id="h7-2-10" class="i">+
</a><a href="#h7-2-11" id="h7-2-11" class="i">+struct commit_list * commit_list_insert(struct commit *item, struct commit_list **list_p);
</a><a href="#h7-2-12" id="h7-2-12" class="i">+struct commit_list * insert_by_date(struct commit *item, struct commit_list **list);
</a><a href="#h7-2-13" id="h7-2-13" class="i">+
</a><a href="#h7-2-14" id="h7-2-14" class="i">+void free_commit_list(struct commit_list *list);
</a><a href="#h7-2-15" id="h7-2-15" class="i">+
</a><a href="#h7-2-16" id="h7-2-16" class="i">+void sort_by_date(struct commit_list **list);
</a><a href="#h7-2-17" id="h7-2-17" class="i">+
</a> /* Commit formats */
 enum cmit_fmt {
 	CMIT_FMT_RAW,
<a href="#h7-3" id="h7-3" class="h">@@ -197,13 +236,9 @@ enum cmit_fmt {
</a> 	CMIT_FMT_UNSPECIFIED,
 };
 
<a href="#h7-3-3" id="h7-3-3" class="i">+extern unsigned long pretty_print_commit(enum cmit_fmt fmt, const struct commit *, unsigned long len, char *buf, unsigned long space, int abbrev, const char *subject, const char *after_subject, int relative_date);
</a> 
 
<a href="#h7-3-6" id="h7-3-6" class="d">-struct commit *lookup_commit(const unsigned char *sha1);
</a><a href="#h7-3-7" id="h7-3-7" class="d">-struct commit *lookup_commit_reference(const unsigned char *sha1);
</a><a href="#h7-3-8" id="h7-3-8" class="d">-struct commit *lookup_commit_reference_gently(const unsigned char *sha1,
</a><a href="#h7-3-9" id="h7-3-9" class="d">-					      int quiet);
</a><a href="#h7-3-10" id="h7-3-10" class="d">-
</a> typedef void (*topo_sort_set_fn_t)(struct commit*, void *data);
 typedef void* (*topo_sort_get_fn_t)(struct commit*);
 
<a href="#h7-4" id="h7-4" class="h">@@ -306,6 +341,16 @@ enum color_diff {
</a> 
 
 
<a href="#h7-4-3" id="h7-4-3" class="i">+/*
</a><a href="#h7-4-4" id="h7-4-4" class="i">+ * from git:refs.g
</a><a href="#h7-4-5" id="h7-4-5" class="i">+ */
</a><a href="#h7-4-6" id="h7-4-6" class="i">+
</a><a href="#h7-4-7" id="h7-4-7" class="i">+typedef int each_ref_fn(const char *refname, const unsigned char *sha1, int flags, void *cb_data);
</a><a href="#h7-4-8" id="h7-4-8" class="i">+extern int head_ref(each_ref_fn, void *);
</a><a href="#h7-4-9" id="h7-4-9" class="i">+extern int for_each_ref(each_ref_fn, void *);
</a><a href="#h7-4-10" id="h7-4-10" class="i">+extern int for_each_tag_ref(each_ref_fn, void *);
</a><a href="#h7-4-11" id="h7-4-11" class="i">+extern int for_each_branch_ref(each_ref_fn, void *);
</a><a href="#h7-4-12" id="h7-4-12" class="i">+extern int for_each_remote_ref(each_ref_fn, void *);
</a> 
 
 
<a href="#h7-5" id="h7-5" class="h">@@ -391,6 +436,11 @@ struct rev_info {
</a> };
 
 
<a href="#h7-5-3" id="h7-5-3" class="i">+extern void init_revisions(struct rev_info *revs, const char *prefix);
</a><a href="#h7-5-4" id="h7-5-4" class="i">+extern int setup_revisions(int argc, const char **argv, struct rev_info *revs, const char *def);
</a><a href="#h7-5-5" id="h7-5-5" class="i">+extern int handle_revision_arg(const char *arg, struct rev_info *revs,int flags,int cant_be_filename);
</a><a href="#h7-5-6" id="h7-5-6" class="i">+
</a><a href="#h7-5-7" id="h7-5-7" class="i">+extern void prepare_revision_walk(struct rev_info *revs);
</a> extern struct commit *get_revision(struct rev_info *revs);
 
 
<b>diff --git a/<a id="h8" href="../file/html.c.html">html.c</a> b/<a href="../file/html.c.html">html.c</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -20,16 +20,18 @@ char *fmt(const char *format, ...)
</a> 
 void html(const char *txt)
 {
<a href="#h8-0-3" id="h8-0-3" class="d">-	fputs(txt, stdout);
</a><a href="#h8-0-4" id="h8-0-4" class="i">+	write(htmlfd, txt, strlen(txt));
</a> }
 
 void htmlf(const char *format, ...)
 {
<a href="#h8-0-9" id="h8-0-9" class="i">+	static char buf[65536];
</a> 	va_list args;
 
 	va_start(args, format);
<a href="#h8-0-13" id="h8-0-13" class="d">-	vprintf(format, args);
</a><a href="#h8-0-14" id="h8-0-14" class="i">+	vsnprintf(buf, sizeof(buf), format, args);
</a> 	va_end(args);
<a href="#h8-0-16" id="h8-0-16" class="i">+	html(buf);
</a> }
 
 void html_txt(char *txt)
</pre>
</div>
</body>
</html>
