<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Switch to exclusively using global ctx - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/f60ffa143cca61e9729ac71033e1a556cf422871.html">f60ffa143cca61e9729ac71033e1a556cf422871</a>
<b>parent</b> <a href="../commit/a431326e8fab8153905fbde036dd3c9fb4cc8eaa.html">a431326e8fab8153905fbde036dd3c9fb4cc8eaa</a>
<b>Author:</b> Lukas Fleischer &lt;<a href="mailto:cgit@cryptocrack.de">cgit@cryptocrack.de</a>&gt;
<b>Date:</b>   Wed, 15 Jan 2014 21:53:15 +0100

Switch to exclusively using global ctx

Drop the context parameter from the following functions (and all static
helpers used by them) and use the global context instead:

* cgit_print_http_headers()
* cgit_print_docstart()
* cgit_print_pageheader()

Remove context parameter from all commands

Drop the context parameter from the following functions (and all static
helpers used by them) and use the global context instead:

* cgit_get_cmd()
* All cgit command functions.
* cgit_clone_info()
* cgit_clone_objects()
* cgit_clone_head()
* cgit_print_plain()
* cgit_show_stats()

In initialization routines, use the global context variable instead of
passing a pointer around locally.

Remove callback data parameter for cache slots

This is no longer needed since the context is always read from the
global context variable.

Signed-off-by: Lukas Fleischer &lt;cgit@cryptocrack.de&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">cache.c</a></td><td> | </td><td class="num">14</td><td><span class="i">++++++</span><span class="d">--------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">cache.h</a></td><td> | </td><td class="num">5</td><td><span class="i">++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">cgit.c</a></td><td> | </td><td class="num">322</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">cmd.c</a></td><td> | </td><td class="num">102</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">cmd.h</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">ui-atom.c</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">ui-blob.c</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">ui-clone.c</a></td><td> | </td><td class="num">48</td><td><span class="i">++++++++++++++++++++++++</span><span class="d">------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">ui-clone.h</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">ui-diff.c</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">ui-patch.c</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">ui-plain.c</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">ui-plain.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">ui-repolist.c</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">ui-shared.c</a></td><td> | </td><td class="num">303</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h15">ui-shared.h</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">ui-snapshot.c</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h17">ui-stats.c</a></td><td> | </td><td class="num">29</td><td><span class="i">++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">ui-stats.h</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
</table></pre><pre>19 files changed, 437 insertions(+), 442 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/cache.c.html">cache.c</a> b/<a href="../file/cache.c.html">cache.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -24,7 +24,6 @@ struct cache_slot {
</a> 	int keylen;
 	int ttl;
 	cache_fill_fn fn;
<a href="#h0-0-3" id="h0-0-3" class="d">-	void *cbdata;
</a> 	int cache_fd;
 	int lock_fd;
 	const char *cache_name;
<a href="#h0-1" id="h0-1" class="h">@@ -187,7 +186,7 @@ static int fill_slot(struct cache_slot *slot)
</a> 		return errno;
 
 	/* Generate cache content */
<a href="#h0-1-3" id="h0-1-3" class="d">-	slot-&gt;fn(slot-&gt;cbdata);
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	slot-&gt;fn();
</a> 
 	/* Restore stdout */
 	if (dup2(tmp, STDOUT_FILENO) == -1)
<a href="#h0-2" id="h0-2" class="h">@@ -277,7 +276,7 @@ static int process_slot(struct cache_slot *slot)
</a> 	if ((err = lock_slot(slot)) != 0) {
 		cache_log(&quot;[cgit] Unable to lock slot %s: %s (%d)\n&quot;,
 			  slot-&gt;lock_name, strerror(err), err);
<a href="#h0-2-3" id="h0-2-3" class="d">-		slot-&gt;fn(slot-&gt;cbdata);
</a><a href="#h0-2-4" id="h0-2-4" class="i">+		slot-&gt;fn();
</a> 		return 0;
 	}
 
<a href="#h0-3" id="h0-3" class="h">@@ -286,7 +285,7 @@ static int process_slot(struct cache_slot *slot)
</a> 			  slot-&gt;lock_name, strerror(err), err);
 		unlock_slot(slot, 0);
 		close_lock(slot);
<a href="#h0-3-3" id="h0-3-3" class="d">-		slot-&gt;fn(slot-&gt;cbdata);
</a><a href="#h0-3-4" id="h0-3-4" class="i">+		slot-&gt;fn();
</a> 		return 0;
 	}
 	// We&#39;ve got a valid cache slot in the lock file, which
<a href="#h0-4" id="h0-4" class="h">@@ -310,7 +309,7 @@ static int process_slot(struct cache_slot *slot)
</a> 
 /* Print cached content to stdout, generate the content if necessary. */
 int cache_process(int size, const char *path, const char *key, int ttl,
<a href="#h0-4-3" id="h0-4-3" class="d">-		  cache_fill_fn fn, void *cbdata)
</a><a href="#h0-4-4" id="h0-4-4" class="i">+		  cache_fill_fn fn)
</a> {
 	unsigned long hash;
 	int i;
<a href="#h0-5" id="h0-5" class="h">@@ -321,14 +320,14 @@ int cache_process(int size, const char *path, const char *key, int ttl,
</a> 
 	/* If the cache is disabled, just generate the content */
 	if (size &lt;= 0) {
<a href="#h0-5-3" id="h0-5-3" class="d">-		fn(cbdata);
</a><a href="#h0-5-4" id="h0-5-4" class="i">+		fn();
</a> 		return 0;
 	}
 
 	/* Verify input, calculate filenames */
 	if (!path) {
 		cache_log(&quot;[cgit] Cache path not specified, caching is disabled\n&quot;);
<a href="#h0-5-11" id="h0-5-11" class="d">-		fn(cbdata);
</a><a href="#h0-5-12" id="h0-5-12" class="i">+		fn();
</a> 		return 0;
 	}
 	if (!key)
<a href="#h0-6" id="h0-6" class="h">@@ -343,7 +342,6 @@ int cache_process(int size, const char *path, const char *key, int ttl,
</a> 	strbuf_addbuf(&amp;lockname, &amp;filename);
 	strbuf_addstr(&amp;lockname, &quot;.lock&quot;);
 	slot.fn = fn;
<a href="#h0-6-3" id="h0-6-3" class="d">-	slot.cbdata = cbdata;
</a> 	slot.ttl = ttl;
 	slot.cache_name = filename.buf;
 	slot.lock_name = lockname.buf;
<b>diff --git a/<a id="h1" href="../file/cache.h.html">cache.h</a> b/<a href="../file/cache.h.html">cache.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -6,7 +6,7 @@
</a> #ifndef CGIT_CACHE_H
 #define CGIT_CACHE_H
 
<a href="#h1-0-3" id="h1-0-3" class="d">-typedef void (*cache_fill_fn)(void *cbdata);
</a><a href="#h1-0-4" id="h1-0-4" class="i">+typedef void (*cache_fill_fn)(void);
</a> 
 
 /* Print cached content to stdout, generate the content if necessary.
<a href="#h1-1" id="h1-1" class="h">@@ -17,13 +17,12 @@ typedef void (*cache_fill_fn)(void *cbdata);
</a>  *   key     the key used to lookup cache files
  *   ttl     max cache time in seconds for this key
  *   fn      content generator function for this key
<a href="#h1-1-3" id="h1-1-3" class="d">- *   cbdata  user-supplied data to the content generator function
</a>  *
  * Return value
  *   0 indicates success, everyting else is an error
  */
 extern int cache_process(int size, const char *path, const char *key, int ttl,
<a href="#h1-1-9" id="h1-1-9" class="d">-			 cache_fill_fn fn, void *cbdata);
</a><a href="#h1-1-10" id="h1-1-10" class="i">+			 cache_fill_fn fn);
</a> 
 
 /* List info about all cache entries on stdout */
<b>diff --git a/<a id="h2" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -322,82 +322,82 @@ static void querystring_cb(const char *name, const char *value)
</a> 	}
 }
 
<a href="#h2-0-3" id="h2-0-3" class="d">-static void prepare_context(struct cgit_context *ctx)
</a><a href="#h2-0-4" id="h2-0-4" class="i">+static void prepare_context(void)
</a> {
<a href="#h2-0-6" id="h2-0-6" class="d">-	memset(ctx, 0, sizeof(*ctx));
</a><a href="#h2-0-7" id="h2-0-7" class="d">-	ctx-&gt;cfg.agefile = &quot;info/web/last-modified&quot;;
</a><a href="#h2-0-8" id="h2-0-8" class="d">-	ctx-&gt;cfg.nocache = 0;
</a><a href="#h2-0-9" id="h2-0-9" class="d">-	ctx-&gt;cfg.cache_size = 0;
</a><a href="#h2-0-10" id="h2-0-10" class="d">-	ctx-&gt;cfg.cache_max_create_time = 5;
</a><a href="#h2-0-11" id="h2-0-11" class="d">-	ctx-&gt;cfg.cache_root = CGIT_CACHE_ROOT;
</a><a href="#h2-0-12" id="h2-0-12" class="d">-	ctx-&gt;cfg.cache_about_ttl = 15;
</a><a href="#h2-0-13" id="h2-0-13" class="d">-	ctx-&gt;cfg.cache_repo_ttl = 5;
</a><a href="#h2-0-14" id="h2-0-14" class="d">-	ctx-&gt;cfg.cache_root_ttl = 5;
</a><a href="#h2-0-15" id="h2-0-15" class="d">-	ctx-&gt;cfg.cache_scanrc_ttl = 15;
</a><a href="#h2-0-16" id="h2-0-16" class="d">-	ctx-&gt;cfg.cache_dynamic_ttl = 5;
</a><a href="#h2-0-17" id="h2-0-17" class="d">-	ctx-&gt;cfg.cache_static_ttl = -1;
</a><a href="#h2-0-18" id="h2-0-18" class="d">-	ctx-&gt;cfg.case_sensitive_sort = 1;
</a><a href="#h2-0-19" id="h2-0-19" class="d">-	ctx-&gt;cfg.branch_sort = 0;
</a><a href="#h2-0-20" id="h2-0-20" class="d">-	ctx-&gt;cfg.commit_sort = 0;
</a><a href="#h2-0-21" id="h2-0-21" class="d">-	ctx-&gt;cfg.css = &quot;/cgit.css&quot;;
</a><a href="#h2-0-22" id="h2-0-22" class="d">-	ctx-&gt;cfg.logo = &quot;/cgit.png&quot;;
</a><a href="#h2-0-23" id="h2-0-23" class="d">-	ctx-&gt;cfg.favicon = &quot;/favicon.ico&quot;;
</a><a href="#h2-0-24" id="h2-0-24" class="d">-	ctx-&gt;cfg.local_time = 0;
</a><a href="#h2-0-25" id="h2-0-25" class="d">-	ctx-&gt;cfg.enable_http_clone = 1;
</a><a href="#h2-0-26" id="h2-0-26" class="d">-	ctx-&gt;cfg.enable_index_owner = 1;
</a><a href="#h2-0-27" id="h2-0-27" class="d">-	ctx-&gt;cfg.enable_tree_linenumbers = 1;
</a><a href="#h2-0-28" id="h2-0-28" class="d">-	ctx-&gt;cfg.enable_git_config = 0;
</a><a href="#h2-0-29" id="h2-0-29" class="d">-	ctx-&gt;cfg.max_repo_count = 50;
</a><a href="#h2-0-30" id="h2-0-30" class="d">-	ctx-&gt;cfg.max_commit_count = 50;
</a><a href="#h2-0-31" id="h2-0-31" class="d">-	ctx-&gt;cfg.max_lock_attempts = 5;
</a><a href="#h2-0-32" id="h2-0-32" class="d">-	ctx-&gt;cfg.max_msg_len = 80;
</a><a href="#h2-0-33" id="h2-0-33" class="d">-	ctx-&gt;cfg.max_repodesc_len = 80;
</a><a href="#h2-0-34" id="h2-0-34" class="d">-	ctx-&gt;cfg.max_blob_size = 0;
</a><a href="#h2-0-35" id="h2-0-35" class="d">-	ctx-&gt;cfg.max_stats = 0;
</a><a href="#h2-0-36" id="h2-0-36" class="d">-	ctx-&gt;cfg.project_list = NULL;
</a><a href="#h2-0-37" id="h2-0-37" class="d">-	ctx-&gt;cfg.renamelimit = -1;
</a><a href="#h2-0-38" id="h2-0-38" class="d">-	ctx-&gt;cfg.remove_suffix = 0;
</a><a href="#h2-0-39" id="h2-0-39" class="d">-	ctx-&gt;cfg.robots = &quot;index, nofollow&quot;;
</a><a href="#h2-0-40" id="h2-0-40" class="d">-	ctx-&gt;cfg.root_title = &quot;Git repository browser&quot;;
</a><a href="#h2-0-41" id="h2-0-41" class="d">-	ctx-&gt;cfg.root_desc = &quot;a fast webinterface for the git dscm&quot;;
</a><a href="#h2-0-42" id="h2-0-42" class="d">-	ctx-&gt;cfg.scan_hidden_path = 0;
</a><a href="#h2-0-43" id="h2-0-43" class="d">-	ctx-&gt;cfg.script_name = CGIT_SCRIPT_NAME;
</a><a href="#h2-0-44" id="h2-0-44" class="d">-	ctx-&gt;cfg.section = &quot;&quot;;
</a><a href="#h2-0-45" id="h2-0-45" class="d">-	ctx-&gt;cfg.repository_sort = &quot;name&quot;;
</a><a href="#h2-0-46" id="h2-0-46" class="d">-	ctx-&gt;cfg.section_sort = 1;
</a><a href="#h2-0-47" id="h2-0-47" class="d">-	ctx-&gt;cfg.summary_branches = 10;
</a><a href="#h2-0-48" id="h2-0-48" class="d">-	ctx-&gt;cfg.summary_log = 10;
</a><a href="#h2-0-49" id="h2-0-49" class="d">-	ctx-&gt;cfg.summary_tags = 10;
</a><a href="#h2-0-50" id="h2-0-50" class="d">-	ctx-&gt;cfg.max_atom_items = 10;
</a><a href="#h2-0-51" id="h2-0-51" class="d">-	ctx-&gt;cfg.ssdiff = 0;
</a><a href="#h2-0-52" id="h2-0-52" class="d">-	ctx-&gt;env.cgit_config = getenv(&quot;CGIT_CONFIG&quot;);
</a><a href="#h2-0-53" id="h2-0-53" class="d">-	ctx-&gt;env.http_host = getenv(&quot;HTTP_HOST&quot;);
</a><a href="#h2-0-54" id="h2-0-54" class="d">-	ctx-&gt;env.https = getenv(&quot;HTTPS&quot;);
</a><a href="#h2-0-55" id="h2-0-55" class="d">-	ctx-&gt;env.no_http = getenv(&quot;NO_HTTP&quot;);
</a><a href="#h2-0-56" id="h2-0-56" class="d">-	ctx-&gt;env.path_info = getenv(&quot;PATH_INFO&quot;);
</a><a href="#h2-0-57" id="h2-0-57" class="d">-	ctx-&gt;env.query_string = getenv(&quot;QUERY_STRING&quot;);
</a><a href="#h2-0-58" id="h2-0-58" class="d">-	ctx-&gt;env.request_method = getenv(&quot;REQUEST_METHOD&quot;);
</a><a href="#h2-0-59" id="h2-0-59" class="d">-	ctx-&gt;env.script_name = getenv(&quot;SCRIPT_NAME&quot;);
</a><a href="#h2-0-60" id="h2-0-60" class="d">-	ctx-&gt;env.server_name = getenv(&quot;SERVER_NAME&quot;);
</a><a href="#h2-0-61" id="h2-0-61" class="d">-	ctx-&gt;env.server_port = getenv(&quot;SERVER_PORT&quot;);
</a><a href="#h2-0-62" id="h2-0-62" class="d">-	ctx-&gt;env.http_cookie = getenv(&quot;HTTP_COOKIE&quot;);
</a><a href="#h2-0-63" id="h2-0-63" class="d">-	ctx-&gt;env.http_referer = getenv(&quot;HTTP_REFERER&quot;);
</a><a href="#h2-0-64" id="h2-0-64" class="d">-	ctx-&gt;env.content_length = getenv(&quot;CONTENT_LENGTH&quot;) ? strtoul(getenv(&quot;CONTENT_LENGTH&quot;), NULL, 10) : 0;
</a><a href="#h2-0-65" id="h2-0-65" class="d">-	ctx-&gt;env.authenticated = 0;
</a><a href="#h2-0-66" id="h2-0-66" class="d">-	ctx-&gt;page.mimetype = &quot;text/html&quot;;
</a><a href="#h2-0-67" id="h2-0-67" class="d">-	ctx-&gt;page.charset = PAGE_ENCODING;
</a><a href="#h2-0-68" id="h2-0-68" class="d">-	ctx-&gt;page.filename = NULL;
</a><a href="#h2-0-69" id="h2-0-69" class="d">-	ctx-&gt;page.size = 0;
</a><a href="#h2-0-70" id="h2-0-70" class="d">-	ctx-&gt;page.modified = time(NULL);
</a><a href="#h2-0-71" id="h2-0-71" class="d">-	ctx-&gt;page.expires = ctx-&gt;page.modified;
</a><a href="#h2-0-72" id="h2-0-72" class="d">-	ctx-&gt;page.etag = NULL;
</a><a href="#h2-0-73" id="h2-0-73" class="d">-	memset(&amp;ctx-&gt;cfg.mimetypes, 0, sizeof(struct string_list));
</a><a href="#h2-0-74" id="h2-0-74" class="d">-	if (ctx-&gt;env.script_name)
</a><a href="#h2-0-75" id="h2-0-75" class="d">-		ctx-&gt;cfg.script_name = xstrdup(ctx-&gt;env.script_name);
</a><a href="#h2-0-76" id="h2-0-76" class="d">-	if (ctx-&gt;env.query_string)
</a><a href="#h2-0-77" id="h2-0-77" class="d">-		ctx-&gt;qry.raw = xstrdup(ctx-&gt;env.query_string);
</a><a href="#h2-0-78" id="h2-0-78" class="d">-	if (!ctx-&gt;env.cgit_config)
</a><a href="#h2-0-79" id="h2-0-79" class="d">-		ctx-&gt;env.cgit_config = CGIT_CONFIG;
</a><a href="#h2-0-80" id="h2-0-80" class="i">+	memset(&amp;ctx, 0, sizeof(ctx));
</a><a href="#h2-0-81" id="h2-0-81" class="i">+	ctx.cfg.agefile = &quot;info/web/last-modified&quot;;
</a><a href="#h2-0-82" id="h2-0-82" class="i">+	ctx.cfg.nocache = 0;
</a><a href="#h2-0-83" id="h2-0-83" class="i">+	ctx.cfg.cache_size = 0;
</a><a href="#h2-0-84" id="h2-0-84" class="i">+	ctx.cfg.cache_max_create_time = 5;
</a><a href="#h2-0-85" id="h2-0-85" class="i">+	ctx.cfg.cache_root = CGIT_CACHE_ROOT;
</a><a href="#h2-0-86" id="h2-0-86" class="i">+	ctx.cfg.cache_about_ttl = 15;
</a><a href="#h2-0-87" id="h2-0-87" class="i">+	ctx.cfg.cache_repo_ttl = 5;
</a><a href="#h2-0-88" id="h2-0-88" class="i">+	ctx.cfg.cache_root_ttl = 5;
</a><a href="#h2-0-89" id="h2-0-89" class="i">+	ctx.cfg.cache_scanrc_ttl = 15;
</a><a href="#h2-0-90" id="h2-0-90" class="i">+	ctx.cfg.cache_dynamic_ttl = 5;
</a><a href="#h2-0-91" id="h2-0-91" class="i">+	ctx.cfg.cache_static_ttl = -1;
</a><a href="#h2-0-92" id="h2-0-92" class="i">+	ctx.cfg.case_sensitive_sort = 1;
</a><a href="#h2-0-93" id="h2-0-93" class="i">+	ctx.cfg.branch_sort = 0;
</a><a href="#h2-0-94" id="h2-0-94" class="i">+	ctx.cfg.commit_sort = 0;
</a><a href="#h2-0-95" id="h2-0-95" class="i">+	ctx.cfg.css = &quot;/cgit.css&quot;;
</a><a href="#h2-0-96" id="h2-0-96" class="i">+	ctx.cfg.logo = &quot;/cgit.png&quot;;
</a><a href="#h2-0-97" id="h2-0-97" class="i">+	ctx.cfg.favicon = &quot;/favicon.ico&quot;;
</a><a href="#h2-0-98" id="h2-0-98" class="i">+	ctx.cfg.local_time = 0;
</a><a href="#h2-0-99" id="h2-0-99" class="i">+	ctx.cfg.enable_http_clone = 1;
</a><a href="#h2-0-100" id="h2-0-100" class="i">+	ctx.cfg.enable_index_owner = 1;
</a><a href="#h2-0-101" id="h2-0-101" class="i">+	ctx.cfg.enable_tree_linenumbers = 1;
</a><a href="#h2-0-102" id="h2-0-102" class="i">+	ctx.cfg.enable_git_config = 0;
</a><a href="#h2-0-103" id="h2-0-103" class="i">+	ctx.cfg.max_repo_count = 50;
</a><a href="#h2-0-104" id="h2-0-104" class="i">+	ctx.cfg.max_commit_count = 50;
</a><a href="#h2-0-105" id="h2-0-105" class="i">+	ctx.cfg.max_lock_attempts = 5;
</a><a href="#h2-0-106" id="h2-0-106" class="i">+	ctx.cfg.max_msg_len = 80;
</a><a href="#h2-0-107" id="h2-0-107" class="i">+	ctx.cfg.max_repodesc_len = 80;
</a><a href="#h2-0-108" id="h2-0-108" class="i">+	ctx.cfg.max_blob_size = 0;
</a><a href="#h2-0-109" id="h2-0-109" class="i">+	ctx.cfg.max_stats = 0;
</a><a href="#h2-0-110" id="h2-0-110" class="i">+	ctx.cfg.project_list = NULL;
</a><a href="#h2-0-111" id="h2-0-111" class="i">+	ctx.cfg.renamelimit = -1;
</a><a href="#h2-0-112" id="h2-0-112" class="i">+	ctx.cfg.remove_suffix = 0;
</a><a href="#h2-0-113" id="h2-0-113" class="i">+	ctx.cfg.robots = &quot;index, nofollow&quot;;
</a><a href="#h2-0-114" id="h2-0-114" class="i">+	ctx.cfg.root_title = &quot;Git repository browser&quot;;
</a><a href="#h2-0-115" id="h2-0-115" class="i">+	ctx.cfg.root_desc = &quot;a fast webinterface for the git dscm&quot;;
</a><a href="#h2-0-116" id="h2-0-116" class="i">+	ctx.cfg.scan_hidden_path = 0;
</a><a href="#h2-0-117" id="h2-0-117" class="i">+	ctx.cfg.script_name = CGIT_SCRIPT_NAME;
</a><a href="#h2-0-118" id="h2-0-118" class="i">+	ctx.cfg.section = &quot;&quot;;
</a><a href="#h2-0-119" id="h2-0-119" class="i">+	ctx.cfg.repository_sort = &quot;name&quot;;
</a><a href="#h2-0-120" id="h2-0-120" class="i">+	ctx.cfg.section_sort = 1;
</a><a href="#h2-0-121" id="h2-0-121" class="i">+	ctx.cfg.summary_branches = 10;
</a><a href="#h2-0-122" id="h2-0-122" class="i">+	ctx.cfg.summary_log = 10;
</a><a href="#h2-0-123" id="h2-0-123" class="i">+	ctx.cfg.summary_tags = 10;
</a><a href="#h2-0-124" id="h2-0-124" class="i">+	ctx.cfg.max_atom_items = 10;
</a><a href="#h2-0-125" id="h2-0-125" class="i">+	ctx.cfg.ssdiff = 0;
</a><a href="#h2-0-126" id="h2-0-126" class="i">+	ctx.env.cgit_config = getenv(&quot;CGIT_CONFIG&quot;);
</a><a href="#h2-0-127" id="h2-0-127" class="i">+	ctx.env.http_host = getenv(&quot;HTTP_HOST&quot;);
</a><a href="#h2-0-128" id="h2-0-128" class="i">+	ctx.env.https = getenv(&quot;HTTPS&quot;);
</a><a href="#h2-0-129" id="h2-0-129" class="i">+	ctx.env.no_http = getenv(&quot;NO_HTTP&quot;);
</a><a href="#h2-0-130" id="h2-0-130" class="i">+	ctx.env.path_info = getenv(&quot;PATH_INFO&quot;);
</a><a href="#h2-0-131" id="h2-0-131" class="i">+	ctx.env.query_string = getenv(&quot;QUERY_STRING&quot;);
</a><a href="#h2-0-132" id="h2-0-132" class="i">+	ctx.env.request_method = getenv(&quot;REQUEST_METHOD&quot;);
</a><a href="#h2-0-133" id="h2-0-133" class="i">+	ctx.env.script_name = getenv(&quot;SCRIPT_NAME&quot;);
</a><a href="#h2-0-134" id="h2-0-134" class="i">+	ctx.env.server_name = getenv(&quot;SERVER_NAME&quot;);
</a><a href="#h2-0-135" id="h2-0-135" class="i">+	ctx.env.server_port = getenv(&quot;SERVER_PORT&quot;);
</a><a href="#h2-0-136" id="h2-0-136" class="i">+	ctx.env.http_cookie = getenv(&quot;HTTP_COOKIE&quot;);
</a><a href="#h2-0-137" id="h2-0-137" class="i">+	ctx.env.http_referer = getenv(&quot;HTTP_REFERER&quot;);
</a><a href="#h2-0-138" id="h2-0-138" class="i">+	ctx.env.content_length = getenv(&quot;CONTENT_LENGTH&quot;) ? strtoul(getenv(&quot;CONTENT_LENGTH&quot;), NULL, 10) : 0;
</a><a href="#h2-0-139" id="h2-0-139" class="i">+	ctx.env.authenticated = 0;
</a><a href="#h2-0-140" id="h2-0-140" class="i">+	ctx.page.mimetype = &quot;text/html&quot;;
</a><a href="#h2-0-141" id="h2-0-141" class="i">+	ctx.page.charset = PAGE_ENCODING;
</a><a href="#h2-0-142" id="h2-0-142" class="i">+	ctx.page.filename = NULL;
</a><a href="#h2-0-143" id="h2-0-143" class="i">+	ctx.page.size = 0;
</a><a href="#h2-0-144" id="h2-0-144" class="i">+	ctx.page.modified = time(NULL);
</a><a href="#h2-0-145" id="h2-0-145" class="i">+	ctx.page.expires = ctx.page.modified;
</a><a href="#h2-0-146" id="h2-0-146" class="i">+	ctx.page.etag = NULL;
</a><a href="#h2-0-147" id="h2-0-147" class="i">+	memset(&amp;ctx.cfg.mimetypes, 0, sizeof(struct string_list));
</a><a href="#h2-0-148" id="h2-0-148" class="i">+	if (ctx.env.script_name)
</a><a href="#h2-0-149" id="h2-0-149" class="i">+		ctx.cfg.script_name = xstrdup(ctx.env.script_name);
</a><a href="#h2-0-150" id="h2-0-150" class="i">+	if (ctx.env.query_string)
</a><a href="#h2-0-151" id="h2-0-151" class="i">+		ctx.qry.raw = xstrdup(ctx.env.query_string);
</a><a href="#h2-0-152" id="h2-0-152" class="i">+	if (!ctx.env.cgit_config)
</a><a href="#h2-0-153" id="h2-0-153" class="i">+		ctx.env.cgit_config = CGIT_CONFIG;
</a> }
 
 struct refmatch {
<a href="#h2-1" id="h2-1" class="h">@@ -527,14 +527,14 @@ static void choose_readme(struct cgit_repo *repo)
</a> 		string_list_append(&amp;repo-&gt;readme, filename)-&gt;util = ref;
 }
 
<a href="#h2-1-3" id="h2-1-3" class="d">-static int prepare_repo_cmd(struct cgit_context *ctx)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+static int prepare_repo_cmd(void)
</a> {
 	unsigned char sha1[20];
 	int nongit = 0;
 	int rc;
 
 	/* The path to the git repository. */
<a href="#h2-1-11" id="h2-1-11" class="d">-	setenv(&quot;GIT_DIR&quot;, ctx-&gt;repo-&gt;path, 1);
</a><a href="#h2-1-12" id="h2-1-12" class="i">+	setenv(&quot;GIT_DIR&quot;, ctx.repo-&gt;path, 1);
</a> 
 	/* Do not look in /etc/ for gitconfig and gitattributes. */
 	setenv(&quot;GIT_CONFIG_NOSYSTEM&quot;, &quot;1&quot;, 1);
<a href="#h2-2" id="h2-2" class="h">@@ -549,69 +549,69 @@ static int prepare_repo_cmd(struct cgit_context *ctx)
</a> 	init_display_notes(NULL);
 
 	if (nongit) {
<a href="#h2-2-3" id="h2-2-3" class="d">-		const char *name = ctx-&gt;repo-&gt;name;
</a><a href="#h2-2-4" id="h2-2-4" class="i">+		const char *name = ctx.repo-&gt;name;
</a> 		rc = errno;
<a href="#h2-2-6" id="h2-2-6" class="d">-		ctx-&gt;page.title = fmtalloc(&quot;%s - %s&quot;, ctx-&gt;cfg.root_title,
</a><a href="#h2-2-7" id="h2-2-7" class="i">+		ctx.page.title = fmtalloc(&quot;%s - %s&quot;, ctx.cfg.root_title,
</a> 						&quot;config error&quot;);
<a href="#h2-2-9" id="h2-2-9" class="d">-		ctx-&gt;repo = NULL;
</a><a href="#h2-2-10" id="h2-2-10" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-2-11" id="h2-2-11" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-2-12" id="h2-2-12" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-2-13" id="h2-2-13" class="i">+		ctx.repo = NULL;
</a><a href="#h2-2-14" id="h2-2-14" class="i">+		cgit_print_http_headers();
</a><a href="#h2-2-15" id="h2-2-15" class="i">+		cgit_print_docstart();
</a><a href="#h2-2-16" id="h2-2-16" class="i">+		cgit_print_pageheader();
</a> 		cgit_print_error(&quot;Failed to open %s: %s&quot;, name,
 				 rc ? strerror(rc) : &quot;Not a valid git repository&quot;);
 		cgit_print_docend();
 		return 1;
 	}
<a href="#h2-2-22" id="h2-2-22" class="d">-	ctx-&gt;page.title = fmtalloc(&quot;%s - %s&quot;, ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;desc);
</a><a href="#h2-2-23" id="h2-2-23" class="i">+	ctx.page.title = fmtalloc(&quot;%s - %s&quot;, ctx.repo-&gt;name, ctx.repo-&gt;desc);
</a> 
<a href="#h2-2-25" id="h2-2-25" class="d">-	if (!ctx-&gt;repo-&gt;defbranch)
</a><a href="#h2-2-26" id="h2-2-26" class="d">-		ctx-&gt;repo-&gt;defbranch = guess_defbranch();
</a><a href="#h2-2-27" id="h2-2-27" class="i">+	if (!ctx.repo-&gt;defbranch)
</a><a href="#h2-2-28" id="h2-2-28" class="i">+		ctx.repo-&gt;defbranch = guess_defbranch();
</a> 
<a href="#h2-2-30" id="h2-2-30" class="d">-	if (!ctx-&gt;qry.head) {
</a><a href="#h2-2-31" id="h2-2-31" class="d">-		ctx-&gt;qry.nohead = 1;
</a><a href="#h2-2-32" id="h2-2-32" class="d">-		ctx-&gt;qry.head = find_default_branch(ctx-&gt;repo);
</a><a href="#h2-2-33" id="h2-2-33" class="i">+	if (!ctx.qry.head) {
</a><a href="#h2-2-34" id="h2-2-34" class="i">+		ctx.qry.nohead = 1;
</a><a href="#h2-2-35" id="h2-2-35" class="i">+		ctx.qry.head = find_default_branch(ctx.repo);
</a> 	}
 
<a href="#h2-2-38" id="h2-2-38" class="d">-	if (!ctx-&gt;qry.head) {
</a><a href="#h2-2-39" id="h2-2-39" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-2-40" id="h2-2-40" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-2-41" id="h2-2-41" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-2-42" id="h2-2-42" class="i">+	if (!ctx.qry.head) {
</a><a href="#h2-2-43" id="h2-2-43" class="i">+		cgit_print_http_headers();
</a><a href="#h2-2-44" id="h2-2-44" class="i">+		cgit_print_docstart();
</a><a href="#h2-2-45" id="h2-2-45" class="i">+		cgit_print_pageheader();
</a> 		cgit_print_error(&quot;Repository seems to be empty&quot;);
 		cgit_print_docend();
 		return 1;
 	}
 
<a href="#h2-2-51" id="h2-2-51" class="d">-	if (get_sha1(ctx-&gt;qry.head, sha1)) {
</a><a href="#h2-2-52" id="h2-2-52" class="d">-		char *tmp = xstrdup(ctx-&gt;qry.head);
</a><a href="#h2-2-53" id="h2-2-53" class="d">-		ctx-&gt;qry.head = ctx-&gt;repo-&gt;defbranch;
</a><a href="#h2-2-54" id="h2-2-54" class="d">-		ctx-&gt;page.status = 404;
</a><a href="#h2-2-55" id="h2-2-55" class="d">-		ctx-&gt;page.statusmsg = &quot;Not found&quot;;
</a><a href="#h2-2-56" id="h2-2-56" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-2-57" id="h2-2-57" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-2-58" id="h2-2-58" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-2-59" id="h2-2-59" class="i">+	if (get_sha1(ctx.qry.head, sha1)) {
</a><a href="#h2-2-60" id="h2-2-60" class="i">+		char *tmp = xstrdup(ctx.qry.head);
</a><a href="#h2-2-61" id="h2-2-61" class="i">+		ctx.qry.head = ctx.repo-&gt;defbranch;
</a><a href="#h2-2-62" id="h2-2-62" class="i">+		ctx.page.status = 404;
</a><a href="#h2-2-63" id="h2-2-63" class="i">+		ctx.page.statusmsg = &quot;Not found&quot;;
</a><a href="#h2-2-64" id="h2-2-64" class="i">+		cgit_print_http_headers();
</a><a href="#h2-2-65" id="h2-2-65" class="i">+		cgit_print_docstart();
</a><a href="#h2-2-66" id="h2-2-66" class="i">+		cgit_print_pageheader();
</a> 		cgit_print_error(&quot;Invalid branch: %s&quot;, tmp);
 		cgit_print_docend();
 		return 1;
 	}
<a href="#h2-2-71" id="h2-2-71" class="d">-	sort_string_list(&amp;ctx-&gt;repo-&gt;submodules);
</a><a href="#h2-2-72" id="h2-2-72" class="d">-	cgit_prepare_repo_env(ctx-&gt;repo);
</a><a href="#h2-2-73" id="h2-2-73" class="d">-	choose_readme(ctx-&gt;repo);
</a><a href="#h2-2-74" id="h2-2-74" class="i">+	sort_string_list(&amp;ctx.repo-&gt;submodules);
</a><a href="#h2-2-75" id="h2-2-75" class="i">+	cgit_prepare_repo_env(ctx.repo);
</a><a href="#h2-2-76" id="h2-2-76" class="i">+	choose_readme(ctx.repo);
</a> 	return 0;
 }
 
<a href="#h2-2-80" id="h2-2-80" class="d">-static inline void open_auth_filter(struct cgit_context *ctx, const char *function)
</a><a href="#h2-2-81" id="h2-2-81" class="i">+static inline void open_auth_filter(const char *function)
</a> {
<a href="#h2-2-83" id="h2-2-83" class="d">-	cgit_open_filter(ctx-&gt;cfg.auth_filter, function,
</a><a href="#h2-2-84" id="h2-2-84" class="d">-		ctx-&gt;env.http_cookie ? ctx-&gt;env.http_cookie : &quot;&quot;,
</a><a href="#h2-2-85" id="h2-2-85" class="d">-		ctx-&gt;env.request_method ? ctx-&gt;env.request_method : &quot;&quot;,
</a><a href="#h2-2-86" id="h2-2-86" class="d">-		ctx-&gt;env.query_string ? ctx-&gt;env.query_string : &quot;&quot;,
</a><a href="#h2-2-87" id="h2-2-87" class="d">-		ctx-&gt;env.http_referer ? ctx-&gt;env.http_referer : &quot;&quot;,
</a><a href="#h2-2-88" id="h2-2-88" class="d">-		ctx-&gt;env.path_info ? ctx-&gt;env.path_info : &quot;&quot;,
</a><a href="#h2-2-89" id="h2-2-89" class="d">-		ctx-&gt;env.http_host ? ctx-&gt;env.http_host : &quot;&quot;,
</a><a href="#h2-2-90" id="h2-2-90" class="d">-		ctx-&gt;env.https ? ctx-&gt;env.https : &quot;&quot;,
</a><a href="#h2-2-91" id="h2-2-91" class="d">-		ctx-&gt;qry.repo ? ctx-&gt;qry.repo : &quot;&quot;,
</a><a href="#h2-2-92" id="h2-2-92" class="d">-		ctx-&gt;qry.page ? ctx-&gt;qry.page : &quot;&quot;,
</a><a href="#h2-2-93" id="h2-2-93" class="d">-		ctx-&gt;qry.url ? ctx-&gt;qry.url : &quot;&quot;,
</a><a href="#h2-2-94" id="h2-2-94" class="i">+	cgit_open_filter(ctx.cfg.auth_filter, function,
</a><a href="#h2-2-95" id="h2-2-95" class="i">+		ctx.env.http_cookie ? ctx.env.http_cookie : &quot;&quot;,
</a><a href="#h2-2-96" id="h2-2-96" class="i">+		ctx.env.request_method ? ctx.env.request_method : &quot;&quot;,
</a><a href="#h2-2-97" id="h2-2-97" class="i">+		ctx.env.query_string ? ctx.env.query_string : &quot;&quot;,
</a><a href="#h2-2-98" id="h2-2-98" class="i">+		ctx.env.http_referer ? ctx.env.http_referer : &quot;&quot;,
</a><a href="#h2-2-99" id="h2-2-99" class="i">+		ctx.env.path_info ? ctx.env.path_info : &quot;&quot;,
</a><a href="#h2-2-100" id="h2-2-100" class="i">+		ctx.env.http_host ? ctx.env.http_host : &quot;&quot;,
</a><a href="#h2-2-101" id="h2-2-101" class="i">+		ctx.env.https ? ctx.env.https : &quot;&quot;,
</a><a href="#h2-2-102" id="h2-2-102" class="i">+		ctx.qry.repo ? ctx.qry.repo : &quot;&quot;,
</a><a href="#h2-2-103" id="h2-2-103" class="i">+		ctx.qry.page ? ctx.qry.page : &quot;&quot;,
</a><a href="#h2-2-104" id="h2-2-104" class="i">+		ctx.qry.url ? ctx.qry.url : &quot;&quot;,
</a> 		cgit_loginurl());
 }
 
<a href="#h2-3" id="h2-3" class="h">@@ -622,107 +622,106 @@ static inline void open_auth_filter(struct cgit_context *ctx, const char *functi
</a>  * will complain on the mailing list, and we&#39;ll increase it as needed. */
 #define MAX_AUTHENTICATION_POST_BYTES 4096
 /* The filter is expected to spit out &quot;Status: &quot; and all headers. */
<a href="#h2-3-3" id="h2-3-3" class="d">-static inline void authenticate_post(struct cgit_context *ctx)
</a><a href="#h2-3-4" id="h2-3-4" class="i">+static inline void authenticate_post(void)
</a> {
 	char buffer[MAX_AUTHENTICATION_POST_BYTES];
 	int len;
 
<a href="#h2-3-9" id="h2-3-9" class="d">-	open_auth_filter(ctx, &quot;authenticate-post&quot;);
</a><a href="#h2-3-10" id="h2-3-10" class="d">-	len = ctx-&gt;env.content_length;
</a><a href="#h2-3-11" id="h2-3-11" class="i">+	open_auth_filter(&quot;authenticate-post&quot;);
</a><a href="#h2-3-12" id="h2-3-12" class="i">+	len = ctx.env.content_length;
</a> 	if (len &gt; MAX_AUTHENTICATION_POST_BYTES)
 		len = MAX_AUTHENTICATION_POST_BYTES;
 	if (read(STDIN_FILENO, buffer, len) &lt; 0)
 		die_errno(&quot;Could not read POST from stdin&quot;);
 	if (write(STDOUT_FILENO, buffer, len) &lt; 0)
 		die_errno(&quot;Could not write POST to stdout&quot;);
<a href="#h2-3-19" id="h2-3-19" class="d">-	cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h2-3-20" id="h2-3-20" class="i">+	cgit_close_filter(ctx.cfg.auth_filter);
</a> 	exit(0);
 }
 
<a href="#h2-3-24" id="h2-3-24" class="d">-static inline void authenticate_cookie(struct cgit_context *ctx)
</a><a href="#h2-3-25" id="h2-3-25" class="i">+static inline void authenticate_cookie(void)
</a> {
 	/* If we don&#39;t have an auth_filter, consider all cookies valid, and thus return early. */
<a href="#h2-3-28" id="h2-3-28" class="d">-	if (!ctx-&gt;cfg.auth_filter) {
</a><a href="#h2-3-29" id="h2-3-29" class="d">-		ctx-&gt;env.authenticated = 1;
</a><a href="#h2-3-30" id="h2-3-30" class="i">+	if (!ctx.cfg.auth_filter) {
</a><a href="#h2-3-31" id="h2-3-31" class="i">+		ctx.env.authenticated = 1;
</a> 		return;
 	}
 
 	/* If we&#39;re having something POST&#39;d to /login, we&#39;re authenticating POST,
 	 * instead of the cookie, so call authenticate_post and bail out early.
 	 * This pattern here should match /?p=login with POST. */
<a href="#h2-3-38" id="h2-3-38" class="d">-	if (ctx-&gt;env.request_method &amp;&amp; ctx-&gt;qry.page &amp;&amp; !ctx-&gt;repo &amp;&amp; \
</a><a href="#h2-3-39" id="h2-3-39" class="d">-	    !strcmp(ctx-&gt;env.request_method, &quot;POST&quot;) &amp;&amp; !strcmp(ctx-&gt;qry.page, &quot;login&quot;)) {
</a><a href="#h2-3-40" id="h2-3-40" class="d">-		authenticate_post(ctx);
</a><a href="#h2-3-41" id="h2-3-41" class="i">+	if (ctx.env.request_method &amp;&amp; ctx.qry.page &amp;&amp; !ctx.repo &amp;&amp; \
</a><a href="#h2-3-42" id="h2-3-42" class="i">+	    !strcmp(ctx.env.request_method, &quot;POST&quot;) &amp;&amp; !strcmp(ctx.qry.page, &quot;login&quot;)) {
</a><a href="#h2-3-43" id="h2-3-43" class="i">+		authenticate_post();
</a> 		return;
 	}
 
 	/* If we&#39;ve made it this far, we&#39;re authenticating the cookie for real, so do that. */
<a href="#h2-3-48" id="h2-3-48" class="d">-	open_auth_filter(ctx, &quot;authenticate-cookie&quot;);
</a><a href="#h2-3-49" id="h2-3-49" class="d">-	ctx-&gt;env.authenticated = cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h2-3-50" id="h2-3-50" class="i">+	open_auth_filter(&quot;authenticate-cookie&quot;);
</a><a href="#h2-3-51" id="h2-3-51" class="i">+	ctx.env.authenticated = cgit_close_filter(ctx.cfg.auth_filter);
</a> }
 
<a href="#h2-3-54" id="h2-3-54" class="d">-static void process_request(void *cbdata)
</a><a href="#h2-3-55" id="h2-3-55" class="i">+static void process_request(void)
</a> {
<a href="#h2-3-57" id="h2-3-57" class="d">-	struct cgit_context *ctx = cbdata;
</a> 	struct cgit_cmd *cmd;
 
 	/* If we&#39;re not yet authenticated, no matter what page we&#39;re on,
 	 * display the authentication body from the auth_filter. This should
 	 * never be cached. */
<a href="#h2-3-63" id="h2-3-63" class="d">-	if (!ctx-&gt;env.authenticated) {
</a><a href="#h2-3-64" id="h2-3-64" class="d">-		ctx-&gt;page.title = &quot;Authentication Required&quot;;
</a><a href="#h2-3-65" id="h2-3-65" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-3-66" id="h2-3-66" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-3-67" id="h2-3-67" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-3-68" id="h2-3-68" class="d">-		open_auth_filter(ctx, &quot;body&quot;);
</a><a href="#h2-3-69" id="h2-3-69" class="d">-		cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h2-3-70" id="h2-3-70" class="i">+	if (!ctx.env.authenticated) {
</a><a href="#h2-3-71" id="h2-3-71" class="i">+		ctx.page.title = &quot;Authentication Required&quot;;
</a><a href="#h2-3-72" id="h2-3-72" class="i">+		cgit_print_http_headers();
</a><a href="#h2-3-73" id="h2-3-73" class="i">+		cgit_print_docstart();
</a><a href="#h2-3-74" id="h2-3-74" class="i">+		cgit_print_pageheader();
</a><a href="#h2-3-75" id="h2-3-75" class="i">+		open_auth_filter(&quot;body&quot;);
</a><a href="#h2-3-76" id="h2-3-76" class="i">+		cgit_close_filter(ctx.cfg.auth_filter);
</a> 		cgit_print_docend();
 		return;
 	}
 
<a href="#h2-3-81" id="h2-3-81" class="d">-	cmd = cgit_get_cmd(ctx);
</a><a href="#h2-3-82" id="h2-3-82" class="i">+	cmd = cgit_get_cmd();
</a> 	if (!cmd) {
<a href="#h2-3-84" id="h2-3-84" class="d">-		ctx-&gt;page.title = &quot;cgit error&quot;;
</a><a href="#h2-3-85" id="h2-3-85" class="d">-		ctx-&gt;page.status = 404;
</a><a href="#h2-3-86" id="h2-3-86" class="d">-		ctx-&gt;page.statusmsg = &quot;Not found&quot;;
</a><a href="#h2-3-87" id="h2-3-87" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-3-88" id="h2-3-88" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-3-89" id="h2-3-89" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-3-90" id="h2-3-90" class="i">+		ctx.page.title = &quot;cgit error&quot;;
</a><a href="#h2-3-91" id="h2-3-91" class="i">+		ctx.page.status = 404;
</a><a href="#h2-3-92" id="h2-3-92" class="i">+		ctx.page.statusmsg = &quot;Not found&quot;;
</a><a href="#h2-3-93" id="h2-3-93" class="i">+		cgit_print_http_headers();
</a><a href="#h2-3-94" id="h2-3-94" class="i">+		cgit_print_docstart();
</a><a href="#h2-3-95" id="h2-3-95" class="i">+		cgit_print_pageheader();
</a> 		cgit_print_error(&quot;Invalid request&quot;);
 		cgit_print_docend();
 		return;
 	}
 
<a href="#h2-3-101" id="h2-3-101" class="d">-	if (!ctx-&gt;cfg.enable_http_clone &amp;&amp; cmd-&gt;is_clone) {
</a><a href="#h2-3-102" id="h2-3-102" class="i">+	if (!ctx.cfg.enable_http_clone &amp;&amp; cmd-&gt;is_clone) {
</a> 		html_status(404, &quot;Not found&quot;, 0);
 		return;
 	}
 
<a href="#h2-3-107" id="h2-3-107" class="d">-	/* If cmd-&gt;want_vpath is set, assume ctx-&gt;qry.path contains a &quot;virtual&quot;
</a><a href="#h2-3-108" id="h2-3-108" class="d">-	 * in-project path limit to be made available at ctx-&gt;qry.vpath.
</a><a href="#h2-3-109" id="h2-3-109" class="d">-	 * Otherwise, no path limit is in effect (ctx-&gt;qry.vpath = NULL).
</a><a href="#h2-3-110" id="h2-3-110" class="i">+	/* If cmd-&gt;want_vpath is set, assume ctx.qry.path contains a &quot;virtual&quot;
</a><a href="#h2-3-111" id="h2-3-111" class="i">+	 * in-project path limit to be made available at ctx.qry.vpath.
</a><a href="#h2-3-112" id="h2-3-112" class="i">+	 * Otherwise, no path limit is in effect (ctx.qry.vpath = NULL).
</a> 	 */
<a href="#h2-3-114" id="h2-3-114" class="d">-	ctx-&gt;qry.vpath = cmd-&gt;want_vpath ? ctx-&gt;qry.path : NULL;
</a><a href="#h2-3-115" id="h2-3-115" class="i">+	ctx.qry.vpath = cmd-&gt;want_vpath ? ctx.qry.path : NULL;
</a> 
<a href="#h2-3-117" id="h2-3-117" class="d">-	if (cmd-&gt;want_repo &amp;&amp; !ctx-&gt;repo) {
</a><a href="#h2-3-118" id="h2-3-118" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-3-119" id="h2-3-119" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-3-120" id="h2-3-120" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-3-121" id="h2-3-121" class="i">+	if (cmd-&gt;want_repo &amp;&amp; !ctx.repo) {
</a><a href="#h2-3-122" id="h2-3-122" class="i">+		cgit_print_http_headers();
</a><a href="#h2-3-123" id="h2-3-123" class="i">+		cgit_print_docstart();
</a><a href="#h2-3-124" id="h2-3-124" class="i">+		cgit_print_pageheader();
</a> 		cgit_print_error(&quot;No repository selected&quot;);
 		cgit_print_docend();
 		return;
 	}
 
<a href="#h2-3-130" id="h2-3-130" class="d">-	if (ctx-&gt;repo &amp;&amp; prepare_repo_cmd(ctx))
</a><a href="#h2-3-131" id="h2-3-131" class="i">+	if (ctx.repo &amp;&amp; prepare_repo_cmd())
</a> 		return;
 
 	if (cmd-&gt;want_layout) {
<a href="#h2-3-135" id="h2-3-135" class="d">-		cgit_print_http_headers(ctx);
</a><a href="#h2-3-136" id="h2-3-136" class="d">-		cgit_print_docstart(ctx);
</a><a href="#h2-3-137" id="h2-3-137" class="d">-		cgit_print_pageheader(ctx);
</a><a href="#h2-3-138" id="h2-3-138" class="i">+		cgit_print_http_headers();
</a><a href="#h2-3-139" id="h2-3-139" class="i">+		cgit_print_docstart();
</a><a href="#h2-3-140" id="h2-3-140" class="i">+		cgit_print_pageheader();
</a> 	}
 
<a href="#h2-3-143" id="h2-3-143" class="d">-	cmd-&gt;fn(ctx);
</a><a href="#h2-3-144" id="h2-3-144" class="i">+	cmd-&gt;fn();
</a> 
 	if (cmd-&gt;want_layout)
 		cgit_print_docend();
<a href="#h2-4" id="h2-4" class="h">@@ -995,7 +994,7 @@ int main(int argc, const char **argv)
</a> 	cgit_init_filters();
 	atexit(cgit_cleanup_filters);
 
<a href="#h2-4-3" id="h2-4-3" class="d">-	prepare_context(&amp;ctx);
</a><a href="#h2-4-4" id="h2-4-4" class="i">+	prepare_context();
</a> 	cgit_repolist.length = 0;
 	cgit_repolist.count = 0;
 	cgit_repolist.repos = NULL;
<a href="#h2-5" id="h2-5" class="h">@@ -1034,7 +1033,7 @@ int main(int argc, const char **argv)
</a> 	/* Before we go any further, we set ctx.env.authenticated by checking to see
 	 * if the supplied cookie is valid. All cookies are valid if there is no
 	 * auth_filter. If there is an auth_filter, the filter decides. */
<a href="#h2-5-3" id="h2-5-3" class="d">-	authenticate_cookie(&amp;ctx);
</a><a href="#h2-5-4" id="h2-5-4" class="i">+	authenticate_cookie();
</a> 
 	ttl = calc_ttl();
 	if (ttl &lt; 0)
<a href="#h2-6" id="h2-6" class="h">@@ -1046,7 +1045,8 @@ int main(int argc, const char **argv)
</a> 	if (ctx.cfg.nocache)
 		ctx.cfg.cache_size = 0;
 	err = cache_process(ctx.cfg.cache_size, ctx.cfg.cache_root,
<a href="#h2-6-3" id="h2-6-3" class="d">-			    ctx.qry.raw, ttl, process_request, &amp;ctx);
</a><a href="#h2-6-4" id="h2-6-4" class="i">+			    ctx.qry.raw, ttl, process_request);
</a><a href="#h2-6-5" id="h2-6-5" class="i">+	cgit_cleanup_filters();
</a> 	if (err)
 		cgit_print_error(&quot;Error processing page: %s (%d)&quot;,
 				 strerror(err), err);
<b>diff --git a/<a id="h3" href="../file/cmd.c.html">cmd.c</a> b/<a href="../file/cmd.c.html">cmd.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -26,120 +26,120 @@
</a> #include &quot;ui-tag.h&quot;
 #include &quot;ui-tree.h&quot;
 
<a href="#h3-0-3" id="h3-0-3" class="d">-static void HEAD_fn(struct cgit_context *ctx)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+static void HEAD_fn(void)
</a> {
<a href="#h3-0-6" id="h3-0-6" class="d">-	cgit_clone_head(ctx);
</a><a href="#h3-0-7" id="h3-0-7" class="i">+	cgit_clone_head();
</a> }
 
<a href="#h3-0-10" id="h3-0-10" class="d">-static void atom_fn(struct cgit_context *ctx)
</a><a href="#h3-0-11" id="h3-0-11" class="i">+static void atom_fn(void)
</a> {
<a href="#h3-0-13" id="h3-0-13" class="d">-	cgit_print_atom(ctx-&gt;qry.head, ctx-&gt;qry.path, ctx-&gt;cfg.max_atom_items);
</a><a href="#h3-0-14" id="h3-0-14" class="i">+	cgit_print_atom(ctx.qry.head, ctx.qry.path, ctx.cfg.max_atom_items);
</a> }
 
<a href="#h3-0-17" id="h3-0-17" class="d">-static void about_fn(struct cgit_context *ctx)
</a><a href="#h3-0-18" id="h3-0-18" class="i">+static void about_fn(void)
</a> {
<a href="#h3-0-20" id="h3-0-20" class="d">-	if (ctx-&gt;repo)
</a><a href="#h3-0-21" id="h3-0-21" class="d">-		cgit_print_repo_readme(ctx-&gt;qry.path);
</a><a href="#h3-0-22" id="h3-0-22" class="i">+	if (ctx.repo)
</a><a href="#h3-0-23" id="h3-0-23" class="i">+		cgit_print_repo_readme(ctx.qry.path);
</a> 	else
 		cgit_print_site_readme();
 }
 
<a href="#h3-0-28" id="h3-0-28" class="d">-static void blob_fn(struct cgit_context *ctx)
</a><a href="#h3-0-29" id="h3-0-29" class="i">+static void blob_fn(void)
</a> {
<a href="#h3-0-31" id="h3-0-31" class="d">-	cgit_print_blob(ctx-&gt;qry.sha1, ctx-&gt;qry.path, ctx-&gt;qry.head, 0);
</a><a href="#h3-0-32" id="h3-0-32" class="i">+	cgit_print_blob(ctx.qry.sha1, ctx.qry.path, ctx.qry.head, 0);
</a> }
 
<a href="#h3-0-35" id="h3-0-35" class="d">-static void commit_fn(struct cgit_context *ctx)
</a><a href="#h3-0-36" id="h3-0-36" class="i">+static void commit_fn(void)
</a> {
<a href="#h3-0-38" id="h3-0-38" class="d">-	cgit_print_commit(ctx-&gt;qry.sha1, ctx-&gt;qry.path);
</a><a href="#h3-0-39" id="h3-0-39" class="i">+	cgit_print_commit(ctx.qry.sha1, ctx.qry.path);
</a> }
 
<a href="#h3-0-42" id="h3-0-42" class="d">-static void diff_fn(struct cgit_context *ctx)
</a><a href="#h3-0-43" id="h3-0-43" class="i">+static void diff_fn(void)
</a> {
<a href="#h3-0-45" id="h3-0-45" class="d">-	cgit_print_diff(ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, ctx-&gt;qry.path, 1, 0);
</a><a href="#h3-0-46" id="h3-0-46" class="i">+	cgit_print_diff(ctx.qry.sha1, ctx.qry.sha2, ctx.qry.path, 1, 0);
</a> }
 
<a href="#h3-0-49" id="h3-0-49" class="d">-static void rawdiff_fn(struct cgit_context *ctx)
</a><a href="#h3-0-50" id="h3-0-50" class="i">+static void rawdiff_fn(void)
</a> {
<a href="#h3-0-52" id="h3-0-52" class="d">-	cgit_print_diff(ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, ctx-&gt;qry.path, 1, 1);
</a><a href="#h3-0-53" id="h3-0-53" class="i">+	cgit_print_diff(ctx.qry.sha1, ctx.qry.sha2, ctx.qry.path, 1, 1);
</a> }
 
<a href="#h3-0-56" id="h3-0-56" class="d">-static void info_fn(struct cgit_context *ctx)
</a><a href="#h3-0-57" id="h3-0-57" class="i">+static void info_fn(void)
</a> {
<a href="#h3-0-59" id="h3-0-59" class="d">-	cgit_clone_info(ctx);
</a><a href="#h3-0-60" id="h3-0-60" class="i">+	cgit_clone_info();
</a> }
 
<a href="#h3-0-63" id="h3-0-63" class="d">-static void log_fn(struct cgit_context *ctx)
</a><a href="#h3-0-64" id="h3-0-64" class="i">+static void log_fn(void)
</a> {
<a href="#h3-0-66" id="h3-0-66" class="d">-	cgit_print_log(ctx-&gt;qry.sha1, ctx-&gt;qry.ofs, ctx-&gt;cfg.max_commit_count,
</a><a href="#h3-0-67" id="h3-0-67" class="d">-		       ctx-&gt;qry.grep, ctx-&gt;qry.search, ctx-&gt;qry.path, 1,
</a><a href="#h3-0-68" id="h3-0-68" class="d">-		       ctx-&gt;repo-&gt;enable_commit_graph,
</a><a href="#h3-0-69" id="h3-0-69" class="d">-		       ctx-&gt;repo-&gt;commit_sort);
</a><a href="#h3-0-70" id="h3-0-70" class="i">+	cgit_print_log(ctx.qry.sha1, ctx.qry.ofs, ctx.cfg.max_commit_count,
</a><a href="#h3-0-71" id="h3-0-71" class="i">+		       ctx.qry.grep, ctx.qry.search, ctx.qry.path, 1,
</a><a href="#h3-0-72" id="h3-0-72" class="i">+		       ctx.repo-&gt;enable_commit_graph,
</a><a href="#h3-0-73" id="h3-0-73" class="i">+		       ctx.repo-&gt;commit_sort);
</a> }
 
<a href="#h3-0-76" id="h3-0-76" class="d">-static void ls_cache_fn(struct cgit_context *ctx)
</a><a href="#h3-0-77" id="h3-0-77" class="i">+static void ls_cache_fn(void)
</a> {
<a href="#h3-0-79" id="h3-0-79" class="d">-	ctx-&gt;page.mimetype = &quot;text/plain&quot;;
</a><a href="#h3-0-80" id="h3-0-80" class="d">-	ctx-&gt;page.filename = &quot;ls-cache.txt&quot;;
</a><a href="#h3-0-81" id="h3-0-81" class="d">-	cgit_print_http_headers(ctx);
</a><a href="#h3-0-82" id="h3-0-82" class="d">-	cache_ls(ctx-&gt;cfg.cache_root);
</a><a href="#h3-0-83" id="h3-0-83" class="i">+	ctx.page.mimetype = &quot;text/plain&quot;;
</a><a href="#h3-0-84" id="h3-0-84" class="i">+	ctx.page.filename = &quot;ls-cache.txt&quot;;
</a><a href="#h3-0-85" id="h3-0-85" class="i">+	cgit_print_http_headers();
</a><a href="#h3-0-86" id="h3-0-86" class="i">+	cache_ls(ctx.cfg.cache_root);
</a> }
 
<a href="#h3-0-89" id="h3-0-89" class="d">-static void objects_fn(struct cgit_context *ctx)
</a><a href="#h3-0-90" id="h3-0-90" class="i">+static void objects_fn(void)
</a> {
<a href="#h3-0-92" id="h3-0-92" class="d">-	cgit_clone_objects(ctx);
</a><a href="#h3-0-93" id="h3-0-93" class="i">+	cgit_clone_objects();
</a> }
 
<a href="#h3-0-96" id="h3-0-96" class="d">-static void repolist_fn(struct cgit_context *ctx)
</a><a href="#h3-0-97" id="h3-0-97" class="i">+static void repolist_fn(void)
</a> {
 	cgit_print_repolist();
 }
 
<a href="#h3-0-102" id="h3-0-102" class="d">-static void patch_fn(struct cgit_context *ctx)
</a><a href="#h3-0-103" id="h3-0-103" class="i">+static void patch_fn(void)
</a> {
<a href="#h3-0-105" id="h3-0-105" class="d">-	cgit_print_patch(ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, ctx-&gt;qry.path);
</a><a href="#h3-0-106" id="h3-0-106" class="i">+	cgit_print_patch(ctx.qry.sha1, ctx.qry.sha2, ctx.qry.path);
</a> }
 
<a href="#h3-0-109" id="h3-0-109" class="d">-static void plain_fn(struct cgit_context *ctx)
</a><a href="#h3-0-110" id="h3-0-110" class="i">+static void plain_fn(void)
</a> {
<a href="#h3-0-112" id="h3-0-112" class="d">-	cgit_print_plain(ctx);
</a><a href="#h3-0-113" id="h3-0-113" class="i">+	cgit_print_plain();
</a> }
 
<a href="#h3-0-116" id="h3-0-116" class="d">-static void refs_fn(struct cgit_context *ctx)
</a><a href="#h3-0-117" id="h3-0-117" class="i">+static void refs_fn(void)
</a> {
 	cgit_print_refs();
 }
 
<a href="#h3-0-122" id="h3-0-122" class="d">-static void snapshot_fn(struct cgit_context *ctx)
</a><a href="#h3-0-123" id="h3-0-123" class="i">+static void snapshot_fn(void)
</a> {
<a href="#h3-0-125" id="h3-0-125" class="d">-	cgit_print_snapshot(ctx-&gt;qry.head, ctx-&gt;qry.sha1, ctx-&gt;qry.path,
</a><a href="#h3-0-126" id="h3-0-126" class="d">-			    ctx-&gt;repo-&gt;snapshots, ctx-&gt;qry.nohead);
</a><a href="#h3-0-127" id="h3-0-127" class="i">+	cgit_print_snapshot(ctx.qry.head, ctx.qry.sha1, ctx.qry.path,
</a><a href="#h3-0-128" id="h3-0-128" class="i">+			    ctx.repo-&gt;snapshots, ctx.qry.nohead);
</a> }
 
<a href="#h3-0-131" id="h3-0-131" class="d">-static void stats_fn(struct cgit_context *ctx)
</a><a href="#h3-0-132" id="h3-0-132" class="i">+static void stats_fn(void)
</a> {
<a href="#h3-0-134" id="h3-0-134" class="d">-	cgit_show_stats(ctx);
</a><a href="#h3-0-135" id="h3-0-135" class="i">+	cgit_show_stats();
</a> }
 
<a href="#h3-0-138" id="h3-0-138" class="d">-static void summary_fn(struct cgit_context *ctx)
</a><a href="#h3-0-139" id="h3-0-139" class="i">+static void summary_fn(void)
</a> {
 	cgit_print_summary();
 }
 
<a href="#h3-0-144" id="h3-0-144" class="d">-static void tag_fn(struct cgit_context *ctx)
</a><a href="#h3-0-145" id="h3-0-145" class="i">+static void tag_fn(void)
</a> {
<a href="#h3-0-147" id="h3-0-147" class="d">-	cgit_print_tag(ctx-&gt;qry.sha1);
</a><a href="#h3-0-148" id="h3-0-148" class="i">+	cgit_print_tag(ctx.qry.sha1);
</a> }
 
<a href="#h3-0-151" id="h3-0-151" class="d">-static void tree_fn(struct cgit_context *ctx)
</a><a href="#h3-0-152" id="h3-0-152" class="i">+static void tree_fn(void)
</a> {
<a href="#h3-0-154" id="h3-0-154" class="d">-	cgit_print_tree(ctx-&gt;qry.sha1, ctx-&gt;qry.path);
</a><a href="#h3-0-155" id="h3-0-155" class="i">+	cgit_print_tree(ctx.qry.sha1, ctx.qry.path);
</a> }
 
 #define def_cmd(name, want_repo, want_layout, want_vpath, is_clone) \
 	{#name, name##_fn, want_repo, want_layout, want_vpath, is_clone}
 
<a href="#h3-0-161" id="h3-0-161" class="d">-struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx)
</a><a href="#h3-0-162" id="h3-0-162" class="i">+struct cgit_cmd *cgit_get_cmd(void)
</a> {
 	static struct cgit_cmd cmds[] = {
 		def_cmd(HEAD, 1, 0, 0, 1),
<a href="#h3-1" id="h3-1" class="h">@@ -165,15 +165,15 @@ struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx)
</a> 	};
 	int i;
 
<a href="#h3-1-3" id="h3-1-3" class="d">-	if (ctx-&gt;qry.page == NULL) {
</a><a href="#h3-1-4" id="h3-1-4" class="d">-		if (ctx-&gt;repo)
</a><a href="#h3-1-5" id="h3-1-5" class="d">-			ctx-&gt;qry.page = &quot;summary&quot;;
</a><a href="#h3-1-6" id="h3-1-6" class="i">+	if (ctx.qry.page == NULL) {
</a><a href="#h3-1-7" id="h3-1-7" class="i">+		if (ctx.repo)
</a><a href="#h3-1-8" id="h3-1-8" class="i">+			ctx.qry.page = &quot;summary&quot;;
</a> 		else
<a href="#h3-1-10" id="h3-1-10" class="d">-			ctx-&gt;qry.page = &quot;repolist&quot;;
</a><a href="#h3-1-11" id="h3-1-11" class="i">+			ctx.qry.page = &quot;repolist&quot;;
</a> 	}
 
 	for (i = 0; i &lt; sizeof(cmds)/sizeof(*cmds); i++)
<a href="#h3-1-15" id="h3-1-15" class="d">-		if (!strcmp(ctx-&gt;qry.page, cmds[i].name))
</a><a href="#h3-1-16" id="h3-1-16" class="i">+		if (!strcmp(ctx.qry.page, cmds[i].name))
</a> 			return &amp;cmds[i];
 	return NULL;
 }
<b>diff --git a/<a id="h4" href="../file/cmd.h.html">cmd.h</a> b/<a href="../file/cmd.h.html">cmd.h</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -1,7 +1,7 @@
</a> #ifndef CMD_H
 #define CMD_H
 
<a href="#h4-0-3" id="h4-0-3" class="d">-typedef void (*cgit_cmd_fn)(struct cgit_context *ctx);
</a><a href="#h4-0-4" id="h4-0-4" class="i">+typedef void (*cgit_cmd_fn)(void);
</a> 
 struct cgit_cmd {
 	const char *name;
<a href="#h4-1" id="h4-1" class="h">@@ -12,6 +12,6 @@ struct cgit_cmd {
</a> 		is_clone:1;
 };
 
<a href="#h4-1-3" id="h4-1-3" class="d">-extern struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx);
</a><a href="#h4-1-4" id="h4-1-4" class="i">+extern struct cgit_cmd *cgit_get_cmd(void);
</a> 
 #endif /* CMD_H */
<b>diff --git a/<a id="h5" href="../file/ui-atom.c.html">ui-atom.c</a> b/<a href="../file/ui-atom.c.html">ui-atom.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -108,7 +108,7 @@ void cgit_print_atom(char *tip, char *path, int max_count)
</a> 	host = cgit_hosturl();
 	ctx.page.mimetype = &quot;text/xml&quot;;
 	ctx.page.charset = &quot;utf-8&quot;;
<a href="#h5-0-3" id="h5-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h5-0-4" id="h5-0-4" class="i">+	cgit_print_http_headers();
</a> 	html(&quot;&lt;feed xmlns=&#39;http://www.w3.org/2005/Atom&#39;&gt;\n&quot;);
 	html(&quot;&lt;title&gt;&quot;);
 	html_txt(ctx.repo-&gt;name);
<b>diff --git a/<a id="h6" href="../file/ui-blob.c.html">ui-blob.c</a> b/<a href="../file/ui-blob.c.html">ui-blob.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -164,6 +164,6 @@ void cgit_print_blob(const char *hex, char *path, const char *head, int file_onl
</a> 			ctx.page.mimetype = &quot;text/plain&quot;;
 	}
 	ctx.page.filename = path;
<a href="#h6-0-3" id="h6-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h6-0-4" id="h6-0-4" class="i">+	cgit_print_http_headers();
</a> 	html_raw(buf, size);
 }
<b>diff --git a/<a id="h7" href="../file/ui-clone.c.html">ui-clone.c</a> b/<a href="../file/ui-clone.c.html">ui-clone.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -29,22 +29,22 @@ static int print_ref_info(const char *refname, const unsigned char *sha1,
</a> 	return 0;
 }
 
<a href="#h7-0-3" id="h7-0-3" class="d">-static void print_pack_info(struct cgit_context *ctx)
</a><a href="#h7-0-4" id="h7-0-4" class="i">+static void print_pack_info(void)
</a> {
 	struct packed_git *pack;
 	int ofs;
 
<a href="#h7-0-9" id="h7-0-9" class="d">-	ctx-&gt;page.mimetype = &quot;text/plain&quot;;
</a><a href="#h7-0-10" id="h7-0-10" class="d">-	ctx-&gt;page.filename = &quot;objects/info/packs&quot;;
</a><a href="#h7-0-11" id="h7-0-11" class="d">-	cgit_print_http_headers(ctx);
</a><a href="#h7-0-12" id="h7-0-12" class="d">-	ofs = strlen(ctx-&gt;repo-&gt;path) + strlen(&quot;/objects/pack/&quot;);
</a><a href="#h7-0-13" id="h7-0-13" class="i">+	ctx.page.mimetype = &quot;text/plain&quot;;
</a><a href="#h7-0-14" id="h7-0-14" class="i">+	ctx.page.filename = &quot;objects/info/packs&quot;;
</a><a href="#h7-0-15" id="h7-0-15" class="i">+	cgit_print_http_headers();
</a><a href="#h7-0-16" id="h7-0-16" class="i">+	ofs = strlen(ctx.repo-&gt;path) + strlen(&quot;/objects/pack/&quot;);
</a> 	prepare_packed_git();
 	for (pack = packed_git; pack; pack = pack-&gt;next)
 		if (pack-&gt;pack_local)
 			htmlf(&quot;P %s\n&quot;, pack-&gt;pack_name + ofs);
 }
 
<a href="#h7-0-23" id="h7-0-23" class="d">-static void send_file(struct cgit_context *ctx, char *path)
</a><a href="#h7-0-24" id="h7-0-24" class="i">+static void send_file(char *path)
</a> {
 	struct stat st;
 
<a href="#h7-1" id="h7-1" class="h">@@ -61,41 +61,41 @@ static void send_file(struct cgit_context *ctx, char *path)
</a> 		}
 		return;
 	}
<a href="#h7-1-3" id="h7-1-3" class="d">-	ctx-&gt;page.mimetype = &quot;application/octet-stream&quot;;
</a><a href="#h7-1-4" id="h7-1-4" class="d">-	ctx-&gt;page.filename = path;
</a><a href="#h7-1-5" id="h7-1-5" class="d">-	if (prefixcmp(ctx-&gt;repo-&gt;path, path))
</a><a href="#h7-1-6" id="h7-1-6" class="d">-		ctx-&gt;page.filename += strlen(ctx-&gt;repo-&gt;path) + 1;
</a><a href="#h7-1-7" id="h7-1-7" class="d">-	cgit_print_http_headers(ctx);
</a><a href="#h7-1-8" id="h7-1-8" class="i">+	ctx.page.mimetype = &quot;application/octet-stream&quot;;
</a><a href="#h7-1-9" id="h7-1-9" class="i">+	ctx.page.filename = path;
</a><a href="#h7-1-10" id="h7-1-10" class="i">+	if (prefixcmp(ctx.repo-&gt;path, path))
</a><a href="#h7-1-11" id="h7-1-11" class="i">+		ctx.page.filename += strlen(ctx.repo-&gt;path) + 1;
</a><a href="#h7-1-12" id="h7-1-12" class="i">+	cgit_print_http_headers();
</a> 	html_include(path);
 }
 
<a href="#h7-1-16" id="h7-1-16" class="d">-void cgit_clone_info(struct cgit_context *ctx)
</a><a href="#h7-1-17" id="h7-1-17" class="i">+void cgit_clone_info(void)
</a> {
<a href="#h7-1-19" id="h7-1-19" class="d">-	if (!ctx-&gt;qry.path || strcmp(ctx-&gt;qry.path, &quot;refs&quot;))
</a><a href="#h7-1-20" id="h7-1-20" class="i">+	if (!ctx.qry.path || strcmp(ctx.qry.path, &quot;refs&quot;))
</a> 		return;
 
<a href="#h7-1-23" id="h7-1-23" class="d">-	ctx-&gt;page.mimetype = &quot;text/plain&quot;;
</a><a href="#h7-1-24" id="h7-1-24" class="d">-	ctx-&gt;page.filename = &quot;info/refs&quot;;
</a><a href="#h7-1-25" id="h7-1-25" class="d">-	cgit_print_http_headers(ctx);
</a><a href="#h7-1-26" id="h7-1-26" class="d">-	for_each_ref(print_ref_info, ctx);
</a><a href="#h7-1-27" id="h7-1-27" class="i">+	ctx.page.mimetype = &quot;text/plain&quot;;
</a><a href="#h7-1-28" id="h7-1-28" class="i">+	ctx.page.filename = &quot;info/refs&quot;;
</a><a href="#h7-1-29" id="h7-1-29" class="i">+	cgit_print_http_headers();
</a><a href="#h7-1-30" id="h7-1-30" class="i">+	for_each_ref(print_ref_info, NULL);
</a> }
 
<a href="#h7-1-33" id="h7-1-33" class="d">-void cgit_clone_objects(struct cgit_context *ctx)
</a><a href="#h7-1-34" id="h7-1-34" class="i">+void cgit_clone_objects(void)
</a> {
<a href="#h7-1-36" id="h7-1-36" class="d">-	if (!ctx-&gt;qry.path) {
</a><a href="#h7-1-37" id="h7-1-37" class="i">+	if (!ctx.qry.path) {
</a> 		html_status(400, &quot;Bad request&quot;, 0);
 		return;
 	}
 
<a href="#h7-1-42" id="h7-1-42" class="d">-	if (!strcmp(ctx-&gt;qry.path, &quot;info/packs&quot;)) {
</a><a href="#h7-1-43" id="h7-1-43" class="d">-		print_pack_info(ctx);
</a><a href="#h7-1-44" id="h7-1-44" class="i">+	if (!strcmp(ctx.qry.path, &quot;info/packs&quot;)) {
</a><a href="#h7-1-45" id="h7-1-45" class="i">+		print_pack_info();
</a> 		return;
 	}
 
<a href="#h7-1-49" id="h7-1-49" class="d">-	send_file(ctx, git_path(&quot;objects/%s&quot;, ctx-&gt;qry.path));
</a><a href="#h7-1-50" id="h7-1-50" class="i">+	send_file(git_path(&quot;objects/%s&quot;, ctx.qry.path));
</a> }
 
<a href="#h7-1-53" id="h7-1-53" class="d">-void cgit_clone_head(struct cgit_context *ctx)
</a><a href="#h7-1-54" id="h7-1-54" class="i">+void cgit_clone_head(void)
</a> {
<a href="#h7-1-56" id="h7-1-56" class="d">-	send_file(ctx, git_path(&quot;%s&quot;, &quot;HEAD&quot;));
</a><a href="#h7-1-57" id="h7-1-57" class="i">+	send_file(git_path(&quot;%s&quot;, &quot;HEAD&quot;));
</a> }
<b>diff --git a/<a id="h8" href="../file/ui-clone.h.html">ui-clone.h</a> b/<a href="../file/ui-clone.h.html">ui-clone.h</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -1,8 +1,8 @@
</a> #ifndef UI_CLONE_H
 #define UI_CLONE_H
 
<a href="#h8-0-3" id="h8-0-3" class="d">-void cgit_clone_info(struct cgit_context *ctx);
</a><a href="#h8-0-4" id="h8-0-4" class="d">-void cgit_clone_objects(struct cgit_context *ctx);
</a><a href="#h8-0-5" id="h8-0-5" class="d">-void cgit_clone_head(struct cgit_context *ctx);
</a><a href="#h8-0-6" id="h8-0-6" class="i">+void cgit_clone_info(void);
</a><a href="#h8-0-7" id="h8-0-7" class="i">+void cgit_clone_objects(void);
</a><a href="#h8-0-8" id="h8-0-8" class="i">+void cgit_clone_head(void);
</a> 
 #endif /* UI_CLONE_H */
<b>diff --git a/<a id="h9" href="../file/ui-diff.c.html">ui-diff.c</a> b/<a href="../file/ui-diff.c.html">ui-diff.c</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -407,7 +407,7 @@ void cgit_print_diff(const char *new_rev, const char *old_rev,
</a> 		diff_setup_done(&amp;diffopt);
 
 		ctx.page.mimetype = &quot;text/plain&quot;;
<a href="#h9-0-3" id="h9-0-3" class="d">-		cgit_print_http_headers(&amp;ctx);
</a><a href="#h9-0-4" id="h9-0-4" class="i">+		cgit_print_http_headers();
</a> 		if (old_tree_sha1) {
 			diff_tree_sha1(old_tree_sha1, new_tree_sha1, &quot;&quot;,
 				       &amp;diffopt);
<b>diff --git a/<a id="h10" href="../file/ui-patch.c.html">ui-patch.c</a> b/<a href="../file/ui-patch.c.html">ui-patch.c</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -59,7 +59,7 @@ void cgit_print_patch(const char *new_rev, const char *old_rev,
</a> 	patchname = fmt(&quot;%s.patch&quot;, rev_range);
 	ctx.page.mimetype = &quot;text/plain&quot;;
 	ctx.page.filename = patchname;
<a href="#h10-0-3" id="h10-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h10-0-4" id="h10-0-4" class="i">+	cgit_print_http_headers();
</a> 
 	if (ctx.cfg.noplainemail) {
 		rev_argv[2] = &quot;--format=format:From %H Mon Sep 17 00:00:00 &quot;
<b>diff --git a/<a id="h11" href="../file/ui-plain.c.html">ui-plain.c</a> b/<a href="../file/ui-plain.c.html">ui-plain.c</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -103,7 +103,7 @@ static int print_object(const unsigned char *sha1, const char *path)
</a> 	ctx.page.filename = path;
 	ctx.page.size = size;
 	ctx.page.etag = sha1_to_hex(sha1);
<a href="#h11-0-3" id="h11-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h11-0-4" id="h11-0-4" class="i">+	cgit_print_http_headers();
</a> 	html_raw(buf, size);
 	/* If we allocated this, then casting away const is safe. */
 	if (freemime)
<a href="#h11-1" id="h11-1" class="h">@@ -128,7 +128,7 @@ static void print_dir(const unsigned char *sha1, const char *base,
</a> 	fullpath = buildpath(base, baselen, path);
 	slash = (fullpath[0] == &#39;/&#39; ? &quot;&quot; : &quot;/&quot;);
 	ctx.page.etag = sha1_to_hex(sha1);
<a href="#h11-1-3" id="h11-1-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h11-1-4" id="h11-1-4" class="i">+	cgit_print_http_headers();
</a> 	htmlf(&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;%s&quot;, slash);
 	html_txt(fullpath);
 	htmlf(&quot;&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;h2&gt;%s&quot;, slash);
<a href="#h11-2" id="h11-2" class="h">@@ -206,14 +206,14 @@ static int basedir_len(const char *path)
</a> 	return 0;
 }
 
<a href="#h11-2-3" id="h11-2-3" class="d">-void cgit_print_plain(struct cgit_context *ctx)
</a><a href="#h11-2-4" id="h11-2-4" class="i">+void cgit_print_plain(void)
</a> {
<a href="#h11-2-6" id="h11-2-6" class="d">-	const char *rev = ctx-&gt;qry.sha1;
</a><a href="#h11-2-7" id="h11-2-7" class="i">+	const char *rev = ctx.qry.sha1;
</a> 	unsigned char sha1[20];
 	struct commit *commit;
 	struct pathspec_item path_items = {
<a href="#h11-2-11" id="h11-2-11" class="d">-		.match = ctx-&gt;qry.path,
</a><a href="#h11-2-12" id="h11-2-12" class="d">-		.len = ctx-&gt;qry.path ? strlen(ctx-&gt;qry.path) : 0
</a><a href="#h11-2-13" id="h11-2-13" class="i">+		.match = ctx.qry.path,
</a><a href="#h11-2-14" id="h11-2-14" class="i">+		.len = ctx.qry.path ? strlen(ctx.qry.path) : 0
</a> 	};
 	struct pathspec paths = {
 		.nr = 1,
<a href="#h11-3" id="h11-3" class="h">@@ -224,7 +224,7 @@ void cgit_print_plain(struct cgit_context *ctx)
</a> 	};
 
 	if (!rev)
<a href="#h11-3-3" id="h11-3-3" class="d">-		rev = ctx-&gt;qry.head;
</a><a href="#h11-3-4" id="h11-3-4" class="i">+		rev = ctx.qry.head;
</a> 
 	if (get_sha1(rev, sha1)) {
 		html_status(404, &quot;Not found&quot;, 0);
<b>diff --git a/<a id="h12" href="../file/ui-plain.h.html">ui-plain.h</a> b/<a href="../file/ui-plain.h.html">ui-plain.h</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -1,6 +1,6 @@
</a> #ifndef UI_PLAIN_H
 #define UI_PLAIN_H
 
<a href="#h12-0-3" id="h12-0-3" class="d">-extern void cgit_print_plain(struct cgit_context *ctx);
</a><a href="#h12-0-4" id="h12-0-4" class="i">+extern void cgit_print_plain(void);
</a> 
 #endif /* UI_PLAIN_H */
<b>diff --git a/<a id="h13" href="../file/ui-repolist.c.html">ui-repolist.c</a> b/<a href="../file/ui-repolist.c.html">ui-repolist.c</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -259,9 +259,9 @@ void cgit_print_repolist()
</a> 		++columns;
 
 	ctx.page.title = ctx.cfg.root_title;
<a href="#h13-0-3" id="h13-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h13-0-4" id="h13-0-4" class="d">-	cgit_print_docstart(&amp;ctx);
</a><a href="#h13-0-5" id="h13-0-5" class="d">-	cgit_print_pageheader(&amp;ctx);
</a><a href="#h13-0-6" id="h13-0-6" class="i">+	cgit_print_http_headers();
</a><a href="#h13-0-7" id="h13-0-7" class="i">+	cgit_print_docstart();
</a><a href="#h13-0-8" id="h13-0-8" class="i">+	cgit_print_pageheader();
</a> 
 	if (ctx.cfg.index_header)
 		html_include(ctx.cfg.index_header);
<b>diff --git a/<a id="h14" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -436,59 +436,58 @@ void cgit_stats_link(const char *name, const char *title, const char *class,
</a> 	reporevlink(&quot;stats&quot;, name, title, class, head, NULL, path);
 }
 
<a href="#h14-0-3" id="h14-0-3" class="d">-static void cgit_self_link(char *name, const char *title, const char *class,
</a><a href="#h14-0-4" id="h14-0-4" class="d">-			   struct cgit_context *ctx)
</a><a href="#h14-0-5" id="h14-0-5" class="d">-{
</a><a href="#h14-0-6" id="h14-0-6" class="d">-	if (!strcmp(ctx-&gt;qry.page, &quot;repolist&quot;))
</a><a href="#h14-0-7" id="h14-0-7" class="d">-		cgit_index_link(name, title, class, ctx-&gt;qry.search, ctx-&gt;qry.sort,
</a><a href="#h14-0-8" id="h14-0-8" class="d">-				ctx-&gt;qry.ofs);
</a><a href="#h14-0-9" id="h14-0-9" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;summary&quot;))
</a><a href="#h14-0-10" id="h14-0-10" class="d">-		cgit_summary_link(name, title, class, ctx-&gt;qry.head);
</a><a href="#h14-0-11" id="h14-0-11" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;tag&quot;))
</a><a href="#h14-0-12" id="h14-0-12" class="d">-		cgit_tag_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-13" id="h14-0-13" class="d">-			      ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL);
</a><a href="#h14-0-14" id="h14-0-14" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;tree&quot;))
</a><a href="#h14-0-15" id="h14-0-15" class="d">-		cgit_tree_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-16" id="h14-0-16" class="d">-			       ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-17" id="h14-0-17" class="d">-			       ctx-&gt;qry.path);
</a><a href="#h14-0-18" id="h14-0-18" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;plain&quot;))
</a><a href="#h14-0-19" id="h14-0-19" class="d">-		cgit_plain_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-20" id="h14-0-20" class="d">-				ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-21" id="h14-0-21" class="d">-				ctx-&gt;qry.path);
</a><a href="#h14-0-22" id="h14-0-22" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;log&quot;))
</a><a href="#h14-0-23" id="h14-0-23" class="d">-		cgit_log_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-24" id="h14-0-24" class="d">-			      ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-25" id="h14-0-25" class="d">-			      ctx-&gt;qry.path, ctx-&gt;qry.ofs,
</a><a href="#h14-0-26" id="h14-0-26" class="d">-			      ctx-&gt;qry.grep, ctx-&gt;qry.search,
</a><a href="#h14-0-27" id="h14-0-27" class="d">-			      ctx-&gt;qry.showmsg);
</a><a href="#h14-0-28" id="h14-0-28" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;commit&quot;))
</a><a href="#h14-0-29" id="h14-0-29" class="d">-		cgit_commit_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-30" id="h14-0-30" class="d">-				 ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-31" id="h14-0-31" class="d">-				 ctx-&gt;qry.path, 0);
</a><a href="#h14-0-32" id="h14-0-32" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;patch&quot;))
</a><a href="#h14-0-33" id="h14-0-33" class="d">-		cgit_patch_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-34" id="h14-0-34" class="d">-				ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-35" id="h14-0-35" class="d">-				ctx-&gt;qry.path);
</a><a href="#h14-0-36" id="h14-0-36" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;refs&quot;))
</a><a href="#h14-0-37" id="h14-0-37" class="d">-		cgit_refs_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-38" id="h14-0-38" class="d">-			       ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-39" id="h14-0-39" class="d">-			       ctx-&gt;qry.path);
</a><a href="#h14-0-40" id="h14-0-40" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;snapshot&quot;))
</a><a href="#h14-0-41" id="h14-0-41" class="d">-		cgit_snapshot_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-42" id="h14-0-42" class="d">-				   ctx-&gt;qry.has_sha1 ? ctx-&gt;qry.sha1 : NULL,
</a><a href="#h14-0-43" id="h14-0-43" class="d">-				   ctx-&gt;qry.path);
</a><a href="#h14-0-44" id="h14-0-44" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;diff&quot;))
</a><a href="#h14-0-45" id="h14-0-45" class="d">-		cgit_diff_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-46" id="h14-0-46" class="d">-			       ctx-&gt;qry.sha1, ctx-&gt;qry.sha2,
</a><a href="#h14-0-47" id="h14-0-47" class="d">-			       ctx-&gt;qry.path, 0);
</a><a href="#h14-0-48" id="h14-0-48" class="d">-	else if (!strcmp(ctx-&gt;qry.page, &quot;stats&quot;))
</a><a href="#h14-0-49" id="h14-0-49" class="d">-		cgit_stats_link(name, title, class, ctx-&gt;qry.head,
</a><a href="#h14-0-50" id="h14-0-50" class="d">-				ctx-&gt;qry.path);
</a><a href="#h14-0-51" id="h14-0-51" class="i">+static void cgit_self_link(char *name, const char *title, const char *class)
</a><a href="#h14-0-52" id="h14-0-52" class="i">+{
</a><a href="#h14-0-53" id="h14-0-53" class="i">+	if (!strcmp(ctx.qry.page, &quot;repolist&quot;))
</a><a href="#h14-0-54" id="h14-0-54" class="i">+		cgit_index_link(name, title, class, ctx.qry.search, ctx.qry.sort,
</a><a href="#h14-0-55" id="h14-0-55" class="i">+				ctx.qry.ofs);
</a><a href="#h14-0-56" id="h14-0-56" class="i">+	else if (!strcmp(ctx.qry.page, &quot;summary&quot;))
</a><a href="#h14-0-57" id="h14-0-57" class="i">+		cgit_summary_link(name, title, class, ctx.qry.head);
</a><a href="#h14-0-58" id="h14-0-58" class="i">+	else if (!strcmp(ctx.qry.page, &quot;tag&quot;))
</a><a href="#h14-0-59" id="h14-0-59" class="i">+		cgit_tag_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-60" id="h14-0-60" class="i">+			      ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL);
</a><a href="#h14-0-61" id="h14-0-61" class="i">+	else if (!strcmp(ctx.qry.page, &quot;tree&quot;))
</a><a href="#h14-0-62" id="h14-0-62" class="i">+		cgit_tree_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-63" id="h14-0-63" class="i">+			       ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-64" id="h14-0-64" class="i">+			       ctx.qry.path);
</a><a href="#h14-0-65" id="h14-0-65" class="i">+	else if (!strcmp(ctx.qry.page, &quot;plain&quot;))
</a><a href="#h14-0-66" id="h14-0-66" class="i">+		cgit_plain_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-67" id="h14-0-67" class="i">+				ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-68" id="h14-0-68" class="i">+				ctx.qry.path);
</a><a href="#h14-0-69" id="h14-0-69" class="i">+	else if (!strcmp(ctx.qry.page, &quot;log&quot;))
</a><a href="#h14-0-70" id="h14-0-70" class="i">+		cgit_log_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-71" id="h14-0-71" class="i">+			      ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-72" id="h14-0-72" class="i">+			      ctx.qry.path, ctx.qry.ofs,
</a><a href="#h14-0-73" id="h14-0-73" class="i">+			      ctx.qry.grep, ctx.qry.search,
</a><a href="#h14-0-74" id="h14-0-74" class="i">+			      ctx.qry.showmsg);
</a><a href="#h14-0-75" id="h14-0-75" class="i">+	else if (!strcmp(ctx.qry.page, &quot;commit&quot;))
</a><a href="#h14-0-76" id="h14-0-76" class="i">+		cgit_commit_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-77" id="h14-0-77" class="i">+				 ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-78" id="h14-0-78" class="i">+				 ctx.qry.path, 0);
</a><a href="#h14-0-79" id="h14-0-79" class="i">+	else if (!strcmp(ctx.qry.page, &quot;patch&quot;))
</a><a href="#h14-0-80" id="h14-0-80" class="i">+		cgit_patch_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-81" id="h14-0-81" class="i">+				ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-82" id="h14-0-82" class="i">+				ctx.qry.path);
</a><a href="#h14-0-83" id="h14-0-83" class="i">+	else if (!strcmp(ctx.qry.page, &quot;refs&quot;))
</a><a href="#h14-0-84" id="h14-0-84" class="i">+		cgit_refs_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-85" id="h14-0-85" class="i">+			       ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-86" id="h14-0-86" class="i">+			       ctx.qry.path);
</a><a href="#h14-0-87" id="h14-0-87" class="i">+	else if (!strcmp(ctx.qry.page, &quot;snapshot&quot;))
</a><a href="#h14-0-88" id="h14-0-88" class="i">+		cgit_snapshot_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-89" id="h14-0-89" class="i">+				   ctx.qry.has_sha1 ? ctx.qry.sha1 : NULL,
</a><a href="#h14-0-90" id="h14-0-90" class="i">+				   ctx.qry.path);
</a><a href="#h14-0-91" id="h14-0-91" class="i">+	else if (!strcmp(ctx.qry.page, &quot;diff&quot;))
</a><a href="#h14-0-92" id="h14-0-92" class="i">+		cgit_diff_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-93" id="h14-0-93" class="i">+			       ctx.qry.sha1, ctx.qry.sha2,
</a><a href="#h14-0-94" id="h14-0-94" class="i">+			       ctx.qry.path, 0);
</a><a href="#h14-0-95" id="h14-0-95" class="i">+	else if (!strcmp(ctx.qry.page, &quot;stats&quot;))
</a><a href="#h14-0-96" id="h14-0-96" class="i">+		cgit_stats_link(name, title, class, ctx.qry.head,
</a><a href="#h14-0-97" id="h14-0-97" class="i">+				ctx.qry.path);
</a> 	else {
 		/* Don&#39;t known how to make link for this page */
<a href="#h14-0-100" id="h14-0-100" class="d">-		repolink(title, class, ctx-&gt;qry.page, ctx-&gt;qry.head, ctx-&gt;qry.path);
</a><a href="#h14-0-101" id="h14-0-101" class="i">+		repolink(title, class, ctx.qry.page, ctx.qry.head, ctx.qry.path);
</a> 		html(&quot;&gt;&lt;!-- cgit_self_link() doesn&#39;t know how to make link for page &#39;&quot;);
<a href="#h14-0-103" id="h14-0-103" class="d">-		html_txt(ctx-&gt;qry.page);
</a><a href="#h14-0-104" id="h14-0-104" class="i">+		html_txt(ctx.qry.page);
</a> 		html(&quot;&#39; --&gt;&quot;);
 		html_txt(name);
 		html(&quot;&lt;/a&gt;&quot;);
<a href="#h14-1" id="h14-1" class="h">@@ -632,39 +631,39 @@ void cgit_print_age(time_t t, time_t max_relative, const char *format)
</a> 	      secs * 1.0 / TM_YEAR);
 }
 
<a href="#h14-1-3" id="h14-1-3" class="d">-void cgit_print_http_headers(struct cgit_context *ctx)
</a><a href="#h14-1-4" id="h14-1-4" class="i">+void cgit_print_http_headers(void)
</a> {
<a href="#h14-1-6" id="h14-1-6" class="d">-	if (ctx-&gt;env.no_http &amp;&amp; !strcmp(ctx-&gt;env.no_http, &quot;1&quot;))
</a><a href="#h14-1-7" id="h14-1-7" class="i">+	if (ctx.env.no_http &amp;&amp; !strcmp(ctx.env.no_http, &quot;1&quot;))
</a> 		return;
 
<a href="#h14-1-10" id="h14-1-10" class="d">-	if (ctx-&gt;page.status)
</a><a href="#h14-1-11" id="h14-1-11" class="d">-		htmlf(&quot;Status: %d %s\n&quot;, ctx-&gt;page.status, ctx-&gt;page.statusmsg);
</a><a href="#h14-1-12" id="h14-1-12" class="d">-	if (ctx-&gt;page.mimetype &amp;&amp; ctx-&gt;page.charset)
</a><a href="#h14-1-13" id="h14-1-13" class="d">-		htmlf(&quot;Content-Type: %s; charset=%s\n&quot;, ctx-&gt;page.mimetype,
</a><a href="#h14-1-14" id="h14-1-14" class="d">-		      ctx-&gt;page.charset);
</a><a href="#h14-1-15" id="h14-1-15" class="d">-	else if (ctx-&gt;page.mimetype)
</a><a href="#h14-1-16" id="h14-1-16" class="d">-		htmlf(&quot;Content-Type: %s\n&quot;, ctx-&gt;page.mimetype);
</a><a href="#h14-1-17" id="h14-1-17" class="d">-	if (ctx-&gt;page.size)
</a><a href="#h14-1-18" id="h14-1-18" class="d">-		htmlf(&quot;Content-Length: %zd\n&quot;, ctx-&gt;page.size);
</a><a href="#h14-1-19" id="h14-1-19" class="d">-	if (ctx-&gt;page.filename)
</a><a href="#h14-1-20" id="h14-1-20" class="i">+	if (ctx.page.status)
</a><a href="#h14-1-21" id="h14-1-21" class="i">+		htmlf(&quot;Status: %d %s\n&quot;, ctx.page.status, ctx.page.statusmsg);
</a><a href="#h14-1-22" id="h14-1-22" class="i">+	if (ctx.page.mimetype &amp;&amp; ctx.page.charset)
</a><a href="#h14-1-23" id="h14-1-23" class="i">+		htmlf(&quot;Content-Type: %s; charset=%s\n&quot;, ctx.page.mimetype,
</a><a href="#h14-1-24" id="h14-1-24" class="i">+		      ctx.page.charset);
</a><a href="#h14-1-25" id="h14-1-25" class="i">+	else if (ctx.page.mimetype)
</a><a href="#h14-1-26" id="h14-1-26" class="i">+		htmlf(&quot;Content-Type: %s\n&quot;, ctx.page.mimetype);
</a><a href="#h14-1-27" id="h14-1-27" class="i">+	if (ctx.page.size)
</a><a href="#h14-1-28" id="h14-1-28" class="i">+		htmlf(&quot;Content-Length: %zd\n&quot;, ctx.page.size);
</a><a href="#h14-1-29" id="h14-1-29" class="i">+	if (ctx.page.filename)
</a> 		htmlf(&quot;Content-Disposition: inline; filename=\&quot;%s\&quot;\n&quot;,
<a href="#h14-1-31" id="h14-1-31" class="d">-		      ctx-&gt;page.filename);
</a><a href="#h14-1-32" id="h14-1-32" class="d">-	if (!ctx-&gt;env.authenticated)
</a><a href="#h14-1-33" id="h14-1-33" class="i">+		      ctx.page.filename);
</a><a href="#h14-1-34" id="h14-1-34" class="i">+	if (!ctx.env.authenticated)
</a> 		html(&quot;Cache-Control: no-cache, no-store\n&quot;);
<a href="#h14-1-36" id="h14-1-36" class="d">-	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(ctx-&gt;page.modified));
</a><a href="#h14-1-37" id="h14-1-37" class="d">-	htmlf(&quot;Expires: %s\n&quot;, http_date(ctx-&gt;page.expires));
</a><a href="#h14-1-38" id="h14-1-38" class="d">-	if (ctx-&gt;page.etag)
</a><a href="#h14-1-39" id="h14-1-39" class="d">-		htmlf(&quot;ETag: \&quot;%s\&quot;\n&quot;, ctx-&gt;page.etag);
</a><a href="#h14-1-40" id="h14-1-40" class="i">+	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(ctx.page.modified));
</a><a href="#h14-1-41" id="h14-1-41" class="i">+	htmlf(&quot;Expires: %s\n&quot;, http_date(ctx.page.expires));
</a><a href="#h14-1-42" id="h14-1-42" class="i">+	if (ctx.page.etag)
</a><a href="#h14-1-43" id="h14-1-43" class="i">+		htmlf(&quot;ETag: \&quot;%s\&quot;\n&quot;, ctx.page.etag);
</a> 	html(&quot;\n&quot;);
<a href="#h14-1-45" id="h14-1-45" class="d">-	if (ctx-&gt;env.request_method &amp;&amp; !strcmp(ctx-&gt;env.request_method, &quot;HEAD&quot;))
</a><a href="#h14-1-46" id="h14-1-46" class="i">+	if (ctx.env.request_method &amp;&amp; !strcmp(ctx.env.request_method, &quot;HEAD&quot;))
</a> 		exit(0);
 }
 
<a href="#h14-1-50" id="h14-1-50" class="d">-void cgit_print_docstart(struct cgit_context *ctx)
</a><a href="#h14-1-51" id="h14-1-51" class="i">+void cgit_print_docstart(void)
</a> {
<a href="#h14-1-53" id="h14-1-53" class="d">-	if (ctx-&gt;cfg.embedded) {
</a><a href="#h14-1-54" id="h14-1-54" class="d">-		if (ctx-&gt;cfg.header)
</a><a href="#h14-1-55" id="h14-1-55" class="d">-			html_include(ctx-&gt;cfg.header);
</a><a href="#h14-1-56" id="h14-1-56" class="i">+	if (ctx.cfg.embedded) {
</a><a href="#h14-1-57" id="h14-1-57" class="i">+		if (ctx.cfg.header)
</a><a href="#h14-1-58" id="h14-1-58" class="i">+			html_include(ctx.cfg.header);
</a> 		return;
 	}
 
<a href="#h14-2" id="h14-2" class="h">@@ -673,37 +672,37 @@ void cgit_print_docstart(struct cgit_context *ctx)
</a> 	html(&quot;&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n&quot;);
 	html(&quot;&lt;head&gt;\n&quot;);
 	html(&quot;&lt;title&gt;&quot;);
<a href="#h14-2-3" id="h14-2-3" class="d">-	html_txt(ctx-&gt;page.title);
</a><a href="#h14-2-4" id="h14-2-4" class="i">+	html_txt(ctx.page.title);
</a> 	html(&quot;&lt;/title&gt;\n&quot;);
 	htmlf(&quot;&lt;meta name=&#39;generator&#39; content=&#39;cgit %s&#39;/&gt;\n&quot;, cgit_version);
<a href="#h14-2-7" id="h14-2-7" class="d">-	if (ctx-&gt;cfg.robots &amp;&amp; *ctx-&gt;cfg.robots)
</a><a href="#h14-2-8" id="h14-2-8" class="d">-		htmlf(&quot;&lt;meta name=&#39;robots&#39; content=&#39;%s&#39;/&gt;\n&quot;, ctx-&gt;cfg.robots);
</a><a href="#h14-2-9" id="h14-2-9" class="i">+	if (ctx.cfg.robots &amp;&amp; *ctx.cfg.robots)
</a><a href="#h14-2-10" id="h14-2-10" class="i">+		htmlf(&quot;&lt;meta name=&#39;robots&#39; content=&#39;%s&#39;/&gt;\n&quot;, ctx.cfg.robots);
</a> 	html(&quot;&lt;link rel=&#39;stylesheet&#39; type=&#39;text/css&#39; href=&#39;&quot;);
<a href="#h14-2-12" id="h14-2-12" class="d">-	html_attr(ctx-&gt;cfg.css);
</a><a href="#h14-2-13" id="h14-2-13" class="i">+	html_attr(ctx.cfg.css);
</a> 	html(&quot;&#39;/&gt;\n&quot;);
<a href="#h14-2-15" id="h14-2-15" class="d">-	if (ctx-&gt;cfg.favicon) {
</a><a href="#h14-2-16" id="h14-2-16" class="i">+	if (ctx.cfg.favicon) {
</a> 		html(&quot;&lt;link rel=&#39;shortcut icon&#39; href=&#39;&quot;);
<a href="#h14-2-18" id="h14-2-18" class="d">-		html_attr(ctx-&gt;cfg.favicon);
</a><a href="#h14-2-19" id="h14-2-19" class="i">+		html_attr(ctx.cfg.favicon);
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 	}
<a href="#h14-2-22" id="h14-2-22" class="d">-	if (host &amp;&amp; ctx-&gt;repo &amp;&amp; ctx-&gt;qry.head) {
</a><a href="#h14-2-23" id="h14-2-23" class="i">+	if (host &amp;&amp; ctx.repo &amp;&amp; ctx.qry.head) {
</a> 		struct strbuf sb = STRBUF_INIT;
<a href="#h14-2-25" id="h14-2-25" class="d">-		strbuf_addf(&amp;sb, &quot;h=%s&quot;, ctx-&gt;qry.head);
</a><a href="#h14-2-26" id="h14-2-26" class="i">+		strbuf_addf(&amp;sb, &quot;h=%s&quot;, ctx.qry.head);
</a> 
 		html(&quot;&lt;link rel=&#39;alternate&#39; title=&#39;Atom feed&#39; href=&#39;&quot;);
 		html(cgit_httpscheme());
 		html_attr(cgit_hosturl());
<a href="#h14-2-31" id="h14-2-31" class="d">-		html_attr(cgit_fileurl(ctx-&gt;repo-&gt;url, &quot;atom&quot;, ctx-&gt;qry.vpath,
</a><a href="#h14-2-32" id="h14-2-32" class="i">+		html_attr(cgit_fileurl(ctx.repo-&gt;url, &quot;atom&quot;, ctx.qry.vpath,
</a> 				       sb.buf));
 		html(&quot;&#39; type=&#39;application/atom+xml&#39;/&gt;\n&quot;);
 		strbuf_release(&amp;sb);
 	}
<a href="#h14-2-37" id="h14-2-37" class="d">-	if (ctx-&gt;cfg.head_include)
</a><a href="#h14-2-38" id="h14-2-38" class="d">-		html_include(ctx-&gt;cfg.head_include);
</a><a href="#h14-2-39" id="h14-2-39" class="i">+	if (ctx.cfg.head_include)
</a><a href="#h14-2-40" id="h14-2-40" class="i">+		html_include(ctx.cfg.head_include);
</a> 	html(&quot;&lt;/head&gt;\n&quot;);
 	html(&quot;&lt;body&gt;\n&quot;);
<a href="#h14-2-43" id="h14-2-43" class="d">-	if (ctx-&gt;cfg.header)
</a><a href="#h14-2-44" id="h14-2-44" class="d">-		html_include(ctx-&gt;cfg.header);
</a><a href="#h14-2-45" id="h14-2-45" class="i">+	if (ctx.cfg.header)
</a><a href="#h14-2-46" id="h14-2-46" class="i">+		html_include(ctx.cfg.header);
</a> }
 
 void cgit_print_docend()
<a href="#h14-3" id="h14-3" class="h">@@ -767,47 +766,47 @@ void cgit_add_hidden_formfields(int incl_head, int incl_search,
</a> 	}
 }
 
<a href="#h14-3-3" id="h14-3-3" class="d">-static const char *hc(struct cgit_context *ctx, const char *page)
</a><a href="#h14-3-4" id="h14-3-4" class="i">+static const char *hc(const char *page)
</a> {
<a href="#h14-3-6" id="h14-3-6" class="d">-	return strcmp(ctx-&gt;qry.page, page) ? NULL : &quot;active&quot;;
</a><a href="#h14-3-7" id="h14-3-7" class="i">+	return strcmp(ctx.qry.page, page) ? NULL : &quot;active&quot;;
</a> }
 
<a href="#h14-3-10" id="h14-3-10" class="d">-static void cgit_print_path_crumbs(struct cgit_context *ctx, char *path)
</a><a href="#h14-3-11" id="h14-3-11" class="i">+static void cgit_print_path_crumbs(char *path)
</a> {
<a href="#h14-3-13" id="h14-3-13" class="d">-	char *old_path = ctx-&gt;qry.path;
</a><a href="#h14-3-14" id="h14-3-14" class="i">+	char *old_path = ctx.qry.path;
</a> 	char *p = path, *q, *end = path + strlen(path);
 
<a href="#h14-3-17" id="h14-3-17" class="d">-	ctx-&gt;qry.path = NULL;
</a><a href="#h14-3-18" id="h14-3-18" class="d">-	cgit_self_link(&quot;root&quot;, NULL, NULL, ctx);
</a><a href="#h14-3-19" id="h14-3-19" class="d">-	ctx-&gt;qry.path = p = path;
</a><a href="#h14-3-20" id="h14-3-20" class="i">+	ctx.qry.path = NULL;
</a><a href="#h14-3-21" id="h14-3-21" class="i">+	cgit_self_link(&quot;root&quot;, NULL, NULL);
</a><a href="#h14-3-22" id="h14-3-22" class="i">+	ctx.qry.path = p = path;
</a> 	while (p &lt; end) {
 		if (!(q = strchr(p, &#39;/&#39;)))
 			q = end;
 		*q = &#39;\0&#39;;
 		html_txt(&quot;/&quot;);
<a href="#h14-3-28" id="h14-3-28" class="d">-		cgit_self_link(p, NULL, NULL, ctx);
</a><a href="#h14-3-29" id="h14-3-29" class="i">+		cgit_self_link(p, NULL, NULL);
</a> 		if (q &lt; end)
 			*q = &#39;/&#39;;
 		p = q + 1;
 	}
<a href="#h14-3-34" id="h14-3-34" class="d">-	ctx-&gt;qry.path = old_path;
</a><a href="#h14-3-35" id="h14-3-35" class="i">+	ctx.qry.path = old_path;
</a> }
 
<a href="#h14-3-38" id="h14-3-38" class="d">-static void print_header(struct cgit_context *ctx)
</a><a href="#h14-3-39" id="h14-3-39" class="i">+static void print_header(void)
</a> {
 	char *logo = NULL, *logo_link = NULL;
 
 	html(&quot;&lt;table id=&#39;header&#39;&gt;\n&quot;);
 	html(&quot;&lt;tr&gt;\n&quot;);
 
<a href="#h14-3-46" id="h14-3-46" class="d">-	if (ctx-&gt;repo &amp;&amp; ctx-&gt;repo-&gt;logo &amp;&amp; *ctx-&gt;repo-&gt;logo)
</a><a href="#h14-3-47" id="h14-3-47" class="d">-		logo = ctx-&gt;repo-&gt;logo;
</a><a href="#h14-3-48" id="h14-3-48" class="i">+	if (ctx.repo &amp;&amp; ctx.repo-&gt;logo &amp;&amp; *ctx.repo-&gt;logo)
</a><a href="#h14-3-49" id="h14-3-49" class="i">+		logo = ctx.repo-&gt;logo;
</a> 	else
<a href="#h14-3-51" id="h14-3-51" class="d">-		logo = ctx-&gt;cfg.logo;
</a><a href="#h14-3-52" id="h14-3-52" class="d">-	if (ctx-&gt;repo &amp;&amp; ctx-&gt;repo-&gt;logo_link &amp;&amp; *ctx-&gt;repo-&gt;logo_link)
</a><a href="#h14-3-53" id="h14-3-53" class="d">-		logo_link = ctx-&gt;repo-&gt;logo_link;
</a><a href="#h14-3-54" id="h14-3-54" class="i">+		logo = ctx.cfg.logo;
</a><a href="#h14-3-55" id="h14-3-55" class="i">+	if (ctx.repo &amp;&amp; ctx.repo-&gt;logo_link &amp;&amp; *ctx.repo-&gt;logo_link)
</a><a href="#h14-3-56" id="h14-3-56" class="i">+		logo_link = ctx.repo-&gt;logo_link;
</a> 	else
<a href="#h14-3-58" id="h14-3-58" class="d">-		logo_link = ctx-&gt;cfg.logo_link;
</a><a href="#h14-3-59" id="h14-3-59" class="i">+		logo_link = ctx.cfg.logo_link;
</a> 	if (logo &amp;&amp; *logo) {
 		html(&quot;&lt;td class=&#39;logo&#39; rowspan=&#39;2&#39;&gt;&lt;a href=&#39;&quot;);
 		if (logo_link &amp;&amp; *logo_link)
<a href="#h14-4" id="h14-4" class="h">@@ -820,104 +819,104 @@ static void print_header(struct cgit_context *ctx)
</a> 	}
 
 	html(&quot;&lt;td class=&#39;main&#39;&gt;&quot;);
<a href="#h14-4-3" id="h14-4-3" class="d">-	if (ctx-&gt;repo) {
</a><a href="#h14-4-4" id="h14-4-4" class="i">+	if (ctx.repo) {
</a> 		cgit_index_link(&quot;index&quot;, NULL, NULL, NULL, NULL, 0);
 		html(&quot; : &quot;);
<a href="#h14-4-7" id="h14-4-7" class="d">-		cgit_summary_link(ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;name, NULL, NULL);
</a><a href="#h14-4-8" id="h14-4-8" class="d">-		if (ctx-&gt;env.authenticated) {
</a><a href="#h14-4-9" id="h14-4-9" class="i">+		cgit_summary_link(ctx.repo-&gt;name, ctx.repo-&gt;name, NULL, NULL);
</a><a href="#h14-4-10" id="h14-4-10" class="i">+		if (ctx.env.authenticated) {
</a> 			html(&quot;&lt;/td&gt;&lt;td class=&#39;form&#39;&gt;&quot;);
 			html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;\n&quot;);
<a href="#h14-4-13" id="h14-4-13" class="d">-			cgit_add_hidden_formfields(0, 1, ctx-&gt;qry.page);
</a><a href="#h14-4-14" id="h14-4-14" class="i">+			cgit_add_hidden_formfields(0, 1, ctx.qry.page);
</a> 			html(&quot;&lt;select name=&#39;h&#39; onchange=&#39;this.form.submit();&#39;&gt;\n&quot;);
<a href="#h14-4-16" id="h14-4-16" class="d">-			for_each_branch_ref(print_branch_option, ctx-&gt;qry.head);
</a><a href="#h14-4-17" id="h14-4-17" class="i">+			for_each_branch_ref(print_branch_option, ctx.qry.head);
</a> 			html(&quot;&lt;/select&gt; &quot;);
 			html(&quot;&lt;input type=&#39;submit&#39; name=&#39;&#39; value=&#39;switch&#39;/&gt;&quot;);
 			html(&quot;&lt;/form&gt;&quot;);
 		}
 	} else
<a href="#h14-4-23" id="h14-4-23" class="d">-		html_txt(ctx-&gt;cfg.root_title);
</a><a href="#h14-4-24" id="h14-4-24" class="i">+		html_txt(ctx.cfg.root_title);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
 
 	html(&quot;&lt;tr&gt;&lt;td class=&#39;sub&#39;&gt;&quot;);
<a href="#h14-4-28" id="h14-4-28" class="d">-	if (ctx-&gt;repo) {
</a><a href="#h14-4-29" id="h14-4-29" class="d">-		html_txt(ctx-&gt;repo-&gt;desc);
</a><a href="#h14-4-30" id="h14-4-30" class="i">+	if (ctx.repo) {
</a><a href="#h14-4-31" id="h14-4-31" class="i">+		html_txt(ctx.repo-&gt;desc);
</a> 		html(&quot;&lt;/td&gt;&lt;td class=&#39;sub right&#39;&gt;&quot;);
<a href="#h14-4-33" id="h14-4-33" class="d">-		html_txt(ctx-&gt;repo-&gt;owner);
</a><a href="#h14-4-34" id="h14-4-34" class="i">+		html_txt(ctx.repo-&gt;owner);
</a> 	} else {
<a href="#h14-4-36" id="h14-4-36" class="d">-		if (ctx-&gt;cfg.root_desc)
</a><a href="#h14-4-37" id="h14-4-37" class="d">-			html_txt(ctx-&gt;cfg.root_desc);
</a><a href="#h14-4-38" id="h14-4-38" class="d">-		else if (ctx-&gt;cfg.index_info)
</a><a href="#h14-4-39" id="h14-4-39" class="d">-			html_include(ctx-&gt;cfg.index_info);
</a><a href="#h14-4-40" id="h14-4-40" class="i">+		if (ctx.cfg.root_desc)
</a><a href="#h14-4-41" id="h14-4-41" class="i">+			html_txt(ctx.cfg.root_desc);
</a><a href="#h14-4-42" id="h14-4-42" class="i">+		else if (ctx.cfg.index_info)
</a><a href="#h14-4-43" id="h14-4-43" class="i">+			html_include(ctx.cfg.index_info);
</a> 	}
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);
 }
 
<a href="#h14-4-48" id="h14-4-48" class="d">-void cgit_print_pageheader(struct cgit_context *ctx)
</a><a href="#h14-4-49" id="h14-4-49" class="i">+void cgit_print_pageheader(void)
</a> {
 	html(&quot;&lt;div id=&#39;cgit&#39;&gt;&quot;);
<a href="#h14-4-52" id="h14-4-52" class="d">-	if (!ctx-&gt;env.authenticated || !ctx-&gt;cfg.noheader)
</a><a href="#h14-4-53" id="h14-4-53" class="d">-		print_header(ctx);
</a><a href="#h14-4-54" id="h14-4-54" class="i">+	if (!ctx.env.authenticated || !ctx.cfg.noheader)
</a><a href="#h14-4-55" id="h14-4-55" class="i">+		print_header();
</a> 
 	html(&quot;&lt;table class=&#39;tabs&#39;&gt;&lt;tr&gt;&lt;td&gt;\n&quot;);
<a href="#h14-4-58" id="h14-4-58" class="d">-	if (ctx-&gt;env.authenticated &amp;&amp; ctx-&gt;repo) {
</a><a href="#h14-4-59" id="h14-4-59" class="d">-		cgit_summary_link(&quot;summary&quot;, NULL, hc(ctx, &quot;summary&quot;),
</a><a href="#h14-4-60" id="h14-4-60" class="d">-				  ctx-&gt;qry.head);
</a><a href="#h14-4-61" id="h14-4-61" class="d">-		cgit_refs_link(&quot;refs&quot;, NULL, hc(ctx, &quot;refs&quot;), ctx-&gt;qry.head,
</a><a href="#h14-4-62" id="h14-4-62" class="d">-			       ctx-&gt;qry.sha1, NULL);
</a><a href="#h14-4-63" id="h14-4-63" class="d">-		cgit_log_link(&quot;log&quot;, NULL, hc(ctx, &quot;log&quot;), ctx-&gt;qry.head,
</a><a href="#h14-4-64" id="h14-4-64" class="d">-			      NULL, ctx-&gt;qry.vpath, 0, NULL, NULL,
</a><a href="#h14-4-65" id="h14-4-65" class="d">-			      ctx-&gt;qry.showmsg);
</a><a href="#h14-4-66" id="h14-4-66" class="d">-		cgit_tree_link(&quot;tree&quot;, NULL, hc(ctx, &quot;tree&quot;), ctx-&gt;qry.head,
</a><a href="#h14-4-67" id="h14-4-67" class="d">-			       ctx-&gt;qry.sha1, ctx-&gt;qry.vpath);
</a><a href="#h14-4-68" id="h14-4-68" class="d">-		cgit_commit_link(&quot;commit&quot;, NULL, hc(ctx, &quot;commit&quot;),
</a><a href="#h14-4-69" id="h14-4-69" class="d">-				 ctx-&gt;qry.head, ctx-&gt;qry.sha1, ctx-&gt;qry.vpath, 0);
</a><a href="#h14-4-70" id="h14-4-70" class="d">-		cgit_diff_link(&quot;diff&quot;, NULL, hc(ctx, &quot;diff&quot;), ctx-&gt;qry.head,
</a><a href="#h14-4-71" id="h14-4-71" class="d">-			       ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, ctx-&gt;qry.vpath, 0);
</a><a href="#h14-4-72" id="h14-4-72" class="d">-		if (ctx-&gt;repo-&gt;max_stats)
</a><a href="#h14-4-73" id="h14-4-73" class="d">-			cgit_stats_link(&quot;stats&quot;, NULL, hc(ctx, &quot;stats&quot;),
</a><a href="#h14-4-74" id="h14-4-74" class="d">-					ctx-&gt;qry.head, ctx-&gt;qry.vpath);
</a><a href="#h14-4-75" id="h14-4-75" class="d">-		if (ctx-&gt;repo-&gt;readme.nr)
</a><a href="#h14-4-76" id="h14-4-76" class="i">+	if (ctx.env.authenticated &amp;&amp; ctx.repo) {
</a><a href="#h14-4-77" id="h14-4-77" class="i">+		cgit_summary_link(&quot;summary&quot;, NULL, hc(&quot;summary&quot;),
</a><a href="#h14-4-78" id="h14-4-78" class="i">+				  ctx.qry.head);
</a><a href="#h14-4-79" id="h14-4-79" class="i">+		cgit_refs_link(&quot;refs&quot;, NULL, hc(&quot;refs&quot;), ctx.qry.head,
</a><a href="#h14-4-80" id="h14-4-80" class="i">+			       ctx.qry.sha1, NULL);
</a><a href="#h14-4-81" id="h14-4-81" class="i">+		cgit_log_link(&quot;log&quot;, NULL, hc(&quot;log&quot;), ctx.qry.head,
</a><a href="#h14-4-82" id="h14-4-82" class="i">+			      NULL, ctx.qry.vpath, 0, NULL, NULL,
</a><a href="#h14-4-83" id="h14-4-83" class="i">+			      ctx.qry.showmsg);
</a><a href="#h14-4-84" id="h14-4-84" class="i">+		cgit_tree_link(&quot;tree&quot;, NULL, hc(&quot;tree&quot;), ctx.qry.head,
</a><a href="#h14-4-85" id="h14-4-85" class="i">+			       ctx.qry.sha1, ctx.qry.vpath);
</a><a href="#h14-4-86" id="h14-4-86" class="i">+		cgit_commit_link(&quot;commit&quot;, NULL, hc(&quot;commit&quot;),
</a><a href="#h14-4-87" id="h14-4-87" class="i">+				 ctx.qry.head, ctx.qry.sha1, ctx.qry.vpath, 0);
</a><a href="#h14-4-88" id="h14-4-88" class="i">+		cgit_diff_link(&quot;diff&quot;, NULL, hc(&quot;diff&quot;), ctx.qry.head,
</a><a href="#h14-4-89" id="h14-4-89" class="i">+			       ctx.qry.sha1, ctx.qry.sha2, ctx.qry.vpath, 0);
</a><a href="#h14-4-90" id="h14-4-90" class="i">+		if (ctx.repo-&gt;max_stats)
</a><a href="#h14-4-91" id="h14-4-91" class="i">+			cgit_stats_link(&quot;stats&quot;, NULL, hc(&quot;stats&quot;),
</a><a href="#h14-4-92" id="h14-4-92" class="i">+					ctx.qry.head, ctx.qry.vpath);
</a><a href="#h14-4-93" id="h14-4-93" class="i">+		if (ctx.repo-&gt;readme.nr)
</a> 			reporevlink(&quot;about&quot;, &quot;about&quot;, NULL,
<a href="#h14-4-95" id="h14-4-95" class="d">-				    hc(ctx, &quot;about&quot;), ctx-&gt;qry.head, NULL,
</a><a href="#h14-4-96" id="h14-4-96" class="i">+				    hc(&quot;about&quot;), ctx.qry.head, NULL,
</a> 				    NULL);
 		html(&quot;&lt;/td&gt;&lt;td class=&#39;form&#39;&gt;&quot;);
 		html(&quot;&lt;form class=&#39;right&#39; method=&#39;get&#39; action=&#39;&quot;);
<a href="#h14-4-100" id="h14-4-100" class="d">-		if (ctx-&gt;cfg.virtual_root)
</a><a href="#h14-4-101" id="h14-4-101" class="d">-			html_url_path(cgit_fileurl(ctx-&gt;qry.repo, &quot;log&quot;,
</a><a href="#h14-4-102" id="h14-4-102" class="d">-						   ctx-&gt;qry.vpath, NULL));
</a><a href="#h14-4-103" id="h14-4-103" class="i">+		if (ctx.cfg.virtual_root)
</a><a href="#h14-4-104" id="h14-4-104" class="i">+			html_url_path(cgit_fileurl(ctx.qry.repo, &quot;log&quot;,
</a><a href="#h14-4-105" id="h14-4-105" class="i">+						   ctx.qry.vpath, NULL));
</a> 		html(&quot;&#39;&gt;\n&quot;);
 		cgit_add_hidden_formfields(1, 0, &quot;log&quot;);
 		html(&quot;&lt;select name=&#39;qt&#39;&gt;\n&quot;);
<a href="#h14-4-109" id="h14-4-109" class="d">-		html_option(&quot;grep&quot;, &quot;log msg&quot;, ctx-&gt;qry.grep);
</a><a href="#h14-4-110" id="h14-4-110" class="d">-		html_option(&quot;author&quot;, &quot;author&quot;, ctx-&gt;qry.grep);
</a><a href="#h14-4-111" id="h14-4-111" class="d">-		html_option(&quot;committer&quot;, &quot;committer&quot;, ctx-&gt;qry.grep);
</a><a href="#h14-4-112" id="h14-4-112" class="d">-		html_option(&quot;range&quot;, &quot;range&quot;, ctx-&gt;qry.grep);
</a><a href="#h14-4-113" id="h14-4-113" class="i">+		html_option(&quot;grep&quot;, &quot;log msg&quot;, ctx.qry.grep);
</a><a href="#h14-4-114" id="h14-4-114" class="i">+		html_option(&quot;author&quot;, &quot;author&quot;, ctx.qry.grep);
</a><a href="#h14-4-115" id="h14-4-115" class="i">+		html_option(&quot;committer&quot;, &quot;committer&quot;, ctx.qry.grep);
</a><a href="#h14-4-116" id="h14-4-116" class="i">+		html_option(&quot;range&quot;, &quot;range&quot;, ctx.qry.grep);
</a> 		html(&quot;&lt;/select&gt;\n&quot;);
 		html(&quot;&lt;input class=&#39;txt&#39; type=&#39;text&#39; size=&#39;10&#39; name=&#39;q&#39; value=&#39;&quot;);
<a href="#h14-4-119" id="h14-4-119" class="d">-		html_attr(ctx-&gt;qry.search);
</a><a href="#h14-4-120" id="h14-4-120" class="i">+		html_attr(ctx.qry.search);
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 		html(&quot;&lt;input type=&#39;submit&#39; value=&#39;search&#39;/&gt;\n&quot;);
 		html(&quot;&lt;/form&gt;\n&quot;);
<a href="#h14-4-124" id="h14-4-124" class="d">-	} else if (ctx-&gt;env.authenticated) {
</a><a href="#h14-4-125" id="h14-4-125" class="d">-		site_link(NULL, &quot;index&quot;, NULL, hc(ctx, &quot;repolist&quot;), NULL, NULL, 0);
</a><a href="#h14-4-126" id="h14-4-126" class="d">-		if (ctx-&gt;cfg.root_readme)
</a><a href="#h14-4-127" id="h14-4-127" class="d">-			site_link(&quot;about&quot;, &quot;about&quot;, NULL, hc(ctx, &quot;about&quot;),
</a><a href="#h14-4-128" id="h14-4-128" class="i">+	} else if (ctx.env.authenticated) {
</a><a href="#h14-4-129" id="h14-4-129" class="i">+		site_link(NULL, &quot;index&quot;, NULL, hc(&quot;repolist&quot;), NULL, NULL, 0);
</a><a href="#h14-4-130" id="h14-4-130" class="i">+		if (ctx.cfg.root_readme)
</a><a href="#h14-4-131" id="h14-4-131" class="i">+			site_link(&quot;about&quot;, &quot;about&quot;, NULL, hc(&quot;about&quot;),
</a> 				  NULL, NULL, 0);
 		html(&quot;&lt;/td&gt;&lt;td class=&#39;form&#39;&gt;&quot;);
 		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&quot;);
 		html_attr(cgit_rooturl());
 		html(&quot;&#39;&gt;\n&quot;);
 		html(&quot;&lt;input type=&#39;text&#39; name=&#39;q&#39; size=&#39;10&#39; value=&#39;&quot;);
<a href="#h14-4-138" id="h14-4-138" class="d">-		html_attr(ctx-&gt;qry.search);
</a><a href="#h14-4-139" id="h14-4-139" class="i">+		html_attr(ctx.qry.search);
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 		html(&quot;&lt;input type=&#39;submit&#39; value=&#39;search&#39;/&gt;\n&quot;);
 		html(&quot;&lt;/form&gt;&quot;);
 	}
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);
<a href="#h14-4-145" id="h14-4-145" class="d">-	if (ctx-&gt;env.authenticated &amp;&amp; ctx-&gt;qry.vpath) {
</a><a href="#h14-4-146" id="h14-4-146" class="i">+	if (ctx.env.authenticated &amp;&amp; ctx.qry.vpath) {
</a> 		html(&quot;&lt;div class=&#39;path&#39;&gt;&quot;);
 		html(&quot;path: &quot;);
<a href="#h14-4-149" id="h14-4-149" class="d">-		cgit_print_path_crumbs(ctx, ctx-&gt;qry.vpath);
</a><a href="#h14-4-150" id="h14-4-150" class="i">+		cgit_print_path_crumbs(ctx.qry.vpath);
</a> 		html(&quot;&lt;/div&gt;&quot;);
 	}
 	html(&quot;&lt;div class=&#39;content&#39;&gt;&quot;);
<b>diff --git a/<a id="h15" href="../file/ui-shared.h.html">ui-shared.h</a> b/<a href="../file/ui-shared.h.html">ui-shared.h</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -59,10 +59,10 @@ __attribute__((format (printf,1,0)))
</a> extern void cgit_vprint_error(const char *fmt, va_list ap);
 extern void cgit_print_date(time_t secs, const char *format, int local_time);
 extern void cgit_print_age(time_t t, time_t max_relative, const char *format);
<a href="#h15-0-3" id="h15-0-3" class="d">-extern void cgit_print_http_headers(struct cgit_context *ctx);
</a><a href="#h15-0-4" id="h15-0-4" class="d">-extern void cgit_print_docstart(struct cgit_context *ctx);
</a><a href="#h15-0-5" id="h15-0-5" class="i">+extern void cgit_print_http_headers(void);
</a><a href="#h15-0-6" id="h15-0-6" class="i">+extern void cgit_print_docstart(void);
</a> extern void cgit_print_docend();
<a href="#h15-0-8" id="h15-0-8" class="d">-extern void cgit_print_pageheader(struct cgit_context *ctx);
</a><a href="#h15-0-9" id="h15-0-9" class="i">+extern void cgit_print_pageheader(void);
</a> extern void cgit_print_filemode(unsigned short mode);
 extern void cgit_print_snapshot_links(const char *repo, const char *head,
 				      const char *hex, int snapshots);
<b>diff --git a/<a id="h16" href="../file/ui-snapshot.c.html">ui-snapshot.c</a> b/<a href="../file/ui-snapshot.c.html">ui-snapshot.c</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -121,7 +121,7 @@ static int make_snapshot(const struct cgit_snapshot_format *format,
</a> 	}
 	ctx.page.mimetype = xstrdup(format-&gt;mimetype);
 	ctx.page.filename = xstrdup(filename);
<a href="#h16-0-3" id="h16-0-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h16-0-4" id="h16-0-4" class="i">+	cgit_print_http_headers();
</a> 	format-&gt;write_func(hex, prefix);
 	return 0;
 }
<a href="#h16-1" id="h16-1" class="h">@@ -183,9 +183,9 @@ static void show_error(char *fmt, ...)
</a> 	va_list ap;
 
 	ctx.page.mimetype = &quot;text/html&quot;;
<a href="#h16-1-3" id="h16-1-3" class="d">-	cgit_print_http_headers(&amp;ctx);
</a><a href="#h16-1-4" id="h16-1-4" class="d">-	cgit_print_docstart(&amp;ctx);
</a><a href="#h16-1-5" id="h16-1-5" class="d">-	cgit_print_pageheader(&amp;ctx);
</a><a href="#h16-1-6" id="h16-1-6" class="i">+	cgit_print_http_headers();
</a><a href="#h16-1-7" id="h16-1-7" class="i">+	cgit_print_docstart();
</a><a href="#h16-1-8" id="h16-1-8" class="i">+	cgit_print_pageheader();
</a> 	va_start(ap, fmt);
 	cgit_vprint_error(fmt, ap);
 	va_end(ap);
<b>diff --git a/<a id="h17" href="../file/ui-stats.c.html">ui-stats.c</a> b/<a href="../file/ui-stats.c.html">ui-stats.c</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -209,13 +209,12 @@ static int cmp_total_commits(const void *a1, const void *a2)
</a> /* Walk the commit DAG and collect number of commits per author per
  * timeperiod into a nested string_list collection.
  */
<a href="#h17-0-3" id="h17-0-3" class="d">-static struct string_list collect_stats(struct cgit_context *ctx,
</a><a href="#h17-0-4" id="h17-0-4" class="d">-					struct cgit_period *period)
</a><a href="#h17-0-5" id="h17-0-5" class="i">+static struct string_list collect_stats(struct cgit_period *period)
</a> {
 	struct string_list authors;
 	struct rev_info rev;
 	struct commit *commit;
<a href="#h17-0-10" id="h17-0-10" class="d">-	const char *argv[] = {NULL, ctx-&gt;qry.head, NULL, NULL, NULL, NULL};
</a><a href="#h17-0-11" id="h17-0-11" class="i">+	const char *argv[] = {NULL, ctx.qry.head, NULL, NULL, NULL, NULL};
</a> 	int argc = 3;
 	time_t now;
 	long i;
<a href="#h17-1" id="h17-1" class="h">@@ -229,9 +228,9 @@ static struct string_list collect_stats(struct cgit_context *ctx,
</a> 		period-&gt;dec(tm);
 	strftime(tmp, sizeof(tmp), &quot;%Y-%m-%d&quot;, tm);
 	argv[2] = xstrdup(fmt(&quot;--since=%s&quot;, tmp));
<a href="#h17-1-3" id="h17-1-3" class="d">-	if (ctx-&gt;qry.path) {
</a><a href="#h17-1-4" id="h17-1-4" class="i">+	if (ctx.qry.path) {
</a> 		argv[3] = &quot;--&quot;;
<a href="#h17-1-6" id="h17-1-6" class="d">-		argv[4] = ctx-&gt;qry.path;
</a><a href="#h17-1-7" id="h17-1-7" class="i">+		argv[4] = ctx.qry.path;
</a> 		argc += 2;
 	}
 	init_revisions(&amp;rev, NULL);
<a href="#h17-2" id="h17-2" class="h">@@ -360,30 +359,30 @@ static void print_authors(struct string_list *authors, int top,
</a>  * for each author is another string_list which is used to calculate the
  * number of commits per time-interval.
  */
<a href="#h17-2-3" id="h17-2-3" class="d">-void cgit_show_stats(struct cgit_context *ctx)
</a><a href="#h17-2-4" id="h17-2-4" class="i">+void cgit_show_stats(void)
</a> {
 	struct string_list authors;
 	struct cgit_period *period;
 	int top, i;
 	const char *code = &quot;w&quot;;
 
<a href="#h17-2-11" id="h17-2-11" class="d">-	if (ctx-&gt;qry.period)
</a><a href="#h17-2-12" id="h17-2-12" class="d">-		code = ctx-&gt;qry.period;
</a><a href="#h17-2-13" id="h17-2-13" class="i">+	if (ctx.qry.period)
</a><a href="#h17-2-14" id="h17-2-14" class="i">+		code = ctx.qry.period;
</a> 
 	i = cgit_find_stats_period(code, &amp;period);
 	if (!i) {
 		cgit_print_error(&quot;Unknown statistics type: %c&quot;, code[0]);
 		return;
 	}
<a href="#h17-2-21" id="h17-2-21" class="d">-	if (i &gt; ctx-&gt;repo-&gt;max_stats) {
</a><a href="#h17-2-22" id="h17-2-22" class="i">+	if (i &gt; ctx.repo-&gt;max_stats) {
</a> 		cgit_print_error(&quot;Statistics type disabled: %s&quot;, period-&gt;name);
 		return;
 	}
<a href="#h17-2-26" id="h17-2-26" class="d">-	authors = collect_stats(ctx, period);
</a><a href="#h17-2-27" id="h17-2-27" class="i">+	authors = collect_stats(period);
</a> 	qsort(authors.items, authors.nr, sizeof(struct string_list_item),
 		cmp_total_commits);
 
<a href="#h17-2-31" id="h17-2-31" class="d">-	top = ctx-&gt;qry.ofs;
</a><a href="#h17-2-32" id="h17-2-32" class="i">+	top = ctx.qry.ofs;
</a> 	if (!top)
 		top = 10;
 
<a href="#h17-3" id="h17-3" class="h">@@ -392,10 +391,10 @@ void cgit_show_stats(struct cgit_context *ctx)
</a> 	html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;&quot;);
 	cgit_add_hidden_formfields(1, 0, &quot;stats&quot;);
 	html(&quot;&lt;table&gt;&lt;tr&gt;&lt;td colspan=&#39;2&#39;/&gt;&lt;/tr&gt;&quot;);
<a href="#h17-3-3" id="h17-3-3" class="d">-	if (ctx-&gt;repo-&gt;max_stats &gt; 1) {
</a><a href="#h17-3-4" id="h17-3-4" class="i">+	if (ctx.repo-&gt;max_stats &gt; 1) {
</a> 		html(&quot;&lt;tr&gt;&lt;td class=&#39;label&#39;&gt;Period:&lt;/td&gt;&quot;);
 		html(&quot;&lt;td class=&#39;ctrl&#39;&gt;&lt;select name=&#39;period&#39; onchange=&#39;this.form.submit();&#39;&gt;&quot;);
<a href="#h17-3-7" id="h17-3-7" class="d">-		for (i = 0; i &lt; ctx-&gt;repo-&gt;max_stats; i++)
</a><a href="#h17-3-8" id="h17-3-8" class="i">+		for (i = 0; i &lt; ctx.repo-&gt;max_stats; i++)
</a> 			html_option(fmt(&quot;%c&quot;, periods[i].code),
 				    periods[i].name, fmt(&quot;%c&quot;, period-&gt;code));
 		html(&quot;&lt;/select&gt;&lt;/td&gt;&lt;/tr&gt;&quot;);
<a href="#h17-4" id="h17-4" class="h">@@ -414,9 +413,9 @@ void cgit_show_stats(struct cgit_context *ctx)
</a> 	html(&quot;&lt;/form&gt;&quot;);
 	html(&quot;&lt;/div&gt;&quot;);
 	htmlf(&quot;&lt;h2&gt;Commits per author per %s&quot;, period-&gt;name);
<a href="#h17-4-3" id="h17-4-3" class="d">-	if (ctx-&gt;qry.path) {
</a><a href="#h17-4-4" id="h17-4-4" class="i">+	if (ctx.qry.path) {
</a> 		html(&quot; (path &#39;&quot;);
<a href="#h17-4-6" id="h17-4-6" class="d">-		html_txt(ctx-&gt;qry.path);
</a><a href="#h17-4-7" id="h17-4-7" class="i">+		html_txt(ctx.qry.path);
</a> 		html(&quot;&#39;)&quot;);
 	}
 	html(&quot;&lt;/h2&gt;&quot;);
<b>diff --git a/<a id="h18" href="../file/ui-stats.h.html">ui-stats.h</a> b/<a href="../file/ui-stats.h.html">ui-stats.h</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -23,6 +23,6 @@ struct cgit_period {
</a> extern int cgit_find_stats_period(const char *expr, struct cgit_period **period);
 extern const char *cgit_find_stats_periodname(int idx);
 
<a href="#h18-0-3" id="h18-0-3" class="d">-extern void cgit_show_stats(struct cgit_context *ctx);
</a><a href="#h18-0-4" id="h18-0-4" class="i">+extern void cgit_show_stats(void);
</a> 
 #endif /* UI_STATS_H */
</pre>
</div>
</body>
</html>
