<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add a &#39;stats&#39; page to each repo - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/f86a23ff537258d36bf8f1876fa7a4bede6673d8.html">f86a23ff537258d36bf8f1876fa7a4bede6673d8</a>
<b>parent</b> <a href="../commit/140012d7a8e51df5a9f9c556696778b86ade4fc9.html">140012d7a8e51df5a9f9c556696778b86ade4fc9</a>
<b>Author:</b> Lars Hjemli &lt;<a href="mailto:hjemli@gmail.com">hjemli@gmail.com</a>&gt;
<b>Date:</b>   Sat,  6 Dec 2008 17:38:19 +0100

Add a &#39;stats&#39; page to each repo

This new page, which is disabled by default, can be used to print some
statistics about the number of commits per period in the repository,
where period can be either weeks, months, quarters or years.

The function can be activated globally by setting &#39;enable-stats=1&#39; in
cgitrc and disabled for individual repos by setting &#39;repo.enable-stats=0&#39;.

Signed-off-by: Lars Hjemli &lt;hjemli@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">Makefile</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">cgit.c</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">cgit.css</a></td><td> | </td><td class="num">77</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">cgit.h</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">cgitrc.5.txt</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">cmd.c</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">shared.c</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">ui-shared.c</a></td><td> | </td><td class="num">3</td><td><span class="i">+++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">ui-stats.c</a></td><td> | </td><td class="num">380</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">ui-stats.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
</table></pre><pre>10 files changed, 497 insertions(+), 0 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -68,6 +68,7 @@ OBJECTS += ui-refs.o
</a> OBJECTS += ui-repolist.o
 OBJECTS += ui-shared.o
 OBJECTS += ui-snapshot.o
<a href="#h0-0-3" id="h0-0-3" class="i">+OBJECTS += ui-stats.o
</a> OBJECTS += ui-summary.o
 OBJECTS += ui-tag.o
 OBJECTS += ui-tree.o
<b>diff --git a/<a id="h1" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -54,6 +54,8 @@ void config_cb(const char *name, const char *value)
</a> 		ctx.cfg.enable_log_filecount = atoi(value);
 	else if (!strcmp(name, &quot;enable-log-linecount&quot;))
 		ctx.cfg.enable_log_linecount = atoi(value);
<a href="#h1-0-3" id="h1-0-3" class="i">+	else if (!strcmp(name, &quot;enable-stats&quot;))
</a><a href="#h1-0-4" id="h1-0-4" class="i">+		ctx.cfg.enable_stats = atoi(value);
</a> 	else if (!strcmp(name, &quot;cache-size&quot;))
 		ctx.cfg.cache_size = atoi(value);
 	else if (!strcmp(name, &quot;cache-root&quot;))
<a href="#h1-1" id="h1-1" class="h">@@ -112,6 +114,8 @@ void config_cb(const char *name, const char *value)
</a> 		ctx.repo-&gt;enable_log_filecount = ctx.cfg.enable_log_filecount * atoi(value);
 	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.enable-log-linecount&quot;))
 		ctx.repo-&gt;enable_log_linecount = ctx.cfg.enable_log_linecount * atoi(value);
<a href="#h1-1-3" id="h1-1-3" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.enable-stats&quot;))
</a><a href="#h1-1-4" id="h1-1-4" class="i">+		ctx.repo-&gt;enable_stats = ctx.cfg.enable_stats &amp;&amp; atoi(value);
</a> 	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.module-link&quot;))
 		ctx.repo-&gt;module_link= xstrdup(value);
 	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.readme&quot;) &amp;&amp; value != NULL) {
<a href="#h1-2" id="h1-2" class="h">@@ -154,6 +158,8 @@ static void querystring_cb(const char *name, const char *value)
</a> 		ctx.qry.name = xstrdup(value);
 	} else if (!strcmp(name, &quot;mimetype&quot;)) {
 		ctx.qry.mimetype = xstrdup(value);
<a href="#h1-2-3" id="h1-2-3" class="i">+	} else if (!strcmp(name, &quot;period&quot;)) {
</a><a href="#h1-2-4" id="h1-2-4" class="i">+		ctx.qry.period = xstrdup(value);
</a> 	}
 }
 
<b>diff --git a/<a id="h2" href="../file/cgit.css.html">cgit.css</a> b/<a href="../file/cgit.css.html">cgit.css</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -456,3 +456,80 @@ div.footer {
</a> 	font-size: 80%;
 	color: #ccc;
 }
<a href="#h2-0-3" id="h2-0-3" class="i">+table.stats {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	border: solid 1px black;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	border-collapse: collapse;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+}
</a><a href="#h2-0-7" id="h2-0-7" class="i">+
</a><a href="#h2-0-8" id="h2-0-8" class="i">+table.stats th {
</a><a href="#h2-0-9" id="h2-0-9" class="i">+	text-align: left;
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	padding: 1px 0.5em;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+	background-color: #eee;
</a><a href="#h2-0-12" id="h2-0-12" class="i">+	border: solid 1px black;
</a><a href="#h2-0-13" id="h2-0-13" class="i">+}
</a><a href="#h2-0-14" id="h2-0-14" class="i">+
</a><a href="#h2-0-15" id="h2-0-15" class="i">+table.stats td {
</a><a href="#h2-0-16" id="h2-0-16" class="i">+	text-align: right;
</a><a href="#h2-0-17" id="h2-0-17" class="i">+	padding: 1px 0.5em;
</a><a href="#h2-0-18" id="h2-0-18" class="i">+	border: solid 1px black;
</a><a href="#h2-0-19" id="h2-0-19" class="i">+}
</a><a href="#h2-0-20" id="h2-0-20" class="i">+
</a><a href="#h2-0-21" id="h2-0-21" class="i">+table.stats td.total {
</a><a href="#h2-0-22" id="h2-0-22" class="i">+	font-weight: bold;
</a><a href="#h2-0-23" id="h2-0-23" class="i">+	text-align: left;
</a><a href="#h2-0-24" id="h2-0-24" class="i">+}
</a><a href="#h2-0-25" id="h2-0-25" class="i">+
</a><a href="#h2-0-26" id="h2-0-26" class="i">+table.stats td.sum {
</a><a href="#h2-0-27" id="h2-0-27" class="i">+	color: #c00;
</a><a href="#h2-0-28" id="h2-0-28" class="i">+	font-weight: bold;
</a><a href="#h2-0-29" id="h2-0-29" class="i">+/*	background-color: #eee; */
</a><a href="#h2-0-30" id="h2-0-30" class="i">+}
</a><a href="#h2-0-31" id="h2-0-31" class="i">+
</a><a href="#h2-0-32" id="h2-0-32" class="i">+table.stats td.left {
</a><a href="#h2-0-33" id="h2-0-33" class="i">+	text-align: left;
</a><a href="#h2-0-34" id="h2-0-34" class="i">+}
</a><a href="#h2-0-35" id="h2-0-35" class="i">+
</a><a href="#h2-0-36" id="h2-0-36" class="i">+table.vgraph {
</a><a href="#h2-0-37" id="h2-0-37" class="i">+	border-collapse: separate;
</a><a href="#h2-0-38" id="h2-0-38" class="i">+	border: solid 1px black;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+	height: 200px;
</a><a href="#h2-0-40" id="h2-0-40" class="i">+}
</a><a href="#h2-0-41" id="h2-0-41" class="i">+
</a><a href="#h2-0-42" id="h2-0-42" class="i">+table.vgraph th {
</a><a href="#h2-0-43" id="h2-0-43" class="i">+	background-color: #eee;
</a><a href="#h2-0-44" id="h2-0-44" class="i">+	font-weight: bold;
</a><a href="#h2-0-45" id="h2-0-45" class="i">+	border: solid 1px white;
</a><a href="#h2-0-46" id="h2-0-46" class="i">+	padding: 1px 0.5em;
</a><a href="#h2-0-47" id="h2-0-47" class="i">+}
</a><a href="#h2-0-48" id="h2-0-48" class="i">+
</a><a href="#h2-0-49" id="h2-0-49" class="i">+table.vgraph td {
</a><a href="#h2-0-50" id="h2-0-50" class="i">+	vertical-align: bottom;
</a><a href="#h2-0-51" id="h2-0-51" class="i">+	padding: 0px 10px;
</a><a href="#h2-0-52" id="h2-0-52" class="i">+}
</a><a href="#h2-0-53" id="h2-0-53" class="i">+
</a><a href="#h2-0-54" id="h2-0-54" class="i">+table.vgraph div.bar {
</a><a href="#h2-0-55" id="h2-0-55" class="i">+	background-color: #eee;
</a><a href="#h2-0-56" id="h2-0-56" class="i">+}
</a><a href="#h2-0-57" id="h2-0-57" class="i">+
</a><a href="#h2-0-58" id="h2-0-58" class="i">+table.hgraph {
</a><a href="#h2-0-59" id="h2-0-59" class="i">+	border: solid 1px black;
</a><a href="#h2-0-60" id="h2-0-60" class="i">+	width: 800px;
</a><a href="#h2-0-61" id="h2-0-61" class="i">+}
</a><a href="#h2-0-62" id="h2-0-62" class="i">+
</a><a href="#h2-0-63" id="h2-0-63" class="i">+table.hgraph th {
</a><a href="#h2-0-64" id="h2-0-64" class="i">+	background-color: #eee;
</a><a href="#h2-0-65" id="h2-0-65" class="i">+	font-weight: bold;
</a><a href="#h2-0-66" id="h2-0-66" class="i">+	border: solid 1px black;
</a><a href="#h2-0-67" id="h2-0-67" class="i">+	padding: 1px 0.5em;
</a><a href="#h2-0-68" id="h2-0-68" class="i">+}
</a><a href="#h2-0-69" id="h2-0-69" class="i">+
</a><a href="#h2-0-70" id="h2-0-70" class="i">+table.hgraph td {
</a><a href="#h2-0-71" id="h2-0-71" class="i">+	vertical-align: center;
</a><a href="#h2-0-72" id="h2-0-72" class="i">+	padding: 2px 2px;
</a><a href="#h2-0-73" id="h2-0-73" class="i">+}
</a><a href="#h2-0-74" id="h2-0-74" class="i">+
</a><a href="#h2-0-75" id="h2-0-75" class="i">+table.hgraph div.bar {
</a><a href="#h2-0-76" id="h2-0-76" class="i">+	background-color: #eee;
</a><a href="#h2-0-77" id="h2-0-77" class="i">+	height: 1em;
</a><a href="#h2-0-78" id="h2-0-78" class="i">+}
</a><a href="#h2-0-79" id="h2-0-79" class="i">+
</a><b>diff --git a/<a id="h3" href="../file/cgit.h.html">cgit.h</a> b/<a href="../file/cgit.h.html">cgit.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -61,6 +61,7 @@ struct cgit_repo {
</a> 	int snapshots;
 	int enable_log_filecount;
 	int enable_log_linecount;
<a href="#h3-0-3" id="h3-0-3" class="i">+	int enable_stats;
</a> };
 
 struct cgit_repolist {
<a href="#h3-1" id="h3-1" class="h">@@ -119,6 +120,7 @@ struct cgit_query {
</a> 	char *name;
 	char *mimetype;
 	char *url;
<a href="#h3-1-3" id="h3-1-3" class="i">+	char *period;
</a> 	int   ofs;
 	int nohead;
 };
<a href="#h3-2" id="h3-2" class="h">@@ -151,6 +153,7 @@ struct cgit_config {
</a> 	int enable_index_links;
 	int enable_log_filecount;
 	int enable_log_linecount;
<a href="#h3-2-3" id="h3-2-3" class="i">+	int enable_stats;
</a> 	int local_time;
 	int max_repo_count;
 	int max_commit_count;
<b>diff --git a/<a id="h4" href="../file/cgitrc.5.txt.html">cgitrc.5.txt</a> b/<a href="../file/cgitrc.5.txt.html">cgitrc.5.txt</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -74,6 +74,10 @@ enable-log-linecount
</a> 	and removed lines for each commit on the repository log page. Default
 	value: &quot;0&quot;.
 
<a href="#h4-0-3" id="h4-0-3" class="i">+enable-stats
</a><a href="#h4-0-4" id="h4-0-4" class="i">+	Globally enable/disable statistics for each repository. Default
</a><a href="#h4-0-5" id="h4-0-5" class="i">+	value: &quot;0&quot;.
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a> favicon
 	Url used as link to a shortcut icon for cgit. If specified, it is
 	suggested to use the value &quot;/favicon.ico&quot; since certain browsers will
<a href="#h4-1" id="h4-1" class="h">@@ -218,6 +222,10 @@ repo.enable-log-linecount
</a> 	A flag which can be used to disable the global setting
 	`enable-log-linecount&#39;. Default value: none.
 
<a href="#h4-1-3" id="h4-1-3" class="i">+repo.enable-stats
</a><a href="#h4-1-4" id="h4-1-4" class="i">+	A flag which can be used to disable the global setting
</a><a href="#h4-1-5" id="h4-1-5" class="i">+	`enable-stats&#39;. Default value: none.
</a><a href="#h4-1-6" id="h4-1-6" class="i">+
</a> repo.name
 	The value to show as repository name. Default value: &lt;repo.url&gt;.
 
<b>diff --git a/<a id="h5" href="../file/cmd.c.html">cmd.c</a> b/<a href="../file/cmd.c.html">cmd.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -21,6 +21,7 @@
</a> #include &quot;ui-refs.h&quot;
 #include &quot;ui-repolist.h&quot;
 #include &quot;ui-snapshot.h&quot;
<a href="#h5-0-3" id="h5-0-3" class="i">+#include &quot;ui-stats.h&quot;
</a> #include &quot;ui-summary.h&quot;
 #include &quot;ui-tag.h&quot;
 #include &quot;ui-tree.h&quot;
<a href="#h5-1" id="h5-1" class="h">@@ -109,6 +110,14 @@ static void snapshot_fn(struct cgit_context *ctx)
</a> 			    ctx-&gt;repo-&gt;snapshots, ctx-&gt;qry.nohead);
 }
 
<a href="#h5-1-3" id="h5-1-3" class="i">+static void stats_fn(struct cgit_context *ctx)
</a><a href="#h5-1-4" id="h5-1-4" class="i">+{
</a><a href="#h5-1-5" id="h5-1-5" class="i">+	if (ctx-&gt;repo-&gt;enable_stats)
</a><a href="#h5-1-6" id="h5-1-6" class="i">+		cgit_show_stats(ctx);
</a><a href="#h5-1-7" id="h5-1-7" class="i">+	else
</a><a href="#h5-1-8" id="h5-1-8" class="i">+		cgit_print_error(&quot;Stats disabled for this repo&quot;);
</a><a href="#h5-1-9" id="h5-1-9" class="i">+}
</a><a href="#h5-1-10" id="h5-1-10" class="i">+
</a> static void summary_fn(struct cgit_context *ctx)
 {
 	cgit_print_summary();
<a href="#h5-2" id="h5-2" class="h">@@ -145,6 +154,7 @@ struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx)
</a> 		def_cmd(refs, 1, 1),
 		def_cmd(repolist, 0, 0),
 		def_cmd(snapshot, 1, 0),
<a href="#h5-2-3" id="h5-2-3" class="i">+		def_cmd(stats, 1, 1),
</a> 		def_cmd(summary, 1, 1),
 		def_cmd(tag, 1, 1),
 		def_cmd(tree, 1, 1),
<b>diff --git a/<a id="h6" href="../file/shared.c.html">shared.c</a> b/<a href="../file/shared.c.html">shared.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -58,6 +58,7 @@ struct cgit_repo *cgit_add_repo(const char *url)
</a> 	ret-&gt;snapshots = ctx.cfg.snapshots;
 	ret-&gt;enable_log_filecount = ctx.cfg.enable_log_filecount;
 	ret-&gt;enable_log_linecount = ctx.cfg.enable_log_linecount;
<a href="#h6-0-3" id="h6-0-3" class="i">+	ret-&gt;enable_stats = ctx.cfg.enable_stats;
</a> 	ret-&gt;module_link = ctx.cfg.module_link;
 	ret-&gt;readme = NULL;
 	return ret;
<b>diff --git a/<a id="h7" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -641,6 +641,9 @@ void cgit_print_pageheader(struct cgit_context *ctx)
</a> 				 ctx-&gt;qry.head, ctx-&gt;qry.sha1);
 		cgit_diff_link(&quot;diff&quot;, NULL, hc(cmd, &quot;diff&quot;), ctx-&gt;qry.head,
 			       ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, NULL);
<a href="#h7-0-3" id="h7-0-3" class="i">+		if (ctx-&gt;repo-&gt;enable_stats)
</a><a href="#h7-0-4" id="h7-0-4" class="i">+			reporevlink(&quot;stats&quot;, &quot;stats&quot;, NULL, hc(cmd, &quot;stats&quot;),
</a><a href="#h7-0-5" id="h7-0-5" class="i">+				    ctx-&gt;qry.head, NULL, NULL);
</a> 		if (ctx-&gt;repo-&gt;readme)
 			reporevlink(&quot;about&quot;, &quot;about&quot;, NULL,
 				    hc(cmd, &quot;about&quot;), ctx-&gt;qry.head, NULL,
<b>diff --git a/<a id="h8" href="../file/ui-stats.c.html">ui-stats.c</a> b/<a href="../file/ui-stats.c.html">ui-stats.c</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,380 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+#include &quot;cgit.h&quot;
</a><a href="#h8-0-1" id="h8-0-1" class="i">+#include &quot;html.h&quot;
</a><a href="#h8-0-2" id="h8-0-2" class="i">+#include &lt;string-list.h&gt;
</a><a href="#h8-0-3" id="h8-0-3" class="i">+
</a><a href="#h8-0-4" id="h8-0-4" class="i">+#define MONTHS 6
</a><a href="#h8-0-5" id="h8-0-5" class="i">+
</a><a href="#h8-0-6" id="h8-0-6" class="i">+struct Period {
</a><a href="#h8-0-7" id="h8-0-7" class="i">+	const char code;
</a><a href="#h8-0-8" id="h8-0-8" class="i">+	const char *name;
</a><a href="#h8-0-9" id="h8-0-9" class="i">+	int max_periods;
</a><a href="#h8-0-10" id="h8-0-10" class="i">+	int count;
</a><a href="#h8-0-11" id="h8-0-11" class="i">+
</a><a href="#h8-0-12" id="h8-0-12" class="i">+	/* Convert a tm value to the first day in the period */
</a><a href="#h8-0-13" id="h8-0-13" class="i">+	void (*trunc)(struct tm *tm);
</a><a href="#h8-0-14" id="h8-0-14" class="i">+
</a><a href="#h8-0-15" id="h8-0-15" class="i">+	/* Update tm value to start of next/previous period */
</a><a href="#h8-0-16" id="h8-0-16" class="i">+	void (*dec)(struct tm *tm);
</a><a href="#h8-0-17" id="h8-0-17" class="i">+	void (*inc)(struct tm *tm);
</a><a href="#h8-0-18" id="h8-0-18" class="i">+
</a><a href="#h8-0-19" id="h8-0-19" class="i">+	/* Pretty-print a tm value */
</a><a href="#h8-0-20" id="h8-0-20" class="i">+	char *(*pretty)(struct tm *tm);
</a><a href="#h8-0-21" id="h8-0-21" class="i">+};
</a><a href="#h8-0-22" id="h8-0-22" class="i">+
</a><a href="#h8-0-23" id="h8-0-23" class="i">+struct authorstat {
</a><a href="#h8-0-24" id="h8-0-24" class="i">+	long total;
</a><a href="#h8-0-25" id="h8-0-25" class="i">+	struct string_list list;
</a><a href="#h8-0-26" id="h8-0-26" class="i">+};
</a><a href="#h8-0-27" id="h8-0-27" class="i">+
</a><a href="#h8-0-28" id="h8-0-28" class="i">+#define DAY_SECS (60 * 60 * 24)
</a><a href="#h8-0-29" id="h8-0-29" class="i">+#define WEEK_SECS (DAY_SECS * 7)
</a><a href="#h8-0-30" id="h8-0-30" class="i">+
</a><a href="#h8-0-31" id="h8-0-31" class="i">+static void trunc_week(struct tm *tm)
</a><a href="#h8-0-32" id="h8-0-32" class="i">+{
</a><a href="#h8-0-33" id="h8-0-33" class="i">+	time_t t = timegm(tm);
</a><a href="#h8-0-34" id="h8-0-34" class="i">+	t -= ((tm-&gt;tm_wday + 6) % 7) * DAY_SECS;
</a><a href="#h8-0-35" id="h8-0-35" class="i">+	gmtime_r(&amp;t, tm);	
</a><a href="#h8-0-36" id="h8-0-36" class="i">+}
</a><a href="#h8-0-37" id="h8-0-37" class="i">+
</a><a href="#h8-0-38" id="h8-0-38" class="i">+static void dec_week(struct tm *tm)
</a><a href="#h8-0-39" id="h8-0-39" class="i">+{
</a><a href="#h8-0-40" id="h8-0-40" class="i">+	time_t t = timegm(tm);
</a><a href="#h8-0-41" id="h8-0-41" class="i">+	t -= WEEK_SECS;
</a><a href="#h8-0-42" id="h8-0-42" class="i">+	gmtime_r(&amp;t, tm);	
</a><a href="#h8-0-43" id="h8-0-43" class="i">+}
</a><a href="#h8-0-44" id="h8-0-44" class="i">+
</a><a href="#h8-0-45" id="h8-0-45" class="i">+static void inc_week(struct tm *tm)
</a><a href="#h8-0-46" id="h8-0-46" class="i">+{
</a><a href="#h8-0-47" id="h8-0-47" class="i">+	time_t t = timegm(tm);
</a><a href="#h8-0-48" id="h8-0-48" class="i">+	t += WEEK_SECS;
</a><a href="#h8-0-49" id="h8-0-49" class="i">+	gmtime_r(&amp;t, tm);	
</a><a href="#h8-0-50" id="h8-0-50" class="i">+}
</a><a href="#h8-0-51" id="h8-0-51" class="i">+
</a><a href="#h8-0-52" id="h8-0-52" class="i">+static char *pretty_week(struct tm *tm)
</a><a href="#h8-0-53" id="h8-0-53" class="i">+{
</a><a href="#h8-0-54" id="h8-0-54" class="i">+	static char buf[10];
</a><a href="#h8-0-55" id="h8-0-55" class="i">+
</a><a href="#h8-0-56" id="h8-0-56" class="i">+	strftime(buf, sizeof(buf), &quot;W%V %G&quot;, tm);
</a><a href="#h8-0-57" id="h8-0-57" class="i">+	return buf;
</a><a href="#h8-0-58" id="h8-0-58" class="i">+}
</a><a href="#h8-0-59" id="h8-0-59" class="i">+
</a><a href="#h8-0-60" id="h8-0-60" class="i">+static void trunc_month(struct tm *tm)
</a><a href="#h8-0-61" id="h8-0-61" class="i">+{
</a><a href="#h8-0-62" id="h8-0-62" class="i">+	tm-&gt;tm_mday = 1;
</a><a href="#h8-0-63" id="h8-0-63" class="i">+}
</a><a href="#h8-0-64" id="h8-0-64" class="i">+
</a><a href="#h8-0-65" id="h8-0-65" class="i">+static void dec_month(struct tm *tm)
</a><a href="#h8-0-66" id="h8-0-66" class="i">+{
</a><a href="#h8-0-67" id="h8-0-67" class="i">+	tm-&gt;tm_mon--;
</a><a href="#h8-0-68" id="h8-0-68" class="i">+	if (tm-&gt;tm_mon &lt; 0) {
</a><a href="#h8-0-69" id="h8-0-69" class="i">+		tm-&gt;tm_year--;
</a><a href="#h8-0-70" id="h8-0-70" class="i">+		tm-&gt;tm_mon = 11;
</a><a href="#h8-0-71" id="h8-0-71" class="i">+	}
</a><a href="#h8-0-72" id="h8-0-72" class="i">+}
</a><a href="#h8-0-73" id="h8-0-73" class="i">+
</a><a href="#h8-0-74" id="h8-0-74" class="i">+static void inc_month(struct tm *tm)
</a><a href="#h8-0-75" id="h8-0-75" class="i">+{
</a><a href="#h8-0-76" id="h8-0-76" class="i">+	tm-&gt;tm_mon++;
</a><a href="#h8-0-77" id="h8-0-77" class="i">+	if (tm-&gt;tm_mon &gt; 11) {
</a><a href="#h8-0-78" id="h8-0-78" class="i">+		tm-&gt;tm_year++;
</a><a href="#h8-0-79" id="h8-0-79" class="i">+		tm-&gt;tm_mon = 0;
</a><a href="#h8-0-80" id="h8-0-80" class="i">+	}
</a><a href="#h8-0-81" id="h8-0-81" class="i">+}
</a><a href="#h8-0-82" id="h8-0-82" class="i">+
</a><a href="#h8-0-83" id="h8-0-83" class="i">+static char *pretty_month(struct tm *tm)
</a><a href="#h8-0-84" id="h8-0-84" class="i">+{
</a><a href="#h8-0-85" id="h8-0-85" class="i">+	static const char *months[] = {
</a><a href="#h8-0-86" id="h8-0-86" class="i">+		&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,
</a><a href="#h8-0-87" id="h8-0-87" class="i">+		&quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;
</a><a href="#h8-0-88" id="h8-0-88" class="i">+	};
</a><a href="#h8-0-89" id="h8-0-89" class="i">+	return fmt(&quot;%s %d&quot;, months[tm-&gt;tm_mon], tm-&gt;tm_year + 1900);
</a><a href="#h8-0-90" id="h8-0-90" class="i">+}
</a><a href="#h8-0-91" id="h8-0-91" class="i">+
</a><a href="#h8-0-92" id="h8-0-92" class="i">+static void trunc_quarter(struct tm *tm)
</a><a href="#h8-0-93" id="h8-0-93" class="i">+{
</a><a href="#h8-0-94" id="h8-0-94" class="i">+	trunc_month(tm);
</a><a href="#h8-0-95" id="h8-0-95" class="i">+	while(tm-&gt;tm_mon % 3 != 0)
</a><a href="#h8-0-96" id="h8-0-96" class="i">+		dec_month(tm);
</a><a href="#h8-0-97" id="h8-0-97" class="i">+}
</a><a href="#h8-0-98" id="h8-0-98" class="i">+
</a><a href="#h8-0-99" id="h8-0-99" class="i">+static void dec_quarter(struct tm *tm)
</a><a href="#h8-0-100" id="h8-0-100" class="i">+{
</a><a href="#h8-0-101" id="h8-0-101" class="i">+	dec_month(tm);
</a><a href="#h8-0-102" id="h8-0-102" class="i">+	dec_month(tm);
</a><a href="#h8-0-103" id="h8-0-103" class="i">+	dec_month(tm);
</a><a href="#h8-0-104" id="h8-0-104" class="i">+}
</a><a href="#h8-0-105" id="h8-0-105" class="i">+
</a><a href="#h8-0-106" id="h8-0-106" class="i">+static void inc_quarter(struct tm *tm)
</a><a href="#h8-0-107" id="h8-0-107" class="i">+{
</a><a href="#h8-0-108" id="h8-0-108" class="i">+	inc_month(tm);
</a><a href="#h8-0-109" id="h8-0-109" class="i">+	inc_month(tm);
</a><a href="#h8-0-110" id="h8-0-110" class="i">+	inc_month(tm);
</a><a href="#h8-0-111" id="h8-0-111" class="i">+}
</a><a href="#h8-0-112" id="h8-0-112" class="i">+
</a><a href="#h8-0-113" id="h8-0-113" class="i">+static char *pretty_quarter(struct tm *tm)
</a><a href="#h8-0-114" id="h8-0-114" class="i">+{
</a><a href="#h8-0-115" id="h8-0-115" class="i">+	return fmt(&quot;Q%d %d&quot;, tm-&gt;tm_mon / 3 + 1, tm-&gt;tm_year + 1900);
</a><a href="#h8-0-116" id="h8-0-116" class="i">+}
</a><a href="#h8-0-117" id="h8-0-117" class="i">+
</a><a href="#h8-0-118" id="h8-0-118" class="i">+static void trunc_year(struct tm *tm)
</a><a href="#h8-0-119" id="h8-0-119" class="i">+{
</a><a href="#h8-0-120" id="h8-0-120" class="i">+	trunc_month(tm);
</a><a href="#h8-0-121" id="h8-0-121" class="i">+	tm-&gt;tm_mon = 0;
</a><a href="#h8-0-122" id="h8-0-122" class="i">+}
</a><a href="#h8-0-123" id="h8-0-123" class="i">+
</a><a href="#h8-0-124" id="h8-0-124" class="i">+static void dec_year(struct tm *tm)
</a><a href="#h8-0-125" id="h8-0-125" class="i">+{
</a><a href="#h8-0-126" id="h8-0-126" class="i">+	tm-&gt;tm_year--;
</a><a href="#h8-0-127" id="h8-0-127" class="i">+}
</a><a href="#h8-0-128" id="h8-0-128" class="i">+
</a><a href="#h8-0-129" id="h8-0-129" class="i">+static void inc_year(struct tm *tm)
</a><a href="#h8-0-130" id="h8-0-130" class="i">+{
</a><a href="#h8-0-131" id="h8-0-131" class="i">+	tm-&gt;tm_year++;
</a><a href="#h8-0-132" id="h8-0-132" class="i">+}
</a><a href="#h8-0-133" id="h8-0-133" class="i">+
</a><a href="#h8-0-134" id="h8-0-134" class="i">+static char *pretty_year(struct tm *tm)
</a><a href="#h8-0-135" id="h8-0-135" class="i">+{
</a><a href="#h8-0-136" id="h8-0-136" class="i">+	return fmt(&quot;%d&quot;, tm-&gt;tm_year + 1900);
</a><a href="#h8-0-137" id="h8-0-137" class="i">+}
</a><a href="#h8-0-138" id="h8-0-138" class="i">+
</a><a href="#h8-0-139" id="h8-0-139" class="i">+struct Period periods[] = {
</a><a href="#h8-0-140" id="h8-0-140" class="i">+	{&#39;w&#39;, &quot;week&quot;, 12, 4, trunc_week, dec_week, inc_week, pretty_week},
</a><a href="#h8-0-141" id="h8-0-141" class="i">+	{&#39;m&#39;, &quot;month&quot;, 12, 4, trunc_month, dec_month, inc_month, pretty_month},
</a><a href="#h8-0-142" id="h8-0-142" class="i">+	{&#39;q&#39;, &quot;quarter&quot;, 12, 4, trunc_quarter, dec_quarter, inc_quarter, pretty_quarter},
</a><a href="#h8-0-143" id="h8-0-143" class="i">+	{&#39;y&#39;, &quot;year&quot;, 12, 4, trunc_year, dec_year, inc_year, pretty_year},
</a><a href="#h8-0-144" id="h8-0-144" class="i">+};
</a><a href="#h8-0-145" id="h8-0-145" class="i">+
</a><a href="#h8-0-146" id="h8-0-146" class="i">+static void add_commit(struct string_list *authors, struct commit *commit,
</a><a href="#h8-0-147" id="h8-0-147" class="i">+	struct Period *period)
</a><a href="#h8-0-148" id="h8-0-148" class="i">+{
</a><a href="#h8-0-149" id="h8-0-149" class="i">+	struct commitinfo *info;
</a><a href="#h8-0-150" id="h8-0-150" class="i">+	struct string_list_item *author, *item;
</a><a href="#h8-0-151" id="h8-0-151" class="i">+	struct authorstat *authorstat;
</a><a href="#h8-0-152" id="h8-0-152" class="i">+	struct string_list *items;
</a><a href="#h8-0-153" id="h8-0-153" class="i">+	char *tmp;
</a><a href="#h8-0-154" id="h8-0-154" class="i">+	struct tm *date;
</a><a href="#h8-0-155" id="h8-0-155" class="i">+	time_t t;
</a><a href="#h8-0-156" id="h8-0-156" class="i">+
</a><a href="#h8-0-157" id="h8-0-157" class="i">+	info = cgit_parse_commit(commit);
</a><a href="#h8-0-158" id="h8-0-158" class="i">+	tmp = xstrdup(info-&gt;author);
</a><a href="#h8-0-159" id="h8-0-159" class="i">+	author = string_list_insert(tmp, authors);
</a><a href="#h8-0-160" id="h8-0-160" class="i">+	if (!author-&gt;util)
</a><a href="#h8-0-161" id="h8-0-161" class="i">+		author-&gt;util = xcalloc(1, sizeof(struct authorstat));
</a><a href="#h8-0-162" id="h8-0-162" class="i">+	else
</a><a href="#h8-0-163" id="h8-0-163" class="i">+		free(tmp);
</a><a href="#h8-0-164" id="h8-0-164" class="i">+	authorstat = author-&gt;util;
</a><a href="#h8-0-165" id="h8-0-165" class="i">+	items = &amp;authorstat-&gt;list;
</a><a href="#h8-0-166" id="h8-0-166" class="i">+	t = info-&gt;committer_date;
</a><a href="#h8-0-167" id="h8-0-167" class="i">+	date = gmtime(&amp;t);
</a><a href="#h8-0-168" id="h8-0-168" class="i">+	period-&gt;trunc(date);
</a><a href="#h8-0-169" id="h8-0-169" class="i">+	tmp = xstrdup(period-&gt;pretty(date));
</a><a href="#h8-0-170" id="h8-0-170" class="i">+	item = string_list_insert(tmp, items);
</a><a href="#h8-0-171" id="h8-0-171" class="i">+	if (item-&gt;util)
</a><a href="#h8-0-172" id="h8-0-172" class="i">+		free(tmp);
</a><a href="#h8-0-173" id="h8-0-173" class="i">+	item-&gt;util++;
</a><a href="#h8-0-174" id="h8-0-174" class="i">+	authorstat-&gt;total++;
</a><a href="#h8-0-175" id="h8-0-175" class="i">+	cgit_free_commitinfo(info);
</a><a href="#h8-0-176" id="h8-0-176" class="i">+}
</a><a href="#h8-0-177" id="h8-0-177" class="i">+
</a><a href="#h8-0-178" id="h8-0-178" class="i">+static int cmp_total_commits(const void *a1, const void *a2)
</a><a href="#h8-0-179" id="h8-0-179" class="i">+{
</a><a href="#h8-0-180" id="h8-0-180" class="i">+	const struct string_list_item *i1 = a1;
</a><a href="#h8-0-181" id="h8-0-181" class="i">+	const struct string_list_item *i2 = a2;
</a><a href="#h8-0-182" id="h8-0-182" class="i">+	const struct authorstat *auth1 = i1-&gt;util;
</a><a href="#h8-0-183" id="h8-0-183" class="i">+	const struct authorstat *auth2 = i2-&gt;util;
</a><a href="#h8-0-184" id="h8-0-184" class="i">+
</a><a href="#h8-0-185" id="h8-0-185" class="i">+	return auth2-&gt;total - auth1-&gt;total;
</a><a href="#h8-0-186" id="h8-0-186" class="i">+}
</a><a href="#h8-0-187" id="h8-0-187" class="i">+
</a><a href="#h8-0-188" id="h8-0-188" class="i">+/* Walk the commit DAG and collect number of commits per author per
</a><a href="#h8-0-189" id="h8-0-189" class="i">+ * timeperiod into a nested string_list collection.
</a><a href="#h8-0-190" id="h8-0-190" class="i">+ */
</a><a href="#h8-0-191" id="h8-0-191" class="i">+struct string_list collect_stats(struct cgit_context *ctx,
</a><a href="#h8-0-192" id="h8-0-192" class="i">+	struct Period *period)
</a><a href="#h8-0-193" id="h8-0-193" class="i">+{
</a><a href="#h8-0-194" id="h8-0-194" class="i">+	struct string_list authors;
</a><a href="#h8-0-195" id="h8-0-195" class="i">+	struct rev_info rev;
</a><a href="#h8-0-196" id="h8-0-196" class="i">+	struct commit *commit;
</a><a href="#h8-0-197" id="h8-0-197" class="i">+	const char *argv[] = {NULL, ctx-&gt;qry.head, NULL, NULL};
</a><a href="#h8-0-198" id="h8-0-198" class="i">+	time_t now;
</a><a href="#h8-0-199" id="h8-0-199" class="i">+	long i;
</a><a href="#h8-0-200" id="h8-0-200" class="i">+	struct tm *tm;
</a><a href="#h8-0-201" id="h8-0-201" class="i">+	char tmp[11];
</a><a href="#h8-0-202" id="h8-0-202" class="i">+
</a><a href="#h8-0-203" id="h8-0-203" class="i">+	time(&amp;now);
</a><a href="#h8-0-204" id="h8-0-204" class="i">+	tm = gmtime(&amp;now);
</a><a href="#h8-0-205" id="h8-0-205" class="i">+	period-&gt;trunc(tm);
</a><a href="#h8-0-206" id="h8-0-206" class="i">+	for (i = 1; i &lt; period-&gt;count; i++)
</a><a href="#h8-0-207" id="h8-0-207" class="i">+		period-&gt;dec(tm);
</a><a href="#h8-0-208" id="h8-0-208" class="i">+	strftime(tmp, sizeof(tmp), &quot;%Y-%m-%d&quot;, tm);
</a><a href="#h8-0-209" id="h8-0-209" class="i">+	argv[2] = xstrdup(fmt(&quot;--since=%s&quot;, tmp));
</a><a href="#h8-0-210" id="h8-0-210" class="i">+	init_revisions(&amp;rev, NULL);
</a><a href="#h8-0-211" id="h8-0-211" class="i">+	rev.abbrev = DEFAULT_ABBREV;
</a><a href="#h8-0-212" id="h8-0-212" class="i">+	rev.commit_format = CMIT_FMT_DEFAULT;
</a><a href="#h8-0-213" id="h8-0-213" class="i">+	rev.no_merges = 1;
</a><a href="#h8-0-214" id="h8-0-214" class="i">+	rev.verbose_header = 1;
</a><a href="#h8-0-215" id="h8-0-215" class="i">+	rev.show_root_diff = 0;
</a><a href="#h8-0-216" id="h8-0-216" class="i">+	setup_revisions(3, argv, &amp;rev, NULL);
</a><a href="#h8-0-217" id="h8-0-217" class="i">+	prepare_revision_walk(&amp;rev);
</a><a href="#h8-0-218" id="h8-0-218" class="i">+	memset(&amp;authors, 0, sizeof(authors));
</a><a href="#h8-0-219" id="h8-0-219" class="i">+	while ((commit = get_revision(&amp;rev)) != NULL) {
</a><a href="#h8-0-220" id="h8-0-220" class="i">+		add_commit(&amp;authors, commit, period);
</a><a href="#h8-0-221" id="h8-0-221" class="i">+		free(commit-&gt;buffer);
</a><a href="#h8-0-222" id="h8-0-222" class="i">+		free_commit_list(commit-&gt;parents);
</a><a href="#h8-0-223" id="h8-0-223" class="i">+	}
</a><a href="#h8-0-224" id="h8-0-224" class="i">+	return authors;
</a><a href="#h8-0-225" id="h8-0-225" class="i">+}
</a><a href="#h8-0-226" id="h8-0-226" class="i">+
</a><a href="#h8-0-227" id="h8-0-227" class="i">+void print_combined_authorrow(struct string_list *authors, int from, int to,
</a><a href="#h8-0-228" id="h8-0-228" class="i">+	const char *name, const char *leftclass, const char *centerclass,
</a><a href="#h8-0-229" id="h8-0-229" class="i">+	const char *rightclass, struct Period *period)
</a><a href="#h8-0-230" id="h8-0-230" class="i">+{
</a><a href="#h8-0-231" id="h8-0-231" class="i">+	struct string_list_item *author;
</a><a href="#h8-0-232" id="h8-0-232" class="i">+	struct authorstat *authorstat;
</a><a href="#h8-0-233" id="h8-0-233" class="i">+	struct string_list *items;
</a><a href="#h8-0-234" id="h8-0-234" class="i">+	struct string_list_item *date;
</a><a href="#h8-0-235" id="h8-0-235" class="i">+	time_t now;
</a><a href="#h8-0-236" id="h8-0-236" class="i">+	long i, j, total, subtotal;
</a><a href="#h8-0-237" id="h8-0-237" class="i">+	struct tm *tm;
</a><a href="#h8-0-238" id="h8-0-238" class="i">+	char *tmp;
</a><a href="#h8-0-239" id="h8-0-239" class="i">+
</a><a href="#h8-0-240" id="h8-0-240" class="i">+	time(&amp;now);
</a><a href="#h8-0-241" id="h8-0-241" class="i">+	tm = gmtime(&amp;now);
</a><a href="#h8-0-242" id="h8-0-242" class="i">+	period-&gt;trunc(tm);
</a><a href="#h8-0-243" id="h8-0-243" class="i">+	for (i = 1; i &lt; period-&gt;count; i++)
</a><a href="#h8-0-244" id="h8-0-244" class="i">+		period-&gt;dec(tm);
</a><a href="#h8-0-245" id="h8-0-245" class="i">+
</a><a href="#h8-0-246" id="h8-0-246" class="i">+	total = 0;
</a><a href="#h8-0-247" id="h8-0-247" class="i">+	htmlf(&quot;&lt;tr&gt;&lt;td class=&#39;%s&#39;&gt;%s&lt;/td&gt;&quot;, leftclass,
</a><a href="#h8-0-248" id="h8-0-248" class="i">+		fmt(name, to - from + 1));
</a><a href="#h8-0-249" id="h8-0-249" class="i">+	for (j = 0; j &lt; period-&gt;count; j++) {
</a><a href="#h8-0-250" id="h8-0-250" class="i">+		tmp = period-&gt;pretty(tm);
</a><a href="#h8-0-251" id="h8-0-251" class="i">+		period-&gt;inc(tm);
</a><a href="#h8-0-252" id="h8-0-252" class="i">+		subtotal = 0;
</a><a href="#h8-0-253" id="h8-0-253" class="i">+		for (i = from; i &lt;= to; i++) {
</a><a href="#h8-0-254" id="h8-0-254" class="i">+			author = &amp;authors-&gt;items[i];
</a><a href="#h8-0-255" id="h8-0-255" class="i">+			authorstat = author-&gt;util;
</a><a href="#h8-0-256" id="h8-0-256" class="i">+			items = &amp;authorstat-&gt;list;
</a><a href="#h8-0-257" id="h8-0-257" class="i">+			date = string_list_lookup(tmp, items);
</a><a href="#h8-0-258" id="h8-0-258" class="i">+			if (date)
</a><a href="#h8-0-259" id="h8-0-259" class="i">+				subtotal += (size_t)date-&gt;util;
</a><a href="#h8-0-260" id="h8-0-260" class="i">+		}
</a><a href="#h8-0-261" id="h8-0-261" class="i">+		htmlf(&quot;&lt;td class=&#39;%s&#39;&gt;%d&lt;/td&gt;&quot;, centerclass, subtotal);
</a><a href="#h8-0-262" id="h8-0-262" class="i">+		total += subtotal;
</a><a href="#h8-0-263" id="h8-0-263" class="i">+	}
</a><a href="#h8-0-264" id="h8-0-264" class="i">+	htmlf(&quot;&lt;td class=&#39;%s&#39;&gt;%d&lt;/td&gt;&lt;/tr&gt;&quot;, rightclass, total);
</a><a href="#h8-0-265" id="h8-0-265" class="i">+}
</a><a href="#h8-0-266" id="h8-0-266" class="i">+
</a><a href="#h8-0-267" id="h8-0-267" class="i">+void print_authors(struct string_list *authors, int top, struct Period *period)
</a><a href="#h8-0-268" id="h8-0-268" class="i">+{
</a><a href="#h8-0-269" id="h8-0-269" class="i">+	struct string_list_item *author;
</a><a href="#h8-0-270" id="h8-0-270" class="i">+	struct authorstat *authorstat;
</a><a href="#h8-0-271" id="h8-0-271" class="i">+	struct string_list *items;
</a><a href="#h8-0-272" id="h8-0-272" class="i">+	struct string_list_item *date;
</a><a href="#h8-0-273" id="h8-0-273" class="i">+	time_t now;
</a><a href="#h8-0-274" id="h8-0-274" class="i">+	long i, j, total;
</a><a href="#h8-0-275" id="h8-0-275" class="i">+	struct tm *tm;
</a><a href="#h8-0-276" id="h8-0-276" class="i">+	char *tmp;
</a><a href="#h8-0-277" id="h8-0-277" class="i">+
</a><a href="#h8-0-278" id="h8-0-278" class="i">+	time(&amp;now);
</a><a href="#h8-0-279" id="h8-0-279" class="i">+	tm = gmtime(&amp;now);
</a><a href="#h8-0-280" id="h8-0-280" class="i">+	period-&gt;trunc(tm);
</a><a href="#h8-0-281" id="h8-0-281" class="i">+	for (i = 1; i &lt; period-&gt;count; i++)
</a><a href="#h8-0-282" id="h8-0-282" class="i">+		period-&gt;dec(tm);
</a><a href="#h8-0-283" id="h8-0-283" class="i">+
</a><a href="#h8-0-284" id="h8-0-284" class="i">+	html(&quot;&lt;table class=&#39;stats&#39;&gt;&lt;tr&gt;&lt;th&gt;Author&lt;/th&gt;&quot;);
</a><a href="#h8-0-285" id="h8-0-285" class="i">+	for (j = 0; j &lt; period-&gt;count; j++) {
</a><a href="#h8-0-286" id="h8-0-286" class="i">+		tmp = period-&gt;pretty(tm);
</a><a href="#h8-0-287" id="h8-0-287" class="i">+		htmlf(&quot;&lt;th&gt;%s&lt;/th&gt;&quot;, tmp);
</a><a href="#h8-0-288" id="h8-0-288" class="i">+		period-&gt;inc(tm);
</a><a href="#h8-0-289" id="h8-0-289" class="i">+	}
</a><a href="#h8-0-290" id="h8-0-290" class="i">+	html(&quot;&lt;th&gt;Total&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h8-0-291" id="h8-0-291" class="i">+
</a><a href="#h8-0-292" id="h8-0-292" class="i">+	if (top &lt;= 0 || top &gt; authors-&gt;nr)
</a><a href="#h8-0-293" id="h8-0-293" class="i">+		top = authors-&gt;nr;
</a><a href="#h8-0-294" id="h8-0-294" class="i">+
</a><a href="#h8-0-295" id="h8-0-295" class="i">+	for (i = 0; i &lt; top; i++) {
</a><a href="#h8-0-296" id="h8-0-296" class="i">+		author = &amp;authors-&gt;items[i];
</a><a href="#h8-0-297" id="h8-0-297" class="i">+		html(&quot;&lt;tr&gt;&lt;td class=&#39;left&#39;&gt;&quot;);
</a><a href="#h8-0-298" id="h8-0-298" class="i">+		html_txt(author-&gt;string);
</a><a href="#h8-0-299" id="h8-0-299" class="i">+		html(&quot;&lt;/td&gt;&quot;);
</a><a href="#h8-0-300" id="h8-0-300" class="i">+		authorstat = author-&gt;util;
</a><a href="#h8-0-301" id="h8-0-301" class="i">+		items = &amp;authorstat-&gt;list;
</a><a href="#h8-0-302" id="h8-0-302" class="i">+		total = 0;
</a><a href="#h8-0-303" id="h8-0-303" class="i">+		for (j = 0; j &lt; period-&gt;count; j++)
</a><a href="#h8-0-304" id="h8-0-304" class="i">+			period-&gt;dec(tm);
</a><a href="#h8-0-305" id="h8-0-305" class="i">+		for (j = 0; j &lt; period-&gt;count; j++) {
</a><a href="#h8-0-306" id="h8-0-306" class="i">+			tmp = period-&gt;pretty(tm);
</a><a href="#h8-0-307" id="h8-0-307" class="i">+			period-&gt;inc(tm);
</a><a href="#h8-0-308" id="h8-0-308" class="i">+			date = string_list_lookup(tmp, items);
</a><a href="#h8-0-309" id="h8-0-309" class="i">+			if (!date)
</a><a href="#h8-0-310" id="h8-0-310" class="i">+				html(&quot;&lt;td&gt;0&lt;/td&gt;&quot;);
</a><a href="#h8-0-311" id="h8-0-311" class="i">+			else {
</a><a href="#h8-0-312" id="h8-0-312" class="i">+				htmlf(&quot;&lt;td&gt;%d&lt;/td&gt;&quot;, date-&gt;util);
</a><a href="#h8-0-313" id="h8-0-313" class="i">+				total += (size_t)date-&gt;util;
</a><a href="#h8-0-314" id="h8-0-314" class="i">+			}
</a><a href="#h8-0-315" id="h8-0-315" class="i">+		}
</a><a href="#h8-0-316" id="h8-0-316" class="i">+		htmlf(&quot;&lt;td class=&#39;sum&#39;&gt;%d&lt;/td&gt;&lt;/tr&gt;&quot;, total);
</a><a href="#h8-0-317" id="h8-0-317" class="i">+	}
</a><a href="#h8-0-318" id="h8-0-318" class="i">+
</a><a href="#h8-0-319" id="h8-0-319" class="i">+	if (top &lt; authors-&gt;nr)
</a><a href="#h8-0-320" id="h8-0-320" class="i">+		print_combined_authorrow(authors, top, authors-&gt;nr - 1,
</a><a href="#h8-0-321" id="h8-0-321" class="i">+			&quot;Others (%d)&quot;, &quot;left&quot;, &quot;&quot;, &quot;sum&quot;, period);
</a><a href="#h8-0-322" id="h8-0-322" class="i">+
</a><a href="#h8-0-323" id="h8-0-323" class="i">+	print_combined_authorrow(authors, 0, authors-&gt;nr - 1, &quot;Total&quot;,
</a><a href="#h8-0-324" id="h8-0-324" class="i">+		&quot;total&quot;, &quot;sum&quot;, &quot;sum&quot;, period);
</a><a href="#h8-0-325" id="h8-0-325" class="i">+	html(&quot;&lt;/table&gt;&quot;);
</a><a href="#h8-0-326" id="h8-0-326" class="i">+}
</a><a href="#h8-0-327" id="h8-0-327" class="i">+
</a><a href="#h8-0-328" id="h8-0-328" class="i">+/* Create a sorted string_list with one entry per author. The util-field
</a><a href="#h8-0-329" id="h8-0-329" class="i">+ * for each author is another string_list which is used to calculate the
</a><a href="#h8-0-330" id="h8-0-330" class="i">+ * number of commits per time-interval.
</a><a href="#h8-0-331" id="h8-0-331" class="i">+ */
</a><a href="#h8-0-332" id="h8-0-332" class="i">+void cgit_show_stats(struct cgit_context *ctx)
</a><a href="#h8-0-333" id="h8-0-333" class="i">+{
</a><a href="#h8-0-334" id="h8-0-334" class="i">+	struct string_list authors;
</a><a href="#h8-0-335" id="h8-0-335" class="i">+	struct Period *period;
</a><a href="#h8-0-336" id="h8-0-336" class="i">+	int top, i;
</a><a href="#h8-0-337" id="h8-0-337" class="i">+
</a><a href="#h8-0-338" id="h8-0-338" class="i">+	period = &amp;periods[0];
</a><a href="#h8-0-339" id="h8-0-339" class="i">+	if (ctx-&gt;qry.period) {
</a><a href="#h8-0-340" id="h8-0-340" class="i">+		for (i = 0; i &lt; sizeof(periods) / sizeof(periods[0]); i++)
</a><a href="#h8-0-341" id="h8-0-341" class="i">+			if (periods[i].code == ctx-&gt;qry.period[0]) {
</a><a href="#h8-0-342" id="h8-0-342" class="i">+				period = &amp;periods[i];
</a><a href="#h8-0-343" id="h8-0-343" class="i">+				break;
</a><a href="#h8-0-344" id="h8-0-344" class="i">+			}
</a><a href="#h8-0-345" id="h8-0-345" class="i">+	}
</a><a href="#h8-0-346" id="h8-0-346" class="i">+	authors = collect_stats(ctx, period);
</a><a href="#h8-0-347" id="h8-0-347" class="i">+	qsort(authors.items, authors.nr, sizeof(struct string_list_item),
</a><a href="#h8-0-348" id="h8-0-348" class="i">+		cmp_total_commits);
</a><a href="#h8-0-349" id="h8-0-349" class="i">+
</a><a href="#h8-0-350" id="h8-0-350" class="i">+	top = ctx-&gt;qry.ofs;
</a><a href="#h8-0-351" id="h8-0-351" class="i">+	if (!top)
</a><a href="#h8-0-352" id="h8-0-352" class="i">+		top = 10;
</a><a href="#h8-0-353" id="h8-0-353" class="i">+	htmlf(&quot;&lt;h2&gt;Commits per author per %s&lt;/h2&gt;&quot;, period-&gt;name);
</a><a href="#h8-0-354" id="h8-0-354" class="i">+
</a><a href="#h8-0-355" id="h8-0-355" class="i">+	html(&quot;&lt;form method=&#39;get&#39; action=&#39;.&#39; style=&#39;float: right; text-align: right;&#39;&gt;&quot;);
</a><a href="#h8-0-356" id="h8-0-356" class="i">+	if (strcmp(ctx-&gt;qry.head, ctx-&gt;repo-&gt;defbranch))
</a><a href="#h8-0-357" id="h8-0-357" class="i">+		htmlf(&quot;&lt;input type=&#39;hidden&#39; name=&#39;h&#39; value=&#39;%s&#39;/&gt;&quot;, ctx-&gt;qry.head);
</a><a href="#h8-0-358" id="h8-0-358" class="i">+	html(&quot;Period: &quot;);
</a><a href="#h8-0-359" id="h8-0-359" class="i">+	html(&quot;&lt;select name=&#39;period&#39; onchange=&#39;this.form.submit();&#39;&gt;&quot;);
</a><a href="#h8-0-360" id="h8-0-360" class="i">+	for (i = 0; i &lt; sizeof(periods) / sizeof(periods[0]); i++)
</a><a href="#h8-0-361" id="h8-0-361" class="i">+		htmlf(&quot;&lt;option value=&#39;%c&#39;%s&gt;%s&lt;/option&gt;&quot;,
</a><a href="#h8-0-362" id="h8-0-362" class="i">+			periods[i].code,
</a><a href="#h8-0-363" id="h8-0-363" class="i">+			period == &amp;periods[i] ? &quot; selected&quot; : &quot;&quot;,
</a><a href="#h8-0-364" id="h8-0-364" class="i">+			periods[i].name);
</a><a href="#h8-0-365" id="h8-0-365" class="i">+	html(&quot;&lt;/select&gt;&lt;br/&gt;&lt;br/&gt;&quot;);
</a><a href="#h8-0-366" id="h8-0-366" class="i">+	html(&quot;Authors: &quot;);
</a><a href="#h8-0-367" id="h8-0-367" class="i">+	html(&quot;&quot;);
</a><a href="#h8-0-368" id="h8-0-368" class="i">+	html(&quot;&lt;select name=&#39;ofs&#39; onchange=&#39;this.form.submit();&#39;&gt;&quot;);
</a><a href="#h8-0-369" id="h8-0-369" class="i">+	htmlf(&quot;&lt;option value=&#39;10&#39;%s&gt;10&lt;/option&gt;&quot;, top == 10 ? &quot; selected&quot; : &quot;&quot;);
</a><a href="#h8-0-370" id="h8-0-370" class="i">+	htmlf(&quot;&lt;option value=&#39;25&#39;%s&gt;25&lt;/option&gt;&quot;, top == 25 ? &quot; selected&quot; : &quot;&quot;);
</a><a href="#h8-0-371" id="h8-0-371" class="i">+	htmlf(&quot;&lt;option value=&#39;50&#39;%s&gt;50&lt;/option&gt;&quot;, top == 50 ? &quot; selected&quot; : &quot;&quot;);
</a><a href="#h8-0-372" id="h8-0-372" class="i">+	htmlf(&quot;&lt;option value=&#39;100&#39;%s&gt;100&lt;/option&gt;&quot;, top == 100 ? &quot; selected&quot; : &quot;&quot;);
</a><a href="#h8-0-373" id="h8-0-373" class="i">+	htmlf(&quot;&lt;option value=&#39;-1&#39;%s&gt;All&lt;/option&gt;&quot;, top == -1 ? &quot; selected&quot; : &quot;&quot;);
</a><a href="#h8-0-374" id="h8-0-374" class="i">+	html(&quot;&lt;/select&gt;&quot;);
</a><a href="#h8-0-375" id="h8-0-375" class="i">+	html(&quot;&lt;noscript&gt;&amp;nbsp;&amp;nbsp;&lt;input type=&#39;submit&#39; value=&#39;Reload&#39;/&gt;&lt;/noscript&gt;&quot;);
</a><a href="#h8-0-376" id="h8-0-376" class="i">+	html(&quot;&lt;/form&gt;&quot;);
</a><a href="#h8-0-377" id="h8-0-377" class="i">+	print_authors(&amp;authors, top, period);
</a><a href="#h8-0-378" id="h8-0-378" class="i">+}
</a><a href="#h8-0-379" id="h8-0-379" class="i">+
</a><b>diff --git a/<a id="h9" href="../file/ui-stats.h.html">ui-stats.h</a> b/<a href="../file/ui-stats.h.html">ui-stats.h</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+#ifndef UI_STATS_H
</a><a href="#h9-0-1" id="h9-0-1" class="i">+#define UI_STATS_H
</a><a href="#h9-0-2" id="h9-0-2" class="i">+
</a><a href="#h9-0-3" id="h9-0-3" class="i">+#include &quot;cgit.h&quot;
</a><a href="#h9-0-4" id="h9-0-4" class="i">+
</a><a href="#h9-0-5" id="h9-0-5" class="i">+extern void cgit_show_stats(struct cgit_context *ctx);
</a><a href="#h9-0-6" id="h9-0-6" class="i">+
</a><a href="#h9-0-7" id="h9-0-7" class="i">+#endif /* UI_STATS_H */
</a></pre>
</div>
</body>
</html>
