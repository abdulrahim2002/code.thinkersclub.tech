<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>use struct strbuf instead of static buffers - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/fb3655df3bf85bd405c5921bbd4b3a54c705c839.html">fb3655df3bf85bd405c5921bbd4b3a54c705c839</a>
<b>parent</b> <a href="../commit/42d5476f258e7909682f1b611da00d64507d45c6.html">42d5476f258e7909682f1b611da00d64507d45c6</a>
<b>Author:</b> John Keeping &lt;<a href="mailto:john@keeping.me.uk">john@keeping.me.uk</a>&gt;
<b>Date:</b>   Sat,  6 Apr 2013 10:28:57 +0100

use struct strbuf instead of static buffers

Use &quot;struct strbuf&quot; from Git to remove the limit on file path length.

Notes on scan-tree:
This is slightly involved since I decided to pass the strbuf into
add_repo() and modify if whenever a new file name is required, which
should avoid any extra allocations within that function.  The pattern
there is to append the filename, use it and then reset the buffer to its
original length (retaining a trailing &#39;/&#39;).

Notes on ui-snapshot:
Since write_archive modifies the argv array passed to it we
copy the argv_array values into a new array of char* and then free the
original argv_array structure and the new array without worrying about
what the values now look like.

Signed-off-by: John Keeping &lt;john@keeping.me.uk&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">cache.c</a></td><td> | </td><td class="num">57</td><td><span class="i">++++++++++++++++++++</span><span class="d">-------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">cgit.c</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">scan-tree.c</a></td><td> | </td><td class="num">160</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">ui-log.c</a></td><td> | </td><td class="num">33</td><td><span class="i">++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">ui-plain.c</a></td><td> | </td><td class="num">6</td><td><span class="i">++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">ui-refs.c</a></td><td> | </td><td class="num">10</td><td><span class="i">++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">ui-repolist.c</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">ui-shared.c</a></td><td> | </td><td class="num">63</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">ui-snapshot.c</a></td><td> | </td><td class="num">60</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">ui-summary.c</a></td><td> | </td><td class="num">12</td><td><span class="i">++++++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">ui-tag.c</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++++</span><span class="d">-----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">ui-tree.c</a></td><td> | </td><td class="num">33</td><td><span class="i">+++++++++++++++++</span><span class="d">----------------</span></td></tr>
</table></pre><pre>12 files changed, 305 insertions(+), 243 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/cache.c.html">cache.c</a> b/<a href="../file/cache.c.html">cache.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -312,9 +312,9 @@ int cache_process(int size, const char *path, const char *key, int ttl,
</a> 		  cache_fill_fn fn, void *cbdata)
 {
 	unsigned long hash;
<a href="#h0-0-3" id="h0-0-3" class="d">-	int len, i;
</a><a href="#h0-0-4" id="h0-0-4" class="d">-	char filename[1024];
</a><a href="#h0-0-5" id="h0-0-5" class="d">-	char lockname[1024 + 5];  /* 5 = &quot;.lock&quot; */
</a><a href="#h0-0-6" id="h0-0-6" class="i">+	int i;
</a><a href="#h0-0-7" id="h0-0-7" class="i">+	struct strbuf filename = STRBUF_INIT;
</a><a href="#h0-0-8" id="h0-0-8" class="i">+	struct strbuf lockname = STRBUF_INIT;
</a> 	struct cache_slot slot;
 
 	/* If the cache is disabled, just generate the content */
<a href="#h0-1" id="h0-1" class="h">@@ -329,32 +329,22 @@ int cache_process(int size, const char *path, const char *key, int ttl,
</a> 		fn(cbdata);
 		return 0;
 	}
<a href="#h0-1-3" id="h0-1-3" class="d">-	len = strlen(path);
</a><a href="#h0-1-4" id="h0-1-4" class="d">-	if (len &gt; sizeof(filename) - 10) { /* 10 = &quot;/01234567\0&quot; */
</a><a href="#h0-1-5" id="h0-1-5" class="d">-		cache_log(&quot;[cgit] Cache path too long, caching is disabled: %s\n&quot;,
</a><a href="#h0-1-6" id="h0-1-6" class="d">-			  path);
</a><a href="#h0-1-7" id="h0-1-7" class="d">-		fn(cbdata);
</a><a href="#h0-1-8" id="h0-1-8" class="d">-		return 0;
</a><a href="#h0-1-9" id="h0-1-9" class="d">-	}
</a> 	if (!key)
 		key = &quot;&quot;;
 	hash = hash_str(key) % size;
<a href="#h0-1-13" id="h0-1-13" class="d">-	strcpy(filename, path);
</a><a href="#h0-1-14" id="h0-1-14" class="d">-	if (filename[len - 1] != &#39;/&#39;)
</a><a href="#h0-1-15" id="h0-1-15" class="d">-		filename[len++] = &#39;/&#39;;
</a><a href="#h0-1-16" id="h0-1-16" class="i">+	strbuf_addstr(&amp;filename, path);
</a><a href="#h0-1-17" id="h0-1-17" class="i">+	strbuf_ensure_end(&amp;filename, &#39;/&#39;);
</a> 	for (i = 0; i &lt; 8; i++) {
<a href="#h0-1-19" id="h0-1-19" class="d">-		sprintf(filename + len++, &quot;%x&quot;,
</a><a href="#h0-1-20" id="h0-1-20" class="d">-			(unsigned char)(hash &amp; 0xf));
</a><a href="#h0-1-21" id="h0-1-21" class="i">+		strbuf_addf(&amp;filename, &quot;%x&quot;, (unsigned char)(hash &amp; 0xf));
</a> 		hash &gt;&gt;= 4;
 	}
<a href="#h0-1-24" id="h0-1-24" class="d">-	filename[len] = &#39;\0&#39;;
</a><a href="#h0-1-25" id="h0-1-25" class="d">-	strcpy(lockname, filename);
</a><a href="#h0-1-26" id="h0-1-26" class="d">-	strcpy(lockname + len, &quot;.lock&quot;);
</a><a href="#h0-1-27" id="h0-1-27" class="i">+	strbuf_addbuf(&amp;lockname, &amp;filename);
</a><a href="#h0-1-28" id="h0-1-28" class="i">+	strbuf_addstr(&amp;lockname, &quot;.lock&quot;);
</a> 	slot.fn = fn;
 	slot.cbdata = cbdata;
 	slot.ttl = ttl;
<a href="#h0-1-32" id="h0-1-32" class="d">-	slot.cache_name = filename;
</a><a href="#h0-1-33" id="h0-1-33" class="d">-	slot.lock_name = lockname;
</a><a href="#h0-1-34" id="h0-1-34" class="i">+	slot.cache_name = strbuf_detach(&amp;filename, NULL);
</a><a href="#h0-1-35" id="h0-1-35" class="i">+	slot.lock_name = strbuf_detach(&amp;lockname, NULL);
</a> 	slot.key = key;
 	slot.keylen = strlen(key);
 	return process_slot(&amp;slot);
<a href="#h0-2" id="h0-2" class="h">@@ -381,18 +371,13 @@ int cache_ls(const char *path)
</a> 	struct dirent *ent;
 	int err = 0;
 	struct cache_slot slot;
<a href="#h0-2-3" id="h0-2-3" class="d">-	char fullname[1024];
</a><a href="#h0-2-4" id="h0-2-4" class="d">-	char *name;
</a><a href="#h0-2-5" id="h0-2-5" class="i">+	struct strbuf fullname = STRBUF_INIT;
</a><a href="#h0-2-6" id="h0-2-6" class="i">+	size_t prefixlen;
</a> 
 	if (!path) {
 		cache_log(&quot;[cgit] cache path not specified\n&quot;);
 		return -1;
 	}
<a href="#h0-2-12" id="h0-2-12" class="d">-	if (strlen(path) &gt; 1024 - 10) {
</a><a href="#h0-2-13" id="h0-2-13" class="d">-		cache_log(&quot;[cgit] cache path too long: %s\n&quot;,
</a><a href="#h0-2-14" id="h0-2-14" class="d">-			  path);
</a><a href="#h0-2-15" id="h0-2-15" class="d">-		return -1;
</a><a href="#h0-2-16" id="h0-2-16" class="d">-	}
</a> 	dir = opendir(path);
 	if (!dir) {
 		err = errno;
<a href="#h0-3" id="h0-3" class="h">@@ -400,30 +385,28 @@ int cache_ls(const char *path)
</a> 			  path, strerror(err), err);
 		return err;
 	}
<a href="#h0-3-3" id="h0-3-3" class="d">-	strcpy(fullname, path);
</a><a href="#h0-3-4" id="h0-3-4" class="d">-	name = fullname + strlen(path);
</a><a href="#h0-3-5" id="h0-3-5" class="d">-	if (*(name - 1) != &#39;/&#39;) {
</a><a href="#h0-3-6" id="h0-3-6" class="d">-		*name++ = &#39;/&#39;;
</a><a href="#h0-3-7" id="h0-3-7" class="d">-		*name = &#39;\0&#39;;
</a><a href="#h0-3-8" id="h0-3-8" class="d">-	}
</a><a href="#h0-3-9" id="h0-3-9" class="d">-	slot.cache_name = fullname;
</a><a href="#h0-3-10" id="h0-3-10" class="i">+	strbuf_addstr(&amp;fullname, path);
</a><a href="#h0-3-11" id="h0-3-11" class="i">+	strbuf_ensure_end(&amp;fullname, &#39;/&#39;);
</a><a href="#h0-3-12" id="h0-3-12" class="i">+	prefixlen = fullname.len;
</a> 	while ((ent = readdir(dir)) != NULL) {
 		if (strlen(ent-&gt;d_name) != 8)
 			continue;
<a href="#h0-3-16" id="h0-3-16" class="d">-		strcpy(name, ent-&gt;d_name);
</a><a href="#h0-3-17" id="h0-3-17" class="i">+		strbuf_setlen(&amp;fullname, prefixlen);
</a><a href="#h0-3-18" id="h0-3-18" class="i">+		strbuf_addstr(&amp;fullname, ent-&gt;d_name);
</a> 		if ((err = open_slot(&amp;slot)) != 0) {
 			cache_log(&quot;[cgit] unable to open path %s: %s (%d)\n&quot;,
<a href="#h0-3-21" id="h0-3-21" class="d">-				  fullname, strerror(err), err);
</a><a href="#h0-3-22" id="h0-3-22" class="i">+				  fullname.buf, strerror(err), err);
</a> 			continue;
 		}
 		printf(&quot;%s %s %10&quot;PRIuMAX&quot; %s\n&quot;,
<a href="#h0-3-26" id="h0-3-26" class="d">-		       name,
</a><a href="#h0-3-27" id="h0-3-27" class="i">+		       fullname.buf,
</a> 		       sprintftime(&quot;%Y-%m-%d %H:%M:%S&quot;,
 				   slot.cache_st.st_mtime),
 		       (uintmax_t)slot.cache_st.st_size,
 		       slot.buf);
 		close_slot(&amp;slot);
 	}
<a href="#h0-3-34" id="h0-3-34" class="i">+	slot.cache_name = strbuf_detach(&amp;fullname, NULL);
</a> 	closedir(dir);
 	return 0;
 }
<b>diff --git a/<a id="h1" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -468,8 +468,8 @@ static int prepare_repo_cmd(struct cgit_context *ctx)
</a> 	if (nongit) {
 		const char *name = ctx-&gt;repo-&gt;name;
 		rc = errno;
<a href="#h1-0-3" id="h1-0-3" class="d">-		ctx-&gt;page.title = fmt(&quot;%s - %s&quot;, ctx-&gt;cfg.root_title,
</a><a href="#h1-0-4" id="h1-0-4" class="d">-				      &quot;config error&quot;);
</a><a href="#h1-0-5" id="h1-0-5" class="i">+		ctx-&gt;page.title = fmtalloc(&quot;%s - %s&quot;, ctx-&gt;cfg.root_title,
</a><a href="#h1-0-6" id="h1-0-6" class="i">+						&quot;config error&quot;);
</a> 		ctx-&gt;repo = NULL;
 		cgit_print_http_headers(ctx);
 		cgit_print_docstart(ctx);
<a href="#h1-1" id="h1-1" class="h">@@ -479,7 +479,7 @@ static int prepare_repo_cmd(struct cgit_context *ctx)
</a> 		cgit_print_docend();
 		return 1;
 	}
<a href="#h1-1-3" id="h1-1-3" class="d">-	ctx-&gt;page.title = fmt(&quot;%s - %s&quot;, ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;desc);
</a><a href="#h1-1-4" id="h1-1-4" class="i">+	ctx-&gt;page.title = fmtalloc(&quot;%s - %s&quot;, ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;desc);
</a> 
 	if (!ctx-&gt;repo-&gt;defbranch)
 		ctx-&gt;repo-&gt;defbranch = guess_defbranch();
<a href="#h1-2" id="h1-2" class="h">@@ -577,21 +577,16 @@ static int cmp_repos(const void *a, const void *b)
</a> static char *build_snapshot_setting(int bitmap)
 {
 	const struct cgit_snapshot_format *f;
<a href="#h1-2-3" id="h1-2-3" class="d">-	char *result = xstrdup(&quot;&quot;);
</a><a href="#h1-2-4" id="h1-2-4" class="d">-	char *tmp;
</a><a href="#h1-2-5" id="h1-2-5" class="d">-	int len;
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	struct strbuf result = STRBUF_INIT;
</a> 
 	for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
 		if (f-&gt;bit &amp; bitmap) {
<a href="#h1-2-10" id="h1-2-10" class="d">-			tmp = result;
</a><a href="#h1-2-11" id="h1-2-11" class="d">-			result = xstrdup(fmt(&quot;%s%s &quot;, tmp, f-&gt;suffix));
</a><a href="#h1-2-12" id="h1-2-12" class="d">-			free(tmp);
</a><a href="#h1-2-13" id="h1-2-13" class="i">+			if (result.len)
</a><a href="#h1-2-14" id="h1-2-14" class="i">+				strbuf_addch(&amp;result, &#39; &#39;);
</a><a href="#h1-2-15" id="h1-2-15" class="i">+			strbuf_addstr(&amp;result, f-&gt;suffix);
</a> 		}
 	}
<a href="#h1-2-18" id="h1-2-18" class="d">-	len = strlen(result);
</a><a href="#h1-2-19" id="h1-2-19" class="d">-	if (len)
</a><a href="#h1-2-20" id="h1-2-20" class="d">-		result[len - 1] = &#39;\0&#39;;
</a><a href="#h1-2-21" id="h1-2-21" class="d">-	return result;
</a><a href="#h1-2-22" id="h1-2-22" class="i">+	return strbuf_detach(&amp;result, NULL);
</a> }
 
 static char *get_first_line(char *txt)
<a href="#h1-3" id="h1-3" class="h">@@ -639,7 +634,7 @@ static void print_repo(FILE *f, struct cgit_repo *repo)
</a> 		fprintf(f, &quot;repo.source-filter=%s\n&quot;, repo-&gt;source_filter-&gt;cmd);
 	if (repo-&gt;snapshots != ctx.cfg.snapshots) {
 		char *tmp = build_snapshot_setting(repo-&gt;snapshots);
<a href="#h1-3-3" id="h1-3-3" class="d">-		fprintf(f, &quot;repo.snapshots=%s\n&quot;, tmp);
</a><a href="#h1-3-4" id="h1-3-4" class="i">+		fprintf(f, &quot;repo.snapshots=%s\n&quot;, tmp ? tmp : &quot;&quot;);
</a> 		free(tmp);
 	}
 	if (repo-&gt;max_stats != ctx.cfg.max_stats)
<a href="#h1-4" id="h1-4" class="h">@@ -661,20 +656,22 @@ static void print_repolist(FILE *f, struct cgit_repolist *list, int start)
</a>  */
 static int generate_cached_repolist(const char *path, const char *cached_rc)
 {
<a href="#h1-4-3" id="h1-4-3" class="d">-	char *locked_rc;
</a><a href="#h1-4-4" id="h1-4-4" class="i">+	struct strbuf locked_rc = STRBUF_INIT;
</a><a href="#h1-4-5" id="h1-4-5" class="i">+	int result = 0;
</a> 	int idx;
 	FILE *f;
 
<a href="#h1-4-9" id="h1-4-9" class="d">-	locked_rc = xstrdup(fmt(&quot;%s.lock&quot;, cached_rc));
</a><a href="#h1-4-10" id="h1-4-10" class="d">-	f = fopen(locked_rc, &quot;wx&quot;);
</a><a href="#h1-4-11" id="h1-4-11" class="i">+	strbuf_addf(&amp;locked_rc, &quot;%s.lock&quot;, cached_rc);
</a><a href="#h1-4-12" id="h1-4-12" class="i">+	f = fopen(locked_rc.buf, &quot;wx&quot;);
</a> 	if (!f) {
 		/* Inform about the error unless the lockfile already existed,
 		 * since that only means we&#39;ve got concurrent requests.
 		 */
<a href="#h1-4-17" id="h1-4-17" class="d">-		if (errno != EEXIST)
</a><a href="#h1-4-18" id="h1-4-18" class="i">+		result = errno;
</a><a href="#h1-4-19" id="h1-4-19" class="i">+		if (result != EEXIST)
</a> 			fprintf(stderr, &quot;[cgit] Error opening %s: %s (%d)\n&quot;,
<a href="#h1-4-21" id="h1-4-21" class="d">-				locked_rc, strerror(errno), errno);
</a><a href="#h1-4-22" id="h1-4-22" class="d">-		return errno;
</a><a href="#h1-4-23" id="h1-4-23" class="i">+				locked_rc.buf, strerror(result), result);
</a><a href="#h1-4-24" id="h1-4-24" class="i">+		goto out;
</a> 	}
 	idx = cgit_repolist.count;
 	if (ctx.cfg.project_list)
<a href="#h1-5" id="h1-5" class="h">@@ -682,55 +679,59 @@ static int generate_cached_repolist(const char *path, const char *cached_rc)
</a> 	else
 		scan_tree(path, repo_config);
 	print_repolist(f, &amp;cgit_repolist, idx);
<a href="#h1-5-3" id="h1-5-3" class="d">-	if (rename(locked_rc, cached_rc))
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	if (rename(locked_rc.buf, cached_rc))
</a> 		fprintf(stderr, &quot;[cgit] Error renaming %s to %s: %s (%d)\n&quot;,
<a href="#h1-5-6" id="h1-5-6" class="d">-			locked_rc, cached_rc, strerror(errno), errno);
</a><a href="#h1-5-7" id="h1-5-7" class="i">+			locked_rc.buf, cached_rc, strerror(errno), errno);
</a> 	fclose(f);
<a href="#h1-5-9" id="h1-5-9" class="d">-	return 0;
</a><a href="#h1-5-10" id="h1-5-10" class="i">+out:
</a><a href="#h1-5-11" id="h1-5-11" class="i">+	strbuf_release(&amp;locked_rc);
</a><a href="#h1-5-12" id="h1-5-12" class="i">+	return result;
</a> }
 
 static void process_cached_repolist(const char *path)
 {
 	struct stat st;
<a href="#h1-5-18" id="h1-5-18" class="d">-	char *cached_rc;
</a><a href="#h1-5-19" id="h1-5-19" class="i">+	struct strbuf cached_rc = STRBUF_INIT;
</a> 	time_t age;
 	unsigned long hash;
 
 	hash = hash_str(path);
 	if (ctx.cfg.project_list)
 		hash += hash_str(ctx.cfg.project_list);
<a href="#h1-5-26" id="h1-5-26" class="d">-	cached_rc = xstrdup(fmt(&quot;%s/rc-%8lx&quot;, ctx.cfg.cache_root, hash));
</a><a href="#h1-5-27" id="h1-5-27" class="i">+	strbuf_addf(&amp;cached_rc, &quot;%s/rc-%8lx&quot;, ctx.cfg.cache_root, hash);
</a> 
<a href="#h1-5-29" id="h1-5-29" class="d">-	if (stat(cached_rc, &amp;st)) {
</a><a href="#h1-5-30" id="h1-5-30" class="i">+	if (stat(cached_rc.buf, &amp;st)) {
</a> 		/* Nothing is cached, we need to scan without forking. And
 		 * if we fail to generate a cached repolist, we need to
 		 * invoke scan_tree manually.
 		 */
<a href="#h1-5-35" id="h1-5-35" class="d">-		if (generate_cached_repolist(path, cached_rc)) {
</a><a href="#h1-5-36" id="h1-5-36" class="i">+		if (generate_cached_repolist(path, cached_rc.buf)) {
</a> 			if (ctx.cfg.project_list)
 				scan_projects(path, ctx.cfg.project_list,
 					      repo_config);
 			else
 				scan_tree(path, repo_config);
 		}
<a href="#h1-5-43" id="h1-5-43" class="d">-		return;
</a><a href="#h1-5-44" id="h1-5-44" class="i">+		goto out;
</a> 	}
 
<a href="#h1-5-47" id="h1-5-47" class="d">-	parse_configfile(cached_rc, config_cb);
</a><a href="#h1-5-48" id="h1-5-48" class="i">+	parse_configfile(cached_rc.buf, config_cb);
</a> 
 	/* If the cached configfile hasn&#39;t expired, lets exit now */
 	age = time(NULL) - st.st_mtime;
 	if (age &lt;= (ctx.cfg.cache_scanrc_ttl * 60))
<a href="#h1-5-53" id="h1-5-53" class="d">-		return;
</a><a href="#h1-5-54" id="h1-5-54" class="i">+		goto out;
</a> 
 	/* The cached repolist has been parsed, but it was old. So lets
 	 * rescan the specified path and generate a new cached repolist
 	 * in a child-process to avoid latency for the current request.
 	 */
 	if (fork())
<a href="#h1-5-61" id="h1-5-61" class="d">-		return;
</a><a href="#h1-5-62" id="h1-5-62" class="i">+		goto out;
</a> 
<a href="#h1-5-64" id="h1-5-64" class="d">-	exit(generate_cached_repolist(path, cached_rc));
</a><a href="#h1-5-65" id="h1-5-65" class="i">+	exit(generate_cached_repolist(path, cached_rc.buf));
</a><a href="#h1-5-66" id="h1-5-66" class="i">+out:
</a><a href="#h1-5-67" id="h1-5-67" class="i">+	strbuf_release(&amp;cached_rc);
</a> }
 
 static void cgit_parse_args(int argc, const char **argv)
<a href="#h1-6" id="h1-6" class="h">@@ -812,7 +813,6 @@ static int calc_ttl()
</a> int main(int argc, const char **argv)
 {
 	const char *path;
<a href="#h1-6-3" id="h1-6-3" class="d">-	char *qry;
</a> 	int err, ttl;
 
 	prepare_context(&amp;ctx);
<a href="#h1-7" id="h1-7" class="h">@@ -843,9 +843,9 @@ int main(int argc, const char **argv)
</a> 			path++;
 		ctx.qry.url = xstrdup(path);
 		if (ctx.qry.raw) {
<a href="#h1-7-3" id="h1-7-3" class="d">-			qry = ctx.qry.raw;
</a><a href="#h1-7-4" id="h1-7-4" class="d">-			ctx.qry.raw = xstrdup(fmt(&quot;%s?%s&quot;, path, qry));
</a><a href="#h1-7-5" id="h1-7-5" class="d">-			free(qry);
</a><a href="#h1-7-6" id="h1-7-6" class="i">+			char *newqry = fmtalloc(&quot;%s?%s&quot;, path, ctx.qry.raw);
</a><a href="#h1-7-7" id="h1-7-7" class="i">+			free(ctx.qry.raw);
</a><a href="#h1-7-8" id="h1-7-8" class="i">+			ctx.qry.raw = newqry;
</a> 		} else
 			ctx.qry.raw = xstrdup(ctx.qry.url);
 		cgit_parse_url(ctx.qry.url);
<b>diff --git a/<a id="h2" href="../file/scan-tree.c.html">scan-tree.c</a> b/<a href="../file/scan-tree.c.html">scan-tree.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -12,38 +12,38 @@
</a> #include &quot;configfile.h&quot;
 #include &quot;html.h&quot;
 
<a href="#h2-0-3" id="h2-0-3" class="d">-#define MAX_PATH 4096
</a><a href="#h2-0-4" id="h2-0-4" class="d">-
</a> /* return 1 if path contains a objects/ directory and a HEAD file */
 static int is_git_dir(const char *path)
 {
 	struct stat st;
<a href="#h2-0-9" id="h2-0-9" class="d">-	static char buf[MAX_PATH];
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	struct strbuf pathbuf = STRBUF_INIT;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+	int result = 0;
</a> 
<a href="#h2-0-13" id="h2-0-13" class="d">-	if (snprintf(buf, MAX_PATH, &quot;%s/objects&quot;, path) &gt;= MAX_PATH) {
</a><a href="#h2-0-14" id="h2-0-14" class="d">-		fprintf(stderr, &quot;Insanely long path: %s\n&quot;, path);
</a><a href="#h2-0-15" id="h2-0-15" class="d">-		return 0;
</a><a href="#h2-0-16" id="h2-0-16" class="d">-	}
</a><a href="#h2-0-17" id="h2-0-17" class="d">-	if (stat(buf, &amp;st)) {
</a><a href="#h2-0-18" id="h2-0-18" class="i">+	strbuf_addf(&amp;pathbuf, &quot;%s/objects&quot;, path);
</a><a href="#h2-0-19" id="h2-0-19" class="i">+	if (stat(pathbuf.buf, &amp;st)) {
</a> 		if (errno != ENOENT)
 			fprintf(stderr, &quot;Error checking path %s: %s (%d)\n&quot;,
 				path, strerror(errno), errno);
<a href="#h2-0-23" id="h2-0-23" class="d">-		return 0;
</a><a href="#h2-0-24" id="h2-0-24" class="i">+		goto out;
</a> 	}
 	if (!S_ISDIR(st.st_mode))
<a href="#h2-0-27" id="h2-0-27" class="d">-		return 0;
</a><a href="#h2-0-28" id="h2-0-28" class="i">+		goto out;
</a> 
<a href="#h2-0-30" id="h2-0-30" class="d">-	sprintf(buf, &quot;%s/HEAD&quot;, path);
</a><a href="#h2-0-31" id="h2-0-31" class="d">-	if (stat(buf, &amp;st)) {
</a><a href="#h2-0-32" id="h2-0-32" class="i">+	strbuf_reset(&amp;pathbuf);
</a><a href="#h2-0-33" id="h2-0-33" class="i">+	strbuf_addf(&amp;pathbuf, &quot;%s/HEAD&quot;, path);
</a><a href="#h2-0-34" id="h2-0-34" class="i">+	if (stat(pathbuf.buf, &amp;st)) {
</a> 		if (errno != ENOENT)
 			fprintf(stderr, &quot;Error checking path %s: %s (%d)\n&quot;,
 				path, strerror(errno), errno);
<a href="#h2-0-38" id="h2-0-38" class="d">-		return 0;
</a><a href="#h2-0-39" id="h2-0-39" class="i">+		goto out;
</a> 	}
 	if (!S_ISREG(st.st_mode))
<a href="#h2-0-42" id="h2-0-42" class="d">-		return 0;
</a><a href="#h2-0-43" id="h2-0-43" class="i">+		goto out;
</a> 
<a href="#h2-0-45" id="h2-0-45" class="d">-	return 1;
</a><a href="#h2-0-46" id="h2-0-46" class="i">+	result = 1;
</a><a href="#h2-0-47" id="h2-0-47" class="i">+out:
</a><a href="#h2-0-48" id="h2-0-48" class="i">+	strbuf_release(&amp;pathbuf);
</a><a href="#h2-0-49" id="h2-0-49" class="i">+	return result;
</a> }
 
 struct cgit_repo *repo;
<a href="#h2-1" id="h2-1" class="h">@@ -75,47 +75,61 @@ static char *xstrrchr(char *s, char *from, int c)
</a> 	return from &lt; s ? NULL : from;
 }
 
<a href="#h2-1-3" id="h2-1-3" class="d">-static void add_repo(const char *base, const char *path, repo_config_fn fn)
</a><a href="#h2-1-4" id="h2-1-4" class="i">+static void add_repo(const char *base, struct strbuf *path, repo_config_fn fn)
</a> {
 	struct stat st;
 	struct passwd *pwd;
<a href="#h2-1-8" id="h2-1-8" class="d">-	char *rel, *p, *slash;
</a><a href="#h2-1-9" id="h2-1-9" class="i">+	size_t pathlen;
</a><a href="#h2-1-10" id="h2-1-10" class="i">+	struct strbuf rel = STRBUF_INIT;
</a><a href="#h2-1-11" id="h2-1-11" class="i">+	char *p, *slash;
</a> 	int n;
 	size_t size;
 
<a href="#h2-1-15" id="h2-1-15" class="d">-	if (stat(path, &amp;st)) {
</a><a href="#h2-1-16" id="h2-1-16" class="i">+	if (stat(path-&gt;buf, &amp;st)) {
</a> 		fprintf(stderr, &quot;Error accessing %s: %s (%d)\n&quot;,
<a href="#h2-1-18" id="h2-1-18" class="d">-			path, strerror(errno), errno);
</a><a href="#h2-1-19" id="h2-1-19" class="i">+			path-&gt;buf, strerror(errno), errno);
</a> 		return;
 	}
 
<a href="#h2-1-23" id="h2-1-23" class="d">-	if (ctx.cfg.strict_export &amp;&amp; stat(fmt(&quot;%s/%s&quot;, path, ctx.cfg.strict_export), &amp;st))
</a><a href="#h2-1-24" id="h2-1-24" class="d">-		return;
</a><a href="#h2-1-25" id="h2-1-25" class="i">+	strbuf_addch(path, &#39;/&#39;);
</a><a href="#h2-1-26" id="h2-1-26" class="i">+	pathlen = path-&gt;len;
</a> 
<a href="#h2-1-28" id="h2-1-28" class="d">-	if (!stat(fmt(&quot;%s/noweb&quot;, path), &amp;st))
</a><a href="#h2-1-29" id="h2-1-29" class="i">+	if (ctx.cfg.strict_export) {
</a><a href="#h2-1-30" id="h2-1-30" class="i">+		strbuf_addstr(path, ctx.cfg.strict_export);
</a><a href="#h2-1-31" id="h2-1-31" class="i">+		if(stat(path-&gt;buf, &amp;st))
</a><a href="#h2-1-32" id="h2-1-32" class="i">+			return;
</a><a href="#h2-1-33" id="h2-1-33" class="i">+		strbuf_setlen(path, pathlen);
</a><a href="#h2-1-34" id="h2-1-34" class="i">+	}
</a><a href="#h2-1-35" id="h2-1-35" class="i">+
</a><a href="#h2-1-36" id="h2-1-36" class="i">+	strbuf_addstr(path, &quot;noweb&quot;);
</a><a href="#h2-1-37" id="h2-1-37" class="i">+	if (!stat(path-&gt;buf, &amp;st))
</a> 		return;
<a href="#h2-1-39" id="h2-1-39" class="i">+	strbuf_setlen(path, pathlen);
</a> 
<a href="#h2-1-41" id="h2-1-41" class="d">-	if (base == path)
</a><a href="#h2-1-42" id="h2-1-42" class="d">-		rel = xstrdup(path);
</a><a href="#h2-1-43" id="h2-1-43" class="i">+	if (strncmp(base, path-&gt;buf, strlen(base)))
</a><a href="#h2-1-44" id="h2-1-44" class="i">+		strbuf_addbuf(&amp;rel, path);
</a> 	else
<a href="#h2-1-46" id="h2-1-46" class="d">-		rel = xstrdup(path + strlen(base) + 1);
</a><a href="#h2-1-47" id="h2-1-47" class="i">+		strbuf_addstr(&amp;rel, path-&gt;buf + strlen(base) + 1);
</a> 
<a href="#h2-1-49" id="h2-1-49" class="d">-	if (!strcmp(rel + strlen(rel) - 5, &quot;/.git&quot;))
</a><a href="#h2-1-50" id="h2-1-50" class="d">-		rel[strlen(rel) - 5] = &#39;\0&#39;;
</a><a href="#h2-1-51" id="h2-1-51" class="i">+	if (!strcmp(rel.buf + rel.len - 5, &quot;/.git&quot;))
</a><a href="#h2-1-52" id="h2-1-52" class="i">+		strbuf_setlen(&amp;rel, rel.len - 5);
</a> 
<a href="#h2-1-54" id="h2-1-54" class="d">-	repo = cgit_add_repo(rel);
</a><a href="#h2-1-55" id="h2-1-55" class="i">+	repo = cgit_add_repo(rel.buf);
</a> 	config_fn = fn;
<a href="#h2-1-57" id="h2-1-57" class="d">-	if (ctx.cfg.enable_git_config)
</a><a href="#h2-1-58" id="h2-1-58" class="d">-		git_config_from_file(gitconfig_config, fmt(&quot;%s/config&quot;, path), NULL);
</a><a href="#h2-1-59" id="h2-1-59" class="i">+	if (ctx.cfg.enable_git_config) {
</a><a href="#h2-1-60" id="h2-1-60" class="i">+		strbuf_addstr(path, &quot;config&quot;);
</a><a href="#h2-1-61" id="h2-1-61" class="i">+		git_config_from_file(gitconfig_config, path-&gt;buf, NULL);
</a><a href="#h2-1-62" id="h2-1-62" class="i">+		strbuf_setlen(path, pathlen);
</a><a href="#h2-1-63" id="h2-1-63" class="i">+	}
</a> 
 	if (ctx.cfg.remove_suffix)
 		if ((p = strrchr(repo-&gt;url, &#39;.&#39;)) &amp;&amp; !strcmp(p, &quot;.git&quot;))
 			*p = &#39;\0&#39;;
<a href="#h2-1-68" id="h2-1-68" class="d">-	repo-&gt;path = xstrdup(path);
</a><a href="#h2-1-69" id="h2-1-69" class="i">+	repo-&gt;path = xstrdup(path-&gt;buf);
</a> 	while (!repo-&gt;owner) {
 		if ((pwd = getpwuid(st.st_uid)) == NULL) {
 			fprintf(stderr, &quot;Error reading owner-info for %s: %s (%d)\n&quot;,
<a href="#h2-1-73" id="h2-1-73" class="d">-				path, strerror(errno), errno);
</a><a href="#h2-1-74" id="h2-1-74" class="i">+				path-&gt;buf, strerror(errno), errno);
</a> 			break;
 		}
 		if (pwd-&gt;pw_gecos)
<a href="#h2-2" id="h2-2" class="h">@@ -125,30 +139,32 @@ static void add_repo(const char *base, const char *path, repo_config_fn fn)
</a> 	}
 
 	if (repo-&gt;desc == cgit_default_repo_desc || !repo-&gt;desc) {
<a href="#h2-2-3" id="h2-2-3" class="d">-		p = fmt(&quot;%s/description&quot;, path);
</a><a href="#h2-2-4" id="h2-2-4" class="d">-		if (!stat(p, &amp;st))
</a><a href="#h2-2-5" id="h2-2-5" class="d">-			readfile(p, &amp;repo-&gt;desc, &amp;size);
</a><a href="#h2-2-6" id="h2-2-6" class="i">+		strbuf_addstr(path, &quot;description&quot;);
</a><a href="#h2-2-7" id="h2-2-7" class="i">+		if (!stat(path-&gt;buf, &amp;st))
</a><a href="#h2-2-8" id="h2-2-8" class="i">+			readfile(path-&gt;buf, &amp;repo-&gt;desc, &amp;size);
</a><a href="#h2-2-9" id="h2-2-9" class="i">+		strbuf_setlen(path, pathlen);
</a> 	}
 
 	if (!repo-&gt;readme) {
<a href="#h2-2-13" id="h2-2-13" class="d">-		p = fmt(&quot;%s/README.html&quot;, path);
</a><a href="#h2-2-14" id="h2-2-14" class="d">-		if (!stat(p, &amp;st))
</a><a href="#h2-2-15" id="h2-2-15" class="i">+		strbuf_addstr(path, &quot;README.html&quot;);
</a><a href="#h2-2-16" id="h2-2-16" class="i">+		if (!stat(path-&gt;buf, &amp;st))
</a> 			repo-&gt;readme = &quot;README.html&quot;;
<a href="#h2-2-18" id="h2-2-18" class="i">+		strbuf_setlen(path, pathlen);
</a> 	}
 	if (ctx.cfg.section_from_path) {
 		n  = ctx.cfg.section_from_path;
 		if (n &gt; 0) {
<a href="#h2-2-23" id="h2-2-23" class="d">-			slash = rel;
</a><a href="#h2-2-24" id="h2-2-24" class="i">+			slash = rel.buf;
</a> 			while (slash &amp;&amp; n &amp;&amp; (slash = strchr(slash, &#39;/&#39;)))
 				n--;
 		} else {
<a href="#h2-2-28" id="h2-2-28" class="d">-			slash = rel + strlen(rel);
</a><a href="#h2-2-29" id="h2-2-29" class="d">-			while (slash &amp;&amp; n &amp;&amp; (slash = xstrrchr(rel, slash, &#39;/&#39;)))
</a><a href="#h2-2-30" id="h2-2-30" class="i">+			slash = rel.buf + rel.len;
</a><a href="#h2-2-31" id="h2-2-31" class="i">+			while (slash &amp;&amp; n &amp;&amp; (slash = xstrrchr(rel.buf, slash, &#39;/&#39;)))
</a> 				n++;
 		}
 		if (slash &amp;&amp; !n) {
 			*slash = &#39;\0&#39;;
<a href="#h2-2-36" id="h2-2-36" class="d">-			repo-&gt;section = xstrdup(rel);
</a><a href="#h2-2-37" id="h2-2-37" class="i">+			repo-&gt;section = xstrdup(rel.buf);
</a> 			*slash = &#39;/&#39;;
 			if (!prefixcmp(repo-&gt;name, repo-&gt;section)) {
 				repo-&gt;name += strlen(repo-&gt;section);
<a href="#h2-3" id="h2-3" class="h">@@ -158,19 +174,19 @@ static void add_repo(const char *base, const char *path, repo_config_fn fn)
</a> 		}
 	}
 
<a href="#h2-3-3" id="h2-3-3" class="d">-	p = fmt(&quot;%s/cgitrc&quot;, path);
</a><a href="#h2-3-4" id="h2-3-4" class="d">-	if (!stat(p, &amp;st))
</a><a href="#h2-3-5" id="h2-3-5" class="d">-		parse_configfile(xstrdup(p), &amp;repo_config);
</a><a href="#h2-3-6" id="h2-3-6" class="d">-
</a><a href="#h2-3-7" id="h2-3-7" class="i">+	strbuf_addstr(path, &quot;cgitrc&quot;);
</a><a href="#h2-3-8" id="h2-3-8" class="i">+	if (!stat(path-&gt;buf, &amp;st))
</a><a href="#h2-3-9" id="h2-3-9" class="i">+		parse_configfile(xstrdup(path-&gt;buf), &amp;repo_config);
</a> 
<a href="#h2-3-11" id="h2-3-11" class="d">-	free(rel);
</a><a href="#h2-3-12" id="h2-3-12" class="i">+	strbuf_release(&amp;rel);
</a> }
 
 static void scan_path(const char *base, const char *path, repo_config_fn fn)
 {
 	DIR *dir = opendir(path);
 	struct dirent *ent;
<a href="#h2-3-19" id="h2-3-19" class="d">-	char *buf;
</a><a href="#h2-3-20" id="h2-3-20" class="i">+	struct strbuf pathbuf = STRBUF_INIT;
</a><a href="#h2-3-21" id="h2-3-21" class="i">+	size_t pathlen = strlen(path);
</a> 	struct stat st;
 
 	if (!dir) {
<a href="#h2-4" id="h2-4" class="h">@@ -178,14 +194,22 @@ static void scan_path(const char *base, const char *path, repo_config_fn fn)
</a> 			path, strerror(errno), errno);
 		return;
 	}
<a href="#h2-4-3" id="h2-4-3" class="d">-	if (is_git_dir(path)) {
</a><a href="#h2-4-4" id="h2-4-4" class="d">-		add_repo(base, path, fn);
</a><a href="#h2-4-5" id="h2-4-5" class="i">+
</a><a href="#h2-4-6" id="h2-4-6" class="i">+	strbuf_add(&amp;pathbuf, path, strlen(path));
</a><a href="#h2-4-7" id="h2-4-7" class="i">+	if (is_git_dir(pathbuf.buf)) {
</a><a href="#h2-4-8" id="h2-4-8" class="i">+		add_repo(base, &amp;pathbuf, fn);
</a> 		goto end;
 	}
<a href="#h2-4-11" id="h2-4-11" class="d">-	if (is_git_dir(fmt(&quot;%s/.git&quot;, path))) {
</a><a href="#h2-4-12" id="h2-4-12" class="d">-		add_repo(base, fmt(&quot;%s/.git&quot;, path), fn);
</a><a href="#h2-4-13" id="h2-4-13" class="i">+	strbuf_addstr(&amp;pathbuf, &quot;/.git&quot;);
</a><a href="#h2-4-14" id="h2-4-14" class="i">+	if (is_git_dir(pathbuf.buf)) {
</a><a href="#h2-4-15" id="h2-4-15" class="i">+		add_repo(base, &amp;pathbuf, fn);
</a> 		goto end;
 	}
<a href="#h2-4-18" id="h2-4-18" class="i">+	/*
</a><a href="#h2-4-19" id="h2-4-19" class="i">+	 * Add one because we don&#39;t want to lose the trailing &#39;/&#39; when we
</a><a href="#h2-4-20" id="h2-4-20" class="i">+	 * reset the length of pathbuf in the loop below.
</a><a href="#h2-4-21" id="h2-4-21" class="i">+	 */
</a><a href="#h2-4-22" id="h2-4-22" class="i">+	pathlen++;
</a> 	while ((ent = readdir(dir)) != NULL) {
 		if (ent-&gt;d_name[0] == &#39;.&#39;) {
 			if (ent-&gt;d_name[1] == &#39;\0&#39;)
<a href="#h2-5" id="h2-5" class="h">@@ -195,24 +219,18 @@ static void scan_path(const char *base, const char *path, repo_config_fn fn)
</a> 			if (!ctx.cfg.scan_hidden_path)
 				continue;
 		}
<a href="#h2-5-3" id="h2-5-3" class="d">-		buf = malloc(strlen(path) + strlen(ent-&gt;d_name) + 2);
</a><a href="#h2-5-4" id="h2-5-4" class="d">-		if (!buf) {
</a><a href="#h2-5-5" id="h2-5-5" class="d">-			fprintf(stderr, &quot;Alloc error on %s: %s (%d)\n&quot;,
</a><a href="#h2-5-6" id="h2-5-6" class="d">-				path, strerror(errno), errno);
</a><a href="#h2-5-7" id="h2-5-7" class="d">-			exit(1);
</a><a href="#h2-5-8" id="h2-5-8" class="d">-		}
</a><a href="#h2-5-9" id="h2-5-9" class="d">-		sprintf(buf, &quot;%s/%s&quot;, path, ent-&gt;d_name);
</a><a href="#h2-5-10" id="h2-5-10" class="d">-		if (stat(buf, &amp;st)) {
</a><a href="#h2-5-11" id="h2-5-11" class="i">+		strbuf_setlen(&amp;pathbuf, pathlen);
</a><a href="#h2-5-12" id="h2-5-12" class="i">+		strbuf_addstr(&amp;pathbuf, ent-&gt;d_name);
</a><a href="#h2-5-13" id="h2-5-13" class="i">+		if (stat(pathbuf.buf, &amp;st)) {
</a> 			fprintf(stderr, &quot;Error checking path %s: %s (%d)\n&quot;,
<a href="#h2-5-15" id="h2-5-15" class="d">-				buf, strerror(errno), errno);
</a><a href="#h2-5-16" id="h2-5-16" class="d">-			free(buf);
</a><a href="#h2-5-17" id="h2-5-17" class="i">+				pathbuf.buf, strerror(errno), errno);
</a> 			continue;
 		}
 		if (S_ISDIR(st.st_mode))
<a href="#h2-5-21" id="h2-5-21" class="d">-			scan_path(base, buf, fn);
</a><a href="#h2-5-22" id="h2-5-22" class="d">-		free(buf);
</a><a href="#h2-5-23" id="h2-5-23" class="i">+			scan_path(base, pathbuf.buf, fn);
</a> 	}
 end:
<a href="#h2-5-26" id="h2-5-26" class="i">+	strbuf_release(&amp;pathbuf);
</a> 	closedir(dir);
 }
 
<a href="#h2-6" id="h2-6" class="h">@@ -220,7 +238,7 @@ end:
</a> 
 void scan_projects(const char *path, const char *projectsfile, repo_config_fn fn)
 {
<a href="#h2-6-3" id="h2-6-3" class="d">-	char line[MAX_PATH * 2], *z;
</a><a href="#h2-6-4" id="h2-6-4" class="i">+	struct strbuf line = STRBUF_INIT;
</a> 	FILE *projects;
 	int err;
 
<a href="#h2-7" id="h2-7" class="h">@@ -230,19 +248,19 @@ void scan_projects(const char *path, const char *projectsfile, repo_config_fn fn
</a> 			projectsfile, strerror(errno), errno);
 		return;
 	}
<a href="#h2-7-3" id="h2-7-3" class="d">-	while (fgets(line, sizeof(line), projects) != NULL) {
</a><a href="#h2-7-4" id="h2-7-4" class="d">-		for (z = &amp;lastc(line);
</a><a href="#h2-7-5" id="h2-7-5" class="d">-		     strlen(line) &amp;&amp; strchr(&quot;\n\r&quot;, *z);
</a><a href="#h2-7-6" id="h2-7-6" class="d">-		     z = &amp;lastc(line))
</a><a href="#h2-7-7" id="h2-7-7" class="d">-			*z = &#39;\0&#39;;
</a><a href="#h2-7-8" id="h2-7-8" class="d">-		if (strlen(line))
</a><a href="#h2-7-9" id="h2-7-9" class="d">-			scan_path(path, fmt(&quot;%s/%s&quot;, path, line), fn);
</a><a href="#h2-7-10" id="h2-7-10" class="i">+	while (strbuf_getline(&amp;line, projects, &#39;\n&#39;) != EOF) {
</a><a href="#h2-7-11" id="h2-7-11" class="i">+		if (!line.len)
</a><a href="#h2-7-12" id="h2-7-12" class="i">+			continue;
</a><a href="#h2-7-13" id="h2-7-13" class="i">+		strbuf_insert(&amp;line, 0, &quot;/&quot;, 1);
</a><a href="#h2-7-14" id="h2-7-14" class="i">+		strbuf_insert(&amp;line, 0, path, strlen(path));
</a><a href="#h2-7-15" id="h2-7-15" class="i">+		scan_path(path, line.buf, fn);
</a> 	}
 	if ((err = ferror(projects))) {
 		fprintf(stderr, &quot;Error reading from projectsfile %s: %s (%d)\n&quot;,
 			projectsfile, strerror(err), err);
 	}
 	fclose(projects);
<a href="#h2-7-22" id="h2-7-22" class="i">+	strbuf_release(&amp;line);
</a> }
 
 void scan_tree(const char *path, repo_config_fn fn)
<b>diff --git a/<a id="h3" href="../file/ui-log.c.html">ui-log.c</a> b/<a href="../file/ui-log.c.html">ui-log.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -243,15 +243,19 @@ static void print_commit(struct commit *commit, struct rev_info *revs)
</a> 	cgit_free_commitinfo(info);
 }
 
<a href="#h3-0-3" id="h3-0-3" class="d">-static const char *disambiguate_ref(const char *ref)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+static const char *disambiguate_ref(const char *ref, int *must_free_result)
</a> {
 	unsigned char sha1[20];
<a href="#h3-0-7" id="h3-0-7" class="d">-	const char *longref;
</a><a href="#h3-0-8" id="h3-0-8" class="i">+	struct strbuf longref = STRBUF_INIT;
</a> 
<a href="#h3-0-10" id="h3-0-10" class="d">-	longref = fmt(&quot;refs/heads/%s&quot;, ref);
</a><a href="#h3-0-11" id="h3-0-11" class="d">-	if (get_sha1(longref, sha1) == 0)
</a><a href="#h3-0-12" id="h3-0-12" class="d">-		return longref;
</a><a href="#h3-0-13" id="h3-0-13" class="i">+	strbuf_addf(&amp;longref, &quot;refs/heads/%s&quot;, ref);
</a><a href="#h3-0-14" id="h3-0-14" class="i">+	if (get_sha1(longref.buf, sha1) == 0) {
</a><a href="#h3-0-15" id="h3-0-15" class="i">+		*must_free_result = 1;
</a><a href="#h3-0-16" id="h3-0-16" class="i">+		return strbuf_detach(&amp;longref, NULL);
</a><a href="#h3-0-17" id="h3-0-17" class="i">+	}
</a> 
<a href="#h3-0-19" id="h3-0-19" class="i">+	*must_free_result = 0;
</a><a href="#h3-0-20" id="h3-0-20" class="i">+	strbuf_release(&amp;longref);
</a> 	return ref;
 }
 
<a href="#h3-1" id="h3-1" class="h">@@ -284,24 +288,26 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	struct commit *commit;
 	struct vector vec = VECTOR_INIT(char *);
 	int i, columns = commit_graph ? 4 : 3;
<a href="#h3-1-3" id="h3-1-3" class="d">-	char *arg;
</a><a href="#h3-1-4" id="h3-1-4" class="i">+	int must_free_tip = 0;
</a><a href="#h3-1-5" id="h3-1-5" class="i">+	struct strbuf argbuf = STRBUF_INIT;
</a> 
 	/* First argv is NULL */
 	vector_push(&amp;vec, NULL, 0);
 
 	if (!tip)
 		tip = ctx.qry.head;
<a href="#h3-1-12" id="h3-1-12" class="d">-	tip = disambiguate_ref(tip);
</a><a href="#h3-1-13" id="h3-1-13" class="i">+	tip = disambiguate_ref(tip, &amp;must_free_tip);
</a> 	vector_push(&amp;vec, &amp;tip, 0);
 
 	if (grep &amp;&amp; pattern &amp;&amp; *pattern) {
 		pattern = xstrdup(pattern);
 		if (!strcmp(grep, &quot;grep&quot;) || !strcmp(grep, &quot;author&quot;) ||
 		    !strcmp(grep, &quot;committer&quot;)) {
<a href="#h3-1-20" id="h3-1-20" class="d">-			arg = fmt(&quot;--%s=%s&quot;, grep, pattern);
</a><a href="#h3-1-21" id="h3-1-21" class="d">-			vector_push(&amp;vec, &amp;arg, 0);
</a><a href="#h3-1-22" id="h3-1-22" class="i">+			strbuf_addf(&amp;argbuf, &quot;--%s=%s&quot;, grep, pattern);
</a><a href="#h3-1-23" id="h3-1-23" class="i">+			vector_push(&amp;vec, &amp;argbuf.buf, 0);
</a> 		}
 		if (!strcmp(grep, &quot;range&quot;)) {
<a href="#h3-1-26" id="h3-1-26" class="i">+			char *arg;
</a> 			/* Split the pattern at whitespace and add each token
 			 * as a revision expression. Do not accept other
 			 * rev-list options. Also, replace the previously
<a href="#h3-2" id="h3-2" class="h">@@ -336,8 +342,8 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	}
 
 	if (path) {
<a href="#h3-2-3" id="h3-2-3" class="d">-		arg = &quot;--&quot;;
</a><a href="#h3-2-4" id="h3-2-4" class="d">-		vector_push(&amp;vec, &amp;arg, 0);
</a><a href="#h3-2-5" id="h3-2-5" class="i">+		static const char *double_dash_arg = &quot;--&quot;;
</a><a href="#h3-2-6" id="h3-2-6" class="i">+		vector_push(&amp;vec, &amp;double_dash_arg, 0);
</a> 		vector_push(&amp;vec, &amp;path, 0);
 	}
 
<a href="#h3-3" id="h3-3" class="h">@@ -430,4 +436,9 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 			      ctx.qry.vpath, 0, NULL, NULL, ctx.qry.showmsg);
 		html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
 	}
<a href="#h3-3-3" id="h3-3-3" class="i">+
</a><a href="#h3-3-4" id="h3-3-4" class="i">+	/* If we allocated tip then it is safe to cast away const. */
</a><a href="#h3-3-5" id="h3-3-5" class="i">+	if (must_free_tip)
</a><a href="#h3-3-6" id="h3-3-6" class="i">+		free((char*) tip);
</a><a href="#h3-3-7" id="h3-3-7" class="i">+	strbuf_release(&amp;argbuf);
</a> }
<b>diff --git a/<a id="h4" href="../file/ui-plain.c.html">ui-plain.c</a> b/<a href="../file/ui-plain.c.html">ui-plain.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -109,9 +109,9 @@ static int print_object(const unsigned char *sha1, const char *path)
</a> static char *buildpath(const char *base, int baselen, const char *path)
 {
 	if (path[0])
<a href="#h4-0-3" id="h4-0-3" class="d">-		return fmt(&quot;%.*s%s/&quot;, baselen, base, path);
</a><a href="#h4-0-4" id="h4-0-4" class="i">+		return fmtalloc(&quot;%.*s%s/&quot;, baselen, base, path);
</a> 	else
<a href="#h4-0-6" id="h4-0-6" class="d">-		return fmt(&quot;%.*s/&quot;, baselen, base);
</a><a href="#h4-0-7" id="h4-0-7" class="i">+		return fmtalloc(&quot;%.*s/&quot;, baselen, base);
</a> }
 
 static void print_dir(const unsigned char *sha1, const char *base,
<a href="#h4-1" id="h4-1" class="h">@@ -142,6 +142,7 @@ static void print_dir(const unsigned char *sha1, const char *base,
</a> 				fullpath);
 		html(&quot;&lt;/li&gt;\n&quot;);
 	}
<a href="#h4-1-3" id="h4-1-3" class="i">+	free(fullpath);
</a> }
 
 static void print_dir_entry(const unsigned char *sha1, const char *base,
<a href="#h4-2" id="h4-2" class="h">@@ -159,6 +160,7 @@ static void print_dir_entry(const unsigned char *sha1, const char *base,
</a> 		cgit_plain_link(path, NULL, NULL, ctx.qry.head, ctx.qry.sha1,
 				fullpath);
 	html(&quot;&lt;/li&gt;\n&quot;);
<a href="#h4-2-3" id="h4-2-3" class="i">+	free(fullpath);
</a> }
 
 static void print_dir_tail(void)
<b>diff --git a/<a id="h5" href="../file/ui-refs.c.html">ui-refs.c</a> b/<a href="../file/ui-refs.c.html">ui-refs.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -99,7 +99,7 @@ static void print_tag_header()
</a> static void print_tag_downloads(const struct cgit_repo *repo, const char *ref)
 {
 	const struct cgit_snapshot_format* f;
<a href="#h5-0-3" id="h5-0-3" class="d">-    	char *filename;
</a><a href="#h5-0-4" id="h5-0-4" class="i">+	struct strbuf filename = STRBUF_INIT;
</a> 	const char *basename;
 	int free_ref = 0;
 
<a href="#h5-1" id="h5-1" class="h">@@ -111,7 +111,7 @@ static void print_tag_downloads(const struct cgit_repo *repo, const char *ref)
</a> 		if ((ref[0] == &#39;v&#39; || ref[0] == &#39;V&#39;) &amp;&amp; isdigit(ref[1]))
 			ref++;
 		if (isdigit(ref[0])) {
<a href="#h5-1-3" id="h5-1-3" class="d">-			ref = xstrdup(fmt(&quot;%s-%s&quot;, basename, ref));
</a><a href="#h5-1-4" id="h5-1-4" class="i">+			ref = fmtalloc(&quot;%s-%s&quot;, basename, ref);
</a> 			free_ref = 1;
 		}
 	}
<a href="#h5-2" id="h5-2" class="h">@@ -119,13 +119,15 @@ static void print_tag_downloads(const struct cgit_repo *repo, const char *ref)
</a> 	for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
 		if (!(repo-&gt;snapshots &amp; f-&gt;bit))
 			continue;
<a href="#h5-2-3" id="h5-2-3" class="d">-		filename = fmt(&quot;%s%s&quot;, ref, f-&gt;suffix);
</a><a href="#h5-2-4" id="h5-2-4" class="d">-		cgit_snapshot_link(filename, NULL, NULL, NULL, NULL, filename);
</a><a href="#h5-2-5" id="h5-2-5" class="i">+		strbuf_reset(&amp;filename);
</a><a href="#h5-2-6" id="h5-2-6" class="i">+		strbuf_addf(&amp;filename, &quot;%s%s&quot;, ref, f-&gt;suffix);
</a><a href="#h5-2-7" id="h5-2-7" class="i">+		cgit_snapshot_link(filename.buf, NULL, NULL, NULL, NULL, filename.buf);
</a> 		html(&quot;&amp;nbsp;&amp;nbsp;&quot;);
 	}
 
 	if (free_ref)
 		free((char *)ref);
<a href="#h5-2-13" id="h5-2-13" class="i">+	strbuf_release(&amp;filename);
</a> }
 
 static int print_tag(struct refinfo *ref)
<b>diff --git a/<a id="h6" href="../file/ui-repolist.c.html">ui-repolist.c</a> b/<a href="../file/ui-repolist.c.html">ui-repolist.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -33,7 +33,7 @@ static time_t read_agefile(char *path)
</a> 
 static int get_repo_modtime(const struct cgit_repo *repo, time_t *mtime)
 {
<a href="#h6-0-3" id="h6-0-3" class="d">-	char *path;
</a><a href="#h6-0-4" id="h6-0-4" class="i">+	struct strbuf path = STRBUF_INIT;
</a> 	struct stat s;
 	struct cgit_repo *r = (struct cgit_repo *)repo;
 
<a href="#h6-1" id="h6-1" class="h">@@ -41,32 +41,36 @@ static int get_repo_modtime(const struct cgit_repo *repo, time_t *mtime)
</a> 		*mtime = repo-&gt;mtime;
 		return 1;
 	}
<a href="#h6-1-3" id="h6-1-3" class="d">-	path = fmt(&quot;%s/%s&quot;, repo-&gt;path, ctx.cfg.agefile);
</a><a href="#h6-1-4" id="h6-1-4" class="d">-	if (stat(path, &amp;s) == 0) {
</a><a href="#h6-1-5" id="h6-1-5" class="d">-		*mtime = read_agefile(path);
</a><a href="#h6-1-6" id="h6-1-6" class="i">+	strbuf_addf(&amp;path, &quot;%s/%s&quot;, repo-&gt;path, ctx.cfg.agefile);
</a><a href="#h6-1-7" id="h6-1-7" class="i">+	if (stat(path.buf, &amp;s) == 0) {
</a><a href="#h6-1-8" id="h6-1-8" class="i">+		*mtime = read_agefile(path.buf);
</a> 		if (*mtime) {
 			r-&gt;mtime = *mtime;
<a href="#h6-1-11" id="h6-1-11" class="d">-			return 1;
</a><a href="#h6-1-12" id="h6-1-12" class="i">+			goto end;
</a> 		}
 	}
 
<a href="#h6-1-16" id="h6-1-16" class="d">-	path = fmt(&quot;%s/refs/heads/%s&quot;, repo-&gt;path, repo-&gt;defbranch ?
</a><a href="#h6-1-17" id="h6-1-17" class="d">-		   repo-&gt;defbranch : &quot;master&quot;);
</a><a href="#h6-1-18" id="h6-1-18" class="d">-	if (stat(path, &amp;s) == 0) {
</a><a href="#h6-1-19" id="h6-1-19" class="i">+	strbuf_reset(&amp;path);
</a><a href="#h6-1-20" id="h6-1-20" class="i">+	strbuf_addf(&amp;path, &quot;%s/refs/heads/%s&quot;, repo-&gt;path,
</a><a href="#h6-1-21" id="h6-1-21" class="i">+		    repo-&gt;defbranch ? repo-&gt;defbranch : &quot;master&quot;);
</a><a href="#h6-1-22" id="h6-1-22" class="i">+	if (stat(path.buf, &amp;s) == 0) {
</a> 		*mtime = s.st_mtime;
 		r-&gt;mtime = *mtime;
<a href="#h6-1-25" id="h6-1-25" class="d">-		return 1;
</a><a href="#h6-1-26" id="h6-1-26" class="i">+		goto end;
</a> 	}
 
<a href="#h6-1-29" id="h6-1-29" class="d">-	path = fmt(&quot;%s/%s&quot;, repo-&gt;path, &quot;packed-refs&quot;);
</a><a href="#h6-1-30" id="h6-1-30" class="d">-	if (stat(path, &amp;s) == 0) {
</a><a href="#h6-1-31" id="h6-1-31" class="i">+	strbuf_reset(&amp;path);
</a><a href="#h6-1-32" id="h6-1-32" class="i">+	strbuf_addf(&amp;path, &quot;%s/%s&quot;, repo-&gt;path, &quot;packed-refs&quot;);
</a><a href="#h6-1-33" id="h6-1-33" class="i">+	if (stat(path.buf, &amp;s) == 0) {
</a> 		*mtime = s.st_mtime;
 		r-&gt;mtime = *mtime;
<a href="#h6-1-36" id="h6-1-36" class="d">-		return 1;
</a><a href="#h6-1-37" id="h6-1-37" class="i">+		goto end;
</a> 	}
 
 	*mtime = 0;
 	r-&gt;mtime = *mtime;
<a href="#h6-1-42" id="h6-1-42" class="i">+end:
</a><a href="#h6-1-43" id="h6-1-43" class="i">+	strbuf_release(&amp;path);
</a> 	return (r-&gt;mtime != 0);
 }
 
<b>diff --git a/<a id="h7" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -62,7 +62,7 @@ const char *cgit_hosturl()
</a> 		return NULL;
 	if (!ctx.env.server_port || atoi(ctx.env.server_port) == 80)
 		return ctx.env.server_name;
<a href="#h7-0-3" id="h7-0-3" class="d">-	return xstrdup(fmt(&quot;%s:%s&quot;, ctx.env.server_name, ctx.env.server_port));
</a><a href="#h7-0-4" id="h7-0-4" class="i">+	return fmtalloc(&quot;%s:%s&quot;, ctx.env.server_name, ctx.env.server_port);
</a> }
 
 const char *cgit_rooturl()
<a href="#h7-1" id="h7-1" class="h">@@ -75,31 +75,30 @@ const char *cgit_rooturl()
</a> 
 char *cgit_repourl(const char *reponame)
 {
<a href="#h7-1-3" id="h7-1-3" class="d">-	if (ctx.cfg.virtual_root) {
</a><a href="#h7-1-4" id="h7-1-4" class="d">-		return fmt(&quot;%s%s/&quot;, ctx.cfg.virtual_root, reponame);
</a><a href="#h7-1-5" id="h7-1-5" class="d">-	} else {
</a><a href="#h7-1-6" id="h7-1-6" class="d">-		return fmt(&quot;?r=%s&quot;, reponame);
</a><a href="#h7-1-7" id="h7-1-7" class="d">-	}
</a><a href="#h7-1-8" id="h7-1-8" class="i">+	if (ctx.cfg.virtual_root)
</a><a href="#h7-1-9" id="h7-1-9" class="i">+		return fmtalloc(&quot;%s%s/&quot;, ctx.cfg.virtual_root, reponame);
</a><a href="#h7-1-10" id="h7-1-10" class="i">+	else
</a><a href="#h7-1-11" id="h7-1-11" class="i">+		return fmtalloc(&quot;?r=%s&quot;, reponame);
</a> }
 
 char *cgit_fileurl(const char *reponame, const char *pagename,
 		   const char *filename, const char *query)
 {
<a href="#h7-1-17" id="h7-1-17" class="d">-	char *tmp;
</a><a href="#h7-1-18" id="h7-1-18" class="i">+	struct strbuf sb = STRBUF_INIT;
</a> 	char *delim;
 
 	if (ctx.cfg.virtual_root) {
<a href="#h7-1-22" id="h7-1-22" class="d">-		tmp = fmt(&quot;%s%s/%s/%s&quot;, ctx.cfg.virtual_root, reponame,
</a><a href="#h7-1-23" id="h7-1-23" class="d">-			  pagename, (filename ? filename:&quot;&quot;));
</a><a href="#h7-1-24" id="h7-1-24" class="i">+		strbuf_addf(&amp;sb, &quot;%s%s/%s/%s&quot;, ctx.cfg.virtual_root, reponame,
</a><a href="#h7-1-25" id="h7-1-25" class="i">+			    pagename, (filename ? filename:&quot;&quot;));
</a> 		delim = &quot;?&quot;;
 	} else {
<a href="#h7-1-28" id="h7-1-28" class="d">-		tmp = fmt(&quot;?url=%s/%s/%s&quot;, reponame, pagename,
</a><a href="#h7-1-29" id="h7-1-29" class="d">-			  (filename ? filename : &quot;&quot;));
</a><a href="#h7-1-30" id="h7-1-30" class="i">+		strbuf_addf(&amp;sb, &quot;?url=%s/%s/%s&quot;, reponame, pagename,
</a><a href="#h7-1-31" id="h7-1-31" class="i">+			    (filename ? filename : &quot;&quot;));
</a> 		delim = &quot;&amp;amp;&quot;;
 	}
 	if (query)
<a href="#h7-1-35" id="h7-1-35" class="d">-		tmp = fmt(&quot;%s%s%s&quot;, tmp, delim, query);
</a><a href="#h7-1-36" id="h7-1-36" class="d">-	return tmp;
</a><a href="#h7-1-37" id="h7-1-37" class="i">+		strbuf_addf(&amp;sb, &quot;%s%s&quot;, delim, query);
</a><a href="#h7-1-38" id="h7-1-38" class="i">+	return strbuf_detach(&amp;sb, NULL);
</a> }
 
 char *cgit_pageurl(const char *reponame, const char *pagename,
<a href="#h7-2" id="h7-2" class="h">@@ -548,21 +547,21 @@ void cgit_submodule_link(const char *class, char *path, const char *rev)
</a> 		htmlf(&quot;class=&#39;%s&#39; &quot;, class);
 	html(&quot;href=&#39;&quot;);
 	if (item) {
<a href="#h7-2-3" id="h7-2-3" class="d">-		html_attr(fmt(item-&gt;util, rev));
</a><a href="#h7-2-4" id="h7-2-4" class="i">+		html_attrf(item-&gt;util, rev);
</a> 	} else if (ctx.repo-&gt;module_link) {
 		dir = strrchr(path, &#39;/&#39;);
 		if (dir)
 			dir++;
 		else
 			dir = path;
<a href="#h7-2-11" id="h7-2-11" class="d">-		html_attr(fmt(ctx.repo-&gt;module_link, dir, rev));
</a><a href="#h7-2-12" id="h7-2-12" class="i">+		html_attrf(ctx.repo-&gt;module_link, dir, rev);
</a> 	} else {
 		html(&quot;#&quot;);
 	}
 	html(&quot;&#39;&gt;&quot;);
 	html_txt(path);
 	html(&quot;&lt;/a&gt;&quot;);
<a href="#h7-2-19" id="h7-2-19" class="d">-	html_txt(fmt(&quot; @ %.7s&quot;, rev));
</a><a href="#h7-2-20" id="h7-2-20" class="i">+	html_txtf(&quot; @ %.7s&quot;, rev);
</a> 	if (item &amp;&amp; tail)
 		path[len - 1] = tail;
 }
<a href="#h7-3" id="h7-3" class="h">@@ -678,12 +677,16 @@ void cgit_print_docstart(struct cgit_context *ctx)
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 	}
 	if (host &amp;&amp; ctx-&gt;repo &amp;&amp; ctx-&gt;qry.head) {
<a href="#h7-3-3" id="h7-3-3" class="i">+		struct strbuf sb = STRBUF_INIT;
</a><a href="#h7-3-4" id="h7-3-4" class="i">+		strbuf_addf(&amp;sb, &quot;h=%s&quot;, ctx-&gt;qry.head);
</a><a href="#h7-3-5" id="h7-3-5" class="i">+
</a> 		html(&quot;&lt;link rel=&#39;alternate&#39; title=&#39;Atom feed&#39; href=&#39;&quot;);
 		html(cgit_httpscheme());
 		html_attr(cgit_hosturl());
 		html_attr(cgit_fileurl(ctx-&gt;repo-&gt;url, &quot;atom&quot;, ctx-&gt;qry.vpath,
<a href="#h7-3-10" id="h7-3-10" class="d">-				       fmt(&quot;h=%s&quot;, ctx-&gt;qry.head)));
</a><a href="#h7-3-11" id="h7-3-11" class="i">+				       sb.buf));
</a> 		html(&quot;&#39; type=&#39;application/atom+xml&#39;/&gt;\n&quot;);
<a href="#h7-3-13" id="h7-3-13" class="i">+		strbuf_release(&amp;sb);
</a> 	}
 	if (ctx-&gt;cfg.head_include)
 		html_include(ctx-&gt;cfg.head_include);
<a href="#h7-4" id="h7-4" class="h">@@ -725,13 +728,14 @@ static int print_branch_option(const char *refname, const unsigned char *sha1,
</a> void cgit_add_hidden_formfields(int incl_head, int incl_search,
 				const char *page)
 {
<a href="#h7-4-3" id="h7-4-3" class="d">-	char *url;
</a><a href="#h7-4-4" id="h7-4-4" class="d">-
</a> 	if (!ctx.cfg.virtual_root) {
<a href="#h7-4-6" id="h7-4-6" class="d">-		url = fmt(&quot;%s/%s&quot;, ctx.qry.repo, page);
</a><a href="#h7-4-7" id="h7-4-7" class="i">+		struct strbuf url = STRBUF_INIT;
</a><a href="#h7-4-8" id="h7-4-8" class="i">+
</a><a href="#h7-4-9" id="h7-4-9" class="i">+		strbuf_addf(&amp;url, &quot;%s/%s&quot;, ctx.qry.repo, page);
</a> 		if (ctx.qry.vpath)
<a href="#h7-4-11" id="h7-4-11" class="d">-			url = fmt(&quot;%s/%s&quot;, url, ctx.qry.vpath);
</a><a href="#h7-4-12" id="h7-4-12" class="d">-		html_hidden(&quot;url&quot;, url);
</a><a href="#h7-4-13" id="h7-4-13" class="i">+			strbuf_addf(&amp;url, &quot;/%s&quot;, ctx.qry.vpath);
</a><a href="#h7-4-14" id="h7-4-14" class="i">+		html_hidden(&quot;url&quot;, url.buf);
</a><a href="#h7-4-15" id="h7-4-15" class="i">+		strbuf_release(&amp;url);
</a> 	}
 
 	if (incl_head &amp;&amp; ctx.qry.head &amp;&amp; ctx.repo-&gt;defbranch &amp;&amp;
<a href="#h7-5" id="h7-5" class="h">@@ -926,20 +930,23 @@ void cgit_print_snapshot_links(const char *repo, const char *head,
</a> 			       const char *hex, int snapshots)
 {
 	const struct cgit_snapshot_format* f;
<a href="#h7-5-3" id="h7-5-3" class="d">-	char *prefix;
</a><a href="#h7-5-4" id="h7-5-4" class="d">-	char *filename;
</a><a href="#h7-5-5" id="h7-5-5" class="i">+	struct strbuf filename = STRBUF_INIT;
</a><a href="#h7-5-6" id="h7-5-6" class="i">+	size_t prefixlen;
</a> 	unsigned char sha1[20];
 
 	if (get_sha1(fmt(&quot;refs/tags/%s&quot;, hex), sha1) == 0 &amp;&amp;
 	    (hex[0] == &#39;v&#39; || hex[0] == &#39;V&#39;) &amp;&amp; isdigit(hex[1]))
 		hex++;
<a href="#h7-5-12" id="h7-5-12" class="d">-	prefix = xstrdup(fmt(&quot;%s-%s&quot;, cgit_repobasename(repo), hex));
</a><a href="#h7-5-13" id="h7-5-13" class="i">+	strbuf_addf(&amp;filename, &quot;%s-%s&quot;, cgit_repobasename(repo), hex);
</a><a href="#h7-5-14" id="h7-5-14" class="i">+	prefixlen = filename.len;
</a> 	for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
 		if (!(snapshots &amp; f-&gt;bit))
 			continue;
<a href="#h7-5-18" id="h7-5-18" class="d">-		filename = fmt(&quot;%s%s&quot;, prefix, f-&gt;suffix);
</a><a href="#h7-5-19" id="h7-5-19" class="d">-		cgit_snapshot_link(filename, NULL, NULL, NULL, NULL, filename);
</a><a href="#h7-5-20" id="h7-5-20" class="i">+		strbuf_setlen(&amp;filename, prefixlen);
</a><a href="#h7-5-21" id="h7-5-21" class="i">+		strbuf_addstr(&amp;filename, f-&gt;suffix);
</a><a href="#h7-5-22" id="h7-5-22" class="i">+		cgit_snapshot_link(filename.buf, NULL, NULL, NULL, NULL,
</a><a href="#h7-5-23" id="h7-5-23" class="i">+				   filename.buf);
</a> 		html(&quot;&lt;br/&gt;&quot;);
 	}
<a href="#h7-5-26" id="h7-5-26" class="d">-	free(prefix);
</a><a href="#h7-5-27" id="h7-5-27" class="i">+	strbuf_release(&amp;filename);
</a> }
<b>diff --git a/<a id="h8" href="../file/ui-snapshot.c.html">ui-snapshot.c</a> b/<a href="../file/ui-snapshot.c.html">ui-snapshot.c</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -15,14 +15,33 @@
</a> static int write_archive_type(const char *format, const char *hex, const char *prefix)
 {
 	struct argv_array argv = ARGV_ARRAY_INIT;
<a href="#h8-0-3" id="h8-0-3" class="i">+	const char **nargv;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+	int result;
</a> 	argv_array_push(&amp;argv, &quot;snapshot&quot;);
 	argv_array_push(&amp;argv, format);
 	if (prefix) {
<a href="#h8-0-8" id="h8-0-8" class="i">+		struct strbuf buf = STRBUF_INIT;
</a><a href="#h8-0-9" id="h8-0-9" class="i">+		strbuf_addstr(&amp;buf, prefix);
</a><a href="#h8-0-10" id="h8-0-10" class="i">+		strbuf_addch(&amp;buf, &#39;/&#39;);
</a> 		argv_array_push(&amp;argv, &quot;--prefix&quot;);
<a href="#h8-0-12" id="h8-0-12" class="d">-		argv_array_push(&amp;argv, fmt(&quot;%s/&quot;, prefix));
</a><a href="#h8-0-13" id="h8-0-13" class="i">+		argv_array_push(&amp;argv, buf.buf);
</a><a href="#h8-0-14" id="h8-0-14" class="i">+		strbuf_release(&amp;buf);
</a> 	}
 	argv_array_push(&amp;argv, hex);
<a href="#h8-0-17" id="h8-0-17" class="d">-	return write_archive(argv.argc, argv.argv, NULL, 1, NULL, 0);
</a><a href="#h8-0-18" id="h8-0-18" class="i">+	/*
</a><a href="#h8-0-19" id="h8-0-19" class="i">+	 * Now we need to copy the pointers to arguments into a new
</a><a href="#h8-0-20" id="h8-0-20" class="i">+	 * structure because write_archive will rearrange its arguments
</a><a href="#h8-0-21" id="h8-0-21" class="i">+	 * which may result in duplicated/missing entries causing leaks
</a><a href="#h8-0-22" id="h8-0-22" class="i">+	 * or double-frees in argv_array_clear.
</a><a href="#h8-0-23" id="h8-0-23" class="i">+	 */
</a><a href="#h8-0-24" id="h8-0-24" class="i">+	nargv = xmalloc(sizeof(char *) * (argv.argc + 1));
</a><a href="#h8-0-25" id="h8-0-25" class="i">+	/* argv_array guarantees a trailing NULL entry. */
</a><a href="#h8-0-26" id="h8-0-26" class="i">+	memcpy(nargv, argv.argv, sizeof(char *) * (argv.argc + 1));
</a><a href="#h8-0-27" id="h8-0-27" class="i">+
</a><a href="#h8-0-28" id="h8-0-28" class="i">+	result = write_archive(argv.argc, nargv, NULL, 1, NULL, 0);
</a><a href="#h8-0-29" id="h8-0-29" class="i">+	argv_array_clear(&amp;argv);
</a><a href="#h8-0-30" id="h8-0-30" class="i">+	free(nargv);
</a><a href="#h8-0-31" id="h8-0-31" class="i">+	return result;
</a> }
 
 static int write_tar_archive(const char *hex, const char *prefix)
<a href="#h8-1" id="h8-1" class="h">@@ -129,29 +148,36 @@ static const char *get_ref_from_filename(const char *url, const char *filename,
</a> {
 	const char *reponame;
 	unsigned char sha1[20];
<a href="#h8-1-3" id="h8-1-3" class="d">-	char *snapshot;
</a><a href="#h8-1-4" id="h8-1-4" class="i">+	struct strbuf snapshot = STRBUF_INIT;
</a><a href="#h8-1-5" id="h8-1-5" class="i">+	int result = 1;
</a> 
<a href="#h8-1-7" id="h8-1-7" class="d">-	snapshot = xstrdup(filename);
</a><a href="#h8-1-8" id="h8-1-8" class="d">-	snapshot[strlen(snapshot) - strlen(format-&gt;suffix)] = &#39;\0&#39;;
</a><a href="#h8-1-9" id="h8-1-9" class="i">+	strbuf_addstr(&amp;snapshot, filename);
</a><a href="#h8-1-10" id="h8-1-10" class="i">+	strbuf_setlen(&amp;snapshot, snapshot.len - strlen(format-&gt;suffix));
</a> 
<a href="#h8-1-12" id="h8-1-12" class="d">-	if (get_sha1(snapshot, sha1) == 0)
</a><a href="#h8-1-13" id="h8-1-13" class="d">-		return snapshot;
</a><a href="#h8-1-14" id="h8-1-14" class="i">+	if (get_sha1(snapshot.buf, sha1) == 0)
</a><a href="#h8-1-15" id="h8-1-15" class="i">+		goto out;
</a> 
 	reponame = cgit_repobasename(url);
<a href="#h8-1-18" id="h8-1-18" class="d">-	if (prefixcmp(snapshot, reponame) == 0) {
</a><a href="#h8-1-19" id="h8-1-19" class="d">-		snapshot += strlen(reponame);
</a><a href="#h8-1-20" id="h8-1-20" class="d">-		while (snapshot &amp;&amp; (*snapshot == &#39;-&#39; || *snapshot == &#39;_&#39;))
</a><a href="#h8-1-21" id="h8-1-21" class="d">-			snapshot++;
</a><a href="#h8-1-22" id="h8-1-22" class="i">+	if (prefixcmp(snapshot.buf, reponame) == 0) {
</a><a href="#h8-1-23" id="h8-1-23" class="i">+		const char *new_start = snapshot.buf;
</a><a href="#h8-1-24" id="h8-1-24" class="i">+		new_start += strlen(reponame);
</a><a href="#h8-1-25" id="h8-1-25" class="i">+		while (new_start &amp;&amp; (*new_start == &#39;-&#39; || *new_start == &#39;_&#39;))
</a><a href="#h8-1-26" id="h8-1-26" class="i">+			new_start++;
</a><a href="#h8-1-27" id="h8-1-27" class="i">+		strbuf_splice(&amp;snapshot, 0, new_start - snapshot.buf, &quot;&quot;, 0);
</a> 	}
 
<a href="#h8-1-30" id="h8-1-30" class="d">-	if (get_sha1(snapshot, sha1) == 0)
</a><a href="#h8-1-31" id="h8-1-31" class="d">-		return snapshot;
</a><a href="#h8-1-32" id="h8-1-32" class="i">+	if (get_sha1(snapshot.buf, sha1) == 0)
</a><a href="#h8-1-33" id="h8-1-33" class="i">+		goto out;
</a> 
<a href="#h8-1-35" id="h8-1-35" class="d">-	snapshot = fmt(&quot;v%s&quot;, snapshot);
</a><a href="#h8-1-36" id="h8-1-36" class="d">-	if (get_sha1(snapshot, sha1) == 0)
</a><a href="#h8-1-37" id="h8-1-37" class="d">-		return snapshot;
</a><a href="#h8-1-38" id="h8-1-38" class="i">+	strbuf_insert(&amp;snapshot, 0, &quot;v&quot;, 1);
</a><a href="#h8-1-39" id="h8-1-39" class="i">+	if (get_sha1(snapshot.buf, sha1) == 0)
</a><a href="#h8-1-40" id="h8-1-40" class="i">+		goto out;
</a> 
<a href="#h8-1-42" id="h8-1-42" class="d">-	return NULL;
</a><a href="#h8-1-43" id="h8-1-43" class="i">+	result = 0;
</a><a href="#h8-1-44" id="h8-1-44" class="i">+	strbuf_release(&amp;snapshot);
</a><a href="#h8-1-45" id="h8-1-45" class="i">+
</a><a href="#h8-1-46" id="h8-1-46" class="i">+out:
</a><a href="#h8-1-47" id="h8-1-47" class="i">+	return result ? strbuf_detach(&amp;snapshot, NULL) : NULL;
</a> }
 
 __attribute__((format (printf, 1, 2)))
<b>diff --git a/<a id="h9" href="../file/ui-summary.c.html">ui-summary.c</a> b/<a href="../file/ui-summary.c.html">ui-summary.c</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -17,6 +17,7 @@
</a> static void print_url(char *base, char *suffix)
 {
 	int columns = 3;
<a href="#h9-0-3" id="h9-0-3" class="i">+	struct strbuf basebuf = STRBUF_INIT;
</a> 
 	if (ctx.repo-&gt;enable_log_filecount)
 		columns++;
<a href="#h9-1" id="h9-1" class="h">@@ -25,13 +26,16 @@ static void print_url(char *base, char *suffix)
</a> 
 	if (!base || !*base)
 		return;
<a href="#h9-1-3" id="h9-1-3" class="d">-	if (suffix &amp;&amp; *suffix)
</a><a href="#h9-1-4" id="h9-1-4" class="d">-		base = fmt(&quot;%s/%s&quot;, base, suffix);
</a><a href="#h9-1-5" id="h9-1-5" class="i">+	if (suffix &amp;&amp; *suffix) {
</a><a href="#h9-1-6" id="h9-1-6" class="i">+		strbuf_addf(&amp;basebuf, &quot;%s/%s&quot;, base, suffix);
</a><a href="#h9-1-7" id="h9-1-7" class="i">+		base = basebuf.buf;
</a><a href="#h9-1-8" id="h9-1-8" class="i">+	}
</a> 	htmlf(&quot;&lt;tr&gt;&lt;td colspan=&#39;%d&#39;&gt;&lt;a href=&#39;&quot;, columns);
 	html_url_path(base);
 	html(&quot;&#39;&gt;&quot;);
 	html_txt(base);
 	html(&quot;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
<a href="#h9-1-14" id="h9-1-14" class="i">+	strbuf_release(&amp;basebuf);
</a> }
 
 static void print_urls(char *txt, char *suffix)
<a href="#h9-2" id="h9-2" class="h">@@ -112,8 +116,8 @@ void cgit_print_repo_readme(char *path)
</a> 
 	/* Prepend repo path to relative readme path unless tracked. */
 	if (!ref &amp;&amp; *ctx.repo-&gt;readme != &#39;/&#39;)
<a href="#h9-2-3" id="h9-2-3" class="d">-		ctx.repo-&gt;readme = xstrdup(fmt(&quot;%s/%s&quot;, ctx.repo-&gt;path,
</a><a href="#h9-2-4" id="h9-2-4" class="d">-					       ctx.repo-&gt;readme));
</a><a href="#h9-2-5" id="h9-2-5" class="i">+		ctx.repo-&gt;readme = fmtalloc(&quot;%s/%s&quot;, ctx.repo-&gt;path,
</a><a href="#h9-2-6" id="h9-2-6" class="i">+						ctx.repo-&gt;readme);
</a> 
 	/* If a subpath is specified for the about page, make it relative
 	 * to the directory containing the configured readme.
<b>diff --git a/<a id="h10" href="../file/ui-tag.c.html">ui-tag.c</a> b/<a href="../file/ui-tag.c.html">ui-tag.c</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -41,6 +41,7 @@ static void print_download_links(char *revname)
</a> 
 void cgit_print_tag(char *revname)
 {
<a href="#h10-0-3" id="h10-0-3" class="i">+	struct strbuf fullref = STRBUF_INIT;
</a> 	unsigned char sha1[20];
 	struct object *obj;
 	struct tag *tag;
<a href="#h10-1" id="h10-1" class="h">@@ -49,20 +50,21 @@ void cgit_print_tag(char *revname)
</a> 	if (!revname)
 		revname = ctx.qry.head;
 
<a href="#h10-1-3" id="h10-1-3" class="d">-	if (get_sha1(fmt(&quot;refs/tags/%s&quot;, revname), sha1)) {
</a><a href="#h10-1-4" id="h10-1-4" class="i">+	strbuf_addf(&amp;fullref, &quot;refs/tags/%s&quot;, revname);
</a><a href="#h10-1-5" id="h10-1-5" class="i">+	if (get_sha1(fullref.buf, sha1)) {
</a> 		cgit_print_error(&quot;Bad tag reference: %s&quot;, revname);
<a href="#h10-1-7" id="h10-1-7" class="d">-		return;
</a><a href="#h10-1-8" id="h10-1-8" class="i">+		goto cleanup;
</a> 	}
 	obj = parse_object(sha1);
 	if (!obj) {
 		cgit_print_error(&quot;Bad object id: %s&quot;, sha1_to_hex(sha1));
<a href="#h10-1-13" id="h10-1-13" class="d">-		return;
</a><a href="#h10-1-14" id="h10-1-14" class="i">+		goto cleanup;
</a> 	}
 	if (obj-&gt;type == OBJ_TAG) {
 		tag = lookup_tag(sha1);
 		if (!tag || parse_tag(tag) || !(info = cgit_parse_tag(tag))) {
 			cgit_print_error(&quot;Bad tag object: %s&quot;, revname);
<a href="#h10-1-20" id="h10-1-20" class="d">-			return;
</a><a href="#h10-1-21" id="h10-1-21" class="i">+			goto cleanup;
</a> 		}
 		html(&quot;&lt;table class=&#39;commit-info&#39;&gt;\n&quot;);
 		htmlf(&quot;&lt;tr&gt;&lt;td&gt;tag name&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h10-2" id="h10-2" class="h">@@ -101,5 +103,7 @@ void cgit_print_tag(char *revname)
</a> 			print_download_links(revname);
 		html(&quot;&lt;/table&gt;\n&quot;);
 	}
<a href="#h10-2-3" id="h10-2-3" class="d">-	return;
</a><a href="#h10-2-4" id="h10-2-4" class="i">+
</a><a href="#h10-2-5" id="h10-2-5" class="i">+cleanup:
</a><a href="#h10-2-6" id="h10-2-6" class="i">+	strbuf_release(&amp;fullref);
</a> }
<b>diff --git a/<a id="h11" href="../file/ui-tree.c.html">ui-tree.c</a> b/<a href="../file/ui-tree.c.html">ui-tree.c</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -129,14 +129,14 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> {
 	struct walk_tree_context *walk_tree_ctx = cbdata;
 	char *name;
<a href="#h11-0-3" id="h11-0-3" class="d">-	char *fullpath;
</a><a href="#h11-0-4" id="h11-0-4" class="d">-	char *class;
</a><a href="#h11-0-5" id="h11-0-5" class="i">+	struct strbuf fullpath = STRBUF_INIT;
</a><a href="#h11-0-6" id="h11-0-6" class="i">+	struct strbuf class = STRBUF_INIT;
</a> 	enum object_type type;
 	unsigned long size = 0;
 
 	name = xstrdup(pathname);
<a href="#h11-0-11" id="h11-0-11" class="d">-	fullpath = fmt(&quot;%s%s%s&quot;, ctx.qry.path ? ctx.qry.path : &quot;&quot;,
</a><a href="#h11-0-12" id="h11-0-12" class="d">-		       ctx.qry.path ? &quot;/&quot; : &quot;&quot;, name);
</a><a href="#h11-0-13" id="h11-0-13" class="i">+	strbuf_addf(&amp;fullpath, &quot;%s%s%s&quot;, ctx.qry.path ? ctx.qry.path : &quot;&quot;,
</a><a href="#h11-0-14" id="h11-0-14" class="i">+		    ctx.qry.path ? &quot;/&quot; : &quot;&quot;, name);
</a> 
 	if (!S_ISGITLINK(mode)) {
 		type = sha1_object_info(sha1, &amp;size);
<a href="#h11-1" id="h11-1" class="h">@@ -152,33 +152,34 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> 	cgit_print_filemode(mode);
 	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
 	if (S_ISGITLINK(mode)) {
<a href="#h11-1-3" id="h11-1-3" class="d">-		cgit_submodule_link(&quot;ls-mod&quot;, fullpath, sha1_to_hex(sha1));
</a><a href="#h11-1-4" id="h11-1-4" class="i">+		cgit_submodule_link(&quot;ls-mod&quot;, fullpath.buf, sha1_to_hex(sha1));
</a> 	} else if (S_ISDIR(mode)) {
 		cgit_tree_link(name, NULL, &quot;ls-dir&quot;, ctx.qry.head,
<a href="#h11-1-7" id="h11-1-7" class="d">-			       walk_tree_ctx-&gt;curr_rev, fullpath);
</a><a href="#h11-1-8" id="h11-1-8" class="i">+			       walk_tree_ctx-&gt;curr_rev, fullpath.buf);
</a> 	} else {
<a href="#h11-1-10" id="h11-1-10" class="d">-		class = strrchr(name, &#39;.&#39;);
</a><a href="#h11-1-11" id="h11-1-11" class="d">-		if (class != NULL) {
</a><a href="#h11-1-12" id="h11-1-12" class="d">-			class = fmt(&quot;ls-blob %s&quot;, class + 1);
</a><a href="#h11-1-13" id="h11-1-13" class="d">-		} else
</a><a href="#h11-1-14" id="h11-1-14" class="d">-			class = &quot;ls-blob&quot;;
</a><a href="#h11-1-15" id="h11-1-15" class="d">-		cgit_tree_link(name, NULL, class, ctx.qry.head,
</a><a href="#h11-1-16" id="h11-1-16" class="d">-			       walk_tree_ctx-&gt;curr_rev, fullpath);
</a><a href="#h11-1-17" id="h11-1-17" class="i">+		char *ext = strrchr(name, &#39;.&#39;);
</a><a href="#h11-1-18" id="h11-1-18" class="i">+		strbuf_addstr(&amp;class, &quot;ls-blob&quot;);
</a><a href="#h11-1-19" id="h11-1-19" class="i">+		if (ext)
</a><a href="#h11-1-20" id="h11-1-20" class="i">+			strbuf_addf(&amp;class, &quot; %s&quot;, ext + 1);
</a><a href="#h11-1-21" id="h11-1-21" class="i">+		cgit_tree_link(name, NULL, class.buf, ctx.qry.head,
</a><a href="#h11-1-22" id="h11-1-22" class="i">+			       walk_tree_ctx-&gt;curr_rev, fullpath.buf);
</a> 	}
 	htmlf(&quot;&lt;/td&gt;&lt;td class=&#39;ls-size&#39;&gt;%li&lt;/td&gt;&quot;, size);
 
 	html(&quot;&lt;td&gt;&quot;);
 	cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, ctx.qry.head,
<a href="#h11-1-28" id="h11-1-28" class="d">-		      walk_tree_ctx-&gt;curr_rev, fullpath, 0, NULL, NULL,
</a><a href="#h11-1-29" id="h11-1-29" class="i">+		      walk_tree_ctx-&gt;curr_rev, fullpath.buf, 0, NULL, NULL,
</a> 		      ctx.qry.showmsg);
 	if (ctx.repo-&gt;max_stats)
 		cgit_stats_link(&quot;stats&quot;, NULL, &quot;button&quot;, ctx.qry.head,
<a href="#h11-1-33" id="h11-1-33" class="d">-				fullpath);
</a><a href="#h11-1-34" id="h11-1-34" class="i">+				fullpath.buf);
</a> 	if (!S_ISGITLINK(mode))
 		cgit_plain_link(&quot;plain&quot;, NULL, &quot;button&quot;, ctx.qry.head,
<a href="#h11-1-37" id="h11-1-37" class="d">-				walk_tree_ctx-&gt;curr_rev, fullpath);
</a><a href="#h11-1-38" id="h11-1-38" class="i">+				walk_tree_ctx-&gt;curr_rev, fullpath.buf);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
 	free(name);
<a href="#h11-1-41" id="h11-1-41" class="i">+	strbuf_release(&amp;fullpath);
</a><a href="#h11-1-42" id="h11-1-42" class="i">+	strbuf_release(&amp;class);
</a> 	return 0;
 }
 
</pre>
</div>
</body>
</html>
