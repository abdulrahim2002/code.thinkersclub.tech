<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Add links to enable downloading of tagged blobs - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/9f48df63f6d8d9a8abcc02cd2f08293da7081520.html">9f48df63f6d8d9a8abcc02cd2f08293da7081520</a>
<b>parent</b> <a href="../commit/f596d10d7391ed72b73019e037a7f7eec7a50d02.html">f596d10d7391ed72b73019e037a7f7eec7a50d02</a>
<b>Author:</b> Lars Hjemli &lt;<a href="mailto:hjemli@gmail.com">hjemli@gmail.com</a>&gt;
<b>Date:</b>   Fri, 11 May 2007 23:44:42 +0200

Add links to enable downloading of tagged blobs

All tags below refs/archives are shown on the repo summary page as
download links. The links referes to the tagged objects, using the
tag name as filename for download.

This can be used to add shortcuts for release tarballs, documentation
and other blobs stored in the object database, especially blobs that
are not reachable during cloning.

Signed-off-by: Lars Hjemli &lt;hjemli@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">cgit.css</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">ui-summary.c</a></td><td> | </td><td class="num">74</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">---------</span></td></tr>
</table></pre><pre>2 files changed, 85 insertions(+), 9 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/cgit.css.html">cgit.css</a> b/<a href="../file/cgit.css.html">cgit.css</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -10,6 +10,7 @@ body {
</a> h2 {
 	font-size: 120%;
 	font-weight: bold;
<a href="#h0-0-3" id="h0-0-3" class="i">+	margin-top: 0em;
</a> 	margin-bottom: 0.25em;
 }
 
<a href="#h0-1" id="h0-1" class="h">@@ -127,6 +128,25 @@ td#search input {
</a> 	background-color: #fff;
 }
 
<a href="#h0-1-3" id="h0-1-3" class="i">+td#summary {
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	vertical-align: top;
</a><a href="#h0-1-5" id="h0-1-5" class="i">+	padding-bottom: 1em;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+}
</a><a href="#h0-1-7" id="h0-1-7" class="i">+
</a><a href="#h0-1-8" id="h0-1-8" class="i">+td#archivelist {
</a><a href="#h0-1-9" id="h0-1-9" class="i">+	padding-bottom: 1em;
</a><a href="#h0-1-10" id="h0-1-10" class="i">+}
</a><a href="#h0-1-11" id="h0-1-11" class="i">+
</a><a href="#h0-1-12" id="h0-1-12" class="i">+td#archivelist table {
</a><a href="#h0-1-13" id="h0-1-13" class="i">+	float: right;
</a><a href="#h0-1-14" id="h0-1-14" class="i">+	border-collapse: collapse;
</a><a href="#h0-1-15" id="h0-1-15" class="i">+	border: solid 1px #777;
</a><a href="#h0-1-16" id="h0-1-16" class="i">+}
</a><a href="#h0-1-17" id="h0-1-17" class="i">+
</a><a href="#h0-1-18" id="h0-1-18" class="i">+td#archivelist table th {
</a><a href="#h0-1-19" id="h0-1-19" class="i">+	background-color: #ccc;
</a><a href="#h0-1-20" id="h0-1-20" class="i">+}
</a><a href="#h0-1-21" id="h0-1-21" class="i">+
</a> td#content {
 	padding: 1em 0.5em;
 }
<b>diff --git a/<a id="h1" href="../file/ui-summary.c.html">ui-summary.c</a> b/<a href="../file/ui-summary.c.html">ui-summary.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -8,6 +8,8 @@
</a> 
 #include &quot;cgit.h&quot;
 
<a href="#h1-0-3" id="h1-0-3" class="i">+int items = 0;
</a><a href="#h1-0-4" id="h1-0-4" class="i">+
</a> static int cgit_print_branch_cb(const char *refname, const unsigned char *sha1,
 				int flags, void *cb_data)
 {
<a href="#h1-1" id="h1-1" class="h">@@ -83,6 +85,13 @@ static int cgit_print_tag_cb(const char *refname, const unsigned char *sha1,
</a> 		tag = lookup_tag(sha1);
 		if (!tag || parse_tag(tag) || !(info = cgit_parse_tag(tag)))
 			return 2;
<a href="#h1-1-3" id="h1-1-3" class="i">+		if (!items) {
</a><a href="#h1-1-4" id="h1-1-4" class="i">+			html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Tag&lt;/th&gt;&quot;
</a><a href="#h1-1-5" id="h1-1-5" class="i">+			     &quot;&lt;th class=&#39;left&#39;&gt;Created&lt;/th&gt;&quot;
</a><a href="#h1-1-6" id="h1-1-6" class="i">+			     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h1-1-7" id="h1-1-7" class="i">+			     &quot;&lt;th class=&#39;left&#39;&gt;Reference&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h1-1-8" id="h1-1-8" class="i">+		}
</a><a href="#h1-1-9" id="h1-1-9" class="i">+		items++;
</a> 		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
 		url = cgit_pageurl(cgit_query_repo, &quot;view&quot;, 
 				   fmt(&quot;id=%s&quot;, sha1_to_hex(sha1)));
<a href="#h1-2" id="h1-2" class="h">@@ -108,6 +117,44 @@ static int cgit_print_tag_cb(const char *refname, const unsigned char *sha1,
</a> 	return 0;
 }
 
<a href="#h1-2-3" id="h1-2-3" class="i">+static int cgit_print_archive_cb(const char *refname, const unsigned char *sha1,
</a><a href="#h1-2-4" id="h1-2-4" class="i">+				 int flags, void *cb_data)
</a><a href="#h1-2-5" id="h1-2-5" class="i">+{
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	struct tag *tag;
</a><a href="#h1-2-7" id="h1-2-7" class="i">+	struct taginfo *info;
</a><a href="#h1-2-8" id="h1-2-8" class="i">+	struct object *obj;
</a><a href="#h1-2-9" id="h1-2-9" class="i">+	char buf[256], *url;
</a><a href="#h1-2-10" id="h1-2-10" class="i">+
</a><a href="#h1-2-11" id="h1-2-11" class="i">+	if (prefixcmp(refname, &quot;refs/archives&quot;))
</a><a href="#h1-2-12" id="h1-2-12" class="i">+		return 0;
</a><a href="#h1-2-13" id="h1-2-13" class="i">+	strncpy(buf, refname+14, sizeof(buf));
</a><a href="#h1-2-14" id="h1-2-14" class="i">+	obj = parse_object(sha1);
</a><a href="#h1-2-15" id="h1-2-15" class="i">+	if (!obj)
</a><a href="#h1-2-16" id="h1-2-16" class="i">+		return 1;
</a><a href="#h1-2-17" id="h1-2-17" class="i">+	if (obj-&gt;type == OBJ_TAG) {
</a><a href="#h1-2-18" id="h1-2-18" class="i">+		tag = lookup_tag(sha1);
</a><a href="#h1-2-19" id="h1-2-19" class="i">+		if (!tag || parse_tag(tag) || !(info = cgit_parse_tag(tag)))
</a><a href="#h1-2-20" id="h1-2-20" class="i">+			return 0;
</a><a href="#h1-2-21" id="h1-2-21" class="i">+		hashcpy(sha1, tag-&gt;tagged-&gt;sha1);
</a><a href="#h1-2-22" id="h1-2-22" class="i">+	} else if (obj-&gt;type != OBJ_BLOB) {
</a><a href="#h1-2-23" id="h1-2-23" class="i">+		return 0;
</a><a href="#h1-2-24" id="h1-2-24" class="i">+	}
</a><a href="#h1-2-25" id="h1-2-25" class="i">+	if (!items) {
</a><a href="#h1-2-26" id="h1-2-26" class="i">+		html(&quot;&lt;table&gt;&quot;);
</a><a href="#h1-2-27" id="h1-2-27" class="i">+		html(&quot;&lt;tr&gt;&lt;th&gt;Downloads&lt;/th&gt;&lt;/tr&gt;&quot;);
</a><a href="#h1-2-28" id="h1-2-28" class="i">+	}
</a><a href="#h1-2-29" id="h1-2-29" class="i">+	items++;
</a><a href="#h1-2-30" id="h1-2-30" class="i">+	html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h1-2-31" id="h1-2-31" class="i">+	url = cgit_pageurl(cgit_query_repo, &quot;blob&quot;,
</a><a href="#h1-2-32" id="h1-2-32" class="i">+			   fmt(&quot;id=%s&amp;path=%s&quot;, sha1_to_hex(sha1),
</a><a href="#h1-2-33" id="h1-2-33" class="i">+			       buf));
</a><a href="#h1-2-34" id="h1-2-34" class="i">+	html_link_open(url, NULL, NULL);
</a><a href="#h1-2-35" id="h1-2-35" class="i">+	html_txt(buf);
</a><a href="#h1-2-36" id="h1-2-36" class="i">+	html_link_close();
</a><a href="#h1-2-37" id="h1-2-37" class="i">+	html(&quot;&lt;/td&gt;&lt;tr&gt;&quot;);
</a><a href="#h1-2-38" id="h1-2-38" class="i">+	return 0;
</a><a href="#h1-2-39" id="h1-2-39" class="i">+}
</a><a href="#h1-2-40" id="h1-2-40" class="i">+
</a> static void cgit_print_branches()
 {
 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Branch&lt;/th&gt;&quot;
<a href="#h1-3" id="h1-3" class="h">@@ -119,21 +166,30 @@ static void cgit_print_branches()
</a> 
 static void cgit_print_tags()
 {
<a href="#h1-3-3" id="h1-3-3" class="d">-	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Tag&lt;/th&gt;&quot;
</a><a href="#h1-3-4" id="h1-3-4" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Created&lt;/th&gt;&quot;
</a><a href="#h1-3-5" id="h1-3-5" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h1-3-6" id="h1-3-6" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Reference&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h1-3-7" id="h1-3-7" class="i">+	items = 0;
</a> 	for_each_tag_ref(cgit_print_tag_cb, NULL);
 }
 
<a href="#h1-3-11" id="h1-3-11" class="i">+static void cgit_print_archives()
</a><a href="#h1-3-12" id="h1-3-12" class="i">+{
</a><a href="#h1-3-13" id="h1-3-13" class="i">+	items = 0;
</a><a href="#h1-3-14" id="h1-3-14" class="i">+	for_each_ref(cgit_print_archive_cb, NULL);
</a><a href="#h1-3-15" id="h1-3-15" class="i">+	if (items)
</a><a href="#h1-3-16" id="h1-3-16" class="i">+		html(&quot;&lt;/table&gt;&quot;);
</a><a href="#h1-3-17" id="h1-3-17" class="i">+}
</a><a href="#h1-3-18" id="h1-3-18" class="i">+
</a> void cgit_print_summary()
 {
<a href="#h1-3-21" id="h1-3-21" class="d">-	html(&quot;&lt;h2&gt;&quot;);
</a><a href="#h1-3-22" id="h1-3-22" class="d">-	html(cgit_repo-&gt;name);
</a><a href="#h1-3-23" id="h1-3-23" class="d">-	html(&quot;&lt;/h2&gt;&lt;h3&gt;&quot;);
</a><a href="#h1-3-24" id="h1-3-24" class="d">-	html(cgit_repo-&gt;desc);
</a><a href="#h1-3-25" id="h1-3-25" class="d">-	html(&quot;&lt;/h3&gt;&quot;);
</a> 	html(&quot;&lt;table class=&#39;list nowrap&#39;&gt;&quot;);
<a href="#h1-3-27" id="h1-3-27" class="i">+	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td id=&#39;summary&#39; colspan=&#39;3&#39;&gt;&quot;);
</a><a href="#h1-3-28" id="h1-3-28" class="i">+	html(&quot;&lt;h2&gt;&quot;);
</a><a href="#h1-3-29" id="h1-3-29" class="i">+	html_txt(cgit_repo-&gt;name);
</a><a href="#h1-3-30" id="h1-3-30" class="i">+	html(&quot; - &quot;);
</a><a href="#h1-3-31" id="h1-3-31" class="i">+	html_txt(cgit_repo-&gt;desc);
</a><a href="#h1-3-32" id="h1-3-32" class="i">+	html(&quot;&lt;/h2&gt;&quot;);
</a><a href="#h1-3-33" id="h1-3-33" class="i">+	html(&quot;&lt;/td&gt;&lt;td id=&#39;archivelist&#39;&gt;&quot;);
</a><a href="#h1-3-34" id="h1-3-34" class="i">+	cgit_print_archives();
</a><a href="#h1-3-35" id="h1-3-35" class="i">+	html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
</a> 	cgit_print_branches();
 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;);
 	cgit_print_tags();
</pre>
</div>
</body>
</html>
