<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Introduce struct cgit_context - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d14d77fe95c3b6224b40df9b101dded0deea913c.html">d14d77fe95c3b6224b40df9b101dded0deea913c</a>
<b>parent</b> <a href="../commit/e5ed227ef0da561e2bde8646ec816842392377ee.html">e5ed227ef0da561e2bde8646ec816842392377ee</a>
<b>Author:</b> Lars Hjemli &lt;<a href="mailto:hjemli@gmail.com">hjemli@gmail.com</a>&gt;
<b>Date:</b>   Sat, 16 Feb 2008 11:53:40 +0100

Introduce struct cgit_context

This struct will hold all the cgit runtime information currently found in
a multitude of global variables.

The first cleanup removes all querystring-related variables.

Signed-off-by: Lars Hjemli &lt;hjemli@gmail.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">cache.c</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">cgit.c</a></td><td> | </td><td class="num">72</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">cgit.h</a></td><td> | </td><td class="num">35</td><td><span class="i">+++++++++++++++++++++</span><span class="d">--------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">parsing.c</a></td><td> | </td><td class="num">8</td><td><span class="i">++++</span><span class="d">----</span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">shared.c</a></td><td> | </td><td class="num">43</td><td><span class="i">++++++++++++++</span><span class="d">-----------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">ui-commit.c</a></td><td> | </td><td class="num">14</td><td><span class="i">+++++++</span><span class="d">-------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h6">ui-diff.c</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h7">ui-log.c</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h8">ui-patch.c</a></td><td> | </td><td class="num">2</td><td><span class="i">+</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h9">ui-refs.c</a></td><td> | </td><td class="num">4</td><td><span class="i">++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">ui-shared.c</a></td><td> | </td><td class="num">86</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h11">ui-summary.c</a></td><td> | </td><td class="num">6</td><td><span class="i">+++</span><span class="d">---</span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">ui-tree.c</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++</span><span class="d">----------</span></td></tr>
</table></pre><pre>13 files changed, 156 insertions(+), 164 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/cache.c.html">cache.c</a> b/<a href="../file/cache.c.html">cache.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -57,10 +57,10 @@ int cache_create_dirs()
</a> 	if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
 		return 0;
 
<a href="#h0-0-3" id="h0-0-3" class="d">-	if (cgit_query_page) {
</a><a href="#h0-0-4" id="h0-0-4" class="i">+	if (ctx.qry.page) {
</a> 		path = fmt(&quot;%s/%s/%s&quot;, cgit_cache_root,
 			   cache_safe_filename(cgit_repo-&gt;url),
<a href="#h0-0-7" id="h0-0-7" class="d">-			   cgit_query_page);
</a><a href="#h0-0-8" id="h0-0-8" class="i">+			   ctx.qry.page);
</a> 		if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
 			return 0;
 	}
<b>diff --git a/<a id="h1" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -10,11 +10,11 @@
</a> 
 static int cgit_prepare_cache(struct cacheitem *item)
 {
<a href="#h1-0-3" id="h1-0-3" class="d">-	if (!cgit_repo &amp;&amp; cgit_query_repo) {
</a><a href="#h1-0-4" id="h1-0-4" class="i">+	if (!cgit_repo &amp;&amp; ctx.qry.repo) {
</a> 		char *title = fmt(&quot;%s - %s&quot;, cgit_root_title, &quot;Bad request&quot;);
 		cgit_print_docstart(title, item);
 		cgit_print_pageheader(title, 0);
<a href="#h1-0-8" id="h1-0-8" class="d">-		cgit_print_error(fmt(&quot;Unknown repo: %s&quot;, cgit_query_repo));
</a><a href="#h1-0-9" id="h1-0-9" class="i">+		cgit_print_error(fmt(&quot;Unknown repo: %s&quot;, ctx.qry.repo));
</a> 		cgit_print_docend();
 		return 0;
 	}
<a href="#h1-1" id="h1-1" class="h">@@ -28,16 +28,16 @@ static int cgit_prepare_cache(struct cacheitem *item)
</a> 	if (!cgit_cmd) {
 		item-&gt;name = xstrdup(fmt(&quot;%s/%s/index.%s.html&quot;, cgit_cache_root,
 					 cache_safe_filename(cgit_repo-&gt;url),
<a href="#h1-1-3" id="h1-1-3" class="d">-					 cache_safe_filename(cgit_querystring)));
</a><a href="#h1-1-4" id="h1-1-4" class="i">+					 cache_safe_filename(ctx.qry.raw)));
</a> 		item-&gt;ttl = cgit_cache_repo_ttl;
 	} else {
 		item-&gt;name = xstrdup(fmt(&quot;%s/%s/%s/%s.html&quot;, cgit_cache_root,
 					 cache_safe_filename(cgit_repo-&gt;url),
<a href="#h1-1-9" id="h1-1-9" class="d">-					 cgit_query_page,
</a><a href="#h1-1-10" id="h1-1-10" class="d">-					 cache_safe_filename(cgit_querystring)));
</a><a href="#h1-1-11" id="h1-1-11" class="d">-		if (cgit_query_has_symref)
</a><a href="#h1-1-12" id="h1-1-12" class="i">+					 ctx.qry.page,
</a><a href="#h1-1-13" id="h1-1-13" class="i">+					 cache_safe_filename(ctx.qry.raw)));
</a><a href="#h1-1-14" id="h1-1-14" class="i">+		if (ctx.qry.has_symref)
</a> 			item-&gt;ttl = cgit_cache_dynamic_ttl;
<a href="#h1-1-16" id="h1-1-16" class="d">-		else if (cgit_query_has_sha1)
</a><a href="#h1-1-17" id="h1-1-17" class="i">+		else if (ctx.qry.has_sha1)
</a> 			item-&gt;ttl = cgit_cache_static_ttl;
 		else
 			item-&gt;ttl = cgit_cache_repo_ttl;
<a href="#h1-2" id="h1-2" class="h">@@ -98,12 +98,12 @@ static void cgit_print_repo_page(struct cacheitem *item)
</a> 	show_search = 0;
 	setenv(&quot;GIT_DIR&quot;, cgit_repo-&gt;path, 1);
 
<a href="#h1-2-3" id="h1-2-3" class="d">-	if (!cgit_query_head) {
</a><a href="#h1-2-4" id="h1-2-4" class="d">-		cgit_query_head = xstrdup(find_default_branch(cgit_repo));
</a><a href="#h1-2-5" id="h1-2-5" class="d">-		cgit_repo-&gt;defbranch = cgit_query_head;
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	if (!ctx.qry.head) {
</a><a href="#h1-2-7" id="h1-2-7" class="i">+		ctx.qry.head = xstrdup(find_default_branch(cgit_repo));
</a><a href="#h1-2-8" id="h1-2-8" class="i">+		cgit_repo-&gt;defbranch = ctx.qry.head;
</a> 	}
 
<a href="#h1-2-11" id="h1-2-11" class="d">-	if (!cgit_query_head) {
</a><a href="#h1-2-12" id="h1-2-12" class="i">+	if (!ctx.qry.head) {
</a> 		cgit_print_docstart(title, item);
 		cgit_print_pageheader(title, 0);
 		cgit_print_error(&quot;Repository seems to be empty&quot;);
<a href="#h1-3" id="h1-3" class="h">@@ -111,9 +111,9 @@ static void cgit_print_repo_page(struct cacheitem *item)
</a> 		return;
 	}
 
<a href="#h1-3-3" id="h1-3-3" class="d">-	if (get_sha1(cgit_query_head, sha1)) {
</a><a href="#h1-3-4" id="h1-3-4" class="d">-		tmp = xstrdup(cgit_query_head);
</a><a href="#h1-3-5" id="h1-3-5" class="d">-		cgit_query_head = cgit_repo-&gt;defbranch;
</a><a href="#h1-3-6" id="h1-3-6" class="i">+	if (get_sha1(ctx.qry.head, sha1)) {
</a><a href="#h1-3-7" id="h1-3-7" class="i">+		tmp = xstrdup(ctx.qry.head);
</a><a href="#h1-3-8" id="h1-3-8" class="i">+		ctx.qry.head = cgit_repo-&gt;defbranch;
</a> 		cgit_print_docstart(title, item);
 		cgit_print_pageheader(title, 0);
 		cgit_print_error(fmt(&quot;Invalid branch: %s&quot;, tmp));
<a href="#h1-4" id="h1-4" class="h">@@ -122,20 +122,20 @@ static void cgit_print_repo_page(struct cacheitem *item)
</a> 	}
 
 	if ((cgit_cmd == CMD_SNAPSHOT) &amp;&amp; cgit_repo-&gt;snapshots) {
<a href="#h1-4-3" id="h1-4-3" class="d">-		cgit_print_snapshot(item, cgit_query_head, cgit_query_sha1,
</a><a href="#h1-4-4" id="h1-4-4" class="i">+		cgit_print_snapshot(item, ctx.qry.head, ctx.qry.sha1,
</a> 				    cgit_repobasename(cgit_repo-&gt;url),
<a href="#h1-4-6" id="h1-4-6" class="d">-				    cgit_query_path,
</a><a href="#h1-4-7" id="h1-4-7" class="i">+				    ctx.qry.path,
</a> 				    cgit_repo-&gt;snapshots );
 		return;
 	}
 
 	if (cgit_cmd == CMD_PATCH) {
<a href="#h1-4-13" id="h1-4-13" class="d">-		cgit_print_patch(cgit_query_sha1, item);
</a><a href="#h1-4-14" id="h1-4-14" class="i">+		cgit_print_patch(ctx.qry.sha1, item);
</a> 		return;
 	}
 
 	if (cgit_cmd == CMD_BLOB) {
<a href="#h1-4-19" id="h1-4-19" class="d">-		cgit_print_blob(item, cgit_query_sha1, cgit_query_path);
</a><a href="#h1-4-20" id="h1-4-20" class="i">+		cgit_print_blob(item, ctx.qry.sha1, ctx.qry.path);
</a> 		return;
 	}
 
<a href="#h1-5" id="h1-5" class="h">@@ -148,28 +148,28 @@ static void cgit_print_repo_page(struct cacheitem *item)
</a> 		return;
 	}
 
<a href="#h1-5-3" id="h1-5-3" class="d">-	cgit_print_pageheader(cgit_query_page, show_search);
</a><a href="#h1-5-4" id="h1-5-4" class="i">+	cgit_print_pageheader(ctx.qry.page, show_search);
</a> 
 	switch(cgit_cmd) {
 	case CMD_LOG:
<a href="#h1-5-8" id="h1-5-8" class="d">-		cgit_print_log(cgit_query_sha1, cgit_query_ofs,
</a><a href="#h1-5-9" id="h1-5-9" class="d">-			       cgit_max_commit_count, cgit_query_grep, cgit_query_search,
</a><a href="#h1-5-10" id="h1-5-10" class="d">-			       cgit_query_path, 1);
</a><a href="#h1-5-11" id="h1-5-11" class="i">+		cgit_print_log(ctx.qry.sha1, ctx.qry.ofs,
</a><a href="#h1-5-12" id="h1-5-12" class="i">+			       cgit_max_commit_count, ctx.qry.grep, ctx.qry.search,
</a><a href="#h1-5-13" id="h1-5-13" class="i">+			       ctx.qry.path, 1);
</a> 		break;
 	case CMD_TREE:
<a href="#h1-5-16" id="h1-5-16" class="d">-		cgit_print_tree(cgit_query_sha1, cgit_query_path);
</a><a href="#h1-5-17" id="h1-5-17" class="i">+		cgit_print_tree(ctx.qry.sha1, ctx.qry.path);
</a> 		break;
 	case CMD_COMMIT:
<a href="#h1-5-20" id="h1-5-20" class="d">-		cgit_print_commit(cgit_query_sha1);
</a><a href="#h1-5-21" id="h1-5-21" class="i">+		cgit_print_commit(ctx.qry.sha1);
</a> 		break;
 	case CMD_REFS:
 		cgit_print_refs();
 		break;
 	case CMD_TAG:
<a href="#h1-5-27" id="h1-5-27" class="d">-		cgit_print_tag(cgit_query_sha1);
</a><a href="#h1-5-28" id="h1-5-28" class="i">+		cgit_print_tag(ctx.qry.sha1);
</a> 		break;
 	case CMD_DIFF:
<a href="#h1-5-31" id="h1-5-31" class="d">-		cgit_print_diff(cgit_query_sha1, cgit_query_sha2, cgit_query_path);
</a><a href="#h1-5-32" id="h1-5-32" class="i">+		cgit_print_diff(ctx.qry.sha1, ctx.qry.sha2, ctx.qry.path);
</a> 		break;
 	default:
 		cgit_print_error(&quot;Invalid request&quot;);
<a href="#h1-6" id="h1-6" class="h">@@ -264,24 +264,24 @@ static void cgit_parse_args(int argc, const char **argv)
</a> 			cgit_nocache = 1;
 		}
 		if (!strncmp(argv[i], &quot;--query=&quot;, 8)) {
<a href="#h1-6-3" id="h1-6-3" class="d">-			cgit_querystring = xstrdup(argv[i]+8);
</a><a href="#h1-6-4" id="h1-6-4" class="i">+			ctx.qry.raw = xstrdup(argv[i]+8);
</a> 		}
 		if (!strncmp(argv[i], &quot;--repo=&quot;, 7)) {
<a href="#h1-6-7" id="h1-6-7" class="d">-			cgit_query_repo = xstrdup(argv[i]+7);
</a><a href="#h1-6-8" id="h1-6-8" class="i">+			ctx.qry.repo = xstrdup(argv[i]+7);
</a> 		}
 		if (!strncmp(argv[i], &quot;--page=&quot;, 7)) {
<a href="#h1-6-11" id="h1-6-11" class="d">-			cgit_query_page = xstrdup(argv[i]+7);
</a><a href="#h1-6-12" id="h1-6-12" class="i">+			ctx.qry.page = xstrdup(argv[i]+7);
</a> 		}
 		if (!strncmp(argv[i], &quot;--head=&quot;, 7)) {
<a href="#h1-6-15" id="h1-6-15" class="d">-			cgit_query_head = xstrdup(argv[i]+7);
</a><a href="#h1-6-16" id="h1-6-16" class="d">-			cgit_query_has_symref = 1;
</a><a href="#h1-6-17" id="h1-6-17" class="i">+			ctx.qry.head = xstrdup(argv[i]+7);
</a><a href="#h1-6-18" id="h1-6-18" class="i">+			ctx.qry.has_symref = 1;
</a> 		}
 		if (!strncmp(argv[i], &quot;--sha1=&quot;, 7)) {
<a href="#h1-6-21" id="h1-6-21" class="d">-			cgit_query_sha1 = xstrdup(argv[i]+7);
</a><a href="#h1-6-22" id="h1-6-22" class="d">-			cgit_query_has_sha1 = 1;
</a><a href="#h1-6-23" id="h1-6-23" class="i">+			ctx.qry.sha1 = xstrdup(argv[i]+7);
</a><a href="#h1-6-24" id="h1-6-24" class="i">+			ctx.qry.has_sha1 = 1;
</a> 		}
 		if (!strncmp(argv[i], &quot;--ofs=&quot;, 6)) {
<a href="#h1-6-27" id="h1-6-27" class="d">-			cgit_query_ofs = atoi(argv[i]+6);
</a><a href="#h1-6-28" id="h1-6-28" class="i">+			ctx.qry.ofs = atoi(argv[i]+6);
</a> 		}
 	}
 }
<a href="#h1-7" id="h1-7" class="h">@@ -303,9 +303,9 @@ int main(int argc, const char **argv)
</a> 	if (getenv(&quot;SCRIPT_NAME&quot;))
 		cgit_script_name = xstrdup(getenv(&quot;SCRIPT_NAME&quot;));
 	if (getenv(&quot;QUERY_STRING&quot;))
<a href="#h1-7-3" id="h1-7-3" class="d">-		cgit_querystring = xstrdup(getenv(&quot;QUERY_STRING&quot;));
</a><a href="#h1-7-4" id="h1-7-4" class="i">+		ctx.qry.raw = xstrdup(getenv(&quot;QUERY_STRING&quot;));
</a> 	cgit_parse_args(argc, argv);
<a href="#h1-7-6" id="h1-7-6" class="d">-	cgit_parse_query(cgit_querystring, cgit_querystring_cb);
</a><a href="#h1-7-7" id="h1-7-7" class="i">+	cgit_parse_query(ctx.qry.raw, cgit_querystring_cb);
</a> 	if (!cgit_prepare_cache(&amp;item))
 		return 0;
 	if (cgit_nocache) {
<b>diff --git a/<a id="h2" href="../file/cgit.h.html">cgit.h</a> b/<a href="../file/cgit.h.html">cgit.h</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -123,10 +123,31 @@ struct reflist {
</a> 	int count;
 };
 
<a href="#h2-0-3" id="h2-0-3" class="i">+struct cgit_query {
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	int has_symref;
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	int has_sha1;
</a><a href="#h2-0-6" id="h2-0-6" class="i">+	char *raw;
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	char *repo;
</a><a href="#h2-0-8" id="h2-0-8" class="i">+	char *page;
</a><a href="#h2-0-9" id="h2-0-9" class="i">+	char *search;
</a><a href="#h2-0-10" id="h2-0-10" class="i">+	char *grep;
</a><a href="#h2-0-11" id="h2-0-11" class="i">+	char *head;
</a><a href="#h2-0-12" id="h2-0-12" class="i">+	char *sha1;
</a><a href="#h2-0-13" id="h2-0-13" class="i">+	char *sha2;
</a><a href="#h2-0-14" id="h2-0-14" class="i">+	char *path;
</a><a href="#h2-0-15" id="h2-0-15" class="i">+	char *name;
</a><a href="#h2-0-16" id="h2-0-16" class="i">+	int   ofs;
</a><a href="#h2-0-17" id="h2-0-17" class="i">+};
</a><a href="#h2-0-18" id="h2-0-18" class="i">+
</a><a href="#h2-0-19" id="h2-0-19" class="i">+struct cgit_context {
</a><a href="#h2-0-20" id="h2-0-20" class="i">+	struct cgit_query qry;
</a><a href="#h2-0-21" id="h2-0-21" class="i">+};
</a><a href="#h2-0-22" id="h2-0-22" class="i">+
</a> extern const char *cgit_version;
 
 extern struct repolist cgit_repolist;
 extern struct repoinfo *cgit_repo;
<a href="#h2-0-27" id="h2-0-27" class="i">+extern struct cgit_context ctx;
</a> extern int cgit_cmd;
 
 extern char *cgit_root_title;
<a href="#h2-1" id="h2-1" class="h">@@ -163,20 +184,6 @@ extern int cgit_max_msg_len;
</a> extern int cgit_max_repodesc_len;
 extern int cgit_max_commit_count;
 
<a href="#h2-1-3" id="h2-1-3" class="d">-extern int cgit_query_has_symref;
</a><a href="#h2-1-4" id="h2-1-4" class="d">-extern int cgit_query_has_sha1;
</a><a href="#h2-1-5" id="h2-1-5" class="d">-
</a><a href="#h2-1-6" id="h2-1-6" class="d">-extern char *cgit_querystring;
</a><a href="#h2-1-7" id="h2-1-7" class="d">-extern char *cgit_query_repo;
</a><a href="#h2-1-8" id="h2-1-8" class="d">-extern char *cgit_query_page;
</a><a href="#h2-1-9" id="h2-1-9" class="d">-extern char *cgit_query_search;
</a><a href="#h2-1-10" id="h2-1-10" class="d">-extern char *cgit_query_grep;
</a><a href="#h2-1-11" id="h2-1-11" class="d">-extern char *cgit_query_head;
</a><a href="#h2-1-12" id="h2-1-12" class="d">-extern char *cgit_query_sha1;
</a><a href="#h2-1-13" id="h2-1-13" class="d">-extern char *cgit_query_sha2;
</a><a href="#h2-1-14" id="h2-1-14" class="d">-extern char *cgit_query_path;
</a><a href="#h2-1-15" id="h2-1-15" class="d">-extern char *cgit_query_name;
</a><a href="#h2-1-16" id="h2-1-16" class="d">-extern int   cgit_query_ofs;
</a> 
 extern int htmlfd;
 
<b>diff --git a/<a id="h3" href="../file/parsing.c.html">parsing.c</a> b/<a href="../file/parsing.c.html">parsing.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -149,7 +149,7 @@ void cgit_parse_url(const char *url)
</a> 
 	cgit_repo = cgit_get_repoinfo(url);
 	if (cgit_repo) {
<a href="#h3-0-3" id="h3-0-3" class="d">-		cgit_query_repo = cgit_repo-&gt;url;
</a><a href="#h3-0-4" id="h3-0-4" class="i">+		ctx.qry.repo = cgit_repo-&gt;url;
</a> 		return;
 	}
 
<a href="#h3-1" id="h3-1" class="h">@@ -163,15 +163,15 @@ void cgit_parse_url(const char *url)
</a> 			continue;
 		}
 
<a href="#h3-1-3" id="h3-1-3" class="d">-		cgit_query_repo = cgit_repo-&gt;url;
</a><a href="#h3-1-4" id="h3-1-4" class="i">+		ctx.qry.repo = cgit_repo-&gt;url;
</a> 		p = strchr(cmd + 1, &#39;/&#39;);
 		if (p) {
 			p[0] = &#39;\0&#39;;
 			if (p[1])
<a href="#h3-1-9" id="h3-1-9" class="d">-				cgit_query_path = trim_end(p + 1, &#39;/&#39;);
</a><a href="#h3-1-10" id="h3-1-10" class="i">+				ctx.qry.path = trim_end(p + 1, &#39;/&#39;);
</a> 		}
 		cgit_cmd = cgit_get_cmd_index(cmd + 1);
<a href="#h3-1-13" id="h3-1-13" class="d">-		cgit_query_page = xstrdup(cmd + 1);
</a><a href="#h3-1-14" id="h3-1-14" class="i">+		ctx.qry.page = xstrdup(cmd + 1);
</a> 		return;
 	}
 }
<b>diff --git a/<a id="h4" href="../file/shared.c.html">shared.c</a> b/<a href="../file/shared.c.html">shared.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -10,6 +10,7 @@
</a> 
 struct repolist cgit_repolist;
 struct repoinfo *cgit_repo;
<a href="#h4-0-3" id="h4-0-3" class="i">+struct cgit_context ctx;
</a> int cgit_cmd;
 
 const char *cgit_version = CGIT_VERSION;
<a href="#h4-1" id="h4-1" class="h">@@ -49,24 +50,8 @@ int cgit_max_msg_len = 60;
</a> int cgit_max_repodesc_len = 60;
 int cgit_max_commit_count = 50;
 
<a href="#h4-1-3" id="h4-1-3" class="d">-int cgit_query_has_symref = 0;
</a><a href="#h4-1-4" id="h4-1-4" class="d">-int cgit_query_has_sha1   = 0;
</a><a href="#h4-1-5" id="h4-1-5" class="d">-
</a><a href="#h4-1-6" id="h4-1-6" class="d">-char *cgit_querystring  = NULL;
</a><a href="#h4-1-7" id="h4-1-7" class="d">-char *cgit_query_repo   = NULL;
</a><a href="#h4-1-8" id="h4-1-8" class="d">-char *cgit_query_page   = NULL;
</a><a href="#h4-1-9" id="h4-1-9" class="d">-char *cgit_query_head   = NULL;
</a><a href="#h4-1-10" id="h4-1-10" class="d">-char *cgit_query_search = NULL;
</a><a href="#h4-1-11" id="h4-1-11" class="d">-char *cgit_query_grep   = NULL;
</a><a href="#h4-1-12" id="h4-1-12" class="d">-char *cgit_query_sha1   = NULL;
</a><a href="#h4-1-13" id="h4-1-13" class="d">-char *cgit_query_sha2   = NULL;
</a><a href="#h4-1-14" id="h4-1-14" class="d">-char *cgit_query_path   = NULL;
</a><a href="#h4-1-15" id="h4-1-15" class="d">-char *cgit_query_name   = NULL;
</a><a href="#h4-1-16" id="h4-1-16" class="d">-int   cgit_query_ofs    = 0;
</a><a href="#h4-1-17" id="h4-1-17" class="d">-
</a> int htmlfd = 0;
 
<a href="#h4-1-20" id="h4-1-20" class="d">-
</a> int cgit_get_cmd_index(const char *cmd)
 {
 	static char *cmds[] = {&quot;log&quot;, &quot;commit&quot;, &quot;diff&quot;, &quot;tree&quot;, &quot;blob&quot;,
<a href="#h4-2" id="h4-2" class="h">@@ -239,32 +224,32 @@ void cgit_global_config_cb(const char *name, const char *value)
</a> void cgit_querystring_cb(const char *name, const char *value)
 {
 	if (!strcmp(name,&quot;r&quot;)) {
<a href="#h4-2-3" id="h4-2-3" class="d">-		cgit_query_repo = xstrdup(value);
</a><a href="#h4-2-4" id="h4-2-4" class="i">+		ctx.qry.repo = xstrdup(value);
</a> 		cgit_repo = cgit_get_repoinfo(value);
 	} else if (!strcmp(name, &quot;p&quot;)) {
<a href="#h4-2-7" id="h4-2-7" class="d">-		cgit_query_page = xstrdup(value);
</a><a href="#h4-2-8" id="h4-2-8" class="i">+		ctx.qry.page = xstrdup(value);
</a> 		cgit_cmd = cgit_get_cmd_index(value);
 	} else if (!strcmp(name, &quot;url&quot;)) {
 		cgit_parse_url(value);
 	} else if (!strcmp(name, &quot;qt&quot;)) {
<a href="#h4-2-13" id="h4-2-13" class="d">-		cgit_query_grep = xstrdup(value);
</a><a href="#h4-2-14" id="h4-2-14" class="i">+		ctx.qry.grep = xstrdup(value);
</a> 	} else if (!strcmp(name, &quot;q&quot;)) {
<a href="#h4-2-16" id="h4-2-16" class="d">-		cgit_query_search = xstrdup(value);
</a><a href="#h4-2-17" id="h4-2-17" class="i">+		ctx.qry.search = xstrdup(value);
</a> 	} else if (!strcmp(name, &quot;h&quot;)) {
<a href="#h4-2-19" id="h4-2-19" class="d">-		cgit_query_head = xstrdup(value);
</a><a href="#h4-2-20" id="h4-2-20" class="d">-		cgit_query_has_symref = 1;
</a><a href="#h4-2-21" id="h4-2-21" class="i">+		ctx.qry.head = xstrdup(value);
</a><a href="#h4-2-22" id="h4-2-22" class="i">+		ctx.qry.has_symref = 1;
</a> 	} else if (!strcmp(name, &quot;id&quot;)) {
<a href="#h4-2-24" id="h4-2-24" class="d">-		cgit_query_sha1 = xstrdup(value);
</a><a href="#h4-2-25" id="h4-2-25" class="d">-		cgit_query_has_sha1 = 1;
</a><a href="#h4-2-26" id="h4-2-26" class="i">+		ctx.qry.sha1 = xstrdup(value);
</a><a href="#h4-2-27" id="h4-2-27" class="i">+		ctx.qry.has_sha1 = 1;
</a> 	} else if (!strcmp(name, &quot;id2&quot;)) {
<a href="#h4-2-29" id="h4-2-29" class="d">-		cgit_query_sha2 = xstrdup(value);
</a><a href="#h4-2-30" id="h4-2-30" class="d">-		cgit_query_has_sha1 = 1;
</a><a href="#h4-2-31" id="h4-2-31" class="i">+		ctx.qry.sha2 = xstrdup(value);
</a><a href="#h4-2-32" id="h4-2-32" class="i">+		ctx.qry.has_sha1 = 1;
</a> 	} else if (!strcmp(name, &quot;ofs&quot;)) {
<a href="#h4-2-34" id="h4-2-34" class="d">-		cgit_query_ofs = atoi(value);
</a><a href="#h4-2-35" id="h4-2-35" class="i">+		ctx.qry.ofs = atoi(value);
</a> 	} else if (!strcmp(name, &quot;path&quot;)) {
<a href="#h4-2-37" id="h4-2-37" class="d">-		cgit_query_path = trim_end(value, &#39;/&#39;);
</a><a href="#h4-2-38" id="h4-2-38" class="i">+		ctx.qry.path = trim_end(value, &#39;/&#39;);
</a> 	} else if (!strcmp(name, &quot;name&quot;)) {
<a href="#h4-2-40" id="h4-2-40" class="d">-		cgit_query_name = xstrdup(value);
</a><a href="#h4-2-41" id="h4-2-41" class="i">+		ctx.qry.name = xstrdup(value);
</a> 	}
 }
 
<b>diff --git a/<a id="h5" href="../file/ui-commit.c.html">ui-commit.c</a> b/<a href="../file/ui-commit.c.html">ui-commit.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -75,7 +75,7 @@ void print_fileinfo(struct fileinfo *info)
</a> 		html(&quot;]&lt;/span&gt;&quot;);
 	}
 	htmlf(&quot;&lt;/td&gt;&lt;td class=&#39;%s&#39;&gt;&quot;, class);
<a href="#h5-0-3" id="h5-0-3" class="d">-	cgit_diff_link(info-&gt;new_path, NULL, NULL, cgit_query_head, curr_rev,
</a><a href="#h5-0-4" id="h5-0-4" class="i">+	cgit_diff_link(info-&gt;new_path, NULL, NULL, ctx.qry.head, curr_rev,
</a> 		       NULL, info-&gt;new_path);
 	if (info-&gt;status == DIFF_STATUS_COPIED || info-&gt;status == DIFF_STATUS_RENAMED)
 		htmlf(&quot; (%s from %s)&quot;,
<a href="#h5-1" id="h5-1" class="h">@@ -143,7 +143,7 @@ void cgit_print_commit(char *hex)
</a> 	int i;
 
 	if (!hex)
<a href="#h5-1-3" id="h5-1-3" class="d">-		hex = cgit_query_head;
</a><a href="#h5-1-4" id="h5-1-4" class="i">+		hex = ctx.qry.head;
</a> 	curr_rev = hex;
 
 	if (get_sha1(hex, sha1)) {
<a href="#h5-2" id="h5-2" class="h">@@ -175,7 +175,7 @@ void cgit_print_commit(char *hex)
</a> 	html(&quot;&lt;tr&gt;&lt;th&gt;tree&lt;/th&gt;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
 	tmp = xstrdup(hex);
 	cgit_tree_link(sha1_to_hex(commit-&gt;tree-&gt;object.sha1), NULL, NULL,
<a href="#h5-2-3" id="h5-2-3" class="d">-		       cgit_query_head, tmp, NULL);
</a><a href="#h5-2-4" id="h5-2-4" class="i">+		       ctx.qry.head, tmp, NULL);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
       	for (p = commit-&gt;parents; p ; p = p-&gt;next) {
 		parent = lookup_commit_reference(p-&gt;item-&gt;object.sha1);
<a href="#h5-3" id="h5-3" class="h">@@ -188,15 +188,15 @@ void cgit_print_commit(char *hex)
</a> 		html(&quot;&lt;tr&gt;&lt;th&gt;parent&lt;/th&gt;&quot;
 		     &quot;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
 		cgit_commit_link(sha1_to_hex(p-&gt;item-&gt;object.sha1), NULL, NULL,
<a href="#h5-3-3" id="h5-3-3" class="d">-				 cgit_query_head, sha1_to_hex(p-&gt;item-&gt;object.sha1));
</a><a href="#h5-3-4" id="h5-3-4" class="i">+				 ctx.qry.head, sha1_to_hex(p-&gt;item-&gt;object.sha1));
</a> 		html(&quot; (&quot;);
<a href="#h5-3-6" id="h5-3-6" class="d">-		cgit_diff_link(&quot;diff&quot;, NULL, NULL, cgit_query_head, hex,
</a><a href="#h5-3-7" id="h5-3-7" class="i">+		cgit_diff_link(&quot;diff&quot;, NULL, NULL, ctx.qry.head, hex,
</a> 			       sha1_to_hex(p-&gt;item-&gt;object.sha1), NULL);
 		html(&quot;)&lt;/td&gt;&lt;/tr&gt;&quot;);
 	}
 	if (cgit_repo-&gt;snapshots) {
 		html(&quot;&lt;tr&gt;&lt;th&gt;download&lt;/th&gt;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
<a href="#h5-3-13" id="h5-3-13" class="d">-		cgit_print_snapshot_links(cgit_query_repo, cgit_query_head,
</a><a href="#h5-3-14" id="h5-3-14" class="i">+		cgit_print_snapshot_links(ctx.qry.repo, ctx.qry.head,
</a> 					  hex, cgit_repo-&gt;snapshots);
 		html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
 	}
<a href="#h5-4" id="h5-4" class="h">@@ -218,7 +218,7 @@ void cgit_print_commit(char *hex)
</a> 		html(&quot;&lt;div class=&#39;diffstat-summary&#39;&gt;&quot;);
 		htmlf(&quot;%d files changed, %d insertions, %d deletions (&quot;,
 		      files, total_adds, total_rems);
<a href="#h5-4-3" id="h5-4-3" class="d">-		cgit_diff_link(&quot;show diff&quot;, NULL, NULL, cgit_query_head, hex,
</a><a href="#h5-4-4" id="h5-4-4" class="i">+		cgit_diff_link(&quot;show diff&quot;, NULL, NULL, ctx.qry.head, hex,
</a> 			       NULL, NULL);
 		html(&quot;)&lt;/div&gt;&quot;);
 	}
<b>diff --git a/<a id="h6" href="../file/ui-diff.c.html">ui-diff.c</a> b/<a href="../file/ui-diff.c.html">ui-diff.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -71,13 +71,13 @@ static void header(unsigned char *sha1, char *path1, int mode1,
</a> 		}
 		html(&quot;&lt;br/&gt;--- a/&quot;);
 		if (mode1 != 0)
<a href="#h6-0-3" id="h6-0-3" class="d">-			cgit_tree_link(path1, NULL, NULL, cgit_query_head,
</a><a href="#h6-0-4" id="h6-0-4" class="i">+			cgit_tree_link(path1, NULL, NULL, ctx.qry.head,
</a> 				       sha1_to_hex(old_rev_sha1), path1);
 		else
 			html_txt(path1);
 		html(&quot;&lt;br/&gt;+++ b/&quot;);
 		if (mode2 != 0)
<a href="#h6-0-10" id="h6-0-10" class="d">-			cgit_tree_link(path2, NULL, NULL, cgit_query_head,
</a><a href="#h6-0-11" id="h6-0-11" class="i">+			cgit_tree_link(path2, NULL, NULL, ctx.qry.head,
</a> 				       sha1_to_hex(new_rev_sha1), path2);
 		else
 			html_txt(path2);
<a href="#h6-1" id="h6-1" class="h">@@ -107,7 +107,7 @@ void cgit_print_diff(const char *new_rev, const char *old_rev, const char *prefi
</a> 	struct commit *commit, *commit2;
 
 	if (!new_rev)
<a href="#h6-1-3" id="h6-1-3" class="d">-		new_rev = cgit_query_head;
</a><a href="#h6-1-4" id="h6-1-4" class="i">+		new_rev = ctx.qry.head;
</a> 	get_sha1(new_rev, new_rev_sha1);
 	type = sha1_object_info(new_rev_sha1, &amp;size);
 	if (type == OBJ_BAD) {
<b>diff --git a/<a id="h7" href="../file/ui-log.c.html">ui-log.c</a> b/<a href="../file/ui-log.c.html">ui-log.c</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -37,7 +37,7 @@ void print_commit(struct commit *commit)
</a> 	html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
 	cgit_print_age(commit-&gt;date, TM_WEEK * 2, FMT_SHORTDATE);
 	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h7-0-3" id="h7-0-3" class="d">-	cgit_commit_link(info-&gt;subject, NULL, NULL, cgit_query_head,
</a><a href="#h7-0-4" id="h7-0-4" class="i">+	cgit_commit_link(info-&gt;subject, NULL, NULL, ctx.qry.head,
</a> 			 sha1_to_hex(commit-&gt;object.sha1));
 	if (cgit_repo-&gt;enable_log_filecount) {
 		files = 0;
<a href="#h7-1" id="h7-1" class="h">@@ -67,7 +67,7 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	int i;
 
 	if (!tip)
<a href="#h7-1-3" id="h7-1-3" class="d">-		argv[1] = cgit_query_head;
</a><a href="#h7-1-4" id="h7-1-4" class="i">+		argv[1] = ctx.qry.head;
</a> 
 	if (grep &amp;&amp; pattern &amp;&amp; (!strcmp(grep, &quot;grep&quot;) ||
 				!strcmp(grep, &quot;author&quot;) ||
<a href="#h7-2" id="h7-2" class="h">@@ -123,17 +123,17 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	if (pager) {
 		html(&quot;&lt;div class=&#39;pager&#39;&gt;&quot;);
 		if (ofs &gt; 0) {
<a href="#h7-2-3" id="h7-2-3" class="d">-			cgit_log_link(&quot;[prev]&quot;, NULL, NULL, cgit_query_head,
</a><a href="#h7-2-4" id="h7-2-4" class="d">-				      cgit_query_sha1, cgit_query_path,
</a><a href="#h7-2-5" id="h7-2-5" class="d">-				      ofs - cnt, cgit_query_grep,
</a><a href="#h7-2-6" id="h7-2-6" class="d">-				      cgit_query_search);
</a><a href="#h7-2-7" id="h7-2-7" class="i">+			cgit_log_link(&quot;[prev]&quot;, NULL, NULL, ctx.qry.head,
</a><a href="#h7-2-8" id="h7-2-8" class="i">+				      ctx.qry.sha1, ctx.qry.path,
</a><a href="#h7-2-9" id="h7-2-9" class="i">+				      ofs - cnt, ctx.qry.grep,
</a><a href="#h7-2-10" id="h7-2-10" class="i">+				      ctx.qry.search);
</a> 			html(&quot;&amp;nbsp;&quot;);
 		}
 		if ((commit = get_revision(&amp;rev)) != NULL) {
<a href="#h7-2-14" id="h7-2-14" class="d">-			cgit_log_link(&quot;[next]&quot;, NULL, NULL, cgit_query_head,
</a><a href="#h7-2-15" id="h7-2-15" class="d">-				      cgit_query_sha1, cgit_query_path,
</a><a href="#h7-2-16" id="h7-2-16" class="d">-				      ofs + cnt, cgit_query_grep,
</a><a href="#h7-2-17" id="h7-2-17" class="d">-				      cgit_query_search);
</a><a href="#h7-2-18" id="h7-2-18" class="i">+			cgit_log_link(&quot;[next]&quot;, NULL, NULL, ctx.qry.head,
</a><a href="#h7-2-19" id="h7-2-19" class="i">+				      ctx.qry.sha1, ctx.qry.path,
</a><a href="#h7-2-20" id="h7-2-20" class="i">+				      ofs + cnt, ctx.qry.grep,
</a><a href="#h7-2-21" id="h7-2-21" class="i">+				      ctx.qry.search);
</a> 		}
 		html(&quot;&lt;/div&gt;&quot;);
 	}
<b>diff --git a/<a id="h8" href="../file/ui-patch.c.html">ui-patch.c</a> b/<a href="../file/ui-patch.c.html">ui-patch.c</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -76,7 +76,7 @@ void cgit_print_patch(char *hex, struct cacheitem *item)
</a> 	char *patchname;
 
 	if (!hex)
<a href="#h8-0-3" id="h8-0-3" class="d">-		hex = cgit_query_head;
</a><a href="#h8-0-4" id="h8-0-4" class="i">+		hex = ctx.qry.head;
</a> 
 	if (get_sha1(hex, sha1)) {
 		cgit_print_error(fmt(&quot;Bad object id: %s&quot;, hex));
<b>diff --git a/<a id="h9" href="../file/ui-refs.c.html">ui-refs.c</a> b/<a href="../file/ui-refs.c.html">ui-refs.c</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -16,9 +16,9 @@ void cgit_print_refs()
</a> 
 	html(&quot;&lt;table class=&#39;list nowrap&#39;&gt;&quot;);
 
<a href="#h9-0-3" id="h9-0-3" class="d">-	if (cgit_query_path &amp;&amp; !strncmp(cgit_query_path, &quot;heads&quot;, 5))
</a><a href="#h9-0-4" id="h9-0-4" class="i">+	if (ctx.qry.path &amp;&amp; !strncmp(ctx.qry.path, &quot;heads&quot;, 5))
</a> 		cgit_print_branches(0);
<a href="#h9-0-6" id="h9-0-6" class="d">-	else if (cgit_query_path &amp;&amp; !strncmp(cgit_query_path, &quot;tags&quot;, 4))
</a><a href="#h9-0-7" id="h9-0-7" class="i">+	else if (ctx.qry.path &amp;&amp; !strncmp(ctx.qry.path, &quot;tags&quot;, 4))
</a> 		cgit_print_tags(0);
 	else {
 		cgit_print_branches(0);
<b>diff --git a/<a id="h10" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -112,10 +112,10 @@ char *cgit_currurl()
</a> {
 	if (!cgit_virtual_root)
 		return cgit_script_name;
<a href="#h10-0-3" id="h10-0-3" class="d">-	else if (cgit_query_page)
</a><a href="#h10-0-4" id="h10-0-4" class="d">-		return fmt(&quot;%s/%s/%s/&quot;, cgit_virtual_root, cgit_query_repo, cgit_query_page);
</a><a href="#h10-0-5" id="h10-0-5" class="d">-	else if (cgit_query_repo)
</a><a href="#h10-0-6" id="h10-0-6" class="d">-		return fmt(&quot;%s/%s/&quot;, cgit_virtual_root, cgit_query_repo);
</a><a href="#h10-0-7" id="h10-0-7" class="i">+	else if (ctx.qry.page)
</a><a href="#h10-0-8" id="h10-0-8" class="i">+		return fmt(&quot;%s/%s/%s/&quot;, cgit_virtual_root, ctx.qry.repo, ctx.qry.page);
</a><a href="#h10-0-9" id="h10-0-9" class="i">+	else if (ctx.qry.repo)
</a><a href="#h10-0-10" id="h10-0-10" class="i">+		return fmt(&quot;%s/%s/&quot;, cgit_virtual_root, ctx.qry.repo);
</a> 	else
 		return fmt(&quot;%s/&quot;, cgit_virtual_root);
 }
<a href="#h10-1" id="h10-1" class="h">@@ -179,7 +179,7 @@ static void reporevlink(char *page, char *name, char *title, char *class,
</a> 	char *delim;
 
 	delim = repolink(title, class, page, head, path);
<a href="#h10-1-3" id="h10-1-3" class="d">-	if (rev &amp;&amp; strcmp(rev, cgit_query_head)) {
</a><a href="#h10-1-4" id="h10-1-4" class="i">+	if (rev &amp;&amp; strcmp(rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(rev);
<a href="#h10-2" id="h10-2" class="h">@@ -201,7 +201,7 @@ void cgit_log_link(char *name, char *title, char *class, char *head,
</a> 	char *delim;
 
 	delim = repolink(title, class, &quot;log&quot;, head, path);
<a href="#h10-2-3" id="h10-2-3" class="d">-	if (rev &amp;&amp; strcmp(rev, cgit_query_head)) {
</a><a href="#h10-2-4" id="h10-2-4" class="i">+	if (rev &amp;&amp; strcmp(rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(rev);
<a href="#h10-3" id="h10-3" class="h">@@ -256,7 +256,7 @@ void cgit_diff_link(char *name, char *title, char *class, char *head,
</a> 	char *delim;
 
 	delim = repolink(title, class, &quot;diff&quot;, head, path);
<a href="#h10-3-3" id="h10-3-3" class="d">-	if (new_rev &amp;&amp; strcmp(new_rev, cgit_query_head)) {
</a><a href="#h10-3-4" id="h10-3-4" class="i">+	if (new_rev &amp;&amp; strcmp(new_rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(new_rev);
<a href="#h10-4" id="h10-4" class="h">@@ -284,7 +284,7 @@ void cgit_object_link(struct object *obj)
</a> 
 	if (obj-&gt;type == OBJ_COMMIT) {
                 cgit_commit_link(fmt(&quot;commit %s&quot;, sha1_to_hex(obj-&gt;sha1)), NULL, NULL,
<a href="#h10-4-3" id="h10-4-3" class="d">-				 cgit_query_head, sha1_to_hex(obj-&gt;sha1));
</a><a href="#h10-4-4" id="h10-4-4" class="i">+				 ctx.qry.head, sha1_to_hex(obj-&gt;sha1));
</a> 		return;
 	} else if (obj-&gt;type == OBJ_TREE) {
 		page = &quot;tree&quot;;
<a href="#h10-5" id="h10-5" class="h">@@ -297,7 +297,7 @@ void cgit_object_link(struct object *obj)
</a> 		arg = &quot;id&quot;;
 	}
 
<a href="#h10-5-3" id="h10-5-3" class="d">-	url = cgit_pageurl(cgit_query_repo, page,
</a><a href="#h10-5-4" id="h10-5-4" class="i">+	url = cgit_pageurl(ctx.qry.repo, page,
</a> 			   fmt(&quot;%s=%s&quot;, arg, sha1_to_hex(obj-&gt;sha1)));
 	html_link_open(url, NULL, NULL);
 	htmlf(&quot;%s %s&quot;, typename(obj-&gt;type),
<a href="#h10-6" id="h10-6" class="h">@@ -392,7 +392,7 @@ int print_branch_option(const char *refname, const unsigned char *sha1,
</a> 			int flags, void *cb_data)
 {
 	char *name = (char *)refname;
<a href="#h10-6-3" id="h10-6-3" class="d">-	html_option(name, name, cgit_query_head);
</a><a href="#h10-6-4" id="h10-6-4" class="i">+	html_option(name, name, ctx.qry.head);
</a> 	return 0;
 }
 
<a href="#h10-7" id="h10-7" class="h">@@ -426,7 +426,7 @@ int print_archive_ref(const char *refname, const unsigned char *sha1,
</a> 		html(&quot;&lt;h1&gt;download&lt;/h1&gt;\n&quot;);
 		*header = 1;
 	}
<a href="#h10-7-3" id="h10-7-3" class="d">-	url = cgit_pageurl(cgit_query_repo, &quot;blob&quot;,
</a><a href="#h10-7-4" id="h10-7-4" class="i">+	url = cgit_pageurl(ctx.qry.repo, &quot;blob&quot;,
</a> 			   fmt(&quot;id=%s&amp;amp;path=%s&quot;, sha1_to_hex(fileid),
 			       buf));
 	html_link_open(url, NULL, &quot;menu&quot;);
<a href="#h10-8" id="h10-8" class="h">@@ -440,25 +440,25 @@ void add_hidden_formfields(int incl_head, int incl_search, char *page)
</a> 	char *url;
 
 	if (!cgit_virtual_root) {
<a href="#h10-8-3" id="h10-8-3" class="d">-		url = fmt(&quot;%s/%s&quot;, cgit_query_repo, page);
</a><a href="#h10-8-4" id="h10-8-4" class="d">-		if (cgit_query_path)
</a><a href="#h10-8-5" id="h10-8-5" class="d">-			url = fmt(&quot;%s/%s&quot;, url, cgit_query_path);
</a><a href="#h10-8-6" id="h10-8-6" class="i">+		url = fmt(&quot;%s/%s&quot;, ctx.qry.repo, page);
</a><a href="#h10-8-7" id="h10-8-7" class="i">+		if (ctx.qry.path)
</a><a href="#h10-8-8" id="h10-8-8" class="i">+			url = fmt(&quot;%s/%s&quot;, url, ctx.qry.path);
</a> 		html_hidden(&quot;url&quot;, url);
 	}
 
<a href="#h10-8-12" id="h10-8-12" class="d">-	if (incl_head &amp;&amp; strcmp(cgit_query_head, cgit_repo-&gt;defbranch))
</a><a href="#h10-8-13" id="h10-8-13" class="d">-		html_hidden(&quot;h&quot;, cgit_query_head);
</a><a href="#h10-8-14" id="h10-8-14" class="i">+	if (incl_head &amp;&amp; strcmp(ctx.qry.head, cgit_repo-&gt;defbranch))
</a><a href="#h10-8-15" id="h10-8-15" class="i">+		html_hidden(&quot;h&quot;, ctx.qry.head);
</a> 
<a href="#h10-8-17" id="h10-8-17" class="d">-	if (cgit_query_sha1)
</a><a href="#h10-8-18" id="h10-8-18" class="d">-		html_hidden(&quot;id&quot;, cgit_query_sha1);
</a><a href="#h10-8-19" id="h10-8-19" class="d">-	if (cgit_query_sha2)
</a><a href="#h10-8-20" id="h10-8-20" class="d">-		html_hidden(&quot;id2&quot;, cgit_query_sha2);
</a><a href="#h10-8-21" id="h10-8-21" class="i">+	if (ctx.qry.sha1)
</a><a href="#h10-8-22" id="h10-8-22" class="i">+		html_hidden(&quot;id&quot;, ctx.qry.sha1);
</a><a href="#h10-8-23" id="h10-8-23" class="i">+	if (ctx.qry.sha2)
</a><a href="#h10-8-24" id="h10-8-24" class="i">+		html_hidden(&quot;id2&quot;, ctx.qry.sha2);
</a> 
 	if (incl_search) {
<a href="#h10-8-27" id="h10-8-27" class="d">-		if (cgit_query_grep)
</a><a href="#h10-8-28" id="h10-8-28" class="d">-			html_hidden(&quot;qt&quot;, cgit_query_grep);
</a><a href="#h10-8-29" id="h10-8-29" class="d">-		if (cgit_query_search)
</a><a href="#h10-8-30" id="h10-8-30" class="d">-			html_hidden(&quot;q&quot;, cgit_query_search);
</a><a href="#h10-8-31" id="h10-8-31" class="i">+		if (ctx.qry.grep)
</a><a href="#h10-8-32" id="h10-8-32" class="i">+			html_hidden(&quot;qt&quot;, ctx.qry.grep);
</a><a href="#h10-8-33" id="h10-8-33" class="i">+		if (ctx.qry.search)
</a><a href="#h10-8-34" id="h10-8-34" class="i">+			html_hidden(&quot;q&quot;, ctx.qry.search);
</a> 	}
 }
 
<a href="#h10-9" id="h10-9" class="h">@@ -476,7 +476,7 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 	htmlf(&quot;&#39;&gt;&lt;img src=&#39;%s&#39; alt=&#39;cgit&#39;/&gt;&lt;/a&gt;\n&quot;,
 	      cgit_logo);
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td class=&#39;sidebar&#39;&gt;\n&quot;);
<a href="#h10-9-3" id="h10-9-3" class="d">-	if (cgit_query_repo) {
</a><a href="#h10-9-4" id="h10-9-4" class="i">+	if (ctx.qry.repo) {
</a> 		html(&quot;&lt;h1 class=&#39;first&#39;&gt;&quot;);
 		html_txt(strrpart(cgit_repo-&gt;name, 20));
 		html(&quot;&lt;/h1&gt;\n&quot;);
<a href="#h10-10" id="h10-10" class="h">@@ -486,18 +486,18 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 			html_txt(cgit_repo-&gt;owner);
 		}
 		html(&quot;&lt;h1&gt;navigate&lt;/h1&gt;\n&quot;);
<a href="#h10-10-3" id="h10-10-3" class="d">-		reporevlink(NULL, &quot;summary&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h10-10-4" id="h10-10-4" class="i">+		reporevlink(NULL, &quot;summary&quot;, NULL, &quot;menu&quot;, ctx.qry.head,
</a> 			    NULL, NULL);
<a href="#h10-10-6" id="h10-10-6" class="d">-		cgit_log_link(&quot;log&quot;, NULL, &quot;menu&quot;, cgit_query_head, NULL, NULL,
</a><a href="#h10-10-7" id="h10-10-7" class="i">+		cgit_log_link(&quot;log&quot;, NULL, &quot;menu&quot;, ctx.qry.head, NULL, NULL,
</a> 			      0, NULL, NULL);
<a href="#h10-10-9" id="h10-10-9" class="d">-		cgit_tree_link(&quot;tree&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h10-10-10" id="h10-10-10" class="d">-			       cgit_query_sha1, NULL);
</a><a href="#h10-10-11" id="h10-10-11" class="d">-		cgit_commit_link(&quot;commit&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h10-10-12" id="h10-10-12" class="d">-			      cgit_query_sha1);
</a><a href="#h10-10-13" id="h10-10-13" class="d">-		cgit_diff_link(&quot;diff&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h10-10-14" id="h10-10-14" class="d">-			       cgit_query_sha1, cgit_query_sha2, NULL);
</a><a href="#h10-10-15" id="h10-10-15" class="d">-		cgit_patch_link(&quot;patch&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h10-10-16" id="h10-10-16" class="d">-				cgit_query_sha1);
</a><a href="#h10-10-17" id="h10-10-17" class="i">+		cgit_tree_link(&quot;tree&quot;, NULL, &quot;menu&quot;, ctx.qry.head,
</a><a href="#h10-10-18" id="h10-10-18" class="i">+			       ctx.qry.sha1, NULL);
</a><a href="#h10-10-19" id="h10-10-19" class="i">+		cgit_commit_link(&quot;commit&quot;, NULL, &quot;menu&quot;, ctx.qry.head,
</a><a href="#h10-10-20" id="h10-10-20" class="i">+			      ctx.qry.sha1);
</a><a href="#h10-10-21" id="h10-10-21" class="i">+		cgit_diff_link(&quot;diff&quot;, NULL, &quot;menu&quot;, ctx.qry.head,
</a><a href="#h10-10-22" id="h10-10-22" class="i">+			       ctx.qry.sha1, ctx.qry.sha2, NULL);
</a><a href="#h10-10-23" id="h10-10-23" class="i">+		cgit_patch_link(&quot;patch&quot;, NULL, &quot;menu&quot;, ctx.qry.head,
</a><a href="#h10-10-24" id="h10-10-24" class="i">+				ctx.qry.sha1);
</a> 
 		for_each_ref(print_archive_ref, &amp;header);
 
<a href="#h10-11" id="h10-11" class="h">@@ -519,10 +519,10 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 
 		html(&quot;&lt;h1&gt;branch&lt;/h1&gt;\n&quot;);
 		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;\n&quot;);
<a href="#h10-11-3" id="h10-11-3" class="d">-		add_hidden_formfields(0, 1, cgit_query_page);
</a><a href="#h10-11-4" id="h10-11-4" class="i">+		add_hidden_formfields(0, 1, ctx.qry.page);
</a> //		html(&quot;&lt;table summary=&#39;branch selector&#39; class=&#39;grid&#39;&gt;&lt;tr&gt;&lt;td id=&#39;branch-dropdown-cell&#39;&gt;&quot;);
 		html(&quot;&lt;select name=&#39;h&#39; onchange=&#39;this.form.submit();&#39;&gt;\n&quot;);
<a href="#h10-11-7" id="h10-11-7" class="d">-		for_each_branch_ref(print_branch_option, cgit_query_head);
</a><a href="#h10-11-8" id="h10-11-8" class="i">+		for_each_branch_ref(print_branch_option, ctx.qry.head);
</a> 		html(&quot;&lt;/select&gt;\n&quot;);
 //		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
 		html(&quot;&lt;noscript&gt;&lt;input type=&#39;submit&#39; id=&#39;switch-btn&#39; value=&#39;switch&#39;/&gt;&lt;/noscript&gt;\n&quot;);
<a href="#h10-12" id="h10-12" class="h">@@ -532,17 +532,17 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 		html(&quot;&lt;h1&gt;search&lt;/h1&gt;\n&quot;);
 		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&quot;);
 		if (cgit_virtual_root)
<a href="#h10-12-3" id="h10-12-3" class="d">-			html_attr(cgit_fileurl(cgit_query_repo, &quot;log&quot;,
</a><a href="#h10-12-4" id="h10-12-4" class="d">-					       cgit_query_path, NULL));
</a><a href="#h10-12-5" id="h10-12-5" class="i">+			html_attr(cgit_fileurl(ctx.qry.repo, &quot;log&quot;,
</a><a href="#h10-12-6" id="h10-12-6" class="i">+					       ctx.qry.path, NULL));
</a> 		html(&quot;&#39;&gt;\n&quot;);
 		add_hidden_formfields(1, 0, &quot;log&quot;);
 		html(&quot;&lt;select name=&#39;qt&#39;&gt;\n&quot;);
<a href="#h10-12-10" id="h10-12-10" class="d">-		html_option(&quot;grep&quot;, &quot;log msg&quot;, cgit_query_grep);
</a><a href="#h10-12-11" id="h10-12-11" class="d">-		html_option(&quot;author&quot;, &quot;author&quot;, cgit_query_grep);
</a><a href="#h10-12-12" id="h10-12-12" class="d">-		html_option(&quot;committer&quot;, &quot;committer&quot;, cgit_query_grep);
</a><a href="#h10-12-13" id="h10-12-13" class="i">+		html_option(&quot;grep&quot;, &quot;log msg&quot;, ctx.qry.grep);
</a><a href="#h10-12-14" id="h10-12-14" class="i">+		html_option(&quot;author&quot;, &quot;author&quot;, ctx.qry.grep);
</a><a href="#h10-12-15" id="h10-12-15" class="i">+		html_option(&quot;committer&quot;, &quot;committer&quot;, ctx.qry.grep);
</a> 		html(&quot;&lt;/select&gt;\n&quot;);
 		html(&quot;&lt;input class=&#39;txt&#39; type=&#39;text&#39; name=&#39;q&#39; value=&#39;&quot;);
<a href="#h10-12-18" id="h10-12-18" class="d">-		html_attr(cgit_query_search);
</a><a href="#h10-12-19" id="h10-12-19" class="i">+		html_attr(ctx.qry.search);
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 		html(&quot;&lt;/form&gt;\n&quot;);
 	} else {
<b>diff --git a/<a id="h11" href="../file/ui-summary.c.html">ui-summary.c</a> b/<a href="../file/ui-summary.c.html">ui-summary.c</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -94,7 +94,7 @@ static int print_tag(struct refinfo *ref)
</a> 		if (!tag || !info)
 			return 1;
 		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
<a href="#h11-0-3" id="h11-0-3" class="d">-		url = cgit_pageurl(cgit_query_repo, &quot;tag&quot;,
</a><a href="#h11-0-4" id="h11-0-4" class="i">+		url = cgit_pageurl(ctx.qry.repo, &quot;tag&quot;,
</a> 				   fmt(&quot;id=%s&quot;, name));
 		html_link_open(url, NULL, NULL);
 		html_txt(name);
<a href="#h11-1" id="h11-1" class="h">@@ -123,7 +123,7 @@ static int print_tag(struct refinfo *ref)
</a> static void print_refs_link(char *path)
 {
 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&quot;);
<a href="#h11-1-3" id="h11-1-3" class="d">-	cgit_refs_link(&quot;[...]&quot;, NULL, NULL, cgit_query_head, NULL, path);
</a><a href="#h11-1-4" id="h11-1-4" class="i">+	cgit_refs_link(&quot;[...]&quot;, NULL, NULL, ctx.qry.head, NULL, path);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
 }
 
<a href="#h11-2" id="h11-2" class="h">@@ -188,7 +188,7 @@ void cgit_print_summary()
</a> 		html(&quot;&lt;/div&gt;&quot;);
 	}
 	if (cgit_summary_log &gt; 0)
<a href="#h11-2-3" id="h11-2-3" class="d">-		cgit_print_log(cgit_query_head, 0, cgit_summary_log, NULL,
</a><a href="#h11-2-4" id="h11-2-4" class="i">+		cgit_print_log(ctx.qry.head, 0, cgit_summary_log, NULL,
</a> 			       NULL, NULL, 0);
 	html(&quot;&lt;table summary=&#39;repository info&#39; class=&#39;list nowrap&#39;&gt;&quot;);
 	if (cgit_summary_log &gt; 0)
<b>diff --git a/<a id="h12" href="../file/ui-tree.c.html">ui-tree.c</a> b/<a href="../file/ui-tree.c.html">ui-tree.c</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -34,7 +34,7 @@ static void print_object(const unsigned char *sha1, char *path)
</a> 	}
 
 	html(&quot; blob: &lt;a href=&#39;&quot;);
<a href="#h12-0-3" id="h12-0-3" class="d">-	html_attr(cgit_pageurl(cgit_query_repo, &quot;blob&quot;, fmt(&quot;id=%s&quot;, sha1_to_hex(sha1))));
</a><a href="#h12-0-4" id="h12-0-4" class="i">+	html_attr(cgit_pageurl(ctx.qry.repo, &quot;blob&quot;, fmt(&quot;id=%s&quot;, sha1_to_hex(sha1))));
</a> 	htmlf(&quot;&#39;&gt;%s&lt;/a&gt;&quot;,sha1_to_hex(sha1));
 
 	html(&quot;&lt;table summary=&#39;blob content&#39; class=&#39;blob&#39;&gt;\n&quot;);
<a href="#h12-1" id="h12-1" class="h">@@ -67,8 +67,8 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> 	unsigned long size = 0;
 
 	name = xstrdup(pathname);
<a href="#h12-1-3" id="h12-1-3" class="d">-	fullpath = fmt(&quot;%s%s%s&quot;, cgit_query_path ? cgit_query_path : &quot;&quot;,
</a><a href="#h12-1-4" id="h12-1-4" class="d">-		       cgit_query_path ? &quot;/&quot; : &quot;&quot;, name);
</a><a href="#h12-1-5" id="h12-1-5" class="i">+	fullpath = fmt(&quot;%s%s%s&quot;, ctx.qry.path ? ctx.qry.path : &quot;&quot;,
</a><a href="#h12-1-6" id="h12-1-6" class="i">+		       ctx.qry.path ? &quot;/&quot; : &quot;&quot;, name);
</a> 
 	type = sha1_object_info(sha1, &amp;size);
 	if (type == OBJ_BAD &amp;&amp; !S_ISGITLINK(mode)) {
<a href="#h12-2" id="h12-2" class="h">@@ -90,16 +90,16 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> 		html_txt(name);
 		html(&quot;&lt;/a&gt;&quot;);
 	} else if (S_ISDIR(mode)) {
<a href="#h12-2-3" id="h12-2-3" class="d">-		cgit_tree_link(name, NULL, &quot;ls-dir&quot;, cgit_query_head,
</a><a href="#h12-2-4" id="h12-2-4" class="i">+		cgit_tree_link(name, NULL, &quot;ls-dir&quot;, ctx.qry.head,
</a> 			       curr_rev, fullpath);
 	} else {
<a href="#h12-2-7" id="h12-2-7" class="d">-		cgit_tree_link(name, NULL, &quot;ls-blob&quot;, cgit_query_head,
</a><a href="#h12-2-8" id="h12-2-8" class="i">+		cgit_tree_link(name, NULL, &quot;ls-blob&quot;, ctx.qry.head,
</a> 			       curr_rev, fullpath);
 	}
 	htmlf(&quot;&lt;/td&gt;&lt;td class=&#39;ls-size&#39;&gt;%li&lt;/td&gt;&quot;, size);
 
 	html(&quot;&lt;td&gt;&quot;);
<a href="#h12-2-14" id="h12-2-14" class="d">-	cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, cgit_query_head, curr_rev,
</a><a href="#h12-2-15" id="h12-2-15" class="i">+	cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, ctx.qry.head, curr_rev,
</a> 		      fullpath, 0, NULL, NULL);
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
 	free(name);
<a href="#h12-3" id="h12-3" class="h">@@ -153,10 +153,10 @@ static int walk_tree(const unsigned char *sha1, const char *base, int baselen,
</a> 	if (state == 0) {
 		memcpy(buffer, base, baselen);
 		strcpy(buffer+baselen, pathname);
<a href="#h12-3-3" id="h12-3-3" class="d">-		url = cgit_pageurl(cgit_query_repo, &quot;tree&quot;,
</a><a href="#h12-3-4" id="h12-3-4" class="i">+		url = cgit_pageurl(ctx.qry.repo, &quot;tree&quot;,
</a> 				   fmt(&quot;h=%s&amp;amp;path=%s&quot;, curr_rev, buffer));
 		html(&quot;/&quot;);
<a href="#h12-3-7" id="h12-3-7" class="d">-		cgit_tree_link(xstrdup(pathname), NULL, NULL, cgit_query_head,
</a><a href="#h12-3-8" id="h12-3-8" class="i">+		cgit_tree_link(xstrdup(pathname), NULL, NULL, ctx.qry.head,
</a> 			       curr_rev, buffer);
 
 		if (strcmp(match_path, buffer))
<a href="#h12-4" id="h12-4" class="h">@@ -188,7 +188,7 @@ void cgit_print_tree(const char *rev, char *path)
</a> 	const char *paths[] = {path, NULL};
 
 	if (!rev)
<a href="#h12-4-3" id="h12-4-3" class="d">-		rev = cgit_query_head;
</a><a href="#h12-4-4" id="h12-4-4" class="i">+		rev = ctx.qry.head;
</a> 
 	curr_rev = xstrdup(rev);
 	if (get_sha1(rev, sha1)) {
<a href="#h12-5" id="h12-5" class="h">@@ -202,7 +202,7 @@ void cgit_print_tree(const char *rev, char *path)
</a> 	}
 
 	html(&quot;path: &lt;a href=&#39;&quot;);
<a href="#h12-5-3" id="h12-5-3" class="d">-	html_attr(cgit_pageurl(cgit_query_repo, &quot;tree&quot;, fmt(&quot;h=%s&quot;, rev)));
</a><a href="#h12-5-4" id="h12-5-4" class="i">+	html_attr(cgit_pageurl(ctx.qry.repo, &quot;tree&quot;, fmt(&quot;h=%s&quot;, rev)));
</a> 	html(&quot;&#39;&gt;root&lt;/a&gt;&quot;);
 
 	if (path == NULL) {
</pre>
</div>
</body>
</html>
