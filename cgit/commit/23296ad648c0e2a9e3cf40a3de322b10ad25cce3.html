<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merge branch &#39;lh/cleanup&#39; - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/23296ad648c0e2a9e3cf40a3de322b10ad25cce3.html">23296ad648c0e2a9e3cf40a3de322b10ad25cce3</a>
<b>parent</b> <a href="../commit/e2a44cf0923398396b7a321d5ce894ad3bf6f580.html">e2a44cf0923398396b7a321d5ce894ad3bf6f580</a>
<b>Author:</b> Lars Hjemli &lt;<a href="mailto:hjemli@gmail.com">hjemli@gmail.com</a>&gt;
<b>Date:</b>   Tue,  8 Apr 2008 21:29:21 +0200

Merge branch &#39;lh/cleanup&#39;

* lh/cleanup: (21 commits)
  Reset ctx.repo to NULL when the config parser is finished
  Move cgit_parse_query() from parsing.c to html.c as http_parse_querystring()
  Move function for configfile parsing into configfile.[ch]
  Add cache.h
  Remove global and obsolete cgit_cmd
  Makefile: copy the QUIET constructs from the Makefile in git.git
  Move cgit_version from shared.c to cgit.c
  Makefile: autobuild dependency rules
  Initial Makefile cleanup
  Move non-generic functions from shared.c to cgit.c
  Add ui-shared.h
  Add separate header-files for each page/view
  Refactor snapshot support
  Add command dispatcher
  Remove obsolete cacheitem parameter to ui-functions
  Add struct cgit_page to cgit_context
  Introduce html.h
  Improve initialization of git directory
  Move cgit_repo into cgit_context
  Add all config variables into struct cgit_context
  ...

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">.gitignore</a></td><td> | </td><td class="num">1</td><td><span class="i">+</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">Makefile</a></td><td> | </td><td class="num">75</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-----------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">cache.c</a></td><td> | </td><td class="num">21</td><td><span class="i">+++++++++++</span><span class="d">----------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h3">cache.h</a></td><td> | </td><td class="num">23</td><td><span class="i">+++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h4">cgit.c</a></td><td> | </td><td class="num">391</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">cgit.h</a></td><td> | </td><td class="num">237</td><td><span class="i">++++++++++++++++++++++++++++</span><span class="d">---------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h6">cmd.c</a></td><td> | </td><td class="num">112</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h7">cmd.h</a></td><td> | </td><td class="num">15</td><td><span class="i">+++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h8">configfile.c</a></td><td> | </td><td class="num">87</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h9">configfile.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h10">html.c</a></td><td> | </td><td class="num">95</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">----------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h11">html.h</a></td><td> | </td><td class="num">20</td><td><span class="i">++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h12">parsing.c</a></td><td> | </td><td class="num">146</td><td><span class="i">++++++</span><span class="d">-------------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h13">shared.c</a></td><td> | </td><td class="num">257</td><td><span class="i">+++++++++++++</span><span class="d">------------------------------------------------------------------</span></td></tr>
<tr><td class="M">M</td><td><a href="#h14">ui-blob.c</a></td><td> | </td><td class="num">16</td><td><span class="i">++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="A">A</td><td><a href="#h15">ui-blob.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h16">ui-commit.c</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h17">ui-commit.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h18">ui-diff.c</a></td><td> | </td><td class="num">9</td><td><span class="i">+++++</span><span class="d">----</span></td></tr>
<tr><td class="A">A</td><td><a href="#h19">ui-diff.h</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h20">ui-log.c</a></td><td> | </td><td class="num">32</td><td><span class="i">+++++++++++++++++</span><span class="d">---------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h21">ui-log.h</a></td><td> | </td><td class="num">7</td><td><span class="i">+++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h22">ui-patch.c</a></td><td> | </td><td class="num">10</td><td><span class="i">+++++++</span><span class="d">---</span></td></tr>
<tr><td class="A">A</td><td><a href="#h23">ui-patch.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h24">ui-refs.c</a></td><td> | </td><td class="num">175</td><td><span class="i">++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h25">ui-refs.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h26">ui-repolist.c</a></td><td> | </td><td class="num">54</td><td><span class="i">+++++++++++++++++++++++++++++</span><span class="d">-------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h27">ui-repolist.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h28">ui-shared.c</a></td><td> | </td><td class="num">237</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++</span><span class="d">------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h29">ui-shared.h</a></td><td> | </td><td class="num">36</td><td><span class="i">++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h30">ui-snapshot.c</a></td><td> | </td><td class="num">123</td><td><span class="i">++++++++++++++++++++++++++</span><span class="d">-----------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h31">ui-snapshot.h</a></td><td> | </td><td class="num">8</td><td><span class="i">++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h32">ui-summary.c</a></td><td> | </td><td class="num">189</td><td><span class="i">+++++</span><span class="d">--------------------------------------------------------------------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h33">ui-summary.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h34">ui-tag.c</a></td><td> | </td><td class="num">3</td><td><span class="i">++</span><span class="d">-</span></td></tr>
<tr><td class="A">A</td><td><a href="#h35">ui-tag.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h36">ui-tree.c</a></td><td> | </td><td class="num">26</td><td><span class="i">++++++++++++++</span><span class="d">------------</span></td></tr>
<tr><td class="A">A</td><td><a href="#h37">ui-tree.h</a></td><td> | </td><td class="num">6</td><td><span class="i">++++++</span><span class="d"></span></td></tr>
</table></pre><pre>38 files changed, 1379 insertions(+), 1117 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/.gitignore.html">.gitignore</a> b/<a href="../file/.gitignore.html">.gitignore</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -3,3 +3,4 @@ cgit
</a> cgit.conf
 VERSION
 *.o
<a href="#h0-0-3" id="h0-0-3" class="i">+*.d
</a><b>diff --git a/<a id="h1" href="../file/Makefile.html">Makefile</a> b/<a href="../file/Makefile.html">Makefile</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -12,13 +12,62 @@ GIT_URL = http://www.kernel.org/pub/software/scm/git/git-$(GIT_VER).tar.bz2
</a> #
 -include cgit.conf
 
<a href="#h1-0-3" id="h1-0-3" class="i">+#
</a><a href="#h1-0-4" id="h1-0-4" class="i">+# Define a way to invoke make in subdirs quietly, shamelessly ripped
</a><a href="#h1-0-5" id="h1-0-5" class="i">+# from git.git
</a><a href="#h1-0-6" id="h1-0-6" class="i">+#
</a><a href="#h1-0-7" id="h1-0-7" class="i">+QUIET_SUBDIR0  = +$(MAKE) -C # space to separate -C and subdir
</a><a href="#h1-0-8" id="h1-0-8" class="i">+QUIET_SUBDIR1  =
</a> 
<a href="#h1-0-10" id="h1-0-10" class="d">-EXTLIBS = git/libgit.a git/xdiff/lib.a -lz -lcrypto
</a><a href="#h1-0-11" id="h1-0-11" class="d">-OBJECTS = shared.o cache.o parsing.o html.o ui-shared.o ui-repolist.o \
</a><a href="#h1-0-12" id="h1-0-12" class="d">-	ui-summary.o ui-log.o ui-tree.o ui-commit.o ui-diff.o \
</a><a href="#h1-0-13" id="h1-0-13" class="d">-	ui-snapshot.o ui-blob.o ui-tag.o ui-refs.o ui-patch.o
</a><a href="#h1-0-14" id="h1-0-14" class="i">+ifneq ($(findstring $(MAKEFLAGS),w),w)
</a><a href="#h1-0-15" id="h1-0-15" class="i">+PRINT_DIR = --no-print-directory
</a><a href="#h1-0-16" id="h1-0-16" class="i">+else # &quot;make -w&quot;
</a><a href="#h1-0-17" id="h1-0-17" class="i">+NO_SUBDIR = :
</a><a href="#h1-0-18" id="h1-0-18" class="i">+endif
</a><a href="#h1-0-19" id="h1-0-19" class="i">+
</a><a href="#h1-0-20" id="h1-0-20" class="i">+ifndef V
</a><a href="#h1-0-21" id="h1-0-21" class="i">+	QUIET_CC       = @echo &#39;   &#39; CC $@;
</a><a href="#h1-0-22" id="h1-0-22" class="i">+	QUIET_MM       = @echo &#39;   &#39; MM $@;
</a><a href="#h1-0-23" id="h1-0-23" class="i">+	QUIET_SUBDIR0  = +@subdir=
</a><a href="#h1-0-24" id="h1-0-24" class="i">+	QUIET_SUBDIR1  = ;$(NO_SUBDIR) echo &#39;   &#39; SUBDIR $$subdir; \
</a><a href="#h1-0-25" id="h1-0-25" class="i">+			 $(MAKE) $(PRINT_DIR) -C $$subdir
</a><a href="#h1-0-26" id="h1-0-26" class="i">+endif
</a><a href="#h1-0-27" id="h1-0-27" class="i">+
</a><a href="#h1-0-28" id="h1-0-28" class="i">+#
</a><a href="#h1-0-29" id="h1-0-29" class="i">+# Define a pattern rule for automatic dependency building
</a><a href="#h1-0-30" id="h1-0-30" class="i">+#
</a><a href="#h1-0-31" id="h1-0-31" class="i">+%.d: %.c
</a><a href="#h1-0-32" id="h1-0-32" class="i">+	$(QUIET_MM)$(CC) $(CFLAGS) -MM $&lt; | sed -e &#39;s/\($*\)\.o:/\1.o $@:/g&#39; &gt;$@
</a><a href="#h1-0-33" id="h1-0-33" class="i">+
</a><a href="#h1-0-34" id="h1-0-34" class="i">+#
</a><a href="#h1-0-35" id="h1-0-35" class="i">+# Define a pattern rule for silent object building
</a><a href="#h1-0-36" id="h1-0-36" class="i">+#
</a><a href="#h1-0-37" id="h1-0-37" class="i">+%.o: %.c
</a><a href="#h1-0-38" id="h1-0-38" class="i">+	$(QUIET_CC)$(CC) -o $*.o -c $(CFLAGS) $&lt;
</a> 
 
<a href="#h1-0-41" id="h1-0-41" class="i">+EXTLIBS = git/libgit.a git/xdiff/lib.a -lz -lcrypto
</a><a href="#h1-0-42" id="h1-0-42" class="i">+OBJECTS =
</a><a href="#h1-0-43" id="h1-0-43" class="i">+OBJECTS += cache.o
</a><a href="#h1-0-44" id="h1-0-44" class="i">+OBJECTS += cgit.o
</a><a href="#h1-0-45" id="h1-0-45" class="i">+OBJECTS += cmd.o
</a><a href="#h1-0-46" id="h1-0-46" class="i">+OBJECTS += configfile.o
</a><a href="#h1-0-47" id="h1-0-47" class="i">+OBJECTS += html.o
</a><a href="#h1-0-48" id="h1-0-48" class="i">+OBJECTS += parsing.o
</a><a href="#h1-0-49" id="h1-0-49" class="i">+OBJECTS += shared.o
</a><a href="#h1-0-50" id="h1-0-50" class="i">+OBJECTS += ui-blob.o
</a><a href="#h1-0-51" id="h1-0-51" class="i">+OBJECTS += ui-commit.o
</a><a href="#h1-0-52" id="h1-0-52" class="i">+OBJECTS += ui-diff.o
</a><a href="#h1-0-53" id="h1-0-53" class="i">+OBJECTS += ui-log.o
</a><a href="#h1-0-54" id="h1-0-54" class="i">+OBJECTS += ui-patch.o
</a><a href="#h1-0-55" id="h1-0-55" class="i">+OBJECTS += ui-refs.o
</a><a href="#h1-0-56" id="h1-0-56" class="i">+OBJECTS += ui-repolist.o
</a><a href="#h1-0-57" id="h1-0-57" class="i">+OBJECTS += ui-shared.o
</a><a href="#h1-0-58" id="h1-0-58" class="i">+OBJECTS += ui-snapshot.o
</a><a href="#h1-0-59" id="h1-0-59" class="i">+OBJECTS += ui-summary.o
</a><a href="#h1-0-60" id="h1-0-60" class="i">+OBJECTS += ui-tag.o
</a><a href="#h1-0-61" id="h1-0-61" class="i">+OBJECTS += ui-tree.o
</a><a href="#h1-0-62" id="h1-0-62" class="i">+
</a> ifdef NEEDS_LIBICONV
 	EXTLIBS += -liconv
 endif
<a href="#h1-1" id="h1-1" class="h">@@ -41,21 +90,25 @@ CFLAGS += -DCGIT_SCRIPT_NAME=&#39;&quot;$(CGIT_SCRIPT_NAME)&quot;&#39;
</a> CFLAGS += -DCGIT_CACHE_ROOT=&#39;&quot;$(CACHE_ROOT)&quot;&#39;
 
 
<a href="#h1-1-3" id="h1-1-3" class="d">-cgit: cgit.c $(OBJECTS)
</a><a href="#h1-1-4" id="h1-1-4" class="d">-	$(CC) $(CFLAGS) cgit.c -o cgit $(OBJECTS) $(EXTLIBS)
</a><a href="#h1-1-5" id="h1-1-5" class="i">+cgit: $(OBJECTS)
</a><a href="#h1-1-6" id="h1-1-6" class="i">+	$(QUIET_CC)$(CC) $(CFLAGS) -o cgit $(OBJECTS) $(EXTLIBS)
</a><a href="#h1-1-7" id="h1-1-7" class="i">+
</a><a href="#h1-1-8" id="h1-1-8" class="i">+$(OBJECTS): git/xdiff/lib.a git/libgit.a
</a><a href="#h1-1-9" id="h1-1-9" class="i">+
</a><a href="#h1-1-10" id="h1-1-10" class="i">+cgit.o: VERSION
</a> 
<a href="#h1-1-12" id="h1-1-12" class="d">-$(OBJECTS): cgit.h git/xdiff/lib.a git/libgit.a VERSION
</a><a href="#h1-1-13" id="h1-1-13" class="i">+-include $(OBJECTS:.o=.d)
</a> 
 git/xdiff/lib.a: | git
 
 git/libgit.a: | git
 
 git:
<a href="#h1-1-20" id="h1-1-20" class="d">-	cd git &amp;&amp; $(MAKE) xdiff/lib.a
</a><a href="#h1-1-21" id="h1-1-21" class="d">-	cd git &amp;&amp; $(MAKE) libgit.a
</a><a href="#h1-1-22" id="h1-1-22" class="i">+	$(QUIET_SUBDIR0)git $(QUIET_SUBDIR1) xdiff/lib.a
</a><a href="#h1-1-23" id="h1-1-23" class="i">+	$(QUIET_SUBDIR0)git $(QUIET_SUBDIR1) libgit.a
</a> 
 test: all
<a href="#h1-1-26" id="h1-1-26" class="d">-	$(MAKE) -C tests
</a><a href="#h1-1-27" id="h1-1-27" class="i">+	$(QUIET_SUBDIR0)tests $(QUIET_SUBDIR1) all
</a> 
 install: all
 	mkdir -p $(DESTDIR)$(CGIT_SCRIPT_PATH)
<a href="#h1-2" id="h1-2" class="h">@@ -69,7 +122,7 @@ uninstall:
</a> 	rm -f $(CGIT_SCRIPT_PATH)/cgit.png
 
 clean:
<a href="#h1-2-3" id="h1-2-3" class="d">-	rm -f cgit VERSION *.o
</a><a href="#h1-2-4" id="h1-2-4" class="i">+	rm -f cgit VERSION *.o *.d
</a> 	cd git &amp;&amp; $(MAKE) clean
 
 distclean: clean
<b>diff --git a/<a id="h2" href="../file/cache.c.html">cache.c</a> b/<a href="../file/cache.c.html">cache.c</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -7,6 +7,7 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h2-0-3" id="h2-0-3" class="i">+#include &quot;cache.h&quot;
</a> 
 const int NOLOCK = -1;
 
<a href="#h2-1" id="h2-1" class="h">@@ -44,23 +45,23 @@ int cache_create_dirs()
</a> {
 	char *path;
 
<a href="#h2-1-3" id="h2-1-3" class="d">-	path = fmt(&quot;%s&quot;, cgit_cache_root);
</a><a href="#h2-1-4" id="h2-1-4" class="i">+	path = fmt(&quot;%s&quot;, ctx.cfg.cache_root);
</a> 	if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
 		return 0;
 
<a href="#h2-1-8" id="h2-1-8" class="d">-	if (!cgit_repo)
</a><a href="#h2-1-9" id="h2-1-9" class="i">+	if (!ctx.repo)
</a> 		return 0;
 
<a href="#h2-1-12" id="h2-1-12" class="d">-	path = fmt(&quot;%s/%s&quot;, cgit_cache_root,
</a><a href="#h2-1-13" id="h2-1-13" class="d">-		   cache_safe_filename(cgit_repo-&gt;url));
</a><a href="#h2-1-14" id="h2-1-14" class="i">+	path = fmt(&quot;%s/%s&quot;, ctx.cfg.cache_root,
</a><a href="#h2-1-15" id="h2-1-15" class="i">+		   cache_safe_filename(ctx.repo-&gt;url));
</a> 
 	if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
 		return 0;
 
<a href="#h2-1-20" id="h2-1-20" class="d">-	if (cgit_query_page) {
</a><a href="#h2-1-21" id="h2-1-21" class="d">-		path = fmt(&quot;%s/%s/%s&quot;, cgit_cache_root,
</a><a href="#h2-1-22" id="h2-1-22" class="d">-			   cache_safe_filename(cgit_repo-&gt;url),
</a><a href="#h2-1-23" id="h2-1-23" class="d">-			   cgit_query_page);
</a><a href="#h2-1-24" id="h2-1-24" class="i">+	if (ctx.qry.page) {
</a><a href="#h2-1-25" id="h2-1-25" class="i">+		path = fmt(&quot;%s/%s/%s&quot;, ctx.cfg.cache_root,
</a><a href="#h2-1-26" id="h2-1-26" class="i">+			   cache_safe_filename(ctx.repo-&gt;url),
</a><a href="#h2-1-27" id="h2-1-27" class="i">+			   ctx.qry.page);
</a> 		if (mkdir(path, S_IRWXU) &amp;&amp; errno!=EEXIST)
 			return 0;
 	}
<a href="#h2-2" id="h2-2" class="h">@@ -74,7 +75,7 @@ int cache_refill_overdue(const char *lockfile)
</a> 	if (stat(lockfile, &amp;st))
 		return 0;
 	else
<a href="#h2-2-3" id="h2-2-3" class="d">-		return (time(NULL) - st.st_mtime &gt; cgit_cache_max_create_time);
</a><a href="#h2-2-4" id="h2-2-4" class="i">+		return (time(NULL) - st.st_mtime &gt; ctx.cfg.cache_max_create_time);
</a> }
 
 int cache_lock(struct cacheitem *item)
<a href="#h2-3" id="h2-3" class="h">@@ -83,7 +84,7 @@ int cache_lock(struct cacheitem *item)
</a> 	char *lockfile = xstrdup(fmt(&quot;%s.lock&quot;, item-&gt;name));
 
  top:
<a href="#h2-3-3" id="h2-3-3" class="d">-	if (++i &gt; cgit_max_lock_attempts)
</a><a href="#h2-3-4" id="h2-3-4" class="i">+	if (++i &gt; ctx.cfg.max_lock_attempts)
</a> 		die(&quot;cache_lock: unable to lock %s: %s&quot;,
 		    item-&gt;name, strerror(errno));
 
<b>diff --git a/<a id="h3" href="../file/cache.h.html">cache.h</a> b/<a href="../file/cache.h.html">cache.h</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -0,0 +1,23 @@
</a><a href="#h3-0-0" id="h3-0-0" class="i">+/*
</a><a href="#h3-0-1" id="h3-0-1" class="i">+ * Since git has it&#39;s own cache.h which we include,
</a><a href="#h3-0-2" id="h3-0-2" class="i">+ * lets test on CGIT_CACHE_H to avoid confusion
</a><a href="#h3-0-3" id="h3-0-3" class="i">+ */
</a><a href="#h3-0-4" id="h3-0-4" class="i">+
</a><a href="#h3-0-5" id="h3-0-5" class="i">+#ifndef CGIT_CACHE_H
</a><a href="#h3-0-6" id="h3-0-6" class="i">+#define CGIT_CACHE_H
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a><a href="#h3-0-8" id="h3-0-8" class="i">+struct cacheitem {
</a><a href="#h3-0-9" id="h3-0-9" class="i">+	char *name;
</a><a href="#h3-0-10" id="h3-0-10" class="i">+	struct stat st;
</a><a href="#h3-0-11" id="h3-0-11" class="i">+	int ttl;
</a><a href="#h3-0-12" id="h3-0-12" class="i">+	int fd;
</a><a href="#h3-0-13" id="h3-0-13" class="i">+};
</a><a href="#h3-0-14" id="h3-0-14" class="i">+
</a><a href="#h3-0-15" id="h3-0-15" class="i">+extern char *cache_safe_filename(const char *unsafe);
</a><a href="#h3-0-16" id="h3-0-16" class="i">+extern int cache_lock(struct cacheitem *item);
</a><a href="#h3-0-17" id="h3-0-17" class="i">+extern int cache_unlock(struct cacheitem *item);
</a><a href="#h3-0-18" id="h3-0-18" class="i">+extern int cache_cancel_lock(struct cacheitem *item);
</a><a href="#h3-0-19" id="h3-0-19" class="i">+extern int cache_exist(struct cacheitem *item);
</a><a href="#h3-0-20" id="h3-0-20" class="i">+extern int cache_expired(struct cacheitem *item);
</a><a href="#h3-0-21" id="h3-0-21" class="i">+
</a><a href="#h3-0-22" id="h3-0-22" class="i">+#endif /* CGIT_CACHE_H */
</a><b>diff --git a/<a id="h4" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -7,40 +7,199 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h4-0-3" id="h4-0-3" class="i">+#include &quot;cache.h&quot;
</a><a href="#h4-0-4" id="h4-0-4" class="i">+#include &quot;cmd.h&quot;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+#include &quot;configfile.h&quot;
</a><a href="#h4-0-6" id="h4-0-6" class="i">+#include &quot;html.h&quot;
</a><a href="#h4-0-7" id="h4-0-7" class="i">+#include &quot;ui-shared.h&quot;
</a><a href="#h4-0-8" id="h4-0-8" class="i">+
</a><a href="#h4-0-9" id="h4-0-9" class="i">+const char *cgit_version = CGIT_VERSION;
</a><a href="#h4-0-10" id="h4-0-10" class="i">+
</a><a href="#h4-0-11" id="h4-0-11" class="i">+void config_cb(const char *name, const char *value)
</a><a href="#h4-0-12" id="h4-0-12" class="i">+{
</a><a href="#h4-0-13" id="h4-0-13" class="i">+	if (!strcmp(name, &quot;root-title&quot;))
</a><a href="#h4-0-14" id="h4-0-14" class="i">+		ctx.cfg.root_title = xstrdup(value);
</a><a href="#h4-0-15" id="h4-0-15" class="i">+	else if (!strcmp(name, &quot;css&quot;))
</a><a href="#h4-0-16" id="h4-0-16" class="i">+		ctx.cfg.css = xstrdup(value);
</a><a href="#h4-0-17" id="h4-0-17" class="i">+	else if (!strcmp(name, &quot;logo&quot;))
</a><a href="#h4-0-18" id="h4-0-18" class="i">+		ctx.cfg.logo = xstrdup(value);
</a><a href="#h4-0-19" id="h4-0-19" class="i">+	else if (!strcmp(name, &quot;index-header&quot;))
</a><a href="#h4-0-20" id="h4-0-20" class="i">+		ctx.cfg.index_header = xstrdup(value);
</a><a href="#h4-0-21" id="h4-0-21" class="i">+	else if (!strcmp(name, &quot;index-info&quot;))
</a><a href="#h4-0-22" id="h4-0-22" class="i">+		ctx.cfg.index_info = xstrdup(value);
</a><a href="#h4-0-23" id="h4-0-23" class="i">+	else if (!strcmp(name, &quot;logo-link&quot;))
</a><a href="#h4-0-24" id="h4-0-24" class="i">+		ctx.cfg.logo_link = xstrdup(value);
</a><a href="#h4-0-25" id="h4-0-25" class="i">+	else if (!strcmp(name, &quot;module-link&quot;))
</a><a href="#h4-0-26" id="h4-0-26" class="i">+		ctx.cfg.module_link = xstrdup(value);
</a><a href="#h4-0-27" id="h4-0-27" class="i">+	else if (!strcmp(name, &quot;virtual-root&quot;)) {
</a><a href="#h4-0-28" id="h4-0-28" class="i">+		ctx.cfg.virtual_root = trim_end(value, &#39;/&#39;);
</a><a href="#h4-0-29" id="h4-0-29" class="i">+		if (!ctx.cfg.virtual_root &amp;&amp; (!strcmp(value, &quot;/&quot;)))
</a><a href="#h4-0-30" id="h4-0-30" class="i">+			ctx.cfg.virtual_root = &quot;&quot;;
</a><a href="#h4-0-31" id="h4-0-31" class="i">+	} else if (!strcmp(name, &quot;nocache&quot;))
</a><a href="#h4-0-32" id="h4-0-32" class="i">+		ctx.cfg.nocache = atoi(value);
</a><a href="#h4-0-33" id="h4-0-33" class="i">+	else if (!strcmp(name, &quot;snapshots&quot;))
</a><a href="#h4-0-34" id="h4-0-34" class="i">+		ctx.cfg.snapshots = cgit_parse_snapshots_mask(value);
</a><a href="#h4-0-35" id="h4-0-35" class="i">+	else if (!strcmp(name, &quot;enable-index-links&quot;))
</a><a href="#h4-0-36" id="h4-0-36" class="i">+		ctx.cfg.enable_index_links = atoi(value);
</a><a href="#h4-0-37" id="h4-0-37" class="i">+	else if (!strcmp(name, &quot;enable-log-filecount&quot;))
</a><a href="#h4-0-38" id="h4-0-38" class="i">+		ctx.cfg.enable_log_filecount = atoi(value);
</a><a href="#h4-0-39" id="h4-0-39" class="i">+	else if (!strcmp(name, &quot;enable-log-linecount&quot;))
</a><a href="#h4-0-40" id="h4-0-40" class="i">+		ctx.cfg.enable_log_linecount = atoi(value);
</a><a href="#h4-0-41" id="h4-0-41" class="i">+	else if (!strcmp(name, &quot;cache-root&quot;))
</a><a href="#h4-0-42" id="h4-0-42" class="i">+		ctx.cfg.cache_root = xstrdup(value);
</a><a href="#h4-0-43" id="h4-0-43" class="i">+	else if (!strcmp(name, &quot;cache-root-ttl&quot;))
</a><a href="#h4-0-44" id="h4-0-44" class="i">+		ctx.cfg.cache_root_ttl = atoi(value);
</a><a href="#h4-0-45" id="h4-0-45" class="i">+	else if (!strcmp(name, &quot;cache-repo-ttl&quot;))
</a><a href="#h4-0-46" id="h4-0-46" class="i">+		ctx.cfg.cache_repo_ttl = atoi(value);
</a><a href="#h4-0-47" id="h4-0-47" class="i">+	else if (!strcmp(name, &quot;cache-static-ttl&quot;))
</a><a href="#h4-0-48" id="h4-0-48" class="i">+		ctx.cfg.cache_static_ttl = atoi(value);
</a><a href="#h4-0-49" id="h4-0-49" class="i">+	else if (!strcmp(name, &quot;cache-dynamic-ttl&quot;))
</a><a href="#h4-0-50" id="h4-0-50" class="i">+		ctx.cfg.cache_dynamic_ttl = atoi(value);
</a><a href="#h4-0-51" id="h4-0-51" class="i">+	else if (!strcmp(name, &quot;max-message-length&quot;))
</a><a href="#h4-0-52" id="h4-0-52" class="i">+		ctx.cfg.max_msg_len = atoi(value);
</a><a href="#h4-0-53" id="h4-0-53" class="i">+	else if (!strcmp(name, &quot;max-repodesc-length&quot;))
</a><a href="#h4-0-54" id="h4-0-54" class="i">+		ctx.cfg.max_repodesc_len = atoi(value);
</a><a href="#h4-0-55" id="h4-0-55" class="i">+	else if (!strcmp(name, &quot;max-commit-count&quot;))
</a><a href="#h4-0-56" id="h4-0-56" class="i">+		ctx.cfg.max_commit_count = atoi(value);
</a><a href="#h4-0-57" id="h4-0-57" class="i">+	else if (!strcmp(name, &quot;summary-log&quot;))
</a><a href="#h4-0-58" id="h4-0-58" class="i">+		ctx.cfg.summary_log = atoi(value);
</a><a href="#h4-0-59" id="h4-0-59" class="i">+	else if (!strcmp(name, &quot;summary-branches&quot;))
</a><a href="#h4-0-60" id="h4-0-60" class="i">+		ctx.cfg.summary_branches = atoi(value);
</a><a href="#h4-0-61" id="h4-0-61" class="i">+	else if (!strcmp(name, &quot;summary-tags&quot;))
</a><a href="#h4-0-62" id="h4-0-62" class="i">+		ctx.cfg.summary_tags = atoi(value);
</a><a href="#h4-0-63" id="h4-0-63" class="i">+	else if (!strcmp(name, &quot;agefile&quot;))
</a><a href="#h4-0-64" id="h4-0-64" class="i">+		ctx.cfg.agefile = xstrdup(value);
</a><a href="#h4-0-65" id="h4-0-65" class="i">+	else if (!strcmp(name, &quot;renamelimit&quot;))
</a><a href="#h4-0-66" id="h4-0-66" class="i">+		ctx.cfg.renamelimit = atoi(value);
</a><a href="#h4-0-67" id="h4-0-67" class="i">+	else if (!strcmp(name, &quot;robots&quot;))
</a><a href="#h4-0-68" id="h4-0-68" class="i">+		ctx.cfg.robots = xstrdup(value);
</a><a href="#h4-0-69" id="h4-0-69" class="i">+	else if (!strcmp(name, &quot;clone-prefix&quot;))
</a><a href="#h4-0-70" id="h4-0-70" class="i">+		ctx.cfg.clone_prefix = xstrdup(value);
</a><a href="#h4-0-71" id="h4-0-71" class="i">+	else if (!strcmp(name, &quot;repo.group&quot;))
</a><a href="#h4-0-72" id="h4-0-72" class="i">+		ctx.cfg.repo_group = xstrdup(value);
</a><a href="#h4-0-73" id="h4-0-73" class="i">+	else if (!strcmp(name, &quot;repo.url&quot;))
</a><a href="#h4-0-74" id="h4-0-74" class="i">+		ctx.repo = cgit_add_repo(value);
</a><a href="#h4-0-75" id="h4-0-75" class="i">+	else if (!strcmp(name, &quot;repo.name&quot;))
</a><a href="#h4-0-76" id="h4-0-76" class="i">+		ctx.repo-&gt;name = xstrdup(value);
</a><a href="#h4-0-77" id="h4-0-77" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.path&quot;))
</a><a href="#h4-0-78" id="h4-0-78" class="i">+		ctx.repo-&gt;path = trim_end(value, &#39;/&#39;);
</a><a href="#h4-0-79" id="h4-0-79" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.clone-url&quot;))
</a><a href="#h4-0-80" id="h4-0-80" class="i">+		ctx.repo-&gt;clone_url = xstrdup(value);
</a><a href="#h4-0-81" id="h4-0-81" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.desc&quot;))
</a><a href="#h4-0-82" id="h4-0-82" class="i">+		ctx.repo-&gt;desc = xstrdup(value);
</a><a href="#h4-0-83" id="h4-0-83" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.owner&quot;))
</a><a href="#h4-0-84" id="h4-0-84" class="i">+		ctx.repo-&gt;owner = xstrdup(value);
</a><a href="#h4-0-85" id="h4-0-85" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.defbranch&quot;))
</a><a href="#h4-0-86" id="h4-0-86" class="i">+		ctx.repo-&gt;defbranch = xstrdup(value);
</a><a href="#h4-0-87" id="h4-0-87" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.snapshots&quot;))
</a><a href="#h4-0-88" id="h4-0-88" class="i">+		ctx.repo-&gt;snapshots = ctx.cfg.snapshots &amp; cgit_parse_snapshots_mask(value); /* XXX: &amp;? */
</a><a href="#h4-0-89" id="h4-0-89" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.enable-log-filecount&quot;))
</a><a href="#h4-0-90" id="h4-0-90" class="i">+		ctx.repo-&gt;enable_log_filecount = ctx.cfg.enable_log_filecount * atoi(value);
</a><a href="#h4-0-91" id="h4-0-91" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.enable-log-linecount&quot;))
</a><a href="#h4-0-92" id="h4-0-92" class="i">+		ctx.repo-&gt;enable_log_linecount = ctx.cfg.enable_log_linecount * atoi(value);
</a><a href="#h4-0-93" id="h4-0-93" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.module-link&quot;))
</a><a href="#h4-0-94" id="h4-0-94" class="i">+		ctx.repo-&gt;module_link= xstrdup(value);
</a><a href="#h4-0-95" id="h4-0-95" class="i">+	else if (ctx.repo &amp;&amp; !strcmp(name, &quot;repo.readme&quot;) &amp;&amp; value != NULL) {
</a><a href="#h4-0-96" id="h4-0-96" class="i">+		if (*value == &#39;/&#39;)
</a><a href="#h4-0-97" id="h4-0-97" class="i">+			ctx.repo-&gt;readme = xstrdup(value);
</a><a href="#h4-0-98" id="h4-0-98" class="i">+		else
</a><a href="#h4-0-99" id="h4-0-99" class="i">+			ctx.repo-&gt;readme = xstrdup(fmt(&quot;%s/%s&quot;, ctx.repo-&gt;path, value));
</a><a href="#h4-0-100" id="h4-0-100" class="i">+	} else if (!strcmp(name, &quot;include&quot;))
</a><a href="#h4-0-101" id="h4-0-101" class="i">+		parse_configfile(value, config_cb);
</a><a href="#h4-0-102" id="h4-0-102" class="i">+}
</a><a href="#h4-0-103" id="h4-0-103" class="i">+
</a><a href="#h4-0-104" id="h4-0-104" class="i">+static void querystring_cb(const char *name, const char *value)
</a><a href="#h4-0-105" id="h4-0-105" class="i">+{
</a><a href="#h4-0-106" id="h4-0-106" class="i">+	if (!strcmp(name,&quot;r&quot;)) {
</a><a href="#h4-0-107" id="h4-0-107" class="i">+		ctx.qry.repo = xstrdup(value);
</a><a href="#h4-0-108" id="h4-0-108" class="i">+		ctx.repo = cgit_get_repoinfo(value);
</a><a href="#h4-0-109" id="h4-0-109" class="i">+	} else if (!strcmp(name, &quot;p&quot;)) {
</a><a href="#h4-0-110" id="h4-0-110" class="i">+		ctx.qry.page = xstrdup(value);
</a><a href="#h4-0-111" id="h4-0-111" class="i">+	} else if (!strcmp(name, &quot;url&quot;)) {
</a><a href="#h4-0-112" id="h4-0-112" class="i">+		cgit_parse_url(value);
</a><a href="#h4-0-113" id="h4-0-113" class="i">+	} else if (!strcmp(name, &quot;qt&quot;)) {
</a><a href="#h4-0-114" id="h4-0-114" class="i">+		ctx.qry.grep = xstrdup(value);
</a><a href="#h4-0-115" id="h4-0-115" class="i">+	} else if (!strcmp(name, &quot;q&quot;)) {
</a><a href="#h4-0-116" id="h4-0-116" class="i">+		ctx.qry.search = xstrdup(value);
</a><a href="#h4-0-117" id="h4-0-117" class="i">+	} else if (!strcmp(name, &quot;h&quot;)) {
</a><a href="#h4-0-118" id="h4-0-118" class="i">+		ctx.qry.head = xstrdup(value);
</a><a href="#h4-0-119" id="h4-0-119" class="i">+		ctx.qry.has_symref = 1;
</a><a href="#h4-0-120" id="h4-0-120" class="i">+	} else if (!strcmp(name, &quot;id&quot;)) {
</a><a href="#h4-0-121" id="h4-0-121" class="i">+		ctx.qry.sha1 = xstrdup(value);
</a><a href="#h4-0-122" id="h4-0-122" class="i">+		ctx.qry.has_sha1 = 1;
</a><a href="#h4-0-123" id="h4-0-123" class="i">+	} else if (!strcmp(name, &quot;id2&quot;)) {
</a><a href="#h4-0-124" id="h4-0-124" class="i">+		ctx.qry.sha2 = xstrdup(value);
</a><a href="#h4-0-125" id="h4-0-125" class="i">+		ctx.qry.has_sha1 = 1;
</a><a href="#h4-0-126" id="h4-0-126" class="i">+	} else if (!strcmp(name, &quot;ofs&quot;)) {
</a><a href="#h4-0-127" id="h4-0-127" class="i">+		ctx.qry.ofs = atoi(value);
</a><a href="#h4-0-128" id="h4-0-128" class="i">+	} else if (!strcmp(name, &quot;path&quot;)) {
</a><a href="#h4-0-129" id="h4-0-129" class="i">+		ctx.qry.path = trim_end(value, &#39;/&#39;);
</a><a href="#h4-0-130" id="h4-0-130" class="i">+	} else if (!strcmp(name, &quot;name&quot;)) {
</a><a href="#h4-0-131" id="h4-0-131" class="i">+		ctx.qry.name = xstrdup(value);
</a><a href="#h4-0-132" id="h4-0-132" class="i">+	}
</a><a href="#h4-0-133" id="h4-0-133" class="i">+}
</a><a href="#h4-0-134" id="h4-0-134" class="i">+
</a><a href="#h4-0-135" id="h4-0-135" class="i">+static void prepare_context(struct cgit_context *ctx)
</a><a href="#h4-0-136" id="h4-0-136" class="i">+{
</a><a href="#h4-0-137" id="h4-0-137" class="i">+	memset(ctx, 0, sizeof(ctx));
</a><a href="#h4-0-138" id="h4-0-138" class="i">+	ctx-&gt;cfg.agefile = &quot;info/web/last-modified&quot;;
</a><a href="#h4-0-139" id="h4-0-139" class="i">+	ctx-&gt;cfg.cache_dynamic_ttl = 5;
</a><a href="#h4-0-140" id="h4-0-140" class="i">+	ctx-&gt;cfg.cache_max_create_time = 5;
</a><a href="#h4-0-141" id="h4-0-141" class="i">+	ctx-&gt;cfg.cache_repo_ttl = 5;
</a><a href="#h4-0-142" id="h4-0-142" class="i">+	ctx-&gt;cfg.cache_root = CGIT_CACHE_ROOT;
</a><a href="#h4-0-143" id="h4-0-143" class="i">+	ctx-&gt;cfg.cache_root_ttl = 5;
</a><a href="#h4-0-144" id="h4-0-144" class="i">+	ctx-&gt;cfg.cache_static_ttl = -1;
</a><a href="#h4-0-145" id="h4-0-145" class="i">+	ctx-&gt;cfg.css = &quot;/cgit.css&quot;;
</a><a href="#h4-0-146" id="h4-0-146" class="i">+	ctx-&gt;cfg.logo = &quot;/git-logo.png&quot;;
</a><a href="#h4-0-147" id="h4-0-147" class="i">+	ctx-&gt;cfg.max_commit_count = 50;
</a><a href="#h4-0-148" id="h4-0-148" class="i">+	ctx-&gt;cfg.max_lock_attempts = 5;
</a><a href="#h4-0-149" id="h4-0-149" class="i">+	ctx-&gt;cfg.max_msg_len = 60;
</a><a href="#h4-0-150" id="h4-0-150" class="i">+	ctx-&gt;cfg.max_repodesc_len = 60;
</a><a href="#h4-0-151" id="h4-0-151" class="i">+	ctx-&gt;cfg.module_link = &quot;./?repo=%s&amp;page=commit&amp;id=%s&quot;;
</a><a href="#h4-0-152" id="h4-0-152" class="i">+	ctx-&gt;cfg.renamelimit = -1;
</a><a href="#h4-0-153" id="h4-0-153" class="i">+	ctx-&gt;cfg.robots = &quot;index, nofollow&quot;;
</a><a href="#h4-0-154" id="h4-0-154" class="i">+	ctx-&gt;cfg.root_title = &quot;Git repository browser&quot;;
</a><a href="#h4-0-155" id="h4-0-155" class="i">+	ctx-&gt;cfg.script_name = CGIT_SCRIPT_NAME;
</a><a href="#h4-0-156" id="h4-0-156" class="i">+	ctx-&gt;page.mimetype = &quot;text/html&quot;;
</a><a href="#h4-0-157" id="h4-0-157" class="i">+	ctx-&gt;page.charset = PAGE_ENCODING;
</a><a href="#h4-0-158" id="h4-0-158" class="i">+	ctx-&gt;page.filename = NULL;
</a><a href="#h4-0-159" id="h4-0-159" class="i">+}
</a> 
 static int cgit_prepare_cache(struct cacheitem *item)
 {
<a href="#h4-0-163" id="h4-0-163" class="d">-	if (!cgit_repo &amp;&amp; cgit_query_repo) {
</a><a href="#h4-0-164" id="h4-0-164" class="d">-		char *title = fmt(&quot;%s - %s&quot;, cgit_root_title, &quot;Bad request&quot;);
</a><a href="#h4-0-165" id="h4-0-165" class="d">-		cgit_print_docstart(title, item);
</a><a href="#h4-0-166" id="h4-0-166" class="d">-		cgit_print_pageheader(title, 0);
</a><a href="#h4-0-167" id="h4-0-167" class="d">-		cgit_print_error(fmt(&quot;Unknown repo: %s&quot;, cgit_query_repo));
</a><a href="#h4-0-168" id="h4-0-168" class="i">+	if (!ctx.repo &amp;&amp; ctx.qry.repo) {
</a><a href="#h4-0-169" id="h4-0-169" class="i">+		ctx.page.title = fmt(&quot;%s - %s&quot;, ctx.cfg.root_title,
</a><a href="#h4-0-170" id="h4-0-170" class="i">+				      &quot;Bad request&quot;);
</a><a href="#h4-0-171" id="h4-0-171" class="i">+		cgit_print_http_headers(&amp;ctx);
</a><a href="#h4-0-172" id="h4-0-172" class="i">+		cgit_print_docstart(&amp;ctx);
</a><a href="#h4-0-173" id="h4-0-173" class="i">+		cgit_print_pageheader(&amp;ctx);
</a><a href="#h4-0-174" id="h4-0-174" class="i">+		cgit_print_error(fmt(&quot;Unknown repo: %s&quot;, ctx.qry.repo));
</a> 		cgit_print_docend();
 		return 0;
 	}
 
<a href="#h4-0-179" id="h4-0-179" class="d">-	if (!cgit_repo) {
</a><a href="#h4-0-180" id="h4-0-180" class="d">-		item-&gt;name = xstrdup(fmt(&quot;%s/index.html&quot;, cgit_cache_root));
</a><a href="#h4-0-181" id="h4-0-181" class="d">-		item-&gt;ttl = cgit_cache_root_ttl;
</a><a href="#h4-0-182" id="h4-0-182" class="i">+	if (!ctx.repo) {
</a><a href="#h4-0-183" id="h4-0-183" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/index.html&quot;, ctx.cfg.cache_root));
</a><a href="#h4-0-184" id="h4-0-184" class="i">+		item-&gt;ttl = ctx.cfg.cache_root_ttl;
</a> 		return 1;
 	}
 
<a href="#h4-0-188" id="h4-0-188" class="d">-	if (!cgit_cmd) {
</a><a href="#h4-0-189" id="h4-0-189" class="d">-		item-&gt;name = xstrdup(fmt(&quot;%s/%s/index.%s.html&quot;, cgit_cache_root,
</a><a href="#h4-0-190" id="h4-0-190" class="d">-					 cache_safe_filename(cgit_repo-&gt;url),
</a><a href="#h4-0-191" id="h4-0-191" class="d">-					 cache_safe_filename(cgit_querystring)));
</a><a href="#h4-0-192" id="h4-0-192" class="d">-		item-&gt;ttl = cgit_cache_repo_ttl;
</a><a href="#h4-0-193" id="h4-0-193" class="i">+	if (!ctx.qry.page) {
</a><a href="#h4-0-194" id="h4-0-194" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/%s/index.%s.html&quot;, ctx.cfg.cache_root,
</a><a href="#h4-0-195" id="h4-0-195" class="i">+					 cache_safe_filename(ctx.repo-&gt;url),
</a><a href="#h4-0-196" id="h4-0-196" class="i">+					 cache_safe_filename(ctx.qry.raw)));
</a><a href="#h4-0-197" id="h4-0-197" class="i">+		item-&gt;ttl = ctx.cfg.cache_repo_ttl;
</a> 	} else {
<a href="#h4-0-199" id="h4-0-199" class="d">-		item-&gt;name = xstrdup(fmt(&quot;%s/%s/%s/%s.html&quot;, cgit_cache_root,
</a><a href="#h4-0-200" id="h4-0-200" class="d">-					 cache_safe_filename(cgit_repo-&gt;url),
</a><a href="#h4-0-201" id="h4-0-201" class="d">-					 cgit_query_page,
</a><a href="#h4-0-202" id="h4-0-202" class="d">-					 cache_safe_filename(cgit_querystring)));
</a><a href="#h4-0-203" id="h4-0-203" class="d">-		if (cgit_query_has_symref)
</a><a href="#h4-0-204" id="h4-0-204" class="d">-			item-&gt;ttl = cgit_cache_dynamic_ttl;
</a><a href="#h4-0-205" id="h4-0-205" class="d">-		else if (cgit_query_has_sha1)
</a><a href="#h4-0-206" id="h4-0-206" class="d">-			item-&gt;ttl = cgit_cache_static_ttl;
</a><a href="#h4-0-207" id="h4-0-207" class="i">+		item-&gt;name = xstrdup(fmt(&quot;%s/%s/%s/%s.html&quot;, ctx.cfg.cache_root,
</a><a href="#h4-0-208" id="h4-0-208" class="i">+					 cache_safe_filename(ctx.repo-&gt;url),
</a><a href="#h4-0-209" id="h4-0-209" class="i">+					 ctx.qry.page,
</a><a href="#h4-0-210" id="h4-0-210" class="i">+					 cache_safe_filename(ctx.qry.raw)));
</a><a href="#h4-0-211" id="h4-0-211" class="i">+		if (ctx.qry.has_symref)
</a><a href="#h4-0-212" id="h4-0-212" class="i">+			item-&gt;ttl = ctx.cfg.cache_dynamic_ttl;
</a><a href="#h4-0-213" id="h4-0-213" class="i">+		else if (ctx.qry.has_sha1)
</a><a href="#h4-0-214" id="h4-0-214" class="i">+			item-&gt;ttl = ctx.cfg.cache_static_ttl;
</a> 		else
<a href="#h4-0-216" id="h4-0-216" class="d">-			item-&gt;ttl = cgit_cache_repo_ttl;
</a><a href="#h4-0-217" id="h4-0-217" class="i">+			item-&gt;ttl = ctx.cfg.cache_repo_ttl;
</a> 	}
 	return 1;
 }
<a href="#h4-1" id="h4-1" class="h">@@ -64,7 +223,7 @@ int find_current_ref(const char *refname, const unsigned char *sha1,
</a> 	return info-&gt;match;
 }
 
<a href="#h4-1-3" id="h4-1-3" class="d">-char *find_default_branch(struct repoinfo *repo)
</a><a href="#h4-1-4" id="h4-1-4" class="i">+char *find_default_branch(struct cgit_repo *repo)
</a> {
 	struct refmatch info;
 
<a href="#h4-2" id="h4-2" class="h">@@ -78,113 +237,98 @@ char *find_default_branch(struct repoinfo *repo)
</a> 		return info.first_ref;
 }
 
<a href="#h4-2-3" id="h4-2-3" class="d">-static void cgit_print_repo_page(struct cacheitem *item)
</a><a href="#h4-2-4" id="h4-2-4" class="i">+static int prepare_repo_cmd(struct cgit_context *ctx)
</a> {
<a href="#h4-2-6" id="h4-2-6" class="d">-	char *title, *tmp;
</a><a href="#h4-2-7" id="h4-2-7" class="d">-	int show_search;
</a><a href="#h4-2-8" id="h4-2-8" class="i">+	char *tmp;
</a> 	unsigned char sha1[20];
<a href="#h4-2-10" id="h4-2-10" class="d">-
</a><a href="#h4-2-11" id="h4-2-11" class="d">-	if (chdir(cgit_repo-&gt;path)) {
</a><a href="#h4-2-12" id="h4-2-12" class="d">-		title = fmt(&quot;%s - %s&quot;, cgit_root_title, &quot;Bad request&quot;);
</a><a href="#h4-2-13" id="h4-2-13" class="d">-		cgit_print_docstart(title, item);
</a><a href="#h4-2-14" id="h4-2-14" class="d">-		cgit_print_pageheader(title, 0);
</a><a href="#h4-2-15" id="h4-2-15" class="d">-		cgit_print_error(fmt(&quot;Unable to scan repository: %s&quot;,
</a><a href="#h4-2-16" id="h4-2-16" class="d">-				     strerror(errno)));
</a><a href="#h4-2-17" id="h4-2-17" class="i">+	int nongit = 0;
</a><a href="#h4-2-18" id="h4-2-18" class="i">+
</a><a href="#h4-2-19" id="h4-2-19" class="i">+	setenv(&quot;GIT_DIR&quot;, ctx-&gt;repo-&gt;path, 1);
</a><a href="#h4-2-20" id="h4-2-20" class="i">+	setup_git_directory_gently(&amp;nongit);
</a><a href="#h4-2-21" id="h4-2-21" class="i">+	if (nongit) {
</a><a href="#h4-2-22" id="h4-2-22" class="i">+		ctx-&gt;page.title = fmt(&quot;%s - %s&quot;, ctx-&gt;cfg.root_title,
</a><a href="#h4-2-23" id="h4-2-23" class="i">+				      &quot;config error&quot;);
</a><a href="#h4-2-24" id="h4-2-24" class="i">+		tmp = fmt(&quot;Not a git repository: &#39;%s&#39;&quot;, ctx-&gt;repo-&gt;path);
</a><a href="#h4-2-25" id="h4-2-25" class="i">+		ctx-&gt;repo = NULL;
</a><a href="#h4-2-26" id="h4-2-26" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h4-2-27" id="h4-2-27" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h4-2-28" id="h4-2-28" class="i">+		cgit_print_pageheader(ctx);
</a><a href="#h4-2-29" id="h4-2-29" class="i">+		cgit_print_error(tmp);
</a> 		cgit_print_docend();
<a href="#h4-2-31" id="h4-2-31" class="d">-		return;
</a><a href="#h4-2-32" id="h4-2-32" class="i">+		return 1;
</a> 	}
<a href="#h4-2-34" id="h4-2-34" class="i">+	ctx-&gt;page.title = fmt(&quot;%s - %s&quot;, ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;desc);
</a> 
<a href="#h4-2-36" id="h4-2-36" class="d">-	title = fmt(&quot;%s - %s&quot;, cgit_repo-&gt;name, cgit_repo-&gt;desc);
</a><a href="#h4-2-37" id="h4-2-37" class="d">-	show_search = 0;
</a><a href="#h4-2-38" id="h4-2-38" class="d">-	setenv(&quot;GIT_DIR&quot;, cgit_repo-&gt;path, 1);
</a><a href="#h4-2-39" id="h4-2-39" class="d">-
</a><a href="#h4-2-40" id="h4-2-40" class="d">-	if (!cgit_query_head) {
</a><a href="#h4-2-41" id="h4-2-41" class="d">-		cgit_query_head = xstrdup(find_default_branch(cgit_repo));
</a><a href="#h4-2-42" id="h4-2-42" class="d">-		cgit_repo-&gt;defbranch = cgit_query_head;
</a><a href="#h4-2-43" id="h4-2-43" class="i">+	if (!ctx-&gt;qry.head) {
</a><a href="#h4-2-44" id="h4-2-44" class="i">+		ctx-&gt;qry.head = xstrdup(find_default_branch(ctx-&gt;repo));
</a><a href="#h4-2-45" id="h4-2-45" class="i">+		ctx-&gt;repo-&gt;defbranch = ctx-&gt;qry.head;
</a> 	}
 
<a href="#h4-2-48" id="h4-2-48" class="d">-	if (!cgit_query_head) {
</a><a href="#h4-2-49" id="h4-2-49" class="d">-		cgit_print_docstart(title, item);
</a><a href="#h4-2-50" id="h4-2-50" class="d">-		cgit_print_pageheader(title, 0);
</a><a href="#h4-2-51" id="h4-2-51" class="i">+	if (!ctx-&gt;qry.head) {
</a><a href="#h4-2-52" id="h4-2-52" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h4-2-53" id="h4-2-53" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h4-2-54" id="h4-2-54" class="i">+		cgit_print_pageheader(ctx);
</a> 		cgit_print_error(&quot;Repository seems to be empty&quot;);
 		cgit_print_docend();
<a href="#h4-2-57" id="h4-2-57" class="d">-		return;
</a><a href="#h4-2-58" id="h4-2-58" class="i">+		return 1;
</a> 	}
 
<a href="#h4-2-61" id="h4-2-61" class="d">-	if (get_sha1(cgit_query_head, sha1)) {
</a><a href="#h4-2-62" id="h4-2-62" class="d">-		tmp = xstrdup(cgit_query_head);
</a><a href="#h4-2-63" id="h4-2-63" class="d">-		cgit_query_head = cgit_repo-&gt;defbranch;
</a><a href="#h4-2-64" id="h4-2-64" class="d">-		cgit_print_docstart(title, item);
</a><a href="#h4-2-65" id="h4-2-65" class="d">-		cgit_print_pageheader(title, 0);
</a><a href="#h4-2-66" id="h4-2-66" class="i">+	if (get_sha1(ctx-&gt;qry.head, sha1)) {
</a><a href="#h4-2-67" id="h4-2-67" class="i">+		tmp = xstrdup(ctx-&gt;qry.head);
</a><a href="#h4-2-68" id="h4-2-68" class="i">+		ctx-&gt;qry.head = ctx-&gt;repo-&gt;defbranch;
</a><a href="#h4-2-69" id="h4-2-69" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h4-2-70" id="h4-2-70" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h4-2-71" id="h4-2-71" class="i">+		cgit_print_pageheader(ctx);
</a> 		cgit_print_error(fmt(&quot;Invalid branch: %s&quot;, tmp));
 		cgit_print_docend();
<a href="#h4-2-74" id="h4-2-74" class="d">-		return;
</a><a href="#h4-2-75" id="h4-2-75" class="i">+		return 1;
</a> 	}
<a href="#h4-2-77" id="h4-2-77" class="i">+	return 0;
</a><a href="#h4-2-78" id="h4-2-78" class="i">+}
</a> 
<a href="#h4-2-80" id="h4-2-80" class="d">-	if ((cgit_cmd == CMD_SNAPSHOT) &amp;&amp; cgit_repo-&gt;snapshots) {
</a><a href="#h4-2-81" id="h4-2-81" class="d">-		cgit_print_snapshot(item, cgit_query_head, cgit_query_sha1,
</a><a href="#h4-2-82" id="h4-2-82" class="d">-				    cgit_repobasename(cgit_repo-&gt;url),
</a><a href="#h4-2-83" id="h4-2-83" class="d">-				    cgit_query_path,
</a><a href="#h4-2-84" id="h4-2-84" class="d">-				    cgit_repo-&gt;snapshots );
</a><a href="#h4-2-85" id="h4-2-85" class="i">+static void process_request(struct cgit_context *ctx)
</a><a href="#h4-2-86" id="h4-2-86" class="i">+{
</a><a href="#h4-2-87" id="h4-2-87" class="i">+	struct cgit_cmd *cmd;
</a><a href="#h4-2-88" id="h4-2-88" class="i">+
</a><a href="#h4-2-89" id="h4-2-89" class="i">+	cmd = cgit_get_cmd(ctx);
</a><a href="#h4-2-90" id="h4-2-90" class="i">+	if (!cmd) {
</a><a href="#h4-2-91" id="h4-2-91" class="i">+		ctx-&gt;page.title = &quot;cgit error&quot;;
</a><a href="#h4-2-92" id="h4-2-92" class="i">+		ctx-&gt;repo = NULL;
</a><a href="#h4-2-93" id="h4-2-93" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h4-2-94" id="h4-2-94" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h4-2-95" id="h4-2-95" class="i">+		cgit_print_pageheader(ctx);
</a><a href="#h4-2-96" id="h4-2-96" class="i">+		cgit_print_error(&quot;Invalid request&quot;);
</a><a href="#h4-2-97" id="h4-2-97" class="i">+		cgit_print_docend();
</a> 		return;
 	}
 
<a href="#h4-2-101" id="h4-2-101" class="d">-	if (cgit_cmd == CMD_PATCH) {
</a><a href="#h4-2-102" id="h4-2-102" class="d">-		cgit_print_patch(cgit_query_sha1, item);
</a><a href="#h4-2-103" id="h4-2-103" class="i">+	if (cmd-&gt;want_repo &amp;&amp; prepare_repo_cmd(ctx))
</a> 		return;
<a href="#h4-2-105" id="h4-2-105" class="d">-	}
</a> 
<a href="#h4-2-107" id="h4-2-107" class="d">-	if (cgit_cmd == CMD_BLOB) {
</a><a href="#h4-2-108" id="h4-2-108" class="d">-		cgit_print_blob(item, cgit_query_sha1, cgit_query_path);
</a><a href="#h4-2-109" id="h4-2-109" class="d">-		return;
</a><a href="#h4-2-110" id="h4-2-110" class="i">+	if (cmd-&gt;want_layout) {
</a><a href="#h4-2-111" id="h4-2-111" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h4-2-112" id="h4-2-112" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h4-2-113" id="h4-2-113" class="i">+		cgit_print_pageheader(ctx);
</a> 	}
 
<a href="#h4-2-116" id="h4-2-116" class="d">-	show_search = (cgit_cmd == CMD_LOG);
</a><a href="#h4-2-117" id="h4-2-117" class="d">-	cgit_print_docstart(title, item);
</a><a href="#h4-2-118" id="h4-2-118" class="d">-	if (!cgit_cmd) {
</a><a href="#h4-2-119" id="h4-2-119" class="d">-		cgit_print_pageheader(&quot;summary&quot;, show_search);
</a><a href="#h4-2-120" id="h4-2-120" class="d">-		cgit_print_summary();
</a><a href="#h4-2-121" id="h4-2-121" class="i">+	cmd-&gt;fn(ctx);
</a><a href="#h4-2-122" id="h4-2-122" class="i">+
</a><a href="#h4-2-123" id="h4-2-123" class="i">+	if (cmd-&gt;want_layout)
</a> 		cgit_print_docend();
<a href="#h4-2-125" id="h4-2-125" class="d">-		return;
</a><a href="#h4-2-126" id="h4-2-126" class="d">-	}
</a><a href="#h4-2-127" id="h4-2-127" class="i">+}
</a> 
<a href="#h4-2-129" id="h4-2-129" class="d">-	cgit_print_pageheader(cgit_query_page, show_search);
</a><a href="#h4-2-130" id="h4-2-130" class="d">-
</a><a href="#h4-2-131" id="h4-2-131" class="d">-	switch(cgit_cmd) {
</a><a href="#h4-2-132" id="h4-2-132" class="d">-	case CMD_LOG:
</a><a href="#h4-2-133" id="h4-2-133" class="d">-		cgit_print_log(cgit_query_sha1, cgit_query_ofs,
</a><a href="#h4-2-134" id="h4-2-134" class="d">-			       cgit_max_commit_count, cgit_query_grep, cgit_query_search,
</a><a href="#h4-2-135" id="h4-2-135" class="d">-			       cgit_query_path, 1);
</a><a href="#h4-2-136" id="h4-2-136" class="d">-		break;
</a><a href="#h4-2-137" id="h4-2-137" class="d">-	case CMD_TREE:
</a><a href="#h4-2-138" id="h4-2-138" class="d">-		cgit_print_tree(cgit_query_sha1, cgit_query_path);
</a><a href="#h4-2-139" id="h4-2-139" class="d">-		break;
</a><a href="#h4-2-140" id="h4-2-140" class="d">-	case CMD_COMMIT:
</a><a href="#h4-2-141" id="h4-2-141" class="d">-		cgit_print_commit(cgit_query_sha1);
</a><a href="#h4-2-142" id="h4-2-142" class="d">-		break;
</a><a href="#h4-2-143" id="h4-2-143" class="d">-	case CMD_REFS:
</a><a href="#h4-2-144" id="h4-2-144" class="d">-		cgit_print_refs();
</a><a href="#h4-2-145" id="h4-2-145" class="d">-		break;
</a><a href="#h4-2-146" id="h4-2-146" class="d">-	case CMD_TAG:
</a><a href="#h4-2-147" id="h4-2-147" class="d">-		cgit_print_tag(cgit_query_sha1);
</a><a href="#h4-2-148" id="h4-2-148" class="d">-		break;
</a><a href="#h4-2-149" id="h4-2-149" class="d">-	case CMD_DIFF:
</a><a href="#h4-2-150" id="h4-2-150" class="d">-		cgit_print_diff(cgit_query_sha1, cgit_query_sha2, cgit_query_path);
</a><a href="#h4-2-151" id="h4-2-151" class="d">-		break;
</a><a href="#h4-2-152" id="h4-2-152" class="d">-	default:
</a><a href="#h4-2-153" id="h4-2-153" class="d">-		cgit_print_error(&quot;Invalid request&quot;);
</a><a href="#h4-2-154" id="h4-2-154" class="d">-	}
</a><a href="#h4-2-155" id="h4-2-155" class="d">-	cgit_print_docend();
</a><a href="#h4-2-156" id="h4-2-156" class="i">+static long ttl_seconds(long ttl)
</a><a href="#h4-2-157" id="h4-2-157" class="i">+{
</a><a href="#h4-2-158" id="h4-2-158" class="i">+	if (ttl&lt;0)
</a><a href="#h4-2-159" id="h4-2-159" class="i">+		return 60 * 60 * 24 * 365;
</a><a href="#h4-2-160" id="h4-2-160" class="i">+	else
</a><a href="#h4-2-161" id="h4-2-161" class="i">+		return ttl * 60;
</a> }
 
 static void cgit_fill_cache(struct cacheitem *item, int use_cache)
 {
<a href="#h4-2-166" id="h4-2-166" class="d">-	static char buf[PATH_MAX];
</a> 	int stdout2;
 
<a href="#h4-2-169" id="h4-2-169" class="d">-	getcwd(buf, sizeof(buf));
</a><a href="#h4-2-170" id="h4-2-170" class="d">-	item-&gt;st.st_mtime = time(NULL);
</a><a href="#h4-2-171" id="h4-2-171" class="d">-
</a> 	if (use_cache) {
 		stdout2 = chk_positive(dup(STDOUT_FILENO),
 				       &quot;Preserving STDOUT&quot;);
<a href="#h4-3" id="h4-3" class="h">@@ -192,10 +336,9 @@ static void cgit_fill_cache(struct cacheitem *item, int use_cache)
</a> 		chk_positive(dup2(item-&gt;fd, STDOUT_FILENO), &quot;Dup2(cachefile)&quot;);
 	}
 
<a href="#h4-3-3" id="h4-3-3" class="d">-	if (cgit_repo)
</a><a href="#h4-3-4" id="h4-3-4" class="d">-		cgit_print_repo_page(item);
</a><a href="#h4-3-5" id="h4-3-5" class="d">-	else
</a><a href="#h4-3-6" id="h4-3-6" class="d">-		cgit_print_repolist(item);
</a><a href="#h4-3-7" id="h4-3-7" class="i">+	ctx.page.modified = time(NULL);
</a><a href="#h4-3-8" id="h4-3-8" class="i">+	ctx.page.expires = ctx.page.modified + ttl_seconds(item-&gt;ttl);
</a><a href="#h4-3-9" id="h4-3-9" class="i">+	process_request(&amp;ctx);
</a> 
 	if (use_cache) {
 		chk_zero(close(STDOUT_FILENO), &quot;Close redirected STDOUT&quot;);
<a href="#h4-4" id="h4-4" class="h">@@ -203,8 +346,6 @@ static void cgit_fill_cache(struct cacheitem *item, int use_cache)
</a> 			     &quot;Restoring original STDOUT&quot;);
 		chk_zero(close(stdout2), &quot;Closing temporary STDOUT&quot;);
 	}
<a href="#h4-4-3" id="h4-4-3" class="d">-
</a><a href="#h4-4-4" id="h4-4-4" class="d">-	chdir(buf);
</a> }
 
 static void cgit_check_cache(struct cacheitem *item)
<a href="#h4-5" id="h4-5" class="h">@@ -212,7 +353,7 @@ static void cgit_check_cache(struct cacheitem *item)
</a> 	int i = 0;
 
  top:
<a href="#h4-5-3" id="h4-5-3" class="d">-	if (++i &gt; cgit_max_lock_attempts) {
</a><a href="#h4-5-4" id="h4-5-4" class="i">+	if (++i &gt; ctx.cfg.max_lock_attempts) {
</a> 		die(&quot;cgit_refresh_cache: unable to lock %s: %s&quot;,
 		    item-&gt;name, strerror(errno));
 	}
<a href="#h4-6" id="h4-6" class="h">@@ -258,30 +399,30 @@ static void cgit_parse_args(int argc, const char **argv)
</a> 
 	for (i = 1; i &lt; argc; i++) {
 		if (!strncmp(argv[i], &quot;--cache=&quot;, 8)) {
<a href="#h4-6-3" id="h4-6-3" class="d">-			cgit_cache_root = xstrdup(argv[i]+8);
</a><a href="#h4-6-4" id="h4-6-4" class="i">+			ctx.cfg.cache_root = xstrdup(argv[i]+8);
</a> 		}
 		if (!strcmp(argv[i], &quot;--nocache&quot;)) {
<a href="#h4-6-7" id="h4-6-7" class="d">-			cgit_nocache = 1;
</a><a href="#h4-6-8" id="h4-6-8" class="i">+			ctx.cfg.nocache = 1;
</a> 		}
 		if (!strncmp(argv[i], &quot;--query=&quot;, 8)) {
<a href="#h4-6-11" id="h4-6-11" class="d">-			cgit_querystring = xstrdup(argv[i]+8);
</a><a href="#h4-6-12" id="h4-6-12" class="i">+			ctx.qry.raw = xstrdup(argv[i]+8);
</a> 		}
 		if (!strncmp(argv[i], &quot;--repo=&quot;, 7)) {
<a href="#h4-6-15" id="h4-6-15" class="d">-			cgit_query_repo = xstrdup(argv[i]+7);
</a><a href="#h4-6-16" id="h4-6-16" class="i">+			ctx.qry.repo = xstrdup(argv[i]+7);
</a> 		}
 		if (!strncmp(argv[i], &quot;--page=&quot;, 7)) {
<a href="#h4-6-19" id="h4-6-19" class="d">-			cgit_query_page = xstrdup(argv[i]+7);
</a><a href="#h4-6-20" id="h4-6-20" class="i">+			ctx.qry.page = xstrdup(argv[i]+7);
</a> 		}
 		if (!strncmp(argv[i], &quot;--head=&quot;, 7)) {
<a href="#h4-6-23" id="h4-6-23" class="d">-			cgit_query_head = xstrdup(argv[i]+7);
</a><a href="#h4-6-24" id="h4-6-24" class="d">-			cgit_query_has_symref = 1;
</a><a href="#h4-6-25" id="h4-6-25" class="i">+			ctx.qry.head = xstrdup(argv[i]+7);
</a><a href="#h4-6-26" id="h4-6-26" class="i">+			ctx.qry.has_symref = 1;
</a> 		}
 		if (!strncmp(argv[i], &quot;--sha1=&quot;, 7)) {
<a href="#h4-6-29" id="h4-6-29" class="d">-			cgit_query_sha1 = xstrdup(argv[i]+7);
</a><a href="#h4-6-30" id="h4-6-30" class="d">-			cgit_query_has_sha1 = 1;
</a><a href="#h4-6-31" id="h4-6-31" class="i">+			ctx.qry.sha1 = xstrdup(argv[i]+7);
</a><a href="#h4-6-32" id="h4-6-32" class="i">+			ctx.qry.has_sha1 = 1;
</a> 		}
 		if (!strncmp(argv[i], &quot;--ofs=&quot;, 6)) {
<a href="#h4-6-35" id="h4-6-35" class="d">-			cgit_query_ofs = atoi(argv[i]+6);
</a><a href="#h4-6-36" id="h4-6-36" class="i">+			ctx.qry.ofs = atoi(argv[i]+6);
</a> 		}
 	}
 }
<a href="#h4-7" id="h4-7" class="h">@@ -291,24 +432,24 @@ int main(int argc, const char **argv)
</a> 	struct cacheitem item;
 	const char *cgit_config_env = getenv(&quot;CGIT_CONFIG&quot;);
 
<a href="#h4-7-3" id="h4-7-3" class="d">-	htmlfd = STDOUT_FILENO;
</a><a href="#h4-7-4" id="h4-7-4" class="i">+	prepare_context(&amp;ctx);
</a> 	item.st.st_mtime = time(NULL);
 	cgit_repolist.length = 0;
 	cgit_repolist.count = 0;
 	cgit_repolist.repos = NULL;
 
<a href="#h4-7-10" id="h4-7-10" class="d">-	cgit_read_config(cgit_config_env ? cgit_config_env : CGIT_CONFIG,
</a><a href="#h4-7-11" id="h4-7-11" class="d">-			 cgit_global_config_cb);
</a><a href="#h4-7-12" id="h4-7-12" class="d">-	cgit_repo = NULL;
</a><a href="#h4-7-13" id="h4-7-13" class="i">+	parse_configfile(cgit_config_env ? cgit_config_env : CGIT_CONFIG,
</a><a href="#h4-7-14" id="h4-7-14" class="i">+			 config_cb);
</a><a href="#h4-7-15" id="h4-7-15" class="i">+	ctx.repo = NULL;
</a> 	if (getenv(&quot;SCRIPT_NAME&quot;))
<a href="#h4-7-17" id="h4-7-17" class="d">-		cgit_script_name = xstrdup(getenv(&quot;SCRIPT_NAME&quot;));
</a><a href="#h4-7-18" id="h4-7-18" class="i">+		ctx.cfg.script_name = xstrdup(getenv(&quot;SCRIPT_NAME&quot;));
</a> 	if (getenv(&quot;QUERY_STRING&quot;))
<a href="#h4-7-20" id="h4-7-20" class="d">-		cgit_querystring = xstrdup(getenv(&quot;QUERY_STRING&quot;));
</a><a href="#h4-7-21" id="h4-7-21" class="i">+		ctx.qry.raw = xstrdup(getenv(&quot;QUERY_STRING&quot;));
</a> 	cgit_parse_args(argc, argv);
<a href="#h4-7-23" id="h4-7-23" class="d">-	cgit_parse_query(cgit_querystring, cgit_querystring_cb);
</a><a href="#h4-7-24" id="h4-7-24" class="i">+	http_parse_querystring(ctx.qry.raw, querystring_cb);
</a> 	if (!cgit_prepare_cache(&amp;item))
 		return 0;
<a href="#h4-7-27" id="h4-7-27" class="d">-	if (cgit_nocache) {
</a><a href="#h4-7-28" id="h4-7-28" class="i">+	if (ctx.cfg.nocache) {
</a> 		cgit_fill_cache(&amp;item, 0);
 	} else {
 		cgit_check_cache(&amp;item);
<b>diff --git a/<a id="h5" href="../file/cgit.h.html">cgit.h</a> b/<a href="../file/cgit.h.html">cgit.h</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -20,19 +20,6 @@
</a> 
 
 /*
<a href="#h5-0-3" id="h5-0-3" class="d">- * The valid cgit repo-commands
</a><a href="#h5-0-4" id="h5-0-4" class="d">- */
</a><a href="#h5-0-5" id="h5-0-5" class="d">-#define CMD_LOG      1
</a><a href="#h5-0-6" id="h5-0-6" class="d">-#define CMD_COMMIT   2
</a><a href="#h5-0-7" id="h5-0-7" class="d">-#define CMD_DIFF     3
</a><a href="#h5-0-8" id="h5-0-8" class="d">-#define CMD_TREE     4
</a><a href="#h5-0-9" id="h5-0-9" class="d">-#define CMD_BLOB     5
</a><a href="#h5-0-10" id="h5-0-10" class="d">-#define CMD_SNAPSHOT 6
</a><a href="#h5-0-11" id="h5-0-11" class="d">-#define CMD_TAG      7
</a><a href="#h5-0-12" id="h5-0-12" class="d">-#define CMD_REFS     8
</a><a href="#h5-0-13" id="h5-0-13" class="d">-#define CMD_PATCH    9
</a><a href="#h5-0-14" id="h5-0-14" class="d">-
</a><a href="#h5-0-15" id="h5-0-15" class="d">-/*
</a>  * Dateformats used on misc. pages
  */
 #define FMT_LONGDATE &quot;%Y-%m-%d %H:%M:%S&quot;
<a href="#h5-1" id="h5-1" class="h">@@ -59,14 +46,7 @@ typedef void (*configfn)(const char *name, const char *value);
</a> typedef void (*filepair_fn)(struct diff_filepair *pair);
 typedef void (*linediff_fn)(char *line, int len);
 
<a href="#h5-1-3" id="h5-1-3" class="d">-struct cacheitem {
</a><a href="#h5-1-4" id="h5-1-4" class="d">-	char *name;
</a><a href="#h5-1-5" id="h5-1-5" class="d">-	struct stat st;
</a><a href="#h5-1-6" id="h5-1-6" class="d">-	int ttl;
</a><a href="#h5-1-7" id="h5-1-7" class="d">-	int fd;
</a><a href="#h5-1-8" id="h5-1-8" class="d">-};
</a><a href="#h5-1-9" id="h5-1-9" class="d">-
</a><a href="#h5-1-10" id="h5-1-10" class="d">-struct repoinfo {
</a><a href="#h5-1-11" id="h5-1-11" class="i">+struct cgit_repo {
</a> 	char *url;
 	char *name;
 	char *path;
<a href="#h5-2" id="h5-2" class="h">@@ -82,10 +62,10 @@ struct repoinfo {
</a> 	int enable_log_linecount;
 };
 
<a href="#h5-2-3" id="h5-2-3" class="d">-struct repolist {
</a><a href="#h5-2-4" id="h5-2-4" class="i">+struct cgit_repolist {
</a> 	int length;
 	int count;
<a href="#h5-2-7" id="h5-2-7" class="d">-	struct repoinfo *repos;
</a><a href="#h5-2-8" id="h5-2-8" class="i">+	struct cgit_repo *repos;
</a> };
 
 struct commitinfo {
<a href="#h5-3" id="h5-3" class="h">@@ -123,74 +103,94 @@ struct reflist {
</a> 	int count;
 };
 
<a href="#h5-3-3" id="h5-3-3" class="i">+struct cgit_query {
</a><a href="#h5-3-4" id="h5-3-4" class="i">+	int has_symref;
</a><a href="#h5-3-5" id="h5-3-5" class="i">+	int has_sha1;
</a><a href="#h5-3-6" id="h5-3-6" class="i">+	char *raw;
</a><a href="#h5-3-7" id="h5-3-7" class="i">+	char *repo;
</a><a href="#h5-3-8" id="h5-3-8" class="i">+	char *page;
</a><a href="#h5-3-9" id="h5-3-9" class="i">+	char *search;
</a><a href="#h5-3-10" id="h5-3-10" class="i">+	char *grep;
</a><a href="#h5-3-11" id="h5-3-11" class="i">+	char *head;
</a><a href="#h5-3-12" id="h5-3-12" class="i">+	char *sha1;
</a><a href="#h5-3-13" id="h5-3-13" class="i">+	char *sha2;
</a><a href="#h5-3-14" id="h5-3-14" class="i">+	char *path;
</a><a href="#h5-3-15" id="h5-3-15" class="i">+	char *name;
</a><a href="#h5-3-16" id="h5-3-16" class="i">+	int   ofs;
</a><a href="#h5-3-17" id="h5-3-17" class="i">+};
</a><a href="#h5-3-18" id="h5-3-18" class="i">+
</a><a href="#h5-3-19" id="h5-3-19" class="i">+struct cgit_config {
</a><a href="#h5-3-20" id="h5-3-20" class="i">+	char *agefile;
</a><a href="#h5-3-21" id="h5-3-21" class="i">+	char *cache_root;
</a><a href="#h5-3-22" id="h5-3-22" class="i">+	char *clone_prefix;
</a><a href="#h5-3-23" id="h5-3-23" class="i">+	char *css;
</a><a href="#h5-3-24" id="h5-3-24" class="i">+	char *index_header;
</a><a href="#h5-3-25" id="h5-3-25" class="i">+	char *index_info;
</a><a href="#h5-3-26" id="h5-3-26" class="i">+	char *logo;
</a><a href="#h5-3-27" id="h5-3-27" class="i">+	char *logo_link;
</a><a href="#h5-3-28" id="h5-3-28" class="i">+	char *module_link;
</a><a href="#h5-3-29" id="h5-3-29" class="i">+	char *repo_group;
</a><a href="#h5-3-30" id="h5-3-30" class="i">+	char *robots;
</a><a href="#h5-3-31" id="h5-3-31" class="i">+	char *root_title;
</a><a href="#h5-3-32" id="h5-3-32" class="i">+	char *script_name;
</a><a href="#h5-3-33" id="h5-3-33" class="i">+	char *virtual_root;
</a><a href="#h5-3-34" id="h5-3-34" class="i">+	int cache_dynamic_ttl;
</a><a href="#h5-3-35" id="h5-3-35" class="i">+	int cache_max_create_time;
</a><a href="#h5-3-36" id="h5-3-36" class="i">+	int cache_repo_ttl;
</a><a href="#h5-3-37" id="h5-3-37" class="i">+	int cache_root_ttl;
</a><a href="#h5-3-38" id="h5-3-38" class="i">+	int cache_static_ttl;
</a><a href="#h5-3-39" id="h5-3-39" class="i">+	int enable_index_links;
</a><a href="#h5-3-40" id="h5-3-40" class="i">+	int enable_log_filecount;
</a><a href="#h5-3-41" id="h5-3-41" class="i">+	int enable_log_linecount;
</a><a href="#h5-3-42" id="h5-3-42" class="i">+	int max_commit_count;
</a><a href="#h5-3-43" id="h5-3-43" class="i">+	int max_lock_attempts;
</a><a href="#h5-3-44" id="h5-3-44" class="i">+	int max_msg_len;
</a><a href="#h5-3-45" id="h5-3-45" class="i">+	int max_repodesc_len;
</a><a href="#h5-3-46" id="h5-3-46" class="i">+	int nocache;
</a><a href="#h5-3-47" id="h5-3-47" class="i">+	int renamelimit;
</a><a href="#h5-3-48" id="h5-3-48" class="i">+	int snapshots;
</a><a href="#h5-3-49" id="h5-3-49" class="i">+	int summary_branches;
</a><a href="#h5-3-50" id="h5-3-50" class="i">+	int summary_log;
</a><a href="#h5-3-51" id="h5-3-51" class="i">+	int summary_tags;
</a><a href="#h5-3-52" id="h5-3-52" class="i">+};
</a><a href="#h5-3-53" id="h5-3-53" class="i">+
</a><a href="#h5-3-54" id="h5-3-54" class="i">+struct cgit_page {
</a><a href="#h5-3-55" id="h5-3-55" class="i">+	time_t modified;
</a><a href="#h5-3-56" id="h5-3-56" class="i">+	time_t expires;
</a><a href="#h5-3-57" id="h5-3-57" class="i">+	char *mimetype;
</a><a href="#h5-3-58" id="h5-3-58" class="i">+	char *charset;
</a><a href="#h5-3-59" id="h5-3-59" class="i">+	char *filename;
</a><a href="#h5-3-60" id="h5-3-60" class="i">+	char *title;
</a><a href="#h5-3-61" id="h5-3-61" class="i">+};
</a><a href="#h5-3-62" id="h5-3-62" class="i">+
</a><a href="#h5-3-63" id="h5-3-63" class="i">+struct cgit_context {
</a><a href="#h5-3-64" id="h5-3-64" class="i">+	struct cgit_query qry;
</a><a href="#h5-3-65" id="h5-3-65" class="i">+	struct cgit_config cfg;
</a><a href="#h5-3-66" id="h5-3-66" class="i">+	struct cgit_repo *repo;
</a><a href="#h5-3-67" id="h5-3-67" class="i">+	struct cgit_page page;
</a><a href="#h5-3-68" id="h5-3-68" class="i">+};
</a><a href="#h5-3-69" id="h5-3-69" class="i">+
</a><a href="#h5-3-70" id="h5-3-70" class="i">+struct cgit_snapshot_format {
</a><a href="#h5-3-71" id="h5-3-71" class="i">+	const char *suffix;
</a><a href="#h5-3-72" id="h5-3-72" class="i">+	const char *mimetype;
</a><a href="#h5-3-73" id="h5-3-73" class="i">+	write_archive_fn_t write_func;
</a><a href="#h5-3-74" id="h5-3-74" class="i">+	int bit;
</a><a href="#h5-3-75" id="h5-3-75" class="i">+};
</a><a href="#h5-3-76" id="h5-3-76" class="i">+
</a> extern const char *cgit_version;
 
<a href="#h5-3-79" id="h5-3-79" class="d">-extern struct repolist cgit_repolist;
</a><a href="#h5-3-80" id="h5-3-80" class="d">-extern struct repoinfo *cgit_repo;
</a><a href="#h5-3-81" id="h5-3-81" class="d">-extern int cgit_cmd;
</a><a href="#h5-3-82" id="h5-3-82" class="d">-
</a><a href="#h5-3-83" id="h5-3-83" class="d">-extern char *cgit_root_title;
</a><a href="#h5-3-84" id="h5-3-84" class="d">-extern char *cgit_css;
</a><a href="#h5-3-85" id="h5-3-85" class="d">-extern char *cgit_logo;
</a><a href="#h5-3-86" id="h5-3-86" class="d">-extern char *cgit_index_header;
</a><a href="#h5-3-87" id="h5-3-87" class="d">-extern char *cgit_index_info;
</a><a href="#h5-3-88" id="h5-3-88" class="d">-extern char *cgit_logo_link;
</a><a href="#h5-3-89" id="h5-3-89" class="d">-extern char *cgit_module_link;
</a><a href="#h5-3-90" id="h5-3-90" class="d">-extern char *cgit_agefile;
</a><a href="#h5-3-91" id="h5-3-91" class="d">-extern char *cgit_virtual_root;
</a><a href="#h5-3-92" id="h5-3-92" class="d">-extern char *cgit_script_name;
</a><a href="#h5-3-93" id="h5-3-93" class="d">-extern char *cgit_cache_root;
</a><a href="#h5-3-94" id="h5-3-94" class="d">-extern char *cgit_repo_group;
</a><a href="#h5-3-95" id="h5-3-95" class="d">-extern char *cgit_robots;
</a><a href="#h5-3-96" id="h5-3-96" class="d">-extern char *cgit_clone_prefix;
</a><a href="#h5-3-97" id="h5-3-97" class="d">-
</a><a href="#h5-3-98" id="h5-3-98" class="d">-extern int cgit_nocache;
</a><a href="#h5-3-99" id="h5-3-99" class="d">-extern int cgit_snapshots;
</a><a href="#h5-3-100" id="h5-3-100" class="d">-extern int cgit_enable_index_links;
</a><a href="#h5-3-101" id="h5-3-101" class="d">-extern int cgit_enable_log_filecount;
</a><a href="#h5-3-102" id="h5-3-102" class="d">-extern int cgit_enable_log_linecount;
</a><a href="#h5-3-103" id="h5-3-103" class="d">-extern int cgit_max_lock_attempts;
</a><a href="#h5-3-104" id="h5-3-104" class="d">-extern int cgit_cache_root_ttl;
</a><a href="#h5-3-105" id="h5-3-105" class="d">-extern int cgit_cache_repo_ttl;
</a><a href="#h5-3-106" id="h5-3-106" class="d">-extern int cgit_cache_dynamic_ttl;
</a><a href="#h5-3-107" id="h5-3-107" class="d">-extern int cgit_cache_static_ttl;
</a><a href="#h5-3-108" id="h5-3-108" class="d">-extern int cgit_cache_max_create_time;
</a><a href="#h5-3-109" id="h5-3-109" class="d">-extern int cgit_summary_log;
</a><a href="#h5-3-110" id="h5-3-110" class="d">-extern int cgit_summary_tags;
</a><a href="#h5-3-111" id="h5-3-111" class="d">-extern int cgit_summary_branches;
</a><a href="#h5-3-112" id="h5-3-112" class="d">-
</a><a href="#h5-3-113" id="h5-3-113" class="d">-extern int cgit_max_msg_len;
</a><a href="#h5-3-114" id="h5-3-114" class="d">-extern int cgit_max_repodesc_len;
</a><a href="#h5-3-115" id="h5-3-115" class="d">-extern int cgit_max_commit_count;
</a><a href="#h5-3-116" id="h5-3-116" class="d">-
</a><a href="#h5-3-117" id="h5-3-117" class="d">-extern int cgit_query_has_symref;
</a><a href="#h5-3-118" id="h5-3-118" class="d">-extern int cgit_query_has_sha1;
</a><a href="#h5-3-119" id="h5-3-119" class="d">-
</a><a href="#h5-3-120" id="h5-3-120" class="d">-extern char *cgit_querystring;
</a><a href="#h5-3-121" id="h5-3-121" class="d">-extern char *cgit_query_repo;
</a><a href="#h5-3-122" id="h5-3-122" class="d">-extern char *cgit_query_page;
</a><a href="#h5-3-123" id="h5-3-123" class="d">-extern char *cgit_query_search;
</a><a href="#h5-3-124" id="h5-3-124" class="d">-extern char *cgit_query_grep;
</a><a href="#h5-3-125" id="h5-3-125" class="d">-extern char *cgit_query_head;
</a><a href="#h5-3-126" id="h5-3-126" class="d">-extern char *cgit_query_sha1;
</a><a href="#h5-3-127" id="h5-3-127" class="d">-extern char *cgit_query_sha2;
</a><a href="#h5-3-128" id="h5-3-128" class="d">-extern char *cgit_query_path;
</a><a href="#h5-3-129" id="h5-3-129" class="d">-extern char *cgit_query_name;
</a><a href="#h5-3-130" id="h5-3-130" class="d">-extern int   cgit_query_ofs;
</a><a href="#h5-3-131" id="h5-3-131" class="d">-
</a><a href="#h5-3-132" id="h5-3-132" class="d">-extern int htmlfd;
</a><a href="#h5-3-133" id="h5-3-133" class="d">-
</a><a href="#h5-3-134" id="h5-3-134" class="d">-extern int cgit_get_cmd_index(const char *cmd);
</a><a href="#h5-3-135" id="h5-3-135" class="d">-extern struct repoinfo *cgit_get_repoinfo(const char *url);
</a><a href="#h5-3-136" id="h5-3-136" class="d">-extern void cgit_global_config_cb(const char *name, const char *value);
</a><a href="#h5-3-137" id="h5-3-137" class="i">+extern struct cgit_repolist cgit_repolist;
</a><a href="#h5-3-138" id="h5-3-138" class="i">+extern struct cgit_context ctx;
</a><a href="#h5-3-139" id="h5-3-139" class="i">+extern const struct cgit_snapshot_format cgit_snapshot_formats[];
</a><a href="#h5-3-140" id="h5-3-140" class="i">+
</a><a href="#h5-3-141" id="h5-3-141" class="i">+extern struct cgit_repo *cgit_add_repo(const char *url);
</a><a href="#h5-3-142" id="h5-3-142" class="i">+extern struct cgit_repo *cgit_get_repoinfo(const char *url);
</a> extern void cgit_repo_config_cb(const char *name, const char *value);
<a href="#h5-3-144" id="h5-3-144" class="d">-extern void cgit_querystring_cb(const char *name, const char *value);
</a> 
 extern int chk_zero(int result, char *msg);
 extern int chk_positive(int result, char *msg);
 extern int chk_non_negative(int result, char *msg);
 
<a href="#h5-3-150" id="h5-3-150" class="d">-extern int hextoint(char c);
</a> extern char *trim_end(const char *str, char c);
 extern char *strlpart(char *txt, int maxlen);
 extern char *strrpart(char *txt, int maxlen);
<a href="#h5-4" id="h5-4" class="h">@@ -213,83 +213,12 @@ extern void cgit_diff_commit(struct commit *commit, filepair_fn fn);
</a> 
 extern char *fmt(const char *format,...);
 
<a href="#h5-4-3" id="h5-4-3" class="d">-extern void html(const char *txt);
</a><a href="#h5-4-4" id="h5-4-4" class="d">-extern void htmlf(const char *format,...);
</a><a href="#h5-4-5" id="h5-4-5" class="d">-extern void html_txt(char *txt);
</a><a href="#h5-4-6" id="h5-4-6" class="d">-extern void html_ntxt(int len, char *txt);
</a><a href="#h5-4-7" id="h5-4-7" class="d">-extern void html_attr(char *txt);
</a><a href="#h5-4-8" id="h5-4-8" class="d">-extern void html_hidden(char *name, char *value);
</a><a href="#h5-4-9" id="h5-4-9" class="d">-extern void html_option(char *value, char *text, char *selected_value);
</a><a href="#h5-4-10" id="h5-4-10" class="d">-extern void html_link_open(char *url, char *title, char *class);
</a><a href="#h5-4-11" id="h5-4-11" class="d">-extern void html_link_close(void);
</a><a href="#h5-4-12" id="h5-4-12" class="d">-extern void html_filemode(unsigned short mode);
</a><a href="#h5-4-13" id="h5-4-13" class="d">-extern int html_include(const char *filename);
</a><a href="#h5-4-14" id="h5-4-14" class="d">-
</a><a href="#h5-4-15" id="h5-4-15" class="d">-extern int cgit_read_config(const char *filename, configfn fn);
</a><a href="#h5-4-16" id="h5-4-16" class="d">-extern int cgit_parse_query(char *txt, configfn fn);
</a> extern struct commitinfo *cgit_parse_commit(struct commit *commit);
 extern struct taginfo *cgit_parse_tag(struct tag *tag);
 extern void cgit_parse_url(const char *url);
 
<a href="#h5-4-21" id="h5-4-21" class="d">-extern char *cache_safe_filename(const char *unsafe);
</a><a href="#h5-4-22" id="h5-4-22" class="d">-extern int cache_lock(struct cacheitem *item);
</a><a href="#h5-4-23" id="h5-4-23" class="d">-extern int cache_unlock(struct cacheitem *item);
</a><a href="#h5-4-24" id="h5-4-24" class="d">-extern int cache_cancel_lock(struct cacheitem *item);
</a><a href="#h5-4-25" id="h5-4-25" class="d">-extern int cache_exist(struct cacheitem *item);
</a><a href="#h5-4-26" id="h5-4-26" class="d">-extern int cache_expired(struct cacheitem *item);
</a><a href="#h5-4-27" id="h5-4-27" class="d">-
</a><a href="#h5-4-28" id="h5-4-28" class="d">-extern char *cgit_repourl(const char *reponame);
</a><a href="#h5-4-29" id="h5-4-29" class="d">-extern char *cgit_fileurl(const char *reponame, const char *pagename,
</a><a href="#h5-4-30" id="h5-4-30" class="d">-			  const char *filename, const char *query);
</a><a href="#h5-4-31" id="h5-4-31" class="d">-extern char *cgit_pageurl(const char *reponame, const char *pagename,
</a><a href="#h5-4-32" id="h5-4-32" class="d">-			  const char *query);
</a><a href="#h5-4-33" id="h5-4-33" class="d">-
</a> extern const char *cgit_repobasename(const char *reponame);
 
<a href="#h5-4-36" id="h5-4-36" class="d">-extern void cgit_tree_link(char *name, char *title, char *class, char *head,
</a><a href="#h5-4-37" id="h5-4-37" class="d">-			   char *rev, char *path);
</a><a href="#h5-4-38" id="h5-4-38" class="d">-extern void cgit_log_link(char *name, char *title, char *class, char *head,
</a><a href="#h5-4-39" id="h5-4-39" class="d">-			  char *rev, char *path, int ofs, char *grep,
</a><a href="#h5-4-40" id="h5-4-40" class="d">-			  char *pattern);
</a><a href="#h5-4-41" id="h5-4-41" class="d">-extern void cgit_commit_link(char *name, char *title, char *class, char *head,
</a><a href="#h5-4-42" id="h5-4-42" class="d">-			     char *rev);
</a><a href="#h5-4-43" id="h5-4-43" class="d">-extern void cgit_refs_link(char *name, char *title, char *class, char *head,
</a><a href="#h5-4-44" id="h5-4-44" class="d">-			   char *rev, char *path);
</a><a href="#h5-4-45" id="h5-4-45" class="d">-extern void cgit_snapshot_link(char *name, char *title, char *class,
</a><a href="#h5-4-46" id="h5-4-46" class="d">-			       char *head, char *rev, char *archivename);
</a><a href="#h5-4-47" id="h5-4-47" class="d">-extern void cgit_diff_link(char *name, char *title, char *class, char *head,
</a><a href="#h5-4-48" id="h5-4-48" class="d">-			   char *new_rev, char *old_rev, char *path);
</a><a href="#h5-4-49" id="h5-4-49" class="d">-
</a><a href="#h5-4-50" id="h5-4-50" class="d">-extern void cgit_object_link(struct object *obj);
</a><a href="#h5-4-51" id="h5-4-51" class="d">-
</a><a href="#h5-4-52" id="h5-4-52" class="d">-extern void cgit_print_error(char *msg);
</a><a href="#h5-4-53" id="h5-4-53" class="d">-extern void cgit_print_date(time_t secs, char *format);
</a><a href="#h5-4-54" id="h5-4-54" class="d">-extern void cgit_print_age(time_t t, time_t max_relative, char *format);
</a><a href="#h5-4-55" id="h5-4-55" class="d">-extern void cgit_print_docstart(char *title, struct cacheitem *item);
</a><a href="#h5-4-56" id="h5-4-56" class="d">-extern void cgit_print_docend();
</a><a href="#h5-4-57" id="h5-4-57" class="d">-extern void cgit_print_pageheader(char *title, int show_search);
</a><a href="#h5-4-58" id="h5-4-58" class="d">-extern void cgit_print_snapshot_start(const char *mimetype,
</a><a href="#h5-4-59" id="h5-4-59" class="d">-				      const char *filename,
</a><a href="#h5-4-60" id="h5-4-60" class="d">-				      struct cacheitem *item);
</a><a href="#h5-4-61" id="h5-4-61" class="d">-extern void cgit_print_branches(int maxcount);
</a><a href="#h5-4-62" id="h5-4-62" class="d">-extern void cgit_print_tags(int maxcount);
</a><a href="#h5-4-63" id="h5-4-63" class="d">-
</a><a href="#h5-4-64" id="h5-4-64" class="d">-extern void cgit_print_repolist(struct cacheitem *item);
</a><a href="#h5-4-65" id="h5-4-65" class="d">-extern void cgit_print_summary();
</a><a href="#h5-4-66" id="h5-4-66" class="d">-extern void cgit_print_log(const char *tip, int ofs, int cnt, char *grep,
</a><a href="#h5-4-67" id="h5-4-67" class="d">-			   char *pattern, char *path, int pager);
</a><a href="#h5-4-68" id="h5-4-68" class="d">-extern void cgit_print_blob(struct cacheitem *item, const char *hex, char *path);
</a><a href="#h5-4-69" id="h5-4-69" class="d">-extern void cgit_print_tree(const char *rev, char *path);
</a><a href="#h5-4-70" id="h5-4-70" class="d">-extern void cgit_print_commit(char *hex);
</a><a href="#h5-4-71" id="h5-4-71" class="d">-extern void cgit_print_refs();
</a><a href="#h5-4-72" id="h5-4-72" class="d">-extern void cgit_print_tag(char *revname);
</a><a href="#h5-4-73" id="h5-4-73" class="d">-extern void cgit_print_diff(const char *new_hex, const char *old_hex, const char *prefix);
</a><a href="#h5-4-74" id="h5-4-74" class="d">-extern void cgit_print_patch(char *hex, struct cacheitem *item);
</a><a href="#h5-4-75" id="h5-4-75" class="d">-extern void cgit_print_snapshot(struct cacheitem *item, const char *head,
</a><a href="#h5-4-76" id="h5-4-76" class="d">-				const char *hex, const char *prefix,
</a><a href="#h5-4-77" id="h5-4-77" class="d">-				const char *filename, int snapshot);
</a><a href="#h5-4-78" id="h5-4-78" class="d">-extern void cgit_print_snapshot_links(const char *repo, const char *head,
</a><a href="#h5-4-79" id="h5-4-79" class="d">-				      const char *hex, int snapshots);
</a> extern int cgit_parse_snapshots_mask(const char *str);
 
 #endif /* CGIT_H */
<b>diff --git a/<a id="h6" href="../file/cmd.c.html">cmd.c</a> b/<a href="../file/cmd.c.html">cmd.c</a></b>
<a href="#h6-0" id="h6-0" class="h">@@ -0,0 +1,112 @@
</a><a href="#h6-0-0" id="h6-0-0" class="i">+/* cmd.c: the cgit command dispatcher
</a><a href="#h6-0-1" id="h6-0-1" class="i">+ *
</a><a href="#h6-0-2" id="h6-0-2" class="i">+ * Copyright (C) 2008 Lars Hjemli
</a><a href="#h6-0-3" id="h6-0-3" class="i">+ *
</a><a href="#h6-0-4" id="h6-0-4" class="i">+ * Licensed under GNU General Public License v2
</a><a href="#h6-0-5" id="h6-0-5" class="i">+ *   (see COPYING for full license text)
</a><a href="#h6-0-6" id="h6-0-6" class="i">+ */
</a><a href="#h6-0-7" id="h6-0-7" class="i">+
</a><a href="#h6-0-8" id="h6-0-8" class="i">+#include &quot;cgit.h&quot;
</a><a href="#h6-0-9" id="h6-0-9" class="i">+#include &quot;cmd.h&quot;
</a><a href="#h6-0-10" id="h6-0-10" class="i">+#include &quot;ui-blob.h&quot;
</a><a href="#h6-0-11" id="h6-0-11" class="i">+#include &quot;ui-commit.h&quot;
</a><a href="#h6-0-12" id="h6-0-12" class="i">+#include &quot;ui-diff.h&quot;
</a><a href="#h6-0-13" id="h6-0-13" class="i">+#include &quot;ui-log.h&quot;
</a><a href="#h6-0-14" id="h6-0-14" class="i">+#include &quot;ui-patch.h&quot;
</a><a href="#h6-0-15" id="h6-0-15" class="i">+#include &quot;ui-refs.h&quot;
</a><a href="#h6-0-16" id="h6-0-16" class="i">+#include &quot;ui-repolist.h&quot;
</a><a href="#h6-0-17" id="h6-0-17" class="i">+#include &quot;ui-snapshot.h&quot;
</a><a href="#h6-0-18" id="h6-0-18" class="i">+#include &quot;ui-summary.h&quot;
</a><a href="#h6-0-19" id="h6-0-19" class="i">+#include &quot;ui-tag.h&quot;
</a><a href="#h6-0-20" id="h6-0-20" class="i">+#include &quot;ui-tree.h&quot;
</a><a href="#h6-0-21" id="h6-0-21" class="i">+
</a><a href="#h6-0-22" id="h6-0-22" class="i">+static void blob_fn(struct cgit_context *ctx)
</a><a href="#h6-0-23" id="h6-0-23" class="i">+{
</a><a href="#h6-0-24" id="h6-0-24" class="i">+	cgit_print_blob(ctx-&gt;qry.sha1, ctx-&gt;qry.path);
</a><a href="#h6-0-25" id="h6-0-25" class="i">+}
</a><a href="#h6-0-26" id="h6-0-26" class="i">+
</a><a href="#h6-0-27" id="h6-0-27" class="i">+static void commit_fn(struct cgit_context *ctx)
</a><a href="#h6-0-28" id="h6-0-28" class="i">+{
</a><a href="#h6-0-29" id="h6-0-29" class="i">+	cgit_print_commit(ctx-&gt;qry.sha1);
</a><a href="#h6-0-30" id="h6-0-30" class="i">+}
</a><a href="#h6-0-31" id="h6-0-31" class="i">+
</a><a href="#h6-0-32" id="h6-0-32" class="i">+static void diff_fn(struct cgit_context *ctx)
</a><a href="#h6-0-33" id="h6-0-33" class="i">+{
</a><a href="#h6-0-34" id="h6-0-34" class="i">+	cgit_print_diff(ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, ctx-&gt;qry.path);
</a><a href="#h6-0-35" id="h6-0-35" class="i">+}
</a><a href="#h6-0-36" id="h6-0-36" class="i">+
</a><a href="#h6-0-37" id="h6-0-37" class="i">+static void repolist_fn(struct cgit_context *ctx)
</a><a href="#h6-0-38" id="h6-0-38" class="i">+{
</a><a href="#h6-0-39" id="h6-0-39" class="i">+	cgit_print_repolist();
</a><a href="#h6-0-40" id="h6-0-40" class="i">+}
</a><a href="#h6-0-41" id="h6-0-41" class="i">+
</a><a href="#h6-0-42" id="h6-0-42" class="i">+static void log_fn(struct cgit_context *ctx)
</a><a href="#h6-0-43" id="h6-0-43" class="i">+{
</a><a href="#h6-0-44" id="h6-0-44" class="i">+	cgit_print_log(ctx-&gt;qry.sha1, ctx-&gt;qry.ofs, ctx-&gt;cfg.max_commit_count,
</a><a href="#h6-0-45" id="h6-0-45" class="i">+		       ctx-&gt;qry.grep, ctx-&gt;qry.search, ctx-&gt;qry.path, 1);
</a><a href="#h6-0-46" id="h6-0-46" class="i">+}
</a><a href="#h6-0-47" id="h6-0-47" class="i">+
</a><a href="#h6-0-48" id="h6-0-48" class="i">+static void patch_fn(struct cgit_context *ctx)
</a><a href="#h6-0-49" id="h6-0-49" class="i">+{
</a><a href="#h6-0-50" id="h6-0-50" class="i">+	cgit_print_patch(ctx-&gt;qry.sha1);
</a><a href="#h6-0-51" id="h6-0-51" class="i">+}
</a><a href="#h6-0-52" id="h6-0-52" class="i">+
</a><a href="#h6-0-53" id="h6-0-53" class="i">+static void refs_fn(struct cgit_context *ctx)
</a><a href="#h6-0-54" id="h6-0-54" class="i">+{
</a><a href="#h6-0-55" id="h6-0-55" class="i">+	cgit_print_refs();
</a><a href="#h6-0-56" id="h6-0-56" class="i">+}
</a><a href="#h6-0-57" id="h6-0-57" class="i">+
</a><a href="#h6-0-58" id="h6-0-58" class="i">+static void snapshot_fn(struct cgit_context *ctx)
</a><a href="#h6-0-59" id="h6-0-59" class="i">+{
</a><a href="#h6-0-60" id="h6-0-60" class="i">+	cgit_print_snapshot(ctx-&gt;qry.head, ctx-&gt;qry.sha1,
</a><a href="#h6-0-61" id="h6-0-61" class="i">+			    cgit_repobasename(ctx-&gt;repo-&gt;url), ctx-&gt;qry.path,
</a><a href="#h6-0-62" id="h6-0-62" class="i">+			    ctx-&gt;repo-&gt;snapshots);
</a><a href="#h6-0-63" id="h6-0-63" class="i">+}
</a><a href="#h6-0-64" id="h6-0-64" class="i">+
</a><a href="#h6-0-65" id="h6-0-65" class="i">+static void summary_fn(struct cgit_context *ctx)
</a><a href="#h6-0-66" id="h6-0-66" class="i">+{
</a><a href="#h6-0-67" id="h6-0-67" class="i">+	cgit_print_summary();
</a><a href="#h6-0-68" id="h6-0-68" class="i">+}
</a><a href="#h6-0-69" id="h6-0-69" class="i">+
</a><a href="#h6-0-70" id="h6-0-70" class="i">+static void tag_fn(struct cgit_context *ctx)
</a><a href="#h6-0-71" id="h6-0-71" class="i">+{
</a><a href="#h6-0-72" id="h6-0-72" class="i">+	cgit_print_tag(ctx-&gt;qry.sha1);
</a><a href="#h6-0-73" id="h6-0-73" class="i">+}
</a><a href="#h6-0-74" id="h6-0-74" class="i">+
</a><a href="#h6-0-75" id="h6-0-75" class="i">+static void tree_fn(struct cgit_context *ctx)
</a><a href="#h6-0-76" id="h6-0-76" class="i">+{
</a><a href="#h6-0-77" id="h6-0-77" class="i">+	cgit_print_tree(ctx-&gt;qry.sha1, ctx-&gt;qry.path);
</a><a href="#h6-0-78" id="h6-0-78" class="i">+}
</a><a href="#h6-0-79" id="h6-0-79" class="i">+
</a><a href="#h6-0-80" id="h6-0-80" class="i">+#define def_cmd(name, want_repo, want_layout) \
</a><a href="#h6-0-81" id="h6-0-81" class="i">+	{#name, name##_fn, want_repo, want_layout}
</a><a href="#h6-0-82" id="h6-0-82" class="i">+
</a><a href="#h6-0-83" id="h6-0-83" class="i">+struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx)
</a><a href="#h6-0-84" id="h6-0-84" class="i">+{
</a><a href="#h6-0-85" id="h6-0-85" class="i">+	static struct cgit_cmd cmds[] = {
</a><a href="#h6-0-86" id="h6-0-86" class="i">+		def_cmd(blob, 1, 0),
</a><a href="#h6-0-87" id="h6-0-87" class="i">+		def_cmd(commit, 1, 1),
</a><a href="#h6-0-88" id="h6-0-88" class="i">+		def_cmd(diff, 1, 1),
</a><a href="#h6-0-89" id="h6-0-89" class="i">+		def_cmd(log, 1, 1),
</a><a href="#h6-0-90" id="h6-0-90" class="i">+		def_cmd(patch, 1, 0),
</a><a href="#h6-0-91" id="h6-0-91" class="i">+		def_cmd(refs, 1, 1),
</a><a href="#h6-0-92" id="h6-0-92" class="i">+		def_cmd(repolist, 0, 0),
</a><a href="#h6-0-93" id="h6-0-93" class="i">+		def_cmd(snapshot, 1, 0),
</a><a href="#h6-0-94" id="h6-0-94" class="i">+		def_cmd(summary, 1, 1),
</a><a href="#h6-0-95" id="h6-0-95" class="i">+		def_cmd(tag, 1, 1),
</a><a href="#h6-0-96" id="h6-0-96" class="i">+		def_cmd(tree, 1, 1),
</a><a href="#h6-0-97" id="h6-0-97" class="i">+	};
</a><a href="#h6-0-98" id="h6-0-98" class="i">+	int i;
</a><a href="#h6-0-99" id="h6-0-99" class="i">+
</a><a href="#h6-0-100" id="h6-0-100" class="i">+	if (ctx-&gt;qry.page == NULL) {
</a><a href="#h6-0-101" id="h6-0-101" class="i">+		if (ctx-&gt;repo)
</a><a href="#h6-0-102" id="h6-0-102" class="i">+			ctx-&gt;qry.page = &quot;summary&quot;;
</a><a href="#h6-0-103" id="h6-0-103" class="i">+		else
</a><a href="#h6-0-104" id="h6-0-104" class="i">+			ctx-&gt;qry.page = &quot;repolist&quot;;
</a><a href="#h6-0-105" id="h6-0-105" class="i">+	}
</a><a href="#h6-0-106" id="h6-0-106" class="i">+
</a><a href="#h6-0-107" id="h6-0-107" class="i">+	for(i = 0; i &lt; sizeof(cmds)/sizeof(*cmds); i++)
</a><a href="#h6-0-108" id="h6-0-108" class="i">+		if (!strcmp(ctx-&gt;qry.page, cmds[i].name))
</a><a href="#h6-0-109" id="h6-0-109" class="i">+			return &amp;cmds[i];
</a><a href="#h6-0-110" id="h6-0-110" class="i">+	return NULL;
</a><a href="#h6-0-111" id="h6-0-111" class="i">+}
</a><b>diff --git a/<a id="h7" href="../file/cmd.h.html">cmd.h</a> b/<a href="../file/cmd.h.html">cmd.h</a></b>
<a href="#h7-0" id="h7-0" class="h">@@ -0,0 +1,15 @@
</a><a href="#h7-0-0" id="h7-0-0" class="i">+#ifndef CMD_H
</a><a href="#h7-0-1" id="h7-0-1" class="i">+#define CMD_H
</a><a href="#h7-0-2" id="h7-0-2" class="i">+
</a><a href="#h7-0-3" id="h7-0-3" class="i">+typedef void (*cgit_cmd_fn)(struct cgit_context *ctx);
</a><a href="#h7-0-4" id="h7-0-4" class="i">+
</a><a href="#h7-0-5" id="h7-0-5" class="i">+struct cgit_cmd {
</a><a href="#h7-0-6" id="h7-0-6" class="i">+	const char *name;
</a><a href="#h7-0-7" id="h7-0-7" class="i">+	cgit_cmd_fn fn;
</a><a href="#h7-0-8" id="h7-0-8" class="i">+	unsigned int want_repo:1,
</a><a href="#h7-0-9" id="h7-0-9" class="i">+		want_layout:1;
</a><a href="#h7-0-10" id="h7-0-10" class="i">+};
</a><a href="#h7-0-11" id="h7-0-11" class="i">+
</a><a href="#h7-0-12" id="h7-0-12" class="i">+extern struct cgit_cmd *cgit_get_cmd(struct cgit_context *ctx);
</a><a href="#h7-0-13" id="h7-0-13" class="i">+
</a><a href="#h7-0-14" id="h7-0-14" class="i">+#endif /* CMD_H */
</a><b>diff --git a/<a id="h8" href="../file/configfile.c.html">configfile.c</a> b/<a href="../file/configfile.c.html">configfile.c</a></b>
<a href="#h8-0" id="h8-0" class="h">@@ -0,0 +1,87 @@
</a><a href="#h8-0-0" id="h8-0-0" class="i">+/* configfile.c: parsing of config files
</a><a href="#h8-0-1" id="h8-0-1" class="i">+ *
</a><a href="#h8-0-2" id="h8-0-2" class="i">+ * Copyright (C) 2008 Lars Hjemli
</a><a href="#h8-0-3" id="h8-0-3" class="i">+ *
</a><a href="#h8-0-4" id="h8-0-4" class="i">+ * Licensed under GNU General Public License v2
</a><a href="#h8-0-5" id="h8-0-5" class="i">+ *   (see COPYING for full license text)
</a><a href="#h8-0-6" id="h8-0-6" class="i">+ */
</a><a href="#h8-0-7" id="h8-0-7" class="i">+
</a><a href="#h8-0-8" id="h8-0-8" class="i">+#include &lt;ctype.h&gt;
</a><a href="#h8-0-9" id="h8-0-9" class="i">+#include &lt;stdio.h&gt;
</a><a href="#h8-0-10" id="h8-0-10" class="i">+#include &quot;configfile.h&quot;
</a><a href="#h8-0-11" id="h8-0-11" class="i">+
</a><a href="#h8-0-12" id="h8-0-12" class="i">+int next_char(FILE *f)
</a><a href="#h8-0-13" id="h8-0-13" class="i">+{
</a><a href="#h8-0-14" id="h8-0-14" class="i">+	int c = fgetc(f);
</a><a href="#h8-0-15" id="h8-0-15" class="i">+	if (c==&#39;\r&#39;) {
</a><a href="#h8-0-16" id="h8-0-16" class="i">+		c = fgetc(f);
</a><a href="#h8-0-17" id="h8-0-17" class="i">+		if (c!=&#39;\n&#39;) {
</a><a href="#h8-0-18" id="h8-0-18" class="i">+			ungetc(c, f);
</a><a href="#h8-0-19" id="h8-0-19" class="i">+			c = &#39;\r&#39;;
</a><a href="#h8-0-20" id="h8-0-20" class="i">+		}
</a><a href="#h8-0-21" id="h8-0-21" class="i">+	}
</a><a href="#h8-0-22" id="h8-0-22" class="i">+	return c;
</a><a href="#h8-0-23" id="h8-0-23" class="i">+}
</a><a href="#h8-0-24" id="h8-0-24" class="i">+
</a><a href="#h8-0-25" id="h8-0-25" class="i">+void skip_line(FILE *f)
</a><a href="#h8-0-26" id="h8-0-26" class="i">+{
</a><a href="#h8-0-27" id="h8-0-27" class="i">+	int c;
</a><a href="#h8-0-28" id="h8-0-28" class="i">+
</a><a href="#h8-0-29" id="h8-0-29" class="i">+	while((c=next_char(f)) &amp;&amp; c!=&#39;\n&#39; &amp;&amp; c!=EOF)
</a><a href="#h8-0-30" id="h8-0-30" class="i">+		;
</a><a href="#h8-0-31" id="h8-0-31" class="i">+}
</a><a href="#h8-0-32" id="h8-0-32" class="i">+
</a><a href="#h8-0-33" id="h8-0-33" class="i">+int read_config_line(FILE *f, char *line, const char **value, int bufsize)
</a><a href="#h8-0-34" id="h8-0-34" class="i">+{
</a><a href="#h8-0-35" id="h8-0-35" class="i">+	int i = 0, isname = 0;
</a><a href="#h8-0-36" id="h8-0-36" class="i">+
</a><a href="#h8-0-37" id="h8-0-37" class="i">+	*value = NULL;
</a><a href="#h8-0-38" id="h8-0-38" class="i">+	while(i&lt;bufsize-1) {
</a><a href="#h8-0-39" id="h8-0-39" class="i">+		int c = next_char(f);
</a><a href="#h8-0-40" id="h8-0-40" class="i">+		if (!isname &amp;&amp; (c==&#39;#&#39; || c==&#39;;&#39;)) {
</a><a href="#h8-0-41" id="h8-0-41" class="i">+			skip_line(f);
</a><a href="#h8-0-42" id="h8-0-42" class="i">+			continue;
</a><a href="#h8-0-43" id="h8-0-43" class="i">+		}
</a><a href="#h8-0-44" id="h8-0-44" class="i">+		if (!isname &amp;&amp; isspace(c))
</a><a href="#h8-0-45" id="h8-0-45" class="i">+			continue;
</a><a href="#h8-0-46" id="h8-0-46" class="i">+
</a><a href="#h8-0-47" id="h8-0-47" class="i">+		if (c==&#39;=&#39; &amp;&amp; !*value) {
</a><a href="#h8-0-48" id="h8-0-48" class="i">+			line[i] = 0;
</a><a href="#h8-0-49" id="h8-0-49" class="i">+			*value = &amp;line[i+1];
</a><a href="#h8-0-50" id="h8-0-50" class="i">+		} else if (c==&#39;\n&#39; &amp;&amp; !isname) {
</a><a href="#h8-0-51" id="h8-0-51" class="i">+			i = 0;
</a><a href="#h8-0-52" id="h8-0-52" class="i">+			continue;
</a><a href="#h8-0-53" id="h8-0-53" class="i">+		} else if (c==&#39;\n&#39; || c==EOF) {
</a><a href="#h8-0-54" id="h8-0-54" class="i">+			line[i] = 0;
</a><a href="#h8-0-55" id="h8-0-55" class="i">+			break;
</a><a href="#h8-0-56" id="h8-0-56" class="i">+		} else {
</a><a href="#h8-0-57" id="h8-0-57" class="i">+			line[i]=c;
</a><a href="#h8-0-58" id="h8-0-58" class="i">+		}
</a><a href="#h8-0-59" id="h8-0-59" class="i">+		isname = 1;
</a><a href="#h8-0-60" id="h8-0-60" class="i">+		i++;
</a><a href="#h8-0-61" id="h8-0-61" class="i">+	}
</a><a href="#h8-0-62" id="h8-0-62" class="i">+	line[i+1] = 0;
</a><a href="#h8-0-63" id="h8-0-63" class="i">+	return i;
</a><a href="#h8-0-64" id="h8-0-64" class="i">+}
</a><a href="#h8-0-65" id="h8-0-65" class="i">+
</a><a href="#h8-0-66" id="h8-0-66" class="i">+int parse_configfile(const char *filename, configfile_value_fn fn)
</a><a href="#h8-0-67" id="h8-0-67" class="i">+{
</a><a href="#h8-0-68" id="h8-0-68" class="i">+	static int nesting;
</a><a href="#h8-0-69" id="h8-0-69" class="i">+	int len;
</a><a href="#h8-0-70" id="h8-0-70" class="i">+	char line[256];
</a><a href="#h8-0-71" id="h8-0-71" class="i">+	const char *value;
</a><a href="#h8-0-72" id="h8-0-72" class="i">+	FILE *f;
</a><a href="#h8-0-73" id="h8-0-73" class="i">+
</a><a href="#h8-0-74" id="h8-0-74" class="i">+	/* cancel deeply nested include-commands */
</a><a href="#h8-0-75" id="h8-0-75" class="i">+	if (nesting &gt; 8)
</a><a href="#h8-0-76" id="h8-0-76" class="i">+		return -1;
</a><a href="#h8-0-77" id="h8-0-77" class="i">+	if (!(f = fopen(filename, &quot;r&quot;)))
</a><a href="#h8-0-78" id="h8-0-78" class="i">+		return -1;
</a><a href="#h8-0-79" id="h8-0-79" class="i">+	nesting++;
</a><a href="#h8-0-80" id="h8-0-80" class="i">+	while((len = read_config_line(f, line, &amp;value, sizeof(line))) &gt; 0)
</a><a href="#h8-0-81" id="h8-0-81" class="i">+		fn(line, value);
</a><a href="#h8-0-82" id="h8-0-82" class="i">+	nesting--;
</a><a href="#h8-0-83" id="h8-0-83" class="i">+	fclose(f);
</a><a href="#h8-0-84" id="h8-0-84" class="i">+	return 0;
</a><a href="#h8-0-85" id="h8-0-85" class="i">+}
</a><a href="#h8-0-86" id="h8-0-86" class="i">+
</a><b>diff --git a/<a id="h9" href="../file/configfile.h.html">configfile.h</a> b/<a href="../file/configfile.h.html">configfile.h</a></b>
<a href="#h9-0" id="h9-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h9-0-0" id="h9-0-0" class="i">+#ifndef CONFIGFILE_H
</a><a href="#h9-0-1" id="h9-0-1" class="i">+#define CONFIGFILE_H
</a><a href="#h9-0-2" id="h9-0-2" class="i">+
</a><a href="#h9-0-3" id="h9-0-3" class="i">+typedef void (*configfile_value_fn)(const char *name, const char *value);
</a><a href="#h9-0-4" id="h9-0-4" class="i">+
</a><a href="#h9-0-5" id="h9-0-5" class="i">+extern int parse_configfile(const char *filename, configfile_value_fn fn);
</a><a href="#h9-0-6" id="h9-0-6" class="i">+
</a><a href="#h9-0-7" id="h9-0-7" class="i">+#endif /* CONFIGFILE_H */
</a><b>diff --git a/<a id="h10" href="../file/html.c.html">html.c</a> b/<a href="../file/html.c.html">html.c</a></b>
<a href="#h10-0" id="h10-0" class="h">@@ -6,7 +6,13 @@
</a>  *   (see COPYING for full license text)
  */
 
<a href="#h10-0-3" id="h10-0-3" class="d">-#include &quot;cgit.h&quot;
</a><a href="#h10-0-4" id="h10-0-4" class="i">+#include &lt;unistd.h&gt;
</a><a href="#h10-0-5" id="h10-0-5" class="i">+#include &lt;stdio.h&gt;
</a><a href="#h10-0-6" id="h10-0-6" class="i">+#include &lt;stdlib.h&gt;
</a><a href="#h10-0-7" id="h10-0-7" class="i">+#include &lt;stdarg.h&gt;
</a><a href="#h10-0-8" id="h10-0-8" class="i">+#include &lt;string.h&gt;
</a><a href="#h10-0-9" id="h10-0-9" class="i">+
</a><a href="#h10-0-10" id="h10-0-10" class="i">+int htmlfd = STDOUT_FILENO;
</a> 
 char *fmt(const char *format, ...)
 {
<a href="#h10-1" id="h10-1" class="h">@@ -21,8 +27,10 @@ char *fmt(const char *format, ...)
</a> 	va_start(args, format);
 	len = vsnprintf(buf[bufidx], sizeof(buf[bufidx]), format, args);
 	va_end(args);
<a href="#h10-1-3" id="h10-1-3" class="d">-	if (len&gt;sizeof(buf[bufidx]))
</a><a href="#h10-1-4" id="h10-1-4" class="d">-		die(&quot;[html.c] string truncated: %s&quot;, format);
</a><a href="#h10-1-5" id="h10-1-5" class="i">+	if (len&gt;sizeof(buf[bufidx])) {
</a><a href="#h10-1-6" id="h10-1-6" class="i">+		fprintf(stderr, &quot;[html.c] string truncated: %s\n&quot;, format);
</a><a href="#h10-1-7" id="h10-1-7" class="i">+		exit(1);
</a><a href="#h10-1-8" id="h10-1-8" class="i">+	}
</a> 	return buf[bufidx];
 }
 
<a href="#h10-2" id="h10-2" class="h">@@ -150,25 +158,10 @@ void html_link_close(void)
</a> 
 void html_fileperm(unsigned short mode)
 {
<a href="#h10-2-3" id="h10-2-3" class="d">-	htmlf(&quot;%c%c%c&quot;, (mode &amp; 4 ? &#39;r&#39; : &#39;-&#39;), 
</a><a href="#h10-2-4" id="h10-2-4" class="i">+	htmlf(&quot;%c%c%c&quot;, (mode &amp; 4 ? &#39;r&#39; : &#39;-&#39;),
</a> 	      (mode &amp; 2 ? &#39;w&#39; : &#39;-&#39;), (mode &amp; 1 ? &#39;x&#39; : &#39;-&#39;));
 }
 
<a href="#h10-2-8" id="h10-2-8" class="d">-void html_filemode(unsigned short mode)
</a><a href="#h10-2-9" id="h10-2-9" class="d">-{
</a><a href="#h10-2-10" id="h10-2-10" class="d">-	if (S_ISDIR(mode))
</a><a href="#h10-2-11" id="h10-2-11" class="d">-		html(&quot;d&quot;);
</a><a href="#h10-2-12" id="h10-2-12" class="d">-	else if (S_ISLNK(mode))
</a><a href="#h10-2-13" id="h10-2-13" class="d">-		html(&quot;l&quot;);
</a><a href="#h10-2-14" id="h10-2-14" class="d">-	else if (S_ISGITLINK(mode))
</a><a href="#h10-2-15" id="h10-2-15" class="d">-		html(&quot;m&quot;);
</a><a href="#h10-2-16" id="h10-2-16" class="d">-	else
</a><a href="#h10-2-17" id="h10-2-17" class="d">-		html(&quot;-&quot;);
</a><a href="#h10-2-18" id="h10-2-18" class="d">-	html_fileperm(mode &gt;&gt; 6);
</a><a href="#h10-2-19" id="h10-2-19" class="d">-	html_fileperm(mode &gt;&gt; 3);
</a><a href="#h10-2-20" id="h10-2-20" class="d">-	html_fileperm(mode);
</a><a href="#h10-2-21" id="h10-2-21" class="d">-}
</a><a href="#h10-2-22" id="h10-2-22" class="d">-
</a> int html_include(const char *filename)
 {
 	FILE *f;
<a href="#h10-3" id="h10-3" class="h">@@ -182,3 +175,67 @@ int html_include(const char *filename)
</a> 	fclose(f);
 	return 0;
 }
<a href="#h10-3-3" id="h10-3-3" class="i">+
</a><a href="#h10-3-4" id="h10-3-4" class="i">+int hextoint(char c)
</a><a href="#h10-3-5" id="h10-3-5" class="i">+{
</a><a href="#h10-3-6" id="h10-3-6" class="i">+	if (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;f&#39;)
</a><a href="#h10-3-7" id="h10-3-7" class="i">+		return 10 + c - &#39;a&#39;;
</a><a href="#h10-3-8" id="h10-3-8" class="i">+	else if (c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;F&#39;)
</a><a href="#h10-3-9" id="h10-3-9" class="i">+		return 10 + c - &#39;A&#39;;
</a><a href="#h10-3-10" id="h10-3-10" class="i">+	else if (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;)
</a><a href="#h10-3-11" id="h10-3-11" class="i">+		return c - &#39;0&#39;;
</a><a href="#h10-3-12" id="h10-3-12" class="i">+	else
</a><a href="#h10-3-13" id="h10-3-13" class="i">+		return -1;
</a><a href="#h10-3-14" id="h10-3-14" class="i">+}
</a><a href="#h10-3-15" id="h10-3-15" class="i">+
</a><a href="#h10-3-16" id="h10-3-16" class="i">+char *convert_query_hexchar(char *txt)
</a><a href="#h10-3-17" id="h10-3-17" class="i">+{
</a><a href="#h10-3-18" id="h10-3-18" class="i">+	int d1, d2;
</a><a href="#h10-3-19" id="h10-3-19" class="i">+	if (strlen(txt) &lt; 3) {
</a><a href="#h10-3-20" id="h10-3-20" class="i">+		*txt = &#39;\0&#39;;
</a><a href="#h10-3-21" id="h10-3-21" class="i">+		return txt-1;
</a><a href="#h10-3-22" id="h10-3-22" class="i">+	}
</a><a href="#h10-3-23" id="h10-3-23" class="i">+	d1 = hextoint(*(txt+1));
</a><a href="#h10-3-24" id="h10-3-24" class="i">+	d2 = hextoint(*(txt+2));
</a><a href="#h10-3-25" id="h10-3-25" class="i">+	if (d1&lt;0 || d2&lt;0) {
</a><a href="#h10-3-26" id="h10-3-26" class="i">+		strcpy(txt, txt+3);
</a><a href="#h10-3-27" id="h10-3-27" class="i">+		return txt-1;
</a><a href="#h10-3-28" id="h10-3-28" class="i">+	} else {
</a><a href="#h10-3-29" id="h10-3-29" class="i">+		*txt = d1 * 16 + d2;
</a><a href="#h10-3-30" id="h10-3-30" class="i">+		strcpy(txt+1, txt+3);
</a><a href="#h10-3-31" id="h10-3-31" class="i">+		return txt;
</a><a href="#h10-3-32" id="h10-3-32" class="i">+	}
</a><a href="#h10-3-33" id="h10-3-33" class="i">+}
</a><a href="#h10-3-34" id="h10-3-34" class="i">+
</a><a href="#h10-3-35" id="h10-3-35" class="i">+int http_parse_querystring(char *txt, void (*fn)(const char *name, const char *value))
</a><a href="#h10-3-36" id="h10-3-36" class="i">+{
</a><a href="#h10-3-37" id="h10-3-37" class="i">+	char *t, *value = NULL, c;
</a><a href="#h10-3-38" id="h10-3-38" class="i">+
</a><a href="#h10-3-39" id="h10-3-39" class="i">+	if (!txt)
</a><a href="#h10-3-40" id="h10-3-40" class="i">+		return 0;
</a><a href="#h10-3-41" id="h10-3-41" class="i">+
</a><a href="#h10-3-42" id="h10-3-42" class="i">+	t = txt = strdup(txt);
</a><a href="#h10-3-43" id="h10-3-43" class="i">+	if (t == NULL) {
</a><a href="#h10-3-44" id="h10-3-44" class="i">+		printf(&quot;Out of memory\n&quot;);
</a><a href="#h10-3-45" id="h10-3-45" class="i">+		exit(1);
</a><a href="#h10-3-46" id="h10-3-46" class="i">+	}
</a><a href="#h10-3-47" id="h10-3-47" class="i">+	while((c=*t) != &#39;\0&#39;) {
</a><a href="#h10-3-48" id="h10-3-48" class="i">+		if (c==&#39;=&#39;) {
</a><a href="#h10-3-49" id="h10-3-49" class="i">+			*t = &#39;\0&#39;;
</a><a href="#h10-3-50" id="h10-3-50" class="i">+			value = t+1;
</a><a href="#h10-3-51" id="h10-3-51" class="i">+		} else if (c==&#39;+&#39;) {
</a><a href="#h10-3-52" id="h10-3-52" class="i">+			*t = &#39; &#39;;
</a><a href="#h10-3-53" id="h10-3-53" class="i">+		} else if (c==&#39;%&#39;) {
</a><a href="#h10-3-54" id="h10-3-54" class="i">+			t = convert_query_hexchar(t);
</a><a href="#h10-3-55" id="h10-3-55" class="i">+		} else if (c==&#39;&amp;&#39;) {
</a><a href="#h10-3-56" id="h10-3-56" class="i">+			*t = &#39;\0&#39;;
</a><a href="#h10-3-57" id="h10-3-57" class="i">+			(*fn)(txt, value);
</a><a href="#h10-3-58" id="h10-3-58" class="i">+			txt = t+1;
</a><a href="#h10-3-59" id="h10-3-59" class="i">+			value = NULL;
</a><a href="#h10-3-60" id="h10-3-60" class="i">+		}
</a><a href="#h10-3-61" id="h10-3-61" class="i">+		t++;
</a><a href="#h10-3-62" id="h10-3-62" class="i">+	}
</a><a href="#h10-3-63" id="h10-3-63" class="i">+	if (t!=txt)
</a><a href="#h10-3-64" id="h10-3-64" class="i">+		(*fn)(txt, value);
</a><a href="#h10-3-65" id="h10-3-65" class="i">+	return 0;
</a><a href="#h10-3-66" id="h10-3-66" class="i">+}
</a><b>diff --git a/<a id="h11" href="../file/html.h.html">html.h</a> b/<a href="../file/html.h.html">html.h</a></b>
<a href="#h11-0" id="h11-0" class="h">@@ -0,0 +1,20 @@
</a><a href="#h11-0-0" id="h11-0-0" class="i">+#ifndef HTML_H
</a><a href="#h11-0-1" id="h11-0-1" class="i">+#define HTML_H
</a><a href="#h11-0-2" id="h11-0-2" class="i">+
</a><a href="#h11-0-3" id="h11-0-3" class="i">+extern int htmlfd;
</a><a href="#h11-0-4" id="h11-0-4" class="i">+
</a><a href="#h11-0-5" id="h11-0-5" class="i">+extern void html(const char *txt);
</a><a href="#h11-0-6" id="h11-0-6" class="i">+extern void htmlf(const char *format,...);
</a><a href="#h11-0-7" id="h11-0-7" class="i">+extern void html_txt(char *txt);
</a><a href="#h11-0-8" id="h11-0-8" class="i">+extern void html_ntxt(int len, char *txt);
</a><a href="#h11-0-9" id="h11-0-9" class="i">+extern void html_attr(char *txt);
</a><a href="#h11-0-10" id="h11-0-10" class="i">+extern void html_hidden(char *name, char *value);
</a><a href="#h11-0-11" id="h11-0-11" class="i">+extern void html_option(char *value, char *text, char *selected_value);
</a><a href="#h11-0-12" id="h11-0-12" class="i">+extern void html_link_open(char *url, char *title, char *class);
</a><a href="#h11-0-13" id="h11-0-13" class="i">+extern void html_link_close(void);
</a><a href="#h11-0-14" id="h11-0-14" class="i">+extern void html_fileperm(unsigned short mode);
</a><a href="#h11-0-15" id="h11-0-15" class="i">+extern int html_include(const char *filename);
</a><a href="#h11-0-16" id="h11-0-16" class="i">+
</a><a href="#h11-0-17" id="h11-0-17" class="i">+extern int http_parse_querystring(char *txt, void (*fn)(const char *name, const char *value));
</a><a href="#h11-0-18" id="h11-0-18" class="i">+
</a><a href="#h11-0-19" id="h11-0-19" class="i">+#endif /* HTML_H */
</a><b>diff --git a/<a id="h12" href="../file/parsing.c.html">parsing.c</a> b/<a href="../file/parsing.c.html">parsing.c</a></b>
<a href="#h12-0" id="h12-0" class="h">@@ -8,130 +8,6 @@
</a> 
 #include &quot;cgit.h&quot;
 
<a href="#h12-0-3" id="h12-0-3" class="d">-int next_char(FILE *f)
</a><a href="#h12-0-4" id="h12-0-4" class="d">-{
</a><a href="#h12-0-5" id="h12-0-5" class="d">-	int c = fgetc(f);
</a><a href="#h12-0-6" id="h12-0-6" class="d">-	if (c==&#39;\r&#39;) {
</a><a href="#h12-0-7" id="h12-0-7" class="d">-		c = fgetc(f);
</a><a href="#h12-0-8" id="h12-0-8" class="d">-		if (c!=&#39;\n&#39;) {
</a><a href="#h12-0-9" id="h12-0-9" class="d">-			ungetc(c, f);
</a><a href="#h12-0-10" id="h12-0-10" class="d">-			c = &#39;\r&#39;;
</a><a href="#h12-0-11" id="h12-0-11" class="d">-		}
</a><a href="#h12-0-12" id="h12-0-12" class="d">-	}
</a><a href="#h12-0-13" id="h12-0-13" class="d">-	return c;
</a><a href="#h12-0-14" id="h12-0-14" class="d">-}
</a><a href="#h12-0-15" id="h12-0-15" class="d">-
</a><a href="#h12-0-16" id="h12-0-16" class="d">-void skip_line(FILE *f)
</a><a href="#h12-0-17" id="h12-0-17" class="d">-{
</a><a href="#h12-0-18" id="h12-0-18" class="d">-	int c;
</a><a href="#h12-0-19" id="h12-0-19" class="d">-
</a><a href="#h12-0-20" id="h12-0-20" class="d">-	while((c=next_char(f)) &amp;&amp; c!=&#39;\n&#39; &amp;&amp; c!=EOF)
</a><a href="#h12-0-21" id="h12-0-21" class="d">-		;
</a><a href="#h12-0-22" id="h12-0-22" class="d">-}
</a><a href="#h12-0-23" id="h12-0-23" class="d">-
</a><a href="#h12-0-24" id="h12-0-24" class="d">-int read_config_line(FILE *f, char *line, const char **value, int bufsize)
</a><a href="#h12-0-25" id="h12-0-25" class="d">-{
</a><a href="#h12-0-26" id="h12-0-26" class="d">-	int i = 0, isname = 0;
</a><a href="#h12-0-27" id="h12-0-27" class="d">-
</a><a href="#h12-0-28" id="h12-0-28" class="d">-	*value = NULL;
</a><a href="#h12-0-29" id="h12-0-29" class="d">-	while(i&lt;bufsize-1) {
</a><a href="#h12-0-30" id="h12-0-30" class="d">-		int c = next_char(f);
</a><a href="#h12-0-31" id="h12-0-31" class="d">-		if (!isname &amp;&amp; (c==&#39;#&#39; || c==&#39;;&#39;)) {
</a><a href="#h12-0-32" id="h12-0-32" class="d">-			skip_line(f);
</a><a href="#h12-0-33" id="h12-0-33" class="d">-			continue;
</a><a href="#h12-0-34" id="h12-0-34" class="d">-		}
</a><a href="#h12-0-35" id="h12-0-35" class="d">-		if (!isname &amp;&amp; isspace(c))
</a><a href="#h12-0-36" id="h12-0-36" class="d">-			continue;
</a><a href="#h12-0-37" id="h12-0-37" class="d">-
</a><a href="#h12-0-38" id="h12-0-38" class="d">-		if (c==&#39;=&#39; &amp;&amp; !*value) {
</a><a href="#h12-0-39" id="h12-0-39" class="d">-			line[i] = 0;
</a><a href="#h12-0-40" id="h12-0-40" class="d">-			*value = &amp;line[i+1];
</a><a href="#h12-0-41" id="h12-0-41" class="d">-		} else if (c==&#39;\n&#39; &amp;&amp; !isname) {
</a><a href="#h12-0-42" id="h12-0-42" class="d">-			i = 0;
</a><a href="#h12-0-43" id="h12-0-43" class="d">-			continue;
</a><a href="#h12-0-44" id="h12-0-44" class="d">-		} else if (c==&#39;\n&#39; || c==EOF) {
</a><a href="#h12-0-45" id="h12-0-45" class="d">-			line[i] = 0;
</a><a href="#h12-0-46" id="h12-0-46" class="d">-			break;
</a><a href="#h12-0-47" id="h12-0-47" class="d">-		} else {
</a><a href="#h12-0-48" id="h12-0-48" class="d">-			line[i]=c;
</a><a href="#h12-0-49" id="h12-0-49" class="d">-		}
</a><a href="#h12-0-50" id="h12-0-50" class="d">-		isname = 1;
</a><a href="#h12-0-51" id="h12-0-51" class="d">-		i++;
</a><a href="#h12-0-52" id="h12-0-52" class="d">-	}
</a><a href="#h12-0-53" id="h12-0-53" class="d">-	line[i+1] = 0;
</a><a href="#h12-0-54" id="h12-0-54" class="d">-	return i;
</a><a href="#h12-0-55" id="h12-0-55" class="d">-}
</a><a href="#h12-0-56" id="h12-0-56" class="d">-
</a><a href="#h12-0-57" id="h12-0-57" class="d">-int cgit_read_config(const char *filename, configfn fn)
</a><a href="#h12-0-58" id="h12-0-58" class="d">-{
</a><a href="#h12-0-59" id="h12-0-59" class="d">-	static int nesting;
</a><a href="#h12-0-60" id="h12-0-60" class="d">-	int len;
</a><a href="#h12-0-61" id="h12-0-61" class="d">-	char line[256];
</a><a href="#h12-0-62" id="h12-0-62" class="d">-	const char *value;
</a><a href="#h12-0-63" id="h12-0-63" class="d">-	FILE *f;
</a><a href="#h12-0-64" id="h12-0-64" class="d">-
</a><a href="#h12-0-65" id="h12-0-65" class="d">-	/* cancel deeply nested include-commands */
</a><a href="#h12-0-66" id="h12-0-66" class="d">-	if (nesting &gt; 8)
</a><a href="#h12-0-67" id="h12-0-67" class="d">-		return -1;
</a><a href="#h12-0-68" id="h12-0-68" class="d">-	if (!(f = fopen(filename, &quot;r&quot;)))
</a><a href="#h12-0-69" id="h12-0-69" class="d">-		return -1;
</a><a href="#h12-0-70" id="h12-0-70" class="d">-	nesting++;
</a><a href="#h12-0-71" id="h12-0-71" class="d">-	while((len = read_config_line(f, line, &amp;value, sizeof(line))) &gt; 0)
</a><a href="#h12-0-72" id="h12-0-72" class="d">-		(*fn)(line, value);
</a><a href="#h12-0-73" id="h12-0-73" class="d">-	nesting--;
</a><a href="#h12-0-74" id="h12-0-74" class="d">-	fclose(f);
</a><a href="#h12-0-75" id="h12-0-75" class="d">-	return 0;
</a><a href="#h12-0-76" id="h12-0-76" class="d">-}
</a><a href="#h12-0-77" id="h12-0-77" class="d">-
</a><a href="#h12-0-78" id="h12-0-78" class="d">-char *convert_query_hexchar(char *txt)
</a><a href="#h12-0-79" id="h12-0-79" class="d">-{
</a><a href="#h12-0-80" id="h12-0-80" class="d">-	int d1, d2;
</a><a href="#h12-0-81" id="h12-0-81" class="d">-	if (strlen(txt) &lt; 3) {
</a><a href="#h12-0-82" id="h12-0-82" class="d">-		*txt = &#39;\0&#39;;
</a><a href="#h12-0-83" id="h12-0-83" class="d">-		return txt-1;
</a><a href="#h12-0-84" id="h12-0-84" class="d">-	}
</a><a href="#h12-0-85" id="h12-0-85" class="d">-	d1 = hextoint(*(txt+1));
</a><a href="#h12-0-86" id="h12-0-86" class="d">-	d2 = hextoint(*(txt+2));
</a><a href="#h12-0-87" id="h12-0-87" class="d">-	if (d1&lt;0 || d2&lt;0) {
</a><a href="#h12-0-88" id="h12-0-88" class="d">-		strcpy(txt, txt+3);
</a><a href="#h12-0-89" id="h12-0-89" class="d">-		return txt-1;
</a><a href="#h12-0-90" id="h12-0-90" class="d">-	} else {
</a><a href="#h12-0-91" id="h12-0-91" class="d">-		*txt = d1 * 16 + d2;
</a><a href="#h12-0-92" id="h12-0-92" class="d">-		strcpy(txt+1, txt+3);
</a><a href="#h12-0-93" id="h12-0-93" class="d">-		return txt;
</a><a href="#h12-0-94" id="h12-0-94" class="d">-	}
</a><a href="#h12-0-95" id="h12-0-95" class="d">-}
</a><a href="#h12-0-96" id="h12-0-96" class="d">-
</a><a href="#h12-0-97" id="h12-0-97" class="d">-int cgit_parse_query(char *txt, configfn fn)
</a><a href="#h12-0-98" id="h12-0-98" class="d">-{
</a><a href="#h12-0-99" id="h12-0-99" class="d">-	char *t, *value = NULL, c;
</a><a href="#h12-0-100" id="h12-0-100" class="d">-
</a><a href="#h12-0-101" id="h12-0-101" class="d">-	if (!txt)
</a><a href="#h12-0-102" id="h12-0-102" class="d">-		return 0;
</a><a href="#h12-0-103" id="h12-0-103" class="d">-
</a><a href="#h12-0-104" id="h12-0-104" class="d">-	t = txt = xstrdup(txt);
</a><a href="#h12-0-105" id="h12-0-105" class="d">-
</a><a href="#h12-0-106" id="h12-0-106" class="d">-	while((c=*t) != &#39;\0&#39;) {
</a><a href="#h12-0-107" id="h12-0-107" class="d">-		if (c==&#39;=&#39;) {
</a><a href="#h12-0-108" id="h12-0-108" class="d">-			*t = &#39;\0&#39;;
</a><a href="#h12-0-109" id="h12-0-109" class="d">-			value = t+1;
</a><a href="#h12-0-110" id="h12-0-110" class="d">-		} else if (c==&#39;+&#39;) {
</a><a href="#h12-0-111" id="h12-0-111" class="d">-			*t = &#39; &#39;;
</a><a href="#h12-0-112" id="h12-0-112" class="d">-		} else if (c==&#39;%&#39;) {
</a><a href="#h12-0-113" id="h12-0-113" class="d">-			t = convert_query_hexchar(t);
</a><a href="#h12-0-114" id="h12-0-114" class="d">-		} else if (c==&#39;&amp;&#39;) {
</a><a href="#h12-0-115" id="h12-0-115" class="d">-			*t = &#39;\0&#39;;
</a><a href="#h12-0-116" id="h12-0-116" class="d">-			(*fn)(txt, value);
</a><a href="#h12-0-117" id="h12-0-117" class="d">-			txt = t+1;
</a><a href="#h12-0-118" id="h12-0-118" class="d">-			value = NULL;
</a><a href="#h12-0-119" id="h12-0-119" class="d">-		}
</a><a href="#h12-0-120" id="h12-0-120" class="d">-		t++;
</a><a href="#h12-0-121" id="h12-0-121" class="d">-	}
</a><a href="#h12-0-122" id="h12-0-122" class="d">-	if (t!=txt)
</a><a href="#h12-0-123" id="h12-0-123" class="d">-		(*fn)(txt, value);
</a><a href="#h12-0-124" id="h12-0-124" class="d">-	return 0;
</a><a href="#h12-0-125" id="h12-0-125" class="d">-}
</a><a href="#h12-0-126" id="h12-0-126" class="d">-
</a> /*
  * url syntax: [repo [&#39;/&#39; cmd [ &#39;/&#39; path]]]
  *   repo: any valid repo url, may contain &#39;/&#39;
<a href="#h12-1" id="h12-1" class="h">@@ -143,35 +19,35 @@ void cgit_parse_url(const char *url)
</a> {
 	char *cmd, *p;
 
<a href="#h12-1-3" id="h12-1-3" class="d">-	cgit_repo = NULL;
</a><a href="#h12-1-4" id="h12-1-4" class="i">+	ctx.repo = NULL;
</a> 	if (!url || url[0] == &#39;\0&#39;)
 		return;
 
<a href="#h12-1-8" id="h12-1-8" class="d">-	cgit_repo = cgit_get_repoinfo(url);
</a><a href="#h12-1-9" id="h12-1-9" class="d">-	if (cgit_repo) {
</a><a href="#h12-1-10" id="h12-1-10" class="d">-		cgit_query_repo = cgit_repo-&gt;url;
</a><a href="#h12-1-11" id="h12-1-11" class="i">+	ctx.repo = cgit_get_repoinfo(url);
</a><a href="#h12-1-12" id="h12-1-12" class="i">+	if (ctx.repo) {
</a><a href="#h12-1-13" id="h12-1-13" class="i">+		ctx.qry.repo = ctx.repo-&gt;url;
</a> 		return;
 	}
 
 	cmd = strchr(url, &#39;/&#39;);
<a href="#h12-1-18" id="h12-1-18" class="d">-	while (!cgit_repo &amp;&amp; cmd) {
</a><a href="#h12-1-19" id="h12-1-19" class="i">+	while (!ctx.repo &amp;&amp; cmd) {
</a> 		cmd[0] = &#39;\0&#39;;
<a href="#h12-1-21" id="h12-1-21" class="d">-		cgit_repo = cgit_get_repoinfo(url);
</a><a href="#h12-1-22" id="h12-1-22" class="d">-		if (cgit_repo == NULL) {
</a><a href="#h12-1-23" id="h12-1-23" class="i">+		ctx.repo = cgit_get_repoinfo(url);
</a><a href="#h12-1-24" id="h12-1-24" class="i">+		if (ctx.repo == NULL) {
</a> 			cmd[0] = &#39;/&#39;;
 			cmd = strchr(cmd + 1, &#39;/&#39;);
 			continue;
 		}
 
<a href="#h12-1-30" id="h12-1-30" class="d">-		cgit_query_repo = cgit_repo-&gt;url;
</a><a href="#h12-1-31" id="h12-1-31" class="i">+		ctx.qry.repo = ctx.repo-&gt;url;
</a> 		p = strchr(cmd + 1, &#39;/&#39;);
 		if (p) {
 			p[0] = &#39;\0&#39;;
 			if (p[1])
<a href="#h12-1-36" id="h12-1-36" class="d">-				cgit_query_path = trim_end(p + 1, &#39;/&#39;);
</a><a href="#h12-1-37" id="h12-1-37" class="i">+				ctx.qry.path = trim_end(p + 1, &#39;/&#39;);
</a> 		}
<a href="#h12-1-39" id="h12-1-39" class="d">-		cgit_cmd = cgit_get_cmd_index(cmd + 1);
</a><a href="#h12-1-40" id="h12-1-40" class="d">-		cgit_query_page = xstrdup(cmd + 1);
</a><a href="#h12-1-41" id="h12-1-41" class="i">+		if (cmd[1])
</a><a href="#h12-1-42" id="h12-1-42" class="i">+			ctx.qry.page = xstrdup(cmd + 1);
</a> 		return;
 	}
 }
<b>diff --git a/<a id="h13" href="../file/shared.c.html">shared.c</a> b/<a href="../file/shared.c.html">shared.c</a></b>
<a href="#h13-0" id="h13-0" class="h">@@ -8,77 +8,10 @@
</a> 
 #include &quot;cgit.h&quot;
 
<a href="#h13-0-3" id="h13-0-3" class="d">-struct repolist cgit_repolist;
</a><a href="#h13-0-4" id="h13-0-4" class="d">-struct repoinfo *cgit_repo;
</a><a href="#h13-0-5" id="h13-0-5" class="i">+struct cgit_repolist cgit_repolist;
</a><a href="#h13-0-6" id="h13-0-6" class="i">+struct cgit_context ctx;
</a> int cgit_cmd;
 
<a href="#h13-0-9" id="h13-0-9" class="d">-const char *cgit_version = CGIT_VERSION;
</a><a href="#h13-0-10" id="h13-0-10" class="d">-
</a><a href="#h13-0-11" id="h13-0-11" class="d">-char *cgit_root_title   = &quot;Git repository browser&quot;;
</a><a href="#h13-0-12" id="h13-0-12" class="d">-char *cgit_css          = &quot;/cgit.css&quot;;
</a><a href="#h13-0-13" id="h13-0-13" class="d">-char *cgit_logo         = &quot;/git-logo.png&quot;;
</a><a href="#h13-0-14" id="h13-0-14" class="d">-char *cgit_index_header = NULL;
</a><a href="#h13-0-15" id="h13-0-15" class="d">-char *cgit_index_info   = NULL;
</a><a href="#h13-0-16" id="h13-0-16" class="d">-char *cgit_logo_link    = &quot;http://www.kernel.org/pub/software/scm/git/docs/&quot;;
</a><a href="#h13-0-17" id="h13-0-17" class="d">-char *cgit_module_link  = &quot;./?repo=%s&amp;page=commit&amp;id=%s&quot;;
</a><a href="#h13-0-18" id="h13-0-18" class="d">-char *cgit_agefile      = &quot;info/web/last-modified&quot;;
</a><a href="#h13-0-19" id="h13-0-19" class="d">-char *cgit_virtual_root = NULL;
</a><a href="#h13-0-20" id="h13-0-20" class="d">-char *cgit_script_name  = CGIT_SCRIPT_NAME;
</a><a href="#h13-0-21" id="h13-0-21" class="d">-char *cgit_cache_root   = CGIT_CACHE_ROOT;
</a><a href="#h13-0-22" id="h13-0-22" class="d">-char *cgit_repo_group   = NULL;
</a><a href="#h13-0-23" id="h13-0-23" class="d">-char *cgit_robots       = &quot;index, nofollow&quot;;
</a><a href="#h13-0-24" id="h13-0-24" class="d">-char *cgit_clone_prefix = NULL;
</a><a href="#h13-0-25" id="h13-0-25" class="d">-
</a><a href="#h13-0-26" id="h13-0-26" class="d">-int cgit_nocache               =  0;
</a><a href="#h13-0-27" id="h13-0-27" class="d">-int cgit_snapshots             =  0;
</a><a href="#h13-0-28" id="h13-0-28" class="d">-int cgit_enable_index_links    =  0;
</a><a href="#h13-0-29" id="h13-0-29" class="d">-int cgit_enable_log_filecount  =  0;
</a><a href="#h13-0-30" id="h13-0-30" class="d">-int cgit_enable_log_linecount  =  0;
</a><a href="#h13-0-31" id="h13-0-31" class="d">-int cgit_max_lock_attempts     =  5;
</a><a href="#h13-0-32" id="h13-0-32" class="d">-int cgit_cache_root_ttl        =  5;
</a><a href="#h13-0-33" id="h13-0-33" class="d">-int cgit_cache_repo_ttl        =  5;
</a><a href="#h13-0-34" id="h13-0-34" class="d">-int cgit_cache_dynamic_ttl     =  5;
</a><a href="#h13-0-35" id="h13-0-35" class="d">-int cgit_cache_static_ttl      = -1;
</a><a href="#h13-0-36" id="h13-0-36" class="d">-int cgit_cache_max_create_time =  5;
</a><a href="#h13-0-37" id="h13-0-37" class="d">-int cgit_summary_log           =  0;
</a><a href="#h13-0-38" id="h13-0-38" class="d">-int cgit_summary_tags          =  0;
</a><a href="#h13-0-39" id="h13-0-39" class="d">-int cgit_summary_branches      =  0;
</a><a href="#h13-0-40" id="h13-0-40" class="d">-int cgit_renamelimit           = -1;
</a><a href="#h13-0-41" id="h13-0-41" class="d">-
</a><a href="#h13-0-42" id="h13-0-42" class="d">-int cgit_max_msg_len = 60;
</a><a href="#h13-0-43" id="h13-0-43" class="d">-int cgit_max_repodesc_len = 60;
</a><a href="#h13-0-44" id="h13-0-44" class="d">-int cgit_max_commit_count = 50;
</a><a href="#h13-0-45" id="h13-0-45" class="d">-
</a><a href="#h13-0-46" id="h13-0-46" class="d">-int cgit_query_has_symref = 0;
</a><a href="#h13-0-47" id="h13-0-47" class="d">-int cgit_query_has_sha1   = 0;
</a><a href="#h13-0-48" id="h13-0-48" class="d">-
</a><a href="#h13-0-49" id="h13-0-49" class="d">-char *cgit_querystring  = NULL;
</a><a href="#h13-0-50" id="h13-0-50" class="d">-char *cgit_query_repo   = NULL;
</a><a href="#h13-0-51" id="h13-0-51" class="d">-char *cgit_query_page   = NULL;
</a><a href="#h13-0-52" id="h13-0-52" class="d">-char *cgit_query_head   = NULL;
</a><a href="#h13-0-53" id="h13-0-53" class="d">-char *cgit_query_search = NULL;
</a><a href="#h13-0-54" id="h13-0-54" class="d">-char *cgit_query_grep   = NULL;
</a><a href="#h13-0-55" id="h13-0-55" class="d">-char *cgit_query_sha1   = NULL;
</a><a href="#h13-0-56" id="h13-0-56" class="d">-char *cgit_query_sha2   = NULL;
</a><a href="#h13-0-57" id="h13-0-57" class="d">-char *cgit_query_path   = NULL;
</a><a href="#h13-0-58" id="h13-0-58" class="d">-char *cgit_query_name   = NULL;
</a><a href="#h13-0-59" id="h13-0-59" class="d">-int   cgit_query_ofs    = 0;
</a><a href="#h13-0-60" id="h13-0-60" class="d">-
</a><a href="#h13-0-61" id="h13-0-61" class="d">-int htmlfd = 0;
</a><a href="#h13-0-62" id="h13-0-62" class="d">-
</a><a href="#h13-0-63" id="h13-0-63" class="d">-
</a><a href="#h13-0-64" id="h13-0-64" class="d">-int cgit_get_cmd_index(const char *cmd)
</a><a href="#h13-0-65" id="h13-0-65" class="d">-{
</a><a href="#h13-0-66" id="h13-0-66" class="d">-	static char *cmds[] = {&quot;log&quot;, &quot;commit&quot;, &quot;diff&quot;, &quot;tree&quot;, &quot;blob&quot;,
</a><a href="#h13-0-67" id="h13-0-67" class="d">-			       &quot;snapshot&quot;, &quot;tag&quot;, &quot;refs&quot;, &quot;patch&quot;, NULL};
</a><a href="#h13-0-68" id="h13-0-68" class="d">-	int i;
</a><a href="#h13-0-69" id="h13-0-69" class="d">-
</a><a href="#h13-0-70" id="h13-0-70" class="d">-	for(i = 0; cmds[i]; i++)
</a><a href="#h13-0-71" id="h13-0-71" class="d">-		if (!strcmp(cmd, cmds[i]))
</a><a href="#h13-0-72" id="h13-0-72" class="d">-			return i + 1;
</a><a href="#h13-0-73" id="h13-0-73" class="d">-	return 0;
</a><a href="#h13-0-74" id="h13-0-74" class="d">-}
</a><a href="#h13-0-75" id="h13-0-75" class="d">-
</a> int chk_zero(int result, char *msg)
 {
 	if (result != 0)
<a href="#h13-1" id="h13-1" class="h">@@ -100,9 +33,9 @@ int chk_non_negative(int result, char *msg)
</a> 	return result;
 }
 
<a href="#h13-1-3" id="h13-1-3" class="d">-struct repoinfo *add_repo(const char *url)
</a><a href="#h13-1-4" id="h13-1-4" class="i">+struct cgit_repo *cgit_add_repo(const char *url)
</a> {
<a href="#h13-1-6" id="h13-1-6" class="d">-	struct repoinfo *ret;
</a><a href="#h13-1-7" id="h13-1-7" class="i">+	struct cgit_repo *ret;
</a> 
 	if (++cgit_repolist.count &gt; cgit_repolist.length) {
 		if (cgit_repolist.length == 0)
<a href="#h13-2" id="h13-2" class="h">@@ -111,7 +44,7 @@ struct repoinfo *add_repo(const char *url)
</a> 			cgit_repolist.length *= 2;
 		cgit_repolist.repos = xrealloc(cgit_repolist.repos,
 					       cgit_repolist.length *
<a href="#h13-2-3" id="h13-2-3" class="d">-					       sizeof(struct repoinfo));
</a><a href="#h13-2-4" id="h13-2-4" class="i">+					       sizeof(struct cgit_repo));
</a> 	}
 
 	ret = &amp;cgit_repolist.repos[cgit_repolist.count-1];
<a href="#h13-3" id="h13-3" class="h">@@ -120,20 +53,20 @@ struct repoinfo *add_repo(const char *url)
</a> 	ret-&gt;path = NULL;
 	ret-&gt;desc = &quot;[no description]&quot;;
 	ret-&gt;owner = NULL;
<a href="#h13-3-3" id="h13-3-3" class="d">-	ret-&gt;group = cgit_repo_group;
</a><a href="#h13-3-4" id="h13-3-4" class="i">+	ret-&gt;group = ctx.cfg.repo_group;
</a> 	ret-&gt;defbranch = &quot;master&quot;;
<a href="#h13-3-6" id="h13-3-6" class="d">-	ret-&gt;snapshots = cgit_snapshots;
</a><a href="#h13-3-7" id="h13-3-7" class="d">-	ret-&gt;enable_log_filecount = cgit_enable_log_filecount;
</a><a href="#h13-3-8" id="h13-3-8" class="d">-	ret-&gt;enable_log_linecount = cgit_enable_log_linecount;
</a><a href="#h13-3-9" id="h13-3-9" class="d">-	ret-&gt;module_link = cgit_module_link;
</a><a href="#h13-3-10" id="h13-3-10" class="i">+	ret-&gt;snapshots = ctx.cfg.snapshots;
</a><a href="#h13-3-11" id="h13-3-11" class="i">+	ret-&gt;enable_log_filecount = ctx.cfg.enable_log_filecount;
</a><a href="#h13-3-12" id="h13-3-12" class="i">+	ret-&gt;enable_log_linecount = ctx.cfg.enable_log_linecount;
</a><a href="#h13-3-13" id="h13-3-13" class="i">+	ret-&gt;module_link = ctx.cfg.module_link;
</a> 	ret-&gt;readme = NULL;
 	return ret;
 }
 
<a href="#h13-3-18" id="h13-3-18" class="d">-struct repoinfo *cgit_get_repoinfo(const char *url)
</a><a href="#h13-3-19" id="h13-3-19" class="i">+struct cgit_repo *cgit_get_repoinfo(const char *url)
</a> {
 	int i;
<a href="#h13-3-22" id="h13-3-22" class="d">-	struct repoinfo *repo;
</a><a href="#h13-3-23" id="h13-3-23" class="i">+	struct cgit_repo *repo;
</a> 
 	for (i=0; i&lt;cgit_repolist.count; i++) {
 		repo = &amp;cgit_repolist.repos[i];
<a href="#h13-4" id="h13-4" class="h">@@ -143,131 +76,6 @@ struct repoinfo *cgit_get_repoinfo(const char *url)
</a> 	return NULL;
 }
 
<a href="#h13-4-3" id="h13-4-3" class="d">-void cgit_global_config_cb(const char *name, const char *value)
</a><a href="#h13-4-4" id="h13-4-4" class="d">-{
</a><a href="#h13-4-5" id="h13-4-5" class="d">-	if (!strcmp(name, &quot;root-title&quot;))
</a><a href="#h13-4-6" id="h13-4-6" class="d">-		cgit_root_title = xstrdup(value);
</a><a href="#h13-4-7" id="h13-4-7" class="d">-	else if (!strcmp(name, &quot;css&quot;))
</a><a href="#h13-4-8" id="h13-4-8" class="d">-		cgit_css = xstrdup(value);
</a><a href="#h13-4-9" id="h13-4-9" class="d">-	else if (!strcmp(name, &quot;logo&quot;))
</a><a href="#h13-4-10" id="h13-4-10" class="d">-		cgit_logo = xstrdup(value);
</a><a href="#h13-4-11" id="h13-4-11" class="d">-	else if (!strcmp(name, &quot;index-header&quot;))
</a><a href="#h13-4-12" id="h13-4-12" class="d">-		cgit_index_header = xstrdup(value);
</a><a href="#h13-4-13" id="h13-4-13" class="d">-	else if (!strcmp(name, &quot;index-info&quot;))
</a><a href="#h13-4-14" id="h13-4-14" class="d">-		cgit_index_info = xstrdup(value);
</a><a href="#h13-4-15" id="h13-4-15" class="d">-	else if (!strcmp(name, &quot;logo-link&quot;))
</a><a href="#h13-4-16" id="h13-4-16" class="d">-		cgit_logo_link = xstrdup(value);
</a><a href="#h13-4-17" id="h13-4-17" class="d">-	else if (!strcmp(name, &quot;module-link&quot;))
</a><a href="#h13-4-18" id="h13-4-18" class="d">-		cgit_module_link = xstrdup(value);
</a><a href="#h13-4-19" id="h13-4-19" class="d">-	else if (!strcmp(name, &quot;virtual-root&quot;)) {
</a><a href="#h13-4-20" id="h13-4-20" class="d">-		cgit_virtual_root = trim_end(value, &#39;/&#39;);
</a><a href="#h13-4-21" id="h13-4-21" class="d">-		if (!cgit_virtual_root &amp;&amp; (!strcmp(value, &quot;/&quot;)))
</a><a href="#h13-4-22" id="h13-4-22" class="d">-			cgit_virtual_root = &quot;&quot;;
</a><a href="#h13-4-23" id="h13-4-23" class="d">-	} else if (!strcmp(name, &quot;nocache&quot;))
</a><a href="#h13-4-24" id="h13-4-24" class="d">-		cgit_nocache = atoi(value);
</a><a href="#h13-4-25" id="h13-4-25" class="d">-	else if (!strcmp(name, &quot;snapshots&quot;))
</a><a href="#h13-4-26" id="h13-4-26" class="d">-		cgit_snapshots = cgit_parse_snapshots_mask(value);
</a><a href="#h13-4-27" id="h13-4-27" class="d">-	else if (!strcmp(name, &quot;enable-index-links&quot;))
</a><a href="#h13-4-28" id="h13-4-28" class="d">-		cgit_enable_index_links = atoi(value);
</a><a href="#h13-4-29" id="h13-4-29" class="d">-	else if (!strcmp(name, &quot;enable-log-filecount&quot;))
</a><a href="#h13-4-30" id="h13-4-30" class="d">-		cgit_enable_log_filecount = atoi(value);
</a><a href="#h13-4-31" id="h13-4-31" class="d">-	else if (!strcmp(name, &quot;enable-log-linecount&quot;))
</a><a href="#h13-4-32" id="h13-4-32" class="d">-		cgit_enable_log_linecount = atoi(value);
</a><a href="#h13-4-33" id="h13-4-33" class="d">-	else if (!strcmp(name, &quot;cache-root&quot;))
</a><a href="#h13-4-34" id="h13-4-34" class="d">-		cgit_cache_root = xstrdup(value);
</a><a href="#h13-4-35" id="h13-4-35" class="d">-	else if (!strcmp(name, &quot;cache-root-ttl&quot;))
</a><a href="#h13-4-36" id="h13-4-36" class="d">-		cgit_cache_root_ttl = atoi(value);
</a><a href="#h13-4-37" id="h13-4-37" class="d">-	else if (!strcmp(name, &quot;cache-repo-ttl&quot;))
</a><a href="#h13-4-38" id="h13-4-38" class="d">-		cgit_cache_repo_ttl = atoi(value);
</a><a href="#h13-4-39" id="h13-4-39" class="d">-	else if (!strcmp(name, &quot;cache-static-ttl&quot;))
</a><a href="#h13-4-40" id="h13-4-40" class="d">-		cgit_cache_static_ttl = atoi(value);
</a><a href="#h13-4-41" id="h13-4-41" class="d">-	else if (!strcmp(name, &quot;cache-dynamic-ttl&quot;))
</a><a href="#h13-4-42" id="h13-4-42" class="d">-		cgit_cache_dynamic_ttl = atoi(value);
</a><a href="#h13-4-43" id="h13-4-43" class="d">-	else if (!strcmp(name, &quot;max-message-length&quot;))
</a><a href="#h13-4-44" id="h13-4-44" class="d">-		cgit_max_msg_len = atoi(value);
</a><a href="#h13-4-45" id="h13-4-45" class="d">-	else if (!strcmp(name, &quot;max-repodesc-length&quot;))
</a><a href="#h13-4-46" id="h13-4-46" class="d">-		cgit_max_repodesc_len = atoi(value);
</a><a href="#h13-4-47" id="h13-4-47" class="d">-	else if (!strcmp(name, &quot;max-commit-count&quot;))
</a><a href="#h13-4-48" id="h13-4-48" class="d">-		cgit_max_commit_count = atoi(value);
</a><a href="#h13-4-49" id="h13-4-49" class="d">-	else if (!strcmp(name, &quot;summary-log&quot;))
</a><a href="#h13-4-50" id="h13-4-50" class="d">-		cgit_summary_log = atoi(value);
</a><a href="#h13-4-51" id="h13-4-51" class="d">-	else if (!strcmp(name, &quot;summary-branches&quot;))
</a><a href="#h13-4-52" id="h13-4-52" class="d">-		cgit_summary_branches = atoi(value);
</a><a href="#h13-4-53" id="h13-4-53" class="d">-	else if (!strcmp(name, &quot;summary-tags&quot;))
</a><a href="#h13-4-54" id="h13-4-54" class="d">-		cgit_summary_tags = atoi(value);
</a><a href="#h13-4-55" id="h13-4-55" class="d">-	else if (!strcmp(name, &quot;agefile&quot;))
</a><a href="#h13-4-56" id="h13-4-56" class="d">-		cgit_agefile = xstrdup(value);
</a><a href="#h13-4-57" id="h13-4-57" class="d">-	else if (!strcmp(name, &quot;renamelimit&quot;))
</a><a href="#h13-4-58" id="h13-4-58" class="d">-		cgit_renamelimit = atoi(value);
</a><a href="#h13-4-59" id="h13-4-59" class="d">-	else if (!strcmp(name, &quot;robots&quot;))
</a><a href="#h13-4-60" id="h13-4-60" class="d">-		cgit_robots = xstrdup(value);
</a><a href="#h13-4-61" id="h13-4-61" class="d">-	else if (!strcmp(name, &quot;clone-prefix&quot;))
</a><a href="#h13-4-62" id="h13-4-62" class="d">-		cgit_clone_prefix = xstrdup(value);
</a><a href="#h13-4-63" id="h13-4-63" class="d">-	else if (!strcmp(name, &quot;repo.group&quot;))
</a><a href="#h13-4-64" id="h13-4-64" class="d">-		cgit_repo_group = xstrdup(value);
</a><a href="#h13-4-65" id="h13-4-65" class="d">-	else if (!strcmp(name, &quot;repo.url&quot;))
</a><a href="#h13-4-66" id="h13-4-66" class="d">-		cgit_repo = add_repo(value);
</a><a href="#h13-4-67" id="h13-4-67" class="d">-	else if (!strcmp(name, &quot;repo.name&quot;))
</a><a href="#h13-4-68" id="h13-4-68" class="d">-		cgit_repo-&gt;name = xstrdup(value);
</a><a href="#h13-4-69" id="h13-4-69" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.path&quot;))
</a><a href="#h13-4-70" id="h13-4-70" class="d">-		cgit_repo-&gt;path = trim_end(value, &#39;/&#39;);
</a><a href="#h13-4-71" id="h13-4-71" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.clone-url&quot;))
</a><a href="#h13-4-72" id="h13-4-72" class="d">-		cgit_repo-&gt;clone_url = xstrdup(value);
</a><a href="#h13-4-73" id="h13-4-73" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.desc&quot;))
</a><a href="#h13-4-74" id="h13-4-74" class="d">-		cgit_repo-&gt;desc = xstrdup(value);
</a><a href="#h13-4-75" id="h13-4-75" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.owner&quot;))
</a><a href="#h13-4-76" id="h13-4-76" class="d">-		cgit_repo-&gt;owner = xstrdup(value);
</a><a href="#h13-4-77" id="h13-4-77" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.defbranch&quot;))
</a><a href="#h13-4-78" id="h13-4-78" class="d">-		cgit_repo-&gt;defbranch = xstrdup(value);
</a><a href="#h13-4-79" id="h13-4-79" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.snapshots&quot;))
</a><a href="#h13-4-80" id="h13-4-80" class="d">-		cgit_repo-&gt;snapshots = cgit_snapshots &amp; cgit_parse_snapshots_mask(value); /* XXX: &amp;? */
</a><a href="#h13-4-81" id="h13-4-81" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.enable-log-filecount&quot;))
</a><a href="#h13-4-82" id="h13-4-82" class="d">-		cgit_repo-&gt;enable_log_filecount = cgit_enable_log_filecount * atoi(value);
</a><a href="#h13-4-83" id="h13-4-83" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.enable-log-linecount&quot;))
</a><a href="#h13-4-84" id="h13-4-84" class="d">-		cgit_repo-&gt;enable_log_linecount = cgit_enable_log_linecount * atoi(value);
</a><a href="#h13-4-85" id="h13-4-85" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.module-link&quot;))
</a><a href="#h13-4-86" id="h13-4-86" class="d">-		cgit_repo-&gt;module_link= xstrdup(value);
</a><a href="#h13-4-87" id="h13-4-87" class="d">-	else if (cgit_repo &amp;&amp; !strcmp(name, &quot;repo.readme&quot;) &amp;&amp; value != NULL) {
</a><a href="#h13-4-88" id="h13-4-88" class="d">-		if (*value == &#39;/&#39;)
</a><a href="#h13-4-89" id="h13-4-89" class="d">-			cgit_repo-&gt;readme = xstrdup(value);
</a><a href="#h13-4-90" id="h13-4-90" class="d">-		else
</a><a href="#h13-4-91" id="h13-4-91" class="d">-			cgit_repo-&gt;readme = xstrdup(fmt(&quot;%s/%s&quot;, cgit_repo-&gt;path, value));
</a><a href="#h13-4-92" id="h13-4-92" class="d">-	} else if (!strcmp(name, &quot;include&quot;))
</a><a href="#h13-4-93" id="h13-4-93" class="d">-		cgit_read_config(value, cgit_global_config_cb);
</a><a href="#h13-4-94" id="h13-4-94" class="d">-}
</a><a href="#h13-4-95" id="h13-4-95" class="d">-
</a><a href="#h13-4-96" id="h13-4-96" class="d">-void cgit_querystring_cb(const char *name, const char *value)
</a><a href="#h13-4-97" id="h13-4-97" class="d">-{
</a><a href="#h13-4-98" id="h13-4-98" class="d">-	if (!strcmp(name,&quot;r&quot;)) {
</a><a href="#h13-4-99" id="h13-4-99" class="d">-		cgit_query_repo = xstrdup(value);
</a><a href="#h13-4-100" id="h13-4-100" class="d">-		cgit_repo = cgit_get_repoinfo(value);
</a><a href="#h13-4-101" id="h13-4-101" class="d">-	} else if (!strcmp(name, &quot;p&quot;)) {
</a><a href="#h13-4-102" id="h13-4-102" class="d">-		cgit_query_page = xstrdup(value);
</a><a href="#h13-4-103" id="h13-4-103" class="d">-		cgit_cmd = cgit_get_cmd_index(value);
</a><a href="#h13-4-104" id="h13-4-104" class="d">-	} else if (!strcmp(name, &quot;url&quot;)) {
</a><a href="#h13-4-105" id="h13-4-105" class="d">-		cgit_parse_url(value);
</a><a href="#h13-4-106" id="h13-4-106" class="d">-	} else if (!strcmp(name, &quot;qt&quot;)) {
</a><a href="#h13-4-107" id="h13-4-107" class="d">-		cgit_query_grep = xstrdup(value);
</a><a href="#h13-4-108" id="h13-4-108" class="d">-	} else if (!strcmp(name, &quot;q&quot;)) {
</a><a href="#h13-4-109" id="h13-4-109" class="d">-		cgit_query_search = xstrdup(value);
</a><a href="#h13-4-110" id="h13-4-110" class="d">-	} else if (!strcmp(name, &quot;h&quot;)) {
</a><a href="#h13-4-111" id="h13-4-111" class="d">-		cgit_query_head = xstrdup(value);
</a><a href="#h13-4-112" id="h13-4-112" class="d">-		cgit_query_has_symref = 1;
</a><a href="#h13-4-113" id="h13-4-113" class="d">-	} else if (!strcmp(name, &quot;id&quot;)) {
</a><a href="#h13-4-114" id="h13-4-114" class="d">-		cgit_query_sha1 = xstrdup(value);
</a><a href="#h13-4-115" id="h13-4-115" class="d">-		cgit_query_has_sha1 = 1;
</a><a href="#h13-4-116" id="h13-4-116" class="d">-	} else if (!strcmp(name, &quot;id2&quot;)) {
</a><a href="#h13-4-117" id="h13-4-117" class="d">-		cgit_query_sha2 = xstrdup(value);
</a><a href="#h13-4-118" id="h13-4-118" class="d">-		cgit_query_has_sha1 = 1;
</a><a href="#h13-4-119" id="h13-4-119" class="d">-	} else if (!strcmp(name, &quot;ofs&quot;)) {
</a><a href="#h13-4-120" id="h13-4-120" class="d">-		cgit_query_ofs = atoi(value);
</a><a href="#h13-4-121" id="h13-4-121" class="d">-	} else if (!strcmp(name, &quot;path&quot;)) {
</a><a href="#h13-4-122" id="h13-4-122" class="d">-		cgit_query_path = trim_end(value, &#39;/&#39;);
</a><a href="#h13-4-123" id="h13-4-123" class="d">-	} else if (!strcmp(name, &quot;name&quot;)) {
</a><a href="#h13-4-124" id="h13-4-124" class="d">-		cgit_query_name = xstrdup(value);
</a><a href="#h13-4-125" id="h13-4-125" class="d">-	}
</a><a href="#h13-4-126" id="h13-4-126" class="d">-}
</a><a href="#h13-4-127" id="h13-4-127" class="d">-
</a> void *cgit_free_commitinfo(struct commitinfo *info)
 {
 	free(info-&gt;author);
<a href="#h13-5" id="h13-5" class="h">@@ -281,18 +89,6 @@ void *cgit_free_commitinfo(struct commitinfo *info)
</a> 	return NULL;
 }
 
<a href="#h13-5-3" id="h13-5-3" class="d">-int hextoint(char c)
</a><a href="#h13-5-4" id="h13-5-4" class="d">-{
</a><a href="#h13-5-5" id="h13-5-5" class="d">-	if (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;f&#39;)
</a><a href="#h13-5-6" id="h13-5-6" class="d">-		return 10 + c - &#39;a&#39;;
</a><a href="#h13-5-7" id="h13-5-7" class="d">-	else if (c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;F&#39;)
</a><a href="#h13-5-8" id="h13-5-8" class="d">-		return 10 + c - &#39;A&#39;;
</a><a href="#h13-5-9" id="h13-5-9" class="d">-	else if (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;)
</a><a href="#h13-5-10" id="h13-5-10" class="d">-		return c - &#39;0&#39;;
</a><a href="#h13-5-11" id="h13-5-11" class="d">-	else
</a><a href="#h13-5-12" id="h13-5-12" class="d">-		return -1;
</a><a href="#h13-5-13" id="h13-5-13" class="d">-}
</a><a href="#h13-5-14" id="h13-5-14" class="d">-
</a> char *trim_end(const char *str, char c)
 {
 	int len;
<a href="#h13-6" id="h13-6" class="h">@@ -491,7 +287,7 @@ void cgit_diff_tree(const unsigned char *old_sha1,
</a> 	diff_setup(&amp;opt);
 	opt.output_format = DIFF_FORMAT_CALLBACK;
 	opt.detect_rename = 1;
<a href="#h13-6-3" id="h13-6-3" class="d">-	opt.rename_limit = cgit_renamelimit;
</a><a href="#h13-6-4" id="h13-6-4" class="i">+	opt.rename_limit = ctx.cfg.renamelimit;
</a> 	DIFF_OPT_SET(&amp;opt, RECURSIVE);
 	opt.format_callback = cgit_diff_tree_cb;
 	opt.format_callback_data = fn;
<a href="#h13-7" id="h13-7" class="h">@@ -519,3 +315,30 @@ void cgit_diff_commit(struct commit *commit, filepair_fn fn)
</a> 		old_sha1 = commit-&gt;parents-&gt;item-&gt;object.sha1;
 	cgit_diff_tree(old_sha1, commit-&gt;object.sha1, fn, NULL);
 }
<a href="#h13-7-3" id="h13-7-3" class="i">+
</a><a href="#h13-7-4" id="h13-7-4" class="i">+int cgit_parse_snapshots_mask(const char *str)
</a><a href="#h13-7-5" id="h13-7-5" class="i">+{
</a><a href="#h13-7-6" id="h13-7-6" class="i">+	const struct cgit_snapshot_format *f;
</a><a href="#h13-7-7" id="h13-7-7" class="i">+	static const char *delim = &quot; \t,:/|;&quot;;
</a><a href="#h13-7-8" id="h13-7-8" class="i">+	int tl, sl, rv = 0;
</a><a href="#h13-7-9" id="h13-7-9" class="i">+
</a><a href="#h13-7-10" id="h13-7-10" class="i">+	/* favor legacy setting */
</a><a href="#h13-7-11" id="h13-7-11" class="i">+	if(atoi(str))
</a><a href="#h13-7-12" id="h13-7-12" class="i">+		return 1;
</a><a href="#h13-7-13" id="h13-7-13" class="i">+	for(;;) {
</a><a href="#h13-7-14" id="h13-7-14" class="i">+		str += strspn(str,delim);
</a><a href="#h13-7-15" id="h13-7-15" class="i">+		tl = strcspn(str,delim);
</a><a href="#h13-7-16" id="h13-7-16" class="i">+		if (!tl)
</a><a href="#h13-7-17" id="h13-7-17" class="i">+			break;
</a><a href="#h13-7-18" id="h13-7-18" class="i">+		for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
</a><a href="#h13-7-19" id="h13-7-19" class="i">+			sl = strlen(f-&gt;suffix);
</a><a href="#h13-7-20" id="h13-7-20" class="i">+			if((tl == sl &amp;&amp; !strncmp(f-&gt;suffix, str, tl)) ||
</a><a href="#h13-7-21" id="h13-7-21" class="i">+			   (tl == sl-1 &amp;&amp; !strncmp(f-&gt;suffix+1, str, tl-1))) {
</a><a href="#h13-7-22" id="h13-7-22" class="i">+				rv |= f-&gt;bit;
</a><a href="#h13-7-23" id="h13-7-23" class="i">+				break;
</a><a href="#h13-7-24" id="h13-7-24" class="i">+			}
</a><a href="#h13-7-25" id="h13-7-25" class="i">+		}
</a><a href="#h13-7-26" id="h13-7-26" class="i">+		str += tl;
</a><a href="#h13-7-27" id="h13-7-27" class="i">+	}
</a><a href="#h13-7-28" id="h13-7-28" class="i">+	return rv;
</a><a href="#h13-7-29" id="h13-7-29" class="i">+}
</a><b>diff --git a/<a id="h14" href="../file/ui-blob.c.html">ui-blob.c</a> b/<a href="../file/ui-blob.c.html">ui-blob.c</a></b>
<a href="#h14-0" id="h14-0" class="h">@@ -1,6 +1,16 @@
</a><a href="#h14-0-0" id="h14-0-0" class="i">+/* ui-blob.c: show blob content
</a><a href="#h14-0-1" id="h14-0-1" class="i">+ *
</a><a href="#h14-0-2" id="h14-0-2" class="i">+ * Copyright (C) 2008 Lars Hjemli
</a><a href="#h14-0-3" id="h14-0-3" class="i">+ *
</a><a href="#h14-0-4" id="h14-0-4" class="i">+ * Licensed under GNU General Public License v2
</a><a href="#h14-0-5" id="h14-0-5" class="i">+ *   (see COPYING for full license text)
</a><a href="#h14-0-6" id="h14-0-6" class="i">+ */
</a><a href="#h14-0-7" id="h14-0-7" class="i">+
</a> #include &quot;cgit.h&quot;
<a href="#h14-0-9" id="h14-0-9" class="i">+#include &quot;html.h&quot;
</a><a href="#h14-0-10" id="h14-0-10" class="i">+#include &quot;ui-shared.h&quot;
</a> 
<a href="#h14-0-12" id="h14-0-12" class="d">-void cgit_print_blob(struct cacheitem *item, const char *hex, char *path)
</a><a href="#h14-0-13" id="h14-0-13" class="i">+void cgit_print_blob(const char *hex, char *path)
</a> {
 
 	unsigned char sha1[20];
<a href="#h14-1" id="h14-1" class="h">@@ -26,6 +36,8 @@ void cgit_print_blob(struct cacheitem *item, const char *hex, char *path)
</a> 	}
 
 	buf[size] = &#39;\0&#39;;
<a href="#h14-1-3" id="h14-1-3" class="d">-	cgit_print_snapshot_start(&quot;text/plain&quot;, path, item);
</a><a href="#h14-1-4" id="h14-1-4" class="i">+	ctx.page.mimetype = &quot;text/plain&quot;;
</a><a href="#h14-1-5" id="h14-1-5" class="i">+	ctx.page.filename = path;
</a><a href="#h14-1-6" id="h14-1-6" class="i">+	cgit_print_http_headers(&amp;ctx);
</a> 	write(htmlfd, buf, size);
 }
<b>diff --git a/<a id="h15" href="../file/ui-blob.h.html">ui-blob.h</a> b/<a href="../file/ui-blob.h.html">ui-blob.h</a></b>
<a href="#h15-0" id="h15-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h15-0-0" id="h15-0-0" class="i">+#ifndef UI_BLOB_H
</a><a href="#h15-0-1" id="h15-0-1" class="i">+#define UI_BLOB_H
</a><a href="#h15-0-2" id="h15-0-2" class="i">+
</a><a href="#h15-0-3" id="h15-0-3" class="i">+extern void cgit_print_blob(const char *hex, char *path);
</a><a href="#h15-0-4" id="h15-0-4" class="i">+
</a><a href="#h15-0-5" id="h15-0-5" class="i">+#endif /* UI_BLOB_H */
</a><b>diff --git a/<a id="h16" href="../file/ui-commit.c.html">ui-commit.c</a> b/<a href="../file/ui-commit.c.html">ui-commit.c</a></b>
<a href="#h16-0" id="h16-0" class="h">@@ -7,6 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h16-0-3" id="h16-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h16-0-4" id="h16-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 static int files, slots;
 static int total_adds, total_rems, max_changes;
<a href="#h16-1" id="h16-1" class="h">@@ -62,20 +64,20 @@ void print_fileinfo(struct fileinfo *info)
</a> 	html(&quot;&lt;tr&gt;&quot;);
 	htmlf(&quot;&lt;td class=&#39;mode&#39;&gt;&quot;);
 	if (is_null_sha1(info-&gt;new_sha1)) {
<a href="#h16-1-3" id="h16-1-3" class="d">-		html_filemode(info-&gt;old_mode);
</a><a href="#h16-1-4" id="h16-1-4" class="i">+		cgit_print_filemode(info-&gt;old_mode);
</a> 	} else {
<a href="#h16-1-6" id="h16-1-6" class="d">-		html_filemode(info-&gt;new_mode);
</a><a href="#h16-1-7" id="h16-1-7" class="i">+		cgit_print_filemode(info-&gt;new_mode);
</a> 	}
 
 	if (info-&gt;old_mode != info-&gt;new_mode &amp;&amp;
 	    !is_null_sha1(info-&gt;old_sha1) &amp;&amp;
 	    !is_null_sha1(info-&gt;new_sha1)) {
 		html(&quot;&lt;span class=&#39;modechange&#39;&gt;[&quot;);
<a href="#h16-1-14" id="h16-1-14" class="d">-		html_filemode(info-&gt;old_mode);
</a><a href="#h16-1-15" id="h16-1-15" class="i">+		cgit_print_filemode(info-&gt;old_mode);
</a> 		html(&quot;]&lt;/span&gt;&quot;);
 	}
 	htmlf(&quot;&lt;/td&gt;&lt;td class=&#39;%s&#39;&gt;&quot;, class);
<a href="#h16-1-19" id="h16-1-19" class="d">-	cgit_diff_link(info-&gt;new_path, NULL, NULL, cgit_query_head, curr_rev,
</a><a href="#h16-1-20" id="h16-1-20" class="i">+	cgit_diff_link(info-&gt;new_path, NULL, NULL, ctx.qry.head, curr_rev,
</a> 		       NULL, info-&gt;new_path);
 	if (info-&gt;status == DIFF_STATUS_COPIED || info-&gt;status == DIFF_STATUS_RENAMED)
 		htmlf(&quot; (%s from %s)&quot;,
<a href="#h16-2" id="h16-2" class="h">@@ -143,7 +145,7 @@ void cgit_print_commit(char *hex)
</a> 	int i;
 
 	if (!hex)
<a href="#h16-2-3" id="h16-2-3" class="d">-		hex = cgit_query_head;
</a><a href="#h16-2-4" id="h16-2-4" class="i">+		hex = ctx.qry.head;
</a> 	curr_rev = hex;
 
 	if (get_sha1(hex, sha1)) {
<a href="#h16-3" id="h16-3" class="h">@@ -175,7 +177,7 @@ void cgit_print_commit(char *hex)
</a> 	html(&quot;&lt;tr&gt;&lt;th&gt;tree&lt;/th&gt;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
 	tmp = xstrdup(hex);
 	cgit_tree_link(sha1_to_hex(commit-&gt;tree-&gt;object.sha1), NULL, NULL,
<a href="#h16-3-3" id="h16-3-3" class="d">-		       cgit_query_head, tmp, NULL);
</a><a href="#h16-3-4" id="h16-3-4" class="i">+		       ctx.qry.head, tmp, NULL);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
       	for (p = commit-&gt;parents; p ; p = p-&gt;next) {
 		parent = lookup_commit_reference(p-&gt;item-&gt;object.sha1);
<a href="#h16-4" id="h16-4" class="h">@@ -188,16 +190,16 @@ void cgit_print_commit(char *hex)
</a> 		html(&quot;&lt;tr&gt;&lt;th&gt;parent&lt;/th&gt;&quot;
 		     &quot;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
 		cgit_commit_link(sha1_to_hex(p-&gt;item-&gt;object.sha1), NULL, NULL,
<a href="#h16-4-3" id="h16-4-3" class="d">-				 cgit_query_head, sha1_to_hex(p-&gt;item-&gt;object.sha1));
</a><a href="#h16-4-4" id="h16-4-4" class="i">+				 ctx.qry.head, sha1_to_hex(p-&gt;item-&gt;object.sha1));
</a> 		html(&quot; (&quot;);
<a href="#h16-4-6" id="h16-4-6" class="d">-		cgit_diff_link(&quot;diff&quot;, NULL, NULL, cgit_query_head, hex,
</a><a href="#h16-4-7" id="h16-4-7" class="i">+		cgit_diff_link(&quot;diff&quot;, NULL, NULL, ctx.qry.head, hex,
</a> 			       sha1_to_hex(p-&gt;item-&gt;object.sha1), NULL);
 		html(&quot;)&lt;/td&gt;&lt;/tr&gt;&quot;);
 	}
<a href="#h16-4-11" id="h16-4-11" class="d">-	if (cgit_repo-&gt;snapshots) {
</a><a href="#h16-4-12" id="h16-4-12" class="i">+	if (ctx.repo-&gt;snapshots) {
</a> 		html(&quot;&lt;tr&gt;&lt;th&gt;download&lt;/th&gt;&lt;td colspan=&#39;2&#39; class=&#39;sha1&#39;&gt;&quot;);
<a href="#h16-4-14" id="h16-4-14" class="d">-		cgit_print_snapshot_links(cgit_query_repo, cgit_query_head,
</a><a href="#h16-4-15" id="h16-4-15" class="d">-					  hex, cgit_repo-&gt;snapshots);
</a><a href="#h16-4-16" id="h16-4-16" class="i">+		cgit_print_snapshot_links(ctx.qry.repo, ctx.qry.head,
</a><a href="#h16-4-17" id="h16-4-17" class="i">+					  hex, ctx.repo-&gt;snapshots);
</a> 		html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
 	}
 	html(&quot;&lt;/table&gt;\n&quot;);
<a href="#h16-5" id="h16-5" class="h">@@ -218,7 +220,7 @@ void cgit_print_commit(char *hex)
</a> 		html(&quot;&lt;div class=&#39;diffstat-summary&#39;&gt;&quot;);
 		htmlf(&quot;%d files changed, %d insertions, %d deletions (&quot;,
 		      files, total_adds, total_rems);
<a href="#h16-5-3" id="h16-5-3" class="d">-		cgit_diff_link(&quot;show diff&quot;, NULL, NULL, cgit_query_head, hex,
</a><a href="#h16-5-4" id="h16-5-4" class="i">+		cgit_diff_link(&quot;show diff&quot;, NULL, NULL, ctx.qry.head, hex,
</a> 			       NULL, NULL);
 		html(&quot;)&lt;/div&gt;&quot;);
 	}
<b>diff --git a/<a id="h17" href="../file/ui-commit.h.html">ui-commit.h</a> b/<a href="../file/ui-commit.h.html">ui-commit.h</a></b>
<a href="#h17-0" id="h17-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h17-0-0" id="h17-0-0" class="i">+#ifndef UI_COMMIT_H
</a><a href="#h17-0-1" id="h17-0-1" class="i">+#define UI_COMMIT_H
</a><a href="#h17-0-2" id="h17-0-2" class="i">+
</a><a href="#h17-0-3" id="h17-0-3" class="i">+extern void cgit_print_commit(char *hex);
</a><a href="#h17-0-4" id="h17-0-4" class="i">+
</a><a href="#h17-0-5" id="h17-0-5" class="i">+#endif /* UI_COMMIT_H */
</a><b>diff --git a/<a id="h18" href="../file/ui-diff.c.html">ui-diff.c</a> b/<a href="../file/ui-diff.c.html">ui-diff.c</a></b>
<a href="#h18-0" id="h18-0" class="h">@@ -7,7 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h18-0-3" id="h18-0-3" class="d">-
</a><a href="#h18-0-4" id="h18-0-4" class="i">+#include &quot;html.h&quot;
</a><a href="#h18-0-5" id="h18-0-5" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 unsigned char old_rev_sha1[20];
 unsigned char new_rev_sha1[20];
<a href="#h18-1" id="h18-1" class="h">@@ -71,13 +72,13 @@ static void header(unsigned char *sha1, char *path1, int mode1,
</a> 		}
 		html(&quot;&lt;br/&gt;--- a/&quot;);
 		if (mode1 != 0)
<a href="#h18-1-3" id="h18-1-3" class="d">-			cgit_tree_link(path1, NULL, NULL, cgit_query_head,
</a><a href="#h18-1-4" id="h18-1-4" class="i">+			cgit_tree_link(path1, NULL, NULL, ctx.qry.head,
</a> 				       sha1_to_hex(old_rev_sha1), path1);
 		else
 			html_txt(path1);
 		html(&quot;&lt;br/&gt;+++ b/&quot;);
 		if (mode2 != 0)
<a href="#h18-1-10" id="h18-1-10" class="d">-			cgit_tree_link(path2, NULL, NULL, cgit_query_head,
</a><a href="#h18-1-11" id="h18-1-11" class="i">+			cgit_tree_link(path2, NULL, NULL, ctx.qry.head,
</a> 				       sha1_to_hex(new_rev_sha1), path2);
 		else
 			html_txt(path2);
<a href="#h18-2" id="h18-2" class="h">@@ -107,7 +108,7 @@ void cgit_print_diff(const char *new_rev, const char *old_rev, const char *prefi
</a> 	struct commit *commit, *commit2;
 
 	if (!new_rev)
<a href="#h18-2-3" id="h18-2-3" class="d">-		new_rev = cgit_query_head;
</a><a href="#h18-2-4" id="h18-2-4" class="i">+		new_rev = ctx.qry.head;
</a> 	get_sha1(new_rev, new_rev_sha1);
 	type = sha1_object_info(new_rev_sha1, &amp;size);
 	if (type == OBJ_BAD) {
<b>diff --git a/<a id="h19" href="../file/ui-diff.h.html">ui-diff.h</a> b/<a href="../file/ui-diff.h.html">ui-diff.h</a></b>
<a href="#h19-0" id="h19-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h19-0-0" id="h19-0-0" class="i">+#ifndef UI_DIFF_H
</a><a href="#h19-0-1" id="h19-0-1" class="i">+#define UI_DIFF_H
</a><a href="#h19-0-2" id="h19-0-2" class="i">+
</a><a href="#h19-0-3" id="h19-0-3" class="i">+extern void cgit_print_diff(const char *new_hex, const char *old_hex,
</a><a href="#h19-0-4" id="h19-0-4" class="i">+			    const char *prefix);
</a><a href="#h19-0-5" id="h19-0-5" class="i">+
</a><a href="#h19-0-6" id="h19-0-6" class="i">+#endif /* UI_DIFF_H */
</a><b>diff --git a/<a id="h20" href="../file/ui-log.c.html">ui-log.c</a> b/<a href="../file/ui-log.c.html">ui-log.c</a></b>
<a href="#h20-0" id="h20-0" class="h">@@ -7,6 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h20-0-3" id="h20-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h20-0-4" id="h20-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 int files, add_lines, rem_lines;
 
<a href="#h20-1" id="h20-1" class="h">@@ -25,7 +27,7 @@ void count_lines(char *line, int size)
</a> void inspect_files(struct diff_filepair *pair)
 {
 	files++;
<a href="#h20-1-3" id="h20-1-3" class="d">-	if (cgit_repo-&gt;enable_log_linecount)
</a><a href="#h20-1-4" id="h20-1-4" class="i">+	if (ctx.repo-&gt;enable_log_linecount)
</a> 		cgit_diff_files(pair-&gt;one-&gt;sha1, pair-&gt;two-&gt;sha1, count_lines);
 }
 
<a href="#h20-2" id="h20-2" class="h">@@ -37,16 +39,16 @@ void print_commit(struct commit *commit)
</a> 	html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
 	cgit_print_age(commit-&gt;date, TM_WEEK * 2, FMT_SHORTDATE);
 	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h20-2-3" id="h20-2-3" class="d">-	cgit_commit_link(info-&gt;subject, NULL, NULL, cgit_query_head,
</a><a href="#h20-2-4" id="h20-2-4" class="i">+	cgit_commit_link(info-&gt;subject, NULL, NULL, ctx.qry.head,
</a> 			 sha1_to_hex(commit-&gt;object.sha1));
<a href="#h20-2-6" id="h20-2-6" class="d">-	if (cgit_repo-&gt;enable_log_filecount) {
</a><a href="#h20-2-7" id="h20-2-7" class="i">+	if (ctx.repo-&gt;enable_log_filecount) {
</a> 		files = 0;
 		add_lines = 0;
 		rem_lines = 0;
 		cgit_diff_commit(commit, inspect_files);
 		html(&quot;&lt;/td&gt;&lt;td class=&#39;right&#39;&gt;&quot;);
 		htmlf(&quot;%d&quot;, files);
<a href="#h20-2-14" id="h20-2-14" class="d">-		if (cgit_repo-&gt;enable_log_linecount) {
</a><a href="#h20-2-15" id="h20-2-15" class="i">+		if (ctx.repo-&gt;enable_log_linecount) {
</a> 			html(&quot;&lt;/td&gt;&lt;td class=&#39;right&#39;&gt;&quot;);
 			htmlf(&quot;-%d/+%d&quot;, rem_lines, add_lines);
 		}
<a href="#h20-3" id="h20-3" class="h">@@ -67,7 +69,7 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	int i;
 
 	if (!tip)
<a href="#h20-3-3" id="h20-3-3" class="d">-		argv[1] = cgit_query_head;
</a><a href="#h20-3-4" id="h20-3-4" class="i">+		argv[1] = ctx.qry.head;
</a> 
 	if (grep &amp;&amp; pattern &amp;&amp; (!strcmp(grep, &quot;grep&quot;) ||
 				!strcmp(grep, &quot;author&quot;) ||
<a href="#h20-4" id="h20-4" class="h">@@ -94,9 +96,9 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Age&lt;/th&gt;&quot;
 	     &quot;&lt;th class=&#39;left&#39;&gt;Message&lt;/th&gt;&quot;);
 
<a href="#h20-4-3" id="h20-4-3" class="d">-	if (cgit_repo-&gt;enable_log_filecount) {
</a><a href="#h20-4-4" id="h20-4-4" class="i">+	if (ctx.repo-&gt;enable_log_filecount) {
</a> 		html(&quot;&lt;th class=&#39;right&#39;&gt;Files&lt;/th&gt;&quot;);
<a href="#h20-4-6" id="h20-4-6" class="d">-		if (cgit_repo-&gt;enable_log_linecount)
</a><a href="#h20-4-7" id="h20-4-7" class="i">+		if (ctx.repo-&gt;enable_log_linecount)
</a> 			html(&quot;&lt;th class=&#39;right&#39;&gt;Lines&lt;/th&gt;&quot;);
 	}
 	html(&quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&lt;/tr&gt;\n&quot;);
<a href="#h20-5" id="h20-5" class="h">@@ -123,17 +125,17 @@ void cgit_print_log(const char *tip, int ofs, int cnt, char *grep, char *pattern
</a> 	if (pager) {
 		html(&quot;&lt;div class=&#39;pager&#39;&gt;&quot;);
 		if (ofs &gt; 0) {
<a href="#h20-5-3" id="h20-5-3" class="d">-			cgit_log_link(&quot;[prev]&quot;, NULL, NULL, cgit_query_head,
</a><a href="#h20-5-4" id="h20-5-4" class="d">-				      cgit_query_sha1, cgit_query_path,
</a><a href="#h20-5-5" id="h20-5-5" class="d">-				      ofs - cnt, cgit_query_grep,
</a><a href="#h20-5-6" id="h20-5-6" class="d">-				      cgit_query_search);
</a><a href="#h20-5-7" id="h20-5-7" class="i">+			cgit_log_link(&quot;[prev]&quot;, NULL, NULL, ctx.qry.head,
</a><a href="#h20-5-8" id="h20-5-8" class="i">+				      ctx.qry.sha1, ctx.qry.path,
</a><a href="#h20-5-9" id="h20-5-9" class="i">+				      ofs - cnt, ctx.qry.grep,
</a><a href="#h20-5-10" id="h20-5-10" class="i">+				      ctx.qry.search);
</a> 			html(&quot;&amp;nbsp;&quot;);
 		}
 		if ((commit = get_revision(&amp;rev)) != NULL) {
<a href="#h20-5-14" id="h20-5-14" class="d">-			cgit_log_link(&quot;[next]&quot;, NULL, NULL, cgit_query_head,
</a><a href="#h20-5-15" id="h20-5-15" class="d">-				      cgit_query_sha1, cgit_query_path,
</a><a href="#h20-5-16" id="h20-5-16" class="d">-				      ofs + cnt, cgit_query_grep,
</a><a href="#h20-5-17" id="h20-5-17" class="d">-				      cgit_query_search);
</a><a href="#h20-5-18" id="h20-5-18" class="i">+			cgit_log_link(&quot;[next]&quot;, NULL, NULL, ctx.qry.head,
</a><a href="#h20-5-19" id="h20-5-19" class="i">+				      ctx.qry.sha1, ctx.qry.path,
</a><a href="#h20-5-20" id="h20-5-20" class="i">+				      ofs + cnt, ctx.qry.grep,
</a><a href="#h20-5-21" id="h20-5-21" class="i">+				      ctx.qry.search);
</a> 		}
 		html(&quot;&lt;/div&gt;&quot;);
 	}
<b>diff --git a/<a id="h21" href="../file/ui-log.h.html">ui-log.h</a> b/<a href="../file/ui-log.h.html">ui-log.h</a></b>
<a href="#h21-0" id="h21-0" class="h">@@ -0,0 +1,7 @@
</a><a href="#h21-0-0" id="h21-0-0" class="i">+#ifndef UI_LOG_H
</a><a href="#h21-0-1" id="h21-0-1" class="i">+#define UI_LOG_H
</a><a href="#h21-0-2" id="h21-0-2" class="i">+
</a><a href="#h21-0-3" id="h21-0-3" class="i">+extern void cgit_print_log(const char *tip, int ofs, int cnt, char *grep,
</a><a href="#h21-0-4" id="h21-0-4" class="i">+			   char *pattern, char *path, int pager);
</a><a href="#h21-0-5" id="h21-0-5" class="i">+
</a><a href="#h21-0-6" id="h21-0-6" class="i">+#endif /* UI_LOG_H */
</a><b>diff --git a/<a id="h22" href="../file/ui-patch.c.html">ui-patch.c</a> b/<a href="../file/ui-patch.c.html">ui-patch.c</a></b>
<a href="#h22-0" id="h22-0" class="h">@@ -7,6 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h22-0-3" id="h22-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h22-0-4" id="h22-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 static void print_line(char *line, int len)
 {
<a href="#h22-1" id="h22-1" class="h">@@ -68,7 +70,7 @@ static void filepair_cb(struct diff_filepair *pair)
</a> 		html(&quot;Error running diff&quot;);
 }
 
<a href="#h22-1-3" id="h22-1-3" class="d">-void cgit_print_patch(char *hex, struct cacheitem *item)
</a><a href="#h22-1-4" id="h22-1-4" class="i">+void cgit_print_patch(char *hex)
</a> {
 	struct commit *commit;
 	struct commitinfo *info;
<a href="#h22-2" id="h22-2" class="h">@@ -76,7 +78,7 @@ void cgit_print_patch(char *hex, struct cacheitem *item)
</a> 	char *patchname;
 
 	if (!hex)
<a href="#h22-2-3" id="h22-2-3" class="d">-		hex = cgit_query_head;
</a><a href="#h22-2-4" id="h22-2-4" class="i">+		hex = ctx.qry.head;
</a> 
 	if (get_sha1(hex, sha1)) {
 		cgit_print_error(fmt(&quot;Bad object id: %s&quot;, hex));
<a href="#h22-3" id="h22-3" class="h">@@ -95,7 +97,9 @@ void cgit_print_patch(char *hex, struct cacheitem *item)
</a> 		hashclr(old_sha1);
 
 	patchname = fmt(&quot;%s.patch&quot;, sha1_to_hex(sha1));
<a href="#h22-3-3" id="h22-3-3" class="d">-	cgit_print_snapshot_start(&quot;text/plain&quot;, patchname, item);
</a><a href="#h22-3-4" id="h22-3-4" class="i">+	ctx.page.mimetype = &quot;text/plain&quot;;
</a><a href="#h22-3-5" id="h22-3-5" class="i">+	ctx.page.filename = patchname;
</a><a href="#h22-3-6" id="h22-3-6" class="i">+	cgit_print_http_headers(&amp;ctx);
</a> 	htmlf(&quot;From %s Mon Sep 17 00:00:00 2001\n&quot;, sha1_to_hex(sha1));
 	htmlf(&quot;From: %s%s\n&quot;, info-&gt;author, info-&gt;author_email);
 	html(&quot;Date: &quot;);
<b>diff --git a/<a id="h23" href="../file/ui-patch.h.html">ui-patch.h</a> b/<a href="../file/ui-patch.h.html">ui-patch.h</a></b>
<a href="#h23-0" id="h23-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h23-0-0" id="h23-0-0" class="i">+#ifndef UI_PATCH_H
</a><a href="#h23-0-1" id="h23-0-1" class="i">+#define UI_PATCH_H
</a><a href="#h23-0-2" id="h23-0-2" class="i">+
</a><a href="#h23-0-3" id="h23-0-3" class="i">+extern void cgit_print_patch(char *hex);
</a><a href="#h23-0-4" id="h23-0-4" class="i">+
</a><a href="#h23-0-5" id="h23-0-5" class="i">+#endif /* UI_PATCH_H */
</a><b>diff --git a/<a id="h24" href="../file/ui-refs.c.html">ui-refs.c</a> b/<a href="../file/ui-refs.c.html">ui-refs.c</a></b>
<a href="#h24-0" id="h24-0" class="h">@@ -7,18 +7,189 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h24-0-3" id="h24-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h24-0-4" id="h24-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
<a href="#h24-0-6" id="h24-0-6" class="i">+static int header;
</a> 
<a href="#h24-0-8" id="h24-0-8" class="i">+static int cmp_age(int age1, int age2)
</a><a href="#h24-0-9" id="h24-0-9" class="i">+{
</a><a href="#h24-0-10" id="h24-0-10" class="i">+	if (age1 != 0 &amp;&amp; age2 != 0)
</a><a href="#h24-0-11" id="h24-0-11" class="i">+		return age2 - age1;
</a><a href="#h24-0-12" id="h24-0-12" class="i">+
</a><a href="#h24-0-13" id="h24-0-13" class="i">+	if (age1 == 0 &amp;&amp; age2 == 0)
</a><a href="#h24-0-14" id="h24-0-14" class="i">+		return 0;
</a><a href="#h24-0-15" id="h24-0-15" class="i">+
</a><a href="#h24-0-16" id="h24-0-16" class="i">+	if (age1 == 0)
</a><a href="#h24-0-17" id="h24-0-17" class="i">+		return +1;
</a><a href="#h24-0-18" id="h24-0-18" class="i">+
</a><a href="#h24-0-19" id="h24-0-19" class="i">+	return -1;
</a><a href="#h24-0-20" id="h24-0-20" class="i">+}
</a><a href="#h24-0-21" id="h24-0-21" class="i">+
</a><a href="#h24-0-22" id="h24-0-22" class="i">+static int cmp_ref_name(const void *a, const void *b)
</a><a href="#h24-0-23" id="h24-0-23" class="i">+{
</a><a href="#h24-0-24" id="h24-0-24" class="i">+	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h24-0-25" id="h24-0-25" class="i">+	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h24-0-26" id="h24-0-26" class="i">+
</a><a href="#h24-0-27" id="h24-0-27" class="i">+	return strcmp(r1-&gt;refname, r2-&gt;refname);
</a><a href="#h24-0-28" id="h24-0-28" class="i">+}
</a><a href="#h24-0-29" id="h24-0-29" class="i">+
</a><a href="#h24-0-30" id="h24-0-30" class="i">+static int cmp_branch_age(const void *a, const void *b)
</a><a href="#h24-0-31" id="h24-0-31" class="i">+{
</a><a href="#h24-0-32" id="h24-0-32" class="i">+	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h24-0-33" id="h24-0-33" class="i">+	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h24-0-34" id="h24-0-34" class="i">+
</a><a href="#h24-0-35" id="h24-0-35" class="i">+	return cmp_age(r1-&gt;commit-&gt;committer_date, r2-&gt;commit-&gt;committer_date);
</a><a href="#h24-0-36" id="h24-0-36" class="i">+}
</a><a href="#h24-0-37" id="h24-0-37" class="i">+
</a><a href="#h24-0-38" id="h24-0-38" class="i">+static int cmp_tag_age(const void *a, const void *b)
</a><a href="#h24-0-39" id="h24-0-39" class="i">+{
</a><a href="#h24-0-40" id="h24-0-40" class="i">+	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h24-0-41" id="h24-0-41" class="i">+	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h24-0-42" id="h24-0-42" class="i">+
</a><a href="#h24-0-43" id="h24-0-43" class="i">+	return cmp_age(r1-&gt;tag-&gt;tagger_date, r2-&gt;tag-&gt;tagger_date);
</a><a href="#h24-0-44" id="h24-0-44" class="i">+}
</a><a href="#h24-0-45" id="h24-0-45" class="i">+
</a><a href="#h24-0-46" id="h24-0-46" class="i">+static int print_branch(struct refinfo *ref)
</a><a href="#h24-0-47" id="h24-0-47" class="i">+{
</a><a href="#h24-0-48" id="h24-0-48" class="i">+	struct commitinfo *info = ref-&gt;commit;
</a><a href="#h24-0-49" id="h24-0-49" class="i">+	char *name = (char *)ref-&gt;refname;
</a><a href="#h24-0-50" id="h24-0-50" class="i">+
</a><a href="#h24-0-51" id="h24-0-51" class="i">+	if (!info)
</a><a href="#h24-0-52" id="h24-0-52" class="i">+		return 1;
</a><a href="#h24-0-53" id="h24-0-53" class="i">+	html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-54" id="h24-0-54" class="i">+	cgit_log_link(name, NULL, NULL, name, NULL, NULL, 0, NULL, NULL);
</a><a href="#h24-0-55" id="h24-0-55" class="i">+	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-56" id="h24-0-56" class="i">+
</a><a href="#h24-0-57" id="h24-0-57" class="i">+	if (ref-&gt;object-&gt;type == OBJ_COMMIT) {
</a><a href="#h24-0-58" id="h24-0-58" class="i">+		cgit_print_age(info-&gt;commit-&gt;date, -1, NULL);
</a><a href="#h24-0-59" id="h24-0-59" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-60" id="h24-0-60" class="i">+		html_txt(info-&gt;author);
</a><a href="#h24-0-61" id="h24-0-61" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-62" id="h24-0-62" class="i">+		cgit_commit_link(info-&gt;subject, NULL, NULL, name, NULL);
</a><a href="#h24-0-63" id="h24-0-63" class="i">+	} else {
</a><a href="#h24-0-64" id="h24-0-64" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-65" id="h24-0-65" class="i">+		cgit_object_link(ref-&gt;object);
</a><a href="#h24-0-66" id="h24-0-66" class="i">+	}
</a><a href="#h24-0-67" id="h24-0-67" class="i">+	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h24-0-68" id="h24-0-68" class="i">+	return 0;
</a><a href="#h24-0-69" id="h24-0-69" class="i">+}
</a><a href="#h24-0-70" id="h24-0-70" class="i">+
</a><a href="#h24-0-71" id="h24-0-71" class="i">+static void print_tag_header()
</a><a href="#h24-0-72" id="h24-0-72" class="i">+{
</a><a href="#h24-0-73" id="h24-0-73" class="i">+	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Tag&lt;/th&gt;&quot;
</a><a href="#h24-0-74" id="h24-0-74" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Age&lt;/th&gt;&quot;
</a><a href="#h24-0-75" id="h24-0-75" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h24-0-76" id="h24-0-76" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Reference&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h24-0-77" id="h24-0-77" class="i">+	header = 1;
</a><a href="#h24-0-78" id="h24-0-78" class="i">+}
</a><a href="#h24-0-79" id="h24-0-79" class="i">+
</a><a href="#h24-0-80" id="h24-0-80" class="i">+static int print_tag(struct refinfo *ref)
</a><a href="#h24-0-81" id="h24-0-81" class="i">+{
</a><a href="#h24-0-82" id="h24-0-82" class="i">+	struct tag *tag;
</a><a href="#h24-0-83" id="h24-0-83" class="i">+	struct taginfo *info;
</a><a href="#h24-0-84" id="h24-0-84" class="i">+	char *url, *name = (char *)ref-&gt;refname;
</a><a href="#h24-0-85" id="h24-0-85" class="i">+
</a><a href="#h24-0-86" id="h24-0-86" class="i">+	if (ref-&gt;object-&gt;type == OBJ_TAG) {
</a><a href="#h24-0-87" id="h24-0-87" class="i">+		tag = (struct tag *)ref-&gt;object;
</a><a href="#h24-0-88" id="h24-0-88" class="i">+		info = ref-&gt;tag;
</a><a href="#h24-0-89" id="h24-0-89" class="i">+		if (!tag || !info)
</a><a href="#h24-0-90" id="h24-0-90" class="i">+			return 1;
</a><a href="#h24-0-91" id="h24-0-91" class="i">+		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-92" id="h24-0-92" class="i">+		url = cgit_pageurl(ctx.qry.repo, &quot;tag&quot;,
</a><a href="#h24-0-93" id="h24-0-93" class="i">+				   fmt(&quot;id=%s&quot;, name));
</a><a href="#h24-0-94" id="h24-0-94" class="i">+		html_link_open(url, NULL, NULL);
</a><a href="#h24-0-95" id="h24-0-95" class="i">+		html_txt(name);
</a><a href="#h24-0-96" id="h24-0-96" class="i">+		html_link_close();
</a><a href="#h24-0-97" id="h24-0-97" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-98" id="h24-0-98" class="i">+		if (info-&gt;tagger_date &gt; 0)
</a><a href="#h24-0-99" id="h24-0-99" class="i">+			cgit_print_age(info-&gt;tagger_date, -1, NULL);
</a><a href="#h24-0-100" id="h24-0-100" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-101" id="h24-0-101" class="i">+		if (info-&gt;tagger)
</a><a href="#h24-0-102" id="h24-0-102" class="i">+			html(info-&gt;tagger);
</a><a href="#h24-0-103" id="h24-0-103" class="i">+		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-104" id="h24-0-104" class="i">+		cgit_object_link(tag-&gt;tagged);
</a><a href="#h24-0-105" id="h24-0-105" class="i">+		html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h24-0-106" id="h24-0-106" class="i">+	} else {
</a><a href="#h24-0-107" id="h24-0-107" class="i">+		if (!header)
</a><a href="#h24-0-108" id="h24-0-108" class="i">+			print_tag_header();
</a><a href="#h24-0-109" id="h24-0-109" class="i">+		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-110" id="h24-0-110" class="i">+		html_txt(name);
</a><a href="#h24-0-111" id="h24-0-111" class="i">+		html(&quot;&lt;/td&gt;&lt;td colspan=&#39;2&#39;/&gt;&lt;td&gt;&quot;);
</a><a href="#h24-0-112" id="h24-0-112" class="i">+		cgit_object_link(ref-&gt;object);
</a><a href="#h24-0-113" id="h24-0-113" class="i">+		html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h24-0-114" id="h24-0-114" class="i">+	}
</a><a href="#h24-0-115" id="h24-0-115" class="i">+	return 0;
</a><a href="#h24-0-116" id="h24-0-116" class="i">+}
</a><a href="#h24-0-117" id="h24-0-117" class="i">+
</a><a href="#h24-0-118" id="h24-0-118" class="i">+static void print_refs_link(char *path)
</a><a href="#h24-0-119" id="h24-0-119" class="i">+{
</a><a href="#h24-0-120" id="h24-0-120" class="i">+	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&quot;);
</a><a href="#h24-0-121" id="h24-0-121" class="i">+	cgit_refs_link(&quot;[...]&quot;, NULL, NULL, ctx.qry.head, NULL, path);
</a><a href="#h24-0-122" id="h24-0-122" class="i">+	html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
</a><a href="#h24-0-123" id="h24-0-123" class="i">+}
</a><a href="#h24-0-124" id="h24-0-124" class="i">+
</a><a href="#h24-0-125" id="h24-0-125" class="i">+void cgit_print_branches(int maxcount)
</a><a href="#h24-0-126" id="h24-0-126" class="i">+{
</a><a href="#h24-0-127" id="h24-0-127" class="i">+	struct reflist list;
</a><a href="#h24-0-128" id="h24-0-128" class="i">+	int i;
</a> 
<a href="#h24-0-130" id="h24-0-130" class="i">+	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Branch&lt;/th&gt;&quot;
</a><a href="#h24-0-131" id="h24-0-131" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Idle&lt;/th&gt;&quot;
</a><a href="#h24-0-132" id="h24-0-132" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h24-0-133" id="h24-0-133" class="i">+	     &quot;&lt;th class=&#39;left&#39;&gt;Head commit&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h24-0-134" id="h24-0-134" class="i">+
</a><a href="#h24-0-135" id="h24-0-135" class="i">+	list.refs = NULL;
</a><a href="#h24-0-136" id="h24-0-136" class="i">+	list.alloc = list.count = 0;
</a><a href="#h24-0-137" id="h24-0-137" class="i">+	for_each_branch_ref(cgit_refs_cb, &amp;list);
</a><a href="#h24-0-138" id="h24-0-138" class="i">+
</a><a href="#h24-0-139" id="h24-0-139" class="i">+	if (maxcount == 0 || maxcount &gt; list.count)
</a><a href="#h24-0-140" id="h24-0-140" class="i">+		maxcount = list.count;
</a><a href="#h24-0-141" id="h24-0-141" class="i">+
</a><a href="#h24-0-142" id="h24-0-142" class="i">+	if (maxcount &lt; list.count) {
</a><a href="#h24-0-143" id="h24-0-143" class="i">+		qsort(list.refs, list.count, sizeof(*list.refs), cmp_branch_age);
</a><a href="#h24-0-144" id="h24-0-144" class="i">+		qsort(list.refs, maxcount, sizeof(*list.refs), cmp_ref_name);
</a><a href="#h24-0-145" id="h24-0-145" class="i">+	}
</a><a href="#h24-0-146" id="h24-0-146" class="i">+
</a><a href="#h24-0-147" id="h24-0-147" class="i">+	for(i=0; i&lt;maxcount; i++)
</a><a href="#h24-0-148" id="h24-0-148" class="i">+		print_branch(list.refs[i]);
</a><a href="#h24-0-149" id="h24-0-149" class="i">+
</a><a href="#h24-0-150" id="h24-0-150" class="i">+	if (maxcount &lt; list.count)
</a><a href="#h24-0-151" id="h24-0-151" class="i">+		print_refs_link(&quot;heads&quot;);
</a><a href="#h24-0-152" id="h24-0-152" class="i">+}
</a><a href="#h24-0-153" id="h24-0-153" class="i">+
</a><a href="#h24-0-154" id="h24-0-154" class="i">+void cgit_print_tags(int maxcount)
</a><a href="#h24-0-155" id="h24-0-155" class="i">+{
</a><a href="#h24-0-156" id="h24-0-156" class="i">+	struct reflist list;
</a><a href="#h24-0-157" id="h24-0-157" class="i">+	int i;
</a><a href="#h24-0-158" id="h24-0-158" class="i">+
</a><a href="#h24-0-159" id="h24-0-159" class="i">+	header = 0;
</a><a href="#h24-0-160" id="h24-0-160" class="i">+	list.refs = NULL;
</a><a href="#h24-0-161" id="h24-0-161" class="i">+	list.alloc = list.count = 0;
</a><a href="#h24-0-162" id="h24-0-162" class="i">+	for_each_tag_ref(cgit_refs_cb, &amp;list);
</a><a href="#h24-0-163" id="h24-0-163" class="i">+	if (list.count == 0)
</a><a href="#h24-0-164" id="h24-0-164" class="i">+		return;
</a><a href="#h24-0-165" id="h24-0-165" class="i">+	qsort(list.refs, list.count, sizeof(*list.refs), cmp_tag_age);
</a><a href="#h24-0-166" id="h24-0-166" class="i">+	if (!maxcount)
</a><a href="#h24-0-167" id="h24-0-167" class="i">+		maxcount = list.count;
</a><a href="#h24-0-168" id="h24-0-168" class="i">+	else if (maxcount &gt; list.count)
</a><a href="#h24-0-169" id="h24-0-169" class="i">+		maxcount = list.count;
</a><a href="#h24-0-170" id="h24-0-170" class="i">+	print_tag_header();
</a><a href="#h24-0-171" id="h24-0-171" class="i">+	for(i=0; i&lt;maxcount; i++)
</a><a href="#h24-0-172" id="h24-0-172" class="i">+		print_tag(list.refs[i]);
</a><a href="#h24-0-173" id="h24-0-173" class="i">+
</a><a href="#h24-0-174" id="h24-0-174" class="i">+	if (maxcount &lt; list.count)
</a><a href="#h24-0-175" id="h24-0-175" class="i">+		print_refs_link(&quot;tags&quot;);
</a><a href="#h24-0-176" id="h24-0-176" class="i">+}
</a> 
 void cgit_print_refs()
 {
 
 	html(&quot;&lt;table class=&#39;list nowrap&#39;&gt;&quot;);
 
<a href="#h24-0-183" id="h24-0-183" class="d">-	if (cgit_query_path &amp;&amp; !strncmp(cgit_query_path, &quot;heads&quot;, 5))
</a><a href="#h24-0-184" id="h24-0-184" class="i">+	if (ctx.qry.path &amp;&amp; !strncmp(ctx.qry.path, &quot;heads&quot;, 5))
</a> 		cgit_print_branches(0);
<a href="#h24-0-186" id="h24-0-186" class="d">-	else if (cgit_query_path &amp;&amp; !strncmp(cgit_query_path, &quot;tags&quot;, 4))
</a><a href="#h24-0-187" id="h24-0-187" class="i">+	else if (ctx.qry.path &amp;&amp; !strncmp(ctx.qry.path, &quot;tags&quot;, 4))
</a> 		cgit_print_tags(0);
 	else {
 		cgit_print_branches(0);
<b>diff --git a/<a id="h25" href="../file/ui-refs.h.html">ui-refs.h</a> b/<a href="../file/ui-refs.h.html">ui-refs.h</a></b>
<a href="#h25-0" id="h25-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h25-0-0" id="h25-0-0" class="i">+#ifndef UI_REFS_H
</a><a href="#h25-0-1" id="h25-0-1" class="i">+#define UI_REFS_H
</a><a href="#h25-0-2" id="h25-0-2" class="i">+
</a><a href="#h25-0-3" id="h25-0-3" class="i">+extern void cgit_print_branches(int maxcount);
</a><a href="#h25-0-4" id="h25-0-4" class="i">+extern void cgit_print_tags(int maxcount);
</a><a href="#h25-0-5" id="h25-0-5" class="i">+extern void cgit_print_refs();
</a><a href="#h25-0-6" id="h25-0-6" class="i">+
</a><a href="#h25-0-7" id="h25-0-7" class="i">+#endif /* UI_REFS_H */
</a><b>diff --git a/<a id="h26" href="../file/ui-repolist.c.html">ui-repolist.c</a> b/<a href="../file/ui-repolist.c.html">ui-repolist.c</a></b>
<a href="#h26-0" id="h26-0" class="h">@@ -6,9 +6,11 @@
</a>  *   (see COPYING for full license text)
  */
 
<a href="#h26-0-3" id="h26-0-3" class="d">-#include &quot;cgit.h&quot;
</a> #include &lt;time.h&gt;
 
<a href="#h26-0-6" id="h26-0-6" class="i">+#include &quot;cgit.h&quot;
</a><a href="#h26-0-7" id="h26-0-7" class="i">+#include &quot;html.h&quot;
</a><a href="#h26-0-8" id="h26-0-8" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 time_t read_agefile(char *path)
 {
<a href="#h26-1" id="h26-1" class="h">@@ -25,12 +27,12 @@ time_t read_agefile(char *path)
</a> 		return 0;
 }
 
<a href="#h26-1-3" id="h26-1-3" class="d">-static void print_modtime(struct repoinfo *repo)
</a><a href="#h26-1-4" id="h26-1-4" class="i">+static void print_modtime(struct cgit_repo *repo)
</a> {
 	char *path;
 	struct stat s;
 
<a href="#h26-1-9" id="h26-1-9" class="d">-	path = fmt(&quot;%s/%s&quot;, repo-&gt;path, cgit_agefile);
</a><a href="#h26-1-10" id="h26-1-10" class="i">+	path = fmt(&quot;%s/%s&quot;, repo-&gt;path, ctx.cfg.agefile);
</a> 	if (stat(path, &amp;s) == 0) {
 		cgit_print_age(read_agefile(path), -1, NULL);
 		return;
<a href="#h26-2" id="h26-2" class="h">@@ -42,22 +44,24 @@ static void print_modtime(struct repoinfo *repo)
</a> 	cgit_print_age(s.st_mtime, -1, NULL);
 }
 
<a href="#h26-2-3" id="h26-2-3" class="d">-void cgit_print_repolist(struct cacheitem *item)
</a><a href="#h26-2-4" id="h26-2-4" class="i">+void cgit_print_repolist()
</a> {
 	int i, columns = 4;
 	char *last_group = NULL;
 
<a href="#h26-2-9" id="h26-2-9" class="d">-	if (cgit_enable_index_links)
</a><a href="#h26-2-10" id="h26-2-10" class="i">+	if (ctx.cfg.enable_index_links)
</a> 		columns++;
 
<a href="#h26-2-13" id="h26-2-13" class="d">-	cgit_print_docstart(cgit_root_title, item);
</a><a href="#h26-2-14" id="h26-2-14" class="d">-	cgit_print_pageheader(cgit_root_title, 0);
</a><a href="#h26-2-15" id="h26-2-15" class="i">+	ctx.page.title = ctx.cfg.root_title;
</a><a href="#h26-2-16" id="h26-2-16" class="i">+	cgit_print_http_headers(&amp;ctx);
</a><a href="#h26-2-17" id="h26-2-17" class="i">+	cgit_print_docstart(&amp;ctx);
</a><a href="#h26-2-18" id="h26-2-18" class="i">+	cgit_print_pageheader(&amp;ctx);
</a> 
 	html(&quot;&lt;table summary=&#39;repository list&#39; class=&#39;list nowrap&#39;&gt;&quot;);
<a href="#h26-2-21" id="h26-2-21" class="d">-	if (cgit_index_header) {
</a><a href="#h26-2-22" id="h26-2-22" class="i">+	if (ctx.cfg.index_header) {
</a> 		htmlf(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;%d&#39; class=&#39;include-block&#39;&gt;&quot;,
 		      columns);
<a href="#h26-2-25" id="h26-2-25" class="d">-		html_include(cgit_index_header);
</a><a href="#h26-2-26" id="h26-2-26" class="i">+		html_include(ctx.cfg.index_header);
</a> 		html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
 	}
 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&quot;
<a href="#h26-3" id="h26-3" class="h">@@ -65,37 +69,37 @@ void cgit_print_repolist(struct cacheitem *item)
</a> 	     &quot;&lt;th class=&#39;left&#39;&gt;Description&lt;/th&gt;&quot;
 	     &quot;&lt;th class=&#39;left&#39;&gt;Owner&lt;/th&gt;&quot;
 	     &quot;&lt;th class=&#39;left&#39;&gt;Idle&lt;/th&gt;&quot;);
<a href="#h26-3-3" id="h26-3-3" class="d">-	if (cgit_enable_index_links)
</a><a href="#h26-3-4" id="h26-3-4" class="i">+	if (ctx.cfg.enable_index_links)
</a> 		html(&quot;&lt;th&gt;Links&lt;/th&gt;&quot;);
 	html(&quot;&lt;/tr&gt;\n&quot;);
 
 	for (i=0; i&lt;cgit_repolist.count; i++) {
<a href="#h26-3-9" id="h26-3-9" class="d">-		cgit_repo = &amp;cgit_repolist.repos[i];
</a><a href="#h26-3-10" id="h26-3-10" class="d">-		if ((last_group == NULL &amp;&amp; cgit_repo-&gt;group != NULL) ||
</a><a href="#h26-3-11" id="h26-3-11" class="d">-		    (last_group != NULL &amp;&amp; cgit_repo-&gt;group == NULL) ||
</a><a href="#h26-3-12" id="h26-3-12" class="d">-		    (last_group != NULL &amp;&amp; cgit_repo-&gt;group != NULL &amp;&amp;
</a><a href="#h26-3-13" id="h26-3-13" class="d">-		     strcmp(cgit_repo-&gt;group, last_group))) {
</a><a href="#h26-3-14" id="h26-3-14" class="i">+		ctx.repo = &amp;cgit_repolist.repos[i];
</a><a href="#h26-3-15" id="h26-3-15" class="i">+		if ((last_group == NULL &amp;&amp; ctx.repo-&gt;group != NULL) ||
</a><a href="#h26-3-16" id="h26-3-16" class="i">+		    (last_group != NULL &amp;&amp; ctx.repo-&gt;group == NULL) ||
</a><a href="#h26-3-17" id="h26-3-17" class="i">+		    (last_group != NULL &amp;&amp; ctx.repo-&gt;group != NULL &amp;&amp;
</a><a href="#h26-3-18" id="h26-3-18" class="i">+		     strcmp(ctx.repo-&gt;group, last_group))) {
</a> 			htmlf(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;%d&#39; class=&#39;repogroup&#39;&gt;&quot;,
 			      columns);
<a href="#h26-3-21" id="h26-3-21" class="d">-			html_txt(cgit_repo-&gt;group);
</a><a href="#h26-3-22" id="h26-3-22" class="i">+			html_txt(ctx.repo-&gt;group);
</a> 			html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
<a href="#h26-3-24" id="h26-3-24" class="d">-			last_group = cgit_repo-&gt;group;
</a><a href="#h26-3-25" id="h26-3-25" class="i">+			last_group = ctx.repo-&gt;group;
</a> 		}
 		htmlf(&quot;&lt;tr&gt;&lt;td class=&#39;%s&#39;&gt;&quot;,
<a href="#h26-3-28" id="h26-3-28" class="d">-		      cgit_repo-&gt;group ? &quot;sublevel-repo&quot; : &quot;toplevel-repo&quot;);
</a><a href="#h26-3-29" id="h26-3-29" class="d">-		html_link_open(cgit_repourl(cgit_repo-&gt;url), NULL, NULL);
</a><a href="#h26-3-30" id="h26-3-30" class="d">-		html_txt(cgit_repo-&gt;name);
</a><a href="#h26-3-31" id="h26-3-31" class="i">+		      ctx.repo-&gt;group ? &quot;sublevel-repo&quot; : &quot;toplevel-repo&quot;);
</a><a href="#h26-3-32" id="h26-3-32" class="i">+		html_link_open(cgit_repourl(ctx.repo-&gt;url), NULL, NULL);
</a><a href="#h26-3-33" id="h26-3-33" class="i">+		html_txt(ctx.repo-&gt;name);
</a> 		html_link_close();
 		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h26-3-36" id="h26-3-36" class="d">-		html_ntxt(cgit_max_repodesc_len, cgit_repo-&gt;desc);
</a><a href="#h26-3-37" id="h26-3-37" class="i">+		html_ntxt(ctx.cfg.max_repodesc_len, ctx.repo-&gt;desc);
</a> 		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h26-3-39" id="h26-3-39" class="d">-		html_txt(cgit_repo-&gt;owner);
</a><a href="#h26-3-40" id="h26-3-40" class="i">+		html_txt(ctx.repo-&gt;owner);
</a> 		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
<a href="#h26-3-42" id="h26-3-42" class="d">-		print_modtime(cgit_repo);
</a><a href="#h26-3-43" id="h26-3-43" class="i">+		print_modtime(ctx.repo);
</a> 		html(&quot;&lt;/td&gt;&quot;);
<a href="#h26-3-45" id="h26-3-45" class="d">-		if (cgit_enable_index_links) {
</a><a href="#h26-3-46" id="h26-3-46" class="i">+		if (ctx.cfg.enable_index_links) {
</a> 			html(&quot;&lt;td&gt;&quot;);
<a href="#h26-3-48" id="h26-3-48" class="d">-			html_link_open(cgit_repourl(cgit_repo-&gt;url),
</a><a href="#h26-3-49" id="h26-3-49" class="i">+			html_link_open(cgit_repourl(ctx.repo-&gt;url),
</a> 				       NULL, &quot;button&quot;);
 			html(&quot;summary&lt;/a&gt;&quot;);
 			cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, NULL, NULL, NULL,
<b>diff --git a/<a id="h27" href="../file/ui-repolist.h.html">ui-repolist.h</a> b/<a href="../file/ui-repolist.h.html">ui-repolist.h</a></b>
<a href="#h27-0" id="h27-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h27-0-0" id="h27-0-0" class="i">+#ifndef UI_REPOLIST_H
</a><a href="#h27-0-1" id="h27-0-1" class="i">+#define UI_REPOLIST_H
</a><a href="#h27-0-2" id="h27-0-2" class="i">+
</a><a href="#h27-0-3" id="h27-0-3" class="i">+extern void cgit_print_repolist();
</a><a href="#h27-0-4" id="h27-0-4" class="i">+
</a><a href="#h27-0-5" id="h27-0-5" class="i">+#endif /* UI_REPOLIST_H */
</a><b>diff --git a/<a id="h28" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h28-0" id="h28-0" class="h">@@ -7,6 +7,7 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h28-0-3" id="h28-0-3" class="i">+#include &quot;html.h&quot;
</a> 
 const char cgit_doctype[] =
 &quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.0 Transitional//EN\&quot;\n&quot;
<a href="#h28-1" id="h28-1" class="h">@@ -25,14 +26,6 @@ static char *http_date(time_t t)
</a> 		   tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec);
 }
 
<a href="#h28-1-3" id="h28-1-3" class="d">-static long ttl_seconds(long ttl)
</a><a href="#h28-1-4" id="h28-1-4" class="d">-{
</a><a href="#h28-1-5" id="h28-1-5" class="d">-	if (ttl&lt;0)
</a><a href="#h28-1-6" id="h28-1-6" class="d">-		return 60 * 60 * 24 * 365;
</a><a href="#h28-1-7" id="h28-1-7" class="d">-	else
</a><a href="#h28-1-8" id="h28-1-8" class="d">-		return ttl * 60;
</a><a href="#h28-1-9" id="h28-1-9" class="d">-}
</a><a href="#h28-1-10" id="h28-1-10" class="d">-
</a> void cgit_print_error(char *msg)
 {
 	html(&quot;&lt;div class=&#39;error&#39;&gt;&quot;);
<a href="#h28-2" id="h28-2" class="h">@@ -42,16 +35,16 @@ void cgit_print_error(char *msg)
</a> 
 char *cgit_rooturl()
 {
<a href="#h28-2-3" id="h28-2-3" class="d">-	if (cgit_virtual_root)
</a><a href="#h28-2-4" id="h28-2-4" class="d">-		return fmt(&quot;%s/&quot;, cgit_virtual_root);
</a><a href="#h28-2-5" id="h28-2-5" class="i">+	if (ctx.cfg.virtual_root)
</a><a href="#h28-2-6" id="h28-2-6" class="i">+		return fmt(&quot;%s/&quot;, ctx.cfg.virtual_root);
</a> 	else
<a href="#h28-2-8" id="h28-2-8" class="d">-		return cgit_script_name;
</a><a href="#h28-2-9" id="h28-2-9" class="i">+		return ctx.cfg.script_name;
</a> }
 
 char *cgit_repourl(const char *reponame)
 {
<a href="#h28-2-14" id="h28-2-14" class="d">-	if (cgit_virtual_root) {
</a><a href="#h28-2-15" id="h28-2-15" class="d">-		return fmt(&quot;%s/%s/&quot;, cgit_virtual_root, reponame);
</a><a href="#h28-2-16" id="h28-2-16" class="i">+	if (ctx.cfg.virtual_root) {
</a><a href="#h28-2-17" id="h28-2-17" class="i">+		return fmt(&quot;%s/%s/&quot;, ctx.cfg.virtual_root, reponame);
</a> 	} else {
 		return fmt(&quot;?r=%s&quot;, reponame);
 	}
<a href="#h28-3" id="h28-3" class="h">@@ -63,8 +56,8 @@ char *cgit_fileurl(const char *reponame, const char *pagename,
</a> 	char *tmp;
 	char *delim;
 
<a href="#h28-3-3" id="h28-3-3" class="d">-	if (cgit_virtual_root) {
</a><a href="#h28-3-4" id="h28-3-4" class="d">-		tmp = fmt(&quot;%s/%s/%s/%s&quot;, cgit_virtual_root, reponame,
</a><a href="#h28-3-5" id="h28-3-5" class="i">+	if (ctx.cfg.virtual_root) {
</a><a href="#h28-3-6" id="h28-3-6" class="i">+		tmp = fmt(&quot;%s/%s/%s/%s&quot;, ctx.cfg.virtual_root, reponame,
</a> 			  pagename, (filename ? filename:&quot;&quot;));
 		delim = &quot;?&quot;;
 	} else {
<a href="#h28-4" id="h28-4" class="h">@@ -110,14 +103,14 @@ const char *cgit_repobasename(const char *reponame)
</a> 
 char *cgit_currurl()
 {
<a href="#h28-4-3" id="h28-4-3" class="d">-	if (!cgit_virtual_root)
</a><a href="#h28-4-4" id="h28-4-4" class="d">-		return cgit_script_name;
</a><a href="#h28-4-5" id="h28-4-5" class="d">-	else if (cgit_query_page)
</a><a href="#h28-4-6" id="h28-4-6" class="d">-		return fmt(&quot;%s/%s/%s/&quot;, cgit_virtual_root, cgit_query_repo, cgit_query_page);
</a><a href="#h28-4-7" id="h28-4-7" class="d">-	else if (cgit_query_repo)
</a><a href="#h28-4-8" id="h28-4-8" class="d">-		return fmt(&quot;%s/%s/&quot;, cgit_virtual_root, cgit_query_repo);
</a><a href="#h28-4-9" id="h28-4-9" class="i">+	if (!ctx.cfg.virtual_root)
</a><a href="#h28-4-10" id="h28-4-10" class="i">+		return ctx.cfg.script_name;
</a><a href="#h28-4-11" id="h28-4-11" class="i">+	else if (ctx.qry.page)
</a><a href="#h28-4-12" id="h28-4-12" class="i">+		return fmt(&quot;%s/%s/%s/&quot;, ctx.cfg.virtual_root, ctx.qry.repo, ctx.qry.page);
</a><a href="#h28-4-13" id="h28-4-13" class="i">+	else if (ctx.qry.repo)
</a><a href="#h28-4-14" id="h28-4-14" class="i">+		return fmt(&quot;%s/%s/&quot;, ctx.cfg.virtual_root, ctx.qry.repo);
</a> 	else
<a href="#h28-4-16" id="h28-4-16" class="d">-		return fmt(&quot;%s/&quot;, cgit_virtual_root);
</a><a href="#h28-4-17" id="h28-4-17" class="i">+		return fmt(&quot;%s/&quot;, ctx.cfg.virtual_root);
</a> }
 
 static char *repolink(char *title, char *class, char *page, char *head,
<a href="#h28-5" id="h28-5" class="h">@@ -137,12 +130,12 @@ static char *repolink(char *title, char *class, char *page, char *head,
</a> 		html(&quot;&#39;&quot;);
 	}
 	html(&quot; href=&#39;&quot;);
<a href="#h28-5-3" id="h28-5-3" class="d">-	if (cgit_virtual_root) {
</a><a href="#h28-5-4" id="h28-5-4" class="d">-		html_attr(cgit_virtual_root);
</a><a href="#h28-5-5" id="h28-5-5" class="d">-		if (cgit_virtual_root[strlen(cgit_virtual_root) - 1] != &#39;/&#39;)
</a><a href="#h28-5-6" id="h28-5-6" class="i">+	if (ctx.cfg.virtual_root) {
</a><a href="#h28-5-7" id="h28-5-7" class="i">+		html_attr(ctx.cfg.virtual_root);
</a><a href="#h28-5-8" id="h28-5-8" class="i">+		if (ctx.cfg.virtual_root[strlen(ctx.cfg.virtual_root) - 1] != &#39;/&#39;)
</a> 			html(&quot;/&quot;);
<a href="#h28-5-10" id="h28-5-10" class="d">-		html_attr(cgit_repo-&gt;url);
</a><a href="#h28-5-11" id="h28-5-11" class="d">-		if (cgit_repo-&gt;url[strlen(cgit_repo-&gt;url) - 1] != &#39;/&#39;)
</a><a href="#h28-5-12" id="h28-5-12" class="i">+		html_attr(ctx.repo-&gt;url);
</a><a href="#h28-5-13" id="h28-5-13" class="i">+		if (ctx.repo-&gt;url[strlen(ctx.repo-&gt;url) - 1] != &#39;/&#39;)
</a> 			html(&quot;/&quot;);
 		if (page) {
 			html(page);
<a href="#h28-6" id="h28-6" class="h">@@ -151,10 +144,10 @@ static char *repolink(char *title, char *class, char *page, char *head,
</a> 				html_attr(path);
 		}
 	} else {
<a href="#h28-6-3" id="h28-6-3" class="d">-		html(cgit_script_name);
</a><a href="#h28-6-4" id="h28-6-4" class="i">+		html(ctx.cfg.script_name);
</a> 		html(&quot;?url=&quot;);
<a href="#h28-6-6" id="h28-6-6" class="d">-		html_attr(cgit_repo-&gt;url);
</a><a href="#h28-6-7" id="h28-6-7" class="d">-		if (cgit_repo-&gt;url[strlen(cgit_repo-&gt;url) - 1] != &#39;/&#39;)
</a><a href="#h28-6-8" id="h28-6-8" class="i">+		html_attr(ctx.repo-&gt;url);
</a><a href="#h28-6-9" id="h28-6-9" class="i">+		if (ctx.repo-&gt;url[strlen(ctx.repo-&gt;url) - 1] != &#39;/&#39;)
</a> 			html(&quot;/&quot;);
 		if (page) {
 			html(page);
<a href="#h28-7" id="h28-7" class="h">@@ -164,7 +157,7 @@ static char *repolink(char *title, char *class, char *page, char *head,
</a> 		}
 		delim = &quot;&amp;amp;&quot;;
 	}
<a href="#h28-7-3" id="h28-7-3" class="d">-	if (head &amp;&amp; strcmp(head, cgit_repo-&gt;defbranch)) {
</a><a href="#h28-7-4" id="h28-7-4" class="i">+	if (head &amp;&amp; strcmp(head, ctx.repo-&gt;defbranch)) {
</a> 		html(delim);
 		html(&quot;h=&quot;);
 		html_attr(head);
<a href="#h28-8" id="h28-8" class="h">@@ -179,7 +172,7 @@ static void reporevlink(char *page, char *name, char *title, char *class,
</a> 	char *delim;
 
 	delim = repolink(title, class, page, head, path);
<a href="#h28-8-3" id="h28-8-3" class="d">-	if (rev &amp;&amp; strcmp(rev, cgit_query_head)) {
</a><a href="#h28-8-4" id="h28-8-4" class="i">+	if (rev &amp;&amp; strcmp(rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(rev);
<a href="#h28-9" id="h28-9" class="h">@@ -201,7 +194,7 @@ void cgit_log_link(char *name, char *title, char *class, char *head,
</a> 	char *delim;
 
 	delim = repolink(title, class, &quot;log&quot;, head, path);
<a href="#h28-9-3" id="h28-9-3" class="d">-	if (rev &amp;&amp; strcmp(rev, cgit_query_head)) {
</a><a href="#h28-9-4" id="h28-9-4" class="i">+	if (rev &amp;&amp; strcmp(rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(rev);
<a href="#h28-10" id="h28-10" class="h">@@ -229,11 +222,11 @@ void cgit_log_link(char *name, char *title, char *class, char *head,
</a> void cgit_commit_link(char *name, char *title, char *class, char *head,
 		      char *rev)
 {
<a href="#h28-10-3" id="h28-10-3" class="d">-	if (strlen(name) &gt; cgit_max_msg_len &amp;&amp; cgit_max_msg_len &gt;= 15) {
</a><a href="#h28-10-4" id="h28-10-4" class="d">-		name[cgit_max_msg_len] = &#39;\0&#39;;
</a><a href="#h28-10-5" id="h28-10-5" class="d">-		name[cgit_max_msg_len - 1] = &#39;.&#39;;
</a><a href="#h28-10-6" id="h28-10-6" class="d">-		name[cgit_max_msg_len - 2] = &#39;.&#39;;
</a><a href="#h28-10-7" id="h28-10-7" class="d">-		name[cgit_max_msg_len - 3] = &#39;.&#39;;
</a><a href="#h28-10-8" id="h28-10-8" class="i">+	if (strlen(name) &gt; ctx.cfg.max_msg_len &amp;&amp; ctx.cfg.max_msg_len &gt;= 15) {
</a><a href="#h28-10-9" id="h28-10-9" class="i">+		name[ctx.cfg.max_msg_len] = &#39;\0&#39;;
</a><a href="#h28-10-10" id="h28-10-10" class="i">+		name[ctx.cfg.max_msg_len - 1] = &#39;.&#39;;
</a><a href="#h28-10-11" id="h28-10-11" class="i">+		name[ctx.cfg.max_msg_len - 2] = &#39;.&#39;;
</a><a href="#h28-10-12" id="h28-10-12" class="i">+		name[ctx.cfg.max_msg_len - 3] = &#39;.&#39;;
</a> 	}
 	reporevlink(&quot;commit&quot;, name, title, class, head, rev, NULL);
 }
<a href="#h28-11" id="h28-11" class="h">@@ -256,7 +249,7 @@ void cgit_diff_link(char *name, char *title, char *class, char *head,
</a> 	char *delim;
 
 	delim = repolink(title, class, &quot;diff&quot;, head, path);
<a href="#h28-11-3" id="h28-11-3" class="d">-	if (new_rev &amp;&amp; strcmp(new_rev, cgit_query_head)) {
</a><a href="#h28-11-4" id="h28-11-4" class="i">+	if (new_rev &amp;&amp; strcmp(new_rev, ctx.qry.head)) {
</a> 		html(delim);
 		html(&quot;id=&quot;);
 		html_attr(new_rev);
<a href="#h28-12" id="h28-12" class="h">@@ -284,7 +277,7 @@ void cgit_object_link(struct object *obj)
</a> 
 	if (obj-&gt;type == OBJ_COMMIT) {
                 cgit_commit_link(fmt(&quot;commit %s&quot;, sha1_to_hex(obj-&gt;sha1)), NULL, NULL,
<a href="#h28-12-3" id="h28-12-3" class="d">-				 cgit_query_head, sha1_to_hex(obj-&gt;sha1));
</a><a href="#h28-12-4" id="h28-12-4" class="i">+				 ctx.qry.head, sha1_to_hex(obj-&gt;sha1));
</a> 		return;
 	} else if (obj-&gt;type == OBJ_TREE) {
 		page = &quot;tree&quot;;
<a href="#h28-13" id="h28-13" class="h">@@ -297,7 +290,7 @@ void cgit_object_link(struct object *obj)
</a> 		arg = &quot;id&quot;;
 	}
 
<a href="#h28-13-3" id="h28-13-3" class="d">-	url = cgit_pageurl(cgit_query_repo, page,
</a><a href="#h28-13-4" id="h28-13-4" class="i">+	url = cgit_pageurl(ctx.qry.repo, page,
</a> 			   fmt(&quot;%s=%s&quot;, arg, sha1_to_hex(obj-&gt;sha1)));
 	html_link_open(url, NULL, NULL);
 	htmlf(&quot;%s %s&quot;, typename(obj-&gt;type),
<a href="#h28-14" id="h28-14" class="h">@@ -360,24 +353,34 @@ void cgit_print_age(time_t t, time_t max_relative, char *format)
</a> 	      secs * 1.0 / TM_YEAR);
 }
 
<a href="#h28-14-3" id="h28-14-3" class="d">-void cgit_print_docstart(char *title, struct cacheitem *item)
</a><a href="#h28-14-4" id="h28-14-4" class="i">+void cgit_print_http_headers(struct cgit_context *ctx)
</a> {
<a href="#h28-14-6" id="h28-14-6" class="d">-	html(&quot;Content-Type: text/html; charset=&quot; PAGE_ENCODING &quot;\n&quot;);
</a><a href="#h28-14-7" id="h28-14-7" class="d">-	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(item-&gt;st.st_mtime));
</a><a href="#h28-14-8" id="h28-14-8" class="d">-	htmlf(&quot;Expires: %s\n&quot;, http_date(item-&gt;st.st_mtime +
</a><a href="#h28-14-9" id="h28-14-9" class="d">-					 ttl_seconds(item-&gt;ttl)));
</a><a href="#h28-14-10" id="h28-14-10" class="i">+	if (ctx-&gt;page.mimetype &amp;&amp; ctx-&gt;page.charset)
</a><a href="#h28-14-11" id="h28-14-11" class="i">+		htmlf(&quot;Content-Type: %s; charset=%s\n&quot;, ctx-&gt;page.mimetype,
</a><a href="#h28-14-12" id="h28-14-12" class="i">+		      ctx-&gt;page.charset);
</a><a href="#h28-14-13" id="h28-14-13" class="i">+	else if (ctx-&gt;page.mimetype)
</a><a href="#h28-14-14" id="h28-14-14" class="i">+		htmlf(&quot;Content-Type: %s\n&quot;, ctx-&gt;page.mimetype);
</a><a href="#h28-14-15" id="h28-14-15" class="i">+	if (ctx-&gt;page.filename)
</a><a href="#h28-14-16" id="h28-14-16" class="i">+		htmlf(&quot;Content-Disposition: inline; filename=\&quot;%s\&quot;\n&quot;,
</a><a href="#h28-14-17" id="h28-14-17" class="i">+		      ctx-&gt;page.filename);
</a><a href="#h28-14-18" id="h28-14-18" class="i">+	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(ctx-&gt;page.modified));
</a><a href="#h28-14-19" id="h28-14-19" class="i">+	htmlf(&quot;Expires: %s\n&quot;, http_date(ctx-&gt;page.expires));
</a> 	html(&quot;\n&quot;);
<a href="#h28-14-21" id="h28-14-21" class="i">+}
</a><a href="#h28-14-22" id="h28-14-22" class="i">+
</a><a href="#h28-14-23" id="h28-14-23" class="i">+void cgit_print_docstart(struct cgit_context *ctx)
</a><a href="#h28-14-24" id="h28-14-24" class="i">+{
</a> 	html(cgit_doctype);
 	html(&quot;&lt;html xmlns=&#39;http://www.w3.org/1999/xhtml&#39; xml:lang=&#39;en&#39; lang=&#39;en&#39;&gt;\n&quot;);
 	html(&quot;&lt;head&gt;\n&quot;);
 	html(&quot;&lt;title&gt;&quot;);
<a href="#h28-14-29" id="h28-14-29" class="d">-	html_txt(title);
</a><a href="#h28-14-30" id="h28-14-30" class="i">+	html_txt(ctx-&gt;page.title);
</a> 	html(&quot;&lt;/title&gt;\n&quot;);
 	htmlf(&quot;&lt;meta name=&#39;generator&#39; content=&#39;cgit %s&#39;/&gt;\n&quot;, cgit_version);
<a href="#h28-14-33" id="h28-14-33" class="d">-	if (cgit_robots &amp;&amp; *cgit_robots)
</a><a href="#h28-14-34" id="h28-14-34" class="d">-		htmlf(&quot;&lt;meta name=&#39;robots&#39; content=&#39;%s&#39;/&gt;\n&quot;, cgit_robots);
</a><a href="#h28-14-35" id="h28-14-35" class="i">+	if (ctx-&gt;cfg.robots &amp;&amp; *ctx-&gt;cfg.robots)
</a><a href="#h28-14-36" id="h28-14-36" class="i">+		htmlf(&quot;&lt;meta name=&#39;robots&#39; content=&#39;%s&#39;/&gt;\n&quot;, ctx-&gt;cfg.robots);
</a> 	html(&quot;&lt;link rel=&#39;stylesheet&#39; type=&#39;text/css&#39; href=&#39;&quot;);
<a href="#h28-14-38" id="h28-14-38" class="d">-	html_attr(cgit_css);
</a><a href="#h28-14-39" id="h28-14-39" class="i">+	html_attr(ctx-&gt;cfg.css);
</a> 	html(&quot;&#39;/&gt;\n&quot;);
 	html(&quot;&lt;/head&gt;\n&quot;);
 	html(&quot;&lt;body&gt;\n&quot;);
<a href="#h28-15" id="h28-15" class="h">@@ -392,7 +395,7 @@ int print_branch_option(const char *refname, const unsigned char *sha1,
</a> 			int flags, void *cb_data)
 {
 	char *name = (char *)refname;
<a href="#h28-15-3" id="h28-15-3" class="d">-	html_option(name, name, cgit_query_head);
</a><a href="#h28-15-4" id="h28-15-4" class="i">+	html_option(name, name, ctx.qry.head);
</a> 	return 0;
 }
 
<a href="#h28-16" id="h28-16" class="h">@@ -426,7 +429,7 @@ int print_archive_ref(const char *refname, const unsigned char *sha1,
</a> 		html(&quot;&lt;h1&gt;download&lt;/h1&gt;\n&quot;);
 		*header = 1;
 	}
<a href="#h28-16-3" id="h28-16-3" class="d">-	url = cgit_pageurl(cgit_query_repo, &quot;blob&quot;,
</a><a href="#h28-16-4" id="h28-16-4" class="i">+	url = cgit_pageurl(ctx.qry.repo, &quot;blob&quot;,
</a> 			   fmt(&quot;id=%s&amp;amp;path=%s&quot;, sha1_to_hex(fileid),
 			       buf));
 	html_link_open(url, NULL, &quot;menu&quot;);
<a href="#h28-17" id="h28-17" class="h">@@ -439,30 +442,30 @@ void add_hidden_formfields(int incl_head, int incl_search, char *page)
</a> {
 	char *url;
 
<a href="#h28-17-3" id="h28-17-3" class="d">-	if (!cgit_virtual_root) {
</a><a href="#h28-17-4" id="h28-17-4" class="d">-		url = fmt(&quot;%s/%s&quot;, cgit_query_repo, page);
</a><a href="#h28-17-5" id="h28-17-5" class="d">-		if (cgit_query_path)
</a><a href="#h28-17-6" id="h28-17-6" class="d">-			url = fmt(&quot;%s/%s&quot;, url, cgit_query_path);
</a><a href="#h28-17-7" id="h28-17-7" class="i">+	if (!ctx.cfg.virtual_root) {
</a><a href="#h28-17-8" id="h28-17-8" class="i">+		url = fmt(&quot;%s/%s&quot;, ctx.qry.repo, page);
</a><a href="#h28-17-9" id="h28-17-9" class="i">+		if (ctx.qry.path)
</a><a href="#h28-17-10" id="h28-17-10" class="i">+			url = fmt(&quot;%s/%s&quot;, url, ctx.qry.path);
</a> 		html_hidden(&quot;url&quot;, url);
 	}
 
<a href="#h28-17-14" id="h28-17-14" class="d">-	if (incl_head &amp;&amp; strcmp(cgit_query_head, cgit_repo-&gt;defbranch))
</a><a href="#h28-17-15" id="h28-17-15" class="d">-		html_hidden(&quot;h&quot;, cgit_query_head);
</a><a href="#h28-17-16" id="h28-17-16" class="i">+	if (incl_head &amp;&amp; strcmp(ctx.qry.head, ctx.repo-&gt;defbranch))
</a><a href="#h28-17-17" id="h28-17-17" class="i">+		html_hidden(&quot;h&quot;, ctx.qry.head);
</a> 
<a href="#h28-17-19" id="h28-17-19" class="d">-	if (cgit_query_sha1)
</a><a href="#h28-17-20" id="h28-17-20" class="d">-		html_hidden(&quot;id&quot;, cgit_query_sha1);
</a><a href="#h28-17-21" id="h28-17-21" class="d">-	if (cgit_query_sha2)
</a><a href="#h28-17-22" id="h28-17-22" class="d">-		html_hidden(&quot;id2&quot;, cgit_query_sha2);
</a><a href="#h28-17-23" id="h28-17-23" class="i">+	if (ctx.qry.sha1)
</a><a href="#h28-17-24" id="h28-17-24" class="i">+		html_hidden(&quot;id&quot;, ctx.qry.sha1);
</a><a href="#h28-17-25" id="h28-17-25" class="i">+	if (ctx.qry.sha2)
</a><a href="#h28-17-26" id="h28-17-26" class="i">+		html_hidden(&quot;id2&quot;, ctx.qry.sha2);
</a> 
 	if (incl_search) {
<a href="#h28-17-29" id="h28-17-29" class="d">-		if (cgit_query_grep)
</a><a href="#h28-17-30" id="h28-17-30" class="d">-			html_hidden(&quot;qt&quot;, cgit_query_grep);
</a><a href="#h28-17-31" id="h28-17-31" class="d">-		if (cgit_query_search)
</a><a href="#h28-17-32" id="h28-17-32" class="d">-			html_hidden(&quot;q&quot;, cgit_query_search);
</a><a href="#h28-17-33" id="h28-17-33" class="i">+		if (ctx.qry.grep)
</a><a href="#h28-17-34" id="h28-17-34" class="i">+			html_hidden(&quot;qt&quot;, ctx.qry.grep);
</a><a href="#h28-17-35" id="h28-17-35" class="i">+		if (ctx.qry.search)
</a><a href="#h28-17-36" id="h28-17-36" class="i">+			html_hidden(&quot;q&quot;, ctx.qry.search);
</a> 	}
 }
 
<a href="#h28-17-40" id="h28-17-40" class="d">-void cgit_print_pageheader(char *title, int show_search)
</a><a href="#h28-17-41" id="h28-17-41" class="i">+void cgit_print_pageheader(struct cgit_context *ctx)
</a> {
 	static const char *default_info = &quot;This is cgit, a fast webinterface for git repositories&quot;;
 	int header = 0;
<a href="#h28-18" id="h28-18" class="h">@@ -474,40 +477,40 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 	html(&quot;&lt;tr&gt;&lt;td class=&#39;sidebar&#39;&gt;\n&lt;a href=&#39;&quot;);
 	html_attr(cgit_rooturl());
 	htmlf(&quot;&#39;&gt;&lt;img src=&#39;%s&#39; alt=&#39;cgit&#39;/&gt;&lt;/a&gt;\n&quot;,
<a href="#h28-18-3" id="h28-18-3" class="d">-	      cgit_logo);
</a><a href="#h28-18-4" id="h28-18-4" class="i">+	      ctx-&gt;cfg.logo);
</a> 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td class=&#39;sidebar&#39;&gt;\n&quot;);
<a href="#h28-18-6" id="h28-18-6" class="d">-	if (cgit_query_repo) {
</a><a href="#h28-18-7" id="h28-18-7" class="i">+	if (ctx-&gt;repo) {
</a> 		html(&quot;&lt;h1 class=&#39;first&#39;&gt;&quot;);
<a href="#h28-18-9" id="h28-18-9" class="d">-		html_txt(strrpart(cgit_repo-&gt;name, 20));
</a><a href="#h28-18-10" id="h28-18-10" class="i">+		html_txt(strrpart(ctx-&gt;repo-&gt;name, 20));
</a> 		html(&quot;&lt;/h1&gt;\n&quot;);
<a href="#h28-18-12" id="h28-18-12" class="d">-		html_txt(cgit_repo-&gt;desc);
</a><a href="#h28-18-13" id="h28-18-13" class="d">-		if (cgit_repo-&gt;owner) {
</a><a href="#h28-18-14" id="h28-18-14" class="i">+		html_txt(ctx-&gt;repo-&gt;desc);
</a><a href="#h28-18-15" id="h28-18-15" class="i">+		if (ctx-&gt;repo-&gt;owner) {
</a> 			html(&quot;&lt;h1&gt;owner&lt;/h1&gt;\n&quot;);
<a href="#h28-18-17" id="h28-18-17" class="d">-			html_txt(cgit_repo-&gt;owner);
</a><a href="#h28-18-18" id="h28-18-18" class="i">+			html_txt(ctx-&gt;repo-&gt;owner);
</a> 		}
 		html(&quot;&lt;h1&gt;navigate&lt;/h1&gt;\n&quot;);
<a href="#h28-18-21" id="h28-18-21" class="d">-		reporevlink(NULL, &quot;summary&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h28-18-22" id="h28-18-22" class="i">+		reporevlink(NULL, &quot;summary&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head,
</a> 			    NULL, NULL);
<a href="#h28-18-24" id="h28-18-24" class="d">-		cgit_log_link(&quot;log&quot;, NULL, &quot;menu&quot;, cgit_query_head, NULL, NULL,
</a><a href="#h28-18-25" id="h28-18-25" class="i">+		cgit_log_link(&quot;log&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head, NULL, NULL,
</a> 			      0, NULL, NULL);
<a href="#h28-18-27" id="h28-18-27" class="d">-		cgit_tree_link(&quot;tree&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h28-18-28" id="h28-18-28" class="d">-			       cgit_query_sha1, NULL);
</a><a href="#h28-18-29" id="h28-18-29" class="d">-		cgit_commit_link(&quot;commit&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h28-18-30" id="h28-18-30" class="d">-			      cgit_query_sha1);
</a><a href="#h28-18-31" id="h28-18-31" class="d">-		cgit_diff_link(&quot;diff&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h28-18-32" id="h28-18-32" class="d">-			       cgit_query_sha1, cgit_query_sha2, NULL);
</a><a href="#h28-18-33" id="h28-18-33" class="d">-		cgit_patch_link(&quot;patch&quot;, NULL, &quot;menu&quot;, cgit_query_head,
</a><a href="#h28-18-34" id="h28-18-34" class="d">-				cgit_query_sha1);
</a><a href="#h28-18-35" id="h28-18-35" class="i">+		cgit_tree_link(&quot;tree&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head,
</a><a href="#h28-18-36" id="h28-18-36" class="i">+			       ctx-&gt;qry.sha1, NULL);
</a><a href="#h28-18-37" id="h28-18-37" class="i">+		cgit_commit_link(&quot;commit&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head,
</a><a href="#h28-18-38" id="h28-18-38" class="i">+			      ctx-&gt;qry.sha1);
</a><a href="#h28-18-39" id="h28-18-39" class="i">+		cgit_diff_link(&quot;diff&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head,
</a><a href="#h28-18-40" id="h28-18-40" class="i">+			       ctx-&gt;qry.sha1, ctx-&gt;qry.sha2, NULL);
</a><a href="#h28-18-41" id="h28-18-41" class="i">+		cgit_patch_link(&quot;patch&quot;, NULL, &quot;menu&quot;, ctx-&gt;qry.head,
</a><a href="#h28-18-42" id="h28-18-42" class="i">+				ctx-&gt;qry.sha1);
</a> 
 		for_each_ref(print_archive_ref, &amp;header);
 
<a href="#h28-18-46" id="h28-18-46" class="d">-		if (cgit_repo-&gt;clone_url || cgit_clone_prefix) {
</a><a href="#h28-18-47" id="h28-18-47" class="i">+		if (ctx-&gt;repo-&gt;clone_url || ctx-&gt;cfg.clone_prefix) {
</a> 			html(&quot;&lt;h1&gt;clone&lt;/h1&gt;\n&quot;);
<a href="#h28-18-49" id="h28-18-49" class="d">-			if (cgit_repo-&gt;clone_url)
</a><a href="#h28-18-50" id="h28-18-50" class="d">-				url = cgit_repo-&gt;clone_url;
</a><a href="#h28-18-51" id="h28-18-51" class="i">+			if (ctx-&gt;repo-&gt;clone_url)
</a><a href="#h28-18-52" id="h28-18-52" class="i">+				url = ctx-&gt;repo-&gt;clone_url;
</a> 			else
<a href="#h28-18-54" id="h28-18-54" class="d">-				url = fmt(&quot;%s%s&quot;, cgit_clone_prefix,
</a><a href="#h28-18-55" id="h28-18-55" class="d">-					  cgit_repo-&gt;url);
</a><a href="#h28-18-56" id="h28-18-56" class="i">+				url = fmt(&quot;%s%s&quot;, ctx-&gt;cfg.clone_prefix,
</a><a href="#h28-18-57" id="h28-18-57" class="i">+					  ctx-&gt;repo-&gt;url);
</a> 			html(&quot;&lt;a class=&#39;menu&#39; href=&#39;&quot;);
 			html_attr(url);
 			html(&quot;&#39; title=&#39;&quot;);
<a href="#h28-19" id="h28-19" class="h">@@ -519,10 +522,10 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 
 		html(&quot;&lt;h1&gt;branch&lt;/h1&gt;\n&quot;);
 		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;\n&quot;);
<a href="#h28-19-3" id="h28-19-3" class="d">-		add_hidden_formfields(0, 1, cgit_query_page);
</a><a href="#h28-19-4" id="h28-19-4" class="i">+		add_hidden_formfields(0, 1, ctx-&gt;qry.page);
</a> //		html(&quot;&lt;table summary=&#39;branch selector&#39; class=&#39;grid&#39;&gt;&lt;tr&gt;&lt;td id=&#39;branch-dropdown-cell&#39;&gt;&quot;);
 		html(&quot;&lt;select name=&#39;h&#39; onchange=&#39;this.form.submit();&#39;&gt;\n&quot;);
<a href="#h28-19-7" id="h28-19-7" class="d">-		for_each_branch_ref(print_branch_option, cgit_query_head);
</a><a href="#h28-19-8" id="h28-19-8" class="i">+		for_each_branch_ref(print_branch_option, ctx-&gt;qry.head);
</a> 		html(&quot;&lt;/select&gt;\n&quot;);
 //		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
 		html(&quot;&lt;noscript&gt;&lt;input type=&#39;submit&#39; id=&#39;switch-btn&#39; value=&#39;switch&#39;/&gt;&lt;/noscript&gt;\n&quot;);
<a href="#h28-20" id="h28-20" class="h">@@ -531,22 +534,22 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 
 		html(&quot;&lt;h1&gt;search&lt;/h1&gt;\n&quot;);
 		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&quot;);
<a href="#h28-20-3" id="h28-20-3" class="d">-		if (cgit_virtual_root)
</a><a href="#h28-20-4" id="h28-20-4" class="d">-			html_attr(cgit_fileurl(cgit_query_repo, &quot;log&quot;,
</a><a href="#h28-20-5" id="h28-20-5" class="d">-					       cgit_query_path, NULL));
</a><a href="#h28-20-6" id="h28-20-6" class="i">+		if (ctx-&gt;cfg.virtual_root)
</a><a href="#h28-20-7" id="h28-20-7" class="i">+			html_attr(cgit_fileurl(ctx-&gt;qry.repo, &quot;log&quot;,
</a><a href="#h28-20-8" id="h28-20-8" class="i">+					       ctx-&gt;qry.path, NULL));
</a> 		html(&quot;&#39;&gt;\n&quot;);
 		add_hidden_formfields(1, 0, &quot;log&quot;);
 		html(&quot;&lt;select name=&#39;qt&#39;&gt;\n&quot;);
<a href="#h28-20-12" id="h28-20-12" class="d">-		html_option(&quot;grep&quot;, &quot;log msg&quot;, cgit_query_grep);
</a><a href="#h28-20-13" id="h28-20-13" class="d">-		html_option(&quot;author&quot;, &quot;author&quot;, cgit_query_grep);
</a><a href="#h28-20-14" id="h28-20-14" class="d">-		html_option(&quot;committer&quot;, &quot;committer&quot;, cgit_query_grep);
</a><a href="#h28-20-15" id="h28-20-15" class="i">+		html_option(&quot;grep&quot;, &quot;log msg&quot;, ctx-&gt;qry.grep);
</a><a href="#h28-20-16" id="h28-20-16" class="i">+		html_option(&quot;author&quot;, &quot;author&quot;, ctx-&gt;qry.grep);
</a><a href="#h28-20-17" id="h28-20-17" class="i">+		html_option(&quot;committer&quot;, &quot;committer&quot;, ctx-&gt;qry.grep);
</a> 		html(&quot;&lt;/select&gt;\n&quot;);
 		html(&quot;&lt;input class=&#39;txt&#39; type=&#39;text&#39; name=&#39;q&#39; value=&#39;&quot;);
<a href="#h28-20-20" id="h28-20-20" class="d">-		html_attr(cgit_query_search);
</a><a href="#h28-20-21" id="h28-20-21" class="i">+		html_attr(ctx-&gt;qry.search);
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 		html(&quot;&lt;/form&gt;\n&quot;);
 	} else {
<a href="#h28-20-25" id="h28-20-25" class="d">-		if (!cgit_index_info || html_include(cgit_index_info))
</a><a href="#h28-20-26" id="h28-20-26" class="i">+		if (!ctx-&gt;cfg.index_info || html_include(ctx-&gt;cfg.index_info))
</a> 			html(default_info);
 	}
 
<a href="#h28-21" id="h28-21" class="h">@@ -555,16 +558,34 @@ void cgit_print_pageheader(char *title, int show_search)
</a> 	html(&quot;&lt;td id=&#39;content&#39;&gt;\n&quot;);
 }
 
<a href="#h28-21-3" id="h28-21-3" class="d">-
</a><a href="#h28-21-4" id="h28-21-4" class="d">-void cgit_print_snapshot_start(const char *mimetype, const char *filename,
</a><a href="#h28-21-5" id="h28-21-5" class="d">-			       struct cacheitem *item)
</a><a href="#h28-21-6" id="h28-21-6" class="i">+void cgit_print_filemode(unsigned short mode)
</a> {
<a href="#h28-21-8" id="h28-21-8" class="d">-	htmlf(&quot;Content-Type: %s\n&quot;, mimetype);
</a><a href="#h28-21-9" id="h28-21-9" class="d">-	htmlf(&quot;Content-Disposition: inline; filename=\&quot;%s\&quot;\n&quot;, filename);
</a><a href="#h28-21-10" id="h28-21-10" class="d">-	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(item-&gt;st.st_mtime));
</a><a href="#h28-21-11" id="h28-21-11" class="d">-	htmlf(&quot;Expires: %s\n&quot;, http_date(item-&gt;st.st_mtime +
</a><a href="#h28-21-12" id="h28-21-12" class="d">-					 ttl_seconds(item-&gt;ttl)));
</a><a href="#h28-21-13" id="h28-21-13" class="d">-	html(&quot;\n&quot;);
</a><a href="#h28-21-14" id="h28-21-14" class="i">+	if (S_ISDIR(mode))
</a><a href="#h28-21-15" id="h28-21-15" class="i">+		html(&quot;d&quot;);
</a><a href="#h28-21-16" id="h28-21-16" class="i">+	else if (S_ISLNK(mode))
</a><a href="#h28-21-17" id="h28-21-17" class="i">+		html(&quot;l&quot;);
</a><a href="#h28-21-18" id="h28-21-18" class="i">+	else if (S_ISGITLINK(mode))
</a><a href="#h28-21-19" id="h28-21-19" class="i">+		html(&quot;m&quot;);
</a><a href="#h28-21-20" id="h28-21-20" class="i">+	else
</a><a href="#h28-21-21" id="h28-21-21" class="i">+		html(&quot;-&quot;);
</a><a href="#h28-21-22" id="h28-21-22" class="i">+	html_fileperm(mode &gt;&gt; 6);
</a><a href="#h28-21-23" id="h28-21-23" class="i">+	html_fileperm(mode &gt;&gt; 3);
</a><a href="#h28-21-24" id="h28-21-24" class="i">+	html_fileperm(mode);
</a> }
 
<a href="#h28-21-27" id="h28-21-27" class="d">-/* vim:set sw=8: */
</a><a href="#h28-21-28" id="h28-21-28" class="i">+void cgit_print_snapshot_links(const char *repo, const char *head,
</a><a href="#h28-21-29" id="h28-21-29" class="i">+			       const char *hex, int snapshots)
</a><a href="#h28-21-30" id="h28-21-30" class="i">+{
</a><a href="#h28-21-31" id="h28-21-31" class="i">+	const struct cgit_snapshot_format* f;
</a><a href="#h28-21-32" id="h28-21-32" class="i">+    	char *filename;
</a><a href="#h28-21-33" id="h28-21-33" class="i">+
</a><a href="#h28-21-34" id="h28-21-34" class="i">+	for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
</a><a href="#h28-21-35" id="h28-21-35" class="i">+		if (!(snapshots &amp; f-&gt;bit))
</a><a href="#h28-21-36" id="h28-21-36" class="i">+			continue;
</a><a href="#h28-21-37" id="h28-21-37" class="i">+		filename = fmt(&quot;%s-%s%s&quot;, cgit_repobasename(repo), hex,
</a><a href="#h28-21-38" id="h28-21-38" class="i">+			       f-&gt;suffix);
</a><a href="#h28-21-39" id="h28-21-39" class="i">+		cgit_snapshot_link(filename, NULL, NULL, (char *)head,
</a><a href="#h28-21-40" id="h28-21-40" class="i">+				   (char *)hex, filename);
</a><a href="#h28-21-41" id="h28-21-41" class="i">+		html(&quot;&lt;br/&gt;&quot;);
</a><a href="#h28-21-42" id="h28-21-42" class="i">+	}
</a><a href="#h28-21-43" id="h28-21-43" class="i">+}
</a><b>diff --git a/<a id="h29" href="../file/ui-shared.h.html">ui-shared.h</a> b/<a href="../file/ui-shared.h.html">ui-shared.h</a></b>
<a href="#h29-0" id="h29-0" class="h">@@ -0,0 +1,36 @@
</a><a href="#h29-0-0" id="h29-0-0" class="i">+#ifndef UI_SHARED_H
</a><a href="#h29-0-1" id="h29-0-1" class="i">+#define UI_SHARED_H
</a><a href="#h29-0-2" id="h29-0-2" class="i">+
</a><a href="#h29-0-3" id="h29-0-3" class="i">+extern char *cgit_repourl(const char *reponame);
</a><a href="#h29-0-4" id="h29-0-4" class="i">+extern char *cgit_fileurl(const char *reponame, const char *pagename,
</a><a href="#h29-0-5" id="h29-0-5" class="i">+			  const char *filename, const char *query);
</a><a href="#h29-0-6" id="h29-0-6" class="i">+extern char *cgit_pageurl(const char *reponame, const char *pagename,
</a><a href="#h29-0-7" id="h29-0-7" class="i">+			  const char *query);
</a><a href="#h29-0-8" id="h29-0-8" class="i">+
</a><a href="#h29-0-9" id="h29-0-9" class="i">+extern void cgit_tree_link(char *name, char *title, char *class, char *head,
</a><a href="#h29-0-10" id="h29-0-10" class="i">+			   char *rev, char *path);
</a><a href="#h29-0-11" id="h29-0-11" class="i">+extern void cgit_log_link(char *name, char *title, char *class, char *head,
</a><a href="#h29-0-12" id="h29-0-12" class="i">+			  char *rev, char *path, int ofs, char *grep,
</a><a href="#h29-0-13" id="h29-0-13" class="i">+			  char *pattern);
</a><a href="#h29-0-14" id="h29-0-14" class="i">+extern void cgit_commit_link(char *name, char *title, char *class, char *head,
</a><a href="#h29-0-15" id="h29-0-15" class="i">+			     char *rev);
</a><a href="#h29-0-16" id="h29-0-16" class="i">+extern void cgit_refs_link(char *name, char *title, char *class, char *head,
</a><a href="#h29-0-17" id="h29-0-17" class="i">+			   char *rev, char *path);
</a><a href="#h29-0-18" id="h29-0-18" class="i">+extern void cgit_snapshot_link(char *name, char *title, char *class,
</a><a href="#h29-0-19" id="h29-0-19" class="i">+			       char *head, char *rev, char *archivename);
</a><a href="#h29-0-20" id="h29-0-20" class="i">+extern void cgit_diff_link(char *name, char *title, char *class, char *head,
</a><a href="#h29-0-21" id="h29-0-21" class="i">+			   char *new_rev, char *old_rev, char *path);
</a><a href="#h29-0-22" id="h29-0-22" class="i">+extern void cgit_object_link(struct object *obj);
</a><a href="#h29-0-23" id="h29-0-23" class="i">+
</a><a href="#h29-0-24" id="h29-0-24" class="i">+extern void cgit_print_error(char *msg);
</a><a href="#h29-0-25" id="h29-0-25" class="i">+extern void cgit_print_date(time_t secs, char *format);
</a><a href="#h29-0-26" id="h29-0-26" class="i">+extern void cgit_print_age(time_t t, time_t max_relative, char *format);
</a><a href="#h29-0-27" id="h29-0-27" class="i">+extern void cgit_print_http_headers(struct cgit_context *ctx);
</a><a href="#h29-0-28" id="h29-0-28" class="i">+extern void cgit_print_docstart(struct cgit_context *ctx);
</a><a href="#h29-0-29" id="h29-0-29" class="i">+extern void cgit_print_docend();
</a><a href="#h29-0-30" id="h29-0-30" class="i">+extern void cgit_print_pageheader(struct cgit_context *ctx);
</a><a href="#h29-0-31" id="h29-0-31" class="i">+extern void cgit_print_filemode(unsigned short mode);
</a><a href="#h29-0-32" id="h29-0-32" class="i">+extern void cgit_print_snapshot_links(const char *repo, const char *head,
</a><a href="#h29-0-33" id="h29-0-33" class="i">+				      const char *hex, int snapshots);
</a><a href="#h29-0-34" id="h29-0-34" class="i">+
</a><a href="#h29-0-35" id="h29-0-35" class="i">+#endif /* UI_SHARED_H */
</a><b>diff --git a/<a id="h30" href="../file/ui-snapshot.c.html">ui-snapshot.c</a> b/<a href="../file/ui-snapshot.c.html">ui-snapshot.c</a></b>
<a href="#h30-0" id="h30-0" class="h">@@ -7,6 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h30-0-3" id="h30-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h30-0-4" id="h30-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 static int write_compressed_tar_archive(struct archiver_args *args,const char *filter)
 {
<a href="#h30-1" id="h30-1" class="h">@@ -54,104 +56,59 @@ static int write_tar_bzip2_archive(struct archiver_args *args)
</a> 	return write_compressed_tar_archive(args,&quot;bzip2&quot;);
 }
 
<a href="#h30-1-3" id="h30-1-3" class="d">-static const struct snapshot_archive_t {
</a><a href="#h30-1-4" id="h30-1-4" class="d">-    	const char *suffix;
</a><a href="#h30-1-5" id="h30-1-5" class="d">-	const char *mimetype;
</a><a href="#h30-1-6" id="h30-1-6" class="d">-	write_archive_fn_t write_func;
</a><a href="#h30-1-7" id="h30-1-7" class="d">-	int bit;
</a><a href="#h30-1-8" id="h30-1-8" class="d">-}	snapshot_archives[] = {
</a><a href="#h30-1-9" id="h30-1-9" class="i">+const struct cgit_snapshot_format cgit_snapshot_formats[] = {
</a> 	{ &quot;.zip&quot;, &quot;application/x-zip&quot;, write_zip_archive, 0x1 },
 	{ &quot;.tar.gz&quot;, &quot;application/x-tar&quot;, write_tar_gzip_archive, 0x2 },
 	{ &quot;.tar.bz2&quot;, &quot;application/x-tar&quot;, write_tar_bzip2_archive, 0x4 },
<a href="#h30-1-13" id="h30-1-13" class="d">-	{ &quot;.tar&quot;, &quot;application/x-tar&quot;, write_tar_archive, 0x8 }
</a><a href="#h30-1-14" id="h30-1-14" class="i">+	{ &quot;.tar&quot;, &quot;application/x-tar&quot;, write_tar_archive, 0x8 },
</a><a href="#h30-1-15" id="h30-1-15" class="i">+	{}
</a> };
 
<a href="#h30-1-18" id="h30-1-18" class="d">-#define snapshot_archives_len (sizeof(snapshot_archives) / sizeof(*snapshot_archives))
</a><a href="#h30-1-19" id="h30-1-19" class="d">-
</a><a href="#h30-1-20" id="h30-1-20" class="d">-void cgit_print_snapshot(struct cacheitem *item, const char *head,
</a><a href="#h30-1-21" id="h30-1-21" class="i">+static int make_snapshot(const struct cgit_snapshot_format *format,
</a> 			 const char *hex, const char *prefix,
<a href="#h30-1-23" id="h30-1-23" class="d">-			 const char *filename, int snapshots)
</a><a href="#h30-1-24" id="h30-1-24" class="i">+			 const char *filename)
</a> {
<a href="#h30-1-26" id="h30-1-26" class="d">-	const struct snapshot_archive_t* sat;
</a> 	struct archiver_args args;
 	struct commit *commit;
 	unsigned char sha1[20];
<a href="#h30-1-30" id="h30-1-30" class="d">-	int f, sl, fnl = strlen(filename);
</a> 
<a href="#h30-1-32" id="h30-1-32" class="d">-	for(f=0; f&lt;snapshot_archives_len; f++) {
</a><a href="#h30-1-33" id="h30-1-33" class="d">-		sat = &amp;snapshot_archives[f];
</a><a href="#h30-1-34" id="h30-1-34" class="d">-		if(!(snapshots &amp; sat-&gt;bit))
</a><a href="#h30-1-35" id="h30-1-35" class="d">-			continue;
</a><a href="#h30-1-36" id="h30-1-36" class="d">-		sl = strlen(sat-&gt;suffix);
</a><a href="#h30-1-37" id="h30-1-37" class="d">-		if(fnl&lt;sl || strcmp(&amp;filename[fnl-sl],sat-&gt;suffix))
</a><a href="#h30-1-38" id="h30-1-38" class="d">-			continue;
</a><a href="#h30-1-39" id="h30-1-39" class="d">-		if (!hex)
</a><a href="#h30-1-40" id="h30-1-40" class="d">-			hex = head;
</a><a href="#h30-1-41" id="h30-1-41" class="d">-		if(get_sha1(hex, sha1)) {
</a><a href="#h30-1-42" id="h30-1-42" class="d">-			cgit_print_error(fmt(&quot;Bad object id: %s&quot;, hex));
</a><a href="#h30-1-43" id="h30-1-43" class="d">-			return;
</a><a href="#h30-1-44" id="h30-1-44" class="d">-		}
</a><a href="#h30-1-45" id="h30-1-45" class="d">-		commit = lookup_commit_reference(sha1);
</a><a href="#h30-1-46" id="h30-1-46" class="d">-		if(!commit) {
</a><a href="#h30-1-47" id="h30-1-47" class="d">-			cgit_print_error(fmt(&quot;Not a commit reference: %s&quot;, hex));
</a><a href="#h30-1-48" id="h30-1-48" class="d">-			return;;
</a><a href="#h30-1-49" id="h30-1-49" class="d">-		}
</a><a href="#h30-1-50" id="h30-1-50" class="d">-		memset(&amp;args,0,sizeof(args));
</a><a href="#h30-1-51" id="h30-1-51" class="d">-		args.base = fmt(&quot;%s/&quot;, prefix);
</a><a href="#h30-1-52" id="h30-1-52" class="d">-		args.tree = commit-&gt;tree;
</a><a href="#h30-1-53" id="h30-1-53" class="d">-		args.time = commit-&gt;date;
</a><a href="#h30-1-54" id="h30-1-54" class="d">-		cgit_print_snapshot_start(sat-&gt;mimetype, filename, item);
</a><a href="#h30-1-55" id="h30-1-55" class="d">-		(*sat-&gt;write_func)(&amp;args);
</a><a href="#h30-1-56" id="h30-1-56" class="d">-		return;
</a><a href="#h30-1-57" id="h30-1-57" class="i">+	if(get_sha1(hex, sha1)) {
</a><a href="#h30-1-58" id="h30-1-58" class="i">+		cgit_print_error(fmt(&quot;Bad object id: %s&quot;, hex));
</a><a href="#h30-1-59" id="h30-1-59" class="i">+		return 1;
</a> 	}
<a href="#h30-1-61" id="h30-1-61" class="d">-	cgit_print_error(fmt(&quot;Unsupported snapshot format: %s&quot;, filename));
</a><a href="#h30-1-62" id="h30-1-62" class="d">-}
</a><a href="#h30-1-63" id="h30-1-63" class="d">-
</a><a href="#h30-1-64" id="h30-1-64" class="d">-void cgit_print_snapshot_links(const char *repo, const char *head,
</a><a href="#h30-1-65" id="h30-1-65" class="d">-			       const char *hex, int snapshots)
</a><a href="#h30-1-66" id="h30-1-66" class="d">-{
</a><a href="#h30-1-67" id="h30-1-67" class="d">-	const struct snapshot_archive_t* sat;
</a><a href="#h30-1-68" id="h30-1-68" class="d">-    	char *filename;
</a><a href="#h30-1-69" id="h30-1-69" class="d">-	int f;
</a><a href="#h30-1-70" id="h30-1-70" class="d">-
</a><a href="#h30-1-71" id="h30-1-71" class="d">-	for(f=0; f&lt;snapshot_archives_len; f++) {
</a><a href="#h30-1-72" id="h30-1-72" class="d">-		sat = &amp;snapshot_archives[f];
</a><a href="#h30-1-73" id="h30-1-73" class="d">-		if(!(snapshots &amp; sat-&gt;bit))
</a><a href="#h30-1-74" id="h30-1-74" class="d">-			continue;
</a><a href="#h30-1-75" id="h30-1-75" class="d">-		filename = fmt(&quot;%s-%s%s&quot;, cgit_repobasename(repo), hex,
</a><a href="#h30-1-76" id="h30-1-76" class="d">-			       sat-&gt;suffix);
</a><a href="#h30-1-77" id="h30-1-77" class="d">-		cgit_snapshot_link(filename, NULL, NULL, (char *)head,
</a><a href="#h30-1-78" id="h30-1-78" class="d">-				   (char *)hex, filename);
</a><a href="#h30-1-79" id="h30-1-79" class="d">-		html(&quot;&lt;br/&gt;&quot;);
</a><a href="#h30-1-80" id="h30-1-80" class="i">+	commit = lookup_commit_reference(sha1);
</a><a href="#h30-1-81" id="h30-1-81" class="i">+	if(!commit) {
</a><a href="#h30-1-82" id="h30-1-82" class="i">+		cgit_print_error(fmt(&quot;Not a commit reference: %s&quot;, hex));
</a><a href="#h30-1-83" id="h30-1-83" class="i">+		return 1;
</a> 	}
<a href="#h30-1-85" id="h30-1-85" class="i">+	memset(&amp;args, 0, sizeof(args));
</a><a href="#h30-1-86" id="h30-1-86" class="i">+	args.base = fmt(&quot;%s/&quot;, prefix);
</a><a href="#h30-1-87" id="h30-1-87" class="i">+	args.tree = commit-&gt;tree;
</a><a href="#h30-1-88" id="h30-1-88" class="i">+	args.time = commit-&gt;date;
</a><a href="#h30-1-89" id="h30-1-89" class="i">+	ctx.page.mimetype = xstrdup(format-&gt;mimetype);
</a><a href="#h30-1-90" id="h30-1-90" class="i">+	ctx.page.filename = xstrdup(filename);
</a><a href="#h30-1-91" id="h30-1-91" class="i">+	cgit_print_http_headers(&amp;ctx);
</a><a href="#h30-1-92" id="h30-1-92" class="i">+	format-&gt;write_func(&amp;args);
</a><a href="#h30-1-93" id="h30-1-93" class="i">+	return 0;
</a> }
 
<a href="#h30-1-96" id="h30-1-96" class="d">-int cgit_parse_snapshots_mask(const char *str)
</a><a href="#h30-1-97" id="h30-1-97" class="i">+void cgit_print_snapshot(const char *head, const char *hex, const char *prefix,
</a><a href="#h30-1-98" id="h30-1-98" class="i">+			 const char *filename, int snapshots)
</a> {
<a href="#h30-1-100" id="h30-1-100" class="d">-	const struct snapshot_archive_t* sat;
</a><a href="#h30-1-101" id="h30-1-101" class="d">-	static const char *delim = &quot; \t,:/|;&quot;;
</a><a href="#h30-1-102" id="h30-1-102" class="d">-	int f, tl, sl, rv = 0;
</a><a href="#h30-1-103" id="h30-1-103" class="d">-
</a><a href="#h30-1-104" id="h30-1-104" class="d">-	/* favor legacy setting */
</a><a href="#h30-1-105" id="h30-1-105" class="d">-	if(atoi(str))
</a><a href="#h30-1-106" id="h30-1-106" class="d">-		return 1;
</a><a href="#h30-1-107" id="h30-1-107" class="d">-	for(;;) {
</a><a href="#h30-1-108" id="h30-1-108" class="d">-		str += strspn(str,delim);
</a><a href="#h30-1-109" id="h30-1-109" class="d">-		tl = strcspn(str,delim);
</a><a href="#h30-1-110" id="h30-1-110" class="d">-		if(!tl)
</a><a href="#h30-1-111" id="h30-1-111" class="d">-			break;
</a><a href="#h30-1-112" id="h30-1-112" class="d">-		for(f=0; f&lt;snapshot_archives_len; f++) {
</a><a href="#h30-1-113" id="h30-1-113" class="d">-			sat = &amp;snapshot_archives[f];
</a><a href="#h30-1-114" id="h30-1-114" class="d">-			sl = strlen(sat-&gt;suffix);
</a><a href="#h30-1-115" id="h30-1-115" class="d">-			if((tl == sl &amp;&amp; !strncmp(sat-&gt;suffix, str, tl)) ||
</a><a href="#h30-1-116" id="h30-1-116" class="d">-			   (tl == sl-1 &amp;&amp; !strncmp(sat-&gt;suffix+1, str, tl-1))) {
</a><a href="#h30-1-117" id="h30-1-117" class="d">-				rv |= sat-&gt;bit;
</a><a href="#h30-1-118" id="h30-1-118" class="d">-				break;
</a><a href="#h30-1-119" id="h30-1-119" class="d">-			}
</a><a href="#h30-1-120" id="h30-1-120" class="d">-		}
</a><a href="#h30-1-121" id="h30-1-121" class="d">-		str += tl;
</a><a href="#h30-1-122" id="h30-1-122" class="i">+	const struct cgit_snapshot_format* f;
</a><a href="#h30-1-123" id="h30-1-123" class="i">+	int sl, fnl;
</a><a href="#h30-1-124" id="h30-1-124" class="i">+
</a><a href="#h30-1-125" id="h30-1-125" class="i">+	fnl = strlen(filename);
</a><a href="#h30-1-126" id="h30-1-126" class="i">+	if (!hex)
</a><a href="#h30-1-127" id="h30-1-127" class="i">+		hex = head;
</a><a href="#h30-1-128" id="h30-1-128" class="i">+	for (f = cgit_snapshot_formats; f-&gt;suffix; f++) {
</a><a href="#h30-1-129" id="h30-1-129" class="i">+		if (!(snapshots &amp; f-&gt;bit))
</a><a href="#h30-1-130" id="h30-1-130" class="i">+			continue;
</a><a href="#h30-1-131" id="h30-1-131" class="i">+		sl = strlen(f-&gt;suffix);
</a><a href="#h30-1-132" id="h30-1-132" class="i">+		if(fnl &lt; sl || strcmp(&amp;filename[fnl-sl], f-&gt;suffix))
</a><a href="#h30-1-133" id="h30-1-133" class="i">+			continue;
</a><a href="#h30-1-134" id="h30-1-134" class="i">+		make_snapshot(f, hex, prefix, filename);
</a><a href="#h30-1-135" id="h30-1-135" class="i">+		return;
</a> 	}
<a href="#h30-1-137" id="h30-1-137" class="d">-	return rv;
</a><a href="#h30-1-138" id="h30-1-138" class="i">+	cgit_print_error(fmt(&quot;Unsupported snapshot format: %s&quot;, filename));
</a> }
<a href="#h30-1-140" id="h30-1-140" class="d">-
</a><a href="#h30-1-141" id="h30-1-141" class="d">-/* vim:set sw=8: */
</a><b>diff --git a/<a id="h31" href="../file/ui-snapshot.h.html">ui-snapshot.h</a> b/<a href="../file/ui-snapshot.h.html">ui-snapshot.h</a></b>
<a href="#h31-0" id="h31-0" class="h">@@ -0,0 +1,8 @@
</a><a href="#h31-0-0" id="h31-0-0" class="i">+#ifndef UI_SNAPSHOT_H
</a><a href="#h31-0-1" id="h31-0-1" class="i">+#define UI_SNAPSHOT_H
</a><a href="#h31-0-2" id="h31-0-2" class="i">+
</a><a href="#h31-0-3" id="h31-0-3" class="i">+extern void cgit_print_snapshot(const char *head, const char *hex,
</a><a href="#h31-0-4" id="h31-0-4" class="i">+				const char *prefix, const char *filename,
</a><a href="#h31-0-5" id="h31-0-5" class="i">+				int snapshot);
</a><a href="#h31-0-6" id="h31-0-6" class="i">+
</a><a href="#h31-0-7" id="h31-0-7" class="i">+#endif /* UI_SNAPSHOT_H */
</a><b>diff --git a/<a id="h32" href="../file/ui-summary.c.html">ui-summary.c</a> b/<a href="../file/ui-summary.c.html">ui-summary.c</a></b>
<a href="#h32-0" id="h32-0" class="h">@@ -7,194 +7,25 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h32-0-3" id="h32-0-3" class="d">-
</a><a href="#h32-0-4" id="h32-0-4" class="d">-static int header;
</a><a href="#h32-0-5" id="h32-0-5" class="d">-
</a><a href="#h32-0-6" id="h32-0-6" class="d">-static int cmp_age(int age1, int age2)
</a><a href="#h32-0-7" id="h32-0-7" class="d">-{
</a><a href="#h32-0-8" id="h32-0-8" class="d">-	if (age1 != 0 &amp;&amp; age2 != 0)
</a><a href="#h32-0-9" id="h32-0-9" class="d">-		return age2 - age1;
</a><a href="#h32-0-10" id="h32-0-10" class="d">-
</a><a href="#h32-0-11" id="h32-0-11" class="d">-	if (age1 == 0 &amp;&amp; age2 == 0)
</a><a href="#h32-0-12" id="h32-0-12" class="d">-		return 0;
</a><a href="#h32-0-13" id="h32-0-13" class="d">-
</a><a href="#h32-0-14" id="h32-0-14" class="d">-	if (age1 == 0)
</a><a href="#h32-0-15" id="h32-0-15" class="d">-		return +1;
</a><a href="#h32-0-16" id="h32-0-16" class="d">-
</a><a href="#h32-0-17" id="h32-0-17" class="d">-	return -1;
</a><a href="#h32-0-18" id="h32-0-18" class="d">-}
</a><a href="#h32-0-19" id="h32-0-19" class="d">-
</a><a href="#h32-0-20" id="h32-0-20" class="d">-static int cmp_ref_name(const void *a, const void *b)
</a><a href="#h32-0-21" id="h32-0-21" class="d">-{
</a><a href="#h32-0-22" id="h32-0-22" class="d">-	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h32-0-23" id="h32-0-23" class="d">-	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h32-0-24" id="h32-0-24" class="d">-
</a><a href="#h32-0-25" id="h32-0-25" class="d">-	return strcmp(r1-&gt;refname, r2-&gt;refname);
</a><a href="#h32-0-26" id="h32-0-26" class="d">-}
</a><a href="#h32-0-27" id="h32-0-27" class="d">-
</a><a href="#h32-0-28" id="h32-0-28" class="d">-static int cmp_branch_age(const void *a, const void *b)
</a><a href="#h32-0-29" id="h32-0-29" class="d">-{
</a><a href="#h32-0-30" id="h32-0-30" class="d">-	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h32-0-31" id="h32-0-31" class="d">-	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h32-0-32" id="h32-0-32" class="d">-
</a><a href="#h32-0-33" id="h32-0-33" class="d">-	return cmp_age(r1-&gt;commit-&gt;committer_date, r2-&gt;commit-&gt;committer_date);
</a><a href="#h32-0-34" id="h32-0-34" class="d">-}
</a><a href="#h32-0-35" id="h32-0-35" class="d">-
</a><a href="#h32-0-36" id="h32-0-36" class="d">-static int cmp_tag_age(const void *a, const void *b)
</a><a href="#h32-0-37" id="h32-0-37" class="d">-{
</a><a href="#h32-0-38" id="h32-0-38" class="d">-	struct refinfo *r1 = *(struct refinfo **)a;
</a><a href="#h32-0-39" id="h32-0-39" class="d">-	struct refinfo *r2 = *(struct refinfo **)b;
</a><a href="#h32-0-40" id="h32-0-40" class="d">-
</a><a href="#h32-0-41" id="h32-0-41" class="d">-	return cmp_age(r1-&gt;tag-&gt;tagger_date, r2-&gt;tag-&gt;tagger_date);
</a><a href="#h32-0-42" id="h32-0-42" class="d">-}
</a><a href="#h32-0-43" id="h32-0-43" class="d">-
</a><a href="#h32-0-44" id="h32-0-44" class="d">-static int print_branch(struct refinfo *ref)
</a><a href="#h32-0-45" id="h32-0-45" class="d">-{
</a><a href="#h32-0-46" id="h32-0-46" class="d">-	struct commitinfo *info = ref-&gt;commit;
</a><a href="#h32-0-47" id="h32-0-47" class="d">-	char *name = (char *)ref-&gt;refname;
</a><a href="#h32-0-48" id="h32-0-48" class="d">-
</a><a href="#h32-0-49" id="h32-0-49" class="d">-	if (!info)
</a><a href="#h32-0-50" id="h32-0-50" class="d">-		return 1;
</a><a href="#h32-0-51" id="h32-0-51" class="d">-	html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-52" id="h32-0-52" class="d">-	cgit_log_link(name, NULL, NULL, name, NULL, NULL, 0, NULL, NULL);
</a><a href="#h32-0-53" id="h32-0-53" class="d">-	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-54" id="h32-0-54" class="d">-
</a><a href="#h32-0-55" id="h32-0-55" class="d">-	if (ref-&gt;object-&gt;type == OBJ_COMMIT) {
</a><a href="#h32-0-56" id="h32-0-56" class="d">-		cgit_print_age(info-&gt;commit-&gt;date, -1, NULL);
</a><a href="#h32-0-57" id="h32-0-57" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-58" id="h32-0-58" class="d">-		html_txt(info-&gt;author);
</a><a href="#h32-0-59" id="h32-0-59" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-60" id="h32-0-60" class="d">-		cgit_commit_link(info-&gt;subject, NULL, NULL, name, NULL);
</a><a href="#h32-0-61" id="h32-0-61" class="d">-	} else {
</a><a href="#h32-0-62" id="h32-0-62" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-63" id="h32-0-63" class="d">-		cgit_object_link(ref-&gt;object);
</a><a href="#h32-0-64" id="h32-0-64" class="d">-	}
</a><a href="#h32-0-65" id="h32-0-65" class="d">-	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h32-0-66" id="h32-0-66" class="d">-	return 0;
</a><a href="#h32-0-67" id="h32-0-67" class="d">-}
</a><a href="#h32-0-68" id="h32-0-68" class="d">-
</a><a href="#h32-0-69" id="h32-0-69" class="d">-static void print_tag_header()
</a><a href="#h32-0-70" id="h32-0-70" class="d">-{
</a><a href="#h32-0-71" id="h32-0-71" class="d">-	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Tag&lt;/th&gt;&quot;
</a><a href="#h32-0-72" id="h32-0-72" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Age&lt;/th&gt;&quot;
</a><a href="#h32-0-73" id="h32-0-73" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h32-0-74" id="h32-0-74" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Reference&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h32-0-75" id="h32-0-75" class="d">-	header = 1;
</a><a href="#h32-0-76" id="h32-0-76" class="d">-}
</a><a href="#h32-0-77" id="h32-0-77" class="d">-
</a><a href="#h32-0-78" id="h32-0-78" class="d">-static int print_tag(struct refinfo *ref)
</a><a href="#h32-0-79" id="h32-0-79" class="d">-{
</a><a href="#h32-0-80" id="h32-0-80" class="d">-	struct tag *tag;
</a><a href="#h32-0-81" id="h32-0-81" class="d">-	struct taginfo *info;
</a><a href="#h32-0-82" id="h32-0-82" class="d">-	char *url, *name = (char *)ref-&gt;refname;
</a><a href="#h32-0-83" id="h32-0-83" class="d">-
</a><a href="#h32-0-84" id="h32-0-84" class="d">-	if (ref-&gt;object-&gt;type == OBJ_TAG) {
</a><a href="#h32-0-85" id="h32-0-85" class="d">-		tag = (struct tag *)ref-&gt;object;
</a><a href="#h32-0-86" id="h32-0-86" class="d">-		info = ref-&gt;tag;
</a><a href="#h32-0-87" id="h32-0-87" class="d">-		if (!tag || !info)
</a><a href="#h32-0-88" id="h32-0-88" class="d">-			return 1;
</a><a href="#h32-0-89" id="h32-0-89" class="d">-		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-90" id="h32-0-90" class="d">-		url = cgit_pageurl(cgit_query_repo, &quot;tag&quot;,
</a><a href="#h32-0-91" id="h32-0-91" class="d">-				   fmt(&quot;id=%s&quot;, name));
</a><a href="#h32-0-92" id="h32-0-92" class="d">-		html_link_open(url, NULL, NULL);
</a><a href="#h32-0-93" id="h32-0-93" class="d">-		html_txt(name);
</a><a href="#h32-0-94" id="h32-0-94" class="d">-		html_link_close();
</a><a href="#h32-0-95" id="h32-0-95" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-96" id="h32-0-96" class="d">-		if (info-&gt;tagger_date &gt; 0)
</a><a href="#h32-0-97" id="h32-0-97" class="d">-			cgit_print_age(info-&gt;tagger_date, -1, NULL);
</a><a href="#h32-0-98" id="h32-0-98" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-99" id="h32-0-99" class="d">-		if (info-&gt;tagger)
</a><a href="#h32-0-100" id="h32-0-100" class="d">-			html(info-&gt;tagger);
</a><a href="#h32-0-101" id="h32-0-101" class="d">-		html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-102" id="h32-0-102" class="d">-		cgit_object_link(tag-&gt;tagged);
</a><a href="#h32-0-103" id="h32-0-103" class="d">-		html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h32-0-104" id="h32-0-104" class="d">-	} else {
</a><a href="#h32-0-105" id="h32-0-105" class="d">-		if (!header)
</a><a href="#h32-0-106" id="h32-0-106" class="d">-			print_tag_header();
</a><a href="#h32-0-107" id="h32-0-107" class="d">-		html(&quot;&lt;tr&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-108" id="h32-0-108" class="d">-		html_txt(name);
</a><a href="#h32-0-109" id="h32-0-109" class="d">-		html(&quot;&lt;/td&gt;&lt;td colspan=&#39;2&#39;/&gt;&lt;td&gt;&quot;);
</a><a href="#h32-0-110" id="h32-0-110" class="d">-		cgit_object_link(ref-&gt;object);
</a><a href="#h32-0-111" id="h32-0-111" class="d">-		html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h32-0-112" id="h32-0-112" class="d">-	}
</a><a href="#h32-0-113" id="h32-0-113" class="d">-	return 0;
</a><a href="#h32-0-114" id="h32-0-114" class="d">-}
</a><a href="#h32-0-115" id="h32-0-115" class="d">-
</a><a href="#h32-0-116" id="h32-0-116" class="d">-static void print_refs_link(char *path)
</a><a href="#h32-0-117" id="h32-0-117" class="d">-{
</a><a href="#h32-0-118" id="h32-0-118" class="d">-	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&quot;);
</a><a href="#h32-0-119" id="h32-0-119" class="d">-	cgit_refs_link(&quot;[...]&quot;, NULL, NULL, cgit_query_head, NULL, path);
</a><a href="#h32-0-120" id="h32-0-120" class="d">-	html(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);
</a><a href="#h32-0-121" id="h32-0-121" class="d">-}
</a><a href="#h32-0-122" id="h32-0-122" class="d">-
</a><a href="#h32-0-123" id="h32-0-123" class="d">-void cgit_print_branches(int maxcount)
</a><a href="#h32-0-124" id="h32-0-124" class="d">-{
</a><a href="#h32-0-125" id="h32-0-125" class="d">-	struct reflist list;
</a><a href="#h32-0-126" id="h32-0-126" class="d">-	int i;
</a><a href="#h32-0-127" id="h32-0-127" class="d">-
</a><a href="#h32-0-128" id="h32-0-128" class="d">-	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;th class=&#39;left&#39;&gt;Branch&lt;/th&gt;&quot;
</a><a href="#h32-0-129" id="h32-0-129" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Idle&lt;/th&gt;&quot;
</a><a href="#h32-0-130" id="h32-0-130" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Author&lt;/th&gt;&quot;
</a><a href="#h32-0-131" id="h32-0-131" class="d">-	     &quot;&lt;th class=&#39;left&#39;&gt;Head commit&lt;/th&gt;&lt;/tr&gt;\n&quot;);
</a><a href="#h32-0-132" id="h32-0-132" class="d">-
</a><a href="#h32-0-133" id="h32-0-133" class="d">-	list.refs = NULL;
</a><a href="#h32-0-134" id="h32-0-134" class="d">-	list.alloc = list.count = 0;
</a><a href="#h32-0-135" id="h32-0-135" class="d">-	for_each_branch_ref(cgit_refs_cb, &amp;list);
</a><a href="#h32-0-136" id="h32-0-136" class="d">-
</a><a href="#h32-0-137" id="h32-0-137" class="d">-	if (maxcount == 0 || maxcount &gt; list.count)
</a><a href="#h32-0-138" id="h32-0-138" class="d">-		maxcount = list.count;
</a><a href="#h32-0-139" id="h32-0-139" class="d">-
</a><a href="#h32-0-140" id="h32-0-140" class="d">-	if (maxcount &lt; list.count) {
</a><a href="#h32-0-141" id="h32-0-141" class="d">-		qsort(list.refs, list.count, sizeof(*list.refs), cmp_branch_age);
</a><a href="#h32-0-142" id="h32-0-142" class="d">-		qsort(list.refs, maxcount, sizeof(*list.refs), cmp_ref_name);
</a><a href="#h32-0-143" id="h32-0-143" class="d">-	}
</a><a href="#h32-0-144" id="h32-0-144" class="d">-
</a><a href="#h32-0-145" id="h32-0-145" class="d">-	for(i=0; i&lt;maxcount; i++)
</a><a href="#h32-0-146" id="h32-0-146" class="d">-		print_branch(list.refs[i]);
</a><a href="#h32-0-147" id="h32-0-147" class="d">-
</a><a href="#h32-0-148" id="h32-0-148" class="d">-	if (maxcount &lt; list.count)
</a><a href="#h32-0-149" id="h32-0-149" class="d">-		print_refs_link(&quot;heads&quot;);
</a><a href="#h32-0-150" id="h32-0-150" class="d">-}
</a><a href="#h32-0-151" id="h32-0-151" class="d">-
</a><a href="#h32-0-152" id="h32-0-152" class="d">-void cgit_print_tags(int maxcount)
</a><a href="#h32-0-153" id="h32-0-153" class="d">-{
</a><a href="#h32-0-154" id="h32-0-154" class="d">-	struct reflist list;
</a><a href="#h32-0-155" id="h32-0-155" class="d">-	int i;
</a><a href="#h32-0-156" id="h32-0-156" class="d">-
</a><a href="#h32-0-157" id="h32-0-157" class="d">-	header = 0;
</a><a href="#h32-0-158" id="h32-0-158" class="d">-	list.refs = NULL;
</a><a href="#h32-0-159" id="h32-0-159" class="d">-	list.alloc = list.count = 0;
</a><a href="#h32-0-160" id="h32-0-160" class="d">-	for_each_tag_ref(cgit_refs_cb, &amp;list);
</a><a href="#h32-0-161" id="h32-0-161" class="d">-	if (list.count == 0)
</a><a href="#h32-0-162" id="h32-0-162" class="d">-		return;
</a><a href="#h32-0-163" id="h32-0-163" class="d">-	qsort(list.refs, list.count, sizeof(*list.refs), cmp_tag_age);
</a><a href="#h32-0-164" id="h32-0-164" class="d">-	if (!maxcount)
</a><a href="#h32-0-165" id="h32-0-165" class="d">-		maxcount = list.count;
</a><a href="#h32-0-166" id="h32-0-166" class="d">-	else if (maxcount &gt; list.count)
</a><a href="#h32-0-167" id="h32-0-167" class="d">-		maxcount = list.count;
</a><a href="#h32-0-168" id="h32-0-168" class="d">-	print_tag_header();
</a><a href="#h32-0-169" id="h32-0-169" class="d">-	for(i=0; i&lt;maxcount; i++)
</a><a href="#h32-0-170" id="h32-0-170" class="d">-		print_tag(list.refs[i]);
</a><a href="#h32-0-171" id="h32-0-171" class="d">-
</a><a href="#h32-0-172" id="h32-0-172" class="d">-	if (maxcount &lt; list.count)
</a><a href="#h32-0-173" id="h32-0-173" class="d">-		print_refs_link(&quot;tags&quot;);
</a><a href="#h32-0-174" id="h32-0-174" class="d">-}
</a><a href="#h32-0-175" id="h32-0-175" class="i">+#include &quot;html.h&quot;
</a><a href="#h32-0-176" id="h32-0-176" class="i">+#include &quot;ui-log.h&quot;
</a><a href="#h32-0-177" id="h32-0-177" class="i">+#include &quot;ui-refs.h&quot;
</a> 
 void cgit_print_summary()
 {
<a href="#h32-0-181" id="h32-0-181" class="d">-	if (cgit_repo-&gt;readme) {
</a><a href="#h32-0-182" id="h32-0-182" class="i">+	if (ctx.repo-&gt;readme) {
</a> 		html(&quot;&lt;div id=&#39;summary&#39;&gt;&quot;);
<a href="#h32-0-184" id="h32-0-184" class="d">-		html_include(cgit_repo-&gt;readme);
</a><a href="#h32-0-185" id="h32-0-185" class="i">+		html_include(ctx.repo-&gt;readme);
</a> 		html(&quot;&lt;/div&gt;&quot;);
 	}
<a href="#h32-0-188" id="h32-0-188" class="d">-	if (cgit_summary_log &gt; 0)
</a><a href="#h32-0-189" id="h32-0-189" class="d">-		cgit_print_log(cgit_query_head, 0, cgit_summary_log, NULL,
</a><a href="#h32-0-190" id="h32-0-190" class="i">+	if (ctx.cfg.summary_log &gt; 0)
</a><a href="#h32-0-191" id="h32-0-191" class="i">+		cgit_print_log(ctx.qry.head, 0, ctx.cfg.summary_log, NULL,
</a> 			       NULL, NULL, 0);
 	html(&quot;&lt;table summary=&#39;repository info&#39; class=&#39;list nowrap&#39;&gt;&quot;);
<a href="#h32-0-194" id="h32-0-194" class="d">-	if (cgit_summary_log &gt; 0)
</a><a href="#h32-0-195" id="h32-0-195" class="i">+	if (ctx.cfg.summary_log &gt; 0)
</a> 		html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;);
<a href="#h32-0-197" id="h32-0-197" class="d">-	cgit_print_branches(cgit_summary_branches);
</a><a href="#h32-0-198" id="h32-0-198" class="i">+	cgit_print_branches(ctx.cfg.summary_branches);
</a> 	html(&quot;&lt;tr class=&#39;nohover&#39;&gt;&lt;td colspan=&#39;4&#39;&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;);
<a href="#h32-0-200" id="h32-0-200" class="d">-	cgit_print_tags(cgit_summary_tags);
</a><a href="#h32-0-201" id="h32-0-201" class="i">+	cgit_print_tags(ctx.cfg.summary_tags);
</a> 	html(&quot;&lt;/table&gt;&quot;);
 }
<b>diff --git a/<a id="h33" href="../file/ui-summary.h.html">ui-summary.h</a> b/<a href="../file/ui-summary.h.html">ui-summary.h</a></b>
<a href="#h33-0" id="h33-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h33-0-0" id="h33-0-0" class="i">+#ifndef UI_SUMMARY_H
</a><a href="#h33-0-1" id="h33-0-1" class="i">+#define UI_SUMMARY_H
</a><a href="#h33-0-2" id="h33-0-2" class="i">+
</a><a href="#h33-0-3" id="h33-0-3" class="i">+extern void cgit_print_summary();
</a><a href="#h33-0-4" id="h33-0-4" class="i">+
</a><a href="#h33-0-5" id="h33-0-5" class="i">+#endif /* UI_SUMMARY_H */
</a><b>diff --git a/<a id="h34" href="../file/ui-tag.c.html">ui-tag.c</a> b/<a href="../file/ui-tag.c.html">ui-tag.c</a></b>
<a href="#h34-0" id="h34-0" class="h">@@ -7,7 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h34-0-3" id="h34-0-3" class="d">-
</a><a href="#h34-0-4" id="h34-0-4" class="i">+#include &quot;html.h&quot;
</a><a href="#h34-0-5" id="h34-0-5" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 static void print_tag_content(char *buf)
 {
<b>diff --git a/<a id="h35" href="../file/ui-tag.h.html">ui-tag.h</a> b/<a href="../file/ui-tag.h.html">ui-tag.h</a></b>
<a href="#h35-0" id="h35-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h35-0-0" id="h35-0-0" class="i">+#ifndef UI_TAG_H
</a><a href="#h35-0-1" id="h35-0-1" class="i">+#define UI_TAG_H
</a><a href="#h35-0-2" id="h35-0-2" class="i">+
</a><a href="#h35-0-3" id="h35-0-3" class="i">+extern void cgit_print_tag(char *revname);
</a><a href="#h35-0-4" id="h35-0-4" class="i">+
</a><a href="#h35-0-5" id="h35-0-5" class="i">+#endif /* UI_TAG_H */
</a><b>diff --git a/<a id="h36" href="../file/ui-tree.c.html">ui-tree.c</a> b/<a href="../file/ui-tree.c.html">ui-tree.c</a></b>
<a href="#h36-0" id="h36-0" class="h">@@ -7,6 +7,8 @@
</a>  */
 
 #include &quot;cgit.h&quot;
<a href="#h36-0-3" id="h36-0-3" class="i">+#include &quot;html.h&quot;
</a><a href="#h36-0-4" id="h36-0-4" class="i">+#include &quot;ui-shared.h&quot;
</a> 
 char *curr_rev;
 char *match_path;
<a href="#h36-1" id="h36-1" class="h">@@ -34,7 +36,7 @@ static void print_object(const unsigned char *sha1, char *path)
</a> 	}
 
 	html(&quot; blob: &lt;a href=&#39;&quot;);
<a href="#h36-1-3" id="h36-1-3" class="d">-	html_attr(cgit_pageurl(cgit_query_repo, &quot;blob&quot;, fmt(&quot;id=%s&quot;, sha1_to_hex(sha1))));
</a><a href="#h36-1-4" id="h36-1-4" class="i">+	html_attr(cgit_pageurl(ctx.qry.repo, &quot;blob&quot;, fmt(&quot;id=%s&quot;, sha1_to_hex(sha1))));
</a> 	htmlf(&quot;&#39;&gt;%s&lt;/a&gt;&quot;,sha1_to_hex(sha1));
 
 	html(&quot;&lt;table summary=&#39;blob content&#39; class=&#39;blob&#39;&gt;\n&quot;);
<a href="#h36-2" id="h36-2" class="h">@@ -67,8 +69,8 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> 	unsigned long size = 0;
 
 	name = xstrdup(pathname);
<a href="#h36-2-3" id="h36-2-3" class="d">-	fullpath = fmt(&quot;%s%s%s&quot;, cgit_query_path ? cgit_query_path : &quot;&quot;,
</a><a href="#h36-2-4" id="h36-2-4" class="d">-		       cgit_query_path ? &quot;/&quot; : &quot;&quot;, name);
</a><a href="#h36-2-5" id="h36-2-5" class="i">+	fullpath = fmt(&quot;%s%s%s&quot;, ctx.qry.path ? ctx.qry.path : &quot;&quot;,
</a><a href="#h36-2-6" id="h36-2-6" class="i">+		       ctx.qry.path ? &quot;/&quot; : &quot;&quot;, name);
</a> 
 	type = sha1_object_info(sha1, &amp;size);
 	if (type == OBJ_BAD &amp;&amp; !S_ISGITLINK(mode)) {
<a href="#h36-3" id="h36-3" class="h">@@ -79,27 +81,27 @@ static int ls_item(const unsigned char *sha1, const char *base, int baselen,
</a> 	}
 
 	html(&quot;&lt;tr&gt;&lt;td class=&#39;ls-mode&#39;&gt;&quot;);
<a href="#h36-3-3" id="h36-3-3" class="d">-	html_filemode(mode);
</a><a href="#h36-3-4" id="h36-3-4" class="i">+	cgit_print_filemode(mode);
</a> 	html(&quot;&lt;/td&gt;&lt;td&gt;&quot;);
 	if (S_ISGITLINK(mode)) {
 		htmlf(&quot;&lt;a class=&#39;ls-mod&#39; href=&#39;&quot;);
<a href="#h36-3-8" id="h36-3-8" class="d">-		html_attr(fmt(cgit_repo-&gt;module_link,
</a><a href="#h36-3-9" id="h36-3-9" class="i">+		html_attr(fmt(ctx.repo-&gt;module_link,
</a> 			      name,
 			      sha1_to_hex(sha1)));
 		html(&quot;&#39;&gt;&quot;);
 		html_txt(name);
 		html(&quot;&lt;/a&gt;&quot;);
 	} else if (S_ISDIR(mode)) {
<a href="#h36-3-16" id="h36-3-16" class="d">-		cgit_tree_link(name, NULL, &quot;ls-dir&quot;, cgit_query_head,
</a><a href="#h36-3-17" id="h36-3-17" class="i">+		cgit_tree_link(name, NULL, &quot;ls-dir&quot;, ctx.qry.head,
</a> 			       curr_rev, fullpath);
 	} else {
<a href="#h36-3-20" id="h36-3-20" class="d">-		cgit_tree_link(name, NULL, &quot;ls-blob&quot;, cgit_query_head,
</a><a href="#h36-3-21" id="h36-3-21" class="i">+		cgit_tree_link(name, NULL, &quot;ls-blob&quot;, ctx.qry.head,
</a> 			       curr_rev, fullpath);
 	}
 	htmlf(&quot;&lt;/td&gt;&lt;td class=&#39;ls-size&#39;&gt;%li&lt;/td&gt;&quot;, size);
 
 	html(&quot;&lt;td&gt;&quot;);
<a href="#h36-3-27" id="h36-3-27" class="d">-	cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, cgit_query_head, curr_rev,
</a><a href="#h36-3-28" id="h36-3-28" class="i">+	cgit_log_link(&quot;log&quot;, NULL, &quot;button&quot;, ctx.qry.head, curr_rev,
</a> 		      fullpath, 0, NULL, NULL);
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
 	free(name);
<a href="#h36-4" id="h36-4" class="h">@@ -153,10 +155,10 @@ static int walk_tree(const unsigned char *sha1, const char *base, int baselen,
</a> 	if (state == 0) {
 		memcpy(buffer, base, baselen);
 		strcpy(buffer+baselen, pathname);
<a href="#h36-4-3" id="h36-4-3" class="d">-		url = cgit_pageurl(cgit_query_repo, &quot;tree&quot;,
</a><a href="#h36-4-4" id="h36-4-4" class="i">+		url = cgit_pageurl(ctx.qry.repo, &quot;tree&quot;,
</a> 				   fmt(&quot;h=%s&amp;amp;path=%s&quot;, curr_rev, buffer));
 		html(&quot;/&quot;);
<a href="#h36-4-7" id="h36-4-7" class="d">-		cgit_tree_link(xstrdup(pathname), NULL, NULL, cgit_query_head,
</a><a href="#h36-4-8" id="h36-4-8" class="i">+		cgit_tree_link(xstrdup(pathname), NULL, NULL, ctx.qry.head,
</a> 			       curr_rev, buffer);
 
 		if (strcmp(match_path, buffer))
<a href="#h36-5" id="h36-5" class="h">@@ -188,7 +190,7 @@ void cgit_print_tree(const char *rev, char *path)
</a> 	const char *paths[] = {path, NULL};
 
 	if (!rev)
<a href="#h36-5-3" id="h36-5-3" class="d">-		rev = cgit_query_head;
</a><a href="#h36-5-4" id="h36-5-4" class="i">+		rev = ctx.qry.head;
</a> 
 	curr_rev = xstrdup(rev);
 	if (get_sha1(rev, sha1)) {
<a href="#h36-6" id="h36-6" class="h">@@ -202,7 +204,7 @@ void cgit_print_tree(const char *rev, char *path)
</a> 	}
 
 	html(&quot;path: &lt;a href=&#39;&quot;);
<a href="#h36-6-3" id="h36-6-3" class="d">-	html_attr(cgit_pageurl(cgit_query_repo, &quot;tree&quot;, fmt(&quot;h=%s&quot;, rev)));
</a><a href="#h36-6-4" id="h36-6-4" class="i">+	html_attr(cgit_pageurl(ctx.qry.repo, &quot;tree&quot;, fmt(&quot;h=%s&quot;, rev)));
</a> 	html(&quot;&#39;&gt;root&lt;/a&gt;&quot;);
 
 	if (path == NULL) {
<b>diff --git a/<a id="h37" href="../file/ui-tree.h.html">ui-tree.h</a> b/<a href="../file/ui-tree.h.html">ui-tree.h</a></b>
<a href="#h37-0" id="h37-0" class="h">@@ -0,0 +1,6 @@
</a><a href="#h37-0-0" id="h37-0-0" class="i">+#ifndef UI_TREE_H
</a><a href="#h37-0-1" id="h37-0-1" class="i">+#define UI_TREE_H
</a><a href="#h37-0-2" id="h37-0-2" class="i">+
</a><a href="#h37-0-3" id="h37-0-3" class="i">+extern void cgit_print_tree(const char *rev, char *path);
</a><a href="#h37-0-4" id="h37-0-4" class="i">+
</a><a href="#h37-0-5" id="h37-0-5" class="i">+#endif /* UI_TREE_H */
</a></pre>
</div>
</body>
</html>
