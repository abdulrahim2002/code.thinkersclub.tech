<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>auth: add basic authentication filter framework - cgit - Web based git repository viewer
</title>
<link rel="icon" type="image/png" href="../favicon.png" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed" href="../atom.xml" />
<link rel="alternate" type="application/atom+xml" title="cgit.git Atom Feed (tags)" href="../tags.xml" />
<link rel="stylesheet" type="text/css" href="../style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/base16/tender.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
<script> hljs.highlightAll() ;</script>
<style>pre code.hljs {display: inline;padding: 0;} code.hljs {padding: 0;} .hljs {background: initial;} .hljs-comment{color: rgb(96, 96, 96);}</style></head>
<body>
<table><tr><td><a href="../../"><img src="../logo.png" alt="" width="32" height="32" /></a></td><td><h1>cgit</h1><span class="desc">Web based git repository viewer
</span></td></tr><tr><td></td><td>
<br>
<a href="../log.html">Log</a> | <a href="../files.html">Files</a> | <a href="../refs.html">Refs</a> | <a href="../file/.gitmodules.html">Submodules</a> | <a href="../file/README.html">README</a> | <a href="../file/COPYING.html">LICENSE</a></td></tr></table>
<hr/>
<div id="content">
<pre><b>commit</b> <a href="../commit/d6e9200cc35411f3f27426b608bcfdef9348e6d3.html">d6e9200cc35411f3f27426b608bcfdef9348e6d3</a>
<b>parent</b> <a href="../commit/3741254a6989b2837cd8d20480f152f0096bcb9a.html">3741254a6989b2837cd8d20480f152f0096bcb9a</a>
<b>Author:</b> Jason A. Donenfeld &lt;<a href="mailto:Jason@zx2c4.com">Jason@zx2c4.com</a>&gt;
<b>Date:</b>   Tue, 14 Jan 2014 21:49:31 +0100

auth: add basic authentication filter framework

This leverages the new lua support. See
filters/simple-authentication.lua for explaination of how this works.
There is also additional documentation in cgitrc.5.txt.

Though this is a cookie-based approach, cgit&#39;s caching mechanism is
preserved for authenticated pages.

Very plugable and extendable depending on user needs.

The sample script uses an HMAC-SHA1 based cookie to store the
currently logged in user, with an expiration date.

Signed-off-by: Jason A. Donenfeld &lt;Jason@zx2c4.com&gt;

<b>Diffstat:</b>
<table><tr><td class="M">M</td><td><a href="#h0">cgit.c</a></td><td> | </td><td class="num">96</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d">--</span></td></tr>
<tr><td class="M">M</td><td><a href="#h1">cgit.h</a></td><td> | </td><td class="num">7</td><td><span class="i">++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h2">cgitrc.5.txt</a></td><td> | </td><td class="num">36</td><td><span class="i">+++++++++++++++++++++++++++++++++++</span><span class="d">-</span></td></tr>
<tr><td class="M">M</td><td><a href="#h3">filter.c</a></td><td> | </td><td class="num">11</td><td><span class="i">+++++++++++</span><span class="d"></span></td></tr>
<tr><td class="A">A</td><td><a href="#h4">filters/simple-authentication.lua</a></td><td> | </td><td class="num">225</td><td><span class="i">+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><span class="d"></span></td></tr>
<tr><td class="M">M</td><td><a href="#h5">ui-shared.c</a></td><td> | </td><td class="num">28</td><td><span class="i">++++++++++++++++</span><span class="d">------------</span></td></tr>
</table></pre><pre>6 files changed, 387 insertions(+), 16 deletions(-)
<hr/><b>diff --git a/<a id="h0" href="../file/cgit.c.html">cgit.c</a> b/<a href="../file/cgit.c.html">cgit.c</a></b>
<a href="#h0-0" id="h0-0" class="h">@@ -192,6 +192,8 @@ static void config_cb(const char *name, const char *value)
</a> 		ctx.cfg.commit_filter = cgit_new_filter(value, COMMIT);
 	else if (!strcmp(name, &quot;email-filter&quot;))
 		ctx.cfg.email_filter = cgit_new_filter(value, EMAIL);
<a href="#h0-0-3" id="h0-0-3" class="i">+	else if (!strcmp(name, &quot;auth-filter&quot;))
</a><a href="#h0-0-4" id="h0-0-4" class="i">+		ctx.cfg.auth_filter = cgit_new_filter(value, AUTH);
</a> 	else if (!strcmp(name, &quot;embedded&quot;))
 		ctx.cfg.embedded = atoi(value);
 	else if (!strcmp(name, &quot;max-atom-items&quot;))
<a href="#h0-1" id="h0-1" class="h">@@ -378,6 +380,10 @@ static void prepare_context(struct cgit_context *ctx)
</a> 	ctx-&gt;env.script_name = getenv(&quot;SCRIPT_NAME&quot;);
 	ctx-&gt;env.server_name = getenv(&quot;SERVER_NAME&quot;);
 	ctx-&gt;env.server_port = getenv(&quot;SERVER_PORT&quot;);
<a href="#h0-1-3" id="h0-1-3" class="i">+	ctx-&gt;env.http_cookie = getenv(&quot;HTTP_COOKIE&quot;);
</a><a href="#h0-1-4" id="h0-1-4" class="i">+	ctx-&gt;env.http_referer = getenv(&quot;HTTP_REFERER&quot;);
</a><a href="#h0-1-5" id="h0-1-5" class="i">+	ctx-&gt;env.content_length = getenv(&quot;CONTENT_LENGTH&quot;) ? strtoul(getenv(&quot;CONTENT_LENGTH&quot;), NULL, 10) : 0;
</a><a href="#h0-1-6" id="h0-1-6" class="i">+	ctx-&gt;env.authenticated = 0;
</a> 	ctx-&gt;page.mimetype = &quot;text/html&quot;;
 	ctx-&gt;page.charset = PAGE_ENCODING;
 	ctx-&gt;page.filename = NULL;
<a href="#h0-2" id="h0-2" class="h">@@ -593,11 +599,92 @@ static int prepare_repo_cmd(struct cgit_context *ctx)
</a> 	return 0;
 }
 
<a href="#h0-2-3" id="h0-2-3" class="i">+static inline void open_auth_filter(struct cgit_context *ctx, const char *function)
</a><a href="#h0-2-4" id="h0-2-4" class="i">+{
</a><a href="#h0-2-5" id="h0-2-5" class="i">+	cgit_open_filter(ctx-&gt;cfg.auth_filter, function,
</a><a href="#h0-2-6" id="h0-2-6" class="i">+		ctx-&gt;env.http_cookie ? ctx-&gt;env.http_cookie : &quot;&quot;,
</a><a href="#h0-2-7" id="h0-2-7" class="i">+		ctx-&gt;env.request_method ? ctx-&gt;env.request_method : &quot;&quot;,
</a><a href="#h0-2-8" id="h0-2-8" class="i">+		ctx-&gt;env.query_string ? ctx-&gt;env.query_string : &quot;&quot;,
</a><a href="#h0-2-9" id="h0-2-9" class="i">+		ctx-&gt;env.http_referer ? ctx-&gt;env.http_referer : &quot;&quot;,
</a><a href="#h0-2-10" id="h0-2-10" class="i">+		ctx-&gt;env.path_info ? ctx-&gt;env.path_info : &quot;&quot;,
</a><a href="#h0-2-11" id="h0-2-11" class="i">+		ctx-&gt;env.http_host ? ctx-&gt;env.http_host : &quot;&quot;,
</a><a href="#h0-2-12" id="h0-2-12" class="i">+		ctx-&gt;env.https ? ctx-&gt;env.https : &quot;&quot;,
</a><a href="#h0-2-13" id="h0-2-13" class="i">+		ctx-&gt;qry.repo ? ctx-&gt;qry.repo : &quot;&quot;,
</a><a href="#h0-2-14" id="h0-2-14" class="i">+		ctx-&gt;qry.page ? ctx-&gt;qry.page : &quot;&quot;,
</a><a href="#h0-2-15" id="h0-2-15" class="i">+		ctx-&gt;qry.url ? ctx-&gt;qry.url : &quot;&quot;);
</a><a href="#h0-2-16" id="h0-2-16" class="i">+}
</a><a href="#h0-2-17" id="h0-2-17" class="i">+
</a><a href="#h0-2-18" id="h0-2-18" class="i">+#define MAX_AUTHENTICATION_POST_BYTES 4096
</a><a href="#h0-2-19" id="h0-2-19" class="i">+static inline void authenticate_post(struct cgit_context *ctx)
</a><a href="#h0-2-20" id="h0-2-20" class="i">+{
</a><a href="#h0-2-21" id="h0-2-21" class="i">+	if (ctx-&gt;env.http_referer &amp;&amp; strlen(ctx-&gt;env.http_referer) &gt; 0) {
</a><a href="#h0-2-22" id="h0-2-22" class="i">+		html(&quot;Status: 302 Redirect\n&quot;);
</a><a href="#h0-2-23" id="h0-2-23" class="i">+		html(&quot;Cache-Control: no-cache, no-store\n&quot;);
</a><a href="#h0-2-24" id="h0-2-24" class="i">+		htmlf(&quot;Location: %s\n&quot;, ctx-&gt;env.http_referer);
</a><a href="#h0-2-25" id="h0-2-25" class="i">+	} else {
</a><a href="#h0-2-26" id="h0-2-26" class="i">+		html(&quot;Status: 501 Missing Referer\n&quot;);
</a><a href="#h0-2-27" id="h0-2-27" class="i">+		html(&quot;Cache-Control: no-cache, no-store\n\n&quot;);
</a><a href="#h0-2-28" id="h0-2-28" class="i">+		exit(0);
</a><a href="#h0-2-29" id="h0-2-29" class="i">+	}
</a><a href="#h0-2-30" id="h0-2-30" class="i">+
</a><a href="#h0-2-31" id="h0-2-31" class="i">+	open_auth_filter(ctx, &quot;authenticate-post&quot;);
</a><a href="#h0-2-32" id="h0-2-32" class="i">+	char buffer[MAX_AUTHENTICATION_POST_BYTES];
</a><a href="#h0-2-33" id="h0-2-33" class="i">+	int len;
</a><a href="#h0-2-34" id="h0-2-34" class="i">+	len = ctx-&gt;env.content_length;
</a><a href="#h0-2-35" id="h0-2-35" class="i">+	if (len &gt; MAX_AUTHENTICATION_POST_BYTES)
</a><a href="#h0-2-36" id="h0-2-36" class="i">+		len = MAX_AUTHENTICATION_POST_BYTES;
</a><a href="#h0-2-37" id="h0-2-37" class="i">+	if (read(STDIN_FILENO, buffer, len) &lt; 0)
</a><a href="#h0-2-38" id="h0-2-38" class="i">+		die_errno(&quot;Could not read POST from stdin&quot;);
</a><a href="#h0-2-39" id="h0-2-39" class="i">+	if (write(STDOUT_FILENO, buffer, len) &lt; 0)
</a><a href="#h0-2-40" id="h0-2-40" class="i">+		die_errno(&quot;Could not write POST to stdout&quot;);
</a><a href="#h0-2-41" id="h0-2-41" class="i">+	/* The filter may now spit out a Set-Cookie: ... */
</a><a href="#h0-2-42" id="h0-2-42" class="i">+	cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h0-2-43" id="h0-2-43" class="i">+
</a><a href="#h0-2-44" id="h0-2-44" class="i">+	html(&quot;\n&quot;);
</a><a href="#h0-2-45" id="h0-2-45" class="i">+	exit(0);
</a><a href="#h0-2-46" id="h0-2-46" class="i">+}
</a><a href="#h0-2-47" id="h0-2-47" class="i">+
</a><a href="#h0-2-48" id="h0-2-48" class="i">+static inline void authenticate_cookie(struct cgit_context *ctx)
</a><a href="#h0-2-49" id="h0-2-49" class="i">+{
</a><a href="#h0-2-50" id="h0-2-50" class="i">+	/* If we don&#39;t have an auth_filter, consider all cookies valid, and thus return early. */
</a><a href="#h0-2-51" id="h0-2-51" class="i">+	if (!ctx-&gt;cfg.auth_filter) {
</a><a href="#h0-2-52" id="h0-2-52" class="i">+		ctx-&gt;env.authenticated = 1;
</a><a href="#h0-2-53" id="h0-2-53" class="i">+		return;
</a><a href="#h0-2-54" id="h0-2-54" class="i">+	}
</a><a href="#h0-2-55" id="h0-2-55" class="i">+
</a><a href="#h0-2-56" id="h0-2-56" class="i">+	/* If we&#39;re having something POST&#39;d to /login, we&#39;re authenticating POST,
</a><a href="#h0-2-57" id="h0-2-57" class="i">+	 * instead of the cookie, so call authenticate_post and bail out early.
</a><a href="#h0-2-58" id="h0-2-58" class="i">+	 * This pattern here should match /?p=login with POST. */
</a><a href="#h0-2-59" id="h0-2-59" class="i">+	if (ctx-&gt;env.request_method &amp;&amp; ctx-&gt;qry.page &amp;&amp; !ctx-&gt;repo &amp;&amp; \
</a><a href="#h0-2-60" id="h0-2-60" class="i">+	    !strcmp(ctx-&gt;env.request_method, &quot;POST&quot;) &amp;&amp; !strcmp(ctx-&gt;qry.page, &quot;login&quot;)) {
</a><a href="#h0-2-61" id="h0-2-61" class="i">+		authenticate_post(ctx);
</a><a href="#h0-2-62" id="h0-2-62" class="i">+		return;
</a><a href="#h0-2-63" id="h0-2-63" class="i">+	}
</a><a href="#h0-2-64" id="h0-2-64" class="i">+
</a><a href="#h0-2-65" id="h0-2-65" class="i">+	/* If we&#39;ve made it this far, we&#39;re authenticating the cookie for real, so do that. */
</a><a href="#h0-2-66" id="h0-2-66" class="i">+	open_auth_filter(ctx, &quot;authenticate-cookie&quot;);
</a><a href="#h0-2-67" id="h0-2-67" class="i">+	ctx-&gt;env.authenticated = cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h0-2-68" id="h0-2-68" class="i">+}
</a><a href="#h0-2-69" id="h0-2-69" class="i">+
</a> static void process_request(void *cbdata)
 {
 	struct cgit_context *ctx = cbdata;
 	struct cgit_cmd *cmd;
 
<a href="#h0-2-75" id="h0-2-75" class="i">+	/* If we&#39;re not yet authenticated, no matter what page we&#39;re on,
</a><a href="#h0-2-76" id="h0-2-76" class="i">+	 * display the authentication body from the auth_filter. This should
</a><a href="#h0-2-77" id="h0-2-77" class="i">+	 * never be cached. */
</a><a href="#h0-2-78" id="h0-2-78" class="i">+	if (!ctx-&gt;env.authenticated) {
</a><a href="#h0-2-79" id="h0-2-79" class="i">+		ctx-&gt;page.title = &quot;Authentication Required&quot;;
</a><a href="#h0-2-80" id="h0-2-80" class="i">+		cgit_print_http_headers(ctx);
</a><a href="#h0-2-81" id="h0-2-81" class="i">+		cgit_print_docstart(ctx);
</a><a href="#h0-2-82" id="h0-2-82" class="i">+		cgit_print_pageheader(ctx);
</a><a href="#h0-2-83" id="h0-2-83" class="i">+		open_auth_filter(ctx, &quot;body&quot;);
</a><a href="#h0-2-84" id="h0-2-84" class="i">+		cgit_close_filter(ctx-&gt;cfg.auth_filter);
</a><a href="#h0-2-85" id="h0-2-85" class="i">+		cgit_print_docend();
</a><a href="#h0-2-86" id="h0-2-86" class="i">+		return;
</a><a href="#h0-2-87" id="h0-2-87" class="i">+	}
</a><a href="#h0-2-88" id="h0-2-88" class="i">+
</a> 	cmd = cgit_get_cmd(ctx);
 	if (!cmd) {
 		ctx-&gt;page.title = &quot;cgit error&quot;;
<a href="#h0-3" id="h0-3" class="h">@@ -911,6 +998,7 @@ int main(int argc, const char **argv)
</a> 	int err, ttl;
 
 	cgit_init_filters();
<a href="#h0-3-3" id="h0-3-3" class="i">+	atexit(cgit_cleanup_filters);
</a> 
 	prepare_context(&amp;ctx);
 	cgit_repolist.length = 0;
<a href="#h0-4" id="h0-4" class="h">@@ -948,18 +1036,22 @@ int main(int argc, const char **argv)
</a> 		cgit_parse_url(ctx.qry.url);
 	}
 
<a href="#h0-4-3" id="h0-4-3" class="i">+	/* Before we go any further, we set ctx.env.authenticated by checking to see
</a><a href="#h0-4-4" id="h0-4-4" class="i">+	 * if the supplied cookie is valid. All cookies are valid if there is no
</a><a href="#h0-4-5" id="h0-4-5" class="i">+	 * auth_filter. If there is an auth_filter, the filter decides. */
</a><a href="#h0-4-6" id="h0-4-6" class="i">+	authenticate_cookie(&amp;ctx);
</a><a href="#h0-4-7" id="h0-4-7" class="i">+
</a> 	ttl = calc_ttl();
 	if (ttl &lt; 0)
 		ctx.page.expires += 10 * 365 * 24 * 60 * 60; /* 10 years */
 	else
 		ctx.page.expires += ttl * 60;
<a href="#h0-4-13" id="h0-4-13" class="d">-	if (ctx.env.request_method &amp;&amp; !strcmp(ctx.env.request_method, &quot;HEAD&quot;))
</a><a href="#h0-4-14" id="h0-4-14" class="i">+	if (!ctx.env.authenticated || (ctx.env.request_method &amp;&amp; !strcmp(ctx.env.request_method, &quot;HEAD&quot;)))
</a> 		ctx.cfg.nocache = 1;
 	if (ctx.cfg.nocache)
 		ctx.cfg.cache_size = 0;
 	err = cache_process(ctx.cfg.cache_size, ctx.cfg.cache_root,
 			    ctx.qry.raw, ttl, process_request, &amp;ctx);
<a href="#h0-4-20" id="h0-4-20" class="d">-	cgit_cleanup_filters();
</a> 	if (err)
 		cgit_print_error(&quot;Error processing page: %s (%d)&quot;,
 				 strerror(err), err);
<b>diff --git a/<a id="h1" href="../file/cgit.h.html">cgit.h</a> b/<a href="../file/cgit.h.html">cgit.h</a></b>
<a href="#h1-0" id="h1-0" class="h">@@ -53,7 +53,7 @@ typedef void (*filepair_fn)(struct diff_filepair *pair);
</a> typedef void (*linediff_fn)(char *line, int len);
 
 typedef enum {
<a href="#h1-0-3" id="h1-0-3" class="d">-	ABOUT, COMMIT, SOURCE, EMAIL
</a><a href="#h1-0-4" id="h1-0-4" class="i">+	ABOUT, COMMIT, SOURCE, EMAIL, AUTH
</a> } filter_type;
 
 struct cgit_filter {
<a href="#h1-1" id="h1-1" class="h">@@ -252,6 +252,7 @@ struct cgit_config {
</a> 	struct cgit_filter *commit_filter;
 	struct cgit_filter *source_filter;
 	struct cgit_filter *email_filter;
<a href="#h1-1-3" id="h1-1-3" class="i">+	struct cgit_filter *auth_filter;
</a> };
 
 struct cgit_page {
<a href="#h1-2" id="h1-2" class="h">@@ -278,6 +279,10 @@ struct cgit_environment {
</a> 	const char *script_name;
 	const char *server_name;
 	const char *server_port;
<a href="#h1-2-3" id="h1-2-3" class="i">+	const char *http_cookie;
</a><a href="#h1-2-4" id="h1-2-4" class="i">+	const char *http_referer;
</a><a href="#h1-2-5" id="h1-2-5" class="i">+	unsigned int content_length;
</a><a href="#h1-2-6" id="h1-2-6" class="i">+	int authenticated;
</a> };
 
 struct cgit_context {
<b>diff --git a/<a id="h2" href="../file/cgitrc.5.txt.html">cgitrc.5.txt</a> b/<a href="../file/cgitrc.5.txt.html">cgitrc.5.txt</a></b>
<a href="#h2-0" id="h2-0" class="h">@@ -42,6 +42,13 @@ agefile::
</a> 	hh:mm:ss&quot;. You may want to generate this file from a post-receive
 	hook. Default value: &quot;info/web/last-modified&quot;.
 
<a href="#h2-0-3" id="h2-0-3" class="i">+auth-filter::
</a><a href="#h2-0-4" id="h2-0-4" class="i">+	Specifies a command that will be invoked for authenticating repository
</a><a href="#h2-0-5" id="h2-0-5" class="i">+	access. Receives quite a few arguments, and data on both stdin and
</a><a href="#h2-0-6" id="h2-0-6" class="i">+	stdout for authentication processing. Details follow later in this
</a><a href="#h2-0-7" id="h2-0-7" class="i">+	document. If no auth-filter is specified, no authentication is
</a><a href="#h2-0-8" id="h2-0-8" class="i">+	performed. Default value: none. See also: &quot;FILTER API&quot;.
</a><a href="#h2-0-9" id="h2-0-9" class="i">+
</a> branch-sort::
 	Flag which, when set to &quot;age&quot;, enables date ordering in the branch ref
 	list, and when set to &quot;name&quot; enables ordering by branch name. Default
<a href="#h2-1" id="h2-1" class="h">@@ -605,6 +612,8 @@ specification with the relevant string; available values are:
</a> 		URL escapes for a path and writes &#39;str&#39; to the webpage.
 	&#39;html_url_arg(str)&#39;::
 		URL escapes for an argument and writes &#39;str&#39; to the webpage.
<a href="#h2-1-3" id="h2-1-3" class="i">+	&#39;html_include(file)&#39;::
</a><a href="#h2-1-4" id="h2-1-4" class="i">+		Includes &#39;file&#39; in webpage.
</a> 
 
 Parameters are provided to filters as follows.
<a href="#h2-2" id="h2-2" class="h">@@ -635,7 +644,32 @@ source filter::
</a> 	file that is to be filtered is available on standard input and the
 	filtered contents is expected on standard output.
 
<a href="#h2-2-3" id="h2-2-3" class="d">-Also, all filters are handed the following environment variables:
</a><a href="#h2-2-4" id="h2-2-4" class="i">+auth filter::
</a><a href="#h2-2-5" id="h2-2-5" class="i">+	The authentication filter receives 11 parameters:
</a><a href="#h2-2-6" id="h2-2-6" class="i">+	  - filter action, explained below, which specifies which action the
</a><a href="#h2-2-7" id="h2-2-7" class="i">+	    filter is called for
</a><a href="#h2-2-8" id="h2-2-8" class="i">+	  - http cookie
</a><a href="#h2-2-9" id="h2-2-9" class="i">+	  - http method
</a><a href="#h2-2-10" id="h2-2-10" class="i">+	  - http referer
</a><a href="#h2-2-11" id="h2-2-11" class="i">+	  - http path
</a><a href="#h2-2-12" id="h2-2-12" class="i">+	  - http https flag
</a><a href="#h2-2-13" id="h2-2-13" class="i">+	  - cgit repo
</a><a href="#h2-2-14" id="h2-2-14" class="i">+	  - cgit page
</a><a href="#h2-2-15" id="h2-2-15" class="i">+	  - cgit url
</a><a href="#h2-2-16" id="h2-2-16" class="i">+	When the filter action is &quot;body&quot;, this filter must write to output the
</a><a href="#h2-2-17" id="h2-2-17" class="i">+	HTML for displaying the login form, which POSTs to &quot;/?p=login&quot;. When
</a><a href="#h2-2-18" id="h2-2-18" class="i">+	the filter action is &quot;authenticate-cookie&quot;, this filter must validate
</a><a href="#h2-2-19" id="h2-2-19" class="i">+	the http cookie and return a 0 if it is invalid or 1 if it is invalid,
</a><a href="#h2-2-20" id="h2-2-20" class="i">+	in the exit code / close function. If the filter action is
</a><a href="#h2-2-21" id="h2-2-21" class="i">+	&quot;authenticate-post&quot;, this filter receives POST&#39;d parameters on
</a><a href="#h2-2-22" id="h2-2-22" class="i">+	standard input, and should write to output one or more &quot;Set-Cookie&quot;
</a><a href="#h2-2-23" id="h2-2-23" class="i">+	HTTP headers, each followed by a newline.
</a><a href="#h2-2-24" id="h2-2-24" class="i">+
</a><a href="#h2-2-25" id="h2-2-25" class="i">+	Please see `filters/simple-authentication.lua` for a clear example
</a><a href="#h2-2-26" id="h2-2-26" class="i">+	script that may be modified.
</a><a href="#h2-2-27" id="h2-2-27" class="i">+
</a><a href="#h2-2-28" id="h2-2-28" class="i">+
</a><a href="#h2-2-29" id="h2-2-29" class="i">+All filters are handed the following environment variables:
</a> 
 - CGIT_REPO_URL (from repo.url)
 - CGIT_REPO_NAME (from repo.name)
<b>diff --git a/<a id="h3" href="../file/filter.c.html">filter.c</a> b/<a href="../file/filter.c.html">filter.c</a></b>
<a href="#h3-0" id="h3-0" class="h">@@ -244,6 +244,11 @@ static int html_url_arg_lua_filter(lua_State *lua_state)
</a> 	return hook_lua_filter(lua_state, html_url_arg);
 }
 
<a href="#h3-0-3" id="h3-0-3" class="i">+static int html_include_lua_filter(lua_State *lua_state)
</a><a href="#h3-0-4" id="h3-0-4" class="i">+{
</a><a href="#h3-0-5" id="h3-0-5" class="i">+	return hook_lua_filter(lua_state, (void (*)(const char *))html_include);
</a><a href="#h3-0-6" id="h3-0-6" class="i">+}
</a><a href="#h3-0-7" id="h3-0-7" class="i">+
</a> static void cleanup_lua_filter(struct cgit_filter *base)
 {
 	struct lua_filter *filter = (struct lua_filter *)base;
<a href="#h3-1" id="h3-1" class="h">@@ -279,6 +284,8 @@ static int init_lua_filter(struct lua_filter *filter)
</a> 	lua_setglobal(filter-&gt;lua_state, &quot;html_url_path&quot;);
 	lua_pushcfunction(filter-&gt;lua_state, html_url_arg_lua_filter);
 	lua_setglobal(filter-&gt;lua_state, &quot;html_url_arg&quot;);
<a href="#h3-1-3" id="h3-1-3" class="i">+	lua_pushcfunction(filter-&gt;lua_state, html_include_lua_filter);
</a><a href="#h3-1-4" id="h3-1-4" class="i">+	lua_setglobal(filter-&gt;lua_state, &quot;html_include&quot;);
</a> 
 	if (luaL_dofile(filter-&gt;lua_state, filter-&gt;script_file)) {
 		error_lua_filter(filter);
<a href="#h3-2" id="h3-2" class="h">@@ -409,6 +416,10 @@ struct cgit_filter *cgit_new_filter(const char *cmd, filter_type filtertype)
</a> 		colon = NULL;
 
 	switch (filtertype) {
<a href="#h3-2-3" id="h3-2-3" class="i">+		case AUTH:
</a><a href="#h3-2-4" id="h3-2-4" class="i">+			argument_count = 11;
</a><a href="#h3-2-5" id="h3-2-5" class="i">+			break;
</a><a href="#h3-2-6" id="h3-2-6" class="i">+
</a> 		case EMAIL:
 			argument_count = 2;
 			break;
<b>diff --git a/<a id="h4" href="../file/filters/simple-authentication.lua.html">filters/simple-authentication.lua</a> b/<a href="../file/filters/simple-authentication.lua.html">filters/simple-authentication.lua</a></b>
<a href="#h4-0" id="h4-0" class="h">@@ -0,0 +1,225 @@
</a><a href="#h4-0-0" id="h4-0-0" class="i">+-- This script may be used with the auth-filter. Be sure to configure it as you wish.
</a><a href="#h4-0-1" id="h4-0-1" class="i">+--
</a><a href="#h4-0-2" id="h4-0-2" class="i">+-- Requirements:
</a><a href="#h4-0-3" id="h4-0-3" class="i">+-- 	luacrypto &gt;= 0.3
</a><a href="#h4-0-4" id="h4-0-4" class="i">+-- 	&lt;http://mkottman.github.io/luacrypto/&gt;
</a><a href="#h4-0-5" id="h4-0-5" class="i">+--
</a><a href="#h4-0-6" id="h4-0-6" class="i">+
</a><a href="#h4-0-7" id="h4-0-7" class="i">+
</a><a href="#h4-0-8" id="h4-0-8" class="i">+--
</a><a href="#h4-0-9" id="h4-0-9" class="i">+--
</a><a href="#h4-0-10" id="h4-0-10" class="i">+-- Configure these variables for your settings.
</a><a href="#h4-0-11" id="h4-0-11" class="i">+--
</a><a href="#h4-0-12" id="h4-0-12" class="i">+--
</a><a href="#h4-0-13" id="h4-0-13" class="i">+
</a><a href="#h4-0-14" id="h4-0-14" class="i">+local protected_repos = {
</a><a href="#h4-0-15" id="h4-0-15" class="i">+	glouglou	= { laurent = true, jason = true },
</a><a href="#h4-0-16" id="h4-0-16" class="i">+	qt		= { jason = true, bob = true }
</a><a href="#h4-0-17" id="h4-0-17" class="i">+}
</a><a href="#h4-0-18" id="h4-0-18" class="i">+
</a><a href="#h4-0-19" id="h4-0-19" class="i">+local users = {
</a><a href="#h4-0-20" id="h4-0-20" class="i">+	jason		= &quot;secretpassword&quot;,
</a><a href="#h4-0-21" id="h4-0-21" class="i">+	laurent		= &quot;s3cr3t&quot;,
</a><a href="#h4-0-22" id="h4-0-22" class="i">+	bob		= &quot;ilikelua&quot;
</a><a href="#h4-0-23" id="h4-0-23" class="i">+}
</a><a href="#h4-0-24" id="h4-0-24" class="i">+
</a><a href="#h4-0-25" id="h4-0-25" class="i">+local secret = &quot;BE SURE TO CUSTOMIZE THIS STRING TO SOMETHING BIG AND RANDOM&quot;
</a><a href="#h4-0-26" id="h4-0-26" class="i">+
</a><a href="#h4-0-27" id="h4-0-27" class="i">+
</a><a href="#h4-0-28" id="h4-0-28" class="i">+
</a><a href="#h4-0-29" id="h4-0-29" class="i">+--
</a><a href="#h4-0-30" id="h4-0-30" class="i">+--
</a><a href="#h4-0-31" id="h4-0-31" class="i">+-- Authentication functions follow below. Swap these out if you want different authentication semantics.
</a><a href="#h4-0-32" id="h4-0-32" class="i">+--
</a><a href="#h4-0-33" id="h4-0-33" class="i">+--
</a><a href="#h4-0-34" id="h4-0-34" class="i">+
</a><a href="#h4-0-35" id="h4-0-35" class="i">+-- Sets HTTP cookie headers based on post
</a><a href="#h4-0-36" id="h4-0-36" class="i">+function authenticate_post()
</a><a href="#h4-0-37" id="h4-0-37" class="i">+	local password = users[post[&quot;username&quot;]]
</a><a href="#h4-0-38" id="h4-0-38" class="i">+	-- TODO: Implement time invariant string comparison function to mitigate against timing attack.
</a><a href="#h4-0-39" id="h4-0-39" class="i">+	if password == nil or password ~= post[&quot;password&quot;] then
</a><a href="#h4-0-40" id="h4-0-40" class="i">+		construct_cookie(&quot;&quot;, &quot;cgitauth&quot;)
</a><a href="#h4-0-41" id="h4-0-41" class="i">+	else
</a><a href="#h4-0-42" id="h4-0-42" class="i">+		construct_cookie(post[&quot;username&quot;], &quot;cgitauth&quot;)
</a><a href="#h4-0-43" id="h4-0-43" class="i">+	end
</a><a href="#h4-0-44" id="h4-0-44" class="i">+	return 0
</a><a href="#h4-0-45" id="h4-0-45" class="i">+end
</a><a href="#h4-0-46" id="h4-0-46" class="i">+
</a><a href="#h4-0-47" id="h4-0-47" class="i">+
</a><a href="#h4-0-48" id="h4-0-48" class="i">+-- Returns 1 if the cookie is valid and 0 if it is not.
</a><a href="#h4-0-49" id="h4-0-49" class="i">+function authenticate_cookie()
</a><a href="#h4-0-50" id="h4-0-50" class="i">+	accepted_users = protected_repos[cgit[&quot;repo&quot;]]
</a><a href="#h4-0-51" id="h4-0-51" class="i">+	if accepted_users == nil then
</a><a href="#h4-0-52" id="h4-0-52" class="i">+		-- We return as valid if the repo is not protected.
</a><a href="#h4-0-53" id="h4-0-53" class="i">+		return 1
</a><a href="#h4-0-54" id="h4-0-54" class="i">+	end
</a><a href="#h4-0-55" id="h4-0-55" class="i">+
</a><a href="#h4-0-56" id="h4-0-56" class="i">+	local username = validate_cookie(get_cookie(http[&quot;cookie&quot;], &quot;cgitauth&quot;))
</a><a href="#h4-0-57" id="h4-0-57" class="i">+	if username == nil or not accepted_users[username] then
</a><a href="#h4-0-58" id="h4-0-58" class="i">+		return 0
</a><a href="#h4-0-59" id="h4-0-59" class="i">+	else
</a><a href="#h4-0-60" id="h4-0-60" class="i">+		return 1
</a><a href="#h4-0-61" id="h4-0-61" class="i">+	end
</a><a href="#h4-0-62" id="h4-0-62" class="i">+end
</a><a href="#h4-0-63" id="h4-0-63" class="i">+
</a><a href="#h4-0-64" id="h4-0-64" class="i">+-- Prints the html for the login form.
</a><a href="#h4-0-65" id="h4-0-65" class="i">+function body()
</a><a href="#h4-0-66" id="h4-0-66" class="i">+	html(&quot;&lt;h2&gt;Authentication Required&lt;/h2&gt;&quot;)
</a><a href="#h4-0-67" id="h4-0-67" class="i">+	html(&quot;&lt;form method=&#39;post&#39; action=&#39;&quot;)
</a><a href="#h4-0-68" id="h4-0-68" class="i">+	html_attr(cgit[&quot;login&quot;])
</a><a href="#h4-0-69" id="h4-0-69" class="i">+	html(&quot;&#39;&gt;&quot;)
</a><a href="#h4-0-70" id="h4-0-70" class="i">+	html(&quot;&lt;table&gt;&quot;)
</a><a href="#h4-0-71" id="h4-0-71" class="i">+	html(&quot;&lt;tr&gt;&lt;td&gt;&lt;label for=&#39;username&#39;&gt;Username:&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input id=&#39;username&#39; name=&#39;username&#39; autofocus /&gt;&lt;/td&gt;&lt;/tr&gt;&quot;)
</a><a href="#h4-0-72" id="h4-0-72" class="i">+	html(&quot;&lt;tr&gt;&lt;td&gt;&lt;label for=&#39;password&#39;&gt;Password:&lt;/label&gt;&lt;/td&gt;&lt;td&gt;&lt;input id=&#39;password&#39; name=&#39;password&#39; type=&#39;password&#39; /&gt;&lt;/td&gt;&lt;/tr&gt;&quot;)
</a><a href="#h4-0-73" id="h4-0-73" class="i">+	html(&quot;&lt;tr&gt;&lt;td colspan=&#39;2&#39;&gt;&lt;input value=&#39;Login&#39; type=&#39;submit&#39; /&gt;&lt;/td&gt;&lt;/tr&gt;&quot;)
</a><a href="#h4-0-74" id="h4-0-74" class="i">+	html(&quot;&lt;/table&gt;&lt;/form&gt;&quot;)
</a><a href="#h4-0-75" id="h4-0-75" class="i">+
</a><a href="#h4-0-76" id="h4-0-76" class="i">+	return 0
</a><a href="#h4-0-77" id="h4-0-77" class="i">+end
</a><a href="#h4-0-78" id="h4-0-78" class="i">+
</a><a href="#h4-0-79" id="h4-0-79" class="i">+
</a><a href="#h4-0-80" id="h4-0-80" class="i">+--
</a><a href="#h4-0-81" id="h4-0-81" class="i">+--
</a><a href="#h4-0-82" id="h4-0-82" class="i">+-- Cookie construction and validation helpers.
</a><a href="#h4-0-83" id="h4-0-83" class="i">+--
</a><a href="#h4-0-84" id="h4-0-84" class="i">+--
</a><a href="#h4-0-85" id="h4-0-85" class="i">+
</a><a href="#h4-0-86" id="h4-0-86" class="i">+local crypto = require(&quot;crypto&quot;)
</a><a href="#h4-0-87" id="h4-0-87" class="i">+
</a><a href="#h4-0-88" id="h4-0-88" class="i">+-- Returns username of cookie if cookie is valid. Otherwise returns nil.
</a><a href="#h4-0-89" id="h4-0-89" class="i">+function validate_cookie(cookie)
</a><a href="#h4-0-90" id="h4-0-90" class="i">+	local i = 0
</a><a href="#h4-0-91" id="h4-0-91" class="i">+	local username = &quot;&quot;
</a><a href="#h4-0-92" id="h4-0-92" class="i">+	local expiration = 0
</a><a href="#h4-0-93" id="h4-0-93" class="i">+	local salt = &quot;&quot;
</a><a href="#h4-0-94" id="h4-0-94" class="i">+	local hmac = &quot;&quot;
</a><a href="#h4-0-95" id="h4-0-95" class="i">+
</a><a href="#h4-0-96" id="h4-0-96" class="i">+	if cookie:len() &lt; 3 or cookie:sub(1, 1) == &quot;|&quot; then
</a><a href="#h4-0-97" id="h4-0-97" class="i">+		return nil
</a><a href="#h4-0-98" id="h4-0-98" class="i">+	end
</a><a href="#h4-0-99" id="h4-0-99" class="i">+
</a><a href="#h4-0-100" id="h4-0-100" class="i">+	for component in string.gmatch(cookie, &quot;[^|]+&quot;) do
</a><a href="#h4-0-101" id="h4-0-101" class="i">+		if i == 0 then
</a><a href="#h4-0-102" id="h4-0-102" class="i">+			username = component
</a><a href="#h4-0-103" id="h4-0-103" class="i">+		elseif i == 1 then
</a><a href="#h4-0-104" id="h4-0-104" class="i">+			expiration = tonumber(component)
</a><a href="#h4-0-105" id="h4-0-105" class="i">+			if expiration == nil then
</a><a href="#h4-0-106" id="h4-0-106" class="i">+				expiration = 0
</a><a href="#h4-0-107" id="h4-0-107" class="i">+			end
</a><a href="#h4-0-108" id="h4-0-108" class="i">+		elseif i == 2 then
</a><a href="#h4-0-109" id="h4-0-109" class="i">+			salt = component
</a><a href="#h4-0-110" id="h4-0-110" class="i">+		elseif i == 3 then
</a><a href="#h4-0-111" id="h4-0-111" class="i">+			hmac = component
</a><a href="#h4-0-112" id="h4-0-112" class="i">+		else
</a><a href="#h4-0-113" id="h4-0-113" class="i">+			break
</a><a href="#h4-0-114" id="h4-0-114" class="i">+		end
</a><a href="#h4-0-115" id="h4-0-115" class="i">+		i = i + 1
</a><a href="#h4-0-116" id="h4-0-116" class="i">+	end
</a><a href="#h4-0-117" id="h4-0-117" class="i">+
</a><a href="#h4-0-118" id="h4-0-118" class="i">+	if hmac == nil or hmac:len() == 0 then
</a><a href="#h4-0-119" id="h4-0-119" class="i">+		return nil
</a><a href="#h4-0-120" id="h4-0-120" class="i">+	end
</a><a href="#h4-0-121" id="h4-0-121" class="i">+
</a><a href="#h4-0-122" id="h4-0-122" class="i">+	-- TODO: implement time invariant comparison to prevent against timing attack.
</a><a href="#h4-0-123" id="h4-0-123" class="i">+	if hmac ~= crypto.hmac.digest(&quot;sha1&quot;, username .. &quot;|&quot; .. tostring(expiration) .. &quot;|&quot; .. salt, secret) then
</a><a href="#h4-0-124" id="h4-0-124" class="i">+		return nil
</a><a href="#h4-0-125" id="h4-0-125" class="i">+	end
</a><a href="#h4-0-126" id="h4-0-126" class="i">+
</a><a href="#h4-0-127" id="h4-0-127" class="i">+	if expiration &lt;= os.time() then
</a><a href="#h4-0-128" id="h4-0-128" class="i">+		return nil
</a><a href="#h4-0-129" id="h4-0-129" class="i">+	end
</a><a href="#h4-0-130" id="h4-0-130" class="i">+
</a><a href="#h4-0-131" id="h4-0-131" class="i">+	return username:lower()
</a><a href="#h4-0-132" id="h4-0-132" class="i">+end
</a><a href="#h4-0-133" id="h4-0-133" class="i">+
</a><a href="#h4-0-134" id="h4-0-134" class="i">+function construct_cookie(username, cookie)
</a><a href="#h4-0-135" id="h4-0-135" class="i">+	local authstr = &quot;&quot;
</a><a href="#h4-0-136" id="h4-0-136" class="i">+	if username:len() &gt; 0 then
</a><a href="#h4-0-137" id="h4-0-137" class="i">+		-- One week expiration time
</a><a href="#h4-0-138" id="h4-0-138" class="i">+		local expiration = os.time() + 604800
</a><a href="#h4-0-139" id="h4-0-139" class="i">+		local salt = crypto.hex(crypto.rand.bytes(16))
</a><a href="#h4-0-140" id="h4-0-140" class="i">+
</a><a href="#h4-0-141" id="h4-0-141" class="i">+		authstr = username .. &quot;|&quot; .. tostring(expiration) .. &quot;|&quot; .. salt
</a><a href="#h4-0-142" id="h4-0-142" class="i">+		authstr = authstr .. &quot;|&quot; .. crypto.hmac.digest(&quot;sha1&quot;, authstr, secret)
</a><a href="#h4-0-143" id="h4-0-143" class="i">+	end
</a><a href="#h4-0-144" id="h4-0-144" class="i">+
</a><a href="#h4-0-145" id="h4-0-145" class="i">+	html(&quot;Set-Cookie: &quot; .. cookie .. &quot;=&quot; .. authstr .. &quot;; HttpOnly&quot;)
</a><a href="#h4-0-146" id="h4-0-146" class="i">+	if http[&quot;https&quot;] == &quot;yes&quot; or http[&quot;https&quot;] == &quot;on&quot; or http[&quot;https&quot;] == &quot;1&quot; then
</a><a href="#h4-0-147" id="h4-0-147" class="i">+		html(&quot;; secure&quot;)
</a><a href="#h4-0-148" id="h4-0-148" class="i">+	end
</a><a href="#h4-0-149" id="h4-0-149" class="i">+	html(&quot;\n&quot;)
</a><a href="#h4-0-150" id="h4-0-150" class="i">+end
</a><a href="#h4-0-151" id="h4-0-151" class="i">+
</a><a href="#h4-0-152" id="h4-0-152" class="i">+--
</a><a href="#h4-0-153" id="h4-0-153" class="i">+--
</a><a href="#h4-0-154" id="h4-0-154" class="i">+-- Wrapper around filter API follows below, exposing the http table, the cgit table, and the post table to the above functions.
</a><a href="#h4-0-155" id="h4-0-155" class="i">+--
</a><a href="#h4-0-156" id="h4-0-156" class="i">+--
</a><a href="#h4-0-157" id="h4-0-157" class="i">+
</a><a href="#h4-0-158" id="h4-0-158" class="i">+local actions = {}
</a><a href="#h4-0-159" id="h4-0-159" class="i">+actions[&quot;authenticate-post&quot;] = authenticate_post
</a><a href="#h4-0-160" id="h4-0-160" class="i">+actions[&quot;authenticate-cookie&quot;] = authenticate_cookie
</a><a href="#h4-0-161" id="h4-0-161" class="i">+actions[&quot;body&quot;] = body
</a><a href="#h4-0-162" id="h4-0-162" class="i">+
</a><a href="#h4-0-163" id="h4-0-163" class="i">+function filter_open(...)
</a><a href="#h4-0-164" id="h4-0-164" class="i">+	action = actions[select(1, ...)]
</a><a href="#h4-0-165" id="h4-0-165" class="i">+
</a><a href="#h4-0-166" id="h4-0-166" class="i">+	http = {}
</a><a href="#h4-0-167" id="h4-0-167" class="i">+	http[&quot;cookie&quot;] = select(2, ...)
</a><a href="#h4-0-168" id="h4-0-168" class="i">+	http[&quot;method&quot;] = select(3, ...)
</a><a href="#h4-0-169" id="h4-0-169" class="i">+	http[&quot;query&quot;] = select(4, ...)
</a><a href="#h4-0-170" id="h4-0-170" class="i">+	http[&quot;referer&quot;] = select(5, ...)
</a><a href="#h4-0-171" id="h4-0-171" class="i">+	http[&quot;path&quot;] = select(6, ...)
</a><a href="#h4-0-172" id="h4-0-172" class="i">+	http[&quot;host&quot;] = select(7, ...)
</a><a href="#h4-0-173" id="h4-0-173" class="i">+	http[&quot;https&quot;] = select(8, ...)
</a><a href="#h4-0-174" id="h4-0-174" class="i">+
</a><a href="#h4-0-175" id="h4-0-175" class="i">+	cgit = {}
</a><a href="#h4-0-176" id="h4-0-176" class="i">+	cgit[&quot;repo&quot;] = select(9, ...)
</a><a href="#h4-0-177" id="h4-0-177" class="i">+	cgit[&quot;page&quot;] = select(10, ...)
</a><a href="#h4-0-178" id="h4-0-178" class="i">+	cgit[&quot;url&quot;] = select(11, ...)
</a><a href="#h4-0-179" id="h4-0-179" class="i">+
</a><a href="#h4-0-180" id="h4-0-180" class="i">+	cgit[&quot;login&quot;] = &quot;&quot;
</a><a href="#h4-0-181" id="h4-0-181" class="i">+	for _ in cgit[&quot;url&quot;]:gfind(&quot;/&quot;) do
</a><a href="#h4-0-182" id="h4-0-182" class="i">+		cgit[&quot;login&quot;] = cgit[&quot;login&quot;] .. &quot;../&quot;
</a><a href="#h4-0-183" id="h4-0-183" class="i">+	end
</a><a href="#h4-0-184" id="h4-0-184" class="i">+	cgit[&quot;login&quot;] = cgit[&quot;login&quot;] .. &quot;?p=login&quot;
</a><a href="#h4-0-185" id="h4-0-185" class="i">+
</a><a href="#h4-0-186" id="h4-0-186" class="i">+end
</a><a href="#h4-0-187" id="h4-0-187" class="i">+
</a><a href="#h4-0-188" id="h4-0-188" class="i">+function filter_close()
</a><a href="#h4-0-189" id="h4-0-189" class="i">+	return action()
</a><a href="#h4-0-190" id="h4-0-190" class="i">+end
</a><a href="#h4-0-191" id="h4-0-191" class="i">+
</a><a href="#h4-0-192" id="h4-0-192" class="i">+function filter_write(str)
</a><a href="#h4-0-193" id="h4-0-193" class="i">+	post = parse_qs(str)
</a><a href="#h4-0-194" id="h4-0-194" class="i">+end
</a><a href="#h4-0-195" id="h4-0-195" class="i">+
</a><a href="#h4-0-196" id="h4-0-196" class="i">+
</a><a href="#h4-0-197" id="h4-0-197" class="i">+--
</a><a href="#h4-0-198" id="h4-0-198" class="i">+--
</a><a href="#h4-0-199" id="h4-0-199" class="i">+-- Utility functions follow below, based on keplerproject/wsapi.
</a><a href="#h4-0-200" id="h4-0-200" class="i">+--
</a><a href="#h4-0-201" id="h4-0-201" class="i">+--
</a><a href="#h4-0-202" id="h4-0-202" class="i">+
</a><a href="#h4-0-203" id="h4-0-203" class="i">+function url_decode(str)
</a><a href="#h4-0-204" id="h4-0-204" class="i">+	if not str then
</a><a href="#h4-0-205" id="h4-0-205" class="i">+		return &quot;&quot;
</a><a href="#h4-0-206" id="h4-0-206" class="i">+	end
</a><a href="#h4-0-207" id="h4-0-207" class="i">+	str = string.gsub(str, &quot;+&quot;, &quot; &quot;)
</a><a href="#h4-0-208" id="h4-0-208" class="i">+	str = string.gsub(str, &quot;%%(%x%x)&quot;, function(h) return string.char(tonumber(h, 16)) end)
</a><a href="#h4-0-209" id="h4-0-209" class="i">+	str = string.gsub(str, &quot;\r\n&quot;, &quot;\n&quot;)
</a><a href="#h4-0-210" id="h4-0-210" class="i">+	return str
</a><a href="#h4-0-211" id="h4-0-211" class="i">+end
</a><a href="#h4-0-212" id="h4-0-212" class="i">+
</a><a href="#h4-0-213" id="h4-0-213" class="i">+function parse_qs(qs)
</a><a href="#h4-0-214" id="h4-0-214" class="i">+	local tab = {}
</a><a href="#h4-0-215" id="h4-0-215" class="i">+	for key, val in string.gmatch(qs, &quot;([^&amp;=]+)=([^&amp;=]*)&amp;?&quot;) do
</a><a href="#h4-0-216" id="h4-0-216" class="i">+		tab[url_decode(key)] = url_decode(val)
</a><a href="#h4-0-217" id="h4-0-217" class="i">+	end
</a><a href="#h4-0-218" id="h4-0-218" class="i">+	return tab
</a><a href="#h4-0-219" id="h4-0-219" class="i">+end
</a><a href="#h4-0-220" id="h4-0-220" class="i">+
</a><a href="#h4-0-221" id="h4-0-221" class="i">+function get_cookie(cookies, name)
</a><a href="#h4-0-222" id="h4-0-222" class="i">+	cookies = string.gsub(&quot;;&quot; .. cookies .. &quot;;&quot;, &quot;%s*;%s*&quot;, &quot;;&quot;)
</a><a href="#h4-0-223" id="h4-0-223" class="i">+	return url_decode(string.match(cookies, &quot;;&quot; .. name .. &quot;=(.-);&quot;))
</a><a href="#h4-0-224" id="h4-0-224" class="i">+end
</a><b>diff --git a/<a id="h5" href="../file/ui-shared.c.html">ui-shared.c</a> b/<a href="../file/ui-shared.c.html">ui-shared.c</a></b>
<a href="#h5-0" id="h5-0" class="h">@@ -641,6 +641,8 @@ void cgit_print_http_headers(struct cgit_context *ctx)
</a> 	if (ctx-&gt;page.filename)
 		htmlf(&quot;Content-Disposition: inline; filename=\&quot;%s\&quot;\n&quot;,
 		      ctx-&gt;page.filename);
<a href="#h5-0-3" id="h5-0-3" class="i">+	if (!ctx-&gt;env.authenticated)
</a><a href="#h5-0-4" id="h5-0-4" class="i">+		html(&quot;Cache-Control: no-cache, no-store\n&quot;);
</a> 	htmlf(&quot;Last-Modified: %s\n&quot;, http_date(ctx-&gt;page.modified));
 	htmlf(&quot;Expires: %s\n&quot;, http_date(ctx-&gt;page.expires));
 	if (ctx-&gt;page.etag)
<a href="#h5-1" id="h5-1" class="h">@@ -814,14 +816,16 @@ static void print_header(struct cgit_context *ctx)
</a> 		cgit_index_link(&quot;index&quot;, NULL, NULL, NULL, NULL, 0);
 		html(&quot; : &quot;);
 		cgit_summary_link(ctx-&gt;repo-&gt;name, ctx-&gt;repo-&gt;name, NULL, NULL);
<a href="#h5-1-3" id="h5-1-3" class="d">-		html(&quot;&lt;/td&gt;&lt;td class=&#39;form&#39;&gt;&quot;);
</a><a href="#h5-1-4" id="h5-1-4" class="d">-		html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;\n&quot;);
</a><a href="#h5-1-5" id="h5-1-5" class="d">-		cgit_add_hidden_formfields(0, 1, ctx-&gt;qry.page);
</a><a href="#h5-1-6" id="h5-1-6" class="d">-		html(&quot;&lt;select name=&#39;h&#39; onchange=&#39;this.form.submit();&#39;&gt;\n&quot;);
</a><a href="#h5-1-7" id="h5-1-7" class="d">-		for_each_branch_ref(print_branch_option, ctx-&gt;qry.head);
</a><a href="#h5-1-8" id="h5-1-8" class="d">-		html(&quot;&lt;/select&gt; &quot;);
</a><a href="#h5-1-9" id="h5-1-9" class="d">-		html(&quot;&lt;input type=&#39;submit&#39; name=&#39;&#39; value=&#39;switch&#39;/&gt;&quot;);
</a><a href="#h5-1-10" id="h5-1-10" class="d">-		html(&quot;&lt;/form&gt;&quot;);
</a><a href="#h5-1-11" id="h5-1-11" class="i">+		if (ctx-&gt;env.authenticated) {
</a><a href="#h5-1-12" id="h5-1-12" class="i">+			html(&quot;&lt;/td&gt;&lt;td class=&#39;form&#39;&gt;&quot;);
</a><a href="#h5-1-13" id="h5-1-13" class="i">+			html(&quot;&lt;form method=&#39;get&#39; action=&#39;&#39;&gt;\n&quot;);
</a><a href="#h5-1-14" id="h5-1-14" class="i">+			cgit_add_hidden_formfields(0, 1, ctx-&gt;qry.page);
</a><a href="#h5-1-15" id="h5-1-15" class="i">+			html(&quot;&lt;select name=&#39;h&#39; onchange=&#39;this.form.submit();&#39;&gt;\n&quot;);
</a><a href="#h5-1-16" id="h5-1-16" class="i">+			for_each_branch_ref(print_branch_option, ctx-&gt;qry.head);
</a><a href="#h5-1-17" id="h5-1-17" class="i">+			html(&quot;&lt;/select&gt; &quot;);
</a><a href="#h5-1-18" id="h5-1-18" class="i">+			html(&quot;&lt;input type=&#39;submit&#39; name=&#39;&#39; value=&#39;switch&#39;/&gt;&quot;);
</a><a href="#h5-1-19" id="h5-1-19" class="i">+			html(&quot;&lt;/form&gt;&quot;);
</a><a href="#h5-1-20" id="h5-1-20" class="i">+		}
</a> 	} else
 		html_txt(ctx-&gt;cfg.root_title);
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;\n&quot;);
<a href="#h5-2" id="h5-2" class="h">@@ -843,11 +847,11 @@ static void print_header(struct cgit_context *ctx)
</a> void cgit_print_pageheader(struct cgit_context *ctx)
 {
 	html(&quot;&lt;div id=&#39;cgit&#39;&gt;&quot;);
<a href="#h5-2-3" id="h5-2-3" class="d">-	if (!ctx-&gt;cfg.noheader)
</a><a href="#h5-2-4" id="h5-2-4" class="i">+	if (!ctx-&gt;env.authenticated || !ctx-&gt;cfg.noheader)
</a> 		print_header(ctx);
 
 	html(&quot;&lt;table class=&#39;tabs&#39;&gt;&lt;tr&gt;&lt;td&gt;\n&quot;);
<a href="#h5-2-8" id="h5-2-8" class="d">-	if (ctx-&gt;repo) {
</a><a href="#h5-2-9" id="h5-2-9" class="i">+	if (ctx-&gt;env.authenticated &amp;&amp; ctx-&gt;repo) {
</a> 		cgit_summary_link(&quot;summary&quot;, NULL, hc(ctx, &quot;summary&quot;),
 				  ctx-&gt;qry.head);
 		cgit_refs_link(&quot;refs&quot;, NULL, hc(ctx, &quot;refs&quot;), ctx-&gt;qry.head,
<a href="#h5-3" id="h5-3" class="h">@@ -886,7 +890,7 @@ void cgit_print_pageheader(struct cgit_context *ctx)
</a> 		html(&quot;&#39;/&gt;\n&quot;);
 		html(&quot;&lt;input type=&#39;submit&#39; value=&#39;search&#39;/&gt;\n&quot;);
 		html(&quot;&lt;/form&gt;\n&quot;);
<a href="#h5-3-3" id="h5-3-3" class="d">-	} else {
</a><a href="#h5-3-4" id="h5-3-4" class="i">+	} else if (ctx-&gt;env.authenticated) {
</a> 		site_link(NULL, &quot;index&quot;, NULL, hc(ctx, &quot;repolist&quot;), NULL, NULL, 0);
 		if (ctx-&gt;cfg.root_readme)
 			site_link(&quot;about&quot;, &quot;about&quot;, NULL, hc(ctx, &quot;about&quot;),
<a href="#h5-4" id="h5-4" class="h">@@ -902,7 +906,7 @@ void cgit_print_pageheader(struct cgit_context *ctx)
</a> 		html(&quot;&lt;/form&gt;&quot;);
 	}
 	html(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\n&quot;);
<a href="#h5-4-3" id="h5-4-3" class="d">-	if (ctx-&gt;qry.vpath) {
</a><a href="#h5-4-4" id="h5-4-4" class="i">+	if (ctx-&gt;env.authenticated &amp;&amp; ctx-&gt;qry.vpath) {
</a> 		html(&quot;&lt;div class=&#39;path&#39;&gt;&quot;);
 		html(&quot;path: &quot;);
 		cgit_print_path_crumbs(ctx, ctx-&gt;qry.vpath);
</pre>
</div>
</body>
</html>
